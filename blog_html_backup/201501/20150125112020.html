<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL exec_bind_message exec_execute_message slow duration CASE</h2>
	<h5 id="">2015-01-25 11:20:20&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402015025105225466/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>集中在一个时间点爆发了大量的超时 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgresql-2015-01-25_080541.csv:2015-01-25 08:28:54.480 CST,"xxx","xxx",3801,"xxx.xxx.xxx.xxx:53452",54c40104.ed9,3,</font></div><div><font size="2"   >"BIND",2015-01-25 04:31:00 CST,156/155533,0,LOG,00000,"duration: 2677.350 ms &nbsp;bind &lt;unnamed&gt;:.........",,,,,,,"exec_bind_message, postgres.c:1771",""</font></div></div><div><div><font size="2"   >postgresql-2015-01-25_080541.csv:2015-01-25 08:28:54.479 CST,"xxx","xxx",31499,"xxx.xxx.xxx.xxx:2311",54c438c5.7b0b,3</font></div><div><font size="2"   >,"INSERT",2015-01-25 08:28:53 CST,197/371,3269635044,LOG,00000,"duration: 1240.600 ms &nbsp;execute &lt;unnamed&gt;:.............,,,,,,,"exec_exec<span style="line-height: 28px;"   >ute_message, postgres.c:1991",""</span></font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   >以往在操作系统内存释放的时候会发生同样的情况.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >11:00:01 PM &nbsp;pgpgin/s pgpgout/s &nbsp; fault/s &nbsp;majflt/s &nbsp;pgfree/s pgscank/s pgscand/s pgsteal/s &nbsp; &nbsp;%vmeff</font></div><div><div><font size="2"   >09:10:01 PM &nbsp; &nbsp;920.12 &nbsp; 6945.41 &nbsp;11065.59 &nbsp; &nbsp; &nbsp;0.02 &nbsp; 7410.51 &nbsp; &nbsp; &nbsp;0.00 &nbsp; 1009.25 &nbsp; 1009.25 &nbsp; &nbsp;100.00</font></div><div><font size="2"   >09:20:01 PM &nbsp; 1164.25 &nbsp; 7400.00 &nbsp;10927.29 &nbsp; &nbsp; &nbsp;0.00 &nbsp; 7307.16 &nbsp; &nbsp; &nbsp;0.00 &nbsp; 1039.47 &nbsp; 1039.44 &nbsp; &nbsp;100.00</font></div><div><font size="2"   >09:30:01 PM &nbsp; 4237.75 &nbsp;46469.21 &nbsp;21326.72 &nbsp; &nbsp; &nbsp;0.30 &nbsp;22577.85 &nbsp; &nbsp; &nbsp;0.00 &nbsp; 6802.80 &nbsp; 6801.95 &nbsp; &nbsp; 99.99</font></div><div><font size="2"   >09:40:01 PM &nbsp; 4690.02 &nbsp;10548.23 &nbsp;15488.73 &nbsp; &nbsp; &nbsp;0.03 &nbsp;14010.75 &nbsp; &nbsp; &nbsp;0.00 &nbsp; 3590.08 &nbsp; 3590.08 &nbsp; &nbsp;100.00</font></div><div><font size="2"   >09:50:01 PM &nbsp; 3207.06 &nbsp; 8823.76 &nbsp;14096.80 &nbsp; &nbsp; &nbsp;0.01 &nbsp;11457.67 &nbsp; &nbsp; &nbsp;0.00 &nbsp; 2300.69 &nbsp; 2300.69 &nbsp; &nbsp;100.00</font></div><div><font size="2"   >10:00:01 PM &nbsp; 1234.30 &nbsp; 7730.82 &nbsp;12010.25 &nbsp; &nbsp; &nbsp;0.00 &nbsp; 8483.31 &nbsp; &nbsp; &nbsp;0.00 &nbsp; 1085.50 &nbsp; 1085.49 &nbsp; &nbsp;100.00</font></div><div><font size="2"   >10:10:01 PM &nbsp; 1245.09 &nbsp; 7213.44 &nbsp;11442.72 &nbsp; &nbsp; &nbsp;0.06 &nbsp; 7704.57 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;830.43 &nbsp; &nbsp;829.18 &nbsp; &nbsp; 99.85</font></div></div><div><div><font size="2"   >11:20:01 PM &nbsp; &nbsp;687.85 &nbsp; 5674.72 &nbsp; 9648.99 &nbsp; &nbsp; &nbsp;0.00 &nbsp; 6155.99 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;620.76 &nbsp; &nbsp;620.92 &nbsp; &nbsp;100.03</font></div><div><font size="2"   >11:30:01 PM &nbsp; 4107.70 &nbsp;53679.93 &nbsp;18141.03 &nbsp; &nbsp; &nbsp;0.01 &nbsp;20401.34 &nbsp; &nbsp; &nbsp;0.00 &nbsp; 5579.80 &nbsp; 5579.80 &nbsp; &nbsp;100.00</font></div><div><font size="2"   >11:40:01 PM &nbsp; &nbsp;642.84 &nbsp; 8380.79 &nbsp;11849.57 &nbsp; &nbsp; &nbsp;0.02 &nbsp; 9801.51 &nbsp; &nbsp; &nbsp;0.00 &nbsp; 1146.84 &nbsp; 1146.84 &nbsp; &nbsp;100.00</font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   >例如以上23:30, 21:30左右都出现了大量的page free动作, 同时数据库的响应就变慢了.</span></div><div><span style="line-height: 28px;"   ><br></span></div><div>超时集中在一个时间点爆发.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-xxx upload_dir]# grep -r duration postgresql-2015-01-25*|grep -c exec_</font></div><div><font size="2"   >200</font></div><div><font size="2"   >[root@db-xxx upload_dir]# grep -r duration postgresql-2015-01-25*|grep "08:28:54"|grep -c exec_</font></div><div><font size="2"   >182</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >大批量的连接出现在</span><span style="line-height: 28px;"   >exec_bind_message</span><span style="line-height: 28px;"   >之前.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-xxx upload_dir]# grep authorized postgresql-2015-01-25*|grep xxx|grep -v xxx|awk '{print $2}'|awk -F "." '{print $1}'|sort|uniq -c</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 4 08:26:57</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;40 08:28:52</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;93 08:28:53</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;60 08:28:54</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 5 08:28:55</font></div><p></p></pre></div><div>程序集中大量的向数据库发起新建连接, 新建的连接第一次发起的SQL需要重新硬解析, 这个问题类似冷启动, 卡一下也是正常的.</div><div>什么时候程序可能大量发起新建连接呢?&nbsp;</div><div>1. 数据库响应变慢, 程序可能会大量发起连接</div><div>2. 程序连接池到期, 可能会大量重新发起连接.</div><div><br></div><div>参考代码 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >src/backend/tcop/postgres.c</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >select count(*) from pg_stat_activity where usename ~ 'xxx' or datname ~ 'xxx';</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp;347</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >select count(*) from pg_stat_activity where (usename ~ 'xxx' or datname ~ 'xxx') and backend_start between '2015-01-25 08:28:00' and '2015-01-25 08:28:59' ;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp;109</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>其他 :&nbsp;</div><div>sar的统计粒度为10分钟一次,内存交换, load, CPU使用率, 上下文切换, 进程数都没见异常.&nbsp;</div><div>内存使用率也只有29.22%, 排除内存释放造成的问题.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >04:30:01 AM &nbsp; &nbsp; CPU &nbsp; &nbsp; %user &nbsp; &nbsp; %nice &nbsp; %system &nbsp; %iowait &nbsp; &nbsp;%steal &nbsp; &nbsp; %idle</font></div><div><div><font size="2"   >08:20:01 AM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;7.57 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;2.70 &nbsp; &nbsp; &nbsp;2.82 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 86.91</font></div><div><font size="2"   >08:30:01 AM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;7.38 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;2.63 &nbsp; &nbsp; &nbsp;2.17 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 87.82</font></div><div><font size="2"   >08:40:01 AM &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp;7.81 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;2.88 &nbsp; &nbsp; &nbsp;2.25 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 87.06</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >04:30:01 AM &nbsp; &nbsp;proc/s &nbsp; cswch/s</font></div><div><div><font size="2"   >08:20:01 AM &nbsp; &nbsp; 14.31 &nbsp; 8113.67</font></div><div><font size="2"   >08:30:01 AM &nbsp; &nbsp; 14.43 &nbsp; 7782.55</font></div><div><font size="2"   >08:40:01 AM &nbsp; &nbsp; 15.08 &nbsp; 7965.01</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >10:40:01 AM &nbsp; runq-sz &nbsp;plist-sz &nbsp; ldavg-1 &nbsp; ldavg-5 &nbsp;ldavg-15</font></div><div><div><font size="2"   >08:20:01 AM &nbsp; &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp; 566 &nbsp; &nbsp; &nbsp;0.56 &nbsp; &nbsp; &nbsp;0.56 &nbsp; &nbsp; &nbsp;0.54</font></div><div><font size="2"   >08:30:01 AM &nbsp; &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp; 647 &nbsp; &nbsp; &nbsp;0.50 &nbsp; &nbsp; &nbsp;0.42 &nbsp; &nbsp; &nbsp;0.45</font></div><div><font size="2"   >08:40:01 AM &nbsp; &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp; 647 &nbsp; &nbsp; &nbsp;0.27 &nbsp; &nbsp; &nbsp;0.43 &nbsp; &nbsp; &nbsp;0.43</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >10:40:01 AM kbmemfree kbmemused &nbsp;%memused kbbuffers &nbsp;kbcached &nbsp;kbcommit &nbsp; %commit</font></div><div><div><font size="2"   >08:20:01 AM &nbsp;95578616 &nbsp;36531396 &nbsp; &nbsp; 27.65 &nbsp; &nbsp;186972 &nbsp;30343852 &nbsp;12100048 &nbsp; &nbsp; &nbsp;8.61</font></div><div><font size="2"   >08:30:01 AM &nbsp;93509604 &nbsp;38600408 &nbsp; &nbsp; 29.22 &nbsp; &nbsp;198340 &nbsp;31968140 &nbsp;12924520 &nbsp; &nbsp; &nbsp;9.20</font></div><div><font size="2"   >08:40:01 AM &nbsp;90494168 &nbsp;41615844 &nbsp; &nbsp; 31.50 &nbsp; &nbsp;204336 &nbsp;34752848 &nbsp;12989064 &nbsp; &nbsp; &nbsp;9.24</font></div></div><p></p></pre></div><div><br></div><div>环境</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >内核 2.6.32-504.el6.x86_64</font></div><div><font size="2"   >系统 CentOS 6.6 x64</font></div><div><font size="2"   >MEM &nbsp;128GB</font></div><div><font size="2"   >CPU &nbsp; Intel(R) Xeon(R) CPU E5-2609 v2 @ 2.50GHz</font></div><div><font size="2"   >sysctl :&nbsp;</font></div><div><div><font size="2"   ># add by digoal.zhou</font></div><div><font size="2"   >kernel.shmmni = 4096</font></div><div><font size="2"   >kernel.sem = 50100 64128000 50100 1280</font></div><div><font size="2"   >fs.file-max = 7672460</font></div><div><font size="2"   >net.ipv4.ip_local_port_range = 9000 65000</font></div><div><font size="2"   >net.core.rmem_default = 1048576</font></div><div><font size="2"   >net.core.rmem_max = 4194304</font></div><div><font size="2"   >net.core.wmem_default = 262144</font></div><div><font size="2"   >net.core.wmem_max = 1048576</font></div><div><font size="2"   >net.ipv4.tcp_tw_recycle = 1</font></div><div><font size="2"   >net.ipv4.tcp_max_syn_backlog = 4096</font></div><div><font size="2"   >net.core.netdev_max_backlog = 10000</font></div><div><font size="2"   >fs.aio-max-nr = 1048576</font></div><div><font size="2"   >net.ipv4.tcp_timestamps = 0</font></div><div><font size="2"   >vm.overcommit_memory = 0</font></div><div><font size="2"   >net.ipv4.tcp_keepalive_time = 72</font></div><div><font size="2"   >net.ipv4.tcp_keepalive_probes = 9</font></div><div><font size="2"   >net.ipv4.tcp_keepalive_intvl = 5</font></div><div><font size="2"   >vm.zone_reclaim_mode=1</font></div><div><font size="2"   >vm.dirty_background_bytes=102400000</font></div><div><font size="2"   >vm.dirty_bytes=102400000</font></div><div><font size="2"   >vm.dirty_expire_centisecs=10</font></div><div><font size="2"   >vm.dirty_writeback_centisecs=10</font></div><div><font size="2"   >vm.swappiness=0</font></div></div><p></p></pre></div><div><br></div><div>有网友反映类似的问题, 不同他们的CPU使用率达到了100%, 我这个场景CPU没有异常(也可能是SAR统计间隔太长没有反映出来).</div><div>见参考部分, 内核3.x的BUG造成的上下文切换问题.</div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://lkml.org/lkml/2012/10/9/210"   >https://lkml.org/lkml/2012/10/9/210</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://comments.gmane.org/gmane.comp.db.postgresql.performance/35673"   >http://comments.gmane.org/gmane.comp.db.postgresql.performance/35673</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/message-id/flat/CAKwGa_9rN8dWgr=O+isr9_5Qc4ughXbFrA1jX-EoM3EjXbBKfw@mail.gmail.com#CAKwGa_9rN8dWgr=O+isr9_5Qc4ughXbFrA1jX-EoM3EjXbBKfw@mail.gmail.com"   >http://www.postgresql.org/message-id/flat/CAKwGa_9rN8dWgr=O+isr9_5Qc4ughXbFrA1jX-EoM3EjXbBKfw@mail.gmail.com#CAKwGa_9rN8dWgr=O+isr9_5Qc4ughXbFrA1jX-EoM3EjXbBKfw@mail.gmail.com</a></div><div>4.&nbsp;src/backend/tcop/postgres.c</div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL exec_bind_message exec_execute_message slow duration CASE - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>