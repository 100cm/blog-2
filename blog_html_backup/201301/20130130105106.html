<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL Function to return the intersection of 2 ARRAYs</h2>
	<h5 id="">2013-01-30 10:51:06&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013030104627983/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">QQ群里面的兄弟问到的一个问题 :&nbsp;<div><div><pre class="prettyprint"  ><p><font size="2"  >&nbsp;--查找数组元素的交集<br>mydb=&gt;&nbsp;select&nbsp;array[1,2,3]&nbsp;&amp;&nbsp;array[3,4,5];<br>&nbsp;?column?&nbsp;<br>----------<br>&nbsp;{3}<br>(1&nbsp;row)<br>网上人家的DEMO里能过去&nbsp;我本地老提示error&nbsp;</font></p></pre></div><div><br></div><div>因为这个操作符没有, 所以报错是必然的.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# \do &amp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of operators</font></div><div><font size="2"  >&nbsp; &nbsp;Schema &nbsp; | Name | Left arg type | Right arg type | Result type | Description&nbsp;</font></div><div><font size="2"  >------------+------+---------------+----------------+-------------+-------------</font></div><div><font size="2"  >&nbsp;pg_catalog | &amp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp;| bitwise and</font></div><div><font size="2"  >&nbsp;pg_catalog | &amp; &nbsp; &nbsp;| bit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | bit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| bit &nbsp; &nbsp; &nbsp; &nbsp; | bitwise and</font></div><div><font size="2"  >&nbsp;pg_catalog | &amp; &nbsp; &nbsp;| inet &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| inet &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | inet &nbsp; &nbsp; &nbsp; &nbsp;| bitwise and</font></div><div><font size="2"  >&nbsp;pg_catalog | &amp; &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp;| integer &nbsp; &nbsp; | bitwise and</font></div><div><font size="2"  >&nbsp;pg_catalog | &amp; &nbsp; &nbsp;| macaddr &nbsp; &nbsp; &nbsp; | macaddr &nbsp; &nbsp; &nbsp; &nbsp;| macaddr &nbsp; &nbsp; | bitwise and</font></div><div><font size="2"  >&nbsp;pg_catalog | &amp; &nbsp; &nbsp;| smallint &nbsp; &nbsp; &nbsp;| smallint &nbsp; &nbsp; &nbsp; | smallint &nbsp; &nbsp;| bitwise and</font></div><div><font size="2"  >(6 rows)</font></div><p></p></pre></div><div>报错 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select array[1,2,3]::int[] &amp; array[3,4,5]::int[];</font></div><div><font size="2"  >ERROR: &nbsp;operator does not exist: integer[] &amp; integer[]</font></div><div><font size="2"  >LINE 1: select array[1,2,3]::int[] &amp; array[3,4,5]::int[];</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"  >HINT: &nbsp;No operator matches the given name and argument type(s). You might need to add explicit type casts.</font></div><p></p></pre></div><div><br></div><div>这个操作符来自intarray扩展.</div><div><div><br></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# create extension intarray;</font></div><div><font size="2"  >CREATE EXTENSION</font></div><div><font size="2"  >digoal=# \do &amp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of operators</font></div><div><font size="2"  >&nbsp; &nbsp;Schema &nbsp; | Name | Left arg type | Right arg type | Result type | Description&nbsp;</font></div><div><font size="2"  >------------+------+---------------+----------------+-------------+-------------</font></div><div><font size="2"  >&nbsp;pg_catalog | &amp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp;| bitwise and</font></div><div><font size="2"  >&nbsp;pg_catalog | &amp; &nbsp; &nbsp;| bit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | bit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| bit &nbsp; &nbsp; &nbsp; &nbsp; | bitwise and</font></div><div><font size="2"  >&nbsp;pg_catalog | &amp; &nbsp; &nbsp;| inet &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| inet &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | inet &nbsp; &nbsp; &nbsp; &nbsp;| bitwise and</font></div><div><font size="2"  >&nbsp;pg_catalog | &amp; &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp;| integer &nbsp; &nbsp; | bitwise and</font></div><div><font size="2"  >&nbsp;pg_catalog | &amp; &nbsp; &nbsp;| macaddr &nbsp; &nbsp; &nbsp; | macaddr &nbsp; &nbsp; &nbsp; &nbsp;| macaddr &nbsp; &nbsp; | bitwise and</font></div><div><font size="2"  >&nbsp;pg_catalog | &amp; &nbsp; &nbsp;| smallint &nbsp; &nbsp; &nbsp;| smallint &nbsp; &nbsp; &nbsp; | smallint &nbsp; &nbsp;| bitwise and</font></div><div><font size="2"  >&nbsp;public &nbsp; &nbsp; | &amp; &nbsp; &nbsp;| integer[] &nbsp; &nbsp; | integer[] &nbsp; &nbsp; &nbsp;| integer[] &nbsp; |&nbsp;</font></div><div><font size="2"  >(7 rows)</font></div><p></p></pre></div></div><div>扩展包 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pgdev@db-172-16-3-150-&gt; cd $PGHOME/share/extension</font></div><div><font size="2"  >intarray--1.0.sql&nbsp;</font></div><div><div><font size="2"  >CREATE OPERATOR &amp; (</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; LEFTARG = _int4,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; RIGHTARG = _int4,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; COMMUTATOR = &amp;,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; PROCEDURE = _int_inter</font></div><div><font size="2"  >);</font></div></div><p></p></pre></div><div><br></div><div>如果要对其他类型的数组执行相交的操作, 可以使用以下函数, 将数组解成record后相交, 再组装.</div><div><pre style="margin-top: 0px; margin-bottom: 10px; padding: 5px; border: 0px; vertical-align: baseline; background-color: rgb(238, 238, 238); font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif; overflow: auto; width: auto; max-height: 600px; line-height: 18px;"  ><code style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;"  ><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent; color: rgb(0, 0, 139);"  >CREATE</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  > </span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent; color: rgb(0, 0, 139);"  >FUNCTION</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  > array_intersect</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  >(</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  >anyarray</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  >,</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  > anyarray</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  >)</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  >   RETURNS anyarray   language sql </span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent; color: rgb(0, 0, 139);"  >as</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  > </span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  >$</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent; color: rgb(0, 0, 139);"  >FUNCTION</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  >$</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  >     </span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent; color: rgb(0, 0, 139);"  >SELECT</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  > ARRAY</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  >(</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  >         </span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent; color: rgb(0, 0, 139);"  >SELECT</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  > UNNEST</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  >($</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent; color: rgb(128, 0, 0);"  >1</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  >)</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  >         </span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent; color: rgb(0, 0, 139);"  >INTERSECT</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  >         </span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent; color: rgb(0, 0, 139);"  >SELECT</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  > UNNEST</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  >($</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent; color: rgb(128, 0, 0);"  >2</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  >)</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  >     </span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  >);</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  > </span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  >$</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent; color: rgb(0, 0, 139);"  >FUNCTION</span><span style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; background-color: transparent;"  >$;</span></code></pre></div><div>如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# CREATE FUNCTION array_intersect(anyarray, anyarray)</font></div><div><font size="2"  >digoal-# &nbsp; RETURNS anyarray</font></div><div><font size="2"  >digoal-# &nbsp; language sql</font></div><div><font size="2"  >digoal-# as $FUNCTION$</font></div><div><font size="2"  >digoal$# &nbsp; &nbsp; SELECT ARRAY(</font></div><div><font size="2"  >digoal$# &nbsp; &nbsp; &nbsp; &nbsp; SELECT UNNEST($1)</font></div><div><font size="2"  >digoal$# &nbsp; &nbsp; &nbsp; &nbsp; INTERSECT</font></div><div><font size="2"  >digoal$# &nbsp; &nbsp; &nbsp; &nbsp; SELECT UNNEST($2)</font></div><div><font size="2"  >digoal$# &nbsp; &nbsp; );</font></div><div><font size="2"  >digoal$# $FUNCTION$;</font></div><div><font size="2"  >CREATE FUNCTION</font></div><div><font size="2"  >digoal=# SELECT array_intersect(array['two', 'four', 'six']</font></div><div><font size="2"  >digoal(# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;, array['four', 'six', 'eight']);</font></div><div><font size="2"  >&nbsp;array_intersect&nbsp;</font></div><div><font size="2"  >-----------------</font></div><div><font size="2"  >&nbsp;{four,six}</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>【参考】</div><div>1.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://stackoverflow.com/questions/756871/postgres-function-to-return-the-intersection-of-2-arrays"  >http://stackoverflow.com/questions/756871/postgres-function-to-return-the-intersection-of-2-arrays</a></div><div>2.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/current/static/intarray.html"  >http://www.postgresql.org/docs/current/static/intarray.html</a></div><wbr></div></div>
	</div>
</div>
</body>
</html>