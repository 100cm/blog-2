<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">which xlog files in pg_xlog dir can be deleted when File system full</h2>
	<h5 id="">2013-01-18 9:37:46&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020130188172951/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>今天早上镜子兄弟他们的服务器存储数据库以及归档的分区都满了，导致数据库DOWN机。</div><div>具体的原因可能是归档文件未即使删除，导致归档目录满。</div><div>然后又由于归档目录满，导致归档失败也就是archive_command返回失败，因此pg_xlog中的文件将不会被rotate掉，持续增长。</div><div>因此pg_xlog也满了。</div><div>数据库写pg_xlog失败自然就挂了。</div><div><br></div><div>下面看看遇到这种问题如何解决?</div><div>测试环境 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >PostgreSQL 9.2.1</font></p></pre></div><div>测试数据 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create table test (id int primary key,info text);</font></div><div><font size="2"  >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "test_pkey" for table "test"</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >digoal=&gt; insert into test select generate_series(1,1000000), repeat(md5(clock_timestamp()::text),30);</font></div><div><font size="2"  >INSERT 0 1000000</font></div><p></p></pre></div><div>给数据库施加压力 :&nbsp;</div><div><div>ocz@db-172-16-3-150-&gt; vi test.sql</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >\setrandom id 1 1000000</font></div><div><font size="2"  >update test set info=repeat(md5(clock_timestamp()::text),30) where id=:id;</font></div><p></p></pre></div></div><div>施加压力 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 8 -j 4 -T 600 -h 127.0.0.1 -p 9201 -U digoal digoal</font></p></pre></div><div><span style="line-height: 22px;"  >在压力测试结束前, 模拟1次异常DOWN库 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; pg_ctl stop -m immediate</font></div><div><font size="2"  >waiting for server to shut down.... done</font></div><div><font size="2"  >server stopped</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >查看控制文件中数据库的状态 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><span style="line-height: 22px;"  ><font size="2"  >ocz@db-172-16-3-150-&gt; pg_controldata</font></span></div><div><font size="2"  >Database cluster state: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in production</font></div><p></p></pre></div><div>因为是异常停库, 所以数据库状态还显示为<span style="line-height: 22px;"  >&nbsp;</span><span style="line-height: 22px;"  >in production . 否则应该是shut down</span></div><div>查看控制文件中<span style="line-height: 22px;"  >检查点</span><span style="line-height: 22px;"  >REDO的位置信息 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="1"  ><span style="line-height: 19px; font-family: Arial, Helvetica, sans-serif;"  >Latest checkpoint's REDO location: &nbsp; &nbsp;</span><font face="Arial, Helvetica, sans-serif"  ><span style="line-height: 19px;"  >96E9/634883D8</span></font></font></div><p></p></pre></div><div><span style="line-height: 22px;"  >根据这个</span><span style="line-height: 22px;"  >Prior checkpoint location</span><span style="line-height: 22px;"  >位置信息找到对应的pg_xlog文件。</span></div><div><span style="line-height: 22px;"  >本例使用的xlog文件为16MB每个, 如果你的不是16MB, 那么最后不是除以16, 以你这边的替代之.</span></div><div><pre class="prettyprint"  ><p></p><div><span style="line-height: 19px; font-family: Arial, Helvetica, sans-serif; font-size: x-small;"  >634883D8</span><font size="2"  ><span style="line-height: 22px;"  > =&nbsp;</span><span style="line-height: 19px;"  >1665696728</span></font></div><div><font size="2"  ><span style="line-height: 19px;"  >1665696728</span> / 1024 / 1024 =&nbsp;<span style="line-height: 19px;"  >1588.53218841552734375</span></font></div><div><font size="2"  ><span style="line-height: 19px;"  >1588.53218841552734375</span> / 16 =&nbsp;<span style="line-height: 19px;"  >99.283261775970458984375</span></font></div><div><font size="2"  ><span style="line-height: 19px;"  >99.283261775970458984375 转换成16进制 &gt;= 63</span></font></div><p></p></pre></div><div>所以pg_xlog的文件名末尾在63之前的都可以删除.</div><div><pre class="prettyprint"  ><p></p><div><span style="line-height: 22px;"  ><font size="2"  >ocz@db-172-16-3-150-&gt; cd $PGDATA/pg_xlog</font></span></div><div><font size="2"  ><div style="line-height: 22px;"  >ocz@db-172-16-3-150-&gt; ll -rt</div><div>total 1.1G<br>-rw------- 1 ocz ocz 16M Jan 18 08:22 00000001000096E900000040<br>-rw------- 1 ocz ocz 16M Jan 18 08:22 00000001000096E900000041<br>-rw------- 1 ocz ocz 16M Jan 18 08:23 00000001000096E900000042<br>-rw------- 1 ocz ocz 16M Jan 18 08:23 00000001000096E900000043<br>-rw------- 1 ocz ocz 16M Jan 18 08:23 00000001000096E900000044<br>-rw------- 1 ocz ocz 16M Jan 18 08:23 00000001000096E900000045<br>-rw------- 1 ocz ocz 16M Jan 18 08:23 00000001000096E900000046<br>-rw------- 1 ocz ocz 16M Jan 18 08:23 00000001000096E900000047<br>-rw------- 1 ocz ocz 16M Jan 18 08:23 00000001000096E900000048<br>-rw------- 1 ocz ocz 16M Jan 18 08:23 00000001000096E900000049<br>-rw------- 1 ocz ocz 16M Jan 18 08:23 00000001000096E90000004A<br>-rw------- 1 ocz ocz 16M Jan 18 08:25 00000001000096E90000004B<br>-rw------- 1 ocz ocz 16M Jan 18 08:25 00000001000096E90000004C<br>-rw------- 1 ocz ocz 16M Jan 18 08:25 00000001000096E90000004D<br>-rw------- 1 ocz ocz 16M Jan 18 08:25 00000001000096E90000004E<br>-rw------- 1 ocz ocz 16M Jan 18 08:25 00000001000096E90000004F<br>-rw------- 1 ocz ocz 16M Jan 18 08:25 00000001000096E900000050<br>-rw------- 1 ocz ocz 16M Jan 18 08:25 00000001000096E900000051<br>-rw------- 1 ocz ocz 16M Jan 18 08:25 00000001000096E900000052<br>-rw------- 1 ocz ocz 16M Jan 18 08:25 00000001000096E900000053<br>-rw------- 1 ocz ocz 16M Jan 18 08:25 00000001000096E900000054<br>-rw------- 1 ocz ocz 16M Jan 18 08:25 00000001000096E900000055<br>-rw------- 1 ocz ocz 16M Jan 18 08:25 00000001000096E900000056<br>-rw------- 1 ocz ocz 16M Jan 18 08:25 00000001000096E900000057<br>-rw------- 1 ocz ocz 16M Jan 18 08:25 00000001000096E900000058<br>-rw------- 1 ocz ocz 16M Jan 18 08:25 00000001000096E900000059<br>-rw------- 1 ocz ocz 16M Jan 18 08:25 00000001000096E90000005A<br>-rw------- 1 ocz ocz 16M Jan 18 08:26 00000001000096E90000005B<br>-rw------- 1 ocz ocz 16M Jan 18 09:21 00000001000096E90000005C<br>-rw------- 1 ocz ocz 16M Jan 18 09:21 00000001000096E90000005D<br>-rw------- 1 ocz ocz 16M Jan 18 09:21 00000001000096E90000005E<br>-rw------- 1 ocz ocz 16M Jan 18 09:21 00000001000096E90000005F<br>-rw------- 1 ocz ocz 16M Jan 18 09:21 00000001000096E900000060<br>-rw------- 1 ocz ocz 16M Jan 18 09:21 00000001000096E900000061<br>-rw------- 1 ocz ocz 16M Jan 18 09:21 00000001000096E900000062<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000063<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000064<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000065<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000066<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000067<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000068<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000069<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E90000006A<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E90000006B<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E90000006C<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E90000006D<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E90000006E<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E90000006F<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000070<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000071<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000072<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000073<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000074<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000075<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000076<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000077<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000078<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000079<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E90000007A<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E90000007B<br>-rw------- 1 ocz ocz 16M Jan 18 09:26 00000001000096E90000007C<br>-rw------- 1 ocz ocz 16M Jan 18 09:26 00000001000096E90000007D<br>-rw------- 1 ocz ocz 16M Jan 18 09:26 00000001000096E90000007E<br>-rw------- 1 ocz ocz 16M Jan 18 09:26 00000001000096E90000007F<br>-rw------- 1 ocz ocz 16M Jan 18 09:26 00000001000096E900000080<br>drwx------ 2 ocz ocz 44K Jan 18 09:26 archive_status</div></font></div><div><div style="line-height: 22px;"  ><span style="line-height: 22px; font-family: Arial, Helvetica, sans-serif; white-space: normal;"  ><font size="2"  style="line-height: 20px;"  >截取要删除的部分执行.</font></span></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-size: small;"  >ocz@db-172-16-3-150-&gt; ll -rt|awk '{print "rm -rf "$9}'</span></div></div><div><font size="2"  >可删除的文件为 :&nbsp;</font></div><div><div><font size="2"  >rm -rf 00000001000096E900000040<br>rm -rf 00000001000096E900000041<br>rm -rf 00000001000096E900000042<br>rm -rf 00000001000096E900000043<br>rm -rf 00000001000096E900000044<br>rm -rf 00000001000096E900000045<br>rm -rf 00000001000096E900000046<br>rm -rf 00000001000096E900000047<br>rm -rf 00000001000096E900000048<br>rm -rf 00000001000096E900000049<br>rm -rf 00000001000096E90000004A<br>rm -rf 00000001000096E90000004B<br>rm -rf 00000001000096E90000004C<br>rm -rf 00000001000096E90000004D<br>rm -rf 00000001000096E90000004E<br>rm -rf 00000001000096E90000004F<br>rm -rf 00000001000096E900000050<br>rm -rf 00000001000096E900000051<br>rm -rf 00000001000096E900000052<br>rm -rf 00000001000096E900000053<br>rm -rf 00000001000096E900000054<br>rm -rf 00000001000096E900000055<br>rm -rf 00000001000096E900000056<br>rm -rf 00000001000096E900000057<br>rm -rf 00000001000096E900000058<br>rm -rf 00000001000096E900000059<br>rm -rf 00000001000096E90000005A<br>rm -rf 00000001000096E90000005B<br>rm -rf 00000001000096E90000005C<br>rm -rf 00000001000096E90000005D<br>rm -rf 00000001000096E90000005E<br>rm -rf 00000001000096E90000005F<br>rm -rf 00000001000096E900000060<br>rm -rf 00000001000096E900000061<br>rm -rf 00000001000096E900000062</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"  >删除后剩余文件 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; ll<br>total 481M<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000063<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000064<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000065<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000066<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000067<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000068<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000069<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E90000006A<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E90000006B<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E90000006C<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E90000006D<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E90000006E<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E90000006F<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000070<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000071<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000072<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000073<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000074<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000075<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000076<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000077<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000078<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E900000079<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E90000007A<br>-rw------- 1 ocz ocz 16M Jan 18 09:25 00000001000096E90000007B<br>-rw------- 1 ocz ocz 16M Jan 18 09:26 00000001000096E90000007C<br>-rw------- 1 ocz ocz 16M Jan 18 09:26 00000001000096E90000007D<br>-rw------- 1 ocz ocz 16M Jan 18 09:26 00000001000096E90000007E<br>-rw------- 1 ocz ocz 16M Jan 18 09:26 00000001000096E90000007F</font></div><div><span style="font-size: small; line-height: 19px;"  >-rw------- 1 ocz ocz 16M Jan 18 09:26 00000001000096E900000080</span><font size="2"  ><br>drwx------ 2 ocz ocz 44K Jan 18 09:26 archive_status</font></div><p></p></pre></div><div>启动数据库 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; pg_ctl start</font></div><div><font size="2"  >server starting</font></div><div><font size="2"  >ocz@db-172-16-3-150-&gt; LOG: &nbsp;00000: loaded library "pg_stat_statements"</font></div><div><font size="2"  >LOCATION: &nbsp;load_libraries, miscinit.c:1249</font></div><p></p></pre></div><div>查看日志中的数据库恢复过程, 直到数据库打开 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 19px;"  >ocz@db-172-16-3-150-&gt; cat postgresql-2013-01-18_092726.csv<br>2013-01-18 09:27:26.958 CST,,,6583,,50f8a4fe.19b7,1,,2013-01-18 09:27:26 CST,,0,LOG,00000,"database system was interrupted; last known up at 2013-01-18 09:24:28 CST",,,,,,,,"StartupXLOG, xlog.c:6136",""<br>2013-01-18 09:27:26.958 CST,,,6583,,50f8a4fe.19b7,2,,2013-01-18 09:27:26 CST,,0,LOG,00000,"database system was not properly shut down; automatic recovery in progress",,,,,,,,"StartupXLOG, xlog.c:6396",""<br>2013-01-18 09:27:26.963 CST,,,6583,,50f8a4fe.19b7,3,,2013-01-18 09:27:26 CST,,0,LOG,00000,"redo starts at 96E9/634883D8",,,,,,,,"StartupXLOG, xlog.c:6625",""<br>2013-01-18 09:28:10.703 CST,,,6583,,50f8a4fe.19b7,4,,2013-01-18 09:27:26 CST,,0,LOG,00000,"record with zero length at 96E9/8013A8A0",,,,,,,,"ReadRecord, xlog.c:3990",""<br>2013-01-18 09:28:10.703 CST,,,6583,,50f8a4fe.19b7,5,,2013-01-18 09:27:26 CST,,0,LOG,00000,"redo done at 96E9/8013A860",,,,,,,,"StartupXLOG, xlog.c:6770",""<br>2013-01-18 09:28:10.703 CST,,,6583,,50f8a4fe.19b7,6,,2013-01-18 09:27:26 CST,,0,LOG,00000,"last completed transaction was at log time 2013-01-18 09:26:08.780037+08",,,,,,,,"StartupXLOG, xlog.c:6775",""<br>2013-01-18 09:28:10.715 CST,,,6583,,50f8a4fe.19b7,7,,2013-01-18 09:27:26 CST,,0,LOG,00000,"checkpoint starting: end-of-recovery immediate",,,,,,,,"LogCheckpointStart, xlog.c:7602",""<br>2013-01-18 09:28:11.099 CST,,,6583,,50f8a4fe.19b7,8,,2013-01-18 09:27:26 CST,,0,LOG,00000,"checkpoint complete: wrote 14713 buffers (2.8%); 0 transaction log file(s) added, 0 removed, 0 recycled; write=0.165 s, sync=0.215 s, total=0.395 s; sync files=8, longest=0.176 s, average=0.026 s",,,,,,,,"LogCheckpointEnd, xlog.c:7690",""<br>2013-01-18 09:28:11.115 CST,,,6612,,50f8a52b.19d4,1,,2013-01-18 09:28:11 CST,,0,LOG,00000,"autovacuum launcher started",,,,,,,,"AutoVacLauncherMain, autovacuum.c:407",""<br>2013-01-18 09:28:11.116 CST,,,6581,,50f8a4fe.19b5,1,,2013-01-18 09:27:26 CST,,0,LOG,00000,"database system is ready to accept connections",,,,,,,,"reaper, postmaster.c:2408",""</span></font></div></pre></div><div>【其他】</div><div>1. 如果想保住所有的归档文件以及未归档成功的pg_xlog文件, 那就扩容吧。数据库启动后会自动继续归档未成功的XLOG。</div><div>2.&nbsp;<span style="line-height: 22px;"  >pg_xlog文件的命名规则可参考 :&nbsp;</span></div><div style="line-height: 22px;"  ><a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/"  >http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/</a></div><div style="line-height: 22px;"  >3. checkpoint和恢复时都会有删除pg_xlog不需要的文件的操作.</div><div style="line-height: 22px;"  >如下 :&nbsp;</div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >src/backend/access/transam/xlog.c</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >/*</font></div><div><font size="2"  >&nbsp;* Recycle or remove all log files older or equal to passed log/seg#</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* endptr is current (or recent) end of xlog; this is used to determine</font></div><div><font size="2"  >&nbsp;* whether we want to recycle rather than delete no-longer-wanted log files.</font></div><div><font size="2"  >&nbsp;*/</font></div><div><font size="2"  >static void</font></div><div><font size="2"  >RemoveOldXlogFiles(uint32 log, uint32 seg, XLogRecPtr endptr)</font></div><div><font size="2"  >{</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; uint32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;endlogId;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; uint32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;endlogSeg;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; max_advance;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; DIR &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*xldir;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; struct dirent *xlde;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lastoff[MAXFNAMELEN];</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;path[MAXPGPATH];</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >#ifdef WIN32</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;newpath[MAXPGPATH];</font></div><div><font size="2"  >#endif</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; struct stat statbuf;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Initialize info about where to try to recycle to. &nbsp;We allow recycling</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* segments up to XLOGfileslop segments beyond the current XLOG location.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; XLByteToPrevSeg(endptr, endlogId, endlogSeg);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; max_advance = XLOGfileslop;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; xldir = AllocateDir(XLOGDIR);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (xldir == NULL)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode_for_file_access(),</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("could not open transaction log directory \"%s\": %m",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XLOGDIR)));</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; XLogFileName(lastoff, ThisTimeLineID, log, seg);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; elog(DEBUG2, "attempting to remove WAL segments older than log file %s",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lastoff);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; while ((xlde = ReadDir(xldir, XLOGDIR)) != NULL)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* We ignore the timeline part of the XLOG segment identifiers in</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* deciding whether a segment is still needed. &nbsp;This ensures that we</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* won't prematurely remove a segment from a parent timeline. We could</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* probably be a little more proactive about removing segments of</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* non-parent timelines, but that would be a whole lot more</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* complicated.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* We use the alphanumeric sorting property of the filenames to decide</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* which ones are earlier than the lastoff segment.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (strlen(xlde-&gt;d_name) == 24 &amp;&amp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; strspn(xlde-&gt;d_name, "0123456789ABCDEF") == 24 &amp;&amp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; strcmp(xlde-&gt;d_name + 8, lastoff + 8) &lt;= 0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (RecoveryInProgress() || XLogArchiveCheckDone(xlde-&gt;d_name))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(path, MAXPGPATH, XLOGDIR "/%s", xlde-&gt;d_name);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Update the last removed location in shared memory first */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UpdateLastRemovedPtr(xlde-&gt;d_name);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Before deleting the file, see if it can be recycled as a</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* future log segment. Only recycle normal files, pg_standby</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* for example can create symbolic links pointing to a</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* separate archive directory.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (lstat(path, &amp;statbuf) == 0 &amp;&amp; S_ISREG(statbuf.st_mode) &amp;&amp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; InstallXLogFileSegment(&amp;endlogId, &amp;endlogSeg, path,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;true, &amp;max_advance, true))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(DEBUG2,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errmsg("recycled transaction log file \"%s\"",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xlde-&gt;d_name)));</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CheckpointStats.ckpt_segs_recycled++;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Needn't recheck that slot on future iterations */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (max_advance &gt; 0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NextLogSeg(endlogId, endlogSeg);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; max_advance--;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* No need for any more future segments... */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(DEBUG2,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errmsg("removing transaction log file \"%s\"",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xlde-&gt;d_name)));</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >#ifdef WIN32</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* On Windows, if another process (e.g another backend)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* holds the file open in FILE_SHARE_DELETE mode, unlink</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* will succeed, but the file will still show up in</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* directory listing until the last handle is closed. To</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* avoid confusing the lingering deleted file for a live</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* WAL file that needs to be archived, rename it before</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* deleting it.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* If another process holds the file open without</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* FILE_SHARE_DELETE flag, rename will fail. We'll try</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* again at the next checkpoint.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(newpath, MAXPGPATH, "%s.deleted", path);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (rename(path, newpath) != 0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode_for_file_access(),</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("could not rename old transaction log file \"%s\": %m",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; path)));</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; continue;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = unlink(newpath);</font></div><div><font size="2"  >#else</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = unlink(path);</font></div><div><font size="2"  >#endif</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (rc != 0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode_for_file_access(),</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("could not remove old transaction log file \"%s\": %m",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; path)));</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; continue;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CheckpointStats.ckpt_segs_removed++;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XLogArchiveCleanup(xlde-&gt;d_name);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; FreeDir(xldir);</font></div><div><font size="2"  >}</font></div><p></p></pre></div><div><br></div><div>调用删除函数 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >1.&nbsp;</font></div><div><font size="2"  >/*</font></div><div><font size="2"  >&nbsp;* Establish a restartpoint if possible.</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* This is similar to CreateCheckPoint, but is used during WAL recovery</font></div><div><font size="2"  >&nbsp;* to establish a point from which recovery can roll forward without</font></div><div><font size="2"  >&nbsp;* replaying the entire recovery log.</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* Returns true if a new restartpoint was established. We can only establish</font></div><div><font size="2"  >&nbsp;* a restartpoint if we have replayed a safe checkpoint record since last</font></div><div><font size="2"  >&nbsp;* restartpoint.</font></div><div><font size="2"  >&nbsp;*/</font></div><div><font size="2"  >bool</font></div><div><font size="2"  >CreateRestartPoint(int flags)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >2.&nbsp;</font></div><div><font size="2"  >/*</font></div><div><font size="2"  >&nbsp;* Perform a checkpoint --- either during shutdown, or on-the-fly</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* flags is a bitwise OR of the following:</font></div><div><font size="2"  >&nbsp;* &nbsp; &nbsp; &nbsp;CHECKPOINT_IS_SHUTDOWN: checkpoint is for database shutdown.</font></div><div><font size="2"  >&nbsp;* &nbsp; &nbsp; &nbsp;CHECKPOINT_END_OF_RECOVERY: checkpoint is for end of WAL recovery.</font></div><div><font size="2"  >&nbsp;* &nbsp; &nbsp; &nbsp;CHECKPOINT_IMMEDIATE: finish the checkpoint ASAP,</font></div><div><font size="2"  >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ignoring checkpoint_completion_target parameter.</font></div><div><font size="2"  >&nbsp;* &nbsp; &nbsp; &nbsp;CHECKPOINT_FORCE: force a checkpoint even if no XLOG activity has occurred</font></div><div><font size="2"  >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;since the last one (implied by CHECKPOINT_IS_SHUTDOWN or</font></div><div><font size="2"  >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CHECKPOINT_END_OF_RECOVERY).</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* Note: flags contains other bits, of interest here only for logging purposes.</font></div><div><font size="2"  >&nbsp;* In particular note that this routine is synchronous and does not pay</font></div><div><font size="2"  >&nbsp;* attention to CHECKPOINT_WAIT.</font></div><div><font size="2"  >&nbsp;*/</font></div><div><font size="2"  >void</font></div><div><font size="2"  >CreateCheckPoint(int flags)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Delete old log files (those no longer needed even for previous</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* checkpoint or the standbys in XLOG streaming).</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (_logId || _logSeg)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; KeepLogSeg(recptr, &amp;_logId, &amp;_logSeg);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PrevLogSeg(_logId, _logSeg);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RemoveOldXlogFiles(_logId, _logSeg, recptr);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div><div><br></div>【参考】<wbr><div>1.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020130109400557/"  >http://blog.163.com/digoal@126/blog/static/16387704020130109400557/</a></div><div>2.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201171233710582/"  >http://blog.163.com/digoal@126/blog/static/163877040201171233710582/</a></div><div>3.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/"  >http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/</a></div><div>4.&nbsp;src/include/catalog/pg_control.h</div><div>5. src/backend/access/transam/xlog.c</div></div>
	</div>
</div>
</body>
</html>