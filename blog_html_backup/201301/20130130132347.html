<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL extension Redis FDW update will support redis structured data types and support for restricted keyspace search</h2>
	<h5 id="">2013-01-30 13:23:47&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020130300142568/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>redis fdw更新了! 来自andrew的博客 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Today I've published a major revision to the Redis Foreign Data Wrapper code for use with PostgreSQL versions 9.2 and later. There are two new features: support for Redis structured data types and support for restricted keyspace search.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The structured data type support is enabled by using the table option "tabletype", which can take one of the values "hash", "list", "set" or "zset". If this option is used the data comes back as an array rather than as a simple scalar value. In the case of "hash" tables, the values are a sequence of key/value pairs. For the other types they are simply the elements of the relevant structure. If the values column of these tables is defined to be of type "text[]"(i.e. array of text) then an actual array is returned. If the column is a plain text column an array literal is returned. Hash table arrays in particular can be turned into records via hstore's "populate_record" functionality, or transformed in other useful ways.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Restricted keyspace search is enabled by using one of the table options "tablekeyprefix" or "tablekeyset". These are mutually exclusive. "tablekeyprefix" restricts the search to keys with the given prefix. However, in a very large Redis database this might still be expensive. In that case, it might be better to keep a list of the keys in a separate set, and this is supported using the "tablekeyset" option. When this is used the global keyspace isn't searched at all, and the list of keys is simply taken as the members of the set.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The new functionality is demonstrated in the test script (which is also new).&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >I am also working on some facilities to push data into Redis and similar things, but these fall outside the current possibility of a Foreign Data Wrapper, and will be announced separately.</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >在PostgreSQL 9.2+ 的版本中使用更新后的redis_fdw版本, 可以支持redis结构化数据类型, list, hash, zset, set.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >(9.2 and later) tabletype: can be 'hash', 'list', 'set' or 'zset' Default: none, meaning only look at scalar values.</font></div><div><font size="2"   >(9.2 and later) tablekeyprefix: only get items whose names start with the prefix. Default: none</font></div><div><font size="2"   >(9.2 and later) tablekeyset: fetch item names from the named set. Default: none</font></div><p></p></pre></div><div>如果foreign talbe参数中使用了tabletype设置list,hash,zset或者set. 那么外部表的value字段可以选择使用普通类型或者数组类型存储, 例如text存储或者text[]存储.</div><div>同时使用了tabletype后,&nbsp;</div><div>1. 可以使用tablekeyprefix限定key的名字.&nbsp;</div><div>2. 或者使用tablekeyset限定set的key名.(这个set中的value用作检索tabletype指定的数据结构的key值, 这样的话比使用tablekeyprefix限定更加方便)</div><div><br></div><div>使用举例 :&nbsp;</div><div>PostgreSQL 9.2.1</div><div>安装redis fdw</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >wget&nbsp;https://github.com/dpage/redis_fdw/archive/REL9_2_STABLE.zip</font></div><div><font size="2"   >unzip&nbsp;<span style="line-height: 22px;"   >REL9_2_STABLE.zip</span></font></div><div><font size="2"   ><span style="line-height: 22px;"   >mv&nbsp;</span>redis_fdw-<span style="line-height: 22px;"   >REL9_2_STABLE&nbsp;</span>postgresql-9.2.1/contrib</font></div><div><font size="2"   >su - root</font></div><div><font size="2"   >. /home/ocz/.bash_profile</font></div><div><font size="2"   >cd&nbsp;<span style="line-height: 22px;"   >postgresql-9.2.1/contrib/</span><span style="line-height: 22px;"   >redis_fdw-</span><span style="line-height: 22px;"   >REL9_2_STABLE</span></font></div><div><span style="line-height: 22px;"   ><font size="2"   >gmake clean</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >gmake</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >gmake install</font></span></div><p></p></pre></div><div><span style="line-height: 22px;"   >redis测试数据 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pgdev@db-172-16-3-150-&gt; redis-cli</font></div><div><div><font size="2"   >select 15</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >set foo bar</font></div><div><font size="2"   >set baz blurfl</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >sadd set1 m1 m2 m3 m4 m5 m6 m7 m8</font></div><div><font size="2"   >sadd set2 m8 m9 m10 m11 m12</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >lpush list1 e1 e2 e3 e4 e5 e6</font></div><div><font size="2"   >lpush list2 e7 e8 e9 e10</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >hmset hash1 k1 v1 k2 v2 k3 v3 k4 v4</font></div><div><font size="2"   >hmset hash2 k1 v5 k2 v6 k3 v7 k4 v8</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >zadd zset1 1 z1 2 z2 3 z3 4 z4 5 z5 6 z6</font></div><div><font size="2"   >zadd zset2 1 z7 2 z8 3 z9 4 z10 5 z11 6 z12</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >sadd hkeys hash1 hash2</font></div><div><font size="2"   >sadd lkeys list1 list2</font></div><div><font size="2"   >sadd skeys set1 set2</font></div><div><font size="2"   >sadd zkeys zset1 zset2</font></div></div><p></p></pre></div><div>输出 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >redis 127.0.0.1:6379&gt; select 15</font></div><div><font size="2"   >OK</font></div><div><font size="2"   >redis 127.0.0.1:6379[15]&gt;&nbsp;</font></div><div><font size="2"   >redis 127.0.0.1:6379[15]&gt; set foo bar</font></div><div><font size="2"   >OK</font></div><div><font size="2"   >redis 127.0.0.1:6379[15]&gt; set baz blurfl</font></div><div><font size="2"   >OK</font></div><div><font size="2"   >redis 127.0.0.1:6379[15]&gt;&nbsp;</font></div><div><font size="2"   >redis 127.0.0.1:6379[15]&gt; sadd set1 m1 m2 m3 m4 m5 m6 m7 m8</font></div><div><font size="2"   >(integer) 8</font></div><div><font size="2"   >redis 127.0.0.1:6379[15]&gt; sadd set2 m8 m9 m10 m11 m12</font></div><div><font size="2"   >(integer) 5</font></div><div><font size="2"   >redis 127.0.0.1:6379[15]&gt;&nbsp;</font></div><div><font size="2"   >redis 127.0.0.1:6379[15]&gt; lpush list1 e1 e2 e3 e4 e5 e6</font></div><div><font size="2"   >(integer) 6</font></div><div><font size="2"   >redis 127.0.0.1:6379[15]&gt; lpush list2 e7 e8 e9 e10</font></div><div><font size="2"   >(integer) 4</font></div><div><font size="2"   >redis 127.0.0.1:6379[15]&gt;&nbsp;</font></div><div><font size="2"   >redis 127.0.0.1:6379[15]&gt; hmset hash1 k1 v1 k2 v2 k3 v3 k4 v4</font></div><div><font size="2"   >OK</font></div><div><font size="2"   >redis 127.0.0.1:6379[15]&gt; hmset hash2 k1 v5 k2 v6 k3 v7 k4 v8</font></div><div><font size="2"   >OK</font></div><div><font size="2"   >redis 127.0.0.1:6379[15]&gt;&nbsp;</font></div><div><font size="2"   >redis 127.0.0.1:6379[15]&gt; zadd zset1 1 z1 2 z2 3 z3 4 z4 5 z5 6 z6</font></div><div><font size="2"   >(integer) 6</font></div><div><font size="2"   >redis 127.0.0.1:6379[15]&gt; zadd zset2 1 z7 2 z8 3 z9 4 z10 5 z11 6 z12</font></div><div><font size="2"   >(integer) 6</font></div><div><font size="2"   >redis 127.0.0.1:6379[15]&gt;&nbsp;</font></div><div><font size="2"   >redis 127.0.0.1:6379[15]&gt; sadd hkeys hash1 hash2</font></div><div><font size="2"   >(integer) 2</font></div><div><font size="2"   >redis 127.0.0.1:6379[15]&gt; sadd lkeys list1 list2</font></div><div><font size="2"   >(integer) 2</font></div><div><font size="2"   >redis 127.0.0.1:6379[15]&gt; sadd skeys set1 set2</font></div><div><font size="2"   >(integer) 2</font></div><div><font size="2"   >redis 127.0.0.1:6379[15]&gt; sadd zkeys zset1 zset2</font></div><div><font size="2"   >(integer) 2</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >使用redis_fdw :&nbsp;</span></div><div><span style="line-height: 22px;"   >1. 创建extension, server以及user mapping for server.</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   ><div>ocz@db-172-16-3-150-&gt; psql digoal</div><div>psql (9.2.1)</div><div>Type "help" for help.</div></font></span></div><div><span style="line-height: 22px;"   ><div><font size="2"   >digoal=# create extension redis_fdw;</font></div><div><font size="2"   >CREATE EXTENSION</font></div><div><div><font size="2"   >digoal=# CREATE SERVER redis_server FOREIGN DATA WRAPPER redis_fdw OPTIONS (address '127.0.0.1', port '6379');</font></div><div><font size="2"   >CREATE SERVER</font></div><div><font size="2"   >digoal=# CREATE USER MAPPING FOR PUBLIC SERVER redis_server;</font></div><div><font size="2"   >CREATE USER MAPPING</font></div></div></span></div><p></p></pre></div><div><div style="line-height: 22px;"   >创建基于database的普通的key value外部表.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# CREATE FOREIGN TABLE redis_db15_kv (key text, value text)&nbsp;</font></div><div><font size="2"   >digoal-# SERVER redis_server</font></div><div><font size="2"   >digoal-# OPTIONS (database '15');</font></div><div><font size="2"   >CREATE FOREIGN TABLE</font></div><div><font size="2"   >digoal=# select * from redis_db15_kv ;</font></div><div><font size="2"   >&nbsp;key | value &nbsp;</font></div><div><font size="2"   >-----+--------</font></div><div><font size="2"   >&nbsp;baz | blurfl</font></div><div><font size="2"   >&nbsp;foo | bar</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div style="line-height: 22px;"   >如果不指定database, &nbsp;默认是0, 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >Datum</font></span></div><div><font size="2"   >redis_fdw_validator(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >{</font></div><div><font size="2"   ><span> </span>List<span> </span> &nbsp; *options_list = untransformRelOptions(PG_GETARG_DATUM(0));</font></div><div><font size="2"   ><span> </span>Oid<span>   </span>catalog = PG_GETARG_OID(1);</font></div><div><font size="2"   ><span> </span>char<span> </span> &nbsp; *svr_address = NULL;</font></div><div><font size="2"   ><span> </span>int<span>   </span>svr_port = 0;</font></div><div><font size="2"   ><span> </span>char<span> </span> &nbsp; *svr_password = NULL;</font></div><div><font size="2"   ><span> </span>int<span>   </span>svr_database = 0;</font></div><div><font size="2"   ><span> </span>redis_table_type tabletype = PG_REDIS_SCALAR_TABLE;</font></div><div><font size="2"   ><span> </span>char &nbsp; &nbsp; &nbsp; *tablekeyprefix = NULL;</font></div><div><font size="2"   ><span> </span>char &nbsp; &nbsp; &nbsp; *tablekeyset = NULL;</font></div><div><font size="2"   ><span> </span>ListCell &nbsp; *cell;</font></div><p></p></pre></div><div style="line-height: 22px;"   >2. 创建基于database的所有hash的外部表. hash value以text存储.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# CREATE FOREIGN TABLE redis_db15_hash_all_vtext (key text, value text)&nbsp;</font></div><div><font size="2"   >digoal-# SERVER redis_server</font></div><div><font size="2"   >digoal-# OPTIONS (database '15', tabletype 'hash');</font></div><div><font size="2"   >CREATE FOREIGN TABLE</font></div><div><font size="2"   >digoal=# select * from redis_db15_hash_all_vtext ;</font></div><div><font size="2"   >&nbsp; key &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; value &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------+-------------------------------------------</font></div><div><font size="2"   >&nbsp;hash1 | {"k1","v1","k2","v2","k3","v3","k4","v4"}</font></div><div><font size="2"   >&nbsp;hash2 | {"k1","v5","k2","v6","k3","v7","k4","v8"}</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >3. 创建基于database的所有hash的外部表. hash value以text[]存储.</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# CREATE FOREIGN TABLE redis_db15_hash_all_vtext_array (key text, value text[])&nbsp;</font></div><div><font size="2"   >digoal-# SERVER redis_server</font></div><div><font size="2"   >digoal-# OPTIONS (database '15', tabletype 'hash');</font></div><div><font size="2"   >CREATE FOREIGN TABLE</font></div><div><font size="2"   >digoal=# select * from redis_db15_hash_all_vtext_array ;</font></div><div><font size="2"   >&nbsp; key &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; value &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------+---------------------------</font></div><div><font size="2"   >&nbsp;hash1 | {k1,v1,k2,v2,k3,v3,k4,v4}</font></div><div><font size="2"   >&nbsp;hash2 | {k1,v5,k2,v6,k3,v7,k4,v8}</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >4. 创建基于database的指定hash key值的外部表. hash value以text存储.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >使用tablekeyprfix指定 KEY值.</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# CREATE FOREIGN TABLE redis_db15_hash1_vtext (key text, value text) &nbsp;&nbsp;</font></div><div><font size="2"   >SERVER redis_server</font></div><div><font size="2"   >OPTIONS (database '15', tabletype 'hash', tablekeyprefix 'hash1');</font></div><div><font size="2"   >CREATE FOREIGN TABLE</font></div><div><font size="2"   >digoal=# select * from redis_db15_hash1_vtext ;</font></div><div><font size="2"   >&nbsp; key &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; value &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------+-------------------------------------------</font></div><div><font size="2"   >&nbsp;hash1 | {"k1","v1","k2","v2","k3","v3","k4","v4"}</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >5. 创建基于database的指定hash key值集合的外部表. hash value以text存储.</span></div><div style="line-height: 22px;"   >外部表包含的hash key值集合存储在redis的set结构中, 所以用tablekeyset指定了set的key值.</div></div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# CREATE FOREIGN TABLE redis_db15_hash_hkeys (key text, value text)&nbsp;</font></div><div><font size="2"   >digoal-# SERVER redis_server</font></div><div><font size="2"   >digoal-# OPTIONS (database '15', tabletype 'hash', tablekeyset 'hkeys');</font></div><div><font size="2"   >CREATE FOREIGN TABLE</font></div><div><font size="2"   >digoal=# select * from redis_db15_hash_hkeys ;</font></div><div><font size="2"   >&nbsp; key &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; value &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------+-------------------------------------------</font></div><div><font size="2"   >&nbsp;hash1 | {"k1","v1","k2","v2","k3","v3","k4","v4"}</font></div><div><font size="2"   >&nbsp;hash2 | {"k1","v5","k2","v6","k3","v7","k4","v8"}</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div style="line-height: 22px;"   >如果set中包含不存在的hash key, 那么这个hash 的value为空白的array结构, 注意不是NULL.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><div><font size="2"   >redis 127.0.0.1:6379[15]&gt; sadd hkeys emptyhask</font></div><div><font size="2"   >(integer) 1</font></div></div><div style="line-height: 22px;"   ><div><font size="2"   >digoal=# select * from redis_db15_hash_hkeys ;</font></div><div><font size="2"   >&nbsp; &nbsp; key &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; value &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----------+-------------------------------------------</font></div><div><font size="2"   >&nbsp;hash1 &nbsp; &nbsp; | {"k1","v1","k2","v2","k3","v3","k4","v4"}</font></div><div><font size="2"   >&nbsp;emptyhask | {}</font></div><div><font size="2"   >&nbsp;hash2 &nbsp; &nbsp; | {"k1","v5","k2","v6","k3","v7","k4","v8"}</font></div><div><font size="2"   >(3 rows)</font></div></div><p></p></pre></div><div style="line-height: 22px;"   >list, set, zset使用与hash类似, 不再举例.</div></div><div><br></div><div>【其他】</div><div>1. 如果tabletype='zset', 目前不取score, 只取member.</div><div><br></div>【参考】<div>1.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013024112341509/"   >http://blog.163.com/digoal@126/blog/static/1638770402013024112341509/</a></div><div>2.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="https://github.com/dpage/redis_fdw"   >https://github.com/dpage/redis_fdw</a></div><div><br><wbr></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL extension Redis FDW update will support redis structured data types and support for restricted keyspace search - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>