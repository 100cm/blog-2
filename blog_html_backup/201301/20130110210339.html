<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Change PostgreSQL TOAST_TUPLE_THRESHOLD</h2>
	<h5 id="">2013-01-10 21:03:39&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020130108132117/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">TOAST表的设计，在一个需要频繁更新(小字段更新)操作的表中非常有用，可以大大降低不必要的大字段带来的IO和CPU(大字段上有索引时) 。<div>优化场景可参考 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020130931040444/"  >http://blog.163.com/digoal@126/blog/static/16387704020130931040444/</a><br><div>但是PostgreSQL对什么时候启用TOAST存储做了限制,&nbsp;</div><div>检测是否需要TOAST的函数如下 :&nbsp;</div><div><div>src/backend/catalog/toasting.c</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >/*</font></div><div><font size="2"  >&nbsp;* Check to see whether the table needs a TOAST table. &nbsp;It does only if</font></div><div><font size="2"  >&nbsp;* (1) there are any toastable attributes, and (2) the maximum length</font></div><div><font size="2"  >&nbsp;* of a tuple could exceed TOAST_TUPLE_THRESHOLD. &nbsp;(We don't want to</font></div><div><font size="2"  >&nbsp;* create a toast table for something like "f1 varchar(20)".)</font></div><div><font size="2"  >&nbsp;*/</font></div><div><font size="2"  >static bool</font></div><div><font size="2"  >needs_toast_table(Relation rel)</font></div><div><font size="2"  >{</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; int32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data_length = 0;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; bool &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;maxlength_unknown = false;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; bool &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;has_toastable_attrs = false;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; TupleDesc &nbsp; &nbsp; &nbsp; tupdesc;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Form_pg_attribute *att;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; int32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tuple_length;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; tupdesc = rel-&gt;rd_att;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; att = tupdesc-&gt;attrs;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; for (i = 0; i &lt; tupdesc-&gt;natts; i++)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (att[i]-&gt;attisdropped)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; continue;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data_length = att_align_nominal(data_length, att[i]-&gt;attalign);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (att[i]-&gt;attlen &gt; 0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Fixed-length types are never toastable */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data_length += att[i]-&gt;attlen;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; maxlen = type_maximum_size(att[i]-&gt;atttypid,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;att[i]-&gt;atttypmod);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (maxlen &lt; 0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; maxlength_unknown = true;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data_length += maxlen;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (att[i]-&gt;attstorage != 'p')</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; has_toastable_attrs = true;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (!has_toastable_attrs)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return false; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* nothing to toast? */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (maxlength_unknown)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return true; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* any unlimited-length attrs? */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; tuple_length = MAXALIGN(offsetof(HeapTupleHeaderData, t_bits) +</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BITMAPLEN(tupdesc-&gt;natts)) +</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MAXALIGN(data_length);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; return (tuple_length &gt; TOAST_TUPLE_THRESHOLD);</font></div><div><font size="2"  >}</font></div><p></p></pre></div></div><div>TOAST_TUPLE_THRESHOLD如下 :&nbsp;</div><div>src/include/access/tuptoaster.h</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >/*</font></div><div><font size="2"  >&nbsp;* Find the maximum size of a tuple if there are to be N tuples per page.</font></div><div><font size="2"  >&nbsp;*/</font></div><div><font size="2"  >#define MaximumBytesPerTuple(tuplesPerPage) \</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; MAXALIGN_DOWN((BLCKSZ - \</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MAXALIGN(SizeOfPageHeaderData + (tuplesPerPage) * sizeof(ItemIdData))) \</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; / (tuplesPerPage))</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >/*</font></div><div><font size="2"  >&nbsp;* These symbols control toaster activation. &nbsp;If a tuple is larger than</font></div><div><font size="2"  >&nbsp;* TOAST_TUPLE_THRESHOLD, we will try to toast it down to no more than</font></div><div><font size="2"  >&nbsp;* TOAST_TUPLE_TARGET bytes through compressing compressible fields and</font></div><div><font size="2"  >&nbsp;* moving EXTENDED and EXTERNAL data out-of-line.</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* The numbers need not be the same, though they currently are. &nbsp;It doesn't</font></div><div><font size="2"  >&nbsp;* make sense for TARGET to exceed THRESHOLD, but it could be useful to make</font></div><div><font size="2"  >&nbsp;* it be smaller.</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* Currently we choose both values to match the largest tuple size for which</font></div><div><font size="2"  >&nbsp;* TOAST_TUPLES_PER_PAGE tuples can fit on a heap page.</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* XXX while these can be modified without initdb, some thought needs to be</font></div><div><font size="2"  >&nbsp;* given to needs_toast_table() in toasting.c before unleashing random</font></div><div><font size="2"  >&nbsp;* changes. &nbsp;Also see LOBLKSIZE in large_object.h, which can *not* be</font></div><div><font size="2"  >&nbsp;* changed without initdb.</font></div><div><font size="2"  >&nbsp;*/</font></div><div><font size="2"  >#define TOAST_TUPLES_PER_PAGE &nbsp; 4</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >#define TOAST_TUPLE_THRESHOLD &nbsp; MaximumBytesPerTuple(TOAST_TUPLES_PER_PAGE)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >#define TOAST_TUPLE_TARGET &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TOAST_TUPLE_THRESHOLD</font></div><p></p></pre></div><div>从上面定义可以得出, 如果你编译PostgreSQL时指定的数据块是8KB的,&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; --with-blocksize=BLOCKSIZE</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set table block size in kB [8]</font></div><p></p></pre></div><div>那么<span style="font-family: monospace; font-size: small; line-height: 19px; white-space: pre;"  >TOAST_TUPLE_THRESHOLD约为2KB</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >MAXALIGN_DOWN(</font></div><div><font size="2"  >&nbsp; (BLCKSZ - MAXALIGN(SizeOfPageHeaderData + (tuplesPerPage) * sizeof(ItemIdData)))&nbsp;</font></div><div><font size="2"  >&nbsp; /&nbsp;</font></div><div><font size="2"  >&nbsp; (tuplesPerPage)</font></div><div><font size="2"  >)</font></div><p></p></pre></div><div>如果想要在字段长度[可选压缩后]大于200字节后就启用TOAST, 可以调整TOAST_TUPLES_PER_PAGE为40.&nbsp;</div><div>重新编译即可.</div><div>重新编译后测试验证 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# create table test (info text);</font></div><div><font size="2"  >CREATE TABLE</font></div><p></p></pre></div><div>改为external, 不压缩. 这样更能看出结果.</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >postgres=# alter table test alter column info set storage external;</font></div><div><font size="2"  >ALTER TABLE</font></div></div><div><div><font size="2"  >postgres=# select pg_column_size(repeat('a', 200));</font></div><div><font size="2"  >&nbsp;pg_column_size&nbsp;</font></div><div><font size="2"  >----------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 204</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# insert into test values (repeat('a', 200));</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >postgres=# select pg_relation_size(reltoastrelid::regclass) from pg_class where relname='test';</font></div><div><font size="2"  >&nbsp;pg_relation_size&nbsp;</font></div><div><font size="2"  >------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8192</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div>可以看出200字节已经存储到TOAST表了.</div><div><br></div><div>在未修改<span style="font-family: monospace; font-size: small; line-height: 19px; white-space: pre;"  >TOAST_TUPLES_PER_PAGE</span>的PostgreSQL数据库中测试如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; truncate test;</font></div><div><font size="2"  >TRUNCATE TABLE</font></div><div><font size="2"  >digoal=&gt; insert into test values (repeat('a', 200));</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; select pg_relation_size(reltoastrelid::regclass) from pg_class where relname='test';</font></div><div><font size="2"  >&nbsp;pg_relation_size&nbsp;</font></div><div><font size="2"  >------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>可以<span style="line-height: 22px;"  >看出200字节未触发存储到TOAST表的动作</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; insert into test values (repeat('a', 2000));</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; select pg_relation_size(reltoastrelid::regclass) from pg_class where relname='test';</font></div><div><font size="2"  >&nbsp;pg_relation_size&nbsp;</font></div><div><font size="2"  >------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>2000字节未触发.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; insert into test values (repeat('a', 2100));</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; select pg_relation_size(reltoastrelid::regclass) from pg_class where relname='test';</font></div><div><font size="2"  >&nbsp;pg_relation_size&nbsp;</font></div><div><font size="2"  >------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8192</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>2100字节触发TOAST.</div><div><span style="line-height: 22px;"  >.</span></div><div>【参考】</div><div><div>1.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201122910531988/"  >http://blog.163.com/digoal@126/blog/static/1638770402012116115354333/</a></div><div>2.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201122910531988/"  >http://blog.163.com/digoal@126/blog/static/16387704020120524144140/</a></div><div>3.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201122910531988/"  >http://blog.163.com/digoal@126/blog/static/163877040201122910531988/</a></div></div></div><div>4.&nbsp;<span style="line-height: 22px;"  >src/include/access/tuptoaster.h</span></div><div><span style="line-height: 22px;"  >5.&nbsp;</span><span style="line-height: 22px;"  >src/backend/catalog/toasting.c</span></div></div>
	</div>
</div>
</body>
</html>