<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL partition table or inherits table predict count and gap and privilege monitor</h2>
	<h5 id="">2013-01-04 16:42:15&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020130433036377/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>当管理的数据库越来越多, 分区表也越来越多, 一个人可能要维护几十万的分区表. 对于分表的监控显得尤为重要.</div><div>本文基于PostgreSQL 9.2 进行讲解, 其他版本可能需要略微调整.</div>PostgreSQL 的分区表除了性能方面需要加强以外, 管理方面也需要加强.<wbr><div>例如,&nbsp;</div><div>一、分区表的气泡, 例如以下情况 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >父表:</font></div><div><font size="2"   >tbl</font></div><div><font size="2"   >子表 :&nbsp;</font></div><div><font size="2"   >tbl_2012_01</font></div><div><div style="line-height: 22px;"   ><font size="2"   >tbl_2012_02</font></div></div><div><div style="line-height: 22px;"   ><font size="2"   >tbl_2012_03</font></div></div><div><div style="line-height: 22px;"   ><font size="2"   >tbl_2012_05</font></div></div><div><div style="line-height: 22px;"   ><font size="2"   >tbl_2012_06</font></div></div><p></p></pre></div><div>以上分区表<span style="line-height: 22px;"   >tbl_2012_04不存在, 说明存在气泡.</span></div><div><br></div><div>二、分区表的子表权限和父表权限不一致,&nbsp;<span style="line-height: 22px;"   >例如以下情况 :&nbsp;</span></div><div>一般来说父表权限应该和子表权限一致, 什么时候可能遇到不一致的情况呢?&nbsp;</div><div>1. 新增了子表, 忘记给新增的子表赋予权限.</div><div>例如系统中有另外的用户需要读分区表, 在一段时间后新增了子表, 很有可能会忘记赋予权限.</div><div>PostgreSQL 9.0开始, 只要给主表赋权, 直接操作主表的话, 不需要子表权限. 但是直接查询子表的话, 还是需要赋权的.</div><div><pre class="prettyprint"   ><p><font size="2"   >Note how table access permissions are handled. Querying a parent table can automatically access data in child tables without further access privilege checking. This preserves the appearance that the data is (also) in the parent table. Accessing the child tables directly is, however, not automatically allowed and would require further privileges to be granted.</font></p></pre></div><div><span style="line-height: 22px;"   ><br></span></div><div>三、分区表的过期,&nbsp;<span style="line-height: 22px;"   >例如以下情况 :&nbsp;</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >父表:&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >tbl</font></div><div style="line-height: 22px;"   ><font size="2"   >子表 :&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >tbl_2012_12</font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >tbl_2013_01</font></div></div><p></p></pre></div><div><div style="line-height: 22px;"   >那么到2013年02月份的时候, 子表<span style="line-height: 22px;"   >tbl_2013_02还不存在, 通常会报表不存在的错误.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div><div style="line-height: 22px;"   >接下来将针对以上几种情况进行监控, 假设表名遵循以下规则 :&nbsp;</div><div style="line-height: 22px;"   >1. 表名中的日期使用标准的yyyy, mm, dd 格式.&nbsp;</div><div style="line-height: 22px;"   >&nbsp; 例如, tbl_2012_1_1 是不合法的,&nbsp;</div><div style="line-height: 22px;"   >&nbsp; &nbsp;应该改成tbl_2012_01_01.</div><div style="line-height: 22px;"   >2. 继承表的表名应该包含父表的表名作为前缀.</div><div style="line-height: 22px;"   >&nbsp; &nbsp; 例如, tbl, tbl_2014.</div><div style="line-height: 22px;"   ><br></div><div>监控还需要用到pg_inherits这个系统表, 其中inhseqno字段需要注意一下 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >&nbsp; If there is more than one direct parent for a child table (multiple inheritance), this number tells the order in which the inherited columns are to be arranged. The count starts at 1.</font></p></pre></div><div>当一个表直接继承多个父表的时候, 可用inhseqno来区分.</div><div>如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; create table t1(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=&gt; create table t2(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=&gt; create table t(id int) inherits(t1);</font></div><div><font size="2"   >NOTICE: &nbsp;merging column "id" with inherited definition</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >digoal=&gt; alter table t inherit t2;</font></div><div><font size="2"   >ALTER TABLE</font></div></div><div><div><font size="2"   >digoal=&gt; select inhparent::regclass,inhrelid::regclass,inhseqno from pg_inherits ;</font></div><div><font size="2"   >&nbsp;inhparent | inhrelid | inhseqno&nbsp;</font></div><div><font size="2"   >-----------+----------+----------</font></div><div><font size="2"   >&nbsp;t1 &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >&nbsp;t2 &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >(2 rows)</font></div></div><p></p></pre></div><div>解除继承后重新继承的话, inhseqno会增加.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; alter table t no inherit t1;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >digoal=&gt; alter table t inherit t1;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >digoal=&gt; select inhparent::regclass,inhrelid::regclass,inhseqno from pg_inherits ;</font></div><div><font size="2"   >&nbsp;inhparent | inhrelid | inhseqno&nbsp;</font></div><div><font size="2"   >-----------+----------+----------</font></div><div><font size="2"   >&nbsp;t2 &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >&nbsp;t1 &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;3</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >在被监控的数据库中创建2个函数, 1个视图 :&nbsp;</div><div style="line-height: 22px;"   >通过pg_class.oid获取权限的函数, 用于比较子表的权限和父表的权限是否一致 .&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace function mon_part_get_acl(i_oid oid) returns aclitem[] as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; result aclitem[] := '{}'::aclitem[];</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select relacl into result from pg_class where oid=i_oid and relacl is not null;</font></div><div><font size="2"   >&nbsp; if found then</font></div><div><font size="2"   >&nbsp; &nbsp; return result;</font></div><div><font size="2"   >&nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; return '{}'::aclitem[];</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >exception when others then</font></div><div><font size="2"   >&nbsp; return '{}'::aclitem[];</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql;</font></div><p></p></pre></div><div><br></div><div>把表名的数字转成日期的函数, 用于分析gap等.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >create or replace function mon_part_conv_to_date(i_relname text, i_prefix text) returns date as $$<br>declare<br>  v_len int;<br>  v_date text := '';<br>  i text := '';<br>  v_suffix text := '';<br>begin<br>  v_suffix := replace(i_relname,i_prefix,'');<br>  FOREACH i IN ARRAY regexp_split_to_array(v_suffix, '')<br>  loop<br>    if (i &gt;= '0' and i &lt;= '9') then<br>      v_date := v_date||i;<br>    end if;<br>  end loop;<br>  v_len := length(v_date);<br>  -- the first 2str must 18,19,20,21,22<br>  if (substr(v_date,1,2) &gt;= '18' and substr(v_date,1,2) &lt;= '22' ) then<br>    if (v_len &gt;= 4 and v_len &lt;=8) then<br>      case v_len<br>      when 4 then<br>        return (v_date||'0101')::date;<br>      when 6 then<br>        return (v_date||'01')::date;<br>      when 8 then<br>        return v_date::date;<br>      else<br>        return '19700101'::date;<br>      end case;<br>    else <br>      -- not a valid date<br>      return '22220101';<br>    end if;<br>  else<br>    -- not a valid date<br>    return '22220101';<br>  end if;<br>exception when others then<br>  raise notice 'partition table name date format error.';<br>  return '19700101'::date;<br>end;<br>$$ language plpgsql;</span></font></div><p></p></pre></div><div><br></div><div>视图 :&nbsp;</div><div>根据间隔的平均值来评估是否出现了分区异常.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >create or replace view v_mon_partition_tables as <br>select <br>  *,<br>  (max_pdate-current_date)/predict_gap::numeric AS future_tables_cnt<br>from <br>(<br>select <br>  *,<br>  pdate-lag_pdate AS gap,<br>  case <br>  when pdate-lag_pdate &gt;=365 then  -- 预计按年分区<br>    pdate - date_trunc('day', (pdate - interval '1 year'))::date<br>  when pdate-lag_pdate &gt;=28 then  -- 预计按月分区<br>    pdate - date_trunc('day', (pdate - interval '1 month'))::date<br>  when pdate-lag_pdate &gt;=1 then  -- 预计按日分区<br>    1<br>  else <br>    0.9  -- 分区间隔小于1天<br>  end AS predict_gap<br>from <br>(<br>select <br>  row_number() over (partition by inhparent order by mon_part_conv_to_date(inhrelid::regclass::text,inhparent::regclass::text)) AS rn,<br>  current_database() AS dbname, <br>  inhparent::regclass::text AS inhparent, <br>  lag(inhrelid::regclass::text,1) over (partition by inhparent order by mon_part_conv_to_date(inhrelid::regclass::text,inhparent::regclass::text)) AS lag_inhrelid,<br>  inhrelid::regclass::text AS inhrelid, <br>  mon_part_get_acl(inhparent) AS acl_inhparent, <br>  mon_part_get_acl(inhrelid) AS acl_inhrelid, <br>  mon_part_conv_to_date(inhrelid::regclass::text,inhparent::regclass::text) AS pdate, <br>  lag(mon_part_conv_to_date(inhrelid::regclass::text,inhparent::regclass::text), 1) over (partition by inhparent order by mon_part_conv_to_date(inhrelid::regclass::text,inhparent::regclass::text)) AS lag_pdate,<br>  max(mon_part_conv_to_date(inhrelid::regclass::text,inhparent::regclass::text)) over (partition by inhparent) AS max_pdate<br>from pg_inherits <br>) t <br>) t;</span></font></div><p></p></pre></div><div>视图结构如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp;View "payment.v_mon_partition_tables"</font></div><div><font size="2"   ><span style="line-height: 21px;"   >      Column       |   Type    | Modifiers <br>-------------------+-----------+-----------<br> rn                | bigint    | <br> dbname            | name      | <br> inhparent         | text      | <br> lag_inhrelid      | text      | <br> inhrelid          | text      | <br> acl_inhparent     | aclitem[] | <br> acl_inhrelid      | aclitem[] | <br> pdate             | date      | <br> lag_pdate         | date      | <br> max_pdate         | date      | <br> gap               | integer   | <br> predict_gap       | numeric   | <br> future_tables_cnt | numeric   | </span></font></div><p></p></pre></div><div><br></div><div>监控日期继承表存在气泡SQL,</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >select * from v_mon_partition_tables<br>  where <br>  gap&lt;&gt;predict_gap <br>  and pdate &lt;&gt; '22220101'::date <br>  and lag_pdate is not null;</span></font></div><p></p></pre></div><div><br></div><div>监控过期的子表</div><div>例如保持未来有10个子表可用,并且未来2年(731day)都有子表已经创建,</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >select * from<br>(<br>select dbname,inhparent,lag_inhrelid,inhrelid,max_pdate,predict_gap,future_tables_cnt,row_number() over (partition by inhparent order by pdate desc) AS rn<br>from v_mon_partition_tables<br>  where <br>  (future_tables_cnt&lt;=10 or max_pdate - current_date &lt;731) <br>  and pdate &lt;&gt; '22220101'::date <br>  and lag_pdate is not null<br>) t order by rn;</span></font></div><p></p></pre></div><div><br></div><div>继承表的权限是否一致,</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select * from v_mon_partition_tables</font></div><div><font size="2"   >&nbsp; where acl_inhparent&lt;&gt;acl_inhrelid;</font></div><p></p></pre></div></div></div></div><div><br></div><div>测试 :&nbsp;</div><div>1.&nbsp;<span style="line-height: 22px;"   >监控日期继承表存在气泡SQL,</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >digoal=&gt; create table tbl(id int, crt_time timestamp(0));<br>CREATE TABLE<br>digoal=&gt; create table tbl_201201 (id int, crt_time timestamp(0)) inherits(tbl);<br>NOTICE:  merging column "id" with inherited definition<br>NOTICE:  merging column "crt_time" with inherited definition<br>CREATE TABLE<br>digoal=&gt; create table tbl_201202 (id int, crt_time timestamp(0)) inherits(tbl);<br>NOTICE:  merging column "id" with inherited definition<br>NOTICE:  merging column "crt_time" with inherited definition<br>CREATE TABLE<br>digoal=&gt; create table tbl_201204 (id int, crt_time timestamp(0)) inherits(tbl);<br>NOTICE:  merging column "id" with inherited definition<br>NOTICE:  merging column "crt_time" with inherited definition<br>CREATE TABLE<br>digoal=&gt; create table tbl_201205 (id int, crt_time timestamp(0)) inherits(tbl);<br>NOTICE:  merging column "id" with inherited definition<br>NOTICE:  merging column "crt_time" with inherited definition<br>CREATE TABLE<br>digoal=&gt; select * from v_mon_partition_tables<br>  where <br>  gap&lt;&gt;predict_gap <br>  and pdate &lt;&gt; '22220101'::date <br>  and lag_pdate is not null;<br> dbname | inhparent |  inhrelid  |   pdate    | lag_pdate  | gap | predict_gap <br>--------+-----------+------------+------------+------------+-----+-------------<br> digoal | tbl       | tbl_201204 | 2012-04-01 | 2012-02-01 |  60 |          31<br>(1 row)</span></font></div><p></p></pre></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >2.&nbsp;</span><span style="line-height: 22px;"   >何时过期监控SQL,&nbsp;</span><span style="line-height: 22px;"   >例如保持未来有10个子表可用,并且未来2年(731day)都有子表已经创建,</span></div><div><div><pre class="prettyprint"   ><p style="line-height: 22px;"   ></p><div><font size="2"   ><span style="line-height: 22px;"   >select * from<br>(<br>select dbname,inhparent,lag_inhrelid,inhrelid,max_pdate,predict_gap,future_tables_cnt,row_number() over (partition by inhparent order by pdate desc) AS rn<br>from v_mon_partition_tables<br>  where <br>  (future_tables_cnt&lt;=10 or max_pdate - current_date &lt;731) <br>  and pdate &lt;&gt; '22220101'::date <br>  and lag_pdate is not null<br>) t order by rn;</span></font></div><div><font size="2"   ><span style="line-height: 22px;"   ><br></span></font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;dbname | inhparent | &nbsp;inhrelid &nbsp;| &nbsp; pdate &nbsp; &nbsp;| max_pdate &nbsp;| gap | &nbsp;future_tables_cnt &nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >--------+-----------+------------+------------+------------+-----+---------------------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201202 | 2012-02-01 | 2012-05-01 | &nbsp;31 | -8.0000000000000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201204 | 2012-04-01 | 2012-05-01 | &nbsp;60 | -8.0000000000000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201205 | 2012-05-01 | 2012-05-01 | &nbsp;30 | -8.2666666666666667</font></div><div style="line-height: 22px;"   ><font size="2"   >(3 rows)</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >创建超过未来2年的子表(现在是2013-01) :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >create table tbl_201206 (id int, crt_time timestamp(0)) inherits(tbl);</font></div></div><div><font size="2"   >.....................</font></div><div><font size="2"   >create table tbl_201507 (id int, crt_time timestamp(0)) inherits(tbl);</font></div><p></p></pre></div></div><div>再次执行监控SQL :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >select * from<br>(<br>select dbname,inhparent,lag_inhrelid,inhrelid,max_pdate,predict_gap,future_tables_cnt,row_number() over (partition by inhparent order by pdate desc) AS rn<br>from v_mon_partition_tables<br>  where <br>  (future_tables_cnt&lt;=10 or max_pdate - current_date &lt;731) <br>  and pdate &lt;&gt; '22220101'::date <br>  and lag_pdate is not null<br>) t order by rn;</span></font></div><div><font size="2"   ><span style="line-height: 21px;"   ><br></span></font></div><div><font size="2"   >&nbsp;dbname | inhparent | inhrelid | pdate | max_pdate | gap | future_tables_cnt&nbsp;</font></div><div><font size="2"   >--------+-----------+----------+-------+-----------+-----+-------------------</font></div><div><font size="2"   >(0 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >3.&nbsp;</span><span style="line-height: 22px;"   >继承表的权限是否一致,</span></div><div><span style="line-height: 22px;"   >当前未赋任何权限, 所以权限是一致的.</span></div><div><span style="line-height: 22px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; &nbsp;select dbname,inhparent,inhrelid,acl_inhparent,acl_inhrelid from v_mon_partition_tables</font></div><div><font size="2"   >digoal-&gt; &nbsp; where acl_inhparent&lt;&gt;acl_inhrelid;</font></div><div><font size="2"   >&nbsp;dbname | inhparent | inhrelid | acl_inhparent | acl_inhrelid&nbsp;</font></div><div><font size="2"   >--------+-----------+----------+---------------+--------------</font></div><div><font size="2"   >(0 rows)</font></div><p></p></pre></div><div>当修改父表的权限后, 如果未给子表赋予权限, 那么权限将不一致, 所以查询有结果 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; grant select on tbl to skycac;</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >digoal=&gt; &nbsp;select dbname,inhparent,inhrelid,acl_inhparent,acl_inhrelid from v_mon_partition_tables</font></div><div><font size="2"   >&nbsp; where acl_inhparent&lt;&gt;acl_inhrelid;</font></div><div><font size="2"   >&nbsp;dbname | inhparent | &nbsp;inhrelid &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;acl_inhparent &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| acl_inhrelid&nbsp;</font></div><div><font size="2"   >--------+-----------+------------+-----------------------------------------+--------------</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201201 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201202 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201204 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201205 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201206 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201207 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201208 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201209 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201210 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201211 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201212 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201301 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201302 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201303 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201304 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201305 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201306 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201307 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201308 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201309 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201310 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201311 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201312 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201401 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201402 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201403 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201404 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201405 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201406 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201407 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201408 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201409 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201410 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201411 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201412 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201501 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201502 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201503 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201504 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201505 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201506 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201507 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}</font></div><div><font size="2"   >(42 rows)</font></div><p></p></pre></div></span></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >-----------------------------------------------------------------------------------------------------------------------</span></div><div><span style="line-height: 22px;"   >脚本中未修改, 以上SQL已调整, 注意同步调整以下脚本的内容.</span></div><div><span style="line-height: 22px;"   >-----------------------------------------------------------------------------------------------------------------------</span></div><div>用以上的SQL写个SHELL脚本就可以进行监控了, 或者结合nagios来进行监控.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; cat t.sh</font></div><div><font size="2"   >#!/bin/bash<br># 环境变量<br>export LANG=en_US.utf8<br>export PGHOME=/opt/pgsql<br>export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib<br>export PATH=$PGHOME/bin:$PATH:.<br><br># 参数判断<br>if [ $# -ne 3 ]; then<br>echo -e "Please check your parameter."<br>echo -e "$0 HOST PORT ROLE \n"<br>exit 1<br>fi<br><br>TODAY=`date +%Y%m%d`<br>EMAIL="digoal@126.com"<br><br>HOST=$1<br>PORT=$2<br>ROLE=$3<br><br>for DB in `psql -q -t -h $HOST -p $PORT -U $ROLE postgres -c "select datname from pg_database where datname not in ('postgres','template0','template1')"`<br>do<br>echo -e "------`date +%F\ %T`----Partition Table MON----IP:$HOST PORT:$PORT DBNAME:$DB------"<br>psql -h $HOST -p $PORT -U $ROLE $DB &lt;&lt;EOF<br>create or replace function mon_part_get_acl(i_oid oid) returns aclitem[] as \$\$<br>declare<br>  result aclitem[] := '{}'::aclitem[];<br>begin<br>  select relacl into result from pg_class where oid=i_oid and relacl is not null;<br>  if found then<br>    return result;<br>  else<br>    return '{}'::aclitem[];<br>  end if;<br>exception when others then<br>  return '{}'::aclitem[];<br>end;<br>\$\$ language plpgsql;<br><br>create or replace function mon_part_conv_to_date(i_relname text) returns date as \$\$<br>declare<br>  v_len int;<br>  v_date text := '';<br>  i text := '';<br>begin<br>  FOREACH i IN ARRAY regexp_split_to_array(i_relname, '')<br>  loop<br>    if (i &gt;= '0' and i &lt;= '9') then<br>      v_date := v_date||i;<br>    end if;<br>  end loop;<br>  v_len := length(v_date);<br>  -- the first 2str must 18,19,20,21,22<br>  if (substr(v_date,1,2) &gt;= '18' and substr(v_date,1,2) &lt;= '22' ) then<br>    if (v_len &gt;= 4 and v_len &lt;=8) then<br>      case v_len<br>      when 4 then<br>        return (v_date||'0101')::date;<br>      when 6 then<br>        return (v_date||'01')::date;<br>      when 8 then<br>        return v_date::date;<br>      else<br>        return '19700101'::date;<br>      end case;<br>    else <br>      -- not a valid date<br>      return '22220101';<br>    end if;<br>  else<br>    -- not a valid date<br>    return '22220101';<br>  end if;<br>exception when others then<br>  raise notice 'partition table name date format error.';<br>  return '19700101'::date;<br>end;<br>\$\$ language plpgsql;<br><br>create or replace view v_mon_partition_tables as <br>select <br>  *,<br>  (max_pdate-current_date)/predict_gap::numeric AS future_tables_cnt<br>from <br>(<br>select <br>  *,<br>  pdate-lag_pdate AS gap,<br>  case <br>  when pdate-lag_pdate &gt;=365 then<br>    pdate - date_trunc('year', (pdate - interval '1 year'))::date<br>  when pdate-lag_pdate &gt;=28 then<br>    pdate - date_trunc('month', (pdate - interval '1 month'))::date<br>  when pdate-lag_pdate &gt;=7 then<br>    pdate-lag_pdate<br>  when pdate-lag_pdate &gt;=1 then<br>    pdate - date_trunc('day', (pdate - interval '1 day'))::date<br>  else <br>    0.9<br>  end AS predict_gap<br>from <br>(<br>select <br>  row_number() over (partition by inhparent order by mon_part_conv_to_date((inhrelid::regclass)::text)) AS rn,<br>  current_database() AS dbname, <br>  (inhparent::regclass)::text AS inhparent, <br>  (inhrelid::regclass)::text AS inhrelid, <br>  mon_part_get_acl(inhparent) AS acl_inhparent, <br>  mon_part_get_acl(inhrelid) AS acl_inhrelid, <br>  mon_part_conv_to_date((inhrelid::regclass)::text) AS pdate, <br>  lag(mon_part_conv_to_date((inhrelid::regclass)::text), 1) over (partition by inhparent order by mon_part_conv_to_date((inhrelid::regclass)::text)) AS lag_pdate,<br>  max(mon_part_conv_to_date((inhrelid::regclass)::text)) over (partition by inhparent) AS max_pdate<br>from pg_inherits <br>) t <br>) t;<br><br>select '-- 监控日期继承表气泡:' as monitor;<br>select dbname,inhparent,inhrelid,pdate,lag_pdate,gap,predict_gap from v_mon_partition_tables<br>  where <br>  gap&lt;&gt;predict_gap <br>  and pdate &lt;&gt; '22220101'::date <br>  and lag_pdate is not null;<br><br>select '-- 监控日期继承表过期(需满足大于未来10个表,且大于未来2年(731day)):' as monitor;<br>select * from<br>(<br>select dbname,inhparent,inhrelid,max_pdate,predict_gap,future_tables_cnt,row_number() over (partition by inhparent order by pdate desc) AS rn<br>from v_mon_partition_tables<br>  where <br>  (future_tables_cnt&lt;=10 or max_pdate - current_date &lt;731) <br>  and pdate &lt;&gt; '22220101'::date <br>  and lag_pdate is not null<br>) t<br>where rn=1;<br><br>select '-- 监控所有继承表的权限和父表是否一致,输出含有不一致的父表名称:' as monitor;<br>select server_ip,server_port,dbname,name_inhparent<br>  from mon_inherits<br>  where acl_inhparent&lt;&gt;acl_inhrelid<br>  group by server_ip,server_port,dbname,name_inhparent;<br><br>EOF<br>done</font></div><p></p></pre></div><div><br></div><div>执行 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; ./t.sh 127.0.0.1 9201 postgres</font></div><div><font size="2"   ><span style="line-height: 19px;"   >------2013-01-04 17:14:16----Partition Table MON----IP:127.0.0.1 PORT:9201 DBNAME:digoal------<br>CREATE FUNCTION<br>CREATE FUNCTION<br>CREATE VIEW<br>          monitor           <br>----------------------------<br> -- </span></font><span style="font-size: small; line-height: 19px;"   >监控日期继承表气泡</span><font size="2"   ><span style="line-height: 19px;"   >:<br>(1 row)<br><br> dbname | inhparent  |     inhrelid      |   pdate    | lag_pdate  | gap | predict_gap <br>--------+------------+-------------------+------------+------------+-----+-------------<br> digoal | digoal.tbl | digoal.tbl_201204 | 2012-04-01 | 2012-02-01 |  60 |          31<br>(1 row)<br><br>            monitor             <br>--------------------------------<br> -- </span></font><span style="font-size: small; line-height: 19px;"   >监控日期继承表过期(需满足大于未来10个表,且大于未来2年(731day))</span><font size="2"   ><span style="line-height: 19px;"   >:<br>(1 row)<br><br> dbname | inhparent | inhrelid | max_pdate | predict_gap | future_tables_cnt | rn <br>--------+-----------+----------+-----------+-------------+-------------------+----<br>(0 rows)<br><br>     monitor      <br>------------------<br> -- </span></font><span style="font-size: small; line-height: 19px;"   >监控所以继承表的权限和父表是否一致,输出不一致的</span><font size="2"   ><span style="line-height: 19px;"   >:<br>(1 row)<br><br> dbname | inhparent  |     inhrelid      |              acl_inhparent              | acl_inhrelid <br>--------+------------+-------------------+-----------------------------------------+--------------<br> digoal | digoal.tbl | digoal.tbl_201201 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201202 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201204 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201205 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201206 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201207 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201208 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201209 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201210 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201211 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201212 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201301 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201302 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201303 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201304 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201305 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201306 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201307 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201308 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201309 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201310 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201311 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201312 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201401 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201402 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201403 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201404 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201405 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201406 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201407 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201408 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201409 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201410 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201411 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201412 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201501 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201502 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201503 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201504 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201505 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201506 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br> digoal | digoal.tbl | digoal.tbl_201507 | {digoal=arwdDxt/digoal,skycac=r/digoal} | {}<br>(42 rows)<br><br>------2013-01-04 17:14:16----Partition Table MON----IP:127.0.0.1 PORT:9201 DBNAME:skycac------<br>CREATE FUNCTION<br>CREATE FUNCTION<br>CREATE VIEW<br>          monitor           <br>----------------------------<br> -- </span></font><span style="font-size: small; line-height: 19px;"   >监控日期继承表气泡</span><font size="2"   ><span style="line-height: 19px;"   >:<br>(1 row)<br><br> dbname | inhparent | inhrelid | pdate | lag_pdate | gap | predict_gap <br>--------+-----------+----------+-------+-----------+-----+-------------<br>(0 rows)<br><br>            monitor             <br>--------------------------------<br> -- </span></font><span style="font-size: small; line-height: 19px;"   >监控日期继承表过期(需满足大于未来10个表,且大于未来2年(731day))</span><font size="2"   ><span style="line-height: 19px;"   >:<br>(1 row)<br><br> dbname | inhparent | inhrelid | max_pdate | predict_gap | future_tables_cnt | rn <br>--------+-----------+----------+-----------+-------------+-------------------+----<br>(0 rows)<br><br>     monitor      <br>------------------<br> -- </span></font><span style="font-size: small; line-height: 19px;"   >监控所以继承表的权限和父表是否一致,输出不一致的</span><font size="2"   ><span style="line-height: 19px;"   >:<br>(1 row)<br><br> dbname | inhparent | inhrelid | acl_inhparent | acl_inhrelid <br>--------+-----------+----------+---------------+--------------<br>(0 rows)</span></font></div><p></p></pre></div><div><br></div><div>如果是远程监控可以编辑PGPASSFILE进行.</div><br><div>【其他】</div><div>1. 当月表要变日表时, 不影响监控, 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create table tbl_20150801(like tbl) inherits(tbl);</font></div><div><font size="2"   >NOTICE: &nbsp;merging column "id" with inherited definition</font></div><div><font size="2"   >NOTICE: &nbsp;merging column "crt_time" with inherited definition</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=&gt; create table tbl_20150802(like tbl) inherits(tbl);</font></div><div><font size="2"   >NOTICE: &nbsp;merging column "id" with inherited definition</font></div><div><font size="2"   >NOTICE: &nbsp;merging column "crt_time" with inherited definition</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=&gt; create table tbl_20150803(like tbl) inherits(tbl);</font></div><div><font size="2"   >NOTICE: &nbsp;merging column "id" with inherited definition</font></div><div><font size="2"   >NOTICE: &nbsp;merging column "crt_time" with inherited definition</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=&gt; select dbname,inhparent,inhrelid,pdate,lag_pdate,gap,predict_gap from v_mon_partition_tables</font></div><div><font size="2"   >digoal-&gt; &nbsp; where&nbsp;</font></div><div><font size="2"   >digoal-&gt; &nbsp; gap&lt;&gt;predict_gap&nbsp;</font></div><div><font size="2"   >digoal-&gt; &nbsp; and pdate &lt;&gt; '22220101'::date&nbsp;</font></div><div><font size="2"   >digoal-&gt; &nbsp; and lag_pdate is not null;</font></div><div><font size="2"   >&nbsp;dbname | inhparent | &nbsp;inhrelid &nbsp;| &nbsp; pdate &nbsp; &nbsp;| lag_pdate &nbsp;| gap | predict_gap&nbsp;</font></div><div><font size="2"   >--------+-----------+------------+------------+------------+-----+-------------</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201204 | 2012-04-01 | 2012-02-01 | &nbsp;60 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;31</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>当日表想变成月表时, 需要注意一定要补齐月末的表 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create table tbl_201509(like tbl) inherits(tbl);</font></div><div><font size="2"   >NOTICE: &nbsp;merging column "id" with inherited definition</font></div><div><font size="2"   >NOTICE: &nbsp;merging column "crt_time" with inherited definition</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=&gt; select dbname,inhparent,inhrelid,pdate,lag_pdate,gap,predict_gap from v_mon_partition_tables</font></div><div><font size="2"   >&nbsp; where&nbsp;</font></div><div><font size="2"   >&nbsp; gap&lt;&gt;predict_gap&nbsp;</font></div><div><font size="2"   >&nbsp; and lag_pdate is not null;</font></div><div><font size="2"   >&nbsp;dbname | inhparent | &nbsp;inhrelid &nbsp;| &nbsp; pdate &nbsp; &nbsp;| lag_pdate &nbsp;| gap | predict_gap&nbsp;</font></div><div><font size="2"   >--------+-----------+------------+------------+------------+-----+-------------</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201204 | 2012-04-01 | 2012-02-01 | &nbsp;60 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;31</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201509 | 2015-09-01 | 2015-08-03 | &nbsp;29 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;31</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>补齐后, 监控恢复正常 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >create table tbl_20150804(like tbl) inherits(tbl);</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >................</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >create table tbl_20150831(like tbl) inherits(tbl);</font></span></div><div><div><font size="2"   >digoal=&gt; select dbname,inhparent,inhrelid,pdate,lag_pdate,gap,predict_gap from v_mon_partition_tables</font></div><div><font size="2"   >digoal-&gt; &nbsp; where&nbsp;</font></div><div><font size="2"   >digoal-&gt; &nbsp; gap&lt;&gt;predict_gap&nbsp;</font></div><div><font size="2"   >digoal-&gt; &nbsp; and lag_pdate is not null;</font></div><div><font size="2"   >&nbsp;dbname | inhparent | &nbsp;inhrelid &nbsp;| &nbsp; pdate &nbsp; &nbsp;| lag_pdate &nbsp;| gap | predict_gap&nbsp;</font></div><div><font size="2"   >--------+-----------+------------+------------+------------+-----+-------------</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp; &nbsp; &nbsp; | tbl_201204 | 2012-04-01 | 2012-02-01 | &nbsp;60 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;31</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>2. 非法表名监控, 一定要清理掉所有非法表名的分区表. 否则这个监控就有暗病.</div><div>3. 人为的每个月一次例行检查还是要的, 因为这个脚本不能适合所有场景.</div><div><br></div><div>【统一监控】</div><div>方法, 1. 将被监控的数据库中的继承表的信息统一收集到一个监控数据库中, 2. 在监控数据库中进行分析.</div><div><div>监控库如下(存放所有收集到的生产数据库的继承表信息) :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >HOST=172.16.3.150</font></div><div><font size="2"   >PORT=1921</font></div><div><font size="2"   >DBNAME=digoal</font></div><div><font size="2"   >ROLE=digoal</font></div><div><font size="2"   >SCHEMA=digoal</font></div><p></p></pre></div><div>创建存储继承表信息的表, 如下.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create table mon_inherits (</font></div><div><font size="2"   >&nbsp; server_ip inet,&nbsp;</font></div><div><font size="2"   >&nbsp; server_port int,</font></div><div><font size="2"   >&nbsp; dbname name,</font></div><div><font size="2"   >&nbsp; inhrelid oid,</font></div><div><font size="2"   >&nbsp; inhparent oid,</font></div><div><font size="2"   >&nbsp; inhseqno int,</font></div><div><font size="2"   >&nbsp; name_inhrelid text,</font></div><div><font size="2"   >&nbsp; name_inhparent text,</font></div><div><font size="2"   >&nbsp; acl_inhrelid text[],</font></div><div><font size="2"   >&nbsp; acl_inhparent text[],</font></div><div><font size="2"   >&nbsp; crt_time timestamp</font></div><div><font size="2"   >);</font></div><div><font size="2"   >创建唯一约束 :&nbsp;</font></div><div><font size="2"   >create unique index idx_mon_inherits_1 on mon_inherits(server_ip, server_port, dbname, inhrelid, inhseqno);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >创建数组排序函数, 原因见本文末尾 : </font></div><div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create or replace function mon_array_sort(i_arr text[]) returns text[] as $$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; result text[];</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; select array_agg(arr order by arr) into result from unnest(i_arr) t(arr);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; return result;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >end;</font></div></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >$$ language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >创建白名单表(用于过滤不是按日期分表的继承表)</font></div><div><font size="2"   ><span style="line-height: 19px;"   >create table mon_inherits_white (name_inhrelid text primary key);</span></font></div><p></p></pre></div><div>关于array的比较可以参考以下BLOG :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020130682522480/"   >http://blog.163.com/digoal@126/blog/static/16387704020130682522480/</a></div><div>被监控的目标库用到的取ACL的函数 :&nbsp;</div><div>创建获取acl的函数, 这个函数可以在统一收集信息的脚本中创建.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >drop function </font><span style="font-size: small; line-height: 19px;"   >mon_part_get_acl(oid);</span></div><div><font size="2"   >create or replace function mon_part_get_acl(i_oid oid) returns text[] as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; result text[] := '{}'::text[];</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select relacl::text[] into result from pg_class where oid=i_oid and relacl is not null;</font></div><div><font size="2"   >&nbsp; if found then</font></div><div><font size="2"   >&nbsp; &nbsp; return result;</font></div><div><font size="2"   >&nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; return '{}'::text[];</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >exception when others then</font></div><div><font size="2"   >&nbsp; return '{}'::text[];</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql;</font></div></pre></div><div>采集服务器, 能连到所有被监控的目标库 :&nbsp;</div><div>收集信息的脚本 :&nbsp;</div><div>vi /home/postgres/script/coll_inherit_info.sh</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >#!/bin/bash<br># 环境变量<br>export LANG=en_US.utf8<br>export PGHOME=/opt/pgsql<br>export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib<br>export PATH=$PGHOME/bin:$PATH:.<br><br># 参数判断<br>if [ $# -ne 3 ]; then<br>echo -e "Please check your parameter."<br>echo -e "$0 HOST PORT ROLE \n"<br>exit 1<br>fi<br><br>TODAY=`date +%Y%m%d`<br>EMAIL="digoal@126.com"<br>MON_HOST=172.16.3.150<br>MON_PORT=1921<br>MON_ROLE=digoal<br>MON_DBNAME=digoal<br>MON_COPY_SQL="copy mon_inherits(server_ip,server_port,dbname,inhrelid,inhparent,inhseqno,name_inhrelid,name_inhparent,acl_inhrelid,acl_inhparent,crt_time) from stdin"<br>TARGET_COPY_SQL="copy (select inet_server_addr(),inet_server_port(),current_database(),inhrelid,inhparent,inhseqno,(inhrelid::regclass)::text,(inhparent::regclass)::text,mon_part_get_acl(inhrelid),mon_part_get_acl(inhparent),now() from pg_inherits) to stdout"<br><br>HOST=$1<br>PORT=$2<br>ROLE=$3<br><br>echo -e "-h $HOST -p $PORT -U $ROLE :\n"<br>for DB in `psql -q -t -h $HOST -p $PORT -U $ROLE postgres -c "select datname from pg_database where datname not in ('postgres','template0','template1')"`<br>do<br>echo -e "psql -q -t -h $HOST -p $PORT -U $ROLE $DB :\n"<br># ----创建获取acl的函数<br>psql -h $HOST -p $PORT -U $ROLE $DB &lt;&lt;EOF</span></font></div><div><font size="2"   style="line-height: 19px;"   >drop function </font><span style="line-height: 19px; font-size: small;"   >mon_part_get_acl(oid);</span><font size="2"   ><span style="line-height: 19px;"   ><br>create or replace function mon_part_get_acl(i_oid oid) returns text[] as \$\$<br></span></font><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; result text[] := '{}'::text[];</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; select relacl::text[] into result from pg_class where oid=i_oid and relacl is not null;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; if found then</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; return result;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; else</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; return '{}'::text[];</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; end if;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >exception when others then</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; return '{}'::text[];</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >end;</font></div><font size="2"   ><span style="line-height: 19px;"   >\$\$ language plpgsql;<br>EOF<br># ----获取真实目标数据库数据,避免pgbouncer或者防火墙中转过后的地址或者数据库名的改变造成不能使用.<br>REAL_HOST=`psql -t -A -h $HOST -p $PORT -U $ROLE $DB -c "select inet_server_addr()"`<br>REAL_PORT=`psql -t -A -h $HOST -p $PORT -U $ROLE $DB -c "select inet_server_port()"`<br>REAL_DBNAME=`psql -t -A -h $HOST -p $PORT -U $ROLE $DB -c "select current_database()"`<br># ----清除历史数据<br>psql -h $MON_HOST -p $MON_PORT -U $MON_ROLE $MON_DBNAME -c "delete from mon_inherits where server_ip='$REAL_HOST' and server_port='$REAL_PORT' and dbname='$REAL_DBNAME'"<br># ----拷贝继承表数据<br>psql -h $HOST -p $PORT -U $ROLE $DB -c "$TARGET_COPY_SQL"|psql -h $MON_HOST -p $MON_PORT -U $MON_ROLE $MON_DBNAME -c "$MON_COPY_SQL"<br>done</span></font></div><p></p></pre></div></div><div>chmod 500 /home/postgres/script/coll_inherit_info.sh</div><div><br></div><div>采集服务器,</div><div><div>vi ~/.pgpass</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >172.16.3.150:1921:digoal:digoal:digoal</font></div></div><div><span style="font-size: small; line-height: 19px;"   >172.16.3.150:9201:*:postgres:postgres</span></div><div><font size="2"   >.....pgpass文件中包含的其他目标库的超级用户连接配置项目略</font></div><p></p></pre></div></div><div>chmod 400 ~/.pgpass</div><div>执行测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="font-size: small;"   >ocz@db-172-16-3-150-&gt; ./t.sh 172.16.3.150 9201 postgres</span></div><div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >DELETE 74</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >DELETE 0</font></div></div><p></p></pre></div><div>信息收集如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 9201 postgres</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# \c digoal digoal</font></div><div><font size="2"   >You are now connected to database "digoal" as user "digoal".</font></div><div><font size="2"   >digoal=&gt; select * from mon_inherits ;</font></div><div><font size="2"   >&nbsp; server_ip &nbsp; | server_port | dbname | inhrelid | inhparent | inhseqno | &nbsp; &nbsp;name_inhrelid &nbsp; &nbsp;| name_inhparent | acl_inhrelid | &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; acl_inhparent &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------+-------------+--------+----------+-----------+----------+---------------------+----------------+--------------+------</font></div><div><font size="2"   >-----------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp;172.16.3.150 | &nbsp; &nbsp; &nbsp; &nbsp;9201 | digoal | &nbsp; &nbsp;98010 | &nbsp; &nbsp; 98007 | &nbsp; &nbsp; &nbsp; &nbsp;1 | digoal.tbl_201201 &nbsp; | digoal.tbl &nbsp; &nbsp; | {} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | {digo</font></div><div><font size="2"   >al=arwdDxt/digoal,skycac=r/digoal} | 2013-01-05 09:37:53.100495</font></div><div><font size="2"   >&nbsp;172.16.3.150 | &nbsp; &nbsp; &nbsp; &nbsp;9201 | digoal | &nbsp; &nbsp;98013 | &nbsp; &nbsp; 98007 | &nbsp; &nbsp; &nbsp; &nbsp;1 | digoal.tbl_201202 &nbsp; | digoal.tbl &nbsp; &nbsp; | {} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | {digo</font></div><div><font size="2"   >al=arwdDxt/digoal,skycac=r/digoal} | 2013-01-05 09:37:53.100495</font></div><div><font size="2"   ><span style="line-height: 19px;"   >....略</span></font><span style="font-size: small;"   >(74 rows)</span></div><p></p></pre></div><div>采集服务器, 编辑定期执行脚本 :&nbsp;</div><div>vi /home/postgres/script/exec_coll_inherit_info.sh</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   >/home/postgres/script/coll_inherit_info.sh 172.16.3.150 9201 postgres</font></div><p></p></pre></div><div><div><span style="line-height: 22px;"   >采集服务器, 编辑采集</span>错误监控脚本 :&nbsp;</div><div><span style="line-height: 22px;"   >vi /home/postgres/script/</span>mutt_err_coll_inherit_info.sh&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   >. /home/postgres/.bash_profile</font></div></div><div><div><font size="2"   >FATAL=1</font></div><div><font size="2"   >ERROR=1</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >FATAL=`grep -c FATAL /tmp/exec_coll_inherit_info.log`</font></div><div><font size="2"   >ERROR=`grep -c ERROR /tmp/exec_coll_inherit_info.log`</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >if [ $FATAL -ne 0 ] || [ $ERROR -ne 0 ]; then</font></div><div><font size="2"   >&nbsp; echo -e "`date +%F%T`exec_coll_inherit_info error\n"|mutt -s "exec_coll_inherit_info error" -a /tmp/exec_coll_inherit_info.log digoal.zhou@sky-mobi.com digoal@126.com</font></div><div><font size="2"   >fi</font></div></div><p></p></pre></div></div><div><div>定时任务 :&nbsp;</div><div>crontab -l</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >1 5 * * * /home/postgres/script/exec_coll_inherit_info.sh &gt;/tmp/exec_coll_inherit_info.log 2&gt;&amp;1</font></div><div><font size="2"   >1 6 * * * /home/postgres/script/mutt_err_coll_inherit_info.sh</font></div><p></p></pre></div></div><div><div>修改权限 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >chmod -R 500 /home/postgres/script/*</font></p></pre></div></div><div>在监控集中库中创建表名转日期的函数 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >create or replace function mon_part_conv_to_date(i_relname text) returns date as $$<br>declare<br>  arr text[] := ARRAY[0];<br>  v_date text := '';<br>  i text := '';<br>  v_len int := 0;<br>begin<br>  arr := regexp_split_to_array( regexp_replace( rtrim( ltrim( regexp_replace(i_relname,'[^[:digit:]]','_','g') ,'_') ,'_') ,'_+','_','g') ,'_');<br>  FOREACH i IN ARRAY arr<br>  loop<br>    if (length(v_date) = 8) then<br>      exit;<br>    end if;<br>    if (length(i) = 4 and length(v_date)=0 and (substr(i,1,2) &gt;= '18' and substr(i,1,2) &lt;= '22')) then<br>      v_date := v_date||i;<br>    elsif (length(i) = 6 and length(v_date)=0 and (substr(i,1,2) &gt;= '18' and substr(i,1,2) &lt;= '22') and (substr(i,5,2)&gt;='01' and substr(i,5,2)&lt;='12')) then<br>      v_date := v_date||i;<br>    elsif (length(i) = 8 and length(v_date)=0 and (substr(i,1,2) &gt;= '18' and substr(i,1,2) &lt;= '22') and (substr(i,5,2)&gt;='01' and substr(i,5,2)&lt;='12') and (substr(i,7,2)&gt;='01' and substr(i,7,2)&lt;='31')) then<br>      v_date := v_date||i;<br>    elsif (length(i)=4 and length(v_date) = 4 and (substr(i,1,2)&gt;='01' and substr(i,1,2)&lt;='12') and (substr(i,3,2)&gt;='01' and substr(i,3,2)&lt;='31')) then<br>      v_date := v_date||i;<br>    elsif (length(i)=2 and length(v_date) = 4 and (substr(i,1,2)&gt;='01' and substr(i,1,2)&lt;='12')) then<br>      v_date := v_date||i;<br>    elsif (length(i)=2 and length(v_date) = 6 and (substr(i,1,2)&gt;='01' and substr(i,1,2)&lt;='31')) then<br>      v_date := v_date||i;<br>    else<br>      continue;<br>    end if;<br>  end loop;<br>  v_len := length(v_date);<br>  case v_len<br>  when 4 then -- 按年分表<br>    return (v_date||'0101')::date;<br>  when 6 then -- 按月分表<br>    return (v_date||'01')::date;<br>  when 8 then -- 按天分表<br>    return v_date::date;<br>  else -- 长度为5和7非日期分表<br>    return '22220101'::date;<br>  end case;<br>exception when others then<br>  return '22220101'::date;<br>end;<br>$$ language plpgsql;</span></font></div><p></p></pre></div><div>创建视图 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >create or replace view v_mon_partition_tables as <br>select <br>  *,<br>  (max_pdate-current_date)/predict_gap::numeric AS future_tables_cnt<br>from <br>(<br>select <br>  *,<br>  pdate-lag_pdate AS gap,<br>  case <br>  when pdate-lag_pdate &gt;=365 then<br>    pdate - date_trunc('year', (pdate - interval '1 year'))::date<br>  when pdate-lag_pdate &gt;=28 then<br>    pdate - date_trunc('month', (pdate - interval '1 month'))::date<br>  when pdate-lag_pdate &gt;=7 then<br>    pdate-lag_pdate<br>  when pdate-lag_pdate &gt;=1 then<br>    pdate - date_trunc('day', (pdate - interval '1 day'))::date<br>  else <br>    0.9<br>  end AS predict_gap<br>from <br>(<br>select <br>  row_number() over (partition by server_ip,server_port,dbname,inhparent order by mon_part_conv_to_date(name_inhrelid)) AS rn,<br>  server_ip,<br>  server_port,<br>  dbname, <br>  name_inhparent, <br>  name_inhrelid, <br>  acl_inhparent, <br>  acl_inhrelid, <br>  mon_part_conv_to_date(name_inhrelid) AS pdate, <br>  lag(mon_part_conv_to_date(name_inhrelid), 1) over (partition by server_ip,server_port,dbname,inhparent order by mon_part_conv_to_date(name_inhrelid)) AS lag_pdate,<br>  max(mon_part_conv_to_date(name_inhrelid)) over (partition by server_ip,server_port,dbname,inhparent) AS max_pdate<br>from mon_inherits <br>) t <br>) t;</span></font></div><p></p></pre></div><div>视图结构 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >View "inherit_mon.v_mon_partition_tables"<br>      Column       |  Type   | Modifiers <br>-------------------+---------+-----------<br> rn                | bigint  | <br> server_ip         | inet    | <br> server_port       | integer | <br> dbname            | name    | <br> name_inhparent    | text    | <br> name_inhrelid     | text    | <br> acl_inhparent     | text[]  | <br> acl_inhrelid      | text[]  | <br> pdate             | date    | <br> lag_pdate         | date    | <br> max_pdate         | date    | <br> gap               | integer | <br> predict_gap       | numeric | <br> future_tables_cnt | numeric | </span></font></div><p></p></pre></div><div>监控脚本示例 :&nbsp;</div><div>每天自动监控 :&nbsp;</div><div>vi ~/inherit_day_monitor.sh</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   ># 环境变量</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/opt/pgsql9.1.2</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >TODAY=`date +%Y%m%d`</font></div><div><font size="2"   >EMAIL="digoal@126.com"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >HOST=127.0.0.1</font></div><div><font size="2"   >PORT=1921</font></div><div><font size="2"   >ROLE=digoal</font></div><div><font size="2"   >DBNAME=digoal</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >psql -t -A -h $HOST -p $PORT -U $ROLE $DBNAME &lt;&lt;EOF &gt;/tmp/inherit_day_monitor.log</font></div><div><font size="2"   ><span style="line-height: 19px;"   >select '-- 监控继承表的权限和父表是否一致,输出不一致项:' as monitor;<br>select server_ip,server_port,dbname,name_inhparent,name_</span></font><span style="font-size: small; line-height: 19px;"   >inhrelid,</span><font size="2"   style="line-height: 19px;"   ><span style="line-height: 19px;"   >mon_array_sort(</span></font><span style="line-height: 19px; font-size: small;"   >acl_inhparent),</span><font size="2"   style="line-height: 19px;"   ><span style="line-height: 19px;"   >mon_array_sort(</span></font><span style="line-height: 19px; font-size: small;"   >acl_inhrelid)</span><font size="2"   ><span style="line-height: 19px;"   ><br>  from mon_inherits<br>  where&nbsp;mon_array_sort(</span></font><span style="line-height: 19px; font-size: small;"   >acl_inhparent)&lt;&gt;</span><font size="2"   ><span style="line-height: 19px;"   >mon_array_sort(</span></font><span style="font-size: small; line-height: 19px;"   >acl_inhrelid)</span><span style="line-height: 19px; font-size: small;"   >;</span></div><div><font size="2"   >select '-- 监控日期继承表气泡:' as monitor;</font></div><div><font size="2"   >select server_ip,server_port,dbname,name_inhparent,name_inhrelid,pdate,lag_pdate,gap,predict_gap&nbsp;</font></div><div><font size="2"   >&nbsp; from v_mon_partition_tables</font></div><div><font size="2"   >&nbsp; where&nbsp;</font></div><div><font size="2"   >&nbsp; gap &lt;&gt; predict_gap&nbsp;</font></div><div><font size="2"   >&nbsp; and pdate &lt;&gt; '22220101'::date&nbsp;</font></div><div><font size="2"   >&nbsp; and lag_pdate is not null;</font></div><div><font size="2"   >select '-- 监控日期继承表过期(需满足大于未来10个表,且大于未来半年(185day)):' as monitor;</font></div><div><font size="2"   >select * from</font></div><div><font size="2"   >(</font></div><div><font size="2"   >select server_ip,server_port,dbname,name_inhparent,name_inhrelid,max_pdate,predict_gap,future_tables_cnt,row_number() over (partition by server_ip,server_port,dbname,name_inhparent order by pdate desc) AS rn</font></div><div><font size="2"   >from v_mon_partition_tables</font></div><div><font size="2"   >&nbsp; where&nbsp;</font></div><div><font size="2"   >&nbsp; (future_tables_cnt&lt;=10 or max_pdate - current_date &lt;185)&nbsp;</font></div><div><font size="2"   >&nbsp; and pdate &lt;&gt; '22220101'::date&nbsp;</font></div><div><font size="2"   >&nbsp; and lag_pdate is not null </font></div><div><font size="2"   >) t</font></div><div><font size="2"   >where rn=1;</font></div><div><font size="2"   >EOF</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CNT=0</font></div><div><font size="2"   >CNT=`wc -l /tmp/inherit_day_monitor.log|awk '{print $1}'`</font></div><div><font size="2"   >if [ $CNT -gt 3 ]; then</font></div><div><font size="2"   >&nbsp; echo -e "partition table abnormal.\n"|mutt -s "partition table abnormal" -a /tmp/inherit_day_monitor.log $EMAIL</font></div><div><font size="2"   >fi</font></div><p></p></pre></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >每月非法表名检查 :&nbsp;</span></div><div><div style="line-height: 22px;"   >vi ~/inherit_month_invalidname_monitor.sh&nbsp;</div><div><pre class="prettyprint"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#!/bin/bash</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ># 环境变量</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >export LANG=en_US.utf8</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >export PGHOME=/opt/pgsql9.1.2</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >TODAY=`date +%Y%m%d`</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >EMAIL="digoal@126.com"</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >HOST=127.0.0.1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >PORT=1921</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ROLE=digoal</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DBNAME=digoal</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >psql -t -A -h $HOST -p $PORT -U $ROLE $DBNAME &lt;&lt;EOF &gt;/tmp/inherit_month_invalidname_monitor.log</font></div><div><font size="2"   style="line-height: 19px;"   >select '-- 每月非法表名检查,过滤白名单(</font><font size="2"   ><span style="line-height: 19px;"   >mon_inherits_white)</span></font><span style="line-height: 19px; font-size: small;"   >: ' as monitor;</span></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >select server_ip,server_port,dbname,name_inhrelid</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; from mon_inherits&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; where mon_part_conv_to_date(name_inhrelid)='22220101'::date</font></div><div><font size="2"   style="line-height: 19px;"   >  and </font><span style="line-height: 19px; font-size: small;"   >name_inhrelid not in (select&nbsp;</span><font size="2"   ><span style="line-height: 19px;"   >name_inhrelid from&nbsp;mon_inherits_white</span></font><span style="font-size: small; line-height: 19px;"   >)</span></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; order by server_ip,server_port,dbname,name_inhparent,name_inhrelid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >EOF</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CNT=0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CNT=`wc -l /tmp/inherit_month_invalidname_monitor.log|awk '{print $1}'`</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >if [ $CNT -gt 3 ]; then</font></div><div><font size="2"   style="line-height: 19px;"   >&nbsp; </font><font size="2"   ><span style="line-height: 19px;"   >echo -e "partition table 每月非法表名检查.\n"|mutt -s "partition table 每月非法表名检查" -a /tmp/inherit_month_invalidname_monitor.log $EMAIL</span></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >fi</font></div><p style="line-height: 22px;"   ></p></pre></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >非法表明确认不是按日期分表的, 并且不需要气泡,过期检查的. 写到白名单表中.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >例如 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >insert into mon_inherits_white select name_inhrelid from (select server_ip,server_port,dbname,name_inhrelid</font></div><div><font size="2"   >&nbsp; from mon_inherits&nbsp;</font></div><div><font size="2"   >&nbsp; where mon_part_conv_to_date(name_inhrelid)='22220101'::date</font></div><div><font size="2"   >&nbsp; and name_inhrelid not in (select name_inhrelid from mon_inherits_white)</font></div><div><font size="2"   >&nbsp; order by server_ip,server_port,dbname,name_inhparent,name_inhrelid) t group by name_inhrelid;</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >以后定期维护这个白名单表.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >每月人工检查 :&nbsp;</span></div><div><div style="line-height: 22px;"   >vi ~/inherit_month_human_monitor.sh&nbsp;</div><div><pre class="prettyprint"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#!/bin/bash</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ># 环境变量</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >export LANG=en_US.utf8</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >export PGHOME=/opt/pgsql9.1.2</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >TODAY=`date +%Y%m%d`</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >EMAIL="digoal@126.com"</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >HOST=127.0.0.1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >PORT=1921</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ROLE=digoal</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DBNAME=digoal</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >psql -t -A -h $HOST -p $PORT -U $ROLE $DBNAME &lt;&lt;EOF &gt;/tmp/inherit_month_human_monitor.log</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >select '-- 每月人工检查:' as monitor;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >select server_ip,server_port,dbname,name_inhparent,name_inhrelid,crt_time&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; from mon_inherits&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; order by server_ip,server_port,dbname,name_inhparent,name_inhrelid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >EOF</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CNT=0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CNT=`wc -l /tmp/inherit_month_human_monitor.log|awk '{print $1}'`</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >if [ $CNT -gt 3 ]; then</font></div><div><font size="2"   ><span style="line-height: 19px;"   >  echo -e "partition table 每月人工检查.\n"|mutt -s "partition table 每月人工检查" -a /tmp/inherit_month_human_monitor.log $EMAIL</span></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >fi</font></div><p style="line-height: 22px;"   ></p></pre></div></div></div><div>mutt环境 :&nbsp;</div><div><div>vi ~/.muttrc&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >set envelope_from=yes</font></div><div><font size="2"   >set from=digoal.zhou@sky-mobi.com</font></div><div><font size="2"   >set realname="德哥"</font></div><div><font size="2"   >set use_from=yes</font></div><div><font size="2"   >set charset="UTF-8"</font></div><p></p></pre></div></div><div>定时任务 :&nbsp;</div><div>crontab -e</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >1 8 * * * /home/pg91/inherit_day_monitor.sh</font></div><div><font size="2"   >1 9 1 * * /home/pg91/inherit_month_invalidname_monitor.sh</font></div><div><font size="2"   >1 9 1 * * /home/pg91/inherit_month_human_monitor.sh</font></div><p></p></pre></div><div><p></p></div></div><div><br></div><div>【注意】</div><div>1. 如果存在IP,端口,库名相同的情况(例如公司存在多个IDC, 这些IDC中用了同样的内网网段), 以上脚本将不适用. 那请使用多个监控库来区分, 或者多个监控表来区分.</div><div>2. 集中监控时为什么acl字段改成了text呢, 因为在监控库中不存在生产库中的用户, 存储不存在的角色时, aclitem[]类型将出错.</div><div>3. 权限比较可能出现父表和子表赋权时顺序不一致造成的假象, 这个需要手工调整一下.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create table tbl(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=&gt; create table tbl_child(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=&gt; grant select on tbl to postgres;</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >digoal=&gt; grant select on tbl to skycac;</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >digoal=&gt; grant select on tbl_child to skycac;</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >digoal=&gt; grant select on tbl_child to postgres;</font></div><div><font size="2"   >GRANT</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >虽然实际的权限是一致的, 但是</span><span style="line-height: 22px;"   >这样得到的权限比较将不一致 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select relacl from pg_class where relname='tbl';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relacl &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------</font></div><div><font size="2"   >&nbsp;{digoal=arwdDxt/digoal,postgres=r/digoal,skycac=r/digoal}</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; select relacl from pg_class where relname='tbl_child';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relacl &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------</font></div><div><font size="2"   >&nbsp;{digoal=arwdDxt/digoal,skycac=r/digoal,postgres=r/digoal}</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="line-height: 22px;"   >要解决这个问题, 需要对数组进行排序, 我们可以用unnest将数组转成setof rec,然后再按顺序聚合(PostgreSQL 9.0开始支持聚合顺序).</div><div style="line-height: 22px;"   >如果不是9.0请自行写聚合函数, 聚合函数范例可参看 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020121118112533410/"   >http://blog.163.com/digoal@126/blog/static/16387704020121118112533410/</a></div><div>下面针对PostgreSQL 9.0+ 举例如下 :</div><div><pre class="prettyprint"   ><div><font size="2"   >digoal=&gt; create or replace function mon_array_sort(i_arr text[]) returns text[] as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; result text[];</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select array_agg(arr order by arr) into result from unnest(i_arr) t(arr);</font></div><div><font size="2"   >&nbsp; return result;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql;&nbsp;</font></div><div><font size="2"   >排序后 :&nbsp;</font></div><div><div><font size="2"   >digoal=&gt; select mon_array_sort('{h1,b,b,c,g,e}'::text[]);</font></div><div><font size="2"   >&nbsp;mon_array_sort&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;{b,b,c,e,g,h1}</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div>4. 一般还需要监控的项目,<div>父表和继承表的表结构一致性.</div><div>父表和继承表的索引一致性.</div><div>父表和继承表的列权限一致性(pg_attribute.attacl).</div></div>
	</div>
</div>
</body>
</html>