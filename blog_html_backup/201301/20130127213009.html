<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 PATCH: optimized DROP of multiple tables within a transaction</h2>
	<h5 id="">2013-01-27 21:30:09&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201302791135605/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>PostgreSQL 在同一个事物中删除多个表的优化, 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Accelerate end-of-transaction dropping of relations</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >When relations are dropped, at end of transaction we need to remove the</font></div><div><font size="2"   >files and clean the buffer pool of buffers containing pages of those</font></div><div><font size="2"   >relations. &nbsp;Previously we would scan the buffer pool once per relation</font></div><div><font size="2"   >to clean up buffers. &nbsp;When there are many relations to drop, the</font></div><div><font size="2"   >repeated scans make this process slow; so we now instead pass a list of</font></div><div><font size="2"   >relations to drop and scan the pool once, checking each buffer against</font></div><div><font size="2"   >the passed list. &nbsp;When the number of relations is larger than a</font></div><div><font size="2"   >threshold (which as of this patch is being set to 20 relations) we sort</font></div><div><font size="2"   >the array before starting, and bsearch the array; when it's smaller, we</font></div><div><font size="2"   >simply scan the array linearly each time, because that's faster. &nbsp;The</font></div><div><font size="2"   >exact optimal threshold value depends on many factors, but the</font></div><div><font size="2"   >difference is not likely to be significant enough to justify making it</font></div><div><font size="2"   >user-settable.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This has been measured to be a significant win (a 15x win when dropping</font></div><div><font size="2"   >100,000 relations; an extreme case, but reportedly a real one).</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Author: Tomas Vondra, some tweaks by me</font></div><div><font size="2"   >Reviewed by: Robert Haas, Shigeru Hanada, Andres Freund, ?lvaro Herrera</font></div><p></p></pre></div><div>删除多表时, 在事物的最后需要移除buffer pool里面的相关内容以及清除磁盘中的相关文件。</div><div><span style="line-height: 22px;"   >在这个补丁前, 每个表都要扫描一次buffer pool, 有多少被删除的对象, 就需要扫描多少次。效率低下.</span></div><div><span style="line-height: 22px;"   >打补丁后, buffer pool只需要扫描一次. (如果被删除的对象大于一定数量(现在设置的是20), 将先对列表进行排序再通过bsearch的方式进行扫描)</span></div><div><br></div><div>涉及代码 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >src/backend/catalog/storage.c</font></div><div><font size="2"   >src/backend/storage/buffer/bufmgr.c</font></div><div><font size="2"   >src/backend/storage/smgr/smgr.c</font></div><div><font size="2"   >src/include/storage/bufmgr.h</font></div><div><font size="2"   >src/include/storage/smgr.h</font></div><p></p></pre></div><div><br></div><div>【测试】</div><div>1. 建表函数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION public.crt_table(i_tablename text, i_cnt integer)</font></div><div><font size="2"   >&nbsp;RETURNS void</font></div><div><font size="2"   >&nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_sql text;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; set client_min_messages=error;</font></div><div><font size="2"   >&nbsp; v_sql := 'create table if not exists '||i_tablename||'(id int primary key, info text)';</font></div><div><font size="2"   >&nbsp; execute v_sql;</font></div><div><font size="2"   >&nbsp; for i in 1..i_cnt loop</font></div><div><font size="2"   >&nbsp; &nbsp; v_sql := 'create table if not exists '||i_tablename||'_'||i||' (like '||i_tablename||' including all) inherits ('||i_tablename||')';</font></div><div><font size="2"   >&nbsp; &nbsp; execute v_sql;</font></div><div><font size="2"   >&nbsp; end loop;</font></div><div><font size="2"   >&nbsp; return;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div></div><div><br></div><div>数据库参数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >shared_buffers = 4096MB</font></div><div><font size="2"   >synchronous_commit = off</font></div><div><font size="2"   >wal_level = minimal</font></div><div><font size="2"   >checkpoint_segments = 128</font></div><div><font size="2"   >max_locks_per_transaction = 1024000</font></div><p></p></pre></div><div><br></div><div>补丁前 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >ocz@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><font size="2"   >digoal=# \timing</font></div><div><font size="2"   >digoal=# select * from crt_table('test', 10000);</font></div><div><font size="2"   >&nbsp;crt_table&nbsp;</font></div><div><font size="2"   >-----------</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 49124.616 ms</font></div><div><font size="2"   >digoal=# select count(*) from pg_class where relkind='r' and relname ~ '^test';</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;10002</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 59.910 ms</font></div><div><div><font size="2"   >digoal=# drop table test cascade;</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >Time: 188896.872 ms</font></div></div><p></p></pre></div><div><br></div><div>补丁后 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pgdev@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><div><font size="2"   >digoal=# \timing</font></div><div><font size="2"   >Timing is on.</font></div></div><div><div><font size="2"   >digoal=# select * from crt_table('test', 10000);</font></div><div><font size="2"   >&nbsp;crt_table&nbsp;</font></div><div><font size="2"   >-----------</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 52650.580 ms</font></div><div><font size="2"   >digoal=# select count(*) from pg_class where relkind='r' and relname ~ '^test';</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;10001</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 71.086 ms</font></div></div><div><div><font size="2"   >digoal=# drop table test cascade;</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >Time: 43721.542 ms</font></div></div><p></p></pre></div><div><br></div><div>速度提升76.85% :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select (188896.872-43721.542)/188896.872;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------</font></div><div><font size="2"   >&nbsp;0.76854279513956165457</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 1.462 ms</font></div><p></p></pre></div><div><br></div><div>【参考】</div><div>1.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/message-id/flat/509FFE4E.1070002@fuzzy.cz#509FFE4E.1070002@fuzzy.cz"   >http://www.postgresql.org/message-id/flat/509FFE4E.1070002@fuzzy.cz#509FFE4E.1070002@fuzzy.cz</a></div><div>2.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=279628a0a7cf582f7dfb68e25b7b76183dd8ff2f"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=279628a0a7cf582f7dfb68e25b7b76183dd8ff2f</a></div><div><br></div><wbr></div>
	</div>
</div>
</body>
</html>