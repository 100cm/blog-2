<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL array compare and array element's sort</h2>
	<h5 id="">2013-01-06 8:55:32&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020130682522480/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">前几天写了一篇关于PostgreSQL 分区表的监控的BLOG, 里面涉及到父表与子表权限的比较环节.<div>权限在数据库中是以aclitem[]类型存储的, 也就是要比较两个数组了.</div><div>我们来看看两个数组比较的时候会是什么样子的情形?</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select 1 where array[1,2]=array[2,1];</font></div><div><font size="2"  >&nbsp;?column?&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; select 1 where array[1,2]=array[1,2];</font></div><div><font size="2"  >&nbsp;?column?&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>从上面的例子可以看出, 两个数组必须完全一致, 包括元素的顺序也必须一致那么这两个数组才是相等的.</div><div>或者说=这个operator 作用在两个数组上是, 是这么来判断一致性的.</div><div>另外, 来看看包含和被包含. 确又有点不一样. 看起来是拆成元素并去重后进行的比较 :&nbsp;</div><div>包含 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; select array[1,2,3,2] @&gt; array[1,2,1];</font></div><div><font size="2"  >&nbsp;?column?&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;t</font></div><div><font size="2"  >(1 row)</font></div></div><div><div><font size="2"  >digoal=&gt; select array[1,2,3,2] @&gt; array[1,2,1,4];</font></div><div><font size="2"  >&nbsp;?column?&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;f</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div>被包含 :&nbsp;</div><div><div><pre class="prettyprint"  ><div><font size="2"  >digoal=&gt; select array[1,2,3,2] &lt;@ array[1,2,1,4];</font></div><div><font size="2"  >&nbsp;?column?&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;f</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; select array[1,2,3,2] &lt;@ array[1,2,1,4,3];</font></div><div><font size="2"  >&nbsp;?column?&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;t</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div></div><div>以上用到的=, &lt;@, @&gt;操作符如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of operators</font></div><div><font size="2"  >&nbsp; &nbsp;Schema &nbsp; | Name | Left arg type | &nbsp;Right arg type &nbsp;| &nbsp; Result type &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Description &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >------------+------+---------------+------------------+------------------+-------------------------------------------------</font></div><div><font size="2"  >&nbsp;pg_catalog | &lt;@ &nbsp; | anyarray &nbsp; &nbsp; &nbsp;| anyarray &nbsp; &nbsp; &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| is contained by</font></div></div><div><font size="2"  >&nbsp;pg_catalog | @&gt; &nbsp; | anyarray &nbsp; &nbsp; &nbsp;| anyarray &nbsp; &nbsp; &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| contains</font></div><div><font size="2"  >&nbsp;pg_catalog | = &nbsp; &nbsp;| anyarray &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| anyarray &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| boolean &nbsp; &nbsp; | equal</font></div><p></p></pre></div><div><br></div><div>他们对应的系统函数如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; select oid,typname from pg_type where typname ~ 'array';</font></div><div><font size="2"  >&nbsp;oid &nbsp;| &nbsp; typname &nbsp;&nbsp;</font></div><div><font size="2"  >------+-------------</font></div><div><font size="2"  >&nbsp;2277 | anyarray</font></div><div><font size="2"  >&nbsp;2776 | anynonarray</font></div><div><font size="2"  >(2 rows)</font></div></div><div><div><font size="2"  >digoal=&gt; select * from pg_operator where oprname in ('&lt;@', '@&gt;', '=') and oprleft=2277 and oprright=2277;</font></div><div><font size="2"  >-[ RECORD 1 ]+-----------------</font></div><div><font size="2"  >oprname &nbsp; &nbsp; &nbsp;| &lt;@</font></div><div><font size="2"  >oprnamespace | 11</font></div><div><font size="2"  >oprowner &nbsp; &nbsp; | 10</font></div><div><font size="2"  >oprkind &nbsp; &nbsp; &nbsp;| b</font></div><div><font size="2"  >oprcanmerge &nbsp;| f</font></div><div><font size="2"  >oprcanhash &nbsp; | f</font></div><div><font size="2"  >oprleft &nbsp; &nbsp; &nbsp;| 2277</font></div><div><font size="2"  >oprright &nbsp; &nbsp; | 2277</font></div><div><font size="2"  >oprresult &nbsp; &nbsp;| 16</font></div><div><font size="2"  >oprcom &nbsp; &nbsp; &nbsp; | 2751</font></div><div><font size="2"  >oprnegate &nbsp; &nbsp;| 0</font></div><div><font size="2"  >oprcode &nbsp; &nbsp; &nbsp;| arraycontained</font></div><div><font size="2"  >oprrest &nbsp; &nbsp; &nbsp;| arraycontsel</font></div><div><font size="2"  >oprjoin &nbsp; &nbsp; &nbsp;| arraycontjoinsel</font></div><div><font size="2"  >-[ RECORD 2 ]+-----------------</font></div><div><font size="2"  >oprname &nbsp; &nbsp; &nbsp;| =</font></div><div><font size="2"  >oprnamespace | 11</font></div><div><font size="2"  >oprowner &nbsp; &nbsp; | 10</font></div><div><font size="2"  >oprkind &nbsp; &nbsp; &nbsp;| b</font></div><div><font size="2"  >oprcanmerge &nbsp;| t</font></div><div><font size="2"  >oprcanhash &nbsp; | t</font></div><div><font size="2"  >oprleft &nbsp; &nbsp; &nbsp;| 2277</font></div><div><font size="2"  >oprright &nbsp; &nbsp; | 2277</font></div><div><font size="2"  >oprresult &nbsp; &nbsp;| 16</font></div><div><font size="2"  >oprcom &nbsp; &nbsp; &nbsp; | 1070</font></div><div><font size="2"  >oprnegate &nbsp; &nbsp;| 1071</font></div><div><font size="2"  >oprcode &nbsp; &nbsp; &nbsp;| array_eq</font></div><div><font size="2"  >oprrest &nbsp; &nbsp; &nbsp;| eqsel</font></div><div><font size="2"  >oprjoin &nbsp; &nbsp; &nbsp;| eqjoinsel</font></div><div><font size="2"  >-[ RECORD 3 ]+-----------------</font></div><div><font size="2"  >oprname &nbsp; &nbsp; &nbsp;| @&gt;</font></div><div><font size="2"  >oprnamespace | 11</font></div><div><font size="2"  >oprowner &nbsp; &nbsp; | 10</font></div><div><font size="2"  >oprkind &nbsp; &nbsp; &nbsp;| b</font></div><div><font size="2"  >oprcanmerge &nbsp;| f</font></div><div><font size="2"  >oprcanhash &nbsp; | f</font></div><div><font size="2"  >oprleft &nbsp; &nbsp; &nbsp;| 2277</font></div><div><font size="2"  >oprright &nbsp; &nbsp; | 2277</font></div><div><font size="2"  >oprresult &nbsp; &nbsp;| 16</font></div><div><font size="2"  >oprcom &nbsp; &nbsp; &nbsp; | 2752</font></div><div><font size="2"  >oprnegate &nbsp; &nbsp;| 0</font></div><div><font size="2"  >oprcode &nbsp; &nbsp; &nbsp;| arraycontains</font></div><div><font size="2"  >oprrest &nbsp; &nbsp; &nbsp;| arraycontsel</font></div><div><font size="2"  >oprjoin &nbsp; &nbsp; &nbsp;| arraycontjoinsel</font></div></div><p></p></pre></div><div>也就是如下对应关系 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >= : array_eq</font></div><div><font size="2"  >&lt;@ :&nbsp;arraycontained</font></div><div><font size="2"  >@&gt; :&nbsp;arraycontains</font></div><p></p></pre></div><div><br></div><div>1. 那么要比较两个array严格相等(包括顺序), 可以使用=操作符.</div><div>如 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select array[1,2]=array[1,2];</font></div><div><font size="2"  >&nbsp;?column?&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;t</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; select array[1,2]=array[2,1];</font></div><div><font size="2"  >&nbsp;?column?&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;f</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>2. 如果要比较两个array不严格相等(只需要数组的元素相等, 各个元素的个数可以不相等), 可以使用a @&gt; b并且b &lt;@ a;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select array[2,2,1,1,3,3,3] @&gt; array[1,1,2,3] and array[2,2,1,1,3,3,3] &lt;@ array[1,1,2,3];</font></div><div><font size="2"  >&nbsp;?column?&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;t</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>3. 如果要比较两个array排序后相等呢? 那就得使用定制函数了, 这个在</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020130433036377/"  >http://blog.163.com/digoal@126/blog/static/16387704020130433036377/</a></div><div>已经提到了.</div><div>首先是对数组进行排序 :&nbsp;</div><div>为了通用性, 这里用到了anyarray类型, 所以可以针对所有元素类型可排序的数组类型.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function mon_array_sort(i_arr anyarray, OUT result anyarray) returns anyarray as $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >&nbsp; select array_agg(arr order by arr) into result from unnest(i_arr) t(arr);</font></div><div><font size="2"  >&nbsp; return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$ language plpgsql;</font></div><p></p></pre></div><div>例如 :&nbsp;</div><div>text数组 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select mon_array_sort('{1,2,3,4}'::text[]) = mon_array_sort('{3,1,2,4,4}'::text[]);</font></div><div><font size="2"  >&nbsp;?column?&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;f</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; select mon_array_sort('{1,2,3,4}'::text[]) = mon_array_sort('{3,1,2,4}'::text[]);</font></div><div><font size="2"  >&nbsp;?column?&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;t</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>int型数组 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; select mon_array_sort(array[3,1,4,2]) = mon_array_sort(array[1,2,3,4]);</font></div><div><font size="2"  >&nbsp;?column?&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;t</font></div><div><font size="2"  >(1 row)</font></div></div><div><div><font size="2"  >digoal=&gt; select mon_array_sort(array[3,1,4,2]) = mon_array_sort(array[1,2,3,4,1]);</font></div><div><font size="2"  >&nbsp;?column?&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;f</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div></div><div>【参考】</div><div>1.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020130433036377/"  >http://blog.163.com/digoal@126/blog/static/16387704020130433036377/</a></div><wbr></div></div>
	</div>
</div>
</body>
</html>