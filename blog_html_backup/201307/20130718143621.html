<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4devel Implement the FILTER clause for aggregate function calls extend the SQL standard</h2>
	<h5 id="">2013-07-18 14:36:21&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013618293678/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.4开发版对聚合函数的语法有小小的增强, 增加了一个FILTER子句, 可以作为聚合函数的输入过滤条件. 比较有实用价值.</div><div>开发版下载地址 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://ftp.postgresql.org/pub/snapshot/dev/postgresql-snapshot.tar.gz"   >http://ftp.postgresql.org/pub/snapshot/dev/postgresql-snapshot.tar.gz</a></div><div>例如 :&nbsp;</div><div>统计各分数线内的count.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create table score(id int primary key, cname name, score int);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >digoal=# insert into score values(1, '刘德华', 99);</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# insert into score values(2, '张学友', 89);</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# insert into score values(3, '郭富城', 88);</font></div><div><font size="2"   >INSERT 0 1</font></div></div><div><div><font size="2"   >digoal=# insert into score values(4, '黎明', 70);</font></div><div><font size="2"   >INSERT 0 1</font></div></div><div><div><font size="2"   >digoal=# insert into score select generate_series(5,100),md5(random()::text),trunc(random()*100);</font></div><div><font size="2"   >INSERT 0 96</font></div></div><p></p></pre></div><div><br></div><div>方法 1 举例 :&nbsp;</div><div>使用case when .. then .. ... else .. end 语法.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select sum(case when score&gt;=90 then 1 else 0 end) AS a, sum(case when score&gt;=80 and score&lt;90 then 1 else 0 end) AS b, sum(case when score&gt;=70 and score&lt;80 then 1 else 0 end) AS c, sum(case when score&lt;70 then 1 else 0 end) AS d, count(*) AS all from score;&nbsp;</font></div><div><font size="2"   >&nbsp;a &nbsp;| b &nbsp;| c &nbsp;| d &nbsp;| all&nbsp;</font></div><div><font size="2"   >----+----+----+----+-----</font></div><div><font size="2"   >&nbsp;14 | 17 | 11 | 58 | 100</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>方法 2 举例 : &nbsp;</div><div>使用聚合函数的FILTER进行过滤.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select count(*) filter (where score&gt;=90) AS a,&nbsp;</font></div><div><font size="2"   >count(*) filter (where score&gt;=80 and score&lt;90) AS b,&nbsp;</font></div><div><font size="2"   >count(*) filter (where score&gt;=70 and score&lt;80) AS c,&nbsp;</font></div><div><font size="2"   >count(*) filter (where score&lt;70) AS d,&nbsp;</font></div><div><font size="2"   >count(*) AS all&nbsp;</font></div><div><font size="2"   >from score;</font></div><div><font size="2"   >&nbsp;a &nbsp;| b &nbsp;| c &nbsp;| d &nbsp;| all&nbsp;</font></div><div><font size="2"   >----+----+----+----+-----</font></div><div><font size="2"   >&nbsp;14 | 17 | 11 | 58 | 100</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>语法 :&nbsp;</div><div><pre style="font-size: 12px; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border: 1px solid rgb(207, 207, 207); padding: 2ex; margin-top: 2ex; margin-bottom: 2ex; margin-left: 2ex; overflow: auto; border-top-left-radius: 8px; border-top-right-radius: 8px; border-bottom-right-radius: 8px; border-bottom-left-radius: 8px; background-color: rgb(247, 247, 247); line-height: normal;"   ><tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >aggregate_name</tt> (<tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >expression</tt> [ , ... ] [ <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >order_by_clause</tt> ] ) [ FILTER ( WHERE <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >filter_clause</tt> ) ]
<tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >aggregate_name</tt> (ALL <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >expression</tt> [ , ... ] [ <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >order_by_clause</tt> ] ) [ FILTER ( WHERE <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >filter_clause</tt> ) ]
<tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >aggregate_name</tt> (DISTINCT <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >expression</tt> [ , ... ] [ <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >order_by_clause</tt> ] ) [ FILTER ( WHERE <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >filter_clause</tt> ) ]
<tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >aggregate_name</tt> ( * ) [ FILTER ( WHERE <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >filter_clause</tt> ) ]</pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=b560ec1b0d7b910ce13edc51ffaafaca72136e3b"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=b560ec1b0d7b910ce13edc51ffaafaca72136e3b</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-select.html"   >http://www.postgresql.org/docs/devel/static/sql-select.html</a></div><div>3.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-expressions.html#SYNTAX-AGGREGATES"   >http://www.postgresql.org/docs/devel/static/sql-expressions.html#SYNTAX-AGGREGATES</a></div></div>
	</div>
</div>
</body>
</html>