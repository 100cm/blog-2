<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 WILL support auto-updatable view WITH CHECK OPTION</h2>
	<h5 id="">2013-07-31 16:51:23&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201363141544732/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>PostgreSQL 9.3 引入了支持自动dml的视图, 免去了写规则或触发器达到DML目的烦恼.</div><div><div style="line-height: 22px;"   ><a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201301483549300/"   >http://blog.163.com/digoal@126/blog/static/163877040201301483549300/</a></div><div style="line-height: 22px;"   ><a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020134922356437/"   >http://blog.163.com/digoal@126/blog/static/16387704020134922356437/</a></div></div><div>但是9.3的可自动更新视图不支持with check option.</div><div>9.4新增了<span style="line-height: 22px;"   >with check option</span><span style="line-height: 22px;"   >这个功能</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >WITH CHECK OPTION support for auto-updatable VIEWs</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >For simple views which are automatically updatable, this patch allows</font></div><div><font size="2"   >the user to specify what level of checking should be done on records</font></div><div><font size="2"   >being inserted or updated. &nbsp;For 'LOCAL CHECK', new tuples are validated</font></div><div><font size="2"   >against the conditionals of the view they are being inserted into, while</font></div><div><font size="2"   >for 'CASCADED CHECK' the new tuples are validated against the</font></div><div><font size="2"   >conditionals for all views involved (from the top down).</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This option is part of the SQL specification.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Dean Rasheed, reviewed by Pavel Stehule</font></div><p></p></pre></div><div>测试如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg94@db-192-168-100-216-&gt; psql</font></div><div><font size="2"   >psql (9.4devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# create table test (id int primary key , info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into test select generate_series(1,10000),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >INSERT 0 10000</font></div><div><font size="2"   >digoal=# create view v_test1 as select * from test where id&gt;0;</font></div><div><font size="2"   >CREATE VIEW</font></div></div><div><div><font size="2"   >digoal=# create view v_test2 as select * from test where id&gt;0 with local check option;</font></div><div><font size="2"   >CREATE VIEW</font></div></div><div><div><font size="2"   >digoal=# create view v_test3 as select * from test where id&gt;0 with cascaded check option;</font></div><div><font size="2"   >CREATE VIEW</font></div><div><font size="2"   >digoal=# create view v_test4 as select * from v_test2 where id&gt;0;</font></div><div><font size="2"   >CREATE VIEW</font></div><div><font size="2"   >digoal=# create view v_test5 as select * from v_test3 where id&gt;0;</font></div><div><font size="2"   >CREATE VIEW</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# \set VERBOSITY verbose</font></div><div><font size="2"   >digoal=# update v_test1 set id=-1 where id=1;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >digoal=# update v_test2 set id=-2 where id=2;</font></div><div><font size="2"   >ERROR: &nbsp;44000: new row violates WITH CHECK OPTION for view "v_test2"</font></div><div><font size="2"   >DETAIL: &nbsp;Failing row contains (-2, 770758090375c68f0f985fab7d723b44, 2013-07-31 16:26:03.159758).</font></div><div><font size="2"   >LOCATION: &nbsp;ExecWithCheckOptions, execMain.c:1665</font></div><div><font size="2"   >digoal=# update v_test3 set id=-2 where id=2;</font></div><div><font size="2"   >ERROR: &nbsp;44000: new row violates WITH CHECK OPTION for view "v_test3"</font></div><div><font size="2"   >DETAIL: &nbsp;Failing row contains (-2, 770758090375c68f0f985fab7d723b44, 2013-07-31 16:26:03.159758).</font></div><div><font size="2"   >LOCATION: &nbsp;ExecWithCheckOptions, execMain.c:1665</font></div><div><font size="2"   >digoal=# update v_test4 set id=-2 where id=2;</font></div><div><font size="2"   >ERROR: &nbsp;44000: new row violates WITH CHECK OPTION for view "v_test2"</font></div><div><font size="2"   >DETAIL: &nbsp;Failing row contains (-2, 770758090375c68f0f985fab7d723b44, 2013-07-31 16:26:03.159758).</font></div><div><font size="2"   >LOCATION: &nbsp;ExecWithCheckOptions, execMain.c:1665</font></div><div><font size="2"   >digoal=# update v_test5 set id=-2 where id=2;</font></div><div><font size="2"   >ERROR: &nbsp;44000: new row violates WITH CHECK OPTION for view "v_test3"</font></div><div><font size="2"   >DETAIL: &nbsp;Failing row contains (-2, 770758090375c68f0f985fab7d723b44, 2013-07-31 16:26:03.159758).</font></div><div><font size="2"   >LOCATION: &nbsp;ExecWithCheckOptions, execMain.c:1665</font></div></div><p></p></pre></div></div><div>local和cascade的测试如下 :&nbsp;</div><div>with check option默认为cascade的, 会检查里层的视图的where 条件.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create view v_test6 as select * from v_test1 with local check option;</font></div><div><font size="2"   >CREATE VIEW</font></div><div><font size="2"   >digoal=# create view v_test7 as select * from v_test1 with cascaded check option;</font></div><div><font size="2"   >CREATE VIEW</font></div></div><div><div><font size="2"   >digoal=# update v_test6 set id=-2 where id=2;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >digoal=# update v_test7 set id=-3 where id=3;</font></div><div><font size="2"   >ERROR: &nbsp;44000: new row violates WITH CHECK OPTION for view "v_test1"</font></div><div><font size="2"   >DETAIL: &nbsp;Failing row contains (-3, 1fc442a49bc3d63a1006a4e62237e340, 2013-07-31 16:26:03.159775).</font></div><div><font size="2"   >LOCATION: &nbsp;ExecWithCheckOptions, execMain.c:1665</font></div></div><p></p></pre></div><div><br></div><div>检查为级联模式, 如下, 最内层的v_test1的约束被检查了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create view v_test8 as select * from v_test1;</font></div><div><font size="2"   >CREATE VIEW</font></div><div><font size="2"   >digoal=# create view v_test9 as select * from v_test8 with cascaded check option;</font></div><div><font size="2"   >CREATE VIEW</font></div><div><font size="2"   >digoal=# update v_test9 set id=-3 where id=3;</font></div><div><font size="2"   >ERROR: &nbsp;44000: new row violates WITH CHECK OPTION for view "v_test1"</font></div><div><font size="2"   >DETAIL: &nbsp;Failing row contains (-3, 1fc442a49bc3d63a1006a4e62237e340, 2013-07-31 16:26:03.159775).</font></div><div><font size="2"   >LOCATION: &nbsp;ExecWithCheckOptions, execMain.c:1665</font></div><p></p></pre></div><div><div><img title="PostgreSQL 9.4 WILL support auto-updatable view WITH CHECK OPTION - 德哥@Digoal - PostgreSQL"   alt="PostgreSQL 9.4 WILL support auto-updatable view WITH CHECK OPTION - 德哥@Digoal - PostgreSQL"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/IBVatoZAi35NryXdUFNl0A==/3791467936392634007.png"   ></div>&nbsp;</div><div><br></div><div>更多测试参考 :&nbsp;</div><div>src/test/regress/expected/updatable_views.out</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=4cbe3ac3e86790d05c569de4585e5075a62a9b41"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=4cbe3ac3e86790d05c569de4585e5075a62a9b41</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-createview.html"   >http://www.postgresql.org/docs/devel/static/sql-createview.html</a></div><div>3.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201301483549300/"   >http://blog.163.com/digoal@126/blog/static/163877040201301483549300/</a></div><div>4.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020134922356437/"   >http://blog.163.com/digoal@126/blog/static/16387704020134922356437/</a></div><div>5.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >WITH [ CASCADED | LOCAL ] CHECK OPTION</font></div><div><font size="2"   >This option controls the behavior of automatically updatable views. When this option is specified, INSERT and UPDATE commands on the view will be checked to ensure that new rows satisfy the view-defining condition (that is, the new rows are checked to ensure that they are visible through the view). If they are not, the update will be rejected. If the CHECK OPTION is not specified, INSERT and UPDATE commands on the view are allowed to create rows that are not visible through the view. The following check options are supported:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >LOCAL</font></div><div><font size="2"   >New rows are only checked against the conditions defined directly in the view itself. Any conditions defined on underlying base views are not checked (unless they also specify the CHECK OPTION).</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CASCADED</font></div><div><font size="2"   >New rows are checked against the conditions of the view and all underlying base views. If the CHECK OPTION is specified, and neither LOCAL nor CASCADED is specified, then CASCADED is assumed.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The CHECK OPTION may not be used with RECURSIVE views.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Note that the CHECK OPTION is only supported on views that are automatically updatable, and do not have INSTEAD OF triggers or INSTEAD rules. If an automatically updatable view is defined on top of a base view that has INSTEAD OF triggers, then the LOCAL CHECK OPTION may be used to check the conditions on the automatically updatable view, but the conditions on the base view with INSTEAD OF triggers will not be checked (a cascaded check option will not cascade down to a trigger-updatable view, and any check options defined directly on a trigger-updatable view will be ignored). If the view or any of its base relations has an INSTEAD rule that causes the INSERT or UPDATE command to be rewritten, then all check options will be ignored in the rewritten query, including any checks from automatically updatable views defined on top of the relation with the INSTEAD rule.</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>