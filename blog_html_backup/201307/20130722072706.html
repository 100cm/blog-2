<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 add support ALTER TABLE ... ALTER CONSTRAINT</h2>
	<h5 id="">2013-07-22 7:27:06&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013621103224772/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.4将增加修改约束的检查属性(SQL执行后马上检查 OR 整个事务结束的末尾检查).&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >While fiddling with FK tuning, it was useful to be able to enable and</font></div><div><font size="2"   >disable the DEFERRED mode of constraints.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >That is not currently possible in SQL, so I wrote this patch. Without</font></div><div><font size="2"   >this you have to drop and then re-add a constraint, which is</font></div><div><font size="2"   >impractical for large tables.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >e.g.</font></div><div><font size="2"   >CREATE TABLE fktable (id integer, fk integer REFERENCES pktable (id));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >ALTER TABLE foo</font></div><div><font size="2"   >&nbsp; &nbsp;ALTER CONSTRAINT fktable_fk_fkey DEFERRED INITIALLY IMMEDIATE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Includes docs and tests.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Currently works for FKs only. Potentially other constraints can be</font></div><div><font size="2"   >supported in future.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >--</font></div><div><font size="2"   >&nbsp;Simon Riggs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; http://www.2ndQuadrant.com/</font></div><div><font size="2"   >&nbsp;PostgreSQL Development, 24x7 Support, Training &amp; Services</font></div><p></p></pre></div><div>感谢Simon Riggs提供的补丁. 目前的补丁仅支持对foreign key约束的check属性修改. 未来会加入对其他约束属性的在线修改.</div><div>在没有这个补丁前, 对约束的修改只能是删除约束后重新添加, 如果数据量很大的话重新添加约束时性能损耗极大.</div><div>下面测试一下这个补丁 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.4devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# create table test1 (id int primary key, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# create table test2 (f_id int references test1(id), crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# \d test2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "public.test2"</font></div><div><font size="2"   >&nbsp; Column &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >----------+-----------------------------+-----------</font></div><div><font size="2"   >&nbsp;f_id &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;crt_time | timestamp without time zone |&nbsp;</font></div><div><font size="2"   >Foreign-key constraints:</font></div><div><font size="2"   >&nbsp; &nbsp; "test2_f_id_fkey" FOREIGN KEY (f_id) REFERENCES test1(id)</font></div><p></p></pre></div><div>默认情况下外键约束的检查在每条SQL后马上检查.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select conname,condeferrable,condeferred from pg_constraint where conname='test2_f_id_fkey';</font></div><div><font size="2"   >-[ RECORD 1 ]-+----------------</font></div><div><font size="2"   >conname &nbsp; &nbsp; &nbsp; | test2_f_id_fkey</font></div><div><font size="2"   >condeferrable | f</font></div><div><font size="2"   >condeferred &nbsp; | f</font></div><p></p></pre></div><div>因此如下事务中报错.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# insert into test2 values (1,now());</font></div><div><font size="2"   >ERROR: &nbsp;insert or update on table "test2" violates foreign key constraint "test2_f_id_fkey"</font></div><div><font size="2"   >DETAIL: &nbsp;Key (f_id)=(1) is not present in table "test1".</font></div><div><font size="2"   >digoal=# rollback;</font></div><div><font size="2"   >ROLLBACK</font></div><p></p></pre></div><div>在事务中设置约束检查首先这个约束本身要支持deferrable.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# set constraints test2_f_id_fkey deferred;</font></div><div><font size="2"   >ERROR: &nbsp;constraint "test2_f_id_fkey" is not deferrable</font></div><div><font size="2"   >digoal=# rollback;</font></div><div><font size="2"   >ROLLBACK</font></div><p></p></pre></div><div>将该外键约束修改为deferrable.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# alter table test2 alter constraint test2_f_id_fkey deferrable;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >digoal=# select conname,condeferrable,condeferred from pg_constraint where conname='test2_f_id_fkey';</font></div><div><font size="2"   >-[ RECORD 1 ]-+----------------</font></div><div><font size="2"   >conname &nbsp; &nbsp; &nbsp; | test2_f_id_fkey</font></div><div><font size="2"   >condeferrable | t</font></div><div><font size="2"   >condeferred &nbsp; | f</font></div><p></p></pre></div><div>注意condeferred=false, 因此默认是每条SQL后检查的,</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# set constraints test2_f_id_fkey deferred;</font></div><div><font size="2"   >SET CONSTRAINTS</font></div><div><font size="2"   >digoal=# insert into test2 values (1,now());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# commit;</font></div><div><font size="2"   >ERROR: &nbsp;insert or update on table "test2" violates foreign key constraint "test2_f_id_fkey"</font></div><div><font size="2"   >DETAIL: &nbsp;Key (f_id)=(1) is not present in table "test1".</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >此时可以设置该约束的deferrable属性. 延迟检查后这个约束的检查将在事务结束的末尾进行.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# set constraints test2_f_id_fkey deferred;</font></div><div><font size="2"   >SET CONSTRAINTS</font></div><div><font size="2"   >digoal=# insert into test2 values (1,now());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# insert into test1 values (1,'test');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# end;</font></div><div><font size="2"   >COMMIT</font></div><p></p></pre></div><div>把默认的检查放到事务末尾, initially deferred.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# alter table test2 alter constraint test2_f_id_fkey deferrable initially deferred;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >digoal=# select conname,condeferrable,condeferred from pg_constraint where conname='test2_f_id_fkey';</font></div><div><font size="2"   >-[ RECORD 1 ]-+----------------</font></div><div><font size="2"   >conname &nbsp; &nbsp; &nbsp; | test2_f_id_fkey</font></div><div><font size="2"   >condeferrable | t</font></div><div><font size="2"   >condeferred &nbsp; | t</font></div><p></p></pre></div><div>此时不需要使用set constraints进行修改.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# insert into test2 values (100,now());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# insert into test1 values (100,'test');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# commit;</font></div><div><font size="2"   >COMMIT</font></div><p></p></pre></div></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/message-id/flat/CA+U5nML4d_HJfp2+hcbYQcGA_Y30nxt+Yu-44KVtQgcSJB09+w@mail.gmail.com#CA+U5nML4d_HJfp2+hcbYQcGA_Y30nxt+Yu-44KVtQgcSJB09+w@mail.gmail.com"   >http://www.postgresql.org/message-id/flat/CA+U5nML4d_HJfp2+hcbYQcGA_Y30nxt+Yu-44KVtQgcSJB09+w@mail.gmail.com#CA+U5nML4d_HJfp2+hcbYQcGA_Y30nxt+Yu-44KVtQgcSJB09+w@mail.gmail.com</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-altertable.html"   >http://www.postgresql.org/docs/devel/static/sql-altertable.html</a></div>3.&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-createtable.html"   >http://www.postgresql.org/docs/devel/static/sql-createtable.html</a><div>4.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-set-constraints.html"   >http://www.postgresql.org/docs/devel/static/sql-set-constraints.html</a></div></div>
	</div>
</div>
</body>
</html>