<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 patch : Row-Level Security</h2>
	<h5 id="">2013-07-27 17:56:00&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201362402650341/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前段时间写过一篇关于使用视图来提供行级别的数据保护, 当创建视图时如果未使用security_barriers, 那么这个视图是不安全的, 攻击者可以利用低成本函数打印出隐藏的基表数据. 使用security_barriers可以规避这个问题, 但是牺牲了SQL优化器的作用, 查询将会变成seq scan, 全表扫描.</div><div>感兴趣的朋友可以参见如下BLOG :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201361031431669/"   >http://blog.163.com/digoal@126/blog/static/163877040201361031431669/</a></div><div>本文讲述的是将要在9.4发布的行级别安全补丁RLS. 在数据保护方面和视图效果一样, 同时不会有security_barriers带来的弊端.</div><div>这个补丁尚未提交, 所以安装时需要注意.</div><div>首先下载一个PostgreSQL devel版本. 补丁在处理nodeFuncs.c时目前有点小问题, 使用以下snapshot可以正常打补丁.</div><div><a rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=10a509d82956dee14eb2011bd266cd3c728ae188"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=10a509d82956dee14eb2011bd266cd3c728ae188</a></div><div>下载补丁文件 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >wget&nbsp;http://www.postgresql.org/message-id/attachment/29700/pgsql-v9.4-row-level-security.v3b.patch</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >打补丁</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >tar -zxvf&nbsp;postgresql-10a509d.tar.gz</font></div><div><font size="2"   >cd&nbsp;postgresql-10a509d</font></div><div><font size="2"   >patch -p1 &lt; ./pgsql-v9.4-row-level-security.v3b.patch</font></div><p></p></pre></div><div>安装</div><div><pre class="prettyprint"   ><p><font size="2"   >./configure --prefix=/home/pg94/pgsql9.4devel --with-pgport=1921 --with-perl --with-tcl --with-python --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=16 &amp;&amp; gmake &amp;&amp; gmake install</font></p></pre></div><div>初始化数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >initdb -E UTF8 -D $PGDATA --locale=C -W -U postgres</font></div><div><font size="2"   >pg_ctl start</font></div><p></p></pre></div><div>语法</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ALTER TABLE&nbsp;</font></div><div><div><font size="2"   >&nbsp; &nbsp; SET ROW SECURITY FOR rowsec_command TO (condition)</font></div><div><font size="2"   >&nbsp; &nbsp; RESET ROW SECURITY FOR rowsec_command</font></div></div><div><font size="2"   >and rowsec_command is:<br>    { ALL | SELECT | INSERT | UPDATE | DELETE }</font></div><p></p></pre></div><div>测试 :&nbsp;</div><div>创建测试表</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table test (id int, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into test select generate_series(1,1000), md5(random()::text);</font></div><div><font size="2"   >INSERT 0 1000</font></div><p></p></pre></div><div>设置行安全策略</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# alter table test SET ROW SECURITY FOR select TO (id&lt;=999);</font></div><div><font size="2"   >ERROR: &nbsp;0A000: Row-security for "select" is not implemented yet</font></div><div><font size="2"   >LOCATION: &nbsp;ATExecSetRowSecurity, pg_rowsecurity.c:305</font></div></div><div><div><font size="2"   >digoal=# alter table test SET ROW SECURITY FOR insert TO (id&lt;=999);</font></div><div><font size="2"   >ERROR: &nbsp;0A000: Row-security for "insert" is not implemented yet</font></div><div><font size="2"   >LOCATION: &nbsp;ATExecSetRowSecurity, pg_rowsecurity.c:305</font></div><div><font size="2"   >digoal=# alter table test SET ROW SECURITY FOR update TO (id&lt;=999);</font></div><div><font size="2"   >ERROR: &nbsp;0A000: Row-security for "update" is not implemented yet</font></div><div><font size="2"   >LOCATION: &nbsp;ATExecSetRowSecurity, pg_rowsecurity.c:305</font></div><div><font size="2"   >digoal=# alter table test SET ROW SECURITY FOR delete TO (id&lt;=999);</font></div><div><font size="2"   >ERROR: &nbsp;0A000: Row-security for "delete" is not implemented yet</font></div><div><font size="2"   >LOCATION: &nbsp;ATExecSetRowSecurity, pg_rowsecurity.c:305</font></div></div><p></p></pre></div><div><div>目前只支持all commands.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# alter table test SET ROW SECURITY FOR all TO (id&lt;=999);</font></div><div><font size="2"   >ALTER TABLE</font></div><p></p></pre></div></div><div>超级用户不受限制.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select * from test &nbsp;where id&gt;=998;</font></div><div><font size="2"   >&nbsp; id &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------+----------------------------------</font></div><div><font size="2"   >&nbsp; 998 | 7177340c488270f432b1476d001f3b9d</font></div><div><font size="2"   >&nbsp; 999 | a609aef006b1147dad10f3e43993dfea</font></div><div><font size="2"   >&nbsp;1000 | c7fa1acdd43d442be5a940c9f7091abc</font></div><div><font size="2"   >(3 rows)</font></div></div><div><div><font size="2"   >digoal=# create role digoal nosuperuser nocreatedb login encrypted password 'digoal';</font></div><div><font size="2"   >CREATE ROLE</font></div></div><div><div><font size="2"   >digoal=# grant select on test to digoal;</font></div><div><font size="2"   >GRANT</font></div></div><p></p></pre></div><div><div>普通用户受到安全限制. id=1000的不会查出来.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \c digoal digoal</font></div><div><font size="2"   >You are now connected to database "digoal" as user "digoal".</font></div><div><font size="2"   >digoal=&gt; select * from test &nbsp;where id&gt;=998;</font></div><div><font size="2"   >&nbsp;id &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----+----------------------------------</font></div><div><font size="2"   >&nbsp;998 | 7177340c488270f432b1476d001f3b9d</font></div><div><font size="2"   >&nbsp;999 | a609aef006b1147dad10f3e43993dfea</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div></div><div>从执行计划可以看到已经自动增加了安全限制条件id&lt;=999</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; explain analyze select * from test &nbsp;where id&gt;=998;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on test &nbsp;(cost=0.00..24.00 rows=1 width=37) (actual time=0.271..0.271 rows=2 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: ((id &lt;= 999) AND (id &gt;= 998))</font></div><div><font size="2"   >&nbsp; &nbsp;Rows Removed by Filter: 998</font></div><div><font size="2"   >&nbsp;Total runtime: 0.308 ms</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div><div>使用RLS不会像视图的security_barriers那样无法使用优化器. 所以索引是有效的.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; \c digoal postgres</font></div><div><font size="2"   >You are now connected to database "digoal" as user "postgres".</font></div><div><font size="2"   >digoal=# create index idx_test_1 on test(id);</font></div><div><font size="2"   >CREATE INDEX</font></div><div><font size="2"   >digoal=# \c digoal digoal</font></div><div><font size="2"   >You are now connected to database "digoal" as user "digoal".</font></div><div><font size="2"   >digoal=&gt; explain analyze select * from test &nbsp;where id&gt;=998;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using idx_test_1 on test &nbsp;(cost=0.28..2.29 rows=1 width=37) (actual time=0.007..0.008 rows=2 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: ((id &lt;= 999) AND (id &gt;= 998))</font></div><div><font size="2"   >&nbsp;Total runtime: 0.065 ms</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div><div>attack测试 :&nbsp;</div><div><br></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# \c digoal digoal</font></div><div><font size="2"   >You are now connected to database "digoal" as user "digoal".</font></div><div><font size="2"   >digoal=&gt; create or replace function attack(test) returns boolean as $$</font></div><div><font size="2"   >digoal$&gt; declare</font></div><div><font size="2"   >digoal$&gt; begin</font></div><div><font size="2"   >digoal$&gt; &nbsp; raise notice '%', $1;</font></div><div><font size="2"   >digoal$&gt; &nbsp; return true;</font></div><div><font size="2"   >digoal$&gt;&nbsp;</font></div><div><font size="2"   >digoal$&gt; end;</font></div><div><font size="2"   >digoal$&gt; $$ language plpgsql strict cost 0.000000000000001;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >digoal=&gt; select * from test where id&gt;997 and attack(test);</font></div><div><font size="2"   >NOTICE: &nbsp;(998,7177340c488270f432b1476d001f3b9d)</font></div><div><font size="2"   >NOTICE: &nbsp;(999,a609aef006b1147dad10f3e43993dfea)</font></div><div><font size="2"   >&nbsp;id &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----+----------------------------------</font></div><div><font size="2"   >&nbsp;998 | 7177340c488270f432b1476d001f3b9d</font></div><div><font size="2"   >&nbsp;999 | a609aef006b1147dad10f3e43993dfea</font></div><div><font size="2"   >(2 rows)</font></div></div><div><font size="2"   >digoal=&gt; explain analyze verbose select * from test where id&gt;997 and attack(test);<br>NOTICE:  (998,7177340c488270f432b1476d001f3b9d)<br>NOTICE:  (999,a609aef006b1147dad10f3e43993dfea)<br>                                                              QUERY PLAN                                                            <br>  <br>------------------------------------------------------------------------------------------------------------------------------------<br>--<br> Subquery Scan on test  (cost=0.28..2.33 rows=1 width=37) (actual time=0.113..0.138 rows=2 loops=1)<br>   Output: test.id, test.info<br>   Filter: attack(test.test)<br>   -&gt;  Index Scan using idx_test_1 on public.test test_1  (cost=0.28..2.31 rows=2 width=98) (actual time=0.014..0.018 rows=2 loops=1<br>)<br>         Output: test_1.id, test_1.info, test_1.*<br>         Index Cond: ((test_1.id &lt;= 999) AND (test_1.id &gt; 997))<br> Total runtime: 0.343 ms<br>(7 rows)</font></div><div><div><font size="2"   >digoal=&gt; \c digoal postgres</font></div><div><font size="2"   >You are now connected to database "digoal" as user "postgres".</font></div><div><font size="2"   >digoal=# drop index idx_test_1;</font></div><div><font size="2"   >DROP INDEX</font></div><div><font size="2"   >digoal=# \c digoal digoal</font></div><div><font size="2"   >You are now connected to database "digoal" as user "digoal".</font></div><div><font size="2"   >digoal=&gt; select * from test where id&gt;997 and attack(test);</font></div><div><font size="2"   >NOTICE: &nbsp;(998,7177340c488270f432b1476d001f3b9d)</font></div><div><font size="2"   >NOTICE: &nbsp;(999,a609aef006b1147dad10f3e43993dfea)</font></div><div><font size="2"   >&nbsp;id &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----+----------------------------------</font></div><div><font size="2"   >&nbsp;998 | 7177340c488270f432b1476d001f3b9d</font></div><div><font size="2"   >&nbsp;999 | a609aef006b1147dad10f3e43993dfea</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   >digoal=&gt; explain analyze verbose select * from test where id&gt;997 and attack(test);</font></div><div><font size="2"   >NOTICE: &nbsp;(998,7177340c488270f432b1476d001f3b9d)</font></div><div><font size="2"   >NOTICE: &nbsp;(999,a609aef006b1147dad10f3e43993dfea)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Subquery Scan on test &nbsp;(cost=0.00..24.02 rows=1 width=37) (actual time=0.381..0.403 rows=2 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: test.id, test.info</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: attack(test.test)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on public.test test_1 &nbsp;(cost=0.00..24.00 rows=2 width=98) (actual time=0.289..0.292 rows=2 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: test_1.id, test_1.info, test_1.*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: ((test_1.id &lt;= 999) AND (test_1.id &gt; 997))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Rows Removed by Filter: 998</font></div><div><font size="2"   >&nbsp;Total runtime: 0.439 ms</font></div><div><font size="2"   >(8 rows)</font></div></div><p></p></pre></div><div>从执行计划可以看出设置RLS后, RLS的条件作为子查询, attack(test)在子查询外面. 所以不可能从attack中窥探子查询外的数据, 因此id=1000的数据在这里是看不到的.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/message-id/flat/CADyhKSWGtZqpsXtF7_q2FvKRvX6RqW+xv7VmxNmj4gubSBoo-g@mail.gmail.com"   >http://www.postgresql.org/message-id/flat/CADyhKSWGtZqpsXtF7_q2FvKRvX6RqW+xv7VmxNmj4gubSBoo-g@mail.gmail.com</a></div>2.&nbsp;<a rel="nofollow" href="http://www.pgcon.org/2013/schedule/attachments/273_PGcon2013-kaigai-row-level-security.pdf"   >http://www.pgcon.org/2013/schedule/attachments/273_PGcon2013-kaigai-row-level-security.pdf</a><div>3.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="https://github.com/kaigai/sepgsql/tree/rowsec"   >https://github.com/kaigai/sepgsql/tree/rowsec</a></div><div>4.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://wiki.postgresql.org/wiki/RLS"   >http://wiki.postgresql.org/wiki/RLS</a></div><div>5.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201361031431669/"   >http://blog.163.com/digoal@126/blog/static/163877040201361031431669/</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL 9.4 patch : Row-Level Security - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>