<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 logical replicatoin patch: logical changeset generation v5</h2>
	<h5 id="">2013-07-30 16:48:13&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201362693010810/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 的xlog逻辑解析补丁, 可以从xlog中解出数据库中执行的SQL, 但是从测试情况来看目前不支持DDL的解析, 只有DML的解析.</div><div>未来PostgreSQL可以基于此增加基于SQL复制的功能.&nbsp;</div><div>补丁比较多, 有些是单独提交的, 本文将简单的测试一下.</div><div><br></div><div>下载PostgreSQL源码, 注意最好使用补丁释放前一天的版本 :&nbsp;</div><div><a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=snapshot;h=bab54e383dd102001753366d3c124f706c7967dd;sf=tgz"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=snapshot;h=bab54e383dd102001753366d3c124f706c7967dd;sf=tgz</a></div><div><br></div><div>下载补丁</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >mkdir patch</font></div><div><font size="2"   >cd patch</font></div><div><font size="2"   >wget&nbsp;http://www.postgresql.org/message-id/attachment/29336/0001-Add-support-for-multiple-kinds-of-external-toast-dat.patch.gz</font></div><div><div><font size="2"   >wget http://www.postgresql.org/message-id/attachment/29337/0002-wal_decoding-Add-pg_xlog_wait_remote_-apply-receive-.patch.gz</font></div><div><font size="2"   >wget http://www.postgresql.org/message-id/attachment/29338/0003-wal_decoding-Add-a-new-RELFILENODE-syscache-to-fetch.patch.gz</font></div><div><font size="2"   >wget http://www.postgresql.org/message-id/attachment/29339/0004-wal_decoding-Add-RelationMapFilenodeToOid-function-t.patch.gz</font></div><div><font size="2"   >wget http://www.postgresql.org/message-id/attachment/29340/0005-wal_decoding-Add-pg_relation_by_filenode-to-lookup-u.patch.gz</font></div><div><font size="2"   >wget http://www.postgresql.org/message-id/attachment/29341/0006-wal_decoding-Introduce-InvalidCommandId-and-declare-.patch.gz</font></div><div><font size="2"   >wget http://www.postgresql.org/message-id/attachment/29342/0007-wal_decoding-Adjust-all-Satisfies-routines-to-take-a.patch.gz</font></div><div><font size="2"   >wget http://www.postgresql.org/message-id/attachment/29343/0008-wal_decoding-Allow-walsender-s-to-connect-to-a-speci.patch.gz</font></div><div><font size="2"   >wget http://www.postgresql.org/message-id/attachment/29344/0009-wal_decoding-Add-alreadyLocked-parameter-to-GetOldes.patch.gz</font></div><div><font size="2"   >wget http://www.postgresql.org/message-id/attachment/29345/0010-wal_decoding-Log-xl_running_xact-s-at-a-higher-frequ.patch.gz</font></div><div><font size="2"   >wget http://www.postgresql.org/message-id/attachment/29346/0011-wal_decoding-copydir-make-fsync_fname-public.patch.gz</font></div><div><font size="2"   >wget http://www.postgresql.org/message-id/attachment/29347/0012-wal_decoding-Add-information-about-a-tables-primary-.patch.gz</font></div><div><font size="2"   >wget http://www.postgresql.org/message-id/attachment/29348/0013-wal_decoding-Introduce-wal-decoding-via-catalog-time.patch.gz</font></div><div><font size="2"   >wget http://www.postgresql.org/message-id/attachment/29349/0014-wal_decoding-test_decoding-Add-a-simple-decoding-mod.patch.gz</font></div><div><font size="2"   >wget http://www.postgresql.org/message-id/attachment/29350/0015-wal_decoding-pg_receivellog-Introduce-pg_receivexlog.patch.gz</font></div><div><font size="2"   >wget http://www.postgresql.org/message-id/attachment/29351/0016-wal_decoding-test_logical_decoding-Add-extension-for.patch.gz</font></div><div><font size="2"   >wget http://www.postgresql.org/message-id/attachment/29352/0017-wal_decoding-design-document-v2.4-and-snapshot-build.patch.gz</font></div></div><div><font size="2"   >wget&nbsp;http://www.postgresql.org/message-id/attachment/29390/0001-wal_decoding-mergme-Fix-pg_basebackup-makefile.patch</font></div><div><font size="2"   >wget&nbsp;http://www.postgresql.org/message-id/attachment/29391/0002-wal_decoding-mergme-Fix-test_logical_decoding-Makefi.patch</font></div><div><font size="2"   >wget&nbsp;http://www.postgresql.org/message-id/attachment/29564/0001-wal_decoding-mergme-Don-t-use-out-of-scope-local-var.patch</font></div><div><font size="2"   >gunzip *.gz</font></div><p></p></pre></div><div><br></div><div>打补丁</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >tar -zxvf postgresql-bab54e3.tar.gz</font></div><div><font size="2"   >cd&nbsp;<span style="line-height: 22px;"   >postgresql-bab54e3</span></font></div><div><div><font size="2"   >patch -p1 &lt; ../patch/0001-Add-support-for-multiple-kinds-of-external-toast-dat.patch</font></div><div><font size="2"   >patch -p1 &lt; ../patch/0002-wal_decoding-Add-pg_xlog_wait_remote_-apply-receive-.patch</font></div><div><font size="2"   >patch -p1 &lt; ../patch/0003-wal_decoding-Add-a-new-RELFILENODE-syscache-to-fetch.patch</font></div><div><font size="2"   >patch -p1 &lt; ../patch/0004-wal_decoding-Add-RelationMapFilenodeToOid-function-t.patch</font></div><div><font size="2"   >patch -p1 &lt; ../patch/0005-wal_decoding-Add-pg_relation_by_filenode-to-lookup-u.patch</font></div><div><font size="2"   >patch -p1 &lt; ../patch/0006-wal_decoding-Introduce-InvalidCommandId-and-declare-.patch</font></div><div><font size="2"   >patch -p1 &lt; ../patch/0007-wal_decoding-Adjust-all-Satisfies-routines-to-take-a.patch</font></div><div><font size="2"   >patch -p1 &lt; ../patch/0008-wal_decoding-Allow-walsender-s-to-connect-to-a-speci.patch</font></div><div><font size="2"   >patch -p1 &lt; ../patch/0009-wal_decoding-Add-alreadyLocked-parameter-to-GetOldes.patch</font></div><div><font size="2"   >patch -p1 &lt; ../patch/0010-wal_decoding-Log-xl_running_xact-s-at-a-higher-frequ.patch</font></div><div><font size="2"   >patch -p1 &lt; ../patch/0011-wal_decoding-copydir-make-fsync_fname-public.patch</font></div><div><font size="2"   >patch -p1 &lt; ../patch/0012-wal_decoding-Add-information-about-a-tables-primary-.patch</font></div><div><font size="2"   >patch -p1 &lt; ../patch/0013-wal_decoding-Introduce-wal-decoding-via-catalog-time.patch</font></div><div><font size="2"   >patch -p1 &lt; ../patch/0014-wal_decoding-test_decoding-Add-a-simple-decoding-mod.patch</font></div><div><font size="2"   >patch -p1 &lt; ../patch/0015-wal_decoding-pg_receivellog-Introduce-pg_receivexlog.patch</font></div><div><font size="2"   >patch -p1 &lt; ../patch/0016-wal_decoding-test_logical_decoding-Add-extension-for.patch</font></div><div><font size="2"   >patch -p1 &lt; ../patch/0017-wal_decoding-design-document-v2.4-and-snapshot-build.patch</font></div><div><font size="2"   >patch -p1 &lt; ../patch/0001-wal_decoding-mergme-Fix-pg_basebackup-makefile.patch</font></div><div><font size="2"   >patch -p1 &lt; ../patch/0002-wal_decoding-mergme-Fix-test_logical_decoding-Makefi.patch</font></div><div><font size="2"   >patch -p1 &lt; ../patch/0001-wal_decoding-mergme-Don-t-use-out-of-scope-local-var.patch</font></div></div><p></p></pre></div><div>确保没有FAILED的输出.</div><div><br></div><div>编译安装</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >cd&nbsp;</span><span style="line-height: 22px;"   >postgresql-bab54e3</span></font></div><div><font size="2"   >./configure --prefix=/home/pg94/pgsql9.4devel --with-pgport=1921 --with-perl --with-tcl --with-python --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=16 &amp;&amp; gmake &amp;&amp; gmake install</font></div><p></p></pre></div><div>报错</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >snapbuild.c:206: error: redefinition of typedef ‘SnapBuild’</font></div><div><font size="2"   >../../../../src/include/replication/snapbuild.h:54: error: previous declaration of ‘SnapBuild’ was here</font></div><div><font size="2"   >gmake[4]: *** [snapbuild.o] Error 1</font></div><p></p></pre></div><div>修复错误</div><div>将src/backend/replication/logical/snapbuild.c中的<span style="line-height: 22px;"   >SnapBuild结构定义复制到</span><span style="line-height: 22px;"   >src/include/replication/snapbuild.h,&nbsp;</span></div><div><span style="line-height: 22px;"   >同时删除</span><span style="line-height: 22px;"   >src/backend/replication/logical/snapbuild.c中的</span><span style="line-height: 22px;"   >SnapBuild结构定义.</span></div><div>如下</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >typedef struct SnapBuild</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* how far are we along building our first full snapshot */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SnapBuildState state;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* private memory context used to allocate memory for this module. */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; MemoryContext context;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* all transactions &lt; than this have committed/aborted */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TransactionId xmin;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* all transactions &gt;= than this are uncommitted */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TransactionId xmax;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Don't replay commits from an LSN &lt;= this LSN. This can be set</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* externally but it will also be advanced (never retreat) from within</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* snapbuild.c.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; XLogRecPtr &nbsp; &nbsp; &nbsp;transactions_after;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Don't start decoding WAL until the "xl_running_xacts" information</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* indicates there are no running xids with a xid smaller than this.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TransactionId initial_xmin_horizon;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Snapshot thats valid to see all currently committed transactions that</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* see catalog modifications.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Snapshot &nbsp; &nbsp; &nbsp; &nbsp;snapshot;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* LSN of the last location we are sure a snapshot has been serialized to.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; XLogRecPtr &nbsp; &nbsp; &nbsp;last_serialized_snapshot;</font></div></div><div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ReorderBuffer *reorder;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* variable length data */</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Information about initially running transactions</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* When we start building a snapshot there already may be transactions in</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* progress. &nbsp;Those are stored in running.xip. &nbsp;We don't have enough</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* information about those to decode their contents, so until they are</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* finished (xcnt=0) we cannot switch to a CONSISTENT state.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* As long as running.xcnt all XIDs &lt; running.xmin and &gt; running.xmax</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* have to be checked whether they still are running.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TransactionId xmin;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TransactionId xmax;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;xcnt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* number of used xip entries */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;xcnt_space; /* allocated size of xip */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TransactionId *xip; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* running xacts array, xidComparator-sorted */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; } &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; running;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Array of transactions which could have catalog changes that committed</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* between xmin and xmax</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* number of committed transactions */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;xcnt;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* available space for committed transactions */</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;xcnt_space;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Until we reach a CONSISTENT state, we record commits of all</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* transactions, not just the catalog changing ones. Record when that</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* changes so we know we cannot export a snapshot safely anymore.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bool &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;includes_all_transactions;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Array of committed transactions that have modified the catalog.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* As this array is frequently modified we do *not* keep it in</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* xidComparator order. Instead we sort the array when building &amp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* distributing a snapshot.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* XXX: That doesn't seem to be good reasoning anymore. Everytime we</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* add something here after becoming consistent will also require</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* distributing a snapshot. Storing them sorted would potentially make</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* it easier to purge as well (but more complicated wrt wraparound?).</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TransactionId *xip;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; } &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; committed;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >} SnapBuild;</font></div></div><p></p></pre></div><div>注释src/include/replication/snapbuild.h中的<span style="line-height: 22px;"   >SnapBuild</span>定义 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >// struct SnapBuild;</font></div><div><font size="2"   >// typedef struct SnapBuild SnapBuild;</font></div><p></p></pre></div><div><br></div><div>重新执行gmake, 正常.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd&nbsp;postgresql-bab54e3</font></div><div><font size="2"   >gmake</font></div><div><font size="2"   >gmake install</font></div><div><font size="2"   >cd contrib</font></div><div><font size="2"   >gmake</font></div><div><font size="2"   >gmake install</font></div><p></p></pre></div><div><br></div><div>初始化数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >initdb -E UTF8 -D $PGDATA --locale=C -W -U postgres</font></div><div></div><p></p></pre></div><div><br></div><div>逻辑复制的相关参数的变化 :&nbsp;</div><div>postgresql.conf</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >#wal_level = minimal &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# minimal, archive, logical or hot_standby</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div></div><div><div><font size="2"   >#max_wal_senders = 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of walsender processes, including</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # both physical and logical replication senders.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div></div><div><div><font size="2"   >#max_logical_slots = 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of logical replication sender</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # and receiver processes. Logical senders</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (but not receivers) also consume a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # max_wal_senders slot.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div></div><p></p></pre></div><div>将以上参数配置为 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >wal_level = logical</font></div><div><font size="2"   >max_wal_senders = 16</font></div><div><font size="2"   >max_logical_slots = 8</font></div></pre></div><div>逻辑复制新增的命令</div><div>pg_receivellog</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg_receivellog receives PostgreSQL logical change stream.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Usage:</font></div><div><font size="2"   >&nbsp; pg_receivellog [OPTION]...</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Options:</font></div><div><font size="2"   >&nbsp; -f, --file=FILE &nbsp; &nbsp; &nbsp; &nbsp;receive log into this file. - for stdout</font></div><div><font size="2"   >&nbsp; -n, --no-loop &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;do not loop on connection lost</font></div><div><font size="2"   >&nbsp; -v, --verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;output verbose messages</font></div><div><font size="2"   >&nbsp; -V, --version &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;output version information, then exit</font></div><div><font size="2"   >&nbsp; -?, --help &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; show this help, then exit</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Connection options:</font></div><div><font size="2"   >&nbsp; -d, --database=DBNAME &nbsp;database to connect to</font></div><div><font size="2"   >&nbsp; -h, --host=HOSTNAME &nbsp; &nbsp;database server host or socket directory</font></div><div><font size="2"   >&nbsp; -p, --port=PORT &nbsp; &nbsp; &nbsp; &nbsp;database server port number</font></div><div><font size="2"   >&nbsp; -U, --username=NAME &nbsp; &nbsp;connect as specified database user</font></div><div><font size="2"   >&nbsp; -w, --no-password &nbsp; &nbsp; &nbsp;never prompt for password</font></div><div><font size="2"   >&nbsp; -W, --password &nbsp; &nbsp; &nbsp; &nbsp; force password prompt (should happen automatically)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Replication options:</font></div><div><font size="2"   >&nbsp; -P, --plugin=PLUGIN &nbsp; &nbsp;use output plugin PLUGIN (defaults to test_decoding)</font></div><div><font size="2"   >&nbsp; -s, --status-interval=INTERVAL</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;time between status packets sent to server (in seconds)</font></div><div><font size="2"   >&nbsp; -S, --slot=SLOT &nbsp; &nbsp; &nbsp; &nbsp;use existing replication slot SLOT instead of starting a new one</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Action to be performed:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; --init &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; initiate a new replication slot (for the slotname see --slot)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; --start &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;start streaming in a replication slot (for the slotname see --slot)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; --stop &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stop the replication slot (for the slotname see --slot)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Report bugs to &lt;pgsql-bugs@postgresql.org&gt;.</font></div><p></p></pre></div><div>新增的几个函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \df *.*replica*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of functions</font></div><div><font size="2"   >&nbsp; &nbsp;Schema &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Result data type | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Argument data types &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;Type &nbsp;</font></div><div><font size="2"   >------------+--------------------------+------------------+-----------------------------------------------------------------------+-</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;pg_catalog | init_logical_replication | record &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | slotname name, plugin name, OUT slotname text, OUT xlog_position text |&nbsp;</font></div><div><font size="2"   >normal</font></div><div><font size="2"   >&nbsp;pg_catalog | stop_logical_replication | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >normal</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>新增的extension &nbsp;:&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cat test_logical_decoding--1.0.sql</font></div><div><font size="2"   >-- complain if script is sourced in psql, rather than via CREATE EXTENSION</font></div><div><font size="2"   >\echo Use "CREATE EXTENSION test_logical_decoding" to load this file. \quit</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION start_logical_replication (slotname name, pos text, VARIADIC options text[] DEFAULT '{}', OUT location text, OUT xid bigint, OUT data text) RETURNS SETOF record</font></div><div><font size="2"   >AS 'MODULE_PATHNAME', 'start_logical_replication'</font></div><div><font size="2"   >LANGUAGE C IMMUTABLE STRICT;</font></div><p></p></pre></div><div>启动数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg_ctl start</font></div><div></div><p></p></pre></div><div><br></div><div>测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg94@db-192-168-100-216-&gt; psql</font></div><div><font size="2"   >psql (9.4devel)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><div><font size="2"   >digoal=# create extension test_logical_decoding;</font></div><div><font size="2"   >CREATE EXTENSION</font></div></div><div><div><font size="2"   >digoal=# SELECT * FROM init_logical_replication('regression_slot', 'test_decoding');</font></div><div><font size="2"   >&nbsp; &nbsp; slotname &nbsp; &nbsp; | xlog_position&nbsp;</font></div><div><font size="2"   >-----------------+---------------</font></div><div><font size="2"   >&nbsp;regression_slot | 0/18402B8</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# CREATE TABLE foo(id serial primary key, data text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# INSERT INTO foo(data) VALUES(1);</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# UPDATE foo SET id = -id, data = ':'||data;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >digoal=# DELETE FROM foo;</font></div><div><font size="2"   >DELETE 1</font></div><div><font size="2"   >digoal=# DROP TABLE foo;</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >digoal=# SELECT * FROM start_logical_replication('regression_slot', 'now', 'hide-xids', '0');</font></div><div><font size="2"   >&nbsp;location &nbsp;| xid &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------+------+--------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;0/18402E8 | 1686 | BEGIN</font></div><div><font size="2"   >&nbsp;0/18402E8 | 1686 | COMMIT</font></div><div><font size="2"   >&nbsp;0/185EEB0 | 1687 | BEGIN</font></div><div><font size="2"   >&nbsp;0/185EEB0 | 1687 | table "foo": INSERT: id[int4]:1 data[text]:1</font></div><div><font size="2"   >&nbsp;0/185EEB0 | 1687 | COMMIT</font></div><div><font size="2"   >&nbsp;0/185EFC8 | 1688 | BEGIN</font></div><div><font size="2"   >&nbsp;0/185EFC8 | 1688 | table "foo": UPDATE: old-pkey: id[int4]:1 new-tuple: id[int4]:-1 data[text]::1</font></div><div><font size="2"   >&nbsp;0/185EFC8 | 1688 | COMMIT</font></div><div><font size="2"   >&nbsp;0/185F0A0 | 1689 | BEGIN</font></div><div><font size="2"   >&nbsp;0/185F0A0 | 1689 | table "foo": DELETE: id[int4]:-1</font></div><div><font size="2"   >&nbsp;0/185F0A0 | 1689 | COMMIT</font></div><div><font size="2"   >&nbsp;0/185F2A8 | 1690 | BEGIN</font></div><div><font size="2"   >&nbsp;0/185F2A8 | 1690 | COMMIT</font></div><div><font size="2"   >(13 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# SELECT * FROM pg_stat_logical_decoding ;</font></div><div><font size="2"   >&nbsp; &nbsp; slot_name &nbsp; &nbsp;| &nbsp; &nbsp;plugin &nbsp; &nbsp; | database | active | xmin | restart_decoding_lsn&nbsp;</font></div><div><font size="2"   >-----------------+---------------+----------+--------+------+----------------------</font></div><div><font size="2"   >&nbsp;regression_slot | test_decoding | &nbsp; &nbsp;16384 | f &nbsp; &nbsp; &nbsp;| 1686 | 0/1840280</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# SELECT * FROM stop_logical_replication('regression_slot');</font></div><div><font size="2"   >&nbsp;stop_logical_replication&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>pg_receivellog测试</div><div>配置pg_hba.conf</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >local &nbsp; replication &nbsp; &nbsp; postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div><div><font size="2"   >host &nbsp; &nbsp;replication &nbsp; &nbsp; postgres &nbsp; &nbsp; &nbsp; &nbsp;127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div></div><div><font size="2"   >pg_ctl reload</font></div><p></p></pre></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg94@db-192-168-100-216-&gt; pg_receivellog -f ./test.logical -d digoal -h $PGDATA -p 1921 -U postgres -P test_decoding -s 1 -S test --init</font></div><div><font size="2"   >WARNING: &nbsp;Initiating logical rep from 0/1861E10</font></div></div><div><div><font size="2"   >pg94@db-192-168-100-216-&gt; pg_receivellog -f ./test.logical -d digoal -h $PGDATA -p 1921 -U postgres -P test_decoding -s 1 -S test --start</font></div><div><font size="2"   >WARNING: &nbsp;Starting logical replication</font></div></div><p></p></pre></div><div>查询pg_stat_replication</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_stat_replication ;</font></div><div><font size="2"   >&nbsp; pid &nbsp;| usesysid | usename &nbsp;| application_name | client_addr | client_hostname | client_port | &nbsp; &nbsp; &nbsp; &nbsp; backend_start &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; st</font></div><div><font size="2"   >ate &nbsp; | sent_location | write_location | flush_location | replay_location | sync_priority | sync_state&nbsp;</font></div><div><font size="2"   >-------+----------+----------+------------------+-------------+-----------------+-------------+-------------------------------+-----</font></div><div><font size="2"   >------+---------------+----------------+----------------+-----------------+---------------+------------</font></div><div><font size="2"   >&nbsp;30794 | &nbsp; &nbsp; &nbsp; 10 | postgres | pg_receivellog &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-1 | 2013-07-30 16:38:56.100306+08 | stre</font></div><div><font size="2"   >aming | 0/1865AF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | async</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>DDL未记录 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create table t(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >pg94@db-192-168-100-216-&gt; cat test.logical&nbsp;</font></div><div><font size="2"   >BEGIN 1692</font></div><div><font size="2"   >COMMIT 1692</font></div></div><p></p></pre></div><div>DML有记录</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# insert into t values (1);</font></div><div><font size="2"   >INSERT 0 1</font></div></div><div><div><font size="2"   >pg94@db-192-168-100-216-&gt; cat test.logical&nbsp;</font></div><div><font size="2"   >BEGIN 1692</font></div><div><font size="2"   >COMMIT 1692</font></div><div><font size="2"   >BEGIN 1693</font></div><div><font size="2"   >table "t": INSERT: id[int4]:1</font></div><div><font size="2"   >COMMIT 1693</font></div></div><p></p></pre></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# create table t1(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >pg94@db-192-168-100-216-&gt; cat test.logical&nbsp;</font></div><div><font size="2"   >BEGIN 1692</font></div><div><font size="2"   >COMMIT 1692</font></div><div><font size="2"   >BEGIN 1693</font></div><div><font size="2"   >table "t": INSERT: id[int4]:1</font></div><div><font size="2"   >COMMIT 1693</font></div><div><font size="2"   >BEGIN 1694</font></div><div><font size="2"   >COMMIT 1694</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# insert into t1 values (1);</font></div><div><font size="2"   >INSERT 0 1</font></div></div><div><div><font size="2"   >pg94@db-192-168-100-216-&gt; cat test.logical&nbsp;</font></div><div><font size="2"   >BEGIN 1692</font></div><div><font size="2"   >COMMIT 1692</font></div><div><font size="2"   >BEGIN 1693</font></div><div><font size="2"   >table "t": INSERT: id[int4]:1</font></div><div><font size="2"   >COMMIT 1693</font></div><div><font size="2"   >BEGIN 1694</font></div><div><font size="2"   >COMMIT 1694</font></div><div><font size="2"   >BEGIN 1695</font></div><div><font size="2"   >table "t1": INSERT: id[int4]:1</font></div><div><font size="2"   >COMMIT 1695</font></div></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/message-id/flat/20130614224817.GA19641@awork2.anarazel.de#20130614224817.GA19641@awork2.anarazel.de"   >http://www.postgresql.org/message-id/flat/20130614224817.GA19641@awork2.anarazel.de#20130614224817.GA19641@awork2.anarazel.de</a></div><div>2.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=snapshot;h=bab54e383dd102001753366d3c124f706c7967dd;sf=tgz"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=snapshot;h=bab54e383dd102001753366d3c124f706c7967dd;sf=tgz</a></div><div>3. 补丁介绍</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >By&nbsp;Andres Freund</font></div><div><div><font size="2"   >Hi!</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >I am rather pleased to announce the next version of the changeset</font></div><div><font size="2"   >extraction patchset. Thanks to help from a large number of people I</font></div><div><font size="2"   >think we are slowly getting to the point where it is getting</font></div><div><font size="2"   >committable.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Since the last submitted version</font></div><div><font size="2"   >(20121115002746(dot)GA7692(at)awork2(dot)anarazel(dot)de) a large number of fixes and</font></div><div><font size="2"   >the result of good amount of review has been added to the tree. All</font></div><div><font size="2"   >bugs known to me have been fixed.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Fixes include:</font></div><div><font size="2"   >* synchronous replication support</font></div><div><font size="2"   >* don't peg the xmin for user tables, do it only for catalog ones.</font></div><div><font size="2"   >* arbitrarily large transaction support by spilling large transactions</font></div><div><font size="2"   >&nbsp; to disk</font></div><div><font size="2"   >* spill snapshots to disk, so we can restart without waiting for a new</font></div><div><font size="2"   >&nbsp; snapshot to be built</font></div><div><font size="2"   >* Don't read all WAL from the establishment of a logical slot</font></div><div><font size="2"   >* tests via SQL interface to changeset extraction</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The todo list includes:</font></div><div><font size="2"   >* morph the "logical slot" interface into being "replication slots" that</font></div><div><font size="2"   >&nbsp; can also be used by streaming replication</font></div><div><font size="2"   >* move some more code from snapbuild.c to decode.c to remove a largely</font></div><div><font size="2"   >&nbsp; duplicated switch</font></div><div><font size="2"   >* do some more header/comment cleanup &amp; clarification</font></div><div><font size="2"   >* move pg_receivellog into its own directory in src/bin or contrib/.</font></div><div><font size="2"   >* user/developer level documentation</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The patch series currently has two interfaces to logical decoding. One -</font></div><div><font size="2"   >which is primarily useful for pg_regress style tests and playing around</font></div><div><font size="2"   >- is SQL based, the other one uses a walsender replication connection.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >A quick demonstration of the SQL interface (server needs to be started</font></div><div><font size="2"   >with wal_level = logical and max_logical_slots &gt; 0):</font></div><div><font size="2"   >=# CREATE EXTENSION test_logical_decoding;</font></div><div><font size="2"   >=# SELECT * FROM init_logical_replication('regression_slot', 'test_decoding');</font></div><div><font size="2"   >&nbsp; &nbsp; slotname &nbsp; &nbsp; | xlog_position&nbsp;</font></div><div><font size="2"   >-----------------+---------------</font></div><div><font size="2"   >&nbsp;regression_slot | 0/17D5908</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >=# CREATE TABLE foo(id serial primary key, data text);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >=# INSERT INTO foo(data) VALUES(1);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >=# UPDATE foo SET id = -id, data = ':'||data;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >=# DELETE FROM foo;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >=# DROP TABLE foo;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >=# SELECT * FROM start_logical_replication('regression_slot', 'now', 'hide-xids', '0');</font></div><div><font size="2"   >&nbsp;location &nbsp;| xid | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data</font></div><div><font size="2"   >-----------+-----+--------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;0/17D59B8 | 695 | BEGIN</font></div><div><font size="2"   >&nbsp;0/17D59B8 | 695 | COMMIT</font></div><div><font size="2"   >&nbsp;0/17E8B58 | 696 | BEGIN</font></div><div><font size="2"   >&nbsp;0/17E8B58 | 696 | table "foo": INSERT: id[int4]:1 data[text]:1</font></div><div><font size="2"   >&nbsp;0/17E8B58 | 696 | COMMIT</font></div><div><font size="2"   >&nbsp;0/17E8CA8 | 697 | BEGIN</font></div><div><font size="2"   >&nbsp;0/17E8CA8 | 697 | table "foo": UPDATE: old-pkey: id[int4]:1 new-tuple: id[int4]:-1 data[text]::1</font></div><div><font size="2"   >&nbsp;0/17E8CA8 | 697 | COMMIT</font></div><div><font size="2"   >&nbsp;0/17E8E50 | 698 | BEGIN</font></div><div><font size="2"   >&nbsp;0/17E8E50 | 698 | table "foo": DELETE: id[int4]:-1</font></div><div><font size="2"   >&nbsp;0/17E8E50 | 698 | COMMIT</font></div><div><font size="2"   >&nbsp;0/17E9058 | 699 | BEGIN</font></div><div><font size="2"   >&nbsp;0/17E9058 | 699 | COMMIT</font></div><div><font size="2"   >(13 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >=# SELECT * FROM pg_stat_logical_decoding ;</font></div><div><font size="2"   >&nbsp; &nbsp; slot_name &nbsp; &nbsp;| &nbsp; &nbsp;plugin &nbsp; &nbsp; | database | active | xmin | restart_decoding_lsn&nbsp;</font></div><div><font size="2"   >-----------------+---------------+----------+--------+------+----------------------</font></div><div><font size="2"   >&nbsp;regression_slot | test_decoding | &nbsp; &nbsp;12042 | f &nbsp; &nbsp; &nbsp;| &nbsp;695 | 0/17D58D0</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >=# SELECT * FROM stop_logical_replication('regression_slot');</font></div><div><font size="2"   >&nbsp;stop_logical_replication</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The walsender interface has the same calls</font></div><div><font size="2"   >INIT_LOGICAL_REPLICATION 'slot' 'plugin';</font></div><div><font size="2"   >START_LOGICAL_REPLICATION 'slot' restart_lsn [(option value)*];</font></div><div><font size="2"   >STOP_LOGICAL_REPLICATION 'slot';</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The only difference is that START_LOGICAL_REPLICATION can stream changes</font></div><div><font size="2"   >and it can support synchronous replication.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The output seen in the 'data' column is produced by a so called 'output</font></div><div><font size="2"   >plugin' which users of the facility can write to suit their needs. They</font></div><div><font size="2"   >can be written by implementing 5 functions in the shared object that's</font></div><div><font size="2"   >passed to init_logical_replication() above:</font></div><div><font size="2"   >* pg_decode_init (optional)</font></div><div><font size="2"   >* pg_decode_begin_txn</font></div><div><font size="2"   >* pg_decode_change</font></div><div><font size="2"   >* pg_decode_commit_txn</font></div><div><font size="2"   >* pg_decode_cleanup (optional)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The most interesting function pg_decode_change get's passed a structure</font></div><div><font size="2"   >containing old/new versions of the row, the 'struct Relation' belonging</font></div><div><font size="2"   >to it and metainformation about the transaction.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The output plugin can rely on syscache lookups et al. to decode the</font></div><div><font size="2"   >changed tuple in whatever fashion it wants.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >I'd like to invite reviewers to first look at:</font></div><div><font size="2"   >* the output plugin interface</font></div><div><font size="2"   >* the walsender/SRF interface</font></div><div><font size="2"   >* patch 12 which contains most of the code</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >When reading the code, the information flow during decoding might be</font></div><div><font size="2"   >interesting:</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +---------------+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | XLogReader &nbsp; &nbsp;|</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +---------------+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XLOG Records</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +---------------+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | decode.c &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +---------------+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >+---------------+ &nbsp; &nbsp;|</font></div><div><font size="2"   >| snapbuild.c &nbsp; | &nbsp;HeapTupleData</font></div><div><font size="2"   >+---------------+ &nbsp; &nbsp;|</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; catalog snapshots &nbsp;|</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v &nbsp; &nbsp; &nbsp; v</font></div><div><font size="2"   ><span>	</span> &nbsp;+---------------+</font></div><div><font size="2"   ><span>	</span> &nbsp;|reorderbuffer.c|</font></div><div><font size="2"   ><span>	</span> &nbsp;+---------------+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; HeapTuple &amp; Metadata</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +---------------+</font></div><div><font size="2"   ><span>	</span> &nbsp;| Output Plugin |</font></div><div><font size="2"   ><span>	</span> &nbsp;+---------------+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Whatever you want</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +---------------+</font></div><div><font size="2"   ><span>	</span> &nbsp;| Output Handler|</font></div><div><font size="2"   ><span>	</span> &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   ><span>	</span> &nbsp;|WalSnd or SRF &nbsp;|</font></div><div><font size="2"   ><span>	</span> &nbsp;+---------------+</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Overview of the attached patches:</font></div><div><font size="2"   >0001: indirect toast tuples; required but submitted independently</font></div><div><font size="2"   >0002: functions for testing; not required,</font></div><div><font size="2"   >0003: (tablespace, filenode) syscache; required</font></div><div><font size="2"   >0004: RelationMapFilenodeToOid: required, simple</font></div><div><font size="2"   >0005: pg_relation_by_filenode() function; not required but useful</font></div><div><font size="2"   >0006: Introduce InvalidCommandId: required, simple</font></div><div><font size="2"   >0007: Adjust Satisfies* interface: required, mechanical,</font></div><div><font size="2"   >0008: Allow walsender to attach to a database: required, needs review</font></div><div><font size="2"   >0009: New GetOldestXmin() parameter; required, pretty boring</font></div><div><font size="2"   >0010: Log xl_running_xact regularly in the bgwriter: required</font></div><div><font size="2"   >0011: make fsync_fname() public; required, needs to be in a different file</font></div><div><font size="2"   >0012: Relcache support for an Relation's primary key: required</font></div><div><font size="2"   >0013: Actual changeset extraction; required</font></div><div><font size="2"   >0014: Output plugin demo; not required (except for testing) but useful</font></div><div><font size="2"   >0015: Add pg_receivellog program: not required but useful</font></div><div><font size="2"   >0016: Add test_logical_decoding extension; not required, but contains</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; the tests for the feature. Uses 0014</font></div><div><font size="2"   >0017: Snapshot building docs; not required</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Greetings,</font></div><div><font size="2"   >Andres Freund</font></div></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>