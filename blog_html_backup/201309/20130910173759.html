<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">find systemtap pre-built probe points & probe points reference manual</h2>
	<h5 id="">2013-09-10 17:37:59&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201381044416754/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>systemtap内建了大量的probe event. 以及alias.</div><div>一般放在<span style="line-height: 22px;"   >/usr/share/systemtap/tapset/这个目录中, 以stp后缀结尾的文件中.</span></div><div><span style="line-height: 22px;"   ><br></span></div><div>使用stap --vp 5输出详细信息, 可以看到stap搜索的目录.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 -e "probe begin { exit() }"</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 147264virt/23696res/3012shr/21860data kb, in 160usr/10sys/171real ms.</font></div><p></p></pre></div></div><div><br></div><div>如果自己定义了一些probe alias放在.stp文件中, 那么可以通过-I来添加存放自定义stp文件的目录.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >man stap</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;-I DIR Add the given directory to the tapset search directory. &nbsp;See the description of pass 2 for details.</font></div><p></p></pre></div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# pwd</font></div><div><font size="2"   >/root</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# ll *.stp</font></div><div><font size="2"   >-rw-r--r-- 1 root root 107 Sep &nbsp;6 16:50 p.stp</font></div><div><font size="2"   >-rw-r--r-- 1 root root 320 Sep 10 15:13 test.stp</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -I /root --vp 5 -e "probe begin { exit() }"</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >parse error: command line argument index 1 out of range [1-0]</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at: unknown token '$1' at /root/test.stp:6:17</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;source: &nbsp; &nbsp; for (i=0; i&lt;$1; i++) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >1 parse error.</font></div><div><font size="2"   >WARNING: tapset '/root/test.stp' has errors, and will be skipped.</font></div><div><font size="2"   >在指定的目录中发现两个.stp文件, 处理了1个.</font></div><div><font size="2"   >Searched: " /root/*.stp ", found: 2, processed: 1</font></div><div><font size="2"   >Pass 1: parsed user script and 86 library script(s) using 146916virt/23728res/3024shr/21512data kb, in 170usr/10sys/174real ms.</font></div><p></p></pre></div><div>一.&nbsp;</div><div>查找内建的probe event或者别名, 可以直接去这几个检索的目录中grep, 也可以使用stap命令行参数进行匹配检索.</div><div>1. 直接去预装的stp脚本目录中检索举例 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 ~]# grep -r "^probe " /usr/share/systemtap/tapset/* | less</font></div><div><font size="2"   >/usr/share/systemtap/tapset/argv.stp:probe begin(-1) {</font></div><div><font size="2"   >/usr/share/systemtap/tapset/i386/nd_syscalls.stp:probe nd_syscall.get_thread_area = kprobe.function("sys_get_thread_area")</font></div><div><font size="2"   >/usr/share/systemtap/tapset/i386/nd_syscalls.stp:probe nd_syscall.get_thread_area.return = kprobe.function("sys_get_thread_area").return</font></div><div><font size="2"   >/usr/share/systemtap/tapset/i386/nd_syscalls.stp:probe nd_syscall.iopl = kprobe.function("sys_iopl")</font></div><div><font size="2"   >/usr/share/systemtap/tapset/i386/nd_syscalls.stp:probe nd_syscall.iopl.return = kprobe.function("sys_iopl").return</font></div></div><div><font size="2"   >... 略</font></div><p></p></pre></div><div>使用这种方法检索到的基本上都是probe alias, 方便我们使用, 其实这些别名都是kernel.funciton或者kprobe.funciton之类的event.</div><div>例如syscall :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# grep -r "^probe " /usr/share/systemtap/tapset/* | grep "probe syscall" | less</font></div><div><font size="2"   >/usr/share/systemtap/tapset/i386/syscalls.stp:probe syscall.get_thread_area = kernel.function("sys_get_thread_area")</font></div><div><font size="2"   >/usr/share/systemtap/tapset/i386/syscalls.stp:probe syscall.get_thread_area.return = kernel.function("sys_get_thread_area").return</font></div><div><font size="2"   >/usr/share/systemtap/tapset/i386/syscalls.stp:probe syscall.iopl = kernel.function("sys_iopl")</font></div><div><font size="2"   >/usr/share/systemtap/tapset/i386/syscalls.stp:probe syscall.iopl.return = kernel.function("sys_iopl").return</font></div><div><font size="2"   >... 略</font></div><p></p></pre></div><div><br></div><div>2. 使用stap -l 参数检索举例 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 -l 'syscall.*'|less</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 146604virt/23692res/3008shr/21200data kb, in 160usr/10sys/172real ms.</font></div><div><font size="2"   >syscall.accept</font></div><div><font size="2"   >syscall.access</font></div><div><font size="2"   >syscall.acct</font></div><div><font size="2"   >syscall.add_key</font></div><div><font size="2"   >syscall.adjtimex</font></div><div><font size="2"   >syscall.alarm</font></div><div><font size="2"   >syscall.arch_prctl</font></div></div><div><font size="2"   >... 略</font></div><p></p></pre></div><div><br></div><div>使用stap支持通配符查找.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -l 'syscall.*.return'|less</font></div><div><font size="2"   >syscall.accept.return</font></div><div><font size="2"   >syscall.access.return</font></div><div><font size="2"   >syscall.acct.return</font></div><div><font size="2"   >syscall.add_key.return</font></div><div><font size="2"   >syscall.adjtimex.return</font></div><div><font size="2"   >syscall.alarm.return</font></div><div><font size="2"   >syscall.arch_prctl.return</font></div><div><font size="2"   >syscall.bdflush.return</font></div></div><div><font size="2"   >... 略</font></div><p></p></pre></div><div><br></div><div>查找kernel.function("*") , :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 -l 'kernel.function("*")'|less</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 146604virt/23688res/3008shr/21200data kb, in 170usr/0sys/173real ms.</font></div><div><font size="2"   >kernel.function("BDEV_I@fs/block_dev.c:32")</font></div><div><font size="2"   >kernel.function("DQUOT_ALLOC_INODE@include/linux/quotaops.h:168")</font></div><div><font size="2"   >kernel.function("DQUOT_ALLOC_SPACE@include/linux/quotaops.h:148")</font></div><div><font size="2"   >kernel.function("DQUOT_ALLOC_SPACE_NODIRTY@include/linux/quotaops.h:126")</font></div><div><font size="2"   >kernel.function("DQUOT_DROP@include/linux/quotaops.h:83")</font></div><div><font size="2"   >kernel.function("DQUOT_FREE_INODE@include/linux/quotaops.h:219")</font></div><div><font size="2"   >kernel.function("DQUOT_FREE_SPACE@include/linux/quotaops.h:213")</font></div></div><div><font size="2"   >... 略</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >kernel.function("*")有</span><span style="line-height: 22px;"   >18124</span><span style="line-height: 22px;"   >个, 而tapset目录中只有2千多个alias.&nbsp;</span></div><div><span style="line-height: 22px;"   >所以需要更精细的事件, 还是去kernel.funciton中找吧. 当然2千多个alias日常已经够用了.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 -l 'kernel.function("*")'|wc -l</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 146604virt/23688res/3008shr/21200data kb, in 170usr/0sys/172real ms.</font></div><div><font size="2"   >18124</font></div><div><div><font size="2"   >[root@db-172-16-3-39 ~]# grep -r "^probe " /usr/share/systemtap/tapset/|wc -l</font></div><div><font size="2"   >2230</font></div></div><p></p></pre></div><div><br></div><div>常用的查询条件, '*', '*.*' '**'</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 -l '*'</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 146608virt/23696res/3008shr/21204data kb, in 160usr/10sys/172real ms.</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >end</font></div><div><font size="2"   >error</font></div><div><font size="2"   >never</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 -l '*.*'| less</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 146604virt/23700res/3008shr/21200data kb, in 160usr/10sys/173real ms.</font></div><div><font size="2"   >_syscall.accept</font></div><div><font size="2"   >_vfs.block_prepare_write</font></div><div><font size="2"   >_vfs.block_write_begin</font></div><div><font size="2"   >_vfs.block_write_end</font></div><div><font size="2"   >_vfs.generic_block_bmap</font></div><div><font size="2"   >_vfs.generic_commit_write</font></div><div><font size="2"   >_vfs.generic_file_readonly_mmap</font></div></div><div><font size="2"   >... 略</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-39 tapset]# stap --vp 5 -l '**'| less<br>Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples<br>Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports<br>Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4<br>Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81<br>Pass 1: parsed user script and 85 library script(s) using 146608virt/23696res/3008shr/21204data kb, in 170usr/0sys/172real ms.<br>__nfs.aop.write_begin<br>__nfs.aop.write_begin.return<br>__nfs.aop.write_end<br>__nfs.aop.write_end.return<br>__scheduler.kthread_stop.kp</font></div><p></p></pre></div><div>这些通配符的含义可以参考man stapprobes</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >The &nbsp;general &nbsp;probe &nbsp;point &nbsp;syntax is a dotted-symbol sequence. &nbsp;This allows a breakdown of the event namespace</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;into parts, somewhat like the Domain Name System does on &nbsp;the &nbsp;Internet. &nbsp; Each &nbsp;component &nbsp;identifier &nbsp;may &nbsp;be</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;parametrized &nbsp;by a string or number literal, with a syntax like a function call. &nbsp;A component may include a "*"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;character, to expand to a set of matching probe points. &nbsp;It may also include "**" to match multiple &nbsp;sequential</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;components at once. &nbsp;Probe aliases likewise expand to other probe points. &nbsp;Each and every resulting probe point</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;is normally resolved to some low-level system instrumentation facility (e.g., a kprobe address, &nbsp;marker, &nbsp;or &nbsp;a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;timer configuration), otherwise the elaboration phase will fail.</font></div><p></p></pre></div><div><br></div><div>二.&nbsp;</div><div>获得event或者alias后, 怎么获得帮助呢? 比如要得到这些事件可用的target variable,&nbsp;</div><div>可以通过帮助手册,或者使用stap -L<span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >查找</span><span style="line-height: 22px;"   >, 或者使用$$vars打印.</span></div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -l "*.*"|grep vm.brk</font></div><div><font size="2"   >vm.brk</font></div><p></p></pre></div><div>变量获得 :&nbsp;</div><div>1. 通过stap -L</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -L vm.brk</font></div><div><font size="2"   >vm.brk name:string address:long length:long $addr:long unsigned int $len:long unsigned int $prev:struct vm_area_struct*</font></div><p></p></pre></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >man stap</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;-L PROBE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Similar to "-l", but list probe points and script-level local variables.</font></div><p></p></pre></div><div>2. 通过probe::*帮助手册 :&nbsp;</div><div>取自SystemTap Tapset Reference Manual</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# man probe::vm.brk</font></div><div><font size="2"   >PROBE::VM.BRK(3stap) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Memory Tapset &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PROBE::VM.BRK(3stap)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >NAME</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;probe::vm.brk - Fires when a brk is requested (i.e. the heap will be resized)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SYNOPSIS</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;vm.brk</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >VALUES</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;length the length of the memory segment</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;name &nbsp; name of the probe point</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;address</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; the requested address</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CONTEXT</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The process calling brk.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SystemTap Tapset Reference &nbsp; &nbsp; &nbsp; January 2013 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PROBE::VM.BRK(3stap)</font></div><p></p></pre></div><div>3. 还可以使用stap这种的特殊变量$$vars打印这个event的变量, 但是这种方法必须要当事件被触发才行.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cat test.stp&nbsp;</font></div><div><font size="2"   >probe vm.brk {</font></div><div><font size="2"   >&nbsp; printf("vars: %s\n", $$vars)</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap test.stp&nbsp;</font></div><div><font size="2"   >vars: addr=0x1fd59000 len=0x21000 mm=? vma=? prev=0xc000003e0000000c flags=? rb_link=? rb_parent=? pgoff=? error=?</font></div><p></p></pre></div><div>使用$$vars打印出来的是这个内核函数中定义的所有变量, 比stap -L和帮助手册更全面.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >expands to a character string that is equivalent to sprintf("parm1=%x ... &nbsp;parmN=%x &nbsp;var1=%x &nbsp;...</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; varN=%x", parm1, ..., parmN, var1, ..., varN)</font></div><p></p></pre></div><div><br></div><div>三.&nbsp;</div><div>probe points 帮助手册的结构 :&nbsp;</div><div>probe::*(3stap), tapset::*(3stap), function::*(3stap)</div><div>这三个man手册其实都是源自以下这本手册.</div><div>&lt;SystemTap Tapset Reference Manual&gt;</div><div><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/"   >https://sourceware.org/systemtap/tapsets/</a></div><div>tapset::* 指大的分类帮助查询, 分类中包含了属于该分类的probe和funciton.</div><div>probe::* 指单个probe point的帮助查询</div><div><span style="line-height: 22px;"   >function::* 指单个函数的帮助查询</span></div><div><span style="line-height: 22px;"   >另外一个更全的帮助索引见如下页面</span></div><div><a rel="nofollow" href="https://sourceware.org/systemtap/man/index.html"   >https://sourceware.org/systemtap/man/index.html</a></div><div><span style="line-height: 22px;"   >例如 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >tapset::kprocess(3stap) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tapset::kprocess(3stap)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >NAME</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;tapset::kprocess - systemtap kprocess tapset</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >DESCRIPTION</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;This family of probe points is used to probe process-related activities.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;kprocess.create</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fires whenever a new process or thread is successfully created</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;See probe::kprocess.create(3stap)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for details.</font></div></div><div><font size="2"   >... 略</font></div><p></p></pre></div><div>对应的是<span style="line-height: 22px;"   >&lt;SystemTap Tapset Reference Manual&gt; 第16章.</span></div><div><span style="line-height: 22px;"   >里面包含了kernel process tapset中的probe point和funciton. 例如</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 ~]# man probe::kprocess.create</font></div><div><font size="2"   >PROBE::KPROCESS.CREA(3stap) &nbsp;Kernel Process Tapset PROBE::KPROCESS.CREA(3stap)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >NAME</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;probe::kprocess.create - Fires whenever a new process or thread is successfully created</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SYNOPSIS</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;kprocess.create</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >VALUES</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;new_tid</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; The TID of the newly created task</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;new_pid</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; The PID of the newly created process</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CONTEXT</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Parent of the created process.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >DESCRIPTION</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Fires whenever a new process is successfully created, either as a result of fork (or one of its syscall</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;variants), or a new kernel thread.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SystemTap Tapset Reference &nbsp; &nbsp; &nbsp; January 2013 &nbsp; &nbsp; &nbsp;PROBE::KPROCESS.CREA(3stap)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-39 ~]# man function::target_set_pid</font></div><div><font size="2"   >FUNCTION::TARGET_SET(3stap) &nbsp;Kernel Process Tapset FUNCTION::TARGET_SET(3stap)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >NAME</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;function::target_set_pid - Does pid descend from target process?</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SYNOPSIS</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;target_set_pid(pid:)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >ARGUMENTS</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;pid &nbsp; &nbsp;The pid of the process to query</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >DESCRIPTION</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;This function returns whether the given process-id is within the “target set”, that is whether it is a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;descendant of the top-level target process.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SystemTap Tapset Reference &nbsp; &nbsp; &nbsp; January 2013 &nbsp; &nbsp; &nbsp;FUNCTION::TARGET_SET(3stap)</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   ><br></span></div><div>四.&nbsp;</div><div><span style="line-height: 22px;"   >查看vm.brk对应的源文件 :&nbsp;</span></div><div><span style="line-height: 22px;"   >首先在tapset目录中查找到alias对应的kernel.funciton.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# grep -r "^probe " /usr/share/systemtap/tapset/|grep vm.brk</font></div><div><font size="2"   >/usr/share/systemtap/tapset/memory.stp:probe vm.brk = kernel.function("do_brk") {</font></div><p></p></pre></div><div>然后用stap -l 查出对应的kernel.function详细信息</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -l 'kernel.function("*")'|grep do_brk</font></div><div><font size="2"   >kernel.function("do_brk@mm/mmap.c:2037")</font></div><p></p></pre></div><div>在源码的debug分支中可以找到这个源码文件.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd /usr/src/debug/kernel-2.6.18/linux-2.6.18-348.12.1.el5.x86_64</font></div><div><font size="2"   >less&nbsp;<span style="line-height: 22px;"   >mm/mmap.c</span></font></div><p></p></pre></div><div>对应的行查找到函数do_brk</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* &nbsp;this is really a simplified "do_mmap". &nbsp;it only handles</font></div><div><font size="2"   >&nbsp;* &nbsp;anonymous maps. &nbsp;eventually we may be able to do some</font></div><div><font size="2"   >&nbsp;* &nbsp;brk-specific accounting here.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >unsigned long do_brk(unsigned long addr, unsigned long len)</font></div><div><font size="2"   >2037: {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct mm_struct * mm = current-&gt;mm;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct vm_area_struct * vma, * prev;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; unsigned long flags;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct rb_node ** rb_link, * rb_parent;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; pgoff_t pgoff = addr &gt;&gt; PAGE_SHIFT;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int error;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; len = PAGE_ALIGN(len);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!len)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return addr;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; error = security_file_mmap_addr(0, 0, 0, 0, addr, 1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (error)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return error;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; flags = VM_DATA_DEFAULT_FLAGS | VM_ACCOUNT | mm-&gt;def_flags;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; error = get_unmapped_area(NULL, addr, len, 0, MAP_FIXED);</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; error = get_unmapped_area(NULL, addr, len, 0, MAP_FIXED);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (error &amp; ~PAGE_MASK)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return error;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* mlock MCL_FUTURE?</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (mm-&gt;def_flags &amp; VM_LOCKED) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unsigned long locked, lock_limit;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; locked = len &gt;&gt; PAGE_SHIFT;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; locked += mm-&gt;locked_vm;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lock_limit = current-&gt;signal-&gt;rlim[RLIMIT_MEMLOCK].rlim_cur;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lock_limit &gt;&gt;= PAGE_SHIFT;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (locked &gt; lock_limit &amp;&amp; !capable(CAP_IPC_LOCK))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return -EAGAIN;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* mm-&gt;mmap_sem is required to protect against another thread</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* changing the mappings in case we sleep.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; verify_mm_writelocked(mm);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Clear old maps. &nbsp;this also does some error checking for us</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp;munmap_back:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; vma = find_vma_prepare(mm, addr, &amp;prev, &amp;rb_link, &amp;rb_parent);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (vma &amp;&amp; vma-&gt;vm_start &lt; addr + len) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (do_munmap(mm, addr, len))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return -ENOMEM;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto munmap_back;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Check against address space limits *after* clearing old maps... */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!may_expand_vm(mm, len &gt;&gt; PAGE_SHIFT))</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Check against address space limits *after* clearing old maps... */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!may_expand_vm(mm, len &gt;&gt; PAGE_SHIFT))&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return -ENOMEM;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (mm-&gt;map_count &gt; sysctl_max_map_count)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return -ENOMEM;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (security_vm_enough_memory(len &gt;&gt; PAGE_SHIFT))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return -ENOMEM;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Can we just expand an old private anonymous mapping? */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (vma_merge(mm, prev, addr, addr + len, flags,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NULL, NULL, pgoff, NULL))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto out;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* create a vma struct for an anonymous mapping</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; vma = kmem_cache_zalloc(vm_area_cachep, GFP_KERNEL);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!vma) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vm_unacct_memory(len &gt;&gt; PAGE_SHIFT);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return -ENOMEM;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; vma-&gt;vm_mm = mm;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; vma-&gt;vm_start = addr;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; vma-&gt;vm_end = addr + len;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; vma-&gt;vm_pgoff = pgoff;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; vma-&gt;vm_flags = flags;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; vma-&gt;vm_page_prot = protection_map[flags &amp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (VM_READ|VM_WRITE|VM_EXEC|VM_SHARED)];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; vma_link(mm, vma, prev, rb_link, rb_parent);</font></div><div><font size="2"   >out: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; mm-&gt;total_vm += len &gt;&gt; PAGE_SHIFT;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (flags &amp; VM_LOCKED) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mm-&gt;locked_vm += len &gt;&gt; PAGE_SHIFT;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; make_pages_present(addr, addr + len);</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mm-&gt;locked_vm += len &gt;&gt; PAGE_SHIFT;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; make_pages_present(addr, addr + len);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return addr;</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   >EXPORT_SYMBOL(do_brk);</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="https://sourceware.org/systemtap/langref/Components_SystemTap_script.html"   >https://sourceware.org/systemtap/langref/Components_SystemTap_script.html</a></div><div>2. man&nbsp;stapprobes</div><div>3. man&nbsp;probe::*&nbsp;tapset::*</div><div>4.&nbsp;stappaths</div><div>5.&nbsp;SystemTap Tapset Reference Manual</div><div><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/"   >https://sourceware.org/systemtap/tapsets/</a></div>6. 帮助手册索引<div><a rel="nofollow" href="https://sourceware.org/systemtap/man/index.html"   >https://sourceware.org/systemtap/man/index.html</a></div></div>
	</div>
</div>
</body>
</html>