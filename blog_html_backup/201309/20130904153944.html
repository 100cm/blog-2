<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 pending patch : Hstore: (@> kv contains)Query speedups with Gin index</h2>
	<h5 id="">2013-09-04 15:39:44&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013849438523/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >Hey everyone,</font></span></div><div><font size="2"   >I'm looking for feedback on a contrib/hstore patch.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >We've been experiencing slow "@&gt;" queries involving an hstore column that's</font></div><div><font size="2"   >covered by a Gin index. At the current postgresql git HEAD, the hstore &lt;-&gt;</font></div><div><font size="2"   >gin interface produces the following text items to be indexed:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >hstore: "'a'=&gt;'1234', 'b'=&gt;'test'"</font></div><div><font size="2"   >Produces indexed text items: "Ka", "V1234", "Kb", "Vtest"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >For the size of our production table (10s of millions of rows), I observed</font></div><div><font size="2"   >significant query speedups by changing the index strategy to the following:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >hstore: "'a'=&gt;'1234', 'b'=&gt;'test'"</font></div><div><font size="2"   >Produces indexed text items: "Ka", "KaV1234", "Kb", "KbVtest"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The combined entry is used to support "contains (@&gt;)" queries, and the key</font></div><div><font size="2"   >only item is used to support "key contains (?)" queries. This change seems</font></div><div><font size="2"   >to help especially with hstore keys that have high cardinalities. Downsides</font></div><div><font size="2"   >of this change is that it requires an index rebuild, and the index will be</font></div><div><font size="2"   >larger in size.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Patch attached. Any thoughts on this change?</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Thanks,</font></div><div><font size="2"   >Blake</font></div><p></p></pre></div><div>该补丁尝试通过修改索引条目的内容来达到加速gin索引@&gt;, ?等操作符的目的.</div><div>补丁前gin索引中存储k值,v值. 补丁后索引中存储k值, k值+v值混合值.&nbsp;</div><div>所以对于@&gt;的查询效率是可以提高的. key的查询效率应该是不变的.</div><div>同时打了这个补丁对于key值比较散的情况, 索引容量会大增.</div><div>HSTORE操作符如下 :&nbsp;</div><div><p style="font-size: 12px; line-height: 1.5em; margin: 1.2em 0em; font-family: verdana, sans-serif;"   >Table F-6.&nbsp;<tt>hstore</tt>&nbsp;Operators</p><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; background-color: rgb(224, 236, 239); border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"   ><colgroup><col><col><col><col><thead><tr><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Operator</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Description</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Example</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Result</th></tr></thead><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>hstore</tt>&nbsp;<tt>-&gt;</tt>&nbsp;<tt>text</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >get value for key (<tt>NULL</tt>&nbsp;if not present)</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>'a=&gt;x, b=&gt;y'::hstore -&gt; 'a'</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>x</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>hstore</tt>&nbsp;<tt>-&gt;</tt>&nbsp;<tt>text[]</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >get values for keys (<tt>NULL</tt>&nbsp;if not present)</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>'a=&gt;x, b=&gt;y, c=&gt;z'::hstore -&gt; ARRAY['c','a']</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>{"z","x"}</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>hstore</tt>&nbsp;<tt>||</tt>&nbsp;<tt>hstore</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >concatenate&nbsp;<tt>hstore</tt>s</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>'a=&gt;b, c=&gt;d'::hstore || 'c=&gt;x, d=&gt;q'::hstore</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>"a"=&gt;"b", "c"=&gt;"x", "d"=&gt;"q"</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>hstore</tt>&nbsp;<tt>?</tt>&nbsp;<tt>text</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >does&nbsp;<tt>hstore</tt>&nbsp;contain key?</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>'a=&gt;1'::hstore ? 'a'</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>t</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>hstore</tt>&nbsp;<tt>?&amp;</tt>&nbsp;<tt>text[]</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >does&nbsp;<tt>hstore</tt>&nbsp;contain all specified keys?</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>'a=&gt;1,b=&gt;2'::hstore ?&amp; ARRAY['a','b']</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>t</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>hstore</tt>&nbsp;<tt>?|</tt>&nbsp;<tt>text[]</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >does&nbsp;<tt>hstore</tt>&nbsp;contain any of the specified keys?</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>'a=&gt;1,b=&gt;2'::hstore ?| ARRAY['b','c']</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>t</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>hstore</tt>&nbsp;<tt>@&gt;</tt>&nbsp;<tt>hstore</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >does left operand contain right?</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>'a=&gt;b, b=&gt;1, c=&gt;NULL'::hstore @&gt; 'b=&gt;1'</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>t</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>hstore</tt>&nbsp;<tt>&lt;@</tt>&nbsp;<tt>hstore</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >is left operand contained in right?</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>'a=&gt;c'::hstore &lt;@ 'a=&gt;b, b=&gt;1, c=&gt;NULL'</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>f</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>hstore</tt>&nbsp;<tt>-</tt>&nbsp;<tt>text</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >delete key from left operand</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>'a=&gt;1, b=&gt;2, c=&gt;3'::hstore - 'b'::text</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>"a"=&gt;"1", "c"=&gt;"3"</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>hstore</tt>&nbsp;<tt>-</tt>&nbsp;<tt>text[]</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >delete keys from left operand</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>'a=&gt;1, b=&gt;2, c=&gt;3'::hstore - ARRAY['a','b']</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>"c"=&gt;"3"</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>hstore</tt>&nbsp;<tt>-</tt>&nbsp;<tt>hstore</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >delete matching pairs from left operand</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>'a=&gt;1, b=&gt;2, c=&gt;3'::hstore - 'a=&gt;4, b=&gt;2'::hstore</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>"a"=&gt;"1", "c"=&gt;"3"</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>record</tt>&nbsp;<tt>#=</tt>&nbsp;<tt>hstore</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >replace fields in&nbsp;<tt>record</tt>&nbsp;with matching values from&nbsp;<tt>hstore</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >see Examples section</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>%%</tt>&nbsp;<tt>hstore</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >convert&nbsp;<tt>hstore</tt>&nbsp;to array of alternating keys and values</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>%% 'a=&gt;foo, b=&gt;bar'::hstore</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>{a,foo,b,bar}</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>%#</tt>&nbsp;<tt>hstore</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >convert&nbsp;<tt>hstore</tt>&nbsp;to two-dimensional key/value array</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>%# 'a=&gt;foo, b=&gt;bar'::hstore</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>{{a,foo},{b,bar}}</tt></td></tr></table></div><div><br></div><div>测试 :&nbsp;</div><div>打补丁 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cd /opt/soft_bak/postgresql-1b1d3d9</font></div><div><font size="2"   >[root@db-172-16-3-39 postgresql-1b1d3d9]# wget http://www.postgresql.org/message-id/attachment/30006/hstore_gin_speedup.patch</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-39 postgresql-1b1d3d9]# patch -p1 &lt; hstore_gin_speedup.patch&nbsp;</font></div><div><font size="2"   >patching file contrib/hstore/hstore_gin.c</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-39 postgresql-1b1d3d9]# cd contrib/</font></div><div><font size="2"   >[root@db-172-16-3-39 contrib]# cd hstore/</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-39 hstore]# gmake</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fpic -I. -I. -I../../src/include -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o hstore_gin.o hstore_gin.c</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fpic -shared -o hstore.so hstore_io.o hstore_op.o hstore_gist.o hstore_gin.o hstore_compat.o crc32.o -L../../src/port -L../../src/common &nbsp;-Wl,-rpath,'/home/pg94/pgsql9.4devel/lib',--enable-new-dtags &nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-39 hstore]# gmake install</font></div><div><font size="2"   >/bin/mkdir -p '/home/pg94/pgsql9.4devel/lib'</font></div><div><font size="2"   >/bin/mkdir -p '/home/pg94/pgsql9.4devel/share/extension'</font></div><div><font size="2"   >/bin/mkdir -p '/home/pg94/pgsql9.4devel/share/extension'</font></div><div><font size="2"   >/usr/bin/install -c -m 755 &nbsp;hstore.so '/home/pg94/pgsql9.4devel/lib/hstore.so'</font></div><div><font size="2"   >/usr/bin/install -c -m 644 hstore.control '/home/pg94/pgsql9.4devel/share/extension/'</font></div><div><font size="2"   >/usr/bin/install -c -m 644 hstore--1.1.sql hstore--1.0--1.1.sql hstore--unpackaged--1.0.sql '/home/pg94/pgsql9.4devel/share/extension/'</font></div><p></p></pre></div><div><br></div><div>创建测试表和生成随机hstore的函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 hstore]# su - pg94</font></div><div><font size="2"   >pg94@db-172-16-3-39-&gt; psql</font></div><div><font size="2"   >psql (9.4devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# create extension hstore;</font></div><div><font size="2"   >CREATE EXTENSION</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span style="line-height: 19px;"   >digoal=# CREATE OR REPLACE FUNCTION public.gen_hstore(i integer)<br> RETURNS hstore<br> LANGUAGE plpgsql<br> STRICT<br>AS $function$<br>declare <br>  v_res hstore;<br>begin          <br>  v_res := hstore('0', md5(random()::text));<br>  for x in 1..i loop                               <br>    v_res := hs_concat(v_res, hstore(x::text, md5(random()::text)));<br>  end loop;                                                                     <br>  return v_res;<br>end;           <br>$function$;<br>CREATE FUNCTION</span></font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span style="line-height: 19px;"   >digoal=# select * from gen_hstore(0);<br>               gen_hstore                <br>-----------------------------------------<br> "0"=&gt;"f016e0d9c1973abb9e06ddf40f262e44"<br>(1 row)<br><br>digoal=# select * from gen_hstore(1);<br>                                    gen_hstore                                    <br>----------------------------------------------------------------------------------<br> "0"=&gt;"bbbbd53b879e2c2e112f8f3bed0c6872", "1"=&gt;"243d995d7f8df165b7d8165f63406f8b"<br>(1 row)<br><br>digoal=# select * from gen_hstore(2);<br>                                                        gen_hstore                                                         <br>---------------------------------------------------------------------------------------------------------------------------<br> "0"=&gt;"19065cc2fe0d19a7f22ba749d13c53fc", "1"=&gt;"4a0ecc985fd9bbf17954917472fb5291", "2"=&gt;"cf7a2de20496f88f0a8d2895c4c2c654"<br>(1 row)</span></font></div><p></p></pre></div><div>创建测试表 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table t_hstore(id serial primary key, info hstore, crt_time timestamp default clock_timestamp());</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div>使用pgbench生成40万条测试数据</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-39-&gt; cat test.sql</font></div><div><font size="2"   >\setrandom i 0 20</font></div><div><font size="2"   >insert into t_hstore(info) values (gen_hstore(:i));</font></div><p></p></pre></div><div>生成速度还可以 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >pg94@db-172-16-3-39-&gt; pgbench -M prepared -n -r -f ./test.sql -P 1 -c 8 -j 4 -t 50000<br>progress: 1.0 s, 36165.0 tps, 0.221 ms lat<br>progress: 2.0 s, 37799.6 tps, 0.212 ms lat<br>progress: 3.0 s, 38091.6 tps, 0.210 ms lat<br>progress: 4.0 s, 37625.7 tps, 0.213 ms lat<br>progress: 5.0 s, 34643.5 tps, 0.231 ms lat<br>progress: 6.0 s, 34891.4 tps, 0.229 ms lat<br>progress: 7.0 s, 38052.7 tps, 0.210 ms lat<br>progress: 8.0 s, 37459.1 tps, 0.214 ms lat<br>progress: 9.0 s, 37486.9 tps, 0.213 ms lat<br>progress: 10.0 s, 36291.7 tps, 0.220 ms lat<br>progress: 11.0 s, 29639.3 tps, 0.270 ms lat<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 8<br>number of threads: 4<br>number of transactions per client: 50000<br>number of transactions actually processed: 400000/400000<br>tps = 35572.152732 (including connections establishing)<br>tps = 35597.906781 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        0.002022        \setrandom i 0 20<br>        0.210059        insert into t_hstore(info) values (gen_hstore(:i));</span></font></div><p></p></pre></div><div>40万条记录, 耗费196MB空间.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >digoal=# \dt+ t_hstore<br>                      List of relations<br> Schema |   Name   | Type  |  Owner   |  Size  | Description <br>--------+----------+-------+----------+--------+-------------<br> public | t_hstore | table | postgres | 196 MB | <br>(1 row)</span></font></div><p></p></pre></div><div>在hstore列创建gin索引.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create index idx_t_hstore_info on t_hstore using gin(info);</font></div><div><font size="2"   >CREATE INDEX</font></div><div><font size="2"   >Time: 48123.826 ms</font></div><p></p></pre></div><div>创建索引耗时48秒.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \di+ idx_t_hstore_info&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp; Name &nbsp; &nbsp; &nbsp; &nbsp;| Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp;Table &nbsp; | &nbsp;Size &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+-------------------+-------+----------+----------+--------+-------------</font></div><div><font size="2"   >&nbsp;public | idx_t_hstore_info | index | postgres | t_hstore | 335 MB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>索引大小335MB.</div><div><br></div><div>kv contains 场景gin索引查询效率测试</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain analyze select * from t_hstore where info @&gt; (select info from t_hstore where id=5200001);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;Bitmap Heap Scan on t_hstore &nbsp;(cost=11.54..413.54 rows=400 width=473) (actual time=0.164..0.165 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Recheck Cond: (info @&gt; $0)</font></div><div><font size="2"   >&nbsp; &nbsp;InitPlan 1 (returns $0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using t_hstore_pkey on t_hstore t_hstore_1 &nbsp;(cost=0.42..2.44 rows=1 width=461) (actual time=0.011..0.012 rows=1&nbsp;</font></div><div><font size="2"   >loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (id = 5200001)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on idx_t_hstore_info &nbsp;(cost=0.00..9.00 rows=400 width=0) (actual time=0.153..0.153 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (info @&gt; $0)</font></div><div><font size="2"   >&nbsp;Total runtime: 0.206 ms</font></div><div><font size="2"   >(8 rows)</font></div><div><font size="2"   >Time: 0.643 ms</font></div><p></p></pre></div><div><br></div><div>k contains 场景<span style="line-height: 22px;"   >gin索引查询效率测试</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select array_agg(key) from (select (each(info)).key from t_hstore where id=5200001) t;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;array_agg &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----------------------------------------------</font></div><div><font size="2"   >&nbsp;{0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17}</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 0.778 ms</font></div></div><div><div><font size="2"   >digoal=# explain analyze select * from t_hstore where info ? '1';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Bitmap Heap Scan on t_hstore &nbsp;(cost=9.10..411.10 rows=400 width=473) (actual time=89.038..250.400 rows=380822 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Recheck Cond: (info ? '1'::text)</font></div><div><font size="2"   >&nbsp; &nbsp;Rows Removed by Index Recheck: 10100</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on idx_t_hstore_info &nbsp;(cost=0.00..9.00 rows=400 width=0) (actual time=86.100..86.100 rows=380822 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (info ? '1'::text)</font></div><div><font size="2"   >&nbsp;Total runtime: 283.150 ms</font></div><div><font size="2"   >(6 rows)</font></div><div><font size="2"   >Time: 283.861 ms</font></div></div><div><div><font size="2"   >digoal=# explain analyze select * from t_hstore where info ?| _text '{0,1,2,3,4,5,6,7,8,9,10,11}';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >--</font></div><div><font size="2"   >&nbsp;Bitmap Heap Scan on t_hstore &nbsp;(cost=64.10..466.10 rows=400 width=473) (actual time=262.783..613.775 rows=400000 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Recheck Cond: (info ?| '{0,1,2,3,4,5,6,7,8,9,10,11}'::text[])</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on idx_t_hstore_info &nbsp;(cost=0.00..64.00 rows=400 width=0) (actual time=259.514..259.514 rows=400000 loops=1</font></div><div><font size="2"   >)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (info ?| '{0,1,2,3,4,5,6,7,8,9,10,11}'::text[])</font></div><div><font size="2"   >&nbsp;Total runtime: 648.329 ms</font></div><div><font size="2"   >(5 rows)</font></div><div><font size="2"   >Time: 648.992 ms</font></div></div><p></p></pre></div><div><br></div><div>下面是hstore补丁前的测试, 用于对比这个补丁是否有性能提升.</div><div>生成数据部分同上, 略.</div><div><div><pre class="prettyprint"   ><p style="line-height: 22px;"   ></p><div><font size="2"   ><span style="line-height: 19px;"   >digoal=# \dt+ t_hstore <br>                      List of relations<br> Schema |   Name   | Type  |  Owner   |  Size  | Description <br>--------+----------+-------+----------+--------+-------------<br> public | t_hstore | table | postgres | 196 MB | <br>(1 row)</span></font></div><p style="line-height: 22px;"   ></p></pre></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >在hstore列创建gin索引.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create index idx_t_hstore_info on t_hstore using gin(info);</font></div><div><font size="2"   >CREATE INDEX</font></div><div><font size="2"   ><span style="line-height: 19px;"   >Time: 51732.079 ms</span></font></div><p></p></pre></div><div><div style="line-height: 22px;"   >创建索引耗时<span style="line-height: 22px;"   >51秒.</span></div><div style="line-height: 22px;"   >索引大小<span style="line-height: 22px;"   >335MB.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >digoal=# \di+ idx_t_hstore_info<br>                                List of relations<br> Schema |       Name        | Type  |  Owner   |  Table   |  Size  | Description <br>--------+-------------------+-------+----------+----------+--------+-------------<br> public | idx_t_hstore_info | index | postgres | t_hstore | 335 MB | <br>(1 row)</span></font></div><p></p></pre></div><div style="line-height: 22px;"   >kv contains 场景gin索引查询效率测试</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >digoal=# explain (buffers,analyze) select * from t_hstore where info @&gt; (select info from t_hstore where id=4000001);<br>                                                                 QUERY PLAN                                                         <br>         <br>------------------------------------------------------------------------------------------------------------------------------------<br>---------<br> Bitmap Heap Scan on t_hstore  (cost=11.54..413.54 rows=400 width=473) (actual time=168.336..168.337 rows=1 loops=1)<br>   Recheck Cond: (info @&gt; $0)<br>   Buffers: shared hit=2730<br>   InitPlan 1 (returns $0)<br>     -&gt;  Index Scan using t_hstore_pkey on t_hstore t_hstore_1  (cost=0.42..2.44 rows=1 width=461) (actual time=0.015..0.016 rows=1 <br>loops=1)<br>           Index Cond: (id = 4000001)<br>           Buffers: shared hit=4<br>   -&gt;  Bitmap Index Scan on idx_t_hstore_info  (cost=0.00..9.00 rows=400 width=0) (actual time=168.311..168.311 rows=1 loops=1)<br>         Index Cond: (info @&gt; $0)<br>         Buffers: shared hit=2729<br> Total runtime: 168.381 ms<br>(11 rows)</span></font></div><p></p></pre></div><div><span style="line-height: 22px;"   >k contains 场景</span><span style="line-height: 22px;"   >gin索引查询效率测试</span></div></div></div><div><pre class="prettyprint"   ><p style="line-height: 22px;"   ></p><div><font size="2"   ><span style="line-height: 19px;"   >digoal=# select array_agg(key) from (select (each(info)).key from t_hstore where id=4000001) t;<br>          array_agg          <br>-----------------------------<br> {0,1,2,3,4,5,6,7,8,9,10,11}<br>(1 row)<br>Time: 0.278 ms</span></font></div><div><div><font size="2"   ><span style="line-height: 19px;"   >digoal=# explain analyze select * from t_hstore where info ? '1';<br>                                                            QUERY PLAN                                                             <br>-----------------------------------------------------------------------------------------------------------------------------------<br> Bitmap Heap Scan on t_hstore  (cost=9.10..411.10 rows=400 width=473) (actual time=60.182..246.450 rows=380810 loops=1)<br>   Recheck Cond: (info ? '1'::text)<br>   Rows Removed by Index Recheck: 10066<br>   -&gt;  Bitmap Index Scan on idx_t_hstore_info  (cost=0.00..9.00 rows=400 width=0) (actual time=58.273..58.273 rows=380810 loops=1)<br>         Index Cond: (info ? '1'::text)<br> Total runtime: 274.195 ms<br>(6 rows)<br>Time: 274.683 ms</span></font></div><div style="line-height: 22px;"   ><font size="2"   ><br></font></div><div><font size="2"   ><span style="line-height: 19px;"   >digoal=# explain analyze select * from t_hstore where info ?| _text '{0,1,2,3,4,5,6,7,8,9,10,11}';<br>                                                              QUERY PLAN                                                            <br>  <br>------------------------------------------------------------------------------------------------------------------------------------<br>--<br> Bitmap Heap Scan on t_hstore  (cost=64.10..466.10 rows=400 width=473) (actual time=178.108..548.362 rows=400000 loops=1)<br>   Recheck Cond: (info ?| '{0,1,2,3,4,5,6,7,8,9,10,11}'::text[])<br>   -&gt;  Bitmap Index Scan on idx_t_hstore_info  (cost=0.00..64.00 rows=400 width=0) (actual time=176.103..176.103 rows=400000 loops=1<br>)<br>         Index Cond: (info ?| '{0,1,2,3,4,5,6,7,8,9,10,11}'::text[])<br> Total runtime: 578.002 ms<br>(5 rows)<br><br>Time: 578.539 ms</span></font></div></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><br></div><div>[小结]</div><div>1. 索引大小比较</div><div>这个和key的离散程度以及key的长度有关, 本例key取值0-20的整型范围, 所以key相对来说比较小, 离散度也不高.</div><div>因此补丁前后索引的大小是差不多的.</div><div>2. 索引创建时间比较</div><div>创建时间没有明显差别.</div><div>3. 查询效率比较</div><div>k-v contains 查询效率提升非常明显, 精确匹配1行,&nbsp;<span style="line-height: 22px;"   >在内存命中的情况下.&nbsp;</span><span style="line-height: 22px;"   >从168毫秒提升到0.2毫秒.&nbsp;</span></div><div>k contains 查询效率可以认为差别不明显, 因为本例打补丁前使用的机器CPU频率略高2.83GHZ. 打补丁后的机器为2.0GHZ.</div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/hstore.html"   >http://www.postgresql.org/docs/devel/static/hstore.html</a></div><div>2.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/message-id/flat/CAPxT4eEe-MNs4FbVN1Le_nWsTgyw3N38tENbN5W7GPBrWB7cJA@mail.gmail.com#CAPxT4eEe-MNs4FbVN1Le_nWsTgyw3N38tENbN5W7GPBrWB7cJA@mail.gmail.com"   >http://www.postgresql.org/message-id/flat/CAPxT4eEe-MNs4FbVN1Le_nWsTgyw3N38tENbN5W7GPBrWB7cJA@mail.gmail.com#CAPxT4eEe-MNs4FbVN1Le_nWsTgyw3N38tENbN5W7GPBrWB7cJA@mail.gmail.com</a></div><div>3.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="https://www.pgcon.org/2013/schedule/events/518.en.html"   >https://www.pgcon.org/2013/schedule/events/518.en.html</a></div><div>4.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://obartunov.livejournal.com/171959.html"   >http://obartunov.livejournal.com/171959.html</a></div><div><br></div></div><wbr></div>
	</div>
</div>
</body>
</html>