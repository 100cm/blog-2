<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL reduce big table's whole scan caused by vacuum , performance tuning</h2>
	<h5 id="">2013-09-24 11:27:42&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201382495753521/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>熟悉PostgreSQL的童鞋对xid定不陌生, 为了避免出现tuples disappear的现象, 数据库需要有计划的自动vacuum将normal xid变更成frozenxid.</div><div>(模拟disappear场景可参考如下:)</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201183043153622/"   >http://blog.163.com/digoal@126/blog/static/163877040201183043153622/</a></div><div>由于这个变更xid的操作, 会给数据库带来写IO和读IO操作, 所以对数据库有一定的影响.</div><div>如果发生的是全表性质的扫描vacuum, 并且刚好发生在数据库繁忙期间, 那简直就是雪上加霜的事情.</div><div>控制是否将normal xid替换成frozenxid的几个参数如下 :&nbsp;</div><div>全局参数 :&nbsp;</div><div>autovacuum_freeze_max_age, 会降低对象的relfrozenxid, 所以需要whole table scan, 替换所有符合条件的normal xid为frozen xid.</div><div>注意即使未开启autovacuum, 这个参数也会生效.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Specifies the maximum age (in transactions) that a table's pg_class.relfrozenxid field can attain before a VACUUM operation is forced to prevent transaction ID wraparound within the table. Note that the system will launch autovacuum processes to prevent wraparound even when autovacuum is otherwise disabled.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Vacuum also allows removal of old files from the pg_clog subdirectory, which is why the default is a relatively low 200 million transactions. This parameter can only be set at server start, but the setting can be reduced for individual tables by changing storage parameters. For more information see Section 23.1.5.</font></div><p></p></pre></div><div>vacuum_freeze_min_age, 仅仅替换被扫描块的符合条件的normal xid 为 frozen xid. 不一定是whole table scan.&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >Specifies the cutoff age (in transactions) that VACUUM should use to decide whether to replace transaction IDs with FrozenXID while scanning a table. The default is 50 million transactions. Although users can set this value anywhere from zero to one billion, VACUUM will silently limit the effective value to half the value of autovacuum_freeze_max_age, so that there is not an unreasonably short time between forced autovacuums. For more information see Section 23.1.5.</font></p></pre></div><div>vacuum_freeze_table_age,&nbsp;<span style="line-height: 23px;"   >当对象的age达到vacuum_freeze_table_age时, 执行vacuum的时候会触发whole table scan.&nbsp;</span></div><div><pre class="prettyprint"   ><p><font size="2"   >VACUUM performs a whole-table scan if the table's pg_class.relfrozenxid field has reached the age specified by this setting. The default is 150 million transactions. Although users can set this value anywhere from zero to one billion, VACUUM will silently limit the effective value to 95% of autovacuum_freeze_max_age, so that a periodical manual VACUUM has a chance to run before an anti-wraparound autovacuum is launched for the table. For more information see Section 23.1.5.</font></p></pre></div><div>表级参数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >autovacuum_freeze_min_age, toast.autovacuum_freeze_min_age (integer)</font></div><div><font size="2"   >autovacuum_freeze_max_age, toast.autovacuum_freeze_max_age (integer)</font></div><div><font size="2"   >autovacuum_freeze_table_age, toast.autovacuum_freeze_table_age (integer)</font></div><p></p></pre></div><div>如果创建表时没有指定, 默认将继承全局参数的设置.&nbsp;</div><div><br></div><div><div style="line-height: 23px;"   >什么情况下会发生whole table scan?&nbsp;</div><div style="line-height: 23px;"   >1. 当对象的age达到vacuum_freeze_table_age时, vacuum的时候会触发whole table scan.&nbsp;</div><div style="line-height: 23px;"   >2. 当使用vacuum freeze命令时, 也是whole table scan.&nbsp;</div><div style="line-height: 23px;"   >3. 当对象的所有数据块里面都存在dead tuple, 需要回收垃圾空间时.</div></div><div style="line-height: 23px;"   ><br></div><div style="line-height: 23px;"   >测试1 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table test(id int, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg94@db-172-16-3-39-&gt; vi test.sql</font></div><div><font size="2"   >\setrandom id 1 5000000</font></div><div><font size="2"   >insert into test values (:id, 'test', now());</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg94@db-172-16-3-39-&gt; pgbench -M prepared -n -r -f ./test.sql -P 3 -c 16 -j 4 -T 20</font></div><div><font size="2"   >progress: 3.0 s, 90145.5 tps, 0.177 ms lat</font></div><div><font size="2"   >progress: 6.0 s, 98736.2 tps, 0.162 ms lat</font></div><div><font size="2"   >progress: 9.0 s, 99266.5 tps, 0.161 ms lat</font></div><div><font size="2"   >progress: 12.0 s, 98073.9 tps, 0.163 ms lat</font></div><div><font size="2"   >progress: 15.0 s, 99807.6 tps, 0.160 ms lat</font></div><div><font size="2"   >progress: 18.0 s, 97463.6 tps, 0.164 ms lat</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 20 s</font></div><div><font size="2"   >number of transactions actually processed: 1949618</font></div><div><font size="2"   >tps = 97461.032569 (including connections establishing)</font></div><div><font size="2"   >tps = 97531.461529 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001346 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.161348 &nbsp; &nbsp; &nbsp; &nbsp;insert into test values (:id, 'test', now());</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg94@db-172-16-3-39-&gt; psql</font></div><div><font size="2"   >psql (9.4devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >当前test表的<span style="line-height: 23px;"   >relfrozenxid</span><span style="line-height: 23px;"   >&nbsp;和age.</span></font></div><div><font size="2"   >digoal=# select relname,relfrozenxid,age(relfrozenxid) from pg_class where relname='test';</font></div><div><font size="2"   >&nbsp;relname | relfrozenxid | &nbsp; age &nbsp;&nbsp;</font></div><div><font size="2"   >---------+--------------+---------</font></div><div><font size="2"   >&nbsp;test &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;9613651 | 1949619</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >使用vacuum freeze会发生whole table scan, 变更normal xid为frozen xid(实际上是把行的xmin变更为2), 同时降低age</font></div><div><font size="2"   >digoal=# vacuum (verbose,freeze) test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": found 0 removable, 1949618 nonremovable row versions in 12426 out of 12426 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.03s/0.25u sec elapsed 0.28 sec.</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "pg_toast.pg_toast_24619"</font></div><div><font size="2"   >INFO: &nbsp;index "pg_toast_24619_index" now contains 0 row versions in 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 index row versions were removed.</font></div><div><font size="2"   >0 index pages have been deleted, 0 are currently reusable.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;"pg_toast_24619": found 0 removable, 0 nonremovable row versions in 0 out of 0 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><div><font size="2"   >digoal=# select relname,relfrozenxid,age(relfrozenxid) from pg_class where relname='test';</font></div><div><font size="2"   >&nbsp;relname | relfrozenxid | age&nbsp;</font></div><div><font size="2"   >---------+--------------+-----</font></div><div><font size="2"   >&nbsp;test &nbsp; &nbsp;| &nbsp; &nbsp; 11563271 | &nbsp; 0</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>测试2 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# truncate table test;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >pg94@db-172-16-3-39-&gt; pgbench -M prepared -n -r -f ./test.sql -P 3 -c 16 -j 4 -T 20</font></div><div><font size="2"   >progress: 3.0 s, 91312.6 tps, 0.175 ms lat</font></div><div><font size="2"   >progress: 6.0 s, 98566.6 tps, 0.162 ms lat</font></div><div><font size="2"   >progress: 9.0 s, 98924.4 tps, 0.162 ms lat</font></div><div><font size="2"   >progress: 12.0 s, 98866.5 tps, 0.162 ms lat</font></div><div><font size="2"   >progress: 15.0 s, 97615.4 tps, 0.164 ms lat</font></div><div><font size="2"   >progress: 18.0 s, 95816.6 tps, 0.167 ms lat</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 20 s</font></div><div><font size="2"   >number of transactions actually processed: 1936647</font></div><div><font size="2"   >tps = 96806.188128 (including connections establishing)</font></div><div><font size="2"   >tps = 96869.910097 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001440 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.162382 &nbsp; &nbsp; &nbsp; &nbsp;insert into test values (:id, 'test', now());</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# select relname,relfrozenxid,age(relfrozenxid) from pg_class where relname='test';</font></div><div><font size="2"   >&nbsp;relname | relfrozenxid | &nbsp; age &nbsp;&nbsp;</font></div><div><font size="2"   >---------+--------------+---------</font></div><div><font size="2"   >&nbsp;test &nbsp; &nbsp;| &nbsp; &nbsp; 13508670 | 1936649</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >此时只需vacuum, 我们看到没有扫描全表.</font></div><div><div><font size="2"   >digoal=# vacuum verbose test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": found 0 removable, 0 nonremovable row versions in 0 out of 12343 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "pg_toast.pg_toast_24619"</font></div><div><font size="2"   >INFO: &nbsp;index "pg_toast_24619_index" now contains 0 row versions in 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 index row versions were removed.</font></div><div><font size="2"   >0 index pages have been deleted, 0 are currently reusable.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;"pg_toast_24619": found 0 removable, 0 nonremovable row versions in 0 out of 0 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div></div><div><font size="2"   >如果把<span style="line-height: 23px;"   >vacuum_freeze_table_age改为小于当前这个表的年龄</span></font></div><div><div><font size="2"   >digoal=# set vacuum_freeze_table_age=1936648;</font></div><div><font size="2"   >SET</font></div></div><div><font size="2"   >此时再次执行vacuum , 会发生全表扫描.</font></div><div><div><font size="2"   >digoal=# vacuum verbose test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": found 0 removable, 1936647 nonremovable row versions in 12343 out of 12343 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.19u sec elapsed 0.19 sec.</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "pg_toast.pg_toast_24619"</font></div><div><font size="2"   >INFO: &nbsp;index "pg_toast_24619_index" now contains 0 row versions in 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 index row versions were removed.</font></div><div><font size="2"   >0 index pages have been deleted, 0 are currently reusable.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;"pg_toast_24619": found 0 removable, 0 nonremovable row versions in 0 out of 0 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div></div><div><font size="2"   >虽然发生了全表扫描, 但是normal xid未被替换为frozen xid, 原因是<span style="line-height: 23px;"   >vacuum_freeze_min_age大于这些被扫描的xmin的年龄.</span></font></div><div><div><font size="2"   >digoal=# select relname,relfrozenxid,age(relfrozenxid) from pg_class where relname='test';</font></div><div><font size="2"   >&nbsp;relname | relfrozenxid | &nbsp; age &nbsp;&nbsp;</font></div><div><font size="2"   >---------+--------------+---------</font></div><div><font size="2"   >&nbsp;test &nbsp; &nbsp;| &nbsp; &nbsp; 13508670 | 1936659</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >如果把<span style="line-height: 23px;"   >vacuum_freeze_min_age改为0, 那么就会被替换为frozen xid了.</span></font></div><div><div><font size="2"   >digoal=# set vacuum_freeze_min_age=0;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# vacuum verbose test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": found 0 removable, 1936647 nonremovable row versions in 12343 out of 12343 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.01s/0.70u sec elapsed 0.75 sec.</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "pg_toast.pg_toast_24619"</font></div><div><font size="2"   >INFO: &nbsp;index "pg_toast_24619_index" now contains 0 row versions in 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 index row versions were removed.</font></div><div><font size="2"   >0 index pages have been deleted, 0 are currently reusable.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;"pg_toast_24619": found 0 removable, 0 nonremovable row versions in 0 out of 0 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><div><font size="2"   >digoal=# select relname,relfrozenxid,age(relfrozenxid) from pg_class where relname='test';</font></div><div><font size="2"   >&nbsp;relname | relfrozenxid | age&nbsp;</font></div><div><font size="2"   >---------+--------------+-----</font></div><div><font size="2"   >&nbsp;test &nbsp; &nbsp;| &nbsp; &nbsp; 15445329 | &nbsp; 0</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div style="line-height: 23px;"   >对以上概念有所了解后, 我们来假象一个场景.</div><div style="line-height: 23px;"   >假设数据库中有以下表,</div><div style="line-height: 23px;"   >t1_201307</div><div style="line-height: 23px;"   ><span style="line-height: 23px;"   >t2_201307</span></div><div style="line-height: 23px;"   ><span style="line-height: 23px;"   >t3_201307</span></div><div style="line-height: 23px;"   ><span style="line-height: 23px;"   >t4_201307</span></div><div style="line-height: 23px;"   ><span style="line-height: 23px;"   >t5_201307</span></div><div><div style="line-height: 23px;"   >t1_201308</div><div style="line-height: 23px;"   ><span style="line-height: 23px;"   >t2_201308</span></div><div style="line-height: 23px;"   ><span style="line-height: 23px;"   >t3_201308</span></div><div style="line-height: 23px;"   ><span style="line-height: 23px;"   >t4_201308</span></div><div style="line-height: 23px;"   ><span style="line-height: 23px;"   >t5_201308</span></div><div style="line-height: 23px;"   ><span style="line-height: 23px;"   >....</span></div><div style="line-height: 23px;"   ><span style="line-height: 23px;"   >每个月1个表.</span></div><div><span style="line-height: 23px;"   >每个月的表只在当月有dml操作, 过后不会有dml, 最多可能会有select的操作, 所以这些表的</span>relfrozenxid在下个月就不会变了, 而且也不会自动触发vacuum. 因为表没有了dml操作, 那么这些表只有当年龄到达autovacuum_freeze_max_age时, 强制触发autovacuum whole table scan, 将normal xid变更成frozen xid. 而且这些表如果数据量很大的话, 同时又在系统繁忙时触发, 后果可想而知.</div></div><div><br></div><div>如何来避免这种情况的发生呢?</div><div>1. 可以在数据库比较空闲时手工或使用定时执行任务来降低对象的pg_class.<span style="line-height: 23px;"   >relfrozenxid.&nbsp;</span></div><div>如何手工来降低<span style="line-height: 23px;"   >pg_class.</span><span style="line-height: 23px;"   >relfrozenxid. 可以参照前面的两个例子,&nbsp;</span></div><div><span style="line-height: 23px;"   >vacuum freeze;</span></div><div><span style="line-height: 23px;"   >或者</span></div><div>set vacuum_freeze_min_age=0;</div><div>set vacuum_freeze_table_age=0;</div><div>vacuum;</div><div>或者使用命令</div><div>vacuumdb -Fav</div><div><span style="line-height: 23px;"   >这样的话就可以减少非计划性的whole table scan.</span></div><div><span style="line-height: 23px;"   >脚本举例, 请根据自己的情况适当调整 :&nbsp;</span></div><div>处理年龄大于2000万的, 同时大小大于800MB的, 按最老的开始排序的前10个对象.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 20px;"   >#!/bin/bash<br># 环境变量<br>PATH=$PATH:$HOME/bin<br>export PATH<br>export LANG=en_US.utf8<br>export PGHOME=/opt/pgsql<br>export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib<br>export PATH=$PGHOME/bin:$PATH:.<br><br># 配置项<br>TODAY=`date +%Y%m%d`<br>AGE="20000000"<br>PAGES="102400"<br><br>HOST="127.0.0.1"<br>PORT="2999"<br>ROLE="postgres"<br>QUERY1="select t2.nspname||'.'||t1.relname from pg_class t1 join pg_namespace t2 on (t1.relnamespace=t2.oid and t1.relkind='r' and age(t1.relfrozenxid)&gt;$AGE and t1.relpages&gt;$PAGES) order by age(relfrozenxid) desc limit 10;"<br><br>for DB in `psql -A -q -t -h $HOST -p $PORT -U $ROLE postgres -c "select datname from pg_database where datname not in ('postgres','template0','template1')"`<br>do<br>  for RELNAME in `psql -A -q -t -h $HOST -p $PORT -U $ROLE $DB -c "$QUERY1"`<br>  do<br>    psql -h $HOST -p $PORT -U $ROLE $DB -c "vacuum (verbose,freeze) $RELNAME;"<br>  done<br>done</span></font></div><p></p></pre></div><div style="line-height: 23px;"   >既然是自定义脚本, 所以还要考虑自动触发的情况, 如果使用了自定义脚本, 那么尽量把自动触发的点往后调, 也就是调大以下的默认值:</div></div><div>autovacuum_freeze_max_age = 200000000</div><div>vacuum_freeze_min_age = 50000000</div><div>vacuum_freeze_table_age = 150000000</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/runtime-config-autovacuum.html#GUC-AUTOVACUUM-FREEZE-MAX-AGE"   >http://www.postgresql.org/docs/9.3/static/runtime-config-autovacuum.html#GUC-AUTOVACUUM-FREEZE-MAX-AGE</a></div><div>2.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/sql-createtable.html"   >http://www.postgresql.org/docs/9.3/static/sql-createtable.html</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >autovacuum_freeze_min_age, toast.autovacuum_freeze_min_age (integer)</font></div><div><font size="2"   >Custom vacuum_freeze_min_age parameter. Note that autovacuum will ignore attempts to set a per-table autovacuum_freeze_min_age larger than the half system-wide autovacuum_freeze_max_age setting.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >autovacuum_freeze_max_age, toast.autovacuum_freeze_max_age (integer)</font></div><div><font size="2"   >Custom autovacuum_freeze_max_age parameter. Note that autovacuum will ignore attempts to set a per-table autovacuum_freeze_max_age larger than the system-wide setting (it can only be set smaller). Note that while you can set autovacuum_freeze_max_age very small, or even zero, this is usually unwise since it will force frequent vacuuming.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >autovacuum_freeze_table_age, toast.autovacuum_freeze_table_age (integer)</font></div><div><font size="2"   >Custom vacuum_freeze_table_age parameter.</font></div><p></p></pre></div><div>3.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/runtime-config-client.html#GUC-VACUUM-FREEZE-MIN-AGE"   >http://www.postgresql.org/docs/9.3/static/runtime-config-client.html#GUC-VACUUM-FREEZE-MIN-AGE</a></div><div>4.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/sql-vacuum.html"   >http://www.postgresql.org/docs/9.3/static/sql-vacuum.html</a></div><div>5.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/routine-vacuuming.html#VACUUM-FOR-WRAPAROUND"   >http://www.postgresql.org/docs/9.3/static/routine-vacuuming.html#VACUUM-FOR-WRAPAROUND</a></div><pre class="prettyprint"   ><div><font size="2"   >The whole table is scanned when relfrozenxid is more than vacuum_freeze_table_age transactions old, when VACUUM's FREEZE option is used, or when all pages happen to require vacuuming to remove dead row versions.&nbsp;</font></div><div></div><p></p></pre><div><span style="line-height: 23px;"   >6.&nbsp;</span><a style="line-height: 23px;" href="http://blog.163.com/digoal@126/blog/static/163877040201183043153622/"   >http://blog.163.com/digoal@126/blog/static/163877040201183043153622/</a></div><div>7.&nbsp;<a style="line-height: 23px;" href="http://blog.163.com/digoal@126/blog/static/163877040201251911813661/"   >http://blog.163.com/digoal@126/blog/static/163877040201251911813661/</a></div></div>
	</div>
</div>
</body>
</html>