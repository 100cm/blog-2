<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap statistics type example</h2>
	<h5 id="">2013-09-03 12:37:23&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020138310438924/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>systemtap统计数据类型, 同array一样, 必须定义为global变量. ( 换句话说, 统计元素可以存储在全局变量(scalar)或者 全局array中. )</div><div><pre class="prettyprint"   ><p><font size="2"   >Aggregate instances are used to collect statistics on numerical values, when it is important to accumulate new data quickly and in large volume. These instances operate without exclusive locks, and store only aggregated stream statistics. Aggregates make sense only for global variables. They are stored individually or as elements of an associative array.</font></p></pre></div><div>相比array的好处是, 操作时不需要exclusive lock. 在执行统计时处理所有数据.</div><div><pre class="prettyprint"   ><p><font size="2"   >For each instance of a distinct extraction function operating on a given identifier, the translator computes a set of statistics. With each execution of an extraction function, the aggregation is computed for that moment across all processors. The first argument of each function is the same style of l-value as used on the left side of the aggregation operation.</font></p></pre></div><div>统计类型可以想象成存储一串整型, 目前统计类型支持count, max, min, avg, sum这种统计操作. 同时还支持柱状图输出, hist_linear(自定义low, high和width), hist_log(2^n次方) .&nbsp;</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# vi test.stp&nbsp;</font></div><div><div><font size="2"   >global var</font></div><div><font size="2"   >probe begin {</font></div><div><font size="2"   >&nbsp; var &lt;&lt;&lt; 12</font></div><div><font size="2"   >&nbsp; var &lt;&lt;&lt; 12</font></div><div><font size="2"   >&nbsp; var &lt;&lt;&lt; 33</font></div><div><font size="2"   >&nbsp; var &lt;&lt;&lt; 44</font></div><div><font size="2"   >&nbsp; var &lt;&lt;&lt; 55</font></div><div><font size="2"   >&nbsp; var &lt;&lt;&lt; 16</font></div><div><font size="2"   >&nbsp; printf("count, min, max, avg, sum\n")</font></div><div><font size="2"   >&nbsp; printf("%d, %d, %d, %d, %d\n", @count(var), @min(var), @max(var), @avg(var), @sum(var))</font></div><div><font size="2"   >&nbsp; //print(@hist_linear(var,0,100,10))</font></div><div><font size="2"   >&nbsp; print(@hist_log(var))</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div>输出</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap test.stp&nbsp;</font></div><div><font size="2"   >count, min, max, avg, sum</font></div><div><font size="2"   ><span style="line-height: 19px;"   >6, 12, 55, 28, 172<br>value |-------------------------------------------------- count<br>    2 |                                                   0  -- &gt;=2 &amp;&amp; &lt;4 的元素有多少个.    <br>    4 |                                                   0  -- &gt;=4 &amp;&amp; &lt;8 的元素有多少个.    <br>    8 |@@                                                 2  -- &gt;=8 &amp;&amp; &lt;16 的元素有多少个.   <br>   16 |@                                                  1  -- &gt;=16 &amp;&amp; &lt;32 的元素有多少个.  <br>   32 |@@@                                                3  -- &gt;=32 &amp;&amp; &lt;64 的元素有多少个.  <br>   64 |                                                   0  -- &gt;=64 &amp;&amp; &lt;128 的元素有多少个. <br>  128 |                                                   0  -- &gt;=128的元素有多少个.</span></font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >稍微解释一下</span></div><div>count : 存储的元素个数.</div><div>min : 所有元素中的最小值.</div><div><span style="line-height: 22px;"   >max : 所有元素中的最大值.</span></div><div>avg : 平均值</div><div>sum : 总和</div><div><span style="line-height: 22px;"   >hist_log : 以2^n次方为动态width. 输出每个bucket中元素的个数. @表示有元素, ~表示没有元素(中间省略的bucket),&nbsp;</span></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >自定义width, 使用hist_linear :&nbsp;</span></div><div><span style="line-height: 22px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cat test.stp&nbsp;</font></div><div><font size="2"   >global var</font></div><div><font size="2"   >probe begin {</font></div><div><font size="2"   >&nbsp; var &lt;&lt;&lt; 12</font></div><div><font size="2"   >&nbsp; var &lt;&lt;&lt; 12</font></div><div><font size="2"   >&nbsp; var &lt;&lt;&lt; 33</font></div><div><font size="2"   >&nbsp; var &lt;&lt;&lt; 44</font></div><div><font size="2"   >&nbsp; var &lt;&lt;&lt; 55</font></div><div><font size="2"   >&nbsp; var &lt;&lt;&lt; 16</font></div><div><font size="2"   >&nbsp; printf("count, min, max, avg, sum\n")</font></div><div><font size="2"   >&nbsp; printf("%d, %d, %d, %d, %d\n", @count(var), @min(var), @max(var), @avg(var), @sum(var))</font></div><div><font size="2"   >&nbsp; print(@hist_linear(var,0,1000,10))</font></div><div><font size="2"   >&nbsp; //print(@hist_log(var))</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div><div>输出 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap test.stp&nbsp;</font></div><div><font size="2"   >count, min, max, avg, sum</font></div><div><font size="2"   >6, 12, 55, 28, 172</font></div><div><font size="2"   >value |-------------------------------------------------- count</font></div><div><font size="2"   >&nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp;10 |@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3</font></div><div><font size="2"   >&nbsp; &nbsp;20 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp;30 |@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >&nbsp; &nbsp;40 |@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >&nbsp; &nbsp;50 |@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >&nbsp; &nbsp;60 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp;70 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><p></p></pre></div></div></span></div><div><span style="line-height: 22px;"   >解释 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >print(@hist_linear(var,0,1000,10))</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >lower=0</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >high=1000</font></span></div><div><font size="2"   >width=10</font></div><p></p></pre></div><div>那么一共有101个bucket.&nbsp;</div><div><br></div><div><span style="line-height: 22px;"   >[参考]</span></div><wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="https://sourceware.org/systemtap/langref/Statistics_aggregates.html"   >https://sourceware.org/systemtap/langref/Statistics_aggregates.html</a></div><div>2.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="https://sourceware.org/systemtap/tutorial/Analysis.html"   >https://sourceware.org/systemtap/tutorial/Analysis.html</a></div></div>
	</div>
</div>
</body>
</html>