<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 pending patch : INSERT...ON DUPLICATE KEY IGNORE</h2>
	<h5 id="">2013-09-06 9:11:12&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020138345125949/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>经常有使用MySQL的开发人员问我PostgreSQL里面有没有replace对应的用法.</div><div><a rel="nofollow" href="http://dev.mysql.com/doc/refman/5.7/en/replace.html"   >http://dev.mysql.com/doc/refman/5.7/en/replace.html</a></div><div>这个在PostgreSQL中目前可以使用函数语言来代替, 使用函数或者online code, 例如</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; &nbsp; update xxx set xxx where xxx;</font></div><div><font size="2"   >&nbsp; &nbsp; if not found then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; insert into xxx(xxx) values (xxx);</font></div><div><font size="2"   >&nbsp; &nbsp; end if;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><p></p></pre></div><div>还有一种MySQL中用得较多的是insert ignore语法. 即插入错误不报错, 忽略该行的插入.</div><div>MySQL中的用法详见.</div><div><a rel="nofollow" href="http://dev.mysql.com/doc/refman/5.7/en/insert.html"   >http://dev.mysql.com/doc/refman/5.7/en/insert.html</a></div><div>在说本文提出的补丁前, 我们先看看PostgreSQL可以通过哪几种手段来实现.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table i_test(id int primary key, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div><br></div><div>1. 函数</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 28px;"   ><font size="2"   >digoal=# create or replace function f_i_test(i_id int, i_info text) returns void as $$</font></div><div style="line-height: 28px;"   ><font size="2"   >declare</font></div><div style="line-height: 28px;"   ><font size="2"   >begin</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; insert into i_test (id,info) values (i_id,i_info);</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; exception</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; when SQLSTATE '23505' then</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; return;</font></div><div style="line-height: 28px;"   ><font size="2"   >end;</font></div><div style="line-height: 28px;"   ><font size="2"   >$$ language plpgsql strict;</font></div><div style="line-height: 28px;"   ><font size="2"   >CREATE FUNCTION</font></div></div><div><div><font size="2"   >digoal=# select f_i_test(1,'test');</font></div><div><font size="2"   >&nbsp;f_i_test&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select ctid,* from i_test;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| id | info&nbsp;</font></div><div><font size="2"   >-------+----+------</font></div><div><font size="2"   >&nbsp;(0,1) | &nbsp;1 | test</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select f_i_test(1,'test');</font></div><div><font size="2"   >&nbsp;f_i_test&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select ctid,* from i_test;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| id | info&nbsp;</font></div><div><font size="2"   >-------+----+------</font></div><div><font size="2"   >&nbsp;(0,1) | &nbsp;1 | test</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select f_i_test(2,'test');</font></div><div><font size="2"   >&nbsp;f_i_test&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select ctid,* from i_test;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| id | info&nbsp;</font></div><div><font size="2"   >-------+----+------</font></div><div><font size="2"   >&nbsp;(0,1) | &nbsp;1 | test</font></div><div><font size="2"   >&nbsp;(0,3) | &nbsp;2 | test</font></div><div><font size="2"   >(2 rows)</font></div></div><p></p></pre></div></div><div><br></div><div>2. do</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# do language plpgsql $$ &nbsp;&nbsp;</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; insert into i_test(id,info) values (1,'test');</font></div><div><font size="2"   >&nbsp; exception when SQLSTATE '23505' then</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >DO</font></div><div><font size="2"   >digoal=# do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; insert into i_test(id,info) values (3,'test');</font></div><div><font size="2"   >&nbsp; exception when SQLSTATE '23505' then</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >DO</font></div><div><font size="2"   >digoal=# select ctid,* from i_test;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| id | info&nbsp;</font></div><div><font size="2"   >-------+----+------</font></div><div><font size="2"   >&nbsp;(0,1) | &nbsp;1 | test</font></div><div><font size="2"   >&nbsp;(0,3) | &nbsp;2 | test</font></div><div><font size="2"   >&nbsp;(0,5) | &nbsp;3 | test</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div><div><br></div><div>3. 触发器</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create or replace function tg_i_test () returns trigger as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; perform 1 from i_test where id=NEW.id limit 1;</font></div><div><font size="2"   >&nbsp; if found then</font></div><div><font size="2"   >&nbsp; &nbsp; return null;</font></div><div><font size="2"   >&nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; return new;</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div></div><div><div><font size="2"   >digoal=# create trigger tg_i before insert on i_test for each row execute procedure tg_i_test();</font></div><div><font size="2"   >CREATE TRIGGER</font></div><div><font size="2"   >digoal=# insert into i_test values (1,'test');</font></div><div><font size="2"   >INSERT 0 0</font></div><div><font size="2"   >digoal=# insert into i_test values (4,'test');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# select ctid,* from i_test;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| id | info&nbsp;</font></div><div><font size="2"   >-------+----+------</font></div><div><font size="2"   >&nbsp;(0,1) | &nbsp;1 | test</font></div><div><font size="2"   >&nbsp;(0,3) | &nbsp;2 | test</font></div><div><font size="2"   >&nbsp;(0,5) | &nbsp;3 | test</font></div><div><font size="2"   >&nbsp;(0,6) | &nbsp;4 | test</font></div><div><font size="2"   >(4 rows)</font></div></div><p></p></pre></div><div>因为是before触发器, 所以使用这个方法不会产生垃圾数据, 推荐使用.</div><div><br></div><div>4. 规则</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# drop trigger tg_i on i_test;</font></div><div><font size="2"   >DROP TRIGGER</font></div></div><div><div><font size="2"   >digoal=# create rule r_i_test as on insert to i_test where exists (select 1 from i_test where id = new.id) do instead nothing;</font></div><div><font size="2"   >CREATE RULE</font></div><div><font size="2"   >digoal=# insert into i_test values (4,'test');</font></div><div><font size="2"   >INSERT 0 0</font></div><div><font size="2"   >digoal=# insert into i_test values (5,'test');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# select ctid,* from i_test;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| id | info&nbsp;</font></div><div><font size="2"   >-------+----+------</font></div><div><font size="2"   >&nbsp;(0,1) | &nbsp;1 | test</font></div><div><font size="2"   >&nbsp;(0,3) | &nbsp;2 | test</font></div><div><font size="2"   >&nbsp;(0,5) | &nbsp;3 | test</font></div><div><font size="2"   >&nbsp;(0,6) | &nbsp;4 | test</font></div><div><font size="2"   >&nbsp;(0,7) | &nbsp;5 | test</font></div><div><font size="2"   >(5 rows)</font></div></div><p></p></pre></div><div>但是需要注意, 规则对于copy不响应, 所以无法规避copy带来的问题. 如果逻辑备份为copy格式的话, 还原的时候也无法规避这个问题. 触发器不存在这个问题.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# copy i_test from stdin;</font></div><div><font size="2"   >Enter data to be copied followed by a newline.</font></div><div><font size="2"   >End with a backslash and a period on a line by itself.</font></div><div><font size="2"   >&gt;&gt; 1 &nbsp; &nbsp;'test'</font></div><div><font size="2"   >&gt;&gt; 2 &nbsp; &nbsp;'test'</font></div><div><font size="2"   >&gt;&gt; 100 &nbsp;'t'</font></div><div><font size="2"   >&gt;&gt; \.</font></div><div><font size="2"   >ERROR: &nbsp;duplicate key value violates unique constraint "i_test_pkey"</font></div><div><font size="2"   >DETAIL: &nbsp;Key (id)=(1) already exists.</font></div><div><font size="2"   >CONTEXT: &nbsp;COPY i_test, line 1</font></div><p></p></pre></div><div><br></div><div>5. with语法</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into i_test with tmp(c1,c2) as ( values(1,'test'),(2,'test'),(1000,'test') )&nbsp;</font></div><div><font size="2"   >digoal-# select tmp.* from tmp where tmp.c1 not in (select id from i_test);</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# insert into i_test with tmp(c1,c2) as ( values(1,'test'),(2,'test'),(1000,'test') )&nbsp;</font></div><div><font size="2"   >select tmp.* from tmp where tmp.c1 not in (select id from i_test);</font></div><div><font size="2"   >INSERT 0 0</font></div><p></p></pre></div><div><br></div><div>接下来进入正题, 本文要说的这个PostgreSQL补丁就是达到这个目的的, 如果违反唯一约束, 可以忽略插入不报错.</div><div>语法 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >insert into t1 values (5,'d',now()) on duplicate key ignore;</font></div><div><font size="2"   >insert into t1 values (5,'d',now()) on duplicate key ignore returning rejects *;</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >补丁:</span></div><div><span style="line-height: 22px;"   >请使用8月28日的postgresql snapshot.</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >wget http://www.postgresql.org/message-id/attachment/29989/insert_on_dup.v1.2013_08_30.patch.gz</font></span></div><div><div><font size="2"   >gunzip insert_on_dup.v1.2013_08_30.patch.gz</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-33 postgresql-090d0f2]# patch -p1 &lt; insert_on_dup.v1.2013_08_30.patch&nbsp;</font></div><div><font size="2"   >patching file contrib/pg_stat_statements/pg_stat_statements.c</font></div><div><font size="2"   >patching file src/backend/access/heap/tuptoaster.c</font></div><div><font size="2"   >patching file src/backend/access/index/indexam.c</font></div><div><font size="2"   >patching file src/backend/access/nbtree/nbtinsert.c</font></div><div><font size="2"   >patching file src/backend/access/nbtree/nbtree.c</font></div><div><font size="2"   >patching file src/backend/access/nbtree/nbtsearch.c</font></div><div><font size="2"   >patching file src/backend/catalog/index.c</font></div><div><font size="2"   >patching file src/backend/catalog/indexing.c</font></div><div><font size="2"   >patching file src/backend/commands/constraint.c</font></div><div><font size="2"   >patching file src/backend/commands/copy.c</font></div><div><font size="2"   >patching file src/backend/executor/execUtils.c</font></div><div><font size="2"   >patching file src/backend/executor/nodeModifyTable.c</font></div><div><font size="2"   >patching file src/backend/nodes/copyfuncs.c</font></div><div><font size="2"   >patching file src/backend/nodes/equalfuncs.c</font></div><div><font size="2"   >patching file src/backend/nodes/nodeFuncs.c</font></div><div><font size="2"   >patching file src/backend/nodes/outfuncs.c</font></div><div><font size="2"   >patching file src/backend/nodes/readfuncs.c</font></div><div><font size="2"   >patching file src/backend/optimizer/plan/createplan.c</font></div><div><font size="2"   >patching file src/backend/optimizer/plan/planner.c</font></div><div><font size="2"   >patching file src/backend/parser/analyze.c</font></div><div><font size="2"   >patching file src/backend/parser/gram.y</font></div><div><font size="2"   >patching file src/include/access/genam.h</font></div><div><font size="2"   >patching file src/include/access/nbtree.h</font></div><div><font size="2"   >patching file src/include/catalog/catversion.h</font></div><div><font size="2"   >patching file src/include/catalog/pg_am.h</font></div><div><font size="2"   >patching file src/include/catalog/pg_proc.h</font></div><div><font size="2"   >patching file src/include/executor/executor.h</font></div><div><font size="2"   >patching file src/include/nodes/execnodes.h</font></div><div><font size="2"   >patching file src/include/nodes/nodes.h</font></div><div><font size="2"   >patching file src/include/nodes/parsenodes.h</font></div><div><font size="2"   >patching file src/include/nodes/plannodes.h</font></div><div><font size="2"   >patching file src/include/optimizer/planmain.h</font></div><div><font size="2"   >patching file src/include/parser/kwlist.h</font></div><div><font size="2"   >patching file src/include/utils/rel.h</font></div><div><font size="2"   >patching file src/test/isolation/expected/insert-duplicate-key.out</font></div><div><font size="2"   >patching file src/test/isolation/isolation_schedule</font></div><div><font size="2"   >patching file src/test/isolation/specs/insert-duplicate-key.spec</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >gmake</font></div><div><font size="2"   >gmake install</font></div></div><p></p></pre></div><div><div>测试 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table t(id int primary key, info text unique, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# \d+ t</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "public.t"</font></div><div><font size="2"   >&nbsp; Column &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Modifiers | Storage &nbsp;| Stats target | Description&nbsp;</font></div><div><font size="2"   >----------+-----------------------------+-----------+----------+--------------+-------------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;info &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;crt_time | timestamp without time zone | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "t_pkey" PRIMARY KEY, btree (id)</font></div><div><font size="2"   >&nbsp; &nbsp; "t_info_key" UNIQUE CONSTRAINT, btree (info)</font></div><div><font size="2"   >Has OIDs: no</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# insert into t values (1,'a',now());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# insert into t values (1,'a',now()) on duplicate key ignore;</font></div><div><font size="2"   >INSERT 0 0</font></div><div><font size="2"   >digoal=# insert into t values (2,'b',now());</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div>-- 使用returning rejects *可以返回未被插入的行.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# insert into t values (1,'a',now()) on duplicate key ignore returning rejects *;</font></div><div><font size="2"   >&nbsp;id | info | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+------+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | a &nbsp; &nbsp;| 2013-09-06 09:03:18.962054</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >INSERT 0 0</font></div></div><div><font size="2"   >digoal=# select ctid,* from t;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| id | info | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------+----+------+----------------------------</font></div><div><font size="2"   >&nbsp;(0,1) | &nbsp;1 | a &nbsp; &nbsp;| 2013-09-06 09:01:41.58451</font></div><div><font size="2"   >&nbsp;(0,2) | &nbsp;2 | b &nbsp; &nbsp;| 2013-09-06 09:02:10.369413</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div></div><div>使用on duplicate key ignore 后, 插入违反唯一约束的话, 记录不会被插入, 同时也不会消耗实际的item.</div><div>如果不使用on duplicate key ignore, 会消耗item. 例如.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into t values (1,'a',now());</font></div><div><font size="2"   >ERROR: &nbsp;duplicate key value violates unique constraint "t_pkey"</font></div><div><font size="2"   >DETAIL: &nbsp;Key (id)=(1) already exists.</font></div><div><font size="2"   >digoal=# insert into t values (1,'a',now());</font></div><div><font size="2"   >ERROR: &nbsp;duplicate key value violates unique constraint "t_pkey"</font></div><div><font size="2"   >DETAIL: &nbsp;Key (id)=(1) already exists.</font></div><div><font size="2"   >digoal=# insert into t values (1,'a',now());</font></div><div><font size="2"   >ERROR: &nbsp;duplicate key value violates unique constraint "t_pkey"</font></div><div><font size="2"   >DETAIL: &nbsp;Key (id)=(1) already exists.</font></div><p></p></pre></div><div>-- 以上SQL插入报错了, 同时将消耗3条item.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into t values (3,'c',now());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# select ctid,* from t;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| id | info | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------+----+------+----------------------------</font></div><div><font size="2"   >&nbsp;(0,1) | &nbsp;1 | a &nbsp; &nbsp;| 2013-09-06 09:01:41.58451</font></div><div><font size="2"   >&nbsp;(0,2) | &nbsp;2 | b &nbsp; &nbsp;| 2013-09-06 09:02:10.369413</font></div><div><font size="2"   >&nbsp;(0,6) | &nbsp;3 | c &nbsp; &nbsp;| 2013-09-06 09:04:13.720437</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div></div><div><span style="line-height: 22px;"   >使用on duplicate key, 插入时如果遇到已有的key, 锁和不使用on duplicate key情形一样.</span></div></div><div>不使用on duplicate key ignore</div><div>session a:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# insert into t values (4,'d',now());</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div>session b:</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# insert into t values (4,'d',now());</font></div></div><div><font size="2"   >-- 等待中</font></div><p></p></pre></div><div>使用on duplicate key ignore, 同样处于等待.</div><div><span style="line-height: 22px;"   >session b:</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# insert into t values (4,'d',now()) on duplicate key ignore;</font></div><p></p></pre></div><div>从锁信息中可以看到, session b 在等待session a的事务锁.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select query,waiting from pg_stat_activity;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| waiting&nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------+---------</font></div><div><font size="2"   >&nbsp;insert into t values (4,'d',now()); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >&nbsp;insert into t values (4,'d',now()) on duplicate key ignore; | t</font></div><div><font size="2"   >&nbsp;select query,waiting from pg_stat_activity; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >(3 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select query,waiting,pid from pg_stat_activity;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| waiting | &nbsp;pid &nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------+---------+-------</font></div><div><font size="2"   >&nbsp;insert into t values (4,'d',now()); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; | 30999</font></div><div><font size="2"   >&nbsp;insert into t values (4,'d',now()) on duplicate key ignore; | t &nbsp; &nbsp; &nbsp; | 24139</font></div><div><font size="2"   >&nbsp;select query,waiting,pid from pg_stat_activity; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; | 23361</font></div><div><font size="2"   >(3 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from pg_locks where pid=24139;</font></div><div><font size="2"   >&nbsp; &nbsp;locktype &nbsp; &nbsp;| database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualtransaction |</font></div><div><font size="2"   >&nbsp; pid &nbsp;| &nbsp; &nbsp; &nbsp; mode &nbsp; &nbsp; &nbsp; | granted | fastpath&nbsp;</font></div><div><font size="2"   >---------------+----------+----------+------+-------+------------+---------------+---------+-------+----------+--------------------+</font></div><div><font size="2"   >-------+------------------+---------+----------</font></div><div><font size="2"   >&nbsp;relation &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;16384 | &nbsp; &nbsp;16426 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3/3864 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;24139 | RowExclusiveLock | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;relation &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;16384 | &nbsp; &nbsp;16424 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3/3864 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;24139 | RowExclusiveLock | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;relation &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;16384 | &nbsp; &nbsp;16418 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3/3864 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;24139 | RowExclusiveLock | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;virtualxid &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | 3/3864 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3/3864 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;24139 | ExclusiveLock &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;transactionid | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1712 | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3/3864 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;24139 | ShareLock &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >(5 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from pg_locks where pid=30999;</font></div><div><font size="2"   >&nbsp; &nbsp;locktype &nbsp; &nbsp;| database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualtransaction |</font></div><div><font size="2"   >&nbsp; pid &nbsp;| &nbsp; &nbsp; &nbsp; mode &nbsp; &nbsp; &nbsp; | granted | fastpath&nbsp;</font></div><div><font size="2"   >---------------+----------+----------+------+-------+------------+---------------+---------+-------+----------+--------------------+</font></div><div><font size="2"   >-------+------------------+---------+----------</font></div><div><font size="2"   >&nbsp;relation &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;16384 | &nbsp; &nbsp;16418 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2/1217 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;30999 | RowExclusiveLock | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;virtualxid &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | 2/1217 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2/1217 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;30999 | ExclusiveLock &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;transactionid | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1712 | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2/1217 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;30999 | ExclusiveLock &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://dev.mysql.com/doc/refman/5.5/en/replace.html"   >http://dev.mysql.com/doc/refman/5.5/en/replace.html</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="https://commitfest.postgresql.org/action/patch_view?id=1201"   >https://commitfest.postgresql.org/action/patch_view?id=1201</a></div><div>3.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://dev.mysql.com/doc/refman/5.6/en/insert-on-duplicate.html"   >http://dev.mysql.com/doc/refman/5.6/en/insert-on-duplicate.html</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://commitfest.postgresql.org/3/35/"   >https://commitfest.postgresql.org/3/35/<br></a><span style="line-height: 28px;"   >
</span><a style="line-height: 28px;" rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL 9.4 pending patch : INSERT...ON DUPLICATE KEY IGNORE - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">辉哥的灰 - 2013-09-27 16:44:05</h5>
				<div><P>请问这个补丁怎么安装</P>
<P>急求！！！</P></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 辉哥的灰 - 2013-09-27 16:44:05</h5>
				<div style="width:600px;">HI, 打补丁的过程在本文有详细描述.patch -p1 &lt; ....</div>
			</div>
	</div>
</div>
</body>
</html>