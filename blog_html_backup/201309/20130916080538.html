<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL pending patch :  MAP_HUGETLB for shared memory</h2>
	<h5 id="">2013-09-16 8:05:38&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201381673359888/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p></p><div><font size="2"   >The attached patch adds the MAP_HUGETLB flag to mmap() for shared memory</font></div><div><font size="2"   >on systems that support it. It's based on Christian Kruse's patch from</font></div><div><font size="2"   >last year, incorporating suggestions from Andres Freund.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >On a system with 4GB shared_buffers, doing pgbench runs long enough for</font></div><div><font size="2"   >each backend to touch most of the buffers, this patch saves nearly 8MB of</font></div><div><font size="2"   >memory per backend and improves performances by just over 2% on average.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >It is still WIP as there are a couple of points that Andres has pointed</font></div><div><font size="2"   >out to me that haven't been addressed yet; also, the documentation is</font></div><div><font size="2"   >incomplete.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Richard</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >--&nbsp;</font></div><div><font size="2"   >Richard Poole &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; http://www.2ndQuadrant.com/</font></div><div><font size="2"   >PostgreSQL Development, 24x7 Support, Training &amp; Services</font></div><p></p></pre></div><div>MAP_HUGETLB是内核2.6.32引入的一个mmap flags, 用于使用huge pages分配共享内存.</div><div>使用大页面的好处是在大内存的管理上减少CPU的开销, 意见减少页表的大小. 从而提高性能.</div><div>PostgreSQL 9.3开始共享内存的分配使用mmap的方式. &nbsp;所以这个补丁需用到9.3以及以上版本.</div><div>同时需要操作系统的支持, 内核需要2.6.32以及以上版本才行.</div><div>huge page在操作系统层面的配置, 详细参考<span style="line-height: 23px;"   >Documentation/vm/hugetlbpage.txt</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >root@digoal-PowerEdge-R610:~# sysctl -w vm.nr_hugepages=10240</font></div><div><font size="2"   >vm.nr_hugepages = 10240</font></div></div><div><font size="2"   >root@digoal-PowerEdge-R610:~# cat /proc/meminfo&nbsp;</font></div><div><div><font size="2"   >HugePages_Total: &nbsp; 10240</font></div><div><font size="2"   >HugePages_Free: &nbsp; &nbsp;10240</font></div><div><font size="2"   >HugePages_Rsvd: &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >HugePages_Surp: &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >Hugepagesize: &nbsp; &nbsp; &nbsp; 2048 kB</font></div></div><p></p></pre></div><div>配置为系统配置 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@digoal-PowerEdge-R610:~# vi /etc/sysctl.conf</font></div><div><font size="2"   ># add</font></div><div><font size="2"   >vm.nr_hugepages = 10240</font></div><p></p></pre></div><div><span style="line-height: 23px;"   ><br></span></div><div><span style="line-height: 23px;"   >[参考]</span></div><wbr><p>1.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="https://commitfest.postgresql.org/action/patch_view?id=1222"   >https://commitfest.postgresql.org/action/patch_view?id=1222</a></p><p>2. man mmap</p><pre class="prettyprint"   ><p></p><p><font size="2"   >flag</font></p><p><font size="2"   >MAP_HUGETLB (since Linux 2.6.32)</font></p><p><font size="2"   >Allocate the mapping using "huge pages." &nbsp;See the Linux kernel</font></p><p><font size="2"   >source file Documentation/vm/hugetlbpage.txt for further</font></p><p><font size="2"   >information.</font></p><p></p></pre><p>3.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="http://www.man7.org/linux/man-pages/man2/mmap.2.html"   >http://www.man7.org/linux/man-pages/man2/mmap.2.html</a></p><p>4.&nbsp;Documentation/vm/hugetlbpage.txt</p><pre class="prettyprint"   ><p></p><p><font size="2"   >The kernel built with hugepage support should show the number of configured</font></p><p><font size="2"   >hugepages in the system by running the "cat /proc/meminfo" command.</font></p><p><font size="2"   ><br></font></p><p><font size="2"   >/proc/meminfo also provides information about the total number of hugetlb</font></p><p><font size="2"   >pages configured in the kernel. &nbsp;It also displays information about the</font></p><p><font size="2"   >number of free hugetlb pages at any time. &nbsp;It also displays information about</font></p><p><font size="2"   >the configured hugepage size - this is needed for generating the proper</font></p><p><font size="2"   >alignment and size of the arguments to the above system calls.</font></p><p><font size="2"   ><br></font></p><p><font size="2"   >The output of "cat /proc/meminfo" will have lines like:</font></p><p><font size="2"   ><br></font></p><p><font size="2"   >.....</font></p><p><font size="2"   >HugePages_Total: xxx</font></p><p><font size="2"   >HugePages_Free: &nbsp;yyy</font></p><p><font size="2"   >HugePages_Rsvd: &nbsp;www</font></p><p><font size="2"   >Hugepagesize: &nbsp; &nbsp;zzz kB</font></p><p><font size="2"   >where:</font></p><p><font size="2"   >HugePages_Total is the size of the pool of hugepages.</font></p><p><font size="2"   >HugePages_Free is the number of hugepages in the pool that are not yet</font></p><p><font size="2"   >allocated.</font></p><p><font size="2"   >HugePages_Rsvd is short for "reserved," and is the number of hugepages</font></p><p><font size="2"   >for which a commitment to allocate from the pool has been made, but no</font></p><p><font size="2"   >allocation has yet been made. It's vaguely analogous to overcommit.</font></p><p><font size="2"   ><br></font></p><p><font size="2"   >/proc/filesystems should also show a filesystem of type "hugetlbfs" configured</font></p><p><font size="2"   >in the kernel.</font></p><p><font size="2"   ><br></font></p><p><font size="2"   >/proc/sys/vm/nr_hugepages indicates the current number of configured hugetlb</font></p><p><font size="2"   >pages in the kernel. &nbsp;Super user can dynamically request more (or free some</font></p><p><font size="2"   >pre-configured) hugepages.</font></p><p><font size="2"   >The allocation (or deallocation) of hugetlb pages is possible only if there are</font></p><p><font size="2"   >enough physically contiguous free pages in system (freeing of hugepages is</font></p><p><font size="2"   >possible only if there are enough hugetlb pages free that can be transferred</font></p><p><font size="2"   >back to regular memory pool).</font></p><p><font size="2"   ><br></font></p><p><font size="2"   >Pages that are used as hugetlb pages are reserved inside the kernel and cannot</font></p><p><font size="2"   >be used for other purposes.</font></p><p><font size="2"   ><br></font></p><p><font size="2"   >Once the kernel with Hugetlb page support is built and running, a user can</font></p><p><font size="2"   >use either the mmap system call or shared memory system calls to start using</font></p><p><font size="2"   >the huge pages. &nbsp;It is required that the system administrator preallocate</font></p><p><font size="2"   >enough memory for huge page purposes.</font></p><p><font size="2"   ><br></font></p><p><font size="2"   >Use the following command to dynamically allocate/deallocate hugepages:</font></p><p><font size="2"   ><br></font></p><p><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; echo 20 &gt; /proc/sys/vm/nr_hugepages</font></p><p><font size="2"   ><br></font></p><p><font size="2"   >This command will try to configure 20 hugepages in the system. &nbsp;The success</font></p><p><font size="2"   >or failure of allocation depends on the amount of physically contiguous</font></p><p><font size="2"   >memory that is preset in system at this time. &nbsp;System administrators may want</font></p><p><font size="2"   >to put this command in one of the local rc init files. &nbsp;This will enable the</font></p><p><font size="2"   >kernel to request huge pages early in the boot process (when the possibility</font></p><p><font size="2"   >of getting physical contiguous pages is still very high).</font></p><p><font size="2"   >If the user applications are going to request hugepages using mmap system</font></p><p><font size="2"   >call, then it is required that system administrator mount a file system of</font></p><p><font size="2"   >type hugetlbfs:</font></p><p><font size="2"   ><br></font></p><p><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; mount none /mnt/huge -t hugetlbfs &lt;uid=value&gt; &lt;gid=value&gt; &lt;mode=value&gt;</font></p><p><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;size=value&gt; &lt;nr_inodes=value&gt;</font></p><p><font size="2"   ><br></font></p><p><font size="2"   >This command mounts a (pseudo) filesystem of type hugetlbfs on the directory</font></p><p><font size="2"   >/mnt/huge. &nbsp;Any files created on /mnt/huge uses hugepages. &nbsp;The uid and gid</font></p><p><font size="2"   >options sets the owner and group of the root of the file system. &nbsp;By default</font></p><p><font size="2"   >the uid and gid of the current process are taken. &nbsp;The mode option sets the</font></p><p><font size="2"   >mode of root of file system to value &amp; 0777. &nbsp;This value is given in octal.</font></p><p><font size="2"   >By default the value 0755 is picked. The size option sets the maximum value of</font></p><p><font size="2"   >memory (huge pages) allowed for that filesystem (/mnt/huge). The size is</font></p><p><font size="2"   >rounded down to HPAGE_SIZE. &nbsp;The option nr_inodes sets the maximum number of</font></p><p><font size="2"   >inodes that /mnt/huge can use. &nbsp;If the size or nr_inodes options are not</font></p><p><font size="2"   >provided on command line then no limits are set. &nbsp;For size and nr_inodes</font></p><p><font size="2"   >options, you can use [G|g]/[M|m]/[K|k] to represent giga/mega/kilo. For</font></p><p><font size="2"   >example, size=2K has the same meaning as size=2048. An example is given at</font></p><p><font size="2"   >the end of this document.</font></p><p><font size="2"   ><br></font></p><p><font size="2"   >read and write system calls are not supported on files that reside on hugetlb</font></p><p><font size="2"   >file systems.</font></p><p><font size="2"   ><br></font></p><p><font size="2"   >Regular chown, chgrp, and chmod commands (with right permissions) could be</font></p><p><font size="2"   >used to change the file attributes on hugetlbfs.</font></p><p><font size="2"   ><br></font></p><p><font size="2"   >Also, it is important to note that no such mount command is required if the</font></p><p><font size="2"   >applications are going to use only shmat/shmget system calls. &nbsp;Users who</font></p><p><font size="2"   >wish to use hugetlb page via shared memory segment should be a member of</font></p><p><font size="2"   >a supplementary group and system admin needs to configure that gid into</font></p><p><font size="2"   >/proc/sys/vm/hugetlb_shm_group. &nbsp;It is possible for same or different</font></p><p><font size="2"   >applications to use any combination of mmaps and shm* calls, though the</font></p><p><font size="2"   >mount of filesystem will be required for using mmap calls.</font></p><p></p></pre><p>5. patch 增加的一个参数</p><pre class="prettyprint"   ><p></p><p><font size="2"   >+ &nbsp; &nbsp; &lt;varlistentry id="guc-huge-tlb-pages" xreflabel="huge_tlb_pages"&gt;</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp;&lt;term&gt;&lt;varname&gt;huge_tlb_pages&lt;/varname&gt; (&lt;type&gt;enum&lt;/type&gt;)&lt;/term&gt;</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp;&lt;indexterm&gt;</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp; &lt;primary&gt;&lt;varname&gt;huge_tlb_pages&lt;/&gt; configuration parameter&lt;/primary&gt;</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp;&lt;/indexterm&gt;</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp;&lt;listitem&gt;</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp; &lt;para&gt;</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;Enables/disables the use of huge tlb pages. Valid values are</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;&lt;literal&gt;on&lt;/literal&gt;, &lt;literal&gt;off&lt;/literal&gt; and &lt;literal&gt;try&lt;/literal&gt;.</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;The default value is &lt;literal&gt;try&lt;/literal&gt;.</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp; &lt;/para&gt;</font></p><p><font size="2"   >+</font></p><p><font size="2"   >+<span>	</span> &nbsp; &lt;para&gt;</font></p><p><font size="2"   >+<span>	</span> &nbsp; Use of huge tlb pages reduces the cpu time spent on memory management and</font></p><p><font size="2"   >+<span>	</span> &nbsp; the amount of memory used for page tables and therefore improves performance.</font></p><p><font size="2"   >+<span>	</span> &nbsp; &lt;/para&gt;</font></p><p><font size="2"   >+</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp; &lt;para&gt;</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;With &lt;varname&gt;huge_tlb_pages&lt;/varname&gt; set to &lt;literal&gt;on&lt;/literal&gt;</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;&lt;symbol&gt;mmap()&lt;/symbol&gt; will be called with &lt;symbol&gt;MAP_HUGETLB&lt;/symbol&gt;.</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;If the call fails the server will fail fatally.</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp; &lt;/para&gt;</font></p><p><font size="2"   >+</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp; &lt;para&gt;</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;With &lt;varname&gt;huge_tlb_pages&lt;/varname&gt; set to &lt;literal&gt;off&lt;/literal&gt; we</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;will not use &lt;symbol&gt;MAP_HUGETLB&lt;/symbol&gt; at all.</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp; &lt;/para&gt;</font></p><p><font size="2"   >+</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp; &lt;para&gt;</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;With &lt;varname&gt;huge_tlb_pages&lt;/varname&gt; set to &lt;literal&gt;try&lt;/literal&gt;</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;we will try to use &lt;symbol&gt;MAP_HUGETLB&lt;/symbol&gt; and fall back to</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;&lt;symbol&gt;mmap()&lt;/symbol&gt; without &lt;symbol&gt;MAP_HUGETLB&lt;/symbol&gt;.</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp; &lt;/para&gt;</font></p><p><font size="2"   >+ &nbsp; &nbsp; &nbsp;&lt;/listitem&gt;</font></p><p><font size="2"   >+ &nbsp; &nbsp; &lt;/varlistentry&gt;</font></p><p></p></pre><pre>其他详见</pre><pre><a rel="nofollow" href="http://www.postgresql.org/message-id/attachment/30126/hugepages-v1.patch"   >http://www.postgresql.org/message-id/attachment/30126/hugepages-v1.patch</a></pre></div>
	</div>
</div>
</body>
</html>