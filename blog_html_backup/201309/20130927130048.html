<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">pg_matlab v2 install</h2>
	<h5 id="">2013-09-27 13:00:48&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201382705930268/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>首先要安装MCR v713 x64, 参考 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201382785137436/"   >http://blog.163.com/digoal@126/blog/static/163877040201382785137436/</a></div><div>然后安装pg_matlab, 首先下载代码 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >wget http://www.cybertec.at/download/pg_matlab/pg_matlab-v2.tar.gz</font></div><div><font size="2"   >tar -zxvf pg_matlab-v2.tar.gz</font></div><div><font size="2"   >mv pg_matlab /opt/soft_bak/postgresql-9.3.0/contrib/</font></div><p></p></pre></div><div>matlab有一些bug, 需要修改一下</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd /opt/soft_bak/postgresql-9.3.0/contrib/pg_matlab</font></div><div><font size="2"   >[root@db-172-16-3-150 pg_matlab]# vi libmatpg/Makefile</font></div><div><font size="2"   >MODULE_big = matpg</font></div><div><font size="2"   >改成</font></div><div><font size="2"   >MODULE_big = libmatpg</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 pg_matlab]# vi libmatpg/create_mat_pg_operators.sql.in</font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION mat_pg_add(DOUBLE PRECISION[], DOUBLE PRECISION[]) RETURNS DOUBLE PRECISION[]</font></div><div><font size="2"   >AS '$libdir/matpg'</font></div><div><font size="2"   >改成</font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION mat_pg_add(DOUBLE PRECISION[], DOUBLE PRECISION[]) RETURNS DOUBLE PRECISION[]</font></div><div><font size="2"   >AS '$libdir/libmatpg'</font></div><p></p></pre></div><div>修改安装目录和lib文件目录. 以及mcr环境</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 pg_matlab]# vi Makefile&nbsp;</font></div><div><font size="2"   >修改</font></div><div><font size="2"   >PGM_DIR = /home/pg93/pgsql/bin</font></div><div><font size="2"   >LIB_DIR = /home/pg93/pgsql/lib</font></div><div><font size="2"   >MATLABROOT=/opt/MATLAB/MATLAB_Compiler_Runtime/v713</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 pg_matlab]# cd matcored/</font></div><div><font size="2"   >vi Makefile</font></div><div><font size="2"   >第一行上面加一行</font></div><div><font size="2"   >MATLABROOT=/opt/MATLAB/MATLAB_Compiler_Runtime/v713</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 pg_matlab]# vi libmatpg/mat_pg_funcs.h</font></div><div><font size="2"   >以下为pg函数连接matcored的端口, 编译时写死了, 所以后面在启动matcored时必须使用这个端口, pg函数会连不上的.</font></div><div><font size="2"   >确保这个端口没有被其他程序占用.</font></div><div><font size="2"   >#define MATPGPORT &nbsp; &nbsp; &nbsp; (54321)</font></div><p></p></pre></div><div>pg_matlab用到的libmatcore.so文件是已经编译好的, 直接使用, 这两个文件如下, md5码一致.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 pg_matlab]# cd libmatcore</font></div><div><font size="2"   >[root@db-172-16-3-150 libmatcore]# ll</font></div><div><font size="2"   >total 8</font></div><div><font size="2"   >drwxr-xr-x. 2 pg93 pg93 4096 Feb 10 &nbsp;2011 distrib</font></div><div><font size="2"   >drwxr-xr-x. 2 pg93 pg93 4096 Feb 10 &nbsp;2011 src</font></div><div><font size="2"   >[root@db-172-16-3-150 libmatcore]# md5sum distrib/libmatcore.so</font></div><div><font size="2"   >ae9f35e018a46c2a240ea0490aa9d98e &nbsp;distrib/libmatcore.so</font></div><div><font size="2"   >[root@db-172-16-3-150 libmatcore]# md5sum src/libmatcore.so</font></div><div><font size="2"   >ae9f35e018a46c2a240ea0490aa9d98e &nbsp;src/libmatcore.so</font></div><p></p></pre></div><div>开始安装pg_matlab, 需要用到一些环境变量 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 pg_matlab]# export PATH=/home/pg93/pgsql/bin:$PATH</font></div><div><font size="2"   >[root@db-172-16-3-150 pg_matlab]# which pg_config</font></div><div><font size="2"   >/home/pg93/pgsql/bin/pg_config</font></div><div><font size="2"   >[root@db-172-16-3-150 pg_matlab]# USE_PGXS=1 make all</font></div><div><font size="2"   >make -e -C matcored</font></div><div><font size="2"   >make[1]: Entering directory `/opt/soft_bak/postgresql-9.3.0/contrib/pg_matlab/matcored'</font></div><div><font size="2"   >cc -Wall -c -o matcored.o matcored.c -I/opt/MATLAB/MATLAB_Compiler_Runtime/v713/extern/include -I../libmatcore/distrib</font></div><div><font size="2"   >cc -Wall -c -o mat_wrapper.o mat_wrapper.c -I/opt/MATLAB/MATLAB_Compiler_Runtime/v713/extern/include -I../libmatcore/distrib</font></div><div><font size="2"   >gcc -o matcored matcored.o mat_wrapper.o -L/opt/MATLAB/MATLAB_Compiler_Runtime/v713/runtime/glnxa64 -L../libmatcore/distrib -lmwmclmcrrt -lmatcore</font></div><div><font size="2"   >make[1]: Leaving directory `/opt/soft_bak/postgresql-9.3.0/contrib/pg_matlab/matcored'</font></div><div><font size="2"   >USE_PGXS=1 make -e -C libmatpg</font></div><div><font size="2"   >make[1]: Entering directory `/opt/soft_bak/postgresql-9.3.0/contrib/pg_matlab/libmatpg'</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fpic -I../matcored -I. -I. -I/home/pg93/pgsql9.3.0/include/server -I/home/pg93/pgsql9.3.0/include/internal -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o mat_pg_funcs.o mat_pg_funcs.c</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fpic -shared -o libmatpg.so mat_pg_funcs.o -L/home/pg93/pgsql9.3.0/lib -Wl,--as-needed -Wl,-rpath,'/home/pg93/pgsql9.3.0/lib',--enable-new-dtags &nbsp;</font></div><div><font size="2"   >sed 's,MODULE_PATHNAME,$libdir/create_mat_pg_operators,g' create_mat_pg_operators.sql.in &gt;create_mat_pg_operators.sql</font></div><div><font size="2"   >make[1]: Leaving directory `/opt/soft_bak/postgresql-9.3.0/contrib/pg_matlab/libmatpg'</font></div><div><font size="2"   >[root@db-172-16-3-150 pg_matlab]# USE_PGXS=1 make install</font></div><div><font size="2"   >cp libmatcore/distrib/libmatcore.so /home/pg93/pgsql/lib</font></div><div><font size="2"   >cp matcored/matcored /home/pg93/pgsql/bin</font></div><div><font size="2"   >USE_PGXS=1 make install -e -C libmatpg</font></div><div><font size="2"   >make[1]: Entering directory `/opt/soft_bak/postgresql-9.3.0/contrib/pg_matlab/libmatpg'</font></div><div><font size="2"   >/bin/mkdir -p '/home/pg93/pgsql9.3.0/lib'</font></div><div><font size="2"   >/bin/mkdir -p '/home/pg93/pgsql9.3.0/share/contrib'</font></div><div><font size="2"   >/usr/bin/install -c -m 755 &nbsp;libmatpg.so '/home/pg93/pgsql9.3.0/lib/libmatpg.so'</font></div><div><font size="2"   >/usr/bin/install -c -m 644 &nbsp;create_mat_pg_operators.sql '/home/pg93/pgsql9.3.0/share/contrib/'</font></div><div><font size="2"   >make[1]: Leaving directory `/opt/soft_bak/postgresql-9.3.0/contrib/pg_matlab/libmatpg'</font></div><p></p></pre></div><div>使用pg_matlab, 设置pg93用户的环境变量 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 pg_matlab]# su - pg93</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; vi .bash_profile</font></div><div><font size="2"   >export PS1="$USER@`/bin/hostname -s`-&gt; "</font></div><div><font size="2"   >export PGPORT=1921</font></div><div><font size="2"   >export PGDATA=/ssd2/pg93/pg_root</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/home/pg93/pgsql</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"   >export PGUSER=postgres</font></div><div><font size="2"   >export PGHOST=$PGDATA</font></div><div><font size="2"   >alias rm='rm -i'</font></div><div><font size="2"   >alias ll='ls -lh'</font></div><div><font size="2"   >export PGDATABASE=digoal</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >export MCRHOME=/opt/MATLAB/MATLAB_Compiler_Runtime/v713</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$MCRHOME/runtime/glnxa64:$MCRHOME/bin/glnxa64:$MCRHOME/sys/os/glnxa64:$MCRHOME/sys/java/jre/glnxa64/jre/lib/amd64:$MCRHOME/sys/java/jre/glnxa64/jre/lib/amd64/native_threads:$MCRHOME/sys/java/jre/glnxa64/jre/lib/amd64/server:$LD_LIBRARY_PATH</font></div><div><font size="2"   >export XAPPLRESDIR=$MCRHOME/X11/app-defaults</font></div><p></p></pre></div><div>在库中创建测试用的函数 &nbsp;:&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; cd /home/pg93/pgsql/share/contrib/</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; ll</font></div><div><font size="2"   >total 4.0K</font></div><div><font size="2"   >-rw-r--r--. 1 root root 341 Sep 27 12:35 create_mat_pg_operators.sql</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; psql -f create_mat_pg_operators.sql&nbsp;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >psql:create_mat_pg_operators.sql:7: ERROR: &nbsp;operator does not exist: double precision[] + double precision[]</font></div><div><font size="2"   >CREATE OPERATOR</font></div><p></p></pre></div><div>启动matcored进程, 指定监听端口必须和libmatpg/mat_pg_funcs.h一致, 这个进程是pg函数与matlab沟通的桥梁.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; matcored 54321</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; ps -ewf|grep matcore</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; &nbsp;7999 &nbsp; &nbsp; 1 &nbsp;0 12:40 pts/1 &nbsp; &nbsp;00:00:00 matcored 54321</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; &nbsp;8001 &nbsp;7944 &nbsp;0 12:40 pts/1 &nbsp; &nbsp;00:00:00 grep matcore</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; netstat -anp|grep 54321</font></div><div><font size="2"   >(Not all processes could be identified, non-owned process info</font></div><div><font size="2"   >&nbsp;will not be shown, you would have to be root to see it all.)</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 127.0.0.1:54321 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;7999/matcored &nbsp; &nbsp; &nbsp;&nbsp;</font></div><p></p></pre></div><div>函数测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.3.0)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# \df</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of functions</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp;Name &nbsp; &nbsp;| &nbsp;Result data type &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Argument data types &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;Type &nbsp;</font></div><div><font size="2"   >--------+------------+--------------------+----------------------------------------+--------</font></div><div><font size="2"   >&nbsp;public | mat_pg_add | double precision[] | double precision[], double precision[] | normal</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# SELECT mat_pg_add( '{1,2,3,4}' , '{2,3,4,5}' );</font></div><div><font size="2"   >卡住, 没反应了.</font></div><p></p></pre></div><div>pg和matcored已经建立连接 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; netstat -anp|grep 54321</font></div><div><font size="2"   >(Not all processes could be identified, non-owned process info</font></div><div><font size="2"   >&nbsp;will not be shown, you would have to be root to see it all.)</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 127.0.0.1:54321 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;7999/matcored &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 127.0.0.1:22297 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1:54321 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESTABLISHED 8005/postgres &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 127.0.0.1:54321 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1:22297 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESTABLISHED 7999/matcored</font></div><p></p></pre></div><div>原因不明, 发邮件给http://www.cybertec.at, 等待答复中.</div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 23px;" href="http://blog.163.com/digoal@126/blog/static/163877040201382785137436/"   >http://blog.163.com/digoal@126/blog/static/163877040201382785137436/</a></div><div><br></div><wbr></div>
	</div>
</div>
</body>
</html>