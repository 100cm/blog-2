<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL pgtrashcan use hook _PG_init catch feature like Oracle's recycle bin</h2>
	<h5 id="">2014-04-03 10:09:39&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014339374747/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 本身不支持类似Oracle recycle bin这样的回收站机制.</div><div>但是可利用 PostgreSQL 动态模块, 以及_PG_init函数来创建钩子程序. (_PG_init函数在加载动态模块时立即执行, 动态模块在会话建立时被加载, 所以很好被利用)</div><div>在钩子程序中写一些逻辑, 将删除表的操作, 转移到其他SCHEMA.</div><div>pgtrashcan就是利用这种机制来实现类似Oracle recycle bin的功能的.</div><div>pgtrashcan写的_PG_init如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >void</font></div><div><font size="2"   >_PG_init(void)</font></div><div><font size="2"   >{</font></div><div><font size="2"   ><span>	</span>prev_ProcessUtility = ProcessUtility_hook;</font></div><div><font size="2"   ><span>	</span>if (!prev_ProcessUtility)</font></div><div><font size="2"   ><span>		</span>prev_ProcessUtility = standard_ProcessUtility;</font></div><div><font size="2"   ><span>	</span>ProcessUtility_hook = pgtrashcan_ProcessUtility;</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>钩子程序对应的函数部分内容 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >static void</font></div><div><font size="2"   >pgtrashcan_ProcessUtility(Node *parsetree,</font></div><div><font size="2"   ><span>						</span> &nbsp;const char *queryString,</font></div><div><font size="2"   ><span>						</span> &nbsp;ParamListInfo params,</font></div><div><font size="2"   ><span>						</span> &nbsp;bool isTopLevel,</font></div><div><font size="2"   ><span>						</span> &nbsp;DestReceiver *dest,</font></div><div><font size="2"   ><span>						</span> &nbsp;char *completionTag)</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   >{</font></div><div><font size="2"   ><span>	</span>if (nodeTag(parsetree) == T_DropStmt)</font></div><div><font size="2"   ><span>	</span>{</font></div><div><font size="2"   ><span>		</span>DropStmt *stmt = (DropStmt *) parsetree;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span>		</span>if (stmt-&gt;removeType == OBJECT_TABLE)</font></div><div><font size="2"   ><span>		</span>{</font></div><div><font size="2"   ><span>			</span>RangeVar *r;</font></div><div><font size="2"   ><span>			</span>AlterObjectSchemaStmt *newstmt = makeNode(AlterObjectSchemaStmt);</font></div><div><font size="2"   ><span>			</span>newstmt-&gt;objectType = stmt-&gt;removeType;</font></div><div><font size="2"   ><span>			</span>newstmt-&gt;newschema = pstrdup(trashcan_nspname);</font></div></div><div><div><font size="2"   >#if PG_VERSION_NUM &gt;= 90200</font></div><div><font size="2"   ><span>			</span>newstmt-&gt;missing_ok = stmt-&gt;missing_ok;</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   ><span>			</span>if (stmt-&gt;behavior != DROP_RESTRICT)</font></div><div><font size="2"   ><span>			</span>ereport(ERROR,</font></div><div><font size="2"   ><span>					</span>(errcode(ERRCODE_FEATURE_NOT_SUPPORTED),</font></div><div><font size="2"   ><span>					</span> errmsg("trash can does not support DROP CASCADE")));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span>			</span>r = makeRangeVarFromAnyName(linitial(stmt-&gt;objects));</font></div><div><font size="2"   ><span>			</span>r-&gt;inhOpt = INH_YES;</font></div><div><font size="2"   ><span>			</span>r-&gt;alias = NULL;</font></div><div><font size="2"   ><span>			</span>newstmt-&gt;relation = r;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span>			</span>if (!r-&gt;schemaname || strcmp(r-&gt;schemaname, trashcan_nspname) != 0)</font></div><div><font size="2"   ><span>			</span>{</font></div><div><font size="2"   ><span>				</span>parsetree = (Node *) newstmt;</font></div><div><font size="2"   ><span>				</span>create_trashcan_schema();</font></div><div><font size="2"   ><span>			</span>}</font></div><div><font size="2"   ><span>		</span>}</font></div><div><font size="2"   ><span>	</span>}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#if PG_VERSION_NUM &gt;= 90300</font></div><div><font size="2"   ><span>	</span>(*prev_ProcessUtility) (parsetree, queryString,<span>	</span>context, params, dest, completionTag);</font></div><div><font size="2"   >#else</font></div><div><font size="2"   ><span>	</span>(*prev_ProcessUtility) (parsetree, queryString,<span>	</span>params, isTopLevel, dest, completionTag);</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >static void</font></div><div><font size="2"   >create_trashcan_schema(void)</font></div><div><font size="2"   >{</font></div><div><font size="2"   ><span>	</span>HeapTuple &nbsp; tuple;</font></div><div><font size="2"   ><span>	</span>Oid<span>			</span>datdba;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span>	</span>if (SearchSysCacheExists1(NAMESPACENAME, PointerGetDatum(trashcan_nspname)))</font></div><div><font size="2"   ><span>		</span>return;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span>	</span>tuple = SearchSysCache1(DATABASEOID, ObjectIdGetDatum(MyDatabaseId));</font></div><div><font size="2"   ><span>	</span>if (!HeapTupleIsValid(tuple))</font></div><div><font size="2"   ><span>		</span>ereport(ERROR,</font></div><div><font size="2"   ><span>				</span>(errcode(ERRCODE_UNDEFINED_DATABASE),</font></div><div><font size="2"   ><span>				</span> errmsg("database with OID %u does not exist", MyDatabaseId)));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span>	</span>datdba = ((Form_pg_database) GETSTRUCT(tuple))-&gt;datdba;</font></div><div><font size="2"   ><span>	</span>ReleaseSysCache(tuple);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span>	</span>NamespaceCreate(trashcan_nspname, datdba, false);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span>	</span>CommandCounterIncrement();</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div><br></div><div>pgtrashcan的做法是, 在 drop一个表时, 创建一个名为Trash的schema, 然后将被删除的表移动到这个schema下面.</div><div>目前pgtrashcan的功能比较单一, 且缺少一些判断, 见本文末尾, 还需要改进.</div><div>使用测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - root</font></div><div><font size="2"   >git clone https://github.com/petere/pgtrashcan</font></div><div><font size="2"   >cd pgtrashcan/</font></div><div><font size="2"   >export PATH=/home/pg93/pgsql9.3.3/bin:$PATH</font></div><div><font size="2"   >make</font></div><div><font size="2"   >make install</font></div><div><font size="2"   >su - pg93</font></div><div><font size="2"   >cd $PGDATA</font></div><div><font size="2"   >vi postgresql.conf</font></div><div><font size="2"   >shared_preload_libraries = 'auto_explain,pgtrashcan'</font></div><div><font size="2"   >pg_ctl restart -m fast</font></div><div><div><font size="2"   >pg93@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.3.3)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; Name &nbsp; | Type &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >--------+----------+-------+----------</font></div><div><font size="2"   >&nbsp;public | logtable | table | postgres</font></div><div><font size="2"   >&nbsp;public | test &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# drop table test;</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >digoal=# \dn</font></div><div><font size="2"   >&nbsp; List of schemas</font></div><div><font size="2"   >&nbsp; Name &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >--------+----------</font></div><div><font size="2"   >&nbsp;Trash &nbsp;| postgres</font></div><div><font size="2"   >&nbsp;digoal | postgres</font></div><div><font size="2"   >&nbsp;public | postgres</font></div><div><font size="2"   >(3 rows)</font></div></div><div><font size="2"   >这个表被重定向到"Trash" schema下面.</font></div><div><div><font size="2"   >digoal=# \dt+ "Trash".test&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | Name | Type &nbsp;| &nbsp;Owner &nbsp; | Size &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+------+-------+----------+-------+-------------</font></div><div><font size="2"   >&nbsp;Trash &nbsp;| test | table | postgres | 32 kB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>pgtrashcan插件的使用限制 :&nbsp;</div><div>1. 目前pgtrashcan不支持drop cascade用法(例如删除主表, 或者删除连带的FK关系).</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# drop table test cascade;</font></div><div><font size="2"   >ERROR: &nbsp;0A000: trash can does not support DROP CASCADE</font></div><div><font size="2"   >LOCATION: &nbsp;pgtrashcan_ProcessUtility, pgtrashcan.c:146</font></div><p></p></pre></div><div>2. 代码中, 并没有同名表的判断, 所以当Trash schema中存在同名的表时, 也会报错.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \set VERBOSITY verbose</font></div><div><font size="2"   >digoal=# drop table test;</font></div><div><font size="2"   >ERROR: &nbsp;42P07: relation "test" already exists in schema "Trash"</font></div><div><font size="2"   >LOCATION: &nbsp;AlterRelationNamespaceInternal, tablecmds.c:10054</font></div><p></p></pre></div><div>3. drop table 的用户<span style="line-height: 28px;"   >需要创建schema的权限, 以及写Trash schema的权限. 如果没有创建schema 的权限也会报错.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; drop table t;</font></div><div><font size="2"   >ERROR: &nbsp;42501: permission denied for schema Trash</font></div><div><font size="2"   >LOCATION: &nbsp;aclcheck_error, aclchk.c:3371</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://github.com/petere/pgtrashcan"   >https://github.com/petere/pgtrashcan</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/xfunc-c.html"   >http://www.postgresql.org/docs/9.3/static/xfunc-c.html</a></div><div><pre class="prettyprint"   ><p><font size="2"   >Optionally, a dynamically loaded file can contain initialization and finalization functions. If the file includes a function named _PG_init, that function will be called immediately after loading the file. The function receives no parameters and should return void. If the file includes a function named _PG_fini, that function will be called immediately before unloading the file. Likewise, the function receives no parameters and should return void. Note that _PG_fini will only be called during an unload of the file, not during process termination. (Presently, unloads are disabled and will never occur, but this may change in the future.)</font></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL pgtrashcan use hook _PG_init catch feature like Oracles recycle bin - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>