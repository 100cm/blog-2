<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 Make security barrier views automatically updatable</h2>
	<h5 id="">2014-04-14 9:53:24&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201431475019925/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>PostgreSQL 9.4新增的一个功能, 允许设置了安全栅栏标签的"简单"视图和未设置"安全栅栏"的视图一样自动更新.</div><div><span style="line-height: 28px;"   >简单视图自动更新引入自9.3版本, 具体可参考</span></div><div><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020134922356437/"   >http://blog.163.com/digoal@126/blog/static/16387704020134922356437/</a></div><div>9.4 新增该项功能的简要说明 :&nbsp;</div><div><pre class="prettyprint"   ><div><font size="2"   >Make security barrier views automatically updatable</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Views which are marked as security_barrier must have their quals</font></div><div><font size="2"   >applied before any user-defined quals are called, to prevent</font></div><div><font size="2"   >user-defined functions from being able to see rows which the</font></div><div><font size="2"   >security barrier view is intended to prevent them from seeing.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Remove the restriction on security barrier views being automatically</font></div><div><span style="line-height: 28px;"   ><font size="2"   >updatable by adding a new securityQuals list to the RTE structure</font></span></div><div><font size="2"   >which keeps track of the quals from security barrier views at each</font></div><div><font size="2"   >level, independently of the user-supplied quals. &nbsp;When RTEs are</font></div><div><font size="2"   >later discovered which have securityQuals populated, they are turned</font></div><div><font size="2"   >into subquery RTEs which are marked as security_barrier to prevent</font></div><div><font size="2"   >any user-supplied quals being pushed down (modulo LEAKPROOF quals).</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Dean Rasheed, reviewed by Craig Ringer, Simon Riggs, KaiGai Kohei</font></div><p></p></pre></div></div><div>除了使用安全栅栏, 其实如果where条件中的操作符标记为LEAKPROOF, 那么都会在用户传入的任何where 条件之前被评估.</div><div>所以不存在<span style="line-height: 28px;"   >利用cbo和function进行</span><span style="line-height: 28px;"   >视图攻击的可能性(</span><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201361031431669/"   >http://blog.163.com/digoal@126/blog/static/163877040201361031431669/</a><span style="line-height: 28px;"   >).</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >If an automatically updatable view is marked with the security_barrier property then all the view's WHERE conditions (and any conditions using operators which are marked as LEAKPROOF) will always be evaluated before any conditions that a user of the view has added. See Section 38.5 for full details.&nbsp;</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >Note that, due to this, rows which are not ultimately returned (because they do not pass the user's WHERE conditions) may still end up being locked.&nbsp;</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >EXPLAIN can be used to see which conditions are applied at the relation level (and therefore do not lock rows) and which are not.</font></span></div><p></p></pre></div><div><span style="line-height: 28px;"   >但是需要注意, 使用安全栅栏的视图, 或者视图中存在的leakproof操作符对应的where 条件在用户传入的where条件前被评估.</span></div><div><span style="line-height: 28px;"   >所以在对这类视图执行DML操作时, 锁的行数可能比普通视图要多, 使用explain可以看到具体锁了哪些行.</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   ><div>+-- security barrier view</div><div>+CREATE TABLE base_tbl (person text, visibility text);</div><div>+INSERT INTO base_tbl VALUES ('Tom', 'public'),</div><div>+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;('Dick', 'private'),</div><div>+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;('Harry', 'public');</div><div>+CREATE VIEW rw_view1 AS</div><div>+ &nbsp;SELECT person FROM base_tbl WHERE visibility = 'public';</div><div>+CREATE FUNCTION snoop(anyelement)</div><div>+RETURNS boolean AS</div><div>+$$</div><div>+BEGIN</div><div>+ &nbsp;RAISE NOTICE 'snooped value: %', $1;</div><div>+ &nbsp;RETURN true;</div><div>+END;</div><div>+$$</div><div>+LANGUAGE plpgsql COST 0.000001;</div><div>+CREATE OR REPLACE FUNCTION leakproof(anyelement)</div><div>+RETURNS boolean AS</div><div>+$$</div><div>+BEGIN</div><div>+ &nbsp;RETURN true;</div><div>+END;</div><div>+$$</div><div>+LANGUAGE plpgsql STRICT IMMUTABLE LEAKPROOF;</div><div><br></div></font></span></div><div><div><font size="2"   >+EXPLAIN (costs off) UPDATE rw_view1 SET person=person WHERE snoop(person);</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >+-----------------------------------------------------</font></div><div><font size="2"   >+ Update on base_tbl base_tbl_1</font></div><div><font size="2"   >+ &nbsp; -&gt; &nbsp;Subquery Scan on base_tbl &nbsp;&nbsp;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; Filter: snoop(base_tbl.person) &nbsp;-- 这个条件是用户传入的, 在评估安全栅栏条件后执行过滤, 所以自动添加子查询.</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; -&gt; &nbsp;Seq Scan on base_tbl base_tbl_2</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Filter: (visibility = 'public'::text) &nbsp; &nbsp;-- 这个条件是relation级别的. 不属于被锁的范围. 可以使用pgrowlocks插件查看.</font></div><div><font size="2"   >+(5 rows)</font></div></div><p></p></pre></div><div>对于leakproof函数, 需要注意它的规则重写, 也可能成为攻击点.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >The query planner has more flexibility when dealing with functions that have no side effects. Such functions are referred to as LEAKPROOF, and include many simple, commonly used operators, such as many equality operators. The query planner can safely allow such functions to be evaluated at any point in the query execution process, since invoking them on rows invisible to the user will not leak any information about the unseen rows. In contrast, a function that might throw an error depending on the values received as arguments (such as one that throws an error in the event of overflow or division by zero) are not leak-proof, and could provide significant information about the unseen rows if applied before the security view's row filters.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >It is important to understand that even a view created with the security_barrier option is intended to be secure only in the limited sense that the contents of the invisible tuples will not be passed to possibly-insecure functions. The user may well have other means of making inferences about the unseen data; for example, they can see the query plan using EXPLAIN, or measure the run time of queries against the view. A malicious attacker might be able to infer something about the amount of unseen data, or even gain some information about the data distribution or most common values (since these things may affect the run time of the plan; or even, since they are also reflected in the optimizer statistics, the choice of plan). If these types of "covert channel" attacks are of concern, it is probably unwise to grant any access to the data at all.</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201363141544732"   >http://blog.163.com/digoal@126/blog/static/163877040201363141544732</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020134922356437/"   >http://blog.163.com/digoal@126/blog/static/16387704020134922356437/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-createview.html"   >http://www.postgresql.org/docs/devel/static/sql-createview.html</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/rules-privileges.html"   >http://www.postgresql.org/docs/devel/static/rules-privileges.html</a></div><div>5.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=842faa714c0454d67e523f5a0b6df6500e9bc1a5"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=842faa714c0454d67e523f5a0b6df6500e9bc1a5</a></div><div>6.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-createfunction.html"   >http://www.postgresql.org/docs/devel/static/sql-createfunction.html</a></div><div>7.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201361031431669/"   >http://blog.163.com/digoal@126/blog/static/163877040201361031431669/</a></div><div>8.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >--- a/doc/src/sgml/ref/create_view.sgml</font></div><div><font size="2"   >+++ b/doc/src/sgml/ref/create_view.sgml</font></div></div><div><div><font size="2"   >@@ -323,12 +323,6 @@ CREATE VIEW vista AS SELECT text 'Hello World' AS hello;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; or set-returning functions.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;&lt;/para&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;/listitem&gt;</font></div><div><font size="2"   >-</font></div><div><font size="2"   >- &nbsp; &nbsp; &lt;listitem&gt;</font></div><div><font size="2"   >- &nbsp; &nbsp; &nbsp;&lt;para&gt;</font></div><div><font size="2"   >- &nbsp; &nbsp; &nbsp; The view must not have the &lt;literal&gt;security_barrier&lt;/&gt; property.</font></div><div><font size="2"   >- &nbsp; &nbsp; &nbsp;&lt;/para&gt;</font></div><div><font size="2"   >- &nbsp; &nbsp; &lt;/listitem&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;&lt;/itemizedlist&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;/para&gt;</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >@@ -362,6 +356,19 @@ CREATE VIEW vista AS SELECT text 'Hello World' AS hello;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;/para&gt;</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;para&gt;</font></div><div><font size="2"   >+ &nbsp; &nbsp;If an automatically updatable view is marked with the</font></div><div><font size="2"   >+ &nbsp; &nbsp;&lt;literal&gt;security_barrier&lt;/&gt; property then all the view's &lt;literal&gt;WHERE&lt;/&gt;</font></div><div><font size="2"   >+ &nbsp; &nbsp;conditions (and any conditions using operators which are marked as LEAKPROOF)</font></div><div><font size="2"   >+ &nbsp; &nbsp;will always be evaluated before any conditions that a user of the view has</font></div><div><font size="2"   >+ &nbsp; &nbsp;added. &nbsp; See &lt;xref linkend="rules-privileges"&gt; for full details. &nbsp;Note that,</font></div><div><font size="2"   >+ &nbsp; &nbsp;due to this, rows which are not ultimately returned (because they do not</font></div><div><font size="2"   >+ &nbsp; &nbsp;pass the user's &lt;literal&gt;WHERE&lt;/&gt; conditions) may still end up being locked.</font></div><div><font size="2"   >+ &nbsp; &nbsp;&lt;command&gt;EXPLAIN&lt;/command&gt; can be used to see which conditions are</font></div><div><font size="2"   >+ &nbsp; &nbsp;applied at the relation level (and therefore do not lock rows) and which are</font></div><div><font size="2"   >+ &nbsp; &nbsp;not.</font></div><div><font size="2"   >+ &nbsp; &lt;/para&gt;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; &lt;para&gt;</font></div></div><p></p></pre></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL 9.4 Make security barrier views automatically updatable - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>