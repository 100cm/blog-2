<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">performance tuning about multi-rows query aggregated to single-row query.</h2>
	<h5 id="">2012-12-17 17:12:42&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201211174617734/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">线上有一个这样的表 :&nbsp;<div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# \d recommendation_mpt</font></div><div><font size="2"  >&nbsp; &nbsp;Column &nbsp; &nbsp;| &nbsp;Type &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"  >-------------+---------+-----------</font></div><div><font size="2"  >&nbsp;user_id &nbsp; &nbsp; | text &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;app_id &nbsp; &nbsp; &nbsp;| numeric |&nbsp;</font></div><div><font size="2"  >&nbsp;rating &nbsp; &nbsp; &nbsp;| numeric |&nbsp;</font></div><p></p></pre></div><div>记录了用户ID以及每个APP_ID对应的推荐比率.</div><div>这部分数据是由数据仓库每天生成并插入到生产环境的, 所以生产中以读为主, 没有写操作. 本文也是针对读进行的优化.</div><div>程序在向用户推荐APP_ID时，根据rating进行排序, rating越大, 推荐越排在前面。</div><div>SQL如下 :&nbsp;</div><div>数据库排序 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >select user_id,app_id from&nbsp;<span style="line-height: 22px;"  >recommendation_mpt where user_id=$1 order by rating desc;</span></font></p></pre></div><div><span style="line-height: 22px;"  >或者程序取到数据后进行排序 :&nbsp;</span></div><div><pre class="prettyprint"  ><p><font size="2"  ><span style="line-height: 22px;"  >select user_id,app_id from&nbsp;</span><span style="line-height: 22px;"  >recommendation_mpt where user_id=$1;</span></font></p></pre></div><div>假如每个用户保留50条app_id的信息, 1亿用户的话需要50亿条记录, 来存储这部分信息.</div><div>不管是数据库排还是程序排序. 以上SQL都要取出50条记录, 走user_id索引的话也可能需要大量的离散IO。</div><div>比较合理的优化手段是每个用户记录1条信息, 用数组或text来存储app_id对应的rating信息.</div><div>如 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# \d recommendation_mpt_new</font></div><div><font size="2"  >&nbsp; &nbsp;Column &nbsp; &nbsp;| &nbsp;Type &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"  >-------------+---------+-----------</font></div><div><font size="2"  >&nbsp;user_id &nbsp; &nbsp; | text &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;recomm &nbsp; &nbsp; &nbsp;| text &nbsp; &nbsp;|&nbsp;</font></div><p></p></pre></div><div>这里涉及到聚合, 最好是排序后再聚合, 那么可以省去程序取出数据后再排序的过程.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >select user_id, array_agg( app_id || '_' || rating order by rating desc ) from&nbsp;<span style="line-height: 22px;"  >recommendation_mpt group by user_id;</span></font></p></pre></div><div><span style="line-height: 22px;"  >如果数组已经排好了顺序的话, 并且程序不需要用到rating时, 那么这个表只需要user_id和app_id字段.</span></div><div><pre class="prettyprint"  ><p><font size="2"  ><span style="line-height: 22px;"  >select user_id, array_agg( app_id order by rating desc ) from&nbsp;</span><span style="line-height: 22px;"  >recommendation_mpt group by user_id;</span></font></p></pre></div><div><span style="line-height: 22px;"  ><br></span></div><div><span style="line-height: 22px;"  >注 :&nbsp;</span></div><div>聚合函数支持order by是从9.0.1开始的 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >Release 9.0.1</font></div><div><font size="2"  >Release Date: 2010-10-04</font></div></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;* Allow aggregate functions to use ORDER BY (Andrew Gierth)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;For example, this is now supported: array_agg(a ORDER BY b). This</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;is useful with aggregates for which the order of input values is</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;significant, and eliminates the need to use a nonstandard subquery</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;to determine the ordering.</font></div><p></p></pre></div><div><br></div><div>性能测试 :&nbsp;</div></div><div>场景一、</div><div>100W用户, 每个用户41条记录(41和1000000不能整除, 比较好生成测试数据.) .&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create table&nbsp;<span style="line-height: 22px;"  >recommendation_mpt (user_id int8, app_id numeric, rating numeric);</span></font></div><div><font size="2"  ><span style="line-height: 22px;"  >insert into&nbsp;</span><span style="line-height: 22px;"  >recommendation_mpt select generate_series(1,1000000), generate_series(1,41), random();</span></font></div><div><font size="2"  >INSERT 0 41000000</font></div><div><font size="2"  >create index idx_<span style="line-height: 22px;"  >recommendation_mpt_1 on&nbsp;</span><span style="line-height: 22px;"  >recommendation_mpt</span><span style="line-height: 22px;"  >&nbsp;(user_id);</span></font></div><div><font size="2"  >digoal=&gt; explain select app_id from recommendation_mpt where user_id = 1 order by rating desc;<br>                                                 QUERY PLAN                                                 <br>------------------------------------------------------------------------------------------------------------<br> Sort  (cost=55.27..55.37 rows=41 width=16)<br>   Sort Key: rating<br>   -&gt;  Index Scan using idx_recommendation_mpt_1 on recommendation_mpt  (cost=0.00..54.17 rows=41 width=16)<br>         Index Cond: (user_id = 1)<br>(4 rows)</font></div></pre></div><div>测试脚本:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >vi digoal.sql</font></div><div><font size="2"  >\setrandom user_id 1 1000000</font></div><div><font size="2"  >select app_id from&nbsp;<span style="line-height: 22px;"  >recommendation_mpt</span><span style="line-height: 22px;"  >&nbsp;where user_id = :user_id order by rating desc;</span></font></div></pre></div><div>测试结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -n -r -c 16 -j 4 -f ./digoal.sql -T 60 -h $PGDATA -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 16</font></div><div><font size="2"  >number of threads: 4</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 507317</font></div><div><font size="2"  >tps = 8447.554947 (including connections establishing)</font></div><div><font size="2"  >tps = 8450.407448 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002683 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom user_id 1 1000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 1.887224 &nbsp; &nbsp; &nbsp; &nbsp;select app_id from recommendation_mpt where user_id = :user_id order by rating desc;</font></div><p></p></pre></div><div>场景一的优化 : 建立索引避免rating排序的开销.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create index idx_<span style="line-height: 22px;"  >recommendation_mpt_2 on </span><span style="line-height: 19px;"  >&nbsp;</span><span style="line-height: 22px;"  >recommendation_mpt (user_id, rating, app_id);</span></font></div><div><font size="2"  >digoal=&gt; set enable_sort=off;<br>SET<br>digoal=&gt; explain select app_id from recommendation_mpt where user_id = 1 order by rating desc;<br>                                                     QUERY PLAN                                                     <br>--------------------------------------------------------------------------------------------------------------------<br> Index Only Scan Backward using idx_recommendation_mpt_2 on recommendation_mpt  (cost=0.00..64.33 rows=42 width=16)<br>   Index Cond: (user_id = 1)<br>(2 rows)</font></div><p></p></pre></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >vi $PGDATA/postgresql.conf</font></div><div><font size="2"  >enable_sort = off</font></div><div><font size="2"  >ocz@db-172-16-3-150-&gt; pg_ctl reload</font></div><div><font size="2"  >server signaled</font></div><p></p></pre></div><div>在此测试后的结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -n -r -c 16 -j 4 -f ./digoal.sql -T 60 -h $PGDATA -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 16</font></div><div><font size="2"  >number of threads: 4</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 515758</font></div><div><font size="2"  >tps = 8587.821833 (including connections establishing)</font></div><div><font size="2"  >tps = 8590.411963 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002724 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom user_id 1 1000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 1.856069 &nbsp; &nbsp; &nbsp; &nbsp;select app_id from recommendation_mpt where user_id = :user_id order by rating desc;</font></div><p></p></pre></div><div><br></div><div>场景二、</div><div><span style="line-height: 22px;"  >100W用户, 每个用户1条聚合并排序好的记录.</span></div><div><div><pre class="prettyprint"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  >create table&nbsp;<span style="line-height: 22px;"  >recommendation_mpt_new ( user_id int8, app_id numeric[] );</span></font></div><div style="line-height: 22px;"  ><font size="2"  ><span style="line-height: 22px;"  >insert into&nbsp;</span><span style="line-height: 22px;"  >recommendation_mpt_new select user_id, array_agg(app_id order by rating desc) &nbsp;from&nbsp;</span><span style="line-height: 22px;"  >&nbsp;</span><span style="line-height: 22px;"  >recommendation_mpt&nbsp;</span><span style="line-height: 22px;"  >group by user_id;</span></font></div><div><font size="2"  >INSERT 0 1000000</font></div><div><font size="2"  >digoal=&gt; select * from recommendation_mpt_new limit 5;<br> user_id |                                                       app_id                                                        <br>---------+---------------------------------------------------------------------------------------------------------------------<br>       1 | {16,19,9,8,35,20,31,40,28,7,5,15,36,10,13,11,34,24,32,38,26,39,6,18,30,29,3,12,17,37,25,22,27,1,2,41,4,21,33,23,14}<br>       2 | {24,33,17,3,20,29,41,38,27,39,4,19,2,28,9,15,11,1,32,10,13,30,31,37,18,21,5,7,12,14,16,6,40,22,36,23,25,8,35,26,34}<br>       3 | {18,22,14,20,26,35,34,8,1,16,11,41,15,30,27,21,19,7,3,5,9,13,17,4,40,10,23,32,6,24,28,31,12,36,38,29,25,2,37,39,33}<br>       4 | {9,27,37,2,41,38,1,31,30,3,32,28,26,7,40,10,4,34,6,21,12,14,24,5,20,13,33,23,35,11,16,18,22,17,19,8,39,29,36,15,25}<br>       5 | {35,9,39,27,11,23,18,24,13,5,10,36,22,1,34,16,7,28,20,38,4,26,21,8,17,2,32,15,41,33,31,29,30,40,14,25,6,37,19,12,3}<br>(5 rows)</font></div><div><font size="2"  >digoal=&gt; select * from recommendation_mpt where user_id=1 order by rating desc;<br> user_id | app_id |       rating       <br>---------+--------+--------------------<br>       1 |     16 |  0.996264576911926<br>       1 |     19 |  0.988723468966782<br>       1 |      9 |  0.988221516367048<br>       1 |      8 |  0.962889738380909<br>       1 |     35 |  0.957569351885468<br>       1 |     20 |   0.94144273782149<br>       1 |     31 |  0.929523797240108<br>       1 |     40 |  0.889733758755028<br>       1 |     28 |  0.851767126005143<br>       1 |      7 |  0.848528668750077<br>       1 |      5 |  0.840631154365838<br>       1 |     15 |  0.822692712768912<br>       1 |     36 |  0.819620195310563<br>       1 |     10 |  0.706364229787141<br>       1 |     13 |  0.698610578197986<br>       1 |     11 |  0.695095229428262<br>       1 |     34 |  0.673047889955342<br>       1 |     24 |  0.660528331529349<br>       1 |     32 |  0.647978096734732<br>       1 |     38 |  0.636633691377938<br>       1 |     26 |  0.592413422185928<br>       1 |     39 |  0.501070868223906<br>       1 |      6 |  0.491314855404198<br>       1 |     18 |  0.471619851421565<br>       1 |     30 |  0.466300643049181<br>       1 |     29 |  0.457061214838177<br>       1 |      3 |  0.325578296091408<br>       1 |     12 |  0.310081131756306<br>       1 |     17 |  0.305294726509601<br>       1 |     37 |   0.26613838179037<br>       1 |     25 |  0.251236057840288<br>       1 |     22 |  0.237996113952249<br>       1 |     27 |   0.22669791476801<br>       1 |      1 |  0.217828437685966<br>       1 |      2 |  0.200171065982431<br>       1 |     41 |  0.197947917506099<br>       1 |      4 |  0.189090229570866<br>       1 |     21 |  0.182843111455441<br>       1 |     33 |  0.131565005518496<br>       1 |     23 |  0.106283554807305<br>       1 |     14 | 0.0274284891784191<br>(41 rows)</font></div><div style="line-height: 22px;"  ><font size="2"  >create index idx_<span style="line-height: 22px;"  >recommendation_mpt_new_1 on&nbsp;</span><span style="line-height: 22px;"  >recommendation_mpt_new</span><span style="line-height: 22px;"  >&nbsp;(user_id);</span></font></div><div><font size="2"  >digoal=&gt; explain select app_id from recommendation_mpt_new where user_id = 1;<br>                                                 QUERY PLAN                                                  <br>-------------------------------------------------------------------------------------------------------------<br> Index Scan using idx_recommendation_mpt_new_1 on recommendation_mpt_new  (cost=0.00..2.54 rows=1 width=352)<br>   Index Cond: (user_id = 1)<br>(2 rows)</font></div></pre></div><div style="line-height: 22px;"  >测试脚本:</div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >\setrandom user_id 1 1000000</font></div><div style="line-height: 22px;"  ><font size="2"  >select app_id from&nbsp;<span style="line-height: 22px;"  >recommendation_mpt_new</span><span style="line-height: 22px;"  >&nbsp;where user_id = :user_id;</span></font></div></pre></div></div><div>测试结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -n -r -c 16 -j 4 -f ./digoal.sql -T 60 -h $PGDATA -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 16</font></div><div><font size="2"  >number of threads: 4</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 4700467</font></div><div><font size="2"  >tps = 78296.696341 (including connections establishing)</font></div><div><font size="2"  >tps = 78327.675964 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.001730 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom user_id 1 1000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.200860 &nbsp; &nbsp; &nbsp; &nbsp;select app_id from recommendation_mpt_new where user_id = :user_id;</font></div><p></p></pre></div><div><br></div><div>【小结】</div><div>1. &nbsp;将多行聚合成1行后, 查询性能从8590 qps提升到78327 qps .</div><div>2. &nbsp;另一篇介绍PostgreSQL aggregate的文章 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020121118112533410/"  >http://blog.163.com/digoal@126/blog/static/16387704020121118112533410/</a></div><div><wbr></div></div></div>
	</div>
</div>
</body>
</html>