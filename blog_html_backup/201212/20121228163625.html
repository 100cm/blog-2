<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL json_accessors</h2>
	<h5 id="">2012-12-28 16:36:25&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012112832614918/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.2开始引入了json数据类型, 目前数据库自带的支持操作还比较少. 只有2个函数如下 :&nbsp;</div><div><p style="font-size: 12px; line-height: 1.5em; margin: 1.2em 0em; font-weight: bold; font-family: verdana, sans-serif;"  >Table 9-39. JSON Support Functions</p><table border="1"  style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; background-color: rgb(224, 236, 239); border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12px; line-height: normal; text-align: left;"  ><colgroup><col><col><col><col><thead><tr><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"  >Function</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"  >Description</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"  >Example</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"  >Example Result</th></tr></thead><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"  ><tt>array_to_json(anyarray [, pretty_bool])</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"  >Returns the array as JSON. A PostgreSQL multidimensional array becomes a JSON array of arrays. Line feeds will be added between dimension 1 elements if&nbsp;<tt>pretty_bool</tt>&nbsp;is true.</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"  ><tt>array_to_json('{{1,5},{99,100}}'::int[])</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"  ><tt>[[1,5],[99,100]]</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"  ><tt>row_to_json(record [, pretty_bool])</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"  >Returns the row as JSON. Line feeds will be added between level 1 elements if&nbsp;<tt>pretty_bool</tt>&nbsp;is true.</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"  ><tt>row_to_json(row(1,'foo'))</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"  ><tt>{"f1":1,"f2":"foo"}</tt></td></tr></table></div><div>前段时间写过一篇关于javascript转用PostgreSQL 函数语言来实现的文章,&nbsp;</div><div><a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201293082737559/"  >http://blog.163.com/digoal@126/blog/static/163877040201293082737559/</a></div><div>文中使用了普通的表, 虽然实现了与mongoDB中同样的功能, 但是丢失了mongoDB的数据非结构化的弹性, 例如日志的格式变更, PostgreSQL中就需要修改表结构.</div><div>要规避这个结构化的限制, 可以选择使用json类型或者text类型.</div><div>本文针对text类型展开讲解. 使用json_accessors这个插件来实现对text类型存储json格式的数据进行分析.</div><div>【安装】</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >wget http://api.pgxn.org/dist/json_accessors/1.3.5/json_accessors-1.3.5.zip</font></div><div><font size="2"  >unzip json_accessors-1.3.5.zip</font></div><div><font size="2"  >mv json_accessors-1.3.5 postgresql-9.2.1/contrib/</font></div><div><font size="2"  >su - root</font></div><div><font size="2"  >. /home/ocz/.bash_profile</font></div><div><font size="2"  >cd /home/ocz/<span style="line-height: 22px;"  >postgresql-9.2.1/contrib/j</span><span style="line-height: 22px;"  >son_accessors-1.3.5</span></font></div><div><font size="2"  >gmake clean</font></div><div><font size="2"  >gmake</font></div><div><font size="2"  >gmake install</font></div><div><font size="2"  >su - ocz</font></div><div><div><font size="2"  >ocz@db-172-16-3-150-&gt; psql</font></div><div><font size="2"  >psql (9.2.1)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  >postgres=# \c digoal postgres</font></div><div><font size="2"  >You are now connected to database "digoal" as user "postgres".</font></div><div><font size="2"  >digoal=# create extension json_accessors;</font></div><div><font size="2"  >CREATE EXTENSION</font></div></div><p></p></pre></div><div><br></div><div>SQL脚本内容如下 :&nbsp;</div><div>包含所有支持的操作函数.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >$PGHOME/share/extension/json_accessors--1.3.5.sql</font></div><div><div><font size="2"  >/* json_accessors.sql */</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >-- complain if script is sourced in psql, rather than via CREATE EXTENSION</font></div><div><font size="2"  >\echo Use "create extension json_accessors" to load this file. \quit</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >-- must be run as a normal user</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >-- Scalar functions</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >-- JSON builder</font></div><div><font size="2"  >create or replace function json_get_object(text, text) returns text</font></div><div><font size="2"  >&nbsp;as 'MODULE_PATHNAME' language C immutable strict;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function json_get_text(text, text) returns text</font></div><div><font size="2"  >&nbsp;as 'MODULE_PATHNAME' language C immutable strict;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function json_get_boolean(text, text) returns boolean</font></div><div><font size="2"  >&nbsp;as 'MODULE_PATHNAME' language C immutable strict;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function json_get_int(text, text) returns int</font></div><div><font size="2"  >&nbsp;as 'MODULE_PATHNAME' language C immutable strict;&nbsp;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function json_get_bigint(text, text) returns bigint</font></div><div><font size="2"  >&nbsp;as 'MODULE_PATHNAME' language C immutable strict;&nbsp;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function json_get_numeric(text, text) returns numeric</font></div><div><font size="2"  >&nbsp;as 'MODULE_PATHNAME' language C immutable strict;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function json_get_timestamp(text, text) returns timestamp without time zone</font></div><div><font size="2"  >&nbsp;as 'MODULE_PATHNAME' language C immutable strict;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >-- Array functions</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function json_array_to_object_array(text) returns text[]</font></div><div><font size="2"  >&nbsp;as 'MODULE_PATHNAME' language C immutable strict;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function json_array_to_text_array(text) returns text[]</font></div><div><font size="2"  >&nbsp;as 'MODULE_PATHNAME' language C immutable strict;&nbsp;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function json_array_to_boolean_array(text) returns boolean[]</font></div><div><font size="2"  >&nbsp;as 'MODULE_PATHNAME' language C immutable strict;&nbsp;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function json_array_to_int_array(text) returns int[]</font></div><div><font size="2"  >&nbsp;as 'MODULE_PATHNAME' language C immutable strict;&nbsp;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function json_array_to_bigint_array(text) returns bigint[]</font></div><div><font size="2"  >&nbsp;as 'MODULE_PATHNAME' language C immutable strict;&nbsp;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function json_array_to_numeric_array(text) returns numeric[]</font></div><div><font size="2"  >&nbsp;as 'MODULE_PATHNAME' language C immutable strict;&nbsp;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function json_array_to_timestamp_array(text) returns timestamp without time zone[]</font></div><div><font size="2"  >&nbsp;as 'MODULE_PATHNAME' language C immutable strict;&nbsp;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >-- Indirect array functions</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function json_get_object_array(text, text) returns text[]</font></div><div><font size="2"  >&nbsp;as 'MODULE_PATHNAME' language C immutable strict;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function json_get_text_array(text, text) returns text[]</font></div><div><font size="2"  >&nbsp;as 'MODULE_PATHNAME' language C immutable strict;&nbsp;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function json_get_boolean_array(text, text) returns boolean[]</font></div><div><font size="2"  >&nbsp;as 'MODULE_PATHNAME' language C immutable strict;&nbsp;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function json_get_int_array(text, text) returns int[]</font></div><div><font size="2"  >&nbsp;as 'MODULE_PATHNAME' language C immutable strict;&nbsp;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function json_get_bigint_array(text, text) returns bigint[]</font></div><div><font size="2"  >&nbsp;as 'MODULE_PATHNAME' language C immutable strict;&nbsp;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function json_get_numeric_array(text, text) returns numeric[]</font></div><div><font size="2"  >&nbsp;as 'MODULE_PATHNAME' language C immutable strict;&nbsp;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function json_get_timestamp_array(text, text) returns timestamp without time zone[]</font></div><div><font size="2"  >&nbsp;as 'MODULE_PATHNAME' language C immutable strict;&nbsp;</font></div></div><p></p></pre></div><div><br></div><div>【使用举例】</div><div>测试表 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt;&nbsp;create table json_text_test (info text);</font></p></pre></div><div><br></div><div>测试数据 :&nbsp;</div><div>就用前面一篇BLOG的数据, 但是需要把timestamp的格式修改一下, 否则parse格式会报错.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt;&nbsp;insert into json_text_test values ('{</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "timestamp" : "2012-10-29T17:22:47.616Z",</font></div><div><font size="2"  ><span> </span>"level" : "INFO",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "thread" : "DubboServerHandler-thread-183",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "message" : "unknow tag:212, just ignore.",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "loggerName" : {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "fullyQualifiedClassName" : "stc.skymobi.bean.tlv.decode.decoders.BeanTLVDecoder",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "package" : [</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "stc",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "skymobi",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "bean",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "tlv",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "decode",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "decoders",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "BeanTLVDecoder"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ],</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "className" : "BeanTLVDecoder"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; },</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "fileName" : "BeanTLVDecoder.java",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "method" : "decode",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "lineNumber" : "93",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "class" : {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "fullyQualifiedClassName" : "stc.skymobi.bean.tlv.decode.decoders.BeanTLVDecoder",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "package" : [</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "stc",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "skymobi",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "bean",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "tlv",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "decode",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "decoders",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "BeanTLVDecoder"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ],</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "className" : "BeanTLVDecoder"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; },</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "host" : {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "process" : "20592@10_10_10_130.localdomain",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "name" : "10_10_10_130.localdomain",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ip" : "10.10.10.130"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >}');</font></div><p></p></pre></div><div><br></div><div>测试数据获取 :&nbsp;</div><div>获取text值 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select ctid,json_get_text(info, 'message') from json_text_test;</font></div><div><font size="2"  >&nbsp;ctid &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;json_get_text &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >-------+------------------------------</font></div><div><font size="2"  >&nbsp;(0,1) | unknow tag:212, just ignore.</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>获取int值 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select ctid,json_get_text(info, 'lineNumber') from json_text_test;</font></div><div><font size="2"  >&nbsp;ctid &nbsp;| json_get_text&nbsp;</font></div><div><font size="2"  >-------+---------------</font></div><div><font size="2"  >&nbsp;(0,1) | 93</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>获取json子对象 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select ctid,json_get_object(info, 'loggerName') from json_text_test;</font></div><div><font size="2"  >&nbsp;ctid &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; json_get_object &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >-------+----------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;(0,1) | {"fullyQualifiedClassName":"stc.skymobi.bean.tlv.decode.decoders.BeanTLVDecoder","package":["stc","skymobi","bean","tlv","d</font></div><div><font size="2"  >ecode","decoders","BeanTLVDecoder"],"className":"BeanTLVDecoder"}</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>获取子对象中的对象 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select json_get_text(json_get_object(info, 'loggerName'),'classname') from json_text_test;</font></div><div><font size="2"  >&nbsp;json_get_text &nbsp;</font></div><div><font size="2"  >----------------</font></div><div><font size="2"  >&nbsp;BeanTLVDecoder</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>获取时间值 :&nbsp;</div><div>注意json_accessors提供的时间转换是12小时制的, 如果要24小时制, 可以改改代码.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select json_get_timestamp(info, 'timestamp') from json_text_test;</font></div><div><font size="2"  >ERROR: &nbsp;hour "17" is invalid for the 12-hour clock</font></div><div><font size="2"  >HINT: &nbsp;Use the 24-hour clock, or give an hour between 1 and 12.</font></div><p></p></pre></div><div>改一下json_accessors.c以下代码 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; /* format: yyyy-MM-dd HH:mm:ss */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; timestampWithTz = DirectFunctionCall2(to_timestamp,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PointerGetDatum(cstring_to_text(elem-&gt;valuestring)),</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PointerGetDatum(cstring_to_text("YYYY-MM-DD HH:MI:SS")));</font></div><p></p></pre></div><div>改成 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; /* format: yyyy-MM-dd HH24:mm:ss */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; timestampWithTz = DirectFunctionCall2(to_timestamp,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PointerGetDatum(cstring_to_text(elem-&gt;valuestring)),</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PointerGetDatum(cstring_to_text("YYYY-MM-DD HH24:MI:SS")));</font></div><p></p></pre></div><div>重新编译一下 :&nbsp;</div><div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >su - root</font></div><div style="line-height: 22px;"  ><font size="2"  >. /home/ocz/.bash_profile</font></div><div style="line-height: 22px;"  ><font size="2"  >cd /home/ocz/<span style="line-height: 22px;"  >postgresql-9.2.1/contrib/j</span><span style="line-height: 22px;"  >son_accessors-1.3.5</span></font></div><div style="line-height: 22px;"  ><font size="2"  >gmake clean</font></div><div style="line-height: 22px;"  ><font size="2"  >gmake</font></div><div style="line-height: 22px;"  ><font size="2"  >gmake install</font></div><p></p></pre></div></div><div style="line-height: 22px;"  >再次执行正常 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select json_get_timestamp(info, 'timestamp') from json_text_test;</font></div><div><font size="2"  >&nbsp;json_get_timestamp &nbsp;</font></div><div><font size="2"  >---------------------</font></div><div><font size="2"  >&nbsp;2012-10-29 17:22:47</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>索引测试 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; create index idx_json_text_test_1 on json_text_test ( json_get_timestamp(info, 'timestamp'));</font></div><div><font size="2"  >CREATE INDEX</font></div></div><div><div><font size="2"  >digoal=&gt; explain analyze select * from json_text_test where json_get_timestamp(info, 'timestamp') &gt;= '2012-12-12 09:00:00';</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp;&nbsp;</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Index Scan using idx_json_text_test_1 on json_text_test &nbsp;(cost=0.00..2.27 rows=1 width=32) (actual time=0.015..0.015 rows=0 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp;Index Cond: (json_get_timestamp(info, 'timestamp'::text) &gt;= '2012-12-12 09:00:00'::timestamp without time zone)</font></div><div><font size="2"  >&nbsp;Total runtime: 0.051 ms</font></div></div><p></p></pre></div><div><br></div><div>【小结】</div><div>1. 使用text类型提高了弹性, 增加日志输出的属性不需要修改表结构.</div><div>例如 :&nbsp;</div><div>在以上json类型中增加1个mod_time属性, 不需要改表结构, 直接插入就可以了.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >insert into json_text_test values ('{</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "mod_time" : "2012-10-30T07:22:47.616Z",</font></div><div><font size="2"  ><span> </span>"timestamp" : "2012-10-29T17:22:47.616Z",</font></div><div><font size="2"  ><span> </span>"level" : "INFO",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "thread" : "DubboServerHandler-thread-183",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "message" : "unknow tag:212, just ignore.",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "loggerName" : {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "fullyQualifiedClassName" : "stc.skymobi.bean.tlv.decode.decoders.BeanTLVDecoder",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "package" : [</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "stc",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "skymobi",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "bean",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "tlv",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "decode",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "decoders",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "BeanTLVDecoder"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ],</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "className" : "BeanTLVDecoder"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; },</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "fileName" : "BeanTLVDecoder.java",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "method" : "decode",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "lineNumber" : "93",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "class" : {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "fullyQualifiedClassName" : "stc.skymobi.bean.tlv.decode.decoders.BeanTLVDecoder",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "package" : [</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "stc",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "skymobi",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "bean",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "tlv",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "decode",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "decoders",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "BeanTLVDecoder"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ],</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "className" : "BeanTLVDecoder"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; },</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "host" : {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "process" : "20592@10_10_10_130.localdomain",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "name" : "10_10_10_130.localdomain",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ip" : "10.10.10.130"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >}');</font></div><p></p></pre></div><div>统计的SQL也不需要改变. 不会影响统计.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select json_get_timestamp(info, 'timestamp'),json_get_timestamp(info, 'mod_time') from json_text_test where json_get_timestamp(info, 'timestamp') &lt;= '2012-12-12 09:00:00';</font></div><div><font size="2"  >&nbsp;json_get_timestamp &nbsp;| json_get_timestamp &nbsp;</font></div><div><font size="2"  >---------------------+---------------------</font></div><div><font size="2"  >&nbsp;2012-10-29 17:22:47 | 2012-10-30 07:22:47</font></div><div><font size="2"  >&nbsp;2012-10-29 17:22:47 |&nbsp;</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div><br></div><div>【参考】</div><wbr><div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://sourceforge.net/projects/cjson/"  >http://sourceforge.net/projects/cjson/</a></div><div>2.&nbsp;<a target="_blank" rel="nofollow" href="http://people.planetpostgresql.org/andrew/index.php?/archives/249-Using-PLV8-to-index-JSON.html"  >http://people.planetpostgresql.org/andrew/index.php?/archives/249-Using-PLV8-to-index-JSON.html</a></div><div>3.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201293082737559/"  >http://blog.163.com/digoal@126/blog/static/163877040201293082737559/</a></div><div>4.&nbsp;<a target="_blank" rel="nofollow" href="https://github.com/alx3apps/postgresql-json-accessors"  >https://github.com/alx3apps/postgresql-json-accessors</a></div><div>5.&nbsp;<a target="_blank" rel="nofollow" href="http://pgxn.org/dist/json_accessors/"  >http://pgxn.org/dist/json_accessors/</a></div><div>6.&nbsp;<a target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=json-datatype.git;a=summary"  >http://git.postgresql.org/gitweb/?p=json-datatype.git;a=summary</a></div><div>7.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/functions-json.html"  >http://www.postgresql.org/docs/9.2/static/functions-json.html</a></div><div>8.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/datatype-json.html"  >http://www.postgresql.org/docs/9.2/static/datatype-json.html</a></div><div>9.&nbsp;<a target="_blank" rel="nofollow" href="http://www.ietf.org/rfc/rfc4627.txt"  >http://www.ietf.org/rfc/rfc4627.txt</a></div><div>10.&nbsp;<a target="_blank" rel="nofollow" href="http://pgxn.org/dist/plv8/"  >http://pgxn.org/dist/plv8/</a></div></div>
	</div>
</div>
</body>
</html>