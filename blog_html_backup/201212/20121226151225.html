<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">retalk PostgreSQL function's [ volatile|stable|immutable ]</h2>
	<h5 id="">2012-12-26 15:12:25&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201211241434248/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 函数的稳定性, 以前写过几篇BLOG讲述, 见参考部分.</div><div>本文再细化并举例说明一下他们的差别.</div><div>首先函数稳定性分三种 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >volatile</font></div><div><font size="2"  >stable</font></div><div><font size="2"  >immutable</font></div><p></p></pre></div><div><br></div><div>首先创建1个测试表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; create table test (id int, info text);</font></div><div><font size="2"  >CREATE TABLE</font></div></div><div><div><font size="2"  >digoal=&gt; insert into test select generate_series(1,100000),random()::text;</font></div><div><font size="2"  >INSERT 0 100000</font></div><div><font size="2"  >digoal=&gt; create index idx_test_1 on test(id);</font></div><div><font size="2"  >CREATE INDEX</font></div></div><p></p></pre></div><div>1. volatile指函数可以修改数据库, 函数参数值相同的情况下, 可以返回不同的结果, 所以volatile函数在执行过程中优化器对它的处理是每一行都需要执行一次volatile函数.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function f_volatile(i_id int) returns text as $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >&nbsp; result text;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >&nbsp; -- update可以用在volatile函数中, 因为UPDATE要修改数据</font></div><div><font size="2"  >&nbsp; update test set info='new' where id=i_id returning info into result;</font></div><div><font size="2"  >&nbsp; return result;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$ language plpgsql volatile;</font></div><p></p></pre></div><div>执行这个函数, 正常返回 :&nbsp;</div><div>如果是immutable或者stable的话, 将报错.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select * from f_volatile(1);</font></div><div><font size="2"  >&nbsp;f_volatile&nbsp;</font></div><div><font size="2"  >------------</font></div><div><font size="2"  >&nbsp;new</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>下面的函数用来返回一个NUMERIC, 然后进行sum运算.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function f_test() returns numeric as $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >&nbsp; return 1.5;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$ language plpgsql volatile;</font></div><p></p></pre></div><div>10W条记录, 执行f_test()耗时335毫秒.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 19px;"  >digoal=&gt; explain analyze select f_test() from test;<br>                                                  QUERY PLAN                                                  <br>--------------------------------------------------------------------------------------------------------------<br> Seq Scan on test  (cost=0.00..26638.00 rows=100000 width=0) (actual time=0.035..322.622 rows=100000 loops=1)<br> Total runtime: 334.539 ms<br>(2 rows)<br>Time: 335.035 ms</span></font></div><p></p></pre></div><div>记住这个执行耗时. 后面要对比f_test()改成stable和immutable后的执行耗时.</div><div>单条执行时间 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 19px;"  >digoal=&gt; select f_test();<br> f_test <br>--------<br>    1.5<br>(1 row)<br>Time: 0.192 ms</span></font></div><p></p></pre></div><div><br></div><div>2. stable 函数, 不允许修改数据库.&nbsp;</div><div>如下 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; alter function f_volatile(int) stable;</font></div><div><font size="2"  >ALTER FUNCTION</font></div><div><font size="2"  >Time: 0.660 ms</font></div><p></p></pre></div><div>再次执行f_volatile将报错, 因为stable的函数不允许执行修改数据库的SQL, 例如UPDATE.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select * from f_volatile(1);</font></div><div><font size="2"  >ERROR: &nbsp;UPDATE is not allowed in a non-volatile function</font></div><div><font size="2"  >CONTEXT: &nbsp;SQL statement "update test set info='new' where id=i_id returning info"</font></div><div><font size="2"  >PL/pgSQL function f_volatile(integer) line 5 at SQL statement</font></div><div><font size="2"  >Time: 0.869 ms</font></div><p></p></pre></div></div><div><br></div><div><div style="line-height: 22px;"  >同样的参数值, stable函数多次执行返回的结果应该一致.</div><div style="line-height: 22px;"  >因此优化器可以选择将多次调用stable函数改为一次调用.&nbsp;<span style="line-height: 22px;"  >stable函数作为where条件中的比较值是, 可以使用</span>索引. 因为走索引需要一个常量.</div></div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; alter function f_test() stable;</font></div><div><font size="2"  >ALTER FUNCTION</font></div></div><div><div><font size="2"  >digoal=&gt; explain analyze select * from test where id&lt;=f_test()::int;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Index Scan using idx_test_1 on test &nbsp;(cost=0.25..2.55 rows=1 width=21) (actual time=0.019..0.024 rows=2 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp;Index Cond: (id &lt;= (f_test())::integer)</font></div><div><font size="2"  >&nbsp;Total runtime: 0.054 ms</font></div><div><font size="2"  >(3 rows)</font></div><div><font size="2"  >Time: 0.926 ms</font></div></div><p></p></pre></div><div>改回volatile, 则不允许走索引. 如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; explain analyze select * from test where id&lt;=f_test()::int;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >---------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Seq Scan on test &nbsp;(cost=0.00..27138.00 rows=33333 width=21) (actual time=0.143..269.208 rows=2 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp;Filter: (id &lt;= (f_test())::integer)</font></div><div><font size="2"  >&nbsp; &nbsp;Rows Removed by Filter: 99998</font></div><div><font size="2"  >&nbsp;Total runtime: 269.242 ms</font></div><div><font size="2"  >(4 rows)</font></div><div><font size="2"  >Time: 269.937 ms</font></div><p></p></pre></div><div>另外一个测试是吧f_test()放到结果集部分, 而不是where条件里面, stable和immutable的差别也很大 :&nbsp;</div><div><div style="line-height: 22px; font-family: monospace; white-space: pre;"  ><pre class="prettyprint"  ><p></p><div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal=&gt; alter function f_test() stable;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >ALTER FUNCTION</font></div></div><div><div><font size="2"  >digoal=&gt; explain analyze select f_test() from test;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >--------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Seq Scan on test &nbsp;(cost=0.00..26638.00 rows=100000 width=0) (actual time=0.137..268.707 rows=100000 loops=1)</font></div><div><font size="2"  >&nbsp;Total runtime: 281.684 ms</font></div><div><font size="2"  >(2 rows)</font></div><div><font size="2"  >Time: 282.248 ms</font></div></div><div><font size="2"  ><br></font></div><div><font size="2"  >改成immutable</font></div><div><div><font size="2"  >digoal=&gt; alter function f_test() immutable;</font></div><div><font size="2"  >ALTER FUNCTION</font></div><div><font size="2"  >Time: 0.359 ms</font></div><div><font size="2"  >digoal=&gt; explain analyze select f_test() from test;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Seq Scan on test &nbsp;(cost=0.00..1638.00 rows=100000 width=0) (actual time=0.011..23.450 rows=100000 loops=1)</font></div><div><font size="2"  >&nbsp;Total runtime: 34.331 ms</font></div><div><font size="2"  >(2 rows)</font></div><div><font size="2"  >Time: 35.061 ms</font></div></div><p></p></pre></div></div><div><br></div><div>3. immutable, 和stable非常类似, 但是immutable是指在任何情况下, 只要参数一致, 结果就一致. 而在事务中参数一致则结果一致可以标记为stable而请你不要把它标记为immutable.</div><div>另外的显著的区别是优化器对immutable和stable函数的处理上.&nbsp;</div><div>如果函数的参数是常量的情况下 :&nbsp;</div><div>immutable函数在优化器生成执行计划时会将函数结果替换函数. 也就是函数不在输出的执行计划中, 取而代之的是一个结果常量.</div><div>stable函数则不会如此, 执行计划输出后还是函数.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >select * from test where id&gt; 1+2;</font></p></pre></div><div>+对应的操作符函数是immutable的, 所以这条SQL执行计划输出的是 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >select * from test where id&gt;3;</font></p></pre></div><div>对于用户自己创建的函数也是如此 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create or replace function f_test(i_id int) returns int as $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >&nbsp; return i_id;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$ language plpgsql immutable;</font></div><div><font size="2"  >CREATE FUNCTION</font></div><div><font size="2"  >Time: 1.020 ms</font></div><p></p></pre></div><div>immutable 测试 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; explain analyze select * from test where id&lt;f_test(50);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >--------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Index Scan using idx_test_1 on test &nbsp;(cost=0.00..3.15 rows=50 width=21) (actual time=0.007..0.025 rows=49 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp;Index Cond: (id &lt; 50)</font></div><div><font size="2"  >&nbsp;Total runtime: 0.058 ms</font></div><div><font size="2"  >(3 rows)</font></div></div><div><font size="2"  >注意这行 :&nbsp;</font></div><div><span style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp;Index Cond: (id &lt; 50), f_test(50)已经替换成了结果50.</font></span></div><p></p></pre></div><div>stable 测试 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; alter function f_test(int) stable;</font></div><div><font size="2"  >ALTER FUNCTION</font></div></div><div><div><font size="2"  >digoal=&gt; explain analyze select * from test where id&lt;f_test(50);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >--------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Index Scan using idx_test_1 on test &nbsp;(cost=0.25..3.40 rows=50 width=21) (actual time=0.019..0.035 rows=49 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp;Index Cond: (id &lt; f_test(50))</font></div><div><font size="2"  >&nbsp;Total runtime: 0.066 ms</font></div><div><font size="2"  >(3 rows)</font></div></div><div><div style="line-height: 22px;"  ><font size="2"  >注意这行 :&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  ><span style="line-height: 22px;"  >&nbsp; &nbsp;Index Cond: (id &lt; f_test(50))</span><span style="line-height: 22px;"  >, f_test(50)没有被替换掉.</span></font></div></div><p></p></pre></div><div>另外一组测试 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; alter function f_test(int) stable;</font></div><div><font size="2"  >ALTER FUNCTION</font></div><div><font size="2"  >digoal=&gt; explain analyze select * from test where f_test(2)&gt;1;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >-------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Result &nbsp;(cost=0.25..1638.25 rows=100000 width=21) (actual time=0.146..50.367 rows=100000 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp;One-Time Filter: (f_test(2) &gt; 1)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on test &nbsp;(cost=0.25..1638.25 rows=100000 width=21) (actual time=0.014..20.646 rows=100000 loops=1)</font></div><div><font size="2"  >&nbsp;Total runtime: 61.386 ms</font></div><div><font size="2"  >(4 rows)</font></div><p></p></pre></div><div>当f_test是stable 时,&nbsp;<span style="line-height: 22px;"  >比immutable多One-Time Filter: (f_test(2) &gt; 1)</span></div><div><br></div><div>而当immutable,<span style="line-height: 22px;"  >&nbsp;优化器则将</span><span style="line-height: 22px;"  >f_test(2)&gt;1这部分</span>直接优化掉了.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; alter function f_test(int) immutable;</font></div><div><font size="2"  >ALTER FUNCTION</font></div><div><font size="2"  >digoal=&gt; explain analyze select * from test where f_test(2)&gt;1;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >-------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Seq Scan on test &nbsp;(cost=0.00..1638.00 rows=100000 width=21) (actual time=0.011..18.801 rows=100000 loops=1)</font></div><div><font size="2"  >&nbsp;Total runtime: 29.839 ms</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div></div><div><br></div><div>【prepare statement 注意】</div><div>prepare statement请参考 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012112452432251/"  >http://blog.163.com/digoal@126/blog/static/1638770402012112452432251/</a></div><div>这里需要注意的是immutable函数, 如果你的函数实际上不是immutable的. 但是你把它标记为immutable了, 可能有意想不到的结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create or replace function immutable_random() returns numeric as $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >return random();</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$ language plpgsql immutable;</font></div><div><font size="2"  >CREATE FUNCTION</font></div><p></p></pre></div><div>创建一个prepare statement.</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; prepare p_test(int) as select $1,immutable_random();</font></div><div><font size="2"  >PREPARE</font></div><div><font size="2"  >Time: 0.473 ms</font></div><p></p></pre></div><div>执行这个prepared statement :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; execute p_test(1);</font></div><div><font size="2"  >&nbsp;?column? | immutable_random &nbsp;</font></div><div><font size="2"  >----------+-------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 1 | 0.277766926214099</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >Time: 0.398 ms</font></div><div><font size="2"  >digoal=&gt; execute p_test(1);</font></div><div><font size="2"  >&nbsp;?column? | immutable_random &nbsp;</font></div><div><font size="2"  >----------+-------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 1 | 0.974089733790606</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >Time: 0.209 ms</font></div><div><font size="2"  >digoal=&gt; execute p_test(1);</font></div><div><font size="2"  >&nbsp;?column? | immutable_random &nbsp;</font></div><div><font size="2"  >----------+-------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 1 | 0.800415104720742</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >Time: 0.212 ms</font></div><div><font size="2"  >digoal=&gt;&nbsp;</font></div><div><font size="2"  >digoal=&gt; execute p_test(1);</font></div><div><font size="2"  >&nbsp;?column? | immutable_random&nbsp;</font></div><div><font size="2"  >----------+------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 1 | 0.41237005777657</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >Time: 0.290 ms</font></div><div><font size="2"  >digoal=&gt; execute p_test(1);</font></div><div><font size="2"  >&nbsp;?column? | &nbsp;immutable_random &nbsp;</font></div><div><font size="2"  >----------+--------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 1 | 0.0541226323693991</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >Time: 0.211 ms</font></div><p></p></pre></div><div>第六次开始使用generic_plan, 而immutable function在plan时将被结果常量替换.&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; execute p_test(1);</font></div><div><font size="2"  >&nbsp;?column? | immutable_random &nbsp;</font></div><div><font size="2"  >----------+-------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 1 | 0.431490630842745</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >Time: 0.233 ms</font></div><p></p></pre></div><div>以后再执行这个prepare statement, immutable_random()部分都将得到同样的结果.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; execute p_test(1);</font></div><div><font size="2"  >&nbsp;?column? | immutable_random &nbsp;</font></div><div><font size="2"  >----------+-------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 1 | 0.431490630842745</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >Time: 0.165 ms</font></div><div><div><font size="2"  >digoal=&gt; execute p_test(2);</font></div><div><font size="2"  >&nbsp;?column? | immutable_random &nbsp;</font></div><div><font size="2"  >----------+-------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 2 | 0.431490630842745</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >Time: 0.273 ms</font></div><div><font size="2"  >digoal=&gt; execute p_test(3);</font></div><div><font size="2"  >&nbsp;?column? | immutable_random &nbsp;</font></div><div><font size="2"  >----------+-------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 3 | 0.431490630842745</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >Time: 0.149 ms</font></div></div><p></p></pre></div></div><div>而把immutable_random()改成volatile或者stable后, immutable_random()都将产生不同的结果, 不会发生以上情况.</div><div>因为他们在plan时函数不会被结果替换.</div><div>所以在prepare statement中使用immutable函数, 需要特别注意这个函数到底是不是真的是immutable的.</div><div><br></div><div>【MVCC 注意】</div><div>这里要注意的是volatile, stable, immutable这几种函数, 对数据的修改的可见性分两种情况.</div><div>volatile , 调用该函数的SQL对数据的修改, 可见.</div><div>stable, immutable ,&nbsp;<span style="line-height: 22px;"  >调用该函数的SQL对数据的修改, 不可见.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp;STABLE and IMMUTABLE functions use a snapshot established as of the start of the calling query,&nbsp;</font></div><div><div><font size="2"  >&nbsp;whereas VOLATILE functions obtain a fresh snapshot at the start of each query they execute.</font></div></div><p></p></pre></div><div>例如 :&nbsp;</div><div>创建测试表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create table test(id int,info text);</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >Time: 50.356 ms</font></div><div><font size="2"  >digoal=&gt; insert into test select 1,random()::text from generate_series(1,1000);</font></div><div><font size="2"  >INSERT 0 1000</font></div><div><font size="2"  >Time: 5.027 ms</font></div><p></p></pre></div><div>创建修改函数, 这个函数将在另一个函数中调用, 用来修改ID。</div><div>因为另一个函数是用perform f_mod(int)来修改数据, 所以另外一个函数可以改成volatile, stable, immutable任意.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create or replace function f_mod(i_id int) returns void as $$ &nbsp;&nbsp;</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >begin &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp; update test set id=i_id+1 where id=i_id;</font></div><div><font size="2"  >end; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >$$ language plpgsql volatile;</font></div><p></p></pre></div><div>测试稳定性的函数 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create or replace function f_test(i_id int) returns bigint as $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >&nbsp; result int8;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >&nbsp; perform f_mod(i_id);</font></div><div><font size="2"  >&nbsp; select count(*) into result from test where id=i_id;</font></div><div><font size="2"  >&nbsp; return result;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$ language plpgsql volatile;</font></div><p></p></pre></div><div><br></div><div>当稳定性=volatile时, 修改可以被<span style="font-family: monospace; font-size: small; line-height: 19px; white-space: pre;"  >select count(*) into result from test where id=i_id; 看到 : </span></div><div><span style="font-family: monospace; font-size: small; line-height: 19px; white-space: pre;"  >所以更新后结果为0 : </span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select f_test(1);</font></div><div><font size="2"  >&nbsp;f_test&nbsp;</font></div><div><font size="2"  >--------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>改成stable, 它看到的是SQL开始是的snapshot, 所以对修改不可见, 结果还是1000 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; alter function f_test(int) stable;</font></div><div><font size="2"  >ALTER FUNCTION</font></div><div><font size="2"  >digoal=&gt; select f_test(2);</font></div><div><font size="2"  >&nbsp;f_test&nbsp;</font></div><div><font size="2"  >--------</font></div><div><font size="2"  >&nbsp; &nbsp;1000</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >改成immutable, 它看到的是SQL开始是的snapshot, 所以对修改不可见, 结果还是1000 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; alter function f_test(int) immutable;</font></div><div><font size="2"  >ALTER FUNCTION</font></div><div><font size="2"  >digoal=&gt; select f_test(3);</font></div><div><font size="2"  >&nbsp;f_test&nbsp;</font></div><div><font size="2"  >--------</font></div><div><font size="2"  >&nbsp; &nbsp;1000</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div></div><div><br></div><div>还有一种情况是如果修改是来自函数体外部的修改, 那是否可见?</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create or replace function f_test(i_id int) returns bigint as $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >&nbsp; result int8;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >&nbsp; select count(*) into result from test where id=i_id; &nbsp;</font></div><div><font size="2"  >&nbsp; return result;</font></div><div><font size="2"  >end; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >$$ language plpgsql volatile;</font></div><div><font size="2"  >CREATE FUNCTION</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >看不到with的修改 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; alter function f_test(int) immutable;</font></div><div><font size="2"  >ALTER FUNCTION</font></div></div><div><div><font size="2"  >digoal=&gt; with t1 as (</font></div><div><font size="2"  >digoal(&gt; &nbsp; update test set id=id+1 where id=4</font></div><div><font size="2"  >digoal(&gt; )</font></div><div><font size="2"  >digoal-&gt; select f_test(4);</font></div><div><font size="2"  >&nbsp;f_test&nbsp;</font></div><div><font size="2"  >--------</font></div><div><font size="2"  >&nbsp; &nbsp;1000</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"  >看不到with的修改 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; alter function f_test(int) stable;</font></div><div><font size="2"  >ALTER FUNCTION</font></div></div><div><div><font size="2"  >digoal=&gt; with t1 as (</font></div><div><font size="2"  >&nbsp; update test set id=id+1 where id=5</font></div><div><font size="2"  >)</font></div><div><font size="2"  >select f_test(5);</font></div><div><font size="2"  >&nbsp;f_test&nbsp;</font></div><div><font size="2"  >--------</font></div><div><font size="2"  >&nbsp; &nbsp;1000</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div>看不到with的修改 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; alter function f_test(int) volatile;</font></div><div><font size="2"  >ALTER FUNCTION</font></div><div><font size="2"  >digoal=&gt; with t1 as ( &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; update test set id=id+1 where id=6</font></div><div><font size="2"  >)</font></div><div><font size="2"  >select f_test(6);</font></div><div><font size="2"  >&nbsp;f_test&nbsp;</font></div><div><font size="2"  >--------</font></div><div><font size="2"  >&nbsp; &nbsp;1000</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>在事务中时, 都能看到本事务在前面做的修改 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; alter function f_test(int) immutable;</font></div><div><font size="2"  >ALTER FUNCTION</font></div><div><font size="2"  >digoal=&gt; begin;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >digoal=&gt; update test set id=id+1 where id=13;</font></div><div><font size="2"  >UPDATE 1000</font></div><div><font size="2"  >digoal=&gt; select f_test(13);</font></div><div><font size="2"  >&nbsp;f_test&nbsp;</font></div><div><font size="2"  >--------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=&gt; select f_test(14);</font></div><div><font size="2"  >&nbsp;f_test&nbsp;</font></div><div><font size="2"  >--------</font></div><div><font size="2"  >&nbsp; &nbsp;1000</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=&gt; end;</font></div><div><font size="2"  >COMMIT</font></div><p></p></pre></div><div>volatile, stable测试略, 同上。</div><div><br></div><div>【其他】</div><div>1. 查看函数的稳定性 :&nbsp;</div><div><div>digoal=&gt; select proname,proargtypes,provolatile from pg_proc where proname='f_test';</div><div>&nbsp;proname | proargtypes | provolatile&nbsp;</div><div>---------+-------------+-------------</div><div>&nbsp;f_test &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | i</div><div>&nbsp;f_test &nbsp;| 23 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| i</div><div>(2 rows)</div><div>i表示immutable, s表示stable, v表示volatile.</div></div><div>2. 请按实际情况严格来标记一个函数的稳定性.</div><div>3. stable函数和immutable函数不能直接调用UPDATE这种修改数据库的SQL语句. 但是通过perform volatile function或者select volatile function还是会修改到数据, 因为PostgreSQL不会有更深层次的检查.</div><div><br></div>【参考】<wbr><div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/spi-spi-prepare.html"  >http://www.postgresql.org/docs/9.2/static/spi-spi-prepare.html</a></div><div>2.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/plpgsql-implementation.html"  >http://www.postgresql.org/docs/9.2/static/plpgsql-implementation.html</a></div><div>3.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/xfunc-volatility.html"  >http://www.postgresql.org/docs/9.2/static/xfunc-volatility.html</a></div><div>4.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201151011105494/"  >http://blog.163.com/digoal@126/blog/static/163877040201151011105494/</a></div><div>5.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201252641410920/"  >http://blog.163.com/digoal@126/blog/static/163877040201252641410920/</a></div><div>6.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/monitoring-stats.html"  >http://www.postgresql.org/docs/9.2/static/monitoring-stats.html</a></div><div>7.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012112452432251/"  >http://blog.163.com/digoal@126/blog/static/1638770402012112452432251/</a></div><div>8.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/sql-createfunction.html"  >http://www.postgresql.org/docs/9.2/static/sql-createfunction.html</a></div></div>
	</div>
</div>
</body>
</html>