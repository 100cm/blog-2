<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL convert text to decimal example</h2>
	<h5 id="">2012-12-10 10:26:49&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201211109465921/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>&nbsp; &nbsp; 这里要说的是把字符串转换成数字, 有些时候可能会用varchar来存储数值. 但是程序没有做保护的话, 可能就会存进非法数值了.</div><div>&nbsp; &nbsp; 例如'a100'</div><div>&nbsp; &nbsp; 要把这种text转换成数值的话, 可以使用规则表达式, 或者其他方法.</div><div><br></div><div>举例如下 :&nbsp;</div><div><br></div><div>&nbsp; &nbsp;1. to_number :&nbsp;</div><div>可以把合法的或者不合法的text转换成数值.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; digoal=# select to_number('123.1','000.0');</font></div><div><font size="2"  >&nbsp;to_number&nbsp;</font></div><div><font size="2"  >-----------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;123.1</font></div><div><font size="2"  >(1 row)</font></div><div><div><font size="2"  >&nbsp; digoal=# select to_number('abc123.1.a1','000000.000');</font></div><div><font size="2"  >&nbsp;to_number&nbsp;</font></div><div><font size="2"  >-----------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;123.1</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>&nbsp; 2. 规则表达式</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select substring('ab12.3fee4', '(([0-9])+(\.)?([0-9])*)');</font></div><div><font size="2"  >&nbsp;substring&nbsp;</font></div><div><font size="2"  >-----------</font></div><div><font size="2"  >&nbsp;12.3</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>&nbsp; 3. 外部函数</div><div>&nbsp; &nbsp; 可以自由发挥. 例如仅仅将数字抽取出来, 不管在哪个位置.</div><div><div style="line-height: 22px;"  >例如以下C程序是从字符串取出数字的一种方法 :&nbsp;</div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >[root@db-172-16-3-150 zzz]# cat a.c</font></div><div style="line-height: 22px;"  ><font size="2"  >#include &lt;stdio.h&gt;</font></div><div style="line-height: 22px;"  ><font size="2"  ><br style="line-height: 22px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  >int main (int argc, char * argv[]) {</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; unsigned long i, n;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; n = 0;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; if (argc != 2)</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; return 1;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; char *s = argv[1];</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; for (i = 0; s[i] != '\0'; ++i)</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; if (s[i] &gt;= '0' &amp;&amp; s[i] &lt;= '9')</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; &nbsp; n = 10 * n + (s[i] - '0');</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; fprintf(stdout, "n: %lu\n", n);</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; return 0;</font></div><div style="line-height: 22px;"  ><font size="2"  >}</font></div><div style="line-height: 22px;"  ><font size="2"  ><br style="line-height: 22px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  >[root@db-172-16-3-150 zzz]# gcc -O3 -Wall -Werror -Wextra -g ./a.c -o a</font></div><div style="line-height: 22px;"  ><font size="2"  ><br style="line-height: 22px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  >[root@db-172-16-3-150 zzz]# ./a abc123a1bfefw99132rjf32f39999</font></div><div style="line-height: 22px;"  ><font size="2"  >n: 1231991323239999</font></div><p></p></pre></div></div><div style="line-height: 22px;"  >写成PostgreSQL 函数如下 :&nbsp;</div><div><div>ocz@db-172-16-3-150-&gt; cat atoi_pg.c</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >/*</font></div><div><font size="2"  >&nbsp; This is a tested external c function file.</font></div><div><font size="2"  >*/</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >#include "postgres.h"</font></div><div><font size="2"  >#include "fmgr.h"</font></div><div><font size="2"  >#include "utils/builtins.h"</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >PG_MODULE_MAGIC;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >PG_FUNCTION_INFO_V1(atoi_pg);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Datum atoi_pg(PG_FUNCTION_ARGS) {</font></div><div><font size="2"  >&nbsp; int i;</font></div><div><font size="2"  >&nbsp; int64 n = 0;</font></div><div><font size="2"  >&nbsp; char *s = text_to_cstring(PG_GETARG_TEXT_P(0));</font></div><div><font size="2"  >&nbsp; for (i = 0; s[i] != '\0'; ++i)</font></div><div><font size="2"  >&nbsp; &nbsp; if (s[i] &gt;= '0' &amp;&amp; s[i] &lt;= '9')</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; n = 10 * n + (s[i] - '0');</font></div><div><font size="2"  >&nbsp; PG_RETURN_INT64(n);</font></div><div><font size="2"  >}</font></div><p></p></pre></div></div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >ocz@db-172-16-3-150-&gt; gcc -O3 -Wall -Wextra -Werror -I /home/ocz/postgresql-9.2.1/src/include -g -fPIC -c ./atoi_pg.c -o atoi_pg.o</font></div><div><font size="2"  >ocz@db-172-16-3-150-&gt; gcc -O3 -Wall -Wextra -Werror -I /home/ocz/postgresql-9.2.1/src/include -g -shared atoi_pg.o -o libatoi_pg.so</font></div><div><font size="2"  >ocz@db-172-16-3-150-&gt; cp libatoi_pg.so /home/ocz/pgsql9.2.1/lib/</font></div></div><div><div><font size="2"  >digoal=# create or replace function atoi_pg(i_text text) returns int8 as '$libdir/libatoi_pg.so', 'atoi_pg' language c strict;</font></div><div><font size="2"  >CREATE FUNCTION</font></div></div><div><div><font size="2"  >digoal=# select atoi_pg('afffe12.,..3...few4wf5.6ee');</font></div><div><font size="2"  >&nbsp;atoi_pg&nbsp;</font></div><div><font size="2"  >---------</font></div><div><font size="2"  >&nbsp; 123456</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div><br></div>【参考】<div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/xfunc-c.html"  >http://www.postgresql.org/docs/9.2/static/xfunc-c.html</a></div><div>2.&nbsp;src/include/fmgr.h</div><div>3.&nbsp;src/include/utils/builtins.h</div><div>4.&nbsp;<span style="line-height: 22px;"  >src/include/</span>postgres.h</div><div>5.&nbsp;<wbr><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/functions-matching.html"  >http://www.postgresql.org/docs/9.2/static/functions-matching.html</a></div></div>
	</div>
</div>
</body>
</html>