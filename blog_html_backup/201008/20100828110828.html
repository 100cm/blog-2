<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL PARSE等待一例</h2>
	<h5 id="">2010-08-28 11:08:28&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201072811343330/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">2010-08-28日<div>某系统发送异常，经查有大量waiting.</div><div><div><div>skyurs=# select procpid,query_start,waiting,current_query from pg_stat_activity;</div><div>&nbsp;procpid | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;query_start &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| waiting | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;current_qu</div><div>ery &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>---------+-------------------------------+---------+--------------------------------------------------------------------------------</div><div>--------------------------------------------------------------------------</div><div>&nbsp;&nbsp; 22048 | 2010-08-27 14:30:24.673425+08 | f &nbsp; &nbsp; &nbsp; | create table urs_test_user_list as select user_id,count(user_id) from urs_user_</div><div>relation a where relation=1 group by user_id having(count(user_id)&gt;50) \r+</div><div>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | and (select count(*) from urs_user_relation where relation=1 and buddy_id=a.use</div><div>r_id limit 50)=50\r &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</div><div>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | limit 400000\r &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</div><div>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</div><div>&nbsp;&nbsp; &nbsp;2634 | 2010-08-27 19:27:06.622968+08 | t &nbsp; &nbsp; &nbsp; | select buddy_id, group_id, relation, appinfo, &nbsp;extinfo, create_time from skyurs</div><div>.urs_user_relation where user_id=$1 and relation=1</div><div>&nbsp;&nbsp; 12932 | 2010-08-27 20:05:50.278318+08 | t &nbsp; &nbsp; &nbsp; | select buddy_id, group_id, relation, appinfo, &nbsp;extinfo, create_time from skyurs</div><div>.urs_user_relation where user_id=$1 and relation=1</div></div></div><div><br></div><div>建表语句:create table urs_test_user_list as select user_id,count(user_id) from urs_user_</div><div style="line-height: 22px;">relation a where relation=1 group by user_id having(count(user_id)&gt;50) \r+</div><div style="line-height: 22px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | and (select count(*) from urs_user_relation where relation=1 and buddy_id=a.use</div><div style="line-height: 22px;">r_id limit 50)=50\r &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</div><div style="line-height: 22px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | limit 400000\</div><div style="line-height: 22px;">把表&nbsp;urs_user_relation给锁了，导致相关的SELECT都处于等待锁状态.</div><div style="line-height: 22px;"><div>skyurs=# select pg_terminate_backend(22048);</div><div>&nbsp;pg_terminate_backend&nbsp;</div><div>----------------------</div><div>&nbsp;t</div><div>(1 row)</div><div>干掉之后，锁消失。</div><div>结束后查看数据库日志：</div><div>出现大量:</div><div><div>2010-08-28 10:56:53.735 CST,"skyurs","skyurs",17107,"192.168.171.39:40721",4c77adcc.42d3,3,"PARSE",2010-08-27 20:21:32 CST,74/157,0,</div><div>LOG,00000,"duration: 52520677.542 ms &nbsp;parse &lt;unnamed&gt;: select buddy_id, group_id, relation, appinfo, &nbsp;extinfo, create_time from skyu</div><div>rs.urs_user_relation where user_id=$1 and relation=1",,,,,,,,,""</div></div><div><br></div><div>总结：</div><div>1. 生产环境跑长SQL必须引起注意.这种SQL必须人在现场看牢。以及时响应。</div><div>2. 这个建表语句可以改一下，先把表建好，再用insert into select语法写入，这样的话锁没这么大。</div><div>&nbsp;当然，PostgreSQL应该降低这类情形下的锁级别才对。</div><div>3. 可以考虑配置超时机制，超时的SQL返回错误，以免锁过长时间才发现</div><div>4. 监控超时SQL，及时反馈给DBA处理。</div><div><br></div></div></div>
	</div>
</div>
</body>
</html>