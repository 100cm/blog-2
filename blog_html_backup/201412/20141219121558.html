<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">fast & safe upgrade to PostgreSQL 9.4 use pg_upgrade & zfs</h2>
	<h5 id="">2014-12-19 12:15:58&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014111991023862/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>[更新]</div><div>已使用pg_upgrade顺利将一个8TB的生产数据库(包含表, 索引, 类型, 函数, 外部对象等对象大概10万个)从9.3升级到9.4, 升级比较快(约2分钟), 因为数据库较大后期<span style="line-height: 28px;"   >analyze的</span><span style="line-height: 28px;"   >时间比较长, 不过你可以将常用的表优先analyze一下, 就可以放心大胆的提供服务了.</span></div><div><br></div><div><br></div><div>PostgreSQL 9.4于昨天(2014-12-18)正式发布, 为了让大家可以快速的享受9.4带来的强大特性, 写一篇使用zfs和pg_upgrade升级9.4的快速可靠的文章. 希望对大家有帮助.</div><div>提醒:</div><div>在正式升级9.4前, 请做好功课, 至少release note要阅读一遍, 特别是兼容性. 例如有些应用可能用了某些9.4不兼容的语法或者插件的话, 需要解决了再上. (以前就有出现过版本升级带来的bytea的默认表述变更导致的程序异常)</div><div><br></div><div>pg_upgrade支持从8.3.x以及更新的版本的跨大版本升级, 使用LINK模式, 可以减少数据的拷贝工作, 大大提高版本升级的速度.</div><div>本文将演示一下使用pg_upgrade将数据库从9.3.5升级到最新的9.4.</div><div>使用zfs快照来保存老的数据文件和软件. 如果升级失败, 回滚非常简单, 回退到ZFS快照或者使用ZFS快照克隆都可以.</div><div><div><img title="security upgrade to PostgreSQL 9.4 use pg_upgrade  zfs - 德哥@Digoal - PostgreSQL research"   alt="security upgrade to PostgreSQL 9.4 use pg_upgrade  zfs - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/QTC01cpcQO3Me12Z1aFuqw==/1055249687705461223.png"   ></div></div><div><br></div><div>升级步骤简介 :&nbsp;</div>假设主机已是基于ZFS<div>&nbsp; 停库</div><div>&nbsp; 创建快照</div><div>&nbsp; 使用upgrade升级</div><div><br><wbr><div>假设主机不是基于ZFS</div><div>&nbsp; 创建ZFS主机</div><div>&nbsp; 创建standby</div><div>&nbsp; 主备角色切换</div><div>&nbsp; 以下基于新的主</div><div>&nbsp; 停主</div><div>&nbsp; 创建快照</div><div>&nbsp; 使用upgrade升级</div><div><br></div><div>如何把老版本的standby升级成为9.4 standby?</div><div>&nbsp; pg start backup</div><div>&nbsp; rsync 数据文件</div><div>&nbsp; pg_stop_backup</div><div>&nbsp; 创建recovery.conf 继续.</div><div><br></div><div>使用ZFS和pg_upgrade升级9.4的详细步骤 :&nbsp;</div><div>以CentOS 7 x64为例,</div><div>测试环境部署</div><div>安装zfs</div><div>http://download.fedoraproject.org/pub/epel 找到最新的epel7 rpm包, 加入YUM仓库.</div><div>例如当下版本如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 28px;"   >[root@localhost ~]#</span><span style="line-height: 28px;"   >&nbsp;</span>yum localinstall --nogpgcheck http://ftp.cuhk.edu.hk/pub/linux/fedora-epel/7/x86_64/e/epel-release-7-5.noarch.rpm</font></div><div><font size="2"   ><span style="line-height: 28px;"   >[root@localhost ~]#</span><span style="line-height: 28px;"   >&nbsp;</span>yum localinstall --nogpgcheck http://archive.zfsonlinux.org/epel/zfs-release.el7.noarch.rpm</font></div><div><div><font size="2"   >[root@localhost ~]# uname -r</font></div><div><font size="2"   >3.10.0-123.el7.x86_64</font></div></div><div><font size="2"   ><span style="line-height: 28px;"   >[root@localhost ~]#</span><span style="line-height: 28px;"   >&nbsp;</span>yum install kernel-devel-3.10.0-123.el7 zfs&nbsp;</font></div><p></p></pre></div><div><br></div><div>安装好ZFS后, 创建ZPOOL, 我们使用5个文件来模拟5块磁盘.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost disks]# dd if=/dev/zero of=./disk1 bs=8192k count=1024 oflag=direct</font></div><div><font size="2"   >[root@localhost disks]# dd if=/dev/zero of=./disk2 bs=8192k count=1024 oflag=direct</font></div><div><font size="2"   >[root@localhost disks]# dd if=/dev/zero of=./disk3 bs=8192k count=1024 oflag=direct</font></div><div><font size="2"   >[root@localhost disks]# dd if=/dev/zero of=./disk4 bs=8192k count=1024 oflag=direct</font></div><div><font size="2"   >[root@localhost disks]# dd if=/dev/zero of=./disk5 bs=8192k count=1024 oflag=direct</font></div><p></p></pre></div><div>创建zpool</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost disks]# zpool create -o ashift=12 zp1 raidz /data01/disks/disk1 /data01/disks/disk2 /data01/disks/disk3 /data01/disks/disk4 /data01/disks/disk5</font></div><div><font size="2"   >[root@localhost disks]# zpool status</font></div><div><font size="2"   >&nbsp; pool: zp1</font></div><div><font size="2"   >&nbsp;state: ONLINE</font></div><div><font size="2"   >&nbsp; scan: none requested</font></div><div><font size="2"   >config:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; NAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; STATE &nbsp; &nbsp; READ WRITE CKSUM</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; zp1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; raidz1-0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /data01/disks/disk1 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /data01/disks/disk2 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /data01/disks/disk3 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /data01/disks/disk4 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /data01/disks/disk5 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><p></p></pre></div><div>设置zfs默认参数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost disks]# zfs set atime=off zp1</font></div><div><font size="2"   >[root@localhost disks]# zfs set compression=lz4 zp1</font></div><div><font size="2"   >[root@localhost disks]# zfs set canmount=off zp1</font></div><p></p></pre></div><div>接下来,&nbsp;<span style="line-height: 28px;"   >我们需要规划一下数据库的目录结构.</span></div><div><span style="line-height: 28px;"   >假设分开5个文件系统来存放.</span></div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >$PGDATA</font></div><div style="line-height: 28px;"   ><font size="2"   >pg_xlog</font></div><div style="line-height: 28px;"   ><font size="2"   >pg_arch</font></div><div style="line-height: 28px;"   ><font size="2"   >tbs1</font></div><div style="line-height: 28px;"   ><font size="2"   >tbs2</font></div><p></p></pre></div><div style="line-height: 28px;"   >创建对应的zfs文件系统</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@localhost disks]# zfs create -o mountpoint=/pgdata01 zp1/pg_root</font></div><div><font size="2"   >[root@localhost disks]# zfs create -o mountpoint=/pgdata02 zp1/pg_xlog</font></div><div><font size="2"   >[root@localhost disks]# zfs create -o mountpoint=/pgdata03 zp1/pg_arch</font></div><div><font size="2"   >[root@localhost disks]# zfs create -o mountpoint=/pgdata04 zp1/tbs1</font></div><div><font size="2"   >[root@localhost disks]# zfs create -o mountpoint=/pgdata05 zp1/tbs2</font></div></div><div><font size="2"   >[root@localhost disks]# df -h</font></div><div><div><font size="2"   >zp1/pg_root &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 32G &nbsp;256K &nbsp; 32G &nbsp; 1% /pgdata01</font></div><div><font size="2"   >zp1/pg_xlog &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 32G &nbsp;256K &nbsp; 32G &nbsp; 1% /pgdata02</font></div><div><font size="2"   >zp1/pg_arch &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 32G &nbsp;256K &nbsp; 32G &nbsp; 1% /pgdata03</font></div><div><font size="2"   >zp1/tbs1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;32G &nbsp;256K &nbsp; 32G &nbsp; 1% /pgdata04</font></div><div><font size="2"   >zp1/tbs2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;32G &nbsp;256K &nbsp; 32G &nbsp; 1% /pgdata05</font></div></div><p></p></pre></div><div>创建数据目录</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# mkdir /pgdata01/pg_root</font></div><div><font size="2"   >[root@localhost ~]# mkdir /pgdata02/pg_xlog</font></div><div><font size="2"   >[root@localhost ~]# mkdir /pgdata03/pg_arch</font></div><div><font size="2"   >[root@localhost ~]# mkdir /pgdata04/tbs1</font></div><div><font size="2"   >[root@localhost ~]# mkdir /pgdata05/tbs2</font></div><div><font size="2"   >[root@localhost ~]# chown -R postgres:postgres /pgdata0*/</font></div><p></p></pre></div><div><br></div><div>接下来安装PostgreSQL 9.3.5, 并初始化数据库, 生成测试数据.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost soft_bak]# tar -jxvf postgresql-9.3.5.tar.bz2</font></div><div><font size="2"   >[root@localhost soft_bak]# cd postgresql-9.3.5</font></div><p></p></pre></div><div>注意<span style="line-height: 28px;"   >在升级到9.4时, 软件的编译参数要一致, 例如</span><span style="line-height: 28px;"   >我们这里使用了非默认的数据块, 所以在编译9.4时也需要一致.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 28px;"   >[root@localhost soft_bak]</span># yum -y install glib2 lrzsz sysstat e4fsprogs xfsprogs ntp readline-devel zlib zlib-devel openssl openssl-devel pam-devel libxml2-devel libxslt-devel python-devel tcl-devel gcc make smartmontools flex bison perl perl-devel perl-ExtUtils* OpenIPMI-tools openldap openldap-devel</font></div><div><font size="2"   >[root@localhost postgresql-9.3.5]# ./configure --prefix=/opt/pgsql9.3.5 --with-pgport=1921 --with-perl --with-tcl --with-python --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-blocksize=32 --with-wal-blocksize=32 &amp;&amp; gmake world &amp;&amp; gmake install-world</font></div><div><font size="2"   >[root@localhost postgresql-9.3.5]# ln -s /opt/pgsql9.3.5 /opt/pgsql</font></div><div><div><font size="2"   >[root@localhost postgresql-9.3.5]# vi /etc/ld.so.conf</font></div><div><font size="2"   >/opt/pgsql/lib</font></div></div><div><font size="2"   >[root@localhost postgresql-9.3.5]# ldconfig</font></div><div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@localhost postgresql-9.3.5]# ldconfig -p|grep /opt/pgsql</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; libpqwalreceiver.so (libc6,x86-64) =&gt; /opt/pgsql/lib/libpqwalreceiver.so</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; libpq.so.5 (libc6,x86-64) =&gt; /opt/pgsql/lib/libpq.so.5</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; libpq.so (libc6,x86-64) =&gt; /opt/pgsql/lib/libpq.so</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; libpgtypes.so.3 (libc6,x86-64) =&gt; /opt/pgsql/lib/libpgtypes.so.3</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; libpgtypes.so (libc6,x86-64) =&gt; /opt/pgsql/lib/libpgtypes.so</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; libecpg_compat.so.3 (libc6,x86-64) =&gt; /opt/pgsql/lib/libecpg_compat.so.3</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; libecpg_compat.so (libc6,x86-64) =&gt; /opt/pgsql/lib/libecpg_compat.so</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; libecpg.so.6 (libc6,x86-64) =&gt; /opt/pgsql/lib/libecpg.so.6</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; libecpg.so (libc6,x86-64) =&gt; /opt/pgsql/lib/libecpg.so</font></div></div><div><font size="2"   >[root@localhost postgresql-9.3.5]# vi /etc/profile</font></div><div><font size="2"   >export PATH=/opt/pgsql/bin:$PATH</font></div><div><div><font size="2"   >[root@localhost postgresql-9.3.5]# . /etc/profile</font></div><div><font size="2"   >[root@localhost postgresql-9.3.5]# which psql</font></div><div><font size="2"   >/opt/pgsql/bin/psql</font></div><div><font size="2"   >[root@localhost postgresql-9.3.5]# which pg_config</font></div><div><font size="2"   >/opt/pgsql/bin/pg_config</font></div></div><p></p></pre></div><div><br></div><div>再安装一个外部插件, 提醒各位在使用pg_upgrade升级时, 也需要在新的版本中编译进去(请使用相同的版本).</div><div>如果外部插件不支持PostgreSQL 9.4的话, 那么请在9.3的数据库中先卸载对应的插件(包括里面创建的类型, 函数等有依赖的一切).&nbsp;</div><div>我这里以pldebug为例</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >http://git.postgresql.org/gitweb/?p=pldebugger.git;a=summary</font></div><div><font size="2"   >[root@localhost soft_bak]# tar -zxvf pldebugger-85d7b3b.tar.gz</font></div><div><div><font size="2"   >[root@localhost soft_bak]# mv pldebugger-85d7b3b postgresql-9.3.5/contrib/</font></div><div><font size="2"   >[root@localhost soft_bak]# cd postgresql-9.3.5/contrib/pldebugger-85d7b3b/</font></div></div><div><div><font size="2"   >[root@localhost pldebugger-85d7b3b]# which pg_config</font></div><div><font size="2"   >/opt/pgsql/bin/pg_config</font></div><div><font size="2"   >[root@localhost pldebugger-85d7b3b]# gmake clean</font></div></div><div><font size="2"   >[root@localhost pldebugger-85d7b3b]# gmake</font></div><div><font size="2"   >[root@localhost pldebugger-85d7b3b]# gmake install</font></div><p></p></pre></div><div><br></div><div>初始化数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost pldebugger-85d7b3b]# useradd postgres</font></div><div><font size="2"   ># su - postgres</font></div><div><font size="2"   >$ vi .bash_profile</font></div><div><div><font size="2"   >export PS1="$USER@`/bin/hostname -s`-&gt; "</font></div><div><font size="2"   >export PGPORT=1921</font></div><div><font size="2"   >export PGDATA=/pgdata01/pg_root</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/opt/pgsql</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"   >export PGUSER=postgres</font></div><div><font size="2"   >export PGHOST=$PGDATA</font></div><div><font size="2"   >export PGDATABASE=postgres</font></div><div><font size="2"   >alias rm='rm -i'</font></div><div><font size="2"   >alias ll='ls -lh'</font></div></div><div><font size="2"   >$ . ~/.bash_profile</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >修改权限</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost pldebugger-85d7b3b]# chown -R postgres:postgres /pgdata0*/*</font></div><div><font size="2"   >[root@localhost pldebugger-85d7b3b]# chmod -R 700 /pgdata0*/*</font></div><p></p></pre></div><div><br></div><div>初始化数据库</div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@localhost-&gt; initdb -D $PGDATA -U postgres -E UTF8 --locale=C -W -X /pgdata02/pg_xlog</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >修改配置文件, 开启归档</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi pg_hba.conf</font></div><div><font size="2"   >host all all 0.0.0.0/0 md5</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >vi postgresql.conf</font></div><div><div><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"   >port = 1921 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >max_connections = 100 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >superuser_reserved_connections = 3 &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >unix_socket_directories = '.' &nbsp; # comma-separated list of directories</font></div><div><font size="2"   >unix_socket_permissions = 0700 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# begin with 0 to use octal notation</font></div><div><font size="2"   >tcp_keepalives_idle = 60 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPIDLE, in seconds;</font></div><div><font size="2"   >tcp_keepalives_interval = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPINTVL, in seconds;</font></div><div><font size="2"   >tcp_keepalives_count = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # TCP_KEEPCNT;</font></div><div><font size="2"   >shared_buffers = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 128kB</font></div><div><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div><font size="2"   >vacuum_cost_delay = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 0-100 milliseconds</font></div><div><font size="2"   >vacuum_cost_limit = 10000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 credits</font></div><div><font size="2"   >bgwriter_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 10-10000ms between rounds</font></div><div><font size="2"   >wal_level = hot_standby &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, or hot_standby</font></div><div><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level;</font></div><div><font size="2"   >wal_buffers = 16384kB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 32kB, -1 sets based on shared_buffers</font></div><div><font size="2"   >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"   >checkpoint_segments = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# in logfile segments, min 1, 16MB each</font></div><div><font size="2"   >archive_mode = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # allows archiving to be done</font></div><div><font size="2"   >archive_command = 'DIR="/pgdata03/pg_arch/`date +%F`";test -d $DIR || mkdir -p $DIR; cp %p $DIR/%f' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # command to use to archive a logfile segment</font></div><div><font size="2"   >archive_timeout = 600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # force a logfile segment switch after this</font></div><div><font size="2"   >effective_cache_size = 4096MB</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_directory = 'pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,</font></div><div><font size="2"   >log_file_mode = 0600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# creation mode for log files,</font></div><div><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_disconnections = on</font></div><div><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div><font size="2"   >log_lock_waits = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # log lock waits &gt;= deadlock_timeout</font></div><div><font size="2"   >log_statement = 'ddl' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # none, ddl, mod, all</font></div><div><font size="2"   >log_timezone = 'PRC'</font></div><div><font size="2"   >autovacuum = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Enable autovacuum subprocess? &nbsp;'on'</font></div><div><font size="2"   >log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >timezone = 'PRC'</font></div><div><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div></div><p></p></pre></div><div>启动数据库</div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@localhost-&gt; pg_ctl start</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >创建测试用户</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create role digoal login encrypted password 'digoal';</font></div><div><font size="2"   >CREATE ROLE</font></div><p></p></pre></div><div>创建表空间, 数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create tablespace tbs1 location '/pgdata04/tbs1';</font></div><div><font size="2"   >CREATE TABLESPACE</font></div><div><font size="2"   >postgres=# create tablespace tbs2 location '/pgdata05/tbs2';</font></div><div><font size="2"   >CREATE TABLESPACE</font></div><div><font size="2"   >postgres=# create database digoal template template0 encoding 'UTF8' tablespace tbs1;</font></div><div><font size="2"   >CREATE DATABASE</font></div><div><font size="2"   >postgres=# grant all on database digoal to digoal;</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >postgres=# grant all on tablespace tbs1 to digoal;</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >postgres=# grant all on tablespace tbs2 to digoal;</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >postgres=# \c digoal digoal</font></div><div><font size="2"   >You are now connected to database "digoal" as user "digoal".</font></div><div><font size="2"   >digoal=&gt; create schema digoal;</font></div><div><font size="2"   >CREATE SCHEMA</font></div><p></p></pre></div><div>创建extension, 用于后面模拟9.3升级到9.4的扩展模块.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \c digoal postgres</font></div><div><font size="2"   >You are now connected to database "digoal" as user "postgres".</font></div><div><font size="2"   >digoal=# create extension pldbgapi;</font></div><div><font size="2"   >CREATE EXTENSION</font></div><p></p></pre></div><div>该扩展会创建一些复合类型和函数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \dT</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; List of data types</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp;Name &nbsp; &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+------------+-------------</font></div><div><font size="2"   >&nbsp;public | breakpoint |&nbsp;</font></div><div><font size="2"   >&nbsp;public | frame &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | proxyinfo &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | targetinfo |&nbsp;</font></div><div><font size="2"   >&nbsp;public | var &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >(5 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# \df</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of functions</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Result data type | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Argument data types &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;Type&nbsp;</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >--------+-----------------------------+------------------+------------------------------------------------------------------+-------</font></div><div><font size="2"   >-</font></div><div><font size="2"   >&nbsp;public | pldbg_abort_target &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| SETOF boolean &nbsp; &nbsp;| session integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;public | pldbg_attach_to_port &nbsp; &nbsp; &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| portnumber integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | normal</font></div><div><font size="2"   >&nbsp;public | pldbg_continue &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| breakpoint &nbsp; &nbsp; &nbsp; | session integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;public | pldbg_create_listener &nbsp; &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;public | pldbg_deposit_value &nbsp; &nbsp; &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| session integer, varname text, linenumber integer, value text &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;public | pldbg_drop_breakpoint &nbsp; &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| session integer, func oid, linenumber integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;public | pldbg_get_breakpoints &nbsp; &nbsp; &nbsp; | SETOF breakpoint | session integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;public | pldbg_get_proxy_info &nbsp; &nbsp; &nbsp; &nbsp;| proxyinfo &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;public | pldbg_get_source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | session integer, func oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;public | pldbg_get_stack &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | SETOF frame &nbsp; &nbsp; &nbsp;| session integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;public | pldbg_get_target_info &nbsp; &nbsp; &nbsp; | targetinfo &nbsp; &nbsp; &nbsp; | signature text, targettype "char" &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;public | pldbg_get_variables &nbsp; &nbsp; &nbsp; &nbsp; | SETOF var &nbsp; &nbsp; &nbsp; &nbsp;| session integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;public | pldbg_oid_debug &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| functionoid oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;public | pldbg_select_frame &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| breakpoint &nbsp; &nbsp; &nbsp; | session integer, frame integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | normal</font></div><div><font size="2"   >&nbsp;public | pldbg_set_breakpoint &nbsp; &nbsp; &nbsp; &nbsp;| boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| session integer, func oid, linenumber integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;public | pldbg_set_global_breakpoint | boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| session integer, func oid, linenumber integer, targetpid integer | normal</font></div><div><font size="2"   >&nbsp;public | pldbg_step_into &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | breakpoint &nbsp; &nbsp; &nbsp; | session integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;public | pldbg_step_over &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | breakpoint &nbsp; &nbsp; &nbsp; | session integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;public | pldbg_wait_for_breakpoint &nbsp; | breakpoint &nbsp; &nbsp; &nbsp; | session integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;public | pldbg_wait_for_target &nbsp; &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| session integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;public | plpgsql_oid_debug &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| functionoid oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >(21 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# \d breakpoint</font></div><div><font size="2"   >Composite type "public.breakpoint"</font></div><div><font size="2"   >&nbsp; &nbsp;Column &nbsp; | &nbsp;Type &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >------------+---------+-----------</font></div><div><font size="2"   >&nbsp;func &nbsp; &nbsp; &nbsp; | oid &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;linenumber | integer |&nbsp;</font></div><div><font size="2"   >&nbsp;targetname | text &nbsp; &nbsp;|&nbsp;</font></div><p></p></pre></div><div><br></div><div>创建测试数据表, 函数, 创建在tbs1和tbs2.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# \c digoal digoal</font></div><div><font size="2"   >You are now connected to database "digoal" as user "digoal".</font></div><div><font size="2"   >digoal=&gt; create table userinfo (id int primary key, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >digoal=&gt; \d userinfo</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "digoal.userinfo"</font></div><div><font size="2"   >&nbsp; Column &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >----------+-----------------------------+-----------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;info &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;crt_time | timestamp without time zone |&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "userinfo_pkey" PRIMARY KEY, btree (id)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; alter index userinfo_pkey set tablespace tbs2;</font></div><div><font size="2"   >ALTER INDEX</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=&gt; create or replace function f_digoal(i_id int) returns void as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; update userinfo set info=$_$Hello,I'm digoal.$_$||md5(random()::text), crt_time=now() where id=i_id;</font></div><div><font size="2"   >&nbsp; if not found then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into userinfo(id,info,crt_time) values(i_id, $_$Hello,I'm digoal.$_$||md5(random()::text), now());</font></div><div><font size="2"   >&nbsp; end if;&nbsp;</font></div><div><font size="2"   >&nbsp; return;</font></div><div><font size="2"   >exception when others then</font></div><div><font size="2"   >&nbsp; return;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql strict volatile;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >digoal=&gt; select f_digoal(1);</font></div><div><font size="2"   >&nbsp;f_digoal&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; select * from userinfo ;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+---------------------------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | Hello,I'm digoal.607acd6f0bfe3c48eecde00f1b98ad85 | 2014-12-19 18:48:03.398352</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=&gt; select f_digoal(1);</font></div><div><font size="2"   >&nbsp;f_digoal&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; select * from userinfo ;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+---------------------------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | Hello,I'm digoal.debe361485303d3bac72ea3d9a95aa42 | 2014-12-19 18:48:47.255641</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>生成测试数据</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; insert into userinfo select generate_series(2,10000000),'test',clock_timestamp();</font></div><div><font size="2"   >INSERT 0 9999999</font></div><p></p></pre></div><div><br></div><div>安装PostgreSQL 9.4, 注意编译参数一致性, 以及内部和外部扩展模块(内部模块gmake world gmake install-world会全部安装).</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost soft_bak]# wget https://ftp.postgresql.org/pub/source/v9.4.0/postgresql-9.4.0.tar.bz2</font></div><div><font size="2"   >[root@localhost soft_bak]# tar -jxvf postgresql-9.4.0.tar.bz2</font></div><div><div><font size="2"   >[root@localhost soft_bak]# cd postgresql-9.4.0</font></div></div><div><font size="2"   >[root@localhost postgresql-9.4.0]# ./configure --prefix=/opt/pgsql9.4.0 --with-pgport=1921 --with-perl --with-tcl --with-python --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-blocksize=32 --with-wal-blocksize=32 &amp;&amp; gmake world &amp;&amp; gmake install-world</font></div><p></p></pre></div><div>检查安装包含upgrade和upgrade库.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# cd /opt/pgsql9.4.0/lib/</font></div><div><font size="2"   >[root@localhost lib]# ll|grep upgr</font></div><div><font size="2"   >-rwxr-xr-x 1 root root &nbsp; 14352 Dec 19 19:12 pg_upgrade_support.so</font></div><div><font size="2"   >[root@localhost lib]# ll /opt/pgsql9.4.0/bin/pg_upgrade&nbsp;</font></div><div><font size="2"   >-rwxr-xr-x 1 root root 116368 Dec 19 19:12 /opt/pgsql9.4.0/bin/pg_upgrade</font></div><p></p></pre></div><div><br></div><div>安装pldebug模块, 这个模块可以和9.4兼容.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@localhost postgresql-9.4.0]# cd ..</font></div><div><font size="2"   >[root@localhost soft_bak]# tar -zxvf pldebugger-85d7b3b.tar.gz</font></div></div><div><font size="2"   >[root@localhost soft_bak]# mv pldebugger-85d7b3b postgresql-9.4.0/contrib/</font></div><div><div><font size="2"   >[root@localhost soft_bak]# cd postgresql-9.4.0/contrib/pldebugger-85d7b3b/</font></div><div><font size="2"   >[root@localhost pldebugger-85d7b3b]# export PATH=/opt/pgsql9.4.0/bin:$PATH</font></div><div><font size="2"   >[root@localhost pldebugger-85d7b3b]# which pg_config</font></div><div><font size="2"   >/opt/pgsql9.4.0/bin/pg_config</font></div><div><font size="2"   >[root@localhost pldebugger-85d7b3b]# gmake clean</font></div></div><div><font size="2"   >[root@localhost pldebugger-85d7b3b]# gmake</font></div><div><font size="2"   >[root@localhost pldebugger-85d7b3b]# gmake install</font></div><p></p></pre></div><div><br></div><div><br></div><div>如果我们要使用硬链接$PGDATA来加快升级速度的话, 那么新的集群$PGDATA要和老集群的$PGDATA在一个文件系统下.</div><div>所以我们使用 /pgdata01/pg_root_9.4 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost lib]# mkdir /pgdata01/pg_root_9.4</font></div><div><font size="2"   >[root@localhost lib]# chown -R postgres:postgres /pgdata01/pg_root_9.4</font></div><div><font size="2"   >[root@localhost lib]# chmod 700 /pgdata01/pg_root_9.4</font></div><p></p></pre></div><div>初始化XLOG目录和arch目录(如果使用了定制的pg_log, 则还需初始化pg_log目录, 本例使用的是$PGDATA/pg_log, 所以无需创建pg_log)</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@localhost lib]# mkdir /pgdata02/pg_xlog_9.4</font></div><div><font size="2"   >[root@localhost lib]# chown -R postgres:postgres /pgdata02/pg_xlog_9.4</font></div><div><font size="2"   >[root@localhost lib]# chmod 700 /pgdata02/pg_xlog_9.4</font></div></div><div><div><font size="2"   >[root@localhost lib]# mkdir /pgdata03/pg_arch_9.4</font></div><div><font size="2"   >[root@localhost lib]# chown -R postgres:postgres /pgdata03/pg_arch_9.4</font></div><div><font size="2"   >[root@localhost lib]# chmod 700 /pgdata03/pg_arch_9.4</font></div></div><p></p></pre></div><div><br></div><div>初始化9.4数据库, 注意除xlog,pgdata以为其他初始化参数和9.3一致(超级用户名也要一致) :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost lib]# su - postgres</font></div><div><font size="2"   >Last login: Fri Dec 19 19:23:00 CST 2014 on pts/3</font></div><div><font size="2"   >postgres@localhost-&gt; /opt/pgsql9.4.0/bin/initdb -D /pgdata01/pg_root_9.4 -X /pgdata02/pg_xlog_9.4 -E UTF8 --locale=C -U postgres -W</font></div><p></p></pre></div><div><br></div><div>配置9.4集群</div><div>将pg_hba.conf改为和老实例的9.3一致.</div><div><br></div><div>另外, 因为升级需要多次连接新老集群数据库实例, 所以修改为使用本地trust认证.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@localhost-&gt; vi /pgdata01/pg_root/pg_hba.conf</font></div><div><font size="2"   >postgres@localhost-&gt; vi /pgdata01/pg_root_9.4/pg_hba.conf</font></div><div><font size="2"   >包含以下即可</font></div><div><div><font size="2"   ># "local" is for Unix domain socket connections only</font></div><div><font size="2"   >local &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trust</font></div><div><font size="2"   ># IPv4 local connections:</font></div><div><font size="2"   >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div></div><p></p></pre></div><div><br></div><div>修改9.4实例的postgresql.conf, 注意使用不同的监听端口. (PostgreSQL 9.4新增了很多功能和参数, 本例一并提供了 )</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"   >port = 1922 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >max_connections = 100 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_directories = '.' &nbsp; # comma-separated list of directories</font></div><div><font size="2"   >unix_socket_permissions = 0700 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# begin with 0 to use octal notation</font></div><div><font size="2"   >tcp_keepalives_idle = 60 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPIDLE, in seconds;</font></div><div><font size="2"   >tcp_keepalives_interval = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPINTVL, in seconds;</font></div><div><font size="2"   >tcp_keepalives_count = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # TCP_KEEPCNT;</font></div><div><font size="2"   >shared_buffers = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 128kB</font></div><div><font size="2"   >huge_pages = try &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# on, off, or try</font></div><div><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div><font size="2"   >autovacuum_work_mem = -1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB, or -1 to use maintenance_work_mem</font></div><div><font size="2"   >dynamic_shared_memory_type = posix &nbsp; &nbsp; &nbsp;# the default is the first option</font></div><div><font size="2"   >vacuum_cost_delay = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 0-100 milliseconds</font></div><div><font size="2"   >vacuum_cost_limit = 10000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 credits</font></div><div><font size="2"   >bgwriter_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 10-10000ms between rounds</font></div><div><font size="2"   >wal_level = logical &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, hot_standby, or logical</font></div><div><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level;</font></div><div><font size="2"   >wal_buffers = 16384kB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 32kB, -1 sets based on shared_buffers</font></div><div><font size="2"   >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"   >checkpoint_segments = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# in logfile segments, min 1, 16MB each</font></div><div><font size="2"   >archive_mode = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # allows archiving to be done</font></div><div><font size="2"   >archive_command = 'DIR="/pgdata03/pg_arch_9.4/`date +%F`";test -d $DIR || mkdir -p $DIR; cp %p $DIR/%f' &nbsp; &nbsp; &nbsp; &nbsp; # command to use to archive a logfile segment</font></div><div><font size="2"   >archive_timeout = 600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # force a logfile segment switch after this</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_directory = 'pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,</font></div><div><font size="2"   >log_file_mode = 0600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# creation mode for log files,</font></div><div><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_disconnections = on</font></div><div><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div><font size="2"   >log_lock_waits = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # log lock waits &gt;= deadlock_timeout</font></div><div><font size="2"   >log_statement = 'ddl' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # none, ddl, mod, all</font></div><div><font size="2"   >log_timezone = 'PRC'</font></div><div><font size="2"   >autovacuum = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Enable autovacuum subprocess? &nbsp;'on'</font></div><div><font size="2"   >log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >timezone = 'PRC'</font></div><div><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><p></p></pre></div><div><br></div><div>停库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@localhost-&gt; /opt/pgsql9.3.5/bin/pg_ctl stop -m fast -D /pgdata01/pg_root</font></div><div><font size="2"   >postgres@localhost-&gt; /opt/pgsql9.4.0/bin/pg_ctl stop -m fast -D /pgdata01/pg_root_9.4</font></div><p></p></pre></div><div><br></div><div>创建9.3数据库的文件系统快照</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# df -h</font></div><div><div><font size="2"   >zp1/pg_root &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 30G &nbsp; 19M &nbsp; 30G &nbsp; 1% /pgdata01</font></div><div><font size="2"   >zp1/pg_xlog &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 31G &nbsp;428M &nbsp; 30G &nbsp; 2% /pgdata02</font></div><div><font size="2"   >zp1/pg_arch &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 31G &nbsp;636M &nbsp; 30G &nbsp; 3% /pgdata03</font></div><div><font size="2"   >zp1/tbs1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;31G &nbsp;170M &nbsp; 30G &nbsp; 1% /pgdata04</font></div><div><font size="2"   >zp1/tbs2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;31G &nbsp; 97M &nbsp; 30G &nbsp; 1% /pgdata05</font></div></div><div><div><font size="2"   >[root@localhost ~]# zfs snapshot zp1/pg_root@pg9.3.5</font></div><div><font size="2"   >[root@localhost ~]# zfs snapshot zp1/pg_xlog@pg9.3.5</font></div><div><font size="2"   >[root@localhost ~]# zfs snapshot zp1/pg_arch@pg9.3.5</font></div><div><font size="2"   >[root@localhost ~]# zfs snapshot zp1/tbs1@pg9.3.5</font></div><div><font size="2"   >[root@localhost ~]# zfs snapshot zp1/tbs2@pg9.3.5</font></div><div><div><font size="2"   >[root@localhost ~]# zfs list -t snapshot</font></div><div><font size="2"   >NAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;USED &nbsp;AVAIL &nbsp;REFER &nbsp;MOUNTPOINT</font></div><div><font size="2"   >zp1/pg_arch@pg9.3.5 &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;- &nbsp; 635M &nbsp;-</font></div><div><font size="2"   >zp1/pg_root@pg9.3.5 &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;- &nbsp;18.4M &nbsp;-</font></div><div><font size="2"   >zp1/pg_xlog@pg9.3.5 &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;- &nbsp; 428M &nbsp;-</font></div><div><font size="2"   >zp1/tbs1@pg9.3.5 &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp;- &nbsp; 169M &nbsp;-</font></div><div><font size="2"   >zp1/tbs2@pg9.3.5 &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp;- &nbsp;96.2M &nbsp;-</font></div></div></div><p></p></pre></div><div><br></div><div>使用9.4的pg_upgrade检测兼容性</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - postgres</font></div><div><div><font size="2"   >postgres@localhost-&gt; cd</font></div><div><font size="2"   >postgres@localhost-&gt; mkdir upgrade_log</font></div></div><div><font size="2"   >postgres@localhost-&gt; cd upgrade_log/</font></div><div><div><font size="2"   >postgres@localhost-&gt; /opt/pgsql9.4.0/bin/pg_upgrade -b /opt/pgsql9.3.5/bin -B /opt/pgsql9.4.0/bin -d /pgdata01/pg_root -D /pgdata01/pg_root_9.4 -p 1921 -P 1922 -U postgres -j 8 -k -c</font></div><div><font size="2"   >Performing Consistency Checks</font></div><div><font size="2"   >-----------------------------</font></div><div><font size="2"   >Checking cluster versions &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ok</font></div><div><font size="2"   >Checking database user is a superuser &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ok</font></div><div><font size="2"   >Checking for prepared transactions &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ok</font></div><div><font size="2"   >Checking for reg* system OID user data types &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ok</font></div><div><font size="2"   >Checking for contrib/isn with bigint-passing mismatch &nbsp; &nbsp; &nbsp; ok</font></div><div><font size="2"   >Checking for invalid "line" user columns &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ok</font></div><div><font size="2"   >Checking for presence of required libraries &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ok</font></div><div><font size="2"   >Checking database user is a superuser &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ok</font></div><div><font size="2"   >Checking for prepared transactions &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ok</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >*Clusters are compatible*</font></div></div><p></p></pre></div><div><br></div><div>验证兼容性正常, 可以正式升级了.&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >postgres@localhost-&gt; /opt/pgsql9.4.0/bin/pg_upgrade -b /opt/pgsql9.3.5/bin -B /opt/pgsql9.4.0/bin -d /pgdata01/pg_root -D /pgdata01/pg_root_9.4 -p 1921 -P 1922 -U postgres -j 8 -k -r -v</font></p></pre></div><div>最后输出如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Upgrade Complete</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >Optimizer statistics are not transferred by pg_upgrade so,</font></div><div><font size="2"   >once you start the new server, consider running:</font></div><div><font size="2"   >&nbsp; &nbsp; analyze_new_cluster.sh</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Running this script will delete the old cluster's data files:</font></div><div><font size="2"   >&nbsp; &nbsp; delete_old_cluster.sh</font></div><p></p></pre></div><div>给了2个脚本, 用于收集统计信息和删除老集群.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@localhost-&gt; ll</font></div><div><font size="2"   >total 20K</font></div><div><font size="2"   >-rwx------ 1 postgres postgres 785 Dec 19 19:50 analyze_new_cluster.sh</font></div><div><font size="2"   >-rwx------ 1 postgres postgres 114 Dec 19 19:50 delete_old_cluster.sh</font></div><div><font size="2"   >-rw------- 1 postgres postgres 326 Dec 19 19:51 pg_upgrade_internal.log</font></div><div><font size="2"   >-rw------- 1 postgres postgres 179 Dec 19 19:51 pg_upgrade_server.log</font></div><div><font size="2"   >-rw------- 1 postgres postgres 179 Dec 19 19:51 pg_upgrade_utility.log</font></div><p></p></pre></div><div><br></div><div>接下来要做的是启动新的数据库集群.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@localhost-&gt; /opt/pgsql9.4.0/bin/pg_ctl start -D /pgdata01/pg_root_9.4</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >执行统计信息收集脚本, 因为使用pg_upgrade升级的话, 统计信息不会迁移过来. 所以需要手工统计一下.</span></div><div>脚本内容如下</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@localhost-&gt; cat analyze_new_cluster.sh&nbsp;</font></div><div><font size="2"   >#!/bin/sh</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >echo 'This script will generate minimal optimizer statistics rapidly'</font></div><div><font size="2"   >echo 'so your system is usable, and then gather statistics twice more'</font></div><div><font size="2"   >echo 'with increasing accuracy. &nbsp;When it is done, your system will'</font></div><div><font size="2"   >echo 'have the default level of optimizer statistics.'</font></div><div><font size="2"   >echo</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >echo 'If you have used ALTER TABLE to modify the statistics target for'</font></div><div><font size="2"   >echo 'any tables, you might want to remove them and restore them after'</font></div><div><font size="2"   >echo 'running this script because they will delay fast statistics generation.'</font></div><div><font size="2"   >echo</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >echo 'If you would like default statistics as quickly as possible, cancel'</font></div><div><font size="2"   >echo 'this script and run:'</font></div><div><font size="2"   >echo ' &nbsp; &nbsp;"/opt/pgsql9.4.0/bin/vacuumdb" -U "postgres" --all --analyze-only'</font></div><div><font size="2"   >echo</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >"/opt/pgsql9.4.0/bin/vacuumdb" -U "postgres" --all --analyze-in-stages</font></div><div><font size="2"   >echo</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >echo 'Done'</font></div><p></p></pre></div><div>但是脚本有点问题, 所以需要我们自行提供连接参数.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@localhost-&gt; "/opt/pgsql9.4.0/bin/vacuumdb" -U "postgres" --all --analyze-only -h /pgdata01/pg_root_9.4 -p 1922 -U postgres</font></div><div><font size="2"   >vacuumdb: vacuuming database "digoal"</font></div><div><font size="2"   >vacuumdb: vacuuming database "postgres"</font></div><div><font size="2"   >vacuumdb: vacuuming database "template1"</font></div><p></p></pre></div><div>升级完成.</div><div>----------------------------------------------------------------------------------------------------------------------------------------------</div><div>查看数据</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres@localhost-&gt; /opt/pgsql9.4.0/bin/psql -h 127.0.0.1 -p 1922 -U digoal digoal</font></div><div><font size="2"   >psql (9.4.0)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=&gt; \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; Name &nbsp; | Type &nbsp;| Owner &nbsp;</font></div><div><font size="2"   >--------+----------+-------+--------</font></div><div><font size="2"   >&nbsp;digoal | userinfo | table | digoal</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; \dx</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of installed extensions</font></div><div><font size="2"   >&nbsp; &nbsp;Name &nbsp; | Version | &nbsp; Schema &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Description &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------+---------+------------+------------------------------------------------------</font></div><div><font size="2"   >&nbsp;pldbgapi | 1.0 &nbsp; &nbsp; | public &nbsp; &nbsp; | server-side support for debugging PL/pgSQL functions</font></div><div><font size="2"   >&nbsp;plpgsql &nbsp;| 1.0 &nbsp; &nbsp; | pg_catalog | PL/pgSQL procedural language</font></div><div><font size="2"   >(2 rows)</font></div></div><div><div><font size="2"   >digoal=&gt; select count(*) from userinfo ;</font></div><div><font size="2"   >&nbsp; count &nbsp;&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;10000000</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>最后, 确认升级成功后, 我们可以把老的集群删掉. 删之前也请确认清楚是否真的可以删除, 不要太相信pg_upgrade.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@localhost-&gt; cat delete_old_cluster.sh&nbsp;</font></div><div><font size="2"   >#!/bin/sh</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >rm -rf /pgdata01/pg_root</font></div><div><font size="2"   >rm -rf /pgdata04/tbs1/PG_9.3_201306121</font></div><div><font size="2"   >rm -rf /pgdata05/tbs2/PG_9.3_201306121</font></div><p></p></pre></div><div><br></div><div>因为我们用了硬链接, 检查一下就可以删除了, 表空间, $PGDATA都使用了硬链接.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@localhost-&gt; stat PG_9.3_201306121</font></div><div><font size="2"   >&nbsp; File: ‘PG_9.3_201306121’</font></div><div><font size="2"   >&nbsp; Size: 3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Blocks: 27 &nbsp; &nbsp; &nbsp; &nbsp; IO Block: 131072 directory</font></div><div><font size="2"   >Device: 26h/38d Inode: 8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Links: 3</font></div><div><font size="2"   >Access: (0700/drwx------) &nbsp;Uid: ( 1001/postgres) &nbsp; Gid: ( 1001/postgres)</font></div><div><font size="2"   >Access: 2014-12-19 19:24:39.096630736 +0800</font></div><div><font size="2"   >Modify: 2014-12-19 19:24:47.718612433 +0800</font></div><div><font size="2"   >Change: 2014-12-19 19:24:47.718612433 +0800</font></div><div><font size="2"   >&nbsp;Birth: -</font></div><div><font size="2"   >postgres@localhost-&gt; du -sh *</font></div><div><font size="2"   >170M &nbsp; &nbsp;PG_9.3_201306121</font></div><div><font size="2"   >3.0M &nbsp; &nbsp;PG_9.4_201409291</font></div><p></p></pre></div><div><br></div><div>删除后, 文件统计信息正确</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@localhost-&gt; du -sh *</font></div><div><font size="2"   >170M &nbsp; &nbsp;PG_9.4_201409291</font></div><p></p></pre></div><div><br></div><div>如果要玩回退的话, 以下调整先不要做.</div><div>确认要完全使用9.4以后, 我们还需要调整一下/etc/profile, ~/.bash_profile, 方便我们的使用.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >rm -f /opt/pgsql</font></div><div><font size="2"   >ln -s /opt/pgsql9.4.0 /opt/pgsql</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >vi /etc/profile</font></div><div><font size="2"   >export PATH=/opt/pgsql/bin:$PATH</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >vi /home/postgres/.bash_profile</font></div><div><div><font size="2"   >export PGPORT=1921</font></div><div><font size="2"   >export PGDATA=/pgdata01/pg_root_9.4</font></div></div><p></p></pre></div><div><br></div><div>--------------------------------------------------------------------------------------------------------------------------------------------------------------</div><div>最后做一下回退测试 :&nbsp;</div><div>回退也很简单, 简单的描述一下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@localhost ~]# zfs clone -o mountpoint=/old_pgdata01 zp1/pg_root@pg9.3.5 zp1/old_pgdata01</font></div><div><font size="2"   >[root@localhost ~]# zfs clone -o mountpoint=/old_pgdata02 zp1/pg_xlog@pg9.3.5 zp1/old_pgdata02</font></div><div><font size="2"   >[root@localhost ~]# zfs clone -o mountpoint=/old_pgdata03 zp1/pg_arch@pg9.3.5 zp1/old_pgdata03</font></div><div><font size="2"   >[root@localhost ~]# zfs clone -o mountpoint=/old_pgdata04 zp1/tbs1@pg9.3.5 zp1/old_pgdata04</font></div><div><font size="2"   >[root@localhost ~]# zfs clone -o mountpoint=/old_pgdata05 zp1/tbs2@pg9.3.5 zp1/old_pgdata05</font></div></div><div><font size="2"   >df -h</font></div><div><div><font size="2"   >zp1/old_pgdata01 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;30G &nbsp; 19M &nbsp; 30G &nbsp; 1% /old_pgdata01</font></div><div><font size="2"   >zp1/old_pgdata02 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;31G &nbsp;428M &nbsp; 30G &nbsp; 2% /old_pgdata02</font></div><div><font size="2"   >zp1/old_pgdata03 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;31G &nbsp;636M &nbsp; 30G &nbsp; 3% /old_pgdata03</font></div><div><font size="2"   >zp1/old_pgdata04 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;31G &nbsp;170M &nbsp; 30G &nbsp; 1% /old_pgdata04</font></div><div><font size="2"   >zp1/old_pgdata05 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;30G &nbsp; 97M &nbsp; 30G &nbsp; 1% /old_pgdata05</font></div></div><p></p></pre></div><div>调整pg_xlog,以及 表空间链接</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# su - postgres</font></div><div><font size="2"   >postgres@localhost-&gt; cd /old_pgdata01</font></div><div><font size="2"   >postgres@localhost-&gt; cd pg_root</font></div><div><div><font size="2"   >postgres@localhost-&gt; ll</font></div><div><font size="2"   >total 225K</font></div><div><font size="2"   >lrwxrwxrwx 1 postgres postgres &nbsp; 17 Dec 19 19:23 pg_xlog -&gt; /pgdata02/pg_xlog</font></div></div><div><div><font size="2"   >postgres@localhost-&gt; rm -f pg_xlog</font></div><div><font size="2"   >postgres@localhost-&gt; ln -s /old_pgdata02/pg_xlog ./</font></div></div><div><div><font size="2"   >postgres@localhost-&gt; cd pg_tblspc/</font></div><div><font size="2"   >postgres@localhost-&gt; ll</font></div><div><font size="2"   >total 1.0K</font></div><div><font size="2"   >lrwxrwxrwx 1 postgres postgres 14 Dec 19 19:24 16385 -&gt; /pgdata04/tbs1</font></div><div><font size="2"   >lrwxrwxrwx 1 postgres postgres 14 Dec 19 19:24 16386 -&gt; /pgdata05/tbs2</font></div></div><div><div><font size="2"   >postgres@localhost-&gt; rm -f *</font></div><div><font size="2"   >postgres@localhost-&gt; ln -s /old_pgdata04/tbs1 ./16385</font></div><div><font size="2"   >postgres@localhost-&gt; ln -s /old_pgdata05/tbs2 ./16386</font></div></div><p></p></pre></div><div>修改参数(新老版本不冲突),</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >archive_command = 'DIR="/old_pgdata03/pg_arch/`date +%F`";test -d $DIR || mkdir -p $DIR; cp %p $DIR/%f'</font></div><div><font size="2"   >port = 1922|1921</font></div><p></p></pre></div><div>启动old数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@localhost-&gt; /opt/pgsql9.3.5/bin/pg_ctl start -D /old_pgdata01/pg_root</font></div><div><font size="2"   >server starting</font></div><p></p></pre></div><div>链接到old数据库测试正常.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@localhost-&gt; /opt/pgsql9.3.5/bin/psql -h 127.0.0.1 -p 1921 -U digoal digoal</font></div><div><font size="2"   >psql (9.3.5)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; select count(*) from userinfo ;</font></div><div><font size="2"   >&nbsp; count &nbsp;&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;10000000</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >[参考]</span></div></div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/pgupgrade.html"   >http://www.postgresql.org/docs/9.4/static/pgupgrade.html</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201341981648918/"   >http://blog.163.com/digoal@126/blog/static/163877040201341981648918/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://download.fedoraproject.org/pub/epel"   >http://download.fedoraproject.org/pub/epel</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://zfsonlinux.org/epel.html"   >http://zfsonlinux.org/epel.html</a></div><div>5. pg_upgrade --help</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Usage:</font></div><div><font size="2"   >&nbsp; pg_upgrade [OPTION]...</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Options:</font></div><div><font size="2"   >&nbsp; -b, --old-bindir=BINDIR &nbsp; &nbsp; &nbsp; old cluster executable directory</font></div><div><font size="2"   >&nbsp; -B, --new-bindir=BINDIR &nbsp; &nbsp; &nbsp; new cluster executable directory</font></div><div><font size="2"   >&nbsp; -c, --check &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; check clusters only, don't change any data</font></div><div><font size="2"   >&nbsp; -d, --old-datadir=DATADIR &nbsp; &nbsp; old cluster data directory</font></div><div><font size="2"   >&nbsp; -D, --new-datadir=DATADIR &nbsp; &nbsp; new cluster data directory</font></div><div><font size="2"   >&nbsp; -j, --jobs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;number of simultaneous processes or threads to use</font></div><div><font size="2"   >&nbsp; -k, --link &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;link instead of copying files to new cluster</font></div><div><font size="2"   >&nbsp; -o, --old-options=OPTIONS &nbsp; &nbsp; old cluster options to pass to the server</font></div><div><font size="2"   >&nbsp; -O, --new-options=OPTIONS &nbsp; &nbsp; new cluster options to pass to the server</font></div><div><font size="2"   >&nbsp; -p, --old-port=PORT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; old cluster port number (default 50432)</font></div><div><font size="2"   >&nbsp; -P, --new-port=PORT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new cluster port number (default 50432)</font></div><div><font size="2"   >&nbsp; -r, --retain &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;retain SQL and log files after success</font></div><div><font size="2"   >&nbsp; -U, --username=NAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cluster superuser (default "postgres")</font></div><div><font size="2"   >&nbsp; -v, --verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; enable verbose internal logging</font></div><div><font size="2"   >&nbsp; -V, --version &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; display version information, then exit</font></div><div><font size="2"   >&nbsp; -?, --help &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;show this help, then exit</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Before running pg_upgrade you must:</font></div><div><font size="2"   >&nbsp; create a new database cluster (using the new version of initdb)</font></div><div><font size="2"   >&nbsp; shutdown the postmaster servicing the old cluster</font></div><div><font size="2"   >&nbsp; shutdown the postmaster servicing the new cluster</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >When you run pg_upgrade, you must provide the following information:</font></div><div><font size="2"   >&nbsp; the data directory for the old cluster &nbsp;(-d DATADIR)</font></div><div><font size="2"   >&nbsp; the data directory for the new cluster &nbsp;(-D DATADIR)</font></div><div><font size="2"   >&nbsp; the "bin" directory for the old version (-b BINDIR)</font></div><div><font size="2"   >&nbsp; the "bin" directory for the new version (-B BINDIR)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >For example:</font></div><div><font size="2"   >&nbsp; pg_upgrade -d oldCluster/data -D newCluster/data -b oldCluster/bin -B newCluster/bin</font></div><div><font size="2"   >or</font></div><div><font size="2"   >&nbsp; $ export PGDATAOLD=oldCluster/data</font></div><div><font size="2"   >&nbsp; $ export PGDATANEW=newCluster/data</font></div><div><font size="2"   >&nbsp; $ export PGBINOLD=oldCluster/bin</font></div><div><font size="2"   >&nbsp; $ export PGBINNEW=newCluster/bin</font></div><div><font size="2"   >&nbsp; $ pg_upgrade</font></div><p></p></pre></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="security upgrade to PostgreSQL 9.4 use pg_upgrade  zfs - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>