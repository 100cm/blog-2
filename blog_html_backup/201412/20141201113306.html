<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">attention : ifup-aliases dose not detect alias interface address if exists in network When ifup parent interface</h2>
	<h5 id="">2014-12-01 11:33:06&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014111103410552/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>早上francs问的一个问题, 在rc.local中配置的如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># add by pg_clusterd</font></div><div><font size="2"   >/sbin/service network start</font></div><div><font size="2"   >/sbin/ifup eth0</font></div><div><font size="2"   >/sbin/ifdown eth0:1</font></div><p></p></pre></div><div>ifdown eth0:1目的是用来关闭虚拟IP, 这样做可能会导致eth0:1的IP会短暂的启用(service network start后). &nbsp;</div><div>实际上是配置不当导致, 因为alias不是用ONBOOT来控制是否自动启动的.</div><div>参考 /usr/share/doc/initscripts*/sysconfig.txt</div><div>&nbsp; &nbsp; ONBOOT=yes|no (not valid for alias devices; use ONPARENT)</div><div><br></div><div>我们来分析一下网络配置 :&nbsp;</div><div>配置文件如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   ># less ifcfg-eth0</font></div><div><font size="2"   >DEVICE="eth0"</font></div><div><font size="2"   >BOOTPROTO="static"</font></div><div><font size="2"   >IPADDR="172.16.3.221"</font></div><div><font size="2"   >NETMASK="255.255.255.0"</font></div><div><font size="2"   >HWADDR="5C:F3:FC:94:12:00"</font></div><div><font size="2"   >IPV6INIT="no"</font></div><div><font size="2"   >MTU="1500"</font></div><div><font size="2"   >NM_CONTROLLED="no"</font></div><div><font size="2"   >ONBOOT="yes"</font></div><div><font size="2"   >TYPE="Ethernet"</font></div><div><font size="2"   >UUID="5904b633-4b24-47d4-b710-292feedda75b"</font></div></div><div><font size="2"   ><br></font></div><div><div style="line-height: 28px;"   ><font size="2"   ># less ifcfg-eth0:1</font></div><div style="line-height: 28px;"   ><font size="2"   >DEVICE="eth0:1"</font></div><div style="line-height: 28px;"   ><font size="2"   >BOOTPROTO="static"</font></div><div style="line-height: 28px;"   ><font size="2"   >IPADDR="172.16.3.222"</font></div><div style="line-height: 28px;"   ><font size="2"   >NETMASK="255.255.255.0"</font></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >IPV6INIT="no"</font></span></div><div style="line-height: 28px;"   ><font size="2"   >MTU="1500"</font></div><div style="line-height: 28px;"   ><font size="2"   >NM_CONTROLLED="no"</font></div><div style="line-height: 28px;"   ><font size="2"   >ONBOOT="no"</font></div><div style="line-height: 28px;"   ><font size="2"   >TYPE="Ethernet"</font></div></div></pre></div><div>注意子接口eth0:1的ONBOOT=no, 并不会导致不启动, 是没有用的, 如果要控制alias接口不要自动启动, 请使用ONPARENT=no.</div><div>ONBOOT只被ifup boot参数使用.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >SYNOPSIS</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ifup IFACE [boot]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ifdown IFACE</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >DESCRIPTION</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The &nbsp;ifup &nbsp;and &nbsp;ifdown &nbsp;commands &nbsp;may be used to configure (or, respec- tively, deconfigure) network interfaces</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;based &nbsp;on &nbsp; interface &nbsp; definitions &nbsp; in &nbsp; the &nbsp; files &nbsp; /etc/sysconfig/network &nbsp; and &nbsp; /etc/sysconfig/network-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;scripts/ifcfg-&lt;configuration&gt;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;These &nbsp;scripts &nbsp;take &nbsp;one &nbsp;argument normally: the name of the configuration (e.g. eth0). They are called with a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;second argument of "boot" during the boot sequence so that devices that are not meant to be brought up on &nbsp;boot</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;(ONBOOT=no, see below) can be ignored at that time.</font></div><p></p></pre></div><div><br></div><div>正常情况下配置了<span style="line-height: 28px;"   >ONBOOT=no</span><span style="line-height: 28px;"   >, 使用network服务来管理的话, 这个接口是不会起来的, 为什么呢?</span></div><div>看看network这个脚本</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># less /etc/init.d/network</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; action $"Bringing up interface $i: " ./ifup $i boot</font></div><p></p></pre></div><div>ifup 带 boot参数只启动ONBOOT=yes的接口.</div><div><br></div><div>例如如果配置了eth0:1的ONBOOT=NO, 我们直接使用ifup启动eth0:1是不会起这个接口的.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >ifup eth0:1 boot</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >没有返回.</span></div><div><br></div><div>但是如果没有配置<span style="line-height: 28px;"   >ONPARENT=no的话,&nbsp;</span><span style="line-height: 28px;"   >启动network 服务时, 子接口的IP还是起来了, 原因是启eth0时, 会连带起eth0:1, 并且没有探测eth0:1配置的IP.</span></div><div>原因是ifup-post中包含了ifup-aliases, 用来启动子接口.&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >ifup eth0</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >这个操作会启动eth0以及所有子接口, 不管子接口的ONBOOT是否为no, 只关心</span><span style="line-height: 28px;"   >ONPARENT是否为no</span><span style="line-height: 28px;"   >.</span></div><div><br></div><div>假设广播域中已经存在eth0:1配置的IP, service network start来启动的话, 会导致eth0:1起来, 也就是广播域会出现两个同样的IP,.</div><div>这也就是rc.local里面配置ifdown eth0:1的原因.</div><div>但是这样短暂的冲突时无法避免的.</div><div><br></div><div>解决办法推荐 :&nbsp;</div><div>方法1.&nbsp;</div><div>可以换一个方式, 不使用子接口来管理虚拟IP, 直接使用arping和ip来管理 VIP.</div><div>删除配置文件&nbsp;<span style="line-height: 28px;"   >ifcfg-eth0:1</span></div><div>启动时不再包含VIP.</div><div>要使用VIP时, 直接在link上添加IP即可.</div><div>例如 :&nbsp;</div><div><span style="line-height: 28px;"   >启动VIP前最好也先检测一下IP在网络中是否已经存在.</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 28px;"   >/sbin/arping -q -c 2 -w 3 -D -I eth0&nbsp;</span><span style="line-height: 28px;"   >172.16.3.222</span><span style="line-height: 28px;"   >&nbsp;&amp;&amp;&nbsp;</span>ip addr add 172.16.3.222/24 dev eth0</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >要删除VIP, 直接删除即可.</span></div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >ip addr del 172.16.3.222/24 dev eth0</font></span></div><div></div><p></p></pre><div><br></div><div><span style="line-height: 28px;"   >IP存在, arping返回1 :&nbsp;</span></div><div><span style="line-height: 28px;"   >注意必须要使用正确的接口, 如这里是br0.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 network-scripts]# /sbin/arping -q -c 2 -w 3 -D -I br0 172.16.3.2</font></div><div><font size="2"   >[root@db-172-16-3-221 network-scripts]# echo $?</font></div><div><font size="2"   >1</font></div><div><font size="2"   >[root@db-172-16-3-221 network-scripts]# arp -a</font></div><div><font size="2"   >150.sky-mobi.com (172.16.3.150) at 00:22:19:60:77:8f [ether] on br0</font></div><div><font size="2"   >? (172.16.3.1) at 00:00:5e:00:01:03 [ether] on br0</font></div><div><font size="2"   >? (172.16.3.3) at 68:ef:bd:08:3f:bf [ether] on br0</font></div><div><font size="2"   >? (172.16.3.2) at e2:e8:2c:5e:7c:af [ether] on br0</font></div><p></p></pre></div><div>IP不存在, arping返回0</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 network-scripts]# /sbin/arping -q -c 2 -w 3 -D -I br0 172.16.3.4</font></div><div><font size="2"   >[root@db-172-16-3-221 network-scripts]# echo $?</font></div><div><font size="2"   >0</font></div><div><font size="2"   >[root@db-172-16-3-221 network-scripts]# arp -a</font></div><div><font size="2"   >150.sky-mobi.com (172.16.3.150) at 00:22:19:60:77:8f [ether] on br0</font></div><div><font size="2"   >? (172.16.3.1) at 00:00:5e:00:01:03 [ether] on br0</font></div><div><font size="2"   >? (172.16.3.3) at 68:ef:bd:08:3f:bf [ether] on br0</font></div><div><font size="2"   >? (172.16.3.2) at 00:25:84:66:d0:3f [ether] on br0</font></div><div><font size="2"   >? (172.16.3.4) at &lt;incomplete&gt; on br0</font></div><p></p></pre></div><div><br></div><div>以下摘自ifup-aliases, ifup-eth</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if ! LC_ALL=C ip addr ls ${REALDEVICE} | LC_ALL=C grep -q "${ipaddr[$idx]}/${prefix[$idx]}" ; then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if [ "${REALDEVICE}" != "lo" ] &amp;&amp; [ "${arpcheck[$idx]}" != "no" ] ; then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo $"Determining if ip address ${ipaddr[$idx]} is already in use for device ${REALDEVICE}..."</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ! /sbin/arping -q -c 2 -w 3 -D -I ${REALDEVICE} ${ipaddr[$idx]} ; then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; net_log $"Error, some other host already uses address ${ipaddr[$idx]}."</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exit 1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fi</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fi</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;if [ "$setup_this" = "yes" ] ; then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if [ "${parent_device}" != "lo" ] &amp;&amp; &nbsp;[ "${ARPCHECK}" != "no" ] &amp;&amp; \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;is_available ${parent_device} &amp;&amp; \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;grep -qswi "up" /sys/class/net/${parent_device}/operstate ; then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;echo $"Determining if ip address ${IPADDR} is already in use for device ${parent_device}..."</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if ! /sbin/arping -q -c 2 -w 3 -D -I ${parent_device} ${IPADDR} ; then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;net_log $"Error, some other host already uses address ${IPADDR}."</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return 1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fi</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fi</font></div></div><p></p></pre></div><div><br></div><div>方法2.</div><div>修改ifup-post脚本, 注释掉启动aliases接口的脚本. 那么就不会自动启动子接口.</div><div># vi&nbsp;/etc/sysconfig/network-scripts/ifup-post</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#if [ "$ISALIAS" = no ] ; then</font></div><div><font size="2"   ># &nbsp; &nbsp;/etc/sysconfig/network-scripts/ifup-aliases ${DEVICE} ${CONFIG}</font></div><div><font size="2"   >#fi</font></div><p></p></pre></div><div><br></div><div>测试 :&nbsp;</div><div>启动network服务, 不会再自动启动子接口了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db6 network-scripts]# cp ifcfg-bond0 ifcfg-bond0:1</font></div><div><font size="2"   >[root@db6 network-scripts]# vi ifcfg-bond0:1</font></div><div><div><font size="2"   >DEVICE=bond0:1</font></div><div><font size="2"   >ONBOOT=no</font></div><div><font size="2"   >BOOTPROTO=none</font></div><div><font size="2"   >IPADDR=172.16.3.2</font></div><div><font size="2"   >NETMASK=255.255.255.0</font></div><div><font size="2"   >BROADCAST=172.16.3.255</font></div><div><font size="2"   >TYPE=Ethernet</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db6 network-scripts]# service network restart</font></div><div><font size="2"   >Shutting down interface bond0: &nbsp;[ &nbsp;OK &nbsp;]</font></div><div><font size="2"   >Shutting down loopback interface: &nbsp;[ &nbsp;OK &nbsp;]</font></div><div><font size="2"   >Bringing up loopback interface: &nbsp;[ &nbsp;OK &nbsp;]</font></div><div><font size="2"   >Bringing up interface bond0: &nbsp;[ &nbsp;OK &nbsp;]</font></div><div><font size="2"   >[root@db6 network-scripts]# ifconfig</font></div><div><font size="2"   >bond0 &nbsp; &nbsp; Link encap:Ethernet &nbsp;HWaddr 00:23:7D:A3:F0:0A &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:172.16.3.174 &nbsp;Bcast:172.16.3.255 &nbsp;Mask:255.255.255.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet6 addr: fe80::223:7dff:fea3:f00a/64 Scope:Link</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING MASTER MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:10 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:43 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:732 (732.0 b) &nbsp;TX bytes:10573 (10.3 KiB)</font></div></div></pre></div><div>手工启动子接口 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >[root@db6 network-scripts]# ifup bond0:1</font></span></div><div><font size="2"   >[root@db6 network-scripts]# ifconfig</font></div><div><font size="2"   >bond0 &nbsp; &nbsp; Link encap:Ethernet &nbsp;HWaddr 00:23:7D:A3:F0:0A &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:172.16.3.174 &nbsp;Bcast:172.16.3.255 &nbsp;Mask:255.255.255.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet6 addr: fe80::223:7dff:fea3:f00a/64 Scope:Link</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING MASTER MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:319 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:145 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:36732 (35.8 KiB) &nbsp;TX bytes:26445 (25.8 KiB)</font></div><div><font size="2"   >bond0:1 &nbsp; Link encap:Ethernet &nbsp;HWaddr 00:23:7D:A3:F0:0A &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:172.16.3.2 &nbsp;Bcast:172.16.3.255 &nbsp;Mask:255.255.255.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING MASTER MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >方法3.&nbsp;</span></div><div><span style="line-height: 28px;"   >子接口中使用</span><span style="line-height: 28px;"   >ONPARENT=no, 例如 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >DEVICE=bond0:1</font></div><div><font size="2"   >ONPARENT=no</font></div><div><font size="2"   >ONBOOT=no</font></div><div><font size="2"   >BOOTPROTO=none</font></div><div><font size="2"   >IPADDR=172.16.3.2</font></div><div><font size="2"   >NETMASK=255.255.255.0</font></div><div><font size="2"   >BROADCAST=172.16.3.255</font></div><div><font size="2"   >TYPE=Ethernet</font></div><div><font size="2"   >GATEWAY=172.16.3.1</font></div><p></p></pre></div><div><br></div><div>最后还有一个问题, ifup-aliases启动 子接口时, 不会检测子接口的IP是否存在.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db6 network-scripts]# ifup-aliases bond0</font></div><div><font size="2"   >[root@db6 network-scripts]# ifconfig</font></div><div><font size="2"   >bond0 &nbsp; &nbsp; Link encap:Ethernet &nbsp;HWaddr 00:23:7D:A3:F0:0A &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:172.16.3.174 &nbsp;Bcast:172.16.3.255 &nbsp;Mask:255.255.255.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet6 addr: fe80::223:7dff:fea3:f00a/64 Scope:Link</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING MASTER MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:946 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:788 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:102384 (99.9 KiB) &nbsp;TX bytes:129685 (126.6 KiB)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >bond0:1 &nbsp; Link encap:Ethernet &nbsp;HWaddr 00:23:7D:A3:F0:0A &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:172.16.3.150 &nbsp;Bcast:172.16.3.255 &nbsp;Mask:255.255.255.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING MASTER MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><p></p></pre></div><div>使用ifup会检测IP是否存在.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db6 network-scripts]# ifdown bond0:1</font></div><div><font size="2"   >[root@db6 network-scripts]# ifup bond0:1</font></div><div><font size="2"   >Error, some other host already uses address 172.16.3.150.</font></div><p></p></pre></div><div>这个问题如何解决?</div><div>修改ifup-aliases脚本 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/etc/sysconfig/network-scripts/ifup-aliases :&nbsp;</font></div><div><div><font size="2"   >##echo "setting up device $DEVICE"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/sbin/ifconfig ${DEVICE} ${IPADDR} netmask ${NETMASK} broadcast ${BROADCAST}</font></div></div><div><font size="2"   >改成</font></div><div><div><font size="2"   >##echo "setting up device $DEVICE"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/sbin/arping -q -c 2 -w 3 -D -I ${DEVICE} ${IPADDR} &amp;&amp; /sbin/ifconfig ${DEVICE} ${IPADDR} netmask ${NETMASK} broadcast ${BROADCAST}</font></div></div><p></p></pre></div><div><br></div><div>[小结]</div><div>1. 搞清楚aliases接口的启动控制不是ONBOOT, 而是ONPARENT.</div><div>2. 对于子接口启动不检查子接口地址是否在网络中重复的问题, 需要修改/etc/sysconfig/network-scripts/ifup-aliases.</div><div><br></div>[参考]<wbr><div>1. man ifup</div><div>2. /etc/sysconfig/network-scripts/ifup</div><div>3.&nbsp;/etc/sysconfig/network-scripts/ifup-eth</div><div>4.&nbsp;/etc/init.d/network</div><div>5.&nbsp;/usr/share/doc/initscripts-*/sysconfig.txt</div><div>6.&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;arping - send ARP REQUEST to a neighbour host</div><div><div>&nbsp; &nbsp; &nbsp; &nbsp;-D &nbsp; &nbsp; Duplicate address detection mode (DAD). See RFC2131, 4.4.1. &nbsp;Returns 0, if DAD succeeded i.e. no replies</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; are received</div></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="dose not detect interface alias if address exists in network when ifup-aliases interface - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>