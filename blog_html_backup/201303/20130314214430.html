<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Loading Useful Modules in PostgreSQL PLV8 lang</h2>
	<h5 id="">2013-03-14 21:44:30&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020132143340793/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 支持JSON数据类型以来, 自带的函数功能确实太匮乏了, 如果要在PostgreSQL中充分利用JSON的特性, 使用plv8语言是个不错的选择. 同时可以加载很多有趣的javascript模块.</div><div>注意PLV8语言是trusted语言 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from pg_language ;</font></div><div><font size="2"   >&nbsp;lanname &nbsp;| lanowner | lanispl | lanpltrusted | lanplcallfoid | laninline | lanvalidator | lanacl&nbsp;</font></div><div><font size="2"   >----------+----------+---------+--------------+---------------+-----------+--------------+--------</font></div><div><font size="2"   >&nbsp;internal | &nbsp; &nbsp; &nbsp; 10 | f &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; 2246 |&nbsp;</font></div><div><font size="2"   >&nbsp;c &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 10 | f &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; 2247 |&nbsp;</font></div><div><font size="2"   >&nbsp;sql &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 10 | f &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; 2248 |&nbsp;</font></div><div><font size="2"   >&nbsp;plpgsql &nbsp;| &nbsp; &nbsp; &nbsp; 10 | t &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 12670 | &nbsp; &nbsp; 12671 | &nbsp; &nbsp; &nbsp; &nbsp;12672 |&nbsp;</font></div><div><font size="2"   >&nbsp;plv8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 10 | t &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 3484692 | &nbsp; 3484693 | &nbsp; &nbsp; &nbsp;3484694 |&nbsp;</font></div><div><font size="2"   >&nbsp;plls &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 10 | t &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 3484701 | &nbsp; 3484702 | &nbsp; &nbsp; &nbsp;3484703 |&nbsp;</font></div><div><font size="2"   >&nbsp;plcoffee | &nbsp; &nbsp; &nbsp; 10 | t &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 3484706 | &nbsp; 3484707 | &nbsp; &nbsp; &nbsp;3484708 |&nbsp;</font></div><div><font size="2"   >(7 rows)</font></div><p></p></pre></div><div>lanpltrusted这列, t表示trusted.</div><div><pre class="prettyprint"   ><p><font size="2"   >True if this is a trusted language, which means that it is believed not to grant access to anything outside the normal SQL execution environment. Only superusers can create functions in untrusted languages.</font></p></pre></div><div>所以如果要加载javascript module, 不能直接读取文件系统. 需要先将javascript导入数据库, 然后才能被plv8读取并加载.</div><div>例如有两个module :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >underscore :&nbsp;http://underscorejs.org/underscore.js</font></div><div><font size="2"   >node-jpath :&nbsp;https://raw.github.com/stsvilik/node-jpath/master/lib/node-jpath.js&nbsp;</font></div><p></p></pre></div><div>(node-jpath.js需稍加修改)</div><div>加载方法如下 :&nbsp;</div><div>1. 首先将脚本下载到本地 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >curl -o underscore.js http://underscorejs.org/underscore.js</font></div><div><font size="2"   >curl -o jpath.js https://raw.github.com/stsvilik/node-jpath/master/lib/node-jpath.js</font></div><p></p></pre></div><div>node-jpath.js的末尾部分需要修改一下 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >module.exports.select = function(obj, pattern, cfn) {</font></div><div><font size="2"   >module.exports.filter = function(obj, pattern, cfn) {</font></div><p></p></pre></div><div>改成</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select = function(obj, pattern, cfn) {</font></div><div><font size="2"   >filter = function(obj, pattern, cfn) {</font></div><p></p></pre></div></div><div>这两个模块的用法参考本文末尾的链接.</div><div><br></div><div>2. 编译plv8模块参考以下链接</div><div><a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013045395446/"   >http://blog.163.com/digoal@126/blog/static/1638770402013045395446/</a></div><div><br></div><div>3. 加载下载好的两个模块</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - digoal</font></div><div><font size="2"   >psql digoal digoal</font></div><div><font size="2"   >create extension plv8;</font></div><div><div><font size="2"   >\set underscore `cat /home/digoal/underscore.js`</font></div><div><font size="2"   >\set jpath `cat /home/digoal/jpath.js`</font></div></div><p></p></pre></div><div><div>-- 创建表, 用来存储javascript脚本</div><div><pre class="prettyprint"   ><p><font size="2"   >create table plv8_modules(modname text primary key, load_on_start boolean, code text);</font></p></pre></div><div>-- 将javascript模块脚本插入数据表</div><div><pre class="prettyprint"   ><p><font size="2"   >insert into plv8_modules values ('underscore',true,:'underscore'), ('jpath',true,:'jpath');</font></p></pre></div></div><div>-- 加载模块的函数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace function public.plv8_startup()</font></div><div><font size="2"   >returns void</font></div><div><font size="2"   >language plv8</font></div><div><font size="2"   >as</font></div><div><font size="2"   >$$</font></div><div><font size="2"   >load_module = function(modname)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; var rows = plv8.execute("SELECT code from plv8_modules " +</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; " where modname = $1", [modname]);</font></div><div><font size="2"   >&nbsp; &nbsp; for (var r = 0; r &lt; rows.length; r++)</font></div><div><font size="2"   >&nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; var code = rows[r].code;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; eval("(function() { " + code + "})")();</font></div><div><font size="2"   >&nbsp; &nbsp; }<span style="line-height: 22px;"   >&nbsp; &nbsp; &nbsp;</span></font></div><div><font size="2"   >};</font></div><div><font size="2"   >load_module("underscore"); load_module("jpath");</font></div><div><font size="2"   >$$;</font></div><p></p></pre></div><div>-- 测试underscore和node-jpath中的方法.</div><div>-- 加载模块, 如果需要使用这两个模块, 必须在每个会话中调用一次plv8_startup, 加载这两个模块.</div><div>-- 后面会有方法来自动加载这两个模块</div><div><pre class="prettyprint"   ><p><font size="2"   >select plv8_startup();</font></p></pre></div><div><div>-- test the underscore module's extend function</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >do language plv8 $$&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;x = {'a':1};&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;y=_.extend(x,{'a':2,'b':3},{'b':4,'c':5});&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;plv8.elog(NOTICE,JSON.stringify(y));&nbsp;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >-- 输出</font></div><div><div><font size="2"   >NOTICE: &nbsp;{"a":2,"b":4,"c":5}</font></div><div><font size="2"   >DO</font></div></div><p></p></pre></div><div>-- test jpath module's filter function</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >do language plv8 $$</font></div><div><font size="2"   >&nbsp; var jsonData = {</font></div><div><font size="2"   >&nbsp; &nbsp; people: [</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {name: "John", age:26, gender:"male"},</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {name: "Steve", age:24, gender:"male"},</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {name: "Susan", age:22, gender:"female"},</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {name: "Linda", age:30, gender:"female"},</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {name: "Adam", age:32, gender:"male"}</font></div><div><font size="2"   >&nbsp; &nbsp; ]</font></div><div><font size="2"   >&nbsp; };</font></div><div><font size="2"   >&nbsp; //We want to get all males younger then 25</font></div><div><font size="2"   >&nbsp; var match = filter(jsonData, "people[gender=male &amp;&amp; age &lt; 25]");</font></div><div><font size="2"   >&nbsp; plv8.elog(NOTICE,JSON.stringify(match));</font></div><div><font size="2"   >$$;</font></div></div><div><font size="2"   >-- 输出</font></div><div><div><font size="2"   >NOTICE: &nbsp;[{"name":"Steve","age":24,"gender":"male"}]</font></div><div><font size="2"   >DO</font></div></div><p></p></pre></div></div><div><br></div><div>-- 自动加载的方法如下, 首先需要修改plv8_startup函数,</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace function public.plv8_startup()</font></div><div><font size="2"   >returns void</font></div><div><font size="2"   >language plv8</font></div><div><font size="2"   >as</font></div><div><font size="2"   >$$</font></div><div><font size="2"   >// now load all the modules marked for loading on start</font></div><div><font size="2"   >// load_on_start值如果是true的, 那么数据库启动时将会自动加载</font></div><div><font size="2"   >var rows = plv8.execute("SELECT modname, code from plv8_modules where load_on_start");</font></div><div><font size="2"   >for (var r = 0; r &lt; rows.length; r++)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp;var code = rows[r].code;</font></div><div><font size="2"   >&nbsp;eval("(function() { " + code + "})")();</font></div><div><font size="2"   >};</font></div><div><font size="2"   >$$;</font></div><p></p></pre></div><div>-- 同时需要修改配置, 让数据库自动加载, plv8的start_proc参数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi $PGDATA/postgresql.conf</font></div><div><div><font size="2"   ># Add settings for extensions here</font></div><div><font size="2"   >plv8.start_proc = 'plv8_startup'</font></div></div><p></p></pre></div><div>-- 重启数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg_ctl stop -m fast</font></div><div><font size="2"   >pg_ctl start</font></div><p></p></pre></div><div>-- 测试是否自动加载</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; -- test the underscore module's extend function</font></div><div><font size="2"   >digoal=&gt; do language plv8 $$&nbsp;</font></div><div><font size="2"   >digoal$&gt; &nbsp; &nbsp;x = {'a':1};&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;plv8.elog(NOTICE,JSON.stringify(y));&nbsp;</font></div><div><font size="2"   >digoal$&gt; &nbsp; &nbsp;y=_.extend(x,{'a':2,'b':3},{'b':4,'c':5});&nbsp;</font></div><div><font size="2"   >digoal$&gt; &nbsp; &nbsp;plv8.elog(NOTICE,JSON.stringify(y));&nbsp;</font></div><div><font size="2"   >digoal$&gt; $$;</font></div><div><font size="2"   >NOTICE: &nbsp;{"a":2,"b":4,"c":5}</font></div><div><font size="2"   >DO</font></div><div><font size="2"   >digoal=&gt; do language plv8 $$</font></div><div><font size="2"   >digoal$&gt; &nbsp; var jsonData = {</font></div><div><font size="2"   >digoal$&gt; &nbsp; &nbsp; people: [</font></div><div><font size="2"   >digoal$&gt; &nbsp; &nbsp; &nbsp; &nbsp; {name: "John", age:26, gender:"male"},</font></div><div><font size="2"   >digoal$&gt; &nbsp; &nbsp; &nbsp; &nbsp; {name: "Steve", age:24, gender:"male"},</font></div><div><font size="2"   >digoal$&gt; &nbsp; &nbsp; &nbsp; &nbsp; {name: "Susan", age:22, gender:"female"},</font></div><div><font size="2"   >digoal$&gt; &nbsp; &nbsp; &nbsp; &nbsp; {name: "Linda", age:30, gender:"female"},</font></div><div><font size="2"   >digoal$&gt; &nbsp; &nbsp; &nbsp; &nbsp; {name: "Adam", age:32, gender:"male"}</font></div><div><font size="2"   >digoal$&gt; &nbsp; &nbsp; ]</font></div><div><font size="2"   >digoal$&gt; &nbsp; };</font></div><div><font size="2"   >digoal$&gt; &nbsp; //We want to get all males younger then 25</font></div><div><font size="2"   >digoal$&gt; &nbsp; var match = filter(jsonData, "people[gender=male &amp;&amp; age &lt; 25]");</font></div><div><font size="2"   >digoal$&gt; &nbsp; plv8.elog(NOTICE,JSON.stringify(match));</font></div><div><font size="2"   >digoal$&gt; $$;</font></div><div><font size="2"   >NOTICE: &nbsp;[{"name":"Steve","age":24,"gender":"male"}]</font></div><div><font size="2"   >DO</font></div><p></p></pre></div><div><br></div>【参考】<div>1.&nbsp;Andrew Dunstan's PostgreSQL and Technical blog</div><div>2.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013045395446/"   >http://blog.163.com/digoal@126/blog/static/1638770402013045395446/</a></div><div>3.&nbsp;<a target="_blank" rel="nofollow" href="https://github.com/documentcloud/underscore"   >https://github.com/documentcloud/underscore</a></div><div>4.&nbsp;<a target="_blank" rel="nofollow" href="https://github.com/stsvilik/node-jpath"   >https://github.com/stsvilik/node-jpath</a><br><br></div></div>
	</div>
</div>
</body>
</html>