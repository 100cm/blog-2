<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL DBLINK module's SQL build NOTEs about primary_key_attnums parameter</h2>
	<h5 id="">2013-03-12 23:01:20&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201321292735532/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>最近在写一个通用的数据表远程复制的触发器函数, 有兴趣的朋友可以阅读以下文章.</div><div><a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201321125220134/"   >http://blog.163.com/digoal@126/blog/static/163877040201321125220134/</a></div><div><br></div><div>在建立复制SQL语句的地方用到了dblink模块的三个函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >1. dblink_build_sql_insert -- &nbsp;builds an INSERT statement using a local tuple, replacing the primary key field values with alternative supplied values</font></span></div><div><div><font size="2"   >2. dblink_build_sql_delete -- builds a DELETE statement using supplied values for primary key field values</font></div><div><font size="2"   >3. dblink_build_sql_update -- builds an UPDATE statement using a local tuple, replacing the primary key field values with alternative supplied values</font></div></div><p></p></pre></div><div>这三个函数的<span style="line-height: 22px;"   >primary_key_attnums参数在PostgreSQL9.0以及以上版本表示的是逻辑位置, 而在8.x以及以下版本表示的是pg_attribute.attnum.</span></div><div>两者存在较大差别, 在使用时需要注意.</div><div><pre class="prettyprint"   ><p><font size="2"   >As of PostgreSQL 9.0, the attribute numbers in primary_key_attnums are interpreted as logical column numbers, corresponding to the column's position in SELECT * FROM relname. Previous versions interpreted the numbers as physical column positions. There is a difference if any column(s) to the left of the indicated column have been dropped during the lifetime of the table.</font></p></pre></div><div>以<span style="line-height: 22px;"   >dblink_build_sql_insert</span><span style="line-height: 22px;"   >为例, 看看9.x和8.x的版本差别.&nbsp;</span></div><div><span style="line-height: 22px;"   >语法如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >dblink_build_sql_insert(text relname,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int2vector primary_key_attnums,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; integer num_primary_key_atts,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; text[] src_pk_att_vals_array,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; text[] tgt_pk_att_vals_array) returns text</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >PostgreSQL 9.2与PostgreSQL 8.4 的dblink_build_sql_insert使用</span><span style="line-height: 22px;"   >差别如下 :&nbsp;</span></div><div>PostgreSQL 9.2 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >ocz@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><font size="2"   >-- 创建模块</font></div><div><div><font size="2"   >digoal=# create extension dblink;</font></div><div><font size="2"   >CREATE EXTENSION</font></div></div><div><font size="2"   >-- 创建测试表, PK建立在c3,c5,c6</font></div><div><div><font size="2"   >digoal=# create table build_test(c1 int, c2 text, c3 int2, c4 name, c5 text, c6 timestamp, primary key(c3,c5,c6));</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "build_test_pkey" for table "build_test"</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >-- 插入测试数据</font></div><div><font size="2"   >digoal=# insert into build_test values (1,'test',2,'build','digoal',now());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >-- 当前c3,c5,c6的逻辑位置是3,5,6</font></div><div><font size="2"   >digoal=# select * from build_test ;</font></div><div><font size="2"   >&nbsp;c1 | &nbsp;c2 &nbsp;| c3 | &nbsp;c4 &nbsp; | &nbsp; c5 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c6 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----+------+----+-------+--------+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | test | &nbsp;2 | build | digoal | 2013-03-12 21:48:39.799831</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >-- pg_attribute中的位置</font></div><div><font size="2"   >digoal=# select attname,attnum from pg_attribute where attrelid='build_test'::regclass;</font></div><div><font size="2"   >&nbsp;attname &nbsp;| attnum&nbsp;</font></div><div><font size="2"   >----------+--------</font></div><div><font size="2"   >&nbsp;tableoid | &nbsp; &nbsp; -7</font></div><div><font size="2"   >&nbsp;cmax &nbsp; &nbsp; | &nbsp; &nbsp; -6</font></div><div><font size="2"   >&nbsp;xmax &nbsp; &nbsp; | &nbsp; &nbsp; -5</font></div><div><font size="2"   >&nbsp;cmin &nbsp; &nbsp; | &nbsp; &nbsp; -4</font></div><div><font size="2"   >&nbsp;xmin &nbsp; &nbsp; | &nbsp; &nbsp; -3</font></div><div><font size="2"   >&nbsp;ctid &nbsp; &nbsp; | &nbsp; &nbsp; -1</font></div><div><font size="2"   >&nbsp;c1 &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >&nbsp;c2 &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >&nbsp;c3 &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;3</font></div><div><font size="2"   >&nbsp;c4 &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;4</font></div><div><font size="2"   >&nbsp;c5 &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;5</font></div><div><font size="2"   >&nbsp;c6 &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;6</font></div><div><font size="2"   >(12 rows)</font></div><div><font size="2"   >-- 建立SQL语句. 使用的位置信息为3,5,6</font></div><div><font size="2"   >digoal=# select * from dblink_build_sql_insert('build_test', '3 5 6'::int2vector, 3, array['2', 'digoal', '2013-03-12 21:48:39.799831'], array['2', 'digoal', '2013-03-12 21:48:39.799831']);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dblink_build_sql_insert &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;INSERT INTO build_test(c1,c2,c3,c4,c5,c6) VALUES('1','test','2','build','digoal','2013-03-12 21:48:39.799831')</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >-- 删除c1列, 主键的逻辑位置将变成2,4,5</font></div><div><font size="2"   >digoal=# alter table build_test drop column c1;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><div style="line-height: 22px;"   ><font size="2"   >digoal=# select * from build_test ;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; c2 &nbsp;| c3 | &nbsp;c4 &nbsp; | &nbsp; c5 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c6 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >------+----+-------+--------+----------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;test | &nbsp;2 | build | digoal | 2013-03-12 21:48:39.799831</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div></div><div style="line-height: 22px;"   ><font size="2"   >-- 使用3,5,6将导致数据错乱或报错.</font></div><div><font size="2"   >digoal=# select * from dblink_build_sql_insert('build_test', '3 5 6'::int2vector, 3, array['2', 'digoal', '2013-03-12 21:48:39.799831'], array['2', 'digoal', '2013-03-12 21:48:39.799831']);</font></div><div><font size="2"   >ERROR: &nbsp;invalid attribute number 6</font></div><div><font size="2"   >-- 将参数改为逻辑位置,&nbsp;<span style="line-height: 22px;"   >'2 4 5'::int2vector; 使用正常</span></font></div><div><font size="2"   >digoal=# select * from dblink_build_sql_insert('build_test', '2 4 5'::int2vector, 3, array['2', 'digoal', '2013-03-12 21:48:39.799831'], array['2', 'digoal', '2013-03-12 21:48:39.799831']);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dblink_build_sql_insert &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;INSERT INTO build_test(c2,c3,c4,c5,c6) VALUES('test','2','build','digoal','2013-03-12 21:48:39.799831')</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><div><br></div></div><div>PostgreSQL 8.4 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-- 创建模块</font></div><div><font size="2"   >pg84@db-172-16-3-150-&gt; psql digoal postgres -f $PGHOME/share/contrib/dblink.sql&nbsp;</font></div><div><div><font size="2"   >pg84@db-172-16-3-150-&gt; psql&nbsp;</font></div><div><font size="2"   >psql (8.4.16)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \c digoal digoal</font></div><div><font size="2"   >psql (8.4.16)</font></div><div><font size="2"   >You are now connected to database "digoal" as user "digoal".</font></div><div><font size="2"   >-- 创建测试表, 主键c3,c5,c6. 是目前的物理位置, 也是逻辑位置.</font></div><div><div><font size="2"   >digoal=&gt; create table build_test(c1 int, c2 text, c3 int2, c4 name, c5 text, c6 timestamp, primary key(c3,c5,c6));</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "build_test_pkey" for table "build_test"</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >-- 插入测试数据</font></div><div><font size="2"   >digoal=&gt; &nbsp;insert into build_test values (1,'test',2,'build','digoal',now());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=&gt; select * from build_test ;</font></div><div><font size="2"   >&nbsp;c1 | &nbsp;c2 &nbsp;| c3 | &nbsp;c4 &nbsp; | &nbsp; c5 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c6 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----+------+----+-------+--------+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | test | &nbsp;2 | build | digoal | 2013-03-12 22:38:14.358793</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >-- pg_attribute中显示了物理位置.</font></div><div><font size="2"   >--&nbsp;attisdropped标记列是否被删除. 所以会造成物理位置没有变化但是逻辑位置变化的情况, PostgreSQL 9.x DBLINK build SQL的函数使用的是逻辑位置.</font></div><div><font size="2"   >digoal=&gt; select attname,attnum from pg_attribute where attrelid='build_test'::regclass;</font></div><div><font size="2"   >&nbsp;attname &nbsp;| attnum&nbsp;</font></div><div><font size="2"   >----------+--------</font></div><div><font size="2"   >&nbsp;tableoid | &nbsp; &nbsp; -7</font></div><div><font size="2"   >&nbsp;cmax &nbsp; &nbsp; | &nbsp; &nbsp; -6</font></div><div><font size="2"   >&nbsp;xmax &nbsp; &nbsp; | &nbsp; &nbsp; -5</font></div><div><font size="2"   >&nbsp;cmin &nbsp; &nbsp; | &nbsp; &nbsp; -4</font></div><div><font size="2"   >&nbsp;xmin &nbsp; &nbsp; | &nbsp; &nbsp; -3</font></div><div><font size="2"   >&nbsp;ctid &nbsp; &nbsp; | &nbsp; &nbsp; -1</font></div><div><font size="2"   >&nbsp;c1 &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >&nbsp;c2 &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >&nbsp;c3 &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;3</font></div><div><font size="2"   >&nbsp;c4 &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;4</font></div><div><font size="2"   >&nbsp;c5 &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;5</font></div><div><font size="2"   >&nbsp;c6 &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;6</font></div><div><font size="2"   >(12 rows)</font></div></div></div><div><font size="2"   >-- 使用物理位置pg_attribute.attnum, 创建SQL</font></div><div><div><font size="2"   >digoal=&gt; select * from dblink_build_sql_insert('build_test', '3 5 6'::int2vector, 3, array['2', 'digoal', '2013-03-12 22:38:14.358793'], array['2', 'digoal', '2013-03-12 22:38:14.358793']);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dblink_build_sql_insert &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;INSERT INTO build_test(c1,c2,c3,c4,c5,c6) VALUES('1','test','2','build','digoal','2013-03-12 22:38:14.358793')</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >-- 删除c1列, 逻辑位置变化, 但是物理位置不变</font></div><div><div><font size="2"   >digoal=&gt; alter table build_test drop column c1;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >-- 8.4继续使用物理位置创建SQL没有问题.</font></div><div><font size="2"   >digoal=&gt; select * from dblink_build_sql_insert('build_test', '3 5 6'::int2vector, 3, array['2', 'digoal', '2013-03-12 22:38:14.358793'], array['2', 'digoal', '2013-03-12 22:38:14.358793']);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dblink_build_sql_insert &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;INSERT INTO build_test(c2,c3,c4,c5,c6) VALUES('test','2','build','digoal','2013-03-12 22:38:14.358793')</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div><br></div>【参考】<wbr><div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><span style="line-height: 25px;"   >1.&nbsp;</span><a style="line-height: 22px; font-family: Arial, Helvetica, sans-serif;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201321125220134/"   >http://blog.163.com/digoal@126/blog/static/163877040201321125220134/</a></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >2.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013283547959/"   >http://blog.163.com/digoal@126/blog/static/1638770402013283547959/</a><br style="line-height: 25px;"   >3.&nbsp;<a style="line-height: 22px; font-family: Arial, Helvetica, sans-serif;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013211102130526/"   >http://blog.163.com/digoal@126/blog/static/1638770402013211102130526/</a></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >4.&nbsp;<a style="line-height: 22px; font-family: Arial, Helvetica, sans-serif;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012731944439/"   >http://blog.163.com/digoal@126/blog/static/1638770402012731944439/</a></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >5.&nbsp;<a style="line-height: 22px; font-family: Arial, Helvetica, sans-serif;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012731203716/"   >http://blog.163.com/digoal@126/blog/static/1638770402012731203716/</a></div></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >6.&nbsp;<a style="font-family: Arial, Helvetica, sans-serif; line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/contrib-dblink-build-sql-insert.html"   >http://www.postgresql.org/docs/9.2/static/contrib-dblink-build-sql-insert.html</a></div></div>
	</div>
</div>
</body>
</html>