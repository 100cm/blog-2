<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL timestamp value attention 'now' IS timestamp constant or text constant</h2>
	<h5 id="">2013-03-14 9:51:37&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201321491315436/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>时间类型timestamp或者timestamptz有一个特殊值, now;</div><div>在使用时需要注意, 它到底是常量还是变量, 和它使用的场景有关系.</div><div>最好不要使用, 建议使用now()函数代替之.</div><div><br></div><div>-- 'now'每次调用时先转换成时间再传入$1, 所以每次是变化的.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >remote=&gt; prepare a(timestamp) as select $1;</font></div><div><font size="2"   >PREPARE</font></div><div><font size="2"   >remote=&gt; execute a('now');</font></div><div><font size="2"   >&nbsp;2013-03-14 09:05:34.562312</font></div><div><font size="2"   >remote=&gt; execute a('now');</font></div><div><font size="2"   >&nbsp;2013-03-14 09:05:35.6413</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >-- 'now'</span><span style="line-height: 22px;"   >每次调用时先转换成text再传入$1, 然后再转换成timestamp类型.&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >remote=&gt; prepare b(text) as select $1::timestamp;</font></div><div><font size="2"   >PREPARE</font></div><div><font size="2"   >remote=&gt; execute b('now');</font></div><div><font size="2"   >&nbsp;2013-03-14 09:05:54.894175</font></div><div><font size="2"   >remote=&gt; execute b('now');</font></div><div><font size="2"   >&nbsp;2013-03-14 09:05:55.541578</font></div><p></p></pre></div><div>-- 'now'是个常量, 但是是text常量, 每次执行时将这个常量转换成timestamp类型.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >remote=&gt; prepare d as select 'now'::text::timestamp;</font></div><div><font size="2"   >PREPARE</font></div><div><font size="2"   >remote=&gt; execute d;</font></div><div><font size="2"   >&nbsp;2013-03-14 09:12:23.128624</font></div><div><font size="2"   >remote=&gt; execute d;</font></div><div><font size="2"   >&nbsp;2013-03-14 09:12:23.783772</font></div><p></p></pre></div><div>--&nbsp;<span style="line-height: 22px;"   >'now'是个常量, 但是是text常量, 每次执行时将这个常量转换成timestamp类型.</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >remote=&gt; prepare e as select (text 'now')::timestamp;</font></div><div><font size="2"   >PREPARE</font></div><div><font size="2"   >remote=&gt; execute e;</font></div><div><font size="2"   >&nbsp;2013-03-14 09:12:58.697479</font></div><div><font size="2"   >remote=&gt; execute e;</font></div><div><font size="2"   >&nbsp;2013-03-14 09:12:59.524841</font></div><p></p></pre></div><div>-- 'now' 是个timestamp常量, 在prepare时已经解析掉, 所以每次调用值不变.&nbsp;</div></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >remote=&gt; prepare c as select 'now'::timestamp;</font></span></div><div><div style="line-height: 22px;"   ><font size="2"   >PREPARE</font></div><div style="line-height: 22px;"   ><font size="2"   >remote=&gt; execute c;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;2013-03-14 09:06:27.695022</font></div><div style="line-height: 22px;"   ><font size="2"   >remote=&gt; execute c;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;2013-03-14 09:06:27.695022</font></div></div><p></p></pre></div><div>-- 同上</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >remote=&gt; prepare g as select timestamp 'now';</font></div><div><font size="2"   >PREPARE</font></div><div><font size="2"   >remote=&gt; execute g;</font></div><div><font size="2"   >&nbsp;2013-03-14 09:27:51.799889</font></div><div><font size="2"   >remote=&gt; execute g;</font></div><div><font size="2"   >&nbsp;2013-03-14 09:27:51.799889</font></div><p></p></pre></div><div>-- 同上</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >remote=&gt; prepare h as select timestamptz 'now';</font></div><div><font size="2"   >PREPARE</font></div><div><font size="2"   >remote=&gt; execute h;</font></div><div><font size="2"   >&nbsp;2013-03-14 09:27:59.942468+08</font></div><div><font size="2"   >remote=&gt; execute h;</font></div><div><font size="2"   >&nbsp;2013-03-14 09:27:59.942468+08</font></div><p></p></pre></div></div><div><br></div><div>鉴于这个特性, 在plpgsql中使用时需要特别注意.</div><div>如下函数 :&nbsp;</div><div><div><pre class="prettyprint"   ><p><font size="2"   >create table logtable(c1 text, c2 timestamp);</font></p></pre></div><div>-- 因为c2是timestamp类型, 在赋值的位置已知它的类型的时候, 可以直接转换为常量. 如下第一个函数.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >CREATE FUNCTION logfunc1(logtxt text) RETURNS void AS $$</font></div><div><font size="2"   >&nbsp; &nbsp; BEGIN</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; INSERT INTO logtable VALUES (logtxt, 'now');</font></div><div><font size="2"   >&nbsp; &nbsp; END;</font></div><div><font size="2"   >$$ LANGUAGE plpgsql;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >select logfunc1('abc');</font></div></div><div><span style="line-height: 22px;"   ><font size="2"   >select logfunc1('abc');</font></span></div><div><span style="line-height: 22px;"   ><div><font size="2"   >remote=&gt; select * from logtable ;</font></div><div><font size="2"   >&nbsp;c1 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----+----------------------------</font></div><div><font size="2"   >&nbsp;abc | 2013-03-14 09:40:46.879857</font></div><div><font size="2"   >&nbsp;abc | 2013-03-14 09:40:46.879857</font></div><div><font size="2"   >(2 rows)</font></div></span></div><p></p></pre></div></div><div><span style="line-height: 22px;"   ><div>-- 以上两次调用插入的时间值一样. 其实只要会话不退出, 以后调用<span style="line-height: 22px;"   >logfunc1得到的时间值都一样.</span></div></span><span style="line-height: 22px;"   ><div><br></div><div>-- 接下来的这个函数, 'now' 作为text常量, 而非timestamp常量.</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><div><div><font size="2"   >CREATE FUNCTION logfunc2(logtxt text) RETURNS void AS $$</font></div><div><font size="2"   >&nbsp; &nbsp; DECLARE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; curtime timestamp;</font></div><div><font size="2"   >&nbsp; &nbsp; BEGIN</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; curtime := 'now';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; INSERT INTO logtable VALUES (logtxt, curtime);</font></div><div><font size="2"   >&nbsp; &nbsp; END;</font></div><div><font size="2"   >$$ LANGUAGE plpgsql;</font></div></div></span></div><div><font size="2"   ><br></font></div><div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >select logfunc2('abc');</font></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >select logfunc2('abc');</font></span></div></div><div><div><font size="2"   >remote=&gt; select * from logtable ;</font></div><div><font size="2"   >&nbsp;c1 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----+----------------------------</font></div><div><font size="2"   >&nbsp;abc | 2013-03-14 09:40:46.879857</font></div><div><font size="2"   >&nbsp;abc | 2013-03-14 09:40:46.879857</font></div><div><font size="2"   >&nbsp;abc | 2013-03-14 09:41:39.626445</font></div><div><font size="2"   >&nbsp;abc | 2013-03-14 09:41:40.992602</font></div><div><font size="2"   >(4 rows)</font></div></div><p></p></pre></div></span></div><div>-- 使用<span style="line-height: 22px;"   >logfunc2函数, 得到的时间值每次都在变化.</span></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >-- 接下来的函数</span><span style="line-height: 22px;"   >timestamp 'now';是个时间常量</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 22px;"   ><font size="2"   >CREATE FUNCTION logfunc3(logtxt text) RETURNS void AS $$</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; DECLARE</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; curtime timestamp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; BEGIN</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; curtime := timestamp 'now';</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; INSERT INTO logtable VALUES (logtxt, curtime);</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; END;</font></div><div style="line-height: 22px;"   ><font size="2"   >$$ LANGUAGE plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   ><br></font></div><div><font size="2"   >select logfunc3('abc3');</font></div></div><div><font size="2"   >select logfunc3('abc3');</font></div><div><div><font size="2"   >remote=&gt; select * from logtable ;</font></div><div><font size="2"   >&nbsp; c1 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------+----------------------------</font></div><div><font size="2"   >&nbsp;abc &nbsp;| 2013-03-14 09:40:46.879857</font></div><div><font size="2"   >&nbsp;abc &nbsp;| 2013-03-14 09:40:46.879857</font></div><div><font size="2"   >&nbsp;abc &nbsp;| 2013-03-14 09:41:39.626445</font></div><div><font size="2"   >&nbsp;abc &nbsp;| 2013-03-14 09:41:40.992602</font></div><div><font size="2"   >&nbsp;abc &nbsp;| 2013-03-14 09:40:46.879857</font></div><div><font size="2"   >&nbsp;abc3 | 2013-03-14 09:44:06.354965</font></div><div><font size="2"   >&nbsp;abc3 | 2013-03-14 09:44:06.354965</font></div><div><font size="2"   >(7 rows)</font></div></div><p></p></pre></div></div><div><br></div><div>【小结】</div><div>1. 时间常量的正确用法是直接的类型提供, 而不要通过间接转换的方式.</div><div>例如&nbsp;<span style="line-height: 22px;"   >curtime := timestamp 'now'; 和&nbsp;</span><span style="line-height: 22px;"   >curtime := 'now'; 两者是存在差别的。</span></div><div><span style="line-height: 22px;"   >curtime := timestamp 'now'; 是直接的类型提供.&nbsp;</span><span style="line-height: 22px;"   >timestamp 'now'</span><span style="line-height: 22px;"   >是个时间常量.</span></div><div><span style="line-height: 22px;"   >curtime := 'now'; 提供的now是text类型, 最终用的时候是text_out('now') 和 timestamp_in(); 所以这里'now'不是时间常量. 而是个text常量.</span></div><div><br></div><wbr></div>
	</div>
</div>
</body>
</html>