<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL Parallel Export consistent data or Parallel Query use snapshot transaction feature</h2>
	<h5 id="">2013-03-06 9:55:30&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201326829943/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.2 的一个新特性支持事务状态的导出和导入, 以前写过一篇文章测试这项特性,</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012416105232835/"   >http://blog.163.com/digoal@126/blog/static/1638770402012416105232835/</a></div><div>本文主要是针对这项特性的一个延展, 利用这个特性可以让PostgreSQL 支持并行的一致性数据导出, 或者并行查询.</div><div><br></div><div>首先测试两个事务导出和导入的场景, 从测试结果可以看到多个事务导入同一个事务状态后看到了一致的数据.</div><div>同时如果导出事务状态的事务提前结束, 状态可以保持, 不会影响导入这个状态的事务的一致性.</div><div>一、导出repeatable read 事务状态.</div><div>SESSION A(导出repeatable read事务状态) :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# drop table snapshot ;</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >postgres=# create table snapshot (id int, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# insert into snapshot values (1,'abc');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=# begin transaction isolation level repeatable read;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# SELECT pg_export_snapshot();</font></div><div><font size="2"   >&nbsp;pg_export_snapshot&nbsp;</font></div><div><font size="2"   >--------------------</font></div><div><font size="2"   >&nbsp;000007E9-1</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >SESSION B(修改数据,自动提交) :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into snapshot values (2,'test');</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >SESSION C(导入</span><span style="line-height: 22px;"   >repeatable read事务状态, 查看数据</span><span style="line-height: 22px;"   >) :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# begin transaction isolation level repeatable read;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# SET TRANSACTION SNAPSHOT '000007E9-1';</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >postgres=# select * from snapshot ;</font></div><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | abc</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >SESSION B(修改数据</span><span style="line-height: 22px;"   >,自动提交</span><span style="line-height: 22px;"   >) :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into snapshot values (3,'test');</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >SESSION D</span><span style="line-height: 22px;"   >(导入</span><span style="line-height: 22px;"   >repeatable read事务状态, 查看数据</span><span style="line-height: 22px;"   >)</span><span style="line-height: 22px;"   >&nbsp;:&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# begin transaction isolation level repeatable read;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# SET TRANSACTION SNAPSHOT '000007E9-1';</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >postgres=# select * from snapshot ;</font></div><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | abc</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >SESSION A(结束事务</span><span style="line-height: 22px;"   >, 不会影响已导入事务状态的事务的一致性</span><span style="line-height: 22px;"   >) :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# end;</font></div><div><font size="2"   >COMMIT</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >SESSION B(</span><span style="line-height: 22px;"   >修改数据</span><span style="line-height: 22px;"   >,自动提交</span><span style="line-height: 22px;"   >) :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into snapshot values (4,'test');</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >SESSION C(查询数据) :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from snapshot ;</font></div><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | abc</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >SESSION D(查询数据) :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from snapshot ;</font></div><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | abc</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>二、<span style="line-height: 22px;"   >导出read committed事务状态.</span></div><div><div style="line-height: 22px;"   >SESSION A(导出read committed事务状态) :&nbsp;</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >postgres=# drop table snapshot ;</font></div><div style="line-height: 22px;"   ><font size="2"   >DROP TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   >postgres=# create table snapshot (id int, info text);</font></div><div style="line-height: 22px;"   ><font size="2"   >CREATE TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   >postgres=# insert into snapshot values (1,'abc');</font></div><div style="line-height: 22px;"   ><font size="2"   >INSERT 0 1</font></div><div style="line-height: 22px;"   ><font size="2"   >postgres=# begin transaction isolation level read committed;</font></div><div style="line-height: 22px;"   ><font size="2"   >BEGIN</font></div><div><div><font size="2"   >postgres=# SELECT pg_export_snapshot();</font></div><div><font size="2"   >&nbsp;pg_export_snapshot&nbsp;</font></div><div><font size="2"   >--------------------</font></div><div><font size="2"   >&nbsp;000007F0-1</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div></div><div style="line-height: 22px;"   >SESSION B(修改数据<span style="line-height: 22px;"   >,自动提交</span><span style="line-height: 22px;"   >) :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into snapshot values (2,'test');</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div style="line-height: 22px;"   >SESSION C(导入<span style="line-height: 22px;"   >read committed事务状态, 查看数据</span><span style="line-height: 22px;"   >) :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# begin transaction isolation level repeatable read;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# SET TRANSACTION SNAPSHOT '000007F0-1';</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >postgres=# select * from snapshot ;</font></div><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | abc</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="line-height: 22px;"   >SESSION B(修改数据<span style="line-height: 22px;"   >,自动提交</span><span style="line-height: 22px;"   >) :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into snapshot values (3,'test');</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div style="line-height: 22px;"   >SESSION D<span style="line-height: 22px;"   >(导入</span><span style="line-height: 22px;"   >read committed事务状态, 查看数据</span><span style="line-height: 22px;"   >)</span><span style="line-height: 22px;"   >&nbsp;:&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# begin transaction isolation level repeatable read;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# SET TRANSACTION SNAPSHOT '000007F0-1';</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >postgres=# select * from snapshot ;</font></div><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | abc</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="line-height: 22px;"   >SESSION A(结束事务, 不会影响已导入事务状态的事务的一致性) :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# end;</font></div><div><font size="2"   >COMMIT</font></div><p></p></pre></div><div style="line-height: 22px;"   >SESSION B(<span style="line-height: 22px;"   >修改数据</span><span style="line-height: 22px;"   >,自动提交</span><span style="line-height: 22px;"   >) :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into snapshot values (4,'test');</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div style="line-height: 22px;"   >SESSION C(查询数据) :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from snapshot ;</font></div><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | abc</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="line-height: 22px;"   >SESSION D(查询数据) :&nbsp;</div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from snapshot ;</font></div><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | abc</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="line-height: 22px;"   >从上面的测试可用看出, 导出事务状态的事务不管是read committed还是repeatable read的, 不影响后续事务导入的结果.</div><div style="line-height: 22px;"   >但是需要注意, 以下场景则存在差异, 这也是read committed和repeatable read事务的特性差异, 并不会影响后续多节点导入这个事务状态后的数据一致性观测.&nbsp;</div><div style="line-height: 22px;"   >注意pg_export_snapshot()会获得一个事务号.</div><div style="line-height: 22px;"   >而begin; 并不会马上获得事务号, 需要在第一条变更数据的语句开启前获得. 或者使用txid_current()直接获得.</div><div style="line-height: 22px;"   >1. repeatable read :&nbsp;</div><div><div>SESSION A(启动repeatable read事务<span style="line-height: 22px;"   >)</span><span style="line-height: 22px;"   >&nbsp;:&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# drop table snapshot ;</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >postgres=# create table snapshot (id int, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# insert into snapshot values (1,'abc');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=# begin transaction isolation level repeatable read;</font></div><div><font size="2"   >BEGIN</font></div></div><div><div><font size="2"   >postgres=# select txid_current();</font></div><div><font size="2"   >&nbsp;txid_current&nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2045</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div></div><div><span style="line-height: 22px;"   >SESSION B(修改数据) :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into snapshot values (2,'test');</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >SESSION A(</span><span style="line-height: 22px;"   >导出repeatable read事务状态</span><span style="line-height: 22px;"   >) :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# SELECT pg_export_snapshot();</font></div><div><font size="2"   >&nbsp;pg_export_snapshot&nbsp;</font></div><div><font size="2"   >--------------------</font></div><div><font size="2"   >&nbsp;000007FD-1</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >SESISON C(</span><span style="line-height: 22px;"   >导入</span><span style="line-height: 22px;"   >repeatable read事务状态, 查看数据</span><span style="line-height: 22px;"   >) :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# begin transaction isolation level repeatable read;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# SET TRANSACTION SNAPSHOT '000007FD-1';</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >postgres=# select * from snapshot ;</font></div><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | abc</font></div><div><font size="2"   >(1 row)</font></div></pre></div><div><span style="line-height: 22px;"   >2. read committed :&nbsp;</span></div><div>SESSION A(<span style="line-height: 22px;"   >启动read committed事务</span><span style="line-height: 22px;"   >) :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# drop table snapshot ;</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >postgres=# create table snapshot (id int, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# insert into snapshot values (1,'abc');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=# begin transaction isolation level read committed ;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# select txid_current();</font></div><div><font size="2"   >&nbsp;txid_current&nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2050</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >SESSION B(修改数据) :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into snapshot values (2,'test');</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >SESSION A(</span><span style="line-height: 22px;"   >导出read committed事务状态</span><span style="line-height: 22px;"   >) :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# SELECT pg_export_snapshot(); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;pg_export_snapshot&nbsp;</font></div><div><font size="2"   >--------------------</font></div><div><font size="2"   >&nbsp;00000802-1</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >SESSION C(</span><span style="line-height: 22px;"   >导入</span><span style="line-height: 22px;"   >read committed事务状态, 查看数据</span><span style="line-height: 22px;"   >) :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# begin transaction isolation level repeatable read;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# SET TRANSACTION SNAPSHOT '00000802-1';</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >postgres=# select * from snapshot ;</font></div><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | abc</font></div><div><font size="2"   >&nbsp; 2 | test</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div><br></div><div style="line-height: 22px;"   >三、并行导出一致性数据.</div><div style="line-height: 22px;"   >1. 单节点导出事务状态</div><div style="line-height: 22px;"   >2. 多节点导入事务状态, 同时copy数据.</div><div style="line-height: 22px;"   >测试 :&nbsp;</div><div style="line-height: 22px;"   >测试数据 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create table a(id int primary key, info text, crt_time timestamp);</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "a_pkey" for table "a"</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table b(id int primary key, info text, crt_time timestamp);</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "b_pkey" for table "b"</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# insert into a select generate_series(1,1000000), md5(clock_timestamp()::text), clock_timestamp();</font></div><div><font size="2"   >INSERT 0 1000000</font></div><div><font size="2"   >postgres=# insert into b select generate_series(1,1000000), md5(clock_timestamp()::text), clock_timestamp();</font></div><div><font size="2"   >INSERT 0 1000000</font></div><p></p></pre></div><div style="line-height: 22px;"   >导出事务状态 :&nbsp;</div><div style="line-height: 22px;"   >SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# begin transaction isolation level repeatable read;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# SELECT pg_export_snapshot();</font></div><div><font size="2"   >&nbsp;pg_export_snapshot&nbsp;</font></div><div><font size="2"   >--------------------</font></div><div><font size="2"   >&nbsp;0000080E-1</font></div><div><font size="2"   >(1 row)</font></div></pre></div><div style="line-height: 22px;"   >并行导出数据 :&nbsp;</div><div style="line-height: 22px;"   >SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# begin transaction isolation level repeatable read;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# SET TRANSACTION SNAPSHOT '0000080E-1';</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >postgres=# copy a to '/home/ocz/a.csv' with csv;</font></div><div><font size="2"   >COPY 1000000</font></div></pre></div><div style="line-height: 22px;"   >SESSION C :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# begin transaction isolation level repeatable read;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# SET TRANSACTION SNAPSHOT '0000080E-1';</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >postgres=# copy b to '/home/ocz/b.csv' with csv;</font></div><div><font size="2"   >COPY 1000000</font></div><p></p></pre></div><div>使用以上方法的并行导出用到的shell脚本可以参考本文末尾.</div><div>PostgreSQL 9.3可能会将并行导出的功能添加到pg_dump工具中. 如下 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="https://commitfest.postgresql.org/action/patch_view?id=785"   >https://commitfest.postgresql.org/action/patch_view?id=785</a></div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/message-id/flat/CACw0+10wAM_L6iC8KKL5eGzUtVjSpum1MEhaggWx5kU4VYn-QA@mail.gmail.com#CACw0+10wAM_L6iC8KKL5eGzUtVjSpum1MEhaggWx5kU4VYn-QA@mail.gmail.com"   >http://www.postgresql.org/message-id/flat/CACw0+10wAM_L6iC8KKL5eGzUtVjSpum1MEhaggWx5kU4VYn-QA@mail.gmail.com#CACw0+10wAM_L6iC8KKL5eGzUtVjSpum1MEhaggWx5kU4VYn-QA@mail.gmail.com</a></div><div><br></div><div>四、并行查询与并行导出类似, 也可以借鉴snapshot的特性.</div><div><div style="line-height: 22px;"   >1. 单节点导出事务状态</div><div style="line-height: 22px;"   >2. 多节点导入事务状态, 同时按照一定的规则并行查询, 合并查询结果<span style="line-height: 22px;"   >.</span></div></div><div style="line-height: 22px;"   ><br></div>【参考】<div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/sql-set-transaction.html"   >http://www.postgresql.org/docs/9.2/static/sql-set-transaction.html</a></div><div>2.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/functions-admin.html#FUNCTIONS-SNAPSHOT-SYNCHRONIZATION"   >http://www.postgresql.org/docs/9.2/static/functions-admin.html#FUNCTIONS-SNAPSHOT-SYNCHRONIZATION</a></div><div>3.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012416105232835/"   >http://blog.163.com/digoal@126/blog/static/1638770402012416105232835/</a></div><div>4.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201241134721101/"   >http://blog.163.com/digoal@126/blog/static/163877040201241134721101/</a></div><div>5.&nbsp;src/backend/utils/time/snapmgr.c</div><div>6.&nbsp;src/bin/pg_dump/pg_dump.c</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Start transaction-snapshot mode transaction to dump consistent data.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ExecuteSqlStatement(fout, "BEGIN");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (fout-&gt;remoteVersion &gt;= 90100)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (serializable_deferrable)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ExecuteSqlStatement(fout,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "SET TRANSACTION ISOLATION LEVEL "</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "SERIALIZABLE, READ ONLY, DEFERRABLE");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ExecuteSqlStatement(fout,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "SET TRANSACTION ISOLATION LEVEL "</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "REPEATABLE READ");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ExecuteSqlStatement(fout,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "SET TRANSACTION ISOLATION LEVEL SERIALIZABLE");</font></div><p></p></pre></div>7.&nbsp;<wbr><a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/message-id/flat/CACw0+10wAM_L6iC8KKL5eGzUtVjSpum1MEhaggWx5kU4VYn-QA@mail.gmail.com#CACw0+10wAM_L6iC8KKL5eGzUtVjSpum1MEhaggWx5kU4VYn-QA@mail.gmail.com"   >http://www.postgresql.org/message-id/flat/CACw0+10wAM_L6iC8KKL5eGzUtVjSpum1MEhaggWx5kU4VYn-QA@mail.gmail.com#CACw0+10wAM_L6iC8KKL5eGzUtVjSpum1MEhaggWx5kU4VYn-QA@mail.gmail.com</a></div><div>8.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.depesz.com/2013/03/05/parallel-dumping-of-databases/"   >http://www.depesz.com/2013/03/05/parallel-dumping-of-databases/</a></div><div>9. 并行dump脚本可以参考depesz的进行修改 :&nbsp;</div><div>以下用于导出digoal库. PGHOST=sockdir</div><div><div>ocz@db-172-16-3-150-&gt; cat dump.sh</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#!/usr/bin/env bash</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   ># configuration</font></div><div><font size="2"   >PATH=$PATH:$HOME/bin</font></div><div><font size="2"   >export PATH</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/home/ocz/pgsql9.2.1</font></div><div><font size="2"   >export LD_LIBRARY_PATH=/opt/uuid-1.6.2/lib:$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >export PGDATA=/data05/ocz/pg_root</font></div><div><font size="2"   >export PGPORT=9201</font></div><div><font size="2"   >export PGUSER=postgres</font></div><div><font size="2"   >export PGHOST=$PGDATA</font></div><div><font size="2"   >export PGDATABASE=digoal</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Temporary directory for small helper files</font></div><div><font size="2"   >tmp_dir="$( mktemp -d )"</font></div><div><font size="2"   >trap 'rm -rf "$tmp_dir"' EXIT</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   ># Run master psql</font></div><div><font size="2"   >exec 50&gt; &gt;( exec psql -qAtX )</font></div><div><font size="2"   >master_pid="$!"</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   ># Start transaction</font></div><div><font size="2"   >printf 'BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;\n' &gt;&amp;50</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   ># Get transaction snapshot id</font></div><div><font size="2"   >printf '\o %s/snapshot.id\n' "$tmp_dir" &gt;&amp;50</font></div><div><font size="2"   >printf 'SELECT pg_export_snapshot();\n' &gt;&amp;50</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   ># Get list of tables to dump</font></div><div><font size="2"   >printf '\o %s/tables.list\n' "$tmp_dir" &gt;&amp;50</font></div><div><font size="2"   >printf 'SELECT c.oid::regclass FROM pg_class c join pg_namespace n on c.relnamespace = n.oid WHERE c.relkind = $$r$$ and n.nspname !~ $$^(pg_|information_schema)$$ ORDER BY pg_table_size(c.oid) desc;\n' &gt;&amp;50</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   ># Create file that marks that all is done in master</font></div><div><font size="2"   >printf '\o %s/marker.file\n' "$tmp_dir" &gt;&amp;50</font></div><div><font size="2"   >printf 'SELECT 1;\n' &gt;&amp;50</font></div><div><font size="2"   >printf '\o\n' &gt;&amp;50</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   ># Wait for marker file to appear</font></div><div><font size="2"   >while true</font></div><div><font size="2"   >do</font></div><div><font size="2"   >&nbsp; &nbsp; if [[ -s "$tmp_dir/marker.file" ]]</font></div><div><font size="2"   >&nbsp; &nbsp; then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; break</font></div><div><font size="2"   >&nbsp; &nbsp; fi</font></div><div><font size="2"   >&nbsp; &nbsp; sleep 0.1</font></div><div><font size="2"   >done</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   ># Get snapshot id to variable</font></div><div><font size="2"   >snapshot_id="$( &lt; "$tmp_dir/snapshot.id" )"</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   ># Dump each table separately</font></div><div><font size="2"   >while read table_name</font></div><div><font size="2"   >do</font></div><div><font size="2"   >&nbsp; &nbsp; printf "BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;\nSET TRANSACTION SNAPSHOT '%s';\nCOPY %s TO STDOUT;\n" "$snapshot_id" "$table_name" | psql -qAtX &gt; "$table_name.dump" &amp;</font></div><div><font size="2"   >done &lt; "$tmp_dir/tables.list"</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   ># wait for all dumps to finish</font></div><div><font size="2"   >wait</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >echo "All done."</font></div><p></p></pre></div></div></div>
	</div>
</div>
</body>
</html>