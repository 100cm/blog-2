<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.2.3 performance tested in kvm virtual machine</h2>
	<h5 id="">2013-03-28 15:52:44&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201322815029796/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>本文主要测试一下PostgreSQL数据库在KVM虚拟机环境中的使用和性能.</div><div><br></div><wbr>一、主机硬件 :&nbsp;<div><pre class="prettyprint"   ><p></p><div><font size="2"   >CPU : 2 *&nbsp;Intel(R) Xeon(R) CPU E5504 &nbsp;@ 2.00GHz(由于PCI-E插槽满插,实际CPU使用1.6G)</font></div><div><font size="2"   >MEM : 96GB DDR3 800MHz</font></div><div><font size="2"   >NETCARD : 1GB</font></div><div><font size="2"   >DISK : DELL MZ-5EA2000-0D3 200G SSD</font></div><div><font size="2"   >OS : Ubuntu 12.04.2 x64</font></div><div><div><font size="2"   >虚拟机软件 : KVM(<span style="line-height: 22px;"   >磁盘, 网卡使用virtio)</span></font></div><div><font size="2"   >虚拟机操作系统 : CentOS 5.9 x64</font></div></div><p></p></pre></div><div><div><br></div><div>二、KVM虚拟机环境安装以及配置简要描述 :&nbsp;</div><div><div>安装软件包 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >sudo apt-get install kvm libvirt-bin virt-manager virt-viewer virtinst</font></div><div><font size="2"   >sudo apt-get install bridge-utils</font></div><p></p></pre></div><div>给普通用户添加libvirtd, kvm组.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >sudo adduser digoal libvirtd</font></div><div><font size="2"   >sudo adduser digoal kvm</font></div><p></p></pre></div><div># 确认kvm硬件加速已正常</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >sudo kvm-ok</font></div><div><font size="2"   >[sudo] password for digoal:&nbsp;</font></div><div><font size="2"   >INFO: /dev/kvm exists</font></div><div><font size="2"   >KVM acceleration can be used</font></div><p></p></pre></div><div>配置网桥</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >sudo vi /etc/network/interfaces</font></div><div><font size="2"   >auto lo</font></div><div><font size="2"   >iface lo inet loopback</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >auto br0</font></div><div><font size="2"   >iface br0 inet static</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; address 192.168.2.8</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; network 192.168.2.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; netmask 255.255.255.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; broadcast 192.168.2.255</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; gateway 192.168.2.1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; dns-nameservers 202.101.172.35 192.168.2.1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bridge_ports eth0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bridge_fd 9</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bridge_hello 2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bridge_maxage 12</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bridge_stp off</font></div><p></p></pre></div><div>重启网络服务</div><div><pre class="prettyprint"   ><p><font size="2"   >sudo /etc/init.d/networking restart</font></p></pre></div><div><br></div><div>配置虚拟机文件分区, /data01 为ssd所在分区.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >mkdir /data01/vm</font></div><div><font size="2"   >chown digoal:digoal /data01/vm</font></div><p></p></pre></div><div>创建虚拟机磁盘镜像文件.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - digoal</font></div><div><font size="2"   >qemu-img create -f qcow2 -o encryption=off,cluster_size=2M,preallocation=off /data01/vm/centos5.9_64_01.img 16G</font></div><p></p></pre></div><div><br></div><div>使用virt-manager创建虚拟机, 内存分配8GB, 1个VCPU</div><div>在虚拟机中安装CentOS 5.9 x64</div><div>最后确认虚拟机使用了硬盘virtio以及网卡virtio.</div><div>详细安装过程略.</div><div><br></div><div>启动虚拟机后, 连接到虚拟机环境, 安装PostgreSQL 9.2.3.</div><div>配置虚拟机网络</div><div>略</div><div>安装软件包</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >yum -y install lrzsz sysstat e4fsprogs ntp readline-devel zlib zlib-devel openssl openssl-devel pam-devel libxml2-devel libxslt-devel python-devel tcl-devel</font></div><div><div><font size="2"   >wget http://ftp.postgresql.org/pub/source/v9.2.3/postgresql-9.2.3.tar.bz2</font></div><div><font size="2"   >wget flex</font></div></div><p></p></pre></div><div>配置时间同步</div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >crontab -e</font></div><div><font size="2"   >&nbsp; -- 8 * * * * /usr/sbin/ntpdate asia.pool.ntp.org &amp;&amp; /sbin/hwclock --systohc</font></div><div><font size="2"   >/usr/sbin/ntpdate asia.pool.ntp.org &amp;&amp; /sbin/hwclock --systohc</font></div><p></p></pre></div><div>关闭不必要的服务</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >chkconfig acpid off</font></div><div><font size="2"   >chkconfig avahi-daemon off</font></div><div><font size="2"   >chkconfig bluetooth off</font></div><div><font size="2"   >chkconfig hidd off</font></div><div><font size="2"   >chkconfig smartd off</font></div><div><font size="2"   >chkconfig yum-updatesd off</font></div><div><font size="2"   >chkconfig hplip off</font></div><div><font size="2"   >chkconfig isdn off</font></div><div><font size="2"   >chkconfig iscsi off</font></div><div><font size="2"   >chkconfig iscsid off</font></div><div><font size="2"   >chkconfig multipathd on</font></div><p></p></pre></div><div>配置内核参数</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi /etc/sysctl.conf</font></div><div><font size="2"   >kernel.shmmni = 4096</font></div><div><font size="2"   >kernel.sem = 50100 64128000 50100 1280</font></div><div><font size="2"   >fs.file-max = 7672460</font></div><div><font size="2"   >net.ipv4.ip_local_port_range = 9000 65000</font></div><div><font size="2"   >net.core.rmem_default = 1048576</font></div><div><font size="2"   >net.core.rmem_max = 4194304</font></div><div><font size="2"   >net.core.wmem_default = 262144</font></div><div><font size="2"   >net.core.wmem_max = 1048576</font></div><div><font size="2"   >net.ipv4.tcp_tw_recycle = 1</font></div><div><font size="2"   >net.ipv4.tcp_max_syn_backlog = 4096</font></div><div><font size="2"   >net.core.netdev_max_backlog = 10000</font></div><div><font size="2"   >vm.overcommit_memory = 0</font></div><div><font size="2"   >net.ipv4.ip_conntrack_max = 655360</font></div><div><font size="2"   >fs.aio-max-nr = 1048576</font></div><div><font size="2"   >net.ipv4.tcp_timestamps = 0</font></div><div><font size="2"   ># sysctl -p</font></div><p></p></pre></div><div>配置限制参数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi /etc/security/limits.conf</font></div><div><font size="2"   >* soft &nbsp; &nbsp;nofile &nbsp;131072</font></div><div><font size="2"   >* hard &nbsp; &nbsp;nofile &nbsp;131072</font></div><div><font size="2"   >* soft &nbsp; &nbsp;nproc &nbsp; 131072</font></div><div><font size="2"   >* hard &nbsp; &nbsp;nproc &nbsp; 131072</font></div><div><font size="2"   >* soft &nbsp; &nbsp;core &nbsp; &nbsp;unlimited</font></div><div><font size="2"   >* hard &nbsp; &nbsp;core &nbsp; &nbsp;unlimited</font></div><div><font size="2"   >* soft &nbsp; &nbsp;memlock 50000000</font></div><div><font size="2"   >* hard &nbsp; &nbsp;memlock 50000000</font></div><p></p></pre></div><div>关闭selinux</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi /etc/sysconfig/selinux</font></div><div><font size="2"   >SELINUX=disabled</font></div><p></p></pre></div></div><div>重启服务器.</div><div>安装flex</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd /opt/soft_bak</font></div><div><font size="2"   >tar -jxvf flex-2.5.35.tar.bz2</font></div><div><font size="2"   >cd flex-2.5.35</font></div><div><font size="2"   >./configure &amp;&amp; make &amp;&amp; make install</font></div><p></p></pre></div><div>安装postgresql</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >useradd postgres</font></div><div><font size="2"   >cd /opt/soft_bak</font></div><div><font size="2"   >tar -jxvf&nbsp;postgresql-9.2.3.tar.bz2</font></div><p></p></pre></div><div>-- 配置profile</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - postgres</font></div><div><div><font size="2"   >vi /home/postgres/.bash_profile</font></div><div><div><font size="2"   >export PGPORT=1921</font></div><div><font size="2"   >export PGDATA=/data01/pgdata/pg_root</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/opt/pgsql</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"   >export PGUSER=postgres</font></div><div><font size="2"   >export PGHOST=$PGDATA</font></div><div><font size="2"   >export PGDATABASE=postgres</font></div><div><font size="2"   >alias rm='rm -i'</font></div><div><font size="2"   >alias ll='ls -lh'</font></div></div></div><p></p></pre></div><div>-- 安装postgresql软件</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >su - root</font></div><div><font size="2"   >cd /opt/soft_bak/postgresql-9.2.3</font></div><div><font size="2"   >./configure --prefix=/opt/pgsql9.2.3 --with-pgport=1921 --with-perl --with-tcl --with-python --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=16 --enable-debug &amp;&amp; gmake world</font></div><div><font size="2"   >gmake install-world</font></div></div><div><font size="2"   >ln -s /opt/pgsql9.2.3 /opt/pgsql</font></div><p></p></pre></div><div>-- 创建数据库目录</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >mkdir -p /data01/pgdata/pg_root</font></div><div><font size="2"   >chown -R postgres:postgres /data01/pgdata</font></div><p></p></pre></div><div>-- 初始化数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - postgres</font></div><div><font size="2"   >initdb -D /data01/pgdata/pg_root -E UTF8 --locale=C -U postgres -W</font></div><p></p></pre></div><div>-- 配置postgresql.conf参数文件</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi $PGDATA/postgresql.conf</font></div><div><div><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"   >port = 1921 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >max_connections = 500 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >superuser_reserved_connections = 13 &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_directory = '.' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_permissions = 0700 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# begin with 0 to use octal notation</font></div><div><font size="2"   >tcp_keepalives_idle = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPIDLE, in seconds;</font></div><div><font size="2"   >tcp_keepalives_interval = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPINTVL, in seconds;</font></div><div><font size="2"   >tcp_keepalives_count = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # TCP_KEEPCNT;</font></div><div><font size="2"   >shared_buffers = 1024MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div><font size="2"   >wal_level = hot_standby &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, or hot_standby</font></div><div><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level;</font></div><div><font size="2"   >wal_buffers = 16384kB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 32kB, -1 sets based on shared_buffers</font></div><div><font size="2"   >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"   >checkpoint_segments = 16 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# in logfile segments, min 1, 16MB each</font></div><div><font size="2"   >archive_mode = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # allows archiving to be done</font></div><div><font size="2"   >archive_command = '/bin/date' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # command to use to archive a logfile segment</font></div><div><font size="2"   >archive_timeout = 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # force a logfile segment switch after this</font></div><div><font size="2"   >max_wal_senders = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of walsender processes</font></div><div><font size="2"   >wal_keep_segments = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# in logfile segments, 16MB each; 0 disables</font></div><div><font size="2"   >hot_standby = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# "on" allows queries during recovery</font></div><div><font size="2"   >wal_receiver_status_interval = 1s &nbsp; &nbsp; &nbsp; # send replies at least this often</font></div><div><font size="2"   >hot_standby_feedback = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # send info from standby to prevent</font></div><div><font size="2"   >random_page_cost = 1.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# same scale as above</font></div><div><font size="2"   >effective_cache_size = 8192MB</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_directory = 'pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,</font></div><div><font size="2"   >log_file_mode = 0600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# creation mode for log files,</font></div><div><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div><font size="2"   >log_rotation_age = 1d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Automatic rotation of logfiles will</font></div><div><font size="2"   >log_rotation_size = 10MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Automatic rotation of logfiles will</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_disconnections = on</font></div><div><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div><font size="2"   >log_timezone = 'PRC'</font></div><div><font size="2"   >log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >timezone = 'PRC'</font></div><div><font size="2"   >lc_messages = 'en_US.utf8' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for system error message</font></div><div><font size="2"   >lc_monetary = 'en_US.utf8' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'en_US.utf8' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for number formatting</font></div><div><font size="2"   >lc_time = 'en_US.utf8' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div></div><p></p></pre></div><div>-- 启动数据库</div><div><pre class="prettyprint"   ><p><font size="2"   >pg_ctl start</font></p></pre></div><div><br></div><div>三、测试场景</div><div>-- 创建测试库</div><div><pre class="prettyprint"   ><p><font size="2"   >create database digoal;</font></p></pre></div><div><div>-- 创建测试表</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create table user_info</font></div><div><font size="2"   >(userid int,</font></div><div><font size="2"   >engname text,</font></div><div><font size="2"   >cnname text,</font></div><div><font size="2"   >occupation text,</font></div><div><font size="2"   >birthday date,</font></div><div><font size="2"   >signname text,</font></div><div><font size="2"   >email text,</font></div><div><font size="2"   >qq numeric,</font></div><div><font size="2"   >crt_time timestamp without time zone,</font></div><div><font size="2"   >mod_time timestamp without time zone</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create table user_session</font></div><div><font size="2"   >(userid int,</font></div><div><font size="2"   >logintime timestamp(0) without time zone,</font></div><div><font size="2"   >login_count bigint default 0,</font></div><div><font size="2"   >logouttime timestamp(0) without time zone,</font></div><div><font size="2"   >online_interval interval default interval '0'</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create table user_login_rec</font></div><div><font size="2"   >(userid int,</font></div><div><font size="2"   >login_time timestamp without time zone,</font></div><div><font size="2"   >ip inet</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create table user_logout_rec</font></div><div><font size="2"   >(userid int,</font></div><div><font size="2"   >logout_time timestamp without time zone,</font></div><div><font size="2"   >ip inet</font></div><div><font size="2"   >);</font></div><p></p></pre></div><div><br></div><div>-- 初始化测试数据</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >insert into user_info (userid,engname,cnname,occupation,birthday,signname,email,qq,crt_time,mod_time)</font></div><div><font size="2"   >select generate_series(1,2000000),</font></div><div><font size="2"   >'digoal.zhou',</font></div><div><font size="2"   >'德哥',</font></div><div><font size="2"   >'DBA',</font></div><div><font size="2"   >'1970-01-01'</font></div><div><font size="2"   >,E'公益是一辈子的事, I\'m Digoal.Zhou, Just do it!',</font></div><div><font size="2"   >'digoal@126.com',</font></div><div><font size="2"   >276732431,</font></div><div><font size="2"   >clock_timestamp(),</font></div><div><font size="2"   >NULL;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >insert into user_session (userid) select generate_series(1,2000000);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >set work_mem='2048MB';</font></div><div><font size="2"   >set maintenance_work_mem='2048MB';</font></div><div><font size="2"   >alter table user_info add constraint pk_user_info primary key (userid);</font></div><div><font size="2"   >alter table user_session add constraint pk_user_session primary key (userid);</font></div><div></div><p></p></pre></div><div><br></div><div>-- 模拟用户登录的函数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace function f_user_login&nbsp;</font></div><div><font size="2"   >(i_userid int,</font></div><div><font size="2"   >OUT o_userid int,</font></div><div><font size="2"   >OUT o_engname text,</font></div><div><font size="2"   >OUT o_cnname text,</font></div><div><font size="2"   >OUT o_occupation text,</font></div><div><font size="2"   >OUT o_birthday date,</font></div><div><font size="2"   >OUT o_signname text,</font></div><div><font size="2"   >OUT o_email text,</font></div><div><font size="2"   >OUT o_qq numeric</font></div><div><font size="2"   >)</font></div><div><font size="2"   >as $BODY$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div><font size="2"   >into o_userid,o_engname,o_cnname,o_occupation,o_birthday,o_signname,o_email,o_qq</font></div><div><font size="2"   >from user_info where userid=i_userid;</font></div><div><font size="2"   >insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"   >update user_session set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div><font size="2"   >return;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$BODY$</font></div><div><font size="2"   >language plpgsql;</font></div><p></p></pre></div><div><br></div><div>-- 模拟用户退出的函数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace function f_user_logout</font></div><div><font size="2"   >(i_userid int,</font></div><div><font size="2"   >OUT o_result int</font></div><div><font size="2"   >)</font></div><div><font size="2"   >as $BODY$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >insert into user_logout_rec (userid,logout_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"   >update user_session set logouttime=now(),online_interval=online_interval+(now()-logintime) where userid=i_userid;</font></div><div><font size="2"   >o_result := 0;</font></div><div><font size="2"   >return;</font></div><div><font size="2"   >exception&nbsp;</font></div><div><font size="2"   >when others then</font></div><div><font size="2"   >o_result := 1;</font></div><div><font size="2"   >return;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$BODY$</font></div><div><font size="2"   >language plpgsql;</font></div><p></p></pre></div><div><br></div><div><div style="line-height: 22px;"   >测试脚本 :&nbsp;</div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >su - postgres</font></div><div style="line-height: 22px;"   ><font size="2"   >vi login.sql</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 1 2000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login(:userid);</font></div><p></p></pre></div></div></div></div></div><div><br></div><div>四、3种虚拟机配置的测试结果</div><div>4.1 虚拟机配置1测试: (<span style="line-height: 22px;"   >1个vcpu, 8G内存</span><span style="line-height: 22px;"   >), 主机上无其他虚拟机.</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># cat /proc/cpuinfo&nbsp;</font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 0</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 15</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Core(TM)2 Duo CPU &nbsp; &nbsp; T7700 &nbsp;@ 2.40GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 11</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1596.000</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 10</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss syscall nx rdtscp lm constant_tsc up pni ssse3 cx16 sse4_1 sse4_2 popcnt lahf_lm</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3192.00</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management:</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >虚拟机启动参数 :&nbsp;</span></div><div><pre class="prettyprint"   ><p><font size="2"   >/usr/bin/kvm -S -M pc-1.0 -cpu core2duo,+lahf_lm,+rdtscp,+popcnt,+sse4.2,+sse4.1,+dca,+xtpr,+cx16,+tm2,+est,+vmx,+ds_cpl,+pbe,+tm,+ht,+ss,+acpi,+ds -enable-kvm -m 8192 -smp 1,sockets=1,cores=1,threads=1 -name centos-5.9-x64-01 -uuid f4a8170a-436d-a731-a5c5-8cc4b59acb71 -nodefconfig -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/centos-5.9-x64-01.monitor,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc -no-shutdown -drive file=/data02/vm/centos-5.9-x64_01.img,if=none,id=drive-virtio-disk0,format=qcow2 -device virtio-blk-pci,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive if=none,media=cdrom,id=drive-ide0-1-0,readonly=on,format=raw -device ide-drive,bus=ide.1,unit=0,drive=drive-ide0-1-0,id=ide0-1-0 -netdev tap,fd=18,id=hostnet0,vhost=on,vhostfd=19 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:fa:be:c3,bus=pci.0,addr=0x3 -chardev pty,id=charserial0 -device isa-serial,chardev=charserial0,id=serial0 -usb -vnc 127.0.0.1:0 -vga cirrus -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x5</font></p></pre></div><div><span style="line-height: 22px;"   >测试结果(根据经验值连接使用2*cpu个数) :&nbsp;</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 2 -f /home/postgres/login.sql -j 1 -n -T 60 -h $PGDATA -p 1921 -U postgres digoal</font></div><div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 2</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 177779</font></div><div><font size="2"   >tps = 2962.415241 (including connections establishing)</font></div><div><font size="2"   >tps = 2962.810601 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.004217 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 2000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.666220 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login(:userid);</font></div></div><p></p></pre></div><div>将连接加到16个, 在主机上看到的CPU开销还是120%左右, 与开2个连接一致. 所以KVM分配给虚拟机的CPU个数确实限制了资源的使用.</div><div>CPU的使用率相当于基本开销+100%.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[postgres@db-192-168-122-171 ~]$ pgbench -M prepared -r -c 16 -f /home/postgres/login.sql -j 4 -n -T 60 -h $PGDATA -p 1921 -U postgres digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 189494</font></div><div><font size="2"   >tps = 3152.515039 (including connections establishing)</font></div><div><font size="2"   >tps = 4051.201821 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002934 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 2000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 3.937482 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login(:userid);</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >测试过程中主机上看到的虚拟机开销</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;RES &nbsp;SHR S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;2880 libvirt- &nbsp;20 &nbsp; 0 10.8g 2.3g 6876 S &nbsp;120 &nbsp;2.4 &nbsp; 5:18.23 /usr/bin/kvm -S -M pc-1.0 -cpu core2duo,+lahf_lm,+rdtscp,+popcnt,+sse4.</font></div><p></p></pre></div></div><br><wbr></div><div>4.2 虚拟机配置2测试<span style="line-height: 22px;"   >: (</span><span style="line-height: 22px;"   >8个vcpu, 8G内存</span><span style="line-height: 22px;"   >)</span><span style="line-height: 22px;"   >, 主机上无其他虚拟机</span></div><div><span style="line-height: 22px;"   >通过virt-manager将该虚拟机的vCPU个数改到8. 重启虚拟机</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-192-168-122-171 ~]# cat /proc/cpuinfo |grep processor</font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 0</font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 1</font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 2</font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 3</font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 5</font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 6</font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 7</font></div><p></p></pre></div><div>在测试前, 看看CPU的开销, 这个开销是基本开销, 后面会有解释 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;RES &nbsp;SHR S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;3522 libvirt- &nbsp;20 &nbsp; 0 10.6g 462m 6932 R &nbsp;120 &nbsp;0.5 &nbsp; 4:07.04 /usr/bin/kvm -S -M pc-1.0 -cpu core2duo,+lahf_lm,+rdtscp,+popcnt,+sse4.</font></div></pre></div><div><span style="line-height: 22px;"   >测试结果(根据经验值连接使用2*cpu个数) :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[postgres@db-192-168-122-171 ~]$ pgbench -M prepared -r -c 16 -f /home/postgres/login.sql -j 4 -n -T 60 -h $PGDATA -p 1921 -U postgres digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 870730</font></div><div><font size="2"   >tps = 14506.303944 (including connections establishing)</font></div><div><font size="2"   >tps = 14514.458560 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003594 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 2000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.093442 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login(:userid);</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >测试过程中主机上看到的虚拟机开销 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;RES &nbsp;SHR S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;3522 libvirt- &nbsp;20 &nbsp; 0 10.6g 2.8g 6932 S &nbsp;635 &nbsp;3.0 &nbsp;16:27.49 /usr/bin/kvm -S -M pc-1.0 -cpu core2duo,+lahf_lm,+rdtscp,+popcnt,+sse4.</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ><br></span></div><div>4.3 虚拟机配置3测试<span style="line-height: 22px;"   >: (</span><span style="line-height: 22px;"   >8个vcpu, 8G内存</span><span style="line-height: 22px;"   >)</span><span style="line-height: 22px;"   >, 另外在主机上再新开7个其他虚拟机(分别分配1个vcpu,1G内存.), 其他虚拟机开机但是啥都不干.</span></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >在测试前, 看看CPU的开销, 这个开销是基本开销, 后面会有解释 :&nbsp;</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;RES &nbsp;SHR S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;3522 libvirt- &nbsp;20 &nbsp; 0 10.6g 3.0g 6932 S &nbsp; 50 &nbsp;3.2 &nbsp;21:48.91 /usr/bin/kvm -S -M pc-1.0 -cpu core2duo,+lahf_lm,+rdtscp,+popcnt,+sse4.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;3807 libvirt- &nbsp;20 &nbsp; 0 4147m 242m 6876 S &nbsp; 24 &nbsp;0.3 &nbsp; 0:34.87 /usr/bin/kvm -S -M pc-1.0 -enable-kvm -m 1024 -smp 1,sockets=1,cores=1,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;3723 libvirt- &nbsp;20 &nbsp; 0 4530m 242m 6876 S &nbsp; 24 &nbsp;0.3 &nbsp; 0:34.98 /usr/bin/kvm -S -M pc-1.0 -enable-kvm -m 1024 -smp 1,sockets=1,cores=1,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;3681 libvirt- &nbsp;20 &nbsp; 0 3827m 239m 6876 S &nbsp; 21 &nbsp;0.2 &nbsp; 0:34.52 /usr/bin/kvm -S -M pc-1.0 -enable-kvm -m 1024 -smp 1,sockets=1,cores=1,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;3702 libvirt- &nbsp;20 &nbsp; 0 3698m 238m 6876 S &nbsp; 18 &nbsp;0.2 &nbsp; 0:34.60 /usr/bin/kvm -S -M pc-1.0 -enable-kvm -m 1024 -smp 1,sockets=1,cores=1,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;3744 libvirt- &nbsp;20 &nbsp; 0 3570m 242m 6876 S &nbsp; 18 &nbsp;0.3 &nbsp; 0:35.36 /usr/bin/kvm -S -M pc-1.0 -enable-kvm -m 1024 -smp 1,sockets=1,cores=1,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;3786 libvirt- &nbsp;20 &nbsp; 0 3954m 242m 6876 S &nbsp; 18 &nbsp;0.3 &nbsp; 0:34.29 /usr/bin/kvm -S -M pc-1.0 -enable-kvm -m 1024 -smp 1,sockets=1,cores=1,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;3765 libvirt- &nbsp;20 &nbsp; 0 4146m 241m 6876 S &nbsp; 17 &nbsp;0.3 &nbsp; 0:33.41 /usr/bin/kvm -S -M pc-1.0 -enable-kvm -m 1024 -smp 1,sockets=1,cores=1,</font></div></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >测试结果(根据经验值连接使用2*cpu个数) :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[postgres@db-192-168-122-171 ~]$ pgbench -M prepared -r -c 16 -f /home/postgres/login.sql -j 4 -n -T 60 -h $PGDATA -p 1921 -U postgres digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 549333</font></div><div><font size="2"   >tps = 9150.800430 (including connections establishing)</font></div><div><font size="2"   >tps = 9154.330186 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.004609 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 2000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.736610 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login(:userid);</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >测试过程中主机上看到的虚拟机开销 :&nbsp;</span></div></div><div><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;RES &nbsp;SHR S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;3522 libvirt- &nbsp;20 &nbsp; 0 10.6g 3.0g 6932 S &nbsp;476 &nbsp;3.2 &nbsp;23:44.33 /usr/bin/kvm -S -M pc-1.0 -cpu core2duo,+lahf_lm,+rdtscp,+popcnt,+sse4.</font></div><div><font size="2"   >&nbsp;3702 libvirt- &nbsp;20 &nbsp; 0 3698m 238m 6876 S &nbsp; 15 &nbsp;0.2 &nbsp; 0:44.83 /usr/bin/kvm -S -M pc-1.0 -enable-kvm -m 1024 -smp 1,sockets=1,cores=1,</font></div><div><font size="2"   >&nbsp;3723 libvirt- &nbsp;20 &nbsp; 0 4530m 242m 6876 R &nbsp; 15 &nbsp;0.3 &nbsp; 0:45.47 /usr/bin/kvm -S -M pc-1.0 -enable-kvm -m 1024 -smp 1,sockets=1,cores=1,</font></div><div><font size="2"   >&nbsp;3681 libvirt- &nbsp;20 &nbsp; 0 3827m 239m 6876 S &nbsp; 14 &nbsp;0.2 &nbsp; 0:44.74 /usr/bin/kvm -S -M pc-1.0 -enable-kvm -m 1024 -smp 1,sockets=1,cores=1,</font></div><div><font size="2"   >&nbsp;3744 libvirt- &nbsp;20 &nbsp; 0 3570m 242m 6876 S &nbsp; 14 &nbsp;0.3 &nbsp; 0:45.42 /usr/bin/kvm -S -M pc-1.0 -enable-kvm -m 1024 -smp 1,sockets=1,cores=1,</font></div><div><font size="2"   >&nbsp;3807 libvirt- &nbsp;20 &nbsp; 0 4147m 242m 6876 S &nbsp; 14 &nbsp;0.3 &nbsp; 0:45.09 /usr/bin/kvm -S -M pc-1.0 -enable-kvm -m 1024 -smp 1,sockets=1,cores=1,</font></div><div><font size="2"   >&nbsp;3765 libvirt- &nbsp;20 &nbsp; 0 4146m 242m 6876 S &nbsp; 13 &nbsp;0.3 &nbsp; 0:42.64 /usr/bin/kvm -S -M pc-1.0 -enable-kvm -m 1024 -smp 1,sockets=1,cores=1,</font></div><div><font size="2"   >&nbsp;3786 libvirt- &nbsp;20 &nbsp; 0 3954m 242m 6876 S &nbsp; 13 &nbsp;0.3 &nbsp; 0:44.74 /usr/bin/kvm -S -M pc-1.0 -enable-kvm -m 1024 -smp 1,sockets=1,cores=1,</font></div><p></p></pre></div></div><div><br></div><div><span style="line-height: 22px;"   >【小结】</span></div><div>1. 单个虚拟机的基本CPU开销(虚拟机开着啥也不干)和分配给这个虚拟机的VCPU个数有关, 每个VCPU至少约消耗单核的15% .&nbsp;</div><div>&nbsp; &nbsp; 例如主机的CPU共有8核, 那么总的可消耗CPU资源算800%.&nbsp;</div><div>&nbsp; &nbsp; 给某虚拟机分配了2个VCPU, 但有足够多的物理核的情况下, 那么这个虚拟机至少约消耗30%的CPU(在主机中用top命令查看).</div><div>所以前面测试场景3中, 开启了其他虚拟机的情况下, 将降低postgresql数据库所在虚拟机的CPU资源分配.</div><div>总共分配了15个VCPU, 其中数据库所在的虚拟机分配了8个vcpu, 占用中CPU资源的8/15, 对比两次的tps的比例 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select 8/15.0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------</font></div><div><font size="2"   >&nbsp;0.53333333333333333333</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select 9154.0/14514;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------</font></div><div><font size="2"   >&nbsp;0.63070139175968030867</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>2. 性能优化及测试场景介绍 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201221382150858/"   >http://blog.163.com/digoal@126/blog/static/163877040201221382150858/</a></div><div>3.&nbsp;<span style="line-height: 22px;"   >虚拟机安装以及配置详细可参考 :&nbsp;</span></div><div style="line-height: 22px;"   ><a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201322462042878/"   >http://blog.163.com/digoal@126/blog/static/163877040201322462042878/</a></div></div>4.&nbsp;<span style="line-height: 22px;"   >场景2的测试结果tps 14514, 在主机,非虚拟机下的测试结果tps 23662.&nbsp;</span><div>数据库使用虚拟机的话性能损失还是较大的.<br><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >postgres@digoal-PowerEdge-R610:~$ pgbench -M prepared -r -c 16 -f ./login.sql -j 4 -n -T 60 -h $PGDATA -p 1921 -U postgres postgres</span></font></div><div><font size="2"   >transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 16<br>number of threads: 4<br>duration: 60 s<br>number of transactions actually processed: 1419819<br>tps = 23657.600751 (including connections establishing)<br>tps = 23662.542199 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        0.002911        \setrandom userid 1 2000000<br>        0.671418        SELECT f_user_login(:userid);</font></div><p></p></pre></div></div></div>
	</div>
</div>
</body>
</html>