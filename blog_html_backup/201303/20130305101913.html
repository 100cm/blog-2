<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 1st materialized view bond in 9.3</h2>
	<h5 id="">2013-03-05 10:19:13&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020132581138434/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>使用过Oracle的朋友可能对物化视图并不陌生, 说白了就是有数据的视图.</div><div>普通视图可以带来一些好处如下 :&nbsp;</div><div>1. 经常用到的复杂查询写成视图, 可以简化查询语句.</div><div>2. 另外就是权限控制, 如果仅允许用户查询表的部分数据, 直接赋予表权限显然不恰当, 创建视图后赋予视图的查询权限则控制得更细致一些.</div><div>物化视图除了有以上好处之外, 还带来了其他好处 :&nbsp;</div><div>1. 由于物化视图有数据, 所以基于物化视图的查询比普通视图的查询扫描的数据更少. 并且物化视图上也可以建立索引, 所以查询效率比在普通视图上更高.</div><div>2. 物化视图用于远程数据表的话, 规避了因为网络波动导致的查询堵塞问题.</div><div><br></div>2013-03-04 PostgreSQL 增加了物化视图的功能.&nbsp;<span style="line-height: 22px;"   >目前功能非常简陋, 仅仅支持全刷新, 不支持增量刷新.&nbsp;</span><div>目前PostgreSQL 中 create materialized view as query相当于是create table as query. 但是materialized view 记录了query. 方便日后刷新mview.</div><div>在此之前, PostgreSQL有个插件叫snapshot, 支持从PostgreSQL 或 Oracle增量刷新的物化视图, 但是需要perl的支持. 可参考本文末尾的链接.</div><div>创建物化视图的语法 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Command: &nbsp; &nbsp; CREATE MATERIALIZED VIEW</font></div><div><font size="2"   >Description: define a new materialized view</font></div><div><font size="2"   >Syntax:</font></div><div><font size="2"   >CREATE [ UNLOGGED ] MATERIALIZED VIEW table_name</font></div><div><font size="2"   >&nbsp; &nbsp; [ (column_name [, ...] ) ]</font></div><div><font size="2"   >&nbsp; &nbsp; [ WITH ( storage_parameter [= value] [, ... ] ) ]</font></div><div><font size="2"   >&nbsp; &nbsp; [ TABLESPACE tablespace_name ]</font></div><div><font size="2"   >&nbsp; &nbsp; AS query</font></div><div><font size="2"   >&nbsp; &nbsp; [ WITH [ NO ] DATA ]</font></div><p></p></pre></div><div><div><span style="line-height: 22px;"   >-- with no data表示创建物化视图时不加载数据, 日后使用REFRESH MATERIALIZED VIEW刷新.</span></div><div>刷新语法 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Command: &nbsp; &nbsp; REFRESH MATERIALIZED VIEW</font></div><div><font size="2"   >Description: replace the contents of a materialized view</font></div><div><font size="2"   >Syntax:</font></div><div><font size="2"   >REFRESH MATERIALIZED VIEW name</font></div><div><font size="2"   >&nbsp; &nbsp; [ WITH [ NO ] DATA ]</font></div><p></p></pre></div><div>--&nbsp;<span style="line-height: 22px;"   >with no data表示把物化视图的数据清除</span></div><div><br></div><div>测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create table test (id int, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into test select generate_series(1,1000),'test',clock_timestamp();</font></div><div><font size="2"   >INSERT 0 1000</font></div><div><font size="2"   >-- 创建物化视图</font></div><div><font size="2"   >digoal=# create unlogged materialized view mv_test as select * from test where id&lt;100 with no data;</font></div><div><font size="2"   >SELECT 0</font></div></div><div><div><font size="2"   >digoal=# select * from mv_test;</font></div><div><font size="2"   >ERROR: &nbsp;materialized view "mv_test" has not been populated</font></div><div><font size="2"   >HINT: &nbsp;Use the REFRESH MATERIALIZED VIEW command.</font></div></div><div><div><font size="2"   >-- 刷新数据</font></div><div><font size="2"   >digoal=# refresh MATERIALIZED VIEW mv_test with data;</font></div><div><font size="2"   >REFRESH MATERIALIZED VIEW</font></div><div><font size="2"   >digoal=# select count(*) from mv_test;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp; 99</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >-- 清除数据</font></div><div><font size="2"   >digoal=# refresh MATERIALIZED VIEW mv_test with no data;</font></div><div><font size="2"   >REFRESH MATERIALIZED VIEW</font></div></div><div><div><font size="2"   >digoal=# select count(*) from mv_test;</font></div><div><font size="2"   >ERROR: &nbsp;materialized view "mv_test" has not been populated</font></div><div><font size="2"   >HINT: &nbsp;Use the REFRESH MATERIALIZED VIEW command.</font></div></div><p></p></pre></div><div><br></div><div>【参考】<wbr><div>1.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402010830111515931/"   >http://blog.163.com/digoal@126/blog/static/1638770402010830111515931/</a></div><div>2.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402010830112443459/"   >http://blog.163.com/digoal@126/blog/static/1638770402010830112443459/</a></div><div>3.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020108271063956/"   >http://blog.163.com/digoal@126/blog/static/16387704020108271063956/</a></div><div>4.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402010830112341992/"   >http://blog.163.com/digoal@126/blog/static/1638770402010830112341992/</a></div><div>5.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=3bf3ab8c563699138be02f9dc305b7b77a724307"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=3bf3ab8c563699138be02f9dc305b7b77a724307</a></div><div>6.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-creatematerializedview.html"   >http://www.postgresql.org/docs/devel/static/sql-creatematerializedview.html</a></div><div><br></div></div></div></div>
	</div>
</div>
</body>
</html>