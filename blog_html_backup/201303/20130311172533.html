<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 extend SQL ERROR REPORT ability</h2>
	<h5 id="">2013-03-11 17:25:33&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020132114570245/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.3扩展了SQL错误报告的功能, 可以在错误报告中输出更为详细的信息, 例如引起错误的对象包括schema_name, table_name, constraint_name等.</div><div><pre class="prettyprint"   ><p><font size="2"   >For some types of errors, the server reports the name of a database object (a table, table column, data type, or constraint) associated with the error; for example, the name of the unique constraint that caused a unique_violation error. Such names are supplied in separate fields of the error report message so that applications need not try to extract them from the possibly-localized human-readable text of the message. As of PostgreSQL 9.3, complete coverage for this feature exists only for errors in SQLSTATE class 23 (integrity constraint violation), but this is likely to be expanded in future.</font></p></pre></div><div>目前支持错误报告扩展的是分类为23的错误代码, 见本文参考部分.</div><div>补丁信息如下 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=991f3e5ab3f8196d18d5b313c81a5f744f3baaea"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=991f3e5ab3f8196d18d5b313c81a5f744f3baaea</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >This patch addresses the problem that applications currently have to</font></div><div><font size="2"   >extract object names from possibly-localized textual error messages,</font></div><div><font size="2"   >if they want to know for example which index caused a UNIQUE_VIOLATION</font></div><div><font size="2"   >failure. &nbsp;It adds new error message fields to the wire protocol, which</font></div><div><font size="2"   >can carry the name of a table, table column, data type, or constraint</font></div><div><font size="2"   >associated with the error. &nbsp;(Since the protocol spec has always instructed</font></div><div><font size="2"   >clients to ignore unrecognized field types, this should not create any</font></div><div><font size="2"   >compatibility problem.)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Support for providing these new fields has been added to just a limited set</font></div><div><font size="2"   >of error reports (mainly, those in the "integrity constraint violation"</font></div><div><font size="2"   >SQLSTATE class), but we will doubtless add them to more calls in future.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Pavel Stehule, reviewed and extensively revised by Peter Geoghegan, with</font></div><div><font size="2"   >additional hacking by Tom Lane.</font></div><p></p></pre></div><div>测试 :&nbsp;</div><div>测试分类在23中的以及不在23中的错误 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pgdev@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \c digoal digoal</font></div><div><font size="2"   >You are now connected to database "digoal" as user "digoal".</font></div><p></p></pre></div><div>-- 测试表</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create table test(id int primary key, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=&gt; \set VERBOSITY verbose</font></div><div><font size="2"   >digoal=&gt; insert into test values (1, 'digoal');</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div>-- 违反唯一约束, 属于23分类, 所以输出了扩展的错误信息. schema_name, table_name, constraint_name.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; insert into test values (1, 'digoal');</font></div><div><font size="2"   >ERROR: &nbsp;23505: duplicate key value violates unique constraint "test_pkey"</font></div><div><font size="2"   >DETAIL: &nbsp;Key (id)=(1) already exists.</font></div><div><font size="2"   >SCHEMA NAME: &nbsp;digoal</font></div><div><font size="2"   >TABLE NAME: &nbsp;test</font></div><div><font size="2"   >CONSTRAINT NAME: &nbsp;test_pkey</font></div><div><font size="2"   >LOCATION: &nbsp;_bt_check_unique, nbtinsert.c:398</font></div><p></p></pre></div></div><div>-- 22分类的错误没有扩展信息</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select 1/0;</font></div><div><font size="2"   >ERROR: &nbsp;22012: division by zero</font></div><div><font size="2"   >LOCATION: &nbsp;int4div, int.c:719</font></div><p></p></pre></div><div>-- 非空约束属于23分类, 有扩展信息.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; insert into test values (null, 'abc');</font></div><div><font size="2"   >ERROR: &nbsp;23502: null value in column "id" violates not-null constraint</font></div><div><font size="2"   >DETAIL: &nbsp;Failing row contains (null, abc).</font></div><div><font size="2"   >SCHEMA NAME: &nbsp;digoal</font></div><div><font size="2"   >TABLE NAME: &nbsp;test</font></div><div><font size="2"   >COLUMN NAME: &nbsp;id</font></div><div><font size="2"   >LOCATION: &nbsp;ExecConstraints, execMain.c:1652</font></div><p></p></pre></div><div>-- copy格式错误, 属于22分类, 所以没有扩展信息.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; copy test from stdin</font></div><div><font size="2"   >digoal-&gt; ;</font></div><div><font size="2"   >Enter data to be copied followed by a newline.</font></div><div><font size="2"   >End with a backslash and a period on a line by itself.</font></div><div><font size="2"   >&gt;&gt; 1 &nbsp; &nbsp;'abc' &nbsp; 'd'</font></div><div><font size="2"   >&gt;&gt; \.</font></div><div><font size="2"   >ERROR: &nbsp;22P04: extra data after last expected column</font></div><div><font size="2"   >CONTEXT: &nbsp;COPY test, line 1: "1 'abc' &nbsp; 'd'"</font></div><div><font size="2"   >LOCATION: &nbsp;NextCopyFrom, copy.c:2716</font></div><p></p></pre></div></div><wbr><div><br></div><div>未来还会增加其他扩展信息. 不局限于23分类.</div><div>在函数中估计也会加入扩展信息的trace 功能.</div><div><br></div><div>【参考】</div><div>1.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/errcodes-appendix.html"   >http://www.postgresql.org/docs/devel/static/errcodes-appendix.html</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Class 23 ― Integrity Constraint Violation</font></div><div><font size="2"   >23000<span>	</span>integrity_constraint_violation</font></div><div><font size="2"   >23001<span>	</span>restrict_violation</font></div><div><font size="2"   >23502<span>	</span>not_null_violation</font></div><div><font size="2"   >23503<span>	</span>foreign_key_violation</font></div><div><font size="2"   >23505<span>	</span>unique_violation</font></div><div><font size="2"   >23514<span>	</span>check_violation</font></div><div><font size="2"   >23P01<span>	</span>exclusion_violation</font></div><p></p></pre></div><div>2.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=991f3e5ab3f8196d18d5b313c81a5f744f3baaea"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=991f3e5ab3f8196d18d5b313c81a5f744f3baaea</a></div></div>
	</div>
</div>
</body>
</html>