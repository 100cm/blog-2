<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL How small Table seq_scan faster than index scan.</h2>
	<h5 id="">2013-03-07 9:54:23&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013279268957/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>今天早上QQ群里聊到小表走全表快还是走索引快的话题,&nbsp;<span style="line-height: 22px;"   >下面针对这个在数据库中做了一下压力测试.</span></div><div><span style="line-height: 22px;"   ><br></span></div><div>测试表如下 :&nbsp;</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; create table tbl_small(id int, info text, crt_time timestamp);</font></div><div style="line-height: 22px;"   ><font size="2"   >CREATE TABLE</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><br></div><div>一、表只有<span style="line-height: 22px;"   >1个数据块时 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; insert into tbl_small select generate_series(1,40),md5(clock_timestamp()::text),clock_timestamp();</font></div><div><font size="2"   >INSERT 0 40</font></div><div><font size="2"   >digoal=&gt; select min(ctid),max(ctid) from tbl_small ;</font></div><div><font size="2"   >&nbsp; min &nbsp;| &nbsp;max &nbsp;&nbsp;</font></div><div><font size="2"   >-------+--------</font></div><div><font size="2"   >&nbsp;(0,1) | (0,40)</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>压力测试脚本 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; vi test.sql</font></div><div><font size="2"   >\setrandom id 1 40</font></div><div><font size="2"   >select * from tbl_small where id=:id;</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >1. 全表扫描压力测试结果 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./test.sql -r -n -c 8 -j 2 -h $PGDATA -T 60 -U digoal digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 2</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 4201144</font></div><div><font size="2"   >tps = 70015.841270 (including connections establishing)</font></div><div><font size="2"   >tps = 70030.797409 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001514 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 40</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.111214 &nbsp; &nbsp; &nbsp; &nbsp;select * from tbl_small where id=:id;</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >CPU开销截取 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;5598 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4712 3112 R 66.1 &nbsp;0.0 &nbsp; 0:27.28 postgres: digoal digoal [local] BIND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;5605 ocz &nbsp; &nbsp; &nbsp; 16 &nbsp; 0 8519m 4724 3124 R 64.1 &nbsp;0.0 &nbsp; 0:20.95 postgres: digoal digoal [local] BIND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;5600 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4716 3116 S 59.8 &nbsp;0.0 &nbsp; 0:24.62 postgres: digoal digoal [local] BILECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;5603 ocz &nbsp; &nbsp; &nbsp; 16 &nbsp; 0 8519m 4716 3116 R 55.8 &nbsp;0.0 &nbsp; 0:19.55 postgres: digoal digoal [local] SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;5599 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4708 3108 R 54.8 &nbsp;0.0 &nbsp; 0:23.43 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;5601 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4712 3112 R 50.5 &nbsp;0.0 &nbsp; 0:21.71 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;5602 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4720 3120 R 48.1 &nbsp;0.0 &nbsp; 0:21.77 postgres: digoal digoal [local] SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;5604 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4712 3116 S 44.1 &nbsp;0.0 &nbsp; 0:20.91 postgres: digoal digoal [local] BIND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div></div><p></p></pre></div><div><br></div><div>2. 索引扫描压力测试结果 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create unique index idx_small_1 on tbl_small (id);</font></div><div><font size="2"   >CREATE INDEX</font></div><p></p></pre></div><div>关闭全表扫描, 强制索引 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi $PGDATA/postgresql.conf</font></div><div><font size="2"   >enable_seqscan = off</font></div><div><font size="2"   >pg_ctl reload</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./test.sql -r -n -c 8 -j 2 -h $PGDATA -T 60 -U digoal digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 2</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 4368406</font></div><div><font size="2"   >tps = 72803.011245 (including connections establishing)</font></div><div><font size="2"   >tps = 72819.600514 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001365 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 40</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.107018 &nbsp; &nbsp; &nbsp; &nbsp;select * from tbl_small where id=:id;</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >CPU开销截取 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;5740 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4892 3264 S 54.8 &nbsp;0.0 &nbsp; 0:15.80 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;5741 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4888 3260 R 54.1 &nbsp;0.0 &nbsp; 0:12.49 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;5742 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4884 3256 S 50.4 &nbsp;0.0 &nbsp; 0:14.77 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;5743 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4892 3264 S 45.5 &nbsp;0.0 &nbsp; 0:11.62 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;5744 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4896 3268 S 42.1 &nbsp;0.0 &nbsp; 0:14.11 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;5745 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4896 3268 R 41.5 &nbsp;0.0 &nbsp; 0:09.39 postgres: digoal digoal [local] SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;5746 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4888 3260 S 41.1 &nbsp;0.0 &nbsp; 0:13.46 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;5747 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4896 3268 R 40.8 &nbsp;0.0 &nbsp; 0:08.32 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"   >二、数据增加到300条, 3个数据块 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; insert into tbl_small select generate_series(41,300),md5(clock_timestamp()::text),clock_timestamp();</font></div><div><font size="2"   >INSERT 0 260</font></div><div><font size="2"   >digoal=&gt; select min(ctid),max(ctid) from tbl_small ;</font></div><div><font size="2"   >&nbsp; min &nbsp;| &nbsp;max &nbsp;&nbsp;</font></div><div><font size="2"   >-------+--------</font></div><div><font size="2"   >&nbsp;(0,1) | (2,86)</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>调整压力测试脚本 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >ocz@db-172-16-3-150-&gt; vi test.sql&nbsp;</font></div><div><font size="2"   >\setrandom id 1 300</font></div><div><font size="2"   >select * from tbl_small where id=:id;</font></div></div><div></div><p></p></pre></div></div><div><span style="line-height: 22px;"   >1. 索引扫描压力测试结果 :&nbsp;</span></div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./test.sql -r -n -c 8 -j 2 -h $PGDATA -T 60 -U digoal digoal</font></span></div><div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 2</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 4176862</font></div><div><font size="2"   >tps = 69611.811913 (including connections establishing)</font></div><div><font size="2"   >tps = 69627.130480 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001544 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 300</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.111827 &nbsp; &nbsp; &nbsp; &nbsp;select * from tbl_small where id=:id;</font></div></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >CPU开销截取 :&nbsp;</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;6158 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4940 3312 R 68.0 &nbsp;0.0 &nbsp; 0:05.25 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6156 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4936 3308 R 67.7 &nbsp;0.0 &nbsp; 0:05.78 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6153 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4956 3328 S 65.4 &nbsp;0.0 &nbsp; 0:05.20 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6154 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4932 3304 R 65.0 &nbsp;0.0 &nbsp; 0:05.46 postgres: digoal digoal [local] SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6152 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4932 3304 R 49.8 &nbsp;0.0 &nbsp; 0:04.26 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6155 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4936 3308 S 46.1 &nbsp;0.0 &nbsp; 0:03.84 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6157 ocz &nbsp; &nbsp; &nbsp; 16 &nbsp; 0 8519m 4936 3308 R 35.8 &nbsp;0.0 &nbsp; 0:03.25 postgres: digoal digoal [local] BIND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6159 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4944 3316 S 28.5 &nbsp;0.0 &nbsp; 0:03.17 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div></div><p></p></pre></div></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >2. 全表扫描压力测试结果 :&nbsp;</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; drop index idx_small_1 ;</font></div><div style="line-height: 22px;"   ><font size="2"   >DROP INDEX</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./test.sql -r -n -c 8 -j 2 -h $PGDATA -T 60 -U digoal digoal</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 8</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 2</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 60 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 2713441</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 45223.499611 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 45232.694182 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001640 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 300</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.173621 &nbsp; &nbsp; &nbsp; &nbsp;select * from tbl_small where id=:id;</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >CPU开销截取 :&nbsp;</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;6126 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4824 3208 S 66.7 &nbsp;0.0 &nbsp; 0:12.98 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;6128 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4824 3208 R 64.0 &nbsp;0.0 &nbsp; 0:13.09 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;6132 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4828 3212 R 63.4 &nbsp;0.0 &nbsp; 0:12.54 postgres: digoal digoal [local] SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;6130 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4832 3216 R 63.0 &nbsp;0.0 &nbsp; 0:13.65 postgres: digoal digoal [local] SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;6127 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4828 3212 S 53.8 &nbsp;0.0 &nbsp; 0:11.19 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;6129 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4828 3212 R 45.8 &nbsp;0.0 &nbsp; 0:09.46 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;6131 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4828 3212 R 37.8 &nbsp;0.0 &nbsp; 0:07.90 postgres: digoal digoal [local] BIND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;6133 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 4828 3212 R 37.8 &nbsp;0.0 &nbsp; 0:07.38 postgres: digoal digoal [local] BIND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div></div><div></div><p></p></pre></div></div><div>三、数据增加到2万条记录, 181个数据块.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; insert into tbl_small select generate_series(1001,20000),md5(clock_timestamp()::text),clock_timestamp();</font></div><div><font size="2"   >INSERT 0 19000</font></div><div><font size="2"   >digoal=&gt; select min(ctid),max(ctid) from tbl_small ;</font></div><div><font size="2"   >&nbsp; min &nbsp;| &nbsp; max &nbsp; &nbsp;</font></div><div><font size="2"   >-------+----------</font></div><div><font size="2"   >&nbsp;(0,1) | (180,40)</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"   >调整压力测试脚本 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; vi test.sql&nbsp;</font></div><div><font size="2"   >\setrandom id 1 20000</font></div><div><font size="2"   >select * from tbl_small where id=:id;</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"   >1. 全表扫描压力测试结果 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./test.sql -r -n -c 8 -j 2 -h $PGDATA -T 60 -U digoal digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 2</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 136301</font></div><div><font size="2"   >tps = 2271.530005 (including connections establishing)</font></div><div><font size="2"   >tps = 2272.021164 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002457 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 20000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 3.516204 &nbsp; &nbsp; &nbsp; &nbsp;select * from tbl_small where id=:id;</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >CPU开销截取 :&nbsp;</span></div><div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp;6078 ocz &nbsp; &nbsp; &nbsp; 25 &nbsp; 0 8519m 6980 5364 R 99.2 &nbsp;0.0 &nbsp; 0:06.27 postgres: digoal digoal [local] SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6082 ocz &nbsp; &nbsp; &nbsp; 20 &nbsp; 0 8519m 6964 5348 R 99.2 &nbsp;0.0 &nbsp; 0:06.23 postgres: digoal digoal [local] SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6083 ocz &nbsp; &nbsp; &nbsp; 25 &nbsp; 0 8519m 6964 5348 R 98.6 &nbsp;0.0 &nbsp; 0:06.23 postgres: digoal digoal [local] SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6079 ocz &nbsp; &nbsp; &nbsp; 25 &nbsp; 0 8519m 6960 5344 R 98.2 &nbsp;0.0 &nbsp; 0:06.24 postgres: digoal digoal [local] SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6081 ocz &nbsp; &nbsp; &nbsp; 20 &nbsp; 0 8519m 6964 5348 R 98.2 &nbsp;0.0 &nbsp; 0:06.22 postgres: digoal digoal [local] SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6080 ocz &nbsp; &nbsp; &nbsp; 25 &nbsp; 0 8519m 6964 5348 R 97.9 &nbsp;0.0 &nbsp; 0:06.21 postgres: digoal digoal [local] SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6084 ocz &nbsp; &nbsp; &nbsp; 25 &nbsp; 0 8519m 6960 5344 R 97.6 &nbsp;0.0 &nbsp; 0:06.07 postgres: digoal digoal [local] SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6085 ocz &nbsp; &nbsp; &nbsp; 25 &nbsp; 0 8519m 6968 5352 R 96.9 &nbsp;0.0 &nbsp; 0:06.11 postgres: digoal digoal [local] SELECT</font></div></div><div></div><p></p></pre></div></div><div><span style="line-height: 22px;"   >2. 索引扫描压力测试结果 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create unique index idx_small_1 on tbl_small (id);</font></div><div><font size="2"   >CREATE INDEX</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./test.sql -r -n -c 8 -j 2 -h $PGDATA -T 60 -U digoal digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 2</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 3933247</font></div><div><font size="2"   >tps = 65551.692347 (including connections establishing)</font></div><div><font size="2"   >tps = 65564.556183 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001622 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 20000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.118833 &nbsp; &nbsp; &nbsp; &nbsp;select * from tbl_small where id=:id;</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >CPU开销截取 :&nbsp;</span></div><div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp;6024 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 7700 6072 R 63.0 &nbsp;0.0 &nbsp; 0:10.49 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6026 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 7696 6068 S 58.1 &nbsp;0.0 &nbsp; 0:09.89 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6030 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 7704 6076 S 55.4 &nbsp;0.0 &nbsp; 0:09.89 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6028 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 7704 6076 S 55.1 &nbsp;0.0 &nbsp; 0:09.74 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6025 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 7692 6064 S 54.4 &nbsp;0.0 &nbsp; 0:06.16 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6027 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 7700 6072 S 40.5 &nbsp;0.0 &nbsp; 0:05.17 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6029 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 7700 6072 R 38.5 &nbsp;0.0 &nbsp; 0:04.53 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6031 ocz &nbsp; &nbsp; &nbsp; 15 &nbsp; 0 8519m 7708 6080 S 30.2 &nbsp;0.0 &nbsp; 0:04.08 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div></div><div></div><p></p></pre></div></div><div>【小结】</div><div>1. 当表的记录数为40, 大小是1个数据块时, 走索引和走全表扫描的tps差别不大, CPU开销差别不大.&nbsp;</div><div>2. 当表的记录数为300, 大小是3个数据块时,&nbsp;<span style="line-height: 22px;"   >走索引的效率明显比全表扫描高出很多, 差别主要体现在CPU的开销上.&nbsp;</span></div><div><span style="line-height: 22px;"   >&nbsp; &nbsp; 走索引的CPU开销与数据量为40时差别不大.</span></div><div><span style="line-height: 22px;"   >3. 当表的记录数为20000, 大小是181个数据块时,&nbsp;</span><span style="line-height: 22px;"   >走索引的效率明显比全表扫描高出很多, 差别主要体现在CPU的开销上.&nbsp;</span></div><div><span style="line-height: 22px;"   >&nbsp; &nbsp; 走索引的CPU开销与数据量为40时差别不大.</span></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >所以不管数据量多少, 在选择性很好的情况下使用索引是减轻CPU负担的好办法. 特别在高并发的查询下面, 全表扫描就是CPU杀手. &nbsp;(因为每条记录都要处理一下, 即cpu_tuple_cost * tuples)</span></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL How small Table seq_scan faster than index scan. - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>