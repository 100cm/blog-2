<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL general sync and async multi-master replication trigger function</h2>
	<h5 id="">2013-03-11 15:28:15&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201321125220134/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>以前写过一些使用触发器复制的BLOG,&nbsp;</div><div><div style="line-height: 22px;"   ><a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012731944439/"   >http://blog.163.com/digoal@126/blog/static/1638770402012731944439/</a></div><div style="line-height: 22px;"   ><a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012731203716/"   >http://blog.163.com/digoal@126/blog/static/1638770402012731203716/</a></div></div><div>但是对于有许多表的环境, 写触发器函数也是很费神的事情.</div><div>本文以PostgreSQL 9.2为例, 介绍如何创建通用的用于多主复制的触发器函数.</div><div>所谓通用, 就是1个触发器函数搞定所有的表复制, 而不需要为每个表创建触发器函数. 方便DBA管理数据库复制.</div><div><br></div><div>测试环境 :&nbsp;</div><div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >创建两个用户 :&nbsp;</div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><div style="line-height: 25px;"   ><pre class="prettyprint"   style="line-height: 25px;"   ><p style="line-height: 25px; margin-bottom: 10px;"   ></p><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >postgres</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >=</span><span style="line-height: 21px; color: rgb(136, 0, 0);"   ># create role local login encrypted password 'LOCAL321';</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >CREATE ROLE</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >postgres=# create role remote login encrypted password 'REMOTE321';</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >CREATE ROLE</span></font></div><p style="line-height: 25px; margin-bottom: 10px;"   ></p></pre></div><div style="line-height: 25px;"   >创建两个数据库 :&nbsp;</div><div style="line-height: 25px;"   ><pre class="prettyprint"   style="line-height: 25px;"   ><p style="line-height: 25px; margin-bottom: 10px;"   ></p><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >postgres</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >=</span><span style="line-height: 21px; color: rgb(136, 0, 0);"   ># create database local owner local;</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >CREATE DATABASE</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >postgres=# create database remote owner remote;</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >CREATE DATABASE</span></font></div><p style="line-height: 25px; margin-bottom: 10px;"   ></p></pre></div><div style="line-height: 25px;"   >创建dblink模块 :&nbsp;</div><div style="line-height: 25px;"   ><pre class="prettyprint"   style="line-height: 25px;"   ><p style="line-height: 25px; margin-bottom: 10px;"   ></p><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >postgres</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >=</span><span style="line-height: 21px; color: rgb(136, 0, 0);"   ># \c local postgres</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >You are now connected to database "local" as user "postgres".</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >local=# create extension dblink;</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >CREATE EXTENSION</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >local=# \c remote postgres</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >You are now connected to database "remote" as user "postgres".</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >remote=# create extension dblink;</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >CREATE EXTENSION</span></font></div><p style="line-height: 25px; margin-bottom: 10px;"   ></p></pre></div><div style="line-height: 25px;"   >创建schema :&nbsp;</div><div style="line-height: 25px;"   ><pre class="prettyprint"   style="line-height: 25px;"   ><p style="line-height: 25px; margin-bottom: 10px;"   ></p><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 136);"   >local=&gt; \c local local</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 136);"   >local</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >=&gt;</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > create schema </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >local</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >;</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >CREATE </span><span style="line-height: 21px; color: rgb(102, 0, 102);"   >SCHEMA</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(102, 0, 102);"   >local</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >=&gt;</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > \c remote remote</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >You are now connected to database </span><span style="line-height: 21px; color: rgb(0, 136, 0);"   >"remote"</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >as</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > user </span><span style="line-height: 21px; color: rgb(0, 136, 0);"   >"remote"</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >.</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >remote</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >=&gt;</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > create schema remote</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >;</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >CREATE SCHEMA</span></font></div></pre></div></div></div><div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >在local库创建测试表 :&nbsp;</div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >本例将使用联合索引 :&nbsp;</div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><pre class="prettyprint"   style="line-height: 25px;"   ><p style="line-height: 25px; margin-bottom: 10px;"   ></p><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >remote</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >=&gt;</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > \c </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >local</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > local</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >You are now connected to database </span><span style="line-height: 21px; color: rgb(0, 136, 0);"   >"local"</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >as</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > user </span><span style="line-height: 21px; color: rgb(0, 136, 0);"   >"local"</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >.</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 136);"   >local</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >=&gt;</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > create table loc_test </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >(</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >pk1 </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >int</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >,</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > pk2 text</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >,</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > info text</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >,</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > crt_time timestamp</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >(</span><span style="line-height: 21px; color: rgb(0, 102, 102);"   >0</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >),</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > mod_time timestamp</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >(</span><span style="line-height: 21px; color: rgb(0, 102, 102);"   >0</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >),</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > primary key</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >(</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >pk1</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >,</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >pk2</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >));</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >NOTICE</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >:</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > &nbsp;CREATE TABLE </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >/</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > PRIMARY KEY will create </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >implicit</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > index </span><span style="line-height: 21px; color: rgb(0, 136, 0);"   >"loc_test_pkey"</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >for</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > table </span><span style="line-height: 21px; color: rgb(0, 136, 0);"   >"loc_test"</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >CREATE </span><span style="line-height: 21px; color: rgb(102, 0, 102);"   >TABLE</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(102, 0, 102);"   >local</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >=&gt;</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >select</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > string_agg</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >(</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >position</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >::</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >text</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >,</span><span style="line-height: 21px; color: rgb(0, 136, 0);"   >' '</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >)::</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >int2vector</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >,</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >count</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >(*)</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >from</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > dblink_get_pkey</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >(</span><span style="line-height: 21px; color: rgb(0, 136, 0);"   >'local.loc_test'</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >);</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp;string_agg </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >|</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > count&nbsp;</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(102, 102, 0);"   >------------+-------</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp;</span><span style="line-height: 21px; color: rgb(0, 102, 102);"   >1</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(0, 102, 102);"   >2</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >|</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > &nbsp; &nbsp; </span><span style="line-height: 21px; color: rgb(0, 102, 102);"   >2</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(102, 102, 0);"   >(</span><span style="line-height: 21px; color: rgb(0, 102, 102);"   >1</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > row</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >)</span></font></div><p style="line-height: 25px; margin-bottom: 10px;"   ></p></pre></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><br style="line-height: 25px;"   ></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >在remote库创建测试表 :&nbsp;</div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><pre class="prettyprint"   style="line-height: 25px;"   ><p style="line-height: 25px; margin-bottom: 10px;"   ></p><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >postgres</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >=</span><span style="line-height: 21px; color: rgb(136, 0, 0);"   ># \c remote remote</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >You are now connected to database "remote" as user "remote".</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >remote=&gt; create table rmt_test (pk1 int, pk2 text, info text, crt_time timestamp(0), mod_time timestamp(0), primary key(pk1,pk2));</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "rmt_test_pkey" for table "rmt_test"</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >CREATE TABLE</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >remote=&gt; select string_agg(position::text,' ')::int2vector,count(*) from dblink_get_pkey('remote.rmt_test');</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >&nbsp;string_agg | count&nbsp;</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >------------+-------</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >&nbsp;1 2 &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; 2</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >(1 row)</span></font></div><p style="line-height: 25px; margin-bottom: 10px;"   ></p></pre></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><br style="line-height: 25px;"   ></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >在local库回收<span style="line-height: 22px;"   >pg_user_mappings的public权限 :&nbsp;</span></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><pre class="prettyprint"   style="line-height: 25px;"   ><p style="line-height: 25px; margin-bottom: 10px;"   ></p><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 136);"   >local</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >=&gt;</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > \c </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >local</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > postgres</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >You are now connected to database </span><span style="line-height: 21px; color: rgb(0, 136, 0);"   >"local"</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >as</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > user </span><span style="line-height: 21px; color: rgb(0, 136, 0);"   >"postgres"</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >.</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 136);"   >local</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >=</span><span style="line-height: 21px; color: rgb(136, 0, 0);"   ># revoke all on pg_user_mappings from public;</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >REVOKE</span></font></div><p style="line-height: 25px; margin-bottom: 10px;"   ></p></pre></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><br style="line-height: 25px;"   ></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><span style="line-height: 22px;"   >在remote库回收</span><span style="line-height: 22px;"   >pg_user_mappings的public权限 :&nbsp;</span></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><pre class="prettyprint"   style="line-height: 25px;"   ><p style="line-height: 25px; margin-bottom: 10px;"   ></p><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 136);"   >local</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >=</span><span style="line-height: 21px; color: rgb(136, 0, 0);"   ># \c remote postgres</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >You are now connected to database "remote" as user "postgres".</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >remote=# revoke all on pg_user_mappings from public;</span></font></div><div style="line-height: 25px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >REVOKE</span></font></div><p style="line-height: 25px; margin-bottom: 10px;"   ></p></pre></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><br style="line-height: 25px;"   ></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >在local库创建server :&nbsp;</div><div><p style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 25px; margin-bottom: 10px;"   ></p><div><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \c local postgres</font></div><div><font size="2"   >You are now connected to database "local" as user "postgres".</font></div><div><font size="2"   >local=# CREATE FOREIGN DATA WRAPPER postgresql VALIDATOR postgresql_fdw_validator;</font></div><div><font size="2"   >CREATE FOREIGN DATA WRAPPER</font></div><div><font size="2"   >local=# CREATE SERVER dst FOREIGN DATA WRAPPER postgresql OPTIONS (hostaddr '172.16.3.150', port '9999', dbname 'remote', options '-c tcp_keepalives_idle=60s -c tcp_keepalives_interval=10 -c tcp_keepalives_count=6 -c application_name=aaa_bbb_digoal');</font></div><div><font size="2"   >CREATE SERVER</font></div><div><font size="2"   >local=# GRANT USAGE ON FOREIGN SERVER dst TO local;</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >local=# CREATE USER MAPPING FOR local SERVER dst OPTIONS (user 'remote', password 'REMOTE321');</font></div><div><font size="2"   >CREATE USER MAPPING</font></div><p></p></pre></div></div></div><div><br></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><span style="line-height: 22px;"   >在remote库创建server :&nbsp;</span></div><div><p style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 25px; margin-bottom: 10px;"   ></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >local=# \c remote postgres</font></div><div><font size="2"   >You are now connected to database "remote" as user "postgres".</font></div><div><font size="2"   >remote=# CREATE FOREIGN DATA WRAPPER postgresql VALIDATOR postgresql_fdw_validator;</font></div><div><font size="2"   >CREATE FOREIGN DATA WRAPPER</font></div><div><font size="2"   >remote=# CREATE SERVER dst FOREIGN DATA WRAPPER postgresql OPTIONS (hostaddr '172.16.3.150', port '9999', dbname 'local', options '-c tcp_keepalives_idle=60s -c tcp_keepalives_interval=10 -c tcp_keepalives_count=6 -c application_name=aaa_bbb_digoal');</font></div><div><font size="2"   >CREATE SERVER</font></div><div><font size="2"   >remote=# GRANT USAGE ON FOREIGN SERVER dst TO remote;</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >remote=# CREATE USER MAPPING FOR remote SERVER dst OPTIONS (user 'local', password 'LOCAL321');</font></div><div><font size="2"   >CREATE USER MAPPING</font></div><p></p></pre></div></div><div>在local和remote库创建异步复制错误SQL记录表 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create table sync_err_rec(id serial8 primary key, nsp_name name, table_name name, dst_server text, dst_query text, create_time timestamp without time zone);</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE will create implicit sequence "sync_err_rec_id_seq" for serial column "sync_err_rec.id"</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "sync_err_rec_pkey" for table "sync_err_rec"</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div><br></div><div>在<span style="line-height: 22px;"   >local和remote库创建异步复制错误SQL处理函数 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >create or replace function deal_sync_err_rec (i_limit int) returns boolean as $$<br>declare<br>  v_conn_name text;  -- 连接名<br>  v_conn_status text;  -- 存储dblink_connect(v_conn_name, v_dst_server)的返回值<br>  v_exec_status text;  -- 存储dblink_exec(v_conn_name, v_dst_query, true|false)的返回值.<br>  v_dst_server text;  -- foreign server, 一次取一个. 根据这个dst_server再抽取错误的同步记录, 进行处理.<br>  v_dst_query text;  -- sync_err_rec中记录的SQL语句<br>  v_id int8[];  -- sync_err_rec的主键, 用于记录一批记录, BATCH删除.<br>begin<br>  -- 如果是standby数据库则直接退出<br>  if pg_is_in_recovery() then<br>   &nbsp;raise notice 'this is standby';</span></font></div><div><font size="2"   ><span style="line-height: 19px;"   >    return false;<br>  end if;<br>  -- 取出最早的记录的dst_server, 加上RowExclusiveLock锁, 接下来将处理这个dst_server发生的错误.<br>  select dst_server into v_dst_server from sync_err_rec order by create_time limit 1 for update;<br>  -- 空表示没有记录直接返回<br>  if (v_dst_server is NULL) then<br>    return true;<br>  end if;<br>  -- 将v_dst_server的值赋予给连接名<br>  v_conn_name := v_dst_server;<br>  -- 取出一批记录<br>  select array_agg(id), string_agg(dst_query, ';') into v_id, v_dst_query from <br>    (select id,dst_query from sync_err_rec where dst_server=v_dst_server order by create_time limit i_limit) t;<br>  -- 删除sync_err_rec中对应的记录.<br>  delete from sync_err_rec where id in (select unnest(v_id));<br>  -- 建立dblink连接<br>  if ( dblink_get_connections() @&gt; ('{'||v_conn_name||'}')::text[] ) then <br>  else<br>    select * into v_conn_status from dblink_connect(v_conn_name, v_dst_server);<br>  end if;<br>  -- 这里dblink_exec使用的是true参数, 远程执行异常则回滚.<br>  select * into v_exec_status from dblink_exec(v_conn_name, v_dst_query, true);<br>  -- debug<br>  -- raise notice 'v_conn_status:%, v_exec_status:%.', v_conn_status, v_exec_status;<br>  return true;<br>END;<br>$$ language plpgsql;</span></font></div><p></p></pre></div><div><br></div><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 25px;"   >在local和remote库创建触发器函数 :&nbsp;</span></div><div><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >CREATE OR REPLACE FUNCTION f_sync_test()<br>RETURNS trigger<br>LANGUAGE plpgsql<br>AS $BODY$<br>DECLARE<br>  v_dst_server text;  -- foreign server<br>  v_conn_name text;  -- 连接名, 本例配置与dst_server一致.<br>  v_conn_status text;  -- 存储dblink_connect(v_conn_name, v_dst_server)的返回值<br>  v_nsp_name name := TG_TABLE_SCHEMA;  -- 触发器变量, 触发这个触发器的表所在的schema<br>  v_table_name name := TG_TABLE_NAME;  -- 触发器变量, 触发这个触发器的表名<br>  v_dst_nsp_name name;  -- 目标schema, 当需要复制到其他schema下时, 这里改成其schema名即可<br>  v_dst_table_name name;  -- 目标表名<br>  v_query text;  -- 使用dblink_build_sql_insert, dblink_build_sql_update, dblink_build_sql_delete得到的SQL, 用于调用dblink_exec远程执行.<br>  v_query_upd1 text;  -- update需要用到delete和insert<br>  v_query_upd2 text;  -- update需要用到delete和insert<br>  v_dst_query text;  -- v_query修改后的语句, 主要就是修改目标schema和目标表名<br>  v_dst_query_upd1 text;  -- update需要用到delete和insert<br>  v_dst_query_upd2 text;  -- update需要用到delete和insert<br>  v_pk_vector int2vector;  -- dblink_build_sql_insert, dblink_build_sql_update, dblink_build_sql_delete要用到的被复制的表的PK列s的逻辑位置<br>  v_pk_cnt int;  -- dblink_build_sql_insert, dblink_build_sql_update, dblink_build_sql_delete要用到的被复制的表的PK列个数<br>  v_pk_attname_array name[];  -- pk名称数组<br>  v_pk_att_vals_array text[];  -- pk值<br>  tmp_v_pk_att_vals_array text[]; -- 临时pk值<br>  v_exec_status text;  -- 存储dblink_exec(v_conn_name, v_dst_query, true|false)的返回值.<br>  -- multi master replication 需要以下参数分辨更新来源, 用于防止死循环触发.<br>  v_application_name_cli text;<br>  v_application_name_check text;<br>  v_pg_backend_pid int;<br>  v_replica_mode text;  -- 复制模式, 同步复制还是异步复制.<br>  i record;<br>  y int;<br>BEGIN<br>  -- 触发器说明详见 http://blog.163.com/digoal@126/blog/static/163877040201321125220134/<br>  -- 触发器参数传入格式(v_dst_server, v_dst_nsp_name, v_dst_table_name, v_application_name_check)<br>  -- 配置foreign server, 远程schema, 远程表名, application_name<br>  v_dst_server := TG_ARGV[0];  -- foreign server<br>  v_conn_name := v_dst_server;  -- 连接名, 本例配置与dst_server一致.<br>  v_dst_nsp_name := TG_ARGV[1];  -- 目标schema, 当需要复制到其他schema下时, 这里改成其schema名即可<br>  v_dst_table_name := TG_ARGV[2];  -- 目标表名<br>  v_application_name_check := TG_ARGV[3];  -- application_name, 用于防止死循环触发.<br>  v_replica_mode := TG_ARGV[4];  -- 同步模式, 同步复制还是异步复制.<br>  <br>  -- 获取会话的postgres pid<br>  select pg_backend_pid() into v_pg_backend_pid;<br>  -- 根据这个PID获取application_name, 这个就可以用来区分是不是复制程序连上来的会话.9.1(含9.1)以前的版本pg_stat_activity.procpid.<br>  select application_name into v_application_name_cli from pg_stat_activity where pid=v_pg_backend_pid;<br>  -- 如果是复制程序连上来的会话, 直接返回null, 否则会出现死循环触发.<br>  if (v_application_name_cli = v_application_name_check ) then<br>    return null;<br>  end if;<br><br>  -- 主键信息(注意位置vector数据9.0及以上版本是输出的逻辑顺序,删除列后将改变逻辑顺序; 9.0以前的版本是pg_attribute.attnum;)<br>  -- v_pk_vector和v_pk_cnt, v_pk_attname_array通过以下SQL得到.<br>  <br>  -- v_pk_cnt信息获取.<br>  select array_length(conkey, 1) into v_pk_cnt from pg_constraint where conrelid=TG_RELID and contype='p';<br><br>  -- v_pk_vector, v_pk_attname_array 信息获取.<br>  if substring(version(),12,1) = '9' then<br>    select string_agg(rn::text, ' ')::int2vector, array_agg(attname) into v_pk_vector, v_pk_attname_array from<br>      (select row_number() over() AS rn, attnum, attname from pg_attribute where attnum&gt;0 and not attisdropped and attrelid=TG_RELID) AS t      <br>      where attnum in                                                                               <br>      (select unnest(conkey) from pg_constraint where conrelid=TG_RELID and contype='p');<br>  elsif substring(version(),12,1) = '8' then<br>    select string_agg(attnum::text, ' ')::int2vector, array_agg(attname) into v_pk_vector, v_pk_attname_array from pg_attribute <br>      where attrelid=TG_RELID<br>      and attnum in<br>      (select unnest(conkey) from pg_constraint where conrelid=TG_RELID and contype='p');<br>  else<br>    -- 其他版本返回异常<br>    raise exception 'PostgreSQL Version not 8 or 9.';<br>  end if;<br><br>  y := 0;<br>  case TG_OP<br>  when 'INSERT' then<br>    -- 生成远程要执行的insert语句, id是这个表的主键. 如果是多列值的则需要得到按v_pk_vector顺序的text[], 考虑到兼容性不使用array的foreach循环<br>    for i in select * from unnest(v_pk_attname_array) AS t(attname) loop<br>      if y = 0 then<br>        execute 'select array[('||quote_literal(NEW)||'::'||v_nsp_name||'.'||v_table_name||').'||i.attname||']::text[]' into v_pk_att_vals_array;<br>      else<br>        tmp_v_pk_att_vals_array := v_pk_att_vals_array;<br>	execute 'select array_append($1, ('||quote_literal(NEW)||'::'||v_nsp_name||'.'||v_table_name||').'||i.attname||'::text)' into v_pk_att_vals_array using tmp_v_pk_att_vals_array;<br>      end if;<br>      y := y+1;<br>    end loop;<br>    select * into v_query from dblink_build_sql_insert(v_nsp_name||'.'||v_table_name, v_pk_vector, v_pk_cnt, v_pk_att_vals_array, v_pk_att_vals_array);<br>  when 'DELETE' then<br>    -- 生成远程要执行的delete语句, id是这个表的主键. 如果是多列值的则需要得到按v_pk_vector顺序的text[]<br>    for i in select * from unnest(v_pk_attname_array) AS t(attname) loop<br>      if y = 0 then<br>        execute 'select array[('||quote_literal(OLD)||'::'||v_nsp_name||'.'||v_table_name||').'||i.attname||']::text[]' into v_pk_att_vals_array;<br>      else<br>        tmp_v_pk_att_vals_array := v_pk_att_vals_array;<br>	execute 'select array_append($1, ('||quote_literal(OLD)||'::'||v_nsp_name||'.'||v_table_name||').'||i.attname||'::text)' into v_pk_att_vals_array using tmp_v_pk_att_vals_array;<br>      end if;<br>      y := y+1;<br>    end loop;<br>    select * into v_query from dblink_build_sql_delete(v_nsp_name||'.'||v_table_name, v_pk_vector, v_pk_cnt, v_pk_att_vals_array);<br>  when 'UPDATE' then<br>    -- 生成远程要执行的update语句, id是这个表的主键. 如果是多列值的则需要得到按v_pk_vector顺序的text[]<br>    -- 这里没有使用dblink_build_sql_update来生成update语句, 因为主键也可能被更新. 所以只能拆成两部分.<br>    for i in select * from unnest(v_pk_attname_array) AS t(attname) loop<br>      if y = 0 then<br>        execute 'select array[('||quote_literal(OLD)||'::'||v_nsp_name||'.'||v_table_name||').'||i.attname||']::text[]' into v_pk_att_vals_array;<br>      else<br>        tmp_v_pk_att_vals_array := v_pk_att_vals_array;<br>	execute 'select array_append($1, ('||quote_literal(OLD)||'::'||v_nsp_name||'.'||v_table_name||').'||i.attname||'::text)' into v_pk_att_vals_array using tmp_v_pk_att_vals_array;<br>      end if;<br>      y := y+1;<br>    end loop;<br>    -- debug<br>    -- raise notice '%', v_pk_att_vals_array;<br>    select * into v_query_upd1 from dblink_build_sql_delete(v_nsp_name||'.'||v_table_name, v_pk_vector, v_pk_cnt, v_pk_att_vals_array);<br>    -- 初始化<br>    v_pk_att_vals_array := null;<br>    for i in select * from unnest(v_pk_attname_array) AS t(attname) loop<br>      if y = 0 then<br>        execute 'select array[('||quote_literal(NEW)||'::'||v_nsp_name||'.'||v_table_name||').'||i.attname||']::text[]' into v_pk_att_vals_array;<br>      else<br>        tmp_v_pk_att_vals_array := v_pk_att_vals_array;<br>	execute 'select array_append($1, ('||quote_literal(NEW)||'::'||v_nsp_name||'.'||v_table_name||').'||i.attname||'::text)' into v_pk_att_vals_array using tmp_v_pk_att_vals_array;<br>      end if;<br>      y := y+1;<br>    end loop;<br>    -- debug<br>    -- raise notice '%', v_pk_att_vals_array;<br>    select * into v_query_upd2 from dblink_build_sql_insert(v_nsp_name||'.'||v_table_name, v_pk_vector, v_pk_cnt, v_pk_att_vals_array, v_pk_att_vals_array);<br>  when 'TRUNCATE' then<br>    -- 生成远程要执行的truncate语句. 注意这里是truncate table only. 如果是子表, 可以在子表上继续减这样的触发器.<br>    v_query := 'truncate table only '||v_table_name;<br>  end case;<br>  -- 将目标schema和目标表名替换现有表名.<br>  case TG_OP<br>  when 'UPDATE' then<br>    v_dst_query_upd1 := regexp_replace(v_query_upd1, v_table_name, v_dst_nsp_name||'.'||v_dst_table_name, '');<br>    v_dst_query_upd2 := regexp_replace(v_query_upd2, v_table_name, v_dst_nsp_name||'.'||v_dst_table_name, '');<br>    v_dst_query := v_dst_query_upd1||';'||v_dst_query_upd2;<br>  else<br>    v_dst_query := regexp_replace(v_query, v_table_name, v_dst_nsp_name||'.'||v_dst_table_name, '');<br>  end case;<br>  -- debug<br>  -- raise notice 'v_dst_query:%', v_dst_query;<br>  -- 异步复制逻辑. 异步的情况下如果要做到绝对的远程执行顺序一致并且远程执行的SQL带有事务属性, 请使用londiste3.<br>  if v_replica_mode = 'async' then<br>    -- 防止远程SQL执行顺序错误的逻辑如下, 原因详见 http://blog.163.com/digoal@126/blog/static/1638770402012731944439/<br>    -- 判断sync_err_rec是否被其他会话加RowExclusiveLock锁. 如果发现, 往sync_err_rec写入触发SQL, <br>    -- 返回NULL. 不再继续调用dblink_exec(v_conn_name, v_dst_query, false)<br>    perform 1 from pg_locks where <br>      relation=(select oid from pg_class where relname='sync_err_rec') <br>      and pid != pg_backend_pid()<br>      and mode='RowExclusiveLock'<br>      limit 1;<br>    if found then<br>      raise notice 'sync_err_rec in syncing, this sql will insert into sync_err_rec but not replica to remote now.';<br>      insert into sync_err_rec (nsp_name, table_name, dst_server, dst_query, create_time) <br>        values (v_nsp_name, v_table_name, v_dst_server, v_dst_query, clock_timestamp());<br>      return null;<br>    end if;<br>    -- 判断sync_err_rec中是否有dst_server=v_dst_server的记录. 如果发现, 往sync_err_rec写入触发SQL, <br>    -- 返回NULL. 不再继续调用dblink_exec(v_conn_name, v_dst_query, false)<br>    perform 1 from sync_err_rec where dst_server=v_dst_server limit 1;<br>    if found then<br>      raise notice 'sync_err_rec has record with %, this sql will insert into sync_err_rec but not replica to remote now.', v_dst_server;<br>      insert into sync_err_rec (nsp_name, table_name, dst_server, dst_query, create_time) <br>        values (v_nsp_name, v_table_name, v_dst_server, v_dst_query, clock_timestamp());<br>      return null;</span></font></div><div><font size="2"   ><span style="line-height: 19px;"   >    -- 严格意义上来说这里应该加一个else raise; 报错; 原因是如果是并行的插入的话, 可能会出现前面的事务遇到问题插入了sync_err_rec并且还未提交,&nbsp;</span></font></div><div><font size="2"   ><span style="line-height: 19px;"   >    -- 但是后面的事务没有发现sync_err_rec中的记录, 并且后面的事务又可以正常操作远程库的话, 那么就出现后面的事务在远程先执行, 前面的事务却写入了</span></font></div><div><font size="2"   ><span style="line-height: 19px;"   >    -- sync_err_rec表的情况, 也就是本地和远端事务的执行顺序不一致.<br>    end if;<br>  end if;</span></font></div><div><font size="2"   ><span style="line-height: 19px;"   ><br>  -- 判断连接是否存在, 不存在则创建.<br>  if ( dblink_get_connections() @&gt; ('{'||v_conn_name||'}')::text[] ) then <br>  else<br>    select * into v_conn_status from dblink_connect(v_conn_name, v_dst_server);<br>  end if;<br>  -- 判断是同步复制还是异步复制<br>  if v_replica_mode = 'sync' then<br>    -- 同步复制, 远程执行错误将回滚本地事务.<br>    select * into v_exec_status from dblink_exec(v_conn_name, v_dst_query, true);<br>  elsif v_replica_mode = 'async' then<br>    -- 异步复制, 远程执行错误不回滚事务, 只是返回ERROR字符串<br>    select * into v_exec_status from dblink_exec(v_conn_name, v_dst_query, false);<br>    if (v_exec_status = 'ERROR') then<br>      insert into sync_err_rec (nsp_name, table_name, dst_server, dst_query, create_time) <br>        values (v_nsp_name, v_table_name, v_dst_server, v_dst_query, clock_timestamp());<br>    end if;<br>  else<br>    raise exception 'replica mode must sync or async.';<br>  end if;<br>  -- 复制完成, 返回.<br>  return null;<br>-- 连接异常捕获<br>exception<br>  WHEN SQLSTATE '08000' <br>    or SQLSTATE '08003' <br>    or SQLSTATE '08006' <br>    or SQLSTATE '08001' <br>    or SQLSTATE '08004' <br>    or SQLSTATE '08007' <br>    or SQLSTATE '08P01' THEN<br>    if v_replica_mode = 'async' then<br>      insert into sync_err_rec (nsp_name, table_name, dst_server, dst_query, create_time) <br>        values (v_nsp_name, v_table_name, v_dst_server, v_dst_query, clock_timestamp());<br>      raise notice 'CONNECTION EXCEPTION, remote SQL write to sync_err_rec';<br>      return null;<br>    elsif v_replica_mode = 'sync' then<br>      raise;<br>    else<br>      raise exception 'replica mode must sync or async.';<br>    end if;<br>-- 其他异常不记录到sync_err_rec, 仅用于区分同步复制和异步复制.<br>END;<br>$BODY$ volatile;</span></font></div><p></p></pre></div><div><span style="line-height: 22px;"   >【同步复制测试 :】</span></div><p></p></div><div>在local库创建触发器 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >\c local local</font></div><div><div><font size="2"   >CREATE TRIGGER tg1 AFTER DELETE or UPDATE or INSERT ON loc_test FOR EACH ROW EXECUTE PROCEDURE f_sync_test(<span style="line-height: 19px;"   >'dst', 'remote', 'rmt_test', 'aaa_bbb_digoal', 'sync'</span></font><span style="line-height: 19px; font-size: small; font-family: Arial, Helvetica, sans-serif;"   >);</span></div><div><font size="2"   >CREATE TRIGGER tg2 AFTER TRUNCATE ON loc_test FOR EACH STATEMENT EXECUTE PROCEDURE f_sync_test(<span style="line-height: 19px;"   >'dst', 'remote', 'rmt_test', 'aaa_bbb_digoal', 'sync'</span></font><span style="line-height: 19px; font-size: small; font-family: Arial, Helvetica, sans-serif;"   >);</span></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >在remote库创建触发器 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >\c remote remote</font></div><div><div><font size="2"   >CREATE TRIGGER tg1 AFTER DELETE or UPDATE or INSERT ON rmt_test FOR EACH ROW EXECUTE PROCEDURE f_sync_test(<span style="line-height: 19px;"   >'dst', 'local', 'loc_test', 'aaa_bbb_digoal', 'sync'</span></font><span style="line-height: 19px; font-size: small; font-family: Arial, Helvetica, sans-serif;"   >);</span></div><div><font size="2"   >CREATE TRIGGER tg2 AFTER TRUNCATE ON rmt_test FOR EACH STATEMENT EXECUTE PROCEDURE f_sync_test(<span style="line-height: 19px;"   >'dst', 'local', 'loc_test', 'aaa_bbb_digoal', 'sync'</span></font><span style="line-height: 19px; font-size: small; font-family: Arial, Helvetica, sans-serif;"   >);</span></div></div></pre></div><div>插入 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >local=&gt; insert into loc_test select generate_series(1,10),'abc',now(),now();</font></div><div><font size="2"   >INSERT 0 10</font></div><div><font size="2"   >local=&gt; select * from loc_test;</font></div><div><font size="2"   >&nbsp;pk1 | pk2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | mod_time&nbsp;</font></div><div><font size="2"   >-----+-----+-------------------------------+---------------------+----------</font></div><div><font size="2"   >&nbsp; &nbsp;1 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;2 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;3 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;4 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;5 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;6 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;7 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;8 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;9 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; 10 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >(10 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >local=&gt; \c remote remote</font></div><div><font size="2"   >You are now connected to database "remote" as user "remote".</font></div><div><font size="2"   >remote=&gt; select * from rmt_test ;</font></div><div><font size="2"   >&nbsp;pk1 | pk2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | mod_time&nbsp;</font></div><div><font size="2"   >-----+-----+-------------------------------+---------------------+----------</font></div><div><font size="2"   >&nbsp; &nbsp;1 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;2 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;3 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;4 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;5 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;6 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;7 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;8 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;9 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; 10 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >(10 rows)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >remote=&gt; insert into rmt_test select generate_series(11,12),'abc',now(),now();</font></div><div><font size="2"   >INSERT 0 2</font></div><div><font size="2"   >remote=&gt; select * from rmt_test;</font></div><div><font size="2"   >&nbsp;pk1 | pk2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | mod_time&nbsp;</font></div><div><font size="2"   >-----+-----+-------------------------------+---------------------+----------</font></div><div><font size="2"   >&nbsp; &nbsp;1 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;2 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;3 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;4 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;5 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;6 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;7 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;8 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;9 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; 10 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; 11 | abc | 2013-03-11 15:03:01.569531+08 | 2013-03-11 15:03:02 |&nbsp;</font></div><div><font size="2"   >&nbsp; 12 | abc | 2013-03-11 15:03:01.569531+08 | 2013-03-11 15:03:02 |&nbsp;</font></div><div><font size="2"   >(12 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >remote=&gt; \c local local</font></div><div><font size="2"   >You are now connected to database "local" as user "local".</font></div><div><font size="2"   >local=&gt; select * from loc_test;</font></div><div><font size="2"   >&nbsp;pk1 | pk2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | mod_time&nbsp;</font></div><div><font size="2"   >-----+-----+-------------------------------+---------------------+----------</font></div><div><font size="2"   >&nbsp; &nbsp;1 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;2 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;3 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;4 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;5 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;6 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;7 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;8 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;9 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; 10 | abc | 2013-03-11 15:02:15.769929+08 | 2013-03-11 15:02:16 |&nbsp;</font></div><div><font size="2"   >&nbsp; 11 | abc | 2013-03-11 15:03:01.569531+08 | 2013-03-11 15:03:02 |&nbsp;</font></div><div><font size="2"   >&nbsp; 12 | abc | 2013-03-11 15:03:01.569531+08 | 2013-03-11 15:03:02 |&nbsp;</font></div><div><font size="2"   >(12 rows)</font></div></div><p></p></pre></div><div><br></div><div>更新 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >local=&gt; update loc_test set pk2='new' where pk1=1;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >local=&gt; select * from loc_test where pk1=1;</font></div><div><font size="2"   >&nbsp;pk1 | pk2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | mod_time&nbsp;</font></div><div><font size="2"   >-----+-----+-------------------------------+---------------------+----------</font></div><div><font size="2"   >&nbsp; &nbsp;1 | new | 2013-03-11 15:20:12.791216+08 | 2013-03-11 15:20:13 |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >local=&gt; \c remote remote</font></div><div><font size="2"   >You are now connected to database "remote" as user "remote".</font></div><div><font size="2"   >remote=&gt; select * from rmt_test where pk1=1;</font></div><div><font size="2"   >&nbsp;pk1 | pk2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | mod_time&nbsp;</font></div><div><font size="2"   >-----+-----+-------------------------------+---------------------+----------</font></div><div><font size="2"   >&nbsp; &nbsp;1 | new | 2013-03-11 15:20:12.791216+08 | 2013-03-11 15:20:13 |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >remote=&gt; select * from rmt_test where pk1=2;</font></div><div><font size="2"   >&nbsp;pk1 | pk2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | mod_time&nbsp;</font></div><div><font size="2"   >-----+-----+-------------------------------+---------------------+----------</font></div><div><font size="2"   >&nbsp; &nbsp;2 | abc | 2013-03-11 15:20:12.791216+08 | 2013-03-11 15:20:13 |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >remote=&gt; update rmt_test set pk2='rmt' where pk1=2;</font></div><div><font size="2"   >UPDATE 1</font></div></div><div><div><font size="2"   >remote=&gt; select * from rmt_test where pk1=2;</font></div><div><font size="2"   >&nbsp;pk1 | pk2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | mod_time&nbsp;</font></div><div><font size="2"   >-----+-----+-------------------------------+---------------------+----------</font></div><div><font size="2"   >&nbsp; &nbsp;2 | rmt | 2013-03-11 15:20:12.791216+08 | 2013-03-11 15:20:13 |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >remote=&gt; \c local local</font></div><div><font size="2"   >You are now connected to database "local" as user "local".</font></div><div><font size="2"   >local=&gt; select * from loc_test where pk1=2;</font></div><div><font size="2"   >&nbsp;pk1 | pk2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | mod_time&nbsp;</font></div><div><font size="2"   >-----+-----+-------------------------------+---------------------+----------</font></div><div><font size="2"   >&nbsp; &nbsp;2 | rmt | 2013-03-11 15:20:12.791216+08 | 2013-03-11 15:20:13 |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>删除 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >local=&gt; delete from loc_test where pk1&lt;9;</font></span></div><div><div><font size="2"   >DELETE 8</font></div><div><font size="2"   >local=&gt; select * from loc_test;</font></div><div><font size="2"   >&nbsp;pk1 | pk2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | mod_time&nbsp;</font></div><div><font size="2"   >-----+-----+-------------------------------+---------------------+----------</font></div><div><font size="2"   >&nbsp; &nbsp;9 | abc | 2013-03-11 15:20:12.791216+08 | 2013-03-11 15:20:13 |&nbsp;</font></div><div><font size="2"   >&nbsp; 10 | abc | 2013-03-11 15:20:12.791216+08 | 2013-03-11 15:20:13 |&nbsp;</font></div><div><font size="2"   >&nbsp; 11 | abc | 2013-03-11 15:20:24.136187+08 | 2013-03-11 15:20:24 |&nbsp;</font></div><div><font size="2"   >&nbsp; 12 | abc | 2013-03-11 15:20:24.136187+08 | 2013-03-11 15:20:24 |&nbsp;</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >local=&gt; \c remote remote</font></div><div><font size="2"   >You are now connected to database "remote" as user "remote".</font></div><div><font size="2"   >remote=&gt; select * from rmt_test;</font></div><div><font size="2"   >&nbsp;pk1 | pk2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | mod_time&nbsp;</font></div><div><font size="2"   >-----+-----+-------------------------------+---------------------+----------</font></div><div><font size="2"   >&nbsp; &nbsp;9 | abc | 2013-03-11 15:20:12.791216+08 | 2013-03-11 15:20:13 |&nbsp;</font></div><div><font size="2"   >&nbsp; 10 | abc | 2013-03-11 15:20:12.791216+08 | 2013-03-11 15:20:13 |&nbsp;</font></div><div><font size="2"   >&nbsp; 11 | abc | 2013-03-11 15:20:24.136187+08 | 2013-03-11 15:20:24 |&nbsp;</font></div><div><font size="2"   >&nbsp; 12 | abc | 2013-03-11 15:20:24.136187+08 | 2013-03-11 15:20:24 |&nbsp;</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >remote=&gt; delete from rmt_test where pk1&gt;=11;</font></div><div><font size="2"   >DELETE 2</font></div><div><font size="2"   >remote=&gt; select * from rmt_test;</font></div><div><font size="2"   >&nbsp;pk1 | pk2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | mod_time&nbsp;</font></div><div><font size="2"   >-----+-----+-------------------------------+---------------------+----------</font></div><div><font size="2"   >&nbsp; &nbsp;9 | abc | 2013-03-11 15:20:12.791216+08 | 2013-03-11 15:20:13 |&nbsp;</font></div><div><font size="2"   >&nbsp; 10 | abc | 2013-03-11 15:20:12.791216+08 | 2013-03-11 15:20:13 |&nbsp;</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >remote=&gt; \c local local</font></div><div><font size="2"   >You are now connected to database "local" as user "local".</font></div><div><font size="2"   >local=&gt; select * from loc_test;</font></div><div><font size="2"   >&nbsp;pk1 | pk2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | mod_time&nbsp;</font></div><div><font size="2"   >-----+-----+-------------------------------+---------------------+----------</font></div><div><font size="2"   >&nbsp; &nbsp;9 | abc | 2013-03-11 15:20:12.791216+08 | 2013-03-11 15:20:13 |&nbsp;</font></div><div><font size="2"   >&nbsp; 10 | abc | 2013-03-11 15:20:12.791216+08 | 2013-03-11 15:20:13 |&nbsp;</font></div><div><font size="2"   >(2 rows)</font></div></div><p></p></pre></div><div><br></div><div>TRUNCATE测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >local=&gt; truncate table loc_test ;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div></div><div><div><font size="2"   >local=&gt; \c remote remote</font></div><div><font size="2"   >You are now connected to database "remote" as user "remote".</font></div><div><font size="2"   >remote=&gt; select * from rmt_test ;</font></div><div><font size="2"   >&nbsp;pk1 | pk2 | info | crt_time | mod_time&nbsp;</font></div><div><font size="2"   >-----+-----+------+----------+----------</font></div><div><font size="2"   >(0 rows)</font></div></div><p></p></pre></div><div><br></div><div>【异步复制测试 : 】</div><div>local库 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >创建异步复制触发器 :&nbsp;</font></div><div><div><font size="2"   >local=&gt; CREATE TRIGGER atg1 AFTER DELETE or UPDATE or INSERT ON loc_test FOR EACH ROW EXECUTE PROCEDURE f_sync_test('dst', 'remote', 'rmt_test', 'aaa_bbb_digoal', 'async');</font></div><div><font size="2"   >CREATE TRIGGER</font></div></div><div><div><font size="2"   >local=&gt; CREATE TRIGGER atg2 AFTER TRUNCATE ON loc_test FOR EACH STATEMENT EXECUTE PROCEDURE f_sync_test('dst', 'remote', 'rmt_test', 'aaa_bbb_digoal', 'async');</font></div><div><font size="2"   >CREATE TRIGGER</font></div></div><div><font size="2"   >禁用同步复制触发器 :&nbsp;</font></div><div><div><font size="2"   >local=&gt; alter table loc_test DISABLE TRIGGER tg1;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >local=&gt; alter table loc_test DISABLE TRIGGER tg2;</font></div><div><font size="2"   >ALTER TABLE</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >remote库 :&nbsp;</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 22px;"   ><font size="2"   >创建异步复制触发器 :&nbsp;</font></div><div><font size="2"   >remote=&gt; CREATE TRIGGER atg1 AFTER DELETE or UPDATE or INSERT ON rmt_test FOR EACH ROW EXECUTE PROCEDURE f_sync_test('dst', 'local', 'loc_test', 'aaa_bbb_digoal', 'async');</font></div><div><font size="2"   >remote=&gt; CREATE TRIGGER atg2 AFTER TRUNCATE ON rmt_test FOR EACH STATEMENT EXECUTE PROCEDURE f_sync_test('dst', 'local', 'loc_test', 'aaa_bbb_digoal', 'async');</font></div><div style="line-height: 22px;"   ><font size="2"   >禁用同步复制触发器 :&nbsp;</font></div></div><div><div><font size="2"   >remote=&gt; alter table rmt_test DISABLE TRIGGER tg1;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >remote=&gt; alter table rmt_test DISABLE TRIGGER tg2;</font></div><div><font size="2"   >ALTER TABLE</font></div></div><p></p></pre></div></div><div>插入 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-- 正向同步</font></div><div><div><font size="2"   >local=&gt; insert into loc_test values (9,'abc','digoal',now(),now());</font></div><div><font size="2"   >INSERT 0 1</font></div></div><div><div><font size="2"   >local=&gt; select * from loc_test where pk1=9;</font></div><div><font size="2"   >&nbsp;pk1 | pk2 | &nbsp;info &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----+-----+--------+---------------------+---------------------</font></div><div><font size="2"   >&nbsp; &nbsp;9 | abc | digoal | 2013-03-13 09:24:29 | 2013-03-13 09:24:29</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >local=&gt; \c remote remote</font></div><div><font size="2"   >You are now connected to database "remote" as user "remote".</font></div><div><font size="2"   >remote=&gt; select * from rmt_test where pk1=9;</font></div><div><font size="2"   >&nbsp;pk1 | pk2 | &nbsp;info &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----+-----+--------+---------------------+---------------------</font></div><div><font size="2"   >&nbsp; &nbsp;9 | abc | digoal | 2013-03-13 09:24:29 | 2013-03-13 09:24:29</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >-- 反向同步</font></div><div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >remote=&gt; insert into rmt_test values (10,'abc','digoal',now(),now());</font></div><div style="line-height: 22px;"   ><font size="2"   >INSERT 0 1</font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >remote=&gt; select * from rmt_test where pk1=10;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;pk1 | pk2 | &nbsp;info &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >-----+-----+--------+---------------------+---------------------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; 10 | abc | digoal | 2013-03-13 09:26:04 | 2013-03-13 09:26:04</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div></div></div><div><font size="2"   >-- 本地错误不写sync_err_rec</font></div><div><div><font size="2"   >remote=&gt; insert into rmt_test values (9,'abc','digoal',now(),now());</font></div><div><font size="2"   >ERROR: &nbsp;duplicate key value violates unique constraint "rmt_test_pkey"</font></div><div><font size="2"   >DETAIL: &nbsp;Key (pk1, pk2)=(9, abc) already exists.</font></div></div><div><div><font size="2"   >remote=&gt; select * from sync_err_rec;</font></div><div><font size="2"   >&nbsp;id | nsp_name | table_name | dst_server | dst_query | create_time&nbsp;</font></div><div><font size="2"   >----+----------+------------+------------+-----------+-------------</font></div><div><font size="2"   >(0 rows)</font></div></div><p></p></pre></div><div><br></div><div>更新 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-- 反向更新</font></div><div><div><font size="2"   >remote=&gt; update rmt_test set pk2='new' where pk1=10;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >remote=&gt; select * from rmt_test where pk1=10;</font></div><div><font size="2"   >&nbsp;pk1 | pk2 | &nbsp;info &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----+-----+--------+---------------------+---------------------</font></div><div><font size="2"   >&nbsp; 10 | new | digoal | 2013-03-13 09:26:04 | 2013-03-13 09:26:04</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >remote=&gt; \c local local</font></div><div><font size="2"   >You are now connected to database "local" as user "local".</font></div><div><font size="2"   >local=&gt; select * from loc_test where pk1=10;</font></div><div><font size="2"   >&nbsp;pk1 | pk2 | &nbsp;info &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----+-----+--------+---------------------+---------------------</font></div><div><font size="2"   >&nbsp; 10 | new | digoal | 2013-03-13 09:26:04 | 2013-03-13 09:26:04</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >-- 正向更新</font></div><div><div><font size="2"   >local=&gt; update loc_test set pk2='new_loc' where pk1=10;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >local=&gt; select * from loc_test where pk1=10;</font></div><div><font size="2"   >&nbsp;pk1 | &nbsp; pk2 &nbsp; | &nbsp;info &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----+---------+--------+---------------------+---------------------</font></div><div><font size="2"   >&nbsp; 10 | new_loc | digoal | 2013-03-13 09:26:04 | 2013-03-13 09:26:04</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >local=&gt; \c remote remote</font></div><div><font size="2"   >You are now connected to database "remote" as user "remote".</font></div><div><font size="2"   >remote=&gt; select * from rmt_test where pk1=10;</font></div><div><font size="2"   >&nbsp;pk1 | &nbsp; pk2 &nbsp; | &nbsp;info &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----+---------+--------+---------------------+---------------------</font></div><div><font size="2"   >&nbsp; 10 | new_loc | digoal | 2013-03-13 09:26:04 | 2013-03-13 09:26:04</font></div><div><font size="2"   >(1 row)</font></div></div></pre></div><div><br></div><div>【错误测试 : 】</div><div>修改pg_hba.conf, 禁止远程连接 :&nbsp;</div><div>vi $PGDATA/pg_hba.conf</div><div>#host all all 0.0.0.0/0 md5</div><div>pg_ctl reload</div><div>以插入为例进行测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >建立连接的错误捕获, 本地执行, 远程SQL写入<span style="line-height: 22px;"   >sync_err_rec表, 以便后期处理.</span></font></div><div><span style="line-height: 22px;"   ><font size="2"   ><div>local=&gt; insert into loc_test values (11,'abc','digoal',now(),now());</div><div>NOTICE: &nbsp;CONNECTION EXCEPTION, remote SQL write to sync_err_rec</div><div>INSERT 0 1</div><div><div>local=&gt; select * from loc_test where pk1=11;</div><div>&nbsp;pk1 | pk2 | &nbsp;info &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp;&nbsp;</div><div>-----+-----+--------+---------------------+---------------------</div><div>&nbsp; 11 | abc | digoal | 2013-03-13 09:31:20 | 2013-03-13 09:31:20</div><div>(1 row)</div></div><div><div>local=&gt; select * from sync_err_rec;</div><div>&nbsp;id | nsp_name | table_name | dst_server | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dst_query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;create_time &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>----+----------+------------+------------+------------------------------------------------------------------------------------------</div><div>-------------------------------------------+----------------------------</div><div>&nbsp; 7 | local &nbsp; &nbsp;| loc_test &nbsp; | dst &nbsp; &nbsp; &nbsp; &nbsp;| INSERT INTO remote.rmt_test(pk1,pk2,info,crt_time,mod_time) VALUES('11','abc','digoal','2</div><div>013-03-13 09:31:20','2013-03-13 09:31:20') | 2013-03-13 09:31:20.394119</div><div>(1 row)</div></div><div><div>remote=&gt; select * from rmt_test where pk1=11;</div><div>&nbsp;pk1 | pk2 | info | crt_time | mod_time&nbsp;</div><div>-----+-----+------+----------+----------</div><div>(0 rows)</div></div><div><br></div></font></span></div><div><font size="2"   ><span style="line-height: 22px;"   >当sync_err_rec有目标foreign server的数据时</span><span style="line-height: 22px;"   >为了保证远程SQL执行顺序, 不立即复制.</span></font></div><div><div><font size="2"   >remote=&gt; \c local local</font></div><div><font size="2"   >You are now connected to database "local" as user "local".</font></div><div><font size="2"   >local=&gt; insert into loc_test values (12,'abc','digoal',now(),now());</font></div><div><font size="2"   >NOTICE: &nbsp;sync_err_rec has record with dst, this sql will insert into sync_err_rec but not replica to remote now.</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >local=&gt; select * from loc_test where pk1=12;</font></div><div><font size="2"   >&nbsp;pk1 | pk2 | &nbsp;info &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----+-----+--------+---------------------+---------------------</font></div><div><font size="2"   >&nbsp; 12 | abc | digoal | 2013-03-13 09:32:18 | 2013-03-13 09:32:18</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >local=&gt; select * from sync_err_rec;</font></div><div><font size="2"   >&nbsp;id | nsp_name | table_name | dst_server | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dst_query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;create_time &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----+----------+------------+------------+------------------------------------------------------------------------------------------</font></div><div><font size="2"   >-------------------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp; 7 | local &nbsp; &nbsp;| loc_test &nbsp; | dst &nbsp; &nbsp; &nbsp; &nbsp;| INSERT INTO remote.rmt_test(pk1,pk2,info,crt_time,mod_time) VALUES('11','abc','digoal','2</font></div><div><font size="2"   >013-03-13 09:31:20','2013-03-13 09:31:20') | 2013-03-13 09:31:20.394119</font></div><div><font size="2"   >&nbsp; 8 | local &nbsp; &nbsp;| loc_test &nbsp; | dst &nbsp; &nbsp; &nbsp; &nbsp;| INSERT INTO remote.rmt_test(pk1,pk2,info,crt_time,mod_time) VALUES('12','abc','digoal','2</font></div><div><font size="2"   >013-03-13 09:32:18','2013-03-13 09:32:18') | 2013-03-13 09:32:18.486967</font></div><div><font size="2"   >(2 rows)</font></div></div><div><span style="line-height: 22px;"   ><font size="2"   ><br></font></span></div><div><div style="line-height: 22px;"   ><font size="2"   >正在执行deal_sync_err_rec时为了保证远程SQL执行顺序, 不立即复制.</font></div></div><div style="line-height: 22px;"   ><font size="2"   >修改pg_hba.conf, 允许连接, 并执行<span style="line-height: 22px;"   >deal_sync_err_rec修复数据.</span></font></div><div><font size="2"   >SESSION A :&nbsp;</font></div><div><div><font size="2"   >local=&gt; begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >local=&gt; select * from deal_sync_err_rec(10);</font></div><div><font size="2"   >&nbsp;deal_sync_err_rec&nbsp;</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp;t</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >-- 不结束事务,暂不释放锁</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SESSION B :&nbsp;</font></div><div><div><font size="2"   >local=&gt; insert into loc_test values (13,'abc','digoal',now(),now());</font></div><div><font size="2"   >NOTICE: &nbsp;00000: sync_err_rec in syncing, this sql will insert into sync_err_rec but not replica to remote now.</font></div><div><font size="2"   >LOCATION: &nbsp;exec_stmt_raise, pl_exec.c:2840</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >Time: 12.985 ms</font></div></div><div><div><font size="2"   >local=&gt; select * from sync_err_rec;</font></div><div><font size="2"   >&nbsp;id | nsp_name | table_name | dst_server | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dst_query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;create_time &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----+----------+------------+------------+------------------------------------------------------------------------------------------</font></div><div><font size="2"   >-------------------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp; 7 | local &nbsp; &nbsp;| loc_test &nbsp; | dst &nbsp; &nbsp; &nbsp; &nbsp;| INSERT INTO remote.rmt_test(pk1,pk2,info,crt_time,mod_time) VALUES('11','abc','digoal','2</font></div><div><font size="2"   >013-03-13 09:31:20','2013-03-13 09:31:20') | 2013-03-13 09:31:20.394119</font></div><div><font size="2"   >&nbsp; 8 | local &nbsp; &nbsp;| loc_test &nbsp; | dst &nbsp; &nbsp; &nbsp; &nbsp;| INSERT INTO remote.rmt_test(pk1,pk2,info,crt_time,mod_time) VALUES('12','abc','digoal','2</font></div><div><font size="2"   >013-03-13 09:32:18','2013-03-13 09:32:18') | 2013-03-13 09:32:18.486967</font></div><div><font size="2"   >&nbsp; 9 | local &nbsp; &nbsp;| loc_test &nbsp; | dst &nbsp; &nbsp; &nbsp; &nbsp;| INSERT INTO remote.rmt_test(pk1,pk2,info,crt_time,mod_time) VALUES('13','abc','digoal','2</font></div><div><font size="2"   >013-03-13 09:34:32','2013-03-13 09:34:32') | 2013-03-13 09:34:31.6283</font></div><div><font size="2"   >(3 rows)</font></div><div><font size="2"   >Time: 0.439 ms</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >SESSION A :&nbsp;</font></div><div><font size="2"   >所有异常SQL处理完</font></div><div><div><font size="2"   >local=&gt; end;</font></div><div><font size="2"   >COMMIT</font></div><div><font size="2"   >local=&gt; select * from deal_sync_err_rec(10);</font></div><div><font size="2"   >&nbsp;deal_sync_err_rec&nbsp;</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp;t</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >local=&gt; select * from sync_err_rec;</font></div><div><font size="2"   >&nbsp;id | nsp_name | table_name | dst_server | dst_query | create_time&nbsp;</font></div><div><font size="2"   >----+----------+------------+------------+-----------+-------------</font></div><div><font size="2"   >(0 rows)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >SESSION B :&nbsp;</font></div><div><span style="line-height: 22px;"   ><font size="2"   >后, 远程SQL正常复制</font></span></div><div><div><font size="2"   >local=&gt; insert into loc_test values (14,'abc','digoal',now(),now());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >Time: 14.380 ms</font></div></div><div><font size="2"   >-- 对比远程和本地的HASH值一致 :&nbsp;</font></div><div><div><font size="2"   >local=&gt; select sum(hashtext(t.*::text)) from loc_test t;</font></div><div><font size="2"   >&nbsp; &nbsp; sum &nbsp; &nbsp;</font></div><div><font size="2"   >-----------</font></div><div><font size="2"   >&nbsp;306096063</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 0.865 ms</font></div><div><font size="2"   >local=&gt; \c remote remote</font></div><div><font size="2"   >You are now connected to database "remote" as user "remote".</font></div><div><font size="2"   >remote=&gt; select sum(hashtext(t.*::text)) from rmt_test t;</font></div><div><font size="2"   >&nbsp; &nbsp; sum &nbsp; &nbsp;</font></div><div><font size="2"   >-----------</font></div><div><font size="2"   >&nbsp;306096063</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 1.991 ms</font></div></div><p></p></pre></div><div><br></div><div>【注意事项】</div><div>1. application_name被用于防止无限循环的触发, 所以foreign server的option中设置的application_name必须与远程表上创建的触发器的传入值一致.</div><div>&nbsp; &nbsp; 例如rmt_test表的触发器条件中设置了aaa_bbb_digoal.</div><div>&nbsp; &nbsp; 那么在local库上创建的foreign server的option中application_name必须也是aaa_bbb_digoal;</div><div>2. 注意dblink_build_sql_insert,&nbsp;dblink_build_sql_delete,&nbsp;dblink_build_sql_update这几个函数的参数int2vector primary_key_attnums;</div><div>&nbsp; &nbsp; PostgreSQL 9.0以及以上版本, 指的是PK在逻辑上的输出顺序, 如select * from loc_test的逻辑输出顺序.</div><div>&nbsp; &nbsp; PostgreSQL 9.0以下的版本, 指的是PK列在pg_attribute.attnum的值.&nbsp;</div><div>&nbsp; &nbsp; 所以当PK的前面删除了列以后, PK的逻辑顺序会发生变化, 对于9.0以上版本的话需要注意这个变化.</div><div>&nbsp; &nbsp; 因此在触发器函数中需要体现这个变化.</div><div>原文如下 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >As of PostgreSQL 9.0, the attribute numbers in primary_key_attnums are interpreted as logical column numbers, corresponding to the column's position in SELECT * FROM relname. Previous versions interpreted the numbers as physical column positions. There is a difference if any column(s) to the left of the indicated column have been dropped during the lifetime of the table.</font></p></pre></div><div>3. 异步复制的sync_err_rec可以使用crontab定期调用deal_sync_err_rec函数来处理.</div><div>4. 值注意用quote_literal来解析, 否则可能造成字符逃逸问题.</div><div>例如上一个版本的SQL封装中使用的$Q$, 如果出现在PK中就会有逃逸问题, 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >when 'INSERT' then</font></div><div><font size="2"   >&nbsp; &nbsp; -- 生成远程要执行的insert语句, id是这个表的主键. 如果是多列值的则需要得到按v_pk_vector顺序的text[], 考虑到兼容性不使用array的for</font></div><div><font size="2"   >each循环</font></div><div><font size="2"   >&nbsp; &nbsp; for i in select * from unnest(v_pk_attname_array) AS t(attname) loop</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; if y = 0 then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; execute 'select array[($Q$'||NEW||'$Q$::'||v_nsp_name||'.'||v_table_name||').'||i.attname||']::text[]' into v_pk_att_vals_ar</font></div><div><font size="2"   >ray;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; tmp_v_pk_att_vals_array := v_pk_att_vals_array;</font></div><div><font size="2"   >execute 'select array_append($1, ($Q$'||NEW||'$Q$::'||v_nsp_name||'.'||v_table_name||').'||i.attname||'::text)' into v_pk_att_vals_a</font></div><div><font size="2"   >rray using tmp_v_pk_att_vals_array;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; y := y+1;</font></div><div><font size="2"   >&nbsp; &nbsp; end loop;</font></div><div><font size="2"   >&nbsp; &nbsp; select * into v_query from dblink_build_sql_insert(v_nsp_name||'.'||v_table_name, v_pk_vector, v_pk_cnt, v_pk_att_vals_array, v_</font></div><div><font size="2"   >pk_att_vals_array);</font></div><p></p></pre></div><div>异常数据 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >local=&gt; insert into loc_test values(1,'$Q$','$Q$',now(),now());</font></div><div><font size="2"   >ERROR: &nbsp;syntax error at or near "."</font></div><div><font size="2"   >LINE 1: ...:01:09","2013-03-14 08:01:09")$Q$::local.loc_test).pk1]::tex...</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >QUERY: &nbsp;select array[($Q$(1,$Q$,$Q$,"2013-03-14 08:01:09","2013-03-14 08:01:09")$Q$::local.loc_test).pk1]::text[]</font></div><div><font size="2"   >CONTEXT: &nbsp;PL/pgSQL function f_sync_test() line 77 at EXECUTE statement</font></div><p></p></pre></div><div>修改为quote_literal后正常 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >remote=&gt; insert into rmt_test values(100,'$Q$','$Q$',now(),now());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >Time: 4.086 ms</font></div></div><div><div><font size="2"   >remote=&gt; select * from rmt_test ;</font></div><div><font size="2"   >&nbsp;pk1 | &nbsp;pk2 &nbsp;| &nbsp;info &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----+-------+--------+---------------------+---------------------</font></div><div><font size="2"   >&nbsp; &nbsp;1 | $Q1$ &nbsp;| $Q1$ &nbsp; | 2013-03-14 08:02:50 | 2013-03-14 08:02:50</font></div><div><font size="2"   >&nbsp; &nbsp;1 | $Q$ &nbsp; | $Q$ &nbsp; &nbsp;| 2013-03-14 08:08:49 | 2013-03-14 08:08:49</font></div><div><font size="2"   >&nbsp; &nbsp;1 | $Q'$ &nbsp;| $'Q$ &nbsp; | 2013-03-14 08:09:16 | 2013-03-14 08:09:16</font></div><div><font size="2"   >&nbsp; &nbsp;1 | $Q$'$ | $Q$'Q$ | 2013-03-14 08:09:43 | 2013-03-14 08:09:43</font></div><div><font size="2"   >&nbsp; &nbsp;2 | $Q$' &nbsp;| $Q$'Q$ | 2013-03-14 08:13:45 | 2013-03-14 08:13:45</font></div><div><font size="2"   >(5 rows)</font></div></div><p></p></pre></div><div><br></div>【参考】<div>1.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013283547959/"   >http://blog.163.com/digoal@126/blog/static/1638770402013283547959/</a><br>2.&nbsp;<wbr><a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013211102130526/"   >http://blog.163.com/digoal@126/blog/static/1638770402013211102130526/</a></div><div>3.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012731944439/"   >http://blog.163.com/digoal@126/blog/static/1638770402012731944439/</a></div><div>4.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012731203716/"   >http://blog.163.com/digoal@126/blog/static/1638770402012731203716/</a></div></div>
	</div>
</div>
</body>
</html>