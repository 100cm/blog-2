<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Use PostgreSQL server program import binary data into database bytea type</h2>
	<h5 id="">2013-03-06 16:33:30&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013264951552/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>群里问到的一个问题, 如何将数据库服务器上的文件导入PostgreSQL数据库. 例如图片.</div><div>【方法1 : 】</div><div>使用pg_read_binary_file函数.&nbsp;</div><div>如下 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >postgres=# select pg_read_binary_file('postgresql.conf');</font></p></pre></div><div>因为postgresql.conf在$PGDATA, 下面所以可以读取.</div><div>如果是绝对路径或者不在$PGDATA或它的子目录下将报错 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select pg_read_binary_file('/home/ocz/t.sh');</font></div><div><font size="2"   >ERROR: &nbsp;absolute path not allowed</font></div></div><div><div><font size="2"   >postgres=# select pg_read_binary_file('../postgresql.conf');</font></div><div><font size="2"   >ERROR: &nbsp;path must be in or below the current directory</font></div></div><p></p></pre></div><div>除了读全文件以外, read_binary_file还支持offset和limit.&nbsp;</div><div>方法1除了对文件的位置做了限制外, 其实还是很好用的.</div><div><br></div><div>【方法2 : 】</div><div>使用大对象.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select lo_import('/home/ocz/t.sh');</font></div><div><font size="2"   >&nbsp;lo_import&nbsp;</font></div><div><font size="2"   >-----------</font></div><div><font size="2"   >&nbsp; &nbsp;3475818</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>/home/ocz/t.sh被导入pg_largeobject中, 在data字段中.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \d pg_largeobject</font></div><div><font size="2"   >Table "pg_catalog.pg_largeobject"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >--------+---------+-----------</font></div><div><font size="2"   >&nbsp;loid &nbsp; | oid &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;pageno | integer | not null</font></div><div><font size="2"   >&nbsp;data &nbsp; | bytea &nbsp; |&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_largeobject_loid_pn_index" UNIQUE, btree (loid, pageno)</font></div><p></p></pre></div><div>-- 查询</div><div><pre class="prettyprint"   ><p><font size="2"   >postgres=# select data from pg_largeobject where loid=3475818;</font></p></pre></div><div>当然还有更细致的查询, 如data的offset, limit.</div><div>大对象的使用例子可参考如下 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020130931040444/"   >http://blog.163.com/digoal@126/blog/static/16387704020130931040444/</a></div><div>方法2是集中式的管理, 虽然可以读任意位置的文件, 但是如果想在自己的表中存储bytea, 那么方法2不适合.</div><div><br></div><div>【方法3 : 】</div><div>解决方法1 和 方法2 的弊端.</div><div>自建读文件的函数 :&nbsp;</div><div><div>vi readfile.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#include "postgres.h"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#include &lt;sys/file.h&gt;</font></div><div><font size="2"   >#include &lt;sys/stat.h&gt;</font></div><div><font size="2"   >#include &lt;unistd.h&gt;</font></div><div><font size="2"   >#include &lt;dirent.h&gt;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#include "catalog/pg_type.h"</font></div><div><font size="2"   >#include "funcapi.h"</font></div><div><font size="2"   >#include "mb/pg_wchar.h"</font></div><div><font size="2"   >#include "miscadmin.h"</font></div><div><font size="2"   >#include "postmaster/syslogger.h"</font></div><div><font size="2"   >#include "storage/fd.h"</font></div><div><font size="2"   >#include "utils/builtins.h"</font></div><div><font size="2"   >#include "utils/memutils.h"</font></div><div><font size="2"   >#include "utils/timestamp.h"</font></div><div><font size="2"   >#include "fmgr.h"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >PG_MODULE_MAGIC;</font></div><div><font size="2"   >PG_FUNCTION_INFO_V1(cu_pg_read_binary_file_all);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >/* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;* Convert a "text" filename argument to C string, and check it's allowable. &nbsp;</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;* Filename may be absolute or relative to the DataDir, but we only allow &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;* absolute paths that match DataDir or Log_directory. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;*/ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >static char * &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >cu_convert_and_check_filename(text *arg) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >{ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *filename; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; filename = text_to_cstring(arg); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; canonicalize_path(filename); &nbsp; &nbsp;/* filename can change length here */ &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; return filename; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Datum</font></div><div><font size="2"   >cu_pg_read_binary_file_all(PG_FUNCTION_ARGS) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >{ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; text &nbsp; &nbsp; &nbsp; *filename_t = PG_GETARG_TEXT_P(0); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *filename; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; if (!superuser()) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_INSUFFICIENT_PRIVILEGE), &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(errmsg("must be superuser to read files"))));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; filename = cu_convert_and_check_filename(filename_t); &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; PG_RETURN_BYTEA_P(read_binary_file(filename, 0, -1)); &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >} &nbsp;</font></div><p></p></pre></div></div><div>编译 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >gcc -O3 -Wall -Wextra -Werror -I /home/ocz/postgresql-9.2.1/src/include -g -fPIC -c ./readfile.c -o readfile.o</font></div><div><font size="2"   >gcc -O3 -Wall -Wextra -Werror -I /home/ocz/postgresql-9.2.1/src/include -g -shared readfile.o -o libreadfile.so</font></div><p></p></pre></div><div>拷贝到库目录 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >cp libreadfile.so $PGHOME/lib/</font></p></pre></div><div>创建函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >psql digoal digoal</font></div><div><font size="2"   >digoal=# create or replace function cu_pg_read_binary_file(text) returns bytea as '$libdir/libreadfile.so', 'cu_pg_read_binary_file_all' language C STRICT;</font></div><p></p></pre></div><div>使用 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >digoal=# select cu_pg_read_binary_file('/home/ocz/t.sh');</font></p></pre></div><div>方法三的好处是, 不再受文件位置的限制.</div><div><br></div>【参考】<div>1.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020130931040444/"   >http://blog.163.com/digoal@126/blog/static/16387704020130931040444/</a><br>2.&nbsp;<wbr>src/backend/utils/adt/genfile.c</div><div>-- 这个函数包含了文件位置检测, 所以pg_read_binary_file不能读绝对路径以及$PGDATA之外的路径原因就在此.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >00041 /*</font></div><div><font size="2"   >00042 &nbsp;* Convert a "text" filename argument to C string, and check it's allowable.</font></div><div><font size="2"   >00043 &nbsp;*</font></div><div><font size="2"   >00044 &nbsp;* Filename may be absolute or relative to the DataDir, but we only allow</font></div><div><font size="2"   >00045 &nbsp;* absolute paths that match DataDir or Log_directory.</font></div><div><font size="2"   >00046 &nbsp;*/</font></div><div><font size="2"   >00047 static char *</font></div><div><font size="2"   >00048 convert_and_check_filename(text *arg)</font></div><div><font size="2"   >00049 {</font></div><div><font size="2"   >00050 &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *filename;</font></div><div><font size="2"   >00051&nbsp;</font></div><div><font size="2"   >00052 &nbsp; &nbsp; filename = text_to_cstring(arg);</font></div><div><font size="2"   >00053 &nbsp; &nbsp; canonicalize_path(filename); &nbsp; &nbsp;/* filename can change length here */</font></div><div><font size="2"   >00054&nbsp;</font></div><div><font size="2"   >00055 &nbsp; &nbsp; if (is_absolute_path(filename))</font></div><div><font size="2"   >00056 &nbsp; &nbsp; {</font></div><div><font size="2"   >00057 &nbsp; &nbsp; &nbsp; &nbsp; /* Disallow '/a/b/data/..' */</font></div><div><font size="2"   >00058 &nbsp; &nbsp; &nbsp; &nbsp; if (path_contains_parent_reference(filename))</font></div><div><font size="2"   >00059 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >00060 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_INSUFFICIENT_PRIVILEGE),</font></div><div><font size="2"   >00061 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errmsg("reference to parent directory (\"..\") not allowed"))));</font></div><div><font size="2"   >00062&nbsp;</font></div><div><font size="2"   >00063 &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >00064 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Allow absolute paths if within DataDir or Log_directory, even</font></div><div><font size="2"   >00065 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* though Log_directory might be outside DataDir.</font></div><div><font size="2"   >00066 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >00067 &nbsp; &nbsp; &nbsp; &nbsp; if (!path_is_prefix_of_path(DataDir, filename) &amp;&amp;</font></div><div><font size="2"   >00068 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (!is_absolute_path(Log_directory) ||</font></div><div><font size="2"   >00069 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;!path_is_prefix_of_path(Log_directory, filename)))</font></div><div><font size="2"   >00070 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >00071 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_INSUFFICIENT_PRIVILEGE),</font></div><div><font size="2"   >00072 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(errmsg("absolute path not allowed"))));</font></div><div><font size="2"   >00073 &nbsp; &nbsp; }</font></div><div><font size="2"   >00074 &nbsp; &nbsp; else if (!path_is_relative_and_below_cwd(filename))</font></div><div><font size="2"   >00075 &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >00076 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_INSUFFICIENT_PRIVILEGE),</font></div><div><font size="2"   >00077 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(errmsg("path must be in or below the current directory"))));</font></div><div><font size="2"   >00078&nbsp;</font></div><div><font size="2"   >00079 &nbsp; &nbsp; return filename;</font></div><div><font size="2"   >00080 }</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>