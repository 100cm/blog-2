<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">CitusDB, PostgreSQLs Use Hadoop Distribute Query - 1 : Single HOST CitusDB Cluster install</h2>
	<h5 id="">2013-03-19 11:19:17&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013219840831/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>测试环境 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CentOS release 5.7 (Final)</font></div><div><font size="2"   >内存 : 96GB</font></div><div><font size="2"   >CPU : 2 *&nbsp;Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >硬盘 : OCZ RevoDrive3</font></div><p></p></pre></div><div><br></div><div>1. 下载操作系统对应的citusdb包</div><div><pre class="prettyprint"   ><p><font size="2"   >wget http://packages.citusdata.com/readline-5.0/citusdb-2.0.0-1.x86_64.rpm</font></p></pre></div><div><br></div><div>2. 安装</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - root</font></div><div><font size="2"   >rpm -ivh&nbsp;citusdb-2.0.0-1.x86_64.rpm</font></div><div><font size="2"   ># 看看citusdb安装包的内容</font></div><div><div><font size="2"   >[root@db-172-16-3-150 ~]# rpm -qa|grep citus</font></div><div><font size="2"   >citusdb-2.0-2.0.0-1</font></div></div><div><font size="2"   ># 通过rpm -ql查看citusdb安装包的内容</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# rpm -ql citusdb-2.0-2.0.0-1</font></div><div><font size="2"   ># 从输出可以看到, 文件被解压到 /opt/citusdb</font></div><p></p></pre></div><div># 新增用户</div><div><pre class="prettyprint"   ><p><font size="2"   >[root@db-172-16-3-150 ~]# useradd citusdb</font></p></pre></div><div># 修改citusdb权限</div><div><pre class="prettyprint"   ><p><font size="2"   >[root@db-172-16-3-150 opt]# chown -R citusdb:citusdb /opt/citusdb</font></p></pre></div><div># 配置用户环境变量</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 opt]# su - citusdb</font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; vi .bash_profile&nbsp;</font></div></div><div><div><font size="2"   >export PS1="$USER@`/bin/hostname -s`-&gt; "</font></div><div><font size="2"   >export PGPORT=9900</font></div><div><font size="2"   >export PGUSER=postgres</font></div><div><font size="2"   >export PGDATA=/data06/citusdb/master</font></div><div><font size="2"   >export PGHOST=$PGDATA</font></div><div><font size="2"   >export PGDATABASE=digoal</font></div><div><div style="line-height: 22px;"   ><font size="2"   >export LANG=en_US.utf8</font></div><div style="line-height: 22px;"   ><font size="2"   >export PGHOME=/opt/citusdb/2.0</font></div></div><div><font size="2"   >export LD_LIBRARY_PATH=<span style="line-height: 19px;"   >$PGHOME/lib:$PGHOME/lib/postgresql:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</span></font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >#export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"   >export LD_PRELOAD=/usr/lib64/libncurses.so</font></div><div><font size="2"   >alias rm='rm -i'</font></div><div><font size="2"   >alias ll='ls -lh'</font></div></div><p></p></pre></div><div>#注意这里的LD_LIBRARY_PATH与postgresql 的LD_LIBRARY_PATH路径不一样, 多了一个路径lib/postgresql.</div><div>原因如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >citusdb@db-172-16-3-150-&gt; cd /opt/citusdb/2.0/lib/</font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; ll</font></div><div><font size="2"   >total 984K</font></div><div><font size="2"   >-rw-r--r-- 1 citusdb citusdb 147K Jan 14 21:04 libecpg.a</font></div><div><font size="2"   >-rw-r--r-- 1 citusdb citusdb &nbsp;19K Jan 14 21:04 libecpg_compat.a</font></div><div><font size="2"   >lrwxrwxrwx 1 citusdb citusdb &nbsp; 21 Mar 15 07:54 libecpg_compat.so -&gt; libecpg_compat.so.3.4</font></div><div><font size="2"   >lrwxrwxrwx 1 citusdb citusdb &nbsp; 21 Mar 15 07:54 libecpg_compat.so.3 -&gt; libecpg_compat.so.3.4</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb &nbsp;23K Jan 14 21:04 libecpg_compat.so.3.4</font></div><div><font size="2"   >lrwxrwxrwx 1 citusdb citusdb &nbsp; 14 Mar 15 07:54 libecpg.so -&gt; libecpg.so.6.4</font></div><div><font size="2"   >lrwxrwxrwx 1 citusdb citusdb &nbsp; 14 Mar 15 07:54 libecpg.so.6 -&gt; libecpg.so.6.4</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb &nbsp;85K Jan 14 21:04 libecpg.so.6.4</font></div><div><font size="2"   >-rw-r--r-- 1 citusdb citusdb &nbsp;65K Jan 14 21:02 libpgport.a</font></div><div><font size="2"   >-rw-r--r-- 1 citusdb citusdb &nbsp;99K Jan 14 21:04 libpgtypes.a</font></div><div><font size="2"   >lrwxrwxrwx 1 citusdb citusdb &nbsp; 17 Mar 15 07:54 libpgtypes.so -&gt; libpgtypes.so.3.3</font></div><div><font size="2"   >lrwxrwxrwx 1 citusdb citusdb &nbsp; 17 Mar 15 07:54 libpgtypes.so.3 -&gt; libpgtypes.so.3.3</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb &nbsp;68K Jan 14 21:04 libpgtypes.so.3.3</font></div><div><font size="2"   >-rw-r--r-- 1 citusdb citusdb 262K Jan 14 21:04 libpq.a</font></div><div><font size="2"   >lrwxrwxrwx 1 citusdb citusdb &nbsp; 12 Mar 15 07:54 libpq.so -&gt; libpq.so.5.5</font></div><div><font size="2"   >lrwxrwxrwx 1 citusdb citusdb &nbsp; 12 Mar 15 07:54 libpq.so.5 -&gt; libpq.so.5.5</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 172K Jan 14 21:04 libpq.so.5.5</font></div><div><font size="2"   >drwxr-xr-x 3 citusdb citusdb 4.0K Mar 19 14:16 postgresql</font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; cd postgresql/</font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; ll</font></div><div><font size="2"   >total 4.4M</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 7.1K Jan 14 21:04 ascii_and_mic.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb &nbsp;18K Jan 14 21:04 cyrillic_and_mic.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 459K Jan 14 21:04 dict_snowball.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 8.9K Jan 14 21:04 euc2004_sjis2004.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 7.4K Jan 14 21:04 euc_cn_and_mic.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb &nbsp;15K Jan 14 21:04 euc_jp_and_sjis.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 7.5K Jan 14 21:04 euc_kr_and_mic.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb &nbsp;14K Jan 14 21:04 euc_tw_and_big5.so</font></div><div><font size="2"   >-rwxr-xr-x 1 root &nbsp; &nbsp;root &nbsp; &nbsp; 22K Mar 19 14:16 file_fdw.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb &nbsp;11K Jan 14 21:04 latin2_and_win1250.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 9.3K Jan 14 21:04 latin_and_mic.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb &nbsp;17K Jan 14 21:05 libpqclientexecutor.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb &nbsp;15K Jan 14 21:05 libpqwalreceiver.so</font></div><div><font size="2"   >drwxr-xr-x 4 citusdb citusdb 4.0K Mar 15 07:54 pgxs</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 171K Jan 14 21:05 plpgsql.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 7.1K Jan 14 21:04 utf8_and_ascii.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 224K Jan 14 21:04 utf8_and_big5.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb &nbsp;13K Jan 14 21:04 utf8_and_cyrillic.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 189K Jan 14 21:04 utf8_and_euc2004.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 124K Jan 14 21:04 utf8_and_euc_cn.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 215K Jan 14 21:04 utf8_and_euc_jp.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 136K Jan 14 21:04 utf8_and_euc_kr.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 332K Jan 14 21:04 utf8_and_euc_tw.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 999K Jan 14 21:04 utf8_and_gb18030.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 348K Jan 14 21:04 utf8_and_gbk.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 7.7K Jan 14 21:04 utf8_and_iso8859_1.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb &nbsp;36K Jan 14 21:04 utf8_and_iso8859.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 276K Jan 14 21:04 utf8_and_johab.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 188K Jan 14 21:04 utf8_and_sjis2004.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 128K Jan 14 21:04 utf8_and_sjis.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb 279K Jan 14 21:04 utf8_and_uhc.so</font></div><div><font size="2"   >-rwxr-xr-x 1 citusdb citusdb &nbsp;31K Jan 14 21:04 utf8_and_win.so</font></div><p></p></pre></div><div><br></div><div>3. 初始化主节点以及work节点数据库</div><div>master :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - root</font></div><div><div><font size="2"   >[root@db-172-16-3-150 opt]# mkdir -p /data06/citusdb/master</font></div><div><font size="2"   >[root@db-172-16-3-150 opt]# chown -R citusdb:citusdb /data06/citusdb</font></div></div><div><div><font size="2"   >[root@db-172-16-3-150 opt]# su - citusdb</font></div></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; initdb -D /data06/citusdb/master -E UTF8 --locale=C -U postgres -W</font></div><div><font size="2"   >.. 输入postgres用户密码</font></div></pre></div><div>worker :&nbsp;</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-150 opt]# mkdir -p /data06/citusdb/work01</font></div><div style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-150 opt]# mkdir -p /data06/citusdb/work02</font></div><div style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-150 opt]# mkdir -p /data06/citusdb/work03</font></div><div style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-150 opt]# mkdir -p /data06/citusdb/work04</font></div></div><div><font size="2"   >[root@db-172-16-3-150 opt]# chown -R citusdb:citusdb /data06/citusdb\</font></div><div><span style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-150 opt]# su - citusdb</font></span></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; initdb -D /data06/citusdb/work01 -E UTF8 --locale=C -U postgres -W</font></div><div><span style="line-height: 22px;"   ><font size="2"   >.. 输入postgres用户密码</font></span></div><div><div style="line-height: 22px;"   ><font size="2"   >citusdb@db-172-16-3-150-&gt; initdb -D /data06/citusdb/work02 -E UTF8 --locale=C -U postgres -W</font></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >.. 输入postgres用户密码</font></span></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >citusdb@db-172-16-3-150-&gt; initdb -D /data06/citusdb/work03 -E UTF8 --locale=C -U postgres -W</font></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >.. 输入postgres用户密码</font></span></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >citusdb@db-172-16-3-150-&gt; initdb -D /data06/citusdb/work04 -E UTF8 --locale=C -U postgres -W</font></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >.. 输入postgres用户密码</font></span></div></div></div><p></p></pre></div></div><div><br></div><div>4. 操作系统配置</div><div>配置sysctl.conf</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]#&nbsp;vi /etc/sysctl.conf</font></div><div><div><font size="2"   ># Controls the maximum size of a message, in bytes</font></div><div><font size="2"   >kernel.msgmnb = 65536</font></div><div><font size="2"   ># Controls the default maxmimum size of a mesage queue</font></div><div><font size="2"   >kernel.msgmax = 65536</font></div><div><font size="2"   ># Controls the maximum shared segment size, in bytes</font></div><div><font size="2"   >kernel.shmmax = 68719476736</font></div><div><font size="2"   ># Controls the maximum number of shared memory segments, in pages</font></div><div><font size="2"   >kernel.shmall = 4294967296</font></div><div><font size="2"   >kernel.shmmni = 4096</font></div><div><font size="2"   >kernel.sem = 50100 64128000 50100 1280</font></div><div><font size="2"   >fs.file-max = 7672460</font></div><div><font size="2"   >net.ipv4.ip_local_port_range = 9000 65000</font></div><div><font size="2"   >net.core.rmem_default = 1048576</font></div><div><font size="2"   >net.core.rmem_max = 4194304</font></div><div><font size="2"   >net.core.wmem_default = 262144</font></div><div><font size="2"   >net.core.wmem_max = 1048576</font></div><div><font size="2"   >net.ipv4.tcp_tw_recycle = 1</font></div><div><font size="2"   >net.ipv4.tcp_max_syn_backlog = 4096</font></div><div><font size="2"   >net.core.netdev_max_backlog = 10000</font></div><div><font size="2"   >net.ipv4.ip_conntrack_max = 655360</font></div><div><font size="2"   >fs.aio-max-nr = 1048576</font></div><div><font size="2"   >net.ipv4.tcp_timestamps = 0</font></div><div><font size="2"   >vm.overcommit_memory = 0</font></div></div><div><span style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-150 ~]#&nbsp;sysctl -p</font></span></div><p></p></pre></div><div><span style="line-height: 22px;"   >配置</span><span style="line-height: 22px;"   >/etc/security/limits.conf</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# vi /etc/security/limits.conf</font></div><div><div><font size="2"   >* soft &nbsp; &nbsp;nofile &nbsp;131072</font></div><div><font size="2"   >* hard &nbsp; &nbsp;nofile &nbsp;131072</font></div><div><font size="2"   >* soft &nbsp; &nbsp;nproc &nbsp; 131072</font></div><div><font size="2"   >* hard &nbsp; &nbsp;nproc &nbsp; 131072</font></div><div><font size="2"   >* soft &nbsp; &nbsp;core &nbsp; &nbsp;unlimited</font></div><div><font size="2"   >* hard &nbsp; &nbsp;core &nbsp; &nbsp;unlimited</font></div><div><font size="2"   >* soft &nbsp; &nbsp;memlock 50000000</font></div><div><font size="2"   >* hard &nbsp; &nbsp;memlock 50000000</font></div></div><p></p></pre></div><div># 配置模拟work数据库的IP</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 opt]# ifconfig lo:1 1.1.1.1/32</font></div><div><font size="2"   >[root@db-172-16-3-150 opt]# ifconfig lo:2 1.1.1.2/32</font></div><div><font size="2"   >[root@db-172-16-3-150 opt]# ifconfig lo:3 1.1.1.3/32</font></div><div><font size="2"   >[root@db-172-16-3-150 opt]# ifconfig lo:4 1.1.1.4/32</font></div><div><font size="2"   >[root@db-172-16-3-150 opt]# ip route list table local</font></div><div><font size="2"   >broadcast 127.255.255.255 dev lo &nbsp;proto kernel &nbsp;scope link &nbsp;src 127.0.0.1&nbsp;</font></div><div><font size="2"   >broadcast 172.16.3.255 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.150&nbsp;</font></div><div><font size="2"   >local 1.1.1.2 dev lo &nbsp;proto kernel &nbsp;scope host &nbsp;src 1.1.1.1&nbsp;</font></div><div><font size="2"   >local 1.1.1.3 dev lo &nbsp;proto kernel &nbsp;scope host &nbsp;src 1.1.1.1&nbsp;</font></div><div><font size="2"   >local 1.1.1.1 dev lo &nbsp;proto kernel &nbsp;scope host &nbsp;src 1.1.1.1&nbsp;</font></div><div><font size="2"   >broadcast 172.16.3.0 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.150&nbsp;</font></div><div><font size="2"   >local 1.1.1.4 dev lo &nbsp;proto kernel &nbsp;scope host &nbsp;src 1.1.1.1&nbsp;</font></div><div><font size="2"   >broadcast 127.0.0.0 dev lo &nbsp;proto kernel &nbsp;scope link &nbsp;src 127.0.0.1&nbsp;</font></div><div><font size="2"   >local 172.16.3.150 dev eth0 &nbsp;proto kernel &nbsp;scope host &nbsp;src 172.16.3.150&nbsp;</font></div><div><font size="2"   >local 127.0.0.1 dev lo &nbsp;proto kernel &nbsp;scope host &nbsp;src 127.0.0.1&nbsp;</font></div><div><font size="2"   >local 127.0.0.0/8 dev lo &nbsp;proto kernel &nbsp;scope host &nbsp;src 127.0.0.1</font></div><p></p></pre></div><div># 由于我这里没有使用DNS, 所以需要配置/etc/hosts</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# vi /etc/hosts</font></div><div><div><font size="2"   ># 注意如果没有DNS则需要配置/etc/hosts</font></div><div><font size="2"   >1.1.1.1 &nbsp; &nbsp;work01</font></div><div><font size="2"   >1.1.1.2 &nbsp; &nbsp;work02</font></div><div><font size="2"   >1.1.1.3 &nbsp; &nbsp;work03</font></div><div><font size="2"   >1.1.1.4 &nbsp; &nbsp;work04</font></div></div><p></p></pre></div><div><br></div><div>5. 数据库配置</div><div>master :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >citusdb@db-172-16-3-150-&gt; cd /data06/citusdb/master</font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; vi postgresql.conf</font></div><div><font size="2"   >listen_addresses = '0.0.0.0'</font></div><div><font size="2"   >port = 9900</font></div><div><font size="2"   >unix_socket_directory = '.'</font></div><div><font size="2"   >unix_socket_permissions = 0700</font></div><div><font size="2"   >tcp_keepalives_idle = 60</font></div><div><font size="2"   >tcp_keepalives_interval = 10</font></div><div><font size="2"   >tcp_keepalives_count = 10</font></div><div><font size="2"   >shared_buffers = 2048MB</font></div><div><font size="2"   >maintenance_work_mem = 1024MB</font></div><div><font size="2"   >max_stack_depth = 8MB</font></div><div><font size="2"   >synchronous_commit = off</font></div><div><font size="2"   >wal_buffers = 16384kB</font></div><div><font size="2"   >wal_writer_delay = 10ms</font></div><div><font size="2"   >checkpoint_segments = 32</font></div><div><font size="2"   >random_page_cost = 1.0</font></div><div><font size="2"   >effective_cache_size = 81920MB</font></div><div><font size="2"   >log_destination = 'csvlog'</font></div><div><font size="2"   >logging_collector = on</font></div><div><font size="2"   >log_directory = 'pg_log'</font></div><div><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'</font></div><div><font size="2"   >log_file_mode = 0600</font></div><div><font size="2"   >log_truncate_on_rotation = on</font></div><div><font size="2"   >log_rotation_age = 1d</font></div><div><font size="2"   >log_rotation_size = 10MB</font></div><div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_disconnections = on</font></div></div><div><font size="2"   >log_error_verbosity = verbose</font></div><div><font size="2"   >autovacuum = on</font></div><div><font size="2"   >log_autovacuum_min_duration = 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; vi pg_hba.conf</font></div><div><font size="2"   >host all all 1.1.1.0/8 trust</font></div><div><font size="2"   >host all all 0.0.0.0/0 md5</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; vi pg_worker_list.conf</font></div><div><div><font size="2"   >work01 9901</font></div><div><font size="2"   ><span style="line-height: 22px;"   >work02</span>&nbsp;9902</font></div><div><font size="2"   ><span style="line-height: 22px;"   >work03</span>&nbsp;9903</font></div><div><font size="2"   ><span style="line-height: 22px;"   >work04</span>&nbsp;9904</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >worker :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >citusdb@db-172-16-3-150-&gt;&nbsp;</span><span style="line-height: 22px;"   >vi /data06/citusdb/work01/postgresql.conf</span></font></div><div><span style="line-height: 22px;"   ><font size="2"   >port = 9901</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >其他项同master的配置.</font></span></div><div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >citusdb@db-172-16-3-150-&gt;&nbsp;</span><span style="line-height: 22px;"   >vi /data06/citusdb/work02/postgresql.conf</span></font></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >port = 9902</font></span></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >其他项同master的配置.</font></span></div><div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >citusdb@db-172-16-3-150-&gt;&nbsp;</span><span style="line-height: 22px;"   >vi /data06/citusdb/work03/postgresql.conf</span></font></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >port = 9903</font></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >其他项同master的配置.</font></span></div><div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >citusdb@db-172-16-3-150-&gt;&nbsp;</span><span style="line-height: 22px;"   >vi /data06/citusdb/work04/postgresql.conf</span></font></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >port = 9904</font></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >其他项同master的配置.</font></span></div><div style="line-height: 22px;"   ><font size="2"   ><br></font></div><div><div style="line-height: 22px;"   ><font size="2"   >citusdb@db-172-16-3-150-&gt; vi&nbsp;<span style="line-height: 22px;"   >/data06/citusdb/work01/</span><span style="line-height: 22px;"   >pg_hba.conf</span></font></div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >citusdb@db-172-16-3-150-&gt; vi&nbsp;</span><span style="line-height: 22px;"   >/data06/citusdb/work02/</span><span style="line-height: 22px;"   >pg_hba.conf</span></font></div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >citusdb@db-172-16-3-150-&gt; vi&nbsp;</span><span style="line-height: 22px;"   >/data06/citusdb/work03/</span><span style="line-height: 22px;"   >pg_hba.conf</span></font></div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >citusdb@db-172-16-3-150-&gt; vi&nbsp;</span><span style="line-height: 22px;"   >/data06/citusdb/work04/</span><span style="line-height: 22px;"   >pg_hba.conf</span></font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >host all all 1.1.1.0/32 trust</font></div><div style="line-height: 22px;"   ><font size="2"   >host all all 0.0.0.0/0 md5</font></div></div></div></div></div><p></p></pre></div><div><div style="line-height: 22px;"   ><br></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6. 启动数据库</span></div><div style="line-height: 22px;"   >master :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >citusdb@db-172-16-3-150-&gt; pg_ctl start -D /data06/citusdb/master</font></p></pre></div><div style="line-height: 22px;"   >worker :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >citusdb@db-172-16-3-150-&gt; pg_ctl start -D /data06/citusdb/work01</font></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >citusdb@db-172-16-3-150-&gt; pg_ctl start -D /data06/citusdb/work02</font></span></div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >citusdb@db-172-16-3-150-&gt; pg_ctl start -D /data06/citusdb/</span><span style="line-height: 22px;"   >work03</span></font></div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >citusdb@db-172-16-3-150-&gt; pg_ctl start -D /data06/citusdb/</span><span style="line-height: 22px;"   >work04</span></font></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div></div></div><div>7. 使用</div><div># 连接到主节点, 以及所有work节点, 创建测试数据库, schema</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h&nbsp;<span style="line-height: 22px;"   >127.0.0.1</span>&nbsp;-p 9900 -U postgres postgres</font></div></div><div><span style="line-height: 22px;"   ><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 9901 -U postgres postgres</font></span></div><div><font size="2"   ><span style="line-height: 22px;"   >citusdb@db-172-16-3-150-&gt; psql -h&nbsp;</span><span style="line-height: 22px;"   >127.0.0.1</span><span style="line-height: 22px;"   >&nbsp;-p 9902 -U postgres postgres</span></font></div><div><font size="2"   ><span style="line-height: 22px;"   >citusdb@db-172-16-3-150-&gt; psql -h&nbsp;</span><span style="line-height: 22px;"   >127.0.0.1</span><span style="line-height: 22px;"   >&nbsp;-p 9903 -U postgres postgres</span></font></div><div><font size="2"   ><span style="line-height: 22px;"   >citusdb@db-172-16-3-150-&gt; psql -h&nbsp;</span><span style="line-height: 22px;"   >127.0.0.1</span><span style="line-height: 22px;"   >&nbsp;-p 9904 -U postgres postgres</span></font></div><div><div><font size="2"   >create role digoal nosuperuser login encrypted password 'digoal';</font></div><div><font size="2"   >create database digoal with owner digoal;</font></div><div><font size="2"   >\c digoal digoal</font></div><div><font size="2"   ># 注意目前citusdb对schema的支持有BUG, 会造成无法查询数据, 后面有例子.&nbsp;</font></div><div><font size="2"   >create schema digoal;</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 在主节点创建测试表</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 9900 -U postgres postgres</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><div><font size="2"   >digoal=# \c digoal digoal</font></div><div><font size="2"   >You are now connected to database "digoal" as user "digoal".</font></div></div><div><div><font size="2"   >digoal=&gt; CREATE TABLE customer_reviews &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(</font></div><div><font size="2"   >&nbsp; &nbsp; customer_id TEXT not null,</font></div><div><font size="2"   >&nbsp; &nbsp; review_date DATE not null,</font></div><div><font size="2"   >&nbsp; &nbsp; review_rating INTEGER not null,</font></div><div><font size="2"   >&nbsp; &nbsp; review_votes INTEGER,</font></div><div><font size="2"   >&nbsp; &nbsp; review_helpful_votes INTEGER,</font></div><div><font size="2"   >&nbsp; &nbsp; product_id CHAR(10) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; product_title TEXT not null,</font></div><div><font size="2"   >&nbsp; &nbsp; product_sales_rank BIGINT,</font></div><div><font size="2"   >&nbsp; &nbsp; product_group TEXT,</font></div><div><font size="2"   >&nbsp; &nbsp; product_category TEXT,</font></div><div><font size="2"   >&nbsp; &nbsp; product_subcategory TEXT,</font></div><div><font size="2"   >&nbsp; &nbsp; similar_product_ids CHAR(10)[]</font></div><div><font size="2"   >)</font></div><div><font size="2"   >DISTRIBUTE BY APPEND (review_date);</font></div></div><div><div><font size="2"   >digoal=&gt; CREATE INDEX customer_id_index ON customer_reviews (customer_id);</font></div><div><font size="2"   >CREATE INDEX</font></div></div><p></p></pre></div><div><br></div><div>8.&nbsp;<span style="line-height: 22px;"   >在主节点</span><span style="line-height: 22px;"   >下载测试数据</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >wget http://examples.citusdata.com/customer_reviews_1999.csv.gz</font></div><div><font size="2"   >wget http://examples.citusdata.com/customer_reviews_1998.csv.gz</font></div><div><font size="2"   >gunzip&nbsp;<span style="line-height: 22px;"   >customer_reviews_1998.csv.gz</span></font></div><div><font size="2"   ><span style="line-height: 22px;"   >gunzip&nbsp;</span><span style="line-height: 22px;"   >customer_reviews_1999.csv.gz</span></font></div><p></p></pre></div><div><br></div><div>9.&nbsp;<span style="line-height: 22px;"   >在主节点</span><span style="line-height: 22px;"   >导入数据, 注意目前往citusdb中导入数据必须从work节点使用psql连接到master节点.</span></div><div>导入distributed 表数据用的是SATGE命令, 和COPY命令的语法类似.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.1 -p 9900 digoal postgres</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=#&nbsp;digoal=# \STAGE digoal.customer_reviews FROM '/home/citusdb/customer_reviews_1998.csv' (FORMAT CSV);</font></div></div><div><div><font size="2"   >digoal=# select * from pg_dist_partition ;</font></div><div><font size="2"   >&nbsp;logicalrelid | partmethod | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;partkey &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------+------------+--------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16467 | a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {VAR :varno 1 :varattno 2 :vartype 1082 :vartypmod -1 :varcollid 0 :varlevelsup 0 :varnoold 1 :varoattn</font></div><div><font size="2"   >o 2 :location 428}</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ># 查看主节点数据库中的shard信息</font></div><div><font size="2"   >digoal=# select * from pg_dist_shard;</font></div><div><font size="2"   >&nbsp;logicalrelid | shardid | shardstorage | shardalias | shardminvalue | shardmaxvalue&nbsp;</font></div><div><font size="2"   >--------------+---------+--------------+------------+---------------+---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16467 | &nbsp;102010 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1970-12-30 &nbsp; &nbsp;| 1998-12-31</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from pg_dist_shard_placement;</font></div><div><font size="2"   >&nbsp;shardid | shardstate | shardlength | nodename | nodeport&nbsp;</font></div><div><font size="2"   >---------+------------+-------------+----------+----------</font></div><div><font size="2"   >&nbsp; 102010 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 145932288 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102010 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 145932288 | work04 &nbsp; | &nbsp; &nbsp; 9904</font></div><div><font size="2"   >(2 rows)</font></div></div><p></p></pre></div><div># worker节点中不存储shard信息 &nbsp;:&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_dist_shard;</font></div><div><font size="2"   >&nbsp;logicalrelid | shardid | shardstorage | shardalias | shardminvalue | shardmaxvalue&nbsp;</font></div><div><font size="2"   >--------------+---------+--------------+------------+---------------+---------------</font></div><div><font size="2"   >(0 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from pg_dist_shard_placement;</font></div><div><font size="2"   >&nbsp;shardid | shardstate | shardlength | nodename | nodeport&nbsp;</font></div><div><font size="2"   >---------+------------+-------------+----------+----------</font></div><div><font size="2"   >(0 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from pg_dist_partition ;</font></div><div><font size="2"   >&nbsp;logicalrelid | partmethod | partkey&nbsp;</font></div><div><font size="2"   >--------------+------------+---------</font></div><div><font size="2"   >(0 rows)</font></div><p></p></pre></div><div><br></div><div># 如果不是从worker节点通过psql连接到master节点, 将会报错, 错误信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 172.16.3.150 digoal postgres</font></div><div><font size="2"   >Password for user postgres:&nbsp;</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \STAGE digoal.customer_reviews FROM '/home/citusdb/customer_reviews_1998.csv' (FORMAT CSV);</font></div><div><font size="2"   >remote command "SELECT * FROM master_get_candidate_nodes()" failed with ERROR: &nbsp;could not find worker node for hostname: db-172-16-3-150.sky-mobi.com</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 127.0.0.1 digoal postgres</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \STAGE digoal.customer_reviews FROM '/home/citusdb/customer_reviews_1998.csv' (FORMAT CSV);</font></div><div><font size="2"   >remote command "SELECT * FROM master_get_candidate_nodes()" failed with ERROR: &nbsp;could not find worker node for hostname: localhost.localdomain</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   ># 注释/etc/hosts中对应的主机</font></div><div><div><font size="2"   ># 127.0.0.1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;localhost.localdomain localhost</font></div><div><font size="2"   ># 172.16.3.150 db-172-16-3-150.sky-mobi.com db-172-16-3-150</font></div><div><font size="2"   >1.1.1.1 work01</font></div><div><font size="2"   >1.1.1.2 work02</font></div><div><font size="2"   >1.1.1.3 work03</font></div><div><font size="2"   >1.1.1.4 work04</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 9900 digoal postgres</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \STAGE digoal.customer_reviews FROM '/home/citusdb/customer_reviews_1998.csv' (FORMAT CSV);</font></div><div><font size="2"   >remote command "SELECT * FROM master_get_candidate_nodes()" failed with ERROR: &nbsp;could not find worker node for hostname: localhost</font></div></div><p></p></pre></div><div><br></div><div># 解决以上错误的方法, 注意这句话</div><div><pre class="prettyprint"   ><p><font size="2"   >CitusDB currently requires that you log into one of the worker nodes to stage data, and connect to the master node from the worker node using psql.</font></p></pre></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   ># 例如, 连接1.1.1.1:9900端口, 查看inet_client_addr.</font></span></div><div><div><font size="2"   >digoal=# select inet_client_addr();</font></div><div><font size="2"   >&nbsp;inet_client_addr&nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp;1.1.1.1</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >虽然work,master在同一台主机上, 但是这个场景确实是从work01节点去连master节点的, 为什么呢?</font></div><div><font size="2"   >1. master节点的 /etc/hosts中有1.1.1.1 work01</font></div><div><font size="2"   >2. master的 pg_worker_list.conf中有work01 9901</font></div><div><font size="2"   >3.&nbsp;<span style="line-height: 22px;"   >所以可以执行\STAGE导入数据.</span></font></div><div><font size="2"   >因此多主机的环境中也要满足这种需求才行.</font></div><p></p></pre></div><div>为什么需要从worker节点连到master节点去执行导入数据的动作呢?</div><div>原因参见 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020132192011747/"   >http://blog.163.com/digoal@126/blog/static/16387704020132192011747/</a></div><div><br></div><div># 继续导入另一个文件</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.2 -p 9900 -U postgres digoal</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \STAGE digoal.customer_reviews FROM '/home/citusdb/customer_reviews_1999.csv' (FORMAT CSV);</font></div></div><div><div><font size="2"   >digoal=# select * from pg_dist_partition ;</font></div><div><font size="2"   >&nbsp;logicalrelid | partmethod | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;partkey &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------+------------+--------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16467 | a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {VAR :varno 1 :varattno 2 :vartype 1082 :vartypmod -1 :varcollid 0 :varlevelsup 0 :varnoold 1 :varoattn</font></div><div><font size="2"   >o 2 :location 428}</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from pg_dist_shard;</font></div><div><font size="2"   >&nbsp;logicalrelid | shardid | shardstorage | shardalias | shardminvalue | shardmaxvalue&nbsp;</font></div><div><font size="2"   >--------------+---------+--------------+------------+---------------+---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16467 | &nbsp;102010 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1970-12-30 &nbsp; &nbsp;| 1998-12-31</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16467 | &nbsp;102014 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1999-01-01 &nbsp; &nbsp;| 1999-12-31</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from pg_dist_shard_placement;</font></div><div><font size="2"   >&nbsp;shardid | shardstate | shardlength | nodename | nodeport&nbsp;</font></div><div><font size="2"   >---------+------------+-------------+----------+----------</font></div><div><font size="2"   >&nbsp; 102010 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 145932288 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102010 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 145932288 | work04 &nbsp; | &nbsp; &nbsp; 9904</font></div><div><font size="2"   >&nbsp; 102014 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 286695424 | work02 &nbsp; | &nbsp; &nbsp; 9902</font></div><div><font size="2"   >&nbsp; 102014 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 286695424 | work03 &nbsp; | &nbsp; &nbsp; 9903</font></div><div><font size="2"   >(4 rows)</font></div></div><p></p></pre></div><div><br></div><div>10.&nbsp;<span style="line-height: 22px;"   >在主节点</span><span style="line-height: 22px;"   >查询表数据</span></div><div># 由于目前citusDB对schema支持有问题, 会有如下错误 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \set VERBOSITY verbose</font></div><div><font size="2"   >digoal=# select count(*) from digoal.customer_reviews ;</font></div><div><font size="2"   >WARNING: &nbsp;01000: could not receive query results</font></div><div><font size="2"   >DETAIL: &nbsp;Client result status: PGRES_FATAL_ERROR</font></div><div><font size="2"   >LOCATION: &nbsp;ClientQueryStatus, libpqclientexecutor.c:460</font></div><div><font size="2"   >WARNING: &nbsp;01000: could not receive query results</font></div><div><font size="2"   >DETAIL: &nbsp;Client result status: PGRES_FATAL_ERROR</font></div><div><font size="2"   >LOCATION: &nbsp;ClientQueryStatus, libpqclientexecutor.c:460</font></div><div><font size="2"   >WARNING: &nbsp;01000: could not receive query results</font></div><div><font size="2"   >DETAIL: &nbsp;Client result status: PGRES_FATAL_ERROR</font></div><div><font size="2"   >LOCATION: &nbsp;ClientQueryStatus, libpqclientexecutor.c:460</font></div><div><font size="2"   >WARNING: &nbsp;01000: could not receive query results</font></div><div><font size="2"   >DETAIL: &nbsp;Client result status: PGRES_FATAL_ERROR</font></div><div><font size="2"   >LOCATION: &nbsp;ClientQueryStatus, libpqclientexecutor.c:460</font></div><div><font size="2"   >WARNING: &nbsp;01000: could not receive query results</font></div><div><font size="2"   >DETAIL: &nbsp;Client result status: PGRES_FATAL_ERROR</font></div><div><font size="2"   >LOCATION: &nbsp;ClientQueryStatus, libpqclientexecutor.c:460</font></div><div><font size="2"   >WARNING: &nbsp;01000: could not receive query results</font></div><div><font size="2"   >DETAIL: &nbsp;Client result status: PGRES_FATAL_ERROR</font></div><div><font size="2"   >LOCATION: &nbsp;ClientQueryStatus, libpqclientexecutor.c:460</font></div><div><font size="2"   >ERROR: &nbsp;XX000: failed to execute job 5</font></div><div><font size="2"   >DETAIL: &nbsp;Failure due to failed task 1</font></div><div><font size="2"   >LOCATION: &nbsp;MultiServerExecute, multi_server_executor.c:181</font></div><div><font size="2"   >digoal=# \q</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 目前CitusDB貌似不支持schema</span></div><div># 在public中创建则没有以上问题</div><div># 连接到所有节点, 删除digoal schema</div><div># 在主节点的public下面重新新建表</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# CREATE TABLE customer_reviews &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(</font></div><div><font size="2"   >&nbsp; &nbsp; customer_id TEXT not null,</font></div><div><font size="2"   >&nbsp; &nbsp; review_date DATE not null,</font></div><div><font size="2"   >&nbsp; &nbsp; review_rating INTEGER not null,</font></div><div><font size="2"   >&nbsp; &nbsp; review_votes INTEGER,</font></div><div><font size="2"   >&nbsp; &nbsp; review_helpful_votes INTEGER,</font></div><div><font size="2"   >&nbsp; &nbsp; product_id CHAR(10) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; product_title TEXT not null,</font></div><div><font size="2"   >&nbsp; &nbsp; product_sales_rank BIGINT,</font></div><div><font size="2"   >&nbsp; &nbsp; product_group TEXT,</font></div><div><font size="2"   >&nbsp; &nbsp; product_category TEXT,</font></div><div><font size="2"   >&nbsp; &nbsp; product_subcategory TEXT,</font></div><div><font size="2"   >&nbsp; &nbsp; similar_product_ids CHAR(10)[]</font></div><div><font size="2"   >)</font></div><div><font size="2"   >DISTRIBUTE BY APPEND (review_date);</font></div><div><font size="2"   >digoal=# CREATE INDEX customer_id_index ON customer_reviews (customer_id);</font></div><p></p></pre></div><div># 在任意worker节点通过psql连接到master节点, 导入数据 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \STAGE customer_reviews FROM '/home/citusdb/customer_reviews_1998.csv' (FORMAT CSV);</font></div><div><span style="line-height: 22px;"   ><font size="2"   >digoal=# select count(*) from customer_reviews ;</font></span></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;589859</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# explain analyze verbose select count(*) from customer_reviews ;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;explain statements for distributed queries are currently unsupported</font></div><div><font size="2"   >(1 row)</font></div><div><span style="line-height: 22px;"   ><font size="2"   >digoal=# \STAGE customer_reviews FROM '/home/citusdb/customer_reviews_1999.csv' (FORMAT CSV);</font></span></div><div><font size="2"   >digoal=# select count(*) from customer_reviews ;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1762504</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div># 其他查询测试</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# SELECT</font></div><div><font size="2"   >&nbsp; &nbsp; width_bucket(length(product_title), 1, 50, 5) title_length_bucket,</font></div><div><font size="2"   >&nbsp; &nbsp; round(avg(review_rating), 2) AS review_average,</font></div><div><font size="2"   >&nbsp; &nbsp; count(*)</font></div><div><font size="2"   >FROM</font></div><div><font size="2"   >&nbsp; &nbsp;customer_reviews</font></div><div><font size="2"   >WHERE</font></div><div><font size="2"   >&nbsp; &nbsp; product_group = 'Book'</font></div><div><font size="2"   >GROUP BY</font></div><div><font size="2"   >&nbsp; &nbsp; title_length_bucket</font></div><div><font size="2"   >ORDER BY</font></div><div><font size="2"   >&nbsp; &nbsp; title_length_bucket;</font></div><div><font size="2"   >&nbsp;title_length_bucket | review_average | count &nbsp;</font></div><div><font size="2"   >---------------------+----------------+--------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4.26 | 139034</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4.24 | 411318</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4.34 | 245671</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4.32 | 167361</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4.30 | 118422</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4.40 | 116412</font></div><div><font size="2"   >(6 rows)</font></div></div><div><div><font size="2"   >digoal=# SELECT</font></div><div><font size="2"   >&nbsp; &nbsp; customer_id, review_date, review_rating, product_id, product_title</font></div><div><font size="2"   >FROM &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; customer_reviews</font></div><div><font size="2"   >WHERE</font></div><div><font size="2"   >&nbsp; &nbsp; customer_id ='A27T7HVDXA3K2A' AND</font></div><div><font size="2"   >&nbsp; &nbsp; product_title LIKE '%Dune%' AND</font></div><div><font size="2"   >&nbsp; &nbsp; review_date &gt;= '1998-01-01' AND</font></div><div><font size="2"   >&nbsp; &nbsp; review_date &lt;= '1998-12-31';</font></div><div><font size="2"   >&nbsp; customer_id &nbsp; | review_date | review_rating | product_id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; product_title &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----------------+-------------+---------------+------------+-----------------------------------------------</font></div><div><font size="2"   >&nbsp;A27T7HVDXA3K2A | 1998-04-10 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 | 1559949570 | Dune Audio Collection</font></div><div><font size="2"   >&nbsp;A27T7HVDXA3K2A | 1998-04-10 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 | 0881036366 | Dune (Dune Chronicles (Econo-Clad Hardcover))</font></div><div><font size="2"   >&nbsp;A27T7HVDXA3K2A | 1998-04-10 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 | 0441172717 | Dune (Dune Chronicles, Book 1)</font></div><div><font size="2"   >&nbsp;A27T7HVDXA3K2A | 1998-04-10 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 | 044100590X | Dune</font></div><div><font size="2"   >&nbsp;A27T7HVDXA3K2A | 1998-04-10 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 | 0399128964 | Dune (Dune Chronicles (Econo-Clad Hardcover))</font></div><div><font size="2"   >(5 rows)</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   ><br></span></div>【注意】<div>1. 数据导入注意事项, 导入数据必须从work节点去连接master节点. 否则会报异常.</div><div>2. schema 问题, 目前在CitusDB中使用public以外的schema将会造成查询异常. 所以现在建议使用public.<br><wbr><div>3. CitusDB新增的相关参数见本文参考部分.</div><div><br></div><div>【参考】</div><div>1.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://citusdata.com/docs"   >http://citusdata.com/docs</a></div><div>2.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.citusdata.com/frequently-asked-questions"   >http://www.citusdata.com/frequently-asked-questions</a></div><div>3. postgresql.conf中citusdb相关部分 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ># DISTRIBUTED DATABASE</font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#max_worker_nodes_tracked = 2048 &nbsp; &nbsp; &nbsp; &nbsp;# maximum worker nodes that are tracked</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#shard_replication_factor = 2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # number of replicas to maintain, 多少份拷贝</font></div><div><font size="2"   >#shard_max_size = 2GB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # maximum size a shard will grow, 达到多大后开始shard</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (stored permanently in system catalogs)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#remote_task_check_interval = 100ms &nbsp; &nbsp; # 10-100000 milliseconds between checks</font></div><div><font size="2"   >#task_tracker_active = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# starts up the task tracker process</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >#task_tracker_delay = 200ms &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 10-100000 milliseconds between rounds</font></div><div><font size="2"   >#max_tracked_tasks_per_node = 256 &nbsp; &nbsp; &nbsp; # maximum tasks that are tracked per node</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >#max_running_tasks_per_node = 8 &nbsp; &nbsp; &nbsp; &nbsp; # maximum tasks to run concurrently</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#partition_buffer_size = 8MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# per process repartitioning buffer size</font></div><div><font size="2"   >#large_table_shard_count = 4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# table considered large after this size</font></div><div><font size="2"   >#limit_clause_row_fetch_count = -1 &nbsp; &nbsp; &nbsp;# number of rows to fetch from each task</font></div><div><font size="2"   >#task_assignment_policy = 'greedy' &nbsp; &nbsp; &nbsp;# task assignment policy to use</font></div><p></p></pre></div><div>4. distributed表在主节点的INSERT, UPDATE, DELETE语句不支持.</div></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# update customer_reviews set review_rating=review_rating where customer_id='AE22YDHSBFYIP';</font></div><div><font size="2"   >ERROR: &nbsp;0A000: cannot execute UPDATE on a distributed table on master node</font></div><div><font size="2"   >LOCATION: &nbsp;PreventCommandIfMasterTable, utility.c:360</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# insert into customer_reviews select * from customer_reviews limit 1;</font></div><div><font size="2"   >ERROR: &nbsp;0A000: cannot execute INSERT on a distributed table on master node</font></div><div><font size="2"   >LOCATION: &nbsp;PreventCommandIfMasterTable, utility.c:360</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# delete from customer_reviews ;</font></div><div><font size="2"   >ERROR: &nbsp;0A000: cannot execute DELETE on a distributed table on master node</font></div><div><font size="2"   >LOCATION: &nbsp;PreventCommandIfMasterTable, utility.c:360</font></div></div><p></p></pre></div><div>普通表的DML是支持的 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table test(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into test values (1);</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>