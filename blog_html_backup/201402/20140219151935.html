<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Lua use package.loadlib or require link C code</h2>
	<h5 id="">2014-02-19 15:19:35&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201411925449418/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>Lua支持<span style="line-height: 28px;"   >通过动态链接库</span><span style="line-height: 28px;"   >加载C语言函数. 使用package.loadlib或require.</span></div><div>检查你所运行的环境是否支持.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&gt; print(package.loadlib("a","b"))</font></div><div><font size="2"   >nil &nbsp; &nbsp; a: cannot open shared object file: No such file or directory &nbsp; &nbsp;open</font></div><p></p></pre></div><div>package.loadlib函数输出一个lua匿名函数. 如果加载不成功, 返回nil和错误消息.</div><div>上面的消息表示系统支持加载动态链接库, 只是没找到库文件而已.</div><div>使用例子 :&nbsp;</div><div>创建一个测试C文件, 函数display</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# vi a.c</font></div><div><font size="2"   >#include &lt;stdio.h&gt;</font></div><div><font size="2"   >#include "a.h"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >void display() {</font></div><div><font size="2"   >&nbsp; fprintf(stdout, "this is display function in a.c\n");</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>头文件</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# vi a.h</font></div><div><font size="2"   >void display();</font></div><p></p></pre></div><div>生成动态链接库.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# gcc -O3 -Wall -Wextra -Werror -g -fPIC -c ./a.c -o a.o</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# gcc -O3 -Wall -Wextra -Werror -g -shared a.o -o liba.so</font></div><p></p></pre></div><div>在lua中加载这个动态链接库文件, display函数.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 ~]# lua</font></div></div><div><div><font size="2"   >&gt; file = "/root/liba.so"</font></div><div><font size="2"   >&gt; f = package.loadlib(file, "display") &nbsp;-- 加载动态链接库中的C函数到lua函数</font></div><div><font size="2"   >&gt; print(f)</font></div><div><font size="2"   >function: 0x7f593eb625b0</font></div><div><font size="2"   >&gt; f() &nbsp;-- 直接调用这个lua函数.</font></div><div><font size="2"   >this is display function in a.c</font></div></div><p></p></pre></div></div><div><div><br></div></div>[参考]<wbr><div>1.&nbsp;</div><div><h3 style="font-family: Verdana, Geneva, sans-serif; font-weight: normal; padding-left: 0.5em; border-left-style: solid; border-left-color: rgb(208, 208, 255); border-left-width: 1em; line-height: normal; text-align: justify;"   ><a name="pdf-package.loadlib" rel="nofollow"   >package.loadlib (libname, funcname)</a></h3><p style="font-family: Helvetica, Arial, sans-serif; font-size: medium; line-height: normal; text-align: justify;"   >Dynamically links the host program with the C&nbsp;library&nbsp;<code style="font-size: 12pt;"   >libname</code>.</p><p style="font-family: Helvetica, Arial, sans-serif; font-size: medium; line-height: normal; text-align: justify;"   >If&nbsp;<code style="font-size: 12pt;"   >funcname</code>&nbsp;is "<code style="font-size: 12pt;"   >*</code>", then it only links with the library, making the symbols exported by the library available to other dynamically linked libraries. Otherwise, it looks for a function&nbsp;<code style="font-size: 12pt;"   >funcname</code>inside the library and returns this function as a C&nbsp;function. So,&nbsp;<code style="font-size: 12pt;"   >funcname</code>&nbsp;must follow the&nbsp;<a style="color: rgb(0, 0, 128); background-color: inherit; text-decoration: none;" rel="nofollow" href="http://www.lua.org/manual/5.2/manual.html#lua_CFunction"   ><code style="font-size: 12pt;"   >lua_CFunction</code></a>&nbsp;prototype (see&nbsp;<a style="color: rgb(0, 0, 128); background-color: inherit; text-decoration: none;" rel="nofollow" href="http://www.lua.org/manual/5.2/manual.html#lua_CFunction"   ><code style="font-size: 12pt;"   >lua_CFunction</code></a>).</p><p style="font-family: Helvetica, Arial, sans-serif; font-size: medium; line-height: normal; text-align: justify;"   >This is a low-level function. It completely bypasses the package and module system. Unlike&nbsp;<a style="color: rgb(0, 0, 128); background-color: inherit; text-decoration: none;" rel="nofollow" href="http://www.lua.org/manual/5.2/manual.html#pdf-require"   ><code style="font-size: 12pt;"   >require</code></a>, it does not perform any path searching and does not automatically adds extensions.<code style="font-size: 12pt;"   >libname</code>&nbsp;must be the complete file name of the C&nbsp;library, including if necessary a path and an extension.&nbsp;<code style="font-size: 12pt;"   >funcname</code>&nbsp;must be the exact name exported by the C&nbsp;library (which may depend on the C&nbsp;compiler and linker used).</p><p style="font-family: Helvetica, Arial, sans-serif; font-size: medium; line-height: normal; text-align: justify;"   >This function is not supported by Standard&nbsp;C. As such, it is only available on some platforms (Windows, Linux, Mac OS X, Solaris, BSD, plus other Unix systems that support the&nbsp;<code style="font-size: 12pt;"   >dlfcn</code>standard).</p></div><div>2.&nbsp;</div><div><h3 style="font-family: Verdana, Geneva, sans-serif; font-weight: normal; padding-left: 0.5em; border-left-style: solid; border-left-color: rgb(208, 208, 255); border-left-width: 1em; line-height: normal; text-align: justify;"   ><a style="background-color: rgb(248, 248, 248); padding: 8px; border: 2px solid rgb(160, 160, 160); border-top-left-radius: 8px; border-top-right-radius: 8px; border-bottom-right-radius: 8px; border-bottom-left-radius: 8px;" name="pdf-require" rel="nofollow"   ><code style="font-size: inherit; font-family: inherit;"   >require (modname)</code></a></h3><p style="font-family: Helvetica, Arial, sans-serif; font-size: medium; line-height: normal; text-align: justify;"   >Loads the given module. The function starts by looking into the&nbsp;<a style="color: rgb(0, 0, 128); background-color: inherit; text-decoration: none;" rel="nofollow" href="http://www.lua.org/manual/5.2/manual.html#pdf-package.loaded"   ><code style="font-size: 12pt;"   >package.loaded</code></a>&nbsp;table to determine whether&nbsp;<code style="font-size: 12pt;"   >modname</code>&nbsp;is already loaded. If it is, then&nbsp;<code style="font-size: 12pt;"   >require</code>&nbsp;returns the value stored at<code style="font-size: 12pt;"   >package.loaded[modname]</code>. Otherwise, it tries to find a&nbsp;<em>loader</em>&nbsp;for the module.</p><p style="font-family: Helvetica, Arial, sans-serif; font-size: medium; line-height: normal; text-align: justify;"   >To find a loader,&nbsp;<code style="font-size: 12pt;"   >require</code>&nbsp;is guided by the&nbsp;<a style="color: rgb(0, 0, 128); background-color: inherit; text-decoration: none;" rel="nofollow" href="http://www.lua.org/manual/5.2/manual.html#pdf-package.searchers"   ><code style="font-size: 12pt;"   >package.searchers</code></a>&nbsp;sequence. By changing this sequence, we can change how&nbsp;<code style="font-size: 12pt;"   >require</code>&nbsp;looks for a module. The following explanation is based on the default configuration for&nbsp;<a style="color: rgb(0, 0, 128); background-color: inherit; text-decoration: none;" rel="nofollow" href="http://www.lua.org/manual/5.2/manual.html#pdf-package.searchers"   ><code style="font-size: 12pt;"   >package.searchers</code></a>.</p><p style="font-family: Helvetica, Arial, sans-serif; font-size: medium; line-height: normal; text-align: justify;"   >First&nbsp;<code style="font-size: 12pt;"   >require</code>&nbsp;queries&nbsp;<code style="font-size: 12pt;"   >package.preload[modname]</code>. If it has a value, this value (which should be a function) is the loader. Otherwise&nbsp;<code style="font-size: 12pt;"   >require</code>&nbsp;searches for a Lua loader using the path stored in&nbsp;<a style="color: rgb(0, 0, 128); background-color: inherit; text-decoration: none;" rel="nofollow" href="http://www.lua.org/manual/5.2/manual.html#pdf-package.path"   ><code style="font-size: 12pt;"   >package.path</code></a>. If that also fails, it searches for a C&nbsp;loader using the path stored in&nbsp;<a style="color: rgb(0, 0, 128); background-color: inherit; text-decoration: none;" rel="nofollow" href="http://www.lua.org/manual/5.2/manual.html#pdf-package.cpath"   ><code style="font-size: 12pt;"   >package.cpath</code></a>. If that also fails, it tries an&nbsp;<em>all-in-one</em>&nbsp;loader (see&nbsp;<a style="color: rgb(0, 0, 128); background-color: inherit; text-decoration: none;" rel="nofollow" href="http://www.lua.org/manual/5.2/manual.html#pdf-package.searchers"   ><code style="font-size: 12pt;"   >package.searchers</code></a>).</p><p style="font-family: Helvetica, Arial, sans-serif; font-size: medium; line-height: normal; text-align: justify;"   >Once a loader is found,&nbsp;<code style="font-size: 12pt;"   >require</code>&nbsp;calls the loader with two arguments:&nbsp;<code style="font-size: 12pt;"   >modname</code>&nbsp;and an extra value dependent on how it got the loader. (If the loader came from a file, this extra value is the file name.) If the loader returns any non-nil value,&nbsp;<code style="font-size: 12pt;"   >require</code>&nbsp;assigns the returned value to&nbsp;<code style="font-size: 12pt;"   >package.loaded[modname]</code>. If the loader does not return a non-nil value and has not assigned any value to&nbsp;<code style="font-size: 12pt;"   >package.loaded[modname]</code>, then&nbsp;<code style="font-size: 12pt;"   >require</code>&nbsp;assigns&nbsp;<b>true</b>&nbsp;to this entry. In any case,&nbsp;<code style="font-size: 12pt;"   >require</code>&nbsp;returns the final value of&nbsp;<code style="font-size: 12pt;"   >package.loaded[modname]</code>.</p><p style="font-family: Helvetica, Arial, sans-serif; font-size: medium; line-height: normal; text-align: justify;"   >If there is any error loading or running the module, or if it cannot find any loader for the module, then&nbsp;<code style="font-size: 12pt;"   >require</code>&nbsp;raises an error.</p></div></div>
	</div>
</div>
</body>
</html>