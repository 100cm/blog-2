<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">test luasql's postgresql driver performance (not better than pgbench)</h2>
	<h5 id="">2014-02-21 15:25:59&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201412125644452/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>测试数据库性能的方法很多, 例如使用pgbench, sysbench.</div><div>对PostgreSQL而言, pgbench是性能损失最小的一种测试工具, 本文将使用lua以及luasql驱动测试一下, 我们对比一下使用lua和pgbench测试的结果, 看看lua会带来多少性能损失.</div><div><br></div><div>本文测试环境 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Lua 5.2.3</font></div><div><font size="2"   >CentOS 6.4 x64</font></div><div><font size="2"   >PostgreSQL 9.3.1</font></div><div><font size="2"   >CPU</font></div><div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1596.010</font></div></div><p></p></pre></div><div><br></div><div>使用2号CPU启动lua, 单线程测试.&nbsp;<span style="line-height: 28px;"   >因为0号CPU负面影响太大, 影响测试结果.</span></div><div><div style="line-height: 28px;"   >原因见 :&nbsp;</div><div style="line-height: 28px;"   ><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013102610150692"   >http://blog.163.com/digoal@126/blog/static/1638770402013102610150692</a></div></div><div style="line-height: 28px;"   >测试结果</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 lib]# taskset -c 2 lua</font></div><div><font size="2"   >Lua 5.2.3 &nbsp;Copyright (C) 1994-2013 Lua.org, PUC-Rio</font></div><div><font size="2"   >&gt; luasql = require "luasql.postgres"</font></div><div><font size="2"   >&gt; env = assert(luasql.postgres())</font></div><div><font size="2"   >&gt; con = assert(env:connect("host=/ssd1/pg931/pg_root dbname=digoal user=digoal password=digoal port=1922"))</font></div><div><font size="2"   >&gt; print(con:execute([[select 10]]):fetch())</font></div><div><font size="2"   >10</font></div><div><font size="2"   >&gt; print(con:execute([[select 11]]):fetch())</font></div><div><font size="2"   >11</font></div><div><font size="2"   >&gt; function foo(cnt)&nbsp;</font></div><div><font size="2"   >&gt;&gt; &nbsp;local var1 = os.time()</font></div><div><font size="2"   >&gt;&gt; &nbsp;for i = 1,cnt do</font></div><div><font size="2"   >&gt;&gt; &nbsp; &nbsp;con:execute([[select 10]])</font></div><div><font size="2"   >&gt;&gt; &nbsp;end</font></div><div><font size="2"   >&gt;&gt; &nbsp;return (os.time()-var1)</font></div><div><font size="2"   >&gt;&gt; end</font></div><div><font size="2"   >&gt; print(foo(100))</font></div><div><font size="2"   >0</font></div><div><font size="2"   >&gt; print(foo(100000))</font></div><div><font size="2"   >8</font></div><div><font size="2"   >&gt; print(foo(1000000))</font></div></div><div><font size="2"   >84</font></div><div><div><font size="2"   >&gt; print(1000000/84.0)</font></div><div><font size="2"   >11904.761904762 TPS</font></div></div><p></p></pre></div><div><br></div><div>测试过程中LUA的CPU开销 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;RES &nbsp;SHR S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;P COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;6767 root &nbsp; &nbsp; &nbsp;20 &nbsp; 0 &nbsp;169m 5740 2328 R 21.5 &nbsp;0.0 &nbsp; 0:54.69 2 lua</font></div><p></p></pre></div><div><br></div><div>pg_stat_activity输出, 连接为unix socket.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_stat_activity;</font></div><div><font size="2"   >-[ RECORD 1 ]----+--------------------------------</font></div><div><font size="2"   >datid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 16386</font></div><div><font size="2"   >datname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| digoal</font></div><div><font size="2"   >pid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 6793</font></div><div><font size="2"   >usesysid &nbsp; &nbsp; &nbsp; &nbsp; | 16523</font></div><div><font size="2"   >usename &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| digoal</font></div><div><font size="2"   >application_name |&nbsp;</font></div><div><font size="2"   >client_addr &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >client_hostname &nbsp;|&nbsp;</font></div><div><font size="2"   >client_port &nbsp; &nbsp; &nbsp;| -1</font></div><div><font size="2"   >backend_start &nbsp; &nbsp;| 2014-02-21 14:54:59.29801+08</font></div><div><font size="2"   >xact_start &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >query_start &nbsp; &nbsp; &nbsp;| 2014-02-21 14:57:35.449137+08</font></div><div><font size="2"   >state_change &nbsp; &nbsp; | 2014-02-21 14:57:35.44919+08</font></div><div><font size="2"   >waiting &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f</font></div><div><font size="2"   >state &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| idle</font></div><div><font size="2"   >query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| select 10</font></div><p></p></pre></div><div><br></div><div>同样使用2号CPU, 直接使用pgbench的测试结果 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg931@db-172-16-3-150-&gt; taskset -c 2 pgbench -M prepared -n -r -c 1 -j 1 -T 30 -f ./test.sql -U digoal digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 430052</font></div><div><font size="2"   >tps = 14335.022228 (including connections establishing)</font></div><div><font size="2"   >tps = 14336.394217 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.068411 &nbsp; &nbsp; &nbsp; &nbsp;select 10;</font></div><p></p></pre></div><div>显然使用lua测试只有pgbench测试性能的83%. 损失了17%的性能.</div><div>这个问题显然不是来自循环, 因为循环一亿次差不多也只要1秒.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&gt; function foo(cnt) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;local var1 = os.time()</font></div><div><font size="2"   >&nbsp;for i = 1,cnt do</font></div><div><font size="2"   >&nbsp; &nbsp;-- con:execute([[select 10]])</font></div><div><font size="2"   >&nbsp;end</font></div><div><font size="2"   >&nbsp;return (os.time()-var1)</font></div><div><font size="2"   >end</font></div></div><div><div><font size="2"   >&gt; print(foo(100000000))</font></div><div><font size="2"   >1</font></div></div><p></p></pre></div><div>那么问题出在哪里呢? 经过了解, luasql不支持prepared sql,&nbsp;</div><div><blockquote style="color: rgb(0, 0, 128); font-family: Simsun; font-size: medium; line-height: normal; border-left-color: rgb(85, 85, 238); border-left-style: solid; border-left-width: 0.2em; margin: 0em; padding-left: 0.85em;"   ><pre style="margin: 0em;"   >(Lua SQL still makes me very sad by lacking parameterized queries
though. Yes, it's better than nothing, Which backends can't support a
norrmalized form for the most common statements?
</pre></blockquote><pre style="color: rgb(0, 0, 128); line-height: normal; margin: 0em;"   >	DBMS's are very different in this aspect.

	PostgreSQL [1]:

PREPARE fooplan (int, text, bool, numeric) AS
    INSERT INTO foo VALUES($1, $2, $3, $4);
EXECUTE fooplan(1, 'Hunter Valley', 't', 200.00);

	MySQL [2]:

PREPARE stmt1 FROM 'SELECT SQRT(POW(?,2) + POW(?,2)) AS hypotenuse';
SET @a = 3;
SET @b = 4;
EXECUTE stmt1 USING @a, @b;

	Oracle OCI8 [3]:

INSERT INTO emp VALUES
    (:empno, :ename, :job, :sal, :deptno)

	I think LuaSQL should not define any of these forms, thus exposing
the incompatibilities between the databases.  Anyway, to offer an API
for prepared statements, LuaSQL must define a _standard_ way to declare,
bind the values and execute a prepared statement.  We have discussed that
before, but anyone had time to spend on that front :-(

	Regards,
		Tomás</pre></div><div><tt style="color: rgb(0, 0, 128); line-height: normal;"   >LuaDBI [1] has prepared statements support built into the API. For the&nbsp;</tt><tt style="color: rgb(0, 0, 128); line-height: normal;"   >couple databases I have used in on, it appears to work great for me.</tt><pre style="color: rgb(0, 0, 128); line-height: normal; margin: 0em;"   >-Josh

[1] <a style="color: maroon;" rel="nofollow" href="http://code.google.com/p/luadbi/"   >http://code.google.com/p/luadbi/</a></pre></div><div><br></div><div>使用stap可以跟踪到这个现象</div><div>详见</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013916101117367/"   >http://blog.163.com/digoal@126/blog/static/1638770402013916101117367/</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >stap -e '</font></div><div><font size="2"   >probe process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__start") {</font></div><div><font size="2"   >&nbsp; println(pn(), user_string($arg1), pid())</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__parse__start") {</font></div><div><font size="2"   >&nbsp; println(pn(), user_string($arg1), pid())</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__rewrite__start") {</font></div><div><font size="2"   >&nbsp; println(pn(), user_string($arg1), pid())</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__plan__start") {</font></div><div><font size="2"   >&nbsp; println(pn(), pid())</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__execute__start") {</font></div><div><font size="2"   >&nbsp; println(pn(), pid())</font></div><div><font size="2"   >}'</font></div><p></p></pre></div><div>结果很明显, 没有使用prepared sql.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__start")select 108312</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__parse__start")select 108312</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__rewrite__start")select 108312</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__plan__start")8312</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__execute__start")8312</font></div></div><div><font size="2"   >... 略&nbsp;</font></div><p></p></pre></div><div><br></div><div>那么使用postgresql原生的prepared看看性能会不会有改观 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&gt; con:execute([[prepare p(int) as select $1]])</font></div><div><font size="2"   >&gt; print(con:execute([[execute p(1)]]):fetch())</font></div><div><font size="2"   >1</font></div><div><font size="2"   >&gt; print(con:execute([[execute p(99)]]):fetch())</font></div><div><font size="2"   >99</font></div><div><font size="2"   >&gt; function foo(cnt)&nbsp;</font></div><div><font size="2"   >&nbsp;local var1 = os.time()</font></div><div><font size="2"   >&nbsp;for i = 1,cnt do</font></div><div><font size="2"   >&nbsp; &nbsp;con:execute([[execute p(10)]])&nbsp;</font></div><div><font size="2"   >&nbsp;end</font></div><div><font size="2"   >&nbsp;return (os.time()-var1)</font></div><div><font size="2"   >end</font></div><div><font size="2"   >&gt; print(foo(1000000))</font></div><div><font size="2"   >92</font></div><p></p></pre></div><div>情况并没有好转, 原因是依旧没有使用prepared sql. 那么使用luasql这个驱动和直接使用pgbench测试的性能差异这么明显原因就在这里了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__start")prepare p(int) as select $18312</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__parse__start")prepare p(int) as select $18312</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__rewrite__start")prepare p(int) as select $18312</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__execute__start")8312</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__start")execute p(10)8312</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__parse__start")execute p(10)8312</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__rewrite__start")execute p(10)8312</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__execute__start")8312</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__plan__start")8312</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__execute__start")8312</font></div><div><font size="2"   >... 略</font></div><p></p></pre></div><div>而使用pgbench的-M prepared则显然用了prepared sql.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__parse__start")select 10;8495</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__plan__start")8495</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__execute__start")8495</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__execute__start")8495</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__execute__start")8495</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__execute__start")8495</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__execute__start")8495</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__execute__start")8495</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__execute__start")8495</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__execute__start")8495</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__execute__start")8495</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__execute__start")8495</font></div><div><font size="2"   >process("/home/pg931/pgsql9.3.1/bin/postgres").mark("query__execute__start")8495</font></div></div><div><font size="2"   >... 略</font></div><p></p></pre></div><div><br></div><div>我后面将再测试一下luapgsql, luadbi这几个驱动看看性能如何.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014121115734665/"   >http://blog.163.com/digoal@126/blog/static/1638770402014121115734665/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201341441042613/"   >http://blog.163.com/digoal@126/blog/static/163877040201341441042613/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013102610150692"   >http://blog.163.com/digoal@126/blog/static/1638770402013102610150692</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://lua-users.org/lists/lua-l/2012-01/msg00671.html"   >http://lua-users.org/lists/lua-l/2012-01/msg00671.html</a></div>5.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013916101117367/"   >http://blog.163.com/digoal@126/blog/static/1638770402013916101117367/</a></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">alexsunchenchen - 2014-04-10 23:45:52</h5>
				<div>lua的生态环境比较恶劣，淘宝有个牛人把lua和nginx组合到一起弄了个openresty，里面的PostgreSQL驱动也没实现prepared sql~。</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 alexsunchenchen - 2014-04-10 23:45:52</h5>
				<div style="width:600px;">恩,alex应该对lua比较了解吧,我胡乱看看的相当浅显.</div>
			</div>
	</div>
</div>
</body>
</html>