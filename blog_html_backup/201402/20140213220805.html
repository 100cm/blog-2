<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL string store bug? not enforce check with correct characterSET/encoding</h2>
	<h5 id="">2014-02-13 22:08:05&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020141139372877/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">在PostgreSQL中, 除了sql_ascii字符集编码不检查编码的合法性, 其他字符集都是会检查编码合法性的.<wbr><div>这个在PostgreSQL手册中有明确的说明:</div><div>参考</div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/multibyte.html"   >http://www.postgresql.org/docs/9.3/static/multibyte.html</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201211281407682/"   >http://blog.163.com/digoal@126/blog/static/163877040201211281407682/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020132150381348/"   >http://blog.163.com/digoal@126/blog/static/16387704020132150381348/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402011718112210516/"   >http://blog.163.com/digoal@126/blog/static/1638770402011718112210516/</a></div><div>例如我们数据库服务端使用的是UTF8字符集, 那么在存储的时候, 数据库会检查是否符合UTF8的协定, 如果不符合则会报错.</div><div>例如 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >ERROR: &nbsp;invalid byte sequence for encoding "UTF8": 0xee 0xc1 0x22</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >这样看来不合法的字符应该不会存储到数据库中, 但是最近在做一些数据迁移时发现了这样的问题, 两个数据库在两台服务器上, 操作系统中的LANG一致, 都是UTF8, 数据库的字符集也都是UTF8, 但是数据导出后倒入到另一个库, 有些数据就是报这样的错误, 因此无法正常的迁移某些数据.</span></div><div>从现象上看, 应该是数据库中存储了非法的字符. 那么既然有检查, 又是怎么存储进去的呢?</div><div>我这里使用convert_from这个函数来还原这个现象.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >我们看到, 除了sql_ascii都会进行字符集的转换.</font></div><div><font size="2"   >postgres=# select t,t::bytea from convert_from('\xeec1','gbk') as g(t);</font></div><div><font size="2"   >&nbsp;t &nbsp;| &nbsp; &nbsp;t &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----+----------</font></div><div><font size="2"   >&nbsp;盍 | \xe79b8d</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select t,t::bytea from convert_from('\xeec1','utf8') as g(t);</font></div><div><font size="2"   >ERROR: &nbsp;invalid byte sequence for encoding "UTF8": 0xee 0xc1</font></div><div><font size="2"   >但是使用sql_ascii是如实存储字节流, 不进行任何转换的.</font></div><div><font size="2"   >postgres=# select t,t::bytea from convert_from('\xeec1','sql_ascii') as g(t);</font></div><div><font size="2"   >&nbsp;t | &nbsp; t &nbsp; &nbsp;</font></div><div><font size="2"   >---+--------</font></div><div><font size="2"   >&nbsp; &nbsp;| \xeec1</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >使用这种方法, 可以把非法的字节流存入数据库中.</font></div><div><div><font size="2"   >postgres=# create table test(info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# insert into test values (convert_from('\xeec1','sql_ascii'));</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=# select info,info::bytea from test;</font></div><div><font size="2"   >&nbsp;info | &nbsp;info &nbsp;</font></div><div><font size="2"   >------+--------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; | \xeec1</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>这条记录备份出来的话, 是无法恢复的, 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-192-168-173-55-&gt; pg_dump -t test -a|psql -f -</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >psql:&lt;stdin&gt;:19: ERROR: &nbsp;invalid byte sequence for encoding "UTF8": 0xee 0xc1</font></div><div><font size="2"   >CONTEXT: &nbsp;COPY test, line 1</font></div><p></p></pre></div><div><br></div><div>只能在数据库中直接使用, 例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into test select * from test;</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=# select info,info::bytea from test;</font></div><div><font size="2"   >&nbsp;info | &nbsp;info &nbsp;</font></div><div><font size="2"   >------+--------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; | \xeec1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; | \xeec1</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div><br></div><div>这个问题使得数据的备份还原成为一个麻烦事.</div><div>可能还有其他的方式会把非法的数据存入数据库中, 这就造成了现在的情况.</div><div>如果要跨库导入这些数据, 目前可通过DBLINK或者外部表来导入, 使用备份还原的方式都会发生字符非法的问题.</div><div>原因是COPY命令中使用的是pg_any_to_server来校验编码合法性的, 如果改成存在问题的pg_do_encoding_conversion则可以解决导入非法的报错. 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi&nbsp;src/backend/commands/copy.c</font></div><div><font size="2"   >修改以下代码</font></div><div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cvt =&nbsp;<span style="line-height: 28px;"   >pg_any_to_server</span>(cstate-&gt;line_buf.data,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;cstate-&gt;line_buf.len,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;cstate-&gt;file_encoding);</font></div></div><div><font size="2"   >改成</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cvt = pg_do_encoding_conversion(cstate-&gt;line_buf.data,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;cstate-&gt;line_buf.len,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;GetDatabaseEncoding(), cstate-&gt;file_encoding);</font></div></div><p></p></pre></div><div>编译后重启数据库即可</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >gmake;gmake install</font></div><div><font size="2"   >pg_ctl restart -m fast</font></div><div><font size="2"   >digoal=# copy tbl to '/home/pg931/tbl.txt';</font></div><div><div><font size="2"   >digoal=# truncate tbl;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >digoal=# copy tbl from '/home/pg931/tbl.txt';</font></div><div><font size="2"   >COPY 8</font></div><div><font size="2"   >digoal=# select info,info::bytea from tbl;</font></div><div><font size="2"   >&nbsp;info &nbsp;| &nbsp; &nbsp; info &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------+--------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| \xee</font></div><div><font size="2"   >&nbsp;\x01 &nbsp;| \x01</font></div><div><font size="2"   >&nbsp;hello | \x68656c6c6f</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| \xeec1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| \xee</font></div><div><font size="2"   >&nbsp;\x01 &nbsp;| \x01</font></div><div><font size="2"   >&nbsp;hello | \x68656c6c6f</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| \xeec1</font></div><div><font size="2"   >(8 rows)</font></div></div><p></p></pre></div><div>非法数据可以成功导入. 但是这些非法始终在里面是个不定时炸弹. 建议尽快修复数据. &nbsp;导入成功后把代码改回去编译重启.</div><div><br></div><div>我在pgsql-bug中报告了这个BUG, Tom Lane的回复 :&nbsp;</div><div><pre style="white-space: pre-wrap; word-wrap: break-word; line-height: 23.32400131225586px;"   ><pre class="prettyprint"   ><p><font size="2"   >Hm, yeah.  Normal input to the database goes through pg_any_to_server(),
which will apply a validation step if the source encoding is SQL_ASCII
and the destination encoding is something else.  However, pg_convert and
some other places call pg_do_encoding_conversion() directly, and that
function will just quietly do nothing if either encoding is SQL_ASCII.

The minimum-refactoring solution to this would be to tweak
pg_do_encoding_conversion() so that if the src_encoding is SQL_ASCII but
the dest_encoding isn't, it does pg_verify_mbstr() rather than nothing.

I'm not sure if this would break anything we need to have work,
though.  Thoughts?  Do we want to back-patch such a change?

			regards, tom lane</font></p></pre></pre></div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/message-id/flat/20127.1392324548@sss.pgh.pa.us#20127.1392324548@sss.pgh.pa.us"   >http://www.postgresql.org/message-id/flat/20127.1392324548@sss.pgh.pa.us#20127.1392324548@sss.pgh.pa.us</a></div><div>补丁</div><div><a target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=769065c1b2471f484bb48bb58a8bdcf1d12a419c"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=769065c1b2471f484bb48bb58a8bdcf1d12a419c</a></div><div><br></div><div>因为数据库中存在有两种数据入入函数, 一种是会检查字符集合法性的, 使用pg_any_to_server();</div><div>而另一种函数则使用pg_do_encoding_conversion(), 这个函数只有客户端或者服务端有一方使用sql_ascii编码则不检查编码合法性. tom lane考虑未来通过修改<span style="line-height: 28px;"   >pg_do_encoding_conversion来解决这个校验问题.</span></div><div><span style="line-height: 28px;"   >我这边修改并编译后, 确实可行. 如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi src/backend/utils/mb/mbutils.c</font></div><div><div><font size="2"   >unsigned char *</font></div><div><font size="2"   >pg_do_encoding_conversion(unsigned char *src, int len,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int src_encoding, int dest_encoding)</font></div><div><font size="2"   >{</font></div></div><div><font size="2"   >...</font></div><div><font size="2"   >// 将以下两行改成后面的.</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; // if (src_encoding == PG_SQL_ASCII || dest_encoding == PG_SQL_ASCII)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; // &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return src;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (dest_encoding == PG_SQL_ASCII)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return src;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (src_encoding == PG_SQL_ASCII)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* No conversion is needed, but we must still validate the data.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (void) pg_verify_mbstr(DatabaseEncoding-&gt;encoding, src, len, false);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // return (char *) src;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return src;</font></div></div><p></p></pre></div><div>改完后重新编译, 重启数据库即可.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >gmake</font></div><div><font size="2"   >gmake install</font></div><div><font size="2"   >pg_ctl restart -m fast</font></div><p></p></pre></div><div>这时插入就会报错了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >digoal=# \set VERBOSITY verbose<br>digoal=# insert into tbl select convert_from('\xeec1','sql_ascii');<br>ERROR:  22021: invalid byte sequence for encoding "UTF8": 0xee 0xc1<br>LOCATION:  report_invalid_encoding, wchar.c:2020</span></font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;src/backend/utils/mb/mbutils.c</div><div>2.&nbsp;src/backend/utils/mb/wchar.c</div><div>3.&nbsp;<span style="line-height: 21px; font-size: small;"   >postgres=# \df convert*</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of functions</font></div><div><font size="2"   >&nbsp; &nbsp;Schema &nbsp; | &nbsp; &nbsp; Name &nbsp; &nbsp; | Result data type | Argument data types | &nbsp;Type &nbsp;</font></div><div><font size="2"   >------------+--------------+------------------+---------------------+--------</font></div><div><font size="2"   >&nbsp;pg_catalog | convert &nbsp; &nbsp; &nbsp;| bytea &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| bytea, name, name &nbsp; | normal</font></div><div><font size="2"   >&nbsp;pg_catalog | convert_from | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | bytea, name &nbsp; &nbsp; &nbsp; &nbsp; | normal</font></div><div><font size="2"   >&nbsp;pg_catalog | convert_to &nbsp; | bytea &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| text, name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre>4. 使用python 的unicode函数测试是否为UTF8, 找出非法值.<div><pre style=" color: rgb(51, 51, 51); margin-bottom: 0px; margin-top: 0px; font-family: Consolas, 'Liberation Mono', Courier, monospace; line-height: 18px;box-sizing: border-box;"   ><div id="LC1"   style=" padding-left: 10px;box-sizing: border-box;"   ><pre class="prettyprint"   ><p></p><div id="LC1"   style=" padding-left: 10px;box-sizing: border-box;"   ><span style=" color: rgb(153, 153, 136);box-sizing: border-box; font-style: italic;"   ><font size="2"   >#!/usr/bin/python</font></span></div><div id="LC2"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   ><br style="box-sizing: border-box;"   ></font></div><div id="LC3"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   ><span style=" font-weight: bold;box-sizing: border-box;"   >import</span> <span style=" color: rgb(85, 85, 85);box-sizing: border-box;"   >sys</span></font></div><div id="LC4"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   ><span style=" font-weight: bold;box-sizing: border-box;"   >import</span> <span style=" color: rgb(85, 85, 85);box-sizing: border-box;"   >re</span></font></div><div id="LC5"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   ><br style="box-sizing: border-box;"   ></font></div><div id="LC6"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   ><span style=" font-weight: bold;box-sizing: border-box;"   >def</span> <span style=" color: rgb(153, 0, 0); font-weight: bold;box-sizing: border-box;"   >isUTF8</span><span style="box-sizing: border-box;"   >(</span><span style="box-sizing: border-box;"   >text</span><span style="box-sizing: border-box;"   >):</span></font></div><div id="LC7"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;<span style=" font-weight: bold;box-sizing: border-box;"   >try</span><span style="box-sizing: border-box;"   >:</span></font></div><div id="LC8"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="box-sizing: border-box;"   >text</span> <span style=" font-weight: bold;box-sizing: border-box;"   >=</span> <span style=" color: rgb(0, 134, 179);box-sizing: border-box;"   >unicode</span><span style="box-sizing: border-box;"   >(</span><span style="box-sizing: border-box;"   >text</span><span style="box-sizing: border-box;"   >,</span> <span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >'UTF-8'</span><span style="box-sizing: border-box;"   >,</span> <span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >'strict'</span><span style="box-sizing: border-box;"   >)</span></font></div><div id="LC9"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=" font-weight: bold;box-sizing: border-box;"   >return</span> <span style=" color: rgb(153, 153, 153);box-sizing: border-box;"   >True</span></font></div><div id="LC10"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;<span style=" font-weight: bold;box-sizing: border-box;"   >except</span> <span style=" color: rgb(153, 0, 0); font-weight: bold;box-sizing: border-box;"   >UnicodeDecodeError</span><span style="box-sizing: border-box;"   >:</span></font></div><div id="LC11"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=" font-weight: bold;box-sizing: border-box;"   >return</span> <span style=" color: rgb(153, 153, 153);box-sizing: border-box;"   >False</span></font></div><div id="LC12"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   ><br style="box-sizing: border-box;"   ></font></div><div id="LC13"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   ><span style="box-sizing: border-box;"   >COPY</span> <span style=" font-weight: bold;box-sizing: border-box;"   >=</span> <span style="box-sizing: border-box;"   >re</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >compile</span><span style="box-sizing: border-box;"   >(</span><span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >'^COPY .+ FROM stdin;$'</span><span style="box-sizing: border-box;"   >)</span></font></div><div id="LC14"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   ><span style="box-sizing: border-box;"   >ENDCOPY</span> <span style=" font-weight: bold;box-sizing: border-box;"   >=</span> <span style="box-sizing: border-box;"   >re</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >compile</span><span style="box-sizing: border-box;"   >(</span><span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >'</span><span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >\\</span><span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >\.'</span><span style="box-sizing: border-box;"   >)</span></font></div><div id="LC15"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   ><span style="box-sizing: border-box;"   >SEARCHPATH</span> <span style=" font-weight: bold;box-sizing: border-box;"   >=</span> <span style="box-sizing: border-box;"   >re</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >compile</span><span style="box-sizing: border-box;"   >(</span><span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >'^SET search_path'</span><span style="box-sizing: border-box;"   >)</span></font></div><div id="LC16"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   ><br style="box-sizing: border-box;"   ></font></div><div id="LC17"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   ><span style="box-sizing: border-box;"   >incopy</span> <span style=" font-weight: bold;box-sizing: border-box;"   >=</span> <span style=" color: rgb(0, 153, 153);box-sizing: border-box;"   >0</span></font></div><div id="LC18"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   ><span style="box-sizing: border-box;"   >linenum</span> <span style=" font-weight: bold;box-sizing: border-box;"   >=</span> <span style=" color: rgb(0, 153, 153);box-sizing: border-box;"   >0</span></font></div><div id="LC19"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   ><span style="box-sizing: border-box;"   >copyline</span> <span style=" font-weight: bold;box-sizing: border-box;"   >=</span> <span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >''</span></font></div><div id="LC20"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   ><span style="box-sizing: border-box;"   >badtables</span> <span style=" font-weight: bold;box-sizing: border-box;"   >=</span> <span style="box-sizing: border-box;"   >[]</span></font></div><div id="LC21"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   ><br style="box-sizing: border-box;"   ></font></div><div id="LC22"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   ><span style=" font-weight: bold;box-sizing: border-box;"   >for</span> <span style="box-sizing: border-box;"   >line</span> <span style=" font-weight: bold;box-sizing: border-box;"   >in</span> <span style="box-sizing: border-box;"   >sys</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >stdin</span><span style="box-sizing: border-box;"   >:</span></font></div><div id="LC23"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=" font-weight: bold;box-sizing: border-box;"   >if</span> <span style="box-sizing: border-box;"   >COPY</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >match</span><span style="box-sizing: border-box;"   >(</span><span style="box-sizing: border-box;"   >line</span><span style="box-sizing: border-box;"   >):</span></font></div><div id="LC24"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="box-sizing: border-box;"   >incopy</span> <span style=" font-weight: bold;box-sizing: border-box;"   >=</span> <span style=" color: rgb(0, 153, 153);box-sizing: border-box;"   >1</span></font></div><div id="LC25"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="box-sizing: border-box;"   >copyline</span> <span style=" font-weight: bold;box-sizing: border-box;"   >=</span> <span style="box-sizing: border-box;"   >line</span></font></div><div id="LC26"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   ><br style="box-sizing: border-box;"   ></font></div><div id="LC27"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=" font-weight: bold;box-sizing: border-box;"   >elif</span> <span style="box-sizing: border-box;"   >ENDCOPY</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >match</span><span style="box-sizing: border-box;"   >(</span><span style="box-sizing: border-box;"   >line</span><span style="box-sizing: border-box;"   >):</span></font></div><div id="LC28"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=" font-weight: bold;box-sizing: border-box;"   >if</span> <span style="box-sizing: border-box;"   >linenum</span> <span style=" font-weight: bold;box-sizing: border-box;"   >&gt;</span> <span style=" color: rgb(0, 153, 153);box-sizing: border-box;"   >0</span><span style="box-sizing: border-box;"   >:</span></font></div><div id="LC29"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="box-sizing: border-box;"   >sys</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >stdout</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >write</span><span style="box-sizing: border-box;"   >(</span><span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >"\.</span><span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >\n\n</span><span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >"</span><span style="box-sizing: border-box;"   >)</span></font></div><div id="LC30"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="box-sizing: border-box;"   >linenum</span> <span style=" font-weight: bold;box-sizing: border-box;"   >=</span> <span style=" color: rgb(0, 153, 153);box-sizing: border-box;"   >0</span></font></div><div id="LC31"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="box-sizing: border-box;"   >incopy</span> <span style=" font-weight: bold;box-sizing: border-box;"   >=</span> <span style=" color: rgb(0, 153, 153);box-sizing: border-box;"   >0</span></font></div><div id="LC32"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   ><br style="box-sizing: border-box;"   ></font></div><div id="LC33"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=" font-weight: bold;box-sizing: border-box;"   >elif</span> <span style="box-sizing: border-box;"   >SEARCHPATH</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >match</span><span style="box-sizing: border-box;"   >(</span><span style="box-sizing: border-box;"   >line</span><span style="box-sizing: border-box;"   >):</span></font></div><div id="LC34"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="box-sizing: border-box;"   >searchpath</span> <span style=" font-weight: bold;box-sizing: border-box;"   >=</span> <span style="box-sizing: border-box;"   >line</span></font></div><div id="LC35"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font></div><div id="LC36"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=" font-weight: bold;box-sizing: border-box;"   >if</span> <span style=" font-weight: bold;box-sizing: border-box;"   >not</span> <span style="box-sizing: border-box;"   >isUTF8</span><span style="box-sizing: border-box;"   >(</span><span style="box-sizing: border-box;"   >line</span><span style="box-sizing: border-box;"   >):</span></font></div><div id="LC37"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="box-sizing: border-box;"   >linenum</span> <span style=" font-weight: bold;box-sizing: border-box;"   >+=</span> <span style=" color: rgb(0, 153, 153);box-sizing: border-box;"   >1</span></font></div><div id="LC38"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=" font-weight: bold;box-sizing: border-box;"   >if</span> <span style="box-sizing: border-box;"   >linenum</span> <span style=" font-weight: bold;box-sizing: border-box;"   >==</span> <span style=" color: rgb(0, 153, 153);box-sizing: border-box;"   >1</span><span style="box-sizing: border-box;"   >:</span></font></div><div id="LC39"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="box-sizing: border-box;"   >sys</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >stdout</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >write</span><span style="box-sizing: border-box;"   >(</span><span style="box-sizing: border-box;"   >searchpath</span><span style="box-sizing: border-box;"   >)</span></font></div><div id="LC40"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="box-sizing: border-box;"   >sys</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >stdout</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >write</span><span style="box-sizing: border-box;"   >(</span><span style="box-sizing: border-box;"   >copyline</span><span style="box-sizing: border-box;"   >)</span></font></div><div id="LC41"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="box-sizing: border-box;"   >schema</span> <span style=" font-weight: bold;box-sizing: border-box;"   >=</span> <span style="box-sizing: border-box;"   >re</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >sub</span><span style="box-sizing: border-box;"   >(</span><span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >r'SET search_path = (.*), .*$'</span><span style="box-sizing: border-box;"   >,</span> <span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >r'\1'</span><span style="box-sizing: border-box;"   >,</span> <span style="box-sizing: border-box;"   >searchpath</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >replace</span><span style="box-sizing: border-box;"   >(</span><span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >'</span><span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >\n</span><span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >'</span><span style="box-sizing: border-box;"   >,</span> <span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >''</span><span style="box-sizing: border-box;"   >)</span> <span style="box-sizing: border-box;"   >)</span></font></div><div id="LC42"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="box-sizing: border-box;"   >table</span> <span style=" font-weight: bold;box-sizing: border-box;"   >=</span> <span style="box-sizing: border-box;"   >re</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >sub</span><span style="box-sizing: border-box;"   >(</span><span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >r'^COPY ("?[\w/_-]+"?) .+ FROM stdin;$'</span><span style="box-sizing: border-box;"   >,</span> <span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >r'\1'</span><span style="box-sizing: border-box;"   >,</span> <span style="box-sizing: border-box;"   >copyline</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >replace</span><span style="box-sizing: border-box;"   >(</span><span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >'</span><span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >\n</span><span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >'</span><span style="box-sizing: border-box;"   >,</span> <span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >''</span><span style="box-sizing: border-box;"   >)</span> <span style="box-sizing: border-box;"   >)</span></font></div><div id="LC43"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="box-sizing: border-box;"   >fqtable</span> <span style=" font-weight: bold;box-sizing: border-box;"   >=</span> <span style="box-sizing: border-box;"   >schema</span> <span style=" font-weight: bold;box-sizing: border-box;"   >+</span> <span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >'.'</span> <span style=" font-weight: bold;box-sizing: border-box;"   >+</span> <span style="box-sizing: border-box;"   >table</span></font></div><div id="LC44"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="box-sizing: border-box;"   >badtables</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >append</span><span style="box-sizing: border-box;"   >(</span><span style="box-sizing: border-box;"   >fqtable</span><span style="box-sizing: border-box;"   >)</span></font></div><div id="LC45"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="box-sizing: border-box;"   >sys</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >stdout</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >write</span><span style="box-sizing: border-box;"   >(</span><span style="box-sizing: border-box;"   >line</span><span style="box-sizing: border-box;"   >)</span></font></div><div id="LC46"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   ><br style="box-sizing: border-box;"   ></font></div><div id="LC47"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   ><span style="box-sizing: border-box;"   >sys</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >stderr</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >write</span><span style="box-sizing: border-box;"   >(</span><span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >"pg_dump --schema-only"</span><span style="box-sizing: border-box;"   >)</span></font></div><div id="LC48"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   ><span style=" font-weight: bold;box-sizing: border-box;"   >for</span> <span style="box-sizing: border-box;"   >mytable</span> <span style=" font-weight: bold;box-sizing: border-box;"   >in</span> <span style="box-sizing: border-box;"   >badtables</span><span style="box-sizing: border-box;"   >:</span></font></div><div id="LC49"   style=" padding-left: 10px;box-sizing: border-box;"   ><font size="2"   >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="box-sizing: border-box;"   >sys</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >stderr</span><span style=" font-weight: bold;box-sizing: border-box;"   >.</span><span style="box-sizing: border-box;"   >write</span><span style="box-sizing: border-box;"   >(</span><span style=" color: rgb(221, 17, 68);box-sizing: border-box;"   >" --table "</span> <span style=" font-weight: bold;box-sizing: border-box;"   >+</span> <span style="box-sizing: border-box;"   >mytable</span><span style="box-sizing: border-box;"   >)</span></font></div><p></p></pre></div></pre></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">Cutis_Dow - 2015-01-30 14:51:18</h5>
				<div>我安装的pg是.run文件，没有源码。安装了集群后相当于集群完全接管了数据库，我可否在postgres-xl的源码里修改copy.c实现你上面所说的。另外你说<span style=""  >pg_do_encoding_conversion存在问题，请问这个命令有哪些问题，因为集群是线上的，每次修改重启成本很大，需要慎重考虑</span></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 Cutis_Dow - 2015-01-30 14:51:18</h5>
				<div style="width:600px;">HI,有些情况下是可以将非法字符存入的,但是取出来再存储进去走COPY协议的话,是需要检测的,所以遇到已经录入的非法字符要导入的话,可以通过禁用检测的方式入库.</div>
			</div>
			<div id="">
				<h5 id="">byfei163 - 2014-02-17 10:22:48</h5>
				<div><P>pg9.2.4 hot standby 遭遇"WAL contains references to invalid pages"碰到过没</P>
<P>2014-02-17 01:11:53.428 GMT,,,27597,,53015278.6bcd,7,,2014-02-17 00:06:16 GMT,1/0,0,WARNING,01000,"page 2285 of relation pg_tblspc/16385/PG_9.2_201204301/12788/76024 is uninitialized",,,,,"xlog redo delete: index 16385/12788/76033; iblk 387, heap 16385/12788/76024;",,,,""<BR>2014-02-17 01:11:53.428 GMT,,,27597,,53015278.6bcd,8,,2014-02-17 00:06:16 GMT,1/0,0,PANIC,XX000,"WAL contains references to invalid pages",,,,,"xlog redo delete: index 16385/12788/76033; iblk 387, heap 16385/12788/76024;",,,,""<BR>2014-02-17 01:11:53.870 GMT,,,27595,,53015277.6bcb,2,,2014-02-17 00:06:15 GMT,,0,LOG,00000,"startup process (PID 27597) was terminated by signal 6: Aborted",,,,,,,,,""<BR>2014-02-17 01:11:53.870 GMT,,,27595,,53015277.6bcb,3,,2014-02-17 00:06:15 GMT,,0,LOG,00000,"terminating any other active server processes",,,,,,,,,""<BR></P></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 byfei163 - 2014-02-17 10:22:48</h5>
				<div style="width:600px;">你可能关闭了full_page_writes, 数据库或系统异常崩溃后DATA FILE和WAL记录的片段不一致. 你这个案例应该是索引页在checkpoint后未flush到disk, 而wal已经记录了对应页的变更.</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">byfei163 回复 德哥@Digoal - 2014-02-17 10:22:48</h5>
				<div style="width:600px;">恩，非常感谢你的回复，full_page_writes=on，关闭的时候先stop smart，关闭不了后才-m fast</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 byfei163 - 2014-02-17 10:22:48</h5>
				<div style="width:600px;">-m fast停库不需要recovery.</div>
			</div>
	</div>
</div>
</body>
</html>