<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 pg_stat_activity pg_stat_replication add backend's running xid & min running xid in database cluster.</h2>
	<h5 id="">2014-02-26 8:32:01&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020141268229344/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><span style="font-family: verdana, sans-serif; font-size: 12px; font-weight: bold; line-height: 18.239999771118164px;"   >Table 27-2.&nbsp;</span><tt style="font-size: 12px; font-weight: bold; line-height: 18.239999771118164px;"   >pg_stat_activity</tt><span style="font-family: verdana, sans-serif; font-size: 12px; font-weight: bold; line-height: 18.239999771118164px;"   >&nbsp;View</span><br><wbr><div><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; background-color: rgb(224, 236, 239); border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"   ><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>backend_xid</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>xid</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Toplevel transaction identifier of this backend, if any.</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>backend_xmin</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>xid</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >The current backend's&nbsp;<tt>xmin</tt>&nbsp;horizon.</td></tr></table></div><div><span style="font-family: verdana, sans-serif; font-size: 12px; font-weight: bold; line-height: 18.239999771118164px;"   >Table 27-12.&nbsp;</span><tt style="font-size: 12px; font-weight: bold; line-height: 18.239999771118164px;"   >pg_stat_replication</tt><span style="font-family: verdana, sans-serif; font-size: 12px; font-weight: bold; line-height: 18.239999771118164px;"   >&nbsp;View</span></div><div><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; background-color: rgb(224, 236, 239); border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"   ><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>backend_xmin</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>xid</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >This standby's&nbsp;<tt>xmin</tt>&nbsp;horizon reported by&nbsp;<a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/runtime-config-replication.html#GUC-HOT-STANDBY-FEEDBACK"   >hot_standby</a>.</td></tr></table></div><div>backend_xid指该backend正在运行的事务xid.</div><div>backend_xmin指当前数据库集群正在运行的最小的事务xid.</div><div><br></div><div>这个补丁的对应地址 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=dd1a3bccca241a998b4ebf39d67202698e5fa599"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=dd1a3bccca241a998b4ebf39d67202698e5fa599</a></div><div>例如 :&nbsp;</div><div>当前数据库中有两个未结束的事务, 事务号分别是1813和1816. 在以往我们可以通过txid_current_snapshot来获取这个信息.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from txid_current_snapshot();</font></div><div><font size="2"   >&nbsp;txid_current_snapshot&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;1813:1818:1813,1816</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>现在我们可以通过pg_stat_activity这个视图获取到这些在执行的事务对应的backend.</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >digoal=# select pid,backend_xmin,backend_xid from pg_stat_activity ;</font></span></div><div><font size="2"   >&nbsp; pid &nbsp;| backend_xmin | backend_xid&nbsp;</font></div><div><font size="2"   >-------+--------------+-------------</font></div><div><font size="2"   >&nbsp;21534 | &nbsp; &nbsp; &nbsp; &nbsp; 1813 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;21373 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;1813</font></div><div><font size="2"   >&nbsp;21428 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;1816</font></div><div><font size="2"   >&nbsp;21516 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div><div>1813则是数据库集群未结束的最小事务号.</div><div><br></div><div>[参考]</div><div>1.&nbsp;src/include/storage/proc.h</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* Prior to PostgreSQL 9.2, the fields below were stored as part of the</font></div><div><font size="2"   >&nbsp;* PGPROC. &nbsp; &nbsp; &nbsp;However, benchmarking revealed that packing these particular</font></div><div><font size="2"   >&nbsp;* members into a separate array as tightly as possible sped up GetSnapshotData</font></div><div><font size="2"   >&nbsp;* considerably on systems with many CPU cores, by reducing the number of</font></div><div><font size="2"   >&nbsp;* cache lines needing to be fetched. &nbsp;Thus, think very carefully before adding</font></div><div><font size="2"   >&nbsp;* anything else here.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >typedef struct PGXACT</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TransactionId xid; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* id of top-level transaction currently being</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* executed by this proc, if running and XID</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* is assigned; else InvalidTransactionId */</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TransactionId xmin; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* minimal running XID as it was when we were</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* starting our xact, excluding LAZY VACUUM:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* vacuum must not remove tuples deleted by</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* xid &gt;= xmin ! */</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; uint8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vacuumFlags; &nbsp; &nbsp;/* vacuum-related flags, see above */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bool &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;overflowed;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bool &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;delayChkpt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* true if this proc delays checkpoint start;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* previously called InCommit */</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; uint8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nxids;</font></div><div><font size="2"   >} PGXACT;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* There is one ProcGlobal struct for the whole database cluster.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >typedef struct PROC_HDR</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Array of PGPROC structures (not including dummies for prepared txns) */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PGPROC &nbsp; &nbsp; *allProcs;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Array of PGXACT structures (not including dummies for prepared txns) */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PGXACT &nbsp; &nbsp; *allPgXact;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Length of allProcs array */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; uint32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;allProcCount;</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Head of list of free PGPROC structures */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PGPROC &nbsp; &nbsp; *freeProcs;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Head of list of autovacuum's free PGPROC structures */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PGPROC &nbsp; &nbsp; *autovacFreeProcs;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Head of list of bgworker free PGPROC structures */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PGPROC &nbsp; &nbsp; *bgworkerFreeProcs;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* WALWriter process's latch */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Latch &nbsp; &nbsp; &nbsp;*walwriterLatch;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Checkpointer process's latch */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Latch &nbsp; &nbsp; &nbsp;*checkpointerLatch;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Current shared estimate of appropriate spins_per_delay value */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; spins_per_delay;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* The proc of the Startup process, since not in ProcArray */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PGPROC &nbsp; &nbsp; *startupProc;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; startupProcPid;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Buffer id of the buffer that Startup process waits for pin on, or -1 */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; startupBufferPinWaitBufId;</font></div><div><font size="2"   >} PROC_HDR;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >extern PROC_HDR *ProcGlobal;</font></div></div><p></p></pre></div><div><br></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/monitoring-stats.html#MONITORING-STATS-VIEWS"   >http://www.postgresql.org/docs/devel/static/monitoring-stats.html#MONITORING-STATS-VIEWS</a></div><div><br></div><div><br></div><div>3.&nbsp;src/backend/storage/ipc/sinvaladt.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >+ * BackendIdGetTransactionIds</font></div><div><font size="2"   >+ * &nbsp; &nbsp; Get the xid and xmin of the backend. The result may be out of date</font></div><div><font size="2"   >+ * &nbsp; &nbsp; arbitrarily quickly, so the caller must be careful about how this</font></div><div><font size="2"   >+ * &nbsp; &nbsp; information is used.</font></div><div><font size="2"   >+ */</font></div><div><font size="2"   >+void</font></div><div><font size="2"   >+BackendIdGetTransactionIds(int backendID, TransactionId *xid, TransactionId *xmin)</font></div><div><font size="2"   >+{</font></div><div><font size="2"   >+ &nbsp; ProcState &nbsp;*stateP;</font></div><div><font size="2"   >+ &nbsp; SISeg &nbsp; &nbsp; &nbsp;*segP = shmInvalBuffer;</font></div><div><font size="2"   >+ &nbsp; PGXACT &nbsp; &nbsp; *xact;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; *xid = InvalidTransactionId;</font></div><div><font size="2"   >+ &nbsp; *xmin = InvalidTransactionId;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; /* Need to lock out additions/removals of backends */</font></div><div><font size="2"   >+ &nbsp; LWLockAcquire(SInvalWriteLock, LW_SHARED);</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; if (backendID &gt; 0 &amp;&amp; backendID &lt;= segP-&gt;lastBackend)</font></div><div><font size="2"   >+ &nbsp; {</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; stateP = &amp;segP-&gt;procState[backendID - 1];</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; xact = &amp;ProcGlobal-&gt;allPgXact[stateP-&gt;proc-&gt;pgprocno];</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; *xid = xact-&gt;xid;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; *xmin = xact-&gt;xmin;</font></div><div><font size="2"   >+ &nbsp; }</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; LWLockRelease(SInvalWriteLock);</font></div><div><font size="2"   >+}</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>