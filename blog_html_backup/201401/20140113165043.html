<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL modify pg_authid's rolname and rolpassword simulate "ALTER ROLE rename to"</h2>
	<h5 id="">2014-01-13 16:50:43&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201401344210399/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">PostgreSQL 的角色名不能使用SQL语句来修改, 因为它没有修改角色名的语法.<wbr><div><pre class="prettyprint"   ><p></p><div><font size="2"   >实际上用户的角色信息是存储在pg_authid这个信息表里面的.</font></div><div><div><font size="2"   >postgres=# \d pg_authid</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Table "pg_catalog.pg_authid"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;Column &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >----------------+--------------------------+-----------</font></div><div><font size="2"   >&nbsp;rolname &nbsp; &nbsp; &nbsp; &nbsp;| name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;rolsuper &nbsp; &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;rolinherit &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;rolcreaterole &nbsp;| boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;rolcreatedb &nbsp; &nbsp;| boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;rolcatupdate &nbsp; | boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;rolcanlogin &nbsp; &nbsp;| boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;rolreplication | boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;rolconnlimit &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;rolpassword &nbsp; &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;rolvaliduntil &nbsp;| timestamp with time zone |&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_authid_oid_index" UNIQUE, btree (oid), tablespace "pg_global"</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_authid_rolname_index" UNIQUE, btree (rolname), tablespace "pg_global"</font></div><div><font size="2"   >Tablespace: "pg_global"</font></div></div><p></p></pre></div><div>通过修改这个系统表的数据, 就可以达到修改用户名的目的.</div><div>这里还设计密码的修改, 因为md5码是密码和用户名的组合字符串的md5值. 所以用户名修改后, 存储的密码md5值也要修改, 否则是无法验证通过的.</div><div>实际例子 :&nbsp;</div><div>创建一个名为TEST的 角色, 数据库中区分大小写.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create role "TEST" login encrypted password '123';</font></div><div><font size="2"   >CREATE ROLE</font></div><p></p></pre></div><div>查询这个角色对应的pg_authid中的信息.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_authid where rolname='TEST';</font></div><div><font size="2"   >-[ RECORD 1 ]--+------------------------------------</font></div><div><font size="2"   >rolname &nbsp; &nbsp; &nbsp; &nbsp;| TEST</font></div><div><font size="2"   >rolsuper &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >rolinherit &nbsp; &nbsp; | t</font></div><div><font size="2"   >rolcreaterole &nbsp;| f</font></div><div><font size="2"   >rolcreatedb &nbsp; &nbsp;| f</font></div><div><font size="2"   >rolcatupdate &nbsp; | f</font></div><div><font size="2"   >rolcanlogin &nbsp; &nbsp;| t</font></div><div><font size="2"   >rolreplication | f</font></div><div><font size="2"   >rolconnlimit &nbsp; | -1</font></div><div><font size="2"   >rolpassword &nbsp; &nbsp;| md5d672445f6a09456ec3e8df468fb34d3b</font></div><div><font size="2"   >rolvaliduntil &nbsp;|&nbsp;</font></div><p></p></pre></div><div>登录测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-33-&gt; psql -h 172.16.3.150 -p 1921 -U TEST postgres</font></div><div><font size="2"   >Password for user TEST: 输入密码123</font></div><div><font size="2"   >psql (9.3.2, server 9.3.1)</font></div><div><font size="2"   >SSL connection (cipher: DHE-RSA-AES256-SHA, bits: 256)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=&gt;&nbsp;</font></div><p></p></pre></div><div><br></div><div>如果要把用户改成其他名字, 修改pg_authid的两个字段, rolname和rolpassword.</div><div>例如我要把用户名从 TEST改成hello, 密码保持123不变.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >先要算出123和hello的组合md5值, 用于更新pg_authid.rolpassword</font></div><div><div><font size="2"   >digoal=# select md5('123hello');</font></div><div><font size="2"   >-[ RECORD 1 ]-------------------------</font></div><div><font size="2"   >md5 | 86fcb4c0551ea48ede7df5ed9626eee7</font></div></div><div><font size="2"   >更新pg_authid.</font></div><div><div><font size="2"   >digoal=# update pg_authid set rolname='hello', rolpassword='md586fcb4c0551ea48ede7df5ed9626eee7' where rolname='TEST';</font></div><div><font size="2"   >UPDATE 1</font></div></div><p></p></pre></div><div>更新后查看用户信息是hello了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; \du</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of roles</font></div><div><font size="2"   >&nbsp; &nbsp; Role name &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Attributes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;Member of &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------+------------------------------------------------+-------------------------</font></div><div><font size="2"   >&nbsp;hello &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {}</font></div><p></p></pre></div><div><br></div><div>使用新老用户进行远程登录测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >使用原来的TEST用户就无法登录了.</font></div><div><div><font size="2"   >postgres@db-172-16-3-33-&gt; psql -h 172.16.3.150 -p 1921 -U TEST postgres</font></div><div><font size="2"   >Password for user TEST:&nbsp;</font></div><div><font size="2"   >psql: FATAL: &nbsp;password authentication failed for user "TEST"</font></div><div><font size="2"   >FATAL: &nbsp;password authentication failed for user "TEST"</font></div></div><div><font size="2"   >使用hello和密码123可以登录.</font></div><div><div><font size="2"   >postgres@db-172-16-3-33-&gt; psql -h 172.16.3.150 -p 1921 -U hello postgres</font></div><div><font size="2"   >Password for user hello:&nbsp;</font></div><div><font size="2"   >psql (9.3.2, server 9.3.1)</font></div><div><font size="2"   >SSL connection (cipher: DHE-RSA-AES256-SHA, bits: 256)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=&gt;&nbsp;</font></div></div><p></p></pre></div><div><br></div><div>注意密码的md5一定也要记得修改, 否则是无法登录的.</div></div>
	</div>
</div>
</body>
</html>