<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Use taskset isolate PostgreSQL CPU resource in Linux</h2>
	<h5 id="">2014-01-21 14:47:41&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020140212301138/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">无意中了解到某测试系统数据库服务器负载到100多, 导致所有这台机器上的其他应用都无法正常使用了.<wbr><div>虽然PostgreSQL是进程模式, 一个连接的服务端进程同一时间最多只会占用一个CPU核的计算资源, 但是如果连接数达到CPU核数的话, 如果都在处理客户端请求的话, 在Linux的调度下可能会占满所有的CPU资源.</div><div>或者在一个操作系统中运行多个业务程序(例如数据库, java进程, 等)的话, 相互之间抢资源的情况就需要考虑如何避免了.</div><div>使用Linux的taskset命令可以很好的解决这个问题.</div><div>我们来做个测试, 测试机是8核的.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-39-&gt; cat /proc/cpuinfo&nbsp;</font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 0</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1596.000</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 1</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 0</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 16</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm syscall nx rdtscp lm constant_tsc nonstop_tsc pni monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr sse4_1 sse4_2 popcnt lahf_lm</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3990.09</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management: [8]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 1</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1596.000</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 0</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 0</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 0</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm syscall nx rdtscp lm constant_tsc nonstop_tsc pni monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr sse4_1 sse4_2 popcnt lahf_lm</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3990.15</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management: [8]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 2</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1596.000</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 1</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 1</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 18</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm syscall nx rdtscp lm constant_tsc nonstop_tsc pni monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr sse4_1 sse4_2 popcnt lahf_lm</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3990.04</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management: [8]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 3</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1596.000</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 0</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 1</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 2</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm syscall nx rdtscp lm constant_tsc nonstop_tsc pni monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr sse4_1 sse4_2 popcnt lahf_lm</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3990.05</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management: [8]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1596.000</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 1</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 2</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 20</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm syscall nx rdtscp lm constant_tsc nonstop_tsc pni monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr sse4_1 sse4_2 popcnt lahf_lm</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3990.06</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management: [8]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 5</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1596.000</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 0</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 2</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm syscall nx rdtscp lm constant_tsc nonstop_tsc pni monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr sse4_1 sse4_2 popcnt lahf_lm</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3990.08</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management: [8]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 6</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1596.000</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 1</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 3</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 22</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm syscall nx rdtscp lm constant_tsc nonstop_tsc pni monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr sse4_1 sse4_2 popcnt lahf_lm</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3990.05</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management: [8]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 7</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1596.000</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 0</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 3</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm syscall nx rdtscp lm constant_tsc nonstop_tsc pni monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr sse4_1 sse4_2 popcnt lahf_lm</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3990.07</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management: [8]</font></div><p></p></pre></div><div><br></div><div>使用taskset的mask限定postgresql只使用第二个核.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-39-&gt; taskset 0x00000002 pg_ctl start</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >启动数据库后,&nbsp;</span></div><div>使用top命令(f, j)可以看到现在所有的服务端进程都只使用1号核.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Tasks: 249 total, &nbsp;11 running, 236 sleeping, &nbsp; 0 stopped, &nbsp; 2 zombie</font></div><div><font size="2"   >Cpu(s): 13.7%us, &nbsp;4.3%sy, &nbsp;0.0%ni, 82.1%id, &nbsp;0.0%wa, &nbsp;0.0%hi, &nbsp;0.0%si, &nbsp;0.0%st</font></div><div><font size="2"   >Mem: &nbsp; 8167400k total, &nbsp;5726764k used, &nbsp;2440636k free, &nbsp; 461632k buffers</font></div><div><font size="2"   >Swap: &nbsp;8385920k total, &nbsp; &nbsp; &nbsp;100k used, &nbsp;8385820k free, &nbsp;4890008k cached</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;RES &nbsp;SHR S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;P COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >16245 postgres &nbsp;15 &nbsp; 0 1178m 3744 3184 S &nbsp;0.0 &nbsp;0.0 &nbsp; 0:00.00 1 postgres: writer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >16246 postgres &nbsp;16 &nbsp; 0 1178m &nbsp;17m &nbsp;16m S &nbsp;6.8 &nbsp;0.2 &nbsp; 0:00.45 1 postgres: wal writer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >16249 postgres &nbsp;16 &nbsp; 0 &nbsp;109m 1688 &nbsp;588 R &nbsp;0.0 &nbsp;0.0 &nbsp; 0:00.00 1 postgres: stats collector process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >16278 postgres &nbsp;17 &nbsp; 0 1179m 3252 1844 S &nbsp;0.0 &nbsp;0.0 &nbsp; 0:00.00 1 postgres: postgres postgres [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >16279 postgres &nbsp;18 &nbsp; 0 1179m 3236 1832 S &nbsp;0.0 &nbsp;0.0 &nbsp; 0:00.00 1 postgres: postgres postgres [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >16281 postgres &nbsp;16 &nbsp; 0 1182m &nbsp;82m &nbsp;80m R &nbsp;0.0 &nbsp;1.0 &nbsp; 0:01.59 1 postgres: postgres postgres [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >16282 postgres &nbsp;18 &nbsp; 0 1179m 3236 1832 S &nbsp;0.0 &nbsp;0.0 &nbsp; 0:00.00 1 postgres: postgres postgres [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >16283 postgres &nbsp;18 &nbsp; 0 1179m 3248 1844 S &nbsp;0.0 &nbsp;0.0 &nbsp; 0:00.00 1 postgres: postgres postgres [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >16284 postgres &nbsp;16 &nbsp; 0 1182m &nbsp;49m &nbsp;47m R &nbsp;0.0 &nbsp;0.6 &nbsp; 0:00.37 1 postgres: postgres postgres [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >16286 postgres &nbsp;18 &nbsp; 0 1179m 3240 1836 S &nbsp;0.0 &nbsp;0.0 &nbsp; 0:00.00 1 postgres: postgres postgres [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >16288 postgres &nbsp;16 &nbsp; 0 1182m &nbsp;81m &nbsp;79m R &nbsp;0.0 &nbsp;1.0 &nbsp; 0:01.49 1 postgres: postgres postgres [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >16295 postgres &nbsp;16 &nbsp; 0 1182m &nbsp;65m &nbsp;64m R &nbsp;0.0 &nbsp;0.8 &nbsp; 0:00.86 1 postgres: postgres postgres [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >16297 postgres &nbsp;25 &nbsp; 0 1179m 3236 1832 S &nbsp;0.0 &nbsp;0.0 &nbsp; 0:00.00 1 postgres: postgres postgres [local] idle</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >现在因为只使用1个CPU核, 所以性能如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-39-&gt; pgbench -M prepared -n -r -f ./login.sql -T 10 -c 16 -j 4</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 47554</font></div><div><font size="2"   >tps = 4719.704404 (including connections establishing)</font></div><div><font size="2"   >tps = 14665.044858 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001787 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 200000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.072017 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_login(:userid);</font></div><p></p></pre></div><div><br></div><div>把mask改掉, 使用1号和2号核心.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-39-&gt; pg_ctl stop -m fast</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div><div><font size="2"   >postgres@db-172-16-3-39-&gt; taskset 0x00000006 pg_ctl start</font></div><p></p></pre></div><div>性能翻倍 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-39-&gt; pgbench -M prepared -n -r -f ./login.sql -T 10 -c 16 -j 4</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 97042</font></div><div><font size="2"   >tps = 9675.651024 (including connections establishing)</font></div><div><font size="2"   >tps = 13064.618447 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001614 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 200000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.211980 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_login(:userid);</font></div><p></p></pre></div><div>使用taskset<span style="line-height: 28px;"   >限定进程的CPU调度</span><span style="line-height: 28px;"   >很好的解决了这个问题.</span></div><div><br></div><div>[参考]</div><div>1. man taskset</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;0x00000001</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; is processor #0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;0x00000003</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; is processors #0 and #1</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;0xFFFFFFFF</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; is all processors (#0 through #31)</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>