<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">pg-amqp extension</h2>
	<h5 id="">2012-01-18 16:06:17&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020120182524830/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>amqp 指的是Advanced Message Queuing Protocol</div><div>有兴趣的朋友可以去它的主页了解一下。</div><div>pg_amqp是一个PostgreSQL的extension, 可以非常方便的使用PostgreSQL 的函数向AMQP发布消息。</div><div>【安装】</div><div>1. 下载&nbsp;</div><div>&nbsp; &nbsp;&nbsp;<a rel="nofollow" href="http://www.pgxn.org/dist/pg_amqp/"  >http://www.pgxn.org/dist/pg_amqp/</a></div><div>2. 解压安装</div><div>unzip pg_amqp-0.3.0.zip</div><div><div>root@db-172-&gt; chown -R postgres:postgres pg_amqp-0.3.0</div><div>root@db-172-&gt; mv pg_amqp-0.3.0 postgresql-9.1.2/contrib/</div></div><div><div>root@db-172-&gt; cd postgresql-9.1.2/contrib/pg_amqp-0.3.0/</div><div>root@db-172-&gt; . /home/postgres/.bash_profile&nbsp;</div></div><div>env LDFLAGS="-lpthread" gmake</div><div>最后一行应该带上-lpthread参数, 例如</div><div>gcc -pthread -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wformat-security -fno-strict-aliasing -fwrapv -fpic -shared -o src/pg_amqp.so src/pg_amqp.o src/librabbitmq/amqp_api.o src/librabbitmq/amqp_connection.o src/librabbitmq/amqp_debug.o src/librabbitmq/amqp_framing.o src/librabbitmq/amqp_mem.o src/librabbitmq/amqp_socket.o src/librabbitmq/amqp_table.o -L/opt/pgsql/lib &nbsp;-Wl,-rpath,'/opt/pgsql/lib',--enable-new-dtags</div><div>如果没有带上这个参数, 可以在gmake install之前把当前目录下的src/pg_amqp.so文件先保留到其他目录, 在gmake install之后去替换$PGHOME/lib/src/pg_amqp.so.</div><div>不替换的话启动PostgreSQL会报错 :&nbsp;FATAL: &nbsp;could not load library "/opt/pgsql/lib/src/pg_amqp.so": /opt/pgsql/lib/src/pg_amqp.so: undefined symbol: pthread_key_create</div><div><br></div><div>env LDFLAGS="-lpthread" gmake install</div><div><br></div><div><span style="line-height: 22px;"  >chown -R postgres:postgres $PGHOME</span></div><div><br></div><div>把pg_amqp.so移到$PGHOME/lib</div><div>mv $PGHOME/lib/src/pg_amqp.so $PGHOME/lib/</div><div><span style="line-height: 22px;"  ><br></span></div><div>3. 配置 postgresql.conf</div><div>shared_preload_libraries = ' <span style="line-height: 22px;"  >pg_amqp</span>'</div><div>4. 重启数据库</div><div>pg_ctl stop -m fast -D $PGDATA</div><div>pg_ctl start -D $PGDATA</div><div><br></div><div>【测试】</div><div>1. 创建extension</div><div><div>postgres@db-172-&gt; psql -h 127.0.0.1 &nbsp;digoal postgres</div><div>psql (9.1.2)</div><div>Type "help" for help.</div><div>digoal=# create extension amqp;</div><div>CREATE EXTENSION</div></div><div># 查看extension sql文件</div><div><div>postgres@db-172-&gt; cd /opt/pgsql/share/extension/</div><div>postgres@db-172-&gt; ll|grep amqp</div><div>-rw-r--r-- 1 postgres postgres 2.3K Jan 18 15:51 amqp--0.3.0.sql</div><div>-rw-r--r-- 1 postgres postgres &nbsp;163 Jan 18 15:51 amqp.control</div><div>-rw-r--r-- 1 postgres postgres &nbsp;566 Jan 18 15:51 amqp--unpackaged--0.3.0.sql</div></div><div><br></div><div><div>less amqp--0.3.0.sql&nbsp;</div><div><br></div><div>create function amqp.exchange_declare(integer, varchar, varchar, boolean, boolean, boolean)</div><div>returns boolean as 'pg_amqp.so', 'pg_amqp_exchange_declare'</div><div>language C immutable;</div><div><br></div><div>comment on function amqp.exchange_declare(integer, varchar, varchar, boolean, boolean, boolean) is</div><div>'Declares a exchange (broker_id, exchange_name, exchange_type, passive, durable, auto_delete)</div><div>auto_delete should be set to false as unexpected errors can cause disconnect/reconnect which</div><div>would trigger the auto deletion of the exchange.';</div><div><br></div><div>create function amqp.publish(integer, varchar, varchar, varchar)</div><div>returns boolean as 'pg_amqp.so', 'pg_amqp_publish'</div><div>language C immutable;</div><div><br></div><div>comment on function amqp.publish(integer, varchar, varchar, varchar) is</div><div>'Publishes a message (broker_id, exchange, routing_key, message). &nbsp;The message will only</div><div>be published if the containing PostgreSQL transaction successfully commits. &nbsp;Under certain</div><div>circumstances, the AMQP commit might fail. &nbsp;In this case, a WARNING is emitted.</div><div><br></div><div>Publish returns a boolean indicating if the publish command was successful. &nbsp;Note that as</div><div>AMQP publish is asynchronous, you may find out later it was unsuccessful.';</div><div><br></div><div>create function amqp.autonomous_publish(integer, varchar, varchar, varchar)</div><div>returns boolean as 'pg_amqp.so', 'pg_amqp_autonomous_publish'</div><div>language C immutable;</div><div><br></div><div>comment on function amqp.autonomous_publish(integer, varchar, varchar, varchar) is</div><div>'Works as amqp.publish does, but the message is published immediately irrespective of the</div><div>current transaction state. &nbsp;PostgreSQL commit and rollback at a later point will have no</div><div>effect on this message being sent to AMQP.';</div><div><br></div><div>create function amqp.disconnect(integer)</div><div>returns void as 'pg_amqp.so', 'pg_amqp_disconnect'</div><div>language C immutable strict;</div><div><br></div><div>comment on function amqp.disconnect(integer) is</div><div>'Explicitly disconnect the specified (broker_id) if it is current connected. Broker</div><div>connections, once established, live until the PostgreSQL backend terminated. &nbsp;This</div><div>allows for more precise control over that.</div><div>select amqp.disconnect(broker_id) from amqp.broker</div><div>will disconnect any brokers that may be connected.';</div><div><br></div><div>create table amqp.broker (</div><div>&nbsp; broker_id serial not null,</div><div>&nbsp; host text not null,</div><div>&nbsp; port integer not null default 5672,</div><div>&nbsp; vhost text,</div><div>&nbsp; username text,</div><div>&nbsp; password text,</div><div>&nbsp; primary key(broker_id, host, port)</div><div>);</div></div><div><br></div><div>函数的comment已经描述得很详细了, 怎么使用就不测试了。</div><div><br></div><div>【用法】</div><div><div>插入AMQP的连接信息到amqp.broker表,格式如下</div><div>Insert AMQP broker information (host/port/user/pass) into the amqp.broker table.</div><div><br></div><div>A process starts and connects to PostgreSQL and runs:</div><div>SELECT amqp.publish(broker_id, 'amqp.direct', 'foo', 'message');</div><div>Upon process termination, all broker connections will be torn down. If there is a need to disconnect from a specific broker, one can call:</div><div><br></div><div>select amqp.disconnect(broker_id);</div><div>which will disconnect from the broker if it is connected and do nothing if it is already disconnected.</div></div><div><br></div>【参考】<wbr><div><a rel="nofollow" href="http://www.amqp.org/"  >http://www.amqp.org</a> </div><div><a rel="nofollow" href="http://api.pgxn.org/src/pg_amqp/pg_amqp-0.3.0/README.md"  >http://api.pgxn.org/src/pg_amqp/pg_amqp-0.3.0/README.md</a> </div></div>
	</div>
</div>
</body>
</html>