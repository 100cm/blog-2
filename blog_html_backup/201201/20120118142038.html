<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">pg-json extension</h2>
	<h5 id="">2012-01-18 14:20:38&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020120182349667/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>【安装】</div><div>pg-json :&nbsp;</div><div>1. 首先要下载并安装jansson.</div><div>&nbsp; &nbsp; 下载地址 :&nbsp;<span style="line-height: normal; text-align: -webkit-auto; white-space: pre-wrap;"   >http://www.digip.org/jansson/</span></div><div><span style="line-height: normal; text-align: -webkit-auto; white-space: pre-wrap;"   >    本例下载2.2.1版本。</span></div><div><span style="text-align: -webkit-auto; white-space: pre-wrap;"   >   $ ./configure    $ make    $ make install</span></div><div>2. 然后到pgxn网站下载pg-json这个extension。</div><div>&nbsp; &nbsp; 下载地址</div><div>&nbsp; &nbsp;&nbsp;<a rel="nofollow" href="http://www.pgxn.org/dist/pg-json/"   >http://www.pgxn.org/dist/pg-json/</a> </div><div>3. 拷贝, jansson 2.2.1 源码文件src目录中的jansson_config.h 和&nbsp;jansson.h到pg-json源码目录中。</div><div>4. 安装pg-json</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; unzip&nbsp;pg-json-0.0.1.zip</font></div><div><font size="2"   >&nbsp; &nbsp; mv pg-json-0.0.1 PostgreSQL9.1.2_src/contrib/</font></div><div><font size="2"   >&nbsp; &nbsp; chown -R postgres:postgres&nbsp;<span style="line-height: 22px;"   >PostgreSQL9.1.2_src</span></font></div><div><span style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; . /home/postgres/.bash_profile</font></span></div><div><font size="2"   ><span style="line-height: 22px;"   >&nbsp; &nbsp; cd&nbsp;</span><span style="line-height: 22px;"   >PostgreSQL9.1.2_src/contrib/pg-json-0.0.1</span></font></div><div><font size="2"   ><span style="line-height: 22px;"   >&nbsp; &nbsp;&nbsp;</span># make USE_PGXS=1</font></div><div><font size="2"   >&nbsp; &nbsp; # make install USE_PGXS=1</font></div><p></p></pre></div><div>5. 进入psql 创建extension :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; psql -h 127.0.0.1 digoal postgres</font></div><div><font size="2"   >&nbsp; &nbsp; psql (9.1.2)</font></div><div><font size="2"   >&nbsp; &nbsp; Type "help" for help.</font></div><div><font size="2"   >&nbsp; &nbsp; digoal=# create extension "pg-json";</font></div><p></p></pre></div><div>6. 查看新增的extension :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_extension ;</font></div><div><font size="2"   >&nbsp;extname | extowner | extnamespace | extrelocatable | extversion | extconfig | extcondition&nbsp;</font></div><div><font size="2"   >---------+----------+--------------+----------------+------------+-----------+--------------</font></div><div><font size="2"   >&nbsp;plpgsql | &nbsp; &nbsp; &nbsp; 10 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1.0 &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;pg-json | &nbsp; &nbsp; &nbsp; 10 | &nbsp; &nbsp; &nbsp; &nbsp; 2200 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 0.0.1 &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>新增了5个函数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \df</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of functions</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; | Result data type | Argument data types &nbsp;| &nbsp;Type &nbsp;</font></div><div><font size="2"   >--------+-----------------+------------------+----------------------+--------</font></div><div><font size="2"   >&nbsp;public | json_equals &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| this json, that json | normal</font></div><div><font size="2"   >&nbsp;public | json_get_value &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | data json, path text | normal</font></div><div><font size="2"   >&nbsp;public | json_in &nbsp; &nbsp; &nbsp; &nbsp; | json &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | cstring &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;public | json_not_equals | boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| this json, that json | normal</font></div><div><font size="2"   >&nbsp;public | json_out &nbsp; &nbsp; &nbsp; &nbsp;| cstring &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| json &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | normal</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div><div>新增了json类型</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# \dT</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;List of data types</font></div><div><font size="2"   >&nbsp;Schema | Name | Description&nbsp;</font></div><div><font size="2"   >--------+------+-------------</font></div><div><font size="2"   >&nbsp;public | json |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><div></div><p></p></pre></div></div><div>查看extension sql &nbsp;：&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-&gt; cd /opt/pgsql/share/extension/</font></div><div><font size="2"   >postgres@db-172-&gt; less pg-json</font></div><div><font size="2"   >pg-json--0.0.1.sql &nbsp;pg-json.control &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >postgres@db-172-&gt; less pg-json--0.0.1.sql&nbsp;</font></div><div><font size="2"   >/*-------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* JSON functions using the Jansson JSON library</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Copyright (c) 2011, Claes Jakobsson, Glue Finance AB</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* This software is licensed under the MIT license. See LICENSE</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;*-------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION json_in(cstring)</font></div><div><font size="2"   >&nbsp; &nbsp; RETURNS json</font></div><div><font size="2"   >&nbsp; &nbsp; AS '$libdir/pg-json'</font></div><div><font size="2"   >&nbsp; &nbsp; LANGUAGE C IMMUTABLE STRICT;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION json_out(json)</font></div><div><font size="2"   >&nbsp; &nbsp; RETURNS cstring</font></div><div><font size="2"   >&nbsp; &nbsp; AS '$libdir/pg-json'</font></div><div><font size="2"   >&nbsp; &nbsp; LANGUAGE C IMMUTABLE STRICT;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION json_get_value(data json, path text)</font></div><div><font size="2"   >&nbsp; &nbsp; RETURNS text</font></div><div><font size="2"   >&nbsp; &nbsp; AS '$libdir/pg-json'</font></div><div><font size="2"   >&nbsp; &nbsp; LANGUAGE C IMMUTABLE STRICT;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION json_equals(this json, that json)</font></div><div><font size="2"   >&nbsp; &nbsp; RETURNS boolean</font></div><div><font size="2"   >&nbsp; &nbsp; AS '$libdir/pg-json'</font></div><div><font size="2"   >&nbsp; &nbsp; LANGUAGE C IMMUTABLE STRICT;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION json_not_equals(this json, that json)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; RETURNS boolean</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; AS '$libdir/pg-json'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LANGUAGE C IMMUTABLE STRICT;</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >CREATE TYPE json (</font></div><div><font size="2"   >&nbsp; &nbsp; INPUT = json_in,</font></div><div><font size="2"   >&nbsp; &nbsp; OUTPUT = json_out</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OPERATOR ~ (</font></div><div><font size="2"   >&nbsp; &nbsp; PROCEDURE = json_get_value,</font></div><div><font size="2"   >&nbsp; &nbsp; LEFTARG = json, RIGHTARG = text</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OPERATOR = (</font></div><div><font size="2"   >&nbsp; &nbsp; PROCEDURE = json_equals,</font></div><div><font size="2"   >&nbsp; &nbsp; LEFTARG = json, RIGHTARG = json,</font></div><div><font size="2"   >&nbsp; &nbsp; COMMUTATOR = =,</font></div><div><font size="2"   >&nbsp; &nbsp; NEGATOR = !=</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OPERATOR != (</font></div><div><font size="2"   >&nbsp; &nbsp; PROCEDURE = json_not_equals,</font></div><div><font size="2"   >&nbsp; &nbsp; LEFTARG = json, RIGHTARG = json,</font></div><div><font size="2"   >&nbsp; &nbsp; COMMUTATOR = !=,</font></div><div><font size="2"   >&nbsp; &nbsp; NEGATOR = =</font></div><div><font size="2"   >);</font></div><p></p></pre></div><div><br></div><div>从SQL文件看出创建extension时新增了5个函数1个类型和3个操作符。</div><div><br></div><div>【测试】 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; create table json_test (id int,info json);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=&gt; insert into json_test values (1,'{"foo":[1,2,3, [3,4,5]]}');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=&gt; select * from json_test ;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----+--------------------------</font></div><div><font size="2"   >&nbsp; 1 | {"foo":[1,2,3, [3,4,5]]}</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; select json_get_value(info,'foo[3][2]'),id from json_test ;</font></div><div><font size="2"   >&nbsp;json_get_value | id&nbsp;</font></div><div><font size="2"   >----------------+----</font></div><div><font size="2"   >&nbsp;5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=&gt; insert into json_test values (2, '{"foo": {"bar": [{}, {}, {"orz": "herp"}]}}');</font></div><div><font size="2"   >INSERT 0 1</font></div></div><div><div><font size="2"   >digoal=&gt; select json_get_value(info,'foo.bar[2].orz'),id from json_test where id=2;</font></div><div><font size="2"   >&nbsp;json_get_value | id&nbsp;</font></div><div><font size="2"   >----------------+----</font></div><div><font size="2"   >&nbsp;herp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;2</font></div></div><div></div><p></p></pre></div></div><div><br></div>【参考】<div><a rel="nofollow" href="http://api.pgxn.org/src/pg-json/pg-json-0.0.1/README"   >http://api.pgxn.org/src/pg-json/pg-json-0.0.1/README</a> </div><div><pre style="line-height: normal; text-align: -webkit-auto; word-wrap: break-word; white-space: pre-wrap;"   ><a target="_blank" rel="nofollow" href="http://www.digip.org/jansson/"   >http://www.digip.org/jansson/</a></pre><br><wbr></div></div>
	</div>
</div>
</body>
</html>