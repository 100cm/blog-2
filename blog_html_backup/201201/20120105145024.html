<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">TOAST table with pgfincore</h2>
	<h5 id="">2012-01-05 14:50:24&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020120524144140/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">pgfincore 可以修改文件的posix_advise属性，输入参数是对象名。如表名，索引名。<wbr><div>注意有些PostgreSQL数据类型的存储如果选择了为extended或者EXTERNAL存储时。实际上这些内容是存储在TOAST表里面。</div><div>例如text 类型.</div><div>下面来看一个例子 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; \d text</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;Table "digoal.text"</font></div><div><font size="2"  >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"  >--------+---------+-----------</font></div><div><font size="2"  >&nbsp;id &nbsp; &nbsp; | integer | not null</font></div><div><font size="2"  >&nbsp;info &nbsp; | text &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >Indexes:</font></div><div><font size="2"  >&nbsp; &nbsp; "text_pkey" PRIMARY KEY, btree (id), tablespace "digoal_idx"</font></div><p></p></pre></div><div>这个表有个toast表, 如下 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select relname from pg_class where oid=(select reltoastrelid from pg_class where relname='text');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;relname &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >------------------</font></div><div><font size="2"  >&nbsp;pg_toast_1293339</font></div><p></p></pre></div><div>还有个toast索引 :&nbsp;</div></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select relname from pg_class where oid=(select reltoastidxid from pg_class where oid=(select reltoastrelid from pg_class where relname='text'));</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >------------------------</font></div><div><font size="2"  >&nbsp;pg_toast_1293339_index</font></div><p></p></pre></div><div>下面我想把text表的posix_fadvise修改一下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; select * from pgfadvise_willneed('text');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relpath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | os_page_size | rel_os_pages | os_pages_free&nbsp;</font></div><div><font size="2"  >------------------------------------------------+--------------+--------------+---------------</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124614 | &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; &nbsp;64922 | &nbsp; &nbsp; &nbsp; &nbsp; 30319</font></div></div><div><div><font size="2"  >digoal=&gt; select * from pgfadvise_willneed('text_pkey');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relpath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | os_page_size | rel_os_pages | os_pages_free&nbsp;</font></div><div><font size="2"  >------------------------------------------------+--------------+--------------+---------------</font></div><div><font size="2"  >&nbsp;pg_tblspc/16393/PG_9.1_201105231/16394/6124616 | &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; &nbsp;27424 | &nbsp; &nbsp; &nbsp; &nbsp; 31007</font></div></div><p></p></pre></div><div>显然没有包含TOAST表的内容。</div><div>接下来看看如何包含TOAST表的内容 :&nbsp;</div><div>首先要看看TOAST表放在哪个schema下面 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select nspname from pg_namespace where oid=(select relnamespace from pg_class where oid=1293342);</font></div><div><font size="2"  >&nbsp;nspname &nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;pg_toast</font></div><p></p></pre></div><div>pg_toast的owner是postgres, 因此需要使用超级用户 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; \dn *.*</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; List of schemas</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Name &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"  >--------------------+----------</font></div><div><font size="2"  >&nbsp;digoal &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | digoal</font></div><div><font size="2"  >&nbsp;information_schema | postgres</font></div><div><font size="2"  >&nbsp;pg_catalog &nbsp; &nbsp; &nbsp; &nbsp; | postgres</font></div><div><font size="2"  >&nbsp;pg_temp_1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| postgres</font></div><div><font size="2"  >&nbsp;pg_toast &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | postgres</font></div><div><font size="2"  >&nbsp;pg_toast_temp_1 &nbsp; &nbsp;| postgres</font></div><div><font size="2"  >&nbsp;public &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | postgres</font></div><p></p></pre></div><div>接下来就可以把TOAST表和它的索引放入内存了 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=# select * from pgfadvise_willneed('pg_toast.pg_toast_1293339');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relpath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| os_page_size | rel_os_pages | os_pages_free&nbsp;</font></div><div><font size="2"  >---------------------------------------------------+--------------+--------------+---------------</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124615 &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp; 32027</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124615.1 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp; 30055</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124615.2 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp; 31436</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124615.3 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp; 30018</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124615.4 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp; 31654</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124615.5 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp; 29949</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124615.6 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp; 30010</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124615.7 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp; 31135</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124615.8 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp; 30281</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124615.9 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp; 31313</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124615.10 | &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp; 31253</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124615.11 | &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp; 31253</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124615.12 | &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp; 31253</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124615.13 | &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp; 31253</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124615.14 | &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp; 31253</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124615.15 | &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp; 31253</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124615.16 | &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp; 31253</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124615.17 | &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp; 31253</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124615.18 | &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp; 31253</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124615.19 | &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; &nbsp;19264 | &nbsp; &nbsp; &nbsp; &nbsp; 31253</font></div><div><font size="2"  >(20 rows)</font></div></div><div><div><font size="2"  >digoal=# select * from pgfadvise_willneed('pg_toast.pg_toast_1293339_index');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relpath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | os_page_size | rel_os_pages | os_pages_free&nbsp;</font></div><div><font size="2"  >------------------------------------------------+--------------+--------------+---------------</font></div><div><font size="2"  >&nbsp;pg_tblspc/16392/PG_9.1_201105231/16394/6124617 | &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; &nbsp;54842 | &nbsp; &nbsp; &nbsp; &nbsp; 30332</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>