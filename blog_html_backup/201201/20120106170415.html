<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">A case, choose array , hstore or text type, or split column</h2>
	<h5 id="">2012-01-06 17:04:15&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020120453516936/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">今天和一位合作商的开发人员聊了一下，发现一个以前未测试过的东西，下面来看看这个CASE。<div>在这个数据库中，有个业务表的字段存储了用户的任务信息。</div><div>类型为TEXT，格式为一堆固定格式的字符串，如 : 任务ID：？，任务名：？，任务类型：？，任务状态：？，对话：？等。。。。。。重复。。。。。</div><div>所有的任务都存储在一个字段里面。</div><div>另外物品仓库也是类似存储。</div><div>这些字段在PostgreSQL中实际上是存储的TOAST格式，并压缩。</div><div>有些用户的数据压缩后还有几MB甚至10几MB。</div><div>解压后可能到几十MB。</div><div>所以数据库的压力集中在对这个表的更新，查询上面。</div><div>对于业务为啥选择TEXT类型，可能和使用的开发框架有关。</div><div>本文重点测试一下 array 和 text 类型在查询和更新上面的比较。</div><div>以下是一组测试 :&nbsp;</div><div><div><br></div><div><br></div><div>创建测试数据 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >text : 'digoal0:{0,0,0} digoal1:{1,1,1} ... digoalx:{x,x,x}'</font></div><div><font size="2"   >text[] {'digoal0:{0,0,0}','digoal1:{1,1,1}',...,'digoalx:{x,x,x}'}</font></div><p></p></pre></div><div><br></div><div>-- 创建测试表</div><div><pre class="prettyprint"   ><p><font size="2"   >CREATE TABLE test_text (info text);</font></p></pre></div><div>-- 插入测试数据</div><div><pre class="prettyprint"   ><p><font size="2"   >INSERT INTO test_text VALUES('digoal0:{0,0,0}');</font></p></pre></div><div>-- 创建生成超大行的函数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION update_test_text()</font></div><div><font size="2"   >&nbsp;RETURNS integer</font></div><div><font size="2"   >&nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >AS $function$&nbsp;</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >for i in 1..350 loop</font></div><div><font size="2"   >update test_text set info=info||' digoal'||i||':{'||i||','||i||','||i||'}';</font></div><div><font size="2"   >end loop;</font></div><div><font size="2"   >return 0;</font></div><div><font size="2"   >exception</font></div><div><font size="2"   >when others then</font></div><div><font size="2"   >return 1;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div>-- 生成超大行</div><div><pre class="prettyprint"   ><p><font size="2"   >SELECT * FROM update_test_text();</font></p></pre></div><div>-- 以上为单笔事务,所以需要VACUUM FULL清理一下.</div><div><pre class="prettyprint"   ><p><font size="2"   >VACUUM FULL test_text;</font></p></pre></div><div>-- 查看TOAST信息</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; SELECT relname,reltoastrelid FROM pg_class WHERE relname='test_text';</font></div><div><font size="2"   >&nbsp; relname &nbsp;| reltoastrelid&nbsp;</font></div><div><font size="2"   >-----------+---------------</font></div><div><font size="2"   >&nbsp;test_text | &nbsp; &nbsp; &nbsp; 1293172</font></div><p></p></pre></div><div>-- 查看单条记录SIZE</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; SELECT pg_column_size(info) FROM test_text;</font></div><div><font size="2"   >&nbsp;pg_column_size&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3545</font></div><p></p></pre></div><div>-- 查看表SIZE</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; SELECT pg_relation_size('test_text'::regclass)/1024;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 8</font></div><p></p></pre></div><div>-- 查看TOAST SIZE</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; SELECT pg_relation_size(1293172)/1024;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 8</font></div><p></p></pre></div><div><br></div><div>-- text测试 :&nbsp;</div><div>-- 创建text测试表</div><div><pre class="prettyprint"   ><p><font size="2"   >CREATE TABLE text (id int primary key,info text);</font></p></pre></div><div>-- 插入500W条测试数据</div><pre class="prettyprint"   ><p></p><div><font size="2"   >INSERT INTO text SELECT generate_series(1,5000000),info FROM test_text;</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >-- 索引和表分开物理存储</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >ALTER TABLE text ADD PRIMARY KEY (id) USING INDEX TABLESPACE digoal_idx;</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >-- 查看表物理存储信息,text为外部压缩存储</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; \d+ text</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "digoal.text"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers | Storage &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+---------+-----------+----------+-------------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; | integer | not null &nbsp;| plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;info &nbsp; | text &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended |&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "text_pkey" PRIMARY KEY, btree (id), tablespace "digoal_idx"</font></div><div><font size="2"   >Has OIDs: no</font></div><p></p></pre></div><div>-- 查看TOAST信息</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; SELECT relname,reltoastrelid FROM pg_class WHERE relname='text';</font></div><div><font size="2"   >&nbsp;relname | reltoastrelid&nbsp;</font></div><div><font size="2"   >---------+---------------</font></div><div><font size="2"   >&nbsp;text &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 1293342</font></div><p></p></pre></div><div>-- 查看表SIZE</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; SELECT pg_relation_size('text'::regclass)/1024;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; 254784</font></div><p></p></pre></div><div>-- 查看TOAST SIZE</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; SELECT pg_relation_size(1293342)/1024;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;20000000</font></div><p></p></pre></div><div>-- 查看索引SIZE</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; SELECT pg_relation_size('text_pkey'::regclass)/1024;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; 109696</font></div><p></p></pre></div><div><br></div><div>-- 测试</div><div>-- SELECT</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: extended</font></div><div><font size="2"   >number of clients: 32</font></div><div><font size="2"   >number of threads: 32</font></div><div><font size="2"   >duration: 180 s</font></div><div><font size="2"   >number of transactions actually processed: 2675714</font></div><div><font size="2"   >tps = 14864.740018 (including connections establishing)</font></div><div><font size="2"   >tps = 14866.318912 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001408 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2.149513 &nbsp; &nbsp; &nbsp; &nbsp;select * from text where id=:id;</font></div><p></p></pre></div><div>-- vmstat</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------</font></div><div><font size="2"   >&nbsp;r &nbsp;b &nbsp; swpd &nbsp; free &nbsp; buff &nbsp;cache &nbsp; si &nbsp; so &nbsp; &nbsp;bi &nbsp; &nbsp;bo &nbsp; in &nbsp; cs us sy id wa st</font></div><div><font size="2"   >&nbsp;5 &nbsp;0 &nbsp; &nbsp;380 127616 156792 23517420 &nbsp; &nbsp;0 &nbsp; &nbsp;0 &nbsp; 920 &nbsp; &nbsp;56 38687 50408 44 14 41 &nbsp;2 &nbsp;0</font></div><p></p></pre></div><div>-- iostat</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >avg-cpu: &nbsp;%user &nbsp; %nice %system %iowait &nbsp;%steal &nbsp; %idle</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 42.70 &nbsp; &nbsp;0.00 &nbsp; 14.73 &nbsp; 11.74 &nbsp; &nbsp;0.00 &nbsp; 30.84</font></div><div><font size="2"   >Device: &nbsp; &nbsp; &nbsp; &nbsp; rrqm/s &nbsp; wrqm/s &nbsp; r/s &nbsp; w/s &nbsp; rsec/s &nbsp; wsec/s avgrq-sz avgqu-sz &nbsp; await &nbsp;svctm &nbsp;%util</font></div><div><font size="2"   >sdc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 &nbsp; &nbsp;19.80 &nbsp;0.00 &nbsp;1.98 &nbsp; &nbsp; 0.00 &nbsp; 174.26 &nbsp; &nbsp;88.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.50 &nbsp; 0.50 &nbsp; 0.10</font></div><div><font size="2"   >sdd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 112.00 &nbsp;0.00 &nbsp;1808.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;16.14 &nbsp; &nbsp; 0.47 &nbsp; &nbsp;4.17 &nbsp; 2.71 &nbsp;30.30</font></div><p></p></pre></div><div>-- sar -n DEV 1 10000</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >03:44:22 PM &nbsp; &nbsp; IFACE &nbsp; rxpck/s &nbsp; txpck/s &nbsp; rxbyt/s &nbsp; txbyt/s &nbsp; rxcmp/s &nbsp; txcmp/s &nbsp;rxmcst/s</font></div><div><font size="2"   >03:44:22 PM &nbsp; &nbsp; &nbsp;eth0 &nbsp;34459.00 &nbsp;87451.00 3422286.00 123163175.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 80.00</font></div><p></p></pre></div><div><br></div><div>-- UPDATE</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: extended</font></div><div><font size="2"   >number of clients: 32</font></div><div><font size="2"   >number of threads: 32</font></div><div><font size="2"   >duration: 180 s</font></div><div><font size="2"   >number of transactions actually processed: 665875</font></div><div><font size="2"   >tps = 3696.889084 (including connections establishing)</font></div><div><font size="2"   >tps = 3697.129571 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001544 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 8.648408 &nbsp; &nbsp; &nbsp; &nbsp;update text set info='省略6845个字符(字段全内容)' where id=:id;</font></div><p></p></pre></div><div>-- vmstat</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------</font></div><div><font size="2"   >&nbsp;r &nbsp;b &nbsp; swpd &nbsp; free &nbsp; buff &nbsp;cache &nbsp; si &nbsp; so &nbsp; &nbsp;bi &nbsp; &nbsp;bo &nbsp; in &nbsp; cs us sy id wa st</font></div><div><font size="2"   >11 &nbsp;0 &nbsp; &nbsp;364 122972 156080 23524920 &nbsp; &nbsp;0 &nbsp; &nbsp;0 &nbsp;2712 75664 11478 29135 62 12 19 &nbsp;7 &nbsp;0</font></div><p></p></pre></div><div>-- iostat</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >avg-cpu: &nbsp;%user &nbsp; %nice %system %iowait &nbsp;%steal &nbsp; %idle</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 62.97 &nbsp; &nbsp;0.00 &nbsp; 11.35 &nbsp; &nbsp;4.36 &nbsp; &nbsp;0.00 &nbsp; 21.32</font></div><div><font size="2"   >Device: &nbsp; &nbsp; &nbsp; &nbsp; rrqm/s &nbsp; wrqm/s &nbsp; r/s &nbsp; w/s &nbsp; rsec/s &nbsp; wsec/s avgrq-sz avgqu-sz &nbsp; await &nbsp;svctm &nbsp;%util</font></div><div><font size="2"   >sdc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 13528.00 &nbsp;0.00 294.00 &nbsp; &nbsp; 0.00 110576.00 &nbsp; 376.11 &nbsp; &nbsp; 0.85 &nbsp; &nbsp;2.89 &nbsp; 0.81 &nbsp;23.90</font></div><div><font size="2"   >sdd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 216.00 &nbsp;0.00 &nbsp;3456.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;16.00 &nbsp; &nbsp; 1.44 &nbsp; &nbsp;6.59 &nbsp; 3.17 &nbsp;68.40</font></div><p></p></pre></div><div>-- sar -n DEV 1 10000</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >03:47:32 PM &nbsp; &nbsp; IFACE &nbsp; rxpck/s &nbsp; txpck/s &nbsp; rxbyt/s &nbsp; txbyt/s &nbsp; rxcmp/s &nbsp; txcmp/s &nbsp;rxmcst/s</font></div><div><font size="2"   >03:47:32 PM &nbsp; &nbsp; &nbsp;eth0 &nbsp;25623.47 &nbsp;15282.65 36521704.08 1126430.61 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;143.88</font></div><p></p></pre></div><div><br></div><div><br></div><div><br></div><div>-- array测试 :&nbsp;</div><div>-- 创建text[]测试表</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE TABLE text_array1 (info text[]);</font></div><div><font size="2"   >CREATE TABLE text_array (id int,info text[]);</font></div><p></p></pre></div><div>-- 插入10W条测试数据</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >INSERT INTO text_array1 SELECT regexp_split_to_array(info,' ') FROM test_text;</font></div><div><font size="2"   >INSERT INTO text_array SELECT generate_series(1,5000000),info FROM text_array1;</font></div><p></p></pre></div><div>-- 索引和表分开物理存储</div><pre class="prettyprint"   ><p></p><div><font size="2"   >ALTER TABLE text_array ADD PRIMARY KEY (id) USING INDEX TABLESPACE digoal_idx;</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >-- 查看表物理存储信息</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; \d+ text_array</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Table "digoal.text_array"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers | Storage &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+---------+-----------+----------+-------------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; | integer | not null &nbsp;| plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;info &nbsp; | text[] &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended |&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "text_array_pkey" PRIMARY KEY, btree (id), tablespace "digoal_idx"</font></div><div><font size="2"   >Has OIDs: no</font></div><p></p></pre></div><div>-- 查看TOAST信息</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; SELECT relname,reltoastrelid FROM pg_class WHERE relname='text_array';</font></div><div><font size="2"   >&nbsp; relname &nbsp; | reltoastrelid&nbsp;</font></div><div><font size="2"   >------------+---------------</font></div><div><font size="2"   >&nbsp;text_array | &nbsp; &nbsp; &nbsp;11738092</font></div><p></p></pre></div><div>-- 查看表SIZE</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; SELECT pg_relation_size('text_array'::regclass)/1024;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp;254784</font></div><p></p></pre></div><div>-- 查看TOAST SIZE</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; SELECT pg_relation_size(11738092)/1024;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;20000000</font></div><p></p></pre></div><div>-- 查看索引SIZE</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; SELECT pg_relation_size('text_array_pkey'::regclass)/1024;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp;109704</font></div><p></p></pre></div><div>-- 测试</div><div>-- SELECT 部分</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: extended</font></div><div><font size="2"   >number of clients: 32</font></div><div><font size="2"   >number of threads: 32</font></div><div><font size="2"   >duration: 180 s</font></div><div><font size="2"   >number of transactions actually processed: 5331728</font></div><div><font size="2"   >tps = 29607.171751 (including connections establishing)</font></div><div><font size="2"   >tps = 29609.826647 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001533 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.077225 &nbsp; &nbsp; &nbsp; &nbsp;select info[10] from text_array where id=:id;</font></div><p></p></pre></div><div>-- vmstat</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------</font></div><div><font size="2"   >&nbsp;r &nbsp;b &nbsp; swpd &nbsp; free &nbsp; buff &nbsp;cache &nbsp; si &nbsp; so &nbsp; &nbsp;bi &nbsp; &nbsp;bo &nbsp; in &nbsp; cs us sy id wa st</font></div><div><font size="2"   >22 &nbsp;0 &nbsp; &nbsp;240 123264 &nbsp; 4560 23738836 &nbsp; &nbsp;0 &nbsp; &nbsp;0 &nbsp;1992 &nbsp; &nbsp; 0 35325 51674 74 19 &nbsp;6 &nbsp;1 &nbsp;0</font></div><p></p></pre></div><div>-- iostat</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >avg-cpu: &nbsp;%user &nbsp; %nice %system %iowait &nbsp;%steal &nbsp; %idle</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 74.81 &nbsp; &nbsp;0.00 &nbsp; 19.20 &nbsp; &nbsp;0.75 &nbsp; &nbsp;0.00 &nbsp; &nbsp;5.24</font></div><div><font size="2"   >Device: &nbsp; &nbsp; &nbsp; &nbsp; rrqm/s &nbsp; wrqm/s &nbsp; r/s &nbsp; w/s &nbsp; rsec/s &nbsp; wsec/s avgrq-sz avgqu-sz &nbsp; await &nbsp;svctm &nbsp;%util</font></div><div><font size="2"   >sdc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 &nbsp; &nbsp;47.00 &nbsp;0.00 34.00 &nbsp; &nbsp; 0.00 &nbsp; 648.00 &nbsp; &nbsp;19.06 &nbsp; &nbsp; 0.02 &nbsp; &nbsp;0.62 &nbsp; 0.06 &nbsp; 0.20</font></div><div><font size="2"   >sdd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 242.00 &nbsp;0.00 &nbsp;3872.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;16.00 &nbsp; &nbsp; 0.67 &nbsp; &nbsp;2.76 &nbsp; 2.00 &nbsp;48.30</font></div><p></p></pre></div><div>-- sar -n DEV 1 10000</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >04:38:10 PM &nbsp; &nbsp; IFACE &nbsp; rxpck/s &nbsp; txpck/s &nbsp; rxbyt/s &nbsp; txbyt/s &nbsp; rxcmp/s &nbsp; txcmp/s &nbsp;rxmcst/s</font></div><div><font size="2"   >04:38:10 PM &nbsp; &nbsp; &nbsp;eth0 &nbsp;30119.80 &nbsp;30022.77 4775100.00 4323687.13 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 92.08</font></div><p></p></pre></div><div><br></div><div>-- SELECT 全部</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: extended</font></div><div><font size="2"   >number of clients: 32</font></div><div><font size="2"   >number of threads: 32</font></div><div><font size="2"   >duration: 180 s</font></div><div><font size="2"   >number of transactions actually processed: 2409554</font></div><div><font size="2"   >tps = 13386.168450 (including connections establishing)</font></div><div><font size="2"   >tps = 13387.845995 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001380 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2.387190 &nbsp; &nbsp; &nbsp; &nbsp;select * from text_array where id=:id;</font></div><p></p></pre></div><div>-- vmstat</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------</font></div><div><font size="2"   >&nbsp;r &nbsp;b &nbsp; swpd &nbsp; free &nbsp; buff &nbsp;cache &nbsp; si &nbsp; so &nbsp; &nbsp;bi &nbsp; &nbsp;bo &nbsp; in &nbsp; cs us sy id wa st</font></div><div><font size="2"   >&nbsp;9 &nbsp;0 &nbsp; &nbsp;240 123516 &nbsp; 5952 23750688 &nbsp; &nbsp;0 &nbsp; &nbsp;0 &nbsp; 208 &nbsp; &nbsp; 8 38086 45752 60 13 27 &nbsp;0 &nbsp;0</font></div><p></p></pre></div><div>-- iostat</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >avg-cpu: &nbsp;%user &nbsp; %nice %system %iowait &nbsp;%steal &nbsp; %idle</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 60.27 &nbsp; &nbsp;0.00 &nbsp; 13.33 &nbsp; &nbsp;0.62 &nbsp; &nbsp;0.00 &nbsp; 25.78</font></div><div><font size="2"   >Device: &nbsp; &nbsp; &nbsp; &nbsp; rrqm/s &nbsp; wrqm/s &nbsp; r/s &nbsp; w/s &nbsp; rsec/s &nbsp; wsec/s avgrq-sz avgqu-sz &nbsp; await &nbsp;svctm &nbsp;%util</font></div><div><font size="2"   >sdc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 &nbsp; &nbsp;42.00 &nbsp;0.00 &nbsp;2.00 &nbsp; &nbsp; 0.00 &nbsp; 352.00 &nbsp; 176.00 &nbsp; &nbsp; 0.01 &nbsp; &nbsp;3.00 &nbsp; 3.00 &nbsp; 0.60</font></div><div><font size="2"   >sdd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 31.00 &nbsp;0.00 &nbsp; 488.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;15.74 &nbsp; &nbsp; 0.14 &nbsp; &nbsp;4.55 &nbsp; 4.45 &nbsp;13.80</font></div><p></p></pre></div><div>-- sar -n DEV 1 10000</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >04:43:36 PM &nbsp; &nbsp; IFACE &nbsp; rxpck/s &nbsp; txpck/s &nbsp; rxbyt/s &nbsp; txbyt/s &nbsp; rxcmp/s &nbsp; txcmp/s &nbsp;rxmcst/s</font></div><div><font size="2"   >04:43:36 PM &nbsp; &nbsp; &nbsp;eth0 &nbsp;33005.94 &nbsp;92742.57 3277501.98 121822100.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 94.06</font></div><p></p></pre></div><div><br></div><div>-- UPDATE</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: extended</font></div><div><font size="2"   >number of clients: 32</font></div><div><font size="2"   >number of threads: 32</font></div><div><font size="2"   >duration: 180 s</font></div><div><font size="2"   >number of transactions actually processed: 678739</font></div><div><font size="2"   >tps = 3769.038192 (including connections establishing)</font></div><div><font size="2"   >tps = 3769.401576 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001467 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 8.484338 &nbsp; &nbsp; &nbsp; &nbsp;update text_array set info[100]='digoal100:{200,200,200}' where id=:id;</font></div><p></p></pre></div><div>-- vmstat</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------</font></div><div><font size="2"   >&nbsp;r &nbsp;b &nbsp; swpd &nbsp; free &nbsp; buff &nbsp;cache &nbsp; si &nbsp; so &nbsp; &nbsp;bi &nbsp; &nbsp;bo &nbsp; in &nbsp; cs us sy id wa st</font></div><div><font size="2"   >15 10 &nbsp; &nbsp;200 122588 &nbsp; 4152 23744824 &nbsp; &nbsp;0 &nbsp; &nbsp;0 &nbsp;7216 60936 10438 38948 65 11 &nbsp;9 15 &nbsp;0</font></div><p></p></pre></div><div>-- iostat</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >avg-cpu: &nbsp;%user &nbsp; %nice %system %iowait &nbsp;%steal &nbsp; %idle</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 66.21 &nbsp; &nbsp;0.00 &nbsp; 10.64 &nbsp; 16.65 &nbsp; &nbsp;0.00 &nbsp; &nbsp;6.51</font></div><div><font size="2"   >Device: &nbsp; &nbsp; &nbsp; &nbsp; rrqm/s &nbsp; wrqm/s &nbsp; r/s &nbsp; w/s &nbsp; rsec/s &nbsp; wsec/s avgrq-sz avgqu-sz &nbsp; await &nbsp;svctm &nbsp;%util</font></div><div><font size="2"   >sdc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 14099.00 &nbsp;0.00 315.00 &nbsp; &nbsp; 0.00 115312.00 &nbsp; 366.07 &nbsp; &nbsp; 1.04 &nbsp; &nbsp;3.32 &nbsp; 0.86 &nbsp;27.00</font></div><div><font size="2"   >sdd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 3.00 1039.00 &nbsp;2.00 16520.00 &nbsp; &nbsp;40.00 &nbsp; &nbsp;15.91 &nbsp; &nbsp; 9.28 &nbsp; &nbsp;8.92 &nbsp; 0.96 100.10</font></div><p></p></pre></div><div>-- sar -n DEV 1 10000</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >04:56:42 PM &nbsp; &nbsp; IFACE &nbsp; rxpck/s &nbsp; txpck/s &nbsp; rxbyt/s &nbsp; txbyt/s &nbsp; rxcmp/s &nbsp; txcmp/s &nbsp;rxmcst/s</font></div><div><font size="2"   >04:56:42 PM &nbsp; &nbsp; &nbsp;eth0 &nbsp; 5371.00 &nbsp; 5290.00 982338.00 497767.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 91.00</font></div><p></p></pre></div><div><br></div><div><br></div><div>小结 :&nbsp;</div><div>1. array类型更适合查询或更新字段中存储的部分元素的情形. 这种情形下面使用array类型可以大大降低网络传输开销, 当然这种情形还可以考虑hstore类型或者拆分字段来搞定.</div><div>2. 本例中更新测试时遇到IO瓶颈, 因此看不出array和text 有太大区别. 但是 由于array类型可以更新部分元素, 同样可以降低网络开销获得性能提升.</div><div><br></div><div>【hstore参考】</div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/hstore.html"   >http://www.postgresql.org/docs/9.1/static/hstore.html</a></div></div></div>
	</div>
</div>
</body>
</html>