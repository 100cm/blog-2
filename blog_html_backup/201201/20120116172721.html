<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 硬件性能调优</h2>
	<h5 id="">2012-01-16 17:27:21&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201201643730877/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>本文基本参考bruce momjian的《PostgreSQL Hardware Performance Tuning》</div><div>看过的人就不要看了。</div><div>首先要理解性能的概念 :&nbsp;</div><div>通常在性能调优方面是先软后硬，所谓软就是优化数据库软件层面的东西，例如创建索引，清理垃圾空间，统计数据分布，顺序化存储，等。<small style="font-family: Simsun; line-height: normal; text-align: -webkit-auto;"  >CREATE INDEX</small><span style="font-family: Simsun; line-height: normal; text-align: -webkit-auto; font-size: medium;"  >,&nbsp;</span><small style="font-family: Simsun; line-height: normal; text-align: -webkit-auto;"  >VACUUM, VACUUM FULL, ANALYZE,</small><span style="font-family: Simsun; line-height: normal; text-align: -webkit-auto; font-size: medium;"  >&nbsp;</span><small style="font-family: Simsun; line-height: normal; text-align: -webkit-auto;"  >CLUSTER</small><span style="font-family: Simsun; line-height: normal; text-align: -webkit-auto; font-size: medium;"  >, and&nbsp;</span><small style="font-family: Simsun; line-height: normal; text-align: -webkit-auto;"  >EXPLAIN.</small></div><div>所谓硬，指的是优化CPU，内存，以及磁盘的性能。</div><div>本文主要来讨论一下硬件方面的优化，来看下面一张图。</div><div><img title="PostgreSQL 硬件性能调优 - 德哥@Digoal - The Heart,The World."  alt="PostgreSQL 硬件性能调优 - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img3.ph.126.net/xkpiRAgZAHWnbYOB461gqQ==/1136033006021418523.jpg"  ></div><div>离CPU越近的存储单元速度越快，例如CPU寄存器，CPU缓存，内核缓存，磁盘等。</div><div>CPU访问磁盘上的数据所花费的开销最大。</div><div>因此硬件优化第一条，</div><div>让数据离CPU更近一些。</div><div>那么在PostgreSQL数据库服务器的内存中包含哪些东西呢 :&nbsp;</div><div><div>executing programs</div><div>program data and stack</div><div>POSTGRESQL shared buffer cache</div><div>kernel disk buffer cache</div><div>kernel</div></div><div>到底应该怎么优化呢 ?&nbsp;</div><div>我们看一看下面一张图 :&nbsp;</div><div>&nbsp;<img title="PostgreSQL 硬件性能调优 - 德哥@Digoal - The Heart,The World."  alt="PostgreSQL 硬件性能调优 - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img2.ph.126.net/SlmcoxwyHw1lr-AggBrhbg==/2739877423318733592.jpg"  ></div><div>PostgreSQL在需要读取一个数据块的时候，先会到<span style="line-height: 22px;"  >POSTGRESQL shared buffer cache里去查找, 如果没找到, 会向操作系统发起请求这个块. 如果这个块在</span><span style="line-height: 22px;"  >kernel disk buffer cache则返回比较快, 如果不在的话需要去DISK读取，DISK读取是比较慢的操作 .</span></div><div><span style="line-height: 22px;"  >那么是不是</span><span style="line-height: 22px;"  >POSTGRESQL shared buffer cache越大越好呢 ?</span></div><div>再来看看下面这张图 : &nbsp;</div><div><div><img title="PostgreSQL 硬件性能调优 - 德哥@Digoal - The Heart,The World."  alt="PostgreSQL 硬件性能调优 - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img2.ph.126.net/cF2GENRjQA0R_7fK_ZHPPg==/2687241602673832452.jpg"  ></div><div>如果内存不够用会怎么样, 内存中部分的数据需要写入到SWAP中, 如果被写入SWAP的数据是不太被访问的数据, 那这个操作还算OK。</div><div>但是当需要重新访问已经被写入SWAP的数据的时候，又需要从SWAP写回到内存中，并且如果内存此时不够用，还需要有部分数据先从内存写入SWAP。在数据从SWAP往内存回写的过程中是处于等待状态的。因此性能低下。</div><div>所以并不是<span style="line-height: 22px;"  >POSTGRESQL shared buffer cache越大越好，配置</span><span style="line-height: 22px;"  >POSTGRESQL shared buffer cache遵循以下两条原则。</span></div><div><span style="line-height: 22px;"  >1. POSTGRESQL shared buffer cache只要能装下经常被访问的数据就可以了。</span></div><div>2. 确保<span style="line-height: 22px;"  >POSTGRESQL shared buffer cache足够小，避免swap的换进换出操作。</span></div><div><span style="line-height: 22px;"  >另外, BSD系统可以把</span><span style="line-height: 22px;"  >POSTGRESQL shared buffer cache LOCK在内存里面. Linux 不行。</span></div><div><span style="line-height: 22px;"  >接下来要优化的是,&nbsp;</span>Sort Memory Batch Size</div><div><span style="font-family: Simsun; line-height: normal; text-align: -webkit-auto; font-size: medium;"  >As a start for tuning, use 15% of&nbsp;</span><small style="font-family: Simsun; line-height: normal; text-align: -webkit-auto;"  >RAM&nbsp;</small><span style="font-family: Simsun; line-height: normal; text-align: -webkit-auto; font-size: medium;"  >for cache size, and 2-4% for sort size if you have just a few big sessions, and much smaller if you have lots of small sessions. You can try increasing it to see if performance improves and if no swapping occurs. If the shared buffers are oversized, you waste overhead maintaining too many buffers, and it takes&nbsp;</span><small style="font-family: Simsun; line-height: normal; text-align: -webkit-auto;"  >RAM</small><span style="font-family: Simsun; line-height: normal; text-align: -webkit-auto; font-size: medium;"  >&nbsp;that could be used by other processes and as additional kernel disk buffer cache.</span></div><div><span style="font-family: Simsun; font-style: italic; line-height: normal; text-align: -webkit-auto; font-size: medium;"  >effective_cache_size的优化规则是如果文件系统配置了CACHE大小则与配置的一致，如果没有配置则和除掉系统，SHARED BUFFER CACHE的剩余内存一致。</span></div><div><span style="font-family: Simsun; font-style: italic; line-height: normal; text-align: -webkit-auto; font-size: medium;"  ><br></span></div><div><span style="font-family: Simsun; font-style: italic; line-height: normal; text-align: -webkit-auto; font-size: medium;"  >磁盘优化 :&nbsp;</span></div><div style="text-align: -webkit-auto;"  ><font face="Simsun"  size="3"  ><span style="line-height: normal;"  ><i>表，索引，WAL日志根据IOPS均匀的分布到物理存储上。</i></span></font></div><div><span style="font-family: Simsun; font-style: italic; line-height: normal; text-align: -webkit-auto; font-size: medium;"  ><br></span></div><div><span style="font-family: Simsun; font-style: italic; line-height: normal; text-align: -webkit-auto; font-size: medium;"  >文件系统 ：&nbsp;</span></div><div style="text-align: -webkit-auto;"  ><font face="Simsun"  size="3"  ><span style="line-height: normal;"  ><i>ext3, ext4, xfs, 选择安全可靠的。</i></span></font></div><div><span style="font-family: Simsun; font-style: italic; line-height: normal; text-align: -webkit-auto; font-size: medium;"  ><br></span></div><div><span style="font-family: Simsun; font-style: italic; line-height: normal; text-align: -webkit-auto; font-size: medium;"  >checkpoint :&nbsp;</span></div><div style="text-align: -webkit-auto;"  ><font face="Simsun"  size="3"  ><span style="line-height: 25px;"  ><i>避免一分钟内出现多次checkpoint, 可以通过调整checkpoint_segments, checkpoint_timeout参数来实现。</i></span></font></div><div style="text-align: -webkit-auto;"  ><font face="Simsun"  size="3"  ><span style="line-height: 25px;"  ><i><br></i></span></font></div><div style="text-align: -webkit-auto;"  ><font face="Simsun"  size="3"  ><span style="line-height: 25px;"  ><i>磁盘缓存 ：</i></span></font></div><div style="text-align: -webkit-auto;"  ><font face="Simsun"  size="3"  ><span style="line-height: 25px;"  ><i>带电保护的缓存可以打开。不带电保护的缓存必须关闭。</i></span></font></div></div><div><br></div>【参考】<div><a rel="nofollow" href="http://momjian.us/main/writings/pgsql/hw_performance/index.html"  >http://momjian.us/main/writings/pgsql/hw_performance/index.html</a>&nbsp;<br><br><wbr></div></div>
	</div>
</div>
</body>
</html>