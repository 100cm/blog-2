<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">We can ignore the performance influence when use sync replication in PostgreSQL 9.1</h2>
	<h5 id="">2011-10-22 1:06:44&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201192203458765/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">PostgreSQL 9.1 提供了同步复制的能力，但是我一直担心同步复制必将带来较大的性能影响。<div>下面从单节点，多个异步复制节点，多个复制节点（含同步复制节点）；以及同步事务，本地事务，异步事务这几个方面来测试一下同步复制带来的性能影响。</div><div><br><wbr><div>下面是测试过程和测试结果。</div><div>首先是测试环境如下 :&nbsp;</div><div><div>服务器配置 :&nbsp;</div><div>主库: &nbsp; 8核, 24G, 1块本地SAS10K转硬盘, 1块1GB网卡, x86服务器</div><div>standby库1: &nbsp;8核, 8G, &nbsp;1块本地SAS10K转硬盘, 1块1GB网卡, x86服务器</div><div>standby库2: &nbsp;8核, 14G, 1块本地SAS10K转硬盘, 1块1GB网卡, x86服务器</div></div><div><br></div><div>环境搭建可以使用pg_basebackup, 这个备份工具也是9.1提供的, 利用流复制协议远程备份数据库的命令. 当然也可以使用传统的pg_start_backup 然后SCP等命令。</div><div>对pg_basebackup不熟悉的朋友可以参考我以前写的BLOG</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201182395310376/"  >http://blog.163.com/digoal@126/blog/static/163877040201182395310376/</a></div><div>或者参考man pg_basebackup.&nbsp;</div><div><br></div><div>环境搭建好后就开始建立测试表和测试数据了 :&nbsp;</div><div><div>测试表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create table user_info</font></div><div><font size="2"  >(userid int,</font></div><div><font size="2"  >engname text,</font></div><div><font size="2"  >cnname text,</font></div><div><font size="2"  >occupation text,</font></div><div><font size="2"  >birthday date,</font></div><div><font size="2"  >signname text,</font></div><div><font size="2"  >email text,</font></div><div><font size="2"  >qq numeric,</font></div><div><font size="2"  >crt_time timestamp without time zone,</font></div><div><font size="2"  >mod_time timestamp without time zone</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table user_login_rec</font></div><div><font size="2"  >(userid int,</font></div><div><font size="2"  >login_time timestamp without time zone,</font></div><div><font size="2"  >ip inet</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table user_logout_rec</font></div><div><font size="2"  >(userid int,</font></div><div><font size="2"  >logout_time timestamp without time zone,</font></div><div><font size="2"  >ip inet</font></div><div><font size="2"  >);</font></div><p></p></pre></div><div><br></div><div>测试数据 :&nbsp;</div><div>我这里弄了5000W测试数据进去，当然你像测试多点数据的话可以再多塞点数据进去。</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >insert into user_info (userid,engname,cnname,occupation,birthday,signname,email,qq,crt_time,mod_time)</font></div><div><font size="2"  >select generate_series(1,50000000),</font></div><div><font size="2"  >'digoal.zhou',</font></div><div><font size="2"  >'德哥',</font></div><div><font size="2"  >'DBA',</font></div><div><font size="2"  >'1970-01-01'</font></div><div><font size="2"  >,E'公益是一辈子的事, I\'m Digoal.Zhou, Just do it!',</font></div><div><font size="2"  >'digoal@126.com',</font></div><div><font size="2"  >276732431,</font></div><div><font size="2"  >clock_timestamp(),</font></div><div><font size="2"  >NULL</font></div><div><font size="2"  >;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >set work_mem='2048MB';</font></div><div><font size="2"  >set maintenance_work_mem='2048MB';</font></div><div><font size="2"  >alter table user_info add constraint pk_user_info primary key (userid) using index tablespace digoal_idx;</font></div><p></p></pre></div></div><div>建立PK。</div><div><br></div><div>接下来新建数据库操作函数，我这里测试的是模拟用户登录，退出。涉及的SQL是查询用户信息，写登录日志表和退出日志表。</div><div><div>登录函数 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function f_user_login&nbsp;</font></div><div><font size="2"  >(i_userid int,</font></div><div><font size="2"  >OUT o_userid int,</font></div><div><font size="2"  >OUT o_engname text,</font></div><div><font size="2"  >OUT o_cnname text,</font></div><div><font size="2"  >OUT o_occupation text,</font></div><div><font size="2"  >OUT o_birthday date,</font></div><div><font size="2"  >OUT o_signname text,</font></div><div><font size="2"  >OUT o_email text,</font></div><div><font size="2"  >OUT o_qq numeric</font></div><div><font size="2"  >)</font></div><div><font size="2"  >as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div><font size="2"  >into o_userid,o_engname,o_cnname,o_occupation,o_birthday,o_signname,o_email,o_qq</font></div><div><font size="2"  >from user_info where userid=i_userid;</font></div><div><font size="2"  >insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$</font></div><div><font size="2"  >language plpgsql;</font></div><p></p></pre></div><div><br></div><div>退出函数 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function f_user_logout</font></div><div><font size="2"  >(i_userid int,</font></div><div><font size="2"  >OUT o_result int</font></div><div><font size="2"  >)</font></div><div><font size="2"  >as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >insert into user_logout_rec (userid,logout_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"  >o_result := 0;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >exception&nbsp;</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >o_result := 1;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$</font></div><div><font size="2"  >language plpgsql;</font></div><p></p></pre></div></div><div><br></div><div>接下来新建pgbouncer连接池，用于测试单场景（开启16个连接到数据库, 允许1W个客户端连接），另一个用来测试复合场景（分别开启12个连接到数据库, 允许2W个客户端连接）。</div><div><br></div><div>然后编辑pgbench需要的SQL文件 :&nbsp;</div><div><div>pgbench测试脚本1 f_user_login.sql :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >\setrandom userid 1 50000000</font></div><div><font size="2"  >select * from f_user_login(:userid);</font></div><p></p></pre></div><div><br></div><div>pgbench测试脚本2 f_user_logout.sql :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >\setrandom userid 1 50000000</font></div><div><font size="2"  >select * from f_user_logout(:userid);</font></div><p></p></pre></div></div><div><br></div><div>测试结果 :&nbsp;</div><div><div>一、未开启任何standby的测试(异步事务) :&nbsp;</div><div>单项测试结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; pgbench -c 32 -M extended -f ./f_user_login.sql -j 32 -n -r -T 180 -h 127.0.0.1 -p 1999 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 32</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 4451365</font></div><div><font size="2"  >tps = 24729.367434 (including connections establishing)</font></div><div><font size="2"  >tps = 24729.796402 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002033 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 1.289057 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_login(:userid);</font></div><div><font size="2"  >postgres@db5-&gt; pgbench -c 32 -M extended -f ./f_user_logout.sql -j 32 -n -r -T 180 -h 127.0.0.1 -p 1999 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 32</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 5022561</font></div><div><font size="2"  >tps = 27902.772377 (including connections establishing)</font></div><div><font size="2"  >tps = 27903.700179 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002034 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 1.141897 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_logout(:userid);</font></div><p></p></pre></div><div><br></div><div>复合测试结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; pgbench -c 32 -M extended -f ./f_user_login.sql -j 32 -n -r -T 180 -h 127.0.0.1 -p 1999 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 32</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 2374574</font></div><div><font size="2"  >tps = 13191.822223 (including connections establishing)</font></div><div><font size="2"  >tps = 13191.979321 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002205 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 2.420410 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_login(:userid);</font></div><div><font size="2"  >postgres@db5-&gt; pgbench -c 32 -M extended -f ./f_user_logout.sql -j 32 -n -r -T 180 -h 127.0.0.1 -p 2000 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 32</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 2864446</font></div><div><font size="2"  >tps = 15913.315357 (including connections establishing)</font></div><div><font size="2"  >tps = 15913.774923 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002180 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 2.005673 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_logout(:userid);</font></div><p></p></pre></div><div><br></div><div><br></div><div><br></div><div>二、开启2台异步standby测试(异步事务)&nbsp;:&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select * from pg_stat_replication;</font></div><div><font size="2"  >&nbsp;procpid | usesysid | usename | application_name | client_addr | client_hostname | client_port | &nbsp; &nbsp; &nbsp; &nbsp; backend_start &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; s</font></div><div><font size="2"  >tate &nbsp; | sent_location | write_location | flush_location | replay_location | sync_priority | sync_state&nbsp;</font></div><div><font size="2"  >---------+----------+---------+------------------+-------------+-----------------+-------------+-------------------------------+----</font></div><div><font size="2"  >-------+---------------+----------------+----------------+-----------------+---------------+------------</font></div><div><font size="2"  >&nbsp; &nbsp; 2780 | &nbsp; &nbsp;16464 | replica | standby1 &nbsp; &nbsp; &nbsp; &nbsp; | 172.xxx.xxx.1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 26038 | 2011-10-22 00:09:48.067483+08 | str</font></div><div><font size="2"  >eaming | 4/90163068 &nbsp; &nbsp;| 4/90163068 &nbsp; &nbsp; | 4/90163068 &nbsp; &nbsp; | 4/90163068 &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | async</font></div><div><font size="2"  >&nbsp; &nbsp; 2781 | &nbsp; &nbsp;16464 | replica | standby2 &nbsp; &nbsp; &nbsp; &nbsp; | 172.xxx.xxx.2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 59262 | 2011-10-22 00:09:53.633187+08 | str</font></div><div><font size="2"  >eaming | 4/90163068 &nbsp; &nbsp;| 4/90163068 &nbsp; &nbsp; | 4/90163068 &nbsp; &nbsp; | 4/90163068 &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | async</font></div><p></p></pre></div><div><br></div><div>单项测试结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; pgbench -c 32 -M extended -f ./f_user_login.sql -j 32 -n -r -T 180 -h 127.0.0.1 -p 1999 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 32</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 4216608</font></div><div><font size="2"  >tps = 23425.184203 (including connections establishing)</font></div><div><font size="2"  >tps = 23425.862496 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002019 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 1.361130 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_login(:userid);</font></div><div><font size="2"  >postgres@db5-&gt; pgbench -c 32 -M extended -f ./f_user_logout.sql -j 32 -n -r -T 180 -h 127.0.0.1 -p 1999 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 32</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 4769505</font></div><div><font size="2"  >tps = 26496.706965 (including connections establishing)</font></div><div><font size="2"  >tps = 26497.351435 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002039 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 1.202742 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_logout(:userid);</font></div><p></p></pre></div><div><br></div><div>复合测试结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; pgbench -c 32 -M extended -f ./f_user_login.sql -j 32 -n -r -T 180 -h 127.0.0.1 -p 1999 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 32</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 2325629</font></div><div><font size="2"  >tps = 12919.857136 (including connections establishing)</font></div><div><font size="2"  >tps = 12920.135410 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002146 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 2.471710 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_login(:userid);</font></div><div><font size="2"  >postgres@db5-&gt; pgbench -c 32 -M extended -f ./f_user_logout.sql -j 32 -n -r -T 180 -h 127.0.0.1 -p 2000 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 32</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 2817671</font></div><div><font size="2"  >tps = 15634.878108 (including connections establishing)</font></div><div><font size="2"  >tps = 15635.203940 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002186 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 2.041436 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_logout(:userid);</font></div><p></p></pre></div><div><br></div><div><br></div><div>三、开启1台同步standby, 1台异步standby测试 :&nbsp;</div><div>这里测了三种情况，一种是同步事务synchronous_commit=on，一种是本地事务synchronous_commit=local，一种是异步事务synchronous_commit=off。</div><div>3.1 异步事务测试结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select * from pg_stat_replication;</font></div><div><font size="2"  >&nbsp;procpid | usesysid | usename | application_name | client_addr | client_hostname | client_port | &nbsp; &nbsp; &nbsp; &nbsp; backend_start &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; s</font></div><div><font size="2"  >tate &nbsp; | sent_location | write_location | flush_location | replay_location | sync_priority | sync_state&nbsp;</font></div><div><font size="2"  >---------+----------+---------+------------------+-------------+-----------------+-------------+-------------------------------+----</font></div><div><font size="2"  >-------+---------------+----------------+----------------+-----------------+---------------+------------</font></div><div><font size="2"  >&nbsp; &nbsp; 2780 | &nbsp; &nbsp;16464 | replica | standby1 &nbsp; &nbsp; &nbsp; &nbsp; | 172.xxx.xxx.1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 26038 | 2011-10-22 00:09:48.067483+08 | str</font></div><div><font size="2"  >eaming | 4/901630F8 &nbsp; &nbsp;| 4/901630F8 &nbsp; &nbsp; | 4/901630F8 &nbsp; &nbsp; | 4/901630F8 &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | sync</font></div><div><font size="2"  >&nbsp; &nbsp; 2781 | &nbsp; &nbsp;16464 | replica | standby2 &nbsp; &nbsp; &nbsp; &nbsp; | 172.xxx.xxx.2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 59262 | 2011-10-22 00:09:53.633187+08 | str</font></div><div><font size="2"  >eaming | 4/901630F8 &nbsp; &nbsp;| 4/901630F8 &nbsp; &nbsp; | 4/901630F8 &nbsp; &nbsp; | 4/901630F8 &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | potential</font></div><p></p></pre></div><div><br></div><div>3.1.1 单项测试结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; pgbench -c 32 -M extended -f ./f_user_login.sql -j 32 -n -r -T 180 -h 127.0.0.1 -p 1999 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 32</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 4159570</font></div><div><font size="2"  >tps = 23108.282523 (including connections establishing)</font></div><div><font size="2"  >tps = 23108.654858 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002064 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 1.379831 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_login(:userid);</font></div><div><font size="2"  >postgres@db5-&gt; pgbench -c 32 -M extended -f ./f_user_logout.sql -j 32 -n -r -T 180 -h 127.0.0.1 -p 1999 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 32</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 4961886</font></div><div><font size="2"  >tps = 27565.527965 (including connections establishing)</font></div><div><font size="2"  >tps = 27566.353175 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002029 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 1.155964 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_logout(:userid);</font></div><p></p></pre></div><div><br></div><div>3.1.2 复合测试结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; pgbench -c 32 -M extended -f ./f_user_login.sql -j 32 -n -r -T 180 -h 127.0.0.1 -p 1999 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 32</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 2247088</font></div><div><font size="2"  >tps = 12483.605632 (including connections establishing)</font></div><div><font size="2"  >tps = 12483.992644 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002179 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 2.558105 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_login(:userid);</font></div><div><font size="2"  >postgres@db5-&gt; pgbench -c 32 -M extended -f ./f_user_logout.sql -j 32 -n -r -T 180 -h 127.0.0.1 -p 2000 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 32</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 2705016</font></div><div><font size="2"  >tps = 15027.514772 (including connections establishing)</font></div><div><font size="2"  >tps = 15027.784844 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002145 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 2.124289 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_logout(:userid);</font></div><p></p></pre></div></div><div><br></div><div>3.2 本地事务测试结果</div><div>3.2.1&nbsp;单项测试结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; pgbench -c 32 -M extended -f ./f_user_login.sql -j 32 -n -r -T 180 -h 127.0.0.1 -p 1999 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 32</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 1880394</font></div><div><font size="2"  >tps = 10446.398754 (including connections establishing)</font></div><div><font size="2"  >tps = 10446.716731 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002059 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 3.058239 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_login(:userid);</font></div><div><font size="2"  >postgres@db5-&gt; pgbench -c 32 -M extended -f ./f_user_logout.sql -j 32 -n -r -T 180 -h 127.0.0.1 -p 1999 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 32</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 2283510</font></div><div><font size="2"  >tps = 12685.954741 (including connections establishing)</font></div><div><font size="2"  >tps = 12686.191268 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002034 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 2.517571 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_logout(:userid);</font></div><p></p></pre></div><div><br></div><div>3.2.2 复合测试结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; pgbench -c 32 -M extended -f ./f_user_login.sql -j 32 -n -r -T 180 -h 127.0.0.1 -p 1999 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 32</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 1010209</font></div><div><font size="2"  >tps = 5611.969675 (including connections establishing)</font></div><div><font size="2"  >tps = 5612.109360 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002196 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 5.696539 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_login(:userid);</font></div><div><font size="2"  >postgres@db5-&gt; pgbench -c 32 -M extended -f ./f_user_logout.sql -j 32 -n -r -T 180 -h 127.0.0.1 -p 2000 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 32</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 1043739</font></div><div><font size="2"  >tps = 5798.298837 (including connections establishing)</font></div><div><font size="2"  >tps = 5798.383639 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002193 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 5.513390 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_logout(:userid);</font></div><p></p></pre></div><div><br></div><div>3.3 同步事务测试结果 :&nbsp;</div><div><div>3.3.1 单项测试结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; pgbench -c 32 -M extended -f ./f_user_login.sql -j 32 -n -r -T 180 -h 127.0.0.1 -p 1999 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 32</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 1778910</font></div><div><font size="2"  >tps = 9882.600708 (including connections establishing)</font></div><div><font size="2"  >tps = 9882.886514 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002006 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 3.233093 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_login(:userid);</font></div><div><font size="2"  >postgres@db5-&gt; pgbench -c 32 -M extended -f ./f_user_logout.sql -j 32 -n -r -T 180 -h 127.0.0.1 -p 1999 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 32</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 2202408</font></div><div><font size="2"  >tps = 12235.373102 (including connections establishing)</font></div><div><font size="2"  >tps = 12235.684730 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002018 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 2.610460 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_logout(:userid);</font></div><p></p></pre></div><div><br></div><div>3.3.2 复合测试结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; pgbench -c 32 -M extended -f ./f_user_login.sql -j 32 -n -r -T 180 -h 127.0.0.1 -p 1999 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 32</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 945110</font></div><div><font size="2"  >tps = 5201.559767 (including connections establishing)</font></div><div><font size="2"  >tps = 5201.652220 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002197 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 6.122413 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_login(:userid);</font></div><div><font size="2"  >postgres@db5-&gt; pgbench -c 32 -M extended -f ./f_user_logout.sql -j 32 -n -r -T 180 -h 127.0.0.1 -p 2000 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 32</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 1007326</font></div><div><font size="2"  >tps = 5546.141117 (including connections establishing)</font></div><div><font size="2"  >tps = 5546.243610 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002194 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 5.735635 &nbsp; &nbsp; &nbsp; &nbsp;select * from f_user_logout(:userid);</font></div><p></p></pre></div></div><div><br></div><div>为了对比的公平，把本地事务的性能和同步事务进行比较，得出的结论是同步复制带来的影响微乎其微。</div><div>把异步事务的性能和其他模式下的异步事务的性能进行比较，得出的结论是同步复制带来的影响微乎其微。</div><div><br></div><div>增加一组数据，采用同步事务测试复合场景过程中，主节点的CPU空闲率约48%，sync节点的空闲率约91%。async节点的空闲率约91%。</div><div>由于是同步事务，所以等待基本集中在xlog的写等待上。</div><div><br></div><div>【小结】</div><div>从测试结果来看，在sync节点的性能以及与Primary节点通讯网络带宽足够的情况下，同步复制带来的影响确实非常小。</div><div>PostgreSQL 9.1的性能令人满意，按照这个速度（异步事务），一台非常普通的X86服务器（另外两台备机如果提供查询的话可以满足更多的查询需求），一天可以提供20多亿次插入请求和10多亿次的查询请求。</div><div>结合PG分布式应用，再多点用户数只要加服务器就行了，非常容易扩展。</div><div><br></div><div>【测试sync节点DOWN机后自动将potential节点切换为sync节点】</div><div>1. 关闭1号standby节点, 然后去主节点观察. 2号standby节点已经变成sync状态了。</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select * from pg_stat_replication;</font></div><div><font size="2"  >&nbsp;procpid | usesysid | usename | application_name | client_addr | client_hostname | client_port | &nbsp; &nbsp; &nbsp; &nbsp; backend_start &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; s</font></div><div><font size="2"  >tate &nbsp; | sent_location | write_location | flush_location | replay_location | sync_priority | sync_state&nbsp;</font></div><div><font size="2"  >---------+----------+---------+------------------+-------------+-----------------+-------------+-------------------------------+----</font></div><div><font size="2"  >-------+---------------+----------------+----------------+-----------------+---------------+------------</font></div><div><font size="2"  >&nbsp; &nbsp; 2781 | &nbsp; &nbsp;16464 | replica | standby2 &nbsp; &nbsp; &nbsp; &nbsp; | 172.xxx.xxx.2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 59262 | 2011-10-22 00:09:53.633187+08 | str</font></div><div><font size="2"  >eaming | 5/17B32770 &nbsp; &nbsp;| 5/17B32770 &nbsp; &nbsp; | 5/17B32770 &nbsp; &nbsp; | 5/17B32770 &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | sync</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>2. 再次开启1号standby节点，1号节点恢复为sync状态，2号又变回potential.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select * from pg_stat_replication;</font></div><div><font size="2"  >&nbsp;procpid | usesysid | usename | application_name | client_addr | client_hostname | client_port | &nbsp; &nbsp; &nbsp; &nbsp; backend_start &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; s</font></div><div><font size="2"  >tate &nbsp; | sent_location | write_location | flush_location | replay_location | sync_priority | sync_state&nbsp;</font></div><div><font size="2"  >---------+----------+---------+------------------+-------------+-----------------+-------------+-------------------------------+----</font></div><div><font size="2"  >-------+---------------+----------------+----------------+-----------------+---------------+------------</font></div><div><font size="2"  >&nbsp; &nbsp; 2920 | &nbsp; &nbsp;16464 | replica | standby1 &nbsp; &nbsp; &nbsp; &nbsp; | 172.xxx.xxx.1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 13088 | 2011-10-22 00:28:30.324383+08 | str</font></div><div><font size="2"  >eaming | 5/17B32770 &nbsp; &nbsp;| 5/17B32770 &nbsp; &nbsp; | 5/17B32770 &nbsp; &nbsp; | 5/17B32770 &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | sync</font></div><div><font size="2"  >&nbsp; &nbsp; 2781 | &nbsp; &nbsp;16464 | replica | standby2 &nbsp; &nbsp; &nbsp; &nbsp; | 172.xxx.xxx.2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 59262 | 2011-10-22 00:09:53.633187+08 | str</font></div><div><font size="2"  >eaming | 5/17B32770 &nbsp; &nbsp;| 5/17B32770 &nbsp; &nbsp; | 5/17B32770 &nbsp; &nbsp; | 5/17B32770 &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | potential</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div>3. 把1号和2号standby节点都关掉。主库的sync事务将进入等待状态,非sync事务依然可以进行读写。</div><div>发现所有standby节点都挂了之后应该考虑立即取消sync模式, 保持事务进行。</div><div><br></div><div>【配置文件】</div><div>standby节点的recovery.conf文件 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >standby_mode = on</font></div><div><font size="2"  >primary_conninfo = 'host=172.xxx.xxx.3 port=5432 user=replica application_name=standby1' &nbsp; &nbsp; &nbsp; &nbsp; # e.g. 'host=localhost port=5432'</font></div><div><font size="2"  >trigger_file = '/pgdata/digoal/5432/data02/pg_root/postgresql.trigger.5432'</font></div><p></p></pre></div><div><br></div><div><div>【测试数据样本】&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select * from user_info limit 5;</font></div><div><font size="2"  >&nbsp;userid | &nbsp; engname &nbsp; | cnname | occupation | &nbsp;birthday &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;signname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; email &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;qq &nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| mod_time&nbsp;</font></div><div><font size="2"  >--------+-------------+--------+------------+------------+------------------------------------------------+----------------+--------</font></div><div><font size="2"  >---+----------------------------+----------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 1 | digoal.zhou | 德哥 &nbsp; | DBA &nbsp; &nbsp; &nbsp; &nbsp;| 1970-01-01 | 公益是一辈子的事, I'm Digoal.Zhou, Just do it! | digoal@126.com | 2767324</font></div><div><font size="2"  >31 | 2011-10-21 22:01:20.029311 |&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 2 | digoal.zhou | 德哥 &nbsp; | DBA &nbsp; &nbsp; &nbsp; &nbsp;| 1970-01-01 | 公益是一辈子的事, I'm Digoal.Zhou, Just do it! | digoal@126.com | 2767324</font></div><div><font size="2"  >31 | 2011-10-21 22:01:20.029424 |&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 3 | digoal.zhou | 德哥 &nbsp; | DBA &nbsp; &nbsp; &nbsp; &nbsp;| 1970-01-01 | 公益是一辈子的事, I'm Digoal.Zhou, Just do it! | digoal@126.com | 2767324</font></div><div><font size="2"  >31 | 2011-10-21 22:01:20.029433 |&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 4 | digoal.zhou | 德哥 &nbsp; | DBA &nbsp; &nbsp; &nbsp; &nbsp;| 1970-01-01 | 公益是一辈子的事, I'm Digoal.Zhou, Just do it! | digoal@126.com | 2767324</font></div><div><font size="2"  >31 | 2011-10-21 22:01:20.029438 |&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 5 | digoal.zhou | 德哥 &nbsp; | DBA &nbsp; &nbsp; &nbsp; &nbsp;| 1970-01-01 | 公益是一辈子的事, I'm Digoal.Zhou, Just do it! | digoal@126.com | 2767324</font></div><div><font size="2"  >31 | 2011-10-21 22:01:20.029442 |&nbsp;</font></div><div><font size="2"  >(5 rows)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Time: 0.612 ms</font></div><div><font size="2"  >digoal=&gt; select * from user_login_rec limit 5;</font></div><div><font size="2"  >&nbsp; userid &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; login_time &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;ip &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----------+----------------------------+--------------</font></div><div><font size="2"  >&nbsp;23375965 | 2011-10-21 22:56:04.722263 | 172.xxx.xxx.xxx</font></div><div><font size="2"  >&nbsp;22441124 | 2011-10-21 22:56:04.727708 |&nbsp;172.xxx.xxx.xxx</font></div><div><font size="2"  >&nbsp;46581992 | 2011-10-21 22:56:04.721366 |&nbsp;172.xxx.xxx.xxx</font></div><div><font size="2"  >&nbsp;17439690 | 2011-10-21 22:56:04.72087 &nbsp;|&nbsp;172.xxx.xxx.xxx</font></div><div><font size="2"  >&nbsp;36373256 | 2011-10-21 22:56:04.722019 |&nbsp;172.xxx.xxx.xxx</font></div><div><font size="2"  >(5 rows)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Time: 0.516 ms</font></div><div><font size="2"  >digoal=&gt; select * from user_logout_rec limit 5;</font></div><div><font size="2"  >&nbsp; userid &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;logout_time &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;ip &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----------+----------------------------+--------------</font></div><div><font size="2"  >&nbsp; 8899868 | 2011-10-21 22:17:03.468211 |&nbsp;172.xxx.xxx.xxx</font></div><div><font size="2"  >&nbsp;47715166 | 2011-10-21 22:17:03.467715 |&nbsp;172.xxx.xxx.xxx</font></div><div><font size="2"  >&nbsp; 4865187 | 2011-10-21 22:17:03.468816 |&nbsp;172.xxx.xxx.xxx</font></div><div><font size="2"  >&nbsp;25229626 | 2011-10-21 22:17:03.470679 |&nbsp;172.xxx.xxx.xxx</font></div><div><font size="2"  >&nbsp; 7699796 | 2011-10-21 22:17:03.470818 |&nbsp;172.xxx.xxx.xxx</font></div><div><font size="2"  >(5 rows)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Time: 0.541 ms</font></div><p></p></pre></div></div>【其他】</div><div>同步复制大多数的瓶颈来自备机的IO能力以及主机和备机之间的网络延时. 可以通过以下工具进行分析.</div><div>1. IO分析工具</div><div>iostat</div><div>2. 网络分析工具</div><div>sar -n DEV 1 10000</div><div>mtr</div><div>qperf</div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">babyyellow - 2011-12-21 16:30:45</h5>
				<div><IMG src="http://b.bst.126.net/common/portrait/face/preview/face55.gif"  ></div>
			</div>
	</div>
</div>
</body>
</html>