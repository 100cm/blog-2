<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">compare GiST and GIN index performance</h2>
	<h5 id="">2011-10-26 14:58:57&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201192624726272/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">今天一位同事带来了一份很IN的需求，推荐好友。<wbr><div>类似新浪微博里面推荐好友的功能，如用户A登录的时候给他推荐他可能感兴趣的好友。</div><div>做法是取出A的好友列表，然后根据这个列表再去找出这些人的好友列表。类似腾讯的二度人脉。(预处理可以考虑mapreduce)</div><div><br></div><div><div><img title="compare GiST and GIN index performance - 德哥@Digoal - The Heart,The World."   alt="compare GiST and GIN index performance - 德哥@Digoal - The Heart,The World."   style="margin:0 10px 0 0;"   src="http://img7.ph.126.net/2fHQ9MvHAH_M3pioPxNtrg==/2517230716740438697.jpg"   ></div><div><br></div>&nbsp;<div><img title="compare GiST and GIN index performance - 德哥@Digoal - The Heart,The World."   alt="compare GiST and GIN index performance - 德哥@Digoal - The Heart,The World."   style="margin:0 10px 0 0;"   src="http://img5.ph.126.net/Ht7cIgkoMEMFM_OmtlWZUA==/2737625623504880465.jpg"   ></div>&nbsp;</div><div><br></div><div>选择了两种类型来比较。</div><div>1. 用array类型来存储好友列表</div><div>例如 ：&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; create table array_test (id int8,phone_list numeric[]);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >digoal=&gt; create table phone (id1 numeric,id2 numeric,id3 numeric,id4 numeric,id5 numeric,id6 numeric);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >digoal=&gt; insert into phone select generate_series(1,500000),generate_series(2,500001),generate_series(3,500002),generate_series(4,500003),generate_series(5,500004),generate_series(6,500005);</font></div><div><font size="2"   >INSERT 0 500000</font></div></div><div><div><font size="2"   >digoal=&gt; insert into array_test (phone_list) select cast(regexp_split_to_array(id1||','||id2||','||id3||','||id4||','||id5||','||id6,',') as numeric[]) from phone;</font></div><div><font size="2"   >INSERT 0 500000</font></div></div><div><div><font size="2"   >digoal=&gt; create index idx_array_test on array_test using gin (phone_list);</font></div><div><font size="2"   >CREATE INDEX</font></div></div><div><div><font size="2"   >digoal=&gt; explain analyze select * from array_test where phone_list &amp;&amp; cast(array[1,2] as numeric[]);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Bitmap Heap Scan on array_test &nbsp;(cost=39.38..3231.72 rows=2500 width=100) (actual time=0.037..0.038 rows=2 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Recheck Cond: (phone_list &amp;&amp; '{1,2}'::numeric[])</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on idx_array_test &nbsp;(cost=0.00..38.75 rows=2500 width=0) (actual time=0.029..0.029 rows=2 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (phone_list &amp;&amp; '{1,2}'::numeric[])</font></div><div><font size="2"   >&nbsp;Total runtime: 0.081 ms</font></div><div><font size="2"   >(5 rows)</font></div><div><font size="2"   >Time: 0.825 ms</font></div></div><div><div><font size="2"   >digoal=&gt; select * from array_test where phone_list &amp;&amp; cast(array[1,2,3,4,5,6] as numeric[]);</font></div><div><font size="2"   >&nbsp;id | &nbsp; phone_list &nbsp; &nbsp;</font></div><div><font size="2"   >----+-----------------</font></div><div><font size="2"   >&nbsp; &nbsp; | {1,2,3,4,5,6}</font></div><div><font size="2"   >&nbsp; &nbsp; | {2,3,4,5,6,7}</font></div><div><font size="2"   >&nbsp; &nbsp; | {3,4,5,6,7,8}</font></div><div><font size="2"   >&nbsp; &nbsp; | {4,5,6,7,8,9}</font></div><div><font size="2"   >&nbsp; &nbsp; | {5,6,7,8,9,10}</font></div><div><font size="2"   >&nbsp; &nbsp; | {6,7,8,9,10,11}</font></div><div><font size="2"   >(6 rows)</font></div><div><font size="2"   >Time: 0.524 ms</font></div></div><p></p></pre></div><div><br></div><div>2. 用tsvector类型来存储好友列表</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; create table tsvector_test (id bigint,phone_list tsvector);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >Time: 3.411 ms</font></div></div><div><div><font size="2"   >digoal=&gt; insert into tsvector_test (phone_list ) select cast (id1||' '||id2||' '||id3||' '||id4||' '||id5||' '||id6 as tsvector) from phone;</font></div><div><font size="2"   >INSERT 0 500000</font></div><div><font size="2"   >Time: 3860.805 ms</font></div><div><font size="2"   >digoal=&gt; create index idx_tsvector_test on tsvector_test using gin (phone_list);</font></div><div><font size="2"   >CREATE INDEX</font></div><div><font size="2"   >Time: 8618.414 ms</font></div></div><div><div><font size="2"   >digoal=&gt; explain analyze select * from tsvector_test where phone_list @@ '1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10'::tsquery;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >---------------------------</font></div><div><font size="2"   >&nbsp;Bitmap Heap Scan on tsvector_test &nbsp;(cost=305.45..6675.01 rows=24445 width=71) (actual time=0.104..0.113 rows=10 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Recheck Cond: (phone_list @@ '( ( ( ( ( ( ( ( ''1'' | ''2'' ) | ''3'' ) | ''4'' ) | ''5'' ) | ''6'' ) | ''7'' ) | ''8'' ) | ''9''</font></div><div><font size="2"   >&nbsp;) | ''10'''::tsquery)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on idx_tsvector_test &nbsp;(cost=0.00..299.34 rows=24445 width=0) (actual time=0.095..0.095 rows=10 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (phone_list @@ '( ( ( ( ( ( ( ( ''1'' | ''2'' ) | ''3'' ) | ''4'' ) | ''5'' ) | ''6'' ) | ''7'' ) | ''8'' ) | '</font></div><div><font size="2"   >'9'' ) | ''10'''::tsquery)</font></div><div><font size="2"   >&nbsp;Total runtime: 0.227 ms</font></div><div><font size="2"   >(5 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 0.824 ms</font></div></div><div><div><font size="2"   >digoal=&gt; select * from tsvector_test where phone_list @@ '1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10'::tsquery;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;phone_list &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----+-------------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; | '1' '2' '3' '4' '5' '6'</font></div><div><font size="2"   >&nbsp; &nbsp; | '2' '3' '4' '5' '6' '7'</font></div><div><font size="2"   >&nbsp; &nbsp; | '3' '4' '5' '6' '7' '8'</font></div><div><font size="2"   >&nbsp; &nbsp; | '4' '5' '6' '7' '8' '9'</font></div><div><font size="2"   >&nbsp; &nbsp; | '10' '5' '6' '7' '8' '9'</font></div><div><font size="2"   >&nbsp; &nbsp; | '10' '11' '6' '7' '8' '9'</font></div><div><font size="2"   >&nbsp; &nbsp; | '10' '11' '12' '7' '8' '9'</font></div><div><font size="2"   >&nbsp; &nbsp; | '10' '11' '12' '13' '8' '9'</font></div><div><font size="2"   >&nbsp; &nbsp; | '10' '11' '12' '13' '14' '9'</font></div><div><font size="2"   >&nbsp; &nbsp; | '10' '11' '12' '13' '14' '15'</font></div><div><font size="2"   >(10 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 0.760 ms</font></div></div><p></p></pre></div><div>换成GiST索引,</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; drop index idx_tsvector_test ;</font></div><div><font size="2"   >DROP INDEX</font></div><div><font size="2"   >Time: 22.531 ms</font></div><div><font size="2"   >digoal=&gt; create index idx_tsvector_test on tsvector_test using gist (phone_list);</font></div><div><font size="2"   >CREATE INDEX</font></div><div><font size="2"   >Time: 22992.763 ms</font></div></div><div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; select * from tsvector_test where phone_list @@ '1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10'::tsquery;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;phone_list &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----+-------------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; | '1' '2' '3' '4' '5' '6'</font></div><div><font size="2"   >&nbsp; &nbsp; | '2' '3' '4' '5' '6' '7'</font></div><div><font size="2"   >&nbsp; &nbsp; | '3' '4' '5' '6' '7' '8'</font></div><div><font size="2"   >&nbsp; &nbsp; | '4' '5' '6' '7' '8' '9'</font></div><div><font size="2"   >&nbsp; &nbsp; | '10' '5' '6' '7' '8' '9'</font></div><div><font size="2"   >&nbsp; &nbsp; | '10' '11' '6' '7' '8' '9'</font></div><div><font size="2"   >&nbsp; &nbsp; | '10' '11' '12' '7' '8' '9'</font></div><div><font size="2"   >&nbsp; &nbsp; | '10' '11' '12' '13' '8' '9'</font></div><div><font size="2"   >&nbsp; &nbsp; | '10' '11' '12' '13' '14' '9'</font></div><div><font size="2"   >&nbsp; &nbsp; | '10' '11' '12' '13' '14' '15'</font></div><div><font size="2"   >(10 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 290.487 ms</font></div><div><font size="2"   >digoal=&gt; explain analyze select * from tsvector_test where phone_list @@ '1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10'::tsquery;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >---------------------------</font></div><div><font size="2"   >&nbsp;Bitmap Heap Scan on tsvector_test &nbsp;(cost=521.77..6891.33 rows=24445 width=71) (actual time=287.089..287.109 rows=10 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Recheck Cond: (phone_list @@ '( ( ( ( ( ( ( ( ''1'' | ''2'' ) | ''3'' ) | ''4'' ) | ''5'' ) | ''6'' ) | ''7'' ) | ''8'' ) | ''9''</font></div><div><font size="2"   >&nbsp;) | ''10'''::tsquery)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on idx_tsvector_test &nbsp;(cost=0.00..515.66 rows=24445 width=0) (actual time=287.059..287.059 rows=10 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (phone_list @@ '( ( ( ( ( ( ( ( ''1'' | ''2'' ) | ''3'' ) | ''4'' ) | ''5'' ) | ''6'' ) | ''7'' ) | ''8'' ) | '</font></div><div><font size="2"   >'9'' ) | ''10'''::tsquery)</font></div><div><font size="2"   >&nbsp;Total runtime: 287.160 ms</font></div><div><font size="2"   >(5 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 287.809 ms</font></div></div><p></p></pre></div><div><br></div><div>显然在这个例子中, 使用GiST的效率远远低于GIN的效率。</div><div>另外如果能够给这几个operator class加上近似度排序的operator就更实用了。</div><div>pg_trgm的近似度排序支持的operator :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; OPERATOR &nbsp; &nbsp; &nbsp; &nbsp;2 &nbsp; &nbsp; &nbsp; &lt;-&gt; (text, text) FOR ORDER BY pg_catalog.float_ops,</font></p></pre></div><div><br></div><div>gin索引对update操作和insert操作影响较大 , 具体优化方法是加大work_mem, 见</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201341625735128/"   >http://blog.163.com/digoal@126/blog/static/163877040201341625735128/</a></div><div><br></div><div>【参考】</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/gin.html"   >http://www.postgresql.org/docs/9.1/static/gin.html</a></div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/gist.html"   >http://www.postgresql.org/docs/9.1/static/gist.html</a></div></div>
	</div>
</div>
</body>
</html>