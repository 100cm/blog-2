<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL pg_trgm usage,字符串拆分,相似匹配,模糊查询</h2>
	<h5 id="">2011-10-18 9:43:33&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201191882553803/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>pg_trgm是一个比较有意思的模块, 主要功能是比较两个字符串的相似度, 可以使用GIN或者GIST索引。</div><div>要比较字符串的相似度，首先要对原来的字符串进行拆分 ：</div><div>下面是trigram or trigraph 拆分规则(不区分大小写) ：</div><div>字符串被前置两个空格，后置一个空格，然后按3个连续的字符为分组进行拆分。</div><div>例如 ：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select show_trgm('digoal');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; show_trgm &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------------------------------</font></div><div><font size="2"   >&nbsp;{" &nbsp;d"," di","al ",dig,goa,igo,oal}</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=&gt; select show_trgm('DIGOAL123456');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; show_trgm &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;{" &nbsp;d"," di",123,234,345,456,"56 ",al1,dig,goa,igo,l12,oal}</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>拆分完后, 比较两个字符的相似度，算法是(两个字符串相同trigram的个数)除以(总共被拆成多少个trigram)，</div><div>例如上面两个字符串'digoal'和'DIGOAL123456'的相似度=6/14</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; select similarity('digoal','DIGOAL123456');</font></div><div><font size="2"   >&nbsp;similarity&nbsp;</font></div><div><font size="2"   >------------</font></div><div><font size="2"   >&nbsp; &nbsp;0.428571</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=&gt; select 6/14.0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------</font></div><div><font size="2"   >&nbsp;0.42857142857142857143</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>接下来看看pg_trgm这个extension新增的几个常用的函数和操作符 :&nbsp;</div><div>similarity(text, text)</div><div>前面的例子已经用到了这个函数，用来计算两个字符串的相似度。</div><div>show_trgm(text)</div><div>前面的例子已经用到了这个函数，用来返回字符串拆分后的trigram。</div><div>show_limit()</div><div>这个函数用来返回目前系统中设置的相似度阈值，大于或者等于这个阈值的两个字符串，similarity_op(text, text)或 字符串1 % 字符串2 返回true.</div><div>例如：</div><div><br></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; select similarity('diga','digoal1');</font></div><div><font size="2"   >&nbsp;similarity&nbsp;</font></div><div><font size="2"   >------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.3</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=&gt; select similarity_op('diga','digoal1');</font></div><div><font size="2"   >&nbsp;similarity_op&nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp;t</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; select 'diga' % 'digoal1';</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;t</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=&gt; select show_limit();</font></div><div><font size="2"   >&nbsp;show_limit&nbsp;</font></div><div><font size="2"   >------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.3</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>set_limit(real)</div><div>这个函数用来设置相似度阈值。</div><div>例如：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select set_limit(0.4);</font></div><div><font size="2"   >&nbsp;set_limit&nbsp;</font></div><div><font size="2"   >-----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;0.4</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=&gt; select 'diga' % 'digoal1';</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;f</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=&gt; select similarity_op('diga','digoal1');</font></div><div><font size="2"   >&nbsp;similarity_op&nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp;f</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>接下来看看pg_trgm新增的两个操作符 :&nbsp;</div><div>% 这个操作符前面的例子已经使用到了，用来返回两个字符串是否相似。</div><div>&lt;-&gt; 这个操作符返回两个字符串相似度的距离。（1减两个字符串的相似度）</div><div>例如：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select 'digoal' &lt;-&gt; 'digoal';</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>表示两个字符串相同。</div><div><br></div><div>接下来要看的时pg_trgm新增的几个索引操作类：</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >-- create the operator class for gist</font></div><div><font size="2"   >CREATE OPERATOR CLASS gist_trgm_ops</font></div><div><font size="2"   >FOR TYPE text USING gist</font></div><div><font size="2"   >AS</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; OPERATOR &nbsp; &nbsp; &nbsp;1 &nbsp; &nbsp; &nbsp; % (text, text),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; FUNCTION &nbsp; &nbsp; &nbsp; &nbsp;1 &nbsp; &nbsp; &nbsp; gtrgm_consistent (internal, text, int, oid, internal),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; FUNCTION &nbsp; &nbsp; &nbsp; &nbsp;2 &nbsp; &nbsp; &nbsp; gtrgm_union (bytea, internal),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; FUNCTION &nbsp; &nbsp; &nbsp; &nbsp;3 &nbsp; &nbsp; &nbsp; gtrgm_compress (internal),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; FUNCTION &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp; &nbsp; gtrgm_decompress (internal),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; FUNCTION &nbsp; &nbsp; &nbsp; &nbsp;5 &nbsp; &nbsp; &nbsp; gtrgm_penalty (internal, internal, internal),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; FUNCTION &nbsp; &nbsp; &nbsp; &nbsp;6 &nbsp; &nbsp; &nbsp; gtrgm_picksplit (internal, internal),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; FUNCTION &nbsp; &nbsp; &nbsp; &nbsp;7 &nbsp; &nbsp; &nbsp; gtrgm_same (gtrgm, gtrgm, internal),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; STORAGE &nbsp; &nbsp; &nbsp; &nbsp; gtrgm;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Add operators and support functions that are new in 9.1. &nbsp;We do it like</font></div><div><font size="2"   >-- this, leaving them "loose" in the operator family rather than bound into</font></div><div><font size="2"   >-- the gist_trgm_ops opclass, because that's the only state that can be</font></div></div><div><div><font size="2"   >-- reproduced during an upgrade from 9.0 (see pg_trgm--unpackaged--1.0.sql).</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >ALTER OPERATOR FAMILY gist_trgm_ops USING gist ADD</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; OPERATOR &nbsp; &nbsp; &nbsp; &nbsp;2 &nbsp; &nbsp; &nbsp; &lt;-&gt; (text, text) FOR ORDER BY pg_catalog.float_ops,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; OPERATOR &nbsp; &nbsp; &nbsp; &nbsp;3 &nbsp; &nbsp; &nbsp; pg_catalog.~~ (text, text),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; OPERATOR &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp; &nbsp; pg_catalog.~~* (text, text),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; FUNCTION &nbsp; &nbsp; &nbsp; &nbsp;8 (text, text) &nbsp;gtrgm_distance (internal, text, int, oid);</font></div></div><p></p></pre></div><div><div>因此where 条件使用&nbsp;% (text, text) ,&nbsp;pg_catalog.~~ (text, text) ,&nbsp;pg_catalog.~~* (text, text) 时 可以使用gist索引。</div><div>&lt;-&gt; (text, text) FOR ORDER BY pg_catalog.float_ops 用于排序。</div><div><br></div><div>例如：</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create table test_pg_trgm (id serial primary key,info text);</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE will create implicit sequence "test_pg_trgm_id_seq" for serial column "test_pg_trgm.id"</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "test_pg_trgm_pkey" for table "test_pg_trgm"</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=&gt; insert into test_pg_trgm (info) select generate_series(1,1000000)||'digoal';</font></div><div><font size="2"   >INSERT 0 1000000</font></div><p></p></pre></div><div>相似度匹配查询</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; &nbsp;select count(*) from test_pg_trgm where info % '%123%oal%';</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; 1144</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 2958.313 ms</font></div><p></p></pre></div><div>全表扫描2958毫秒.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; create index idx_test_pg_trgm_1 on test_pg_trgm using gist (info gist_trgm_ops);&nbsp;</font></div><div><font size="2"   >CREATE INDEX</font></div></div><div><div><font size="2"   >digoal=&gt; &nbsp;select count(*) from test_pg_trgm where info % '%123%oal%';</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; 1144</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 276.247 ms</font></div></div><p></p></pre></div></div><div>走索引276毫秒。</div><div>模糊查询</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select count(*) from test_pg_trgm where info ilike '%123444%al%';</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 577.213 ms</font></div><p></p></pre></div><div>全表扫描577毫秒.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select count(*) from test_pg_trgm where info ilike '%123444%al%';</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 17.080 ms</font></div><p></p></pre></div><div>走索引17毫秒。</div><div>如果结果集大的情况下，和其他索引扫描一样可能比全表慢。</div><div>接下来是排序操作符&lt;-&gt;的例子 ：<br></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; explain verbose select * from test_pg_trgm order by info &lt;-&gt; '1234digoal' limit 1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Limit &nbsp;(cost=0.00..0.05 rows=1 width=16)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, ((info &lt;-&gt; '1234digoal'::text))</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Index Scan using idx_test_pg_trgm_1 on digoal.test_pg_trgm &nbsp;(cost=0.00..54110.46 rows=1010000 width=16)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id, info, (info &lt;-&gt; '1234digoal'::text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Order By: (test_pg_trgm.info &lt;-&gt; '1234digoal'::text)</font></div><div><font size="2"   >(5 rows)</font></div><div><font size="2"   >Time: 0.372 ms</font></div></div><div><div><font size="2"   >digoal=&gt; select * from test_pg_trgm order by info &lt;-&gt; '1234digoal' limit 1;</font></div><div><font size="2"   >&nbsp; id &nbsp; | &nbsp; &nbsp;info &nbsp; &nbsp;</font></div><div><font size="2"   >-------+------------</font></div><div><font size="2"   >&nbsp;11234 | 1234digoal</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 28.504 ms</font></div></div><p></p></pre></div><div><div>走索引28毫秒。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; drop index idx_test_pg_trgm_1 ;</font></div><div><font size="2"   >DROP INDEX</font></div><div><font size="2"   >Time: 71.590 ms</font></div><div><font size="2"   >digoal=&gt; select * from test_pg_trgm order by info &lt;-&gt; '1234digoal' limit 1;</font></div><div><font size="2"   >&nbsp; id &nbsp;| &nbsp; &nbsp;info &nbsp; &nbsp;</font></div><div><font size="2"   >------+------------</font></div><div><font size="2"   >&nbsp;1234 | 1234digoal</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 3219.032 ms</font></div><p></p></pre></div></div><div>全表扫描3219毫秒。</div><div><br></div><div>下面看看GIN相关。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-- create the operator class for gin</font></div><div><font size="2"   >CREATE OPERATOR CLASS gin_trgm_ops</font></div><div><font size="2"   >FOR TYPE text USING gin</font></div><div><font size="2"   >AS</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; OPERATOR &nbsp; &nbsp; &nbsp;1 &nbsp; &nbsp; &nbsp; % (text, text),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; FUNCTION &nbsp; &nbsp; &nbsp; &nbsp;1 &nbsp; &nbsp; &nbsp; btint4cmp (int4, int4),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; FUNCTION &nbsp; &nbsp; &nbsp; &nbsp;2 &nbsp; &nbsp; &nbsp; gin_extract_value_trgm (text, internal),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; FUNCTION &nbsp; &nbsp; &nbsp; &nbsp;3 &nbsp; &nbsp; &nbsp; gin_extract_query_trgm (text, internal, int2, internal, internal, internal, internal),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; FUNCTION &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp; &nbsp; gin_trgm_consistent (internal, int2, text, int4, internal, internal, internal, internal),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; STORAGE &nbsp; &nbsp; &nbsp; &nbsp; int4;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Add operators that are new in 9.1.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >ALTER OPERATOR FAMILY gin_trgm_ops USING gin ADD</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; OPERATOR &nbsp; &nbsp; &nbsp; &nbsp;3 &nbsp; &nbsp; &nbsp; pg_catalog.~~ (text, text),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; OPERATOR &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp; &nbsp; pg_catalog.~~* (text, text);</font></div><p></p></pre></div></div><div><div style="line-height: 22px;"   >相比GIST，排序少了&lt;-&gt;操作符。</div></div><div style="line-height: 22px;"   >例如：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create index idx_test_pg_trgm_1 on test_pg_trgm using gin (info gin_trgm_ops);&nbsp;</font></div><div><font size="2"   >CREATE INDEX</font></div><div><font size="2"   >Time: 12918.872 ms</font></div><div><font size="2"   >digoal=&gt; explain verbose select * from test_pg_trgm order by info &lt;-&gt; '1234digoal' limit 1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Limit &nbsp;(cost=24003.00..24003.00 rows=1 width=16)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, ((info &lt;-&gt; '1234digoal'::text))</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=24003.00..26528.00 rows=1010000 width=16)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id, info, ((info &lt;-&gt; '1234digoal'::text))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: ((test_pg_trgm.info &lt;-&gt; '1234digoal'::text))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on digoal.test_pg_trgm &nbsp;(cost=0.00..18953.00 rows=1010000 width=16)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id, info, (info &lt;-&gt; '1234digoal'::text)</font></div><div><font size="2"   >(7 rows)</font></div><div><font size="2"   >Time: 0.707 ms</font></div><div><font size="2"   >digoal=&gt; select * from test_pg_trgm order by info &lt;-&gt; '1234digoal' limit 1;</font></div><div><font size="2"   >&nbsp; id &nbsp;| &nbsp; &nbsp;info &nbsp; &nbsp;</font></div><div><font size="2"   >------+------------</font></div><div><font size="2"   >&nbsp;1234 | 1234digoal</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 3220.476 ms</font></div><p></p></pre></div><div>由于GIN没有&lt;-&gt; order by操作符，所以全表扫描，耗时3220毫秒。</div><div>相似度和模糊查询依然可以走GIN索引，如下。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select count(*) from test_pg_trgm where info like '%123444%al%';</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 4.318 ms</font></div><div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; select count(*) from test_pg_trgm where info ilike '%123444%al%';</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;count&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >-------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp;1</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   >Time: 4.318 ms</font></div></div><div><font size="2"   >digoal=&gt; select count(*) from test_pg_trgm where info % '123444al';</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp; 22</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 369.328 ms</font></div><p></p></pre></div><div><br></div><div>pg_trgm的另一个应用场景是全文扫描的辅助，用于修正拼写错误的匹配。如digoal,拼写成dagoal，全文扫描无法匹配。但是用近似匹配就可以。</div><div><br></div><div>不常用的请参考pg_trgm--1.0.sql</div><div><br></div><div><br></div><div>【参考】</div><div>extension :&nbsp;</div><div>pg_trgm--1.0.sql</div><div>pg_trgm.control</div><div>pg_trgm--unpackaged--1.0.sql</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/pgtrgm.html"   >http://www.postgresql.org/docs/9.1/static/pgtrgm.html</a></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">benhaben - 2014-04-26 14:32:48</h5>
				<div>LZ您好，我相对中文做相似度搜索，pg默认并不支持，您有解决方案吗？</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 benhaben - 2014-04-26 14:32:48</h5>
				<div style="width:600px;">HI, pg_trgm本身就支持.</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 benhaben - 2014-04-26 14:32:48</h5>
				<div style="width:600px;">只要<span style=""  >collate不为C即可支持 wchar.</span><div><span style=""  >如果是分词的全文检索, 可以使用全文检索的插件.&nbsp;</span></div><div><span style=""  >&nbsp;参考</span></div><div>http://blog.163.com/digoal@126/blog/static/163877040201422410175698</div></div>
			</div>
			<div id="">
				<h5 id="">tulong199 - 2012-08-02 11:17:33</h5>
				<div>LZ 你好 我现在使用postgreSQL9.1（Win7环境） 建立Gin 和Gist索引的时候一直提示“处理方法 "gin_trgm_ops" 的操作符类 "gin" 不存在”<div>&nbsp;CREATE INDEX all_countries_index ON "AllCountries" USING gin ("字段4" gin_trgm_ops) 这是我的语句 &nbsp; &nbsp; &nbsp; 。。。 &nbsp; 这是怎么回事儿呢？</div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 tulong199 - 2012-08-02 11:17:33</h5>
				<div style="width:600px;">please create extension pg_trgm first.</div>
			</div>
	</div>
</div>
</body>
</html>