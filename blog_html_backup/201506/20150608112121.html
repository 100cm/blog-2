<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Oracle index by table(Associative array) used in PostgreSQL</h2>
	<h5 id="">2015-06-08 11:21:21&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201558102842351/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>Oracle plSQL中支持3种集合变量, index-by table, varray, nest table。</div><div><div><img title="Oracle index by table(Associative array) used in PostgreSQL - 德哥@Digoal - PostgreSQL research"   alt="Oracle index by table(Associative array) used in PostgreSQL - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/AL6WQMQ0nvx24bEicVrqlw==/6608509085632427581.png"   ></div><div>其中index-by table是不限元素个数，支持字符串或INT下标。</div>用法举例：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >DECLARE</font></div><div><font size="2"   >&nbsp; -- Associative array indexed by string:</font></div><div><font size="2"   >&nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; TYPE population IS TABLE OF NUMBER &nbsp;-- Associative array type</font></div><div><font size="2"   >&nbsp; &nbsp; INDEX BY VARCHAR2(64); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-- &nbsp;indexed by string</font></div><div><font size="2"   >&nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; city_population &nbsp;population; &nbsp; &nbsp; &nbsp; &nbsp;-- Associative array variable</font></div><div><font size="2"   >&nbsp; i &nbsp;VARCHAR2(64); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-- Scalar variable</font></div><div><font size="2"   >&nbsp;&nbsp;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >&nbsp; -- Add elements (key-value pairs) to associative array:</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; city_population('Smallville') &nbsp;:= 2000;</font></div><div><font size="2"   >&nbsp; city_population('Midland') &nbsp; &nbsp; := 750000;</font></div><div><font size="2"   >&nbsp; city_population('Megalopolis') := 1000000;</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; -- Change value associated with key 'Smallville':</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; city_population('Smallville') := 2001;</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; -- Print associative array:</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; i := city_population.FIRST; &nbsp;-- Get first element of array</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; WHILE i IS NOT NULL LOOP</font></div><div><font size="2"   >&nbsp; &nbsp; DBMS_Output.PUT_LINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; ('Population of ' || i || ' is ' || city_population(i));</font></div><div><font size="2"   >&nbsp; &nbsp; i := city_population.NEXT(i); &nbsp;-- Get next element of array</font></div><div><font size="2"   >&nbsp; END LOOP;</font></div><div><font size="2"   >END;</font></div><div><font size="2"   >/</font></div><div><font size="2"   >Result:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Population of Megalopolis is 1000000</font></div><div><font size="2"   >Population of Midland is 750000</font></div><div><font size="2"   >Population of Smallville is 2001</font></div><div><font size="2"   >Example 5-2 defines a type of associative array indexed by PLS_INTEGER and a function that returns an associative array of that type.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Example 5-2 Function Returns Associative Array Indexed by PLS_INTEGER</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >DECLARE</font></div><div><font size="2"   >&nbsp; TYPE sum_multiples IS TABLE OF PLS_INTEGER INDEX BY PLS_INTEGER;</font></div><div><font size="2"   >&nbsp; n &nbsp;PLS_INTEGER := 5; &nbsp; -- number of multiples to sum for display</font></div><div><font size="2"   >&nbsp; sn PLS_INTEGER := 10; &nbsp;-- number of multiples to sum</font></div><div><font size="2"   >&nbsp; m &nbsp;PLS_INTEGER := 3; &nbsp; -- multiple</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; FUNCTION get_sum_multiples (</font></div><div><font size="2"   >&nbsp; &nbsp; multiple IN PLS_INTEGER,</font></div><div><font size="2"   >&nbsp; &nbsp; num &nbsp; &nbsp; &nbsp;IN PLS_INTEGER</font></div><div><font size="2"   >&nbsp; ) RETURN sum_multiples</font></div><div><font size="2"   >&nbsp; IS</font></div><div><font size="2"   >&nbsp; &nbsp; s sum_multiples;</font></div><div><font size="2"   >&nbsp; BEGIN</font></div><div><font size="2"   >&nbsp; &nbsp; FOR i IN 1..num LOOP</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; s(i) := multiple * ((i * (i + 1)) / 2); &nbsp;-- sum of multiples</font></div><div><font size="2"   >&nbsp; &nbsp; END LOOP;</font></div><div><font size="2"   >&nbsp; &nbsp; RETURN s;</font></div><div><font size="2"   >&nbsp; END get_sum_multiples;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >&nbsp; DBMS_OUTPUT.PUT_LINE (</font></div><div><font size="2"   >&nbsp; &nbsp; 'Sum of the first ' || TO_CHAR(n) || ' multiples of ' ||</font></div><div><font size="2"   >&nbsp; &nbsp; TO_CHAR(m) || ' is ' || TO_CHAR(get_sum_multiples (m, sn)(n))</font></div><div><font size="2"   >&nbsp; );</font></div><div><font size="2"   >END;</font></div><div><font size="2"   >/</font></div><div><font size="2"   >Result:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Sum of the first 5 multiples of 3 is 45</font></div><p></p></pre></div><wbr><div>在PostgreSQL plpgsql函数中对应的用法：</div><div>PostgreSQL中不需要指定数组长度，可以存储任意个元素。</div><div>但是不能使用字符串下标。</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# create table t1(id int,info text);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=#&nbsp;do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v _t1;  -- _t1表示t1表的数组类型</font></div><div><font size="2"   >&nbsp; v1 t1;&nbsp;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; v1.id := 10;&nbsp;</font></div><div><font size="2"   >&nbsp; v1.info := 'abc';&nbsp;</font></div><div><font size="2"   >&nbsp; v[1] := v1;</font></div><div><font size="2"   >&nbsp; v[2] := '(11,"hello")';</font></div><div><font size="2"   >&nbsp; v1.id := 100;</font></div><div><font size="2"   >&nbsp; v1.info := 'i am digoal';</font></div><div><font size="2"   >&nbsp; v[3] := v1;</font></div><div><font size="2"   >&nbsp; foreach v1 in array v loop</font></div><div><font size="2"   >&nbsp; &nbsp; raise notice '%, %, %', v1, v1.id, v1.info;</font></div><div><font size="2"   >&nbsp; end loop;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div></div><div><div><font size="2"   >NOTICE: &nbsp;00000: (10,abc), 10, abc</font></div><div><font size="2"   >LOCATION: &nbsp;exec_stmt_raise, pl_exec.c:3074</font></div><div><font size="2"   >NOTICE: &nbsp;00000: (11,hello), 11, hello</font></div><div><font size="2"   >LOCATION: &nbsp;exec_stmt_raise, pl_exec.c:3074</font></div><div><font size="2"   >NOTICE: &nbsp;00000: (100,"i am digoal"), 100, i am digoal</font></div><div><font size="2"   >LOCATION: &nbsp;exec_stmt_raise, pl_exec.c:3074</font></div><div><font size="2"   >DO</font></div></div><p></p></pre></div><div>如果要存储非结构化数据，可以使用jsonb或者hstore和数组的组合。</div><div>不过目前在plpgsql中只能对非结构化数据一次性赋值，不能部分赋值。例如：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >postgres=# </span>do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><span style="line-height: 28px;"   ><font size="2"   >&nbsp; v1 hstore := '';</font></span></div><div><font size="2"   >&nbsp; ky text;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; v1 := v1 ||  '"a"=&gt;1'::hstore;&nbsp;</font></div><div><font size="2"   >&nbsp; v1 := v1 ||&nbsp;<span style="line-height: 28px;"   >hstore('b', '2');&nbsp;-- 另一种hstore value写法</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   >   v1 := v1 ||  '"b"=&gt;100'::hstore;  -- 覆盖或修改b的值</span></font></div><div><font size="2"   >&nbsp; foreach ky in array akeys(v1) loop</font></div><div><font size="2"   >&nbsp; &nbsp; raise notice '%, %', ky, v1-&gt;ky;     -- hstore-&gt;key 获取指定key的value</font></div><div><font size="2"   >&nbsp; end loop;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >NOTICE:  00000: a, 1<br>LOCATION:  exec_stmt_raise, pl_exec.c:3074<br>NOTICE:  00000: b, 100<br>LOCATION:  exec_stmt_raise, pl_exec.c:3074<br>DO</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://docs.oracle.com/database/121/LNPLS/composites.htm#LNPLS005"   >http://docs.oracle.com/database/121/LNPLS/composites.htm#LNPLS005</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="Oracle index by table(Associative array) used in PostgreSQL - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>