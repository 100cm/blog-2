<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">阿里云RDS for PostgreSQL试用报告 - 6</h2>
	<h5 id="">2015-06-19 10:48:18&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020155199222755/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div><div>阿里云的RDS for PostgreSQL目前提供的备份为物理备份，备份粒度可以自己设置，最频繁的基础备份可以做到一天一次。</div><div>有了这个备份和归档日志，我们可以做到基于任意时间点（实际上是事务提交或回滚点的粒度）的恢复。</div><div>在RDS的控制台可以看到：</div><div><div><img title="阿里云RDS for PostgreSQL试用报告 - 6 - 德哥@Digoal - PostgreSQL research"   alt="阿里云RDS for PostgreSQL试用报告 - 6 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/Lj-QK1pmD4A0ndxKIENjPw==/2438417723262679885.png"   ></div>&nbsp;<div><img title="阿里云RDS for PostgreSQL试用报告 - 6 - 德哥@Digoal - PostgreSQL research"   alt="阿里云RDS for PostgreSQL试用报告 - 6 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/NTvYYsl8GtRnc9fMboSTTg==/6630193653955627404.png"   ></div>&nbsp;<div><img title="阿里云RDS for PostgreSQL试用报告 - 6 - 德哥@Digoal - PostgreSQL research"   alt="阿里云RDS for PostgreSQL试用报告 - 6 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/6PhNTqbv_d1Ipa-cb3tRfA==/2879207536791326529.png"   ></div><br></div><div>接下来我将演示一下如何实现以及如何设计一个好的恢复方案。</div><div>甚至我们在了解其中的原理后，如果阿里云将来提供基于时间点的恢复服务，我们应该如何更好的与之结合来使用。</div><div><br></div><div>要恢复到任意时间点，我们就必须告诉恢复进程一个点，这个点可以是时间，字符串，或者XID。</div><div>1. 时间很好理解，其实就是触及这个时间后的XLOG中的第一个事务结束位置作为停止点。</div><div>2. 字符串，这个是需要通过pg_create_restore_point函数来创建的一个还原点，需要超级用户调用这个函数。</div><div>3. XID也很好理解，就是恢复到指定事务的结束位置。</div><div>既然我们已经知道了数据库可以恢复到指定的这几个位置，我们怎么来结合呢？</div><div>例如我们在做一笔比较重要的操作前，可以创建一个还原点（但是需要超级用户），不适合阿里云RDS。</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >postgres=# select pg_create_restore_point('digoal');</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;pg_create_restore_point&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >-------------------------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;1D6/FB17EC08</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div style="line-height: 28px;"   >阿里云为了防止一些用户的误操作，只开放了普通用户给用户使用，所以有一些东西都无法操作，例如创建检查点，切换XLOG，创建还原点都无法操作。</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >postgres=&gt; checkpoint;</font></div><div style="line-height: 28px;"   ><font size="2"   >ERROR: &nbsp;must be superuser to do CHECKPOINT</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >postgres=&gt; select pg_switch_xlog();</font></div><div style="line-height: 28px;"   ><font size="2"   >ERROR: &nbsp;must be superuser to switch transaction log files</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >postgres=&gt; select pg_create_restore_point('ab');</font></div><div style="line-height: 28px;"   ><font size="2"   >ERROR: &nbsp;must be superuser to create a restore point</font></div></div></div><p></p></pre></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><br></div></div></div></div><div>时间其实是一个比较模糊的概念，所以也不建议使用，除非是我们没有其他信息，才使用时间。</div><div>XID是一个很不错的信息，我们在阿里云就用它了。</div><div>首先要创建一个记录还原点XID的表。记录XID，时间，以及描述信息。（来代替<span style="line-height: 28px;"   >pg_create_restore_point系统函数的功能</span><span style="line-height: 28px;"   >）</span></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; create table restore_point(id serial primary key, xid int8, crt_time timestamp default now(), point text);</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div></div><div>创建一个函数，代替<span style="line-height: 28px;"   >pg_create_restore_point的功能，插入还原点。</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; create or replace function create_restore_point(i_point text) returns void as $$</font></div><div><font size="2"   >declare&nbsp;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; insert into restore_point(xid,point) values (txid_current(),i_point);</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><p></p></pre></div><div>插入一个还原点</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; select create_restore_point('digoal');</font></div><div><font size="2"   >&nbsp;create_restore_point&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>查询这个表的信息：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; select * from restore_point;</font></div><div><font size="2"   >&nbsp;id | &nbsp;xid &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| point &nbsp;</font></div><div><font size="2"   >----+--------+----------------------------+--------</font></div><div><font size="2"   >&nbsp; 1 | 561426 | 2015-06-19 09:18:57.525475 | digoal</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=&gt; select * from restore_point where point='digoal';</font></div><div><font size="2"   >&nbsp;id | &nbsp;xid &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| point &nbsp;</font></div><div><font size="2"   >----+--------+----------------------------+--------</font></div><div><font size="2"   >&nbsp; 1 | 561426 | 2015-06-19 09:18:57.525475 | digoal</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div><br></div><div>接下来要模拟一下还原：</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; create table test(id int,info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=&gt; insert into test select generate_series(1,1000),md5(random()::text);</font></div><div><font size="2"   >INSERT 0 1000</font></div><p></p></pre></div><div>记录当前哈希值。用于恢复后的比对。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; select sum(hashtext(t.*::text)) from test t;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;sum &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp;-69739904784</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div>接下来我要做一笔删除操作，在删除前，我先创建一条还原点信息。</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=&gt; select create_restore_point('before delete test');</font></div><div><font size="2"   >&nbsp;create_restore_point&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=&gt; delete from test;</font></div><div><font size="2"   >DELETE 1000</font></div></div><div><div><font size="2"   >postgres=&gt; select * from restore_point where point='before delete test';</font></div><div><font size="2"   >&nbsp;id | &nbsp;xid &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; point &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+--------+----------------------------+--------------------</font></div><div><font size="2"   >&nbsp; 2 | 561574 | 2015-06-19 09:45:28.030295 | before delete test</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>我只需要恢复到<span style="line-height: 28px;"   >561574</span><span style="line-height: 28px;"   >&nbsp;即可。接下来就是模拟恢复了。</span></div><div>但是这个文件可能还没有归档，而<span style="line-height: 28px;"   >pg_switch_xlog()函数又不能用，我们只能主动产生一些XLOG，让RDS触发归档。</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; select pg_xlogfile_name(pg_current_xlog_location());</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;pg_xlogfile_name &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;000000010000000200000041</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=&gt; insert into test select generate_series(1,100000);</font></div><div><font size="2"   >INSERT 0 100000</font></div><div><font size="2"   >postgres=&gt; insert into test select generate_series(1,100000);</font></div><div><font size="2"   >INSERT 0 100000</font></div><div><font size="2"   >postgres=&gt; select pg_xlogfile_name(pg_current_xlog_location());</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;pg_xlogfile_name &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;000000010000000200000042</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>已经切换。接下来我们需要下载阿里云RDS的备份和归档到本地。</div><div>并且在本地需要安装一个postgresql, 并且与阿里云RDS的编译配置参数一致(<span style="line-height: 28px;"   >例如数据块的大小</span><span style="line-height: 28px;"   >)，最好使用的模块也一致，但是这里没有用到其他模块，所以无所谓。</span></div><div><span style="line-height: 28px;"   >给阿里云RDS一个建议，最好提供用户一个软件打包，方便用户恢复，降低恢复门槛。</span></div><div><span style="line-height: 28px;"   >编译项可以使用pg_config命令查看，但是RDS我们没有办法这么查看。通过pg_settings来看吧。</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=&gt; select name,setting,unit from pg_settings where category='Preset Options';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| setting | unit&nbsp;</font></div><div><font size="2"   >-----------------------+---------+------</font></div><div><font size="2"   >&nbsp;block_size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 8192 &nbsp; &nbsp;| &nbsp;</font></div><div><font size="2"   >&nbsp;data_checksums &nbsp; &nbsp; &nbsp; &nbsp;| on &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;integer_datetimes &nbsp; &nbsp; | on &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;max_function_args &nbsp; &nbsp; | 100 &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;max_identifier_length | 63 &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;max_index_keys &nbsp; &nbsp; &nbsp; &nbsp;| 32 &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;segment_size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 131072 &nbsp;| 8kB</font></div><div><font size="2"   >&nbsp;server_version &nbsp; &nbsp; &nbsp; &nbsp;| 9.4.1 &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;server_version_num &nbsp; &nbsp;| 90401 &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;wal_block_size &nbsp; &nbsp; &nbsp; &nbsp;| 8192 &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;wal_segment_size &nbsp; &nbsp; &nbsp;| 2048 &nbsp; &nbsp;| 8kB</font></div><div><font size="2"   >(11 rows)</font></div></div><div><div><font size="2"   >postgres=&gt; select version();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;version &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;PostgreSQL 9.4.1 on x86_64-unknown-linux-gnu, compiled by gcc (GCC) 4.4.6 20110731 (Red Hat 4.4.6-3), 64-bit</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>本地编译安装PostgreSQL 9.4.1，编译参数与RDS一致。阿里云RDS这几个参数都是默认的。</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; --with-blocksize=BLOCKSIZE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set table block size in kB [8]</font></div><div><font size="2"   >&nbsp; --with-segsize=SEGSIZE &nbsp;set table segment size in GB [1]</font></div><div><font size="2"   >&nbsp; --with-wal-blocksize=BLOCKSIZE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set WAL block size in kB [8]</font></div><div><font size="2"   >&nbsp; --with-wal-segsize=SEGSIZE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set WAL segment size in MB [16]</font></div></div><div><font size="2"   ><br></font></div><div><div style="line-height: 28px;"   ><font size="2"   ># useradd digoal</font></div><div style="line-height: 28px;"   ><font size="2"   ># su - digoal</font></div><div style="line-height: 28px;"   ><font size="2"   >$ vi .bash_profile</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   ># add by digoal</font></div><div style="line-height: 28px;"   ><font size="2"   >export PS1="$USER@`/bin/hostname -s`-&gt; "</font></div><div style="line-height: 28px;"   ><font size="2"   >export PGPORT=1931</font></div><div style="line-height: 28px;"   ><font size="2"   >export PGDATA=/home/digoal/pg_root</font></div><div style="line-height: 28px;"   ><font size="2"   >export LANG=en_US.utf8</font></div><div style="line-height: 28px;"   ><font size="2"   >export PGHOME=/home/digoal/pgsql9.4.1</font></div><div style="line-height: 28px;"   ><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH</font></div><div style="line-height: 28px;"   ><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div style="line-height: 28px;"   ><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div style="line-height: 28px;"   ><font size="2"   >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div style="line-height: 28px;"   ><font size="2"   >export PGHOST=$PGDATA</font></div><div style="line-height: 28px;"   ><font size="2"   >export PGDATABASE=postgres</font></div><div style="line-height: 28px;"   ><font size="2"   >alias rm='rm -i'</font></div><div style="line-height: 28px;"   ><font size="2"   >alias ll='ls -lh'</font></div><div style="line-height: 28px;"   ><font size="2"   >unalias vi</font></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div></div></div><div><font size="2"   ># wget&nbsp;https://ftp.postgresql.org/pub/source/v9.4.1/postgresql-9.4.1.tar.bz2</font></div><div><font size="2"   ># tar -jxvf&nbsp;<span style="line-height: 28px;"   >postgresql-9.4.1.tar.bz2</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   ># cd&nbsp;</span><span style="line-height: 28px;"   >postgresql-9.4.1</span></font></div><div><font size="2"   ># ./configure --prefix=/home/digoal/pgsql9.4.1 --with-pgport=1931 --with-perl --with-python --with-tcl --with-openssl --with-pam --with-ldap --with-libxml --with-libxslt --enable-thread-safety --enable-debug</font></div><div><font size="2"   ># gmake world &amp;&amp; gmake install-world</font></div><p></p></pre></div><div><br></div><div><br></div><div><br></div><div>下载备份和归档文件，解压：</div><div><div style="line-height: 28px;"   >基础备份选择需要恢复的时间点之前的一个备份，归档则选择在此之后的所有归档文件。</div></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >total 453M</font></div><div><font size="2"   >-rw-r--r-- 1 root &nbsp; root &nbsp; &nbsp;17M Jun 19 10:23 000000010000000200000040.tar.gz</font></div><div><font size="2"   >-rw-r--r-- 1 root &nbsp; root &nbsp; &nbsp;17M Jun 19 10:23 000000010000000200000041.tar.gz</font></div><div><font size="2"   >-rw-r--r-- 1 root &nbsp; root &nbsp; 404M Jun 19 10:23 hins668881_xtra_20150618232331.tar.gz</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   ># mkdir /home/digoal/pg_root</font></div><div><font size="2"   ># mv&nbsp;<span style="line-height: 28px;"   >hins668881_xtra_20150618232331.tar.gz /home/digoal/pg_root</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   ># tar -zxvf&nbsp;</span><span style="line-height: 28px;"   >hins668881_xtra_20150618232331.tar.gz</span></font></div><div><div><font size="2"   >[root@db-172-16-3-150 ~]# tar -xvf 000000010000000200000040.tar.gz&nbsp;</font></div><div><font size="2"   >000000010000000200000040</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# tar -xvf 000000010000000200000041.tar.gz&nbsp;</font></div><div><font size="2"   >000000010000000200000041</font></div></div><div><div><font size="2"   >[root@db-172-16-3-150 ~]# mv 000000010000000200000040 /home/digoal/</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# mv 000000010000000200000041 /home/digoal/</font></div></div><div><div><font size="2"   >[root@db-172-16-3-150 ~]# chown -R digoal:digoal /home/digoal</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# chmod -R 700 /home/digoal/pg_root</font></div></div><p></p></pre></div><div><br></div><div>修改配置文件</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >$ vi postgresql.conf</font></div><div><font size="2"   >port=1931</font></div><div><font size="2"   >注释RDS自定义的GUC参数</font></div><div><div style="line-height: 28px;"   ><font size="2"   >#rds_enable_proxy=on</font></div><div style="line-height: 28px;"   ><font size="2"   >#rds_available_extensions='plpgsql,pg_stat_statements,btree_gin,btree_gist,chkpass,citext,cube,dblink,dict_int,earthdistance,hstore,intagg,intarray,isn,ltree,pgcrypto,pgrowlocks,pg_prewarm,pg_trgm,postgres_fdw,sslinfo,tablefunc,tsearch2,unaccent,postgis,postgis_topology,fuzzystrmatch,postgis_tiger_geocoder,plperl,pltcl,plv8,plls,plcoffee,"uuid-ossp"'</font></div><div style="line-height: 28px;"   ><font size="2"   >#rds_enable_admin_user_as_super=on</font></div></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div><div><span style="line-height: 28px;"   >配置recovery.conf</span></div><div>打开hot_standby，恢复到目标点后暂停，如果确认已经到达，使用resume激活。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >$ vi recovery.conf</font></div><div><font size="2"   >standby_mode = 'on'</font></div><div><font size="2"   >restore_command = 'cp /home/digoal/%f %p' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >recovery_target_xid='561574' &nbsp;# 使用我们自建的恢复点的XID</font></div><div><font size="2"   >recovery_target_inclusive=true</font></div><div><font size="2"   >pause_at_recovery_target=true</font></div><p></p></pre></div><div><br></div><div>启动数据库</div><pre class="prettyprint"   ><p></p><div><font size="2"   >$ pg_ctl start</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >检查是否恢复到指定XID</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 1931</font></div><div><font size="2"   >psql (9.4.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=&gt; \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; | Type &nbsp;| Owner &nbsp;</font></div><div><font size="2"   >--------+-----------------+-------+--------</font></div><div><font size="2"   >&nbsp;public | ha_health_check | table | aurora</font></div><div><font size="2"   >&nbsp;public | login_log &nbsp; &nbsp; &nbsp; | table | digoal</font></div><div><font size="2"   >&nbsp;public | restore_point &nbsp; | table | digoal</font></div><div><font size="2"   >&nbsp;public | session &nbsp; &nbsp; &nbsp; &nbsp; | table | digoal</font></div><div><font size="2"   >&nbsp;public | tbl_small &nbsp; &nbsp; &nbsp; | table | digoal</font></div><div><font size="2"   >&nbsp;public | test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| table | digoal</font></div><div><font size="2"   >&nbsp;public | userinfo &nbsp; &nbsp; &nbsp; &nbsp;| table | digoal</font></div><div><font size="2"   >(7 rows)</font></div><p></p></pre></div><div>检查，已经恢复到DELETE test表的数据之前了。</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=&gt; select count(*) from test;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; 1000</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >postgres=&gt; select sum(hashtext(t.*::text)) from test t;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;sum &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp;-69739904784</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div></div><div>接下来就交给你了，导出逻辑备份，还原，或者其他。。。。。。</div><div><br></div><div>[其他]</div><div>1. RDS增加了一些GUC控制参数，例如，</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >rds_enable_proxy=on</font></div><div><font size="2"   >rds_available_extensions='plpgsql,pg_stat_statements,btree_gin,btree_gist,chkpass,citext,cube,dblink,dict_int,earthdistance,hstore,intagg,intarray,isn,ltree,pgcrypto,pgrowlocks,pg_prewarm,pg_trgm,postgres_fdw,sslinfo,tablefunc,tsearch2,unaccent,postgis,postgis_topology,fuzzystrmatch,postgis_tiger_geocoder,plperl,pltcl,plv8,plls,plcoffee,"uuid-ossp"'</font></div><div><font size="2"   >rds_enable_admin_user_as_super=on</font></div><p></p></pre></div><div>还是对云化做了一些修改的：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal@db-172-16-3-150-&gt; cat postgresql.conf</font></div><div><font size="2"   >#</font></div><div><font size="2"   >#Thu Jun 11 22:34:23 CST 2015</font></div><div><font size="2"   >checkpoint_segments=64</font></div><div><font size="2"   >autovacuum_vacuum_scale_factor=0.1</font></div><div><font size="2"   >maintenance_work_mem=16MB</font></div><div><font size="2"   >log_min_duration_statement=1000</font></div><div><font size="2"   >archive_mode=on</font></div><div><font size="2"   >log_lock_waits=on</font></div><div><font size="2"   >max_prepared_transactions=800</font></div><div><font size="2"   >log_rotation_size=10MB</font></div><div><font size="2"   >timezone='PRC'</font></div><div><font size="2"   >archive_command='cp %p /u02/rds427ugtq91telkvtwap/arch/%f'</font></div><div><font size="2"   >track_functions=all</font></div><div><font size="2"   >port=3011</font></div><div><font size="2"   >max_replication_slots=10</font></div><div><font size="2"   >max_connections=100</font></div><div><font size="2"   >hot_standby=on</font></div><div><font size="2"   >lc_numeric='zh_CN.UTF-8'</font></div><div><font size="2"   >pg_stat_statements.max=1000</font></div><div><font size="2"   >checkpoint_completion_target=0.9</font></div><div><font size="2"   >lc_monetary='zh_CN.UTF-8'</font></div><div><font size="2"   >log_line_prefix='\1\n\t%p\t%r\t%u\t%d\t%t\t%e\t\t\t\t\t\t'</font></div><div><font size="2"   >datestyle='iso, ymd'</font></div><div><font size="2"   >wal_keep_segments=80</font></div><div><font size="2"   >superuser_reserved_connections=10</font></div><div><font size="2"   >default_text_search_config='pg_catalog.simple'</font></div><div><font size="2"   >max_wal_senders=5</font></div><div><font size="2"   >track_io_timing=on</font></div><div><font size="2"   >autovacuum_analyze_scale_factor=0.1</font></div><div><font size="2"   >work_mem=4MB</font></div><div><font size="2"   >wal_buffers=7864kB</font></div><div><font size="2"   >pg_stat_statements.track=all</font></div><div><font size="2"   >rds_enable_proxy=on</font></div><div><font size="2"   >logging_collector=on</font></div><div><font size="2"   >log_timezone='UTC'</font></div><div><font size="2"   >log_directory='pg_log'</font></div><div><font size="2"   >listen_addresses='*'</font></div><div><font size="2"   >shared_preload_libraries='pg_stat_statements'</font></div><div><font size="2"   >log_filename='postgresql-%Y-%m-%d_%H%M%S.log'</font></div><div><font size="2"   >wal_level=hot_standby</font></div><div><font size="2"   >hot_standby_feedback=on</font></div><div><font size="2"   >log_truncate_on_rotation=on</font></div><div><font size="2"   >log_rotation_age=0</font></div><div><font size="2"   >lc_time='zh_CN.UTF-8'</font></div><div><font size="2"   >lc_messages='C'</font></div><div><font size="2"   >default_statistics_target=100</font></div><div><font size="2"   >autovacuum_max_workers=5</font></div><div><font size="2"   >rds_available_extensions='plpgsql,pg_stat_statements,btree_gin,btree_gist,chkpass,citext,cube,dblink,dict_int,earthdistance,hstore,intagg,intarray,isn,ltree,pgcrypto,pgrowlocks,pg_prewarm,pg_trgm,postgres_fdw,sslinfo,tablefunc,tsearch2,unaccent,postgis,postgis_topology,fuzzystrmatch,postgis_tiger_geocoder,plperl,pltcl,plv8,plls,plcoffee,"uuid-ossp"'</font></div><div><font size="2"   >log_temp_files=100000</font></div><div><font size="2"   >log_statement='all'</font></div><div><font size="2"   >shared_buffers=256MB</font></div><div><font size="2"   >effective_cache_size=768MB</font></div><div><font size="2"   >autovacuum_vacuum_cost_delay=0</font></div><div><font size="2"   >bgwriter_delay=20ms</font></div><div><font size="2"   >rds_enable_admin_user_as_super=on</font></div><p></p></pre></div><div><br></div><div>2. 从pg_hba.conf可以看出，阿里云的RDS 基于流复制的standby 节点有两个，本地一个，异地一个。</div><div>但是实际上只开了一个异地的流复制节点。并且没有使用slot，原因可能是准备用于同步流复制的。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal@db-172-16-3-150-&gt; grep "^[a-z]" pg_hba.conf&nbsp;</font></div><div><font size="2"   >local &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trust</font></div><div><font size="2"   >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div><div><font size="2"   >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ::1/128 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trust</font></div><div><font size="2"   >local replication pgrds427ugtq91telkvtwap &nbsp; trust</font></div><div><font size="2"   >host all all 0.0.0.0/0 md5</font></div><div><font size="2"   >host replication replicator 10.151.133.24/32 md5</font></div><p></p></pre></div><div><br></div><div>实际开了1个流复制节点：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; select * from pg_stat_replication ;</font></div><div><font size="2"   >&nbsp; pid &nbsp;| usesysid | &nbsp;usename &nbsp; | application_name | client_addr | client_hostname | client_port | backend_start | backend_xmin | sta</font></div><div><font size="2"   >te | sent_location | write_location | flush_location | replay_location | sync_priority | sync_state&nbsp;</font></div><div><font size="2"   >-------+----------+------------+------------------+-------------+-----------------+-------------+---------------+--------------+----</font></div><div><font size="2"   >---+---------------+----------------+----------------+-----------------+---------------+------------</font></div><div><font size="2"   >&nbsp;27049 | &nbsp; &nbsp;16384 | replicator | standby1 &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 561915 | &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=&gt; select * from pg_replication_slots ;</font></div><div><font size="2"   >&nbsp;slot_name | plugin | slot_type | datoid | database | active | xmin | catalog_xmin | restart_lsn&nbsp;</font></div><div><font size="2"   >-----------+--------+-----------+--------+----------+--------+------+--------------+-------------</font></div><div><font size="2"   >(0 rows)</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/recovery-config.html"   >http://www.postgresql.org/docs/9.4/static/recovery-config.html</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="阿里云RDS for PostgreSQL试用报告 - 6 - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>