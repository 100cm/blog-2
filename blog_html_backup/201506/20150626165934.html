<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL earth distance module</h2>
	<h5 id="">2015-06-26 16:59:34&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201552631447227/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL提供了一个扩展模块earthdistance，实际上是将地球构造为一个标准的圆球体（实际上是扁球体），利用cube或point来表示地球上的点。</div><div>其中cube是用来记录球坐标的，通过坐标来表示地球上的点。（实际上是做了一定约束的cube, 即域类型earth）</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-- Define domain for locations on the surface of the earth using a cube</font></div><div><font size="2"   >-- datatype with constraints. cube provides 3D indexing.</font></div><div><font size="2"   >-- The cube is restricted to be a point, no more than 3 dimensions</font></div><div><font size="2"   >-- (for less than 3 dimensions 0 is assumed for the missing coordinates)</font></div><div><font size="2"   >-- and that the point must be very near the surface of the sphere</font></div><div><font size="2"   >-- centered about the origin with the radius of the earth.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >有三个约束</font></div><div><font size="2"   >CREATE DOMAIN earth AS cube</font></div><div><font size="2"   >&nbsp; CONSTRAINT not_point check(cube_is_point(value))</font></div><div><font size="2"   >&nbsp; CONSTRAINT not_3d check(cube_dim(value) &lt;= 3)</font></div><div><font size="2"   >&nbsp; CONSTRAINT on_surface check(abs(cube_distance(value, '(0)'::cube) /</font></div><div><font size="2"   >&nbsp; earth() - 1) &lt; '10e-7'::float8);</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >而point是用来记录纬度和经度的，通过纬度和经度来表示地球上的点。</span></div><div>使用纬度和经度来表示有一定的缺陷，例如有正负，有边界需要注意，用球坐标则不存在这个问题。</div><div><br></div><div>所以需要依赖另外一个模块cube，这个模块是多维数据结构模型，可以表示多维的点，多维的BOX区域。</div><div>例如我要计算北京和杭州的地表距离，只需要提供两个位置经纬度就可以计算，使用earthdistance计算的结果没有使用postgis计算的结果精确，（原因地球是扁球体，而非标准圆球体）PostGIS考虑了这一点。</div><div><br></div><div>例子：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create extension cube;</font></div><div><font size="2"   >create extension earthdistance;</font></div><p></p></pre></div><div><br></div><div>earth()函数，返回地球半径，单位千米。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE FUNCTION earth() RETURNS float8</font></div><div><font size="2"   >LANGUAGE SQL IMMUTABLE</font></div><div><font size="2"   >AS 'SELECT ''6378168''::float8';</font></div><p></p></pre></div><div><br></div><div>创建完后会建立一个域类型earth, 其实是基于cube建的。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from pg_type where typname='earth';</font></div><div><font size="2"   >-[ RECORD 1 ]--+------------</font></div><div><font size="2"   >typname &nbsp; &nbsp; &nbsp; &nbsp;| earth</font></div><div><font size="2"   >typnamespace &nbsp; | 2200</font></div><div><font size="2"   >typowner &nbsp; &nbsp; &nbsp; | 10</font></div><div><font size="2"   >typlen &nbsp; &nbsp; &nbsp; &nbsp; | -1</font></div><div><font size="2"   >typbyval &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >typtype &nbsp; &nbsp; &nbsp; &nbsp;| d</font></div><div><font size="2"   >typcategory &nbsp; &nbsp;| U</font></div><div><font size="2"   >typispreferred | f</font></div><div><font size="2"   >typisdefined &nbsp; | t</font></div><div><font size="2"   >typdelim &nbsp; &nbsp; &nbsp; | ,</font></div><div><font size="2"   >typrelid &nbsp; &nbsp; &nbsp; | 0</font></div><div><font size="2"   >typelem &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"   >typarray &nbsp; &nbsp; &nbsp; | 0</font></div><div><font size="2"   >typinput &nbsp; &nbsp; &nbsp; | domain_in</font></div><div><font size="2"   >typoutput &nbsp; &nbsp; &nbsp;| cube_out</font></div><div><font size="2"   >typreceive &nbsp; &nbsp; | domain_recv</font></div><div><font size="2"   >typsend &nbsp; &nbsp; &nbsp; &nbsp;| -</font></div><div><font size="2"   >typmodin &nbsp; &nbsp; &nbsp; | -</font></div><div><font size="2"   >typmodout &nbsp; &nbsp; &nbsp;| -</font></div><div><font size="2"   >typanalyze &nbsp; &nbsp; | -</font></div><div><font size="2"   >typalign &nbsp; &nbsp; &nbsp; | d</font></div><div><font size="2"   >typstorage &nbsp; &nbsp; | p</font></div><div><font size="2"   >typnotnull &nbsp; &nbsp; | f</font></div><div><font size="2"   >typbasetype &nbsp; &nbsp;| 16545</font></div><div><font size="2"   >typtypmod &nbsp; &nbsp; &nbsp;| -1</font></div><div><font size="2"   >typndims &nbsp; &nbsp; &nbsp; | 0</font></div><div><font size="2"   >typcollation &nbsp; | 0</font></div><div><font size="2"   >typdefaultbin &nbsp;|&nbsp;</font></div><div><font size="2"   >typdefault &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >typacl &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><p></p></pre></div><div><br></div><div>将纬度，经度转换为earth坐标类型。第一个参数表示纬度，第二个参数表示经度。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select ll_to_earth(30.3,120.2);</font></div><div><font size="2"   >-[ RECORD 1 ]--------------------------------------------------------</font></div><div><font size="2"   >ll_to_earth | (-2770071.42546437, 4759459.23949754, 3217961.94533299)</font></div><p></p></pre></div><div><br></div><div>将球坐标转换为经度或纬度。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select latitude(ll_to_earth(30.3,120.2));</font></div><div><font size="2"   >-[ RECORD 1 ]--</font></div><div><font size="2"   >latitude | 30.3</font></div><div><font size="2"   >postgres=# select longitude(ll_to_earth(30.3,120.2));</font></div><div><font size="2"   >-[ RECORD 1 ]----</font></div><div><font size="2"   >longitude | 120.2</font></div><p></p></pre></div><div><br></div><div>直线距离和球体表面距离的换算。</div><div>直线距离转换为球面距离，</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select sec_to_gc(100000);</font></div><div><font size="2"   >-[ RECORD 1 ]--------------</font></div><div><font size="2"   >sec_to_gc | 100001.02425681</font></div><p></p></pre></div><div>球面距离转换为直线距离，</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select gc_to_sec(100001.02425681);</font></div><div><font size="2"   >-[ RECORD 1 ]-----</font></div><div><font size="2"   >gc_to_sec | 100000</font></div><p></p></pre></div></div><div><br></div><div>使用公式换算，用到圆周率pi()和地球半径：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE FUNCTION sec_to_gc(float8)</font></div><div><font size="2"   >RETURNS float8</font></div><div><font size="2"   >LANGUAGE SQL</font></div><div><font size="2"   >IMMUTABLE STRICT</font></div><div><font size="2"   >AS 'SELECT CASE WHEN $1 &lt; 0 THEN 0::float8 WHEN $1/(2*earth()) &gt; 1 THEN pi()*earth() ELSE 2*earth()*asin($1/(2*earth())) END';</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION gc_to_sec(float8)</font></div><div><font size="2"   >RETURNS float8</font></div><div><font size="2"   >LANGUAGE SQL</font></div><div><font size="2"   >IMMUTABLE STRICT</font></div><div><font size="2"   >AS 'SELECT CASE WHEN $1 &lt; 0 THEN 0::float8 WHEN $1/earth() &gt; pi() THEN 2*earth() ELSE 2*earth()*sin($1/(2*earth())) END';</font></div><p></p></pre></div><div><br></div><div>计算两个坐标的球面距离：</div><div>例如北京和杭州的球面距离，约1123公里。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select earth_distance(ll_to_earth(39.9,116.4),ll_to_earth(30.3,120.2));</font></div><div><font size="2"   >-[ RECORD 1 ]--+----------------</font></div><div><font size="2"   >earth_distance | 1122999.5704515</font></div><p></p></pre></div><div>算法，用到了CUBE的<span style="line-height: 28px;"   >cube_distance函数，先计算直线距离，再转换为球体表面距离</span><span style="line-height: 28px;"   >：</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE FUNCTION earth_distance(earth, earth)</font></div><div><font size="2"   >RETURNS float8</font></div><div><font size="2"   >LANGUAGE SQL</font></div><div><font size="2"   >IMMUTABLE STRICT</font></div><div><font size="2"   >AS 'SELECT sec_to_gc(cube_distance($1, $2))';</font></div><p></p></pre></div><div><br></div><div>最后一个例子是范围，用户提供球体表面的一个坐标，以及一个半径信息，用来表示球体表面的一个以这个坐标为中心辐射的半径范围，但实际测试发现有一定的偏差，可能和cube的计算方法有关系。</div><div><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: normal; background-color: rgb(224, 236, 239);"   ><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>earth_box(earth, float8)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>cube</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Returns a box suitable for an indexed search using the cube&nbsp;<tt>@&gt;</tt>&nbsp;operator for points within a given great circle distance of a location. Some points in this box are further than the specified great circle distance from the location, so a second check using&nbsp;<code>earth_distance</code>&nbsp;should be included in the query.</td></tr></table></div><div>算法，还是要用到CUBE提供的<span style="line-height: 28px;"   >cube_enlarge函数，这个函数是将多维坐标的每个坐标都延展一个半径的距离，实际上已经不是球体了，而是立方体</span><span style="line-height: 28px;"   >：</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE FUNCTION earth_box(earth, float8)</font></div><div><font size="2"   >RETURNS cube</font></div><div><font size="2"   >LANGUAGE SQL</font></div><div><font size="2"   >IMMUTABLE STRICT</font></div><div><font size="2"   >AS 'SELECT cube_enlarge($1, gc_to_sec($2), 3)';</font></div><p></p></pre></div><div>第一个参数是坐标，第二个参数是直线距离（球面距离转换为直线距离），第三个参数是第一个参数的维度，这里是3维。所以用3表示。</div><div><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: normal; background-color: rgb(224, 236, 239);"   ><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>cube_enlarge(cube c, double r, int n) returns cube</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Increases the size of a cube by a specified radius in at least n dimensions. If the radius is negative the cube is shrunk instead. This is useful for creating bounding boxes around a point for searching for nearby points. All defined dimensions are changed by the radius r. LL coordinates are decreased by r and UR coordinates are increased by r. If a LL coordinate is increased to larger than the corresponding UR coordinate (this can only happen when r &lt; 0) than both coordinates are set to their average. If n is greater than the number of defined dimensions and the cube is being increased (r &gt;= 0) then 0 is used as the base for the extra coordinates.</td></tr></table></div><div>例子：</div><div>将一个平面坐标(1,1)的每个方向扩展1个距离单位，得到<span style="line-height: 28px;"   >(0, 0),(2, 2)。你在纸上画一下就知道怎么回事了。</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select cube_enlarge('(1,1)',1,2);</font></div><div><font size="2"   >&nbsp;cube_enlarge &nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp;(0, 0),(2, 2)</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>现在回到earthdistance的例子，例如我们前面计算得到杭州到北京的球面距离是1123公里，那么我以杭州为中心，辐射多少距离才能包含北京呢？如果是圆的话，辐射半径应该要达到<span style="line-height: 28px;"   >1123公里才能包含北京。但是实际上使用</span><span style="line-height: 28px;"   >earth_box得到的结果</span><span style="line-height: 28px;"   >并非如此。</span></div><div><span style="line-height: 28px;"   >先看看扩展10米得到的BOX，每个坐标方向正反各延展了10米，得到2个点，即一个BOX：</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select ll_to_earth(30.3,120.2);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ll_to_earth &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------------------------------------------</font></div><div><font size="2"   >&nbsp;(-2770071.42546437, 4759459.23949754, 3217961.94533299)</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select earth_box(ll_to_earth(30.3,120.2), 10);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; earth_box &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;(-2770081.42546437, 4759449.23949754, 3217951.94533299),(-2770061.42546437, 4759469.23949754, 3217971.94533299)</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# select earth_box(ll_to_earth(30.3,120.2), 1122999.5704515);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; earth_box &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;(-3891620.99816939, 3637909.66679251, 2096412.37262797),(-1648521.85275934, 5881008.81220257, 4339511.51803802)</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>这个BOX是否包含北京呢？</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select earth_box(ll_to_earth(30.3,120.2), 1122999.5704515) @&gt; ll_to_earth(39.9,116.4);</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;t</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >postgres=# select ll_to_earth(39.9,116.4);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ll_to_earth &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------------------------------------</font></div><div><font size="2"   >&nbsp;(-2175648.05107066, 4382814.5785906, 4091273.51368619)</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>实际上，800多公里就包含北京了，因为这个BOX是立方体，而不是球体，北京被包含在800多公里的球体外面，立方体里面。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select earth_box(ll_to_earth(30.3,120.2), 880999.5704515) @&gt; ll_to_earth(39.9,116.4);</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;t</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>用PostGIS可以很好的解决这个问题。</div><div><br></div><div><br></div><div>earthdistance还支持使用point来表示坐标，计算得到的是英里单位。</div><div>经度，纬度。</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select point(116.4,39.9) &lt;@&gt; point(120.2,30.3);</font></div><div><font size="2"   >&nbsp; &nbsp; ?column? &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----------------</font></div><div><font size="2"   >&nbsp;697.01393638328</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >转换为公里。</font></div><div><div><font size="2"   >postgres=# select 697.01393638328*1.60931;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;?column? &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;1121.7114979609763368</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>与使用cube坐标计算得到的结果有一定的偏差，误差来自定义的地球半径不一样，见代码。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select 3958.747716*1.60931;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;?column? &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp;6370.85228683596</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>earth()函数得到的是 AS 'SELECT ''6378168''::float8';&nbsp;</div><div>调整一下，两种坐标表示方法得到的结果就一致了：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# CREATE or REPLACE FUNCTION earth() RETURNS float8</font></div><div><font size="2"   >LANGUAGE SQL IMMUTABLE</font></div><div><font size="2"   >AS 'SELECT ''6370852''::float8';</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select earth_distance(ll_to_earth(39.9,116.4),ll_to_earth(30.3,120.2));</font></div><div><font size="2"   >&nbsp; earth_distance &nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp;1121711.44745797</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>代码如下：</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >--------------- geo_distance as operator &lt;@&gt;</font></div><div><font size="2"   >CREATE OPERATOR &lt;@&gt; (</font></div><div><font size="2"   >&nbsp; LEFTARG = point,</font></div><div><font size="2"   >&nbsp; RIGHTARG = point,</font></div><div><font size="2"   >&nbsp; PROCEDURE = geo_distance,</font></div><div><font size="2"   >&nbsp; COMMUTATOR = &lt;@&gt;</font></div><div><font size="2"   >);</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >--------------- geo_distance</font></div><div><font size="2"   >CREATE FUNCTION geo_distance (point, point)</font></div><div><font size="2"   >RETURNS float8</font></div><div><font size="2"   >LANGUAGE C IMMUTABLE STRICT AS 'MODULE_PATHNAME';</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#include "postgres.h"<br><br>#include &lt;math.h&gt;<br><br>#include "utils/geo_decls.h"    /* for Point */<br><br>#ifndef M_PI<br>#define M_PI 3.14159265358979323846<br>#endif<br><br><br>PG_MODULE_MAGIC;<br><br>/* Earth's radius is in statute miles. 英里单位 */<br>static const double EARTH_RADIUS = 3958.747716;<br>static const double TWO_PI = 2.0 * M_PI;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >/******************************************************</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* geo_distance_internal - distance between points</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* args:</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; a pair of points - for each point,</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; x-coordinate is longitude in degrees west of Greenwich</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; y-coordinate is latitude in degrees above equator</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* returns: double</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; distance between the points in miles on earth's surface</font></div><div><font size="2"   >&nbsp;******************************************************/</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >static double</font></div><div><font size="2"   >geo_distance_internal(Point *pt1, Point *pt2)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; double &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;long1,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lat1,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; long2,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lat2;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; double &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;longdiff;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; double &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sino;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* convert degrees to radians */</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; long1 = degtorad(pt1-&gt;x);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; lat1 = degtorad(pt1-&gt;y);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; long2 = degtorad(pt2-&gt;x);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; lat2 = degtorad(pt2-&gt;y);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* compute difference in longitudes - want &lt; 180 degrees */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; longdiff = fabs(long1 - long2);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (longdiff &gt; M_PI)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; longdiff = TWO_PI - longdiff;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sino = sqrt(sin(fabs(lat1 - lat2) / 2.) * sin(fabs(lat1 - lat2) / 2.) +</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cos(lat1) * cos(lat2) * sin(longdiff / 2.) * sin(longdiff / 2.));</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (sino &gt; 1.)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sino = 1.;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return 2. * EARTH_RADIUS * asin(sino);</font></div><div><font size="2"   >}</font></div></div></pre></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/earthdistance.html"   >http://www.postgresql.org/docs/9.4/static/earthdistance.html</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL earth distance module - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>