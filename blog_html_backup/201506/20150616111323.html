<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.5 new feature - add distance operator <-> & gist KNN order by for point and polygon and circle</h2>
	<h5 id="">2015-06-16 11:13:23&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201551611410282/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.5 新增了两个可用于圆形，多边形距离排序的操作符&lt;-&gt;</div><div>以及求圆形，多边形，点之间距离的操作符&lt;-&gt;</div><div><h1 style="font-size: 1.4em; margin-top: 2ex; margin-bottom: 0em; color: rgb(236, 88, 0); font-family: verdana, sans-serif; line-height: normal;"   ><a id="GIST-BUILTIN-OPCLASSES" name="GIST-BUILTIN-OPCLASSES" rel="nofollow"   >58.2. Built-in Operator Classes</a></h1><p style="font-size: 12.1599998474121px; line-height: 1.5em; margin: 1.2em 0em; font-family: verdana, sans-serif;"   >The core&nbsp;<span>PostgreSQL</span>&nbsp;distribution includes the&nbsp;<acronym>GiST&nbsp;operator classes shown in&nbsp;<a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/gist-builtin-opclasses.html#GIST-BUILTIN-OPCLASSES-TABLE"   >Table 58-1</a>. (Some of the optional modules described in&nbsp;<a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/contrib.html"   >Appendix F</a>&nbsp;provide additional&nbsp;<acronym>GiST&nbsp;operator classes.)</p><div style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: normal;"   ><a id="GIST-BUILTIN-OPCLASSES-TABLE" name="GIST-BUILTIN-OPCLASSES-TABLE" rel="nofollow"   ></a><p style="font-size: 1em; line-height: 1.5em; margin: 1.2em 0em; font-weight: bold;"   >Table 58-1. Built-in&nbsp;<acronym>GiST&nbsp;Operator Classes</p><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; border: 2px solid rgb(167, 198, 223); background-color: rgb(224, 236, 239);"   ><colgroup><col><col><col><col><thead><tr><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Name</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Indexed Data Type</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Indexable Operators</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Ordering Operators</th></tr></thead><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>box_ops</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>box</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>&amp;&amp;</tt>&nbsp;<tt>&amp;&gt;</tt>&nbsp;<tt>&amp;&lt;</tt>&nbsp;<tt>&amp;&lt;|</tt>&nbsp;<tt>&gt;&gt;</tt>&nbsp;<tt>&lt;&lt;</tt>&nbsp;<tt>&lt;&lt;|</tt>&nbsp;<tt>&lt;@</tt>&nbsp;<tt>@&gt;</tt>&nbsp;<tt>@</tt>&nbsp;<tt>|&amp;&gt;</tt>&nbsp;<tt>|&gt;&gt;</tt>&nbsp;<tt>~</tt>&nbsp;<tt>~=</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>circle_ops</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>circle</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>&amp;&amp;</tt>&nbsp;<tt>&amp;&gt;</tt>&nbsp;<tt>&amp;&lt;</tt>&nbsp;<tt>&amp;&lt;|</tt>&nbsp;<tt>&gt;&gt;</tt>&nbsp;<tt>&lt;&lt;</tt>&nbsp;<tt>&lt;&lt;|</tt>&nbsp;<tt>&lt;@</tt>&nbsp;<tt>@&gt;</tt>&nbsp;<tt>@</tt>&nbsp;<tt>|&amp;&gt;</tt>&nbsp;<tt>|&gt;&gt;</tt>&nbsp;<tt>~</tt>&nbsp;<tt>~=</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>&lt;-&gt;</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>inet_ops</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>inet</tt>,&nbsp;<tt>cidr</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>&amp;&amp;</tt>&nbsp;<tt>&gt;&gt;</tt>&nbsp;<tt>&gt;&gt;=</tt>&nbsp;<tt>&gt;</tt>&nbsp;<tt>&gt;=</tt>&nbsp;<tt>&lt;&gt;</tt>&nbsp;<tt>&lt;&lt;</tt>&nbsp;<tt>&lt;&lt;=</tt>&nbsp;<tt>&lt;</tt>&nbsp;<tt>&lt;=</tt>&nbsp;<tt>=</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>point_ops</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>point</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>&gt;&gt;</tt>&nbsp;<tt>&gt;^</tt>&nbsp;<tt>&lt;&lt;</tt>&nbsp;<tt>&lt;@</tt>&nbsp;<tt>&lt;@</tt>&nbsp;<tt>&lt;@</tt>&nbsp;<tt>&lt;^</tt>&nbsp;<tt>~=</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>&lt;-&gt;</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>poly_ops</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>polygon</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>&amp;&amp;</tt>&nbsp;<tt>&amp;&gt;</tt>&nbsp;<tt>&amp;&lt;</tt>&nbsp;<tt>&amp;&lt;|</tt>&nbsp;<tt>&gt;&gt;</tt>&nbsp;<tt>&lt;&lt;</tt>&nbsp;<tt>&lt;&lt;|</tt>&nbsp;<tt>&lt;@</tt>&nbsp;<tt>@&gt;</tt>&nbsp;<tt>@</tt>&nbsp;<tt>|&amp;&gt;</tt>&nbsp;<tt>|&gt;&gt;</tt>&nbsp;<tt>~</tt>&nbsp;<tt>~=</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>&lt;-&gt;</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>range_ops</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >any range type</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>&amp;&amp;</tt>&nbsp;<tt>&amp;&gt;</tt>&nbsp;<tt>&amp;&lt;</tt>&nbsp;<tt>&gt;&gt;</tt>&nbsp;<tt>&lt;&lt;</tt>&nbsp;<tt>&lt;@</tt>&nbsp;<tt>-|-</tt>&nbsp;<tt>=</tt>&nbsp;<tt>@&gt;</tt>&nbsp;<tt>@&gt;</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>tsquery_ops</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>tsquery</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>&lt;@</tt>&nbsp;<tt>@&gt;</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>tsvector_ops</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>tsvector</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>@@</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td></tr></table></div><p style="font-size: 12.1599998474121px; line-height: 1.5em; margin: 1.2em 0em; font-family: verdana, sans-serif;"   >For historical reasons, the&nbsp;<tt>inet_ops</tt>&nbsp;operator class is not the default class for types&nbsp;<tt>inet</tt>&nbsp;and&nbsp;<tt>cidr</tt>. To use it, mention the class name in&nbsp;<tt>CREATE INDEX</tt>, for example</p><pre style="font-size: 1em; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border: 1px solid rgb(207, 207, 207); padding: 2ex; margin-top: 2ex; margin-bottom: 2ex; margin-left: 2ex; overflow: auto; border-radius: 8px; line-height: normal; background-color: rgb(247, 247, 247);"   >CREATE INDEX ON my_table USING GIST (my_inet_column inet_ops);</pre></div><div><br></div><div>例子：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select oprcode,oprleft,oprright,oprresult from pg_operator where oprname='&lt;-&gt;' order by 1;</font></div><div><font size="2"   >......</font></div><div><div><font size="2"   >&nbsp;dist_ppoly &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; 600 | &nbsp; &nbsp; &nbsp;604 | &nbsp; &nbsp; &nbsp; 701</font></div><div><font size="2"   >&nbsp;dist_cpoint &nbsp; &nbsp; | &nbsp; &nbsp; 718 | &nbsp; &nbsp; &nbsp;600 | &nbsp; &nbsp; &nbsp; 701</font></div><div><font size="2"   >&nbsp;dist_polyp &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; 604 | &nbsp; &nbsp; &nbsp;600 | &nbsp; &nbsp; &nbsp; 701</font></div><div><font size="2"   >(19 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select typname from pg_type where oid=600;</font></div><div><font size="2"   >&nbsp;typname&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;point</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select typname from pg_type where oid=604;</font></div><div><font size="2"   >&nbsp;typname&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;polygon</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select typname from pg_type where oid=718;</font></div><div><font size="2"   >&nbsp;typname&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;circle</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select typname from pg_type where oid=701;</font></div><div><font size="2"   >&nbsp;typname&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;float8</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>求两者的最近距离：</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select point '(1,100)' &lt;-&gt; circle '&lt;(0,1),5&gt;';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;?column? &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp;94.0050503762308</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >postgres=# select point '(1,100)' &lt;-&gt; polygon '((1,2),(100,200),(100,2000))';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;?column? &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp;4.84990586340793</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >postgres=# select point '(-1,1)' &lt;-&gt; polygon '((0,1),(100,0),(0,0))';</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select point '(-1,1)' &lt;-&gt; polygon '((-1,1),(100,0),(0,0))';</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/gist-builtin-opclasses.html"   >http://www.postgresql.org/docs/devel/static/gist-builtin-opclasses.html</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/functions-geometry.html"   >http://www.postgresql.org/docs/devel/static/functions-geometry.html</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL 9.5 new feature - add distance operator -  gist KNN order by for point and polygon and circle - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>