<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.5 new feature - Use PG_OOM_ADJUST_FILE and PG_OOM_ADJUST_VALUE to control Linux OOM killer</h2>
	<h5 id="">2015-06-14 16:42:00&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201551434949238/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.5新特性，通过两个环境变量控制Linux OOM killer，当然还是要结合内核参数来使用的，只是不需要重新编译PG。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Add environment variables PG_OOM_ADJUST_FILE and PG_OOM_ADJUST_VALUE to control Linux OOM killer (Gurjeet Singh)</font></div><div><font size="2"   >The previous OOM control involved a compile-time option.</font></div><p></p></pre></div><div><br></div><div>"overcommit" memory是指当前操作系统commit的内存超出commitLimit。</div><div>当前系统的commitLimit和已commit的内存可以通过/proc/meminfo查看：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >（The current overcommit limit and amount committed are viewable in</font></div><div><font size="2"   >/proc/meminfo as CommitLimit and Committed_AS respectively.）</font></div><div><div><font size="2"   ># cat /proc/meminfo |grep -i commit</font></div><div><font size="2"   >CommitLimit: &nbsp; &nbsp;89149372 kB</font></div><div><font size="2"   >Committed_AS: &nbsp; 19386404 kB</font></div></div><p></p></pre></div><div>通过两个内核参数可以控制Limit：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># sysctl -a|grep overcommit</font></div><div><font size="2"   >vm.overcommit_memory = 0</font></div><div><font size="2"   >vm.overcommit_ratio = 90 &nbsp;# 设置Limit为当前内存的比例</font></div><div><font size="2"   >vm.overcommit_kbytes = 0 &nbsp;# 或者设置Limit为KB</font></div><div><font size="2"   >vm.nr_overcommit_hugepages = 0</font></div><p></p></pre></div><div>例如我修改CommitLimit为当前内存的一半：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># sysctl -w vm.overcommit_ratio=50</font></div><div><font size="2"   >vm.overcommit_ratio = 50</font></div><p></p></pre></div><div>可以看到<span style="line-height: 28px;"   >CommitLimit的</span>变化：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># cat /proc/meminfo |grep -i commit</font></div><div><font size="2"   >CommitLimit: &nbsp; &nbsp;49527428 kB</font></div><div><font size="2"   >Committed_AS: &nbsp; 19386764 kB</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# free</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;total &nbsp; &nbsp; &nbsp; used &nbsp; &nbsp; &nbsp; free &nbsp; &nbsp; shared &nbsp; &nbsp;buffers &nbsp; &nbsp; cached</font></div><div><font size="2"   >Mem: &nbsp; &nbsp; &nbsp;99054860 &nbsp; &nbsp;7155832 &nbsp; 91899028 &nbsp; &nbsp; 161632 &nbsp; &nbsp; 496572 &nbsp; &nbsp;4514604</font></div><div><font size="2"   >-/+ buffers/cache: &nbsp; &nbsp;2144656 &nbsp; 96910204</font></div><div><font size="2"   >Swap: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><p></p></pre></div><div>另外一个内核参数<span style="line-height: 28px;"   >overcommit_memory</span><span style="line-height: 28px;"   >&nbsp;是控制当overcommit发生时，内核如何处理？与OOM Killer有关了：</span></div><div><span style="line-height: 28px;"   >overcommit_memory</span><span style="line-height: 28px;"   >&nbsp;允许设置为3个值，0,1,2：</span></div><div>默认为0，启发式的OOM，允许root用户使用更多的内存，当commited数超过限制时，会触发OOM Killer。</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >0 &nbsp; &nbsp; &nbsp; - &nbsp; &nbsp; &nbsp; Heuristic overcommit handling. Obvious overcommits of</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; address space are refused. Used for a typical system. It</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ensures a seriously wild allocation fails while allowing</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; overcommit to reduce swap usage. &nbsp;root is allowed to&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; allocate slighly more memory in this mode. This is the&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default.</font></div><p></p></pre></div><div>1,允许出现overcommit（超出内存使用），通常在用在一些科学应用，例如GreenPlum数据仓库。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >1 &nbsp; &nbsp; &nbsp; - &nbsp; &nbsp; &nbsp; Always overcommit. Appropriate for some scientific</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; applications.</font></div><p></p></pre></div><div>2,不允许出现overcommit，限制在SWAP + ( MEM*<span style="line-height: 28px;"   >overcommit_ratio 或&nbsp;</span><span style="line-height: 28px;"   >overcommit_kbytes</span><span style="line-height: 28px;"   >&nbsp;)；</span></div><div><span style="line-height: 28px;"   >也就是说，只要交换分区足够大，基本上可以避免出现操作系统主动OOM Killer。</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2 &nbsp; &nbsp; &nbsp; - &nbsp; &nbsp; &nbsp; Don't overcommit. The total address space commit</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for the system is not permitted to exceed swap + a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; configurable amount (default is 50%) of physical RAM.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Depending on the amount you use, in most situations</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this means a process will not be killed while accessing</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pages but will receive errors on memory allocation as</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appropriate.</font></div><p></p></pre></div></div><div><br></div><div>首先说一下如何尽可能的减少OOM发生的几率的几种方法，</div><div>1. 开启交换分区，同时设置足够大的<span style="line-height: 28px;"   >overcommit_ratio，例如90。并且将</span><span style="line-height: 28px;"   >overcommit_memory</span><span style="line-height: 28px;"   >&nbsp;设置为2。（这种设置可能导致使用交换分区。）</span></div><div><span style="line-height: 28px;"   >2. 设置较大的</span><span style="line-height: 28px;"   >overcommit_ratio如90，同时设置</span><span style="line-height: 28px;"   >overcommit_memory</span><span style="line-height: 28px;"   >&nbsp;=0（默认），这种方法会发生OOM，但是可以减少交换分区使用几率。</span></div><div><br></div><div>当系统触发OOM Killer时，如何保护PostgreSQL进程不被kill呢？</div><div>需要设置进程的oom adj。</div><div>在PostgreSQL 9.5以前的版本，需要在编译时指定几个宏。参考：</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012811103039776/"   >http://blog.163.com/digoal@126/blog/static/1638770402012811103039776/</a></div><div>现在，不需要在编译时指定，可以在环境变量中使用。</div><div>例子：</div><div>首先要设置当前进程的oom adj（需要超级用户），然后配置环境变量，启动数据库。</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 ~]# echo -1000 &gt; /proc/self/oom_score_adj</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# cat /proc/self/oom_score_adj</font></div><div><font size="2"   >-1000</font></div></div><div><font size="2"   >[root@db-172-16-3-150 ~]# su - pg95</font></div><div><div><font size="2"   >pg95@db-172-16-3-150-&gt; pg_ctl stop -m fast</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div></div><p></p></pre></div><div><div>设置postgres主进程的oom adj值，即-1000。（老的系统可能是-17）</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg95@db-172-16-3-150-&gt; export PG_OOM_ADJUST_FILE=/proc/self/oom_score_adj</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >设置postgres子进程的oom adj值，这个值可以随意设置，一般比postgres高一点即可（更容易被KILL）</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg95@db-172-16-3-150-&gt; export PG_OOM_ADJUST_VALUE=-1</font></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; pg_ctl start</font></div><div><font size="2"   >server starting</font></div></div><div><div><font size="2"   >pg95@db-172-16-3-150-&gt; ps -ewf|grep postgres|grep pg95</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 24444 &nbsp; &nbsp; 1 &nbsp;0 16:32 pts/4 &nbsp; &nbsp;00:00:00 /opt/pgsql9.5/bin/postgres</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 24446 24444 &nbsp;0 16:32 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: logger process &nbsp;&nbsp;</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 24448 24444 &nbsp;0 16:32 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp;&nbsp;</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 24449 24444 &nbsp;0 16:32 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp;&nbsp;</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 24450 24444 &nbsp;0 16:32 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal writer process &nbsp;&nbsp;</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 24451 24444 &nbsp;0 16:32 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum launcher process &nbsp;&nbsp;</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 24452 24444 &nbsp;0 16:32 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: archiver process &nbsp;&nbsp;</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 24453 24444 &nbsp;0 16:32 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process &nbsp;&nbsp;</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 24464 24384 &nbsp;0 16:32 pts/4 &nbsp; &nbsp;00:00:00 grep postgres</font></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; cat /proc/24444/oom_score_adj&nbsp;</font></div><div><font size="2"   >-1000</font></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; cat /proc/24446/oom_score_adj&nbsp;</font></div><div><font size="2"   >-1</font></div></div><div><div><font size="2"   >pg95@db-172-16-3-150-&gt; cat /proc/24453/oom_score_adj&nbsp;</font></div><div><font size="2"   >-1</font></div></div><p></p></pre></div></div><div>后面FORK的backend process的oom adj也是-1</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg95@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.5devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select pg_backend_pid();</font></div><div><font size="2"   >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 24628</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# \! cat /proc/24628/oom_score_adj</font></div><div><font size="2"   >-1</font></div><p></p></pre></div><div>其实我们还有一个小小的问题，就是我们其实也希望数据库启动时的进程也是-1000，但是不希望backend process是-1000。</div><div>这个需要通过root用户来修改。例如：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># echo -1000 &gt; /proc/24446/oom_score_adj</font></div><div><font size="2"   >。。。。。。</font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/kernel-resources.html#LINUX-MEMORY-OVERCOMMIT"   >http://www.postgresql.org/docs/devel/static/kernel-resources.html#LINUX-MEMORY-OVERCOMMIT</a></div><div>2.&nbsp;/usr/share/doc/kernel-doc-2.6.32/Documentation/vm/overcommit-accounting</div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012811103039776/"   >http://blog.163.com/digoal@126/blog/static/1638770402012811103039776/</a></div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL 9.5 new feature - Use PG_OOM_ADJUST_FILE and PG_OOM_ADJUST_VALUE to control Linux OOM killer - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>