<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.5 new feature - Add information about buffer pins to pg_buffercache</h2>
	<h5 id="">2015-06-17 15:30:58&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402015517111721646/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>pg_buffercache这个插件是用来输出shared buffer的内容的，<span style="line-height: 28px;"   >PostgreSQL 9.5 新增了一列pinning_backends，反映这个buffer 块正在被多少个backend pin。见</span>BufferDesc。</div><div><p style="font-size: 12.1599998474121px; line-height: 1.5em; margin: 1.2em 0em; font-weight: bold; font-family: verdana, sans-serif;"   >Table F-14.&nbsp;<tt>pg_buffercache</tt>&nbsp;Columns</p><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: normal; background-color: rgb(224, 236, 239);"   ><colgroup><col><col><col><col><thead><tr><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Name</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Type</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >References</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Description</th></tr></thead><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>bufferid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>integer</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >ID, in the range 1..<tt>shared_buffers</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>relfilenode</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>oid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>pg_class.relfilenode</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Filenode number of the relation</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>reltablespace</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>oid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>pg_tablespace.oid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Tablespace OID of the relation</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>reldatabase</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>oid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>pg_database.oid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Database OID of the relation</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>relforknumber</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>smallint</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Fork number within the relation; see&nbsp;<tt>include/storage/relfilenode.h</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>relblocknumber</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>bigint</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Page number within the relation</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>isdirty</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>boolean</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Is the page dirty?</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>usagecount</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>smallint</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Clock-sweep access count</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>pinning_backends</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>integer</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Number of backends pinning this buffer</td></tr></table></div><div>pinning_backends可以反映热块，表示当前有多少个process正在pin 这个块，正常情况下应该都是0，因为pined buffer是不能被replacement的，也就是无法驱逐出shared buffer，对一个buffer操作完后会立即释放，例如插入，更新，查询，删除都需要pin buffer，但是都会很快释放。什么情况下我们能观察到这个值大于0呢？</div><div>例如用户正在等待锁的时候，会观察到，但是获取到锁后立即就会消失，即使事务未退出。</div><div>例子：</div><div>会话1</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# select * from test for update;</font></div><div><font size="2"   >&nbsp;id&nbsp;</font></div><div><font size="2"   >----</font></div><div><font size="2"   >&nbsp; 1</font></div><div><font size="2"   >&nbsp; 1</font></div><div><font size="2"   >&nbsp; 1</font></div><div><font size="2"   >&nbsp; 1</font></div><div><font size="2"   >&nbsp; 1</font></div><div><font size="2"   >&nbsp; 1</font></div><div><font size="2"   >(6 rows)</font></div><p></p></pre></div><div>当前无pinning&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from pg_buffercache where relfilenode=(select relfilenode from pg_class where relname='test');</font></div><div><font size="2"   >&nbsp;bufferid | relfilenode | reltablespace | reldatabase | relforknumber | relblocknumber | isdirty | usagecount | pinning_backends&nbsp;</font></div><div><font size="2"   >----------+-------------+---------------+-------------+---------------+----------------+---------+------------+------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 190 | &nbsp; &nbsp; &nbsp; 16480 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1663 | &nbsp; &nbsp; &nbsp; 13181 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | t &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>会话2，等待</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# select * from test for update;</font></div><p></p></pre></div><div>有1个pinning backend</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from pg_buffercache where relfilenode=(select relfilenode from pg_class where relname='test');</font></div><div><font size="2"   >&nbsp;bufferid | relfilenode | reltablespace | reldatabase | relforknumber | relblocknumber | isdirty | usagecount | pinning_backends&nbsp;</font></div><div><font size="2"   >----------+-------------+---------------+-------------+---------------+----------------+---------+------------+------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 190 | &nbsp; &nbsp; &nbsp; 16480 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1663 | &nbsp; &nbsp; &nbsp; 13181 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | t &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>会话3，等待</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >postgres=# begin;</font></div><div style="line-height: 28px;"   ><font size="2"   >BEGIN</font></div><div style="line-height: 28px;"   ><font size="2"   >postgres=# select * from test for update;</font></div><p></p></pre></div></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >有2个pinning backend</span></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >postgres=# select * from pg_buffercache where relfilenode=(select relfilenode from pg_class where relname='test');</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;bufferid | relfilenode | reltablespace | reldatabase | relforknumber | relblocknumber | isdirty | usagecount | pinning_backends&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >----------+-------------+---------------+-------------+---------------+----------------+---------+------------+------------------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; 190 | &nbsp; &nbsp; &nbsp; 16480 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1663 | &nbsp; &nbsp; &nbsp; 13181 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | t &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="line-height: 28px;"   >提交会话1，会话2获得锁，并释放pin</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >postgres=# end;</font></div><div style="line-height: 28px;"   ><font size="2"   >COMMIT</font></div><p></p></pre></div></div><div style="line-height: 28px;"   >所以只有会话3在等待，即1个pinning backend</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >postgres=# select * from pg_buffercache where relfilenode=(select relfilenode from pg_class where relname='test');</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;bufferid | relfilenode | reltablespace | reldatabase | relforknumber | relblocknumber | isdirty | usagecount | pinning_backends&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >----------+-------------+---------------+-------------+---------------+----------------+---------+------------+------------------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; 190 | &nbsp; &nbsp; &nbsp; 16480 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1663 | &nbsp; &nbsp; &nbsp; 13181 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | t &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >提交会话2，会话3获得锁，并释放pin</span></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >postgres=# end;</font></div><div style="line-height: 28px;"   ><font size="2"   >COMMIT</font></div><p></p></pre></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >0个pinning backend</span></div></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >postgres=# select * from pg_buffercache where relfilenode=(select relfilenode from pg_class where relname='test');</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;bufferid | relfilenode | reltablespace | reldatabase | relforknumber | relblocknumber | isdirty | usagecount | pinning_backends&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >----------+-------------+---------------+-------------+---------------+----------------+---------+------------+------------------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; 190 | &nbsp; &nbsp; &nbsp; 16480 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1663 | &nbsp; &nbsp; &nbsp; 13181 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | t &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div><p></p></pre></div></div></div></div></div><div><br></div><div>[参考]</div>1. src/include/storage/buf_internals.h<wbr><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;BufferDesc -- shared descriptor/state data for a single shared buffer.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Note: buf_hdr_lock must be held to examine or change the tag, flags,</font></div><div><font size="2"   >&nbsp;* usage_count, refcount, or wait_backend_pid fields. &nbsp;buf_id field never</font></div><div><font size="2"   >&nbsp;* changes after initialization, so does not need locking. &nbsp;freeNext is</font></div><div><font size="2"   >&nbsp;* protected by the buffer_strategy_lock not buf_hdr_lock. &nbsp;The LWLocks can take</font></div><div><font size="2"   >&nbsp;* care of themselves. &nbsp;The buf_hdr_lock is *not* used to control access to</font></div><div><font size="2"   >&nbsp;* the data in the buffer!</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* An exception is that if we have the buffer pinned, its tag can't change</font></div><div><font size="2"   >&nbsp;* underneath us, so we can examine the tag without locking the spinlock.</font></div><div><font size="2"   >&nbsp;* Also, in places we do one-time reads of the flags without bothering to</font></div><div><font size="2"   >&nbsp;* lock the spinlock; this is generally for situations where we don't expect</font></div><div><font size="2"   >&nbsp;* the flag bit being tested to be changing.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* We can't physically remove items from a disk page if another backend has</font></div><div><font size="2"   >&nbsp;* the buffer pinned. &nbsp;Hence, a backend may need to wait for all other pins</font></div><div><font size="2"   >&nbsp;* to go away. &nbsp;This is signaled by storing its own PID into</font></div><div><font size="2"   >&nbsp;* wait_backend_pid and setting flag bit BM_PIN_COUNT_WAITER. &nbsp;At present,</font></div><div><font size="2"   >&nbsp;* there can be only one such waiter per buffer.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* We use this same struct for local buffer headers, but the lock fields</font></div><div><font size="2"   >&nbsp;* are not used and not all of the flag bits are useful either.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >typedef struct BufferDesc</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; BufferTag &nbsp; &nbsp; &nbsp; tag; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* ID of page contained in buffer */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; BufFlags &nbsp; &nbsp; &nbsp; &nbsp;flags; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* see bit definitions above */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; uint16 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;usage_count; &nbsp; &nbsp;/* usage counter for clock sweep code */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; unsigned &nbsp; &nbsp; &nbsp; &nbsp;refcount; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* # of backends holding pins on buffer */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wait_backend_pid; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* backend PID of pin-count waiter */</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; slock_t &nbsp; &nbsp; &nbsp; &nbsp; buf_hdr_lock; &nbsp; /* protects the above fields */</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf_id; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* buffer's index number (from 0) */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; freeNext; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* link in freelist chain */</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LWLock &nbsp; &nbsp; *io_in_progress_lock; &nbsp; &nbsp; &nbsp; &nbsp;/* to wait for I/O to complete */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LWLock &nbsp; &nbsp; *content_lock; &nbsp; &nbsp; &nbsp; /* to lock access to buffer contents */</font></div><div><font size="2"   >} BufferDesc;</font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   >2.&nbsp;contrib/pg_buffercache/pg_buffercache_pages.c</span></div><div><span style="line-height: 28px;"   ><br></span></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/pgbuffercache.html"   >http://www.postgresql.org/docs/devel/static/pgbuffercache.html</a></div><div>4.&nbsp;src/backend/storage/buffer/bufmgr.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* PinBuffer -- make buffer unavailable for replacement.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* For the default access strategy, the buffer's usage_count is incremented</font></div><div><font size="2"   >&nbsp;* when we first pin it; for other strategies we just make sure the usage_count</font></div><div><font size="2"   >&nbsp;* isn't zero. &nbsp;(The idea of the latter is that we don't want synchronized</font></div><div><font size="2"   >&nbsp;* heap scans to inflate the count, but we need it to not be zero to discourage</font></div><div><font size="2"   >&nbsp;* other backends from stealing buffers from our ring. &nbsp;As long as we cycle</font></div><div><font size="2"   >&nbsp;* through the ring faster than the global clock-sweep cycles, buffers in</font></div><div><font size="2"   >&nbsp;* our ring won't be chosen as victims for replacement by other backends.)</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* This should be applied only to shared buffers, never local ones.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Note that ResourceOwnerEnlargeBuffers must have been done already.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Returns TRUE if buffer is BM_VALID, else FALSE. &nbsp;This provision allows</font></div><div><font size="2"   >&nbsp;* some callers to avoid an extra spinlock cycle.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static bool</font></div><div><font size="2"   >PinBuffer(volatile BufferDesc *buf, BufferAccessStrategy strategy)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = buf-&gt;buf_id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bool &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;result;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PrivateRefCountEntry *ref;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ref = GetPrivateRefCountEntry(b + 1, true);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (ref == NULL)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ReservePrivateRefCountEntry();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ref = NewPrivateRefCountEntry(b + 1);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LockBufHdr(buf);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;refcount++;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (strategy == NULL)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (buf-&gt;usage_count &lt; BM_MAX_USAGE_COUNT)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;usage_count++;</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (buf-&gt;usage_count == 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;usage_count = 1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = (buf-&gt;flags &amp; BM_VALID) != 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UnlockBufHdr(buf);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* If we previously pinned the buffer, it must surely be valid */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = true;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ref-&gt;refcount++;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Assert(ref-&gt;refcount &gt; 0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ResourceOwnerRememberBuffer(CurrentResourceOwner,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BufferDescriptorGetBuffer(buf));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return result;</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* PinBuffer_Locked -- as above, but caller already locked the buffer header.</font></div><div><font size="2"   >&nbsp;* The spinlock is released before return.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* As this function is called with the spinlock held, the caller has to</font></div><div><font size="2"   >&nbsp;* previously call ReservePrivateRefCountEntry().</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Currently, no callers of this function want to modify the buffer's</font></div><div><font size="2"   >&nbsp;* usage_count at all, so there's no need for a strategy parameter.</font></div><div><font size="2"   >&nbsp;* Also we don't bother with a BM_VALID test (the caller could check that for</font></div><div><font size="2"   >&nbsp;* itself).</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Also all callers only ever use this function when it's known that the</font></div><div><font size="2"   >&nbsp;* buffer can't have a preexisting pin by this backend. That allows us to skip</font></div><div><font size="2"   >&nbsp;* searching the private refcount array &amp; hash, which is a boon, because the</font></div><div><font size="2"   >&nbsp;* spinlock is still held.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Note: use of this routine is frequently mandatory, not just an optimization</font></div><div><font size="2"   >&nbsp;* to save a spin lock/unlock cycle, because we need to pin a buffer before</font></div><div><font size="2"   >&nbsp;* its state can change under us.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static void</font></div><div><font size="2"   >PinBuffer_Locked(volatile BufferDesc *buf)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b = buf-&gt;buf_id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PrivateRefCountEntry *ref;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* As explained, We don't expect any preexisting pins. That allows us to</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* manipulate the PrivateRefCount after releasing the spinlock</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Assert(GetPrivateRefCountEntry(b + 1, false) == NULL);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;refcount++;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; UnlockBufHdr(buf);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ref = NewPrivateRefCountEntry(b + 1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ref-&gt;refcount++;</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ResourceOwnerRememberBuffer(CurrentResourceOwner,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BufferDescriptorGetBuffer(buf));</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* IncrBufferRefCount</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Increment the pin count on a buffer that we have *already* pinned</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;at least once.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;This function cannot be used on a buffer we do not have pinned,</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;because it doesn't change the shared buffer state.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >void</font></div><div><font size="2"   >IncrBufferRefCount(Buffer buffer)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Assert(BufferIsPinned(buffer));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ResourceOwnerEnlargeBuffers(CurrentResourceOwner);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ResourceOwnerRememberBuffer(CurrentResourceOwner, buffer);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (BufferIsLocal(buffer))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LocalRefCount[-buffer - 1]++;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PrivateRefCountEntry *ref;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ref = GetPrivateRefCountEntry(buffer, true);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Assert(ref != NULL);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ref-&gt;refcount++;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* UnpinBuffer -- make buffer available for replacement.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* This should be applied only to shared buffers, never local ones.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Most but not all callers want CurrentResourceOwner to be adjusted.</font></div><div><font size="2"   >&nbsp;* Those that don't should pass fixOwner = FALSE.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static void</font></div><div><font size="2"   >UnpinBuffer(volatile BufferDesc *buf, bool fixOwner)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PrivateRefCountEntry *ref;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* not moving as we're likely deleting it soon anyway */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ref = GetPrivateRefCountEntry(buf-&gt;buf_id + 1, false);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Assert(ref != NULL);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (fixOwner)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ResourceOwnerForgetBuffer(CurrentResourceOwner,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BufferDescriptorGetBuffer(buf));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Assert(ref-&gt;refcount &gt; 0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ref-&gt;refcount--;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (ref-&gt;refcount == 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* I'd better not still hold any locks on the buffer */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Assert(!LWLockHeldByMe(buf-&gt;content_lock));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Assert(!LWLockHeldByMe(buf-&gt;io_in_progress_lock));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LockBufHdr(buf);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Decrement the shared reference count */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Assert(buf-&gt;refcount &gt; 0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;refcount--;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Support LockBufferForCleanup() */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ((buf-&gt;flags &amp; BM_PIN_COUNT_WAITER) &amp;&amp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;refcount == 1)</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* we just released the last pin other than the waiter's */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wait_backend_pid = buf-&gt;wait_backend_pid;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf-&gt;flags &amp;= ~BM_PIN_COUNT_WAITER;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UnlockBufHdr(buf);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ProcSendSignal(wait_backend_pid);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UnlockBufHdr(buf);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ForgetPrivateRefCountEntry(ref);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >}</font></div></div></div><p></p></pre></div><div><br></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL 9.5 new feature - Add information about buffer pins to pg_buffercache - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>