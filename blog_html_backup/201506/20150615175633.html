<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.5 new feature - ALTER TABLE .. SET LOGGED / UNLOGGED</h2>
	<h5 id="">2015-06-15 17:56:33&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020155155415716/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.5以前，我们只能在创建表时指定这个表是否需要记录WAL，即是否unlogged TABLE。</div><div>如果表创建好后，需要修改这个属性的话，我们只能用超级用户去修改pg_class.relpersistence 。 u代表unlogged, p代表persistent。</div><div><pre class="prettyprint"   ><p><font size="2"   >Allow control of table WAL logging after table creation with&nbsp;<span style="line-height: 28px;"   >ALTER TABLE .. SET LOGGED / UNLOGGED&nbsp;</span>(Fabrízio de Royes Mello)<wbr></font></p><div></div><p></p></pre>测试：</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select relpersistence from pg_class where relname='test';</font></div><div><font size="2"   >&nbsp;relpersistence&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;p</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >postgres=# alter table test set unlogged;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >postgres=# select relpersistence from pg_class where relname='test';</font></div><div><font size="2"   >&nbsp;relpersistence&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;u</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# select pg_relation_filepath('test');</font></div><div><font size="2"   >&nbsp;pg_relation_filepath&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;base/13181/16403</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >postgres=# \q</font></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; cd $PGDATA</font></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; ll base/13181/16403*</font></div><div><font size="2"   >-rw------- 1 pg95 pg95 0 Jun 15 17:41 base/13181/16403</font></div><div><font size="2"   >-rw------- 1 pg95 pg95 0 Jun 15 17:41 base/13181/16403_init</font></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.5devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# alter table test set logged;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >postgres=# select pg_relation_filepath('test');</font></div><div><font size="2"   >&nbsp;pg_relation_filepath&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;base/13181/16406</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# \q</font></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; ll base/13181/16406*</font></div><div><font size="2"   >-rw------- 1 pg95 pg95 0 Jun 15 17:41 base/13181/16406</font></div></div><p></p></pre></div><div>注意执行alter table set 后file发生了变化, 即表发生了rewrite, 参考代码</div><div><span style="line-height: 28px;"   >src/backend/commands/tablecmds.c。</span></div><div><br></div><div><div>时间测试，因为需要rewrite，所以表越大，时间越久：</div><div><pre class="prettyprint"   ><p></p><div><div><div><font size="2"   >postgres=# insert into test select generate_series(1,100000000);</font></div><div><font size="2"   >INSERT 0 100000000</font></div><div><font size="2"   >postgres=# \timing</font></div><div><font size="2"   >Timing is on.</font></div><div><font size="2"   >postgres=# alter table test set logged; &nbsp;-- &nbsp;产生WAL</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >Time: 99217.034 ms</font></div></div></div><div><div><font size="2"   >postgres=# alter table test set unlogged; &nbsp;-- &nbsp;不产生WAL</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >Time: 56105.722 ms</font></div></div><p></p></pre></div></div><div><br></div>[参考]<br><div>1. src/backend/commands/tablecmds.c</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case AT_SetLogged: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* SET LOGGED */</font></span></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ATSimplePermissions(rel, ATT_TABLE);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tab-&gt;chgPersistence = ATPrepChangePersistence(rel, true);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* force rewrite if necessary; see comment in ATRewriteTables */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (tab-&gt;chgPersistence)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tab-&gt;rewrite |= AT_REWRITE_ALTER_PERSISTENCE;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tab-&gt;newrelpersistence = RELPERSISTENCE_PERMANENT;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pass = AT_PASS_MISC;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case AT_SetUnLogged: &nbsp; &nbsp;/* SET UNLOGGED */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ATSimplePermissions(rel, ATT_TABLE);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tab-&gt;chgPersistence = ATPrepChangePersistence(rel, false);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* force rewrite if necessary; see comment in ATRewriteTables */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (tab-&gt;chgPersistence)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tab-&gt;rewrite |= AT_REWRITE_ALTER_PERSISTENCE;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tab-&gt;newrelpersistence = RELPERSISTENCE_UNLOGGED;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pass = AT_PASS_MISC;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div></div><p></p></pre></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL 9.5 new feature - ALTER TABLE .. SET LOGGED / UNLOGGED - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>