<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL seq's lastval</h2>
	<h5 id="">2015-03-02 12:14:17&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402015220816913/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>序列在PostgreSQL中可以通过像查询表一样来查询, 但是却和表不一样, 为什么呢?</div><div>如果是表的话, 变更的数据是否可见, 和事务隔离级别有关, 但是SEQUENCE不是这样的, 查询seq时和事务隔离级别无关.</div><div>因为序列状态和会话有关, 每个会话会存储用到的序列, 结构如下</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* We store a SeqTable item for every sequence we have touched in the current</font></div><div><font size="2"   >&nbsp;* session. &nbsp;This is needed to hold onto nextval/currval state. &nbsp;(We can't</font></div><div><font size="2"   >&nbsp;* rely on the relcache, since it's only, well, a cache, and may decide to</font></div><div><font size="2"   >&nbsp;* discard entries.)</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >typedef struct SeqTableData</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relid; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* pg_class OID of this sequence (hash key) */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; filenode; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* last seen relfilenode of this sequence */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LocalTransactionId lxid; &nbsp; &nbsp; &nbsp; &nbsp;/* xact in which we last did a seq op */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bool &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;last_valid; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* do we have a valid "last" value? */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int64 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; last; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* value last returned by nextval */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int64 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cached; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* last value already cached for nextval */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* if last != cached, we have not used up all the cached values */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int64 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; increment; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* copy of sequence's increment field */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* note that increment is zero until we first do read_seq_tuple() */</font></div><div><font size="2"   >} SeqTableData;</font></div><p></p></pre></div><div><br></div><div>例如系统中有一个序列名为seq.</div><div>开启A事务, 隔离级别repeatable read</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# begin isolation level repeatable read;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# select 1;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select * from seq;</font></div><div><font size="2"   >&nbsp;sequence_name | last_value | start_value | increment_by | &nbsp; &nbsp; &nbsp;max_value &nbsp; &nbsp; &nbsp;| min_value | cache_value | log_cnt | is_cycled | is_</font></div><div><font size="2"   >called&nbsp;</font></div><div><font size="2"   >---------------+------------+-------------+--------------+---------------------+-----------+-------------+---------+-----------+----</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;seq &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | 9223372036854775807 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp;30 | f &nbsp; &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>在B会话中, 消耗一个值</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select nextval('seq'::regclass);</font></div><div><font size="2"   >&nbsp;nextval&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;9</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>在A会话中, 看到了这个变化, 注意last_value</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from seq;</font></div><div><font size="2"   >&nbsp;sequence_name | last_value | start_value | increment_by | &nbsp; &nbsp; &nbsp;max_value &nbsp; &nbsp; &nbsp;| min_value | cache_value | log_cnt | is_cycled | is_</font></div><div><font size="2"   >called&nbsp;</font></div><div><font size="2"   >---------------+------------+-------------+--------------+---------------------+-----------+-------------+---------+-----------+----</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;seq &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | 9223372036854775807 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp;29 | f &nbsp; &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>只有通过currval看到的是当前会话的序列值 :&nbsp;</div><div>在B会话中, 查看当前的序列值</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select currval('seq');</font></div><div><font size="2"   >&nbsp;currval&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;9</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>在A会话中消耗序列值</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select nextval('seq'::regclass);</font></div><div><font size="2"   >&nbsp;nextval&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 10</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select nextval('seq'::regclass);</font></div><div><font size="2"   >&nbsp;nextval&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 11</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>在B会话中看到的currval还是9.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select currval('seq');</font></div><div><font size="2"   >&nbsp;currval&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;9</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >调用<span style="line-height: 28px;"   >discard sequences;后, 序列值不在当前会话存储, 所以currval会返回序列在当前会话未定义.</span></font></div><div><div><font size="2"   >postgres=# discard sequences;</font></div><div><font size="2"   >DISCARD SEQUENCES</font></div><div><font size="2"   >postgres=# select currval('seq');</font></div><div><font size="2"   >ERROR: &nbsp;currval of sequence "seq" is not yet defined in this session</font></div></div><p></p></pre></div><div>对应代码</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Datum</font></div><div><font size="2"   >currval_oid(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relid = PG_GETARG_OID(0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int64 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SeqTable &nbsp; &nbsp; &nbsp; &nbsp;elm;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Relation &nbsp; &nbsp; &nbsp; &nbsp;seqrel;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* open and AccessShareLock sequence */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; init_sequence(relid, &amp;elm, &amp;seqrel);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (pg_class_aclcheck(elm-&gt;relid, GetUserId(), ACL_SELECT) != ACLCHECK_OK &amp;&amp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pg_class_aclcheck(elm-&gt;relid, GetUserId(), ACL_USAGE) != ACLCHECK_OK)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_INSUFFICIENT_PRIVILEGE),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("permission denied for sequence %s",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RelationGetRelationName(seqrel))));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!elm-&gt;last_valid)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("currval of sequence \"%s\" is not yet defined in this session",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RelationGetRelationName(seqrel))));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; result = elm-&gt;last;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; relation_close(seqrel, NoLock);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_INT64(result);</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div><br></div><div>所以要问序列最后一个消耗的值, 通过'schema.seq_name'.last_value可以查看.</div><div>要问当前会话获得的最后一个序列值, 通过<span style="line-height: 28px;"   >currval函数查看</span></div><div><span style="line-height: 28px;"   >要问下一个序列值, 通过next</span><span style="line-height: 28px;"   >val获取(获取就消耗掉了).</span></div><div><br></div><div>序列操作的相关源码文件 :&nbsp;</div><div>1. src/backend/commands/sequence.c</div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL seqs lastval - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>