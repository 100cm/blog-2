<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL aggregate function 1  : General-Purpose Aggregate Functions</h2>
	<h5 id="">2015-03-02 16:03:52&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020152223539859/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><span style="line-height: 28px;"   >PostgreSQL支持较多的聚合函数, 以PostgreSQL 9.4为例, 支持例如一般性的聚合, 统计学科的聚合, 排序集聚合, 假象集聚合等.</span></div><div><span style="line-height: 28px;"   >本文将对一般性聚合函数举例说明其功能和用法.</span></div><div><span style="line-height: 28px;"   >以下图表参考 :&nbsp;</span></div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/functions-aggregate.html"   >http://www.postgresql.org/docs/9.4/static/functions-aggregate.html</a></div><div><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: normal; background-color: rgb(224, 236, 239);"   ><thead><tr><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Function</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Argument Type(s)</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Return Type</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Description</th></tr></thead><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>array_agg(<tt style="font-style: italic; font-size: 1em;"   >expression</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >any</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >array of the argument type</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >input values, including nulls, concatenated into an array</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>avg(<tt style="font-style: italic; font-size: 1em;"   >expression</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>smallint</tt>,&nbsp;<tt>int</tt>,&nbsp;<tt>bigint</tt>,&nbsp;<tt>real</tt>,&nbsp;<tt>double precision</tt>,&nbsp;<tt>numeric</tt>, or&nbsp;<tt>interval</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>numeric</tt>&nbsp;for any integer-type argument,&nbsp;<tt>double precision</tt>&nbsp;for a floating-point argument, otherwise the same as the argument data type</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >the average (arithmetic mean) of all input values</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>bit_and(<tt style="font-style: italic; font-size: 1em;"   >expression</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>smallint</tt>,&nbsp;<tt>int</tt>,&nbsp;<tt>bigint</tt>, or&nbsp;<tt>bit</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >same as argument data type</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >the bitwise AND of all non-null input values, or null if none</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>bit_or(<tt style="font-style: italic; font-size: 1em;"   >expression</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>smallint</tt>,&nbsp;<tt>int</tt>,&nbsp;<tt>bigint</tt>, or&nbsp;<tt>bit</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >same as argument data type</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >the bitwise OR of all non-null input values, or null if none</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>bool_and(<tt style="font-style: italic; font-size: 1em;"   >expression</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>bool</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>bool</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >true if all input values are true, otherwise false</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>bool_or(<tt style="font-style: italic; font-size: 1em;"   >expression</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>bool</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>bool</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >true if at least one input value is true, otherwise false</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>count(*)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>bigint</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >number of input rows</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>count(<tt style="font-style: italic; font-size: 1em;"   >expression</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >any</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>bigint</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >number of input rows for which the value of&nbsp;<tt style="font-style: italic;"   >expression</tt>&nbsp;is not null</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>every(<tt style="font-style: italic; font-size: 1em;"   >expression</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>bool</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>bool</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >equivalent to&nbsp;<code>bool_and</code></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>json_agg(<tt style="font-style: italic; font-size: 1em;"   >expression</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>any</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>json</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >aggregates values as a JSON array</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>json_object_agg(<tt style="font-style: italic; font-size: 1em;"   >name</tt>,<tt style="font-style: italic; font-size: 1em;"   >value</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>(any, any)</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>json</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >aggregates name/value pairs as a JSON object</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>max(<tt style="font-style: italic; font-size: 1em;"   >expression</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >any array, numeric, string, or date/time type</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >same as argument type</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >maximum value of&nbsp;<tt style="font-style: italic;"   >expression</tt>&nbsp;across all input values</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>min(<tt style="font-style: italic; font-size: 1em;"   >expression</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >any array, numeric, string, or date/time type</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >same as argument type</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >minimum value of&nbsp;<tt style="font-style: italic;"   >expression</tt>&nbsp;across all input values</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>string_agg(<tt style="font-style: italic; font-size: 1em;"   >expression</tt>,<tt style="font-style: italic; font-size: 1em;"   >delimiter</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >(<tt>text</tt>,&nbsp;<tt>text</tt>) or (<tt>bytea</tt>,&nbsp;<tt>bytea</tt>)</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >same as argument types</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >input values concatenated into a string, separated by delimiter</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>sum(<tt style="font-style: italic; font-size: 1em;"   >expression</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>smallint</tt>,&nbsp;<tt>int</tt>,&nbsp;<tt>bigint</tt>,&nbsp;<tt>real</tt>,&nbsp;<tt>double precision</tt>,&nbsp;<tt>numeric</tt>,&nbsp;<tt>interval</tt>, or&nbsp;<tt>money</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>bigint</tt>&nbsp;for&nbsp;<tt>smallint</tt>&nbsp;or&nbsp;<tt>int</tt>&nbsp;arguments,&nbsp;<tt>numeric</tt>&nbsp;for&nbsp;<tt>bigint</tt>&nbsp;arguments, otherwise the same as the argument data type</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >sum of&nbsp;<tt style="font-style: italic;"   >expression</tt>&nbsp;across all input values</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>xmlagg(<tt style="font-style: italic; font-size: 1em;"   >expression</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>xml</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>xml</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >concatenation of XML values (see also<a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/functions-xml.html#FUNCTIONS-XML-XMLAGG"   >Section 9.14.1.7</a>)</td></tr></table></div><div>上图中所有聚合函数, 当没有行输入时, 除了count返回0, 其他都返回null.</div><div>使用sum, array_agg时, 当没有行输入, 返回NULL可能有点别扭, 那么你可以使用coalesce来替代NULL, 如coalesce(sum(x), 0)</div><div><span style="line-height: 28px;"   >coalesce(array_agg(x),&nbsp;</span>'{}'::int[]<span style="line-height: 28px;"   >)</span></div><div>例子 :&nbsp;</div><div>聚合后得到数组, null将计入数组元素</div><div><div>postgres=# select array_agg(id) from (values(null),(1),(2)) as t(id);</div><div>&nbsp;array_agg &nbsp;</div><div>------------</div><div>&nbsp;{NULL,1,2}</div><div>(1 row)</div></div><div><br></div><div>算平均值是不计算null</div><div><div>postgres=# select avg(id) from (values(null),(1),(2)) as t(id);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; avg &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>--------------------</div><div>&nbsp;1.5000000000000000</div><div>(1 row)</div></div><div><div><br></div><div>算bit与|或 时也不计算NULL</div><div>postgres=# select bit_and(id) from (values(null),(1),(2)) as t(id);</div><div>&nbsp;bit_and&nbsp;</div><div>---------</div><div>&nbsp; &nbsp; &nbsp; &nbsp;0</div><div>(1 row)</div><div>postgres=# select bit_or(id) from (values(null),(1),(2)) as t(id);</div><div>&nbsp;bit_or&nbsp;</div><div>--------</div><div>&nbsp; &nbsp; &nbsp; 3</div><div>(1 row)</div></div><div>算布尔逻辑时也不计算NULL</div><div><div>postgres=# select bool_and(id) from (values(null),(true),(false)) as t(id);</div><div>&nbsp;bool_and&nbsp;</div><div>----------</div><div>&nbsp;f</div><div>(1 row)</div></div><div>every是bool_and的别名, 实际上是SQL标准中定义的.&nbsp;</div><div><div>postgres=# select every(id) from (values(null),(true),(false)) as t(id);</div><div>&nbsp;every&nbsp;</div><div>-------</div><div>&nbsp;f</div><div>(1 row)</div><div>SQL标准中还定义了any和some为bool_or的别名, 但是因为any和some还可以被解释为子查询, 所以在PostgreSQL中any和some的布尔逻辑聚合不可用.&nbsp;</div><div>postgres=# select any(id) from (values(null),(true),(false)) as t(id);</div><div>ERROR: &nbsp;syntax error at or near "any"</div><div>LINE 1: select any(id) from (values(null),(true),(false)) as t(id);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</div><div>postgres=# select some(id) from (values(null),(true),(false)) as t(id);</div><div>ERROR: &nbsp;syntax error at or near "some"</div><div>LINE 1: select some(id) from (values(null),(true),(false)) as t(id);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</div></div><div>bool_or的例子</div><div><div>postgres=# select bool_or(id) from (values(null),(true),(false)) as t(id);</div><div>&nbsp;bool_or&nbsp;</div><div>---------</div><div>&nbsp;t</div><div>(1 row)</div></div><div><br></div><div>计算非空的表达式个数, count带表达式时, 不计算null</div><div><div>postgres=# select count(id) from (values(null),(1),(2)) as t(id);</div><div>&nbsp;count&nbsp;</div><div>-------</div><div>&nbsp; &nbsp; &nbsp;2</div><div>(1 row)</div><div><br></div><div>计算表达式(含空值)的个数, count(*)计算null, 注意count(*)是一个独立的聚合函数. 请和count(express)区分开来.</div><div>postgres=# select count(*) from (values(null),(1),(2)) as t(id);</div><div>&nbsp;count&nbsp;</div><div>-------</div><div>&nbsp; &nbsp; &nbsp;3</div><div>(1 row)</div></div><div><div>postgres=# select count(*) from (values(null),(null),(1),(2)) as t(id);</div><div>&nbsp;count&nbsp;</div><div>-------</div><div>&nbsp; &nbsp; &nbsp;4</div><div>(1 row)</div></div><div><br></div><div>聚合后得到json, 不带key的json聚合</div><div><div>postgres=# select json_agg(id) from (values(null),(true),(false)) as t(id);</div><div>&nbsp; &nbsp; &nbsp; json_agg &nbsp; &nbsp; &nbsp;&nbsp;</div><div>---------------------</div><div>&nbsp;[null, true, false]</div><div>(1 row)</div><div><span style="line-height: 28px;"   >聚合后得到json,</span><span style="line-height: 28px;"   >&nbsp;</span>带key的json聚合, 注意key不能为null, 否则报错.</div><div>postgres=# select json_object_agg(c1,c2) from (values('a',null),('b',true),('c',false)) as t(c1,c2);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;json_object_agg &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>-----------------------------------------</div><div>&nbsp;{ "a" : null, "b" : true, "c" : false }</div><div>(1 row)</div></div><div><div>postgres=# select json_object_agg(c1,c2) from (values(null,null),('b',true),('c',false)) as t(c1,c2);</div><div>ERROR: &nbsp;22023: field name must not be null</div><div>LOCATION: &nbsp;json_object_agg_transfn, json.c:1959</div></div><div><br></div><div>计算最大最小值, max, min都不计算null</div><div><div>postgres=# select max(id) from (values(null),(1),(2)) as t(id);</div><div>&nbsp;max&nbsp;</div><div>-----</div><div>&nbsp; &nbsp;2</div><div>(1 row)</div><div>postgres=# select min(id) from (values(null),(1),(2)) as t(id);</div><div>&nbsp;min&nbsp;</div><div>-----</div><div>&nbsp; &nbsp;1</div><div>(1 row)</div></div><div><br></div><div>聚合后得到字符串, 字符串聚合</div><div><div>postgres=# select string_agg(c1,'***') from (values('a',null),('b',true),('c',false)) as t(c1,c2);</div><div>&nbsp;string_agg&nbsp;</div><div>------------</div><div>&nbsp;a***b***c</div><div>(1 row)</div></div><div><div>postgres=# select string_agg(id,'***') from (values(null),('digoal'),('zhou')) as t(id);</div><div>&nbsp; string_agg &nbsp;&nbsp;</div><div>---------------</div><div>&nbsp;digoal***zhou</div><div>(1 row)</div></div><div><br></div><div>计算总和, sum不计算null, 当所有行都是null时, 即没有任何行输入, 返回null.</div><div><div>postgres=# select sum(id) from (values(null),(1),(2)) as t(id);</div><div>&nbsp;sum&nbsp;</div><div>-----</div><div>&nbsp; &nbsp;3</div><div>(1 row)</div></div><div><div>postgres=# select sum(id::int) from (values(null),(null),(null)) as t(id);</div><div>&nbsp;sum&nbsp;</div><div>-----</div><div>&nbsp; &nbsp;&nbsp;</div><div>(1 row)</div></div><div><br></div><div>聚合后得到xml</div><div><div>postgres=# select xmlagg(id::xml) from (values(null),('&lt;foo&gt;digoal&lt;/foo&gt;'),('&lt;bar/&gt;')) as t(id);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;xmlagg &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>-------------------------</div><div>&nbsp;&lt;foo&gt;digoal&lt;/foo&gt;&lt;bar/&gt;</div><div>(1 row)</div></div><div><br></div><div>某些聚合函数得到的结果可能和行的输入顺序有关, 例如array_agg, json_agg, json_object_agg, string_agg, and xmlagg, 以及某些自定义聚合函数. 如何来实现呢?</div><div>支持聚合函数中使用order by的PostgreSQL版本可以用如下语法 :&nbsp;</div><div><div>postgres=# select string_agg(id,'***' order by id) from (values(null),('digoal'),('zhou')) as t(id);</div><div>&nbsp; string_agg &nbsp;&nbsp;</div><div>---------------</div><div>&nbsp;digoal***zhou</div><div>(1 row)</div><div>postgres=# select string_agg(id,'***' order by id desc) from (values(null),('digoal'),('zhou')) as t(id);</div><div>&nbsp; string_agg &nbsp;&nbsp;</div><div>---------------</div><div>&nbsp;zhou***digoal</div><div>(1 row)</div></div><div>不支持<span style="line-height: 28px;"   >聚合函数中使用order by的PostgreSQL版本, 可以用如下语法 :&nbsp;</span></div><div>SELECT xmlagg(x) FROM (SELECT x FROM test ORDER BY y DESC) AS tab;</div><div><div>postgres=# select string_agg(id,'***') from (select id from (values(null),('digoal'),('zhou')) as t(id) order by id desc) t;</div><div>&nbsp; string_agg &nbsp;&nbsp;</div><div>---------------</div><div>&nbsp;zhou***digoal</div><div>(1 row)</div></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/functions-aggregate.html"   >http://www.postgresql.org/docs/9.4/static/functions-aggregate.html</a></div><div>2.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/functions-xml.html"   >http://www.postgresql.org/docs/9.4/static/functions-xml.html</a></div><div>3.&nbsp;src/backend/utils/adt</div><div>这些函数的代码在src/backend/utils/adt这里可以查询到, 对应各自的类型.</div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL aggregate function 1  : General-Purpose Aggregate Functions - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>