<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Swap Consumed very Much When PostgreSQL autovacuum to prevent wraparound</h2>
	<h5 id="">2011-02-14 17:57:52&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020111145124258/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">今天接到监控组的告警，某数据库服务器的SWAP分区消耗超过阀值，消耗约8G。<br>free<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; total&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; used&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; free&nbsp;&nbsp;&nbsp;&nbsp; shared&nbsp;&nbsp;&nbsp; buffers&nbsp;&nbsp;&nbsp;&nbsp; cached<br>Mem:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 24682828&nbsp;&nbsp; 24607764&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 75064&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 10128&nbsp;&nbsp;&nbsp; 6525184<br>-/+ buffers/cache:&nbsp;&nbsp; 18072452&nbsp;&nbsp;&nbsp; 6610376<br>Swap:&nbsp;&nbsp;&nbsp;&nbsp; 16779884&nbsp;&nbsp;&nbsp; 8794580&nbsp;&nbsp;&nbsp; 7985304<br><br>查看过往的SAR报告如下<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kbmemfree kbmemused&nbsp; %memused kbbuffers&nbsp; kbcached kbswpfree kbswpused&nbsp; %swpused&nbsp; kbswpcad<br>02-06<br>Average:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 79193&nbsp; 24603635&nbsp;&nbsp;&nbsp;&nbsp; 99.68&nbsp;&nbsp;&nbsp;&nbsp; 27148&nbsp;&nbsp; 8510109&nbsp; 13953197&nbsp;&nbsp; 2826687&nbsp;&nbsp;&nbsp;&nbsp; 16.85&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 967<br>02-07<br>Average:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 81699&nbsp; 24601129&nbsp;&nbsp;&nbsp;&nbsp; 99.67&nbsp;&nbsp;&nbsp;&nbsp; 23619&nbsp;&nbsp; 8483106&nbsp; 13953178&nbsp;&nbsp; 2826706&nbsp;&nbsp;&nbsp;&nbsp; 16.85&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 985<br>02-08<br>Average:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 73905&nbsp; 24608923&nbsp;&nbsp;&nbsp;&nbsp; 99.70&nbsp;&nbsp;&nbsp;&nbsp; 11064&nbsp;&nbsp; 8504025&nbsp; 13953172&nbsp;&nbsp; 2826712&nbsp;&nbsp;&nbsp;&nbsp; 16.85&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 970<br>02-09<br>Average:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 78953&nbsp; 24603875&nbsp;&nbsp;&nbsp;&nbsp; 99.68&nbsp;&nbsp;&nbsp;&nbsp; 18140&nbsp;&nbsp; 8475291&nbsp; 13953172&nbsp;&nbsp; 2826712&nbsp;&nbsp;&nbsp;&nbsp; 16.85&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 968<br>02-10<br>09:20:01 AM&nbsp;&nbsp;&nbsp;&nbsp; 74356&nbsp; 24608472&nbsp;&nbsp;&nbsp;&nbsp; 99.70&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2580&nbsp;&nbsp; 8361932&nbsp; 13953172&nbsp;&nbsp; 2826712&nbsp;&nbsp;&nbsp;&nbsp; 16.85&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 968<br>09:30:01 AM&nbsp;&nbsp;&nbsp;&nbsp; 74224&nbsp; 24608604&nbsp;&nbsp;&nbsp;&nbsp; 99.70&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3412&nbsp;&nbsp; 8466448&nbsp; 13822936&nbsp;&nbsp; 2956948&nbsp;&nbsp;&nbsp;&nbsp; 17.62&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2956<br>Average:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 77257&nbsp; 24605571&nbsp;&nbsp;&nbsp;&nbsp; 99.69&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 7574&nbsp;&nbsp; 8344604&nbsp; 13196771&nbsp;&nbsp; 3583113&nbsp;&nbsp;&nbsp;&nbsp; 21.35&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1432<br>02-11<br>Average:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 87933&nbsp; 24594895&nbsp;&nbsp;&nbsp;&nbsp; 99.64&nbsp;&nbsp;&nbsp;&nbsp; 10818&nbsp;&nbsp; 7304608&nbsp; 10841381&nbsp;&nbsp; 5938503&nbsp;&nbsp;&nbsp;&nbsp; 35.39&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2315<br>02-12<br>Average:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 82804&nbsp; 24600024&nbsp;&nbsp;&nbsp;&nbsp; 99.66&nbsp;&nbsp;&nbsp;&nbsp; 15113&nbsp;&nbsp; 7149277&nbsp; 10581682&nbsp;&nbsp; 6198202&nbsp;&nbsp;&nbsp;&nbsp; 36.94&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1978<br>02-13<br>Average:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 85698&nbsp; 24597130&nbsp;&nbsp;&nbsp;&nbsp; 99.65&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 7834&nbsp;&nbsp; 7246716&nbsp; 10130720&nbsp;&nbsp; 6649164&nbsp;&nbsp;&nbsp;&nbsp; 39.63&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3248<br>TODAY<br>Average:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 73259&nbsp; 24609569&nbsp;&nbsp;&nbsp;&nbsp; 99.70&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4444&nbsp;&nbsp; 6649324&nbsp;&nbsp; 8273769&nbsp;&nbsp; 8506115&nbsp;&nbsp;&nbsp;&nbsp; 50.69&nbsp;&nbsp;&nbsp;&nbsp; 21545<br><br>数据库日志中包含大量autovacuum 信息,其中有的执行时间比较长。（正常情况下一个autovacuum进程可以占用做多maintenance_work_mem设置的内存大小）<br><br># 查看服务器上占用内存较多的进程pmem (百分比)<br>ps -eo user,rssize,vsize,sz,size,pmem,cmd --sort size|grep postgres<br>以下进程占用70%物理内存<br>postgres 17280128 27504196 6876049 26001504 70.0 postgres: autovacuum launcher process&nbsp; <br>怀疑是服务器内存处理出现问题造成.<br><br>到服务器上杀掉该进程<br>&nbsp;ps -ewf|grep auto<br>postgres&nbsp; 5821&nbsp; 5816&nbsp; 0&nbsp; 2010 ?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 05:13:02 postgres: autovacuum launcher process <br>postgres=# select * from pg_terminate_backend(5821);<br>&nbsp;pg_terminate_backend <br>----------------------<br>&nbsp;t<br>(1 row)<br><br>日志输出如下：<br>2011-02-14 17:47:07.905 CST,,,5821,,4ccfbe6a.16bd,2,,2010-11-02 15:31:54 CST,1/0,0,LOG,00000,"autovacuum launcher shutting down",,,,,,,,,""<br>2011-02-14 17:47:10.005 CST,,,15773,,4d58fa1e.3d9d,1,,2011-02-14 17:47:10 CST,,0,LOG,00000,"autovacuum launcher started",,,,,,,,,""<br><br>autovacuum launcher的主进程为postgres进程，在被终结后自动产生.<br><br>ps -ewf|grep auto<br>postgres 15773&nbsp; 5816&nbsp; 0 17:47 ?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00:00:00 postgres: autovacuum launcher process <br><br>交换分区释放:<br>&nbsp;free<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; total&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; used&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; free&nbsp;&nbsp;&nbsp;&nbsp; shared&nbsp;&nbsp;&nbsp; buffers&nbsp;&nbsp;&nbsp;&nbsp; cached<br>Mem:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 24682828&nbsp;&nbsp;&nbsp; 7307256&nbsp;&nbsp; 17375572&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 10676&nbsp;&nbsp;&nbsp; 6525460<br>-/+ buffers/cache:&nbsp;&nbsp;&nbsp;&nbsp; 771120&nbsp;&nbsp; 23911708<br>Swap:&nbsp;&nbsp;&nbsp;&nbsp; 16779884&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 54836&nbsp;&nbsp; 16725048<br><br>PS输出注释:<br>%mem&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; %MEM&nbsp;&nbsp;&nbsp;&nbsp; ratio of the process’s resident set size&nbsp; to the physical memory on the machine, expressed as a<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; percentage. (alias pmem).<br>rss&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RSS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; resident set size, the non-swapped physical memory that a task has used (in kiloBytes).<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (alias rssize, rsz).<br><br>rssize&nbsp;&nbsp;&nbsp;&nbsp; RSS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; see rss. (alias rss, rsz).<br><br>rsz&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RSZ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; see rss. (alias rss, rssize).<br><br>从上面的解释来看autovacuum launcher 进程占据了约70%的不可交换物理内存.</div>
	</div>
</div>
</body>
</html>