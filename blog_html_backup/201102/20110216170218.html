<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Which ALTER TABLE Operation will rewrite the whole tables</h2>
	<h5 id="">2011-02-16 17:02:18&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201111644133716/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">某些ALTER 表操作可能导致全表重建,包括索引的重建，需要慎重操作。(如set data type操作(不管类型类有没有改变),set with oids和set without oids都会引起全表重建)。<br>除此之外，还需要注意的是:<br>&nbsp; drop column 并不会立刻释放删掉的列的占用空间，仅仅是标记为不可见。同样增加列也不会立刻分配空间。<br>&nbsp; set data type $type USING express 可以用于修改类型的同时更新该字段的值，（如不支持隐形转换的类型更改，或者是既想更改类型又想更新数据，这么做的好处是不会产生二次更新垃圾）<br>&nbsp; SET STORAGE操作针对修改列的存储属性，如释放为普通存储或压缩存储，是否使用TOAST表等等。包含PLAIN , MAIN , EXTERNAL , EXTENDED 四个选择。plain表示普通且INLINE存储，固定长度的值如INT必须选择这个。main表示压缩且INLINE存储。EXTERNAL表示普通且外部存储。EXTENDED表示压缩且外部存储。外部存储将会新建一个TOAST表，外部存储的好处是提高超长字段的处理效率。改变列存储属性不会对已经存在的数据做修改，对后续操作有效。<br>&nbsp; SET TABLESPACE也是比较大的操作，会把表的数据文件拷贝到指定的表空间，所以最好一开始就规划好表空间。<br>最后的建议是:<br>&nbsp;&nbsp; 对于会重写表的操作，尽量合并为一句SQL搞定，减少表的扫描次数和IO操作次数。<br><br>ALTER TABLE的语法:<br><pre><pre class="prettyprint"  ><p><font size="2"  >ALTER TABLE [ ONLY ] <tt><i>name</i></tt> [ * ]<br>    <tt><i>action</i></tt> [, ... ]<br>ALTER TABLE [ ONLY ] <tt><i>name</i></tt> [ * ]<br>    RENAME [ COLUMN ] <tt><i>column</i></tt> TO <tt><i>new_column</i></tt><br>ALTER TABLE <tt><i>name</i></tt><br>    RENAME TO <tt><i>new_name</i></tt><br>ALTER TABLE <tt><i>name</i></tt><br>    SET SCHEMA <tt><i>new_schema</i></tt><br><br>where <tt><i>action</i></tt> is one of:<br><br>    ADD [ COLUMN ] <tt><i>column</i></tt> <tt><i>type</i></tt> [ <tt><i>column_constraint</i></tt> [ ... ] ]<br>    DROP [ COLUMN ] [ IF EXISTS ] <tt><i>column</i></tt> [ RESTRICT | CASCADE ]<br>    ALTER [ COLUMN ] <tt><i>column</i></tt> [ SET DATA ] TYPE <tt><i>type</i></tt> [ USING <tt><i>expression</i></tt> ]<br>    ALTER [ COLUMN ] <tt><i>column</i></tt> SET DEFAULT <tt><i>expression</i></tt><br>    ALTER [ COLUMN ] <tt><i>column</i></tt> DROP DEFAULT<br>    ALTER [ COLUMN ] <tt><i>column</i></tt> { SET | DROP } NOT NULL<br>    ALTER [ COLUMN ] <tt><i>column</i></tt> SET STATISTICS <tt><i>integer</i></tt><br>    ALTER [ COLUMN ] <tt><i>column</i></tt> SET ( <tt><i>attribute_option</i></tt> = <tt><i>value</i></tt> [, ... ] )<br>    ALTER [ COLUMN ] <tt><i>column</i></tt> RESET ( <tt><i>attribute_option</i></tt> [, ... ] )<br>    ALTER [ COLUMN ] <tt><i>column</i></tt> SET STORAGE { PLAIN | EXTERNAL | EXTENDED | MAIN }<br>    ADD <tt><i>table_constraint</i></tt><br>    DROP CONSTRAINT [ IF EXISTS ]  <tt><i>constraint_name</i></tt> [ RESTRICT | CASCADE ]<br>    DISABLE TRIGGER [ <tt><i>trigger_name</i></tt> | ALL | USER ]<br>    ENABLE TRIGGER [ <tt><i>trigger_name</i></tt> | ALL | USER ]<br>    ENABLE REPLICA TRIGGER <tt><i>trigger_name</i></tt><br>    ENABLE ALWAYS TRIGGER <tt><i>trigger_name</i></tt><br>    DISABLE RULE <tt><i>rewrite_rule_name</i></tt><br>    ENABLE RULE <tt><i>rewrite_rule_name</i></tt><br>    ENABLE REPLICA RULE <tt><i>rewrite_rule_name</i></tt><br>    ENABLE ALWAYS RULE <tt><i>rewrite_rule_name</i></tt><br>    CLUSTER ON <tt><i>index_name</i></tt><br>    SET WITHOUT CLUSTER<br>    SET WITH OIDS<br>    SET WITHOUT OIDS<br>    SET ( <tt><i>storage_parameter</i></tt> = <tt><i>value</i></tt> [, ... ] )<br>    RESET ( <tt><i>storage_parameter</i></tt> [, ... ] )<br>    INHERIT <tt><i>parent_table</i></tt><br>    NO INHERIT <tt><i>parent_table</i></tt><br>    OWNER TO <tt><i>new_owner</i></tt><br>    SET TABLESPACE <tt><i>new_tablespace</i></tt></font></p></pre></pre><br>下面是举例：（从操作时间上就可以看出 set data type操作(不管类型类有没有改变),set with oids和set without oids都会引起全表重建 ）<br><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; create table tbl_user (id int primary key,firstname varchar(32),lastname varchar(32),corp varchar(32),age int);<br>NOTICE:&nbsp; CREATE TABLE / PRIMARY KEY will create implicit index "tbl_user_pkey" for table "tbl_user"<br>CREATE TABLE<br>Time: 51.633 ms<br>digoal=&gt; insert into tbl_user select generate_series(1,1000000),'zhou','digoal','sky-mobi',27;<br>INSERT 0 1000000<br>Time: 3837.951 ms<br>digoal=&gt; analyze tbl_user;<br>ANALYZE<br>Time: 118.823 ms<br>digoal=&gt; select pg_relation_size('tbl_user');<br>&nbsp;pg_relation_size <br>------------------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 60235776<br>(1 row)<br><br>Time: 0.370 ms<br>digoal=&gt; alter table tbl_user drop column firstname;<br>ALTER TABLE<br>Time: 0.363 ms<br>digoal=&gt; analyze tbl_user;<br>ANALYZE<br>Time: 111.081 ms<br>digoal=&gt; select pg_relation_size('tbl_user');<br>&nbsp;pg_relation_size <br>------------------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 60235776<br>(1 row)<br><br>Time: 0.447 ms<br>digoal=&gt; alter table tbl_user add column firstname varchar(32);<br>ALTER TABLE<br>Time: 0.521 ms<br>digoal=&gt; analyze tbl_user;<br>ANALYZE<br>Time: 80.384 ms<br>digoal=&gt; select pg_relation_size('tbl_user');<br>&nbsp;pg_relation_size <br>------------------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 60235776<br>(1 row)<br><br>Time: 0.297 ms<br>digoal=&gt; alter table tbl_user alter column firstname set data type varchar(64);<br>ALTER TABLE<br>Time: 6432.210 ms</font></p></pre># 设置和当前相同类型,同样全表重写<br><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; alter table tbl_user alter column firstname set data type varchar(64);<br>ALTER TABLE<br>Time: 4751.493 ms<br>digoal=&gt; analyze tbl_user ;<br>ANALYZE<br>Time: 101.746 ms<br>digoal=&gt; select pg_relation_size('tbl_user');<br>&nbsp;pg_relation_size <br>------------------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 52183040<br>(1 row)<br><br>Time: 0.296 ms<br>digoal=&gt; alter table tbl_user alter column firstname set default 'zhou';<br>ALTER TABLE<br>Time: 31.990 ms<br><br>digoal=&gt; alter table tbl_user alter column firstname drop default ;<br>ALTER TABLE<br>Time: 0.494 ms<br><br>digoal=&gt; alter table tbl_user alter column lastname set not null ;<br>ALTER TABLE<br>Time: 100.171 ms</font></p></pre># set with oids和set without oids重写整表<br><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; insert into tbl_user(id,lastname) select generate_series(1000001,2000000),'DIGOAL';<br>INSERT 0 1000000<br>Time: 3723.678 ms<br>digoal=&gt; alter table tbl_user set with oids;<br>ALTER TABLE<br>Time: 11461.001 ms<br>digoal=&gt; analyze tbl_user;<br>ANALYZE<br>Time: 171.743 ms<br>digoal=&gt; select pg_relation_size('tbl_user');<br>-[ RECORD 1 ]----+----------<br>pg_relation_size | 112418816<br><br>Time: 0.290 ms<br>digoal=&gt; alter table tbl_user set without oids;<br>ALTER TABLE<br>Time: 10742.167 ms<br>digoal=&gt; select pg_relation_size('tbl_user');<br>-[ RECORD 1 ]----+---------<br>pg_relation_size | 96460800<br><br>Time: 0.456 ms<br>digoal=&gt; analyze tbl_user;<br>ANALYZE<br>Time: 166.247 ms<br>digoal=&gt; select pg_relation_size('tbl_user');<br>-[ RECORD 1 ]----+---------<br>pg_relation_size | 96460800<br><br>Time: 0.276 ms</font></p></pre></div>
	</div>
</div>
</body>
</html>