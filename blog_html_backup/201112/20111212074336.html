<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL QQ群 FAQ贴 - 1</h2>
	<h5 id="">2011-12-12 7:43:36&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402011111274336235/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">QQ群里一些网友问到的问题，收集如下 :&nbsp;<div>目录 :&nbsp;</div><div><span style="line-height: 22px;"   >1. PostgreSQL存储过程中自定义异常怎么弄?</span> </div><div><span style="line-height: 22px;"   >2. PostgreSQL9.1的同步事务在某些情况下用户主动cancel等待sync replication standby 的acknowledge,实际本地已提交.</span> </div><div><span style="line-height: 22px;"   >3.&nbsp;</span><span style="line-height: 22px;"   >PostgreSQL如何满足已经存在则更新, 不存在则插入的需求.</span></div><div><span style="line-height: 22px;"   >4.&nbsp;</span><span style="line-height: 22px;"   >copy和insert哪个效率高?</span></div><div><span style="line-height: 22px;"   >5.&nbsp;</span><span style="line-height: 22px;"   >PostgreSQL能不能限制数据库的大小?</span></div><div><span style="line-height: 22px;"   >6.&nbsp;</span><span style="line-height: 22px;"   >怎样给一个用户授予只读角色?</span></div><div><span style="line-height: 22px;"   >7.&nbsp;</span><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 25px;"   >不想让数据插入到某个表应该怎么做?</span></div><div><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 25px;"   >8.&nbsp;</span><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   ><span style="line-height: 25px;"   >PostgreSQL 中有没有rownum这样的，显示结果集的序号?</span></font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   ><span style="line-height: 25px;"   >9. PostgreSQL 函数中如何使用savepoint?</span></font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   ><span style="line-height: 25px;"   >10.请问, pg脚本有宏替换, 计算字符串公式的能力? 类似 a=2 ; evaluate('5-a') ; 如果将这个值赋值给这个变量呢? zresult = evaluate('5-a') ;</span></font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   ><span style="line-height: 25px;"   >11.UPDATE A表 FROM B表 ?</span></font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   ><span style="line-height: 25px;"   >12. hex转decimal</span></font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   ><span style="line-height: 25px;"   >13. PostgreSQL 时区.</span></font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   ><span style="line-height: 25px;"   >14. PostgreSQL 不同的版本, 只读事务中是否允许 nextval() 取序列值;</span></font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   ><span style="line-height: 25px;"   >15.&nbsp;</span></font>修改数据库记录的时候, 如何才能做到指修改日期, 而不修改时间? &nbsp;例如 2012-06-16 08:20:12 &nbsp; 改为 2012-07-01 08:20:12 ?</div><div><span style="line-height: 22px;"   >16. PostgreSQL 什么情况下模糊查询可以使用索引扫描?</span></div><div><span style="line-height: 22px;"   >17. INT类型如何显示前导0, 例如01,001.</span></div><div><span style="line-height: 22px;"   >18.&nbsp;</span>postgresql能不能把在某个数据库上执行过的所有SQL都记录下来.</div><div>19.&nbsp;在postgreSQL写SQL语句，更新字段里的值，该字段的值是这样的形式{"x":114.310134, "y":30.522772, "spatialReference":{"wkid":4326}，需要更新字符串里X Y的值，值是从其它变表查出来的，该如何写SQL语句呢？</div><div>20. PostgreSQL 列类型匹配判断. IS OF, IS NOT OF表达式.</div><div>21. PostgreSQL 字符串排序和什么有关.</div><div>22. PostgreSQL 支持的SQL最大长度.</div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >内容 :&nbsp;</span></div><div>1. Q :&nbsp;</div><div>postgresql存储过程中自定义异常怎么弄?</div><div>A :&nbsp;</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/plpgsql-errors-and-messages.html"   >http://www.postgresql.org/docs/9.1/static/plpgsql-errors-and-messages.html</a></div><div><div><div><br><wbr></div></div></div>2. Q :&nbsp;<div>PostgreSQL9.1的同步事务在某些情况下用户主动cancel等待sync replication standby 的acknowledge,实际本地已提交.返回如下:</div><div><div>canceling the wait for synchronous replication and terminating connection due to administrator command.</div><div><div>The transaction has already committed locally, but might not have been replicated to the standby.</div></div><div>或者,</div><div>canceling wait for synchronous replication due to user request</div><div>The transaction has already committed locally, but might not have been replicated to the standby.</div><div>A :&nbsp;</div><div>原因是,</div><div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* If a wait for synchronous replication is pending, we can neither</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* acknowledge the commit nor raise ERROR or FATAL. &nbsp;The latter would</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* lead the client to believe that that the transaction aborted, which</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* is not true: it's already committed locally. The former is no good</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* either: the client has requested synchronous replication, and is</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* entitled to assume that an acknowledged commit is also replicated,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* which might not be true. So in this case we issue a WARNING (which</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* some clients may be able to interpret) and shut off further output.</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* We do NOT reset ProcDiePending, so that the process will die after</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* the commit is cleaned up.</div></div><div>或者</div><div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* It's unclear what to do if a query cancel interrupt arrives. &nbsp;We</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* can't actually abort at this point, but ignoring the interrupt</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* altogether is not helpful, so we just terminate the wait with a</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* suitable warning.</div></div><div>详细参考, src/backend/replication/syncrep.c</div></div><br><div>3. Q :&nbsp;</div><div>PostgreSQL如何满足已经存在则更新, 不存在则插入的需求.</div><div>A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; create table exists_test (id int primary key,info text);</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "exists_test_pkey" for table "exists_test"</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >digoal=&gt; create or replace function insert_exists_test(i_id int,i_info text) returns void as $BODY$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >perform 1 from exists_test where id=i_id;</font></div><div><font size="2"   >if not found then</font></div><div><font size="2"   >insert into exists_test(id,info) values (i_id,i_info);</font></div><div><font size="2"   >return;</font></div><div><font size="2"   >else</font></div><div><font size="2"   >update exists_test set info=i_info where id=i_id;</font></div><div><font size="2"   >return;</font></div><div><font size="2"   >end if;</font></div><div><font size="2"   >exception</font></div><div><font size="2"   >when others then</font></div><div><font size="2"   >raise exception 'Insert exists_test(id,info) values(%,%) error.',i_id,i_info;</font></div><div><font size="2"   >return;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$BODY$ language plpgsql;</font></div></div><div><font size="2"   >digoal=&gt; select insert_exists_test(1,'digoal');</font></div><div><font size="2"   >digoal=&gt; select insert_exists_test(1,'adigoal');</font></div><div><font size="2"   >digoal=&gt; select * from exists_test ;</font></div><div><div><font size="2"   >&nbsp;id | &nbsp;info &nbsp;&nbsp;</font></div><div><font size="2"   >----+---------</font></div></div><div><font size="2"   >&nbsp; 1 | adigoal</font></div><p></p></pre></div><br><div>4. Q :&nbsp;</div><div>copy和insert哪个效率高?</div><div>A :&nbsp;</div><div>COPY效率高.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create table copy_insert_compare(id int,info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=&gt; insert into copy_insert_compare select generate_series(1,1000000),'digoal_test';</font></div><div><font size="2"   >INSERT 0 1000000</font></div><p></p></pre></div><div>copy到文件</div><div><pre class="prettyprint"   ><p>digoal=# copy digoal.copy_insert_compare to '/home/postgres/copy_insert_compare';</p></pre></div><div>导出为insert语句</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg_dump -f ./copy_insert_compare.sql -F p -E UTF8 -t digoal.copy_insert_compare --inserts -h 127.0.0.1 -U digoal digoal</font></div><div><div><font size="2"   >-rw-r--r-- 1 postgres postgres &nbsp;19M Dec 13 12:07 copy_insert_compare</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres &nbsp;61M Dec 13 12:09 copy_insert_compare.sql</font></div></div><p></p></pre></div><div>首先文件大小就相差几倍.</div><div>COPY导入时间，</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# copy digoal.copy_insert_compare from '/home/postgres/copy_insert_compare';</font></div><div><font size="2"   >COPY 1000000</font></div><div><font size="2"   >Time: 1456.939 ms</font></div><p></p></pre></div><div>insert导入时间，</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres@db-172-16-3-150-&gt; date;nohup psql -h 127.0.0.1 digoal digoal -f ./copy_insert_compare.sql &gt;/dev/null 2&gt;&amp;1;date;</font></div><div><font size="2"   >Tue Dec 13 12:14:48 CST 2011</font></div></div><div><div><font size="2"   >Tue Dec 13 12:16:56 CST 2011,&nbsp;128秒</font></div></div><p></p></pre></div><div>单一事务insert导入时间,(开始部分加入begin;结束部分加入commit;)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-150-&gt; date;nohup psql -h 127.0.0.1 digoal digoal -f ./copy_insert_compare.sql &gt;/dev/null 2&gt;&amp;1;date;</font></div><div><font size="2"   >Tue Dec 13 12:17:23 CST 2011</font></div><div><font size="2"   >Tue Dec 13 12:19:28 CST 2011, 125秒</font></div><p></p></pre></div><div>insert 慢了将近100倍。</div><br><div><div style="line-height: 22px;"   >5. Q :&nbsp;</div><div style="line-height: 22px;"   >PostgreSQL能不能限制数据库的大小?</div><div style="line-height: 22px;"   >A :&nbsp;</div><div style="line-height: 22px;"   >目前PostgreSQL对数据库, 表空间的大小都没有限制. 如果要限制表空间的大小, 可以考虑利用文件系统的配合来实现, 如linux的quota.</div></div><br><div>6. Q :&nbsp;</div><div>怎样给一个用户授予只读角色?</div><div>A :&nbsp;</div><div>PostgreSQL没有只读角色这个权限，但是可以通过修改用户的默认参数来达到只读的目的，如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select usename,useconfig from pg_user where usename='digoal';</font></div><div><font size="2"   >&nbsp;usename | useconfig&nbsp;</font></div><div><font size="2"   >---------+-----------</font></div><div><font size="2"   >&nbsp;digoal &nbsp;|&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=# alter role digoal set default_transaction_read_only=true;</font></div><div><font size="2"   >ALTER ROLE</font></div><div><font size="2"   >digoal=# select usename,useconfig from pg_user where usename='digoal';</font></div><div><font size="2"   >&nbsp;usename | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;useconfig &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------+--------------------------------------</font></div><div><font size="2"   >&nbsp;digoal &nbsp;| {default_transaction_read_only=true}</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>连接到digoal用户进行验证,</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \c digoal digoal</font></div><div><font size="2"   >You are now connected to database "digoal" as user "digoal".</font></div><div><font size="2"   >digoal=&gt; insert into test values (1);</font></div><div><font size="2"   >ERROR: &nbsp;cannot execute INSERT in a read-only transaction</font></div><div><font size="2"   >digoal=&gt; delete from test ;</font></div><div><font size="2"   >ERROR: &nbsp;cannot execute DELETE in a read-only transaction</font></div><div><font size="2"   >digoal=&gt; drop table test ;</font></div><div><font size="2"   >ERROR: &nbsp;cannot execute DROP TABLE in a read-only transaction</font></div><p></p></pre></div><div>重置用户参数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; \c postgres postgres</font></div><div><font size="2"   >You are now connected to database "postgres" as user "postgres".</font></div><div><font size="2"   >postgres=# alter role digoal reset default_transaction_read_only;</font></div><div><font size="2"   >ALTER ROLE</font></div></div><div><div><font size="2"   >postgres=# select usename,useconfig from pg_user where usename='digoal';</font></div><div><font size="2"   >&nbsp;usename | useconfig&nbsp;</font></div><div><font size="2"   >---------+-----------</font></div><div><font size="2"   >&nbsp;digoal &nbsp;|&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><br><div>7. Q :&nbsp;</div><div>不想让数据插入到某个表应该怎么做?</div><div>A :&nbsp;</div><div>创建do instead nothing规则, 例如</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; create rule r_insert as on insert to test do instead nothing;</font></div><div><font size="2"   >CREATE RULE</font></div><div><font size="2"   >digoal=&gt; insert into test values (1);</font></div><div><font size="2"   >INSERT 0 0</font></div></div><div><div><font size="2"   >digoal=&gt; select * from test ;</font></div><div><font size="2"   >&nbsp;id&nbsp;</font></div><div><font size="2"   >----</font></div><div><font size="2"   >(0 rows)</font></div></div><p></p></pre></div><br><div>8. Q :&nbsp;</div><div><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 25px;"   >PostgresQL 中有没有rownum这样的，显示结果集的序号?</span> </div><div><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 25px;"   >A :&nbsp;</span></div><div><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 25px;"   >在Oracle里面rownum可以用来标示行号, 如 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >SQL&gt; select rownum,table_name from dba_tables where rownum&lt;10;</font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   ><br></font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >&nbsp; &nbsp; ROWNUM TABLE_NAME</font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >---------- ------------------------------</font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 ICOL$</font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 CON$</font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3 UNDO$</font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 PROXY_ROLE_DATA$</font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5 FILE$</font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6 UET$</font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;7 IND$</font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8 SEG$</font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9 COL$</font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   ><br></font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >9 rows selected.</font></div><p></p></pre></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   >PostgreSQL使用窗口函数row_number()可以满足同样的需求</font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from (select row_number() over() as rownum,tablename from pg_tables) t where rownum&lt;10;</font></div><div><font size="2"   >&nbsp;rownum | &nbsp; &nbsp;tablename &nbsp; &nbsp;</font></div><div><font size="2"   >--------+-----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 1 | pg_statistic</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 2 | pg_type</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 3 | pg_attribute</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 4 | pg_authid</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 5 | pg_proc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 6 | pg_class</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 7 | pg_database</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 8 | pg_user_mapping</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 9 | pg_constraint</font></div><div><font size="2"   >(9 rows)</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 25px;"   >9. Q :&nbsp;</span></div><div><span style="line-height: 25px;"   >PostgreSQL 函数中如何使用savepoint?</span> </div><div><span style="line-height: 25px;"   >A :&nbsp;</span></div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402011112635938640/"   >http://blog.163.com/digoal@126/blog/static/1638770402011112635938640/</a> </div><div><span style="line-height: 25px;"   ><br></span></div></font></div><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 25px;"   >10. Q :&nbsp;</span><div><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 25px;"   >请问, pg脚本有宏替换, 计算字符串公式的能力? 类似 a=2 ; evaluate('5-a') ; 如果将这个值赋值给这个变量呢? result = evaluate('5-a') ;</span> <div><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 25px;"   >A :&nbsp;</span></div></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   ><span style="line-height: 25px;"   >PostgreSQL支持DO来执行匿名块, 实现类似上述的功能如下 :&nbsp;</span></font></div><div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51);"   ><pre class="prettyprint"   ><p></p><div style="line-height: 25px;"   ><font size="2"   >postgres=# do $$</font></div><div style="line-height: 25px;"   ><font size="2"   >postgres$# declare</font></div><div style="line-height: 25px;"   ><font size="2"   >postgres$# a int;</font></div><div style="line-height: 25px;"   ><font size="2"   >postgres$# result int;</font></div><div style="line-height: 25px;"   ><font size="2"   >postgres$# begin</font></div><div style="line-height: 25px;"   ><font size="2"   >postgres$# a := 2;</font></div><div style="line-height: 25px;"   ><font size="2"   >postgres$# result := 5-a;</font></div><div style="line-height: 25px;"   ><font size="2"   >postgres$# raise notice '%', result;</font></div><div style="line-height: 25px;"   ><font size="2"   >postgres$# end</font></div><div style="line-height: 25px;"   ><font size="2"   >postgres$# $$</font></div><div style="line-height: 25px;"   ><font size="2"   >postgres-# ;</font></div><div style="line-height: 25px;"   ><font size="2"   >NOTICE: &nbsp;3</font></div><div style="line-height: 25px;"   ><font size="2"   >DO</font></div><p></p></pre></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51); line-height: 25px;"   >另外, 通过PostgreSQL的客户端psql定义的变量也可以实现 :&nbsp;</div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51);"   ><div style="line-height: 25px;"   >设置变量和它的值</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \set a 2</font></div><div><font size="2"   >postgres=# \set result 5-:a</font></div><p></p></pre></div><div style="line-height: 25px;"   >输出变量的值</div><div><pre class="prettyprint"   ><p></p><div style="line-height: 25px;"   ><font size="2"   >postgres=# select :result;</font></div><div style="line-height: 25px;"   ><font size="2"   >&nbsp;?column?&nbsp;</font></div><div style="line-height: 25px;"   ><font size="2"   >----------</font></div><div style="line-height: 25px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 3</font></div><div style="line-height: 25px;"   ><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51); line-height: 25px;"   ><span style="line-height: 22px;"   >输出变量的值</span> </div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51);"   ><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \echo :a</font></div><div><font size="2"   >2</font></div><div><font size="2"   >postgres=# \echo :result</font></div><div><font size="2"   >5-:a</font></div><p></p></pre></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51); line-height: 25px;"   >输出当前psql下的所有变量</div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51);"   ><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \set</font></div><div><font size="2"   >AUTOCOMMIT = 'on'</font></div><div><font size="2"   >PROMPT1 = '%/%R%# '</font></div><div><font size="2"   >PROMPT2 = '%/%R%# '</font></div><div><font size="2"   >PROMPT3 = '&gt;&gt; '</font></div><div><font size="2"   >VERBOSITY = 'default'</font></div><div><font size="2"   >VERSION = 'PostgreSQL 9.1.2 on x86_64-unknown-linux-gnu, compiled by gcc (GCC) 4.1.2 20080704 (Red Hat 4.1.2-51), 64-bit'</font></div><div><font size="2"   >DBNAME = 'postgres'</font></div><div><font size="2"   >USER = 'postgres'</font></div><div><font size="2"   >HOST = '127.0.0.1'</font></div><div><font size="2"   >PORT = '1931'</font></div><div><font size="2"   >ENCODING = 'UTF8'</font></div><div><font size="2"   >LASTOID = '0'</font></div><div><font size="2"   >a = '2'</font></div><div><font size="2"   >result = '5-:a'</font></div><p></p></pre></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51); line-height: 25px;"   >删除变量</div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51);"   ><pre class="prettyprint"   ><p></p><div style="line-height: 25px;"   ><font size="2"   >\unset a</font></div><div style="line-height: 25px;"   ><font size="2"   >\unset result</font></div><p></p></pre></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51); line-height: 25px;"   >可以参考man psql</div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51); line-height: 25px;"   ><br></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51); line-height: 25px;"   ><span style="line-height: 25px;"   >11. Q :&nbsp;</span></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51); line-height: 25px;"   ><span style="line-height: 25px;"   >UPDATE A表 FROM B表 ?</span> </div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51); line-height: 25px;"   ><span style="line-height: 25px;"   >A :&nbsp;</span></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51); line-height: 25px;"   ><span style="line-height: 25px;"   >首先A表和B表需要有关联的列, 关联之后A表和B表应该是多对一或者一对一的关系,&nbsp;</span></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51); line-height: 25px;"   ><span style="line-height: 25px;"   >如果是一对多会怎么样呢? 测试如下 :&nbsp;</span></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51);"   ><pre class="prettyprint"   ><p></p><div><font size="2"   >sar=&gt; create table a (id int primary key, info text);</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "a_pkey" for table "a"</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >sar=&gt; create table b (id int, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >sar=&gt; insert into a select generate_series(1,10),'digoal';</font></div><div><font size="2"   >INSERT 0 10</font></div><div><font size="2"   >sar=&gt; insert into b select generate_series(1,10),'Digoal';</font></div><div><font size="2"   >INSERT 0 10</font></div><div><font size="2"   >sar=&gt; insert into b select generate_series(1,10),'DIGOAL';</font></div><div><font size="2"   >INSERT 0 10</font></div><div><font size="2"   >sar=&gt; select * from a where id=1;</font></div><div><font size="2"   >&nbsp;id | &nbsp;info &nbsp;</font></div><div><font size="2"   >----+--------</font></div><div><font size="2"   >&nbsp; 1 | digoal</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >sar=&gt; select * from b where id=1;</font></div><div><font size="2"   >&nbsp;id | &nbsp;info &nbsp;</font></div><div><font size="2"   >----+--------</font></div><div><font size="2"   >&nbsp; 1 | Digoal</font></div><div><font size="2"   >&nbsp; 1 | DIGOAL</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51);"   >执行如下更新之后, a.id 会等于什么呢? 是Digoal, 还是DIGOAL.</div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51);"   ><pre class="prettyprint"   ><p></p><div><font size="2"   >sar=&gt; update a set info=b.info from b where a.id=b.id and a.id=1;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >sar=&gt; select * from a where id=1;</font></div><div><font size="2"   >&nbsp;id | &nbsp;info &nbsp;</font></div><div><font size="2"   >----+--------</font></div><div><font size="2"   >&nbsp; 1 | Digoal</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51);"   >看起来是第一次匹配到的B表的那条记录的info值.</div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51);"   >所以在做多表关联的更新操作时, 需要注意这一点.</div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51);"   ><br></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51);"   >12.&nbsp;</div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51);"   >基本的用法是 &nbsp;<span style="color: rgb(0, 0, 0); font-family: Verdana, Geneva, Helvetica, Arial, sans-serif; font-size: 13px; line-height: normal; text-align: -webkit-auto;"   >SELECT x'FF'::integer; 一般写成函数.</span></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51);"   ><span style="color: rgb(0, 0, 0); font-family: Verdana, Geneva, Helvetica, Arial, sans-serif; font-size: 13px; line-height: normal; text-align: -webkit-auto;"   >可参看,&nbsp;</span></div><div><a style="font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(51, 51, 51); line-height: 25px; " rel="nofollow" href="http://postgresql.1045698.n5.nabble.com/Hex-to-Dec-Conversion-td3218223.html"   >http://postgresql.1045698.n5.nabble.com/Hex-to-Dec-Conversion-td3218223.html</a></div></div><br><div>13.&nbsp;</div><div>时区参看</div><div>timezone参数</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/runtime-config-client.html#RUNTIME-CONFIG-CLIENT-FORMAT"   >http://www.postgresql.org/docs/9.1/static/runtime-config-client.html#RUNTIME-CONFIG-CLIENT-FORMAT</a> </div><div>pg_timezone_names表</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/view-pg-timezone-names.html"   >http://www.postgresql.org/docs/9.1/static/view-pg-timezone-names.html</a> </div><div>或</div><div>src/backend/utils/adt/timestamp.c</div><div><br></div><div><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 25px;"   >14. PostgreSQL 不同的版本, 只读事务中是否允许 nextval() 取序列值;</span> </div><div><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 25px;"   >8.3 允许只读事务通过nextval()取序列值.</span></div><div><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >psql</font></div><div><font size="2"   >Welcome to psql 8.3.5, the PostgreSQL interactive terminal.</font></div></div><div><div><font size="2"   >postgres=# create sequence seq_test;</font></div><div><font size="2"   >CREATE SEQUENCE</font></div><div><font size="2"   >postgres=# begin transaction read only;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# select nextval('seq_test'::regclass);</font></div><div><font size="2"   >&nbsp;nextval&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div style="line-height: 25px;"   ><br></div></span></div><div><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 25px;"   >从9.0版本开始不允许.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >psql (9.1.3)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><div><font size="2"   >postgres=# create sequence seq_test;</font></div><div><font size="2"   >CREATE SEQUENCE</font></div><div><font size="2"   >postgres=# begin transaction read only;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   ><span style="line-height: 21px;"   >postgres=# select nextval('seq');<br>ERROR:  25006: cannot execute nextval() in a read-only transaction<br>LOCATION:  PreventCommandIfReadOnly, utility.c:228</span></font></div></div><p></p></pre></div><div>源码分析 :&nbsp;</div><div>9.0版本开始, 增加了一个只读事务的判断, 某些命令(包括更改序列值的命令, 例如nextval)在只读事务中不允许执行.</div><div>源码如下 :&nbsp;</div><div>src/backend/tcop/utility.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* check_xact_readonly: is a utility command read-only?</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Here we use the loose rules of XactReadOnly mode: no permanent effects</font></div><div><font size="2"   >&nbsp;* on the database are allowed.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static void</font></div><div><font size="2"   >check_xact_readonly(Node *parsetree)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!XactReadOnly)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Note: Commands that need to do more complicated checking are handled</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* elsewhere, in particular COPY and plannable statements do their own</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* checking. &nbsp;However they should all call PreventCommandIfReadOnly to</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* actually throw the error.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; switch (nodeTag(parsetree))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_AlterDatabaseStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_AlterDatabaseSetStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_AlterDomainStmt:</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_AlterFunctionStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_AlterRoleStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_AlterRoleSetStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_AlterObjectSchemaStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_AlterOwnerStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_AlterSeqStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_AlterTableStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_RenameStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CommentStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_DefineStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CreateCastStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CreateConversionStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CreatedbStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CreateDomainStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CreateFunctionStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CreateRoleStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_IndexStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CreatePLangStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CreateOpClassStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CreateOpFamilyStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_AlterOpFamilyStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_RuleStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CreateSchemaStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CreateSeqStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CreateStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CreateTableSpaceStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CreateTrigStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CompositeTypeStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CreateEnumStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_ViewStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_DropCastStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_DropStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_DropdbStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_DropTableSpaceStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_RemoveFuncStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_DropRoleStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_DropPLangStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_RemoveOpClassStmt:</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_RemoveOpFamilyStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_DropPropertyStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_GrantStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_GrantRoleStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_AlterDefaultPrivilegesStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_TruncateStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_DropOwnedStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_ReassignOwnedStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_AlterTSDictionaryStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_AlterTSConfigurationStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CreateFdwStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_AlterFdwStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_DropFdwStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CreateForeignServerStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_AlterForeignServerStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_DropForeignServerStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CreateUserMappingStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_AlterUserMappingStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_DropUserMappingStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_AlterTableSpaceOptionsStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PreventCommandIfReadOnly(CreateCommandTag(parsetree));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* do nothing */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* PreventCommandIfReadOnly: throw error if XactReadOnly</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* This is useful mainly to ensure consistency of the error message wording;</font></div><div><font size="2"   >&nbsp;* most callers have checked XactReadOnly for themselves.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >void</font></div><div><font size="2"   >PreventCommandIfReadOnly(const char *cmdname)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (XactReadOnly)</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_READ_ONLY_SQL_TRANSACTION),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* translator: %s is name of a SQL command, eg CREATE */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("cannot execute %s in a read-only transaction",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmdname)));</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><br><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   style="line-height: 22px;"   ><span style="line-height: 25px;"   >15.&nbsp;</span></font><span style="line-height: 22px;"   >修改数据库记录的时候, 如何才能做到指修改日期, 而不修改时间? &nbsp;例如 2012-06-16 08:20:12 &nbsp; 改为 2012-07-01 08:20:12 ?</span> </div><div>A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >column_name::time+changed_date</font></div><div><div><font size="2"   >for example :&nbsp;</font></div><div><font size="2"   >postgres=&gt; create table test (col1 timestamp(0));</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=&gt; insert into test values (now());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=&gt; select * from test;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; col1 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;2012-07-02 13:53:38</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=&gt; update test set col1 = '2011-01-01'::date+col1::time;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=&gt; select * from test;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; col1 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;2011-01-01 13:53:38</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><span style="line-height: 22px;"   ><div><span style="line-height: 22px;"   ><br></span></div>16. PostgreSQL 什么情况下模糊查询可以使用索引扫描?</span><div>分为两种情况,<br><div><span style="line-height: 22px;"   >1. collate = C</span></div><div><span style="line-height: 22px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create table collate_c (id int primary key, info text collate "C");</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "collate_c_pkey" for table "collate_c"</font></div><div><font size="2"   >CREATE TABLE</font></div><div><div><font size="2"   >digoal=&gt; insert into collate_c select generate_series(1,100000),repeat(random()::text,20);</font></div><div><font size="2"   >INSERT 0 100000</font></div></div><p></p></pre></div><div>索引使用默认的operator class, 即可支持"后模糊"查询.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; create index idx_collate_c_1 on collate_c (info);</font></div><div><font size="2"   >CREATE INDEX</font></div></div><div><div><font size="2"   >digoal=&gt; explain analyze select * from collate_c where info ~ '^12';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using idx_collate_c_1 on collate_c &nbsp;(cost=0.00..2.81 rows=10 width=348) (actual time=0.030..0.030 rows=0 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: ((info &gt;= '12'::text) AND (info &lt; '13'::text))</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (info ~ '^12'::text)</font></div><div><font size="2"   >&nbsp;Total runtime: 0.056 ms</font></div><div><font size="2"   >(4 rows)</font></div></div><div><div><font size="2"   >digoal=&gt; explain analyze select * from collate_c where info like '12%';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using idx_collate_c_1 on collate_c &nbsp;(cost=0.00..2.81 rows=10 width=348) (actual time=0.026..0.026 rows=0 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: ((info &gt;= '12'::text) AND (info &lt; '13'::text))</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (info ~~ '12%'::text)</font></div><div><font size="2"   >&nbsp;Total runtime: 0.051 ms</font></div><div><font size="2"   >(4 rows)</font></div></div><p></p></pre></div><div><br></div></span></div><div><span style="line-height: 22px;"   >2. collate &lt;&gt; C</span></div><div><div style="line-height: 22px;"   >第二种情况是列的collate &lt;&gt; C.</div><div style="line-height: 22px;"   >这种使用默认的operator class不支持模糊查询.</div></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; create table collate_notc (id int primary key, info text collate "en_US");</font></div><div style="line-height: 22px;"   ><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "collate_notc_pkey" for table "collate_notc"</font></div><div style="line-height: 22px;"   ><font size="2"   >CREATE TABLE</font></div><div style="line-height: 22px;"   ><div><font size="2"   >digoal=&gt; insert into collate_notc select generate_series(1,100000),repeat(random()::text,20);</font></div><div><font size="2"   >INSERT 0 100000</font></div></div><div style="line-height: 22px;"   ><div><font size="2"   >digoal=&gt; create index idx_collate_notc_1 on collate_notc (info);</font></div><div><font size="2"   >CREATE INDEX</font></div></div><div style="line-height: 22px;"   ><div><font size="2"   >digoal=&gt; explain analyze select * from collate_notc where info ~ '^12';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on collate_notc &nbsp;(cost=0.00..6012.00 rows=10 width=348) (actual time=414.631..414.631 rows=0 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (info ~ '^12'::text)</font></div><div><font size="2"   >&nbsp; &nbsp;Rows Removed by Filter: 100000</font></div><div><font size="2"   >&nbsp;Total runtime: 414.661 ms</font></div><div><font size="2"   >(4 rows)</font></div></div><div style="line-height: 22px;"   ><div><font size="2"   >digoal=&gt; explain analyze select * from collate_notc where info like '12%';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on collate_notc &nbsp;(cost=0.00..6012.00 rows=10 width=348) (actual time=157.486..157.486 rows=0 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (info ~~ '12%'::text)</font></div><div><font size="2"   >&nbsp; &nbsp;Rows Removed by Filter: 100000</font></div><div><font size="2"   >&nbsp;Total runtime: 157.508 ms</font></div><div><font size="2"   >(4 rows)</font></div></div><div><div><font size="2"   >digoal=&gt; create index idx_collate_notc_2 on collate_notc (info varchar_pattern_ops);</font></div><div><font size="2"   >CREATE INDEX</font></div><div><font size="2"   >digoal=&gt; explain analyze select * from collate_notc where info ~ '^12';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using idx_collate_notc_2 on collate_notc &nbsp;(cost=0.00..2.81 rows=10 width=348) (actual time=0.482..0.482 rows=0 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: ((info ~&gt;=~ '12'::text) AND (info ~&lt;~ '13'::text))</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (info ~ '^12'::text)</font></div><div><font size="2"   >&nbsp;Total runtime: 0.506 ms</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; explain analyze select * from collate_notc where info like '12%';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using idx_collate_notc_2 on collate_notc &nbsp;(cost=0.00..2.81 rows=10 width=348) (actual time=0.073..0.073 rows=0 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: ((info ~&gt;=~ '12'::text) AND (info ~&lt;~ '13'::text))</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (info ~~ '12%'::text)</font></div><div><font size="2"   >&nbsp;Total runtime: 0.097 ms</font></div><div><font size="2"   >(4 rows)</font></div></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=&gt; drop index idx_collate_notc_2;</font></div><div><font size="2"   >DROP INDEX</font></div><div><font size="2"   >digoal=&gt; explain analyze select info from collate_notc where info like '12%';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on collate_notc &nbsp;(cost=0.00..6012.00 rows=10 width=344) (actual time=204.449..204.449 rows=0 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (info ~~ '12%'::text)</font></div><div><font size="2"   >&nbsp; &nbsp;Rows Removed by Filter: 100000</font></div><div><font size="2"   >&nbsp;Total runtime: 204.471 ms</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; set enable_seqscan=off;</font></div><div><font size="2"   >SET</font></div></div><p></p></pre></div></div><div><div>但是, 当查询的结果集只包含索引列字段时, 可以选择Index Only Scan.</div><div>当然这个效率显然不如使用ops来的高.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; explain analyze select info from collate_notc where info like '12%';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >-------------</font></div><div><font size="2"   >&nbsp;Index Only Scan using idx_collate_notc_1 on collate_notc &nbsp;(cost=0.00..11870.79 rows=10 width=344) (actual time=746.763..746.763 row</font></div><div><font size="2"   >s=0 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (info ~~ '12%'::text)</font></div><div><font size="2"   >&nbsp; &nbsp;Rows Removed by Filter: 100000</font></div><div><font size="2"   >&nbsp; &nbsp;Heap Fetches: 100000</font></div><div><font size="2"   >&nbsp;Total runtime: 746.786 ms</font></div><div><font size="2"   >(5 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; explain analyze select * from collate_notc where info like '12%';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on collate_notc &nbsp;(cost=10000000000.00..10000006012.00 rows=10 width=348) (actual time=175.617..175.617 rows=0 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (info ~~ '12%'::text)</font></div><div><font size="2"   >&nbsp; &nbsp;Rows Removed by Filter: 100000</font></div><div><font size="2"   >&nbsp;Total runtime: 175.646 ms</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >查询支持的collate</span></div><div>digoal=&gt; select * from pg_collation ;</div><div><span style="line-height: 22px;"   >参考 :&nbsp;</span></div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/indexes-opclass.html"   >http://www.postgresql.org/docs/9.2/static/indexes-opclass.html</a></div></div><div><br></div><div><span style="line-height: 22px;"   >17. INT类型如何显示前导0, 例如01,001.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select to_char(123, '0000');</font></div><div><font size="2"   >&nbsp;to_char&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; 0123</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; select to_char(123, '00000');</font></div><div><font size="2"   >&nbsp;to_char&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; 00123</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; select to_char(123, '00000.0');</font></div><div><font size="2"   >&nbsp;to_char &nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; 00123.0</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><font size="2"   ><br></font></div><div><span style="line-height: 22px;"   >18.&nbsp;</span><span style="line-height: 22px;"   >postgresql能不能把在某个数据库上执行过的所有SQL都记录下来.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# alter database digoal set log_min_duration_statement=0;</font></div><div><font size="2"   >ALTER DATABASE</font></div><div><font size="2"   >或者</font></div><div><div><font size="2"   >digoal=# alter database digoal set log_statement='all';</font></div><div><font size="2"   >ALTER DATABASE</font></div></div><div><font size="2"   >-- 只记录下digoal数据库的所有SQL, 其他数据库则按系统默认的配置.</font></div><div><font size="2"   >语法 :&nbsp;</font></div><div><div><font size="2"   >ALTER DATABASE name SET configuration_parameter { TO | = } { value | DEFAULT }</font></div><div><font size="2"   >ALTER DATABASE name SET configuration_parameter FROM CURRENT</font></div><div><font size="2"   >ALTER DATABASE name RESET configuration_parameter</font></div><div><font size="2"   >ALTER DATABASE name RESET ALL</font></div></div><div><font size="2"   >PostgreSQL的权限分级较多, 例如可以按角色配置权限, 也可以按数据库配置权限, 也可以按会话配置权限等等.</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >19. Q :&nbsp;</span></div><div><span style="line-height: 22px;"   >在postgreSQL写SQL语句，更新字段里的值，该字段的值是这样的形式{"x":114.310134, "y":30.522772, "spatialReference":{"wkid":4326}，需要更新字符串里X Y的值，值是从其它变表查出来的，该如何写SQL语句呢？</span></div><div><span style="line-height: 22px;"   >A :&nbsp;</span></div><div><span style="line-height: 22px;"   ><div>digoal=# select regexp_replace ('{"x":114.310134, "y":30.522772, "spatialReference":{"wkid":4326}','()[0-9]+\.[0-9]+(, "y":)[0-9]+\.[0-9]+()','\11234\25678\3','g');</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; regexp_replace &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>-------------------------------------------------------</div><div>&nbsp;{"x":1234, "y":5678, "spatialReference":{"wkid":4326}</div><div>(1 row)</div></span><span style="line-height: 22px;"   ><div><span style="line-height: 22px;"   >\11234\25678\3 中&nbsp;</span>\n 位置表示规则表达式中的括号部分. 最多可使用1-9</div></span></div><div>详细介绍参考</div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/functions-matching.html#FUNCTIONS-POSIX-REGEXP"   >http://www.postgresql.org/docs/9.3/static/functions-matching.html#FUNCTIONS-POSIX-REGEXP</a></div><br><div>20. Q:</div><div><span style="line-height: 28px;"   >PostgreSQL 列类型匹配判断. IS OF, IS NOT OF表达式.</span></div><div><span style="line-height: 28px;"   >A:</span></div><div><div>digoal=# \d+ pg_class</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "pg_catalog.pg_class"</div><div>&nbsp; &nbsp; &nbsp;Column &nbsp; &nbsp; | &nbsp; Type &nbsp; &nbsp;| Modifiers | Storage &nbsp;| Stats target | Description&nbsp;</div><div>----------------+-----------+-----------+----------+--------------+-------------</div><div>&nbsp;relname &nbsp; &nbsp; &nbsp; &nbsp;| name &nbsp; &nbsp; &nbsp;| not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;relnamespace &nbsp; | oid &nbsp; &nbsp; &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;reltype &nbsp; &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;reloftype &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;relowner &nbsp; &nbsp; &nbsp; | oid &nbsp; &nbsp; &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;relam &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;relfilenode &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;reltablespace &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;relpages &nbsp; &nbsp; &nbsp; | integer &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;reltuples &nbsp; &nbsp; &nbsp;| real &nbsp; &nbsp; &nbsp;| not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;relallvisible &nbsp;| integer &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;reltoastrelid &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;reltoastidxid &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;relhasindex &nbsp; &nbsp;| boolean &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;relisshared &nbsp; &nbsp;| boolean &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;relpersistence | "char" &nbsp; &nbsp;| not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;relkind &nbsp; &nbsp; &nbsp; &nbsp;| "char" &nbsp; &nbsp;| not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;relnatts &nbsp; &nbsp; &nbsp; | smallint &nbsp;| not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;relchecks &nbsp; &nbsp; &nbsp;| smallint &nbsp;| not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;relhasoids &nbsp; &nbsp; | boolean &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;relhaspkey &nbsp; &nbsp; | boolean &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;relhasrules &nbsp; &nbsp;| boolean &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;relhastriggers | boolean &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;relhassubclass | boolean &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;relispopulated | boolean &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;relfrozenxid &nbsp; | xid &nbsp; &nbsp; &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;relminmxid &nbsp; &nbsp; | xid &nbsp; &nbsp; &nbsp; | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;relacl &nbsp; &nbsp; &nbsp; &nbsp; | aclitem[] | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;reloptions &nbsp; &nbsp; | text[] &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>Indexes:</div><div>&nbsp; &nbsp; "pg_class_oid_index" UNIQUE, btree (oid)</div><div>&nbsp; &nbsp; "pg_class_relname_nsp_index" UNIQUE, btree (relname, relnamespace)</div><div>Has OIDs: yes</div><div><br></div><div>digoal=# select relname is of (text) from pg_class limit 1;</div><div>&nbsp;?column?&nbsp;</div><div>----------</div><div>&nbsp;f</div><div>(1 row)</div></div><div><div>digoal=# select relname is of (name) from pg_class limit 1;</div><div>&nbsp;?column?&nbsp;</div><div>----------</div><div>&nbsp;t</div><div>(1 row)</div></div><div><br></div><div><span style="line-height: 28px;"   >PostgreSQL7.3添加到特性.</span></div><div><span style="line-height: 28px;"   >参考:&nbsp;</span>src/backend/parser/gram.y</div><div><br></div><div><br></div><div><span style="line-height: 28px;"   >21.&nbsp;</span></div><div><span style="line-height: 28px;"   >PostgreSQL 字符串排序和什么有关.</span></div><div><span style="line-height: 28px;"   >A :&nbsp;</span></div><div><span style="line-height: 28px;"   >排序需要考虑collate 以及数据库所在系统的glibc版本. 如下测试都是在PostgreSQL 9.3中, UTF8的数据库中执行的, 因为操作系统的glibc版本不一样, 所以结果也不一样.</span></div><div><span style="line-height: 28px;"   >CentOS 6.4</span></div><div><div>digoal=# select id,bytea(id) from ( values('a'),('b'),('你好'),('中国') ) as t(id) order by id collate "C";</div><div>&nbsp; id &nbsp;| &nbsp; &nbsp; bytea &nbsp; &nbsp; &nbsp;</div><div>------+----------------</div><div>&nbsp;a &nbsp; &nbsp;| \x61</div><div>&nbsp;b &nbsp; &nbsp;| \x62</div><div>&nbsp;中国 | \xe4b8ade59bbd</div><div>&nbsp;你好 | \xe4bda0e5a5bd</div><div>(4 rows)</div><div><br></div><div>digoal=# select id,bytea(id) from ( values('a'),('b'),('你好'),('中国') ) as t(id) order by id collate "zh_CN";</div><div>&nbsp; id &nbsp;| &nbsp; &nbsp; bytea &nbsp; &nbsp; &nbsp;</div><div>------+----------------</div><div>&nbsp;a &nbsp; &nbsp;| \x61</div><div>&nbsp;b &nbsp; &nbsp;| \x62</div><div>&nbsp;你好 | \xe4bda0e5a5bd</div><div>&nbsp;中国 | \xe4b8ade59bbd</div><div>(4 rows)</div></div><div><br></div><div>CentOS 5.x</div><div><div>postgres=# select id,bytea(id) from ( values('a'),('b'),('你好'),('中国') ) as t(id) order by id collate "zh_CN";</div><div>&nbsp; id &nbsp;| &nbsp; &nbsp; bytea &nbsp; &nbsp; &nbsp;</div><div>------+----------------</div><div>&nbsp;a &nbsp; &nbsp;| \x61</div><div>&nbsp;b &nbsp; &nbsp;| \x62</div><div>&nbsp;中国 | \xe4b8ade59bbd</div><div>&nbsp;你好 | \xe4bda0e5a5bd</div><div>(4 rows)</div><div><br></div><div>postgres=# select id,bytea(id) from ( values('a'),('b'),('你好'),('中国') ) as t(id) order by id collate "C";</div><div>&nbsp; id &nbsp;| &nbsp; &nbsp; bytea &nbsp; &nbsp; &nbsp;</div><div>------+----------------</div><div>&nbsp;a &nbsp; &nbsp;| \x61</div><div>&nbsp;b &nbsp; &nbsp;| \x62</div><div>&nbsp;中国 | \xe4b8ade59bbd</div><div>&nbsp;你好 | \xe4bda0e5a5bd</div><div>(4 rows)</div></div><div>还可以参考此文</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201173003547236/"   >http://blog.163.com/digoal@126/blog/static/163877040201173003547236/</a></div><div><br></div><div><span style="line-height: 28px;"   >22. PostgreSQL 支持的SQL最大长度.</span></div><div><span style="line-height: 28px;"   >A :&nbsp;</span></div><div><span style="line-height: 28px;"   >2G</span></div><div>src/include/lib/stringinfo.h</div><div><div>/*-------------------------</div><div>&nbsp;* StringInfoData holds information about an extensible string.</div><div>&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data &nbsp; &nbsp;is the current buffer for the string (allocated with palloc).</div><div>&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;len &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; is the current string length. &nbsp;There is guaranteed to be</div><div>&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;a terminating '\0' at data[len], although this is not very</div><div>&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;useful when the string holds binary data rather than text.</div><div>&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;maxlen &nbsp;is the allocated size in bytes of 'data', i.e. the maximum</div><div>&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;string size (including the terminating '\0' char) that we can</div><div>&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;currently store in 'data' without having to reallocate</div><div>&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;more space. &nbsp;We must always have maxlen &gt; len.</div><div>&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;cursor &nbsp;is initialized to zero by makeStringInfo or initStringInfo,</div><div>&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;but is not otherwise touched by the stringinfo.c routines.</div><div>&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Some routines use it to scan through a StringInfo.</div><div>&nbsp;*-------------------------</div><div>&nbsp;*/</div><div>typedef struct StringInfoData</div><div>{</div><div>&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *data;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; maxlen;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cursor;</div><div>} StringInfoData;</div></div><div><span style="line-height: 28px;"   ><br></span></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL QQ群 FAQ贴 - 1 - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">renny - 2013-10-22 10:49:27</h5>
				<div><span style=""  >3.&nbsp;</span><span style=""  >PostgreSQL如何满足已经存在则更新, 不存在则插入的需求.</span><div><span style=""  >两句SQL就可以搞定的问题，为什么要搞那么复杂？</span></div><div><span style=""  ><div>SQL1: update t1 set b =t2.b from t2 where t1.a=t2.a;</div><div>SQL2: insert into t1 select a,b from t2 where not exists (select 1 from t1 where t1.a =t2.a);</div><div>另外，我的经验是不到万不得已，不应该使用自定义函数，在SQL语句中使用自定义函数如果数据一多就会慢得出奇，因为对于每一行数据都要调用一次函数完整地计算一次/。</div></span></div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 renny - 2013-10-22 10:49:27</h5>
				<div style="width:600px;">HI, 用函数封装更高效, 同时在高并发的情况下, 可以减少query start, query parse, query plan.<div>函数使用举例 :&nbsp;</div><div>create or replace function (v1 type1, ... vn typen) returns void as $$</div><div>declare&nbsp;</div><div>begin</div><div>&nbsp; update tbl set c1=v1, ... cn=vn where pk=?;</div><div>&nbsp; if not found then</div><div>&nbsp; &nbsp; insert into tbl (c1, ... cn) values (v1, ... vn);</div><div>&nbsp; end if;</div><div>end;</div><div>$$ language plpgsql strict;</div><div>建议您测试一下两种方式在高并发下的性能.</div><div>肯定是函数要好.&nbsp;</div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 renny - 2013-10-22 10:49:27</h5>
				<div style="width:600px;">性能优化可参考如下<div><a href="http://blog.163.com/digoal@126/blog/static/163877040201221382150858/"  >http://blog.163.com/digoal@126/blog/static/163877040201221382150858/</a></div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201221333411196/"  >http://blog.163.com/digoal@126/blog/static/163877040201221333411196/</a></div><div>再次感谢您对PostgreSQL的关注.</div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">renny 回复 德哥@Digoal - 2013-10-22 10:49:27</h5>
				<div style="width:600px;">我是这么理解的，你的方法适用于OLTP场景，我的方法适用于BI场景，我在以往的BI应用经验中由于自定义函数而引起的性能问题确实屡见不鲜；另外在很多OLTP里，一般会将这种“是否存在”的判断放在上层应用，而不是在数据库再开发一层，因为OLTP项目中几乎没有专职的数据库开发人员，而他们大多存在于BI项目中。<br><br></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 renny - 2013-10-22 10:49:27</h5>
				<div style="width:600px;">恩,bi交互少,这点开销不是重头.<div>当然这种是否存在的判断放应用层来做也是可以的.</div><div>方法多种多样.<br><br></div></div>
			</div>
			<div id="">
				<h5 id="">return NULL - 2013-03-03 22:44:31</h5>
				<div>很欣喜 刚开始学习postgres &nbsp;搜索with的递归用法竟然找个这个博客 &nbsp;感谢分享</div>
			</div>
			<div id="">
				<h5 id="">qhjhemcwf663 - 2013-01-17 0:08:02</h5>
				<div> 我珍惜身边的每一份真诚友情，无论它是不是已经过去，无论它会不会有将来。也许不会天长地久，也许会淡忘，也许会疏远，但却从来都不应该遗忘。它是一粒种子，珍惜了，就会在彼此的心里萌芽，抽叶，开花，直至结果。而那种绽放时的清香也将伴你我前行一生一世……愿我的好朋友幸福快乐！</div>
			</div>
			<div id="">
				<h5 id="">lizhenqiu0628 - 2012-10-17 17:29:02</h5>
				<div>  <P>我日志里的【治疗鼻炎偏方大全】也许能帮到你身边有需要的患者朋友！</P></div>
			</div>
	</div>
</div>
</body>
</html>