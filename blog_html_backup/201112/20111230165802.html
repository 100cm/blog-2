<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL standby replication error : invalid record length at %u</h2>
	<h5 id="">2011-12-30 16:58:02&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020111130455400/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>一位QQ上的网友问我的一个问题，我觉得比较有意思。</div><div>记录如下 :&nbsp;</div><div>Question :&nbsp;</div><div>我在启动POSTGRES的STANDBY数据库时，报</div><div>--------------------------</div><div>LOG: &nbsp;database system was shut down in recovery at 2011-12-30 23:20:25 CST</div><div>LOG: &nbsp;entering standby mode</div><div>LOG: &nbsp;restored log file "0000000100000002000000E9" from archive</div><div>LOG: &nbsp;invalid record length at 2/E9000108</div><div>LOG: &nbsp;invalid record length at 2/E9000108</div><div>LOG: &nbsp;streaming replication successfully connected to primary</div><div>LOG: &nbsp;invalid record length at 2/E9000108</div><div>FATAL: &nbsp;terminating walreceiver process due to administrator command</div><div>LOG: &nbsp;restored log file "0000000100000002000000E9" from archive</div><div>LOG: &nbsp;invalid record length at 2/E9000108</div><div>FATAL: &nbsp;the database system is starting up</div><div>LOG: &nbsp;invalid record length at 2/E9000108</div><div>LOG: &nbsp;restored log file "0000000100000002000000E9" from archive</div><div>LOG: &nbsp;invalid record length at 2/E9000108</div><div>--------------------------------------</div><div>我是把主库整个做了个TAR 包到备库的</div><div><br></div><div>问题分析 :&nbsp;</div><div>报错<span style="line-height: 22px;"   >invalid record length at 2/E9000108</span></div><div><span style="line-height: 22px;"   >源码中对应的部分如下 :&nbsp;</span></div><div><div>&nbsp; &nbsp; &nbsp; &nbsp; /*</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* NOTE: We disallow len == 0 because it provides a useful bit of extra</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* error checking in ReadRecord. &nbsp;This means that all callers of</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* XLogInsert must supply at least some not-in-a-buffer data. &nbsp;However, we</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* make an exception for XLOG SWITCH records because we don't want them to</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* ever cross a segment boundary.</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</div><div>&nbsp; &nbsp; &nbsp; &nbsp; if (len == 0 &amp;&amp; !isLogSwitch)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(PANIC, "invalid xlog record length %u", len);</div><div><br></div><div>&nbsp; &nbsp; &nbsp; &nbsp; START_CRIT_SECTION();</div></div><div>因此报错的原因是standby在恢复过程中从 xlog&nbsp;<span style="line-height: 22px;"   >0000000100000002000000E9 的&nbsp;</span><span style="line-height: 22px;"   >2/E9000108位置读取到了len == 0&nbsp;</span><span style="line-height: 22px;"   >并且 !isLogSwitch 的信息。</span></div><div><span style="line-height: 22px;"   >日志中还提到了</span><span style="line-height: 22px;"   >restored log file "0000000100000002000000E9" from archive</span></div><div><span style="line-height: 22px;"   >因此问他要了recovery.conf 配置文件的内容如下 :&nbsp;</span></div><div><span style="line-height: 22px;"   >standby_mode&nbsp;=&nbsp;'on'</span><br style="line-height: 22px;"   ><span style="line-height: 22px;"   >primary_conninfo&nbsp;=&nbsp;'host=隐藏&nbsp;port=5432&nbsp;user=隐藏&nbsp;password=隐藏'</span><br style="line-height: 22px;"   ><span style="line-height: 22px;"   >restore_command&nbsp;=&nbsp;'cp&nbsp;"/home/postgres/data/pg_xlog/%f"&nbsp;"%p"'</span><br style="line-height: 22px;"   ><span style="line-height: 22px;"   >trigger_file&nbsp;=&nbsp;'/home/postgres/trigger_activestb'</span><br></div><div>从这个配置文件来看，<span style="line-height: 22px;"   >restore_command&nbsp;=&nbsp;'cp&nbsp;"/home/postgres/data/pg_xlog/%f"&nbsp;"%p"' 有问题，如果要配置</span><span style="line-height: 22px;"   >restore_command，那么应该是把主库的归档文件拷贝standby的pg_xlog目录。</span></div><div><span style="line-height: 22px;"   >要么就是不要配置</span><span style="line-height: 22px;"   >restore_command , 那么standby会尝试从stream获取xlog的信息（要求primary库的这个xlog没有被覆盖）。</span></div><div><br></div><div>Answer :&nbsp;</div><div>经过确认主库的&nbsp;<span style="line-height: 22px;"   >0000000100000002000000E9 存在pg_xlog中未被覆盖.</span></div><div><span style="line-height: 22px;"   >注释standby节点recovery.conf的restore_command&nbsp;=&nbsp;'cp&nbsp;"/home/postgres/data/pg_xlog/%f"&nbsp;"%p"'</span> </div><div><span style="line-height: 22px;"   >重启standby.</span></div><div>未解决，还是报&nbsp;<span style="line-height: 22px;"   >invalid record length at 2/E9000108&nbsp;</span></div><div><span style="line-height: 22px;"   >另外需要了解的是，</span></div><div><span style="line-height: 22px;"   >&nbsp; 做STANDBY的时候有没有按照正常流程来做( select pg_start_backup(), backup, select pg_stop_backup() )</span></div><div><span style="line-height: 22px;"   >&nbsp; 拷贝数据文件的过程中有没有错误发生.</span></div><div><span style="line-height: 22px;"   >&nbsp; 这些都不得而知, 因此问题不太好判断。</span></div><div><span style="line-height: 22px;"   >&nbsp;&nbsp;</span><span style="line-height: 22px;"   >所以先重做 standby 来解决目前的问题 .&nbsp;</span></div><div><br></div><div>最后.</div><div>可以尝试使用pg_filedump来分析一下<span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >0000000100000002000000E9的内容。（由于时间关系，暂时没做）</span></div><div><br></div><div><br></div><div><div>&nbsp;</div></div><div>【参考】</div><div>src/backend/access/transam/xlog.c</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201142610215685/"   >http://blog.163.com/digoal@126/blog/static/163877040201142610215685/</a> </div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL standby replication error : invalid record length at u - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>