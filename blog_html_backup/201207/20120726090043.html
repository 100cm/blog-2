<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Notice : PostgreSQL 9.2 must escape colon in PGPASSFILE password field but 9.1, 9.0, 8.x must not need</h2>
	<h5 id="">2012-07-26 9:00:43&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201262682948920/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">PostgreSQL 9.2 在密码文件读取密码时, 有一个改变(参考后面的参考部分, PasswordFromFile函数多了一个de-escape逻辑. ),&nbsp; <span style="line-height: 22px;"  >当你的密码中包含冒号时, 会</span>造成你以前使用的密码文件无效. 原因是冒号需要转义.<wbr><div>而早期的版本如9.1, 9.0, 8.x 都不需要转义冒号.</div><div><br></div><div>例如 :&nbsp;</div><div>首先修改回环地址连接验证方法为md5, 默认可能是trust, 无法达到本例验证的目的.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >vi $PGDATA/pg_hba.conf</font></div><div><font size="2"  >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;md5</font></div><div><font size="2"  >pg_ctl reload</font></div><p></p></pre></div><div><br></div><div>9.2测试结果 :&nbsp;</div><div>-- 创建用户, 密码中包含冒号</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >su - pg92</font></div><div><div><font size="2"  >pg92@db-172-16-3-150-&gt; psql -h 127.0.0.1 postgres postgres</font></div><div><font size="2"  >Password for user postgres:&nbsp;</font></div><div><font size="2"  >psql (9.2beta2)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# create role digoal nosuperuser login encrypted password 'digoal:1';</font></div><div><font size="2"  >CREATE ROLE</font></div><div><font size="2"  >postgres=# \q</font></div></div><p></p></pre></div><div><br></div><div>-- 使用密码登陆正常</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg92@db-172-16-3-150-&gt; psql -h 127.0.0.1 -U digoal postgres</font></div><div><font size="2"  >Password for user digoal:&nbsp;</font></div><div><font size="2"  >psql (9.2beta2)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=&gt; \q</font></div><p></p></pre></div><div><br></div><div>-- 使用密码文件登陆, 冒号不转义则密码校验失败</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >su - pg92</font></div><div><font size="2"  >vi ~/.pgpass</font></div><div><font size="2"  >127.0.0.1:*:*:digoal:digoal:1</font></div><div><font size="2"  >chmod 400&nbsp;<span style="line-height: 22px;"  >~/.pgpass</span></font></div><div><div style="line-height: 22px;"  ><font size="2"  >pg92@db-172-16-3-150-&gt; psql -h 127.0.0.1 -U digoal postgres</font></div><div style="line-height: 22px;"  ><font size="2"  >psql: FATAL: &nbsp;password authentication failed for user "digoal"</font></div><div style="line-height: 22px;"  ><font size="2"  >password retrieved from file "/home/pg92/.pgpass"</font></div></div><p></p></pre></div><div><div style="line-height: 22px;"  ><br></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >-- 使用密码文件登陆, 冒号转义则密码校验通过</span></div><div><pre class="prettyprint"  ><p></p><div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  >su - pg92</font></span></div><div style="line-height: 22px;"  ><font size="2"  ><span style="line-height: 22px;"  >vi ~/.pgpass</span> </font></div><div><font size="2"  >127.0.0.1:*:*:digoal:digoal\:1</font></div></div><div><div><font size="2"  >pg92@db-172-16-3-150-&gt; psql -h 127.0.0.1 -U digoal postgres</font></div><div><font size="2"  >psql (9.2beta2)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=&gt;&nbsp;</font></div></div><p></p></pre></div></div><div><br></div><div><br></div><div>9.1测试结果 :&nbsp;</div><div><span style="line-height: 22px;"  >-- 创建用户, 密码中包含冒号</span> </div><div><pre class="prettyprint"  ><p></p><div><span style="line-height: 22px;"  ><font size="2"  >su - pg91</font></span></div><div><span style="line-height: 22px;"  ><div><font size="2"  >pg91@db-172-16-3-150-&gt; psql&nbsp;<span style="line-height: 22px;"  >127.0.0.1 postgres postgres</span><span style="line-height: 22px;"  ></span></font></div><div><font size="2"  >psql (9.1.3)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  ><br></font></div><div><div style="line-height: 22px;"  ><font size="2"  >postgres=# create role digoal nosuperuser login encrypted password 'digoal:1';</font></div><div style="line-height: 22px;"  ><font size="2"  >CREATE ROLE</font></div><div style="line-height: 22px;"  ><font size="2"  >postgres=# \q</font></div></div></span></div><p></p></pre></div><div><span style="line-height: 22px;"  ><div><br></div></span></div><div><span style="line-height: 22px;"  >-- 使用密码登陆正常</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg91@db-172-16-3-150-&gt; psql -h 127.0.0.1 -U digoal postgres</font></div><div><font size="2"  >Password for user digoal:&nbsp;</font></div><div><font size="2"  >psql (9.1.3)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=&gt; \q</font></div><p></p></pre></div><div><span style="line-height: 22px;"  ><br></span></div><div><span style="line-height: 22px;"  >-- 使用密码文件登陆, 冒号不转义则密码校验通过, 与pg92 相反.</span></div><div><div><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >su - pg91</font></div><div style="line-height: 22px;"  ><font size="2"  >vi ~/.pgpass</font></div><div style="line-height: 22px;"  ><font size="2"  >127.0.0.1:*:*:digoal:digoal:1</font></div><div style="line-height: 22px;"  ><font size="2"  >chmod 400&nbsp;<span style="line-height: 22px;"  >~/.pgpass</span></font></div><div><div style="line-height: 22px;"  ><font size="2"  >pg91@db-172-16-3-150-&gt; psql -h 127.0.0.1 -U digoal postgres</font></div><div><div><font size="2"  >psql (9.1.3)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=&gt; \q</font></div></div></div><p></p></pre></div></div><div><span style="line-height: 22px;"  ><br></span></div><div><span style="line-height: 22px;"  >-- 使用密码文件登陆, 冒号转义则密码校验失败,&nbsp;</span><span style="line-height: 22px;"  >与pg92 相反.</span></div><div><div><pre class="prettyprint"  ><p></p><div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  >su - pg91</font></span></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  >vi ~/.pgpass</font></span></div><div style="line-height: 22px;"  ><font size="2"  >127.0.0.1:*:*:digoal:digoal\:1</font></div></div><div><span style="line-height: 22px;"  ><font size="2"  ><div>pg91@db-172-16-3-150-&gt; psql -h 127.0.0.1 -U digoal postgres</div><div>psql: FATAL: &nbsp;password authentication failed for user "digoal"</div><div>password retrieved from file "/home/pg91/.pgpass"</div></font></span></div><p></p></pre></div></div><div><span style="line-height: 22px;"  ><br></span></div><div><span style="line-height: 22px;"  >【参考】</span></div><div>src/interfaces/libpq/fe-connect.c</div><div><span style="line-height: 22px;"  >9.2和9.1的 PasswordFromFile 函数比较, 原因就在此 :&nbsp;</span></div><div><br></div><div>9.2 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >/* Get a password from the password file. Return value is malloc'd. */</font></div><div><font size="2"  >static char *</font></div><div><font size="2"  >PasswordFromFile(char *hostname, char *port, char *dbname, char *username)</font></div><div><font size="2"  >{</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; FILE &nbsp; &nbsp; &nbsp; *fp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pgpassfile[MAXPGPATH];</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; struct stat stat_buf;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >#define LINELEN NAMEDATALEN*5</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;buf[LINELEN];</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (dbname == NULL || strlen(dbname) == 0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (username == NULL || strlen(username) == 0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; /* 'localhost' matches pghost of '' or the default socket directory */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (hostname == NULL)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hostname = DefaultHost;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; else if (is_absolute_path(hostname))</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* We should probably use canonicalize_path(), but then we have to</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* bring path.c into libpq, and it doesn't seem worth it.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (strcmp(hostname, DEFAULT_PGSOCKET_DIR) == 0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hostname = DefaultHost;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (port == NULL)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; port = DEF_PGPORT_STR;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (!getPgPassFilename(pgpassfile))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; /* If password file cannot be opened, ignore it. */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (stat(pgpassfile, &amp;stat_buf) != 0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div></div><div><div><font size="2"  >#ifndef WIN32</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (!S_ISREG(stat_buf.st_mode))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; libpq_gettext("WARNING: password file \"%s\" is not a plain file\n"),</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgpassfile);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; /* If password file is insecure, alert the user and ignore it. */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (stat_buf.st_mode &amp; (S_IRWXG | S_IRWXO))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; libpq_gettext("WARNING: password file \"%s\" has group or world access; permissions should be u=rw (0600) or less\n"),</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgpassfile);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >#else</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* On Win32, the directory is protected, so we don't have to check the</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* file.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"  >#endif</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; fp = fopen(pgpassfile, "r");</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (fp == NULL)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; while (!feof(fp) &amp;&amp; !ferror(fp))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *t = buf,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*ret,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*p1,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*p2;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (fgets(buf, sizeof(buf), fp) == NULL)</font></div></div><div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = strlen(buf);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (len == 0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; continue;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Remove trailing newline */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (buf[len - 1] == '\n')</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf[len - 1] = 0;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ((t = pwdfMatchesString(t, hostname)) == NULL ||</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (t = pwdfMatchesString(t, port)) == NULL ||</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (t = pwdfMatchesString(t, dbname)) == NULL ||</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (t = pwdfMatchesString(t, username)) == NULL)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; continue;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ret = strdup(t);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fclose(fp);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* De-escape password. */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for (p1 = p2 = ret; *p1 != ':' &amp;&amp; *p1 != '\0'; ++p1, ++p2)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (*p1 == '\\' &amp;&amp; p1[1] != '\0')</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ++p1;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p2 = *p1;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p2 = '\0';</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return ret;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; fclose(fp);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >#undef LINELEN</font></div><div><font size="2"  >}</font></div></div><p></p></pre></div><div><br></div><div>9.1 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >/* Get a password from the password file. Return value is malloc'd. */</font></div><div><font size="2"  >static char *</font></div><div><font size="2"  >PasswordFromFile(char *hostname, char *port, char *dbname, char *username)</font></div><div><font size="2"  >{</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; FILE &nbsp; &nbsp; &nbsp; *fp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pgpassfile[MAXPGPATH];</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; struct stat stat_buf;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >#define LINELEN NAMEDATALEN*5</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;buf[LINELEN];</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (dbname == NULL || strlen(dbname) == 0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (username == NULL || strlen(username) == 0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; /* 'localhost' matches pghost of '' or the default socket directory */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (hostname == NULL)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hostname = DefaultHost;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; else if (is_absolute_path(hostname))</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* We should probably use canonicalize_path(), but then we have to</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* bring path.c into libpq, and it doesn't seem worth it.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (strcmp(hostname, DEFAULT_PGSOCKET_DIR) == 0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hostname = DefaultHost;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (port == NULL)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; port = DEF_PGPORT_STR;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (!getPgPassFilename(pgpassfile))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; /* If password file cannot be opened, ignore it. */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (stat(pgpassfile, &amp;stat_buf) != 0)</font></div></div><div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >#ifndef WIN32</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (!S_ISREG(stat_buf.st_mode))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; libpq_gettext("WARNING: password file \"%s\" is not a plain file\n"),</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgpassfile);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; /* If password file is insecure, alert the user and ignore it. */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (stat_buf.st_mode &amp; (S_IRWXG | S_IRWXO))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; libpq_gettext("WARNING: password file \"%s\" has group or world access; permissions should be u=rw (0600) or less\n"),</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgpassfile);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >#else</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* On Win32, the directory is protected, so we don't have to check the</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* file.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"  >#endif</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; fp = fopen(pgpassfile, "r");</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (fp == NULL)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; while (!feof(fp) &amp;&amp; !ferror(fp))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *t = buf,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*ret;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (fgets(buf, sizeof(buf), fp) == NULL)</font></div></div><div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = strlen(buf);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (len == 0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; continue;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Remove trailing newline */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (buf[len - 1] == '\n')</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf[len - 1] = 0;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ((t = pwdfMatchesString(t, hostname)) == NULL ||</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (t = pwdfMatchesString(t, port)) == NULL ||</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (t = pwdfMatchesString(t, dbname)) == NULL ||</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (t = pwdfMatchesString(t, username)) == NULL)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; continue;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ret = strdup(t);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fclose(fp);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return ret;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; fclose(fp);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >#undef LINELEN</font></div><div><font size="2"  >}</font></div></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>