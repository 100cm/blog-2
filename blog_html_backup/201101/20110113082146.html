<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL VS Oracle Crash Recovery - 1</h2>
	<h5 id="">2011-01-13 8:21:46&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201101382146176/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">测试环境：<br>PostgreSQL和Oracle处于同一台物理机,测试Oracle时关闭PostgreSQL,反之亦然。<br>为达到比较一致的效果，测试完都执行一把checkpoint. 数据文件处于同一文件系统下面.<br>测试机: CentOS 5.2 x64<br>146G硬盘 16G内存<br>Oracle : 10.2.0.4 X64<br>PostgreSQL : 9.0.2&nbsp; 编译安装<br>测试过程:<br>执行事务,不提交<br>shutdown abort 或 pg_ctl stop -m immediate<br>启动，<br>恢复期间,连接数据库，执行事务,并观察日志,<br>并行恢复的话应该不会干扰新执行事务请求，非并行恢复将干扰新事物请求或干扰连接请求。(oracle update场景看出并行恢复的迹象,很遗憾的是影响太大,并且Oracle恢复时间太长了。)<br>测试结果:<br><div><img title="PostgreSQL VS Oracle Crash Recovery - 1 - 德哥@Digoal - The Heart,The World." alt="PostgreSQL VS Oracle Crash Recovery - 1 - 德哥@Digoal - The Heart,The World." style="margin: 0pt 10px 0pt 0pt;" src="http://img686.ph.126.net/76KfIJ2o5XgvCRtUA-KL-w==/2856408063661013777.jpg"></div>&nbsp;<br>PostgreSQL 领先 Oracle不是一个数量级。包括回收空间的速度也不如PostgreSQL,详细参见如下报告<br><br>测试表:<br>create table test.tbl_test (id int,firstname varchar(32),lastname varchar(32),corp varchar(32),age int,create_time timestamp without time zone ,info varchar(128));<br><br>SQL&gt; create table test.tbl_test (id int,firstname varchar2(32),lastname varchar2(32),corp varchar2(32),age int,create_time date ,info varchar2(128)) tablespace tbs_test;<br>postgresql变长的单位为字符,Oracle的变长单位为字节,除非使用nvarchar2。<br><br>操作系统配置:<br>net.ipv4.ip_forward = 0<br>net.ipv4.conf.default.rp_filter = 1<br>net.ipv4.conf.default.accept_source_route = 0<br>kernel.sysrq = 0<br>kernel.core_uses_pid = 1<br>net.ipv4.tcp_syncookies = 1<br>kernel.msgmnb = 65536<br>kernel.msgmax = 65536<br>kernel.shmmax = 68719476736<br>kernel.shmall = 4294967296<br>kernel.shmmni = 4096<br>kernel.sem = 5010 641280 5010 128<br>fs.file-max = 1587056<br>net.ipv4.ip_local_port_range = 1024 65000<br>net.core.rmem_default = 1048576<br>net.core.rmem_max = 1048576<br>net.core.wmem_default = 262144<br>net.core.wmem_max = 262144<br><br>*&nbsp; soft&nbsp;&nbsp;&nbsp; nofile&nbsp; 131072<br>*&nbsp; hard&nbsp;&nbsp;&nbsp; nofile&nbsp; 131072<br>*&nbsp; soft&nbsp;&nbsp;&nbsp; nproc&nbsp;&nbsp; 131072<br>*&nbsp; hard&nbsp;&nbsp;&nbsp; nproc&nbsp;&nbsp; 131072<br>*&nbsp; soft&nbsp;&nbsp;&nbsp; core&nbsp;&nbsp;&nbsp; unlimited<br>*&nbsp; hard&nbsp;&nbsp;&nbsp; core&nbsp;&nbsp;&nbsp; unlimited<br>*&nbsp; soft&nbsp;&nbsp;&nbsp; memlock 50000000<br>*&nbsp; hard&nbsp;&nbsp;&nbsp; memlock 50000000<br><br>PostgreSQL 详细配置：<br>configure --prefix=/app/pgsql --with-pgport=1921 --with-segsize=8 --with-wal-segsize=64 --with-perl --with-python --with-openssl --with-pam --with-ldap --with-libxml --with-libxslt --enable-thread-safety<br>gmake<br>gmake install-world<br>initdb -D /home/postgres/pgdata -E UTF8 --locale=C -U postgres -W<br><br>listen_addresses = '*'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # what IP address(es) to listen on;<br>port = 1921&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # (change requires restart)<br>max_connections = 2000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # (change requires restart)<br>superuser_reserved_connections = 13&nbsp;&nbsp;&nbsp;&nbsp; # (change requires restart)<br>unix_socket_directory = '/home/postgres/pgdata'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # (change requires restart)<br>unix_socket_permissions = 0700&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # begin with 0 to use octal notation<br>password_encryption = on<br>shared_buffers = 8192MB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # min 128kB<br>maintenance_work_mem = 2048MB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # min 1MB<br>max_stack_depth = 8MB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # min 100kB<br>max_files_per_process = 80000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # min 25<br>synchronous_commit = off&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # immediate fsync at commit<br>wal_sync_method = open_sync&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # the default is the first option <br>wal_buffers = 12800kB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # min 32kB<br>wal_writer_delay = 20ms&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # 1-10000 milliseconds<br>checkpoint_segments = 32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # in logfile segments, min 1, 16MB each<br>checkpoint_timeout = 5min&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # range 30s-1h<br>effective_cache_size = 15000MB<br>constraint_exclusion = partition&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # on, off, or partition<br>log_destination = 'csvlog'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Valid values are combinations of<br>logging_collector = on&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Enable capturing of stderr and csvlog<br>log_directory = '/var/applog/pg_log'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # directory where log files are written,<br>log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,<br>log_truncate_on_rotation = on&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # If on, an existing log file of the<br>log_rotation_age = 1d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Automatic rotation of logfiles will<br>log_rotation_size = 10MB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Automatic rotation of logfiles will <br>log_min_duration_statement = 500ms&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # -1 is disabled, 0 logs all statements<br>log_checkpoints = on<br>log_lock_waits = on&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # log lock waits &gt;= deadlock_timeout<br>log_statement = 'ddl'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # none, ddl, mod, all<br>autovacuum = on&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Enable autovacuum subprocess?&nbsp; 'on' <br>log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and<br>bytea_output = 'escape'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # hex, escape<br>datestyle = 'iso, mdy'<br>lc_messages = 'C'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # locale for system error message<br>lc_monetary = 'C'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # locale for monetary formatting<br>lc_numeric = 'C'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # locale for number formatting<br>lc_time = 'C'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # locale for time formatting<br>default_text_search_config = 'pg_catalog.english'<br>deadlock_timeout = 1s<br><br>Oracle详细配置:<br>*.audit_file_dest='/app/oracle/admin/skyoss/adump'<br>*.background_dump_dest='/app/oracle/admin/skyoss/bdump'<br>*.compatible='10.2.0.3.0'<br>*.control_files='/home/oracle/oradata/skyoss/control01.ctl','/home/oracle/oradata/skyoss/control02.ctl','/home/oracle/oradata/skyoss/control03.ctl'<br>*.core_dump_dest='/app/oracle/admin/skyoss/cdump'<br>*.db_block_size=8192<br>*.db_domain=''<br>*.db_file_multiblock_read_count=16<br>*.db_name='skyoss'<br>*.dispatchers=''<br>*.job_queue_processes=10<br>*.local_listener='LISTENER_SKYOSS'<br>*.open_cursors=300<br>*.pga_aggregate_target=1672478720<br>*.processes=1500<br>*.remote_login_passwordfile='EXCLUSIVE'<br>*.sessions=1655<br>*.sga_target=8589934592<br>*.undo_management='AUTO'<br>*.undo_tablespace='UNDOTBS1'<br>*.user_dump_dest='/app/oracle/admin/skyoss/udump'<br><br>PostgreSQL测试 :<br>mkdir /home/postgres/pgdata/tbs_test<br>create role test nosuperuser nocreatedb nocreaterole noinherit login encrypted password 'test' ;<br>create tablespace tbs_test owner test location '/home/postgres/pgdata/tbs_test';<br>create database test with owner test template template0 encoding 'UTF8' tablespace tbs_test;<br>test=&gt; create schema test authorization test;<br><br>插入<br>\c test test<br>create table test.tbl_test (id int,firstname varchar(32),lastname varchar(32),corp varchar(32),age int,create_time timestamp without time zone ,info varchar(128));<br>\c test postgres<br>\timing<br>begin;<br>test=&gt; insert into test.tbl_test (id,firstname,lastname,corp,age,create_time,info) select generate_series(1,10000000) ,'zhou','digoal','sky-mobi',27,now(),'abcdefghijklmnopqrstuvwxyz09876543211234567890poiuytrewqasdfghmjuiklopff';<br>INSERT 0 10000000<br>Time: 58547.378 ms<br>test=&gt; select pg_total_relation_size('tbl_test')/1024/1024;<br>&nbsp;?column? <br>----------<br>&nbsp;&nbsp;&nbsp;&nbsp; 1420<br>(1 row)<br><br>另一个SESSION<br>another session:<br>\c test postgres<br>test=# checkpoint;<br>CHECKPOINT<br>Time: 23801.397 ms<br>\c test test<br>test=&gt; insert into test.tbl_test (id,firstname,lastname,corp,age,create_time,info) select 999999999,'zhou','digoal','sky-mobi',27,now(),'abcdefghijklmnopqrstuvwxyz09876543211234567890poiuytrewqasdfghmjuiklopff';<br>INSERT 0 1<br>commit;<br>呆会可以看到提交的事务在恢复后是存在的。<br><br>另一个SHELL，异常关闭数据库，模拟crash<br>postgres@db5-&gt; pg_ctl stop -m immediate -D /home/postgres/pgdata<br>waiting for server to shut down.... done<br># 模式解释 Immediate mode will abort all server processes without a clean shutdown. This will lead to a recovery run on restart.<br><br>开机，查看恢复日志<br>[root@db5 ~]# pgctl.sh start<br>[root@db5 ~]# su - postgres<br>postgres@db5-&gt; psql -h 127.0.0.1 test test<br>(在恢复阶段将阻止登录,不过恢复时间比仅0.1秒,基本上不会有机会被阻止,恢复时间和checkpoint以及磁盘IO性能相关.)<br>psql: FATAL:&nbsp; the database system is starting up<br><br>2011-01-13 11:26:57.030 CST,,,30962,,4d2e7101.78f2,1,,2011-01-13 11:26:57 CST,,0,LOG,00000,"database system was interrupted; last known up at 2011-01-13 11:26:18 CST",,,,,,,,,""<br>2011-01-13 11:26:57.031 CST,,,30962,,4d2e7101.78f2,2,,2011-01-13 11:26:57 CST,,0,LOG,00000,"database system was not properly shut down; automatic recovery in progress",,,,,,,,,""<br>2011-01-13 11:26:57.064 CST,,,30962,,4d2e7101.78f2,3,,2011-01-13 11:26:57 CST,,0,LOG,00000,"consistent recovery state reached at 4/67404778",,,,,,,,,""<br>2011-01-13 11:26:57.064 CST,,,30962,,4d2e7101.78f2,4,,2011-01-13 11:26:57 CST,,0,LOG,00000,"record with zero length at 4/67404778",,,,,,,,,""<br>2011-01-13 11:26:57.064 CST,,,30962,,4d2e7101.78f2,5,,2011-01-13 11:26:57 CST,,0,LOG,00000,"redo is not required",,,,,,,,,""<br>2011-01-13 11:26:57.073 CST,,,30962,,4d2e7101.78f2,6,,2011-01-13 11:26:57 CST,,0,LOG,00000,"checkpoint starting: end-of-recovery immediate",,,,,,,,,""<br>2011-01-13 11:26:57.136 CST,,,30962,,4d2e7101.78f2,7,,2011-01-13 11:26:57 CST,,0,LOG,00000,"checkpoint complete: wrote 0 buffers (0.0%); 0 transaction log file(s) added, 0 removed, 26 recycled; write=0.047 s, sync=0.000 s, total=0.072 s",,,,,,,,,""<br>2011-01-13 11:26:57.149 CST,,,30965,,4d2e7101.78f5,1,,2011-01-13 11:26:57 CST,,0,LOG,00000,"autovacuum launcher started",,,,,,,,,""<br>2011-01-13 11:26:57.150 CST,,,30960,,4d2e7100.78f0,1,,2011-01-13 11:26:56 CST,,0,LOG,00000,"database system is ready to accept connections",,,,,,,,,""<br>恢复时间约0.1秒<br><br>test=&gt; select pg_total_relation_size('tbl_test')/1024/1024;<br>&nbsp;?column? <br>----------<br>&nbsp;&nbsp;&nbsp;&nbsp; 1420<br>(1 row)<br><br>test=&gt; select * from tbl_test ;<br>&nbsp;&nbsp;&nbsp; id&nbsp;&nbsp;&nbsp;&nbsp; | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; create_time&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; info&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>-----------+-----------+----------+----------+-----+----------------------------+---------------------------------------------------<br>-----------------------<br>&nbsp;999999999 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27 | 2011-01-13 09:42:37.703759 | abcdefghijklmnopqrstuvwxyz09876543211234567890poiu<br>ytrewqasdfghmjuiklopff<br>(1 row)<br>可以看到，提交的事务已经恢复,<br>回收空间测试:<br>test=&gt; vacuum verbose tbl_test;<br>INFO:&nbsp; vacuuming "test.tbl_test"<br>INFO:&nbsp; "tbl_test": removed 10000000 row versions in 181819 pages<br>INFO:&nbsp; "tbl_test": found 10000000 removable, 0 nonremovable row versions in 181819 out of 181819 pages<br>DETAIL:&nbsp; 0 dead row versions cannot be removed yet.<br>There were 0 unused item pointers.<br>0 pages are entirely empty.<br>CPU 3.10s/3.68u sec elapsed 63.32 sec.<br>INFO:&nbsp; "tbl_test": truncated 181819 to 0 pages<br>DETAIL:&nbsp; CPU 1.21s/0.30u sec elapsed 1.53 sec.<br>VACUUM<br>test=&gt; select pg_total_relation_size('tbl_test')/1024/1024;<br>&nbsp;?column? <br>----------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br>(1 row)<br><br># 重新插入1kw记录测试update<br>test=&gt; begin;<br>BEGIN<br>Time: 0.156 ms<br>test=&gt; update tbl_test&nbsp; set info='fefeabcdefghijklmnopqrstuvwxyz09876543211234567890poiuytrewqasdfghmjuiklopff' ;<br>UPDATE 10000000<br>Time: 129763.739 ms<br><br>another session:<br>\c test postgres<br>test=# checkpoint;<br>CHECKPOINT<br><br>postgres@db5-&gt; pg_ctl stop -m immediate -D /home/postgres/pgdata<br>waiting for server to shut down.... done<br><br>pgctl.sh start<br><br>2011-01-13 11:42:44.230 CST,,,31383,,4d2e74b4.7a97,1,,2011-01-13 11:42:44 CST,,0,LOG,00000,"database system was interrupted; last known up at 2011-01-13 11:42:22 CST",,,,,,,,,""<br>2011-01-13 11:42:44.236 CST,,,31383,,4d2e74b4.7a97,2,,2011-01-13 11:42:44 CST,,0,LOG,00000,"database system was not properly shut down; automatic recovery in progress",,,,,,,,,""<br>2011-01-13 11:42:44.267 CST,,,31383,,4d2e74b4.7a97,3,,2011-01-13 11:42:44 CST,,0,LOG,00000,"consistent recovery state reached at 5/A0B9AE30",,,,,,,,,""<br>2011-01-13 11:42:44.267 CST,,,31383,,4d2e74b4.7a97,4,,2011-01-13 11:42:44 CST,,0,LOG,00000,"record with zero length at 5/A0B9AE30",,,,,,,,,""<br>2011-01-13 11:42:44.267 CST,,,31383,,4d2e74b4.7a97,5,,2011-01-13 11:42:44 CST,,0,LOG,00000,"redo is not required",,,,,,,,,""<br>2011-01-13 11:42:44.275 CST,,,31383,,4d2e74b4.7a97,6,,2011-01-13 11:42:44 CST,,0,LOG,00000,"checkpoint starting: end-of-recovery immediate",,,,,,,,,""<br>2011-01-13 11:42:44.365 CST,,,31383,,4d2e74b4.7a97,7,,2011-01-13 11:42:44 CST,,0,LOG,00000,"checkpoint complete: wrote 0 buffers (0.0%); 0 transaction log file(s) added, 11 removed, 7 recycled; write=0.047 s, sync=0.000 s, total=0.098 s",,,,,,,,,""<br>2011-01-13 11:42:44.378 CST,,,31386,,4d2e74b4.7a9a,1,,2011-01-13 11:42:44 CST,,0,LOG,00000,"autovacuum launcher started",,,,,,,,,""<br>2011-01-13 11:42:44.379 CST,,,31381,,4d2e74b3.7a95,1,,2011-01-13 11:42:43 CST,,0,LOG,00000,"database system is ready to accept connections",,,,,,,,,""<br><br>恢复时间约0.1秒<br><br>test=&gt; select pg_total_relation_size('tbl_test')/1024/1024;<br>&nbsp;?column? <br>----------<br>&nbsp;&nbsp;&nbsp;&nbsp; 2841<br>(1 row)<br><br>test=&gt; vacuum verbose analyze tbl_test;<br>INFO:&nbsp; vacuuming "test.tbl_test"<br>INFO:&nbsp; "tbl_test": removed 9999990 row versions in 181819 pages<br>INFO:&nbsp; "tbl_test": found 9999990 removable, 10000000 nonremovable row versions in 363637 out of 363637 pages<br>DETAIL:&nbsp; 0 dead row versions cannot be removed yet.<br>There were 0 unused item pointers.<br>0 pages are entirely empty.<br>CPU 4.04s/6.13u sec elapsed 58.85 sec.<br>INFO:&nbsp; "tbl_test": truncated 363637 to 181819 pages<br>DETAIL:&nbsp; CPU 0.88s/0.32u sec elapsed 1.21 sec.<br>INFO:&nbsp; analyzing "test.tbl_test"<br>INFO:&nbsp; "tbl_test": scanned 30000 of 181819 pages, containing 1650000 live rows and 0 dead rows; 30000 rows in sample, 10000045 estimated total rows<br>VACUUM<br>test=&gt; select pg_total_relation_size('tbl_test')/1024/1024;<br>&nbsp;?column? <br>----------<br>&nbsp;&nbsp;&nbsp;&nbsp; 1420<br>(1 row)<br><br># 测试delete<br><br>test=&gt; begin;<br>BEGIN<br>Time: 0.146 ms<br>test=&gt; delete from tbl_test;<br>DELETE 10000000<br>Time: 42590.051 ms<br><br>another session : <br><br>postgres@db5-&gt; psql -h 127.0.0.1 test postgres<br>psql (9.0.2)<br>Type "help" for help.<br><br>test=# checkpoint;<br>CHECKPOINT<br><br>postgres@db5-&gt; pg_ctl stop -m immediate -D /home/postgres/pgdata<br>waiting for server to shut down.... done<br><br>pgctl.sh start<br><br><br>2011-01-13 12:23:55.125 CST,,,32448,,4d2e7e5b.7ec0,1,,2011-01-13 12:23:55 CST,,0,LOG,00000,"database system was interrupted; last known up at 2011-01-13 12:23:17 CST",,,,,,,,,""<br>2011-01-13 12:23:55.132 CST,,,32448,,4d2e7e5b.7ec0,2,,2011-01-13 12:23:55 CST,,0,LOG,00000,"database system was not properly shut down; automatic recovery in progress",,,,,,,,,""<br>2011-01-13 12:23:55.159 CST,,,32448,,4d2e7e5b.7ec0,3,,2011-01-13 12:23:55 CST,,0,LOG,00000,"consistent recovery state reached at 6/24913128",,,,,,,,,""<br>2011-01-13 12:23:55.159 CST,,,32448,,4d2e7e5b.7ec0,4,,2011-01-13 12:23:55 CST,,0,LOG,00000,"record with zero length at 6/24913128",,,,,,,,,""<br>2011-01-13 12:23:55.159 CST,,,32448,,4d2e7e5b.7ec0,5,,2011-01-13 12:23:55 CST,,0,LOG,00000,"redo is not required",,,,,,,,,""<br>2011-01-13 12:23:55.168 CST,,,32448,,4d2e7e5b.7ec0,6,,2011-01-13 12:23:55 CST,,0,LOG,00000,"checkpoint starting: end-of-recovery immediate",,,,,,,,,""<br>2011-01-13 12:23:55.229 CST,,,32448,,4d2e7e5b.7ec0,7,,2011-01-13 12:23:55 CST,,0,LOG,00000,"checkpoint complete: wrote 0 buffers (0.0%); 0 transaction log file(s) added, 0 removed, 31 recycled; write=0.048 s, sync=0.000 s, total=0.070 s",,,,,,,,,""<br>2011-01-13 12:23:55.242 CST,,,32451,,4d2e7e5b.7ec3,1,,2011-01-13 12:23:55 CST,,0,LOG,00000,"autovacuum launcher started",,,,,,,,,""<br>2011-01-13 12:23:55.243 CST,,,32446,,4d2e7e5a.7ebe,1,,2011-01-13 12:23:54 CST,,0,LOG,00000,"database system is ready to accept connections",,,,,,,,,""<br><br>恢复时间约0.1秒<br><br>test=&gt; select pg_total_relation_size('tbl_test')/1024/1024;<br>&nbsp;?column? <br>----------<br>&nbsp;&nbsp;&nbsp;&nbsp; 1420<br>(1 row)<br><br>test=&gt; vacuum verbose analyze tbl_test;<br>INFO:&nbsp; vacuuming "test.tbl_test"<br>INFO:&nbsp; "tbl_test": found 0 removable, 10000000 nonremovable row versions in 181819 out of 181819 pages<br>DETAIL:&nbsp; 0 dead row versions cannot be removed yet.<br>There were 45 unused item pointers.<br>0 pages are entirely empty.<br>CPU 1.82s/2.29u sec elapsed 4.11 sec.<br>INFO:&nbsp; analyzing "test.tbl_test"<br>INFO:&nbsp; "tbl_test": scanned 30000 of 181819 pages, containing 1650000 live rows and 0 dead rows; 30000 rows in sample, 10000045 estimated total rows<br>VACUUM<br>test=&gt; select pg_total_relation_size('tbl_test')/1024/1024;<br>&nbsp;?column? <br>----------<br>&nbsp;&nbsp;&nbsp;&nbsp; 1420<br>(1 row)<br><br># 来个更狠的truncate<br><br><br>test=&gt; \timing<br>Timing is on.<br>test=&gt; begin;<br>BEGIN<br>Time: 0.068 ms<br>test=&gt; truncate table tbl_test;<br>TRUNCATE TABLE<br>Time: 0.592 ms<br><br>another session : <br><br>postgres@db5-&gt; psql -h 127.0.0.1 test postgres<br>psql (9.0.2)<br>Type "help" for help.<br><br>test=# checkpoint;<br>CHECKPOINT<br><br>postgres@db5-&gt; pg_ctl stop -m immediate -D /home/postgres/pgdata<br>waiting for server to shut down.... done<br><br>pgctl.sh start<br><br>2011-01-13 12:26:52.816 CST,,,32559,,4d2e7f0c.7f2f,1,,2011-01-13 12:26:52 CST,,0,LOG,00000,"database system was interrupted; last known up at 2011-01-13 12:26:37 CST",,,,,,,,,""<br>2011-01-13 12:26:52.816 CST,,,32559,,4d2e7f0c.7f2f,2,,2011-01-13 12:26:52 CST,,0,LOG,00000,"database system was not properly shut down; automatic recovery in progress",,,,,,,,,""<br>2011-01-13 12:26:52.841 CST,,,32559,,4d2e7f0c.7f2f,3,,2011-01-13 12:26:52 CST,,0,LOG,00000,"consistent recovery state reached at 6/249173D8",,,,,,,,,""<br>2011-01-13 12:26:52.841 CST,,,32559,,4d2e7f0c.7f2f,4,,2011-01-13 12:26:52 CST,,0,LOG,00000,"record with zero length at 6/249173D8",,,,,,,,,""<br>2011-01-13 12:26:52.841 CST,,,32559,,4d2e7f0c.7f2f,5,,2011-01-13 12:26:52 CST,,0,LOG,00000,"redo is not required",,,,,,,,,""<br>2011-01-13 12:26:52.850 CST,,,32559,,4d2e7f0c.7f2f,6,,2011-01-13 12:26:52 CST,,0,LOG,00000,"checkpoint starting: end-of-recovery immediate",,,,,,,,,""<br>2011-01-13 12:26:52.913 CST,,,32559,,4d2e7f0c.7f2f,7,,2011-01-13 12:26:52 CST,,0,LOG,00000,"checkpoint complete: wrote 0 buffers (0.0%); 0 transaction log file(s) added, 0 removed, 0 recycled; write=0.048 s, sync=0.000 s, total=0.071 s",,,,,,,,,""<br>2011-01-13 12:26:52.927 CST,,,32562,,4d2e7f0c.7f32,1,,2011-01-13 12:26:52 CST,,0,LOG,00000,"autovacuum launcher started",,,,,,,,,""<br>2011-01-13 12:26:52.928 CST,,,32557,,4d2e7f0c.7f2d,1,,2011-01-13 12:26:52 CST,,0,LOG,00000,"database system is ready to accept connections",,,,,,,,,""<br><br><br>test=&gt; select pg_total_relation_size('tbl_test')/1024/1024;<br>&nbsp;?column? <br>----------<br>&nbsp;&nbsp;&nbsp;&nbsp; 1420<br>(1 row)<br><br>test=&gt; vacuum verbose analyze tbl_test;<br>INFO:&nbsp; vacuuming "test.tbl_test"<br>INFO:&nbsp; "tbl_test": found 0 removable, 1705 nonremovable row versions in 31 out of 181819 pages<br>DETAIL:&nbsp; 0 dead row versions cannot be removed yet.<br>There were 0 unused item pointers.<br>0 pages are entirely empty.<br>CPU 0.00s/0.00u sec elapsed 0.00 sec.<br>INFO:&nbsp; analyzing "test.tbl_test"<br>INFO:&nbsp; "tbl_test": scanned 30000 of 181819 pages, containing 1650000 live rows and 0 dead rows; 30000 rows in sample, 10000045 estimated total rows<br>VACUUM<br>test=&gt; select pg_total_relation_size('tbl_test')/1024/1024;<br>&nbsp;?column? <br>----------<br>&nbsp;&nbsp;&nbsp;&nbsp; 1420<br>(1 row)<br><br>Oracle的测试参考第二部分</div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">Winder - 2015-01-12 15:00:50</h5>
				<div>您好，我在主从备份的时候碰到一些问题。能否加您的qq咨询下呢。</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 Winder - 2015-01-12 15:00:50</h5>
				<div style="width:600px;">好的,或者给我发邮件 &nbsp;digoal@126.com</div>
			</div>
	</div>
</div>
</body>
</html>