<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">migrate Data From PostgreSQL to mongoDB using PG's copy AND mongoimport</h2>
	<h5 id="">2011-01-07 19:56:43&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402011076252545/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">最近有个项目启用了mongoDB主要用作查询缓存。<br>需要将部分PostgreSQL中的数据导入到mongoDB中，写程序来处理的话确实是比较烦。<br>对应格式如下:<br><div><img title="migrate Data From PostgreSQL to mongoDB using PGs copy AND mongoimport - 德哥@Digoal - The Heart,The World." alt="migrate Data From PostgreSQL to mongoDB using PGs copy AND mongoimport - 德哥@Digoal - The Heart,The World." style="margin: 0pt 10px 0pt 0pt;" src="http://img233.ph.126.net/xiC37eSkfkwMJSb4Gn8HnA==/1367405436862119806.jpg"></div>&nbsp;<br>还好mongoDB有一个比较好的工具mongoimport可以导入格式csv , tsc , json 等格式的文件。<br><br>1. 使用csv格式导入,这里遇到了数据类型的问题,比如某字段需要导入为string类型，进去变成了数值类型。(这里的话应该是可以搞的，暂时没找到好的办法)<br>首先从PostgreSQL导出到文件,由于"createTime","cardName"导入到mongoDB是string类型,所以使用"括起来，结果还是很悲剧，mongoimport不认为这样会是string。凡是看起来是数字的都变成了数字.<br>copy (select skyid as "skyId",real_amount as "realAmount",pay_type as "payType",to_char(create_time,'yyyymmddhh24miss') as "createTime",card_type as "cardType",card_name as "cardName",app_id as "appId",amount from tbl_digoal) to '/home/postgres/to_mongo.csv' with csv HEADER quote '"' force quote "createTime","cardName";<br>取出一条作为范例:(下面一行范例中createTime已经使用双引号了,cardName为空)<br>99999999,0,1,"20101111230027",99,,999999,9999<br>导入的写法如下:<br>mongoimport -h 127.0.0.1:5281 -d 库名 -c collection名 -u 用户 -p 密码 -f skyId,realAmount,payType,createTime,cardType,cardName,appId,amount --ignoreBlanks --type csv --headerline --file ./to_mongo.csv<br>导入后到mongoDB中查看结果如下:<br>{ "_id" : ObjectId("4d26fd83f96edba6b10e3e5d"), "skyId" : NumberLong(99999999), "realAmount" : 0, "payType" : 1, "createTime" : NumberLong("20101111230027"), "cardType" : 99, "appId" : 999999, "amount" : 9999 }<br>很明显,createTime变成NumberLong类型了.<br>cardName达到预期没有出现在行中.如果不使用--ignoreBlanks，那样的话会导入"cardName" : "" 的值。<br><br>2. 使用json格式导入,由于key和输入的值都是指定的，没有类型的问题了。就是从PostgreSQL到处的文件大了3倍。<br>下面调整一下PostgreSQL的导出SQL：<br>copy (select case when skyid is null then '{"skyId" : null,' else '{"skyId" : '||skyid||',' end || case when real_amount is null then '"realAmount" : null,' else '"realAmount" : '||real_amount||',' end || case when pay_type is null then '"payType" : null,' else '"payType" : '||pay_type||',' end || case when to_char(create_time,'yyyymmddhh24miss') is null then '"createTime" : null,' else '"createTime" : "'||to_char(create_time,'yyyymmddhh24miss')||'",' end || case when card_type is null then '"cardType" : null,' else '"cardType" : '||card_type||',' end || case when card_name is null then '"cardName" : null,' else '"cardName" : "'||card_name||'",' end || case when app_id is null then '"appId" : null,' else '"appId" : '||app_id||',' end || case when amount is null then '"amount" : null}' else '"amount" : '||amount||'}' end&nbsp; from tbl_digoal ) to '/home/postgres/to_mongo.json' <br>取出一条作为范例:(下面一行范例中createTime已经使用双引号了,cardName为空)<br>{"skyId" : 9999999999,"realAmount" : 0,"payType" : 1,"createTime" : "20101111230027","cardType" : 99,"cardName" : null,"appId" : 9999999,"amount" : 9999}<br>导入的写法如下:<br>mongoimport -h 127.0.0.1:5281 -d 库名 -c collection名 -u 用户名 -p 密码 --type json --file ./to_mongo.json <br>导入后取出记录如下,和对应的类型一致.达到预期:<br>{ "_id" : ObjectId("4d26ff29f96edba6b10e3e60"), "skyId" : NumberLong("9999999999"), "realAmount" : 0, "payType" : 1, "createTime" : "20101111230027", "cardType" : 99, "cardName" : null, "appId" : 9999999, "amount" : 9999 }<br>&gt; db.test.find({"skyId" : 9999999999})<br>{ "_id" : ObjectId("4d26ff29f96edba6b10e3e60"), "skyId" : NumberLong("9999999999"), "realAmount" : 0, "payType" : 1, "createTime" : "20101111230027", "cardType" : 99, "cardName" : null, "appId" : 9999999, "amount" : 9999 }<br><br>csv导入和json导入的区别:<br>1. csv导入的null可以直接把key忽略掉，而json的话显示为"$key" : null.当然你可以在json中删除掉"$key" : null这一节,那就和csv一样了.<br>2. 导入速度 没啥分别.<br><br>参考:<br>mongo@db-192-168-169-90-&gt; mongoimport --help<br>options:<br>&nbsp; --help&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; produce help message<br>&nbsp; -v [ --verbose ]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; be more verbose (include multiple times for more <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; verbosity e.g. -vvvvv)<br>&nbsp; -h [ --host ] arg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mongo host to connect to ("left,right" for pairs)<br>&nbsp; --port arg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server port. Can also use --host hostname:port<br>&nbsp; -d [ --db ] arg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; database to use<br>&nbsp; -c [ --collection ] arg collection to use (some commands)<br>&nbsp; -u [ --username ] arg&nbsp;&nbsp; username<br>&nbsp; -p [ --password ] arg&nbsp;&nbsp; password<br>&nbsp; --ipv6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; enable IPv6 support (disabled by default)<br>&nbsp; --dbpath arg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; directly access mongod database files in the given <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; path, instead of connecting to a mongod&nbsp; server - <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; needs to lock the data directory, so cannot be used <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if a mongod is currently accessing the same path<br>&nbsp; --directoryperdb&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if dbpath specified, each db is in a separate <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; directory<br>&nbsp; -f [ --fields ] arg&nbsp;&nbsp;&nbsp;&nbsp; comma separated list of field names e.g. -f name,age<br>&nbsp; --fieldFile arg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; file with fields names - 1 per line<br>&nbsp; --ignoreBlanks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if given, empty fields in csv and tsv will be ignored<br>&nbsp; --type arg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type of file to import.&nbsp; default: json (json,csv,tsv)<br>&nbsp; --file arg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; file to import from; if not specified stdin is used<br>&nbsp; --drop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; drop collection first <br>&nbsp; --headerline&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CSV,TSV only - use first line as headers<br>&nbsp; --upsert&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; insert or update objects that already exist<br>&nbsp; --upsertFields arg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; comma-separated fields for the query part of the <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; upsert. You should make sure this is indexed<br>&nbsp; --stopOnError&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stop importing at first error rather than continuing<br>&nbsp; --jsonArray&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; load a json array, not one item per line. Currently <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; limited to 4MB.</div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">nl - 2013-08-20 10:14:11</h5>
				<div>到底怎么搞呀，字符型的导进去变成了numberlong的了</div>
			</div>
	</div>
</div>
</body>
</html>