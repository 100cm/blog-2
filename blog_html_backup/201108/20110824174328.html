<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Test PostgreSQL 9.1's Merge duplicate fsync - 1</h2>
	<h5 id="">2011-08-24 17:43:28&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020117243337487/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">PostgreSQL 9.1 有一个性能方面的性能改进策略如下：<wbr><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  ><p style="font-size: 1em; line-height: 1.5em; margin-top: 0.2em; margin-right: 0em; margin-bottom: 1.2em; margin-left: 0em;"  >Merge duplicate fsync requests (Robert Haas, Greg Smith)</p><p style="font-size: 1em; line-height: 1.5em; margin-top: 0.2em; margin-right: 0em; margin-bottom: 1.2em; margin-left: 0em;"  >This greatly improves performance under heavy write loads.</p></span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  ><div>&nbsp;&nbsp;&nbsp; 首先bgwriter和walwriter都可能频繁的产生fsync的操作请求，把BUFFER里面的内容写入磁盘（非易失存储）。<br>&nbsp;&nbsp;&nbsp; FSYNC基本上属于随机IO请求，机械盘的IOPS能力非常有限，所以一般OLTP数据库的瓶颈大都出现在磁盘上面。降低IO读请求可以通过提高数据库的缓存命中率；而降低IO写请求的方法就比较有限，对于XLOG来说，如果独立给XLOG分配磁盘的话，那XLOG写请求可以认为是连续的IO请求，这个IOPS就比较高了；如果是 XLOG和DATAFILE混用的话，XLOG的写请求随机度就升高了，因为受到DATAFILE 写入的干扰，连续变离散。<br>&nbsp;&nbsp;&nbsp; 提高XLOG的FSYNC性能的方法，<br>1. 就是前面说的给XLOG独立的磁盘或磁盘组，<br>2. 可以通过合并IO请求来减少IO请求的次数，<span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 19px;"  >（#commit_delay和#commit_siblings</span> ，或异步提交）<br>&nbsp;&nbsp;&nbsp; 提高DATAFILE的FSYNC性能的方法，<br>1. 使用SSD磁盘提高随机IOPS能力<br>2. 想办法降低IO请求次数，如9.1提到的Merge duplicate fsync。<br>3. 想办法在离散的IO请求里面尽量去匹配物理存储的顺序，按顺序执行IO写入。<br><br>不太清楚这里表达的merge duplicate 是什么意思，<br>如果Merge duplicate fsync用于WALWRITER写XLOG的场景，那么表现应该是XLOG的写入量会降低（保证满足PITR的前提下）。<br>如果是用于BGWRITER写SHARED BUFFER的场景的话，数据文件的写入量应该减少。<br>猜得很累，想起了国产零零漆里面的台词，周星驰拿着一只鞋，其实是只吹风机，掏出一把枪，其实是个打火机，再掏出一只大哥大，其实是个刮胡刀。<br><br></div></span><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  >我猜测有几种可能 (当然直接去代码里找到相应改动是最好的) ：<br></span></font><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 19px;"  >1. XLOG的多次FSYNC请求合并成少量FSYNC请求？(</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 19px;"  > 这个可能性不大 , 因为需要调整#commit_delay和#commit_siblings参数 )</span></div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  ></span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 19px;"  >2. 数据文件的重复的block的fsync写请求合并成少量fsync请求？(这个可能性比较大，例如一个8K的block对应磁盘的16个扇区,如果16个扇区在一个bgwriter周期内都被修改过的话，可能出现16个FSYNC请求甚至更多，如果可以将多次fsync变一次或几次,性能将有所提升，在同样的压力状态下体现出来的w/s +&nbsp;</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 19px;"  >wrqm/s 应该比9.0更少。</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 19px;"  >)</span></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  >3. 这里所指也许完全不是前面两种场景，数据库什么时候可能产生完全相同的fsync请求 ? ( 同样的数据写入同样的磁盘块？不同的数据写入同样的磁盘块？同样的磁盘块内，不同的部分写入不同的数据？如一次性往表里面插入大量数据，数据库的BLOCK被逐渐填充，可能有合并bgwriter的FSYNC请求的可能。).</span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ><br></span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  >不管哪种可能，从字面理解，最终的体现应该是FSYNC请求变少了，写磁盘的字节数可能不变也可能减少。</span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ><br></span></font></div><div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >下面来验证测试一下和9.0的对比。</span></div></div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >测试环境 :&nbsp;</span></div><div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  >一、用户信息表</span></font></div><div><pre class="prettyprint"  ><p></p><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >CREATE TABLE user_info&nbsp;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >(userid int primary key,</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >firstname text,</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >lastname text,</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >age smallint,</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >sex text check (sex in ('female','male')),</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >mobile text,</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >address text,</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >corp text,</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >quarters text,</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >kb numeric check (kb &gt;= 0),</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >last_login_ip inet,</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >crt_time timestamp without time zone,</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >mod_time timestamp without time zone);</span></font></div><p></p></pre></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ><br></span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  >二、日志表</span></font></div><div><pre class="prettyprint"  ><p></p><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >CREATE TABLE success_log&nbsp;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >(userid int,</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >consume_kb numeric,</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >last_login_ip inet,</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >crt_time timestamp without time zone);</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br></span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >CREATE TABLE failed_log&nbsp;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >(userid int,</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >consume_kb numeric,</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >last_login_ip inet,</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >crt_time timestamp without time zone);</span></font></div><p></p></pre></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ><br></span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ><br></span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  >测试点 :&nbsp;</span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  >三、用户消费</span></font></div><div><pre class="prettyprint"  ><p></p><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >CREATE OR REPLACE FUNCTION digoal.consume_kb(i_userid integer, i_consume_kb numeric, i_last_login_ip inet)</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >&nbsp;RETURNS integer</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >&nbsp;LANGUAGE plpgsql</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >AS $function$</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >DECLARE</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >BEGIN</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >UPDATE user_info SET kb=kb-i_consume_kb,last_login_ip=i_last_login_ip,mod_time=now() WHERE userid=i_userid;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >INSERT INTO success_log(userid,consume_kb,last_login_ip,crt_time)&nbsp;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >VALUES (i_userid,i_consume_kb,i_last_login_ip,now());</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >RETURN 0;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >EXCEPTION</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >WHEN others THEN&nbsp;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >INSERT INTO failed_log(userid,consume_kb,last_login_ip,crt_time)&nbsp;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >VALUES (i_userid,i_consume_kb,i_last_login_ip,now());&nbsp;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >RETURN 1;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >END;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >$function$</span></font></div><p></p></pre></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  >四、获取用户信息</span></font></div><div><pre class="prettyprint"  ><p><font size="2"  >SELECT * from user_info where userid=$?;</font></p></pre></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ><br></span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  >五、测试数据</span></font></div><div><pre class="prettyprint"  ><p></p><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >INSERT INTO user_info&nbsp;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >SELECT generate_series(1,50000000),</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >'zhou'||generate_series(1,50000000),</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >'digoal'||generate_series(1,50000000),</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >28,</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >'male',</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >'13999999999',</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >'杭州市紫荆花路2号联合大厦B座11楼',</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >'杭州斯凯',</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >'DBA Team Leader',</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >100000,</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >'192.168.1.100',</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >now(),</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >now();</span></font></div><p></p></pre></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ><br></span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  >六、连接池</span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  >pgbouncer</span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ><br></span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  >七、测试程序</span></font></div><div><pre class="prettyprint"  ><p></p><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >nohup pgbench -M extended -c 500 -f /home/postgres/pgbench/get_user_info.sql -j 100 -n -T 120 -h 127.0.0.1 -p 1922 -U digoal digoal &gt;&gt;//home/postgres/pgbench/get_user_info.log 2&gt;&amp;1 &amp;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >nohup pgbench -M extended -c 500 -f /home/postgres/pgbench/consume_kb.sql -j 100 -n -T 120 -h 127.0.0.1 -p 1921 -U digoal digoal &gt;&gt;//home/postgres/pgbench/consume_kb.log 2&gt;&amp;1 &amp;</span></font></div><p></p></pre></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ><br></span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ># consume_kb.sql&nbsp;</span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ># 这里使用的随机USERID 1到5000W，所以重复更新一部分BLOCK的概率较小。后面改成1到1000看看结果的不一样之处。</span></font></div><div><pre class="prettyprint"  ><p></p><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >\setrandom i_userid 1 50000000</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >\setrandom i_consume_kb -10000000 10000000</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >SELECT consume_kb(:i_userid,:i_consume_kb,'192.168.1.2');</span></font></div><p></p></pre></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ><br></span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ># get_user_info.sql&nbsp;</span></font></div><div><pre class="prettyprint"  ><p></p><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >\setrandom i_userid 1 50000000</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >SELECT * from user_info where userid=:i_userid;</span></font></div><p></p></pre></div></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ><br></span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  >数据库几个和本文相关的参数,未指明的使用默认值 :&nbsp;</span></font></div><div><pre class="prettyprint"  ><p></p><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >shared_buffers = 2048MB</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >bgwriter_delay = 200ms</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >fsync = on</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >synchronous_commit = on</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >wal_sync_method = fdatasync</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >full_page_writes = on</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >wal_buffers = 16384kB</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >checkpoint_segments = 128</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >checkpoint_timeout = 15min</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >archive_mode = off</span></font></div><p></p></pre></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ><br></span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  >测试结果 :&nbsp;</span></font></div><div><pre class="prettyprint"  ><p></p><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >9.0&nbsp;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >测试过程中xlog盘的 wrqm/s&nbsp;w/s wsec/s %util 性能视图</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br></span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >平均值</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >683 , 163 , 6772 , 97</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br></span></font></div><div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >9.1&nbsp;</span></font></div><div style="line-height: 22px;"  ><font size="2"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  ><span style="line-height: 19px;"  >测试过程中xlog盘的 wrqm/s&nbsp;w/s&nbsp;</span></font><span style="font-family: verdana, sans-serif; line-height: 19px;"  >wsec/s&nbsp;</span><span style="font-family: verdana, sans-serif; line-height: 19px;"  >%util 性能视图</span></font></div></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br></span></font></div><div style="line-height: 22px;"  ><span style="font-family: verdana, sans-serif; line-height: 19px;"  ><font size="2"  >平均值</font></span></div><div style="line-height: 22px;"  ><span style="font-family: verdana, sans-serif; line-height: 19px;"  ><font size="2"  >831 , 161 , 7942 , 97&nbsp;</font></span></div><div style="line-height: 22px;"  ><span style="font-family: verdana, sans-serif; line-height: 19px;"  ><font size="2"  ><br></font></span></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br></span></font></div><div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >9.0&nbsp;</span></font></div><div style="line-height: 22px;"  ><font size="2"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  ><span style="line-height: 19px;"  >checkpoint时数据表user_info对应的磁盘的 wrqm/s&nbsp;w/s&nbsp;</span></font><span style="font-family: verdana, sans-serif; line-height: 19px;"  >wsec/s&nbsp;</span><span style="font-family: verdana, sans-serif; line-height: 19px;"  >%util 性能视图</span></font></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br></span></font></div><div style="line-height: 22px;"  ><span style="font-family: verdana, sans-serif; line-height: 19px;"  ><font size="2"  >平均值</font></span></div><div style="line-height: 22px;"  ><span style="font-family: verdana, sans-serif; line-height: 19px;"  ><font size="2"  >457 , 861 , 10506 , 82</font></span></div><div style="line-height: 22px;"  ><span style="font-family: verdana, sans-serif; line-height: 19px;"  ><font size="2"  >时长16秒</font></span></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br style="line-height: 19px;"  ></span></font></div><div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >9.1&nbsp;</span></font></div><div><font size="2"  ><span style="font-family: verdana, sans-serif; line-height: 19px;"  >checkpoint时数据表user_info对应的磁盘的 wrqm/s&nbsp;w/s&nbsp;</span><span style="font-family: verdana, sans-serif; line-height: 19px;"  >wsec/s&nbsp;</span><span style="font-family: verdana, sans-serif; line-height: 19px;"  >%util 性能视图</span></font></div></div></div><div><span style="font-family: verdana, sans-serif; line-height: 19px;"  ><font size="2"  ><br></font></span></div><div><span style="font-family: verdana, sans-serif; line-height: 19px;"  ><font size="2"  >平均值</font></span></div><div><span style="font-family: verdana, sans-serif; line-height: 19px;"  ><font size="2"  >941 , 1492 , 19474 , 99</font></span></div><div><span style="font-family: verdana, sans-serif; line-height: 19px;"  ><font size="2"  >时长76秒</font></span></div><div><span style="font-family: verdana, sans-serif; line-height: 19px;"  ><font size="2"  ><br></font></span></div><div><span style="font-family: verdana, sans-serif; line-height: 19px;"  ><font size="2"  ># 以下这里使用的随机USERID 改成1到1000看看结果的不一样之处。</font></span></div><div><span style="font-family: verdana, sans-serif; line-height: 19px;"  ><span style="font-family: Arial, Helvetica, sans-serif; line-height: 22px;"  ><font size="2"  ><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  ><span style="line-height: 19px;"  >\setrandom i_userid 1 1000</span></font></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  ><span style="line-height: 19px;"  >\setrandom i_consume_kb -10000000 10000000</span></font></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  ><span style="line-height: 19px;"  >SELECT consume_kb(:i_userid,:i_consume_kb,'192.168.1.2');</span></font></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  ><span style="line-height: 19px;"  ><br></span></font></div></font></span></span><div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >9.0&nbsp;</span></font></div><div style="line-height: 22px;"  ><font size="2"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  ><span style="line-height: 19px;"  >测试过程中xlog盘的 wrqm/s&nbsp;w/s&nbsp;</span></font><span style="font-family: verdana, sans-serif; line-height: 19px;"  >wsec/s&nbsp;</span><span style="font-family: verdana, sans-serif; line-height: 19px;"  >%util 性能视图</span></font></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br style="line-height: 19px;"  ></span></font></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >平均值</span></font></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >679 , 162 , 6739 , 97</span></font></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br style="line-height: 19px;"  ></span></font></div><div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >9.1&nbsp;</span></font></div><div style="line-height: 22px;"  ><font size="2"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  ><span style="line-height: 19px;"  >测试过程中xlog盘的 wrqm/s&nbsp;w/s&nbsp;</span></font><span style="font-family: verdana, sans-serif; line-height: 19px;"  >wsec/s&nbsp;</span><span style="font-family: verdana, sans-serif; line-height: 19px;"  >%util 性能视图</span></font></div></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br style="line-height: 19px;"  ></span></font></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-family: verdana, sans-serif;"  ><font size="2"  >平均值</font></span></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-family: verdana, sans-serif;"  ><font size="2"  >536 , 163 , 5603 , 97</font></span></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br style="line-height: 19px;"  ></span></font></div><div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >9.0&nbsp;</span></font></div><div style="line-height: 22px;"  ><font size="2"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  ><span style="line-height: 19px;"  >checkpoint时数据表user_info对应的磁盘的 wrqm/s&nbsp;w/s&nbsp;</span></font><span style="font-family: verdana, sans-serif; line-height: 19px;"  >wsec/s&nbsp;</span><span style="font-family: verdana, sans-serif; line-height: 19px;"  >%util 性能视图</span></font></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br style="line-height: 19px;"  ></span></font></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-family: verdana, sans-serif;"  ><font size="2"  >平均值</font></span></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-family: verdana, sans-serif;"  ><font size="2"  >511 , 957 , 11755 , 87</font></span></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br style="line-height: 19px;"  ></span></font></div><div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >9.1&nbsp;</span></font></div><div style="line-height: 22px;"  ><font size="2"  ><span style="line-height: 19px; font-family: verdana, sans-serif;"  >checkpoint时数据表user_info对应的磁盘的 wrqm/s&nbsp;w/s&nbsp;</span><span style="font-family: verdana, sans-serif; line-height: 19px;"  >wsec/s&nbsp;</span><span style="font-family: verdana, sans-serif; line-height: 19px;"  >%util 性能视图</span></font></div></div></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-family: verdana, sans-serif;"  ><font size="2"  ><br style="line-height: 19px;"  ></font></span></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-family: verdana, sans-serif;"  ><font size="2"  >平均值</font></span></div></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-family: verdana, sans-serif;"  ><font size="2"  >1358 , 1771 , 25050 , 99</font></span></div><div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br></span></font></div><div><font size="2"  ><font face="verdana, sans-serif"  ><span style="line-height: 19px;"  >测试第三种可能(</span></font><span style="font-family: verdana, sans-serif; line-height: 19px;"  >一次性往表里面插入大量数据，数据库的BLOCK被逐渐填充，可能有合并bgwriter的FSYNC请求的可能</span><span style="font-family: verdana, sans-serif; line-height: 19px;"  >):</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >insert into tbl_fsync_merge_test select generate_series(1,5000000),'Merge test!';</span></font></div><div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >9.0&nbsp;</span></font></div><div style="line-height: 22px;"  ><font size="2"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  ><span style="line-height: 19px;"  >测试过程中xlog盘的 wrqm/s&nbsp;w/s&nbsp;</span></font><span style="font-family: verdana, sans-serif; line-height: 19px;"  >wsec/s&nbsp;</span><span style="font-family: verdana, sans-serif; line-height: 19px;"  >%util 性能视图</span></font></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br style="line-height: 19px;"  ></span></font></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >平均值</span></font></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >11814 , 133 , 96350 , 84</span></font></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br style="line-height: 19px;"  ></span></font></div><div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >9.1&nbsp;</span></font></div><div style="line-height: 22px;"  ><font size="2"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  ><span style="line-height: 19px;"  >测试过程中xlog盘的 wrqm/s&nbsp;w/s&nbsp;</span></font><span style="font-family: verdana, sans-serif; line-height: 19px;"  >wsec/s&nbsp;</span><span style="font-family: verdana, sans-serif; line-height: 19px;"  >%util 性能视图</span></font></div></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br style="line-height: 19px;"  ></span></font></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-family: verdana, sans-serif;"  ><font size="2"  >平均值</font></span></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-family: verdana, sans-serif;"  ><font size="2"  >12912 , 145 , 103026 , 84</font></span></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br style="line-height: 19px;"  ></span></font></div><div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >9.0&nbsp;</span></font></div><div style="line-height: 22px;"  ><font size="2"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  ><span style="line-height: 19px;"  >checkpoint时数据表user_info对应的磁盘的 wrqm/s&nbsp;w/s&nbsp;</span></font><span style="font-family: verdana, sans-serif; line-height: 19px;"  >wsec/s&nbsp;</span><span style="font-family: verdana, sans-serif; line-height: 19px;"  >%util 性能视图</span></font></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br style="line-height: 19px;"  ></span></font></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-family: verdana, sans-serif;"  ><font size="2"  >平均值</font></span></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-family: verdana, sans-serif;"  ><font size="2"  >26761 , 257 , 194700 , 92</font></span></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-family: verdana, sans-serif;"  ><font size="2"  >时长21秒</font></span></div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br style="line-height: 19px;"  ></span></font></div><div><div style="line-height: 22px;"  ><font style="line-height: 22px;"  face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >9.1&nbsp;</span></font></div><div style="line-height: 22px;"  ><font size="2"  ><span style="line-height: 19px; font-family: verdana, sans-serif;"  >checkpoint时数据表user_info对应的磁盘的 wrqm/s&nbsp;w/s&nbsp;</span><span style="font-family: verdana, sans-serif; line-height: 19px;"  >wsec/s&nbsp;</span><span style="font-family: verdana, sans-serif; line-height: 19px;"  >%util 性能视图</span></font></div></div></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-family: verdana, sans-serif;"  ><font size="2"  ><br style="line-height: 19px;"  ></font></span></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-family: verdana, sans-serif;"  ><font size="2"  >平均值</font></span></div></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-family: verdana, sans-serif;"  ><font size="2"  >17851 , 195 , 144370 , 76</font></span></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-family: verdana, sans-serif;"  ><font size="2"  >时长98秒</font></span></div></div></div><p></p></pre></div><div><div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ><br></span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  >更新操作的PGBENCH报告 :</span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  >从结果上看，两者是在同等压力下测试的，有可比较性。</span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  >PostgreSQL 9.1</span></font></div><div><font face="verdana, sans-serif"  ><span style="line-height: 19px;"  ><div><pre class="prettyprint"  ><p></p><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 500</font></div><div><font size="2"  >number of threads: 100</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 10076</font></div><div><font size="2"  >tps = 159.677377 (including connections establishing)</font></div><div><font size="2"  >tps = 159.854173 (excluding connections establishing)</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 500</font></div><div><font size="2"  >number of threads: 100</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 10240</font></div><div><font size="2"  >tps = 162.491570 (including connections establishing)</font></div><div><font size="2"  >tps = 162.670016 (excluding connections establishing)</font></div><p></p></pre></div><div style="font-size: 12px;"  ><br></div><div style="font-size: 12px;"  >PostgreSQL 9.0.4</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 500</font></div><div><font size="2"  >number of threads: 100</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 10053</font></div><div><font size="2"  >tps = 159.484973 (including connections establishing)</font></div><div><font size="2"  >tps = 159.683664 (excluding connections establishing)</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 500</font></div><div><font size="2"  >number of threads: 100</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 10191</font></div><div><font size="2"  >tps = 161.729913 (including connections establishing)</font></div><div><font size="2"  >tps = 161.917860 (excluding connections establishing)</font></div><p></p></pre></div><div style="font-size: 12px;"  ><span style="line-height: 19px;"  >总结:</span></div></span></font></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-family: verdana, sans-serif; font-size: 12px;"  >1. postgresql 9.1rc1 checkpoint耗时明显比9.0.4长。</span></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-family: verdana, sans-serif; font-size: 12px;"  >2. 在随机数是1到1000，也就是DUPLICATE可能性较大的情况下，WRQ/S，W/S，wsec/s比9.0略小，但是不明显，反而CHECKPOINT时间长了几倍，所以总的来说写入量增加了。</span></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-family: verdana, sans-serif; font-size: 12px;"  >3. 在随机数是1到5000W时，没有明显差异。</span></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-family: verdana, sans-serif; font-size: 12px;"  >4. 在BULK插入时，没有明显差异。</span></div><div style="line-height: 22px;"  ><span style="line-height: 19px; font-family: verdana, sans-serif; font-size: 12px;"  >总之没有得到预期的效果，反而感觉比9.0.4略差。</span></div></div></div><div><div style="margin-top: 3.36pt; margin-bottom: 0pt; margin-left: 0.38in; text-indent: -0.38in; text-align: left; direction: ltr; unicode-bidi: embed; vertical-align: baseline;"  ><div style="color: black; font-family: 'Times New Roman'; font-size: 14pt; line-height: 120%; margin-top: 3.36pt; margin-bottom: 0pt; margin-left: 0.38in; text-indent: -0.38in; text-align: left; direction: ltr; unicode-bidi: embed; vertical-align: baseline;"  ><br></div></div></div></div>
	</div>
</div>
</body>
</html>