<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use chkpass type encrypted password in PostgreSQL</h2>
	<h5 id="">2011-07-07 11:31:25&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201167112254160/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><font size="2">chkpass这个extension利用标准的UNIX函数<wbr></font><font size="2"><span style="font-family: monospace; line-height: 18px;">crypt()对cstring 进行加密。</span></font><div><font face="monospace" size="2"><span style="line-height: 18px;">因此chkpass和crypt()的所有使用限制一样，如只能存储8位长度的密码。<br></span></font></div><div><div><span style="font-family: monospace;"><font size="2">chkpass创建后，在数据库里面多出6个函数其中2个比较函数，一个数据类型，还有两个运算符。</font></span></div><div><span style="font-family: monospace; line-height: 19px; font-size: small;">chkpass_out</span><span style="font-size: small;">和</span><span style="font-family: monospace; line-height: 19px; font-size: small;">raw的区别在于显示方面,raw 不显示前面的冒号。</span><font size="2"><div><font face="monospace"><span style="line-height: 19px;"><br></span></font></div><div><font face="monospace"><span style="line-height: 19px;">CREATE FUNCTION eq(chkpass, text)</span></font></div><div><font face="monospace"><span style="line-height: 19px;">&nbsp; &nbsp; &nbsp; &nbsp; RETURNS bool</span></font></div><div><font face="monospace"><span style="line-height: 19px;">&nbsp; &nbsp; &nbsp; &nbsp; AS 'MODULE_PATHNAME', 'chkpass_eq'</span></font></div><div><font face="monospace"><span style="line-height: 19px;">&nbsp; &nbsp; &nbsp; &nbsp; LANGUAGE C STRICT;</span></font></div></font><span style="font-family: monospace; line-height: 19px; font-size: small;">CREATE FUNCTION ne(chkpass, text)</span><font size="2"><div><font face="monospace"><span style="line-height: 19px;">&nbsp; &nbsp; &nbsp; &nbsp; RETURNS bool</span></font></div><div><font face="monospace"><span style="line-height: 19px;">&nbsp; &nbsp; &nbsp; &nbsp; AS 'MODULE_PATHNAME', 'chkpass_ne'</span></font></div><div><font face="monospace"><span style="line-height: 19px;">&nbsp; &nbsp; &nbsp; &nbsp; LANGUAGE C STRICT;</span></font></div><div><div><font face="monospace"><span style="line-height: 19px;">CREATE FUNCTION chkpass_in(cstring)</span></font></div><div><font face="monospace"><span style="line-height: 19px;">&nbsp; &nbsp; &nbsp; &nbsp; RETURNS chkpass</span></font></div><div><font face="monospace"><span style="line-height: 19px;">&nbsp; &nbsp; &nbsp; &nbsp; AS 'MODULE_PATHNAME'</span></font></div><div><font face="monospace"><span style="line-height: 19px;">&nbsp; &nbsp; &nbsp; &nbsp; LANGUAGE C STRICT;</span></font></div></div></font><span style="font-family: monospace; line-height: 19px; font-size: small;">CREATE FUNCTION chkpass_out(chkpass)</span><font size="2"><div><div><font face="monospace"><span style="line-height: 19px;">&nbsp; &nbsp; &nbsp; &nbsp; RETURNS cstring</span></font></div><div><font face="monospace"><span style="line-height: 19px;">&nbsp; &nbsp; &nbsp; &nbsp; AS 'MODULE_PATHNAME'</span></font></div><div><font face="monospace"><span style="line-height: 19px;">&nbsp; &nbsp; &nbsp; &nbsp; LANGUAGE C STRICT;</span></font></div></div><div><font face="monospace"><span style="line-height: 19px;"><div>CREATE FUNCTION raw(chkpass)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; RETURNS text</div><div>&nbsp; &nbsp; &nbsp; &nbsp; AS 'MODULE_PATHNAME', 'chkpass_rout'</div><div>&nbsp; &nbsp; &nbsp; &nbsp; LANGUAGE C STRICT;</div></span></font></div></font></div><div><span style="font-family: monospace;"><font size="2"><div>CREATE TYPE chkpass (</div><div>&nbsp; &nbsp; &nbsp; &nbsp; internallength = 16,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; input = chkpass_in,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; output = chkpass_out</div><div>);</div></font></span></div><div><font face="monospace" size="2"><span style="line-height: 19px;"><div>CREATE OPERATOR = (</div><div>&nbsp; &nbsp; &nbsp; &nbsp; leftarg = chkpass,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; rightarg = text,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; negator = &lt;&gt;,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; procedure = eq</div><div>);</div></span></font><span style="font-family: monospace; line-height: 19px; font-size: small;">CREATE OPERATOR &lt;&gt; (</span><font face="monospace" size="2"><span style="line-height: 19px;"><div>&nbsp; &nbsp; &nbsp; &nbsp; leftarg = chkpass,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; rightarg = text,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; negator = =,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; procedure = ne</div><div>);</div></span></font></div><div><span style="font-family: monospace;"><font size="2"><br></font></span></div><div><span style="font-family: monospace;"><font size="2">如:</font></span></div><div><font face="monospace" size="2"><span style="line-height: 19px;">digoal=&gt; insert into tbl_test (id,passwd) values (1,'abc');</span></font></div><div><font size="2"><div style="font-family: monospace;">digoal=&gt; select id,passwd,chkpass_out(passwd),raw(passwd) from tbl_test;</div><div style="font-family: monospace;">&nbsp;id | &nbsp; &nbsp; passwd &nbsp; &nbsp; | &nbsp;chkpass_out &nbsp; | &nbsp; &nbsp; &nbsp;raw &nbsp; &nbsp; &nbsp;</div><div style="font-family: monospace;">----+----------------+----------------+---------------</div><div style="font-family: monospace;">&nbsp; 1 | :G325RU.X/ya7U | :G325RU.X/ya7U | G325RU.X/ya7U</div><div style="font-family: monospace;">(1 row)</div><div style="font-family: monospace;"><br></div><div style="font-family: monospace;">如果密码明文的第一个字符是冒号的话，需要使用转义</div><div><font face="monospace">digoal=&gt; insert into tbl_test (id,passwd) values (2,':abc');</font></div><div style="font-family: monospace;"><div>digoal=&gt; select id,passwd,chkpass_out(passwd),raw(passwd) from tbl_test;</div><div>&nbsp;id | &nbsp; &nbsp; passwd &nbsp; &nbsp; | &nbsp;chkpass_out &nbsp; | &nbsp; &nbsp; &nbsp;raw &nbsp; &nbsp; &nbsp;</div><div>----+----------------+----------------+---------------</div><div>&nbsp; 1 | :G325RU.X/ya7U | :G325RU.X/ya7U | G325RU.X/ya7U</div><div>&nbsp; 2 | :abc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | :abc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | abc</div><div>(2 rows)</div></div><div><font face="monospace">digoal=&gt; insert into tbl_test (id,passwd) values (3,'\:abc');</font></div><div><font face="monospace"><span style="line-height: 19px;"><div>digoal=&gt; select id,passwd,chkpass_out(passwd),raw(passwd) from tbl_test;</div><div>&nbsp;id | &nbsp; &nbsp; passwd &nbsp; &nbsp; | &nbsp;chkpass_out &nbsp; | &nbsp; &nbsp; &nbsp;raw &nbsp; &nbsp; &nbsp;</div><div>----+----------------+----------------+---------------</div><div>&nbsp; 1 | :G325RU.X/ya7U | :G325RU.X/ya7U | G325RU.X/ya7U</div><div>&nbsp; 2 | :abc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | :abc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | abc</div><div>&nbsp; 3 | :rADvTP7V8KnHc | :rADvTP7V8KnHc | rADvTP7V8KnHc</div><div>(3 rows)</div><div><br></div></span></font></div></font></div><div><span style="font-family: monospace; line-height: 18px;"><font size="2">比较密码时使用运算符号或函数都可以.</font></span></div></div><div><font size="2"><div style="font-family: monospace; line-height: 18px;">digoal=&gt; select * from tbl_test where passwd='abc';</div><div style="font-family: monospace; line-height: 18px;">&nbsp;id | &nbsp; &nbsp; passwd &nbsp; &nbsp;&nbsp;</div><div style="font-family: monospace; line-height: 18px;">----+----------------</div><div style="font-family: monospace; line-height: 18px;">&nbsp; 1 | :G325RU.X/ya7U</div><div style="font-family: monospace; line-height: 18px;">(1 row)</div><div style="font-family: monospace; line-height: 18px;"><div>digoal=&gt; select * from tbl_test where passwd='\:abc';</div><div>&nbsp;id | &nbsp; &nbsp; passwd &nbsp; &nbsp;&nbsp;</div><div>----+----------------</div><div>&nbsp; 3 | :rADvTP7V8KnHc</div><div>(1 row)</div></div><div><div><font face="monospace"><span style="line-height: 19px;"><br></span></font></div><div><font face="monospace"><span style="line-height: 19px;">digoal=&gt; select * from tbl_test where eq(passwd,'\:abc');</span></font></div><div><font face="monospace"><span style="line-height: 19px;">&nbsp;id | &nbsp; &nbsp; passwd &nbsp; &nbsp;&nbsp;</span></font></div><div><font face="monospace"><span style="line-height: 19px;">----+----------------</span></font></div><div><font face="monospace"><span style="line-height: 19px;">&nbsp; 3 | :rADvTP7V8KnHc</span></font></div><div><font face="monospace"><span style="line-height: 19px;">(1 row)</span></font></div></div><div><font face="monospace"><span style="line-height: 19px;"><br></span></font></div><div><font face="monospace"><span style="line-height: 19px;">密码长度超过8位的数字不比较，所以只要前8位字符一致都认为是一致的:</span></font></div><div><font face="monospace"><div style="line-height: 19px;">digoal=&gt; select chkpass_in('123456789')='123456781234';</div><div style="line-height: 19px;">&nbsp;?column?&nbsp;</div><div style="line-height: 19px;">----------</div><div style="line-height: 19px;">&nbsp;t</div><div style="line-height: 19px;">(1 row)</div><div><div>digoal=&gt; select chkpass_in('123456789')='12345678';</div><div>&nbsp;?column?&nbsp;</div><div>----------</div><div>&nbsp;t</div><div>(1 row)</div><div><br></div><div>digoal=&gt; select chkpass_in('123456789')='12345677';</div><div>&nbsp;?column?&nbsp;</div><div>----------</div><div>&nbsp;f</div><div>(1 row)</div></div></font></div><div><font face="monospace"><br></font></div></font></div></div>
	</div>
</div>
</body>
</html>