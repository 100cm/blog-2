<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL multi-commands batch insert performance test</h2>
	<h5 id="">2012-06-04 15:03:44&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020125421816584/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前面介绍过一篇PostgreSQL batch insert的性能评测文章如下</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201242331551545/"  >http://blog.163.com/digoal@126/blog/static/163877040201242331551545/</a> </div><div>有兴趣的朋友可以参考一下.</div><div>前面测试的两个batch insert都是在一个事务中进行的.&nbsp;</div><div>还有一种batch insert是multi-commands模式的. 即一次向PostgreSQL请求多条SQL. londiste3使用的就是这种模式.</div><div>下面来测试一下multi-commands batch insert的性能, 测试方法和测试机与上一次测试一样, 如下 :&nbsp;</div><div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  >测试环境:</div><div style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ><font size="2"  >PostgreSQL 9.2 beta1</font></div><div style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ><font size="2"  >CentOS 5.x 64bit</font></div><div style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ><font size="2"  >HP DL360G5</font></div><div style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ><font size="2"  >2 * Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5440 &nbsp;@ 2.83GHz CPU</font></div><div style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ><font size="2"  >SAS 146GB硬盘</font></div><p></p></pre></div></div><div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  >测试表,</font></div><div><pre class="prettyprint"  ><p></p><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >create table batch (</font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >id1 int,&nbsp;</font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >id2 int,</font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >id3 int,&nbsp;</font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >id4 int,</font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >id5 int,&nbsp;</font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >id6 int,</font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >id7 int,&nbsp;</font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >id8 int,</font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >id9 int,&nbsp;</font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >id10 int);</font></div><p></p></pre></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  ><br></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  >测试用的pgbench如下:</font></div><div><pre class="prettyprint"  ><p><font size="2"  >pgbench -M simple -c 8 -j 8 -f ./batch.sql -n -r -T 60 -h 127.0.0.1 -U postgres digoal</font></p></pre></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  ><br></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  >每次测试完后, 清理数据并执行checkpoint.</font></div><div><pre class="prettyprint"  ><p></p><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >truncate table batch;</font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >checkpoint;</font></div><p></p></pre></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  >异步提交下的测试结果 :&nbsp;</font></div></div><div><font color="#333333"  ><div><pre class="prettyprint"  ><p style="font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ></p><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ><font size="2"  >每个batch的commands, 每秒提交commands</font></div><div><p style="font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ></p><div><font size="2"  >1   77712<br>2   101294<br>4   132640<br>8   178584<br>16  183232<br>32  185440<br>64  186688<br>128 166784</font></div></div><p style="font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ></p></pre></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ><p></p></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  >pgbench详细测试结果 :&nbsp;</div><div><p style="font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ></p><div><p style="font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ></p><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg92@db-172-16-3-33-&gt; pgbench -M simple -c 8 -j 8 -f ./batch.sql -n -r -T 60 -h 127.0.0.1 -U postgres digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: simple</font></div><div><font size="2"  >number of clients: 8</font></div><div><font size="2"  >number of threads: 8</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 4663122</font></div><div><font size="2"  >tps = 77704.138244 (including connections establishing)</font></div><div><font size="2"  >tps = 77712.855022 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.101318 &nbsp; &nbsp; &nbsp; &nbsp;insert into batch values(1,2,3,4,5,6,7,8,9,10);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >pg92@db-172-16-3-33-&gt; pgbench -M simple -c 8 -j 8 -f ./batch.sql -n -r -T 60 -h 127.0.0.1 -U postgres digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: simple</font></div><div><font size="2"  >number of clients: 8</font></div><div><font size="2"  >number of threads: 8</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 3038998</font></div><div><font size="2"  >tps = 50640.309560 (including connections establishing)</font></div><div><font size="2"  >tps = 50647.300719 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.155947 &nbsp; &nbsp; &nbsp; &nbsp;insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >pg92@db-172-16-3-33-&gt; pgbench -M simple -c 8 -j 8 -f ./batch.sql -n -r -T 60 -h 127.0.0.1 -U postgres digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: simple</font></div><div><font size="2"  >number of clients: 8</font></div><div><font size="2"  >number of threads: 8</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 1989854</font></div><div><font size="2"  >tps = 33156.943779 (including connections establishing)</font></div><div><font size="2"  >tps = 33160.472659 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.238589 &nbsp; &nbsp; &nbsp; &nbsp;insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >pg92@db-172-16-3-33-&gt; pgbench -M simple -c 8 -j 8 -f ./batch.sql -n -r -T 60 -h 127.0.0.1 -U postgres digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: simple</font></div><div><font size="2"  >number of clients: 8</font></div><div><font size="2"  >number of threads: 8</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 1339341</font></div><div><font size="2"  >tps = 22320.901002 (including connections establishing)</font></div><div><font size="2"  >tps = 22323.795326 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.354627 &nbsp; &nbsp; &nbsp; &nbsp;insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >pg92@db-172-16-3-33-&gt; pgbench -M simple -c 8 -j 8 -f ./batch.sql -n -r -T 60 -h 127.0.0.1 -U postgres digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: simple</font></div><div><font size="2"  >number of clients: 8</font></div><div><font size="2"  >number of threads: 8</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 699091</font></div><div><font size="2"  >tps = 11450.946094 (including connections establishing)</font></div><div><font size="2"  >tps = 11452.246082 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.692685 &nbsp; &nbsp; &nbsp; &nbsp;insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >pg92@db-172-16-3-33-&gt; pgbench -M simple -c 8 -j 8 -f ./batch.sql -n -r -T 60 -h 127.0.0.1 -U postgres digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: simple</font></div><div><font size="2"  >number of clients: 8</font></div><div><font size="2"  >number of threads: 8</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 347709</font></div><div><font size="2"  >tps = 5794.898791 (including connections establishing)</font></div><div><font size="2"  >tps = 5795.528726 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 1.369810 &nbsp; &nbsp; &nbsp; &nbsp;insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >pg92@db-172-16-3-33-&gt; pgbench -M simple -c 8 -j 8 -f ./batch.sql -n -r -T 60 -h 127.0.0.1 -U postgres digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: simple</font></div><div><font size="2"  >number of clients: 8</font></div><div><font size="2"  >number of threads: 8</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 175079</font></div><div><font size="2"  >tps = 2917.062222 (including connections establishing)</font></div><div><font size="2"  >tps = 2917.330599 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 2.722609 &nbsp; &nbsp; &nbsp; &nbsp;insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >pg92@db-172-16-3-33-&gt; pgbench -M simple -c 8 -j 8 -f ./batch.sql -n -r -T 60 -h 127.0.0.1 -U postgres digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: simple</font></div><div><font size="2"  >number of clients: 8</font></div><div><font size="2"  >number of threads: 8</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 78229</font></div><div><font size="2"  >tps = 1303.512231 (including connections establishing)</font></div><div><font size="2"  >tps = 1303.639404 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 6.100038 &nbsp; &nbsp; &nbsp; &nbsp;insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,10);</font></div><p></p></pre></div><p style="font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ></p></div><p style="font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ></p></div></font></div><div><br></div><div>【小结】</div><div>1. multi-commands batch 模式不允许使用prepared statement. 因此pgbench测试时使用extended和prepared都会报错 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ERROR: &nbsp;cannot insert multiple commands into a prepared statement</font></div><div><font size="2"  >ERROR: &nbsp;cannot insert multiple commands into a prepared statement</font></div><div><font size="2"  >ERROR: &nbsp;cannot insert multiple commands into a prepared statement</font></div><div><font size="2"  >ERROR: &nbsp;cannot insert multiple commands into a prepared statement</font></div><div><font size="2"  >ERROR: &nbsp;cannot insert multiple commands into a prepared statement</font></div><div><font size="2"  >ERROR: &nbsp;cannot insert multiple commands into a prepared statement</font></div><div><font size="2"  >ERROR: &nbsp;cannot insert multiple commands into a prepared statement</font></div><div><font size="2"  >ERROR: &nbsp;cannot insert multiple commands into a prepared statement</font></div><div><font size="2"  >Client 5 aborted in state 0: ERROR: &nbsp;prepared statement "P0_0" does not exist</font></div><div><font size="2"  >Client 3 aborted in state 0: ERROR: &nbsp;prepared statement "P0_0" does not exist</font></div><div><font size="2"  >Client 4 aborted in state 0: ERROR: &nbsp;prepared statement "P0_0" does not exist</font></div><div><font size="2"  >Client 6 aborted in state 0: ERROR: &nbsp;prepared statement "P0_0" does not exist</font></div><div><font size="2"  >Client 0 aborted in state 0: ERROR: &nbsp;prepared statement "P0_0" does not exist</font></div><div><font size="2"  >Client 1 aborted in state 0: ERROR: &nbsp;prepared statement "P0_0" does not exist</font></div><div><font size="2"  >Client 2 aborted in state 0: ERROR: &nbsp;prepared statement "P0_0" does not exist</font></div><div><font size="2"  >Client 7 aborted in state 0: ERROR: &nbsp;prepared statement "P0_0" does not exist</font></div><p></p></pre></div>2. autocommit模式下的multi-commands batch insert, 中间如果出现错误的SQL, 其他正常的SQL将提交, 不会回滚整个batch操作, 例如:<div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# insert into batch values(1,2,3,4,5,6,7,8,9,10);insert into batch values(1,2,3,4,5,6,7,8,9,'abc');insert into batch values(1,2,3,4,5,6,7,8,9,10);</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >ERROR: &nbsp;invalid input syntax for integer: "abc"</font></div><div><font size="2"  >LINE 1: insert into batch values(1,2,3,4,5,6,7,8,9,'abc');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  ><span style="line-height: 19px;"  >-- 正常的数据已经入库.</span></font></div><div><font size="2"  >digoal=# select * from batch ;</font></div><div><font size="2"  >&nbsp;id1 | id2 | id3 | id4 | id5 | id6 | id7 | id8 | id9 | id10&nbsp;</font></div><div><font size="2"  >-----+-----+-----+-----+-----+-----+-----+-----+-----+------</font></div><div><font size="2"  >&nbsp; &nbsp;1 | &nbsp; 2 | &nbsp; 3 | &nbsp; 4 | &nbsp; 5 | &nbsp; 6 | &nbsp; 7 | &nbsp; 8 | &nbsp; 9 | &nbsp; 10</font></div><div><font size="2"  >&nbsp; &nbsp;1 | &nbsp; 2 | &nbsp; 3 | &nbsp; 4 | &nbsp; 5 | &nbsp; 6 | &nbsp; 7 | &nbsp; 8 | &nbsp; 9 | &nbsp; 10</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div>而前一篇BLOG的batch insert, 中间有异常的数据则整个batch回滚.</div></div>3. 其实最快的batch insert是copy. 如下 :&nbsp;<div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=# truncate batch ;</font></div><div><font size="2"  >TRUNCATE TABLE</font></div><div><font size="2"  >digoal=# copy (select 1,2,3,4,5,6,7,8,9,10 from (select generate_series(1,1000000)) t) to '/home/pg92/test.sql';</font></div><div><font size="2"  >COPY 1000000</font></div></div><div><div><font size="2"  >digoal=# \timing</font></div><div><font size="2"  >Timing is on.</font></div><div><font size="2"  >digoal=# copy batch from '/home/pg92/test.sql';</font></div><div><font size="2"  >COPY 1000000</font></div><div><font size="2"  >Time: 1394.502 ms</font></div></div><div><div><font size="2"  >digoal=# select 1000000/1.394502;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >---------------------</font></div><div><font size="2"  >&nbsp;717101.875795086705</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div>每秒入库的数据达到了<span style="line-height: 22px;"  >717101 . 但是copy不适合用在OLTP的常规SQL里面, 更适合做数据迁移, 导入导出.</span></div>4. multi-commands 带来了另一个问题, SQL注入攻击. 所以建议不要使用.<div>参考</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/devel/static/libpq-async.html"  >http://www.postgresql.org/docs/devel/static/libpq-async.html</a>&nbsp;</div><div>pgbouncer里面有一个开关是用来禁止PQexec调用接口的, 主要也是为了提高安全性.</div><div><pre style="margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 12px; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; color: rgb(51, 51, 51); line-height: 16px; text-align: -webkit-auto;"  ><div id="LC202"  style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 6px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial;"  >==== disable_pqexec ====</div><div id="LC203"  style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 6px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial;"  ><br></div><div id="LC204"  style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 6px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial;"  >Disable Simple Query protocol (PQexec).  Unlike Extended Query protocol, Simple Query</div><div id="LC205"  style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 6px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial;"  >allows multiple queries in one packet, which allows some classes of SQL-injection</div><div id="LC206"  style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 6px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial;"  >attacks.  Disabling it can improve security.  Obviously this means only clients that</div><div id="LC207"  style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 6px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial;"  >exclusively use Extended Query protocol will stay working.</div></pre><div><br></div></div></div>
	</div>
</div>
</body>
</html>