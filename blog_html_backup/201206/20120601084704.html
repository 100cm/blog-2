<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL SQL query time impacted by CPU Speed & Memory Speed</h2>
	<h5 id="">2012-06-01 8:47:04&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201251754214/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">昨天一位网友遇到一个问题，数据从PostgreSQL 8.x迁移到9.x后，执行时间变长了。<div>这个需要从几方面来排查，</div><div>1. 执行计划是否一致</div><div>2. 两边的数据库参数配置是否一致</div><div>3. 两边的操作系统内核参数配置是否一致</div><div>4. 两边的硬件配置是否一致，如CPU速度，内存速度，存储速度，接口带宽等</div><div>本篇BLOG不讨论前面3点，只来讨论一下不一样的内存和CPU对SQL处理速度的影响。</div><div>以后选购数据库服务器时, 要多多考虑.</div><div>我这里使用了3台服务器, &nbsp;CPU和内存的配置如下 :&nbsp;</div><div>A :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >Server : HP&nbsp;ProLiant DL360 G5</font></div><div><font size="2"  >CPU :&nbsp;Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5440 &nbsp;@ 2.83GHz</font></div><div><font size="2"  >MEM :&nbsp;DDR2&nbsp;667 MHz (2GB*6, 1GB*2)</font></div><p></p></pre></div><div>B :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >Server : DELL PowerEdge R610</font></div><div><font size="2"  >CPU : Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"  >MEM : DDR3&nbsp;1333 MHz (2GB*12)</font></div><p></p></pre></div><div>C :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >Server : HP ProLiant DL360 G5</font></div><div><font size="2"  >CPU :&nbsp;Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5405 &nbsp;@ 2.00GHz</font></div><div><font size="2"  >MEM :&nbsp;667 MHz (1.5 ns) (2GB*8)</font></div><p></p></pre></div><div>测试库版本 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >PostgreSQL 9.1.3</font></p></pre></div><div>配置 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >shared_buffers = 2048MB</font></p></pre></div><div>测试表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; create table test (id int);</font></div><div><font size="2"  >CREATE TABLE</font></div></div><div><div><font size="2"  >digoal=&gt; insert into test select generate_series(1,1000000);</font></div><div><font size="2"  >INSERT 0 1000000</font></div></div><p></p></pre></div><div>测试SQL :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; set work_mem='1024MB';</font></div><div><font size="2"  >digoal=&gt; explain (analyze ,verbose ,costs ,buffers) select * from test order by id;</font></div><p></p></pre></div><div>测试结果 :&nbsp;</div><div>-- 多次执行后取最后一次的值, （数据已在内存(shared 完全hit)，排除从磁盘读取的可能）</div><div>A :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 22px;"  >digoal=&gt; set work_mem='1024MB';</span> </font></div><div><div><font size="2"  ><span style="line-height: 22px;"  >digoal=&gt;</span>&nbsp;explain (analyze ,verbose ,costs ,buffers) select * from test order by id;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >-----------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Sort &nbsp;(cost=114082.84..116582.84 rows=1000000 width=4) (actual time=314.297..411.362 rows=1000000 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp;Output: id</font></div><div><font size="2"  >&nbsp; &nbsp;Sort Key: test.id</font></div><div><font size="2"  >&nbsp; &nbsp;Sort Method: quicksort &nbsp;Memory: 71452kB</font></div><div><font size="2"  >&nbsp; &nbsp;Buffers: shared hit=4425</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on public.test &nbsp;(cost=0.00..14425.00 rows=1000000 width=4) (actual time=0.016..118.435 rows=1000000 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buffers: shared hit=4425</font></div><div><font size="2"  >&nbsp;Total runtime: 493.376 ms</font></div><div><font size="2"  >(9 rows)</font></div></div><p></p></pre></div><div>B :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 22px;"  >digoal=&gt; set work_mem='1024MB';</span> </font></div><div><div><font size="2"  ><span style="line-height: 22px;"  >digoal=&gt;</span>&nbsp;explain (analyze ,verbose ,costs ,buffers) select * from test order by id;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >---------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Sort &nbsp;(cost=121342.45..123997.45 rows=1062000 width=4) (actual time=435.239..561.063 rows=1000000 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp;Output: id</font></div><div><font size="2"  >&nbsp; &nbsp;Sort Key: test.id</font></div><div><font size="2"  >&nbsp; &nbsp;Sort Method: quicksort &nbsp;Memory: 71452kB</font></div><div><font size="2"  >&nbsp; &nbsp;Buffers: shared hit=4425</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on test.test &nbsp;(cost=0.00..15045.00 rows=1062000 width=4) (actual time=0.016..180.778 rows=1000000 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buffers: shared hit=4425</font></div><div><font size="2"  >&nbsp;Total runtime: 679.548 ms</font></div><div><font size="2"  >(9 rows)</font></div></div><p></p></pre></div><div>C :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 22px;"  >digoal=&gt; set work_mem='1024MB';</span> </font></div><div><div><font size="2"  ><span style="line-height: 22px;"  >digoal=&gt;</span>&nbsp;explain (analyze ,verbose ,costs ,buffers) select * from test order by id;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >-----------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Sort &nbsp;(cost=114082.84..116582.84 rows=1000000 width=4) (actual time=1314.200..1894.382 rows=1000000 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp;Output: id</font></div><div><font size="2"  >&nbsp; &nbsp;Sort Key: test.id</font></div><div><font size="2"  >&nbsp; &nbsp;Sort Method: quicksort &nbsp;Memory: 71452kB</font></div><div><font size="2"  >&nbsp; &nbsp;Buffers: shared hit=4425</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on public.test &nbsp;(cost=0.00..14425.00 rows=1000000 width=4) (actual time=0.011..613.539 rows=1000000 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buffers: shared hit=4425</font></div><div><font size="2"  >&nbsp;Total runtime: 2457.041 ms</font></div><div><font size="2"  >(9 rows)</font></div></div><p></p></pre></div><div><br></div><div>【小结】</div><div>1. CPU的处理速度,CPU的特性(如是否有内嵌内存控制器等)和SQL执行速度息息相关.</div><div>本例用到的几个CPU信息和比较如下 :&nbsp;</div><div><div><a target="_blank" rel="nofollow" href="http://ark.intel.com/products/33082/Intel-Xeon-Processor-E5440-(12M-Cache-2_83-GHz-1333-MHz-FSB)"  >http://ark.intel.com/products/33082/Intel-Xeon-Processor-E5440-(12M-Cache-2_83-GHz-1333-MHz-FSB)</a></div><div><a target="_blank" rel="nofollow" href="http://ark.intel.com/products/40711/Intel-Xeon-Processor-E5504-(4M-Cache-2_00-GHz-4_80-GTs-Intel-QPI)"  >http://ark.intel.com/products/40711/Intel-Xeon-Processor-E5504-(4M-Cache-2_00-GHz-4_80-GTs-Intel-QPI)</a></div><div><a target="_blank" rel="nofollow" href="http://ark.intel.com/products/33079/Intel-Xeon-Processor-E5405-(12M-Cache-2_00-GHz-1333-MHz-FSB)"  >http://ark.intel.com/products/33079/Intel-Xeon-Processor-E5405-(12M-Cache-2_00-GHz-1333-MHz-FSB)</a></div><div><a target="_blank" rel="nofollow" href="http://ark.intel.com/compare/33082,40711,33079"  >http://ark.intel.com/compare/33082,40711,33079</a></div></div><div>2. 通道,内存的频率以及是否启用了NUMA, 也是影响速率的关键因素.</div><div>和numa相关的一篇文章如下 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402011625104031947/"  >http://blog.163.com/digoal@126/blog/static/1638770402011625104031947/</a> </div><div>3. 和通道相关的可以参考百科 :&nbsp;</div><div><a rel="nofollow" href="http://baike.baidu.com/view/3100123.htm"  >http://baike.baidu.com/view/3100123.htm</a> </div><div>4. 三台服务器的内存信息如下 :&nbsp;</div><div>A :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >Physical Memory Array</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Location: System Board Or Motherboard</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Use: System Memory</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Error Correction Type: Single-bit ECC</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Maximum Capacity: 32 GB</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Error Information Handle: Not Provided</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Number Of Devices: 8</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Handle 0x1100, DMI type 17, 23 bytes</font></div><div><font size="2"  >Memory Device</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Array Handle: 0x1000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Error Information Handle: Not Provided</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Total Width: 72 bits</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Data Width: 64 bits</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Size: 2048 MB</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Form Factor: FB-DIMM</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Set: 1</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Locator: DIMM 1A</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Bank Locator: Not Specified</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Type: DDR2 FB-DIMM</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Type Detail: Synchronous</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Speed: 667 MHz</font></div><p></p></pre></div><div>B :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >Physical Memory Array</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Location: System Board Or Motherboard</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Use: System Memory</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Error Correction Type: Multi-bit ECC</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Maximum Capacity: 96 GB</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Error Information Handle: Not Provided</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Number Of Devices: 12</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Handle 0x1100, DMI type 17, 28 bytes</font></div><div><font size="2"  >Memory Device</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Array Handle: 0x1000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Error Information Handle: Not Provided</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Total Width: 72 bits</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Data Width: 64 bits</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Size: 2048 MB</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Form Factor: DIMM</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Set: 1</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Locator: DIMM_A1&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Bank Locator: Not Specified</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Type: DDR3</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Type Detail: Synchronous Registered (Buffered)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Speed: 1333 MHz</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Manufacturer: 80AD009780AD</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Serial Number: 247006E0</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Asset Tag: 0109291D</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Part Number: HMT125R7BFR8C-H9 &nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Rank: 2</font></div><p></p></pre></div><div>C :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >Physical Memory Array</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Location: System Board Or Motherboard</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Use: System Memory</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Error Correction Type: Single-bit ECC</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Maximum Capacity: 64 GB</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Error Information Handle: Not Provided</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Number Of Devices: 8</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Handle 0x1100, DMI type 17, 23 bytes.</font></div><div><font size="2"  >Memory Device</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Array Handle: 0x1000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Error Information Handle: Not Provided</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Total Width: 72 bits</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Data Width: 64 bits</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Size: 2048 MB</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Form Factor: &lt;OUT OF SPEC&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Set: 1</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Locator: DIMM 1A</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Bank Locator: Not Specified</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Type: &lt;OUT OF SPEC&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Type Detail: Synchronous</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Speed: 667 MHz (1.5 ns)</font></div><p></p></pre></div><div><br></div><div><br></div><div><br><wbr></div></div>
	</div>
</div>
</body>
</html>