<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">flashback query in PostgreSQL</h2>
	<h5 id="">2012-06-19 13:56:26&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201251911813661/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">PostgreSQL没说支持flashback query, 在PostgreSQL 2012中国用户大会上我也问了simon, 他表示很多功能都排上日程, 这个目前还没有排, 所以一时半会也不会去实现它.&nbsp;<div>很多朋友希望这个功能能加入到PostgreSQL的内核中.<wbr><div>我后来想了想, 其实PostgreSQL要支持这个还是可以的, 以下通过pg_resetxlog来实现flashback query的功能.</div><div>首先大家可以参考一下以下BLOG, 了解一下为什么要这么做?</div><div>Use pg_resetxlog simulate tuple disappear within PostgreSQL</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201183043153622/"   >http://blog.163.com/digoal@126/blog/static/163877040201183043153622/</a> </div><div><br></div><div>除了这种方法, 还可以通过触发器来跟踪和还原DML, truncate的操作, 参考</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014728105442434/"   >http://blog.163.com/digoal@126/blog/static/1638770402014728105442434/</a></div><div><br></div><div>还有一个前提是需要配置&nbsp;vacuum_defer_cleanup_age.</div><div>也就是需要确保dead tuple不被vacuum掉的事务个数. 例如,&nbsp;</div><div>delete from t1;</div><div>经过了1000个事务后, 如果需要闪回查询t1的数据, 那么vacuum_defer_cleanup_age要设置为1000以上.</div><div>否则t1的记录可能被autovacuum掉了.</div><div><br></div><div>但是需要注意, 如果这中间经过的1000个事务, 发生了大量数据的的update和delete, 这些数据都不能被vacuum掉, 只有等到超出了<span style="line-height: 22px;"   >vacuum_defer_cleanup_age设置的保留值后, 才能会vacuum掉. 所以可能造成dead tuple bloat现象.</span></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >接下来测试一下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >vi $PGDATA/postgresql.conf</font></span></div><div><font size="2"   >vacuum_defer_cleanup_age = 1024</font></div><p></p></pre></div><div><br></div><div>-- 重加载</div><div><pre class="prettyprint"   ><p><font size="2"   >pg_ctl reload</font></p></pre></div><div><br></div><div>-- 新建测试数据</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >psql digoal digoal</font></div><div><div><font size="2"   >digoal=&gt; create table t1 (id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=&gt; insert into t1 select generate_series(1,10);</font></div><div><font size="2"   >INSERT 0 10</font></div></div><p></p></pre></div><div><div><br></div><div>-- 在库中执行一些事务(这里可以随意, 目的是模拟经过多个事务后再来flashback query)</div></div><div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; select * from txid_current();</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;txid_current&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >--------------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; 7442050</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; select * from txid_current();</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;txid_current&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >--------------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; 7442051</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; select * from txid_current();</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;txid_current&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >--------------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; 7442052</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; select * from txid_current();</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;txid_current&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >--------------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; 7442053</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; create table t2 (id int);</font></div><div style="line-height: 22px;"   ><font size="2"   >CREATE TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; insert into t2 select generate_series(1,10);</font></div><div style="line-height: 22px;"   ><font size="2"   >INSERT 0 10</font></div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; select * from txid_current();</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;txid_current&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >--------------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; 7442056</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; select * from txid_current();</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;txid_current&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >--------------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; 7442057</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div></div><div>-- 模拟误操作, 把t1的表都更新掉.</div><div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; update t1 set id=0;</font></div><div style="line-height: 22px;"   ><font size="2"   >UPDATE 10</font></div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; select * from txid_current();</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;txid_current&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >--------------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; 7442059</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >-- 执行vacuum , 能看到确实不会回收掉这部分DEAD TUPLE</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; vacuum verbose t1;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.t1"</font></div><div><font size="2"   >INFO: &nbsp;"t1": found 0 removable, 20 nonremovable row versions in 1 out of 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;10 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><p></p></pre></div><div><br></div><div>-- 在PostgreSQL中实现flashback query</div><div>-- 首先关闭数据库</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; \q</font></div><div><font size="2"   >pg92@db-172-16-3-33-&gt; pg_ctl stop -m fast</font></div><div><font size="2"   >waiting for server to shut down...LOG: &nbsp;received fast shutdown request</font></div><div><font size="2"   >.LOG: &nbsp;aborting any active transactions</font></div><div><font size="2"   >LOG: &nbsp;autovacuum launcher shutting down</font></div><div><font size="2"   >LOG: &nbsp;shutting down</font></div><div><font size="2"   >LOG: &nbsp;database system is shut down</font></div><div><font size="2"   >pg_ done</font></div><div><font size="2"   >server stopped</font></div><p></p></pre></div><div>查看控制文件的<span style="line-height: 22px;"   >Latest checkpoint's NextXID. 查看到误操作前的数据后, 还要改回去的.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-33-&gt; pg_controldata&nbsp;</font></div><div><font size="2"   >pg_control version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;922</font></div><div><font size="2"   >Catalog version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 201204301</font></div><div><font size="2"   >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5752103169472836607</font></div><div><font size="2"   >Database cluster state: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shut down</font></div><div><font size="2"   >pg_control last modified: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tue 19 Jun 2012 01:49:58 PM CST</font></div><div><font size="2"   >Latest checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4/1030200</font></div><div><font size="2"   >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4/1011C88</font></div><div><font size="2"   >Latest checkpoint's REDO location: &nbsp; &nbsp;4/1030200</font></div><div><font size="2"   >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >Latest checkpoint's full_page_writes: on</font></div><div><font size="2"   >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/7442060</font></div><div><font size="2"   >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;17474</font></div><div><font size="2"   >Latest checkpoint's NextMultiXactId: &nbsp;1</font></div><div><font size="2"   >Latest checkpoint's NextMultiOffset: &nbsp;0</font></div><div><font size="2"   >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;1672</font></div><div><font size="2"   >Latest checkpoint's oldestXID's DB: &nbsp; 16385</font></div><div><font size="2"   >Latest checkpoint's oldestActiveXID: &nbsp;0</font></div><div><font size="2"   >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Tue 19 Jun 2012 01:49:58 PM CST</font></div><div><font size="2"   >Minimum recovery ending location: &nbsp; &nbsp; 0/0</font></div><div><font size="2"   >Backup start location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"   >Backup end location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"   >End-of-backup record required: &nbsp; &nbsp; &nbsp; &nbsp;no</font></div><div><font size="2"   >Current wal_level setting: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hot_standby</font></div><div><font size="2"   >Current max_connections setting: &nbsp; &nbsp; &nbsp;100</font></div><div><font size="2"   >Current max_prepared_xacts setting: &nbsp; 0</font></div><div><font size="2"   >Current max_locks_per_xact setting: &nbsp; 64</font></div><div><font size="2"   >Maximum data alignment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8</font></div><div><font size="2"   >Database block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8192</font></div><div><font size="2"   >Blocks per segment of large relation: 131072</font></div><div><font size="2"   >WAL block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 16384</font></div><div><font size="2"   >Bytes per WAL segment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16777216</font></div><div><font size="2"   >Maximum length of identifiers: &nbsp; &nbsp; &nbsp; &nbsp;64</font></div><div><font size="2"   >Maximum columns in an index: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;32</font></div><div><font size="2"   >Maximum size of a TOAST chunk: &nbsp; &nbsp; &nbsp; &nbsp;1996</font></div><div><font size="2"   >Date/time type storage: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64-bit integers</font></div><div><font size="2"   >Float4 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><div><font size="2"   >Float8 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><p></p></pre></div><div>-- 把nextXID设置到过去, 发生误操作前.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-33-&gt; pg_resetxlog -x 7442050 $PGDATA</font></div><div><font size="2"   >Transaction log reset</font></div><p></p></pre></div><div>-- 重启数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-33-&gt; pg_ctl start</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >pg92@db-172-16-3-33-&gt; LOG: &nbsp;database system was shut down at 2012-06-19 13:50:22 CST</font></div><div><font size="2"   >LOG: &nbsp;database system is ready to accept connections</font></div><div><font size="2"   >LOG: &nbsp;autovacuum launcher started</font></div><p></p></pre></div><div>-- 查看数据, 回来了. 看到的就是误操作前的数据.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-33-&gt; psql digoal digoal</font></div><div><font size="2"   >psql (9.2beta2)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; select * from t1;</font></div><div><font size="2"   >&nbsp;id&nbsp;</font></div><div><font size="2"   >----</font></div><div><font size="2"   >&nbsp; 1</font></div><div><font size="2"   >&nbsp; 2</font></div><div><font size="2"   >&nbsp; 3</font></div><div><font size="2"   >&nbsp; 4</font></div><div><font size="2"   >&nbsp; 5</font></div><div><font size="2"   >&nbsp; 6</font></div><div><font size="2"   >&nbsp; 7</font></div><div><font size="2"   >&nbsp; 8</font></div><div><font size="2"   >&nbsp; 9</font></div><div><font size="2"   >&nbsp;10</font></div><div><font size="2"   >(10 rows)</font></div><p></p></pre></div></div><div>-- 这部分数据可以把它备份出来. 然后把nextXID改回去. 重启数据库之后把数据修复.</div><div>Oracle使用的是UNDO来做flashback query. 而PostgreSQL则是用的snapshot view.</div><div>对于truncate都是无效的, 因为数据文件会删掉.</div></div><br><div>【注意】</div><div>1. 一定要注意防止<span style="line-height: 22px;"   >dead tuple bloat.</span></div><div><span style="line-height: 22px;"   >2. 这个操作一定不要直接使用生产库做, 可以使用pg_basebackup备份出来做, 或者使用文件系统镜像. 因为你已经回到数据库的过去, "改变历史是很恐怖的"(好像在寻秦记里面有这个台词.). 原因你的XID已经回到过去, 如果发生改动, 改动的数据的xid可能和后面(已经发生)的冲突. 所以flashback query建议只用于只读(例如可以加一个recovery.conf文件放在哪里, 然后以hot_standby的角色启动它, 那就不会发生写的情况了).&nbsp;</span></div><div><span style="line-height: 22px;"   ><br></span></div></div>
	</div>
</div>
</body>
</html>