<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL performance affected by NUMA - 2</h2>
	<h5 id="">2012-06-07 15:00:44&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012572513493/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前一篇写的是NUMA的三种策略和PostgreSQL按主键读的操作的性能对比. 如下 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402012571831555/"  >http://blog.163.com/digoal@126/blog/static/1638770402012571831555/</a> </div><div>这篇测试一下按主键写和三种NUMA策略下的性能比较.</div><div><br></div><div>-- 测试表如下</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >psql digoal digoal</font></div><div><font size="2"  >create schema digoal;</font></div><div><font size="2"  >create table user_info (id int, info text);</font></div><div><font size="2"  >insert into user_info select generate_series(1,50000000),'digoal'||generate_series(1,50000000);</font></div><div><font size="2"  >alter table user_info add primary key (id);</font></div><p></p></pre></div><div>-- 加载如OS CACHE的SQL, 需要用到pgfincore, 不熟悉的朋友可以参考我以前写过的关于pgfincore的BLOG.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >select pgfadvise_willneed('pg_toast.'||relname) from pg_class where oid in (select reltoastrelid from pg_class where relname='user_info');</font></div><div><font size="2"  >select * from pgfadvise_willneed('digoal.user_info');</font></div><div><font size="2"  >select * from pgfadvise_willneed('digoal.user_info_pkey');</font></div><p></p></pre></div><div><br></div><div>-- pgbench用于测试update的脚本</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@172_16_3_52-&gt; vi upd.sql</font></div><div><font size="2"  >\setrandom id 1 50000000</font></div><div><font size="2"  >update digoal.user_info set info='DIGOAL' where id=:id;</font></div><p></p></pre></div><div><br></div><div>-- pgbench 测试语句</div><div><pre class="prettyprint"  ><p><font size="2"  >postgres@172_16_3_52-&gt; pgbench -M prepared -n -f ./upd.sql -h 127.0.0.1 -U digoal -r -T 60 -c 8 -j 8 digoal</font></p></pre></div><div><br></div><div>-- 为了避免硬盘IO造成瓶颈, 开启异步提交(synchronous_commit = off) ,</div><div>-- 数据文件移至/dev/shm, pg_xlog不需要移动.</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >#export PGDATA=/opt/pgdata/pg_root</font></div><div><font size="2"  >export PGDATA=/dev/shm/pg_root</font></div></div><div><font size="2"  >-- 把pg_xlog移出$PGDATA, 在/dev/shm/pg_root中作为软连接 (ln -s /opt/pgdata/pg_xlog /dev/shm/pg_root/pg_xlog)</font></div><div><font size="2"  >cp -r /opt/pgdata/pg_root /dev/shm</font></div><p></p></pre></div><div><br></div><div>一、default</div><div>-- 首先把数据库关掉</div><div><pre class="prettyprint"  ><p><font size="2"  >pg_ctl stop -m fast</font></p></pre></div><div>-- 清除OS缓存, 以清理分配出去的内存.</div><div><pre class="prettyprint"  ><p><font size="2"  >echo 3 &gt; /proc/sys/vm/drop_caches</font></p></pre></div><div>-- 启动数据库</div><div><pre class="prettyprint"  ><p><font size="2"  >pg_ctl start</font></p></pre></div><div>-- vacuum 测试表, checkpoint, 加载数据至os cache</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >psql digoal postgres</font></div><div><font size="2"  >vacuum digoal.user_info ;</font></div><div><font size="2"  >checkpoint;</font></div><div><font size="2"  >select pgfadvise_willneed('pg_toast.'||relname) from pg_class where oid in (select reltoastrelid from pg_class where relname='user_info');</font></div><div><font size="2"  >select * from pgfadvise_willneed('digoal.user_info');</font></div><div><font size="2"  >select * from pgfadvise_willneed('digoal.user_info_pkey');</font></div><p></p></pre></div><div><br></div><div>-- 压力测试结果</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@172_16_3_52-&gt; pgbench -M prepared -n -f ./upd.sql -h 127.0.0.1 -U digoal -r -T 60 -c 8 -j 8 digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 8</font></div><div><font size="2"  >number of threads: 8</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 2195789</font></div><div><font size="2"  >tps = 36595.562345 (including connections establishing)</font></div><div><font size="2"  >tps = 36599.364313 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002844 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.212967 &nbsp; &nbsp; &nbsp; &nbsp;update digoal.user_info set info='DIGOAL' where id=:id;</font></div><p></p></pre></div><div><br></div><div>二、interleave=all</div><div><span style="line-height: 22px;"  >-- 首先把数据库关掉</span> </div><div><pre class="prettyprint"  ><p><font size="2"  >pg_ctl stop -m fast</font></p></pre></div><div><span style="line-height: 22px;"  >-- 清除OS缓存, 以清理分配出去的内存.</span> </div><div><pre class="prettyprint"  ><p><font size="2"  >echo 3 &gt; /proc/sys/vm/drop_caches</font></p></pre></div><div><span style="line-height: 22px;"  >-- 启动数据库,&nbsp;</span>注意此时选择numa策略interleave=all</div><div><pre class="prettyprint"  ><p><font size="2"  >postgres@172_16_3_52-&gt; numactl --interleave=all pg_ctl start</font></p></pre></div><div><span style="line-height: 22px;"  >-- vacuum 测试表, checkpoint, 加载数据至os cache</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >psql digoal postgres</font></div><div><font size="2"  >vacuum digoal.user_info ;</font></div><div><font size="2"  >checkpoint;</font></div><div><font size="2"  >select pgfadvise_willneed('pg_toast.'||relname) from pg_class where oid in (select reltoastrelid from pg_class where relname='user_info');</font></div><div><font size="2"  >select * from pgfadvise_willneed('digoal.user_info');</font></div><div><font size="2"  >select * from pgfadvise_willneed('digoal.user_info_pkey');</font></div><p></p></pre></div><div><br></div><div>-- 压力测试结果</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@172_16_3_52-&gt; pgbench -M prepared -n -f ./upd.sql -h 127.0.0.1 -U digoal -r -T 60 -c 8 -j 8 digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 8</font></div><div><font size="2"  >number of threads: 8</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 2159559</font></div><div><font size="2"  >tps = 35991.452684 (including connections establishing)</font></div><div><font size="2"  >tps = 36000.155507 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002853 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.216709 &nbsp; &nbsp; &nbsp; &nbsp;update digoal.user_info set info='DIGOAL' where id=:id;</font></div><p></p></pre></div><div><br></div><div>三、localalloc</div><div><span style="line-height: 22px;"  >-- 首先把数据库关掉</span> </div><div><pre class="prettyprint"  ><p><font size="2"  >pg_ctl stop -m fast</font></p></pre></div><div><span style="line-height: 22px;"  >-- 清除OS缓存, 以清理分配出去的内存.</span> </div><div><pre class="prettyprint"  ><p><font size="2"  >echo 3 &gt; /proc/sys/vm/drop_caches</font></p></pre></div><div><span style="line-height: 22px;"  >-- 启动数据库,&nbsp;</span><span style="line-height: 22px;"  >注意此时选择numa策略localalloc</span></div><div><pre class="prettyprint"  ><p><font size="2"  >postgres@172_16_3_52-&gt; numactl --localalloc pg_ctl start</font></p></pre></div><div><span style="line-height: 22px;"  >-- vacuum 测试表, checkpoint, 加载数据至os cache</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >psql digoal postgres</font></div><div><font size="2"  >vacuum digoal.user_info ;</font></div><div><font size="2"  >checkpoint;</font></div><div><font size="2"  >select pgfadvise_willneed('pg_toast.'||relname) from pg_class where oid in (select reltoastrelid from pg_class where relname='user_info');</font></div><div><font size="2"  >select * from pgfadvise_willneed('digoal.user_info');</font></div><div><font size="2"  >select * from pgfadvise_willneed('digoal.user_info_pkey');</font></div><p></p></pre></div><div><br></div><div>-- 压力测试结果</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@172_16_3_52-&gt; pgbench -M prepared -n -f ./upd.sql -h 127.0.0.1 -U digoal -r -T 60 -c 8 -j 8 digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 8</font></div><div><font size="2"  >number of threads: 8</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 2244693</font></div><div><font size="2"  >tps = 37410.793055 (including connections establishing)</font></div><div><font size="2"  >tps = 37414.993972 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002920 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.208161 &nbsp; &nbsp; &nbsp; &nbsp;update digoal.user_info set info='DIGOAL' where id=:id;</font></div><p></p></pre></div><div><br></div><div>【小结】</div><div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  >1. 测试结果来看, NUMA策略性能分布 : &nbsp;localalloc &gt; default<span style="line-height: 25px;"  >&nbsp;&gt; </span><span style="line-height: 25px;"  >interleave</span>&nbsp;<span style="line-height: 25px;"  >&nbsp;.</span></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  >&nbsp; &nbsp; 如果觉得测试时间不够长, 可以把-T 调大一点, 这样出来的值更有可信度.</div></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  >2. Linux I/O 调度算法和性能也有一定关系, 关于调度算法RHEL 5里面有4种.</div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ><a href="http://blog.163.com/digoal@126/blog/static/163877040201192483154563/"  >http://blog.163.com/digoal@126/blog/static/163877040201192483154563/</a> </div><wbr></div>
	</div>
</div>
</body>
</html>