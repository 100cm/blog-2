<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">pgsql_fdw english doc</h2>
	<h5 id="">2012-06-21 20:30:37&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201252183037555/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><h1 id="pgsql_fdw"  style="font-family: Simsun; line-height: normal; text-align: -webkit-auto;"  ><font size="1"  >pgsql_fdw</font></h1><div style="font-family: Simsun; line-height: normal; text-align: -webkit-auto;"  ><font size="1"  ><a rel="nofollow" href="file:///C:/Users/Digoal/index-en.html"  >Top</a>&nbsp;&gt;&nbsp;<a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html"  >pgsql_fdw</a></font><div><hr><div><ol><li><a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html#name"  ><font size="1"  >Name</font></a></li><li><a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html#description"  ><font size="1"  >Description</font></a></li><li><a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html#install"  ><font size="1"  >Install</font></a><ol><li><a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html#requirement"  ><font size="1"  >Requirement</font></a></li><li><a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html#build"  ><font size="1"  >Build module</font></a></li><li><a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html#create-extension"  ><font size="1"  >Create extension</font></a></li><li><a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html#uninstall"  ><font size="1"  >Uninstall</font></a></li></ol></li><li><a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html#usage"  ><font size="1"  >How to use</font></a><ol><li><a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html#create-server"  ><font size="1"  >Create server</font></a></li><li><a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html#create-user-mapping"  ><font size="1"  >Create user mapping</font></a></li><li><a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html#create-foreign-table"  ><font size="1"  >Create foreign table</font></a></li><li><a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html#execute-query"  ><font size="1"  >Execute query</font></a></li><li><a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html#alter-options"  ><font size="1"  >Alter FDW options</font></a></li><li><a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html#connections"  ><font size="1"  >Connection management</font></a></li></ol></li><li><a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html#valid-options"  ><font size="1"  >Vaild FDW options</font></a></li><li><a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html#restrictions"  ><font size="1"  >Restrictions</font></a></li><li><a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html#details"  ><font size="1"  >Details</font></a><ol><li><a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html#connection-option"  ><font size="1"  >libpq Options used internally</font></a></li><li><a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html#functions"  ><font size="1"  >Functions</font></a></li></ol></li><li><a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html#seealso"  ><font size="1"  >See also</font></a></li></ol></div><h2 id="name"  ><font size="1"  >Name</font></h2><p><font size="1"  >pgsql_fdw -- A foreign data wrapper fot external PostgreSQL servers.</font></p><h2 id="description"  ><font size="1"  >Description</font></h2><p><font size="1"  >You can create foreign tables which point tables on external PostgreSQL servers. Then you can use those foreign tables like ordinary local tables in SELECT query to retrieve data from external data.</font></p><p><font size="1"  >pgsql_fdw optimizes remote query to reduce amount of data to be transferred.</font></p><ul><li><font size="1"  >Replace unnecessary column reference with NULL literal.</font></li><li><font size="1"  >Push some of WHERE clause down to remote server.</font></li></ul><p><font size="1"  >Foreign tables are read-only in PostgreSQL 9.1, so modifying foreign tables would cause error.</font></p><h2 id="install"  ><font size="1"  >Install</font></h2><p><font size="1"  >This section describes how to install pgsql_fdw.</font></p><h3 id="requirement"  ><font size="1"  >Requirement</font></h3><dl><dt><font size="1"  >PostgreSQL</font></dt><dd><font size="1"  >9.1</font></dd></dl><h3 id="build"  ><font size="1"  >Build module</font></h3><p><font size="1"  >Source code of PostgreSQL 9.1 or pgxs environment is required to build pgsql_fdw binary module. Please interpret x.y.z as the version you downloaded.</font></p><h4 id="build-with-source"  ><font size="1"  >Building with source code</font></h4><p><font size="1"  >You need to extract source files of pgsql_fdw down to contrib directory of PostgreSQL which has already been built, and invoke make command.</font></p><pre><font size="1"  >$ cd postgresql-9.1.x $ ./configure $ make $ cd contrib $ tar zxvf pgsql_fdw-x.y.z.tar.gz $ cd pgsql_fdw-x.y.z $ make $ sudo make install  </font></pre><h4 id="build-with-pgxs"  ><font size="1"  >Building with pgxs</font></h4><p><font size="1"  >You need to set USE_PGXS shell variable to build and install.</font></p><pre><font size="1"  >$ tar xzvf pgsql_fdw-x.y.z.tar.gz $ cd pgsql_fdw $ make USE_PGXS=1 $ sudo make USE_PGXS=1 install </font></pre><h3 id="create-extension"  ><font size="1"  >Create extension</font></h3><p><font size="1"  >pgsql_fdw conforms EXTENSION mechanism, which was introduced in PostgreSQL 9.1, so just need to invoke CREATE EXTENSION command to install pgsql_fdw to your database. You don't need to execute SQL script which has been installed into extension directory of your PostgreSQL installation. It's contrib modules style. To create pgsql_fdw extension, you need to be a superuser.</font></p><pre><font size="1"  >$ psql postgres=# CREATE EXTENSION pgsql_fdw; CREATE EXTENSION postgres=# \dew                  List of foreign-data wrappers    Name    |  Owner   |      Handler      |      Validator -----------+----------+-------------------+---------------------  pgsql_fdw | postgres | pgsql_fdw_handler | pgsql_fdw_validator (1 row)  postgres=# </font></pre><h3 id="uninstall"  ><font size="1"  >Uninstall</font></h3><p><font size="1"  >Executing DROP EXTENSION is the only thing you need to do to uninstall pgsql_fdw. If some objects which were created with pgsql_fdw exist, you need to drop them first, or use CASCADE option of DROP EXTENSION statement.</font></p><p><font size="1"  >Following example shows how to drop pgsql_fdw extension and some related objects: a server, a user mapping and four foreign tables.</font></p><pre><font size="1"  >postgres=# drop EXTENSION pgsql_fdw CASCADE; NOTICE:  drop cascades to 6 other objects DETAIL:  drop cascades to server remote_db drop cascades to user mapping for public drop cascades to foreign table remote_accounts drop cascades to foreign table remote_branches drop cascades to foreign table remote_tellers drop cascades to foreign table remote_history DROP EXTENSION postgres=# </font></pre><h2 id="usage"  ><font size="1"  >How to use</font></h2><p><font size="1"  >Here you see how to retrieve data on an external PostgreSQL server. This is just a sample, so please replace connection information and table definition to fit your environment.</font></p><h3 id="create-server"  ><font size="1"  >Create server</font></h3><p><font size="1"  >First of all, become a superuser and execute CREATE SERVER command to create a server object which points target server. You can specify hostname, port number and database name of the external server here.</font></p><pre><font size="1"  >postgres=# CREATE SERVER remote_db FOREIGN DATA WRAPPER pgsql_fdw postgres-# OPTIONS (host 'hostname', port '5432', dbname 'remote'); CREATE SERVER postgres=# </font></pre><h3 id="create-user-mapping"  ><font size="1"  >Create user mapping</font></h3><p><font size="1"  >Execute CREATE USER MAPPING command to create a user mapping object which links server and local user. Here you can specify username and password of external database user. Superuser privilege is required to this.</font></p><pre><font size="1"  >postgres=# CREATE USER MAPPING FOR postgres SERVER remote_db postgres-# OPTIONS (user 'postgres', password 'secret'); CREATE USER MAPPING postgres=# </font></pre><p><font size="1"  >User mapping for "public" is used for local users who don't have explicit user mapping.</font></p><pre><font size="1"  >postgres=# CREATE USER MAPPING FOR public SERVER remote_db postgres-# OPTIONS (user 'app_user', password 'secret'); CREATE USER MAPPING postgres=# </font></pre><h3 id="create-foreign-table"  ><font size="1"  >Create foreign table</font></h3><p><font size="1"  >Execute CREATE FOREIGN TABLE command to define a foreign table which points an external table. The syntax of CREATE FOREIGN TABLE is basically similar to syntax of CREATE TABLE, except that you need to specify server name. You can specify schema name and/or table name of external table as FDW option. Following example shows how to define a foreign table "remote_accounts", which points an external table "public.pgbench_accounts" on a server "remote_db".</font></p><pre><font size="1"  >postgres=# CREATE FOREIGN TABLE remote_accounts ( postgres(# aid integer, postgres(# bid integer, postgres(# abalance integer, postgres(# filler char(84)) postgres(# SERVER remote_db postgres(# OPTIONS (nspname 'public', relname 'pgbench_accounts'); CREATE FOREIGN TABLE postgres=# </font></pre><h3 id="execute-query"  ><font size="1"  >Execute query</font></h3><p><font size="1"  >Now you can get external data by executing usual SELECT statement against foreign tables. You can execute any SELECT against foreign tables, but can't modify external data via foreign table.</font></p><pre><font size="1"  >postgres=# SELECT aid, bid, abalance FROM remote_accounts WHERE aid = 1;  aid | bid | abalance -----+-----+----------    1 |   1 |        0 (1 row)  postgres=# </font></pre><p><font size="1"  >Owner of a foreign table can allow other users to use the foreign table by executing GRANT statement, like ordinary tables.</font></p><p><font size="1"  >EXPLAIN command shows actual query which is sent to external server for each foreign table. Following example shows a plan tree which is used to retrieve data from external table "pgbench_accounts" via a foreign table "remote_accounts".</font></p><pre><font size="1"  >postgres=# EXPLAIN SELECT aid, bid, abalance FROM remote_accounts WHERE aid = 1;                                                                 QUERY PLAN ------------------------------------------------------------------------------------------------------------------------------------------  Foreign Scan on remote_accounts  (cost=100.00..108.30 rows=1 width=12)    Filter: (aid = 1)    Remote SQL: DECLARE pgsql_fdw_cursor_2 SCROLL CURSOR FOR SELECT aid, bid, abalance, NULL FROM public.pgbench_accounts WHERE (aid = 1) (3 rows) </font></pre><h3 id="alter-options"  ><font size="1"  >Alter FDW options</font></h3><p><font size="1"  >You can change value of FDW options with ALTER statement. Following example shows how to change remote user's password. Note that SET is required to change value of existing option.</font></p><pre><font size="1"  >postgres=# ALTER USER MAPPING FOR postgres SERVER remote_db postgres-# OPTIONS (SET password 'more secret'); ALTER USER MAPPING postgres=# </font></pre><h3 id="connections"  ><font size="1"  >Connection management</font></h3><p><font size="1"  >pgsql_fdw establishes a connection in the first query which uses a foreign table on a foreign server. Established connection is reused by following queries, and even by following scans in same query, during local session. In other words, only one connection is established against a foreign server until you switch local user. You can see active connections via pgsql_fdw_connections view.</font></p><pre><font size="1"  >postgres=# select * from pgsql_fdw_connections;  srvid |    srvname     | usesysid | usename -------+----------------+----------+----------  16530 | remote_pgbench |       10 | postgres (1 row) </font></pre><p><font size="1"  >You can discard any active connection anytime by invoking pgsql_fdw_disconnect() with server oid and local user oid. You can discard all active connections with following query:</font></p><pre><font size="1"  >postgres=# SELECT pgsql_fdw_disconnect(srvid, usesysid) FROM pgsql_fdw_connections;  pgsql_fdw_disconnect ----------------------  OK  OK (2 rows) </font></pre><p><font size="1"  >When local transaction aborts, pgsql_fdw discards all active connections automatically. This would prevent connection leak occurs with unexpected error. Connection will be established again automatically when a foreign server was accessed later.</font></p><h2 id="valid-options"  ><font size="1"  >Vaild FDW options</font></h2><p><font size="1"  >pgsql_fdw retrieves various information required for a query against a foreign table from FDW options of objects which are related to the foreign table.</font></p><h3><font size="1"  >Connection options</font></h3><p><font size="1"  >All libpq options except following can be used as connection opions. Only "user" and "password" are fore user mappings, and others are for foreign servers.</font></p><ul><li><font size="1"  >client_encoding</font></li><li><font size="1"  >fallback_application_name</font></li><li><font size="1"  >replication</font></li></ul><p><font size="1"  >See&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/libpq-connect.html"  >Database Connection Control Functions</a>&nbsp;for details of libpq options. Note that omitted options are taken from environment variables of the user who started PostgreSQL server. Invalid options would be caught at once, but omission of required parameters and wrong values will be found when query was executed actually.</font></p><h3><font size="1"  >Object name optionsl</font></h3><p><font size="1"  >You can specify name and/or schema of external table as FDW options of a foreign table, "relname" and "nspname". They default to foreign table's name ans schema respectively.</font></p><h3><font size="1"  >Cursor option</font></h3><p><font size="1"  >With a FDW option "fetch_count", you can control the behavior of cursor used internally. It is used as number of rows fetched from external server at a time, and defualt to 10000. This option can be specified to foreign table and/or foreign server. If both of them has value, foreign table's setting is used.</font></p><h2 id="restrictions"  ><font size="1"  >Restrictions</font></h2><p><font size="1"  >There are some restrictions to use pgsql_fdw.</font></p><dl><dt><font size="1"  >Foreign tables are read-only</font></dt><dd><font size="1"  >Foreign tables are read-only for specification of PostgreSQL, so DMLs other than SELECT fail with error. In addition, VACUUM and ANALYZE don't handle foreign tables. Please connect external server directly to execute this kind of commands to external tables.</font></dd><dt><font size="1"  >Management of connection and transaction</font></dt><dd><font size="1"  >A connection is shared between scans which access same foreign server even those scans are in a local query, and pgsql_fdw starts a transaction only at the beginning of a connection. As a result, multiple scans in a local query might have inconsistent result from the viewpoint of transaction.</font></dd></dl><h2 id="details"  ><font size="1"  >Details</font></h2><p><font size="1"  >This section describes advanced usage and internal details.</font></p><h3 id="connection-option"  ><font size="1"  >Internal use of libpq options</font></h3><p><font size="1"  >Some of libpq options are used internally. "client_encoding" is set to local encoding to retrieve external data properly. "fallback_application_name" is set to "pgsql_fdw" to allow remote DBAs to know originator of connections via pg_stat_activity and server log.</font></p><h3 id="functions"  ><font size="1"  >Functions</font></h3><p><font size="1"  >This extension provides pgsql_fdw_validator as a valiidator, and pgsql_fdw_handler as a handler. These are created automatically during CREATE EXTENSION statement.</font></p><h2 id="seealso"  ><font size="1"  >See also</font></h2><h3 id="postgresql_document"  ><font size="1"  >PostgreSQL Documents</font></h3><font size="1"  ><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/ddl-foreign-data.html"  >Foreign Data</a>,&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/sql-createforeigndatawrapper.html"  >CREATE FOREIGN DATA WRAPPER</a>,&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/sql-createserver.html"  >CREATE SERVER</a>,&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/sql-createusermapping.html"  >CREATE USER MAPPING</a>,&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/sql-createforeigntable.html"  >CREATE FOREIGN TABLE</a>,&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/libpq-connect.html"  >Database Connection Control Functions</a>,</font><hr><div><font size="1"  ><a rel="nofollow" href="file:///C:/Users/Digoal/index-en.html"  >Top</a>&nbsp;&gt;&nbsp;<a rel="nofollow" href="file:///C:/Users/Digoal/Desktop/pgsql_fdw-en.html"  >pgsql_fdw</a></font></div></div></div><font size="1"  ><wbr></font></div>
	</div>
</div>
</body>
</html>