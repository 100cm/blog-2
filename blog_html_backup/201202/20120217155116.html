<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL Data merge case</h2>
	<h5 id="">2012-02-17 15:51:16&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201211714942191/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">打个比方，有两个游戏区要合并。<div>单个游戏区的用户ID可以有多个角色，角色名不能重复。</div><div>当需要合并游戏区时，可能会涉及到同一个ID的不同区使用的相同的角色。</div><div>PostgreSQL没有merge的SQL语法, 当然Oracle用MERGE也无法在一条SQL中实现这个需求.</div><div>举个例子 :&nbsp;</div><div>user_info1 表代表1区的用户表。</div><div><pre class="prettyprint"  ><p></p><div>digoal=&gt; create table user_info1 (userid int,nick text,info text,unique (userid,nick));</div><div>NOTICE: &nbsp;CREATE TABLE / UNIQUE will create implicit index "user_info1_userid_nick_key" for table "user_info1"</div><div>CREATE TABLE</div><p></p></pre></div><div>user_info2 表代表2区的用户表</div><div><pre class="prettyprint"  ><p></p><div>digoal=&gt; create table user_info2 (userid int,nick text,info text,unique (userid,nick));</div><div>NOTICE: &nbsp;CREATE TABLE / UNIQUE will create implicit index "user_info2_userid_nick_key" for table "user_info2"</div><div>CREATE TABLE</div><p></p></pre></div><div><br></div><div>创建测试数据, 1区和2区在userid=1到100范围内nick相同, 因此合并2个区的用户数据时, 这部分nick需要修改一下. 假如改成nick||'_2'</div><div><pre class="prettyprint"  ><p></p><div>digoal=&gt; insert into user_info1 select generate_series(1,100),'digoal'||generate_series(1,100),'user_info1';</div><div>INSERT 0 100</div><div>digoal=&gt; insert into user_info2 select generate_series(1,200),'digoal'||generate_series(1,200),'user_info2';</div><div>INSERT 0 200</div><div>digoal=&gt; insert into user_info1 select generate_series(201,300),'digoal'||generate_series(201,300),'user_info1';</div><div>INSERT 0 100</div><p></p></pre></div><div><br></div><div>创建nick获取函数 :</div><div><pre class="prettyprint"  ><p></p><div>CREATE OR REPLACE FUNCTION digoal.get_nick(i_userid int,i_nick text)</div><div>&nbsp;RETURNS text</div><div>&nbsp;LANGUAGE plpgsql</div><div>AS $function$</div><div>declare</div><div>begin</div><div>perform 1 from user_info1 where userid=i_userid and nick=i_nick;</div><div>if found then&nbsp;</div><div>return i_nick||'_2';</div><div>end if;</div><div>return i_nick;</div><div>end;</div><div>$function$</div><p></p></pre></div><div><br></div><div>合并2区的表到1区</div><div><pre class="prettyprint"  ><p></p><div>digoal=&gt; insert into user_info1 select userid,get_nick(userid,nick),info from user_info2;</div><div>INSERT 0 200</div><p></p></pre></div><div><br><wbr></div><div>合并后, 查看重叠部分的数据, 2区的nick已经加上了_2.</div><div><pre class="prettyprint"  ><p></p><div>digoal=&gt; select * from user_info1 where userid=1;</div><div>&nbsp;userid | &nbsp; nick &nbsp; &nbsp;| &nbsp; &nbsp;info &nbsp; &nbsp;</div><div>--------+-----------+------------</div><div>&nbsp; &nbsp; &nbsp; 1 | digoal1 &nbsp; | user_info1</div><div>&nbsp; &nbsp; &nbsp; 1 | digoal1_2 | user_info2</div><div>(2 rows)</div><p></p></pre></div>非重叠数据正常插入 :&nbsp;<div><pre class="prettyprint"  ><p></p><div>digoal=&gt; select * from user_info1 where userid=200;</div><div>&nbsp;userid | &nbsp; nick &nbsp; &nbsp;| &nbsp; &nbsp;info &nbsp; &nbsp;</div><div>--------+-----------+------------</div><div>&nbsp; &nbsp; 200 | digoal200 | user_info2</div><div>(1 row)</div><p></p></pre></div>另一个例子 :&nbsp;<div><pre class="prettyprint"  ><p></p><div>digoal=&gt; create table t1 (id int,name text unique);</div><div>NOTICE: &nbsp;CREATE TABLE / UNIQUE will create implicit index "t1_name_key" for table "t1"</div><div>CREATE TABLE</div><div>digoal=&gt; create table t2 (id int,name text unique);</div><div>NOTICE: &nbsp;CREATE TABLE / UNIQUE will create implicit index "t2_name_key" for table "t2"</div><div>CREATE TABLE</div><div><div>digoal=&gt; insert into t1 values(1,'digoal');</div><div>INSERT 0 1</div><div>digoal=&gt; insert into t1 values(2,'digoal1');</div><div>INSERT 0 1</div><div>digoal=&gt; insert into t1 values(3,'digoal11');</div><div>INSERT 0 1</div><div>digoal=&gt; insert into t1 values(4,'digoal111');</div><div>INSERT 0 1</div><div>digoal=&gt; insert into t1 values(5,'digoal1111');</div><div>INSERT 0 1</div><div>digoal=&gt; insert into t1 values(6,'digoal11111');</div><div>INSERT 0 1</div><div>digoal=&gt; insert into t2 values(1,'digoal');</div></div><p></p></pre></div><div><br></div><div>把t2的数据合并到t1 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div>create or replace function get_name(i_name text) returns text as $$</div><div>declare</div><div>v_name text;</div><div>v_suffix text;</div><div>begin</div><div>v_suffix = '1';</div><div>perform 1 from t1 where name = i_name limit 1;</div><div>if not found then</div><div>&nbsp;return i_name;</div><div>else</div><div>&nbsp;loop</div><div>&nbsp; perform 1 from t1 where name = i_name||v_suffix limit 1;</div><div>&nbsp; if not found then</div><div>&nbsp; &nbsp;exit;</div><div>&nbsp; else</div><div>&nbsp; &nbsp;v_suffix=v_suffix||'1';</div><div>&nbsp; end if;</div><div>&nbsp;end loop;</div><div>end if;</div><div>return i_name||v_suffix;</div><div>end;</div><div>$$ language plpgsql;</div></div><div><div>digoal=&gt; insert into t1 select id,get_name(name) from t2;</div><div>INSERT 0 1</div><div><br></div><div>digoal=&gt; select * from t1;</div><div>&nbsp;id | &nbsp; &nbsp; name &nbsp; &nbsp;&nbsp;</div><div>----+--------------</div><div>&nbsp; 1 | digoal</div><div>&nbsp; 2 | digoal1</div><div>&nbsp; 3 | digoal11</div><div>&nbsp; 4 | digoal111</div><div>&nbsp; 5 | digoal1111</div><div>&nbsp; 6 | digoal11111</div><div>&nbsp; 1 | digoal111111</div></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>