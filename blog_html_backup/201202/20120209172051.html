<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Implement Postgres-XC 0.9.7 with 8 servers</h2>
	<h5 id="">2012-02-09 17:20:51&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020121952051174/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>Postgres-XC 于1月份发布了0.9.7版本, 基于PostgreSQL9.1.2版本修改而来. 手册目前还很不完整.&nbsp;</div><div>Postgres-XC 主要的组件有gtm, gtm_standby, gtm_proxy, coordinator, datanode.</div><div>gtm 为分配GXID和管理PGXC MVCC的模块, 在一个CLUSTER中只能有一台主的gtm, gtm也将成为整个CLUSTER的瓶颈已经单点故障点.</div><div>gtm_standby 为gtm的备机.</div><div>gtm_proxy 为降低gtm压力而诞生的, 用于对coordinator节点提交的任务进行分组等操作. 机器中可以存在多个gtm_proxy.</div><div>coordinator 为管理全局的catalog信息和与应用程序交互的节点, 也是一个PostgreSQL数据库. 集群中可以存在多个coordinator.</div><div>datanode 也是一个PostgreSQL数据库, 用于存放大量的应用数据.</div><div><br></div><div>以下是一个简单的测试.&nbsp;</div><div># 测试环境</div><div># 主机, 模块</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >host_datanode_1 datanode_1</font></div><div><font size="2"   >host_datanode_2 datanode_2</font></div><div><font size="2"   >host_datanode_3 datanode_3</font></div><div><font size="2"   >host_coordinator_3 gtm-proxy, coordinator_3</font></div><div><font size="2"   >host_coordinator_2 gtm-proxy, coordinator_2</font></div><div><font size="2"   >host_coordinator_1 gtm-proxy, coordinator_1</font></div><div><font size="2"   >host_gtm-standby gtm-standby</font></div><div><font size="2"   >host_gtm gtm</font></div><p></p></pre></div><div><br></div><div># 端口</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >gtm, gtm-standby 4191</font></div><div><font size="2"   >gtm-proxy 4192</font></div><div><font size="2"   >coordinator, datanode 4193</font></div><div><font size="2"   >coordinator_pooler_manager_port 4194</font></div><p></p></pre></div><div><br></div><div># 数据目录</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >gtm /pgxc_gtm/work</font></div><div><font size="2"   >gtm-standby /pgxc_gtm/work</font></div><div><font size="2"   >gtm-proxy /pgxc_gtm_proxy/work</font></div><div><font size="2"   >coordinator /pgxcdata/data01/pg_root</font></div><div><font size="2"   >datanode /pgxcdata/data01/pg_root</font></div><p></p></pre></div><div><br></div><div># 配置主机名, 不配置的话请使用DSN, 否则互联互通会有问题.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/etc/hosts</font></div><div><font size="2"   >10.10.1.212 db-host_gtm.sky-mobi.com db-host_gtm</font></div><div><font size="2"   >10.10.1.89 db-host_gtm-standby.sky-mobi.com db-host_gtm-standby</font></div><div><font size="2"   >10.10.1.63 db-host_coordinator_1.sky-mobi.com db-host_coordinator_1</font></div><div><font size="2"   >10.10.1.55 db-host_coordinator_2.sky-mobi.com db-host_coordinator_2</font></div><div><font size="2"   >10.10.1.236 db-host_coordinator_3.sky-mobi.com db-host_coordinator_3</font></div><div><font size="2"   >10.10.1.235 db-host_datanode_3.sky-mobi.com db-host_datanode_3</font></div><div><font size="2"   >10.10.1.227 db-host_datanode_2.sky-mobi.com db-host_datanode_2</font></div><div><font size="2"   >10.10.1.207 db-host_datanode_1.sky-mobi.com db-host_datanode_1</font></div><p></p></pre></div><div><br></div><div># 安装, 与安装PostgreSQL的前提一致, 如也需要flex, bison等</div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >useradd pgxc</font></div><div><font size="2"   >tar -zxvf pgxc_v0.9.7.tar.gz</font></div><div><font size="2"   >chown -R pgxc:pgxc pgxc</font></div><div><font size="2"   >su - pgxc</font></div><div><font size="2"   >vi .bash_profile</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >export PS1="$USER@`/bin/hostname -s`-&gt; "</font></div><div><font size="2"   >export PGPORT=4193</font></div><div><font size="2"   >export PGDATA=/pgxcdata/data01/pg_root</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/opt/pgxc0.9.7</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"   >alias rm='rm -i'</font></div><div><font size="2"   >alias ll='ls -lh'</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >cd pgxc</font></div><div><font size="2"   >./configure --prefix=/opt/pgxc0.9.7 --with-pgport=4193 --with-perl --with-python --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety &amp;&amp; gmake</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >su - root</font></div><div><font size="2"   >cd pgxc</font></div><div><font size="2"   >gmake install</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >mkdir $PGHOME/share/man</font></div><div><font size="2"   >cp -r /opt/soft_bak/pgxc/doc-xc/src/sgml/man1 $PGHOME/share/man</font></div><div><font size="2"   >cp -r /opt/soft_bak/pgxc/doc-xc/src/sgml/man3 $PGHOME/share/man</font></div><div><font size="2"   >cp -r /opt/soft_bak/pgxc/doc-xc/src/sgml/man7 $PGHOME/share/man</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >su - pgxc</font></div><div><font size="2"   >psql -V</font></div><div><font size="2"   >psql (PostgreSQL) 9.1.2</font></div><div><font size="2"   >contains support for command-line editing</font></div><p></p></pre></div><div><br></div><div># 配置gtm, 建议gtm为独占主机</div><div># 配置文件必须放在工作目录, 所有GTM ID必须唯一, 从1开始, 所以gtm=1,gtm_standby=2.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >mkdir -p /pgxc_gtm/work</font></div><div><font size="2"   >cp /opt/pgxc0.9.7/share/postgresql/gtm.conf.sample /pgxc_gtm/work/gtm.conf</font></div><div><font size="2"   >chown -R pgxc:pgxc /pgxc_gtm</font></div><div><font size="2"   >vi /pgxc_gtm/work/gtm.conf</font></div><div><font size="2"   >nodename = '1'</font></div><div><font size="2"   >listen_addresses = '0.0.0.0'</font></div><div><font size="2"   >port = 4191</font></div><div><font size="2"   >startup = ACT</font></div><div><font size="2"   >log_file = 'gtm.log'</font></div><div><font size="2"   >log_min_messages = NOTICE</font></div><p></p></pre></div><div>启动gtm</div><div><pre class="prettyprint"   ><p>gtm_ctl start -S gtm -D /pgxc_gtm/work -l /pgxc_gtm/work/gtm_ctl.log</p></pre></div><div># 查看启动状态</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >gtm_ctl status -S gtm -D /pgxc_gtm/work</font></div><div><font size="2"   >pid: 2219</font></div><div><font size="2"   >data: /pgxc_gtm/work</font></div><div><font size="2"   >active: 1</font></div><p></p></pre></div><div><br></div><div>配置gtm standby</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >mkdir -p /pgxc_gtm/work</font></div><div><font size="2"   >cp /opt/pgxc0.9.7/share/postgresql/gtm.conf.sample /pgxc_gtm/work/gtm.conf</font></div><div><font size="2"   >chown -R pgxc:pgxc /pgxc_gtm</font></div><div><font size="2"   >vi /pgxc_gtm/work/gtm.conf</font></div><div><font size="2"   >nodename = '2'</font></div><div><font size="2"   >listen_addresses = '0.0.0.0'</font></div><div><font size="2"   >port = 4191</font></div><div><font size="2"   >startup = STANDBY</font></div><div><font size="2"   >active_host = 'db-host_gtm'</font></div><div><font size="2"   >active_port = 4191</font></div><div><font size="2"   >keepalives_idle = 60</font></div><div><font size="2"   >keepalives_interval = 10</font></div><div><font size="2"   >keepalives_count = 10</font></div><div><font size="2"   >log_file = 'gtm.log'</font></div><div><font size="2"   >log_min_messages = NOTICE</font></div><p></p></pre></div><div>启动gtm standby</div><div><pre class="prettyprint"   ><p>gtm_ctl start -S gtm -D /pgxc_gtm/work -l /pgxc_gtm/work/gtm_ctl.log</p></pre></div><div># 查看状态</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >gtm_ctl status -S gtm -D /pgxc_gtm/work</font></div><div><font size="2"   >pid: 30694</font></div><div><font size="2"   >data: /pgxc_gtm/work</font></div><div><font size="2"   >active: 0</font></div><p></p></pre></div><div><br></div><div># 配置gtm proxy, 所有GTM-Proxy ID必须唯一, 从1开始,</div><div># 建议每个coordinator配置一个gtm_proxy, 并将gtm_proxy和coordinator放在一台主机上</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >mkdir -p /pgxc_gtm_proxy/work</font></div><div><font size="2"   >cp /opt/pgxc0.9.7/share/postgresql/gtm_proxy.conf.sample /pgxc_gtm_proxy/work/gtm_proxy.conf</font></div><div><font size="2"   >chown -R pgxc:pgxc /pgxc_gtm_proxy</font></div><div><font size="2"   >vi /pgxc_gtm_proxy/work/gtm_proxy.conf</font></div><div><font size="2"   >nodename = '1'</font></div><div><font size="2"   >listen_addresses = '0.0.0.0'</font></div><div><font size="2"   >port = 4192</font></div><div><font size="2"   >worker_threads = 2</font></div><div><font size="2"   >gtm_host = 'db-host_gtm'</font></div><div><font size="2"   >gtm_port = 4191</font></div><div><font size="2"   >keepalives_idle = 60</font></div><div><font size="2"   >keepalives_interval = 10</font></div><div><font size="2"   >keepalives_count = 10</font></div><div><font size="2"   >log_file = 'gtm_proxy.log'</font></div><div><font size="2"   >log_min_messages = NOTICE</font></div><p></p></pre></div><div>启动gtm proxy</div><div><pre class="prettyprint"   ><p>gtm_ctl start -S gtm_proxy -D /pgxc_gtm_proxy/work -l /pgxc_gtm_proxy/work/gtm_ctl.log</p></pre></div><div># 查看状态</div><div><pre class="prettyprint"   ><p>ps -ewf|grep gtm_proxy</p></pre></div><div><br></div><div># 建议datanode和coordinate的数量相同,但是datanode和coordinate不要跑在同一台主机上,因为创建表空间时datanode和coordinate使用相同的目录.</div><div># 配置datanode, 初始化3台datanode</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >initdb --nodename datanode_1 -D /pgxcdata/data01/pg_root -E UTF8 --locale=C -W -A md5</font></div><div><font size="2"   >initdb --nodename datanode_2 -D /pgxcdata/data01/pg_root -E UTF8 --locale=C -W -A md5</font></div><div><font size="2"   >initdb --nodename datanode_3 -D /pgxcdata/data01/pg_root -E UTF8 --locale=C -W -A md5</font></div><p></p></pre></div><div># 其中datanode_1节点的postgresql.conf配置</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"   >port = 4193 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >max_connections = 2000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart) # 大于或等于所有coordinator配置的max_pool_size的总和</font></div><div><font size="2"   >superuser_reserved_connections = 13 &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >password_encryption = on</font></div><div><font size="2"   >tcp_keepalives_idle = 60 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPIDLE, in seconds;</font></div><div><font size="2"   >tcp_keepalives_interval = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPINTVL, in seconds;</font></div><div><font size="2"   >tcp_keepalives_count = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # TCP_KEEPCNT;</font></div><div><font size="2"   >shared_buffers = 1024MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div><font size="2"   >max_prepared_transactions = 2000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# zero disables the feature</font></div><div><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div><font size="2"   >max_stack_depth = 8MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 100kB</font></div><div><font size="2"   >vacuum_cost_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 0-100 milliseconds</font></div><div><font size="2"   >vacuum_cost_limit = 500 &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 credits</font></div><div><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level; on, off, or local</font></div><div><font size="2"   >wal_sync_method = fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # the default is the first option</font></div><div><font size="2"   >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"   >checkpoint_segments = 128 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # in logfile segments, min 1, 16MB each</font></div><div><font size="2"   >checkpoint_timeout = 15min &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# range 30s-1h</font></div><div><font size="2"   >random_page_cost = 2.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# same scale as above</font></div><div><font size="2"   >effective_cache_size = 20480MB</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_directory = '/var/applog/pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,</font></div><div><font size="2"   >log_file_mode = 0600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# creation mode for log files,</font></div><div><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div><font size="2"   >log_rotation_age = 1d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Automatic rotation of logfiles will</font></div><div><font size="2"   >log_rotation_size = 10MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Automatic rotation of logfiles will</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >autovacuum = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Enable autovacuum subprocess? &nbsp;'on'</font></div><div><font size="2"   >log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><div><font size="2"   >gtm_host = '</font><span style="font-size: small; line-height: 21px;"   >db-host_coordinator_1</span><font size="2"   >' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Host name or address of GTM, 对应本地gtm proxy , 请自行修改主机名字</font></div><div><font size="2"   >gtm_port = 4192 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Port of GTM</font></div><div><font size="2"   >pgxc_node_name = 'datanode_1' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Coordinator or Datanode name</font></div><div><font size="2"   >strict_statement_checking = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Forbid PG-XC-unsafe SQL</font></div><p></p></pre></div><div># 所有节点的pg_hba.conf配置,允许coordinator和datanode节点trust访问</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >host all all 10.10.1.63/32 trust</font></div><div><font size="2"   >host all all 10.10.1.55/32 trust</font></div><div><font size="2"   >host all all 10.10.1.236/32 trust</font></div><div><font size="2"   >host all all 10.10.1.235/32 trust</font></div><div><font size="2"   >host all all 10.10.1.227/32 trust</font></div><div><font size="2"   >host all all 10.10.1.207/32 trust</font></div><div><font size="2"   >host all all 0.0.0.0/0 md5</font></div><p></p></pre></div><div># 启动</div><div><pre class="prettyprint"   ><p><font size="2"   >pg_ctl start -D /pgxcdata/data01/pg_root -Z datanode</font></p></pre></div><div><br></div><div><br></div><div>配置coordinate</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >initdb --nodename coordinator_1 -D /pgxcdata/data01/pg_root -E UTF8 --locale=C -W -A md5</font></div><div><font size="2"   >initdb --nodename coordinator_2 -D /pgxcdata/data01/pg_root -E UTF8 --locale=C -W -A md5</font></div><div><font size="2"   >initdb --nodename coordinator_3 -D /pgxcdata/data01/pg_root -E UTF8 --locale=C -W -A md5</font></div><p></p></pre></div><div># 其中coordinator_1节点的postgresql.conf配置</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"   >port = 4193 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >max_connections = 1000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart) &nbsp;# 指应用最多可以与coordinator建立多少个连接</font></div><div><font size="2"   >superuser_reserved_connections = 13 &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >password_encryption = on</font></div><div><font size="2"   >tcp_keepalives_idle = 60 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPIDLE, in seconds;</font></div><div><font size="2"   >tcp_keepalives_interval = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPINTVL, in seconds;</font></div><div><font size="2"   >tcp_keepalives_count = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # TCP_KEEPCNT;</font></div><div><font size="2"   >shared_buffers = 1024MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div><font size="2"   >max_prepared_transactions = 1000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# zero disables the feature</font></div><div><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div><font size="2"   >max_stack_depth = 8MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 100kB</font></div><div><font size="2"   >vacuum_cost_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 0-100 milliseconds</font></div><div><font size="2"   >vacuum_cost_limit = 500 &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 credits</font></div><div><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level; on, off, or local</font></div><div><font size="2"   >wal_sync_method = fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # the default is the first option</font></div><div><font size="2"   >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"   >checkpoint_segments = 128 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # in logfile segments, min 1, 16MB each</font></div><div><font size="2"   >checkpoint_timeout = 15min &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# range 30s-1h</font></div><div><font size="2"   >random_page_cost = 2.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# same scale as above</font></div><div><font size="2"   >effective_cache_size = 20480MB</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_directory = '/var/applog/pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,</font></div><div><font size="2"   >log_file_mode = 0600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# creation mode for log files,</font></div><div><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div><font size="2"   >log_rotation_age = 1d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Automatic rotation of logfiles will</font></div><div><font size="2"   >log_rotation_size = 10MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Automatic rotation of logfiles will</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >autovacuum = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Enable autovacuum subprocess? &nbsp;'on'</font></div><div><font size="2"   >log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><div><font size="2"   >gtm_host = '</font><span style="font-size: small; line-height: 21px; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, 宋体;"   >db-host_coordinator_1</span><span style="line-height: 21px; font-size: small; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, 宋体;"   >' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Host name or address of GTM # 对应本地gtm proxy, 请自行修改名字</span></div><div><font size="2"   >gtm_port = 4192 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Port of GTM</font></div><div><font size="2"   >pooler_port = 4194 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Pool Manager TCP port</font></div><div><font size="2"   >min_pool_size = 1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Initial pool size &nbsp;# 指coordinator和datanode建立的连接</font></div><div><font size="2"   >max_pool_size = 100 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Maximum pool size &nbsp;# 指coordinator和datanode建立的连接</font></div><div><font size="2"   >persistent_datanode_connections = on &nbsp; # Set persistent connection mode for pooler</font></div><div><font size="2"   >pgxc_node_name = 'coordinator_1' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Coordinator or Datanode name</font></div><div><font size="2"   >strict_statement_checking = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Forbid PG-XC-unsafe SQL</font></div><p></p></pre></div><div># 所有节点的pg_hba.conf配置,允许coordinator和datanode节点trust访问</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >host all all 10.10.1.63/32 trust</font></div><div><font size="2"   >host all all 10.10.1.55/32 trust</font></div><div><font size="2"   >host all all 10.10.1.236/32 trust</font></div><div><font size="2"   >host all all 10.10.1.235/32 trust</font></div><div><font size="2"   >host all all 10.10.1.227/32 trust</font></div><div><font size="2"   >host all all 10.10.1.207/32 trust</font></div><div><font size="2"   >host all all 0.0.0.0/0 md5</font></div><p></p></pre></div><div># 启动</div><div><pre class="prettyprint"   ><p>pg_ctl start -D /pgxcdata/data01/pg_root -Z coordinator</p></pre></div><div><br></div><div># 配置node信息, 在所有coordinator执行</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >psql -d template1 -U pgxc</font></div><div><font size="2"   >drop node coordinator_1;</font></div><div><font size="2"   >drop node coordinator_2;</font></div><div><font size="2"   >drop node coordinator_3;</font></div><div><font size="2"   >drop node datanode_1;</font></div><div><font size="2"   >drop node datanode_2;</font></div><div><font size="2"   >drop node datanode_3;</font></div><div><font size="2"   >create node coordinator_1 with (type='coordinator', host='db-host_coordinator_1', port=4193);</font></div><div><font size="2"   >create node coordinator_2 with (type='coordinator', host='db-host_coordinator_2', port=4193);</font></div><div><font size="2"   >create node coordinator_3 with (type='coordinator', host='db-host_coordinator_3', port=4193);</font></div><div><font size="2"   >create node datanode_1 with (type='datanode', host='db-host_datanode_1', port=4193, PRIMARY, PREFERRED);</font></div><div><font size="2"   >create node datanode_2 with (type='datanode', host='db-host_datanode_2', port=4193, PREFERRED);</font></div><div><font size="2"   >create node datanode_3 with (type='datanode', host='db-host_datanode_3', port=4193, PREFERRED);</font></div><div><font size="2"   >alter node coordinator_1 with (host='db-host_coordinator_1', port=4193);</font></div><div><font size="2"   >alter node coordinator_2 with (host='db-host_coordinator_2', port=4193);</font></div><div><font size="2"   >alter node coordinator_3 with (host='db-host_coordinator_3', port=4193);</font></div><div><font size="2"   >alter node datanode_1 with (type='datanode', host='db-host_datanode_1', port=4193, PRIMARY, PREFERRED);</font></div><div><font size="2"   >alter node datanode_2 with (type='datanode', host='db-host_datanode_2', port=4193, PREFERRED);</font></div><div><font size="2"   >alter node datanode_3 with (type='datanode', host='db-host_datanode_3', port=4193, PREFERRED);</font></div><p></p></pre></div><div><br></div><div># 建库测试, 断开所有coordinator的template1库的连接, 连接到任意一台coordinator, 创建digoal库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create database digoal;</font></div><div><font size="2"   >\c digoal digoal</font></div><div><font size="2"   >digoal=# create table user_info_hash(id int primary key,firstname text,lastname text,info text) distribute by hash(id) to node datanode_1,datanode_2,datanode_3;</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "user_info_hash_pkey" for table "user_info_hash"</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# create table user_info_modulo(id int primary key,firstname text,lastname text,info text) distribute by modulo(id) to node datanode_1,datanode_2,datanode_3;</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "user_info_modulo_pkey" for table "user_info_modulo"</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# create table user_info_rr(id int,firstname text,lastname text,info text) distribute by round robin to node datanode_1,datanode_2,datanode_3;</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# create table user_info_replica(id int primary key,firstname text,lastname text,info text) distribute by replication to node datanode_1,datanode_2,datanode_3;</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "user_info_replica_pkey" for table "user_info_replica"</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div><br></div><div># 插入数据测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into user_info_hash select generate_series(1,10000),'zhou','digoal','DBA';</font></div><div><font size="2"   >INSERT 0 10000</font></div><div><font size="2"   >Time: 5260.994 ms</font></div><div><font size="2"   >digoal=# insert into user_info_modulo select generate_series(1,10000),'zhou','digoal','DBA';</font></div><div><font size="2"   >INSERT 0 10000</font></div><div><font size="2"   >Time: 5305.979 ms</font></div><div><font size="2"   >digoal=# insert into user_info_rr select generate_series(1,10000),'zhou','digoal','DBA';</font></div><div><font size="2"   >INSERT 0 10000</font></div><div><font size="2"   >Time: 5124.162 ms</font></div><div><font size="2"   >digoal=# insert into user_info_replica select generate_series(1,10000),'zhou','digoal','DBA';</font></div><p></p></pre></div><div><br></div><div># 其中user_info_hash, user_info_modulo, user_info_rr表的数据分布在3个datanode中, 3个datanode合起来是1W条。</div><div># 而user_info_replica的数据在3个datanode中每个节点一样, 都有1W条。</div><div><br></div><div># Postgres-XC 相比PostgreSQL新增的catalog</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;pg_catalog | pgxc_class &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| table | pgxc</font></div><div><font size="2"   >&nbsp;pg_catalog | pgxc_group &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| table | pgxc</font></div><div><font size="2"   >&nbsp;pg_catalog | pgxc_node &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | table | pgxc</font></div><div><font size="2"   >&nbsp;pg_catalog | pgxc_prepared_xacts &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | view &nbsp;| pgxc</font></div><p></p></pre></div><div><br></div><div>例如可以通过pgxc_class在coordinator节点查询到pgxc创建的对象信息.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pgxc_class;</font></div><div><font size="2"   >&nbsp;pcrelid | pclocatortype | pcattnum | pchashalgorithm | pchashbuckets | &nbsp; &nbsp; nodeoids &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------+---------------+----------+-----------------+---------------+-------------------</font></div><div><font size="2"   >&nbsp; &nbsp;16422 | H &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4096 | 16405 16406 16407</font></div><div></div><p></p></pre></div><div>通过pg_node查询节点信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pgxc_node;</font></div><div><font size="2"   >&nbsp; &nbsp;node_name &nbsp; | node_type | node_port | &nbsp; &nbsp; node_host &nbsp; &nbsp; &nbsp;| nodeis_primary | nodeis_preferred&nbsp;</font></div><div><font size="2"   >---------------+-----------+-----------+--------------------+----------------+------------------</font></div><div><font size="2"   >&nbsp;coordinator_1 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;4193 | host_coordinator_1 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f</font></div><div><font size="2"   >&nbsp;datanode_1 &nbsp; &nbsp;| D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;4193 | host_datanode_1 &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t</font></div><div><font size="2"   >&nbsp;datanode_2 &nbsp; &nbsp;| D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;4193 | host_datanode_2 &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t</font></div><div><font size="2"   >&nbsp;datanode_3 &nbsp; &nbsp;| D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;4193 | host_datanode_3 &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t</font></div><div><font size="2"   >&nbsp;coordinator_2 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;4193 | host_coordinator_2 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f</font></div><div><font size="2"   >&nbsp;coordinator_3 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;4193 | host_coordinator_3 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f</font></div><p></p></pre></div><div><br></div><div># Postgres-XC 相比PostgreSQL新增的语法</div><div>alter node 修改node信息</div><div>create barrier 用于创建PGXC全局一致性备份的关键命令.</div><div>create node 创建node</div><div>create node group 创建node分组</div><div>drop node 删除node</div><div>drop node group 删除node分组</div><div><br></div><div>【小结】</div><div>1. 目前Postgres-XC还不太成熟, 操作性不好, 维护麻烦.</div><div>2. create barrier . 这个对于一个分布式数据库来说可以说是非常重要的, 全局一致的备份和还原对于企业级应用来说是特别需要考虑的. 相信PGXC未来会得到企业的认可.</div><div><br></div><div>【参考】</div><div>http://postgres-xc.sourceforge.net/</div><div>http://postgres-xc.sourceforge.net/docs/0_9_7/</div><div>手册 : Overview of Postgres-XC Internals</div><div><br></div><div>【其他】</div><div># 安装时的报错</div><div>1. gmake world 报错</div><div>/bin/collateindex.pl 不存在</div><div>下载collateindex.pl到指定目录后</div><div>gmake install-world 报错</div><div>'/usr/bin/perl' /bin/collateindex.pl -f -g -i 'bookindex' -o bookindex.sgml HTML.index</div><div>collateindex.pl: file "HTML.index" does not exist</div><wbr></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">路人甲 - 2014-05-29 23:52:18</h5>
				<div><span style=""  >collateindex.pl 这个在哪里下载呀? 搜不到!!!</span><img src="http://b.bst.126.net/common/portrait/face/preview/face8.gif"  ></div>
			</div>
	</div>
</div>
</body>
</html>