<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Use PostgreSQL collect and analyze Operation System statistics</h2>
	<h5 id="">2012-02-14 8:28:46&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201211354145701/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">当你管理的服务器越来越多的时候, 哪个服务器才是你最需要关注的?<div>通过各个监控维度的排行, 可以知道你到底需要关注或者优先关注哪些服务器.</div><div><div>这个通过nagios,cacti等监控软件当然是可以做到的.<br>不过不太灵活, 因为服务器的配置各不一样, 关注的维度也不一样, PostgreSQL数据库的递归调用和窗口函数可以很好的运用来输出各种各样的统计数据, 有了数据也就利于展现了。</div></div><div>本文测试环境 :&nbsp;</div><div>OS : RHEL5</div><div>DB : PostgreSQL 9.1.2</div><div>假设我这里有1000台跑了mongoDB, PostgreSQL, Oracle, MySQL等数据库的服务器需要将它们的SAR报告集中到一台PostgreSQL数据库中.</div><div>集中之后对报告进行分析, 找出需要关注的服务器来.&nbsp;</div><div>一、首先看看我们要收集什么信息 :&nbsp;</div><div>我这里举了一个简单的例子, 收集前一天sar的统计报告. 如下 :&nbsp;</div><div>1. sar -b</div><div>反映系统的每秒读写IO请求等, 详情</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;-b &nbsp; &nbsp; Report I/O and transfer rate statistics. &nbsp;The following values are displayed:</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tps</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Total number of transfers per second that were issued to physical devices. &nbsp;A transfer is an &nbsp;I/O</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;request to a physical device. Multiple logical requests can be combined into a single I/O request</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;to the device. &nbsp;A transfer is of indeterminate size.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rtps</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Total number of read requests per second issued to physical devices.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wtps</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Total number of write requests per second issued to physical devices.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bread/s</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Total amount of data read from the devices in blocks per second. &nbsp;Blocks are equivalent &nbsp;to &nbsp;sec-</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tors &nbsp;with &nbsp;2.4 &nbsp;kernels &nbsp;and newer and therefore have a size of 512 bytes. With older kernels, a</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;block is of indeterminate size.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bwrtn/s</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Total amount of data written to devices in blocks per second.</font></div><p></p></pre></div></div><div>2. sar -B</div><div>反映每秒系统写入或从磁盘读出的page数, 详情</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;-B &nbsp; &nbsp; Report paging statistics. The following values are displayed:</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgpgin/s</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Total number of kilobytes the system paged in from disk &nbsp;per &nbsp;second. &nbsp; Note: &nbsp;With &nbsp;old &nbsp;kernels</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(2.2.x) this value is a number of blocks per second (and not kilobytes).</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgpgout/s</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Total &nbsp;number &nbsp;of &nbsp;kilobytes &nbsp;the &nbsp;system &nbsp;paged &nbsp;out to disk per second. &nbsp;Note: With old kernels</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(2.2.x) this value is a number of blocks per second (and not kilobytes).</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fault/s</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Number of page faults (major + minor) made by the system per &nbsp;second &nbsp;(post &nbsp;2.5 &nbsp;kernels &nbsp;only).</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;This &nbsp;is &nbsp;not &nbsp;a count of page faults that generate I/O, because some page faults can be resolved</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;without I/O.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; majflt/s</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Number of major faults the system has made per second, those which have required loading a memory</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;page from disk (post 2.5 kernels only).</font></div><p></p></pre></div></div><div>3. sar -c</div><div>反映系统每秒创建的进程数, 如果这个数字很大可能是应用程序连接数据库是短连接, 并且请求数据库频繁, 而PostgreSQL采用的是客户端连接过来fork新进程然后这个新进程与客户端进行交互的模式, 因此这种情况会造成数据库服务器大量的关闭和创建进程, sar -c能反映这种情况. 使用短连接还有一个坏处就是当系统中使用到sequence, 并且这个sequence被大量的这种短连接进程请求, 那么它设置的sequence cache没有效果并且会造成大量的跳号.</div><div>详情</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;-c &nbsp; &nbsp; Report process creation activity.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; proc/s</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Total number of processes created per second.</font></div><p></p></pre></div></div><div>4. sar -q</div><div>反映系统的负载, 详情</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;-q &nbsp; &nbsp; Report queue length and load averages. The following values are displayed:</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; runq-sz</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Run queue length (number of processes waiting for run time).</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; plist-sz</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Number of processes and threads in the process list.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ldavg-1</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;System load average for the last minute.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ldavg-5</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;System load average for the past 5 minutes.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ldavg-15</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;System load average for the past 15 minutes.</font></div><p></p></pre></div></div><div>5. sar -r</div><div>反映系统的内存和SWAP的使用情况, 详情</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;-r &nbsp; &nbsp; Report memory and swap space utilization statistics. &nbsp;The following values are displayed:</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kbmemfree</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Amount of free memory available in kilobytes.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kbmemused</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Amount &nbsp;of &nbsp;used &nbsp;memory &nbsp;in kilobytes. This does not take into account memory used by the kernel</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;itself.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %memused</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Percentage of used memory.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kbbuffers</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Amount of memory used as buffers by the kernel in kilobytes.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kbcached</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Amount of memory used to cache data by the kernel in kilobytes.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kbswpfree</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Amount of free swap space in kilobytes.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kbswpused</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Amount of used swap space in kilobytes.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %swpused</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Percentage of used swap space.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kbswpcad</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Amount of cached swap memory in kilobytes. &nbsp;This is memory that once was swapped out, is &nbsp;swapped</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;back in but still also is in the swap area (if memory is needed it doesn’t need to be swapped out</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;again because it is already in the swap area. This saves I/O).</font></div><p></p></pre></div></div><div>6. sar -R</div><div>反映每秒被free的内存, 新增给buffer的内存, 新增给cache的内存. 详情</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;-R &nbsp; &nbsp; Report memory statistics. The following values are displayed:</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; frmpg/s</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Number of memory pages freed by the system per second. &nbsp;A negative value represents a &nbsp;number &nbsp;of</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pages &nbsp;allocated &nbsp;by &nbsp;the &nbsp;system. &nbsp; Note that a page has a size of 4 kB or 8 kB according to the</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;machine architecture.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bufpg/s</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Number of additional memory pages used as buffers by the system per &nbsp;second. &nbsp; A &nbsp;negative &nbsp;value</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;means fewer pages used as buffers by the system.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; campg/s</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Number &nbsp;of additional memory pages cached by the system per second. &nbsp;A negative value means fewer</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pages in the cache.</font></div><p></p></pre></div></div><div>7. sar -u</div><div>反映系统CPU在user, nice, system, iowait, steal, idle的分配比例. 详情</div><div><div><pre class="prettyprint"  ><p></p><div>&nbsp; &nbsp; &nbsp; <font size="2"  >&nbsp;-u &nbsp; &nbsp; Report CPU utilization. The following values are displayed:</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %user</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Percentage of CPU utilization that occurred while executing at the user level (application).</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %nice</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Percentage of CPU utilization that occurred while executing at the user level with nice priority.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %system</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Percentage of CPU utilization that occurred while executing at the system level (kernel).</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %iowait</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Percentage of time that the CPU or CPUs were idle during which the system had an outstanding disk</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;I/O request.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %steal</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Show the percentage of time spent in involuntary wait by the virtual CPU or CPUs while the hyper-</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;visor was servicing another virtual processor.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %idle</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Percentage of time that the CPU or CPUs were idle and the system did not have an outstanding disk</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;I/O request.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Note: On SMP machines a processor that does not have any activity at all (0.00 for &nbsp;every &nbsp;field) &nbsp;is &nbsp;a</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; disabled (offline) processor.</font></div><p></p></pre></div></div><div>8. sar -v</div><div>inode, file 或其他内核表的报告, 详情</div><div><div><pre class="prettyprint"  ><p></p><div>&nbsp; &nbsp; &nbsp; <font size="2"  >&nbsp;-v &nbsp; &nbsp; Report status of inode, file and other kernel tables. &nbsp;The following values are displayed:</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dentunusd</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Number of unused cache entries in the directory cache.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file-sz</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Number of used file handles.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inode-sz</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Number of used inode handlers.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; super-sz</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Number of super block handlers allocated by the kernel.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %super-sz</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Percentage &nbsp;of &nbsp;allocated &nbsp;super &nbsp;block handlers with regard to the maximum number of super block</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;handlers that Linux can allocate.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dquot-sz</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Number of allocated disk quota entries.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %dquot-sz</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Percentage of allocated disk quota entries with regard to the maximum number of cached disk quota</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;entries that can be allocated.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rtsig-sz</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Number of queued RT signals.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %rtsig-sz</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Percentage &nbsp;of &nbsp;queued &nbsp;RT &nbsp;signals &nbsp;with &nbsp;regard to the maximum number of RT signals that can be</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;queued.</font></div><p></p></pre></div></div><div>9. sar -w</div><div>反映每秒上下文的切换数量, 详情</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;-w &nbsp; &nbsp; Report system switching activity.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cswch/s</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Total number of context switches per second.</font></div><p></p></pre></div></div><div>10. sar -W</div><div>反映SWAP每秒被换进或换出的数量, 详情</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;-W &nbsp; &nbsp; Report swapping statistics. The following values are displayed:</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pswpin/s</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Total number of swap pages the system brought in per second.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pswpout/s</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Total number of swap pages the system brought out per second.</font></div><p></p></pre></div></div><div><br></div><div>二、接下来看看数据库表的设计 :&nbsp;</div><div>我这里使用的是sar用户和sar库以及tbs_sar表空间, 首先初始化数据库 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create role sar nosuperuser nocreatedb nocreaterole noinherit login encrypted password 'DIGOAL';</font></div><div><font size="2"  >create tablespace tbs_sar owner digoal location '/home/sar/tbs_sar';</font></div><div><font size="2"  >create database sar with owner digoal template template0 encoding 'UTF8' tablespace tbs_sar;</font></div><div><font size="2"  >grant all on database sar to sar;</font></div><div><font size="2"  >grant all on tablespace tbs_sar to sar;</font></div><div><font size="2"  >\c sar sar</font></div><div><font size="2"  >create schema sar authorization sar;</font></div><p></p></pre></div></div><div>创建序列, 函数 和表 :&nbsp;</div><div><div><pre class="prettyprint"  ><p><font size="2"  >create sequence seq_server_id start with 1 increment by 1;</font></p></pre></div><div>存放Server信息, 本例只为说明方法, 所以这个表设计得比较简单, 实际使用当中可以加入其他字段, 如IDC, 维护人, 项目名称等。</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create table server(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >ip inet not null unique,</font></div><div><font size="2"  >info text);</font></div><p></p></pre></div><div>根据IP地址获取ServerID的函数, 没有则新分配</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function get_server_id (i_ip inet) returns int as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_id int;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >select id into v_id from server where ip=i_ip;</font></div><div><font size="2"  >if not found then</font></div><div><font size="2"  >insert into server(id, ip) values(nextval('seq_server_id'::regclass), i_ip);</font></div><div><font size="2"  >select id into v_id from server where ip=i_ip;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >return v_id;</font></div><div><font size="2"  >exception&nbsp;</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >return -1;</font></div><div><font size="2"  >end</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><p></p></pre></div><div>根据ServerID获取IP的函数</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function get_ip (i_id int) returns inet as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_ip inet;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >select ip into v_ip from server where id=i_id;</font></div><div><font size="2"  >return v_ip;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >return '0.0.0.0/0'::inet;</font></div><div><font size="2"  >end</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><p></p></pre></div><div>根据ServerID获取服务器info的函数</div><div><pre class="prettyprint"  style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >create or replace function get_info (i_id int) returns text as $BODY$</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >declare</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >v_info text;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >begin</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >select info into v_info from server where id=i_id;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >return v_info;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >exception</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >when others then</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >return 'no info';</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >end</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >$BODY$ language plpgsql;</font></div></pre></div><div>统计昨天未收集到SAR日志的函数</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function get_server_nodata_yesterday() returns setof text as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_result text;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >perform 1 from (select s1.* from server s1 left outer join</font></div><div><font size="2"  >(select * from (select server_id,row_number() over (partition by server_id order by s_date desc) from sar_context where s_date=current_date-1) t1&nbsp;</font></div><div><font size="2"  >where row_number=1) t2 on (s1.id=t2.server_id) where t2.server_id is null) t;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >return next 'sar_context: ';</font></div><div><font size="2"  >return query select s1.ip||', '||s1.info from server s1 left outer join</font></div><div><font size="2"  >(select * from (select server_id,row_number() over (partition by server_id order by s_date desc) from sar_context where s_date=current_date-1) t1&nbsp;</font></div><div><font size="2"  >where row_number=1) t2 on (s1.id=t2.server_id) where t2.server_id is null;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >perform 1 from (select s1.* from server s1 left outer join</font></div><div><font size="2"  >(select * from (select server_id,row_number() over (partition by server_id order by s_date desc) from sar_cpu where s_date=current_date-1) t1&nbsp;</font></div><div><font size="2"  >where row_number=1) t2 on (s1.id=t2.server_id) where t2.server_id is null) t;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >return next 'sar_cpu: ';</font></div><div><font size="2"  >return query select s1.ip||', '||s1.info from server s1 left outer join</font></div><div><font size="2"  >(select * from (select server_id,row_number() over (partition by server_id order by s_date desc) from sar_cpu where s_date=current_date-1) t1&nbsp;</font></div><div><font size="2"  >where row_number=1) t2 on (s1.id=t2.server_id) where t2.server_id is null;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >perform 1 from (select s1.* from server s1 left outer join</font></div><div><font size="2"  >(select * from (select server_id,row_number() over (partition by server_id order by s_date desc) from sar_inode where s_date=current_date-1) t1&nbsp;</font></div><div><font size="2"  >where row_number=1) t2 on (s1.id=t2.server_id) where t2.server_id is null) t;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >return next 'sar_inode: ';</font></div><div><font size="2"  >return query select s1.ip||', '||s1.info from server s1 left outer join</font></div><div><font size="2"  >(select * from (select server_id,row_number() over (partition by server_id order by s_date desc) from sar_inode where s_date=current_date-1) t1&nbsp;</font></div><div><font size="2"  >where row_number=1) t2 on (s1.id=t2.server_id) where t2.server_id is null;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >perform 1 from (select s1.* from server s1 left outer join</font></div><div><font size="2"  >(select * from (select server_id,row_number() over (partition by server_id order by s_date desc) from sar_io where s_date=current_date-1) t1&nbsp;</font></div><div><font size="2"  >where row_number=1) t2 on (s1.id=t2.server_id) where t2.server_id is null) t;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >return next 'sar_io: ';</font></div><div><font size="2"  >return query select s1.ip||', '||s1.info from server s1 left outer join</font></div><div><font size="2"  >(select * from (select server_id,row_number() over (partition by server_id order by s_date desc) from sar_io where s_date=current_date-1) t1&nbsp;</font></div><div><font size="2"  >where row_number=1) t2 on (s1.id=t2.server_id) where t2.server_id is null;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >perform 1 from (select s1.* from server s1 left outer join</font></div><div><font size="2"  >(select * from (select server_id,row_number() over (partition by server_id order by s_date desc) from sar_load where s_date=current_date-1) t1&nbsp;</font></div><div><font size="2"  >where row_number=1) t2 on (s1.id=t2.server_id) where t2.server_id is null) t;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >return next 'sar_load: ';</font></div><div><font size="2"  >return query select s1.ip||', '||s1.info from server s1 left outer join</font></div><div><font size="2"  >(select * from (select server_id,row_number() over (partition by server_id order by s_date desc) from sar_load where s_date=current_date-1) t1&nbsp;</font></div><div><font size="2"  >where row_number=1) t2 on (s1.id=t2.server_id) where t2.server_id is null;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >perform 1 from (select s1.* from server s1 left outer join</font></div><div><font size="2"  >(select * from (select server_id,row_number() over (partition by server_id order by s_date desc) from sar_mem where s_date=current_date-1) t1&nbsp;</font></div><div><font size="2"  >where row_number=1) t2 on (s1.id=t2.server_id) where t2.server_id is null) t;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >return next 'sar_mem: ';</font></div><div><font size="2"  >return query select s1.ip||', '||s1.info from server s1 left outer join</font></div><div><font size="2"  >(select * from (select server_id,row_number() over (partition by server_id order by s_date desc) from sar_mem where s_date=current_date-1) t1&nbsp;</font></div><div><font size="2"  >where row_number=1) t2 on (s1.id=t2.server_id) where t2.server_id is null;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >perform 1 from (select s1.* from server s1 left outer join</font></div><div><font size="2"  >(select * from (select server_id,row_number() over (partition by server_id order by s_date desc) from sar_mem_swap where s_date=current_date-1) t1&nbsp;</font></div><div><font size="2"  >where row_number=1) t2 on (s1.id=t2.server_id) where t2.server_id is null) t;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >return next 'sar_mem_swap: ';</font></div><div><font size="2"  >return query select s1.ip||', '||s1.info from server s1 left outer join</font></div><div><font size="2"  >(select * from (select server_id,row_number() over (partition by server_id order by s_date desc) from sar_mem_swap where s_date=current_date-1) t1&nbsp;</font></div><div><font size="2"  >where row_number=1) t2 on (s1.id=t2.server_id) where t2.server_id is null;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >perform 1 from (select s1.* from server s1 left outer join</font></div><div><font size="2"  >(select * from (select server_id,row_number() over (partition by server_id order by s_date desc) from sar_page where s_date=current_date-1) t1&nbsp;</font></div><div><font size="2"  >where row_number=1) t2 on (s1.id=t2.server_id) where t2.server_id is null) t;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >return next 'sar_page: ';</font></div><div><font size="2"  >return query select s1.ip||', '||s1.info from server s1 left outer join</font></div><div><font size="2"  >(select * from (select server_id,row_number() over (partition by server_id order by s_date desc) from sar_page where s_date=current_date-1) t1&nbsp;</font></div><div><font size="2"  >where row_number=1) t2 on (s1.id=t2.server_id) where t2.server_id is null;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >perform 1 from (select s1.* from server s1 left outer join</font></div><div><font size="2"  >(select * from (select server_id,row_number() over (partition by server_id order by s_date desc) from sar_proc where s_date=current_date-1) t1&nbsp;</font></div><div><font size="2"  >where row_number=1) t2 on (s1.id=t2.server_id) where t2.server_id is null) t;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >return next 'sar_proc: ';</font></div><div><font size="2"  >return query select s1.ip||', '||s1.info from server s1 left outer join</font></div><div><font size="2"  >(select * from (select server_id,row_number() over (partition by server_id order by s_date desc) from sar_proc where s_date=current_date-1) t1&nbsp;</font></div><div><font size="2"  >where row_number=1) t2 on (s1.id=t2.server_id) where t2.server_id is null;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >perform 1 from (select s1.* from server s1 left outer join</font></div><div><font size="2"  >(select * from (select server_id,row_number() over (partition by server_id order by s_date desc) from sar_swap where s_date=current_date-1) t1&nbsp;</font></div><div><font size="2"  >where row_number=1) t2 on (s1.id=t2.server_id) where t2.server_id is null) t;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >return next 'sar_swap: ';</font></div><div><font size="2"  >return query select s1.ip||', '||s1.info from server s1 left outer join</font></div><div><font size="2"  >(select * from (select server_id,row_number() over (partition by server_id order by s_date desc) from sar_swap where s_date=current_date-1) t1&nbsp;</font></div><div><font size="2"  >where row_number=1) t2 on (s1.id=t2.server_id) where t2.server_id is null;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >return;</font></div><div><font size="2"  >end</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><p></p></pre></div></div><div>sar信息存放表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create table sar_io</font></div><div><font size="2"  >(server_id int not null,</font></div><div><font size="2"  >s_date date not null,</font></div><div><font size="2"  >s_time time not null,</font></div><div><font size="2"  >tps numeric,</font></div><div><font size="2"  >rtps numeric,</font></div><div><font size="2"  >wtps numeric,</font></div><div><font size="2"  >bread_p_s numeric,</font></div><div><font size="2"  >bwrtn_p_s numeric,</font></div><div><font size="2"  >unique(server_id,s_date,s_time));</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table sar_page</font></div><div><font size="2"  >(server_id int not null,</font></div><div><font size="2"  >s_date date not null,</font></div><div><font size="2"  >s_time time not null,</font></div><div><font size="2"  >pgpgin_p_s numeric,</font></div><div><font size="2"  >pgpgout_p_s numeric,</font></div><div><font size="2"  >fault_p_s numeric,</font></div><div><font size="2"  >majflt_p_s numeric,</font></div><div><font size="2"  >unique(server_id,s_date,s_time));</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table sar_proc</font></div><div><font size="2"  >(server_id int not null,</font></div><div><font size="2"  >s_date date not null,</font></div><div><font size="2"  >s_time time not null,</font></div><div><font size="2"  >proc_p_s numeric,</font></div><div><font size="2"  >unique(server_id,s_date,s_time));</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table sar_load</font></div><div><font size="2"  >(server_id int not null,</font></div><div><font size="2"  >s_date date not null,</font></div><div><font size="2"  >s_time time not null,</font></div><div><font size="2"  >runq_sz numeric,</font></div><div><font size="2"  >plist_sz numeric,</font></div><div><font size="2"  >ldavg_1 numeric,</font></div><div><font size="2"  >ldavg_5 numeric,</font></div><div><font size="2"  >ldavg_15 numeric,</font></div><div><font size="2"  >unique(server_id,s_date,s_time));</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table sar_mem_swap</font></div><div><font size="2"  >(server_id int not null,</font></div><div><font size="2"  >s_date date not null,</font></div><div><font size="2"  >s_time time not null,</font></div><div><font size="2"  >kbmemfree numeric,</font></div><div><font size="2"  >kbmemused numeric,</font></div><div><font size="2"  >percnt_memused numeric,</font></div><div><font size="2"  >kbbuffers numeric,</font></div><div><font size="2"  >kbcached numeric,</font></div><div><font size="2"  >kbswpfree numeric,</font></div><div><font size="2"  >kbswpused numeric,</font></div><div><font size="2"  >percnt_swpused numeric,</font></div><div><font size="2"  >kbswpcad numeric,</font></div><div><font size="2"  >unique(server_id,s_date,s_time));</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table sar_mem</font></div><div><font size="2"  >(server_id int not null,</font></div><div><font size="2"  >s_date date not null,</font></div><div><font size="2"  >s_time time not null,</font></div><div><font size="2"  >frmpg_p_s numeric,</font></div><div><font size="2"  >bufpg_p_s numeric,</font></div><div><font size="2"  >campg_p_s numeric,</font></div><div><font size="2"  >unique(server_id,s_date,s_time));</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table sar_cpu</font></div><div><font size="2"  >(server_id int not null,</font></div><div><font size="2"  >s_date date not null,</font></div><div><font size="2"  >s_time time not null,</font></div><div><font size="2"  >percnt_user numeric,</font></div><div><font size="2"  >percnt_nice numeric,</font></div><div><font size="2"  >percnt_system numeric,</font></div><div><font size="2"  >percnt_iowait numeric,</font></div><div><font size="2"  >percnt_steal numeric,</font></div><div><font size="2"  >percnt_idle numeric,</font></div><div><font size="2"  >unique(server_id,s_date,s_time));</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table sar_inode</font></div><div><font size="2"  >(server_id int not null,</font></div><div><font size="2"  >s_date date not null,</font></div><div><font size="2"  >s_time time not null,</font></div><div><font size="2"  >dentunusd numeric,</font></div><div><font size="2"  >file_sz numeric,</font></div><div><font size="2"  >inode_sz numeric,</font></div><div><font size="2"  >super_sz numeric,</font></div><div><font size="2"  >percnt_super_sz numeric,</font></div><div><font size="2"  >dquot_sz numeric,</font></div><div><font size="2"  >percnt_dquot_sz numeric,</font></div><div><font size="2"  >rtsig_sz numeric,</font></div><div><font size="2"  >percnt_rtsig_sz numeric,</font></div><div><font size="2"  >unique(server_id,s_date,s_time));</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table sar_context</font></div><div><font size="2"  >(server_id int not null,</font></div><div><font size="2"  >s_date date not null,</font></div><div><font size="2"  >s_time time not null,</font></div><div><font size="2"  >cswch_p_s numeric,</font></div><div><font size="2"  >unique(server_id,s_date,s_time));</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table sar_swap</font></div><div><font size="2"  >(server_id int not null,</font></div><div><font size="2"  >s_date date not null,</font></div><div><font size="2"  >s_time time not null,</font></div><div><font size="2"  >pswpin_p_s numeric,</font></div><div><font size="2"  >pswpout_p_s numeric,</font></div><div><font size="2"  >unique(server_id,s_date,s_time));</font></div><p></p></pre></div></div><div><br></div><div>三、在需要收集sar报告的操作系统中配置如下程序用来收集sar信息 :&nbsp;</div><div>收集用到了PostgreSQL的psql程序, 所以需要在系统中安装PostgreSQL客户端. 安装过程略.</div><div>假设PostgreSQL数据库的连接信息如下, IP 10.10.10.1 , Port 1931 , DBNAME sar , USER sar , PASSWORD DIGOAL</div><div><div>配置 ~/.pgpass文件</div><div><pre class="prettyprint"  ><p><font size="2"  >10.10.10.1:1931:sar:sar:DIGOAL</font></p></pre></div><div><pre class="prettyprint"  ><p><font size="2"  >chmod 400 ~/.pgpass</font></p></pre></div><div><br></div><div><div>编写sar_collect.sh脚本, 用于收集昨天的SAR报告</div><div><pre class="prettyprint"  ><p><font size="2"  >vi /home/postgres/<span style="line-height: 22px;"  >sar_collect.sh</span></font></p></pre></div></div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >#!/bin/bash<br># 环境变量, 数据库连接, 避免风暴随机等待60秒内<br>. /home/postgres/.bash_profile<br>DB_URL="-h 10.10.10.1 -p 1931 -U sar -d sar"<br>sleep $(($RANDOM%60))<br><br>NET_DEV="`/sbin/route -n|grep UG|awk '{print $8}'|head -n 1`"<br>IP_ADDR="'`/sbin/ip addr show $NET_DEV|grep inet|grep "global $NET_DEV$"|awk '{print $2}'`'"<br>SAR_FILE="/var/log/sa/sa`date -d -1day +%d`"<br>SAR_DATE="'`date -d -1day +%Y-%m-%d`'"<br>SERVER_ID="`psql -A -t $DB_URL -c "select * from get_server_id($IP_ADDR)"`"<br><br># sar -b, sar_io tps      rtps      wtps   bread/s   bwrtn/s<br>SQL=`sar -b -f $SAR_FILE|grep -E 'AM[ ]+([0-9]+|\.+|all|-)|PM[ ]+([0-9]+|\.+|all|-)'|awk '{print "insert into sar_io(server_id, s_date, s_time, tps, rtps, wtps, bread_p_s, bwrtn_p_s) values('$SERVER_ID', '$SAR_DATE',","\47"$1$2"\47,",$3",",$4",",$5",",$6",",$7");"}'`<br>psql $DB_URL -c "$SQL"<br><br># sar -B, sar_page pgpgin/s pgpgout/s   fault/s  majflt/s<br>SQL=`sar -B -f $SAR_FILE|grep -E 'AM[ ]+([0-9]+|\.+|all|-)|PM[ ]+([0-9]+|\.+|all|-)'|awk '{print "insert into sar_page(server_id, s_date, s_time, pgpgin_p_s, pgpgout_p_s, fault_p_s, majflt_p_s) values('$SERVER_ID', '$SAR_DATE',","\47"$1$2"\47,",$3",",$4",",$5",",$6");"}'`<br>psql $DB_URL -c "$SQL"<br><br># sar -c, sar_proc proc/s<br>SQL=`sar -c -f $SAR_FILE|grep -E 'AM[ ]+([0-9]+|\.+|all|-)|PM[ ]+([0-9]+|\.+|all|-)'|awk '{print "insert into sar_proc(server_id, s_date, s_time, proc_p_s) values('$SERVER_ID', '$SAR_DATE',","\47"$1$2"\47,",$3");"}'`<br>psql $DB_URL -c "$SQL"<br><br># sar -q, sar_load runq-sz  plist-sz   ldavg-1   ldavg-5  ldavg-15<br>SQL=`sar -q -f $SAR_FILE|grep -E 'AM[ ]+([0-9]+|\.+|all|-)|PM[ ]+([0-9]+|\.+|all|-)'|awk '{print "insert into sar_load(server_id, s_date, s_time, runq_sz, plist_sz, ldavg_1, ldavg_5, ldavg_15) values('$SERVER_ID', '$SAR_DATE',","\47"$1$2"\47,",$3",",$4",",$5",",$6",",$7");"}'`<br>psql $DB_URL -c "$SQL"<br><br># sar -r, sar_mem_swap kbmemfree kbmemused  %memused kbbuffers  kbcached kbswpfree kbswpused  %swpused  kbswpcad<br>SQL=`sar -r -f $SAR_FILE|grep -E 'AM[ ]+([0-9]+|\.+|all|-)|PM[ ]+([0-9]+|\.+|all|-)'|awk '{print "insert into sar_mem_swap(server_id, s_date, s_time, kbmemfree, kbmemused, percnt_memused, kbbuffers, kbcached, kbswpfree, kbswpused, percnt_swpused, kbswpcad) values('$SERVER_ID', '$SAR_DATE',","\47"$1$2"\47,",$3",",$4",",$5",",$6",",$7",",$8",",$9",",$10",",$11");"}'`<br>psql $DB_URL -c "$SQL"<br><br># sar -R, sar_mem frmpg/s   bufpg/s   campg/s<br>SQL=`sar -R -f $SAR_FILE|grep -E 'AM[ ]+([0-9]+|\.+|all|-)|PM[ ]+([0-9]+|\.+|all|-)'|awk '{print "insert into sar_mem(server_id, s_date, s_time, frmpg_p_s, bufpg_p_s, campg_p_s) values('$SERVER_ID', '$SAR_DATE',","\47"$1$2"\47,",$3",",$4",",$5");"}'`<br>psql $DB_URL -c "$SQL"<br><br># sar -u, sar_cpu %user     %nice   %system   %iowait    %steal     %idle<br>SQL=`sar -u -f $SAR_FILE|grep -E 'AM[ ]+([0-9]+|\.+|all|-)|PM[ ]+([0-9]+|\.+|all|-)'|awk '{print "insert into sar_cpu(server_id, s_date, s_time, percnt_user, percnt_nice, percnt_system, percnt_iowait, percnt_steal, percnt_idle) values('$SERVER_ID', '$SAR_DATE',","\47"$1$2"\47,",$4",",$5",",$6",",$7",",$8",",$9");"}'`<br>psql $DB_URL -c "$SQL"<br><br># sar -v, sar_inode dentunusd   file-sz  inode-sz  super-sz %super-sz  dquot-sz %dquot-sz  rtsig-sz %rtsig-sz<br>SQL=`sar -v -f $SAR_FILE|grep -E 'AM[ ]+([0-9]+|\.+|all|-)|PM[ ]+([0-9]+|\.+|all|-)'|awk '{print "insert into sar_inode(server_id, s_date, s_time, dentunusd, file_sz, inode_sz, super_sz, percnt_super_sz, dquot_sz, percnt_dquot_sz, rtsig_sz, percnt_rtsig_sz) values('$SERVER_ID', '$SAR_DATE',","\47"$1$2"\47,",$3",",$4",",$5",",$6",",$7",",$8",",$9",",$10",",$11");"}'`<br>psql $DB_URL -c "$SQL"<br><br># sar -w, sar_context cswch/s<br>SQL=`sar -w -f $SAR_FILE|grep -E 'AM[ ]+([0-9]+|\.+|all|-)|PM[ ]+([0-9]+|\.+|all|-)'|awk '{print "insert into sar_context(server_id, s_date, s_time, cswch_p_s) values('$SERVER_ID', '$SAR_DATE',","\47"$1$2"\47,",$3");"}'`<br>psql $DB_URL -c "$SQL"<br><br># sar -W, sar_swap pswpin/s pswpout/s<br>SQL=`sar -W -f $SAR_FILE|grep -E 'AM[ ]+([0-9]+|\.+|all|-)|PM[ ]+([0-9]+|\.+|all|-)'|awk '{print "insert into sar_swap(server_id, s_date, s_time, pswpin_p_s, pswpout_p_s) values('$SERVER_ID', '$SAR_DATE',","\47"$1$2"\47,",$3",",$4");"}'`<br>psql $DB_URL -c "$SQL"</font></div></div><div><font size="2"  ><br></font></div><div><font size="2"  ># Author : Digoal.Zhou</font></div><div><span style="line-height: 22px;"  ><font size="2"  ># THE END</font></span></div><p></p></pre></div></div><div><span style="line-height: 22px;"  ><br></span></div><div><span style="line-height: 22px;"  >修改权限 :&nbsp;</span></div><div><pre class="prettyprint"  ><p>chmod 500 sar_collect.sh</p></pre></div><div>新建执行计划,&nbsp;</div><div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p><font size="2"  >crontab -e</font></p></pre></div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p><font size="2"  >1 2 * * * /home/postgres/sar_collect.sh</font></p></pre></div><div style="line-height: 22px;"  ><br></div><div style="line-height: 22px;"  >四、然后看看几条简单的报告SQL, 使用row_number窗口函数 &nbsp;:&nbsp;</div></div><div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  ># 昨天15分钟最大负载排名前10,后一条为平均值排行<br># 负载过高需要关注这些服务器上运行的数据库和业务是否健康, 例如是否需要建索引, 是否需要使用绑定变量等.<br>select get_ip(server_id),* from (select *,row_number() over (partition by server_id order by ldavg_15 desc) from sar_load where s_date=current_date-1) t where row_number=1 order by ldavg_15 desc limit 10;<br>select get_info(server_id),get_ip(server_id),round(avg(ldavg_15),2) ldavg_15 from sar_load where s_date=current_date-1 group by server_id,s_date order by ldavg_15 desc limit 10;<br><br># 昨天最大读请求数排名前10,后一条为平均值排行<br># 读请求过高需要关注这些服务器上运行的数据库和业务是否健康, 例如是否需要建索引, 是否需要加内存, 是否需要对存储性能扩容等. <br>select get_ip(server_id),* from (select *,row_number() over (partition by server_id order by rtps desc) from sar_io where s_date=current_date-1) t where row_number=1 order by rtps desc limit 10;<br>select get_info(server_id),get_ip(server_id),round(avg(rtps),2) rtps from sar_io where s_date=current_date-1 group by server_id,s_date order by rtps desc limit 10;<br><br># 昨天最大写请求数排名前10,后一条为平均值排行<br># 写请求过高需要关注这些服务器上运行的数据库和业务是否健康, 例如是否需要减少索引, 是否需要使用异步IO, 是否需要对存储性能进行扩容等. <br>select get_ip(server_id),* from (select *,row_number() over (partition by server_id order by wtps desc) from sar_io where s_date=current_date-1) t where row_number=1 order by wtps desc limit 10;<br>select get_info(server_id),get_ip(server_id),round(avg(wtps),2) wtps from sar_io where s_date=current_date-1 group by server_id,s_date order by wtps desc limit 10;<br><br># 昨天最大iowait排名前10,后一条为平均值排行<br># iowait过高需要关注这些服务器上运行的数据库和业务是否健康, 例如是否需要加内存, 是否需要将常用数据放入内存, 是否需要对存储性能进行扩容等.<br>select get_ip(server_id),* from (select *,row_number() over (partition by server_id order by percnt_iowait desc) from sar_cpu where s_date=current_date-1) t where row_number=1 order by percnt_iowait desc limit 10;<br>select get_info(server_id),get_ip(server_id),round(avg(percnt_iowait),2) percnt_iowait from sar_cpu where s_date=current_date-1 group by server_id,s_date order by percnt_iowait desc limit 10;<br><br># 昨天最大swap页进出排名前10,后一条为平均值排行<br># swap也进出过高需要关注这些服务器上运行的数据库和业务是否健康, 例如是否需要加内存, 是否需要将常用数据放入内存等. <br>select get_ip(server_id),* from (select *,row_number() over (partition by server_id order by pswpin_p_s+pswpout_p_s desc) from sar_swap where s_date=current_date-1) t where row_number=1 order by pswpin_p_s+pswpout_p_s desc limit 10;<br>select get_info(server_id),get_ip(server_id),round(avg(pswpin_p_s+pswpout_p_s),2) pswpin_out_p_s from sar_swap where s_date=current_date-1 group by server_id,s_date order by pswpin_out_p_s desc limit 10;<br><br># 昨天最大SWAP使用比例前10,后一条为平均值排行<br># SWAP使用率过高需要关注这些服务器上运行的数据库和业务是否健康, 例如是否需要加内存, 是否需要调整数据库参数, 是否需要使用大页等. <br>select get_ip(server_id),* from (select *,row_number() over (partition by server_id order by percnt_swpused desc) from sar_mem_swap where s_date=current_date-1) t where row_number=1 order by percnt_swpused desc limit 10;<br>select get_info(server_id),get_ip(server_id),round(avg(percnt_swpused),2) percnt_swpused from sar_mem_swap where s_date=current_date-1 group by server_id,s_date order by percnt_swpused desc limit 10;<br><br># 昨天每秒新建进程排名前10,后一条为平均值排行<br># 每秒新建进程数过高需要关注这些服务器上运行的数据库和业务是否健康, 例如是否需要加个数据库连接池使用长连接, Oracle是否需要使用共享连接, 应用程序是否可以将短连接改成长连接的模式等. <br>select get_ip(server_id),* from (select *,row_number() over (partition by server_id order by proc_p_s desc) from sar_proc where s_date=current_date-1) t where row_number=1 order by  proc_p_s  desc limit 10;<br>select get_info(server_id),get_ip(server_id),round(avg(proc_p_s),2) proc_p_s from sar_proc where s_date=current_date-1 group by server_id,s_date order by proc_p_s desc limit 10;</font></div></div><p></p></pre></div></div><div>报告如图 :&nbsp;</div><div><div><br></div><div><img title="Use PostgreSQL collect and analyze Operation System statistics - 德哥@Digoal - The Heart,The World."  alt="Use PostgreSQL collect and analyze Operation System statistics - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img0.ph.126.net/98t_8FIo0yJvEbPIPim4IA==/2634324307052285480.jpg"  ></div>&nbsp;<div><img title="Use PostgreSQL collect and analyze Operation System statistics - 德哥@Digoal - The Heart,The World."  alt="Use PostgreSQL collect and analyze Operation System statistics - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img2.ph.126.net/fmy5DbfVisuu6Q0Lpzkm9A==/1566408245412055992.jpg"  ></div>&nbsp;<div><img title="Use PostgreSQL collect and analyze Operation System statistics - 德哥@Digoal - The Heart,The World."  alt="Use PostgreSQL collect and analyze Operation System statistics - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img9.ph.126.net/uxnjgkjBpcJ7cv-XnSkJZw==/3097069168764599989.jpg"  ></div><div><br></div><div><div><img title="Use PostgreSQL collect and analyze Operation System statistics - 德哥@Digoal - The Heart,The World."  alt="Use PostgreSQL collect and analyze Operation System statistics - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img3.ph.126.net/UUIMSLiz62A4-_45ZrFamw==/2634324307052285473.jpg"  ></div>&nbsp;</div>&nbsp;</div><div>五、最后通过邮件将报告发送给自己 :&nbsp;</div><div>发送邮件脚本 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >#!/bin/bash</font></div><div><font size="2"  >. /home/postgres/.bash_profile</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >EMAIL="digoal@126.com"</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >echo -e `date +%F\ %T` &gt;/tmp/sar_report.log<br>echo -e "\n---- WeeklyAvgValue TOP10: ----\n" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n1. ldavg_15 TOP10 :\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select get_info(server_id),get_ip(server_id),round(avg(ldavg_15),2) ldavg_15 from sar_load where s_date&lt;=current_date-1 and s_date&gt;=current_date-7 group by server_id order by ldavg_15 desc limit 10;" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n2. rtps TOP10 :\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select get_info(server_id),get_ip(server_id),round(avg(rtps),2) rtps from sar_io where s_date&lt;=current_date-1 and s_date&gt;=current_date-7 group by server_id order by rtps desc limit 10;" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n3. wtps TOP10 :\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select get_info(server_id),get_ip(server_id),round(avg(wtps),2) wtps from sar_io where s_date&lt;=current_date-1 and s_date&gt;=current_date-7 group by server_id order by wtps desc limit 10;" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n4. iowait TOP10 :\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select get_info(server_id),get_ip(server_id),round(avg(percnt_iowait),2) percnt_iowait from sar_cpu where s_date&lt;=current_date-1 and s_date&gt;=current_date-7 group by server_id order by percnt_iowait desc limit 10;" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n5. swap_page_in_out TOP10 :\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select get_info(server_id),get_ip(server_id),round(avg(pswpin_p_s+pswpout_p_s),2) pswpin_out_p_s from sar_swap where s_date&lt;=current_date-1 and s_date&gt;=current_date-7 group by server_id order by pswpin_out_p_s desc limit 10;" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n6. swap_usage TOP10 :\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select get_info(server_id),get_ip(server_id),round(avg(percnt_swpused),2) percnt_swpused from sar_mem_swap where s_date&lt;=current_date-1 and s_date&gt;=current_date-7 group by server_id order by percnt_swpused desc limit 10;" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n7. newproc_p_s TOP10 :\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select get_info(server_id),get_ip(server_id),round(avg(proc_p_s),2) proc_p_s from sar_proc where s_date&lt;=current_date-1 and s_date&gt;=current_date-7 group by server_id order by proc_p_s desc limit 10;" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n---- DailyAvgValue TOP10: ----\n" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n1. ldavg_15 TOP10 :\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select get_info(server_id),get_ip(server_id),round(avg(ldavg_15),2) ldavg_15 from sar_load where s_date=current_date-1 group by server_id order by ldavg_15 desc limit 10;" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n2. rtps TOP10 :\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select get_info(server_id),get_ip(server_id),round(avg(rtps),2) rtps from sar_io where s_date=current_date-1 group by server_id order by rtps desc limit 10;" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n3. wtps TOP10 :\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select get_info(server_id),get_ip(server_id),round(avg(wtps),2) wtps from sar_io where s_date=current_date-1 group by server_id order by wtps desc limit 10;" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n4. iowait TOP10 :\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select get_info(server_id),get_ip(server_id),round(avg(percnt_iowait),2) percnt_iowait from sar_cpu where s_date=current_date-1 group by server_id order by percnt_iowait desc limit 10;" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n5. swap_page_in_out TOP10 :\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select get_info(server_id),get_ip(server_id),round(avg(pswpin_p_s+pswpout_p_s),2) pswpin_out_p_s from sar_swap where s_date=current_date-1 group by server_id order by pswpin_out_p_s desc limit 10;" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n6. swap_usage TOP10 :\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select get_info(server_id),get_ip(server_id),round(avg(percnt_swpused),2) percnt_swpused from sar_mem_swap where s_date=current_date-1 group by server_id order by percnt_swpused desc limit 10;" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n7. newproc_p_s TOP10 :\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select get_info(server_id),get_ip(server_id),round(avg(proc_p_s),2) proc_p_s from sar_proc where s_date=current_date-1 group by server_id order by proc_p_s desc limit 10;" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n---- DailyMaxValue TOP10: ----\n" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n1. ldavg_15 TOP10 :\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select get_info(server_id),get_ip(server_id),s_date,s_time,runq_sz,plist_sz,ldavg_1,ldavg_5,ldavg_15 from (select *,row_number() over (partition by server_id order by ldavg_15 desc) from sar_load where s_date=current_date-1) t where row_number=1 order by ldavg_15 desc limit 10;" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n2. rtps TOP10 :\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select get_info(server_id),get_ip(server_id),s_date,s_time,tps,rtps,wtps,bread_p_s,bwrtn_p_s from (select *,row_number() over (partition by server_id order by rtps desc) from sar_io where s_date=current_date-1) t where row_number=1 order by rtps desc limit 10;" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n3. wtps TOP10 :\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select get_info(server_id),get_ip(server_id),s_date,s_time,tps,rtps,wtps,bread_p_s,bwrtn_p_s from (select *,row_number() over (partition by server_id order by wtps desc) from sar_io where s_date=current_date-1) t where row_number=1 order by wtps desc limit 10;" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n4. iowait TOP10 :\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select get_info(server_id),get_ip(server_id),s_date,s_time,percnt_user,percnt_nice,percnt_system,percnt_iowait,percnt_steal,percnt_idle from (select *,row_number() over (partition by server_id order by percnt_iowait desc) from sar_cpu where s_date=current_date-1) t where row_number=1 order by percnt_iowait desc limit 10;" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n5. swap_page_in_out TOP10 :\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select get_info(server_id),get_ip(server_id),s_date,s_time,pswpin_p_s,pswpout_p_s from (select *,row_number() over (partition by server_id order by pswpin_p_s+pswpout_p_s desc) from sar_swap where s_date=current_date-1) t where row_number=1 order by pswpin_p_s+pswpout_p_s desc limit 10;" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n6. swap_usage TOP10 :\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select get_info(server_id),get_ip(server_id),s_date,s_time,kbmemfree,kbmemused,percnt_memused,kbbuffers,kbcached,kbswpfree,kbswpused,percnt_swpused,kbswpcad from (select *,row_number() over (partition by server_id order by percnt_swpused desc) from sar_mem_swap where s_date=current_date-1) t where row_number=1 order by percnt_swpused desc limit 10;" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n7. newproc_p_s TOP10 :\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select get_info(server_id),get_ip(server_id),s_date,s_time,proc_p_s from (select *,row_number() over (partition by server_id order by proc_p_s desc) from sar_proc where s_date=current_date-1) t where row_number=1 order by proc_p_s desc limit 10;" &gt;&gt;/tmp/sar_report.log<br><br>echo -e "\n---- get_server_nodata_yesterday: ----\n" &gt;&gt;/tmp/sar_report.log<br>psql -h 127.0.0.1 sar sar -c "select * from get_server_nodata_yesterday();" &gt;&gt;/tmp/sar_report.log</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >cat /tmp/sar_report.log|mutt -s "`date +$F` DB Servers RS Consume Top10" $EMAIL</font></div></div><div><font size="2"  ># Author : Digoal.Zhou</font></div><div><font size="2"  ># THE END</font></div><p></p></pre></div><div>配置mutt环境, 假设数据库编码为UTF-8, 否则中文可能出错.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >vi ~/.muttrc</font></div><div><div><font size="2"  >set envelope_from=yes</font></div><div><font size="2"  >set from=digoal@126.com</font></div><div><font size="2"  >set realname="德哥"</font></div><div><font size="2"  >set use_from=yes</font></div><div><font size="2"  >set charset="UTF-8"</font></div></div><p></p></pre></div><div>六、其他,&nbsp;</div><div>1. 展现可以通过WEB形式来做, 这里只是举了个简单的收集和统计的例子, 未设计WEB开发.</div><div>2. 1000台服务器一天收集的这些sar日志数据量约200MB. 按照现在的硬盘容量, 放几年没问题.&nbsp;</div><div>【参考】</div><div>man sar</div></div>
	</div>
</div>
</body>
</html>