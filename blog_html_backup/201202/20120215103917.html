<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL add columns to pg_stat_database : dead lock & tempfile statistics</h2>
	<h5 id="">2012-02-15 10:39:17&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201211510188953/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL &nbsp;在 pg_stat_database中添加了deadlock和tempfile 文件使用个数和SIZE的统计。目前两个补丁已经处于committed状态。</div><div>如图 :&nbsp;</div><div><div><img title="PostgreSQL add columns to pg_stat_database : dead lock  tempfile statistics - 德哥@Digoal - The Heart,The World."  alt="PostgreSQL add columns to pg_stat_database : dead lock  tempfile statistics - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img6.ph.126.net/6MaQC4lH5Xd9pd_nKMSovg==/2700752401556003306.jpg"  ></div>&nbsp;</div>2012-1-26日, 关于在pg_stat_database中添加deadlock的计数的补丁已经committed.<wbr><div>下面在PostgreSQL 9.2的当前开发版本中测试 :&nbsp;</div><div>新建测试数据 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create table t1(id int primary key,info text);</font></div><div><font size="2"  >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "t1_pkey" for table "t1"</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >digoal=&gt; create table t2(id int primary key,info text);</font></div><div><font size="2"  >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "t2_pkey" for table "t2"</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >digoal=&gt; insert into t1 select generate_series(1,100),'digoal';</font></div><div><font size="2"  >INSERT 0 100</font></div><div><font size="2"  >digoal=&gt; insert into t2 select generate_series(1,100),'digoal';</font></div><div><font size="2"  >INSERT 0 100</font></div><p></p></pre></div><div><br></div><div># SESSION A :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; begin;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >digoal=&gt; update t1 set info='DIGOAL' where id=1;</font></div><div><font size="2"  >UPDATE 1</font></div><p></p></pre></div><div><br></div><div># SESSION B :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; begin;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >digoal=&gt; update t2 set info='DIGOAL' where id=1;</font></div><div><font size="2"  >UPDATE 1</font></div></div><div><div><font size="2"  >digoal=&gt; update t1 set info='DIGOAL' where id=1;</font></div><div><font size="2"  >UPDATE 1</font></div></div><p></p></pre></div><div><br></div><div># SESSION A :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; update t2 set info='DIGOAL' where id=1;</font></div><div><font size="2"  >ERROR: &nbsp;deadlock detected</font></div><div><font size="2"  >DETAIL: &nbsp;Process 25435 waits for ShareLock on transaction 1693; blocked by process 25534.</font></div><div><font size="2"  >Process 25534 waits for ShareLock on transaction 1692; blocked by process 25435.</font></div><div><font size="2"  >HINT: &nbsp;See server log for query details.</font></div><p></p></pre></div><div>检测到死锁一次 :&nbsp;</div><div>看看pg_stat_database中的deadlocks统计信息, 已经统计到了这次死锁检测 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select datname,deadlocks from pg_stat_database where datname='digoal';</font></div><div><font size="2"  >&nbsp;datname | deadlocks&nbsp;</font></div><div><font size="2"  >---------+-----------</font></div><div><font size="2"  >&nbsp;digoal &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><p></p></pre></div><div><br></div></div><div><br></div><div>下面来测试templfile的统计信息 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create table pg92_test (id int);</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >digoal=&gt; insert into pg92_test select generate_series(1,200000);</font></div><div><font size="2"  >INSERT 0 200000</font></div><div><font size="2"  >digoal=&gt; select pg_relation_size('pg92_test');</font></div><div><font size="2"  >&nbsp;pg_relation_size&nbsp;</font></div><div><font size="2"  >------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 7249920</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; show work_mem;</font></div><div><font size="2"  >&nbsp;work_mem&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;1MB</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; select datname,temp_files,temp_bytes from pg_stat_database where datname='digoal';</font></div><div><font size="2"  >&nbsp;datname | temp_files | temp_bytes&nbsp;</font></div><div><font size="2"  >---------+------------+------------</font></div><div><font size="2"  >&nbsp;digoal &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; select * from pg92_test order by id;</font></div><p></p></pre></div><div>... 结果略 ...&nbsp;</div><div><br></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select datname,temp_files,temp_bytes from pg_stat_database where datname='digoal';</font></div><div><font size="2"  >&nbsp;datname | temp_files | temp_bytes&nbsp;</font></div><div><font size="2"  >---------+------------+------------</font></div><div><font size="2"  >&nbsp;digoal &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;2801664</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; select * from pg92_test order by id;</font></div><p></p></pre></div><div>... 结果略 ...&nbsp;</div><div><br></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select datname,temp_files,temp_bytes from pg_stat_database where datname='digoal';</font></div><div><font size="2"  >&nbsp;datname | temp_files | temp_bytes&nbsp;</font></div><div><font size="2"  >---------+------------+------------</font></div><div><font size="2"  >&nbsp;digoal &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp;5603328</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; set work_mem='100MB';</font></div><div><font size="2"  >SET</font></div><div><font size="2"  >digoal=&gt; select * from pg92_test order by id;</font></div><p></p></pre></div><div>... 结果略 ...&nbsp;</div><div><br></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select datname,temp_files,temp_bytes from pg_stat_database where datname='digoal';</font></div><div><font size="2"  >&nbsp;datname | temp_files | temp_bytes&nbsp;</font></div><div><font size="2"  >---------+------------+------------</font></div><div><font size="2"  >&nbsp;digoal &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp;5603328</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div></div><div><br></div><div>看看执行计划 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><div style="line-height: 22px;"  ><font size="2"  >digoal=&gt; set work_mem='100MB';</font></div><div style="line-height: 22px;"  ><font size="2"  >SET</font></div></div><div><div><font size="2"  >digoal=&gt; explain (analyze,timing) select * from pg92_test order by id ;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Sort &nbsp;(cost=20494.64..20994.64 rows=200000 width=4) (actual time=328.811..476.721 rows=200000 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp;Sort Key: id</font></div><div><font size="2"  >&nbsp; &nbsp;Sort Method: quicksort &nbsp;Memory: 15520kB</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on pg92_test &nbsp;(cost=0.00..2885.00 rows=200000 width=4) (actual time=0.017..158.621 rows=200000 loops=1)</font></div><div><font size="2"  >&nbsp;Total runtime: 624.558 ms</font></div><div><font size="2"  >(5 rows)</font></div></div><p></p></pre></div></div><div><div>当work_mem=100MB时, 使用内存排序.</div><div><br></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; set work_mem='1MB';</font></div><div><font size="2"  >SET</font></div><div><font size="2"  >digoal=&gt; explain (analyze,timing) select * from pg92_test order by id ;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Sort &nbsp;(cost=22449.64..22949.64 rows=200000 width=4) (actual time=434.774..596.784 rows=200000 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp;Sort Key: id</font></div><div><font size="2"  >&nbsp; &nbsp;Sort Method: external sort &nbsp;Disk: 2736kB</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on pg92_test &nbsp;(cost=0.00..2885.00 rows=200000 width=4) (actual time=0.017..165.751 rows=200000 loops=1)</font></div><div><font size="2"  >&nbsp;Total runtime: 743.505 ms</font></div><div><font size="2"  >(5 rows)</font></div><p></p></pre></div></div><div><span style="line-height: 22px;"  >当work_mem=1MB时, 使用tempfile排序.</span> </div><div><br></div><div>【小结】</div><div>1. 从deadlock的统计信息可以看出应用系统设计的问题.</div><div>2. 从tempfile的统计信息可以看出work_mem分配是否合理, 是否有需要加索引的表.</div></div>
	</div>
</div>
</body>
</html>