<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">How to control who can see PostgreSQL function's source code</h2>
	<h5 id="">2015-02-09 9:52:01&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020151993632304/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>函数内容比较敏感时, 如何提高函数内容的隐射或安全性呢?</div><div>1. 可以使用加密函数的方法来提高安全性. 需要安装额外的插件.</div><div>2. 可以使用C函数, 用户无法看到函数内容.</div><div>3. 如果以上方法无法在你的生产环境实施的话, 那么可以通过控制pg_proc的权限来控制谁可以看到函数内容.</div><div>例如, 我们这里创建一个测试函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create or replace function f() returns int as $$</font></div><div><font size="2"   >postgres$# declare</font></div><div><font size="2"   >postgres$# &nbsp;a int := 10;</font></div><div><font size="2"   >postgres$# begin</font></div><div><font size="2"   >postgres$# &nbsp;return a;</font></div><div><font size="2"   >postgres$# end;</font></div><div><font size="2"   >postgres$# $$ language plpgsql;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><p></p></pre></div><div>函数内容存在pg_proc.prosrc字段中.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select prosrc from pg_proc where proname='f';</font></div><div><font size="2"   >&nbsp; &nbsp; prosrc &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;declare &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; a int := 10;+</font></div><div><font size="2"   >&nbsp;begin &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; return a; &nbsp; +</font></div><div><font size="2"   >&nbsp;end; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>创建一个普通用户, 因为pg_proc的权限给public角色了, 所以普通用户也可以查询到它的内容.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create role test login;</font></div><div><font size="2"   >CREATE ROLE</font></div><div><font size="2"   >postgres=# \c postgres test</font></div><div><font size="2"   >You are now connected to database "postgres" as user "test".</font></div><div><font size="2"   >postgres=&gt; select prosrc from pg_proc where proname='f';</font></div><div><font size="2"   >&nbsp; &nbsp; prosrc &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;declare &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; a int := 10;+</font></div><div><font size="2"   >&nbsp;begin &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; return a; &nbsp; +</font></div><div><font size="2"   >&nbsp;end; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>仅仅回收prosrc字段的权限是不够的, 为什么呢? 参考</div><div><a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/sql-revoke.html"   >http://www.postgresql.org/docs/9.4/static/sql-revoke.html</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; \c postgres postgres</font></div><div><font size="2"   >You are now connected to database "postgres" as user "postgres".</font></div><div><font size="2"   >postgres=# revoke select(prosrc) on pg_proc from public;</font></div><div><font size="2"   >REVOKE</font></div><div><font size="2"   >postgres=# \c postgres test</font></div><div><font size="2"   >You are now connected to database "postgres" as user "test".</font></div><div><font size="2"   >postgres=&gt; select prosrc from pg_proc where proname='f';</font></div><div><font size="2"   >&nbsp; &nbsp; prosrc &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;declare &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; a int := 10;+</font></div><div><font size="2"   >&nbsp;begin &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; return a; &nbsp; +</font></div><div><font size="2"   >&nbsp;end; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>将pg_proc的权限从public回收即可.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; \c postgres postgres</font></div><div><font size="2"   >You are now connected to database "postgres" as user "postgres".</font></div><div><font size="2"   >postgres=# revoke select on pg_proc from public;</font></div><div><font size="2"   >REVOKE</font></div><div><font size="2"   >postgres=# \c postgres test</font></div><div><font size="2"   >You are now connected to database "postgres" as user "test".</font></div><div><font size="2"   >postgres=&gt; select prosrc from pg_proc where proname='f';</font></div><div><font size="2"   >ERROR: &nbsp;permission denied for relation pg_proc</font></div><div><font size="2"   >postgres=&gt; select proname from pg_proc where proname='f';</font></div><div><font size="2"   >ERROR: &nbsp;permission denied for relation pg_proc</font></div><p></p></pre></div><div>但是这样做的话, 所有的普通用户都没有了查询权限, 包括不能列出函数名.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; \c postgres postgres</font></div><div><font size="2"   >You are now connected to database "postgres" as user "postgres".</font></div><div><font size="2"   >postgres=# \du</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of roles</font></div><div><font size="2"   >&nbsp;Role name | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Attributes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Member of&nbsp;</font></div><div><font size="2"   >-----------+------------------------------------------------+-----------</font></div><div><font size="2"   >&nbsp;d &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {}</font></div><div><font size="2"   >&nbsp;postgres &nbsp;| Superuser, Create role, Create DB, Replication | {}</font></div><div><font size="2"   >&nbsp;test &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {}</font></div><div><div><font size="2"   >postgres=&gt; \df</font></div><div><font size="2"   >ERROR: &nbsp;permission denied for relation pg_proc</font></div></div><p></p></pre></div><div>其他普通用户, 需要查询函数名, 必须赋予pg_proc的查询权限.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# grant select on pg_proc to d;</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >postgres=# \c postgres d</font></div><div><font size="2"   >You are now connected to database "postgres" as user "d".</font></div><div><font size="2"   >postgres=&gt; select prosrc from pg_proc where proname='f';</font></div><div><font size="2"   >&nbsp; &nbsp; prosrc &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;declare &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; a int := 10;+</font></div><div><font size="2"   >&nbsp;begin &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; return a; &nbsp; +</font></div><div><font size="2"   >&nbsp;end; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>这样就控制了某个用户没有查询函数, 函数内容的权限.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; \c postgres test</font></div><div><font size="2"   >You are now connected to database "postgres" as user "test".</font></div><div><font size="2"   >postgres=&gt; select prosrc from pg_proc where proname='f';</font></div><div><font size="2"   >ERROR: &nbsp;permission denied for relation pg_proc</font></div><p></p></pre></div></div><div>如果要做到可以列出函数名, 但是不能查询函数内容. 怎么做呢?</div><div>首先我们要知道列函数用到什么QUERY</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@localhost-&gt; psql -E</font></div><div><div><font size="2"   >postgres=&gt; \df</font></div><div><font size="2"   >********* QUERY **********</font></div><div><font size="2"   >SELECT n.nspname as "Schema",</font></div><div><font size="2"   >&nbsp; p.proname as "Name",</font></div><div><font size="2"   >&nbsp; pg_catalog.pg_get_function_result(p.oid) as "Result data type",</font></div><div><font size="2"   >&nbsp; pg_catalog.pg_get_function_arguments(p.oid) as "Argument data types",</font></div><div><font size="2"   >&nbsp;CASE</font></div><div><font size="2"   >&nbsp; WHEN p.proisagg THEN 'agg'</font></div><div><font size="2"   >&nbsp; WHEN p.proiswindow THEN 'window'</font></div><div><font size="2"   >&nbsp; WHEN p.prorettype = 'pg_catalog.trigger'::pg_catalog.regtype THEN 'trigger'</font></div><div><font size="2"   >&nbsp; ELSE 'normal'</font></div><div><font size="2"   >&nbsp;END as "Type"</font></div><div><font size="2"   >FROM pg_catalog.pg_proc p</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LEFT JOIN pg_catalog.pg_namespace n ON n.oid = p.pronamespace</font></div><div><font size="2"   >WHERE pg_catalog.pg_function_is_visible(p.oid)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; AND n.nspname &lt;&gt; 'pg_catalog'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; AND n.nspname &lt;&gt; 'information_schema'</font></div><div><font size="2"   >ORDER BY 1, 2, 4;</font></div><div><font size="2"   >**************************</font></div><div><font size="2"   >ERROR: &nbsp;permission denied for relation pg_proc</font></div></div><p></p></pre></div><div>那么需要将除prosrc以外的所有字段(包括oid)都赋予给test用户即可.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# grant select(oid,proname,pronamespace,proowner,prolang,procost,prorows,provariadic,protransform,proisagg,proiswindow,prosecdef,proleakproof,proisstrict,proretset,provolatile,pronargs,pronargdefaults,prorettype,proargtypes,proallargtypes,proargmodes,proargnames,proargdefaults,probin,proconfig,proacl) on pg_proc to test;</font></div><div><font size="2"   >GRANT</font></div></div><div><div><font size="2"   >postgres=# \c postgres test</font></div><div><font size="2"   >You are now connected to database "postgres" as user "test".</font></div></div><p></p></pre></div><div>现在test用户可以列函数名, 但是不能看函数内容了.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=&gt; select proname from pg_proc limit 1;</font></div><div><font size="2"   >&nbsp;proname&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;boolin</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=&gt; select prosrc from pg_proc limit 1;</font></div><div><font size="2"   >ERROR: &nbsp;permission denied for relation pg_proc</font></div><div><font size="2"   >postgres=&gt;&nbsp;<span style="line-height: 28px;"   >\df</span></font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of functions</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; Result data type &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Argument data types &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;Type &nbsp;</font></div><div><font size="2"   >--------+-------------------------+---------------------------+---------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >--------------------------------------------------------+--------</font></div><div><font size="2"   >&nbsp;public | dblink &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| SETOF record &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | normal</font></div><div><font size="2"   >&nbsp;public | dblink &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| SETOF record &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| text, boolean</font></div></div><p></p></pre></div><div>但是, 别高兴太早, 函数的内容不是这么查出来的, 而是通过pg_get_functiondef(oid)系统函数来获取的, 所以还需要回收这个系统函数的权限.</div><div>在回收权限前.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=&gt; select * from pg_get_functiondef(16649);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pg_get_functiondef &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------------------------</font></div><div><font size="2"   >&nbsp;CREATE OR REPLACE FUNCTION public.f()+</font></div><div><font size="2"   >&nbsp; RETURNS integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp; LANGUAGE plpgsql &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;AS $function$ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;declare &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; a int := 10; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;begin &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; return a; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;end; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;$function$ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >postgres=&gt; \sf f</font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION public.f()</font></div><div><font size="2"   >&nbsp;RETURNS integer</font></div><div><font size="2"   >&nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp;a int := 10;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp;return a;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$function$</font></div></div><p></p></pre></div><div>回收权限后</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# revoke execute on function pg_get_functiondef(oid) from public;</font></div><div><font size="2"   >REVOKE</font></div><div><div><font size="2"   >postgres=&gt; \c postgres postgres</font></div><div><font size="2"   >You are now connected to database "postgres" as user "postgres".</font></div><div><font size="2"   >postgres=# select oid from pg_proc where proname='f';</font></div><div><font size="2"   >&nbsp; oid &nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;16649</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >postgres=# \c postgres test</font></div><div><font size="2"   >You are now connected to database "postgres" as user "test".</font></div><div><font size="2"   >postgres=&gt; \sf f</font></div><div><font size="2"   >ERROR: &nbsp;permission denied for function pg_get_functiondef</font></div></div><div><div><font size="2"   >postgres=&gt; select * from pg_get_functiondef(16649);</font></div><div><font size="2"   >ERROR: &nbsp;permission denied for function pg_get_functiondef</font></div></div><p></p></pre></div><div><br></div><div>[小结]</div><div>通过权限来控制普通用户是否有查看函数内容的权限方法.&nbsp;</div><div>第三步对于不同的PostgreSQL版本可能不一样, 请注意.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >1. revoke select on pg_proc from public;</font></div><div><font size="2"   >2. grant select on&nbsp;<span style="line-height: 28px;"   >pg_proc</span><span style="line-height: 28px;"   >&nbsp;to 需要查看函数内容权限的普通用户;</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   >3. grant select(oid,</span>proname,pronamespace,proowner,prolang,procost,prorows,provariadic,protransform,proisagg,proiswindow,prosecdef,proleakproof,proisstrict,proretset,provolatile,pronargs,pronargdefaults,prorettype,proargtypes,proallargtypes,proargmodes,proargnames,proargdefaults,probin,proconfig,proacl) on pg_proc to 不<span style="line-height: 28px;"   >需要查看函数内容权限的普通用户;</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   >4. revoke select(prosrc)&nbsp;</span><span style="line-height: 28px;"   >on pg_proc from 不</span><span style="line-height: 28px;"   >需要查看函数内容权限的普通用户;</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   >5. </span></font></div><div><font size="2"   >postgres=# revoke execute on function pg_get_functiondef(oid) from public;<br>REVOKE</font></div><div><font size="2"   >6. </font></div><div><font size="2"   >postgres=# grant execute on function pg_get_functiondef(oid) to 需要查看函数内容权限的普通用户;</font></div><p></p></pre></div><div>目前PostgreSQL在对象权限这块控制还是过于粗燥, 不像Oracle做得很细, 用户间的权限控制是非常严格的.</div><div>而Postgres-XL则做了一定的修改, 是在parser层面做的, 可参考 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201462552243293/"   >http://blog.163.com/digoal@126/blog/static/163877040201462552243293/</a></div><div>这也是一个路子.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/sql-revoke.html"   >http://www.postgresql.org/docs/9.4/static/sql-revoke.html</a></div><div>&nbsp; &nbsp; When revoking privileges on a table, the corresponding column privileges (if any) are automatically revoked on each column of the table, as well. On the other hand, if a role has been granted privileges on a table, then revoking the same privileges from individual columns will have no effect.</div><div><br></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.cybertec.at/en/products/plpgsql_sec-encrypt-your-stored-procedure-codes/"   >http://www.cybertec.at/en/products/plpgsql_sec-encrypt-your-stored-procedure-codes/</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="How to control who can see PostgreSQL functions source code - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>