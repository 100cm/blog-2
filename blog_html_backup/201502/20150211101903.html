<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">attention: use zfs clone filesystem for SOX audit use case.</h2>
	<h5 id="">2015-02-11 10:19:03&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201511110844812/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">在进行SOX审计时, 可能需要用到生产数据库进行审查操作, 一般我们可以用PostgreSQL流复制创建一个standby给审计人员使用.<div>如果线上本来用的就是master-slave模式的HA, 那么备机就可以直接给他们使用.</div><div>master-slave HA方案参考</div><div><a target="_blank" rel="nofollow" href="https://github.com/digoal/PostgreSQL_HA_with_primary_standby_2vip"   >https://github.com/digoal/PostgreSQL_HA_with_primary_standby_2vip</a></div><div>但是这里也有一个问题, standby仅仅支持只读, 不能写数据, 审计过程可能需要一些中间结果需要保存, 所以纯粹的standby可能不适用.</div><div>为什么standby连temp表都不能用呢?</div><div>这里解释得非常清楚, 因为standby不能申请新的XID, 显然和这一项相关的太多了, 包括临时表在内, 都是无法使用的.</div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/hot-standby.html"   >http://www.postgresql.org/docs/9.4/static/hot-standby.html</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Transactions started during hot standby will never be assigned a transaction ID and cannot write to the system write-ahead log. Therefore, the following actions will produce error messages:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Data Manipulation Language (DML) - INSERT, UPDATE, DELETE, COPY FROM, TRUNCATE. Note that there are no allowed actions that result in a trigger being executed during recovery. This restriction applies even to temporary tables, because table rows cannot be read or written without assigning a transaction ID, which is currently not possible in a Hot Standby environment.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Data Definition Language (DDL) - CREATE, DROP, ALTER, COMMENT. This restriction applies even to temporary tables, because carrying out these operations would require updating the system catalog tables.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SELECT ... FOR SHARE | UPDATE, because row locks cannot be taken without updating the underlying data files.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Rules on SELECT statements that generate DML commands.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >LOCK that explicitly requests a mode higher than ROW EXCLUSIVE MODE.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >LOCK in short default form, since it requests ACCESS EXCLUSIVE MODE.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Transaction management commands that explicitly set non-read-only state:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >BEGIN READ WRITE, START TRANSACTION READ WRITE</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SET TRANSACTION READ WRITE, SET SESSION CHARACTERISTICS AS TRANSACTION READ WRITE</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SET transaction_read_only = off</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Two-phase commit commands - PREPARE TRANSACTION, COMMIT PREPARED, ROLLBACK PREPARED because even read-only transactions need to write WAL in the prepare phase (the first phase of two phase commit).</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Sequence updates - nextval(), setval()</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >LISTEN, UNLISTEN, NOTIFY</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >In normal operation, "read-only" transactions are allowed to update sequences and to use LISTEN, UNLISTEN, and NOTIFY, so Hot Standby sessions operate under slightly tighter restrictions than ordinary read-only sessions. It is possible that some of these restrictions might be loosened in a future release.</font></div><p></p></pre></div><div>那么问题来了, 怎样能够快速的为审计提供环境呢?</div><div>假使我们的数据库存储用了ZFS的话, 一切就简单了.</div><div>我们只需要创建快照, 克隆, 修改一些参数和配置即可. 但是务必注意配置要调整对, 否则可能破坏原有的数据库.</div><div>1. 软链接</div><div>2. 归档, 日志, 端口等.</div><div><br></div><div>过程简介, 在一个STANDBY主机上克隆一个读写数据库.</div><div>首选停一下备库(不停也可以, 那么就先快照$PGDATA所在目录),&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >$ pg_ctl stop -m fast</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >创建快照</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># zfs snapshot zp1/data01@20150211</font></div><div><font size="2"   ># zfs snapshot zp1/data02@20150211</font></div><div><font size="2"   ># zfs snapshot zp1/data03@20150211</font></div><p></p></pre></div><div>克隆</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># zfs clone -o mountpoint=/aud_data01 zp1/data01@20150211 zp1/aud_data01</font></div><div><font size="2"   ># zfs clone -o mountpoint=/aud_data02 zp1/data02@20150211 zp1/aud_data02</font></div><div><font size="2"   ># zfs clone -o mountpoint=/aud_data03 zp1/data03@20150211 zp1/aud_data03</font></div><p></p></pre></div><div>修改配置</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >$ cd /aud_data02/pgdata/digoal/pg_root/</font></div><div><font size="2"   >$ vi postgresql.conf</font></div><div><font size="2"   >port = 1922</font></div><div><font size="2"   >wal_level = minimal</font></div><div><font size="2"   >archive_mode = off</font></div><div><font size="2"   >max_wal_senders = 0</font></div><div><font size="2"   >log_directory = 'pg_log'</font></div><p></p></pre></div><div>重命名recovery.conf</div><pre class="prettyprint"   ><p></p><div><font size="2"   >$ mv&nbsp;recovery.conf recovery.done</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >修改软链接</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >$ rm -f pg_xlog</font></div><div><font size="2"   >$ ln -s /aud_data01/pgdata/pg_xlog ./pg_xlog</font></div><div><font size="2"   >$ cd pg_tblspc/</font></div><div><font size="2"   >$ rm -f *</font></div><p></p></pre></div><div>$ 将克隆出来的表空间目录软链接至此</div><div>启动数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >$ pg_ctl start -D&nbsp;<span style="line-height: 28px;"   >/aud_data02/pgdata/pg_root</span></font></div><div></div><p></p></pre></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="attention: use zfs clone filesystem for SOX audit use case. - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>