<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">psql ExecQueryUsingCursor when set fetch_count >0 and is_select_command</h2>
	<h5 id="">2014-10-08 8:25:01&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020149881435701/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>默认情况下, psql在执行一个SELECT查询时, 是将所有的结果集载入内存后再打印结果的(所以在返回结果前, 这条SQL肯定是执行成功的).</div><div>如果设置了psql的变量FETCH_COUNT大于0的话, 那么psql将使用游标来批量获取以及返回结果. (当然这种情况可能导致最后失败的情况.但是对于大结果集的查询来说, 这样做可以避免内存溢出)</div><div>FETCH_COUNT变量的说明如下 :&nbsp;</div><div><div style="line-height: 28px;"   >man psql</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FETCH_COUNT</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;If this variable is set to an integer value &gt; 0, the results of SELECT queries are fetched and</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;displayed in groups of that many rows, rather than the default behavior of collecting the entire result</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;set before display. Therefore only a limited amount of memory is used, regardless of the size of the</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;result set. Settings of 100 to 1000 are commonly used when enabling this feature. Keep in mind that</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;when using this feature, a query might fail after having already displayed some rows.</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Tip</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Although you can use any output format with this feature, the default aligned format tends to look</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bad because each group of FETCH_COUNT rows will be formatted separately, leading to varying column</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;widths across the row groups. The other output formats work better.</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >使用方法:</div></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-221-&gt; psql</font></div><div><font size="2"   >psql (9.3.5)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \echo :FETCH_COUNT</font></div><div><font size="2"   >:FETCH_COUNT</font></div><div><font size="2"   >digoal=# \set FETCH_COUNT 10</font></div><div><font size="2"   >digoal=# \echo :FETCH_COUNT</font></div><div><font size="2"   >10</font></div><p></p></pre></div></div><div><br></div><div>大结果集查询的应用, 例如查询这个344MB的大表.&nbsp;</div><div>设置FETCH_COUNT&gt;0后查询很快就返回结果, 如果不设置的话, 需要等比较久才返回结果.</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >digoal=# \set FETCH_COUNT 10</font></span></div><div><div><font size="2"   >digoal=# \dt+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp;Name &nbsp; &nbsp;| Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp;Size &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+------------+-------+----------+--------+-------------</font></div><div><font size="2"   >&nbsp;public | test_table | table | postgres | 344 MB |&nbsp;</font></div></div><div><div><font size="2"   >digoal=# \timing</font></div><div><font size="2"   >Timing is on.</font></div></div><div><div><font size="2"   >digoal=# select * from test_table;</font></div><div><font size="2"   >很快就返回结果</font></div><div><font size="2"   >&nbsp;id | val&nbsp;</font></div><div><font size="2"   >----+-----</font></div><div><font size="2"   >&nbsp; 1 | 234</font></div><div><font size="2"   >&nbsp; 2 | 496</font></div><div><font size="2"   >&nbsp; 3 | 306</font></div><div><font size="2"   >&nbsp; 4 | 352</font></div><div><font size="2"   >&nbsp; 5 | 688</font></div><div><font size="2"   >&nbsp; 6 | 846</font></div><div><font size="2"   >&nbsp; 7 | 629</font></div><div><font size="2"   >&nbsp; 8 | 616</font></div><div><font size="2"   >&nbsp; 9 | 236</font></div><div><font size="2"   >&nbsp;10 | 491</font></div><div><font size="2"   >&nbsp;11 | 546</font></div><div><font size="2"   >&nbsp;12 | 197</font></div><div><font size="2"   >&nbsp;13 | &nbsp;37</font></div><div><font size="2"   >&nbsp;14 | &nbsp;78</font></div><div><font size="2"   >&nbsp;15 | 287</font></div><div><font size="2"   >&nbsp;16 | 464</font></div><div><font size="2"   >&nbsp;17 | 641</font></div><div><font size="2"   >&nbsp;18 | 378</font></div><div><font size="2"   >&nbsp;19 | &nbsp;81</font></div><div><font size="2"   >&nbsp;20 | 409</font></div><div><font size="2"   >&nbsp;21 | 309</font></div><div><font size="2"   >&nbsp;22 | 266</font></div><div><font size="2"   >&nbsp;23 | 379</font></div><div><font size="2"   >&nbsp;24 | 160</font></div><div><font size="2"   >&nbsp;25 | 531</font></div><div><font size="2"   >&nbsp;26 | 849</font></div><div><font size="2"   >&nbsp;27 | &nbsp;36</font></div><div><font size="2"   >&nbsp;28 | 660</font></div><div><font size="2"   >&nbsp;29 | &nbsp;44</font></div><div><font size="2"   >&nbsp;30 | 690</font></div><div><font size="2"   >&nbsp;31 | 196</font></div><div><font size="2"   >&nbsp;32 | 278</font></div><div><font size="2"   >&nbsp;33 | 186</font></div><div><font size="2"   >&nbsp;34 | 502</font></div><div><font size="2"   >&nbsp;35 | 630</font></div><div><font size="2"   >&nbsp;36 | 874</font></div><div><font size="2"   >q (退出查询)</font></div><div><font size="2"   >Time: 27.886 ms</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# \set FETCH_COUNT 0</font></div><div><font size="2"   >digoal=# select * from test_table;</font></div><div><font size="2"   >等了几秒才开始返回结果</font></div><div><font size="2"   >&nbsp;id &nbsp;| val &nbsp;</font></div><div><font size="2"   >-----+------</font></div><div><font size="2"   >&nbsp; &nbsp;1 | &nbsp;234</font></div><div><font size="2"   >&nbsp; &nbsp;2 | &nbsp;496</font></div><div><font size="2"   >&nbsp; &nbsp;3 | &nbsp;306</font></div><div><font size="2"   >&nbsp; &nbsp;4 | &nbsp;352</font></div><div><font size="2"   >&nbsp; &nbsp;5 | &nbsp;688</font></div><div><font size="2"   >&nbsp; &nbsp;6 | &nbsp;846</font></div><div><font size="2"   >&nbsp; &nbsp;7 | &nbsp;629</font></div><div><font size="2"   >&nbsp; &nbsp;8 | &nbsp;616</font></div><div><font size="2"   >&nbsp; &nbsp;9 | &nbsp;236</font></div><div><font size="2"   >&nbsp; 10 | &nbsp;491</font></div><div><font size="2"   >&nbsp; 11 | &nbsp;546</font></div><div><font size="2"   >&nbsp; 12 | &nbsp;197</font></div><div><font size="2"   >&nbsp; 13 | &nbsp; 37</font></div><div><font size="2"   >&nbsp; 14 | &nbsp; 78</font></div><div><font size="2"   >&nbsp; 15 | &nbsp;287</font></div><div><font size="2"   >&nbsp; 16 | &nbsp;464</font></div><div><font size="2"   >&nbsp; 17 | &nbsp;641</font></div><div><font size="2"   >&nbsp; 18 | &nbsp;378</font></div><div><font size="2"   >&nbsp; 19 | &nbsp; 81</font></div><div><font size="2"   >&nbsp; 20 | &nbsp;409</font></div><div><font size="2"   >&nbsp; 21 | &nbsp;309</font></div><div><font size="2"   >&nbsp; 22 | &nbsp;266</font></div><div><font size="2"   >&nbsp; 23 | &nbsp;379</font></div><div><font size="2"   >&nbsp; 24 | &nbsp;160</font></div><div><font size="2"   >&nbsp; 25 | &nbsp;531</font></div><div><font size="2"   >&nbsp; 26 | &nbsp;849</font></div><div><font size="2"   >&nbsp; 27 | &nbsp; 36</font></div><div><font size="2"   >&nbsp; 28 | &nbsp;660</font></div><div><font size="2"   >&nbsp; 29 | &nbsp; 44</font></div><div><font size="2"   >&nbsp; 30 | &nbsp;690</font></div><div><font size="2"   >&nbsp; 31 | &nbsp;196</font></div><div><font size="2"   >&nbsp; 32 | &nbsp;278</font></div><div><font size="2"   >&nbsp; 33 | &nbsp;186</font></div><div><font size="2"   >&nbsp; 34 | &nbsp;502</font></div><div><font size="2"   >&nbsp; 35 | &nbsp;630</font></div><div><font size="2"   >&nbsp; 36 | &nbsp;874</font></div><div><font size="2"   >q (退出查询)</font></div><div><font size="2"   >Time: 4331.564 ms (耗时包括查询耗时, 但是不包括返回结果耗时)</font></div></div><p></p></pre></div><div><br></div><div>psql定义的内部变量如下, 详细的使用说明参考man psql :&nbsp;</div><div>src/bin/psql/startup.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >static void</font></div><div><font size="2"   >EstablishVariableSpace(void)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; pset.vars = CreateVariableSpace();</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SetVariableAssignHook(pset.vars, "AUTOCOMMIT", autocommit_hook);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SetVariableAssignHook(pset.vars, "ON_ERROR_STOP", on_error_stop_hook);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SetVariableAssignHook(pset.vars, "QUIET", quiet_hook);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SetVariableAssignHook(pset.vars, "SINGLELINE", singleline_hook);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SetVariableAssignHook(pset.vars, "SINGLESTEP", singlestep_hook);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SetVariableAssignHook(pset.vars, "FETCH_COUNT", fetch_count_hook);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SetVariableAssignHook(pset.vars, "ECHO", echo_hook);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SetVariableAssignHook(pset.vars, "ECHO_HIDDEN", echo_hidden_hook);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SetVariableAssignHook(pset.vars, "ON_ERROR_ROLLBACK", on_error_rollback_hook);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SetVariableAssignHook(pset.vars, "HISTCONTROL", histcontrol_hook);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SetVariableAssignHook(pset.vars, "PROMPT1", prompt1_hook);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SetVariableAssignHook(pset.vars, "PROMPT2", prompt2_hook);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SetVariableAssignHook(pset.vars, "PROMPT3", prompt3_hook);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SetVariableAssignHook(pset.vars, "VERBOSITY", verbosity_hook);</font></div></div><div><font size="2"   >}</font></div><p></p></pre></div><div><br></div><div>FETCH_COUNT作用对应的代码 :&nbsp;</div><div>src/bin/psql/common.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (pset.fetch_count &lt;= 0 || !is_select_command(query))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Default fetch-it-all-and-print mode */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; instr_time &nbsp; &nbsp; &nbsp;before,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; after;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (pset.timing)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INSTR_TIME_SET_CURRENT(before);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; results = PQexec(pset.db, query);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* these operations are included in the timing result: */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ResetCancelConn();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; OK = ProcessResult(&amp;results);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (pset.timing)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INSTR_TIME_SET_CURRENT(after);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INSTR_TIME_SUBTRACT(after, before);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elapsed_msec = INSTR_TIME_GET_MILLISEC(after);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* but printing results isn't: */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (OK &amp;&amp; results)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; OK = PrintQueryResults(results);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Fetch-in-segments mode */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; OK = ExecQueryUsingCursor(query, &amp;elapsed_msec);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ResetCancelConn();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; results = NULL; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* PQclear(NULL) does nothing */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >*</font></div><div><font size="2"   >&nbsp;* ExecQueryUsingCursor: run a SELECT-like query using a cursor</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* This feature allows result sets larger than RAM to be dealt with.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Returns true if the query executed successfully, false otherwise.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* If pset.timing is on, total query time (exclusive of result-printing) is</font></div><div><font size="2"   >&nbsp;* stored into *elapsed_msec.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static bool</font></div><div><font size="2"   >ExecQueryUsingCursor(const char *query, double *elapsed_msec)</font></div><div><font size="2"   >{</font></div></div><div><font size="2"   >..............</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Send DECLARE CURSOR */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; initPQExpBuffer(&amp;buf);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; appendPQExpBuffer(&amp;buf, "DECLARE _psql_cursor NO SCROLL CURSOR FOR\n%s",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; query);</font></div></div><div><font size="2"   >........................</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; snprintf(fetch_cmd, sizeof(fetch_cmd),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"FETCH FORWARD %d FROM _psql_cursor",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fetch_count);</font></div></div><div><font size="2"   >........</font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<span style="line-height: 28px;"   >src/bin/psql/common.c</span></div><div><span style="line-height: 28px;"   >2.&nbsp;</span><span style="line-height: 28px;"   >src/bin/psql/</span><span style="line-height: 28px;"   >startup.c</span></div><div><span style="line-height: 28px;"   >3. man psql</span></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="psql ExecQueryUsingCursor when set fetch_count 0 and is_select_command - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>