<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL's protocol requires clients to send particular packet before they disconnect the connection.</h2>
	<h5 id="">2014-10-08 11:04:44&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201498104813561/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在使用pgpool-II时, 如果客户端异常退出, 可能在pgpool的日志中会产生类似ProcessFrontendResponse: failed to read kind from frontend. frontend abnormally exited的日志.&nbsp;</div><div>pool_proto_modules.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >POOL_STATUS ProcessFrontendResponse(POOL_CONNECTION *frontend,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; POOL_CONNECTION_POOL *backend)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char fkind;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char *bufp = NULL;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char *contents;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; POOL_STATUS status;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int len;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; POOL_SESSION_CONTEXT *session_context;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Get session context */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; session_context = pool_get_session_context();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!session_context)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pool_error("ProcessFrontendResponse: cannot get session context");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return POOL_END;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (pool_read_buffer_is_empty(frontend) &amp;&amp; frontend-&gt;no_forward != 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return POOL_CONTINUE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (pool_read(frontend, &amp;fkind, 1) &lt; 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pool_log("ProcessFrontendResponse: failed to read kind from frontend. frontend abnormally exited");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return POOL_END_WITH_FRONTEND_ERROR;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div><div><br></div><div><h3 style="font-weight: normal; margin: 0px 0px 0.3em; overflow: hidden; padding-top: 0.5em; padding-bottom: 0.17em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); width: auto; font-size: 17px; font-family: sans-serif; line-height: 19.2000007629395px; background-image: none; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><span id="Why_am_I_getting_.22ProcessFrontendResponse:_failed_to_read_kind_from_frontend._frontend_abnormally_exited.22_in_my_pgool_log.3F"   ><b>Why am I getting "ProcessFrontendResponse: failed to read kind from frontend. frontend abnormally exited" in my pgool log?</b></span></h3><dl style="margin-top: 0.2em; margin-bottom: 0.5em; font-family: sans-serif; font-size: 13px; line-height: 19.2000007629395px;"   ><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >Well, your clients might be ill-behaved:-) PostgreSQL's protocol requires clients to send particular packet before they disconnect the connection. pgpool-II complains that clients disconnect without sending the packet. You could reprodcude the problem by using psql. Connect to pgpool using psql. Kill -9 psql. You will silimar message in the log. The message will not appear if you quit psql normaly. Another possibility is unstable network connection between your client machine and pgpool-II. Check the cable and network interface card.</dd></dl></div><div><br></div><div>连接包也有类似的检查.</div><div>telnet 127.0.0.1 5432</div><div>日志如下 :&nbsp;</div><div>日志信息来自<span style="line-height: 28px;"   >ProcessStartupPacket, postmaster.c</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (len &lt; (int32) sizeof(ProtocolVersion) ||</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len &gt; MAX_STARTUP_PACKET_LENGTH)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(COMMERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_PROTOCOL_VIOLATION),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("invalid length of startup packet")));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return STATUS_ERROR;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2014-10-08 10:47:00.528 CST,,,27183,"",5434a5a4.6a2f,1,"",2014-10-08 10:47:00 CST,,0,LOG,00000,"connection received: host=127.0.0.1 port=49040",,,,,,,,"BackendInitialize, postmaster.c:3850",""</font></div><div><font size="2"   >2014-10-08 10:47:01.188 CST,,,27183,"127.0.0.1:49040",5434a5a4.6a2f,2,"",2014-10-08 10:47:00 CST,,0,LOG,08P01,"invalid length of startup packet",,,,,,,,"ProcessStartupPacket, postmaster.c:1744",""</font></div><p></p></pre></div>
<div><br></div><div><h3 style="font-weight: normal; margin: 0px 0px 0.3em; overflow: hidden; padding-top: 0.5em; padding-bottom: 0.17em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); width: auto; font-size: 17px; font-family: sans-serif; line-height: 19.2000007629395px; background-image: none; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><span id="I_periodically_get_error_message_like_.22read_startup_packet:_incorrect_packet_length.22._What_does_it_mean.3F"   ><b>I periodically get error message like "read_startup_packet: incorrect packet length". What does it mean?</b></span></h3><dl style="margin-top: 0.2em; margin-bottom: 0.5em; font-family: sans-serif; font-size: 13px; line-height: 19.2000007629395px;"   ><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >Monitoring tools including Zabbix and Nagios periodically sends a packet or ping to the port which pgoool is listening on. Unfortunately those packets do not have correct contents, and pgpool-II complains it. If you are not sure who is sending such a packet, you could turn on "log_connections" to know the source host and port info. If they are from such tools, you could stop the monitoring to avoid the problem or even better, change the monitoring method to send legal query, for example, "SELECT 1".</dd></dl></div><div><br></div><a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQLs protocol requires clients to send particular packet before they disconnect the connection. - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>