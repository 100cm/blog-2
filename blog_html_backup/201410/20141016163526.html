<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL in & = any (values|array)</h2>
	<h5 id="">2014-10-16 16:35:26&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020149163535754/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>查询表的某个或某些字段批量匹配, 可以有几种写法.</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >select * from t2 where id in (1,2,3,100,1000,0);</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >select * from t2 where id = ANY ('{1,2,3,100,1000,0}'::integer[]);</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >select * from t2 where id = ANY (VALUES (1),(2),(3),(100),(1000),(0));</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >select t2.* from t2 join (VALUES (1),(2),(3),(100),(1000),(0)) as t(id) on t2.id=t.id;</font></span></div><div><font size="2"   ><span style="line-height: 28px;"   >还有or的写法. &nbsp;</span><span style="line-height: 28px;"   >select * from t2 where id=1 or id=2 or id=3 ....;</span></font></div><p></p></pre></div><div><span style="line-height: 28px;"   >这里主要看一下前几种.</span></div><div><br></div><div>执行计划 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain select * from t2 where id in (1,2,3,100,1000,0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using t2_pkey on t2 &nbsp;(cost=0.29..25.82 rows=6 width=37)</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: (id = ANY ('{1,2,3,100,1000,0}'::integer[]))</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   >digoal=# explain select * from t2 where id = ANY ('{1,2,3,100,1000,0}'::integer[]);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using t2_pkey on t2 &nbsp;(cost=0.29..25.82 rows=6 width=37)</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: (id = ANY ('{1,2,3,100,1000,0}'::integer[]))</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>=any (values)会产生hash 聚合</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain select * from t2 where id = ANY (VALUES (1),(2),(3),(100),(1000),(0));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Nested Loop &nbsp;(cost=0.38..46.04 rows=6 width=37)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;HashAggregate &nbsp;(cost=0.09..0.15 rows=6 width=4)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Values Scan on "*VALUES*" &nbsp;(cost=0.00..0.08 rows=6 width=4)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Index Scan using t2_pkey on t2 &nbsp;(cost=0.29..7.64 rows=1 width=37)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (id = "*VALUES*".column1)</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div></div><div>而使用join不会产生hash 聚合.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain select t2.* from t2 join (VALUES (1),(2),(3),(100),(1000),(0)) as t(id) on t2.id=t.id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Nested Loop &nbsp;(cost=0.29..45.96 rows=6 width=37)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Values Scan on "*VALUES*" &nbsp;(cost=0.00..0.08 rows=6 width=4)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Index Scan using t2_pkey on t2 &nbsp;(cost=0.29..7.64 rows=1 width=37)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (id = "*VALUES*".column1)</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div><div>用VALUES时, 会带入一个Values Scan节点, 和seq scan, index scan等scan一样, 都属于数据扫描节点.</div><div><br></div><div>执行结果是一致的,&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from t2 where id in (1,2,3,100,1000,0);</font></div><div><font size="2"   >&nbsp; id &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------+----------------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; 1 | 07d16508c6719888fe7030354f9eb3ed</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | a190af0a3e0f62c1c210e314e2b23018</font></div><div><font size="2"   >&nbsp; &nbsp; 3 | 2ecbd5b8d321bb409d14992f234527bb</font></div><div><font size="2"   >&nbsp; 100 | 2f33507dba91ef78bd28aec7e1f52254</font></div><div><font size="2"   >&nbsp;1000 | 5964d4dba996b76360544ef6aa90ed0e</font></div><div><font size="2"   >(5 rows)</font></div><div><font size="2"   >digoal=# select * from t2 where id = ANY ('{1,2,3,100,1000,0}'::integer[]);</font></div><div><font size="2"   >&nbsp; id &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------+----------------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; 1 | 07d16508c6719888fe7030354f9eb3ed</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | a190af0a3e0f62c1c210e314e2b23018</font></div><div><font size="2"   >&nbsp; &nbsp; 3 | 2ecbd5b8d321bb409d14992f234527bb</font></div><div><font size="2"   >&nbsp; 100 | 2f33507dba91ef78bd28aec7e1f52254</font></div><div><font size="2"   >&nbsp;1000 | 5964d4dba996b76360544ef6aa90ed0e</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div><div>这个结果反了, 可能是hash 聚合造成的.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from t2 where id = ANY (VALUES (1),(2),(3),(100),(1000),(0));</font></div><div><font size="2"   >&nbsp; id &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------+----------------------------------</font></div><div><font size="2"   >&nbsp;1000 | 5964d4dba996b76360544ef6aa90ed0e</font></div><div><font size="2"   >&nbsp; 100 | 2f33507dba91ef78bd28aec7e1f52254</font></div><div><font size="2"   >&nbsp; &nbsp; 1 | 07d16508c6719888fe7030354f9eb3ed</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | a190af0a3e0f62c1c210e314e2b23018</font></div><div><font size="2"   >&nbsp; &nbsp; 3 | 2ecbd5b8d321bb409d14992f234527bb</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select t2.* from t2 join (VALUES (1),(2),(3),(100),(1000),(0)) as t(id) on t2.id=t.id;</font></div><div><font size="2"   >&nbsp; id &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------+----------------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; 1 | 07d16508c6719888fe7030354f9eb3ed</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | a190af0a3e0f62c1c210e314e2b23018</font></div><div><font size="2"   >&nbsp; &nbsp; 3 | 2ecbd5b8d321bb409d14992f234527bb</font></div><div><font size="2"   >&nbsp; 100 | 2f33507dba91ef78bd28aec7e1f52254</font></div><div><font size="2"   >&nbsp;1000 | 5964d4dba996b76360544ef6aa90ed0e</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div><div><br></div><div>有一位外国网友在他的SQL使用场景中, 使用values节点来改变执行计划, 获得更好的效率.&nbsp;</div><div><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   ><em>A simple but non-obvious one-line change (<code style="font-family: monospace, monospace; font-size: 1em;"   >ANY(ARRAY[...])</code>&nbsp;to&nbsp;<code style="font-family: monospace, monospace; font-size: 1em;"   >ANY(VALUES(...))</code>) in a (bad) PostgreSQL query cuts query time from 20s to 0.2s. Starting with low-level metrics we make our way to your best friend:&nbsp;<a style="color: rgb(132, 90, 173); text-decoration: none;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/sql-explain.html"   ><code style="font-family: monospace, monospace; font-size: 1em;"   >EXPLAIN ANALYZE</code></a>. The amount of time invested will pay off a hundred times over. The&nbsp;<a style="color: rgb(132, 90, 173); text-decoration: none;" target="_blank" rel="nofollow" href="http://www.postgresql.org/list/pgsql-performance/"   >Postgres community</a>&nbsp;is your second best friend.</em></p><h3 id="monitoring-slow-postgres-queries-with-postgres"   style="font-family: Helvetica, Arial, sans-serif; color: rgb(85, 85, 85); text-shadow: rgb(255, 255, 255) 0px 1px 1px; font-size: 18px; margin: 0.5em 0px 0.75em; padding: 0px; line-height: 1.25;"   >Monitoring slow Postgres queries with Postgres</h3><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   >Earlier this week the performance of one of our (many) databases was plagued by a few pathologically large, primary-key queries in a smallish table (10 GB, 15 million rows) used to feed our graph editor.</p><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   >In 99.9% of accounts these queries would be zippy. In a few cases where the number of tags used to annotate metrics is large, these queries would take up to 20 seconds. That much time spent in a database meant that someone was waiting in front of their browser for the graph editor to respond. This is obviously not the best experience for the unlucky 0.1%.</p><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   >Here is the surprisingly simple culprit:</p><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   ></p><div id="gist6282597"   style="color: rgb(51, 51, 51); height: auto; float: none; clear: both; font-family: HelveticaNeue-Light, 'Helvetica Neue Light', 'Helvetica Neue', Helvetica, Arial, 'Lucida Grande', sans-serif;"   ><div style="margin-bottom: 1em; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221) rgb(221, 221, 221) rgb(204, 204, 204); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; height: auto; float: none; clear: both;"   ><div style="overflow: auto; word-wrap: normal; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(221, 221, 221); height: auto; float: none; clear: both; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><div style="font-size: 12px; line-height: 1.4; height: auto; float: none; clear: both;"   ><table cellpadding="0"   cellspacing="0"   style="border-collapse: collapse; border-spacing: 0px; margin: 0px; padding: 0px; width: 598px; font-size: 14px;"   ><tbody><tr><td style="vertical-align: top; padding: 0.5em; color: rgb(170, 170, 170); text-align: right; border-right-width: 1px; border-right-style: solid; border-right-color: rgb(238, 238, 238);"   ><span id="file-slow-query-sql-L1"   rel="file-slow-query-sql-L1"   style="display: block; clear: right;"   >1</span><span id="file-slow-query-sql-L2"   rel="file-slow-query-sql-L2"   style="display: block; clear: right;"   >2</span><span id="file-slow-query-sql-L3"   rel="file-slow-query-sql-L3"   style="display: block; clear: right;"   >3</span><span id="file-slow-query-sql-L4"   rel="file-slow-query-sql-L4"   style="display: block; clear: right;"   >4</span><span id="file-slow-query-sql-L5"   rel="file-slow-query-sql-L5"   style="display: block; clear: right;"   >5</span><span id="file-slow-query-sql-L6"   rel="file-slow-query-sql-L6"   style="display: block; clear: right;"   >6</span><span id="file-slow-query-sql-L7"   rel="file-slow-query-sql-L7"   style="display: block; clear: right;"   >7</span><span id="file-slow-query-sql-L8"   rel="file-slow-query-sql-L8"   style="display: block; clear: right;"   >8</span><span id="file-slow-query-sql-L9"   rel="file-slow-query-sql-L9"   style="display: block; clear: right;"   >9</span><span id="file-slow-query-sql-L10"   rel="file-slow-query-sql-L10"   style="display: block; clear: right;"   >10</span></td><td style="vertical-align: top; padding: 0.5em !important;"   ><pre style="font-size: 1em; word-wrap: break-word; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace !important; padding: 0px !important; margin-top: 0px !important; margin-bottom: 0px !important; line-height: inherit !important; border: 0px !important; background: transparent !important;"   ><div id="file-slow-query-sql-LC1"   style="height: auto; float: none; clear: both;"   ><span style="font-weight: bold;"   >SELECT</span> <span style="font-weight: bold;"   >c</span><span>.</span><span style="font-weight: bold;"   >key</span><span>,</span></div><div id="file-slow-query-sql-LC2"   style="height: auto; float: none; clear: both;"   >       <span style="font-weight: bold;"   >c</span><span>.</span><span style="color: rgb(51, 51, 51);"   >x_key</span><span>,</span></div><div id="file-slow-query-sql-LC3"   style="height: auto; float: none; clear: both;"   >       <span style="font-weight: bold;"   >c</span><span>.</span><span style="color: rgb(51, 51, 51);"   >tags</span><span>,</span></div><div id="file-slow-query-sql-LC4"   style="height: auto; float: none; clear: both;"   >       <span style="color: rgb(51, 51, 51);"   >x</span><span>.</span><span style="color: rgb(51, 51, 51);"   >name</span></div><div id="file-slow-query-sql-LC5"   style="height: auto; float: none; clear: both;"   > <span style="font-weight: bold;"   >FROM</span> <span style="color: rgb(51, 51, 51);"   >context</span> <span style="font-weight: bold;"   >c</span></div><div id="file-slow-query-sql-LC6"   style="height: auto; float: none; clear: both;"   > <span style="font-weight: bold;"   >JOIN</span> <span style="color: rgb(51, 51, 51);"   >x</span></div><div id="file-slow-query-sql-LC7"   style="height: auto; float: none; clear: both;"   >   <span style="font-weight: bold;"   >ON</span> <span style="font-weight: bold;"   >c</span><span>.</span><span style="color: rgb(51, 51, 51);"   >x_key</span> <span style="font-weight: bold;"   >=</span> <span style="color: rgb(51, 51, 51);"   >x</span><span>.</span><span style="font-weight: bold;"   >key</span></div><div id="file-slow-query-sql-LC8"   style="height: auto; float: none; clear: both;"   ><span style="font-weight: bold;"   >WHERE</span> <span style="font-weight: bold;"   >c</span><span>.</span><span style="font-weight: bold;"   >key</span> <span style="font-weight: bold;"   >=</span> <span style="font-weight: bold;"   >ANY</span> <span>(</span><span style="color: rgb(0, 134, 179);"   >ARRAY</span><span>[</span><span style="color: rgb(0, 153, 153);"   >15368196</span><span>,</span> <span style="color: rgb(153, 153, 136); font-style: italic;"   >-- 11,000 other keys --)])</span></div><div id="file-slow-query-sql-LC9"   style="height: auto; float: none; clear: both;"   >  <span style="font-weight: bold;"   >AND</span> <span style="font-weight: bold;"   >c</span><span>.</span><span style="color: rgb(51, 51, 51);"   >x_key</span> <span style="font-weight: bold;"   >=</span> <span style="color: rgb(0, 153, 153);"   >1</span></div><div id="file-slow-query-sql-LC10"   style="height: auto; float: none; clear: both;"   >  <span style="font-weight: bold;"   >AND</span> <span style="font-weight: bold;"   >c</span><span>.</span><span style="color: rgb(51, 51, 51);"   >tags</span> <span style="font-weight: bold;"   >@&gt;</span> <span style="color: rgb(0, 134, 179);"   >ARRAY</span><span>[</span><span style="color: rgb(51, 51, 51);"   >E</span><span style="color: rgb(221, 17, 68);"   >'blah'</span><span>];</span></div></pre></td></tr></table></div></div><div style="padding: 10px; overflow: hidden; font-stretch: normal; font-size: 12px; line-height: normal; font-family: 'Helvetica Neue', Helvetica, arial, freesans, clean, sans-serif; color: rgb(153, 153, 153); height: auto; float: none; clear: both; background-color: rgb(247, 247, 247);"   ><a style="color: rgb(102, 102, 102); text-decoration: none; float: right;" rel="nofollow" href="https://gist.github.com/alq666/6282597/raw/slow-query.sql"   >view raw</a><a style="color: rgb(102, 102, 102); text-decoration: none;" rel="nofollow" href="https://gist.github.com/alq666/6282597#file-slow-query-sql"   >slow-query.sql</a>&nbsp;hosted with ? by&nbsp;<a style="color: rgb(102, 102, 102); text-decoration: none;" rel="nofollow" href="https://github.com/"   >GitHub</a></div></div></div><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   ></p><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   >Table X contains a few thousand rows, Table C contains 15 millions rows. Both “key” columns are primary keys with proper indexing. Pretty straightforward, it’s a simple primary key lookup. Where things get interesting is when you increase the number of keys. At 11,000 keys we get the following plan, by prefixing&nbsp;<code style="font-family: monospace, monospace; font-size: 1em;"   >EXPLAIN (ANALYZE, BUFFERS)</code>&nbsp;to the query:</p><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   ></p><div id="gist6282566"   style="color: rgb(51, 51, 51); height: auto; float: none; clear: both; font-family: HelveticaNeue-Light, 'Helvetica Neue Light', 'Helvetica Neue', Helvetica, Arial, 'Lucida Grande', sans-serif;"   ><div style="margin-bottom: 1em; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221) rgb(221, 221, 221) rgb(204, 204, 204); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; height: auto; float: none; clear: both;"   ><div style="overflow: auto; word-wrap: normal; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(221, 221, 221); height: auto; float: none; clear: both; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><div style="font-size: 12px; line-height: 1.4; height: auto; float: none; clear: both;"   ><table cellpadding="0"   cellspacing="0"   style="border-collapse: collapse; border-spacing: 0px; margin: 0px; padding: 0px; width: 1333px; font-size: 14px;"   ><tbody><tr><td style="vertical-align: top; padding: 0.5em; color: rgb(170, 170, 170); text-align: right; border-right-width: 1px; border-right-style: solid; border-right-color: rgb(238, 238, 238);"   ><span id="file-gistfile1-sql-L1"   rel="file-gistfile1-sql-L1"   style="display: block; clear: right;"   >1</span><span id="file-gistfile1-sql-L2"   rel="file-gistfile1-sql-L2"   style="display: block; clear: right;"   >2</span><span id="file-gistfile1-sql-L3"   rel="file-gistfile1-sql-L3"   style="display: block; clear: right;"   >3</span><span id="file-gistfile1-sql-L4"   rel="file-gistfile1-sql-L4"   style="display: block; clear: right;"   >4</span><span id="file-gistfile1-sql-L5"   rel="file-gistfile1-sql-L5"   style="display: block; clear: right;"   >5</span><span id="file-gistfile1-sql-L6"   rel="file-gistfile1-sql-L6"   style="display: block; clear: right;"   >6</span><span id="file-gistfile1-sql-L7"   rel="file-gistfile1-sql-L7"   style="display: block; clear: right;"   >7</span><span id="file-gistfile1-sql-L8"   rel="file-gistfile1-sql-L8"   style="display: block; clear: right;"   >8</span><span id="file-gistfile1-sql-L9"   rel="file-gistfile1-sql-L9"   style="display: block; clear: right;"   >9</span><span id="file-gistfile1-sql-L10"   rel="file-gistfile1-sql-L10"   style="display: block; clear: right;"   >10</span><span id="file-gistfile1-sql-L11"   rel="file-gistfile1-sql-L11"   style="display: block; clear: right;"   >11</span><span id="file-gistfile1-sql-L12"   rel="file-gistfile1-sql-L12"   style="display: block; clear: right;"   >12</span><span id="file-gistfile1-sql-L13"   rel="file-gistfile1-sql-L13"   style="display: block; clear: right;"   >13</span><span id="file-gistfile1-sql-L14"   rel="file-gistfile1-sql-L14"   style="display: block; clear: right;"   >14</span><span id="file-gistfile1-sql-L15"   rel="file-gistfile1-sql-L15"   style="display: block; clear: right;"   >15</span><span id="file-gistfile1-sql-L16"   rel="file-gistfile1-sql-L16"   style="display: block; clear: right;"   >16</span><span id="file-gistfile1-sql-L17"   rel="file-gistfile1-sql-L17"   style="display: block; clear: right;"   >17</span><span id="file-gistfile1-sql-L18"   rel="file-gistfile1-sql-L18"   style="display: block; clear: right;"   >18</span></td><td style="vertical-align: top; padding: 0.5em !important;"   ><pre style="font-size: 1em; word-wrap: break-word; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace !important; padding: 0px !important; margin-top: 0px !important; margin-bottom: 0px !important; line-height: inherit !important; border: 0px !important; background: transparent !important;"   ><div id="file-gistfile1-sql-LC1"   style="height: auto; float: none; clear: both;"   ><span style="color: rgb(51, 51, 51);"   >Nested</span> <span style="color: rgb(51, 51, 51);"   >Loop</span>  <span>(</span><span style="color: rgb(51, 51, 51);"   >cost</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >6923</span><span>.</span><span style="color: rgb(0, 153, 153);"   >33</span><span>..</span><span style="color: rgb(0, 153, 153);"   >11770</span><span>.</span><span style="color: rgb(0, 153, 153);"   >59</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >1</span> <span style="color: rgb(51, 51, 51);"   >width</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >362</span><span>)</span> <span>(</span><span style="color: rgb(51, 51, 51);"   >actual</span> <span style="color: rgb(51, 51, 51);"   >time</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >17128</span><span>.</span><span style="color: rgb(0, 153, 153);"   >188</span><span>..</span><span style="color: rgb(0, 153, 153);"   >22109</span><span>.</span><span style="color: rgb(0, 153, 153);"   >283</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >10858</span> <span style="color: rgb(51, 51, 51);"   >loops</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >1</span><span>)</span></div><div id="file-gistfile1-sql-LC2"   style="height: auto; float: none; clear: both;"   >  <span style="color: rgb(51, 51, 51);"   >Buffers</span><span>:</span> <span style="color: rgb(51, 51, 51);"   >shared</span> <span style="color: rgb(51, 51, 51);"   >hit</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >83494</span></div><div id="file-gistfile1-sql-LC3"   style="height: auto; float: none; clear: both;"   >  <span style="font-weight: bold;"   >-&gt;</span>  <span style="color: rgb(51, 51, 51);"   >Bitmap</span> <span style="color: rgb(51, 51, 51);"   >Heap</span> <span style="color: rgb(51, 51, 51);"   >Scan</span> <span style="font-weight: bold;"   >on</span> <span style="color: rgb(51, 51, 51);"   >context</span> <span style="font-weight: bold;"   >c</span>  <span>(</span><span style="color: rgb(51, 51, 51);"   >cost</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >6923</span><span>.</span><span style="color: rgb(0, 153, 153);"   >33</span><span>..</span><span style="color: rgb(0, 153, 153);"   >11762</span><span>.</span><span style="color: rgb(0, 153, 153);"   >31</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >1</span> <span style="color: rgb(51, 51, 51);"   >width</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >329</span><span>)</span> <span>(</span><span style="color: rgb(51, 51, 51);"   >actual</span> <span style="color: rgb(51, 51, 51);"   >time</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >17128</span><span>.</span><span style="color: rgb(0, 153, 153);"   >121</span><span>..</span><span style="color: rgb(0, 153, 153);"   >22031</span><span>.</span><span style="color: rgb(0, 153, 153);"   >783</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >10858</span> <span style="color: rgb(51, 51, 51);"   >loops</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >1</span><span>)</span></div><div id="file-gistfile1-sql-LC4"   style="height: auto; float: none; clear: both;"   >        <span style="font-weight: bold;"   >Recheck</span> <span style="color: rgb(51, 51, 51);"   >Cond</span><span>:</span> <span>((</span><span style="color: rgb(51, 51, 51);"   >tags</span> <span style="font-weight: bold;"   >@&gt;</span> <span style="color: rgb(221, 17, 68);"   >'{blah}'</span><span>::</span><span style="color: rgb(0, 134, 179);"   >text</span><span>[])</span> <span style="font-weight: bold;"   >AND</span> <span>(</span><span style="color: rgb(51, 51, 51);"   >x_key</span> <span style="font-weight: bold;"   >=</span> <span style="color: rgb(0, 153, 153);"   >1</span><span>))</span></div><div id="file-gistfile1-sql-LC5"   style="height: auto; float: none; clear: both;"   >        <span style="color: rgb(51, 51, 51);"   >Filter</span><span>:</span> <span>(</span><span style="font-weight: bold;"   >key</span> <span style="font-weight: bold;"   >=</span> <span style="font-weight: bold;"   >ANY</span> <span>(</span><span style="color: rgb(221, 17, 68);"   >'{15368196,(a lot more keys here)}'</span><span>::</span><span style="color: rgb(0, 134, 179);"   >integer</span><span>[]))</span></div><div id="file-gistfile1-sql-LC6"   style="height: auto; float: none; clear: both;"   >        <span style="color: rgb(51, 51, 51);"   >Buffers</span><span>:</span> <span style="color: rgb(51, 51, 51);"   >shared</span> <span style="color: rgb(51, 51, 51);"   >hit</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >50919</span></div><div id="file-gistfile1-sql-LC7"   style="height: auto; float: none; clear: both;"   >        <span style="font-weight: bold;"   >-&gt;</span>  <span style="color: rgb(51, 51, 51);"   >BitmapAnd</span>  <span>(</span><span style="color: rgb(51, 51, 51);"   >cost</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >6923</span><span>.</span><span style="color: rgb(0, 153, 153);"   >33</span><span>..</span><span style="color: rgb(0, 153, 153);"   >6923</span><span>.</span><span style="color: rgb(0, 153, 153);"   >33</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >269</span> <span style="color: rgb(51, 51, 51);"   >width</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >0</span><span>)</span> <span>(</span><span style="color: rgb(51, 51, 51);"   >actual</span> <span style="color: rgb(51, 51, 51);"   >time</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >132</span><span>.</span><span style="color: rgb(0, 153, 153);"   >910</span><span>..</span><span style="color: rgb(0, 153, 153);"   >132</span><span>.</span><span style="color: rgb(0, 153, 153);"   >910</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >0</span> <span style="color: rgb(51, 51, 51);"   >loops</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >1</span><span>)</span></div><div id="file-gistfile1-sql-LC8"   style="height: auto; float: none; clear: both;"   >              <span style="color: rgb(51, 51, 51);"   >Buffers</span><span>:</span> <span style="color: rgb(51, 51, 51);"   >shared</span> <span style="color: rgb(51, 51, 51);"   >hit</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >1342</span></div><div id="file-gistfile1-sql-LC9"   style="height: auto; float: none; clear: both;"   >              <span style="font-weight: bold;"   >-&gt;</span>  <span style="color: rgb(51, 51, 51);"   >Bitmap</span> <span style="font-weight: bold;"   >Index</span> <span style="color: rgb(51, 51, 51);"   >Scan</span> <span style="font-weight: bold;"   >on</span> <span style="color: rgb(51, 51, 51);"   >context_tags_idx</span>  <span>(</span><span style="color: rgb(51, 51, 51);"   >cost</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >0</span><span>.</span><span style="color: rgb(0, 153, 153);"   >00</span><span>..</span><span style="color: rgb(0, 153, 153);"   >1149</span><span>.</span><span style="color: rgb(0, 153, 153);"   >61</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >15891</span> <span style="color: rgb(51, 51, 51);"   >width</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >0</span><span>)</span> <span>(</span><span style="color: rgb(51, 51, 51);"   >actual</span> <span style="color: rgb(51, 51, 51);"   >time</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >64</span><span>.</span><span style="color: rgb(0, 153, 153);"   >614</span><span>..</span><span style="color: rgb(0, 153, 153);"   >64</span><span>.</span><span style="color: rgb(0, 153, 153);"   >614</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >264777</span> <span style="color: rgb(51, 51, 51);"   >loops</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >1</span><span>)</span></div><div id="file-gistfile1-sql-LC10"   style="height: auto; float: none; clear: both;"   >                    <span style="font-weight: bold;"   >Index</span> <span style="color: rgb(51, 51, 51);"   >Cond</span><span>:</span> <span>(</span><span style="color: rgb(51, 51, 51);"   >tags</span> <span style="font-weight: bold;"   >@&gt;</span> <span style="color: rgb(221, 17, 68);"   >'{blah}'</span><span>::</span><span style="color: rgb(0, 134, 179);"   >text</span><span>[])</span></div><div id="file-gistfile1-sql-LC11"   style="height: auto; float: none; clear: both;"   >                    <span style="color: rgb(51, 51, 51);"   >Buffers</span><span>:</span> <span style="color: rgb(51, 51, 51);"   >shared</span> <span style="color: rgb(51, 51, 51);"   >hit</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >401</span></div><div id="file-gistfile1-sql-LC12"   style="height: auto; float: none; clear: both;"   >              <span style="font-weight: bold;"   >-&gt;</span>  <span style="color: rgb(51, 51, 51);"   >Bitmap</span> <span style="font-weight: bold;"   >Index</span> <span style="color: rgb(51, 51, 51);"   >Scan</span> <span style="font-weight: bold;"   >on</span> <span style="color: rgb(51, 51, 51);"   >context_x_id_source_type_id_idx</span>  <span>(</span><span style="color: rgb(51, 51, 51);"   >cost</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >0</span><span>.</span><span style="color: rgb(0, 153, 153);"   >00</span><span>..</span><span style="color: rgb(0, 153, 153);"   >5773</span><span>.</span><span style="color: rgb(0, 153, 153);"   >47</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >268667</span> <span style="color: rgb(51, 51, 51);"   >width</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >0</span><span>)</span> <span>(</span><span style="color: rgb(51, 51, 51);"   >actual</span> <span style="color: rgb(51, 51, 51);"   >time</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >54</span><span>.</span><span style="color: rgb(0, 153, 153);"   >648</span><span>..</span><span style="color: rgb(0, 153, 153);"   >54</span><span>.</span><span style="color: rgb(0, 153, 153);"   >648</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >267659</span> <span style="color: rgb(51, 51, 51);"   >loops</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >1</span><span>)</span></div><div id="file-gistfile1-sql-LC13"   style="height: auto; float: none; clear: both;"   >                    <span style="font-weight: bold;"   >Index</span> <span style="color: rgb(51, 51, 51);"   >Cond</span><span>:</span> <span>(</span><span style="color: rgb(51, 51, 51);"   >x_id</span> <span style="font-weight: bold;"   >=</span> <span style="color: rgb(0, 153, 153);"   >1</span><span>)</span></div><div id="file-gistfile1-sql-LC14"   style="height: auto; float: none; clear: both;"   >                    <span style="color: rgb(51, 51, 51);"   >Buffers</span><span>:</span> <span style="color: rgb(51, 51, 51);"   >shared</span> <span style="color: rgb(51, 51, 51);"   >hit</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >941</span></div><div id="file-gistfile1-sql-LC15"   style="height: auto; float: none; clear: both;"   >  <span style="font-weight: bold;"   >-&gt;</span>  <span style="font-weight: bold;"   >Index</span> <span style="color: rgb(51, 51, 51);"   >Scan</span> <span style="font-weight: bold;"   >using</span> <span style="color: rgb(51, 51, 51);"   >x_pkey</span> <span style="font-weight: bold;"   >on</span> <span style="color: rgb(51, 51, 51);"   >x</span>  <span>(</span><span style="color: rgb(51, 51, 51);"   >cost</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >0</span><span>.</span><span style="color: rgb(0, 153, 153);"   >00</span><span>..</span><span style="color: rgb(0, 153, 153);"   >8</span><span>.</span><span style="color: rgb(0, 153, 153);"   >27</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >1</span> <span style="color: rgb(51, 51, 51);"   >width</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >37</span><span>)</span> <span>(</span><span style="color: rgb(51, 51, 51);"   >actual</span> <span style="color: rgb(51, 51, 51);"   >time</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >0</span><span>.</span><span style="color: rgb(0, 153, 153);"   >003</span><span>..</span><span style="color: rgb(0, 153, 153);"   >0</span><span>.</span><span style="color: rgb(0, 153, 153);"   >004</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >1</span> <span style="color: rgb(51, 51, 51);"   >loops</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >10858</span><span>)</span></div><div id="file-gistfile1-sql-LC16"   style="height: auto; float: none; clear: both;"   >        <span style="font-weight: bold;"   >Index</span> <span style="color: rgb(51, 51, 51);"   >Cond</span><span>:</span> <span>(</span><span style="color: rgb(51, 51, 51);"   >x</span><span>.</span><span style="font-weight: bold;"   >key</span> <span style="font-weight: bold;"   >=</span> <span style="color: rgb(0, 153, 153);"   >1</span><span>)</span></div><div id="file-gistfile1-sql-LC17"   style="height: auto; float: none; clear: both;"   >        <span style="color: rgb(51, 51, 51);"   >Buffers</span><span>:</span> <span style="color: rgb(51, 51, 51);"   >shared</span> <span style="color: rgb(51, 51, 51);"   >hit</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >32575</span></div><div id="file-gistfile1-sql-LC18"   style="height: auto; float: none; clear: both;"   ><span style="color: rgb(51, 51, 51);"   >Total</span> <span style="color: rgb(51, 51, 51);"   >runtime</span><span>:</span> <span style="color: rgb(0, 153, 153);"   >22117</span><span>.</span><span style="color: rgb(0, 153, 153);"   >417</span> <span style="color: rgb(51, 51, 51);"   >ms</span></div></pre></td></tr></table></div></div><div style="padding: 10px; overflow: hidden; font-stretch: normal; font-size: 12px; line-height: normal; font-family: 'Helvetica Neue', Helvetica, arial, freesans, clean, sans-serif; color: rgb(153, 153, 153); height: auto; float: none; clear: both; background-color: rgb(247, 247, 247);"   ><a style="color: rgb(102, 102, 102); text-decoration: none; float: right;" rel="nofollow" href="https://gist.github.com/alq666/6282566/raw/gistfile1.sql"   >view raw</a><a style="color: rgb(102, 102, 102); text-decoration: none;" rel="nofollow" href="https://gist.github.com/alq666/6282566#file-gistfile1-sql"   >gistfile1.sql</a>&nbsp;hosted with ? by&nbsp;<a style="color: rgb(102, 102, 102); text-decoration: none;" rel="nofollow" href="https://github.com/"   >GitHub</a></div></div></div><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   ></p><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   >As you can see at the bottom of the plan, the query took 22 seconds to execute. These 22 seconds can be visualized on the following graph as pure CPU execution split 90/10 between Postgres and the OS; very little disk I/O.</p></div><div><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   >At the lowest level these queries would look like these spikes of CPU utilization. CPU graphs are seldom useful but in this case it confirmed a crucial point: the database was not waiting for the disks to read data. It was doing things like sorting, hashing and comparing rows.</p><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   >The second interesting metric that tracks the spikes very closely is the number of rows that are “fetched” by Postgres (in this case not returned, just looked at and discarded).</p></div><div><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   >Clearly something is regularly and methodically going through a lot of rows: our query.</p><h3 id="the-postgres-performance-problem-bitmap-heap-scan"   style="font-family: Helvetica, Arial, sans-serif; color: rgb(85, 85, 85); text-shadow: rgb(255, 255, 255) 0px 1px 1px; font-size: 18px; margin: 0.5em 0px 0.75em; padding: 0px; line-height: 1.25;"   >The Postgres Performance Problem: Bitmap Heap Scan</h3><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   >The&nbsp;<em>rows_fetched</em>&nbsp;metric is consistent with the following part of the plan:</p><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   ></p><div id="gist6282712"   style="color: rgb(51, 51, 51); height: auto; float: none; clear: both; font-family: HelveticaNeue-Light, 'Helvetica Neue Light', 'Helvetica Neue', Helvetica, Arial, 'Lucida Grande', sans-serif;"   ><div style="margin-bottom: 1em; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221) rgb(221, 221, 221) rgb(204, 204, 204); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; height: auto; float: none; clear: both;"   ><div style="overflow: auto; word-wrap: normal; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(221, 221, 221); height: auto; float: none; clear: both; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><div style="font-size: 12px; line-height: 1.4; height: auto; float: none; clear: both;"   ><table cellpadding="0"   cellspacing="0"   style="border-collapse: collapse; border-spacing: 0px; margin: 0px; padding: 0px; width: 1093px; font-size: 14px;"   ><tbody><tr><td style="vertical-align: top; padding: 0.5em; color: rgb(170, 170, 170); text-align: right; border-right-width: 1px; border-right-style: solid; border-right-color: rgb(238, 238, 238);"   ><span id="file-plan-detail-blog-sql-L1"   rel="file-plan-detail-blog-sql-L1"   style="display: block; clear: right;"   >1</span><span id="file-plan-detail-blog-sql-L2"   rel="file-plan-detail-blog-sql-L2"   style="display: block; clear: right;"   >2</span><span id="file-plan-detail-blog-sql-L3"   rel="file-plan-detail-blog-sql-L3"   style="display: block; clear: right;"   >3</span><span id="file-plan-detail-blog-sql-L4"   rel="file-plan-detail-blog-sql-L4"   style="display: block; clear: right;"   >4</span><span id="file-plan-detail-blog-sql-L5"   rel="file-plan-detail-blog-sql-L5"   style="display: block; clear: right;"   >5</span></td><td style="vertical-align: top; padding: 0.5em !important;"   ><pre style="font-size: 1em; word-wrap: break-word; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace !important; padding: 0px !important; margin-top: 0px !important; margin-bottom: 0px !important; line-height: inherit !important; border: 0px !important; background: transparent !important;"   ><div id="file-plan-detail-blog-sql-LC1"   style="height: auto; float: none; clear: both;"   ><span style="color: rgb(51, 51, 51);"   >Buffers</span><span>:</span> <span style="color: rgb(51, 51, 51);"   >shared</span> <span style="color: rgb(51, 51, 51);"   >hit</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >83494</span></div><div id="file-plan-detail-blog-sql-LC2"   style="height: auto; float: none; clear: both;"   >  <span style="font-weight: bold;"   >-&gt;</span>  <span style="color: rgb(51, 51, 51);"   >Bitmap</span> <span style="color: rgb(51, 51, 51);"   >Heap</span> <span style="color: rgb(51, 51, 51);"   >Scan</span> <span style="font-weight: bold;"   >on</span> <span style="color: rgb(51, 51, 51);"   >context</span> <span style="font-weight: bold;"   >c</span>  <span>(</span><span style="color: rgb(51, 51, 51);"   >cost</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >6923</span><span>.</span><span style="color: rgb(0, 153, 153);"   >33</span><span>..</span><span style="color: rgb(0, 153, 153);"   >11762</span><span>.</span><span style="color: rgb(0, 153, 153);"   >31</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >1</span> <span style="color: rgb(51, 51, 51);"   >width</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >329</span><span>)</span> <span>(</span><span style="color: rgb(51, 51, 51);"   >actual</span> <span style="color: rgb(51, 51, 51);"   >time</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >17128</span><span>.</span><span style="color: rgb(0, 153, 153);"   >121</span><span>..</span><span style="color: rgb(0, 153, 153);"   >22031</span><span>.</span><span style="color: rgb(0, 153, 153);"   >783</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >10858</span> <span style="color: rgb(51, 51, 51);"   >loops</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >1</span><span>)</span></div><div id="file-plan-detail-blog-sql-LC3"   style="height: auto; float: none; clear: both;"   >        <span style="font-weight: bold;"   >Recheck</span> <span style="color: rgb(51, 51, 51);"   >Cond</span><span>:</span> <span>((</span><span style="color: rgb(51, 51, 51);"   >tags</span> <span style="font-weight: bold;"   >@&gt;</span> <span style="color: rgb(221, 17, 68);"   >'{blah}'</span><span>::</span><span style="color: rgb(0, 134, 179);"   >text</span><span>[])</span> <span style="font-weight: bold;"   >AND</span> <span>(</span><span style="color: rgb(51, 51, 51);"   >x_key</span> <span style="font-weight: bold;"   >=</span> <span style="color: rgb(0, 153, 153);"   >1</span><span>))</span></div><div id="file-plan-detail-blog-sql-LC4"   style="height: auto; float: none; clear: both;"   >        <span style="color: rgb(51, 51, 51);"   >Filter</span><span>:</span> <span>(</span><span style="font-weight: bold;"   >key</span> <span style="font-weight: bold;"   >=</span> <span style="font-weight: bold;"   >ANY</span> <span>(</span><span style="color: rgb(221, 17, 68);"   >'{15368196,(a lot more keys here)}'</span><span>::</span><span style="color: rgb(0, 134, 179);"   >integer</span><span>[]))</span></div><div id="file-plan-detail-blog-sql-LC5"   style="height: auto; float: none; clear: both;"   >        <span style="color: rgb(51, 51, 51);"   >Buffers</span><span>:</span> <span style="color: rgb(51, 51, 51);"   >shared</span> <span style="color: rgb(51, 51, 51);"   >hit</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >50919</span></div></pre></td></tr></table></div></div><div style="padding: 10px; overflow: hidden; font-stretch: normal; font-size: 12px; line-height: normal; font-family: 'Helvetica Neue', Helvetica, arial, freesans, clean, sans-serif; color: rgb(153, 153, 153); height: auto; float: none; clear: both; background-color: rgb(247, 247, 247);"   ><a style="color: rgb(102, 102, 102); text-decoration: none; float: right;" rel="nofollow" href="https://gist.github.com/alq666/6282712/raw/plan-detail-blog.sql"   >view raw</a><a style="color: rgb(102, 102, 102); text-decoration: none;" rel="nofollow" href="https://gist.github.com/alq666/6282712#file-plan-detail-blog-sql"   >plan-detail-blog.sql</a>&nbsp;hosted with ? by&nbsp;<a style="color: rgb(102, 102, 102); text-decoration: none;" rel="nofollow" href="https://github.com/"   >GitHub</a></div></div></div><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   ></p><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   >Postgres is reading Table C using a&nbsp;<a style="color: rgb(132, 90, 173); text-decoration: none;" target="_blank" rel="nofollow" href="http://www.postgresql.org/message-id/12553.1135634231@sss.pgh.pa.us"   >Bitmap Heap Scan</a>. When the number of keys to check stays small, it can efficiently use the index to build the bitmap in memory. If the bitmap gets too large, the query optimizer changes the way it looks up data. In our case it has a large number of keys to check so it uses the more approximative way to retrieve the candidate rows and checks each row individually for a match on x_key and tags. All this “loading in memory” and “checking individual row” takes time (the Recheck Cond in the plan).</p><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   >Luckily for us the table is 30% loaded in RAM so it is not as bad as retrieving the rows from disk. It still has a very noticeable impact on performance. Remember that the query is quite simple. It’s a primary key lookup so there aren’t many obvious ways to fix it without dramatically re-architecting the database or the application. We turned to the community for help via the&nbsp;<a style="color: rgb(132, 90, 173); text-decoration: none;" target="_blank" rel="nofollow" href="http://www.postgresql.org/message-id/200209271205.49756.josh@agliodbs.com"   >PGSQL-Performance mailing list</a>.</p><h3 id="the-solution"   style="font-family: Helvetica, Arial, sans-serif; color: rgb(85, 85, 85); text-shadow: rgb(255, 255, 255) 0px 1px 1px; font-size: 18px; margin: 0.5em 0px 0.75em; padding: 0px; line-height: 1.25;"   >The solution</h3><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   >This is yet another reason why we love open-source and its culture of helping users.<a style="color: rgb(132, 90, 173); text-decoration: none;" rel="nofollow" href="http://en.wikipedia.org/wiki/Tom_Lane_(computer_scientist)"   >Tom Lane</a>, one of the most prolific open-source authors around, suggested to try this instead:</p><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   ></p><div id="gist6282672"   style="color: rgb(51, 51, 51); height: auto; float: none; clear: both; font-family: HelveticaNeue-Light, 'Helvetica Neue Light', 'Helvetica Neue', Helvetica, Arial, 'Lucida Grande', sans-serif;"   ><div style="margin-bottom: 1em; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221) rgb(221, 221, 221) rgb(204, 204, 204); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; height: auto; float: none; clear: both;"   ><div style="overflow: auto; word-wrap: normal; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(221, 221, 221); height: auto; float: none; clear: both; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><div style="font-size: 12px; line-height: 1.4; height: auto; float: none; clear: both;"   ><table cellpadding="0"   cellspacing="0"   style="border-collapse: collapse; border-spacing: 0px; margin: 0px; padding: 0px; width: 598px; font-size: 14px;"   ><tbody><tr><td style="vertical-align: top; padding: 0.5em; color: rgb(170, 170, 170); text-align: right; border-right-width: 1px; border-right-style: solid; border-right-color: rgb(238, 238, 238);"   ><span id="file-better-query-blog-sql-L1"   rel="file-better-query-blog-sql-L1"   style="display: block; clear: right;"   >1</span><span id="file-better-query-blog-sql-L2"   rel="file-better-query-blog-sql-L2"   style="display: block; clear: right;"   >2</span><span id="file-better-query-blog-sql-L3"   rel="file-better-query-blog-sql-L3"   style="display: block; clear: right;"   >3</span><span id="file-better-query-blog-sql-L4"   rel="file-better-query-blog-sql-L4"   style="display: block; clear: right;"   >4</span><span id="file-better-query-blog-sql-L5"   rel="file-better-query-blog-sql-L5"   style="display: block; clear: right;"   >5</span><span id="file-better-query-blog-sql-L6"   rel="file-better-query-blog-sql-L6"   style="display: block; clear: right;"   >6</span><span id="file-better-query-blog-sql-L7"   rel="file-better-query-blog-sql-L7"   style="display: block; clear: right;"   >7</span><span id="file-better-query-blog-sql-L8"   rel="file-better-query-blog-sql-L8"   style="display: block; clear: right;"   >8</span><span id="file-better-query-blog-sql-L9"   rel="file-better-query-blog-sql-L9"   style="display: block; clear: right;"   >9</span><span id="file-better-query-blog-sql-L10"   rel="file-better-query-blog-sql-L10"   style="display: block; clear: right;"   >10</span></td><td style="vertical-align: top; padding: 0.5em !important;"   ><pre style="font-size: 1em; word-wrap: break-word; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace !important; padding: 0px !important; margin-top: 0px !important; margin-bottom: 0px !important; line-height: inherit !important; border: 0px !important; background: transparent !important;"   ><div id="file-better-query-blog-sql-LC1"   style="height: auto; float: none; clear: both;"   ><span style="font-weight: bold;"   >SELECT</span> <span style="font-weight: bold;"   >c</span><span>.</span><span style="font-weight: bold;"   >key</span><span>,</span></div><div id="file-better-query-blog-sql-LC2"   style="height: auto; float: none; clear: both;"   >       <span style="font-weight: bold;"   >c</span><span>.</span><span style="color: rgb(51, 51, 51);"   >x_key</span><span>,</span></div><div id="file-better-query-blog-sql-LC3"   style="height: auto; float: none; clear: both;"   >       <span style="font-weight: bold;"   >c</span><span>.</span><span style="color: rgb(51, 51, 51);"   >tags</span><span>,</span></div><div id="file-better-query-blog-sql-LC4"   style="height: auto; float: none; clear: both;"   >       <span style="color: rgb(51, 51, 51);"   >x</span><span>.</span><span style="color: rgb(51, 51, 51);"   >name</span></div><div id="file-better-query-blog-sql-LC5"   style="height: auto; float: none; clear: both;"   > <span style="font-weight: bold;"   >FROM</span> <span style="color: rgb(51, 51, 51);"   >context</span> <span style="font-weight: bold;"   >c</span></div><div id="file-better-query-blog-sql-LC6"   style="height: auto; float: none; clear: both;"   > <span style="font-weight: bold;"   >JOIN</span> <span style="color: rgb(51, 51, 51);"   >x</span></div><div id="file-better-query-blog-sql-LC7"   style="height: auto; float: none; clear: both;"   >   <span style="font-weight: bold;"   >ON</span> <span style="font-weight: bold;"   >c</span><span>.</span><span style="color: rgb(51, 51, 51);"   >x_key</span> <span style="font-weight: bold;"   >=</span> <span style="color: rgb(51, 51, 51);"   >x</span><span>.</span><span style="font-weight: bold;"   >key</span></div><div id="file-better-query-blog-sql-LC8"   style="height: auto; float: none; clear: both;"   ><span style="font-weight: bold;"   >WHERE</span> <span style="font-weight: bold;"   >c</span><span>.</span><span style="font-weight: bold;"   >key</span> <span style="font-weight: bold;"   >=</span> <span style="font-weight: bold;"   >ANY</span> <span>(</span><span style="font-weight: bold;"   >VALUES</span> <span>(</span><span style="color: rgb(0, 153, 153);"   >15368196</span><span>),</span> <span style="color: rgb(153, 153, 136); font-style: italic;"   >-- 11,000 other keys --)</span></div><div id="file-better-query-blog-sql-LC9"   style="height: auto; float: none; clear: both;"   >  <span style="font-weight: bold;"   >AND</span> <span style="font-weight: bold;"   >c</span><span>.</span><span style="color: rgb(51, 51, 51);"   >x_key</span> <span style="font-weight: bold;"   >=</span> <span style="color: rgb(0, 153, 153);"   >1</span></div><div id="file-better-query-blog-sql-LC10"   style="height: auto; float: none; clear: both;"   >  <span style="font-weight: bold;"   >AND</span> <span style="font-weight: bold;"   >c</span><span>.</span><span style="color: rgb(51, 51, 51);"   >tags</span> <span style="font-weight: bold;"   >@&gt;</span> <span style="color: rgb(0, 134, 179);"   >ARRAY</span><span>[</span><span style="color: rgb(51, 51, 51);"   >E</span><span style="color: rgb(221, 17, 68);"   >'blah'</span><span>];</span></div></pre></td></tr></table></div></div><div style="padding: 10px; overflow: hidden; font-stretch: normal; font-size: 12px; line-height: normal; font-family: 'Helvetica Neue', Helvetica, arial, freesans, clean, sans-serif; color: rgb(153, 153, 153); height: auto; float: none; clear: both; background-color: rgb(247, 247, 247);"   ><a style="color: rgb(102, 102, 102); text-decoration: none; float: right;" rel="nofollow" href="https://gist.github.com/alq666/6282672/raw/better-query-blog.sql"   >view raw</a><a style="color: rgb(102, 102, 102); text-decoration: none;" rel="nofollow" href="https://gist.github.com/alq666/6282672#file-better-query-blog-sql"   >better-query-blog.sql</a>&nbsp;hosted with ? by&nbsp;<a style="color: rgb(102, 102, 102); text-decoration: none;" rel="nofollow" href="https://github.com/"   >GitHub</a></div></div></div><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   ></p><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   >Can you spot the difference?&nbsp;<code style="font-family: monospace, monospace; font-size: 1em;"   >ARRAY</code>&nbsp;has been changed to&nbsp;<code style="font-family: monospace, monospace; font-size: 1em;"   >VALUES</code>.</p><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   >The query optimizer is fooled by the use of&nbsp;<code style="font-family: monospace, monospace; font-size: 1em;"   >ARRAY[...]</code>&nbsp;to list all the primary keys to look up.&nbsp;<code style="font-family: monospace, monospace; font-size: 1em;"   >VALUES (...), (...)</code>&nbsp;lets the optimizer make full use of the primary key index instead. It is literally a one-line change, which makes no semantic difference.</p><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   >Here is the plan of the new query. The 2 major differences are on lines 3 and 14.</p><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   ></p><div id="gist6282734"   style="color: rgb(51, 51, 51); height: auto; float: none; clear: both; font-family: HelveticaNeue-Light, 'Helvetica Neue Light', 'Helvetica Neue', Helvetica, Arial, 'Lucida Grande', sans-serif;"   ><div style="margin-bottom: 1em; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; border-width: 1px; border-style: solid; border-color: rgb(221, 221, 221) rgb(221, 221, 221) rgb(204, 204, 204); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; height: auto; float: none; clear: both;"   ><div style="overflow: auto; word-wrap: normal; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(221, 221, 221); height: auto; float: none; clear: both; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><div style="font-size: 12px; line-height: 1.4; height: auto; float: none; clear: both;"   ><table cellpadding="0"   cellspacing="0"   style="border-collapse: collapse; border-spacing: 0px; margin: 0px; padding: 0px; width: 1133px; font-size: 14px;"   ><tbody><tr><td style="vertical-align: top; padding: 0.5em; color: rgb(170, 170, 170); text-align: right; border-right-width: 1px; border-right-style: solid; border-right-color: rgb(238, 238, 238);"   ><span id="file-better-plan-full-blog-sql-L1"   rel="file-better-plan-full-blog-sql-L1"   style="display: block; clear: right;"   >1</span><span id="file-better-plan-full-blog-sql-L2"   rel="file-better-plan-full-blog-sql-L2"   style="display: block; clear: right;"   >2</span><span id="file-better-plan-full-blog-sql-L3"   rel="file-better-plan-full-blog-sql-L3"   style="display: block; clear: right;"   >3</span><span id="file-better-plan-full-blog-sql-L4"   rel="file-better-plan-full-blog-sql-L4"   style="display: block; clear: right;"   >4</span><span id="file-better-plan-full-blog-sql-L5"   rel="file-better-plan-full-blog-sql-L5"   style="display: block; clear: right;"   >5</span><span id="file-better-plan-full-blog-sql-L6"   rel="file-better-plan-full-blog-sql-L6"   style="display: block; clear: right;"   >6</span><span id="file-better-plan-full-blog-sql-L7"   rel="file-better-plan-full-blog-sql-L7"   style="display: block; clear: right;"   >7</span><span id="file-better-plan-full-blog-sql-L8"   rel="file-better-plan-full-blog-sql-L8"   style="display: block; clear: right;"   >8</span><span id="file-better-plan-full-blog-sql-L9"   rel="file-better-plan-full-blog-sql-L9"   style="display: block; clear: right;"   >9</span><span id="file-better-plan-full-blog-sql-L10"   rel="file-better-plan-full-blog-sql-L10"   style="display: block; clear: right;"   >10</span><span id="file-better-plan-full-blog-sql-L11"   rel="file-better-plan-full-blog-sql-L11"   style="display: block; clear: right;"   >11</span><span id="file-better-plan-full-blog-sql-L12"   rel="file-better-plan-full-blog-sql-L12"   style="display: block; clear: right;"   >12</span><span id="file-better-plan-full-blog-sql-L13"   rel="file-better-plan-full-blog-sql-L13"   style="display: block; clear: right;"   >13</span><span id="file-better-plan-full-blog-sql-L14"   rel="file-better-plan-full-blog-sql-L14"   style="display: block; clear: right;"   >14</span></td><td style="vertical-align: top; padding: 0.5em !important;"   ><pre style="font-size: 1em; word-wrap: break-word; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace !important; padding: 0px !important; margin-top: 0px !important; margin-bottom: 0px !important; line-height: inherit !important; border: 0px !important; background: transparent !important;"   ><div id="file-better-plan-full-blog-sql-LC1"   style="height: auto; float: none; clear: both;"   ><span style="color: rgb(51, 51, 51);"   >Nested</span> <span style="color: rgb(51, 51, 51);"   >Loop</span>  <span>(</span><span style="color: rgb(51, 51, 51);"   >cost</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >168</span><span>.</span><span style="color: rgb(0, 153, 153);"   >22</span><span>..</span><span style="color: rgb(0, 153, 153);"   >2116</span><span>.</span><span style="color: rgb(0, 153, 153);"   >29</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >148</span> <span style="color: rgb(51, 51, 51);"   >width</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >362</span><span>)</span> <span>(</span><span style="color: rgb(51, 51, 51);"   >actual</span> <span style="color: rgb(51, 51, 51);"   >time</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >22</span><span>.</span><span style="color: rgb(0, 153, 153);"   >134</span><span>..</span><span style="color: rgb(0, 153, 153);"   >256</span><span>.</span><span style="color: rgb(0, 153, 153);"   >531</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >10858</span> <span style="color: rgb(51, 51, 51);"   >loops</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >1</span><span>)</span></div><div id="file-better-plan-full-blog-sql-LC2"   style="height: auto; float: none; clear: both;"   >  <span style="color: rgb(51, 51, 51);"   >Buffers</span><span>:</span> <span style="color: rgb(51, 51, 51);"   >shared</span> <span style="color: rgb(51, 51, 51);"   >hit</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >44967</span></div><div id="file-better-plan-full-blog-sql-LC3"   style="height: auto; float: none; clear: both;"   >  <span style="font-weight: bold;"   >-&gt;</span>  <span style="font-weight: bold;"   >Index</span> <span style="color: rgb(51, 51, 51);"   >Scan</span> <span style="font-weight: bold;"   >using</span> <span style="color: rgb(51, 51, 51);"   >x_pkey</span> <span style="font-weight: bold;"   >on</span> <span style="color: rgb(51, 51, 51);"   >x</span>  <span>(</span><span style="color: rgb(51, 51, 51);"   >cost</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >0</span><span>.</span><span style="color: rgb(0, 153, 153);"   >00</span><span>..</span><span style="color: rgb(0, 153, 153);"   >8</span><span>.</span><span style="color: rgb(0, 153, 153);"   >27</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >1</span> <span style="color: rgb(51, 51, 51);"   >width</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >37</span><span>)</span> <span>(</span><span style="color: rgb(51, 51, 51);"   >actual</span> <span style="color: rgb(51, 51, 51);"   >time</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >0</span><span>.</span><span style="color: rgb(0, 153, 153);"   >071</span><span>..</span><span style="color: rgb(0, 153, 153);"   >0</span><span>.</span><span style="color: rgb(0, 153, 153);"   >073</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >1</span> <span style="color: rgb(51, 51, 51);"   >loops</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >1</span><span>)</span></div><div id="file-better-plan-full-blog-sql-LC4"   style="height: auto; float: none; clear: both;"   >        <span style="font-weight: bold;"   >Index</span> <span style="color: rgb(51, 51, 51);"   >Cond</span><span>:</span> <span>(</span><span style="color: rgb(51, 51, 51);"   >id</span> <span style="font-weight: bold;"   >=</span> <span style="color: rgb(0, 153, 153);"   >1</span><span>)</span></div><div id="file-better-plan-full-blog-sql-LC5"   style="height: auto; float: none; clear: both;"   >        <span style="color: rgb(51, 51, 51);"   >Buffers</span><span>:</span> <span style="color: rgb(51, 51, 51);"   >shared</span> <span style="color: rgb(51, 51, 51);"   >hit</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >4</span></div><div id="file-better-plan-full-blog-sql-LC6"   style="height: auto; float: none; clear: both;"   >  <span style="font-weight: bold;"   >-&gt;</span>  <span style="color: rgb(51, 51, 51);"   >Nested</span> <span style="color: rgb(51, 51, 51);"   >Loop</span>  <span>(</span><span style="color: rgb(51, 51, 51);"   >cost</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >168</span><span>.</span><span style="color: rgb(0, 153, 153);"   >22</span><span>..</span><span style="color: rgb(0, 153, 153);"   >2106</span><span>.</span><span style="color: rgb(0, 153, 153);"   >54</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >148</span> <span style="color: rgb(51, 51, 51);"   >width</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >329</span><span>)</span> <span>(</span><span style="color: rgb(51, 51, 51);"   >actual</span> <span style="color: rgb(51, 51, 51);"   >time</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >22</span><span>.</span><span style="color: rgb(0, 153, 153);"   >060</span><span>..</span><span style="color: rgb(0, 153, 153);"   >242</span><span>.</span><span style="color: rgb(0, 153, 153);"   >406</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >10858</span> <span style="color: rgb(51, 51, 51);"   >loops</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >1</span><span>)</span></div><div id="file-better-plan-full-blog-sql-LC7"   style="height: auto; float: none; clear: both;"   >        <span style="color: rgb(51, 51, 51);"   >Buffers</span><span>:</span> <span style="color: rgb(51, 51, 51);"   >shared</span> <span style="color: rgb(51, 51, 51);"   >hit</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >44963</span></div><div id="file-better-plan-full-blog-sql-LC8"   style="height: auto; float: none; clear: both;"   >        <span style="font-weight: bold;"   >-&gt;</span>  <span style="color: rgb(51, 51, 51);"   >HashAggregate</span>  <span>(</span><span style="color: rgb(51, 51, 51);"   >cost</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >168</span><span>.</span><span style="color: rgb(0, 153, 153);"   >22</span><span>..</span><span style="color: rgb(0, 153, 153);"   >170</span><span>.</span><span style="color: rgb(0, 153, 153);"   >22</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >200</span> <span style="color: rgb(51, 51, 51);"   >width</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >4</span><span>)</span> <span>(</span><span style="color: rgb(51, 51, 51);"   >actual</span> <span style="color: rgb(51, 51, 51);"   >time</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >21</span><span>.</span><span style="color: rgb(0, 153, 153);"   >529</span><span>..</span><span style="color: rgb(0, 153, 153);"   >32</span><span>.</span><span style="color: rgb(0, 153, 153);"   >820</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >11215</span> <span style="color: rgb(51, 51, 51);"   >loops</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >1</span><span>)</span></div><div id="file-better-plan-full-blog-sql-LC9"   style="height: auto; float: none; clear: both;"   >              <span style="font-weight: bold;"   >-&gt;</span>  <span style="font-weight: bold;"   >Values</span> <span style="color: rgb(51, 51, 51);"   >Scan</span> <span style="font-weight: bold;"   >on</span> <span style="color: rgb(153, 0, 115);"   >"*VALUES*"</span>  <span>(</span><span style="color: rgb(51, 51, 51);"   >cost</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >0</span><span>.</span><span style="color: rgb(0, 153, 153);"   >00</span><span>..</span><span style="color: rgb(0, 153, 153);"   >140</span><span>.</span><span style="color: rgb(0, 153, 153);"   >19</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >11215</span> <span style="color: rgb(51, 51, 51);"   >width</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >4</span><span>)</span> <span>(</span><span style="color: rgb(51, 51, 51);"   >actual</span> <span style="color: rgb(51, 51, 51);"   >time</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >0</span><span>.</span><span style="color: rgb(0, 153, 153);"   >005</span><span>..</span><span style="color: rgb(0, 153, 153);"   >9</span><span>.</span><span style="color: rgb(0, 153, 153);"   >527</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >11215</span> <span style="color: rgb(51, 51, 51);"   >loops</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >1</span><span>)</span></div><div id="file-better-plan-full-blog-sql-LC10"   style="height: auto; float: none; clear: both;"   >        <span style="font-weight: bold;"   >-&gt;</span>  <span style="font-weight: bold;"   >Index</span> <span style="color: rgb(51, 51, 51);"   >Scan</span> <span style="font-weight: bold;"   >using</span> <span style="color: rgb(51, 51, 51);"   >context_pkey</span> <span style="font-weight: bold;"   >on</span> <span style="color: rgb(51, 51, 51);"   >context</span> <span style="font-weight: bold;"   >c</span>  <span>(</span><span style="color: rgb(51, 51, 51);"   >cost</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >0</span><span>.</span><span style="color: rgb(0, 153, 153);"   >00</span><span>..</span><span style="color: rgb(0, 153, 153);"   >9</span><span>.</span><span style="color: rgb(0, 153, 153);"   >67</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >1</span> <span style="color: rgb(51, 51, 51);"   >width</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >329</span><span>)</span> <span>(</span><span style="color: rgb(51, 51, 51);"   >actual</span> <span style="color: rgb(51, 51, 51);"   >time</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >0</span><span>.</span><span style="color: rgb(0, 153, 153);"   >015</span><span>..</span><span style="color: rgb(0, 153, 153);"   >0</span><span>.</span><span style="color: rgb(0, 153, 153);"   >016</span> <span style="font-weight: bold;"   >rows</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >1</span> <span style="color: rgb(51, 51, 51);"   >loops</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >11215</span><span>)</span></div><div id="file-better-plan-full-blog-sql-LC11"   style="height: auto; float: none; clear: both;"   >              <span style="font-weight: bold;"   >Index</span> <span style="color: rgb(51, 51, 51);"   >Cond</span><span>:</span> <span>(</span><span style="font-weight: bold;"   >c</span><span>.</span><span style="font-weight: bold;"   >key</span> <span style="font-weight: bold;"   >=</span> <span style="color: rgb(153, 0, 115);"   >"*VALUES*"</span><span>.</span><span style="color: rgb(51, 51, 51);"   >column1</span><span>)</span></div><div id="file-better-plan-full-blog-sql-LC12"   style="height: auto; float: none; clear: both;"   >              <span style="color: rgb(51, 51, 51);"   >Filter</span><span>:</span> <span>((</span><span style="font-weight: bold;"   >c</span><span>.</span><span style="color: rgb(51, 51, 51);"   >tags</span> <span style="font-weight: bold;"   >@&gt;</span> <span style="color: rgb(221, 17, 68);"   >'{blah}'</span><span>::</span><span style="color: rgb(0, 134, 179);"   >text</span><span>[])</span> <span style="font-weight: bold;"   >AND</span> <span>(</span><span style="font-weight: bold;"   >c</span><span>.</span><span style="color: rgb(51, 51, 51);"   >x_id</span> <span style="font-weight: bold;"   >=</span> <span style="color: rgb(0, 153, 153);"   >1</span><span>))</span></div><div id="file-better-plan-full-blog-sql-LC13"   style="height: auto; float: none; clear: both;"   >              <span style="color: rgb(51, 51, 51);"   >Buffers</span><span>:</span> <span style="color: rgb(51, 51, 51);"   >shared</span> <span style="color: rgb(51, 51, 51);"   >hit</span><span style="font-weight: bold;"   >=</span><span style="color: rgb(0, 153, 153);"   >44963</span></div><div id="file-better-plan-full-blog-sql-LC14"   style="height: auto; float: none; clear: both;"   ><span style="color: rgb(51, 51, 51);"   >Total</span> <span style="color: rgb(51, 51, 51);"   >runtime</span><span>:</span> <span style="color: rgb(0, 153, 153);"   >263</span><span>.</span><span style="color: rgb(0, 153, 153);"   >639</span> <span style="color: rgb(51, 51, 51);"   >ms</span></div></pre></td></tr></table></div></div><div style="padding: 10px; overflow: hidden; font-stretch: normal; font-size: 12px; line-height: normal; font-family: 'Helvetica Neue', Helvetica, arial, freesans, clean, sans-serif; color: rgb(153, 153, 153); height: auto; float: none; clear: both; background-color: rgb(247, 247, 247);"   ><a style="color: rgb(102, 102, 102); text-decoration: none; float: right;" rel="nofollow" href="https://gist.github.com/alq666/6282734/raw/better-plan-full-blog.sql"   >view raw</a><a style="color: rgb(102, 102, 102); text-decoration: none;" rel="nofollow" href="https://gist.github.com/alq666/6282734#file-better-plan-full-blog-sql"   >better-plan-full-blog.sql</a>&nbsp;hosted with ? by&nbsp;<a style="color: rgb(102, 102, 102); text-decoration: none;" rel="nofollow" href="https://github.com/"   >GitHub</a></div></div></div><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   ></p><p style="margin-top: 22px; margin-bottom: 1em; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: rgb(86, 86, 86);"   >From 22,000ms to 200ms. That’s a 100x speedup for a simple one-line change.</p></div><div><br></div><div><br></div><div>[参考]</div><div><span style="line-height: 28px;"   >1. src/backend/parser/parse_relation.c</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case RTE_VALUES:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Values RTE --- get type info from first sublist */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* collation is stored separately, though */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List &nbsp; &nbsp; &nbsp; *collist = (List *) linitial(rte-&gt;values_lists);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Node &nbsp; &nbsp; &nbsp; *col;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (attnum &lt; 1 || attnum &gt; list_length(collist))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, "values list %s does not have attribute %d",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;rte-&gt;eref-&gt;aliasname, attnum);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; col = (Node *) list_nth(collist, attnum - 1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *vartype = exprType(col);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *vartypmod = exprTypmod(col);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *varcollid = list_nth_oid(rte-&gt;values_collations, attnum - 1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://www.datadoghq.com/2013/08/100x-faster-postgres-performance-by-changing-1-line/"   >https://www.datadoghq.com/2013/08/100x-faster-postgres-performance-by-changing-1-line/</a></div><div>3.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;* 4. ScalarArrayOpExpr ("indexkey op ANY (array-expression)"). &nbsp;If the index</font></div><div><font size="2"   >&nbsp;* has rd_am-&gt;amsearcharray, we handle these the same as simple operators,</font></div><div><font size="2"   >&nbsp;* setting the SK_SEARCHARRAY flag to tell the AM to handle them. &nbsp;Otherwise,</font></div><div><font size="2"   >&nbsp;* we create a ScanKey with everything filled in except the comparison value,</font></div><div><font size="2"   >&nbsp;* and set up an IndexArrayKeyInfo struct to drive processing of the qual.</font></div><div><font size="2"   >&nbsp;* (Note that if we use an IndexArrayKeyInfo struct, the array expression is</font></div><div><font size="2"   >&nbsp;* always treated as requiring runtime evaluation, even if it's a constant.)</font></div><p></p></pre></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL in  = any (values|array) - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>