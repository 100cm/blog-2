<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">connecting docker containers on multiple hosts with open vswitch GRE</h2>
	<h5 id="">2014-10-11 17:41:18&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020149115414214/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>转一篇</div><div><span style="line-height: 28px;"   >通过GRE联通多台主机上运行的containers.&nbsp;</span></div><div><span style="line-height: 28px;"   >可以用于解决没有VLAN或者网络不归自己管理的环境, 用gre穿透.</span></div><div><br></div><div>GRE概念</div><div><a target="_blank" rel="nofollow" href="http://en.wikipedia.org/wiki/Generic_Routing_Encapsulation"   >http://en.wikipedia.org/wiki/Generic_Routing_Encapsulation</a></div><div><br></div><div>OpenVswitch相关</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020147194247869/"   >http://blog.163.com/digoal@126/blog/static/16387704020147194247869/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020147111145122/"   >http://blog.163.com/digoal@126/blog/static/16387704020147111145122/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020147111358858/"   >http://blog.163.com/digoal@126/blog/static/16387704020147111358858/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020147683530613/"   >http://blog.163.com/digoal@126/blog/static/16387704020147683530613/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020147693015754/"   >http://blog.163.com/digoal@126/blog/static/16387704020147693015754/</a></div><div><br></div><div>通过GRE联通多台主机上运行的containers.</div><div><a target="_blank" rel="nofollow" href="https://goldmann.pl/blog/2014/01/21/connecting-docker-containers-on-multiple-hosts/"   >https://goldmann.pl/blog/2014/01/21/connecting-docker-containers-on-multiple-hosts/</a></div><div><br></div><div><h1 style="box-sizing: border-box; font-size: 36px; margin: 20px 0px 10px; font-family: 'PT Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif; font-weight: 500; line-height: 1.1; color: rgb(68, 68, 68);"   >Connecting Docker containers on multiple hosts</h1><div style="box-sizing: border-box; color: rgb(68, 68, 68); font-family: 'PT Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif; line-height: 22.8571434020996px;"   ><div id="preamble"   style="box-sizing: border-box;"   ><div style="box-sizing: border-box;"   ><div style="box-sizing: border-box; padding: 8px 35px 8px 14px; margin-bottom: 20px; text-shadow: rgba(255, 255, 255, 0.498039) 0px 1px 0px; border: 1px solid rgb(251, 238, 213); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(252, 248, 227);"   ><table style="box-sizing: border-box; border-collapse: collapse; border-spacing: 0px; max-width: 100%; background-color: transparent;"   ><tbody style="box-sizing: border-box;"   ><tr style="box-sizing: border-box;"   ><td style="box-sizing: border-box; padding: 0px 10px 0px 0px; font-weight: bold; vertical-align: top;"   ><div style="box-sizing: border-box;"   >Warning</div></td><td style="box-sizing: border-box; padding: 0px;"   >This guide is based on an old version of Docker. The instructions you find below may be already removed or changed in the Docker codebase.</td></tr></table></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >In my&nbsp;<a style="box-sizing: border-box; color: rgb(66, 139, 202); text-decoration: none; background: 0px 0px;" rel="nofollow" href="https://goldmann.pl/blog/2014/01/16/running-fedora-cloud-images-on-kvm/"   >previous blog post</a>&nbsp;I talked about running the&nbsp;<a style="box-sizing: border-box; color: rgb(66, 139, 202); text-decoration: none; background: 0px 0px;" rel="nofollow" href="http://fedoraproject.org/en/get-fedora#clouds"   >Fedora Cloud images</a>&nbsp;on a local KVM with libvirt. This was not a standalone task, but rather the preparation for this blog post: running&nbsp;<a style="box-sizing: border-box; color: rgb(66, 139, 202); text-decoration: none; background: 0px 0px;" rel="nofollow" href="http://www.docker.io/"   >Docker</a>&nbsp;containers on multiple hosts&nbsp;<span style="box-sizing: border-box; font-weight: 700;"   >attached to the same network</span>.</p></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >I was asked in the comments on my&nbsp;<a style="box-sizing: border-box; color: rgb(66, 139, 202); text-decoration: none; background: 0px 0px;" rel="nofollow" href="https://goldmann.pl/2013/10/07/wildfly-cluster-using-docker-on-fedora/"   >WildFly cluster based on Docker blog post</a>&nbsp;if it would be possible to run a cluster on multiple hosts. I found a&nbsp;<a style="box-sizing: border-box; color: rgb(66, 139, 202); text-decoration: none; background: 0px 0px;" rel="nofollow" href="http://fbevmware.blogspot.com/2013/12/coupling-docker-and-open-vswitch.html"   >very nice tutorial</a>&nbsp;written by Franck Besnard. I’ve decided to set up a similar environment on my own to see how/if it works.</p></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >I made a few changes to Franck’s set up:</p></div><div style="box-sizing: border-box;"   ><ol style="box-sizing: border-box; margin-top: 0px; margin-bottom: 10px;"   ><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >I’m not using the&nbsp;<a style="box-sizing: border-box; color: rgb(66, 139, 202); text-decoration: none; background: 0px 0px;" rel="nofollow" href="https://github.com/jpetazzo/pipework"   >pipework</a>&nbsp;script to minimize the dependencies.</p></li><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >I wanted to make the launching of the containers as simple as possible, so I dropped the use of the<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >ovswork.sh</code>&nbsp;script Franck crafted and I only use the&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >docker run</code>&nbsp;command.</p></li><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >I’m not creating a virtual ethernet device for each container?―?instead I’m attaching all containers to a bridge.</p></li><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >I’m not using VLAN’s (yet)</p></li></ol></div></div></div><div style="box-sizing: border-box;"   ><h2 id="_set_up"   style="box-sizing: border-box; font-family: inherit; font-weight: 500; line-height: 1.1; color: inherit; margin-top: 20px; margin-bottom: 10px; font-size: 30px;"   >Set up</h2><div style="box-sizing: border-box;"   ><a title="Networking" style="box-sizing: border-box; color: rgb(66, 139, 202); text-decoration: none; background: 0px 0px;" rel="nofollow" href="https://goldmann.pl/images/docker-network/network.png"   ><img title="connecting docker containers on multiple hosts with open vswitch GRE - 德哥@Digoal - PostgreSQL research"   alt="Networking"   src="https://goldmann.pl/images/docker-network/network.png"   style="box-sizing: border-box; vertical-align: middle; display: block; height: auto;"   ></a><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >I used two VM’s (<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >host1</code>&nbsp;and&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >host2</code>) each with Fedora 20 as the operating system. You can use&nbsp;<a style="box-sizing: border-box; color: rgb(66, 139, 202); text-decoration: none; background: 0px 0px;" rel="nofollow" href="https://gist.github.com/goldmann/8455702"   >the script</a>&nbsp;<a style="box-sizing: border-box; color: rgb(66, 139, 202); text-decoration: none; background: 0px 0px;" rel="nofollow" href="https://goldmann.pl/blog/2014/01/16/running-fedora-cloud-images-on-kvm/"   >I described in my previous post</a>&nbsp;to create them. Later you can use the&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >virsh start host1</code>&nbsp;command to run them.</p></div><div style="box-sizing: border-box;"   ><h3 id="_docker"   style="box-sizing: border-box; font-family: inherit; font-weight: 500; line-height: 1.1; color: inherit; margin-top: 20px; margin-bottom: 10px; font-size: 24px;"   >Docker</h3><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >On both hosts I’ve installed Docker:</p></div><div style="box-sizing: border-box;"   ><div style="box-sizing: border-box;"   ><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 13px; padding: 9.5px; margin-top: 0px; margin-bottom: 10px; line-height: 1.428571429; word-break: break-all; word-wrap: break-word; color: rgb(51, 51, 51); border: 1px solid rgb(204, 204, 204); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(245, 245, 245);"   >yum -y install docker-io</pre></div></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >The Docker configuration requires some changes.</p></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >By default Docker chooses a (more or less) random network to run the containers. After this it creates a bridge and assigns an address to it. This is not really what we want because we need to have static address assignment, so we need to prepare our own bridge and disable the one managed by Docker.</p></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Copy the&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >/usr/lib/systemd/system/docker.service</code>&nbsp;file to&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >/etc/systemd/system/docker.service</code>&nbsp;and add following content to disable the default&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >docker0</code>&nbsp;bridge creation on Docker startup.</p></div><div style="box-sizing: border-box;"   ><div style="box-sizing: border-box;"   ><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 13px; padding: 9.5px; margin-top: 0px; margin-bottom: 10px; line-height: 1.428571429; word-break: break-all; word-wrap: break-word; color: rgb(51, 51, 51); border: 1px solid rgb(204, 204, 204); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(245, 245, 245);"   >.include /usr/lib/systemd/system/docker.service

[Service]
ExecStart=
ExecStart=/usr/bin/docker -d -b=none</pre></div></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >You can start Docker with&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >systemctl start docker</code>.</p></div><div style="box-sizing: border-box; padding: 8px 35px 8px 14px; margin-bottom: 20px; text-shadow: rgba(255, 255, 255, 0.498039) 0px 1px 0px; border: 1px solid rgb(188, 232, 241); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; color: rgb(58, 135, 173); background-color: rgb(217, 237, 247);"   ><table style="box-sizing: border-box; border-collapse: collapse; border-spacing: 0px; max-width: 100%; background-color: transparent;"   ><tbody style="box-sizing: border-box;"   ><tr style="box-sizing: border-box;"   ><td style="box-sizing: border-box; padding: 0px 10px 0px 0px; font-weight: bold; vertical-align: top;"   ><div style="box-sizing: border-box;"   >Note</div></td><td style="box-sizing: border-box; padding: 0px;"   >Every time you modify a systemd service file do not forget to run&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >systemctl daemon-reload</code>&nbsp;to apply your changes.</td></tr></table></div></div><div style="box-sizing: border-box;"   ><h3 id="_networking"   style="box-sizing: border-box; font-family: inherit; font-weight: 500; line-height: 1.1; color: inherit; margin-top: 20px; margin-bottom: 10px; font-size: 24px;"   >Networking</h3><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >This is the interesting part :)</p></div><div style="box-sizing: border-box;"   ><h4 id="_open_vswitch"   style="box-sizing: border-box; font-family: inherit; font-weight: 500; line-height: 1.1; color: inherit; margin-top: 10px; margin-bottom: 10px; font-size: 18px;"   >Open vSwitch</h4><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >To make networking easy I used the&nbsp;<a style="box-sizing: border-box; color: rgb(66, 139, 202); text-decoration: none; background: 0px 0px;" rel="nofollow" href="http://openvswitch.org/"   >Open vSwitch</a>&nbsp;software. I’m very new to it, but its flexibility and ease of use is just impressive. I haven’t done any performance testing, though.&nbsp;<a style="box-sizing: border-box; color: rgb(66, 139, 202); text-decoration: none; background: 0px 0px;" rel="nofollow" href="http://en.wikipedia.org/wiki/Future"   >Maybe some day</a>.</p></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >You can install Open vSwitch on Fedora by running this command:</p></div><div style="box-sizing: border-box;"   ><div style="box-sizing: border-box;"   ><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 13px; padding: 9.5px; margin-top: 0px; margin-bottom: 10px; line-height: 1.428571429; word-break: break-all; word-wrap: break-word; color: rgb(51, 51, 51); border: 1px solid rgb(204, 204, 204); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(245, 245, 245);"   >yum -y install openvswitch</pre></div></div></div><div style="box-sizing: border-box;"   ><h4 id="_network_configuration"   style="box-sizing: border-box; font-family: inherit; font-weight: 500; line-height: 1.1; color: inherit; margin-top: 10px; margin-bottom: 10px; font-size: 18px;"   >Network configuration</h4><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >The script below prepares the networking for you. You can execute it on both hosts by adjusting the<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >REMOTE_IP</code>&nbsp;and&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >BRIDGE_ADDRESS</code>&nbsp;variables. The&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >BRIDGE_NAME</code>&nbsp;can be the same on both hosts.</p></div><div style="box-sizing: border-box;"   ><div style="box-sizing: border-box;"   ><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 13px; padding: 9.5px; margin-top: 0px; margin-bottom: 10px; line-height: 1.428571429; word-break: break-all; word-wrap: break-word; color: rgb(51, 51, 51); border: 1px solid rgb(204, 204, 204); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(245, 245, 245);"   ># The 'other' host
REMOTE_IP=192.168.122.189
# Name of the bridge
BRIDGE_NAME=docker0
# Bridge address
BRIDGE_ADDRESS=172.16.42.2/24

# Deactivate the docker0 bridge
ip link set $BRIDGE_NAME down
# Remove the docker0 bridge
brctl delbr $BRIDGE_NAME
# Delete the Open vSwitch bridge
ovs-vsctl del-br br0
# Add the docker0 bridge
brctl addbr $BRIDGE_NAME
# Set up the IP for the docker0 bridge
ip a add $BRIDGE_ADDRESS dev $BRIDGE_NAME
# Activate the bridge
ip link set $BRIDGE_NAME up
# Add the br0 Open vSwitch bridge
ovs-vsctl add-br br0
# Create the tunnel to the other host and attach it to the
# br0 bridge
ovs-vsctl add-port br0 gre0 -- set interface gre0 type=gre options:remote_ip=$REMOTE_IP
# Add the br0 bridge to docker0 bridge
brctl addif $BRIDGE_NAME br0

# Some useful commands to confirm the settings:
# ip a s
# ip r s
# ovs-vsctl show
# brctl show</pre></div></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >After executing these commands on both hosts you should be able to ping the&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >docker0</code>&nbsp;bridge addresses from both hosts.</p></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Here is an example from&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >host2</code>&nbsp;(ip&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >192.168.122.189</code>):</p></div><div style="box-sizing: border-box;"   ><div style="box-sizing: border-box;"   ><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 13px; padding: 9.5px; margin-top: 0px; margin-bottom: 10px; line-height: 1.428571429; word-break: break-all; word-wrap: break-word; color: rgb(51, 51, 51); border: 1px solid rgb(204, 204, 204); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(245, 245, 245);"   >$ ping 172.16.42.1
PING 172.16.42.1 (172.16.42.1) 56(84) bytes of data.
64 bytes from 172.16.42.1: icmp_seq=1 ttl=64 time=2.16 ms
64 bytes from 172.16.42.1: icmp_seq=2 ttl=64 time=0.628 ms
^C
--- 172.16.42.1 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 0.628/1.396/2.165/0.769 ms</pre></div></div></div><div style="box-sizing: border-box;"   ><h4 id="_networking_explained"   style="box-sizing: border-box; font-family: inherit; font-weight: 500; line-height: 1.1; color: inherit; margin-top: 10px; margin-bottom: 10px; font-size: 18px;"   >Networking explained</h4><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >The above script has some useful comments that help to understand what it’s doing, but here’s a high level view on the networking part.</p></div><div style="box-sizing: border-box;"   ><ol style="box-sizing: border-box; margin-top: 0px; margin-bottom: 10px;"   ><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Every container run with Docker is attached to&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >docker0</code>&nbsp;bridge. This is a&nbsp;<a style="box-sizing: border-box; color: rgb(66, 139, 202); text-decoration: none; background: 0px 0px;" rel="nofollow" href="http://www.tldp.org/HOWTO/BRIDGE-STP-HOWTO/"   >regular bridge</a>&nbsp;you can create on every Linux system, without the need for Open vSwitch.</p></li><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >The&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >docker0</code>&nbsp;bridge is attached to another bridge:&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >br0</code>. This time it’s an Open vSwitch bridge. This means that all traffic between containers is routed through&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >br0</code>&nbsp;too. You can think about two switches connected to each other.</p></li><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Additionally we need to connect together the networks from both hosts in which the containers are running. A&nbsp;<a style="box-sizing: border-box; color: rgb(66, 139, 202); text-decoration: none; background: 0px 0px;" rel="nofollow" href="http://en.wikipedia.org/wiki/Generic_Routing_Encapsulation"   >GRE tunnel</a>&nbsp;is used for this purpose. This tunnel is attached to the&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >br0</code>&nbsp;Open vSwitch bridge and as a result to&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >docker0</code>&nbsp;too.</p></li></ol></div></div></div></div></div><div style="box-sizing: border-box;"   ><h2 id="_the_issue_ip_assignment"   style="box-sizing: border-box; font-family: inherit; font-weight: 500; line-height: 1.1; color: inherit; margin-top: 20px; margin-bottom: 10px; font-size: 30px;"   >The issue: IP assignment</h2><div style="box-sizing: border-box;"   ><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >While creating this environment I found a problem.</p></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Docker assumes that it’s managing the network where the containers are run. It does not expect any other hosts to be run on the network besides the ones it starts. This works well in a typical environment (and definitely makes the code easier). But if we’re going to spread across multiple hosts?―?this can cause some headaches.</p></div><div style="box-sizing: border-box;"   ><h3 id="_docker_address_assignement_method"   style="box-sizing: border-box; font-family: inherit; font-weight: 500; line-height: 1.1; color: inherit; margin-top: 20px; margin-bottom: 10px; font-size: 24px;"   >Docker address assignement method</h3><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >The way Docker assignes IP addresses to the containers is very simple: it tries to assign the first&nbsp;<em style="box-sizing: border-box;"   >unused</em>address. It sounds valid, right? But it depends how do you define&nbsp;<em style="box-sizing: border-box;"   >not used</em>. When Docker starts a container?―?the assigned IP is added to a list of used IPs maintained by the Docker daemon.&nbsp;<em style="box-sizing: border-box;"   >Not used</em>&nbsp;IP in Docker’s case means that the IP wasn’t found in that list.</p></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >This can be problematic, though. If you run something manually on that network and you assign an IP to it?―?Docker will not be able to detect it and instead it can happen that Docker&nbsp;<span style="box-sizing: border-box; font-weight: 700;"   >assigns this IP blindly again causing a conflict</span>.</p></div></div><div style="box-sizing: border-box;"   ><h3 id="_solution"   style="box-sizing: border-box; font-family: inherit; font-weight: 500; line-height: 1.1; color: inherit; margin-top: 20px; margin-bottom: 10px; font-size: 24px;"   >Solution</h3><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Over the weekend I was thinking about some solutions, and I ended up with two:</p></div><div style="box-sizing: border-box;"   ><ol style="box-sizing: border-box; margin-top: 0px; margin-bottom: 10px;"   ><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Obvious one: change the Docker code to find out if the address is&nbsp;<span style="box-sizing: border-box; font-weight: 700;"   >really</span>&nbsp;free.</p></li><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Manually assign IP’s to the containers when running them.</p></li></ol></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Both have pros and cons. There may be other solutions too. Feel free to drop a comment if you find one.</p></div><div style="box-sizing: border-box;"   ><h4 id="_option_1_modifying_docker"   style="box-sizing: border-box; font-family: inherit; font-weight: 500; line-height: 1.1; color: inherit; margin-top: 10px; margin-bottom: 10px; font-size: 18px;"   >Option 1: Modifying Docker</h4><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >The first idea involves patching Docker. We need to make it aware of the hosts running on the network. From the beginning I was focused on using the&nbsp;<a style="box-sizing: border-box; color: rgb(66, 139, 202); text-decoration: none; background: 0px 0px;" rel="nofollow" href="http://en.wikipedia.org/wiki/Address_Resolution_Protocol"   >ARP protocol</a>.</p></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >I was trying to use the host ARP cache table for the interface bound to Docker (by default it’s&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >docker0</code>), but I found that:</p></div><div style="box-sizing: border-box;"   ><ol type="a"   style="box-sizing: border-box; margin-top: 0px; margin-bottom: 10px;"   ><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Containers do not advertise themselves on startup, and</p></li><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Even if we advertise manually (using&nbsp;<a style="box-sizing: border-box; color: rgb(66, 139, 202); text-decoration: none; background: 0px 0px;" rel="nofollow" href="http://en.wikipedia.org/wiki/Address_Resolution_Protocol#ARP_announcements"   >gratuitous ARP message</a>)?―?the ARP table is not reliable enough since entries will be removed after some time if there is no communication between these two hosts.</p></li></ol></div><div style="box-sizing: border-box; padding: 8px 35px 8px 14px; margin-bottom: 20px; text-shadow: rgba(255, 255, 255, 0.498039) 0px 1px 0px; border: 1px solid rgb(188, 232, 241); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; color: rgb(58, 135, 173); background-color: rgb(217, 237, 247);"   ><table style="box-sizing: border-box; border-collapse: collapse; border-spacing: 0px; max-width: 100%; background-color: transparent;"   ><tbody style="box-sizing: border-box;"   ><tr style="box-sizing: border-box;"   ><td style="box-sizing: border-box; padding: 0px 10px 0px 0px; font-weight: bold; vertical-align: top;"   ><div style="box-sizing: border-box;"   >Note</div></td><td style="box-sizing: border-box; padding: 0px;"   >Fedora does drop the broadcast ARP messages by default. You can change this by setting:<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >echo 1 &gt; /proc/sys/net/ipv4/conf/&lt;device&gt;/arp_accept</code>.&nbsp;<a style="box-sizing: border-box; color: rgb(66, 139, 202); text-decoration: none; background: 0px 0px;" rel="nofollow" href="https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt"   >Read more in the Linux kernel documentation</a>&nbsp;(search for&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >arp_accept</code>).</td></tr></table></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >But the good news is that we still can find if the selected IP is used by using the&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >arping</code>&nbsp;utility and this is what I used.</p></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >I prepared a&nbsp;<a style="box-sizing: border-box; color: rgb(66, 139, 202); text-decoration: none; background: 0px 0px;" rel="nofollow" href="https://gist.github.com/goldmann/8520776"   >very ugly patch</a>&nbsp;for Docker&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >0.7.6</code>&nbsp;which adds an additional check if the IP we’re trying to use is actually free.</p></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >In my testing I found that using arping is pretty reliable?―?the hosts were discovered properly and it didn’t take too long to find a free IP.</p></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >I built an RPM with this patch for Fedora 20, you can&nbsp;<a style="box-sizing: border-box; color: rgb(66, 139, 202); text-decoration: none; background: 0px 0px;" rel="nofollow" href="http://koji.fedoraproject.org/koji/taskinfo?taskID=6429484"   >download it from here</a>, if you want to give it a try.</p></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >After installing the patched Docker you should be able to run containers just like you’re used to:</p></div><div style="box-sizing: border-box;"   ><div style="box-sizing: border-box;"   ><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 13px; padding: 9.5px; margin-top: 0px; margin-bottom: 10px; line-height: 1.428571429; word-break: break-all; word-wrap: break-word; color: rgb(51, 51, 51); border: 1px solid rgb(204, 204, 204); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(245, 245, 245);"   >docker run -i -t centos:latest /bin/bash</pre></div></div></div><div style="box-sizing: border-box;"   ><h4 id="_option_2_manual_address_assignment"   style="box-sizing: border-box; font-family: inherit; font-weight: 500; line-height: 1.1; color: inherit; margin-top: 10px; margin-bottom: 10px; font-size: 18px;"   >Option 2: Manual address assignment</h4><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Sometimes patching Docker is not an option.</p></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >This is where assigning IP addresses manually makes sense. Since Docker does not expose the ability to assign a selected IP directly to the&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >docker run</code>&nbsp;command?―?we need to do this in two steps:</p></div><div style="box-sizing: border-box;"   ><ol style="box-sizing: border-box; margin-top: 0px; margin-bottom: 10px;"   ><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Disable the automatic network configuration in Docker by specifying&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >-n=false</code>,</p></li><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Configure networking using the LXC configuration using&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >-lxc-conf</code></p></li></ol></div><div style="box-sizing: border-box;"   ><h5 id="_example"   style="box-sizing: border-box; font-family: inherit; font-weight: 500; line-height: 1.1; color: inherit; margin-top: 10px; margin-bottom: 10px; font-size: 14px;"   >Example</h5><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >This is how it could be done:</p></div><div style="box-sizing: border-box;"   ><div style="box-sizing: border-box;"   ><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 13px; padding: 9.5px; margin-top: 0px; margin-bottom: 10px; line-height: 1.428571429; word-break: break-all; word-wrap: break-word; color: rgb(51, 51, 51); border: 1px solid rgb(204, 204, 204); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(245, 245, 245);"   >docker run \
-n=false \
-lxc-conf="lxc.network.type = veth" \
-lxc-conf="lxc.network.ipv4 = 172.16.42.20/24" \
-lxc-conf="lxc.network.ipv4.gateway = 172.16.42.1" \
-lxc-conf="lxc.network.link = docker0" \
-lxc-conf="lxc.network.name = eth0" \
-lxc-conf="lxc.network.flags = up" \
-i -t centos:latest /bin/bash</pre></div></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >This will run a CentOS container with networking set up as follows:</p></div><div style="box-sizing: border-box;"   ><ul style="box-sizing: border-box; margin-top: 0px; margin-bottom: 10px;"   ><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Create a virtual ethernet interface</p></li><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Attach this interface to the&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >docker0</code>&nbsp;bridge</p></li><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Expose it in the container as&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >eth0</code></p></li><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Assign the&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >172.16.42.20</code>&nbsp;IP to the interface</p></li><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Set up the default gateway as&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >172.16.42.1</code></p></li></ul></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >If you want to run multiple containers on one host, the only thing you’ll change is the IP address?―?everything else can be left as-is.</p></div></div></div></div></div></div><div style="box-sizing: border-box;"   ><h2 id="_expected_result"   style="box-sizing: border-box; font-family: inherit; font-weight: 500; line-height: 1.1; color: inherit; margin-top: 20px; margin-bottom: 10px; font-size: 30px;"   >Expected result</h2><div style="box-sizing: border-box;"   ><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >If you followed the tutorial (no matter which option you choose)?―?you should be able to run containers on both hosts. Containers should be attached to the same network and be able to ping each other. Additionaly no IP address conflicts should happen.</p></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Win!</p></div><div style="box-sizing: border-box;"   ><h3 id="_troubleshooting"   style="box-sizing: border-box; font-family: inherit; font-weight: 500; line-height: 1.1; color: inherit; margin-top: 20px; margin-bottom: 10px; font-size: 24px;"   >Troubleshooting</h3><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >If you encounter some problems?―?you need to check the configuration.</p></div><div style="box-sizing: border-box;"   ><ul style="box-sizing: border-box; margin-top: 0px; margin-bottom: 10px;"   ><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Make sure the&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >brctl show</code>&nbsp;command outputs similar content:</p></li></ul></div><div style="box-sizing: border-box;"   ><div style="box-sizing: border-box;"   ><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 13px; padding: 9.5px; margin-top: 0px; margin-bottom: 10px; line-height: 1.428571429; word-break: break-all; word-wrap: break-word; color: rgb(51, 51, 51); border: 1px solid rgb(204, 204, 204); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(245, 245, 245);"   >bridge name bridge id   STP enabled interfaces
docker0   8000.7a7c5f332842 no    br0</pre></div></div><div style="box-sizing: border-box;"   ><ul style="box-sizing: border-box; margin-top: 0px; margin-bottom: 10px;"   ><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Make sure the&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >ovs-vsctl show</code>&nbsp;command outputs similar content:</p></li></ul></div><div style="box-sizing: border-box;"   ><div style="box-sizing: border-box;"   ><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 13px; padding: 9.5px; margin-top: 0px; margin-bottom: 10px; line-height: 1.428571429; word-break: break-all; word-wrap: break-word; color: rgb(51, 51, 51); border: 1px solid rgb(204, 204, 204); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(245, 245, 245);"   >73f7bcaa-7141-4b20-8fa8-3a0c1ec34f39
    Bridge "br0"
        Port "br0"
            Interface "br0"
                type: internal
        Port "gre0"
            Interface "gre0"
                type: gre
                options: {remote_ip="192.168.122.43"}
    ovs_version: "2.0.0"</pre></div></div><div style="box-sizing: border-box;"   ><ul style="box-sizing: border-box; margin-top: 0px; margin-bottom: 10px;"   ><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Make sure you can ping&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >host1</code>&nbsp;from&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >host2</code>&nbsp;and vice-versa.</p></li><li style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Make sure you can ping the&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >docker0</code>&nbsp;interface running on&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >host1</code>&nbsp;from&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >host2</code>&nbsp;and vice-versa.</p></li></ul></div></div></div></div><div style="box-sizing: border-box;"   ><h2 id="_conclusion"   style="box-sizing: border-box; font-family: inherit; font-weight: 500; line-height: 1.1; color: inherit; margin-top: 20px; margin-bottom: 10px; font-size: 30px;"   >Conclusion</h2><div style="box-sizing: border-box;"   ><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >It’s possible to run Docker containers on different hosts that share the same network.</p></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >It’s even pretty simple. But like always?―?it could be better: Docker should make it possible without any workarounds.</p></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >One idea would be to implement the ARP requests directly in Go and drop the use of&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >arping</code>.</p></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >The other idea is to expose the network settings for the containers to the&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >docker run</code>&nbsp;call. I’m thinking here about the&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >-i</code>&nbsp;(IP with network prefix) and&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >-g</code>&nbsp;(gateway) options forwarded to&nbsp;<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); white-space: nowrap; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(248, 248, 248);"   >dockerinit</code>&nbsp;when launching a container.</p></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Whoah, you’re still reading this? Not bad.</p></div><div style="box-sizing: border-box;"   ><p style="box-sizing: border-box; margin-top: 0px;"   >Thanks!</p></div></div></div></div></div><wbr><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://goldmann.pl/blog/2014/01/21/connecting-docker-containers-on-multiple-hosts/"   >https://goldmann.pl/blog/2014/01/21/connecting-docker-containers-on-multiple-hosts/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://en.wikipedia.org/wiki/Generic_Routing_Encapsulation"   >http://en.wikipedia.org/wiki/Generic_Routing_Encapsulation</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="connecting docker containers on multiple hosts with open vswitch GRE - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>