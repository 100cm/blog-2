<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">docker network performance reduce by nat module & kvm vs docker vs localhost</h2>
	<h5 id="">2014-10-23 14:10:35&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201492315242694/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在测试docker下postgresql性能时, 发现的一个DNAT转换后的网络性能问题.</div><div><br></div><div>首先附上KVM,DOCKER,本机的几组测试数据(测试数据仅供参考, 有兴趣的朋友可以自己测试一下) :&nbsp;</div><div>注意在测试连接超出物理核心数后, docker的性能开始严重下降. (可能有优化手段解决这个问题)&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   > TPS                      16连接IP,             16连接UNIX SOCK,  48连接UNIX SOCK,  96连接UNIX SOCK<br>docker DNAT               29662<br>docker                    174089.814292          257437.255033    265112.234836     180037.521722 <br>kvm                       58692.023756           62217.477740     166212.113952     162729.867472 <br>本机                      185341.577666          271232.160555    335530.912484     303621.978815</span></font></div><p></p></pre></div><div><br></div><div>宿主机内核 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# uname -r</font></div><div><font size="2"   >2.6.32-431.el6.x86_64</font></div><p></p></pre></div><div>docker版本 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# docker info</font></div><div><font size="2"   >Containers: 1</font></div><div><font size="2"   >Images: 99</font></div><div><font size="2"   >Storage Driver: devicemapper</font></div><div><font size="2"   >&nbsp;Pool Name: docker-8:49-17826869-pool</font></div><div><font size="2"   >&nbsp;Data file: /var/lib/docker/devicemapper/devicemapper/data</font></div><div><font size="2"   >&nbsp;Metadata file: /var/lib/docker/devicemapper/devicemapper/metadata</font></div><div><font size="2"   >&nbsp;Data Space Used: 1455.9 Mb</font></div><div><font size="2"   >&nbsp;Data Space Total: 102400.0 Mb</font></div><div><font size="2"   >&nbsp;Metadata Space Used: 3.4 Mb</font></div><div><font size="2"   >&nbsp;Metadata Space Total: 2048.0 Mb</font></div><div><font size="2"   >Execution Driver: native-0.2</font></div><div><font size="2"   >Kernel Version: 2.6.32-431.el6.x86_64</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >本地的images如下 :&nbsp;</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# docker images</font></div><div><font size="2"   >REPOSITORY &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TAG &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IMAGE ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CREATED &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; VIRTUAL SIZE</font></div><div><font size="2"   >postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9.4-beta3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 68b6ddf9ca08 &nbsp; &nbsp; &nbsp; &nbsp;47 hours ago &nbsp; &nbsp; &nbsp; &nbsp;213.6 MB</font></div><div><font size="2"   >postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9.4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 68b6ddf9ca08 &nbsp; &nbsp; &nbsp; &nbsp;47 hours ago &nbsp; &nbsp; &nbsp; &nbsp;213.6 MB</font></div><div><font size="2"   >postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 935836384c52 &nbsp; &nbsp; &nbsp; &nbsp;47 hours ago &nbsp; &nbsp; &nbsp; &nbsp;212.9 MB</font></div><div><font size="2"   >postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;latest &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;935836384c52 &nbsp; &nbsp; &nbsp; &nbsp;47 hours ago &nbsp; &nbsp; &nbsp; &nbsp;212.9 MB</font></div><div><font size="2"   >postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9.3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 935836384c52 &nbsp; &nbsp; &nbsp; &nbsp;47 hours ago &nbsp; &nbsp; &nbsp; &nbsp;212.9 MB</font></div><div><font size="2"   >postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9.3.5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 935836384c52 &nbsp; &nbsp; &nbsp; &nbsp;47 hours ago &nbsp; &nbsp; &nbsp; &nbsp;212.9 MB</font></div><div><font size="2"   >postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9.2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2a9ab0b9fa56 &nbsp; &nbsp; &nbsp; &nbsp;47 hours ago &nbsp; &nbsp; &nbsp; &nbsp;212.7 MB</font></div><div><font size="2"   >postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9.2.9 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2a9ab0b9fa56 &nbsp; &nbsp; &nbsp; &nbsp;47 hours ago &nbsp; &nbsp; &nbsp; &nbsp;212.7 MB</font></div><div><font size="2"   >postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9.1.14 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ee60947f6805 &nbsp; &nbsp; &nbsp; &nbsp;47 hours ago &nbsp; &nbsp; &nbsp; &nbsp;212.1 MB</font></div><div><font size="2"   >postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9.1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ee60947f6805 &nbsp; &nbsp; &nbsp; &nbsp;47 hours ago &nbsp; &nbsp; &nbsp; &nbsp;212.1 MB</font></div><div><font size="2"   >postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9.0.18 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;f29be88283f6 &nbsp; &nbsp; &nbsp; &nbsp;47 hours ago &nbsp; &nbsp; &nbsp; &nbsp;211.5 MB</font></div><div><font size="2"   >postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; f29be88283f6 &nbsp; &nbsp; &nbsp; &nbsp;47 hours ago &nbsp; &nbsp; &nbsp; &nbsp;211.5 MB</font></div><div><font size="2"   >postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c57c14beb696 &nbsp; &nbsp; &nbsp; &nbsp;47 hours ago &nbsp; &nbsp; &nbsp; &nbsp;211 MB</font></div><div><font size="2"   >postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8.4.22 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c57c14beb696 &nbsp; &nbsp; &nbsp; &nbsp;47 hours ago &nbsp; &nbsp; &nbsp; &nbsp;211 MB</font></div><div><font size="2"   >postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8.4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c57c14beb696 &nbsp; &nbsp; &nbsp; &nbsp;47 hours ago &nbsp; &nbsp; &nbsp; &nbsp;211 MB</font></div><div><font size="2"   >postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9.4-beta2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bf872395e1d4 &nbsp; &nbsp; &nbsp; &nbsp;2 weeks ago &nbsp; &nbsp; &nbsp; &nbsp; 213.6 MB</font></div><p></p></pre></div><div><br></div><div>我们可以看看一个image的网络配置 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# docker inspect postgres:9.3.5</font></div><div><font size="2"   >[{</font></div><div><font size="2"   >&nbsp; &nbsp; "Architecture": "amd64",</font></div><div><font size="2"   >&nbsp; &nbsp; "Author": "",</font></div><div><font size="2"   >&nbsp; &nbsp; "Comment": "",</font></div><div><font size="2"   >&nbsp; &nbsp; "Config": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "AttachStderr": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "AttachStdin": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "AttachStdout": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Cmd": [</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "postgres"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ],</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "CpuShares": 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Cpuset": "",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Domainname": "",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Entrypoint": [</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "/docker-entrypoint.sh"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ],</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Env": [</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "PATH=/usr/lib/postgresql/9.3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "LANG=en_US.utf8",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "PG_MAJOR=9.3",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "PG_VERSION=9.3.5-1.pgdg70+1",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "PGDATA=/var/lib/postgresql/data"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ],</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "ExposedPorts": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "5432/tcp": {}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Hostname": "39d2c877bc4f",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Image": "15d042248df39ca896223c9e75f0f4541996f2b52030f1f8e6619cf18f77e395",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Memory": 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "MemorySwap": 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "NetworkDisabled": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "OnBuild": [],</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "OpenStdin": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "PortSpecs": null,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "StdinOnce": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Tty": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "User": "",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Volumes": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "/var/lib/postgresql/data": {}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "WorkingDir": ""</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "Container": "977043cde52cd15e070d71a67fbd8e2ec908af49123f3f773f71cda2061e9f44",</font></div><div><font size="2"   >&nbsp; &nbsp; "ContainerConfig": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "AttachStderr": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "AttachStdin": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "AttachStdout": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Cmd": [</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "/bin/sh",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "-c",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "#(nop) CMD [postgres]"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ],</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "CpuShares": 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Cpuset": "",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Domainname": "",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Entrypoint": [</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "/docker-entrypoint.sh"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ],</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Env": [</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "PATH=/usr/lib/postgresql/9.3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "LANG=en_US.utf8",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "PG_MAJOR=9.3",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "PG_VERSION=9.3.5-1.pgdg70+1",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "PGDATA=/var/lib/postgresql/data"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ],</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "ExposedPorts": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "5432/tcp": {}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Hostname": "39d2c877bc4f",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Image": "15d042248df39ca896223c9e75f0f4541996f2b52030f1f8e6619cf18f77e395",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Memory": 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "MemorySwap": 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "NetworkDisabled": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "OnBuild": [],</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "OpenStdin": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "PortSpecs": null,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "StdinOnce": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Tty": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "User": "",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Volumes": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "/var/lib/postgresql/data": {}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "WorkingDir": ""</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "Created": "2014-10-21T05:54:39.659381225Z",</font></div><div><font size="2"   >&nbsp; &nbsp; "DockerVersion": "1.2.0",</font></div><div><font size="2"   >&nbsp; &nbsp; "Id": "935836384c524aafc0ac1c05246002c9c93343f0b4283a34e77a5f92f97f9a7c",</font></div><div><font size="2"   >&nbsp; &nbsp; "Os": "linux",</font></div><div><font size="2"   >&nbsp; &nbsp; "Parent": "15d042248df39ca896223c9e75f0f4541996f2b52030f1f8e6619cf18f77e395",</font></div><div><font size="2"   >&nbsp; &nbsp; "Size": 0</font></div><div><font size="2"   >}</font></div><p></p></pre></div></div><div><br></div><div>启动一个container, 使用-P将端口映射出来.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# docker run -d -P postgres:9.3.5</font></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# docker ps</font></div><div><font size="2"   >CONTAINER ID &nbsp; &nbsp; &nbsp; &nbsp;IMAGE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CREATED &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; STATUS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PORTS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NAMES</font></div><div><font size="2"   >786d815d71b0 &nbsp; &nbsp; &nbsp; &nbsp;postgres:9 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/docker-entrypoint.s &nbsp; 2 hours ago &nbsp; &nbsp; &nbsp; &nbsp; Up 2 hours &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0:49155-&gt;5432/tcp &nbsp; suspicious_wright &nbsp;&nbsp;</font></div></div><p></p></pre></div><div><br></div><div>这个时候会自动创建nat转换条目, 可以使用iptables-save命令查看, 如下有一台DNAT的规则是端口49155的转发 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# iptables-save</font></div><div><div><font size="2"   ># Generated by iptables-save v1.4.7 on Thu Oct 23 14:00:48 2014</font></div><div><font size="2"   >*nat</font></div><div><font size="2"   >:PREROUTING ACCEPT [109:52442]</font></div><div><font size="2"   >:POSTROUTING ACCEPT [90:4680]</font></div><div><font size="2"   >:OUTPUT ACCEPT [90:4680]</font></div><div><font size="2"   >:DOCKER - [0:0]</font></div><div><font size="2"   >-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER&nbsp;</font></div><div><font size="2"   >-A POSTROUTING -s 172.17.0.0/16 ! -d 172.17.0.0/16 -j MASQUERADE&nbsp;</font></div><div><font size="2"   >-A POSTROUTING -s 172.17.0.0/16 ! -d 172.17.0.0/16 -j MASQUERADE&nbsp;</font></div><div><font size="2"   >-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER&nbsp;</font></div><div><font size="2"   >-A DOCKER ! -i docker0 -p tcp -m tcp --dport 49155 -j DNAT --to-destination 172.17.0.4:5432&nbsp;</font></div><div><font size="2"   >COMMIT</font></div><div><font size="2"   ># Completed on Thu Oct 23 14:00:48 2014</font></div></div><p></p></pre></div><div><br></div><div>同时查看这个container的网络, 也就是说, 外部可以通过宿主机的<span style="line-height: 28px;"   >49155</span><span style="line-height: 28px;"   >&nbsp;端口访问这个container的postgresql数据库.</span></div><div><span style="line-height: 28px;"   >宿主机本地则可以通过127.0.0.1:</span><span style="line-height: 28px;"   >49155</span><span style="line-height: 28px;"   >&nbsp;或</span><span style="line-height: 28px;"   >172.17.0.4:5432来访问.</span></div><div><span style="line-height: 28px;"   >问题来了 :&nbsp;</span></div><div><span style="line-height: 28px;"   >通过nat访问的性能和直接访问的性能差太多了.</span></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; "NetworkSettings": {</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Bridge": "docker0",</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Gateway": "172.17.42.1",</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "IPAddress": "172.17.0.4",</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "IPPrefixLen": 16,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "PortMapping": null,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Ports": {</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "5432/tcp": [</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "HostIp": "0.0.0.0",</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "HostPort": "49155"</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div></div><div style="line-height: 28px;"   >详细 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# docker inspect 786d815d71b0</font></div><div><font size="2"   >[{</font></div><div><font size="2"   >&nbsp; &nbsp; "Args": [</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "postgres"</font></div><div><font size="2"   >&nbsp; &nbsp; ],</font></div><div><font size="2"   >&nbsp; &nbsp; "Config": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "AttachStderr": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "AttachStdin": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "AttachStdout": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Cmd": [</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "postgres"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ],</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "CpuShares": 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Cpuset": "",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Domainname": "",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Entrypoint": [</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "/docker-entrypoint.sh"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ],</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Env": [</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "PATH=/usr/lib/postgresql/9.3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "LANG=en_US.utf8",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "PG_MAJOR=9.3",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "PG_VERSION=9.3.5-1.pgdg70+1",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "PGDATA=/var/lib/postgresql/data"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ],</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "ExposedPorts": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "5432/tcp": {}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Hostname": "786d815d71b0",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Image": "postgres:9.3.5",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Memory": 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "MemorySwap": 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "NetworkDisabled": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "OnBuild": null,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "OpenStdin": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "PortSpecs": null,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "StdinOnce": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Tty": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "User": "",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Volumes": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "/var/lib/postgresql/data": {}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "WorkingDir": ""</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "Created": "2014-10-23T02:51:06.152941964Z",</font></div><div><font size="2"   >&nbsp; &nbsp; "Driver": "devicemapper",</font></div><div><font size="2"   >&nbsp; &nbsp; "ExecDriver": "native-0.2",</font></div><div><font size="2"   >&nbsp; &nbsp; "HostConfig": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Binds": null,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "ContainerIDFile": "",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Dns": null,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "DnsSearch": null,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Links": null,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "LxcConf": [],</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "NetworkMode": "bridge",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "PortBindings": {},</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Privileged": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "PublishAllPorts": true,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "VolumesFrom": null</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "HostnamePath": "/var/lib/docker/containers/786d815d71b0dca10042e73842634483158811a9c54509e58d7a1d2afa6fd94d/hostname",</font></div><div><font size="2"   >&nbsp; &nbsp; "HostsPath": "/var/lib/docker/containers/786d815d71b0dca10042e73842634483158811a9c54509e58d7a1d2afa6fd94d/hosts",</font></div><div><font size="2"   >&nbsp; &nbsp; "Id": "786d815d71b0dca10042e73842634483158811a9c54509e58d7a1d2afa6fd94d",</font></div><div><font size="2"   >&nbsp; &nbsp; "Image": "935836384c524aafc0ac1c05246002c9c93343f0b4283a34e77a5f92f97f9a7c",</font></div><div><font size="2"   >&nbsp; &nbsp; "MountLabel": "",</font></div><div><font size="2"   >&nbsp; &nbsp; "Name": "/suspicious_wright",</font></div><div><font size="2"   >&nbsp; &nbsp; "NetworkSettings": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Bridge": "docker0",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Gateway": "172.17.42.1",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "IPAddress": "172.17.0.4",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "IPPrefixLen": 16,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "PortMapping": null,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Ports": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "5432/tcp": [</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "HostIp": "0.0.0.0",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "HostPort": "49155"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ]</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "Path": "/docker-entrypoint.sh",</font></div><div><font size="2"   >&nbsp; &nbsp; "ProcessLabel": "",</font></div><div><font size="2"   >&nbsp; &nbsp; "ResolvConfPath": "/etc/resolv.conf",</font></div><div><font size="2"   >&nbsp; &nbsp; "State": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "ExitCode": 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "FinishedAt": "0001-01-01T00:00:00Z",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Paused": false,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Pid": 22251,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "Running": true,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "StartedAt": "2014-10-23T02:51:06.931436989Z"</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "Volumes": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "/var/lib/postgresql/data": "/var/lib/docker/vfs/dir/8df8643eb4f255471b744a957a168fb9e1e57b1169ade6fba8b5f3a912681e88"</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "VolumesRW": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "/var/lib/postgresql/data": true</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div><br></div><div>这个启动container后为container创建的接口.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># ifconfig</font></div><div><div><font size="2"   >veth2d30 &nbsp;Link encap:Ethernet &nbsp;HWaddr 42:9B:9F:1F:09:B0 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet6 addr: fe80::409b:9fff:fe1f:9b0/64 Scope:Link</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:6289977 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:6290136 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:1000&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:786242516 (749.8 MiB) &nbsp;TX bytes:597549874 (569.8 MiB)</font></div></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# brctl show</font></div><div><font size="2"   >bridge name &nbsp; &nbsp; bridge id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; STP enabled &nbsp; &nbsp; interfaces</font></div><div><font size="2"   >docker0 &nbsp; &nbsp; &nbsp; &nbsp; 8000.429b9f1f09b0 &nbsp; &nbsp; &nbsp; no &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;veth2d30</font></div></div><p></p></pre></div><div><br></div><div>测试如下, 执行select 1; :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-221 ~]# cd</font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# psql -V</font></div><div><font size="2"   >psql (PostgreSQL) 9.3.5</font></div></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# vi test.sql</font></div><div><font size="2"   >select 1;</font></div></div><p></p></pre></div><div>通过NAT转换的性能 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# pgbench -M prepared -n -r -f ./test.sql -h 127.0.0.1 -p 49155 -U postgres -c 16 -j 4 -T 30 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 889901</font></div><div><font size="2"   >tps = 29662.517330 (including connections establishing)</font></div><div><font size="2"   >tps = 29677.580497 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.537902 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><p></p></pre></div><div>直接连接container访问的性能 :&nbsp;</div><div>显然使用nat转换带来的性能损失非常大, TPS下降到了17%.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# pgbench -M prepared -n -r -f ./test.sql -h 172.17.0.4 -p 5432 -U postgres -c 16 -j 4 -T 30 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 5222786</font></div><div><font size="2"   >tps = 174089.814292 (including connections establishing)</font></div><div><font size="2"   >tps = 174177.646184 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.090595 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >另外 , 附上直接访问宿主机本地的数据库的性能, 我们看到docker性能损失极少(约6%) :&nbsp;</span></div><div><span style="line-height: 28px;"   >相比KVM虚拟化, CPU损耗方面, DOCKER的性能损耗确实非常低, KVM参考 :&nbsp;</span></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201322815029796/"   >http://blog.163.com/digoal@126/blog/static/163877040201322815029796/</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# pgbench -M prepared -n -r -f ./test.sql -h 127.0.0.1 -p 5432 -U postgres -c 16 -j 4 -T 30 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 5560383</font></div><div><font size="2"   >tps = 185341.577666 (including connections establishing)</font></div><div><font size="2"   >tps = 185435.133589 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.084922 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><p></p></pre></div><div>在同一台宿主机下KVM虚拟机测试结果如下(kvm VCPU=48, 宿主机48核) :&nbsp;</div><div>宿主机CPU :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 47</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 46</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E7540 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1995.262</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 18432 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 3</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 12</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 11</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 6</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 119</font></div><div><font size="2"   >initial apicid &nbsp;: 119</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx rdtscp lm constant_tsc arch_perfmon pebs bts rep_good xtopology nonstop_tsc aperfmperf pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 sse4_2 x2apic popcnt lahf_lm ida epb dts tpr_shadow vnmi flexpriority ept vpid</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3989.44</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 44 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management:</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >4SOCKET</font></div><div><font size="2"   >6CORE</font></div><div><font size="2"   >2TH</font></div><p></p></pre></div><div>共48核心</div><div>虚拟机CPU(问题可能出自这里) :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 47</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel Core i7 9xx (Nehalem Class Core i7)</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 3</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1995.047</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 3</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 12</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 5</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 6</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 59</font></div><div><font size="2"   >initial apicid &nbsp;: 59</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 4</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss ht syscall nx lm constant_tsc unfair_spinlock pni ssse3 cx16 sse4_1 sse4_2 x2apic popcnt hypervisor lahf_lm</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3990.09</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 44 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management:</font></div><p></p></pre></div><div>KVM进程 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   ><span style="line-height: 21px;"   >qemu     29307     1 55 15:57 ?        00:00:07 /usr/libexec/qemu-kvm -name test1 -S -M rhel6.5.0 -cpu Nehalem,+rdtscp,+x2apic,+dca,+pdcm,+xtpr,+tm2,+est,+vmx,+ds_cpl,+monitor,+dtes64,+pbe,+tm,+ht,+ss,+acpi,+ds,+vme -enable-kvm -m 8192 -realtime mlock=off -smp 48,sockets=4,cores=6,threads=2 -uuid 073dbc6f-f376-2c96-6323-e0cc488eda68 -nodefconfig -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/test1.monitor,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc -no-shutdown -device piix3-usb-uhci,id=usb,bus=pci.0,addr=0x1.0x2 -drive file=/var/lib/libvirt/images/test1.img,if=none,id=drive-virtio-disk0,format=raw,cache=none -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x5,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive if=none,media=cdrom,id=drive-ide0-1-0,readonly=on,format=raw -device ide-drive,bus=ide.1,unit=0,drive=drive-ide0-1-0,id=ide0-1-0 -netdev tap,fd=21,id=hostnet0,vhost=on,vhostfd=22 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:d6:b2:07,bus=pci.0,addr=0x3 -chardev pty,id=charserial0 -device isa-serial,chardev=charserial0,id=serial0 -device usb-tablet,id=input0 -vnc 127.0.0.1:0 -vga cirrus -device intel-hda,id=sound0,bus=pci.0,addr=0x4 -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0 -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x6</span></font></p></pre></div><div>KVM性能(损耗68%) :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >[root@db-172-16-3-221 ~]# pgbench -M prepared -n -r -f ./test.sql -h 172.17.42.222 -p 5432 -U postgres -c 16 -j 4 -T 30 postgres<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 16<br>number of threads: 4<br>duration: 30 s<br>number of transactions actually processed: 1760790<br>tps = 58692.023756 (including connections establishing)<br>tps = 58743.201940 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        0.271061        select 1;</span></font></div><p></p></pre></div><div>计算密集型的话docker有明显优势.</div><div><br></div><div>最后再来一组unix socket的测试结果 :&nbsp;</div><div>本机 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# pgbench -M prepared -n -r -f ./test.sql -h /data01/pgdata/pg_root -p 5432 -U postgres -c 16 -j 4 -T 30 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 8137047</font></div><div><font size="2"   >tps = 271232.160555 (including connections establishing)</font></div><div><font size="2"   >tps = 271348.434446 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.057746 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><p></p></pre></div><div><br></div><div>docker (性能损耗5%)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# docker run -t -i postgres:9.3.5 /bin/bash</font></div><div><div><font size="2"   >root@48f8decd3ccb:/# more docker-entrypoint.sh&nbsp;</font></div><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   >set -e</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >if [ "$1" = 'postgres' ]; then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; chown -R postgres "$PGDATA"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if [ -z "$(ls -A "$PGDATA")" ]; then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gosu postgres initdb</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sed -ri "s/^#(listen_addresses\s*=\s*)\S+/\1'*'/" "$PGDATA"/postgresql.conf</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; { echo; echo 'host all all 0.0.0.0/0 trust'; } &gt;&gt; "$PGDATA"/pg_hba.conf</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if [ -d /docker-entrypoint-initdb.d ]; then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for f in /docker-entrypoint-initdb.d/*.sh; do</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [ -f "$f" ] &amp;&amp; . "$f"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; done</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fi</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fi</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; exec gosu postgres "$@"</font></div><div><font size="2"   >fi</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >exec "$@"</font></div><div><font size="2"   >root@48f8decd3ccb:/# ./docker-entrypoint.sh postgres</font></div></div><div><font size="2"   >root@48f8decd3ccb:/# echo "select 1;" &gt; ./test.sql</font></div><div><div><font size="2"   >root@48f8decd3ccb:/# pgbench -M prepared -n -r -f ./test.sql -h /var/run/postgresql -p 5432 -U postgres -c 16 -j 4 -T 30 postgres &nbsp; transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 7723173</font></div><div><font size="2"   >tps = 257437.255033 (including connections establishing)</font></div><div><font size="2"   >tps = 257554.115083 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.060943 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div></div><p></p></pre></div><div><br></div><div>kvm (性能损耗77%)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@localhost-&gt; pgbench -M prepared -n -r -f ./test.sql -h /home/postgres/pgdata/pg_root -p 5432 -U postgres -c 16 -j 4 -T 30 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 1866859</font></div><div><font size="2"   >tps = 62217.477740 (including connections establishing)</font></div><div><font size="2"   >tps = 62248.936343 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.254873 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><p></p></pre></div><div><br></div><div>加大连接后, kvm有性能提升. 但是到顶也只能达到16.6W左右, 性能损失46.4%左右.</div><div>DOCKER的话, 超出核数后性能下降严重, 在达到物理核限制极限时, 损失12.7% 左右.&nbsp;</div><div>KVM加大连接(CPU使用率1200%) :&nbsp;</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 28px;"   ><font size="2"   >top - 17:54:56 up 43 days, &nbsp;7:58, &nbsp;3 users, &nbsp;load average: 4.72, 1.43, 0.53</font></div><div style="line-height: 28px;"   ><font size="2"   >Tasks: 1115 total, &nbsp; 1 running, 1114 sleeping, &nbsp; 0 stopped, &nbsp; 0 zombie</font></div><div style="line-height: 28px;"   ><font size="2"   >Cpu(s): 24.9%us, &nbsp;0.2%sy, &nbsp;0.0%ni, 74.9%id, &nbsp;0.0%wa, &nbsp;0.0%hi, &nbsp;0.0%si, &nbsp;0.0%st</font></div><div style="line-height: 28px;"   ><font size="2"   >Mem: &nbsp;99045564k total, 13146680k used, 85898884k free, &nbsp; 272772k buffers</font></div><div style="line-height: 28px;"   ><font size="2"   >Swap: &nbsp;1048568k total, &nbsp; &nbsp; &nbsp; &nbsp;0k used, &nbsp;1048568k free, &nbsp;9688200k cached</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;RES &nbsp;SHR S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >30008 qemu &nbsp; &nbsp; &nbsp;20 &nbsp; 0 11.8g 815m 5828 S 1204.4 &nbsp;0.8 &nbsp;20:56.29 /usr/libexec/qemu-kvm -name test1 -S -M rhel6.5.0 -cpu Nehalem,+rdtsc</font></div></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div><div><font size="2"   >postgres@localhost-&gt; pgbench -M prepared -n -r -f ./test.sql -h /home/postgres/pgdata/pg_root -p 5432 -U postgres -c 48 -j 12 -T 30 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 48</font></div><div><font size="2"   >number of threads: 12</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 4988101</font></div><div><font size="2"   >tps = 166212.113952 (including connections establishing)</font></div><div><font size="2"   >tps = 166348.747712 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.285856 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@localhost-&gt; pgbench -M prepared -n -r -f ./test.sql -h /home/postgres/pgdata/pg_root -p 5432 -U postgres -c 96 -j 12 -T 30 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 96</font></div><div><font size="2"   >number of threads: 12</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 4885569</font></div><div><font size="2"   >tps = 162729.867472 (including connections establishing)</font></div><div><font size="2"   >tps = 163017.799292 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.585876 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div></div><p></p></pre></div></div><div><br></div><div>本地加大连接 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# pgbench -M prepared -n -r -f ./test.sql -h /data01/pgdata/pg_root -p 5432 -U postgres -c 48 -j 12 -T 30 postgres<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 48<br>number of threads: 12<br>duration: 30 s<br>number of transactions actually processed: 10068364<br>tps = 335530.912484 (including connections establishing)<br>tps = 335757.764533 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        0.141343        select 1;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# pgbench -M prepared -n -r -f ./test.sql -h /data01/pgdata/pg_root -p 5432 -U postgres -c 96 -j 12 -T 30 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 96</font></div><div><font size="2"   >number of threads: 12</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 9113013</font></div><div><font size="2"   >tps = 303621.978815 (including connections establishing)</font></div><div><font size="2"   >tps = 304050.332175 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.313762 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><p></p></pre></div><div><br></div><div>docker加大连接 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >root@48f8decd3ccb:/# pgbench -M prepared -n -r -f ./test.sql -h /var/run/postgresql -p 5432 -U postgres -c 96 -j 12 -T 30 postgres&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 96</font></div><div><font size="2"   >number of threads: 12</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 5403085</font></div><div><font size="2"   >tps = 180037.521722 (including connections establishing)</font></div><div><font size="2"   >tps = 180248.827373 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.527325 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >root@48f8decd3ccb:/# pgbench -M prepared -n -r -f ./test.sql -h /var/run/postgresql -p 5432 -U postgres -c 40 -j 10 -T 30 postgres&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 40</font></div><div><font size="2"   >number of threads: 10</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 7955103</font></div><div><font size="2"   >tps = 265112.234836 (including connections establishing)</font></div><div><font size="2"   >tps = 265278.332675 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.147930 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >[参考]</span></div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://docs.docker.com/userguide/"   >http://docs.docker.com/userguide/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201322815029796/"   >http://blog.163.com/digoal@126/blog/static/163877040201322815029796/</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="docker network performance reduce by nat module - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>