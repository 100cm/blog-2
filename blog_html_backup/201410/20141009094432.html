<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL password security</h2>
	<h5 id="">2014-10-09 9:44:32&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020149852941586/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><span style="line-height: 28px;"   >数据库密码管理是数据库安全的重要环节之一.</span></div><div><span style="line-height: 28px;"   >例如简单密码策略应该包含 :&nbsp;</span></div><div><span style="line-height: 28px;"   >1. 密码复杂度</span></div><div><span style="line-height: 28px;"   >2. 密码验证失败延迟</span></div><div><span style="line-height: 28px;"   >3. 密码更换周期, 以及</span><span style="line-height: 28px;"   >重复使用策略</span></div><div>4. 密码验证失败几次后锁定, 以及解锁时间等</div><div>5. 设置密码时防止密码被记录到数据库日志,history,或审计日志中. (也可以使用pwd+user的md5值设置密码, 或者使用提示输入) , 创建用户时使用createuser命令行工具-W选项提示输入密码. 修改用户密码建议使用pg_md5工具生成密码, 在psql中使用ALTER ROLE填入md5值.</div><div><span style="line-height: 28px;"   ><br></span></div><div>下面依次来讲解一下在PostgreSQL中如何实现简单的密码策略.</div><div><span style="line-height: 28px;"   >1. 密码复杂度</span></div><div><span style="line-height: 28px;"   >PostgreSQL提供了一个插件</span><span style="line-height: 28px;"   >passwordcheck可以满足简单的密码复杂度测验, 防止使用过短, 或者与包含用户名的密码.</span></div><div><span style="line-height: 28px;"   >如果需要更复杂的检查, 可以让</span><span style="line-height: 28px;"   >passwordcheck使用crack库.</span></div><div>安装过程 :&nbsp;</div><div>安装cracklib以及字典</div><pre class="prettyprint"   ><p></p><div><font size="2"   ># yum install -y cracklib-devel&nbsp;<span style="line-height: 28px;"   >cracklib</span>-dicts&nbsp;cracklib</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >字典如下(.pwd结尾文件) :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 cracklib]# rpm -ql cracklib-dicts</font></div><div><font size="2"   >/usr/lib64/cracklib_dict.hwm</font></div><div><font size="2"   >/usr/lib64/cracklib_dict.pwd</font></div><div><font size="2"   >/usr/lib64/cracklib_dict.pwi</font></div><div><font size="2"   >/usr/sbin/mkdict</font></div><div><font size="2"   >/usr/sbin/packer</font></div><div><font size="2"   >/usr/share/cracklib</font></div><div><font size="2"   >/usr/share/cracklib/cracklib-small.hwm</font></div><div><font size="2"   >/usr/share/cracklib/cracklib-small.pwd</font></div><div><font size="2"   >/usr/share/cracklib/cracklib-small.pwi</font></div><div><font size="2"   >/usr/share/cracklib/pw_dict.hwm</font></div><div><font size="2"   >/usr/share/cracklib/pw_dict.pwd</font></div><div><font size="2"   >/usr/share/cracklib/pw_dict.pwi</font></div><p></p></pre></div><div>当然, 你也可以使用&nbsp;create-cracklib-dict 通过word文件自行生成字典.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >下载word文件</font></div><div><font size="2"   >http://sourceforge.net/projects/cracklib/files/cracklib-words/2008-05-07/</font></div><div><font size="2"   >(可以自行添加word进去)</font></div><div><div><font size="2"   ># cd /opt/soft_bak/</font></div><div><font size="2"   ># wget http://downloads.sourceforge.net/project/cracklib/cracklib-words/2008-05-07/cracklib-words-20080507.gz?r=http%3A%2F%2Fsourceforge.net%2Fprojects%2Fcracklib%2Ffiles%2Fcracklib-words%2F2008-05-07%2F&amp;ts=1412826278&amp;use_mirror=nchc</font></div></div><div><font size="2"   ># tar -zxvf&nbsp;cracklib-words-20080507.gz</font></div><div><font size="2"   ># gunzip&nbsp;<span style="line-height: 28px;"   >cracklib-words-20080507.gz</span></font></div><div><div><font size="2"   >[root@db-172-16-3-221 soft_bak]# less cracklib-words-20080507&nbsp;</font></div><div><font size="2"   >`</font></div><div><font size="2"   >`!@#$%^&amp;*()_+</font></div><div><font size="2"   >^</font></div><div><font size="2"   >^%$#@!</font></div><div><font size="2"   >~</font></div><div><font size="2"   >~!@</font></div><div><font size="2"   >~!@#</font></div><div><font size="2"   >~!@#~@!#</font></div></div><div><font size="2"   >创建字典文件</font></div><div><div><font size="2"   >[root@db-172-16-3-221 soft_bak]# create-cracklib-dict -h</font></div><div><font size="2"   >Usage: create-cracklib-dict [options] wordlist ...</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This script takes one or more word list files as arguments</font></div><div><font size="2"   >and converts them into cracklib dictionaries for use</font></div><div><font size="2"   >by password checking programs. The results are placed in</font></div><div><font size="2"   >the default compiled-in dictionary location.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >If you wish to store the dictionary in a different location,</font></div><div><font size="2"   >use the cracklib-format and cracklib-packer commands directly.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Options:</font></div><div><font size="2"   >&nbsp; -o, --output &lt;file&gt; &nbsp; Alternative output file for cracklib-packer</font></div><div><font size="2"   >&nbsp; -h, --help &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;This help output</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Example:</font></div><div><font size="2"   >create-cracklib-dict /usr/share/words</font></div><div><font size="2"   >[root@db-172-16-3-221 soft_bak]# create-cracklib-dict -o ./cracklib-dict ./cracklib-words-20080507&nbsp;</font></div><div><font size="2"   >skipping line: 1</font></div><div><font size="2"   >1669426 1669425</font></div></div><div><div><font size="2"   >[root@db-172-16-3-221 soft_bak]# ll cracklib-dict.*</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; &nbsp;1024 Oct &nbsp;9 12:00 cracklib-dict.hwm</font></div><div><font size="2"   >-rw-r--r-- 1 root root 7472513 Oct &nbsp;9 12:00 cracklib-dict.pwd</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;417372 Oct &nbsp;9 12:00 cracklib-dict.pwi</font></div></div><p></p></pre></div><div>使用这个密码文件</div><div><br></div><div>修改<span style="line-height: 28px;"   >passwordcheck.c以及Makefile.</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-221 cracklib]# cd /opt/soft_bak/postgresql-9.3.5/contrib/passwordcheck/</font></div></div><div><span style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-221 passwordcheck]# vi passwordcheck.c</font></span></div><div><div><font size="2"   >#ifdef USE_CRACKLIB</font></div><div><span style="line-height: 28px;"   ><font size="2"   >#include &lt;crack.h&gt;</font></span></div><div><font size="2"   >// &nbsp;如果是源码安装的cracklib, 可能需要修改如下, 本例不需要修改</font></div><div><font size="2"   ><span style="line-height: 28px;"   >// &nbsp;#include "</span><span style="line-height: 28px;"   >/opt/cracklib/include/</span><span style="line-height: 28px;"   >crack.h"</span></font></div><div><font size="2"   >#endif</font></div></div><div><div><font size="2"   >/* passwords shorter than this will be rejected, 最小密码长度最好改成20或更大 */</font></div><div><font size="2"   >#define MIN_PWD_LENGTH 20</font></div></div><p></p></pre></div><div><br></div><div>修改Makefile, 把注释去掉, 并修改字典文件(不要带.pwd后缀).</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-221 passwordcheck]# vi Makefile</font></span></div><div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   ># contrib/passwordcheck/Makefile</font></div></div><div><div style="line-height: 28px;"   ><font size="2"   ># uncomment the following two lines to enable cracklib support</font></div><div style="line-height: 28px;"   ><font size="2"   >PG_CPPFLAGS = -DUSE_CRACKLIB '-DCRACKLIB_DICTPATH="<span style="line-height: 28px;"   >/usr/share/cracklib/pw_dict</span><span style="line-height: 28px;"   >"'</span></font></div><div style="line-height: 28px;"   ><font size="2"   ># 修改字典文件&nbsp;<span style="line-height: 28px;"   >/usr/lib/cracklib_dict</span></font></div><div style="line-height: 28px;"   ><font size="2"   >SHLIB_LINK = -lcrack</font></div></div></div><p></p></pre></div><div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >安装模块:&nbsp;</div><div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-221 passwordcheck]# make clean</font></div><div style="line-height: 28px;"   ><font size="2"   >rm -f passwordcheck.so &nbsp; libpasswordcheck.a &nbsp;libpasswordcheck.pc</font></div><div style="line-height: 28px;"   ><font size="2"   >rm -f passwordcheck.o</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-221 passwordcheck]# make</font></div><div style="line-height: 28px;"   ><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fpic -DUSE_CRACKLIB '-DCRACKLIB_DICTPATH="/usr/share/cracklib/pw_dict"' -I. -I. -I../../src/include -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o passwordcheck.o passwordcheck.c</font></div><div style="line-height: 28px;"   ><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fpic -shared -o passwordcheck.so passwordcheck.o -L../../src/port -L../../src/common -Wl,--as-needed -Wl,-rpath,'/opt/pgsql9.3.5/lib',--enable-new-dtags &nbsp;-lcrack&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-221 passwordcheck]# make install</font></div><div style="line-height: 28px;"   ><font size="2"   >/bin/mkdir -p '/opt/pgsql9.3.5/lib'</font></div><div style="line-height: 28px;"   ><font size="2"   >/usr/bin/install -c -m 755 &nbsp;passwordcheck.so '/opt/pgsql9.3.5/lib/passwordcheck.so'</font></div><p></p></pre></div></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >加载模块.</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div><div><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-221 passwordcheck]# su - postgres</font></div><div style="line-height: 28px;"   ><font size="2"   >postgres@db-172-16-3-221-&gt; cd $PGDATA</font></div><div style="line-height: 28px;"   ><font size="2"   >postgres@db-172-16-3-221-&gt; vi postgresql.conf</font></div><div><font size="2"   >shared_preload_libraries = 'passwordcheck'</font></div></div></div><div><font size="2"   >postgres@db-172-16-3-221-&gt; pg_ctl restart -m fast</font></div><p></p></pre></div></div></div><div><br></div><div>修改密码测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-221-&gt; psql</font></div><div><font size="2"   >psql (9.3.5)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >可以看到, 不符合密码强度(必须包含大小写, 非字符), 或者在密码文件中的密码都不允许使用.</font></div><div><font size="2"   >digoal=# alter role postgres encrypted password 'helloworld123';</font></div><div><font size="2"   >ERROR: &nbsp;password is easily cracked</font></div><div><font size="2"   >digoal=# alter role postgres encrypted password 'helloworld';</font></div><div><font size="2"   >ERROR: &nbsp;password must contain both letters and nonletters</font></div><div><font size="2"   >digoal=# alter role postgres encrypted password 'hello';</font></div><div><font size="2"   >ERROR: &nbsp;password is too short</font></div><div><font size="2"   >digoal=# alter role postgres encrypted password 'postgres';</font></div><div><font size="2"   >ERROR: &nbsp;password must not contain user name</font></div><div><font size="2"   >digoal=# alter role postgres encrypted password 'postgresql';</font></div><div><font size="2"   >ERROR: &nbsp;password must not contain user name</font></div><div><div><font size="2"   >digoal=# alter role postgres encrypted password 'abcpostgreHAHAHA';</font></div><div><font size="2"   >ERROR: &nbsp;password must contain both letters and nonletters</font></div></div><div><div><font size="2"   >digoal=# alter role postgres encrypted password 'a_b_cpostgreHAHAHA';</font></div><div><font size="2"   >ERROR: &nbsp;password is too short</font></div><div><font size="2"   >digoal=# alter role postgres encrypted password 'a_b_cpostgreHAHAHAHAHAH';</font></div><div><font size="2"   >ALTER ROLE</font></div></div><p></p></pre></div><div>使用<span style="line-height: 28px;"   >passwordcheck模块后, 就可以在数据库中强制密码复杂度了.</span></div></div><div><br></div><div><span style="line-height: 28px;"   >2. 密码验证失败延迟</span></div><div>这个主要用于防止暴力破解. 验证失败后, 延迟一个时间窗口才能继续验证.</div><div>安装 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 auth_delay]# cd /opt/soft_bak/postgresql-9.3.5/contrib/auth_delay/</font></div><div><font size="2"   >[root@db-172-16-3-221 auth_delay]# gmake clean</font></div><div><font size="2"   >rm -f auth_delay.so auth_delay.o</font></div><div><font size="2"   >[root@db-172-16-3-221 auth_delay]# gmake</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fpic -I. -I. -I../../src/include -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o auth_delay.o auth_delay.c</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fpic -L../../src/port -L../../src/common -Wl,--as-needed -Wl,-rpath,'/opt/pgsql9.3.5/lib',--enable-new-dtags &nbsp;-shared -o auth_delay.so auth_delay.o</font></div><div><font size="2"   >[root@db-172-16-3-221 auth_delay]# gmake install</font></div><div><font size="2"   >/bin/mkdir -p '/opt/pgsql9.3.5/lib'</font></div><div><font size="2"   >/usr/bin/install -c -m 755 &nbsp;auth_delay.so '/opt/pgsql9.3.5/lib/'</font></div><p></p></pre></div><div># 加载模块</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-221 auth_delay]# su - postgres</font></div><div><font size="2"   >postgres@db-172-16-3-221-&gt; cd $PGDATA</font></div><div><font size="2"   >postgres@db-172-16-3-221-&gt; vi postgresql.conf</font></div></div><div><font size="2"   >shared_preload_libraries = 'auth_delay,passwordcheck'</font></div><div><font size="2"   >auth_delay.milliseconds = 5000</font></div><p></p></pre></div><div>测试</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-221-&gt; pg_ctl restart -m fast</font></div><div><div><font size="2"   >postgres@db-172-16-3-221-&gt; psql -h 172.16.3.221 -U postgres postgres</font></div><div><font size="2"   >Password for user postgres: 密码输入错误后, 需要等待5秒返回认证失败. 防止暴力破解密码.</font></div><div><font size="2"   >psql: FATAL: &nbsp;password authentication failed for user "postgres"</font></div></div><p></p></pre></div><div><br></div><div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >3. 密码更换周期, 以及</span><span style="line-height: 28px;"   >重复使用策略</span></div></div><div style="line-height: 28px;"   >密码更换周期通过设置角色的有效期来强制指定, 例如</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >digoal=# alter role postgres valid until '2015-01-01';</font></div><div style="line-height: 28px;"   ><font size="2"   >ALTER ROLE</font></div><div style="line-height: 28px;"   ><font size="2"   >digoal=# \du</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of roles</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;Role name | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Attributes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Member of&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >-----------+------------------------------------------------+-----------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;postgres &nbsp;| Superuser, Create role, Create DB, Replication+| {}</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Password valid until 2015-01-01 00:00:00+08 &nbsp; &nbsp;|&nbsp;</font></div><p></p></pre></div><div>那么2015-01-01后, 使用密码认证将不能登录, 但是如果配置为trust的话, 不需要密码验证还是能登录的.</div></div><div><span style="line-height: 28px;"   >重复使用策略目前无法简单的实现, 但是可以结合事件触发器来实现, 例如创建用户, 修改用户时, 将用户和密码+user的md5值记录到一个文件中, 下次修改密码时在事件触发器中检索一下是否重复使用了密码.</span></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >4. 密码验证失败几次后锁定, 以及解锁时间等</span></div><div>目前PostgreSQL不支持这个安全策略, 目前只能使用auth_delay来延长暴力破解的时间.</div><div><br></div><div><span style="line-height: 28px;"   >5. 设置密码时防止密码被记录到数据库日志,history,或审计日志中.&nbsp;</span></div><div><span style="line-height: 28px;"   >这一点是最容易被忽略的, 可能导致密码泄露.</span></div><div><span style="line-height: 28px;"   >例如 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-221-&gt; psql</font></div><div><font size="2"   >psql (9.3.5)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# alter role postgres encrypted password 'a_b_cpostgreHAHAHAHAHAH';</font></div><div><font size="2"   >ALTER ROLE</font></div><p></p></pre></div><div>这条SQL, 包括密码都可能被记录到2个地方.</div><div>1. history</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres@db-172-16-3-221-&gt; cd</font></div><div><font size="2"   >postgres@db-172-16-3-221-&gt; less .psql_history</font></div></div><div><div><font size="2"   >alter role postgres encrypted password 'a_b_cpostgreHAHAHAHAHAH';</font></div><div><font size="2"   >\q</font></div></div><p></p></pre></div><div>2. csvlog, (如果开启了DDL或更高级别审计, #log_statement = 'ddl' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # none, ddl, mod, all).</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-221-&gt; cd $PGDATA/pg_log</font></div><div><font size="2"   >2014-10-09 09:30:53.277 CST,"postgres","digoal",36441,"[local]",5435e54c.8e59,3,"idle",2014-10-09 09:30:52 CST,2/76,0,LOG,00000,"statement: alter role postgres encrypted password 'a_b_cpostgreHAHAHAHAHAH';",,,,,,,,"exec_simple_query, postgres.c:890","psql"</font></div><p></p></pre></div><div>同时还可能被记录到审计工具中, 例如堡垒机.</div><div><br></div><div>解决办法 :&nbsp;</div><div><span style="line-height: 28px;"   >1. 使用pwd+user的md5值设置密码,&nbsp;</span></div><div><span style="line-height: 28px;"   >2. 或者</span><span style="line-height: 28px;"   >创建用户时使用createuser命令行工具-W选项提示输入密码.&nbsp;</span></div><div><span style="line-height: 28px;"   >例如 :&nbsp;</span></div><div><div>postgres@db-172-16-3-221-&gt; createuser -D -E -I -l -P -R -s --no-replication -h 127.0.0.1 -p 5432 -U postgres -W newrole</div><div>Enter password for new role:&nbsp;</div><div>Enter it again:&nbsp;</div><div>Password:&nbsp;</div></div><div>我们看到日志中记录的密码已经是加密后的密码.</div><div>2014-10-09 09:36:31.491 CST,"postgres","postgres",36499,"127.0.0.1:10919",5435e69f.8e93,3,"idle",2014-10-09 09:36:31 CST,2/100,0,LOG,00000,"statement: CREATE ROLE newrole ENCRYPTED PASSWORD 'md5e8541c3402dc262583fc1b0980b013df' SUPERUSER CREATEDB CREATEROLE NOINHERIT LOGIN NOREPLICATION;</div><div>对应的代码 :&nbsp;</div><div>src/bin/scripts/createuser.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (encrypted != TRI_NO)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *encrypted_password;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; encrypted_password = PQencryptPassword(newpassword,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;newuser);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!encrypted_password)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr, _("Password encryption failed.\n"));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exit(1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendStringLiteralConn(&amp;sql, encrypted_password, conn);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PQfreemem(encrypted_password);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div><div>src/interfaces/libpq/fe-auth.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* PQencryptPassword -- exported routine to encrypt a password</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* This is intended to be used by client applications that wish to send</font></div><div><font size="2"   >&nbsp;* commands like ALTER USER joe PASSWORD 'pwd'. &nbsp;The password need not</font></div><div><font size="2"   >&nbsp;* be sent in cleartext if it is encrypted on the client side. &nbsp;This is</font></div><div><font size="2"   >&nbsp;* good because it ensures the cleartext password won't end up in logs,</font></div><div><font size="2"   >&nbsp;* pg_stat displays, etc. &nbsp;We export the function so that clients won't</font></div><div><font size="2"   >&nbsp;* be dependent on low-level details like whether the enceyption is MD5</font></div><div><font size="2"   >&nbsp;* or something else.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Arguments are the cleartext password, and the SQL name of the user it</font></div><div><font size="2"   >&nbsp;* is for.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Return value is a malloc'd string, or NULL if out-of-memory. &nbsp;The client</font></div><div><font size="2"   >&nbsp;* may assume the string doesn't contain any special characters that would</font></div><div><font size="2"   >&nbsp;* require escaping.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >char *</font></div><div><font size="2"   >PQencryptPassword(const char *passwd, const char *user)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *crypt_pwd;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; crypt_pwd = malloc(MD5_PASSWD_LEN + 1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!crypt_pwd)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!pg_md5_encrypt(passwd, user, strlen(user), crypt_pwd))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; free(crypt_pwd);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return crypt_pwd;</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>src/backend/libpq/md5.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* Computes MD5 checksum of "passwd" (a null-terminated string) followed</font></div><div><font size="2"   >&nbsp;* by "salt" (which need not be null-terminated).</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Output format is "md5" followed by a 32-hex-digit MD5 checksum.</font></div><div><font size="2"   >&nbsp;* Hence, the output buffer "buf" must be at least 36 bytes long.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Returns TRUE if okay, FALSE on error (out of memory).</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >bool</font></div><div><font size="2"   >pg_md5_encrypt(const char *passwd, const char *salt, size_t salt_len,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;char *buf)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; size_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;passwd_len = strlen(passwd);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* +1 here is just to avoid risk of unportable malloc(0) */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *crypt_buf = malloc(passwd_len + salt_len + 1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bool &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ret;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!crypt_buf)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return false;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Place salt at the end because it may be known by users trying to crack</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* the MD5 output.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; memcpy(crypt_buf, passwd, passwd_len);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; memcpy(crypt_buf + passwd_len, salt, salt_len);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; strcpy(buf, "md5");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ret = pg_md5_hash(crypt_buf, passwd_len + salt_len, buf + 3);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; free(crypt_buf);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return ret;</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >3. 修改用户密码建议使用pg_md5工具生成密码, 在psql中使用ALTER ROLE填入md5值.&nbsp;</span></div><div>与上面类似, pg_md5是pgpool提供的一个工具, 实际上就是调用上面的函数.</div><div><br></div><div><span style="line-height: 28px;"   >如果需要将认证模块剥离, 可以选择使用域认证或其他第三方认证方法, 这样的话, 密码策略就交由第三方管理了.</span></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014824551899/"   >http://blog.163.com/digoal@126/blog/static/1638770402014824551899/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014563264469/"   >http://blog.163.com/digoal@126/blog/static/1638770402014563264469/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020145914717111/"   >http://blog.163.com/digoal@126/blog/static/16387704020145914717111/</a></div><div><br></div><div><br></div><div>[其他]</div><div>1. PostgreSQL在密码安全管理这块还需要加强.</div><div>例如应该有密码修改的命令行工具.</div><div>应该有密码重复使用的策略模块.</div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/passwordcheck.html"   >http://www.postgresql.org/docs/9.4/static/passwordcheck.html</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/auth-delay.html"   >http://www.postgresql.org/docs/9.4/static/auth-delay.html</a></div><div><div style="line-height: 28px;"   >3.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014824551899/"   >http://blog.163.com/digoal@126/blog/static/1638770402014824551899/</a></div><div style="line-height: 28px;"   >4.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014563264469/"   >http://blog.163.com/digoal@126/blog/static/1638770402014563264469/</a></div><div style="line-height: 28px;"   >5.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020145914717111/"   >http://blog.163.com/digoal@126/blog/static/16387704020145914717111/</a></div></div><div style="line-height: 28px;"   >6.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://sourceforge.net/projects/cracklib/"   >http://sourceforge.net/projects/cracklib/</a></div><div style="line-height: 28px;"   ><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL password security - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>