<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Tomcat & pgpool-II configure attention "An I/O Error occurred while sending to the backend"</h2>
	<h5 id="">2014-10-08 10:10:42&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014989559405/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>使用Tomcat时, 因为Tomcat连接可以设置为池模式, 持久化TOMCAT得到PGPOOL的连接, 周期性的测试连接, 但是如果pgpool-II设置了client_idle_limit&gt;0, 那么在空闲时间超过client_idle_limit后, pgpool将主动断开连接, 断开连接后, 如果tomcat发起SQL请求, 将报错An I/O Error occurred while sending to the backend.</div><div>解决办法有2个,&nbsp;</div><div>1. 设置pgpool的client_idle_limit=0. 弊端是pgpool将出现一些空闲连接.</div><div>2. 如果<span style="line-height: 28px;"   >pgpool的client_idle_limit&gt;0, 那么可以</span><span style="line-height: 28px;"   >设置tomcat的测试周期, 小于client_idle_limit.</span></div><div><br></div><div>详见 :&nbsp;</div><div><h3 style="font-weight: normal; margin: 0px 0px 0.3em; overflow: hidden; padding-top: 0.5em; padding-bottom: 0.17em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); width: auto; font-size: 17px; font-family: sans-serif; line-height: 19.2000007629395px; background-image: none; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><span id="I.27m_getting_repeated_errors_like_this_every_few_minutes_on_Tomcat:_.22An_I.2FO_Error_occurred_while_sending_to_the_backend.22_Why.3F"   ><b>I'm getting repeated errors like this every few minutes on Tomcat: "An I/O Error occurred while sending to the backend" Why?</b></span></h3><dl style="margin-top: 0.2em; margin-bottom: 0.5em; font-family: sans-serif; font-size: 13px; line-height: 19.2000007629395px;"   ><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >Tomcat creates persistent connections to pgpool. If you set client_idle_limit to non 0, pgpool disconnects the connection and next time when Tomcat tries to send something to pgpool it breaks with the error message.</dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >One solution is set client_idle_limit to 0. However this will leave lots of idle connections.</dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >Another solution provided by Lachezar Dobrev is:</dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >You might solve that by adding a time-out on the Tomcat side.&nbsp;<a class="external free" rel="nofollow" href="http://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html"   >http://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html</a></dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >What you should set is (AFAIK &nbsp;As Far As I Know （就我所知）):</dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   ><br></dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >minIdle (default is 10, set to 0)</dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >timeBetweenEvictionRunsMillis (default 5000)</dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >minEvictableIdleTimeMillis (default 60000)</dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   ><br></dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >This will try every 5 seconds and close any connections that were not used in the last 60 seconds. If you keep the sum of both numbers below the client time-out on the pgpool size connections should be closed at Tomcat side before they time-out on the pgpool side.</dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >It is also beneficial to set the:</dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   ><br></dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >testOnBorrow (default false, set to true)</dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >validationQuery (default none, set to 'SELECT version();' no quotes)</dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   ><br></dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >This will help with connections should they expire while waiting, without supplying a disconnected connection to the application.</dd></dl></div><div><br></div><div><table border="1"   cellpadding="5"   style="border-collapse: collapse; font-family: Simsun;"   ><tbody style="border-collapse: separate;"   ><tr style="border-collapse: separate;"   ><td align="left"   valign="center"   style="border-collapse: separate;"   ><code style="padding: 0px 0.1em; border-collapse: separate; background-color: transparent;"   >minIdle</code></td><td align="left"   valign="center"   style="border-collapse: separate;"   ><p style="border-collapse: separate;"   >(int) The minimum number of established connections that should be kept in the pool at all times. The connection pool can shrink below this number if validation queries fail. Default value is derived from&nbsp;<code style="padding: 0px 0.1em; border-collapse: separate; background-color: rgb(224, 255, 255);"   >initialSize</code>:<code style="padding: 0px 0.1em; border-collapse: separate; background-color: rgb(224, 255, 255);"   >10</code>&nbsp;(also see<code style="padding: 0px 0.1em; border-collapse: separate; background-color: rgb(224, 255, 255);"   >testWhileIdle</code>)</p></td></tr></table></div><div><table border="1"   cellpadding="5"   style="border-collapse: collapse; font-family: Simsun;"   ><tbody style="border-collapse: separate;"   ><tr style="border-collapse: separate;"   ><td align="left"   valign="center"   style="border-collapse: separate;"   ><code style="padding: 0px 0.1em; border-collapse: separate; background-color: transparent;"   >testWhileIdle</code></td><td align="left"   valign="center"   style="border-collapse: separate;"   ><p style="border-collapse: separate;"   >(boolean) The indication of whether objects will be validated by the idle object evictor (if any). If an object fails to validate, it will be dropped from the pool. NOTE - for a true value to have any effect, the&nbsp;<code style="padding: 0px 0.1em; border-collapse: separate; background-color: rgb(224, 255, 255);"   >validationQuery</code>parameter must be set to a non-null string. The default value is&nbsp;<code style="padding: 0px 0.1em; border-collapse: separate; background-color: rgb(224, 255, 255);"   >false</code>&nbsp;and this property has to be set in order for the pool cleaner/test thread is to run (also see&nbsp;<code style="padding: 0px 0.1em; border-collapse: separate; background-color: rgb(224, 255, 255);"   >timeBetweenEvictionRunsMillis</code>)</p></td></tr></table></div><div><table border="1"   cellpadding="5"   style="border-collapse: collapse; font-family: Simsun;"   ><tbody style="border-collapse: separate;"   ><tr style="border-collapse: separate;"   ><td align="left"   valign="center"   style="border-collapse: separate;"   ><code style="padding: 0px 0.1em; border-collapse: separate; background-color: transparent;"   >timeBetweenEvictionRunsMillis</code></td><td align="left"   valign="center"   style="border-collapse: separate;"   ><p style="border-collapse: separate;"   >(int) The number of milliseconds to sleep between runs of the idle connection validation/cleaner thread. This value should not be set under 1 second. It dictates how often we check for idle, abandoned connections, and how often we validate idle connections. The default value is&nbsp;<code style="padding: 0px 0.1em; border-collapse: separate; background-color: rgb(224, 255, 255);"   >5000</code>&nbsp;(5 seconds).&nbsp;</p></td></tr></table></div><div><table border="1"   cellpadding="5"   style="border-collapse: collapse; font-family: Simsun;"   ><tbody style="border-collapse: separate;"   ><tr style="border-collapse: separate;"   ><td align="left"   valign="center"   style="border-collapse: separate;"   ><code style="padding: 0px 0.1em; border-collapse: separate; background-color: transparent;"   >minEvictableIdleTimeMillis</code></td><td align="left"   valign="center"   style="border-collapse: separate;"   ><p style="border-collapse: separate;"   >(int) The minimum amount of time an object may sit idle in the pool before it is eligible for eviction. The default value is&nbsp;<code style="padding: 0px 0.1em; border-collapse: separate; background-color: rgb(224, 255, 255);"   >60000</code>&nbsp;(60 seconds).</p></td></tr></table></div><div><table border="1"   cellpadding="5"   style="border-collapse: collapse; font-family: Simsun;"   ><tbody style="border-collapse: separate;"   ><tr style="border-collapse: separate;"   ><td align="left"   valign="center"   style="border-collapse: separate;"   ><code style="padding: 0px 0.1em; border-collapse: separate; background-color: transparent;"   >testOnBorrow</code></td><td align="left"   valign="center"   style="border-collapse: separate;"   ><p style="border-collapse: separate;"   >(boolean) The indication of whether objects will be validated before being borrowed from the pool. If the object fails to validate, it will be dropped from the pool, and we will attempt to borrow another. NOTE - for a true value to have any effect, the&nbsp;<code style="padding: 0px 0.1em; border-collapse: separate; background-color: rgb(224, 255, 255);"   >validationQuery</code>&nbsp;parameter must be set to a non-null string. In order to have a more efficient validation, see&nbsp;<code style="padding: 0px 0.1em; border-collapse: separate; background-color: rgb(224, 255, 255);"   >validationInterval</code>. Default value is&nbsp;<code style="padding: 0px 0.1em; border-collapse: separate; background-color: rgb(224, 255, 255);"   >false</code></p></td></tr></table></div><div><table border="1"   cellpadding="5"   style="border-collapse: collapse; font-family: Simsun;"   ><tbody style="border-collapse: separate;"   ><tr style="border-collapse: separate;"   ><td align="left"   valign="center"   style="border-collapse: separate;"   ><code style="padding: 0px 0.1em; border-collapse: separate; background-color: transparent;"   >validationQuery</code></td><td align="left"   valign="center"   style="border-collapse: separate;"   ><p style="border-collapse: separate;"   >(String) The SQL query that will be used to validate connections from this pool before returning them to the caller. If specified, this query does not have to return any data, it just can't throw a&nbsp;<code style="padding: 0px 0.1em; border-collapse: separate; background-color: rgb(224, 255, 255);"   >SQLException</code>. The default value is&nbsp;<code style="padding: 0px 0.1em; border-collapse: separate; background-color: rgb(224, 255, 255);"   >null</code>. Example values are&nbsp;<code style="padding: 0px 0.1em; border-collapse: separate; background-color: rgb(224, 255, 255);"   >SELECT 1</code>(mysql),&nbsp;<code style="padding: 0px 0.1em; border-collapse: separate; background-color: rgb(224, 255, 255);"   >select 1 from dual</code>(oracle),&nbsp;<code style="padding: 0px 0.1em; border-collapse: separate; background-color: rgb(224, 255, 255);"   >SELECT 1</code>(MS Sql Server)</p></td></tr></table></div><div><br></div><div><span style="line-height: 28px;"   >[参考]</span></div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html"   >http://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="Tomcat  pgpool-II configure attention An I/O Error occurred while sending to the backend - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>