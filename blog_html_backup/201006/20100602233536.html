<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">[From 0xCCCE]linux下的网络地址绑定</h2>
	<h5 id="">2010-06-02 23:35:36&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201052113536828/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><span style="font-family: Tahoma, Arial, Helvetica, sans-serif; line-height: normal; font-size: 12px; color: rgb(51, 68, 85);"><h2 style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 2px; padding-right: 10px; padding-bottom: 2px; padding-left: 10px; font-family: Georgia, 'Times New Roman', Times, serif; font-weight: bold; font-size: 16px; line-height: 26px; color: rgb(85, 85, 85); border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(255, 255, 255); text-shadow: rgb(221, 221, 221) 1px 1px 1px;"><span style="color: rgb(51, 68, 85); font-family: Tahoma, Arial, Helvetica, sans-serif; font-weight: normal; line-height: 18px; font-size: 13px;">系统环境：<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">CentOS 5.2<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">eth0 192.168.1.2<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">eth0:1 192.168.1.3<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">sysctl net.ipv4.ip_local_port_range = 10000 10000<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">如果对一个socket做绑定，会出现什么情况？Python代码为例：<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">sk1.bind((“”, 0)) # 绑定0.0.0.0:10000<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">sk2.bind((“”, 0)) # 失败，提示Address already in used<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">这是正常的<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">sk1.bind((“192.168.1.2″, 0)) # 绑定192.168.1.2:10000<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">sk2.bind((“192.168.1.3″, 0)) # 失败，提示Address already in used<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">这就有点奇怪了，192.168.1.3:10000我们没有使用，但是分配不到，再试试：<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">sk1.bind((“192.168.1.2″, 10000)) # 绑定192.168.1.2:10000<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">sk2.bind((“192.168.1.3″, 0)) # 失败，提示Address already in used<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">再来<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">sk1.bind((“192.168.1.2″, 0)) # 绑定192.168.1.2:10000<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">sk2.bind((“192.168.1.3″, 10000)) # 成功<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">再来<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">sk1.bind((“192.168.1.2″, 10000)) # 绑定192.168.1.2:10000<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">sk2.bind((“192.168.1.3″, 10000)) # 成功<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">结论：当端口为0，要求系统自动分配时，如果这个端口只要被某个IP在使用，则无法分配，如果指定端口号，则可以分配成功，参考了linux相关源码，没看出什么头绪，还要继续研究<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">上面的例子是eth0和eth0:1，如果是eth0和lo，情况也是一样，暂时没有条件测试eth0和eth1的情况<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">实际问题：<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">在一台机器向远端建立很多连接（需要说明，一般来讲这种做法从架构上讲是有问题的，但是因为某些特殊原因可能会碰到），由于tcp连接客户端需要绑定一个端口，一般采用自动分配，于是连接数受到端口数限制，6万多连接后出现无法绑定的异常<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">通过给eth0配置别名的办法增加IP，可以增加连接数，但是根据上面的实验，必须在程序中采用手工指定端口的办法进行绑定，关键在于绑定的时候怎么确定端口号，保证多个进程之间的端口不会冲突以及在系统资源足够的情况下保证端口绑定成功<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">比较好的办法是每个应用进程自己维护一份当前自己在用的{PORT : IPlist}表，以及系统所有IP的列表<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">1 初始化，表为空<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">2 建立连接的时候，查一下表，假如有某个端口对应的IP没有满，则用此端口的一个可用IP进行绑定，并将其记录到表中，如果所有端口的IPlist都是满的，则用eth0的IP和0端口进行绑定，并在表中加入绑定好的端口号和eth0的IP的映射，简单地讲，就是先让系统分配一个可用端口（同时绑定了eth0的IP，也阻止了对其他进程自动分配此端口），然后手工绑定此端口的其他所有IP<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">3 连接断开的时候将此连接的IP从相应PORT的IPlist中剔除，假如此时IPlist为空，则将此PORT从表中剔除，即此进程已失去对此PORT的控制，归还系统供其他进程分配<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;">不过，这个办法我目前还没有实践过，从理论上讲应该没问题的，可以找机会试试看</span></h2></span></div>
	</div>
</div>
</body>
</html>