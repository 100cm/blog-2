<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL性能优化综合案例讲解 - 1</h2>
	<h5 id="">2012-03-13 20:21:50&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201221382150858/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div style="line-height: 22px;"   >【声明】</div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >欢迎转载, 注明出处.</span></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >【正文】</div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >【软件环境】&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CentOS 5 x64</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >PostgreSQL 9.1.3</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >plproxy 2.3</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pgbouncer 1.4.2</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >【测试模型】</div><div style="line-height: 22px;"   >设计一个包含INSERT, UPDATE, SELECT语句的业务模型用于本优化案例.</div><div style="line-height: 22px;"   >业务逻辑 :&nbsp;</div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><img title="PostgreSQL性能优化综合案例讲解 - 1 - 德哥@Digoal - The Heart,The World."   alt="PostgreSQL性能优化综合案例讲解 - 1 - 德哥@Digoal - The Heart,The World."   src="http://img2.ph.126.net/ETuV2zrOT9RuVAPjCJgxJg==/1044272163613848422.jpg"   style="line-height: 22px; border-style: initial; border-color: initial; margin-top: 0px; margin-right: 10px; margin-bottom: 0px; margin-left: 0px;"   ></div>&nbsp;</div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >【测试表】</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create table user_info</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >engname text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >cnname text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >occupation text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >birthday date,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >signname text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >email text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >qq numeric,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >crt_time timestamp without time zone,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >mod_time timestamp without time zone</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create table user_session</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >logintime timestamp(0) without time zone,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >login_count bigint default 0,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >logouttime timestamp(0) without time zone,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >online_interval interval default interval '0'</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create table user_login_rec</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >login_time timestamp without time zone,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ip inet</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create table user_logout_rec</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >logout_time timestamp without time zone,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ip inet</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >);</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >【初始化数据】</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_info (userid,engname,cnname,occupation,birthday,signname,email,qq,crt_time,mod_time)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >select generate_series(1,20000000),</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'digoal.zhou',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'德哥',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'DBA',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'1970-01-01'</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >,E'公益是一辈子的事, I\'m Digoal.Zhou, Just do it!',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'digoal@126.com',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >276732431,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >clock_timestamp(),</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >NULL;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_session (userid) select generate_series(1,20000000);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >set work_mem='2048MB';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >set maintenance_work_mem='2048MB';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >alter table user_info add constraint pk_user_info primary key (userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >alter table user_session add constraint pk_user_session primary key (userid);</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >【业务函数】</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-- 模拟用户登录的函数</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create or replace function f_user_login&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(i_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_engname text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_cnname text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_occupation text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_birthday date,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_signname text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_email text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_qq numeric</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >into o_userid,o_engname,o_cnname,o_occupation,o_birthday,o_signname,o_email,o_qq</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >from user_info where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >update user_session set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><span style="line-height: 19px;"   >-- 模拟用户退出的函数</span></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create or replace function f_user_logout</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(i_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_result int</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_logout_rec (userid,logout_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >update user_session set logouttime=now(),online_interval=online_interval+(now()-logintime) where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >o_result := 0;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >exception&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >when others then</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >o_result := 1;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >language plpgsql;</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >【搭建测试模型】</div><div style="line-height: 22px;"   >1. &nbsp;搭建环境, 安装PostgreSQL9.1.3数据库软件并初始化数据库(略).</div><div style="line-height: 22px;"   >2. &nbsp;调整数据库postgresql.conf参数.&nbsp;打开日志, SQL统计, 跟踪, 以及性能参数, 便于优化过程中取证.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >监听IPv4的所有IP.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >listen_addresses = '0.0.0.0'</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >最大允许1000个连接.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >max_connections = 1000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >为超级用户保留3个可用连接.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >superuser_reserved_connections = 3</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >默认的unix socket文件放在/tmp, 修改为$PGDATA, 以确保安全.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >unix_socket_directory = '/pgdata/digoal/1921/data02/pg_root'</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >默认的访问权限是0777, 修改为0700更安全.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >unix_socket_permissions = 0700</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><span style="font-size: small; line-height: 19px;"   >Linux下面默认是2小时.</span><font size="2"   style="line-height: 19px;"   >tcp的keepalives包发送间隔以及重试次数, 如果客户端没有响应, 将主动释放对应的SOCKET.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tcp_keepalives_idle = 60</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tcp_keepalives_interval = 10</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tcp_keepalives_count = 6</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >大的shared_buffers需要大的checkpoint_segments,同时需要申请更多的System V共享内存资源.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >这个值不需要设的太大, 因为PostgreSQL还依赖操作系统的cache来提高读性能, 另外, 写操作频繁的数据库这个设太大反而会增加checkpoint压力.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >shared_buffers = 512MB</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >这个值越大, VACUUM, CREATE INDEX的操作越快, 当然大到一定程度瓶颈就不在内存了, 可能是CPU例如创建索引.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >这个值是一个操作的内存使用上限, 而不是一次性分配出去的. 并且需要注意如果开启了autovacuum, 最大可能有autovacuum_max_workers*maintenance_work_mem的内存被系统消耗掉.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >maintenance_work_mem = 512MB</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >一般设置为比系统限制的略少,ulimit -a : stack size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(kbytes, -s) 10240</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >max_stack_depth = 8MB</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >手动执行vacuum操作时, 默认是没有停顿执行到底的, 为了防止VACUUM操作消耗太多数据库服务器硬件资源, 这个值是指vacuum在消耗多少资源后停顿多少时间,以便其他的操作可以使用更多的硬件资源.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >vacuum_cost_delay = 10ms</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#vacuum_cost_page_hit = 1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 0-10000 credits</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#vacuum_cost_page_miss = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 0-10000 credits</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#vacuum_cost_page_dirty = 20 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 0-10000 credits</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#vacuum_cost_limit = 200 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 1-10000 credits</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >默认bgwriter进程执行一次后会停顿200ms再被唤醒执行下一次操作, 当数据库的写操作很频繁的时候, 200ms可能太长, 导致其他进程需要花费过多的时间来进行bgwriter的操作.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >bgwriter_delay = 10ms</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >如果需要做数据库WAL日志备份的话至少需要设置成archive级别, 如果需要做hot_standby那么需要设置成hot_standby, 由于这个值修改需要重启数据库, 所以先设置成hot_standby比较好. 当然hot_standby意味着WAL记录得更详细, 如果没有打算做hot_standby设置得越低性能越好.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >wal_level = hot_standby</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >wal buffers默认是-1 根据shared_buffers的设置自动调整shared_buffers*3% .最大限制是XLOG的segment_size.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >wal_buffers = 16384kB</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >多少个xlog file产生后开始checkpoint操作, 这个值越大, 允许shared_buffer中的被频繁访问的脏数据存储得更久. 一定程度上可以提高数据库性能. 但是太大的话会导致在数据库发生checkpoint的时候需要处理更多的脏数据带来长时间的IO开销. 太小的话会导致产生更多的WAL文件(因为full page writes=on,CHECKPOINT后的第一次块的改变要写全块, checkpoint越频繁, 越多的数据更新要写全块导致产生更多WAL).</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >checkpoint_segments = 64</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >这个和checkpoint_segments的效果是一样的, 只是触发的条件是时间条件.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >checkpoint_timeout = 5min</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >归档参数的修改也需要重启数据库, 所以就先打开吧.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >archive_mode = on</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >这个是归档调用的命令, 我这里用date代替, 所以归档的时候调用的是输出时间而不是拷贝wal文件.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >archive_command = '/bin/date'</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >如果要做hot standby这个必须大于0, 并且修改之后要重启数据库所以先设置为32.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >max_wal_senders = 32</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >这是个standby 数据库参数, 为了方便角色切换, 我一般是所有的数据库都把他设置为on 的.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >hot_standby = on</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >这个参数是说数据库中随机的PAGE访问的开销占seq_page_cost的多少倍 , seq_page_cost默认是1. 其他的开销都是seq_page_cost的倍数. 这些都用于基于成本的执行计划选择.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >random_page_cost = 2.0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >和上一个参数一样, 用于基于成本的执行计划选择. 不是说会用多少cache, 它只是个度量值. 表示系统有多少内存可以作为操作系统的cache. 越大的话, 数据库越倾向使用index这种适合random访问的执行计划.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >effective_cache_size = 12000MB</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >下面是日志输出的配置.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >log_destination = 'csvlog'</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >logging_collector = on</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >log_directory = '/var/applog/pg_log/digoal/1921'</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >log_truncate_on_rotation = on</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >log_rotation_age = 1d</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >log_rotation_size = 10MB</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >这个参数调整的是记录执行时间超过1秒的SQL到日志中, 一般用于跟踪哪些SQL执行时间长.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >log_min_duration_statement = 1000ms</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >记录每一次checkpoint到日志中.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >log_checkpoints = on</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >记录锁等待超过1秒的操作, 一般用于排查业务逻辑上的问题.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >log_lock_waits = on</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >deadlock_timeout = 1s</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >记录DDL语句, 一般用于跟踪数据库中的危险操作.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >log_statement = 'ddl'</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >这个原本是1024表示跟踪的SQL在1024的地方截断, 超过1024将无法显示全SQL. 修改为2048会消耗更多的内存(基本可以忽略), 不过可以显示更长的SQL.&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >track_activity_query_size = 2048</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >默认autovacuum就是打开的, log_autovacuum_min_duration = 0记录所有的autovacuum操作.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autovacuum = on</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >log_autovacuum_min_duration = 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >这个模块用于记录数据库中的最近的1000条SQL以及这些SQL的统计信息, 如执行了多少次, 总共耗时是多少. 一般用于发现业务上最频繁调用的SQL是什么, 有针对性的进行SQL优化.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >shared_preload_libraries = 'pg_stat_statements'</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >custom_variable_classes = 'pg_stat_statements'</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pg_stat_statements.max = 1000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pg_stat_statements.track = all</font></div></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >其他参数值默认.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >这些参数的详细解释如有疑问请参考PostgreSQL官方文档.</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >3. 新建数据库用户digoal, 库digoal. 并使用前面的测试模型新建表以及函数, 初始化数据.</div><div style="line-height: 22px;"   >&nbsp; &nbsp;下面的测试过程中只测登陆部分, 未测试退出部分, 因为登陆过程已经包含了INSERT, UPDATE, SELECT. 基本上可以反映整个调优过程了.</div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >【调优阶段1】</div><div style="line-height: 22px;"   >使用pgbench进行压力测试, 发现瓶颈并合理优化.</div><div style="line-height: 22px;"   >1. pgbench用到的登陆脚本</div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >cat login.sql&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >\setrandom userid 1 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >select userid,engname,cnname,occupation,birthday,signname,email,qq from user_info where userid=:userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_login_rec (userid,login_time,ip) values (:userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >update user_session set logintime=now(),login_count=login_count+1 where userid=:userid;</font></div><p style="line-height: 22px;"   ></p></pre></div></div><div style="line-height: 22px;"   >2.&nbsp;<span style="line-height: 22px;"   >pgbench用到的退出脚本</span></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >cat logout.sql&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >\setrandom userid 1 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_logout_rec (userid,logout_time,ip) values (:userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >update user_session set logouttime=now(),online_interval=online_interval+(now()-logintime) where userid=:userid;</font></div><p style="line-height: 22px;"   ></p></pre></div></div><div style="line-height: 22px;"   >3. 压力测试</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pgbench -M simple -r -c 8 -f /home/postgres/test/login.sql -j 8 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal</font></p></pre></div><div style="line-height: 22px;"   >4. 压力测试结果</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >query mode: simple</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of clients: 8</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of threads: 8</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of transactions actually processed: 62675</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 348.084647 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 348.100337 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.004577 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 12.963789 &nbsp; &nbsp; &nbsp; select userid,engname,cnname,occupation,birthday,signname,email,qq from user_info where userid=:userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 5.540750 &nbsp; &nbsp; &nbsp; &nbsp;insert into user_login_rec (userid,login_time,ip) values (:userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 4.457834 &nbsp; &nbsp; &nbsp; &nbsp;update user_session set logintime=now(),login_count=login_count+1 where userid=:userid;</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >5. 瓶颈分析与优化</div><div style="line-height: 22px;"   >压力测试中查看数据库服务器的iostat -x</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >avg-cpu: &nbsp;%user &nbsp; %nice %system %iowait &nbsp;%steal &nbsp; %idle</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.69 &nbsp; &nbsp;0.00 &nbsp; &nbsp;0.25 &nbsp; 24.11 &nbsp; &nbsp;0.00 &nbsp; 74.95</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Device: &nbsp; &nbsp; &nbsp; &nbsp; rrqm/s &nbsp; wrqm/s &nbsp; r/s &nbsp; w/s &nbsp; rsec/s &nbsp; wsec/s avgrq-sz avgqu-sz &nbsp; await &nbsp;svctm &nbsp;%util</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >cciss/c0d0 &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 6.00 &nbsp;0.00 &nbsp;1.50 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;60.00 &nbsp; &nbsp;40.00 &nbsp; &nbsp; 0.01 &nbsp; &nbsp;6.67 &nbsp; 6.67 &nbsp; 1.00</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >cciss/c0d0p1 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 6.00 &nbsp;0.00 &nbsp;1.50 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;60.00 &nbsp; &nbsp;40.00 &nbsp; &nbsp; 0.01 &nbsp; &nbsp;6.67 &nbsp; 6.67 &nbsp; 1.00</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >cciss/c0d0p2 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >cciss/c0d0p3 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >cciss/c0d1 &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >cciss/c0d2 &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; 638.50 10.00 217.50 &nbsp; 160.00 &nbsp;6444.00 &nbsp; &nbsp;29.03 &nbsp; 152.58 &nbsp;707.89 &nbsp; 4.40 100.10</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >cciss/c0d3 &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >cciss/c0d4 &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >cciss/c0d5 &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >dm-0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >dm-1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 10.00 866.50 &nbsp; 160.00 &nbsp;6932.00 &nbsp; &nbsp; 8.09 &nbsp; 446.26 &nbsp;510.49 &nbsp; 1.14 100.10</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >dm-2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >dm-3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >dm-4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >操作系统的平均IO请求等待700多毫秒, PostgreSQL数据文件所处的块设备使用率100%. 存在严重的IO性能瓶颈.</div><div style="line-height: 22px;"   >使用pgfincore降低读的物理IO请求.</div><div style="line-height: 22px;"   >pgfincore的相关文章可参考如下,</div><div style="line-height: 22px;"   >《use posix_fadvise pre-cache frequency data》</div><div style="line-height: 22px;"   ><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201062944945126/"   >http://blog.163.com/digoal@126/blog/static/163877040201062944945126/</a></div><div style="line-height: 22px;"   >《a powerful upgrade from pgfincore 1.0》</div><div style="line-height: 22px;"   ><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402011630102117658/"   >http://blog.163.com/digoal@126/blog/static/1638770402011630102117658/</a></div><div style="line-height: 22px;"   >《TOAST table with pgfincore》</div><div style="line-height: 22px;"   ><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020120524144140/"   >http://blog.163.com/digoal@126/blog/static/16387704020120524144140/</a></div><div style="line-height: 22px;"   >pgfincore所起的作用类似EnterpriseDB的InfiniteCache或者熟悉Oracle的朋友可能更易于接受的KEEP BUFFER POOL.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-- 载入os cache</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=&gt; select reltoastrelid from pg_class where relname='user_info';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;reltoastrelid&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >---------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16424</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=&gt; select relname from pg_class where oid=16424;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; relname &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >----------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_toast_16421</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=&gt; \c digoal postgres</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >seYou are now connected to database "digoal" as user "postgres".</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select * from pgfadvise_willneed('pg_toast.pg_toast_16421');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;relpath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| os_page_size | rel_os_pages | os_pages_free&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >----------------------------------------------+--------------+--------------+---------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_tblspc/16385/PG_9.1_201105231/16386/16424 | &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;243865</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select * from pgfadvise_willneed('digoal.user_info');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relpath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | os_page_size | rel_os_pages | os_pages_free&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------------------------------------------+--------------+--------------+---------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_tblspc/16385/PG_9.1_201105231/16386/16421 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp;243834</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_tblspc/16385/PG_9.1_201105231/16386/16421.1 | &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp;243834</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_tblspc/16385/PG_9.1_201105231/16386/16421.2 | &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 244944 | &nbsp; &nbsp; &nbsp; &nbsp;243834</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(3 rows)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select * from pgfadvise_willneed('digoal.user_session');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relpath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | os_page_size | rel_os_pages | os_pages_free&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------------------------------------------+--------------+--------------+---------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_tblspc/16385/PG_9.1_201105231/16386/16431 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 262144 | &nbsp; &nbsp; &nbsp; &nbsp;243834</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_tblspc/16385/PG_9.1_201105231/16386/16431.1 | &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; &nbsp;33640 | &nbsp; &nbsp; &nbsp; &nbsp;243834</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(2 rows)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select reltoastrelid from pg_class where relname='user_session';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;reltoastrelid&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >---------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select * from pgfadvise_willneed('digoal.pk_user_session');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;relpath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| os_page_size | rel_os_pages | os_pages_free&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >----------------------------------------------+--------------+--------------+---------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_tblspc/16385/PG_9.1_201105231/16386/16438 | &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 109680 | &nbsp; &nbsp; &nbsp; &nbsp;243865</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select * from pgfadvise_willneed('digoal.pk_user_info');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;relpath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| os_page_size | rel_os_pages | os_pages_free&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >----------------------------------------------+--------------+--------------+---------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_tblspc/16385/PG_9.1_201105231/16386/16436 | &nbsp; &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; 109680 | &nbsp; &nbsp; &nbsp; &nbsp;235567</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >【调优阶段2】</div><div style="line-height: 22px;"   >1. 压力测试</div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pgbench -M simple -r -c 8 -f /home/postgres/test/login.sql -j 8 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal</font></p></pre></div><div style="line-height: 22px;"   >2. 测试结果</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >query mode: simple</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of clients: 8</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of threads: 8</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of transactions actually processed: 264895</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 1471.517096 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 1471.585818 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.004226 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.459824 &nbsp; &nbsp; &nbsp; &nbsp;select userid,engname,cnname,occupation,birthday,signname,email,qq from user_info where userid=:userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 2.457797 &nbsp; &nbsp; &nbsp; &nbsp;insert into user_login_rec (userid,login_time,ip) values (:userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 2.501684 &nbsp; &nbsp; &nbsp; &nbsp;update user_session set logintime=now(),login_count=login_count+1 where userid=:userid;</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >3. 瓶颈分析与优化</div><div style="line-height: 22px;"   >SELECT语句的延时已经通过上一个优化阶段下降到了0.45毫秒, INSERT和UPDATE语句的平均耗时也从原来的5.5和4.45下降到了2.5.原因是select的请求在内存中命中了, 因此update和insert不需要和select争抢物理io请求, 处理效率自然有一定的提高.</div><div style="line-height: 22px;"   >但是INSERT和UPDATE的语句延时还有2.5毫秒存在很大的可优化空间.</div><div style="line-height: 22px;"   >开启PostgreSQL的异步提交日志.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >synchronous_commit = off</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >wal_writer_delay = 10ms</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >与Oracle的异步日志差别请参考 :&nbsp;</div></div><div style="line-height: 22px;"   >《PostgreSQL and Oracle's async commit》</div><div style="line-height: 22px;"   ><a style="line-height: 22px; " href="http://blog.163.com/digoal@126/blog/static/16387704020121229223072/"   >http://blog.163.com/digoal@126/blog/static/16387704020121229223072/</a></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >【调优阶段3】</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >1. 压力测试</span></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pgbench -M simple -r -c 8 -f /home/postgres/test/login.sql -j 8 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal</font></p></pre></div><div style="line-height: 22px;"   >2. 测试结果</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >query mode: simple</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of clients: 8</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of threads: 8</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of transactions actually processed: 685344</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 3751.377919 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 3751.568948 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003474 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.418716 &nbsp; &nbsp; &nbsp; &nbsp;select userid,engname,cnname,occupation,birthday,signname,email,qq from user_info where userid=:userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.511601 &nbsp; &nbsp; &nbsp; &nbsp;insert into user_login_rec (userid,login_time,ip) values (:userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.188277 &nbsp; &nbsp; &nbsp; &nbsp;update user_session set logintime=now(),login_count=login_count+1 where userid=:userid;</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >3. 瓶颈分析与优化</div><div style="line-height: 22px;"   >客户端连接使用simple协议, 存在一定的可优化空间.</div><div style="line-height: 22px;"   >修改协议为extended, 查看性能提升多少.</div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br style="line-height: 22px;"   ></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >【调优阶段4】</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >1. 压力测试</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pgbench -M extended -r -c 8 -f /home/postgres/test/login.sql -j 8 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal</font></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >2. 测试结果</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >query mode: extended</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of clients: 8</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of threads: 8</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of transactions actually processed: 970981</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 5394.015368 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 5394.215477 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003345 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.381675 &nbsp; &nbsp; &nbsp; &nbsp;select userid,engname,cnname,occupation,birthday,signname,email,qq from user_info where userid=:userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.296300 &nbsp; &nbsp; &nbsp; &nbsp;insert into user_login_rec (userid,login_time,ip) values (:userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.792592 &nbsp; &nbsp; &nbsp; &nbsp;update user_session set logintime=now(),login_count=login_count+1 where userid=:userid;</font></div><p style="line-height: 22px;"   ></p></pre></div><div><div style="line-height: 22px;"   >3. 瓶颈分析与优化</div><div style="line-height: 22px;"   >客户端连接使用extended协议, 存在一定的可优化空间.</div><div style="line-height: 22px;"   >修改协议为prepared, 查看性能提升多少.</div><div style="line-height: 22px;"   >参见 :&nbsp;</div><div>《PostgreSQL prepared statement: SPI_prepare, prepare|execute COMMAND, PL/pgsql STYLE: custom &amp; generic plan cache》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012112452432251/"   >http://blog.163.com/digoal@126/blog/static/1638770402012112452432251/</a></div></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >【调优阶段5】</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >1. 压力测试</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pgbench -M prepared -r -c 8 -f /home/postgres/test/login.sql -j 8 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal</font></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >2. 测试结果</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of clients: 8</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of threads: 8</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of transactions actually processed: 1044186</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 5800.589330 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 5800.902491 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003465 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.319665 &nbsp; &nbsp; &nbsp; &nbsp;select userid,engname,cnname,occupation,birthday,signname,email,qq from user_info where userid=:userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.266931 &nbsp; &nbsp; &nbsp; &nbsp;insert into user_login_rec (userid,login_time,ip) values (:userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.777822 &nbsp; &nbsp; &nbsp; &nbsp;update user_session set logintime=now(),login_count=login_count+1 where userid=:userid;</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >3. 瓶颈分析与优化</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >压力测试的脚本中使用的是普通的SQL语句, 未使用初始化时用到的登陆函数和退出函数. 使用普通SQL显然比使用函数多了交互的次数以及每次发送的数据包的大小.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >使用函数看看性能能提升多少.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br style="line-height: 22px;"   ></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >【调优阶段6】</span></div><div style="line-height: 22px;"   >1. 登陆脚本</div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >cat login.sql&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >\setrandom userid 1 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >SELECT f_user_login(:userid);</font></div><p style="line-height: 22px;"   ></p></pre></div></div><div style="line-height: 22px;"   >2. 退出脚本</div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >cat logout.sql&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >\setrandom userid 1 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >SELECT f_user_logout(:userid);</font></div><p style="line-height: 22px;"   ></p></pre></div></div><div style="line-height: 22px;"   >3. 压力测试</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pgbench -M prepared -r -c 8 -f /home/postgres/test/login.sql -j 8 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal</font></p></pre></div><div style="line-height: 22px;"   >4. 测试结果</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of clients: 8</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of threads: 8</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of transactions actually processed: 1616746</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 8981.596290 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 8981.995800 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.004012 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.881060 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login(:userid);</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >5. 瓶颈分析与优化</div><div style="line-height: 22px;"   >到这个时候看起来好像没什么好优化的了, 其实不然.</div><div style="line-height: 22px;"   >我们知道在整个登陆过程中用到了SELECT, UPDATE, INSERT.</div><div style="line-height: 22px;"   >其中UPDATE的表有一个PK索引, 每次更新需要修改数据表的同时还需要更新索引. 所以理论上这个更新操作表越小性能越高.</div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >我们可以通过拆表来提升性能. 如下 :&nbsp;</span></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >拆表 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create table user_info_0 (like user_info including all);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create table user_info_1 (like user_info including all);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create table user_info_2 (like user_info including all);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create table user_info_3 (like user_info including all);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create table user_info_4 (like user_info including all);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create table user_session_0 (like user_session including all);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create table user_session_1 (like user_session including all);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create table user_session_2 (like user_session including all);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create table user_session_3 (like user_session including all);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create table user_session_4 (like user_session including all);</font></div></pre></div><div style="line-height: 22px;"   >插入初始化数据 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_info_0 (userid,engname,cnname,occupation,birthday,signname,email,qq,crt_time,mod_time)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >select generate_series(1,4000000),</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'digoal.zhou',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'德哥',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'DBA',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'1970-01-01'</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >,E'公益是一辈子的事, I\'m Digoal.Zhou, Just do it!',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'digoal@126.com',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >276732431,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >clock_timestamp(),</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >NULL;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_info_1 (userid,engname,cnname,occupation,birthday,signname,email,qq,crt_time,mod_time)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >select generate_series(4000001,8000000),</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'digoal.zhou',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'德哥',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'DBA',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'1970-01-01'</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >,E'公益是一辈子的事, I\'m Digoal.Zhou, Just do it!',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'digoal@126.com',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >276732431,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >clock_timestamp(),</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >NULL;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_info_2 (userid,engname,cnname,occupation,birthday,signname,email,qq,crt_time,mod_time)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >select generate_series(8000001,12000000),</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'digoal.zhou',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'德哥',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'DBA',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'1970-01-01'</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >,E'公益是一辈子的事, I\'m Digoal.Zhou, Just do it!',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'digoal@126.com',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >276732431,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >clock_timestamp(),</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >NULL;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_info_3 (userid,engname,cnname,occupation,birthday,signname,email,qq,crt_time,mod_time)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >select generate_series(12000001,16000000),</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'digoal.zhou',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'德哥',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'DBA',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'1970-01-01'</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >,E'公益是一辈子的事, I\'m Digoal.Zhou, Just do it!',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'digoal@126.com',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >276732431,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >clock_timestamp(),</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >NULL;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_info_4 (userid,engname,cnname,occupation,birthday,signname,email,qq,crt_time,mod_time)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >select generate_series(16000001,20000000),</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'digoal.zhou',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'德哥',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'DBA',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'1970-01-01'</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >,E'公益是一辈子的事, I\'m Digoal.Zhou, Just do it!',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >'digoal@126.com',</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >276732431,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >clock_timestamp(),</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >NULL;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_session_0 (userid) select generate_series(1,4000000);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_session_1 (userid) select generate_series(4000001,8000000);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_session_2 (userid) select generate_series(8000001,12000000);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_session_3 (userid) select generate_series(12000001,16000000);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_session_4 (userid) select generate_series(16000001,20000000);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >set work_mem='2048MB';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >set maintenance_work_mem='2048MB';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >alter table user_info_0 add primary key (userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >alter table user_info_1 add primary key (userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >alter table user_info_2 add primary key (userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >alter table user_info_3 add primary key (userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >alter table user_info_4 add primary key (userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >alter table user_session_0 add primary key (userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >alter table user_session_1 add primary key (userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >alter table user_session_2 add primary key (userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >alter table user_session_3 add primary key (userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >alter table user_session_4 add primary key (userid);</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >同样通过pgfincore把他们加载到内存中, 这里不详细描述.</div><div style="line-height: 22px;"   >新建登陆和退出函数</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create or replace function f_user_login_0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(i_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_engname text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_cnname text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_occupation text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_birthday date,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_signname text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_email text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_qq numeric</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >into o_userid,o_engname,o_cnname,o_occupation,o_birthday,o_signname,o_email,o_qq</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >from user_info_0 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >update user_session_0 set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create or replace function f_user_login_1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(i_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_engname text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_cnname text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_occupation text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_birthday date,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_signname text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_email text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_qq numeric</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >into o_userid,o_engname,o_cnname,o_occupation,o_birthday,o_signname,o_email,o_qq</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >from user_info_1 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >update user_session_1 set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create or replace function f_user_login_2</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(i_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_engname text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_cnname text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_occupation text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_birthday date,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_signname text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_email text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_qq numeric</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >into o_userid,o_engname,o_cnname,o_occupation,o_birthday,o_signname,o_email,o_qq</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >from user_info_2 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >update user_session_2 set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create or replace function f_user_login_3</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(i_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_engname text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_cnname text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_occupation text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_birthday date,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_signname text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_email text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_qq numeric</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >into o_userid,o_engname,o_cnname,o_occupation,o_birthday,o_signname,o_email,o_qq</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >from user_info_3 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >update user_session_3 set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create or replace function f_user_login_4</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(i_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_engname text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_cnname text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_occupation text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_birthday date,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_signname text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_email text,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_qq numeric</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >into o_userid,o_engname,o_cnname,o_occupation,o_birthday,o_signname,o_email,o_qq</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >from user_info_4 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >update user_session_4 set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create or replace function f_user_logout_0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(i_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_result int</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_logout_rec (userid,logout_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >update user_session_0 set logouttime=now(),online_interval=online_interval+(now()-logintime) where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >o_result := 0;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >exception&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >when others then</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >o_result := 1;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create or replace function f_user_logout_1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(i_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_result int</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_logout_rec (userid,logout_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >update user_session_1 set logouttime=now(),online_interval=online_interval+(now()-logintime) where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >o_result := 0;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >exception&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >when others then</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >o_result := 1;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create or replace function f_user_logout_2</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(i_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_result int</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_logout_rec (userid,logout_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >update user_session_2 set logouttime=now(),online_interval=online_interval+(now()-logintime) where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >o_result := 0;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >exception&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >when others then</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >o_result := 1;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create or replace function f_user_logout_3</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(i_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_result int</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_logout_rec (userid,logout_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >update user_session_3 set logouttime=now(),online_interval=online_interval+(now()-logintime) where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >o_result := 0;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >exception&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >when others then</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >o_result := 1;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >create or replace function f_user_logout_4</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(i_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >OUT o_result int</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into user_logout_rec (userid,logout_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >update user_session_4 set logouttime=now(),online_interval=online_interval+(now()-logintime) where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >o_result := 0;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >exception&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >when others then</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >o_result := 1;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >language plpgsql;</font></div><p style="line-height: 22px;"   ></p></pre></div></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >【调优阶段7】</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >1. 登陆脚本</span></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >cat login*.sql</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >\setrandom userid 1 4000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >SELECT f_user_login_0(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >\setrandom userid 4000001 8000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >SELECT f_user_login_1(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >\setrandom userid 8000001 12000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >SELECT f_user_login_2(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >\setrandom userid 12000001 16000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >SELECT f_user_login_3(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >\setrandom userid 16000001 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >SELECT f_user_login_4(:userid);</font></div><p style="line-height: 22px;"   ></p></pre></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >2. 退出脚本</span></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >cat logout*.sql</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >\setrandom userid 1 4000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >SELECT f_user_logout_0(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >\setrandom userid 4000001 8000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >SELECT f_user_logout_1(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >\setrandom userid 8000001 12000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >SELECT f_user_logout_2(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >\setrandom userid 12000001 16000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >SELECT f_user_logout_3(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >\setrandom userid 16000001 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >SELECT f_user_logout_4(:userid);</font></div><p style="line-height: 22px;"   ></p></pre></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >3. 压力测试</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pgbench -M prepared -r -c 1 -f /home/postgres/test/login0.sql -j 1 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login0 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pgbench -M prepared -r -c 1 -f /home/postgres/test/login1.sql -j 1 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login1 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pgbench -M prepared -r -c 2 -f /home/postgres/test/login2.sql -j 2 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login2 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pgbench -M prepared -r -c 2 -f /home/postgres/test/login3.sql -j 2 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login3 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pgbench -M prepared -r -c 2 -f /home/postgres/test/login4.sql -j 2 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login4 &amp;</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >4. 测试结果</span></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >cat log.log*</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of clients: 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of threads: 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of transactions actually processed: 233348</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 1281.818097 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 1281.837109 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003492 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 4000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.771932 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_0(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of clients: 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of threads: 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of transactions actually processed: 233466</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 1282.514774 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 1282.573500 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003546 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 4000001 8000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.771399 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_1(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of clients: 2</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of threads: 2</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of transactions actually processed: 475466</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 2612.200783 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 2612.281526 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003605 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 8000001 12000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.757312 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_2(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of clients: 2</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of threads: 2</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of transactions actually processed: 468904</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 2576.380443 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 2576.488485 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003587 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 12000001 16000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.767869 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_3(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of clients: 2</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of threads: 2</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of transactions actually processed: 439381</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 2414.347086 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 2414.425600 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.004431 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 16000001 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.817879 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_4(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >总计 :&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 10167.261183 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 10167.261183 (excluding connections establishing)</font></div><p style="line-height: 22px;"   ></p></pre></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >5. 瓶颈分析与优化</span></div><div style="line-height: 22px;"   >到这里我们还没有关注过表空间, 其实这些表拆分后它们还在同一个表空间里面. 把它们放在不同的表空间可以扩展它们整体的IO吞吐能力.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >postgres=# \db+</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of tablespaces</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; Name &nbsp; &nbsp;| &nbsp;Owner &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Location &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;Access privileges &nbsp;| Description&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------+----------+---------------------------------------------+---------------------+-------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;digoal &nbsp; &nbsp; | postgres | /pgdata/digoal/1921/data02/pg_tbs/digoal &nbsp; &nbsp;| postgres=C/postgres+|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | digoal=C/postgres &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;digoal_01 &nbsp;| postgres | /pgdata/digoal/1921/data03/pg_tbs/digoal_01 | postgres=C/postgres+|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | digoal=C/postgres &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;digoal_02 &nbsp;| postgres | /pgdata/digoal/1921/data04/pg_tbs/digoal_02 | postgres=C/postgres+|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | digoal=C/postgres &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;digoal_03 &nbsp;| postgres | /pgdata/digoal/1921/data05/pg_tbs/digoal_03 | postgres=C/postgres+|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | digoal=C/postgres &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;digoal_04 &nbsp;| postgres | /pgdata/digoal/1921/data06/pg_tbs/digoal_04 | postgres=C/postgres+|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | digoal=C/postgres &nbsp; |&nbsp;</font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=&gt; alter table user_info_0 set tablespace digoal_04;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ALTER TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=&gt; alter table user_info_2 set tablespace digoal_01;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ALTER TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=&gt; alter table user_info_3 set tablespace digoal_02;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ALTER TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=&gt; alter table user_info_4 set tablespace digoal_03;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=&gt; alter index user_info_0_pkey set tablespace digoal_04;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ALTER INDEX</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=&gt; alter index user_info_2_pkey set tablespace digoal_01;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ALTER INDEX</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=&gt; alter index user_info_3_pkey set tablespace digoal_02;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ALTER INDEX</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=&gt; alter index user_info_4_pkey set tablespace digoal_03;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=&gt; alter table user_session_0 set tablespace digoal_04;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ALTER TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=&gt; alter table user_session_2 set tablespace digoal_01;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ALTER TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=&gt; alter table user_session_3 set tablespace digoal_02;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ALTER TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=&gt; alter table user_session_4 set tablespace digoal_03;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=&gt; alter index user_session_0_pkey set tablespace digoal_04;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ALTER INDEX</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=&gt; alter index user_session_2_pkey set tablespace digoal_01;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ALTER INDEX</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=&gt; alter index user_session_3_pkey set tablespace digoal_02;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ALTER INDEX</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=&gt; alter index user_session_4_pkey set tablespace digoal_03;</font></div></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >重新把它们加载到内存.</div></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >下节 :&nbsp;</div><wbr style="line-height: 22px;"   ><span style="line-height: 22px;"   >&nbsp;</span><a style="line-height: 22px; " href="http://blog.163.com/digoal@126/blog/static/163877040201221333411196/"   >http://blog.163.com/digoal@126/blog/static/163877040201221333411196/</a><wbr><br><div><br></div><div>【附】</div><div>pgbench simple|extended|prepare 部分源码 :&nbsp;</div><div>1. pgbench.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (commands[st-&gt;state]-&gt;type == SQL_COMMAND)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; const Command *command = commands[st-&gt;state];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (querymode == QUERY_SIMPLE)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *sql;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sql = xstrdup(command-&gt;argv[0]);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sql = assignVariables(st, sql);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (debug)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr, "client %d sending %s\n", st-&gt;id, sql);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r = PQsendQuery(st-&gt;con, sql);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; free(sql);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (querymode == QUERY_EXTENDED)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; const char *sql = command-&gt;argv[0];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; const char *params[MAX_ARGS];</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; getQueryParams(st, command, params);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (debug)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr, "client %d sending %s\n", st-&gt;id, sql);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r = PQsendQueryParams(st-&gt;con, sql, command-&gt;argc - 1,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NULL, params, NULL, NULL, 0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (querymode == QUERY_PREPARED)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;name[MAX_PREPARE_NAME];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; const char *params[MAX_ARGS];</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!st-&gt;prepared[st-&gt;use_file])</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; j;</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for (j = 0; commands[j] != NULL; j++)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PGresult &nbsp; *res;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;name[MAX_PREPARE_NAME];</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (commands[j]-&gt;type != SQL_COMMAND)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; continue;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; preparedStatementName(name, st-&gt;use_file, j);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res = PQprepare(st-&gt;con, name,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; commands[j]-&gt;argv[0], commands[j]-&gt;argc - 1, NULL);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (PQresultStatus(res) != PGRES_COMMAND_OK)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr, "%s", PQerrorMessage(st-&gt;con));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PQclear(res);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; st-&gt;prepared[st-&gt;use_file] = true;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; getQueryParams(st, command, params);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; preparedStatementName(name, st-&gt;use_file, st-&gt;state);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (debug)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr, "client %d sending %s\n", st-&gt;id, name);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r = PQsendQueryPrepared(st-&gt;con, name, command-&gt;argc - 1,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; params, NULL, NULL, 0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div></div><p></p></pre></div>2.&nbsp;src/interfaces/libpq/fe-exec.c<br><div><p><br></p><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL性能优化综合案例讲解 - 1 - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">AdamZhong - 2012-12-26 10:28:45</h5>
				<div>写的非常详细，感谢德哥！！</div>
			</div>
			<div id="">
				<h5 id="">bearmaphao - 2012-06-14 14:32:12</h5>
				<div>学习了。<br><br></div>
			</div>
			<div id="">
				<h5 id="">jshf - 2012-06-01 19:22:34</h5>
				<div><img src="http://b.bst.126.net/common/portrait/face/preview/face55.gif"  >学习</div>
			</div>
	</div>
</div>
</body>
</html>