<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">explain postmaster.pid</h2>
	<h5 id="">2012-03-15 17:48:30&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201221554316637/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>今天我们部门内部的数据库讲座, 提到了postmaster.pid这个文件, 我以前并没有仔细的去查看它每一行的含义.</div><div>刚好今天有机会查了一下源码, 再加上三个臭皮匠赛过一个诸葛亮. 终于把每一行的意思给搞明白了.</div>先来看一个postmaster.pid文件的内容 :&nbsp;<wbr><div><div>cat postmaster.pid</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >2551</font></div><div><font size="2"  >/pgdata/digoal/1921/data02/pg_root</font></div><div><font size="2"  >1331803654</font></div><div><font size="2"  >1921</font></div><div><font size="2"  >/pgdata/digoal/1921/data02/pg_root</font></div><div><font size="2"  >0.0.0.0</font></div><div><font size="2"  >&nbsp; 1921001 &nbsp; 6127619</font></div><p></p></pre></div></div><div>我一行一行来解释 :&nbsp;</div><div>2551 postgres主进程的PID</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ps -ewf|grep 2551</font></div><div><font size="2"  >postgres &nbsp;2551 &nbsp; &nbsp; 1 &nbsp;0 17:27 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 /opt/pgsql/bin/postgres</font></div><div><font size="2"  >postgres &nbsp;2552 &nbsp;2551 &nbsp;0 17:27 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: logger process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres &nbsp;2554 &nbsp;2551 &nbsp;0 17:27 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres &nbsp;2555 &nbsp;2551 &nbsp;0 17:27 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal writer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres &nbsp;2556 &nbsp;2551 &nbsp;0 17:27 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum launcher process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres &nbsp;2557 &nbsp;2551 &nbsp;0 17:27 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: archiver process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres &nbsp;2558 &nbsp;2551 &nbsp;0 17:27 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process </font>&nbsp;&nbsp;</div><p></p></pre></div><div><span style="font-family: monospace; line-height: 19px; white-space: pre; font-size: small;"  ><br></span></div><div><span style="font-family: monospace; line-height: 19px; white-space: pre; font-size: small;"  >/pgdata/digoal/1921/data02/pg_root</span> </div></div><div><span style="font-family: monospace; line-height: 19px; white-space: pre; font-size: small;"  >数据目录.</span></div><div><span style="font-family: monospace; line-height: 19px; white-space: pre; font-size: small;"  ><br></span></div><div><span style="font-family: monospace; line-height: 19px; white-space: pre; font-size: small;"  >1331803654</span></div><div><font face="monospace"  size="2"  ><span style="line-height: 19px; white-space: pre;"  >这行是这个文件创建的时间转换成epoch. 我一开始一直以为是</span></font><span style="font-family: monospace; font-size: small; line-height: 19px; white-space: pre;"  >pg_postmaster_start_time获得的时间.如果你发现不对的话就去看看postmaster.pid的文件创建时间吧.</span></div><div><font face="monospace"  size="2"  ><div style="line-height: 19px; white-space: pre;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 19px;"  >digoal=# select pg_postmaster_start_time();</div><div style="line-height: 19px;"  >&nbsp; &nbsp;pg_postmaster_start_time &nbsp; &nbsp;</div><div style="line-height: 19px;"  >-------------------------------</div><div style="line-height: 19px;"  >&nbsp;2012-03-15 17:27:34.416047+08</div><div style="line-height: 19px;"  >(1 row)</div><div>digoal=# select extract(epoch from '2012-03-15 17:27:34'::timestamp); &nbsp;</div><div>date_part  &nbsp;</div><div>------------ &nbsp;</div><div>1331803654&nbsp;</div><div>(1 row)</div><p></p></pre></div><div><span style="white-space: pre;"  >虽然上面的postmaster时间和这个文件的创建时间一致, 但它其实是这个文件的创建时间.</span></div><div><pre class="prettyprint"  ><p>stat postmaster.pid   &nbsp;</p><p>File: `postmaster.pid'  &nbsp;</p><p>Size: 119             Blocks: 8          IO Block: 4096  &nbsp;</p><p>regular file Device: fd03h/64771d    Inode: 1572868     Links: 1&nbsp;</p><p>Access: (0600/-rw-------) &nbsp;</p><p>Uid: (  500/postgres)  &nbsp;</p><p>Gid: (  500/postgres)&nbsp;</p><p>Access: 2012-03-15 17:41:10.416810701 +0800&nbsp;</p><p>Modify: 2012-03-15 17:27:34.364810701 +0800&nbsp;</p><p>Change: 2012-03-15 17:27:34.364810701 +0800</p></pre></div><div><span style="white-space: pre;"  ><br></span></div><div><span style="line-height: 19px; white-space: pre;"  >1921 数据库监听端口. 在postgresql.conf中对应 </span><span style="white-space: pre;"  >port = 1921</span></div><span style="line-height: 19px; white-space: pre;"  >&nbsp;</span></font><br></div><div><span style="font-family: monospace; line-height: 19px; white-space: pre; font-size: small;"  >/pgdata/digoal/1921/data02/pg_root 是unix socket的监听目录. 在postgresql.conf中对应 </span><font face="monospace"  size="2"  ><span style="line-height: 19px; white-space: pre;"  >unix_socket_directory = '/pgdata/digoal/1921/data02/pg_root'</span></font></div><div><span style="font-family: monospace; line-height: 19px; white-space: pre; font-size: small;"  ><br></span></div><div><span style="font-family: monospace; line-height: 19px; white-space: pre; font-size: small;"  >0.0.0.0 数据库监听地址, 对应 postgresql.conf 的 </span><font face="monospace"  size="2"  ><span style="line-height: 19px; white-space: pre;"  >listen_addresses = '0.0.0.0'</span></font></div><div><br></div><div>最后一行对应的是共享内存的地址(shared memory segments中的key和shmid).</div><div><span style="font-family: monospace; line-height: 19px; white-space: pre; font-size: small;"  >&nbsp; 1921001 &nbsp; 6127619</span> </div><div><pre class="prettyprint"  ><p></p><div><font face="monospace"  size="2"  ><span style="line-height: 19px;"  >ipcs &nbsp;</span></font></div><div><font face="monospace"  size="2"  ><span style="line-height: 19px;"  >------ Shared Memory Segments --------&nbsp;</span></font></div><div><font face="monospace"  size="2"  ><span style="line-height: 19px;"  >key        shmid      owner      perms      bytes      nattch     status      &nbsp;</span></font></div><div><font face="monospace"  size="2"  ><span style="line-height: 19px;"  >0x001d4fe9 6127619    postgres  600        617250816  4                       </span></font><span style="line-height: 19px; font-size: small;"  > </span></div><div></div><p></p></pre></div><div><span style="font-family: monospace; line-height: 19px; white-space: pre; font-size: small;"  >postmaster.pid显示的是key转成10进制后的数字.</span></div></div>
	</div>
</div>
</body>
</html>