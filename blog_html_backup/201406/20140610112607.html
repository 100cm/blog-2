<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Use LDAP store PostgreSQL Connection parameter & client use it with .pg_service.conf</h2>
	<h5 id="">2014-06-10 11:26:07&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201451011417262/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前面几篇BLOG谈了一下PostgreSQL的用户密码认证可以通过LDAP 来做AUTH.</div><div>客户端提交用户和密码,</div><div>PostgreSQL server根据提供客户端的用户, 以及pg_hba.conf中的配置, 到LDAP server查找匹配条目.</div><div>如果找到了匹配的话, 根据客户端提供的密码在LDAP server进行认证.</div><div>客户端只和PostgreSQL server交互, 认证部分由PostgreSQL server和LDAP server完成. 所以PostgreSQL server编译时需要--with-ldap.</div><div>本文要讲的是LDAP的另一个用法, 用来存储客户端连接数据库的连接信息.</div><div>例如psql -h 172.16.3.150 -p 1818 -U digoal -d digoal</div><div>这里的<span style="line-height: 28px;"   >-h 172.16.3.150 -p 1818 -U digoal -d digoal 存储到LDAP里面.</span></div><div><span style="line-height: 28px;"   >客户端psql通过LDAP获取到连接信息后再去连接数据库, 因此这里的客户端需要配置--with-ldap, 而服务端不需要.</span></div><div><span style="line-height: 28px;"   >首先将连接信息导入LDAP, 这里用到core.schema里面的objectclass&nbsp;</span><span style="line-height: 28px;"   >groupOfUniqueNames, 因为连接信息存储多个, 所以存储到description中, uniqueMember存储1项即可.</span></div><div><pre class="prettyprint"   ><div><div><font size="2"   >[root@db-172-16-3-150 ~]# cat digoal_db.ldif&nbsp;</font></div><div><font size="2"   >dn: cn=digoal,ou=People,dc=my-domain,dc=com</font></div><div><font size="2"   >objectclass: top</font></div><div><font size="2"   >objectclass: groupOfUniqueNames</font></div><div><font size="2"   >cn: digoal</font></div><div><font size="2"   >description: sslmode=allow</font></div><div><font size="2"   >description: user=digoal</font></div><div><font size="2"   >description: dbname=digoal</font></div><div><font size="2"   >description: port=1818</font></div><div><font size="2"   >description: host=172.16.3.150</font></div><div><font size="2"   >uniqueMember: host=172.16.3.150</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-150 ~]# ldapadd -vv -x -w 123321 -D "cn=Manager,dc=my-domain,dc=com" -f digoal_db.ldif</font></div><div><font size="2"   >ldap_initialize( &lt;DEFAULT&gt; )</font></div><div><font size="2"   >add objectclass:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; top</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; groupOfUniqueNames</font></div><div><font size="2"   >add cn:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; digoal</font></div><div><font size="2"   >add description:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sslmode=allow</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; user=digoal</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; dbname=digoal</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; port=1818</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; host=172.16.3.150</font></div><div><font size="2"   >add uniqueMember:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; host=172.16.3.150</font></div><div><font size="2"   >adding new entry "cn=digoal,ou=People,dc=my-domain,dc=com"</font></div><div><font size="2"   >modify complete</font></div></div><p></p></pre></div><div>查找这个DN正常.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# slapcat -s "cn=digoal,ou=People,dc=my-domain,dc=com"</font></div><div><font size="2"   >bdb_db_open: warning - no DB_CONFIG file found in directory /var/lib/ldap: (2).</font></div><div><font size="2"   >Expect poor performance for suffix "dc=my-domain,dc=com".</font></div><div><font size="2"   >dn: cn=digoal,ou=People,dc=my-domain,dc=com</font></div><div><font size="2"   >objectClass: top</font></div><div><font size="2"   >objectClass: groupOfUniqueNames</font></div><div><font size="2"   >cn: digoal</font></div><div><font size="2"   >description: sslmode=allow</font></div><div><font size="2"   >description: user=digoal</font></div><div><font size="2"   >description: dbname=digoal</font></div><div><font size="2"   >description: port=1818</font></div><div><font size="2"   >description: host=172.16.3.150</font></div><div><font size="2"   >uniqueMember: host=172.16.3.150</font></div><div><font size="2"   >structuralObjectClass: groupOfUniqueNames</font></div><div><font size="2"   >entryUUID: 2119866a-848b-1033-8f3c-c1c6b9bc50eb</font></div><div><font size="2"   >creatorsName: cn=Manager,dc=my-domain,dc=com</font></div><div><font size="2"   >createTimestamp: 20140610013437Z</font></div><div><font size="2"   >entryCSN: 20140610013437.788394Z#000000#000#000000</font></div><div><font size="2"   >modifiersName: cn=Manager,dc=my-domain,dc=com</font></div><div><font size="2"   >modifyTimestamp: 20140610013437Z</font></div><p></p></pre></div><div>修改数据库的pg_hba.conf, 允许客户端连接</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd $PGDATA</font></div><div><font size="2"   >vi pg_hba.conf</font></div><div><font size="2"   >host all all 0.0.0.0/0 md5</font></div><div><font size="2"   >pg_ctl reload</font></div><p></p></pre></div><div>查看客户端是否加了--with-ldap配置项.</div><div><div>pg93@db-172-16-3-39-&gt; pg_config --configure</div><div>'--prefix=/home/pg93/pgsql9.3.1' '--with-pgport=1999' '--with-perl' '--with-tcl' '--with-python' '--with-openssl' '--with-pam' '--with-ldap' '--with-libxml' '--with-libxslt' '--enable-thread-safety' '--with-wal-blocksize=16' '--enable-dtrace' '--enable-debug'</div><div>配置~/.pg_service.conf, 注意格式,&nbsp;<span style="line-height: 28px;"   >&nbsp;ldap://host:port/dn?attributes?scope?filter?extensions&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-39-&gt; cat .pg_service.conf&nbsp;</font></div><div><font size="2"   >[mydb]</font></div><div><font size="2"   >ldap://172.16.3.150:389/cn=digoal,ou=People,dc=my-domain,dc=com?description?sub?cn=digoal</font></div><p></p></pre></div><div>使用psql连接, 会先到LDAPserver找到attributes的值作为连接项, 连接到目标数据库.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-39-&gt; psql service=mydb</font></div><div><font size="2"   >Password:&nbsp;</font></div><div><font size="2"   >psql (9.3.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=&gt;&nbsp;</font></div><p></p></pre></div></div><div>如果客户端未配置--with-ldap, 那么在.pg_service.conf中使用ldap uri是会报语法错误的.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-39-&gt; pg_config --configure</font></div><div><font size="2"   >'--prefix=/home/pg94/pgsql9.4devel' '--with-pgport=2999' '--with-perl' '--with-tcl' '--with-python' '--with-openssl' '--with-pam' '--without-ldap' '--with-libxml' '--with-libxslt' '--enable-thread-safety' '--with-wal-blocksize=16' '--enable-dtrace'</font></div><div><font size="2"   >pg94@db-172-16-3-39-&gt; cat .pg_service.conf</font></div><div><font size="2"   >[mydb]</font></div><div><font size="2"   >ldap://172.16.3.150:389/cn=digoal,ou=People,dc=my-domain,dc=com?description?sub?cn=digoal</font></div><div><font size="2"   >pg94@db-172-16-3-39-&gt; psql service=mydb</font></div><div><font size="2"   >psql: syntax error in service file "/home/pg94/.pg_service.conf", line 2</font></div><p></p></pre></div><div>在LDAP server中存储数据库的连接信息, 对于需要修改数据库连接配置的场景, 只需要修改LDAP, 而不需要修改客户端的配置, 方便管理.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020145953644535/"   >http://blog.163.com/digoal@126/blog/static/16387704020145953644535/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020145914717111/"   >http://blog.163.com/digoal@126/blog/static/16387704020145914717111/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014563264469/"   >http://blog.163.com/digoal@126/blog/static/1638770402014563264469/</a></div><div>4.&nbsp;<span style="line-height: 28px;"   >src/interfaces/libpq/fe-connect.c</span></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >/*</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ldapServiceLookup</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;*</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* Search the LDAP URL passed as first argument, treat the result as a</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* string of connection options that are parsed and added to the array of</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* options passed as second argument.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;*</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* LDAP URLs must conform to RFC 1959 without escape sequences.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;ldap://host:port/dn?attributes?scope?filter?extensions</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;*</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* Returns</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;0 if the lookup was successful,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;1 if the connection to the LDAP server could be established but</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;the search was unsuccessful,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;2 if a connection could not be established, and</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;3 if a fatal error occurred.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;*</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* An error message is returned in the third argument for return codes 1 and 3.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;*/</font></div><div style="line-height: 28px;"   ><font size="2"   >static int</font></div><div style="line-height: 28px;"   ><font size="2"   >ldapServiceLookup(const char *purl, PQconninfoOption *options,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PQExpBuffer errorMessage)</font></div><div style="line-height: 28px;"   ><font size="2"   >{</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; port = LDAP_DEF_PORT,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scope,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; msgid,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oldstate,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bool &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;found_keyword;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *url,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*hostname,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*portstr,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*endptr,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*dn,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*scopestr,</font></div><p></p></pre></div></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="Use LDAP store PostgreSQL Connection parameter  client use it with .pg_service.conf - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>