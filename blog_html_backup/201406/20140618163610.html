<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">CentOS 6.x limits changed on a existing running process</h2>
	<h5 id="">2014-06-18 16:36:10&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201451842633844/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前段时间发了一篇关于CentOS 6.x ulimit配置文件变更为/etc/security/limits.d/90-nproc.conf &nbsp;的文章.</div><div>但是如果你的系统中已经存在的进程的nproc是不会被变更过来的. 例如一个数据库服务器.</div><div>PostgreSQL所有的backend process都是从postmaster进程fork出来的, 如果postmaster进程的nproc还是老的配置的话, 资源限制依旧存在, 例如.</div><div><div><font size="2"   color="#ff0000"   >&gt; psql</font></div><div><font size="2"   color="#ff0000"   >psql: could not fork new process for connection: Resource temporarily unavailable</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >could not fork new process for connection: Resource temporarily unavailable</font></div></div><div>这种情况通过修改<span style="line-height: 28px;"   >/etc/security/limits.d/90-nproc.conf是无法实现的,&nbsp;</span></div><div><div><font size="2"   color="#ff0000"   >* soft &nbsp; &nbsp;nproc &nbsp; 131072</font></div><div><font size="2"   color="#ff0000"   >* hard &nbsp; &nbsp;nproc &nbsp; 131072</font></div></div><div><span style="line-height: 28px;"   >但是又不能重启数据库进程怎么办呢?</span></div><div>只要你的内核够新2.6.32+, 那么就可以通过编辑进程的limits来实现.</div><div>例如</div><div><div><font size="2"   color="#ff0000"   >&gt; ps -ewf|grep postgres</font></div><div><font size="2"   color="#ff0000"   >postgres &nbsp;5721 &nbsp;5720 &nbsp;0 Feb26 ? &nbsp; &nbsp; &nbsp; &nbsp;19:11:05 postgres: logger process &nbsp;&nbsp;</font></div></div><div>主进程号是5720</div><div><font size="2"   color="#ff0000"   ># cd /proc/5720</font></div><div><div><font size="2"   color="#ff0000"   ># cat limits</font></div><div><font size="2"   color="#ff0000"   >Limit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Soft Limit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Hard Limit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Units &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max cpu time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;seconds &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max file size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bytes &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max data size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bytes &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max stack size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10485760 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bytes &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max core file size &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bytes &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max resident set &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bytes &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max processes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1024 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 131072 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; processes&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max open files &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;131072 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 131072 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; files &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max locked memory &nbsp; &nbsp; &nbsp; &nbsp; 51200000000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;51200000000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bytes &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max address space &nbsp; &nbsp; &nbsp; &nbsp; unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bytes &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max file locks &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;locks &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max pending signals &nbsp; &nbsp; &nbsp; 256607 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 256607 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; signals &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max msgqueue size &nbsp; &nbsp; &nbsp; &nbsp; 819200 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 819200 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bytes &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max nice priority &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max realtime priority &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max realtime timeout &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;us &nbsp; &nbsp; &nbsp; &nbsp;</font></div></div><div>软限制还是1024, 修改方法</div><div><font size="2"   color="#ff0000"   ># echo -n "Max processes=131072:131072" &gt; limits</font></div><div><div><font size="2"   color="#ff0000"   ># cat limits&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Limit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Soft Limit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Hard Limit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Units &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max cpu time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;seconds &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max file size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bytes &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max data size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bytes &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max stack size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10485760 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bytes &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max core file size &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bytes &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max resident set &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bytes &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max processes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 131072 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 131072 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; processes&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max open files &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;131072 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 131072 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; files &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max locked memory &nbsp; &nbsp; &nbsp; &nbsp; 51200000000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;51200000000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bytes &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max address space &nbsp; &nbsp; &nbsp; &nbsp; unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bytes &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max file locks &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;locks &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max pending signals &nbsp; &nbsp; &nbsp; 256607 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 256607 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; signals &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max msgqueue size &nbsp; &nbsp; &nbsp; &nbsp; 819200 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 819200 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bytes &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max nice priority &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max realtime priority &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   color="#ff0000"   >Max realtime timeout &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unlimited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;us &nbsp; &nbsp; &nbsp; &nbsp;</font></div></div><div>千万不要直接编辑这个文件.</div><div><br></div><div>限制问题解决了, 不会再报资源不足的错误.</div><div><div><font size="2"   color="#ff0000"   >&gt; psql</font></div><div><font size="2"   color="#ff0000"   >psql (9.3.3)</font></div><div><font size="2"   color="#ff0000"   >Type "help" for help.</font></div></div><div><font size="2"   color="#ff0000"   >postgres=&gt;</font></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://serverfault.com/questions/201207/set-max-file-limit-on-a-running-process"   >http://serverfault.com/questions/201207/set-max-file-limit-on-a-running-process</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://blogs.kent.ac.uk/unseenit/2013/06/06/changing-ulimit-for-running-processes/"   >http://blogs.kent.ac.uk/unseenit/2013/06/06/changing-ulimit-for-running-processes/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.nowo.com/run-time-changes-ulimit/"   >http://www.nowo.com/run-time-changes-ulimit/</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020145775247895/"   >http://blog.163.com/digoal@126/blog/static/16387704020145775247895/</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="CentOS 6.x limits changed on a running process - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>