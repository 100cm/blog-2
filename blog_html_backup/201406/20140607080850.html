<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">CentOS 6.x nproc limit change to /etc/security/limits.d/90-nproc.conf</h2>
	<h5 id="">2014-06-07 8:08:50&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020145775247895/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><span style="line-height: 28px;"   >在CentOS 5.x的时代, 修改用户的ulimit配置文件在</span><wbr style="line-height: 28px;"   ><span style="line-height: 28px;"   >/etc/security/limits.conf, 包括nproc的限制.</span></div><div>例如</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi /etc/security/limits.conf</font></div><div><div><font size="2"   ># /etc/security/limits.conf</font></div><div><font size="2"   >#</font></div><div><font size="2"   >#Each line describes a limit for a user in the form:</font></div><div><font size="2"   >#</font></div><div><font size="2"   >#&lt;domain&gt; &nbsp; &nbsp; &nbsp; &nbsp;&lt;type&gt; &nbsp;&lt;item&gt; &nbsp;&lt;value&gt;</font></div><div><font size="2"   >#</font></div><div><font size="2"   >#Where:</font></div><div><font size="2"   >#&lt;domain&gt; can be:</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- an user name</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- a group name, with @group syntax</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- the wildcard *, for default entry</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- the wildcard %, can be also used with %group syntax,</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for maxlogin limit</font></div><div><font size="2"   >#</font></div><div><font size="2"   >#&lt;type&gt; can have the two values:</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- "soft" for enforcing the soft limits</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- "hard" for enforcing hard limits</font></div><div><font size="2"   >#</font></div><div><font size="2"   >#&lt;item&gt; can be one of the following:</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- core - limits the core file size (KB)</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- data - max data size (KB)</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- fsize - maximum filesize (KB)</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- memlock - max locked-in-memory address space (KB)</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- nofile - max number of open files</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- rss - max resident set size (KB)</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- stack - max stack size (KB)</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- cpu - max CPU time (MIN)</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- nproc - max number of processes</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- as - address space limit (KB)</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- maxlogins - max number of logins for this user</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- maxsyslogins - max number of logins on the system</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- priority - the priority to run user process with</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- locks - max number of file locks the user can hold</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- sigpending - max number of pending signals</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- msgqueue - max memory used by POSIX message queues (bytes)</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- nice - max nice priority allowed to raise to values: [-20, 19]</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp;- rtprio - max realtime priority</font></div><div><font size="2"   >#</font></div><div><font size="2"   >#&lt;domain&gt; &nbsp; &nbsp; &nbsp;&lt;type&gt; &nbsp;&lt;item&gt; &nbsp; &nbsp; &nbsp; &nbsp; &lt;value&gt;</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >* soft &nbsp; &nbsp;nofile &nbsp;131072</font></div><div><font size="2"   >* hard &nbsp; &nbsp;nofile &nbsp;131073</font></div><div><font size="2"   >* soft &nbsp; &nbsp;nproc &nbsp; 131072</font></div><div><font size="2"   >* hard &nbsp; &nbsp;nproc &nbsp; 131073</font></div><div><font size="2"   >* soft &nbsp; &nbsp;core &nbsp; &nbsp;unlimited</font></div><div><font size="2"   >* hard &nbsp; &nbsp;core &nbsp; &nbsp;unlimited</font></div><div><font size="2"   >* soft &nbsp; &nbsp;memlock 50000000</font></div><div><font size="2"   >* hard &nbsp; &nbsp;memlock 50000001</font></div></div><div><font size="2"   ><br></font></div><div><div><div><font size="2"   >[root@db6 ~]# ulimit -u</font></div><div><font size="2"   >131072</font></div><div><font size="2"   >[root@db6 ~]# su - postgres</font></div><div><font size="2"   >postgres@db6-&gt; ulimit -u</font></div><div><font size="2"   >131072</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db6 ~]# cat /etc/redhat-release&nbsp;</font></div><div><font size="2"   ># Red Hat Enterprise Linux Server release 4.2 (Tikanga)</font></div><div><font size="2"   >CentOS release 5.2 (Final)</font></div><div><font size="2"   >[root@db6 ~]# uname -r</font></div><div><font size="2"   >2.6.18-92.el5</font></div></div><p></p></pre></div><div><br></div><div>同样的配置, 在CentOS 6.x, 普通用户是1024, root用户是<span style="line-height: 28px;"   >131073.</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 ~]# uname -r</font></div><div><font size="2"   >2.6.32-358.el6.x86_64</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# cat /etc/redhat-release&nbsp;</font></div><div><font size="2"   >CentOS release 6.4 (Final)</font></div></div><div><div><font size="2"   >postgres@db-172-16-3-150-&gt; ulimit -u</font></div><div><font size="2"   >1024</font></div><div><font size="2"   >postgres@db-172-16-3-150-&gt; exit</font></div><div><font size="2"   >logout</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# ulimit -u</font></div><div><font size="2"   >131073</font></div></div><p></p></pre></div><div>原因是6.x新增了一个nproc的配置文件</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# cat /etc/security/limits.d/90-nproc.conf&nbsp;</font></div><div><font size="2"   ># Default limit for number of user's processes to prevent</font></div><div><font size="2"   ># accidental fork bombs.</font></div><div><font size="2"   ># See rhbz #432903 for reasoning.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;soft &nbsp; &nbsp;nproc &nbsp; &nbsp; 1024</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp; soft &nbsp; &nbsp;nproc &nbsp; &nbsp; unlimited</font></div><p></p></pre></div><div>普通用户的nproc必须配置这个文件才能生效.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 ~]# vi /etc/security/limits.d/90-nproc.conf&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Default limit for number of user's processes to prevent</font></div><div><font size="2"   ># accidental fork bombs.</font></div><div><font size="2"   ># See rhbz #432903 for reasoning.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;soft &nbsp; &nbsp;nproc &nbsp; &nbsp; 111111</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp; soft &nbsp; &nbsp;nproc &nbsp; &nbsp; unlimited</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-150 ~]# ulimit -u</font></div><div><font size="2"   >131073</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# su - postgres</font></div><div><font size="2"   >postgres@db-172-16-3-150-&gt; ulimit -u</font></div><div><font size="2"   >111111</font></div></div><p></p></pre></div><div><br></div><div>普通用户用了/etc/security/limits.d/90-nproc.conf&nbsp;软限制的配置, 而root用户用了/etc/security/limits.conf硬限制的配置.</div><div><br></div><div>如果把<span style="line-height: 28px;"   >/etc/security/limits.d/90-nproc.conf注释掉, /etc/security/limits.conf的配置就生效了.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# su - postgres</font></div><div><font size="2"   >postgres@db-172-16-3-150-&gt; ulimit -u</font></div><div><font size="2"   >131072</font></div><div><font size="2"   >postgres@db-172-16-3-150-&gt; exit</font></div><div><font size="2"   >logout</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# ulimit -u</font></div><div><font size="2"   >131073</font></div><p></p></pre></div><div><br></div><div>小结</div><div>1. 说明<span style="line-height: 28px;"   >/etc/security/limits.d/90-nproc.conf优先级更高.</span></div><div><span style="line-height: 28px;"   >2. 说明普通用户采用</span><span style="line-height: 28px;"   >软限制的配置, root用户采用硬限制的配置.</span></div><div><span style="line-height: 28px;"   >如果需要更详细的了解内核对资源限制的机制, 可以参考褚霸的这篇文章</span><a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://csrd.aliapp.com/?p=1760"   >http://csrd.aliapp.com/?p=1760</a>.</div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >其他参考文章</span></div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://csrd.aliapp.com/?p=1760"   >http://csrd.aliapp.com/?p=1760</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://kumu1988.blog.51cto.com/4075018/1091369"   >http://kumu1988.blog.51cto.com/4075018/1091369</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="CentOS 6.x nproc limit change to /etc/security/limits.d/90-nproc.conf - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>