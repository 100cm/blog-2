<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Active archive_command (or fork pgarch  proc) on PostgreSQL's standby node by modify postmaster.c and walreceiver.c</h2>
	<h5 id="">2014-06-20 12:53:37&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201452004721783/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL standby节点(换句话说, 数据库未进入PM_RUN状态的时候) , 在启动数据库后, 不会触发pgarch进程.</div><div>也就是说postgresql 的standby节点是没有办法做xlog的归档的.</div><div>当然PG不允许standby节点归档, 也是情有可原, 但是我个人觉得, 这个可以交给用户自己来决定是否需要开启standby节点的归档功能. 例如增肌一个GUC参数, 控制standby节点是否允许归档.</div><div><br></div><div>好了不扯淡, 接下来要做的是如何开启standby的归档, 以下是最简单粗暴的方法.</div><div>有两处代码需要修改.</div><div>第一处, 去除启动pgarch进程的状态判断, 这样的话standby节点也可以启动archiver进程.</div><div><font size="2"   color="#ff0000"   >1.&nbsp;src/backend/postmaster/postmaster.c</font></div><div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (XLogArchivingActive() &amp;&amp; PgArchPID == 0 )</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //if (XLogArchivingActive() &amp;&amp; PgArchPID == 0 &amp;&amp; pmState == PM_RUN)</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PgArchPID = pgarch_start();</font></div></div><div><font size="2"   color="#ff0000"   >...</font></div><div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (XLogArchivingActive())</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //if (XLogArchivingActive() &amp;&amp; pmState == PM_RUN)</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PgArchPID = pgarch_start();</font></div></div><div>第二除, 修改walreceiver进程的接收部分, 不接收.done文件.</div><div>这个文件在$PGDATA/pg_xlog/archive_status里面, 文件名由两部分组成xlog_name.done, 表示已经归档完成.</div><div>如果walreceiver直接生成这个文件, 将使得archiver认为这个文件已经归档了, 所以不需要再归档.</div><div>同时archive需要通过xlog_name.ready来判断是否需要对该XLOG文件进行归档, 所以我们这把生成.done, 改成.ready.</div><div><font size="2"   color="#ff0000"   >2.&nbsp;<span style="line-height: 28px;"   >src/backend/replication/walreceiver.c</span></font></div><div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Create .done file forcibly to prevent the streamed segment from</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* being archived later.</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XLogFileName(xlogfname, recvFileTLI, recvSegNo);</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //XLogArchiveForceDone(xlogfname);</font></div></div><div><font color="#ff0000"   size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="line-height: 22.75px;"   >XLogArchiveNotify(xlogfname);</span></font></div><div><font size="2"   color="#ff0000"   >....</font></div><div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Create .done file forcibly to prevent the streamed segment</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* from being archived later.</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XLogFileName(xlogfname, recvFileTLI, recvSegNo);</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //XLogArchiveForceDone(xlogfname);</font></div></div><div><font color="#ff0000"   size="2"   ><span style="line-height: 22.75px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;XLogArchiveNotify(xlogfname);</span></font></div><div>修改后重新编译standby节点的postgresql程序, 重启standby.</div><div>现在standby节点可以正常的执行archive_command里配置的命令了.</div><div>这个场景主要应用在以standby节点为备份节点的场景中. 主节点不需要开启归档, 由备份节点去完成归档.</div><div><br></div><div>注意, 修改后, 因为standby节点会fork出archive进程, 所以在关库的时候也需要关这个进程, 相应的代码本文未修改, 所以关库会卡住, 你可以使用pg_ctl stop -m immediate来关.</div><div><br></div><div>本文仅供测试, 不建议在生产中使用.</div><div><br></div>[参考]<div>1.&nbsp;src/backend/postmaster/postmaster.c<br><wbr><div>2.&nbsp;src/backend/postmaster/pgarch.c</div><div>3.&nbsp;src/backend/replication/walreceiver.c</div></div><div>4.&nbsp;src/backend/access/transam/xlogarchive.c</div><div><div><font size="2"   color="#ff0000"   >/*</font></div><div><font size="2"   color="#ff0000"   >&nbsp;* XLogArchiveNotify</font></div><div><font size="2"   color="#ff0000"   >&nbsp;*</font></div><div><font size="2"   color="#ff0000"   >&nbsp;* Create an archive notification file</font></div><div><font size="2"   color="#ff0000"   >&nbsp;*</font></div><div><font size="2"   color="#ff0000"   >&nbsp;* The name of the notification file is the message that will be picked up</font></div><div><font size="2"   color="#ff0000"   >&nbsp;* by the archiver, e.g. we write 0000000100000001000000C6.ready</font></div><div><font size="2"   color="#ff0000"   >&nbsp;* and the archiver then knows to archive XLOGDIR/0000000100000001000000C6,</font></div><div><font size="2"   color="#ff0000"   >&nbsp;* then when complete, rename it to 0000000100000001000000C6.done</font></div><div><font size="2"   color="#ff0000"   >&nbsp;*/</font></div><div><font size="2"   color="#ff0000"   >void</font></div><div><font size="2"   color="#ff0000"   >XLogArchiveNotify(const char *xlog)</font></div></div><div><font size="2"   color="#ff0000"   >...</font></div><div><div><font size="2"   color="#ff0000"   >/*</font></div><div><font size="2"   color="#ff0000"   >&nbsp;* XLogArchiveForceDone</font></div><div><font size="2"   color="#ff0000"   >&nbsp;*</font></div><div><font size="2"   color="#ff0000"   >&nbsp;* Emit notification forcibly that an XLOG segment file has been successfully</font></div><div><font size="2"   color="#ff0000"   >&nbsp;* archived, by creating &lt;XLOG&gt;.done regardless of whether &lt;XLOG&gt;.ready</font></div><div><font size="2"   color="#ff0000"   >&nbsp;* exists or not.</font></div><div><font size="2"   color="#ff0000"   >&nbsp;*/</font></div><div><font size="2"   color="#ff0000"   >void</font></div><div><font size="2"   color="#ff0000"   >XLogArchiveForceDone(const char *xlog)</font></div></div><div><br></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL active archive_command (or fork pgarch  proc) in standby node by modify postmaster.c and walreceiver.c - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>