<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">why you cann't create reference by objects(like mview,foreign table) other than TABLE</h2>
	<h5 id="">2015-04-22 9:28:17&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020153229205997/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>一位网友问我的一个问题，使用plproxy将数据库拆分后，如果有两个表一个在A库一个在B库，能不能创建他们之间的外键关联关系。</div><div>显然，目前是不行的，为什么呢？创建外键关系后，如果被关联表的值删除或变更，是可能影响关联表的关联关系的，所以这两者必须在同一个数据库，或者它们之间务必要能方便的维护这种关系，例如数据库可以自动的实行for update, for delete这样的操作。</div><div>假设我关联的表在另一个数据库，那么另一个数据库必须要能方便的自动实行for update,for delete这样的关系，这在目前的PostgreSQL是无法实现的。除非你自己去添加这部分代码。</div><div>我们举个例子，例如我创建一个跨库的外部表，然后在本地创建基于这个外部表的关联表，看看是否可行？</div><div>根据前面的知识了解，如果要建立这样的关联关系，那么外部表所在的数据库必须要能方便的操作本地的数据库对应的这个关联表，显然这个目前PostgreSQL没有实现这一的功能。</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.4.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><p></p></pre></div><div>外部表</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# \det</font></div><div><font size="2"   >&nbsp;List of foreign tables</font></div><div><font size="2"   >&nbsp;Schema | Table | Server&nbsp;</font></div><div><font size="2"   >--------+-------+--------</font></div><div><font size="2"   >&nbsp;rmt &nbsp; &nbsp;| ft1 &nbsp; | rmt</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >postgres=# \d rmt.ft1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Foreign table "rmt.ft1"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers | FDW Options&nbsp;</font></div><div><font size="2"   >--------+---------+-----------+-------------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; | integer | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;info &nbsp; | text &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >Server: rmt</font></div><div><font size="2"   >FDW Options: (schema_name 'public', table_name 'test')</font></div></div><p></p></pre></div><div>对应的远程表</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# truncate test;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >postgres=# insert into test select generate_series(1,100);</font></div><div><font size="2"   >INSERT 0 100</font></div><div><font size="2"   >postgres=# alter table test add constraint pk_test primary key (id);</font></div><div><font size="2"   >ALTER TABLE</font></div><p></p></pre></div><div>创建基于外部表的关联关系，注意报错代码</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \set VERBOSITY verbose</font></div><div><font size="2"   >postgres=# create table tttt (id int references rmt.ft1(id),info text,crt_time timestamp);</font></div><div><font size="2"   >ERROR: &nbsp;42809: referenced relation "ft1" is not a table</font></div><div><font size="2"   >LOCATION: &nbsp;ATAddForeignKeyConstraint, tablecmds.c:5937</font></div><div><font size="2"   >postgres=# \q</font></div><p></p></pre></div></div></div><div>这个错误来自如下代码，即需要检查关联表是否为TABLE，否则报错。</div><div>这不是简单的修改一下if (pkrel-&gt;rd_rel-&gt;relkind != RELKIND_RELATION)就可以的，因为还有我前面说的，需要处理那些关系。</div><div>src/backend/commands/tablecmds.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Validity checks (permission checks wait till we have the column</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* numbers)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (pkrel-&gt;rd_rel-&gt;relkind != RELKIND_RELATION)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_WRONG_OBJECT_TYPE),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("referenced relation \"%s\" is not a table",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RelationGetRelationName(pkrel))));</font></div><p></p></pre></div><div>数据库所有的relkind如下：</div><div><div style="line-height: 28px;"   >src/include/catalog/pg_class.h</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >#define &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RELKIND_RELATION &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'r' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* ordinary table */</font></div><div style="line-height: 28px;"   ><font size="2"   >#define &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RELKIND_INDEX &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'i' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* secondary index */</font></div><div style="line-height: 28px;"   ><font size="2"   >#define &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RELKIND_SEQUENCE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'S' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* sequence object */</font></div><div style="line-height: 28px;"   ><font size="2"   >#define &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RELKIND_TOASTVALUE &nbsp; &nbsp; &nbsp;'t' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* for out-of-line values */</font></div><div style="line-height: 28px;"   ><font size="2"   >#define &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RELKIND_VIEW &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'v' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* view */</font></div><div style="line-height: 28px;"   ><font size="2"   >#define &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RELKIND_COMPOSITE_TYPE &nbsp;'c' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* composite type */</font></div><div style="line-height: 28px;"   ><font size="2"   >#define &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RELKIND_FOREIGN_TABLE &nbsp; 'f' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* foreign table */</font></div><div style="line-height: 28px;"   ><font size="2"   >#define &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RELKIND_MATVIEW &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'm' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* materialized view */</font></div><p></p></pre></div></div><div style="line-height: 28px;"   ><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="why you cannt create reference by objects(like mview,foreign table) other than TABLE - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>