<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">install kvm hosts use vnc in CentOS 6</h2>
	<h5 id="">2015-04-01 16:26:56&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020153142253971/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>本文描述在centos6中部署kvm虚拟机, 使用vnc连接到服务器, 再使用vncviewer连接到kvm vnc安装界面.</div><div>(原本打算直接连接到kvm vnc安装界面的, 没有成功, 会闪退)</div><div><br></div><div>在服务器安装必要的包</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># yum install -y qemu-img qemu-kvm virt-manager libvirt libvirt-python python-virtinst libvirt-client tigervnc-server libvirt libvirt-client virt-what virt-viewer</font></div><div><font size="2"   ># yum groupinstall -y desktop</font></div><p></p></pre></div><div>创建一个虚拟磁盘目录</div><pre class="prettyprint"   ><p></p><div><font size="2"   ># mkdir /data03/kvmdisk</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >创建虚拟磁盘, 用于虚拟机的系统盘</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   ># qemu-img create -f qcow2 -o encryption=off,cluster_size=2M,preallocation=full /data03/kvmdisk/disk01.img 32G</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >下载安装镜像</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># mkdir /data03/iso</font></div><div><font size="2"   ># cd iso</font></div><div><font size="2"   ># wget http://mirrors.aliyun.com/centos/6.6/isos/x86_64/CentOS-6.6-x86_64-bin-DVD1.iso</font></div><p></p></pre></div><div>启动libvirtd</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># service libvirtd start</font></div><div><font size="2"   ># chkconfig libvirtd on</font></div><div><font size="2"   ># chkconfig libvirt-guests off</font></div><p></p></pre></div><div>查看当前启动的网桥</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   ># brctl show</font></div><div><font size="2"   >bridge name &nbsp; &nbsp; bridge id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; STP enabled &nbsp; &nbsp; interfaces</font></div><div><font size="2"   >virbr0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8000.5254001263b0 &nbsp; &nbsp; &nbsp; yes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; virbr0-nic</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   ># ifconfig</font></div><div><font size="2"   >em1 &nbsp; &nbsp; &nbsp; Link encap:Ethernet &nbsp;HWaddr 00:22:19:60:77:8F &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:172.16.3.150 &nbsp;Bcast:172.16.3.255 &nbsp;Mask:255.255.255.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet6 addr: fe80::222:19ff:fe60:778f/64 Scope:Link</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:5469716 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:2830916 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:1000&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:5147311077 (4.7 GiB) &nbsp;TX bytes:198552462 (189.3 MiB)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >lo &nbsp; &nbsp; &nbsp; &nbsp;Link encap:Local Loopback &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:127.0.0.1 &nbsp;Mask:255.0.0.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet6 addr: ::1/128 Scope:Host</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP LOOPBACK RUNNING &nbsp;MTU:65536 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:79073 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:79073 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:24506711 (23.3 MiB) &nbsp;TX bytes:24506711 (23.3 MiB)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >virbr0 &nbsp; &nbsp;Link encap:Ethernet &nbsp;HWaddr 52:54:00:12:63:B0 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:192.168.122.1 &nbsp;Bcast:192.168.122.255 &nbsp;Mask:255.255.255.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:0 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:0 (0.0 b) &nbsp;TX bytes:0 (0.0 b)</font></div><p></p></pre></div><div>网桥地址配置</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># grep -r 192.168.122 /etc/libvirt</font></div><div><font size="2"   >/etc/libvirt/qemu/networks/default.xml: &nbsp;&lt;ip address="192.168.122.1" netmask="255.255.255.0"&gt;</font></div><div><font size="2"   >/etc/libvirt/qemu/networks/default.xml: &nbsp; &nbsp; &nbsp;&lt;range start="192.168.122.2" end="192.168.122.254" /&gt;</font></div><div><font size="2"   >/etc/libvirt/qemu/networks/autostart/default.xml: &nbsp;&lt;ip address="192.168.122.1" netmask="255.255.255.0"&gt;</font></div><div><font size="2"   >/etc/libvirt/qemu/networks/autostart/default.xml: &nbsp; &nbsp; &nbsp;&lt;range start="192.168.122.2" end="192.168.122.254" /&gt;</font></div><p></p></pre></div><div>安装KVM虚拟机, 开启VNC.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># virt-install \</font></div><div><font size="2"   >&nbsp; &nbsp;--name=centos6_6_x64 \</font></div><div><font size="2"   >&nbsp; &nbsp;--disk path=/data03/kvmdisk/disk01.img,device=disk,bus=virtio,perms=rw,cache=writethrough \</font></div><div><font size="2"   >&nbsp; &nbsp;--graphics vnc,listen=0.0.0.0,port=5901,password=digoal \</font></div><div><font size="2"   >&nbsp; &nbsp;--vcpus=4 --ram=4096 \</font></div><div><font size="2"   >&nbsp; &nbsp;--cdrom=/data03/iso/CentOS-6.6-x86_64-bin-DVD1.iso \</font></div><div><font size="2"   >&nbsp; &nbsp;--network bridge=virbr0 \</font></div><div><font size="2"   >&nbsp; &nbsp;--os-type=linux \</font></div><div><font size="2"   >&nbsp; &nbsp;--os-variant=rhel6</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># ps -ewf|grep kvm</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp; 967 &nbsp; &nbsp; 2 &nbsp;0 15:05 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 [kvm-irqfd-clean]</font></div><div><font size="2"   >qemu &nbsp; &nbsp; &nbsp;3582 &nbsp; &nbsp; 1 &nbsp;7 15:15 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 /usr/libexec/qemu-kvm -name centos6_6_x64 -S -M rhel6.6.0 -enable-kvm -m 4096 -realtime mlock=off -smp 4,sockets=4,cores=1,threads=1 -uuid e55d318c-5b3c-a0c0-e694-799c618787ac -nodefconfig -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/centos6_6_x64.monitor,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc -no-reboot -no-shutdown -device ich9-usb-ehci1,id=usb,bus=pci.0,addr=0x4.0x7 -device ich9-usb-uhci1,masterbus=usb.0,firstport=0,bus=pci.0,multifunction=on,addr=0x4 -device ich9-usb-uhci2,masterbus=usb.0,firstport=2,bus=pci.0,addr=0x4.0x1 -device ich9-usb-uhci3,masterbus=usb.0,firstport=4,bus=pci.0,addr=0x4.0x2 -drive file=/data03/kvmdisk/disk01.img,if=none,id=drive-virtio-disk0,format=raw,cache=writethrough -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x5,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=2 -drive file=/data03/iso/CentOS-6.6-x86_64-bin-DVD1.iso,if=none,media=cdrom,id=drive-ide0-1-0,readonly=on,format=raw -device ide-drive,bus=ide.1,unit=0,drive=drive-ide0-1-0,id=ide0-1-0,bootindex=1 -netdev tap,fd=22,id=hostnet0,vhost=on,vhostfd=23 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:5d:70:bd,bus=pci.0,addr=0x3 -chardev pty,id=charserial0 -device isa-serial,chardev=charserial0,id=serial0 -device usb-tablet,id=input0 -vnc 0.0.0.0:1,password -vga cirrus -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x6 -msg timestamp=on</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp;3593 &nbsp; &nbsp; 2 &nbsp;0 15:15 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 [kvm-pit-wq]</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp;3605 &nbsp;2457 &nbsp;0 15:16 pts/2 &nbsp; &nbsp;00:00:00 grep kvm</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># netstat -anp|grep 5901</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:5901 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;3582/qemu-kvm &nbsp; &nbsp;</font></div><p></p></pre></div><div><br></div><div>虽然监听了5901, 但是在外部主机不能连到这个VNC, 会闪退.</div><div>在服务器本地可以连接正常.</div><div><br></div><div>在服务端启动vncserver</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># vncserver :2</font></div><div><font size="2"   ># vi ~/.vnc/xstartup</font></div><div><div><font size="2"   >#twm &amp;</font></div><div><font size="2"   >gnome-session &amp;</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   ># vncserver -kill :2</font></div><div><font size="2"   ># vncserver :2</font></div><p></p></pre></div><div>使用笔记本连接到服务端vnc, 然后在服务端的vnc窗口中使用vncviewer再连接本地的vnc 5901.</div><div>安装过程略.</div><div><br></div><div>其他, 如果要删除虚拟机, 需要删除配置, 重启libvirtd.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># virsh list --all</font></div><div><font size="2"   >&nbsp;Id &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; State</font></div><div><font size="2"   >----------------------------------------------------</font></div><div><font size="2"   >&nbsp;1 &nbsp; &nbsp; centos6_6_x64 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;running</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># virsh destroy 1</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># virsh list --all</font></div><div><font size="2"   >&nbsp;Id &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; State</font></div><div><font size="2"   >----------------------------------------------------</font></div><div><font size="2"   >&nbsp;- &nbsp; &nbsp; centos6_6_x64 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;shut off</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># rm -f /etc/libvirt/qemu/centos6_6_x64.xml</font></div><div><font size="2"   ># service libvirtd restart</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># virsh list --all</font></div><div><font size="2"   >&nbsp;Id &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; State</font></div><div><font size="2"   >----------------------------------------------------</font></div><p></p></pre></div><div><br></div><div>[问题]</div><div>1. 无法直接使用笔记本连接virt-install提供的vnc端口, 必须在服务端连, 目前不知原因.</div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Virtualization_Getting_Started_Guide/ch05.html#idp8381488"   >https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Virtualization_Getting_Started_Guide/ch05.html#idp8381488</a></div><div>2. man virt-install</div><div>3. man virsh</div><div>4. man qemu-kvm</div><div>5. man qemu-img</div><div>6.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Installation_Guide/index.html"   >https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Installation_Guide/index.html</a></div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="install kvm hosts use vnc in CentOS 6 - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>