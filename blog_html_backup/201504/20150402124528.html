<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL who can set parameters's value controlled by guc.c</h2>
	<h5 id="">2015-04-02 12:45:28&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402015320391222/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div><div>本文主要讲一下PostgreSQL如何控制什么用户可以配置哪些权限.</div><div>中午francs问我的一个问题,&nbsp;<span style="line-height: 28px;"   >log_min_duration_statement这个参数普通用户为什么不能在会话中设置?</span></div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; \set VERBOSITY verbose</font></div><div><font size="2"   >postgres=&gt; set log_min_duration_statement=1;</font></div><div><font size="2"   >ERROR: &nbsp;42501: permission denied to set parameter "log_min_duration_statement"</font></div><div><font size="2"   >LOCATION: &nbsp;set_config_option, guc.c:5662</font></div><div><font size="2"   >postgres=&gt; \q</font></div><p></p></pre></div></div><div>从上可以看到报错代码是guc.c</div><div>这个代码实际上是检测参数的配置权限的, 例如哪些参数是需要超级用户来设置的.</div><div>列举部分代码如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 postgresql-9.4.1]# cd /opt/soft_bak/postgresql-9.4.1</font></div><div><font size="2"   >[root@db-172-16-3-150 postgresql-9.4.1]# vi src/backend/utils/misc/guc.c</font></div></div><div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* Support for grand unified configuration scheme, including SET</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* command, configuration file, and command line options.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* See src/backend/utils/misc/README for more information.</font></div></div><div style="line-height: 28px;"   ><font size="2"   >....</font></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* Displayable names for context types (enum GucContext)</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Note: these strings are deliberately not localized.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >const char *const GucContext_Names[] =</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* PGC_INTERNAL */ "internal",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* PGC_POSTMASTER */ "postmaster",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* PGC_SIGHUP */ "sighup",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* PGC_BACKEND */ "backend",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* PGC_SUSET */ "superuser",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* PGC_USERSET */ "user"</font></div><div><font size="2"   >};</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {"log_min_duration_statement",&nbsp;<span style="line-height: 28px;"   >PGC_SUSET</span>, LOGGING_WHEN,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gettext_noop("Sets the minimum execution time above which "</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"statements will be logged."),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gettext_noop("Zero prints all queries. -1 turns this feature off."),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GUC_UNIT_MS</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;log_min_duration_statement,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -1, -1, INT_MAX,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NULL, NULL, NULL</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; },</font></div></div><p></p></pre></div></div><div>为了让普通用户能够修改<span style="line-height: 28px;"   >log_min_duration_statement, 我们需要修改</span><span style="line-height: 28px;"   >其中</span></div><div><pre class="prettyprint"   ><p></p><div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {"log_min_duration_statement",&nbsp;<span style="line-height: 28px;"   >PGC_SUSET</span>, LOGGING_WHEN,</font></div></div><div></div><p></p></pre><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >改成</span></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {"log_min_duration_statement", PGC_USERSET, LOGGING_WHEN,</font></div><div></div><p></p></pre></div><div>重编译</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 postgresql-9.4.1]# pwd</font></div><div><font size="2"   >/opt/soft_bak/postgresql-9.4.1</font></div><div><font size="2"   >[root@db-172-16-3-150 postgresql-9.4.1]# gmake &amp;&amp; gmake install</font></div><p></p></pre></div><div><br></div><div>重启数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - postgres</font></div><div><font size="2"   >pg_ctl restart -m fast</font></div><p></p></pre></div><div><br></div><div>好了, 现在普通用户可以在线修改<span style="line-height: 28px;"   >log_min_duration_statement了.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.4.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# \c postgres test</font></div><div><font size="2"   >You are now connected to database "postgres" as user "test".</font></div><div><font size="2"   >postgres=&gt; set log_min_duration_statement=1;</font></div><div><font size="2"   >SET</font></div><p></p></pre></div><div><br></div><div>[参考<span style="line-height: 28px;"   >]</span></div><div><span style="line-height: 28px;"   >1.&nbsp;</span>src/backend/utils/misc/guc.c</div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL who can set parameterss value controlled by guc.c - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">francs - 2015-04-02 14:36:53</h5>
				<div><img src="http://b.bst.126.net/common/portrait/face/preview/face55.gif"  ></div>
			</div>
	</div>
</div>
</body>
</html>