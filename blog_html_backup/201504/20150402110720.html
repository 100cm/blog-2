<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">add cpu,disk,net card to kvm guest</h2>
	<h5 id="">2015-04-02 11:07:20&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402015321045850/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>本文主要描述一下如何给虚拟机添加硬盘, CPU, 网卡.</div><div>1. 添加硬盘</div><div>创建硬盘文件</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># qemu-img create -f qcow2 -o encryption=off,cluster_size=2M,preallocation=full /data03/kvmdisk/disk02.img 10G</font></div><div><font size="2"   >Formatting '/data03/kvmdisk/disk02.img', fmt=qcow2 size=10737418240 encryption=off cluster_size=2097152 preallocation='full'&nbsp;</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-150 schemas]# virsh</font></div><div><font size="2"   >Welcome to virsh, the virtualization interactive terminal.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Type: &nbsp;'help' for help with commands</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;'quit' to quit</font></div></div><p></p></pre></div><div><div>编辑虚拟机配置</div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >virsh # edit centos6_6_x64</font></div></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >在第一块硬盘配置下面</span><span style="line-height: 28px;"   >添加, 注意文件名, 硬盘名称, 注意slot不要和其他所有项冲突</span></div></div><div><span style="line-height: 28px;"   >缓存自由配置. type可以选择raw或qcow2. &nbsp;数据库建议使用raw格式.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &lt;disk type='file' device='disk'&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;driver name='qemu' type='qcow2' cache='writethrough'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;source file='/data03/kvmdisk/disk02.img'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;target dev='vdb' bus='virtio'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x06' function='0x0'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;/disk&gt;</font></div><p></p></pre></div><div><br></div><div><div>xml全部如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >virsh # dumpxml centos6_6_x64</font></div><div><font size="2"   >&lt;domain type='kvm' id='6'&gt;</font></div><div><font size="2"   >&nbsp; &lt;name&gt;centos6_6_x64&lt;/name&gt;</font></div><div><font size="2"   >&nbsp; &lt;uuid&gt;4c613d4e-716b-f2cb-4df3-09bc7779f7df&lt;/uuid&gt;</font></div><div><font size="2"   >&nbsp; &lt;memory unit='KiB'&gt;4194304&lt;/memory&gt;</font></div><div><font size="2"   >&nbsp; &lt;currentMemory unit='KiB'&gt;4194304&lt;/currentMemory&gt;</font></div><div><font size="2"   >&nbsp; &lt;vcpu placement='static'&gt;4&lt;/vcpu&gt;</font></div><div><font size="2"   >&nbsp; &lt;os&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;type arch='x86_64' machine='rhel6.6.0'&gt;hvm&lt;/type&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;boot dev='hd'/&gt;</font></div><div><font size="2"   >&nbsp; &lt;/os&gt;</font></div><div><font size="2"   >&nbsp; &lt;features&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;acpi/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;apic/&gt;</font></div><div><font size="2"   >&nbsp; &lt;/features&gt;</font></div><div><font size="2"   >&nbsp; &lt;cpu mode='host-model'&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;model fallback='allow'/&gt;</font></div><div><font size="2"   >&nbsp; &lt;/cpu&gt;</font></div><div><font size="2"   >&nbsp; &lt;clock offset='utc'/&gt;</font></div><div><font size="2"   >&nbsp; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;</font></div><div><font size="2"   >&nbsp; &lt;on_reboot&gt;restart&lt;/on_reboot&gt;</font></div><div><font size="2"   >&nbsp; &lt;on_crash&gt;restart&lt;/on_crash&gt;</font></div><div><font size="2"   >&nbsp; &lt;devices&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;disk type='file' device='disk'&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;driver name='qemu' type='raw' cache='writethrough'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;source file='/data03/kvmdisk/disk01.img'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;target dev='vda' bus='virtio'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;alias name='virtio-disk0'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;/disk&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;disk type='file' device='disk'&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;driver name='qemu' type='qcow2' cache='writethrough'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;source file='/data03/kvmdisk/disk02.img'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;target dev='vdb' bus='virtio'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;alias name='virtio-disk1'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x06' function='0x0'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;/disk&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;controller type='usb' index='0'&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;alias name='usb0'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x2'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;/controller&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;interface type='bridge'&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;mac address='52:54:00:76:ac:2b'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;source bridge='virbr0'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;target dev='vnet0'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;model type='virtio'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;alias name='net0'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;/interface&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;serial type='pty'&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;source path='/dev/pts/3'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;target port='0'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;alias name='serial0'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;/serial&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;console type='pty' tty='/dev/pts/3'&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;source path='/dev/pts/3'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;target type='serial' port='0'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;alias name='serial0'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;/console&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;memballoon model='virtio'&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;alias name='balloon0'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;/memballoon&gt;</font></div><div><font size="2"   >&nbsp; &lt;/devices&gt;</font></div><div><font size="2"   >&lt;/domain&gt;</font></div><p></p></pre></div><div>重启虚拟机 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >virsh # shutdown centos6_6_x64</font></div><div><font size="2"   >Domain centos6_6_x64 is being shutdown</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >virsh # start centos6_6_x64</font></div><div><font size="2"   >Domain centos6_6_x64 started</font></div></div><p></p></pre></div></div><div><br></div><div>连接到console进行验证是否已经添加硬盘 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >virsh # console centos6_6_x64</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   ><br></font></span></div><div><div><font size="2"   >CentOS release 6.6 (Final)</font></div><div><font size="2"   >Kernel 2.6.32-504.el6.x86_64 on an x86_64</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal.sky-mobi.com login: root</font></div><div><font size="2"   >Password:&nbsp;</font></div><div><font size="2"   >Last login: Thu Apr &nbsp;2 02:01:13 on ttyS0</font></div><div><font size="2"   >[root@digoal ~]# fdisk -l</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Disk /dev/vda: 34.4 GB, 34370224128 bytes</font></div><div><font size="2"   >255 heads, 63 sectors/track, 4178 cylinders</font></div><div><font size="2"   >Units = cylinders of 16065 * 512 = 8225280 bytes</font></div><div><font size="2"   >Sector size (logical/physical): 512 bytes / 512 bytes</font></div><div><font size="2"   >I/O size (minimum/optimal): 512 bytes / 512 bytes</font></div><div><font size="2"   >Disk identifier: 0x0001bf14</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;Device Boot &nbsp; &nbsp; &nbsp;Start &nbsp; &nbsp; &nbsp; &nbsp; End &nbsp; &nbsp; &nbsp;Blocks &nbsp; Id &nbsp;System</font></div><div><font size="2"   >/dev/vda1 &nbsp; * &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp; &nbsp;3698 &nbsp; &nbsp;29696000 &nbsp; 83 &nbsp;Linux</font></div><div><font size="2"   >/dev/vda2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3698 &nbsp; &nbsp; &nbsp; &nbsp;3959 &nbsp; &nbsp; 2097152 &nbsp; 82 &nbsp;Linux swap / Solaris</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Disk /dev/vdb: 10.7 GB, 10747904000 bytes</font></div><div><font size="2"   >16 heads, 63 sectors/track, 20825 cylinders</font></div><div><font size="2"   >Units = cylinders of 1008 * 512 = 516096 bytes</font></div><div><font size="2"   >Sector size (logical/physical): 512 bytes / 512 bytes</font></div><div><font size="2"   >I/O size (minimum/optimal): 512 bytes / 512 bytes</font></div><div><font size="2"   >Disk identifier: 0x00000000</font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div><div>2. # 修改CPU</div><div>直接修改xml并重启,&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &lt;vcpu placement='static'&gt;4&lt;/vcpu&gt;</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >略.</span></div><div><br></div><div>3. # 添加网卡</div><div><div style="line-height: 28px;"   >直接修改xml并重启, 注意mac地址, slot不要冲突.</div><div style="line-height: 28px;"   >略 :&nbsp;</div></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;interface type='bridge'&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;mac address='52:54:00:76:ac:2c'/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;source bridge='virbr0'/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;model type='virtio'/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;/interface&gt;</font></div><p></p></pre></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   >检验 :&nbsp;</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@digoal ~]# ethtool eth0</font></div><div style="line-height: 28px;"   ><font size="2"   >Settings for eth0:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Link detected: yes</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@digoal ~]# ethtool eth1</font></div><div style="line-height: 28px;"   ><font size="2"   >Settings for eth1:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Link detected: no</font></div><p></p></pre></div></div></div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="add cpu,disk,net card to kvm guest - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>