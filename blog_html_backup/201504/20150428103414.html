<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Fast move table between databases by move datafiles ? Be careful TOAST pointer</h2>
	<h5 id="">2015-04-28 10:34:14&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020153289316178/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">最近有一个数据库合并的需求，因为涉及的数据量较大，正在寻找比较快速的合并方法。<div>从rewrite table受到启发，rewrite table最后一步是交换元表的filenode完成重写的，那么合并数据库的话是否有可能只移动数据文件来完成数据的迁移呢？</div><div>下面先做一个测试，</div><div>创建两个数据库</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.4.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# create database digoal;</font></div><div><font size="2"   >CREATE DATABASE</font></div><div><font size="2"   >postgres=# create database test;</font></div><div><font size="2"   >CREATE DATABASE</font></div><p></p></pre></div><div>创建测试表，并启用TOAST存储，因为问题就出在TOAST。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \c digoal</font></div><div><font size="2"   >You are now connected to database "digoal" as user "postgres".</font></div><div><font size="2"   >digoal=# create table tbl(id int, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into tbl select generate_series(1,1000),repeat(md5(random()::text), 100000),clock_timestamp();</font></div><div><font size="2"   >INSERT 0 1000</font></div><div><font size="2"   >digoal=# alter table tbl add constraint pk primary key(id);</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >digoal=# analyze tbl;</font></div><p></p></pre></div><div>记录下表的filepath.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >digoal=# select relname,oid,reltoastrelid,pg_relation_filepath(oid),pg_relation_filepath(reltoastrelid) from pg_class where relname='tbl' or oid in (select indexrelid from pg_index where indrelid='tbl'::regclass) or oid in (select indexrelid from pg_index where indrelid=(select reltoastrelid from pg_class where relname='tbl'));<br>       relname        |  oid  | reltoastrelid | pg_relation_filepath | pg_relation_filepath <br>----------------------+-------+---------------+----------------------+----------------------<br> tbl                  | 50156 |         50159 | base/50154/51175     | base/50154/51176<br> pk                   | 51165 |             0 | base/50154/51177     | <br> pg_toast_50156_index | 50161 |             0 | base/50154/51178     | </span></font></div><p></p></pre></div><div>假设我们需要将表迁移到test库，先在test库创建好对应的表。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \c test</font></div><div><font size="2"   >test=# create table tbl(id int primary key,info text,crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div>记录下filepath</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >test=# select relname,oid,reltoastrelid,pg_relation_filepath(oid),pg_relation_filepath(reltoastrelid) from pg_class where relname='tbl' or oid in (select indexrelid from pg_index where indrelid='tbl'::regclass) or oid in (select indexrelid from pg_index where indrelid=(select reltoastrelid from pg_class where relname='tbl'));<br>       relname        |  oid  | reltoastrelid | pg_relation_filepath | pg_relation_filepath <br>----------------------+-------+---------------+----------------------+----------------------<br> pg_toast_51167_index | 51172 |             0 | base/50155/51172     | <br> tbl_pkey             | 51173 |             0 | base/50155/51173     | <br> tbl                  | 51167 |         51170 | base/50155/51167     | base/50155/51170<br>(3 rows)</span></font></div><div><font size="2"   >test=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >postgres@db-172-16-3-150-&gt; pg_ctl stop -m fast</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div><p></p></pre></div><div>将digoal库的tbl表对应的数据文件拷贝到test库，并更名为test库对应的filepath.</div><div>注意文件需要一一对应。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >postgres@db-172-16-3-150-&gt; cd $PGDATA<br>postgres@db-172-16-3-150-&gt; ll base/50154/51175*<br>-rw------- 1 postgres postgres 64K Apr 28 07:49 base/50154/51175<br>-rw------- 1 postgres postgres 96K Apr 28 07:49 base/50154/51175_fsm<br>postgres@db-172-16-3-150-&gt; ll base/50154/51176*<br>-rw------- 1 postgres postgres 40M Apr 28 07:49 base/50154/51176<br>-rw------- 1 postgres postgres 96K Apr 28 07:49 base/50154/51176_fsm<br>postgres@db-172-16-3-150-&gt; ll base/50154/51177*<br>-rw------- 1 postgres postgres 64K Apr 28 07:49 base/50154/51177<br>postgres@db-172-16-3-150-&gt; ll base/50154/51178*<br>-rw------- 1 postgres postgres 192K Apr 28 07:49 base/50154/51178<br><br>postgres@db-172-16-3-150-&gt; ll base/50155/51167*<br>-rw------- 1 postgres postgres 0 Apr 28 07:40 base/50155/51167<br>postgres@db-172-16-3-150-&gt; ll base/50155/51170*<br>-rw------- 1 postgres postgres 0 Apr 28 07:40 base/50155/51170<br>postgres@db-172-16-3-150-&gt; ll base/50155/51173*<br>-rw------- 1 postgres postgres 32K Apr 28 07:40 base/50155/51173<br>postgres@db-172-16-3-150-&gt; ll base/50155/51172*<br>-rw------- 1 postgres postgres 32K Apr 28 09:46 base/50155/51172<br><br>postgres@db-172-16-3-150-&gt; rm -f base/50155/51167<br>postgres@db-172-16-3-150-&gt; rm -f base/50155/51170<br>postgres@db-172-16-3-150-&gt; rm -f base/50155/51173<br>postgres@db-172-16-3-150-&gt; rm -f base/50155/51172<br><br>postgres@db-172-16-3-150-&gt; cp base/50154/51175* base/50155/<br>postgres@db-172-16-3-150-&gt; cp base/50154/51176* base/50155/<br>postgres@db-172-16-3-150-&gt; cp base/50154/51177* base/50155/<br>postgres@db-172-16-3-150-&gt; cp base/50154/51178* base/50155/<br><br>postgres@db-172-16-3-150-&gt; mv base/50155/51175 base/50155/51167<br>postgres@db-172-16-3-150-&gt; mv base/50155/51175_fsm base/50155/51167_fsm<br>postgres@db-172-16-3-150-&gt; mv base/50155/51176 base/50155/51170<br>postgres@db-172-16-3-150-&gt; mv base/50155/51176_fsm base/50155/51170_fsm<br>postgres@db-172-16-3-150-&gt; mv base/50155/51177 base/50155/51173<br>postgres@db-172-16-3-150-&gt; mv base/50155/51178 base/50155/51172</span></font></div><p></p></pre></div><div>启动数据库，发现查看数据正常。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg_ctl start</font></div><div><font size="2"   >test=# select count(*) from tbl;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; 1000</font></div><div><font size="2"   >(1 row)</font></div><div><div><font size="2"   >test=# select id,crt_time from tbl limit 1;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | 2015-04-28 07:49:00.319558</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><div><span style="line-height: 28px;"   >但是不要高兴太早，存储到TOAST的字段无法查出。</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >test=# select info from tbl limit 1;</font></div><div><font size="2"   >ERROR: &nbsp;could not open relation with OID 50159</font></div></div><div><font size="2"   >test=# \set VERBOSITY verbose</font></div><div><font size="2"   >test=# select sum(hashtext(t.*::text)) from tbl t;</font></div><div><font size="2"   >ERROR: &nbsp;XX000: could not open relation with OID 50159</font></div><div><font size="2"   >LOCATION: &nbsp;relation_open, heapam.c:1038</font></div><p></p></pre></div></div><div>报错的这个OID怎么来的呢？实际上这个OID是存储在表里的TOAST pointer里面的数据，对应的是TOAST表的OID。</div><div>后面我会给出TOAST pointer的数据结构。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >test=# select oid,relname from pg_class where oid=(select reltoastrelid from pg_class where relname='tbl');</font></div><div><font size="2"   >&nbsp; oid &nbsp;| &nbsp; &nbsp;relname &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------+----------------</font></div><div><font size="2"   >&nbsp;51170 | pg_toast_51167</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>这个OID在digoal库是能查到信息的：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># \c digoal</font></div><div><font size="2"   >digoal=# select * from pg_class where reltoastrelid =50159;</font></div><div><font size="2"   >&nbsp;relname | relnamespace | reltype | reloftype | relowner | relam | relfilenode | reltablespace | relpages | reltuples | relallvisibl</font></div><div><font size="2"   >e | reltoastrelid | relhasindex | relisshared | relpersistence | relkind | relnatts | relchecks | relhasoids | relhaspkey | relhasru</font></div><div><font size="2"   >les | relhastriggers | relhassubclass | relispopulated | relreplident | relfrozenxid | relminmxid | relacl | reloptions&nbsp;</font></div><div><font size="2"   >---------+--------------+---------+-----------+----------+-------+-------------+---------------+----------+-----------+-------------</font></div><div><font size="2"   >--+---------------+-------------+-------------+----------------+---------+----------+-----------+------------+------------+---------</font></div><div><font size="2"   >----+----------------+----------------+----------------+--------------+--------------+------------+--------+------------</font></div><div><font size="2"   >&nbsp;tbl &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; 2200 | &nbsp; 50158 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; 10 | &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; 51175 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;1000 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >0 | &nbsp; &nbsp; &nbsp; &nbsp; 50159 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | p &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| r &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;3 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;6095721 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>那么我将test库的pg_class元表里的tbl表对应的TOAST表的OID改成<span style="line-height: 28px;"   >50159</span><span style="line-height: 28px;"   >&nbsp;，不就好了吗？</span></div><div>修改是遇到几个麻烦。通过修改代码可以不报这几个错误，但是最后是无法修改成功的原因见后面。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >test=# \set VERBOSITY verbose</font></div><div><font size="2"   >test=# update pg_class set oid=50159 where oid=(select reltoastrelid from pg_class where relname='tbl');</font></div><div><font size="2"   >ERROR: &nbsp;0A000: cannot assign to system column "oid"</font></div><div><font size="2"   >LINE 1: update pg_class set oid=50159 where oid=(select reltoastreli...</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   >LOCATION: &nbsp;transformAssignedExpr, parse_target.c:404</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># vi src/backend/parser/parse_target.c</font></div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (attrno &lt;= 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_FEATURE_NOT_SUPPORTED),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("cannot assign to system column \"%s\"",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; colname),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parser_errposition(pstate, location)));</font></div><div><font size="2"   >*/</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># make &amp;&amp; make install</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg_ctl restart -m fast</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >test=# \set VERBOSITY verbose</font></div><div><font size="2"   >test=# update pg_class set oid=50159 where oid=(select reltoastrelid from pg_class where relname='tbl');</font></div><div><font size="2"   >ERROR: &nbsp;XX000: bogus resno -2 in targetlist</font></div><div><font size="2"   >LOCATION: &nbsp;rewriteTargetListIU, rewriteHandler.c:719</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># vi src/backend/rewrite/rewriteHandler.c</font></div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (attrno &lt; 1 || attrno &gt; numattrs)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, "bogus resno %d in targetlist", attrno);</font></div><div><font size="2"   >*/</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># make &amp;&amp; make install</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg_ctl restart -m fast</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# \c test</font></div><div><font size="2"   >You are now connected to database "test" as user "postgres".</font></div><div><font size="2"   >test=# \set VERBOSITY verbose</font></div><div><font size="2"   >test=# update pg_class set oid=50159 where oid=(select reltoastrelid from pg_class where relname='tbl');</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >test=# select * from pg_class where oid=50159;</font></div><div><font size="2"   >&nbsp;relname | relnamespace | reltype | reloftype | relowner | relam | relfilenode | reltablespace | relpages | reltuples | relallvisibl</font></div><div><font size="2"   >e | reltoastrelid | relhasindex | relisshared | relpersistence | relkind | relnatts | relchecks | relhasoids | relhaspkey | relhasru</font></div><div><font size="2"   >les | relhastriggers | relhassubclass | relispopulated | relreplident | relfrozenxid | relminmxid | relacl | reloptions&nbsp;</font></div><div><font size="2"   >---------+--------------+---------+-----------+----------+-------+-------------+---------------+----------+-----------+-------------</font></div><div><font size="2"   >--+---------------+-------------+-------------+----------------+---------+----------+-----------+------------+------------+---------</font></div><div><font size="2"   >----+----------------+----------------+----------------+--------------+--------------+------------+--------+------------</font></div><div><font size="2"   >(0 rows)</font></div><div><div style="line-height: 28px;"   ><font size="2"   >test=# select sum(hashtext(t.*::text)) from tbl t;</font></div><div style="line-height: 28px;"   ><font size="2"   >ERROR: &nbsp;XX000: could not open relation with OID 50159</font></div><div style="line-height: 28px;"   ><font size="2"   >LOCATION: &nbsp;relation_open, heapam.c:1038</font></div></div><p></p></pre></div><div>为什么无法修改成功呢？原因还是出在rewriteHandler.c，它并没有对attrno&lt;1的字段进行处理。如下：</div><div><span style="line-height: 28px;"   >src/backend/rewrite/rewriteHandler.c</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >rewriteTargetListIU(Query *parsetree, Relation target_relation,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List **attrno_list)</font></div><div><font size="2"   >{</font></div></div><div><font size="2"   >......</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; for (attrno = 1; attrno &lt;= numattrs; attrno++)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TargetEntry *new_tle = new_tles[attrno - 1];</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; att_tup = target_relation-&gt;rd_att-&gt;attrs[attrno - 1];</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* We can (and must) ignore deleted attributes */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (att_tup-&gt;attisdropped)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; continue;</font></div></div><div><font size="2"   >......</font></div><p></p></pre></div><div>oid在pg_class表的attrnum=-2</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >test=# select attnum,attname from pg_attribute where attrelid ='pg_class'::regclass;</font></div><div><font size="2"   >&nbsp;attnum | &nbsp; &nbsp;attname &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------+----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 1 | relname</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 2 | relnamespace</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 3 | reltype</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 4 | reloftype</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 5 | relowner</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 6 | relam</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 7 | relfilenode</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 8 | reltablespace</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 9 | relpages</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;10 | reltuples</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;11 | relallvisible</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;12 | reltoastrelid</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;13 | relhasindex</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;14 | relisshared</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;15 | relpersistence</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;16 | relkind</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;17 | relnatts</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;18 | relchecks</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;19 | relhasoids</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;20 | relhaspkey</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;21 | relhasrules</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;22 | relhastriggers</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;23 | relhassubclass</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;24 | relispopulated</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;25 | relreplident</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;26 | relfrozenxid</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;27 | relminmxid</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;28 | relacl</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;29 | reloptions</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;-1 | ctid</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;-3 | xmin</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;-4 | cmin</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;-5 | xmax</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;-6 | cmax</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;-7 | tableoid</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;-2 | oid</font></div><p></p></pre></div><div><br></div><div>TOAST pointer数据结构，包含<span style="line-height: 28px;"   >&nbsp; &nbsp; &nbsp; &nbsp; Oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; va_toastrelid; &nbsp;/* RelID of TOAST table containing it */</span></div><div><span style="line-height: 28px;"   >所以当数据表中的某些字段存储到TOAST后，实际上在HEAP Tuple中存储的是TOAST pointer，所以要完成迁移，我们必须把目标库中的TOAST表的OID修改为TOAST pointer对应的OID。</span></div><div>src/include/postgres.h</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* struct varatt_external is a "TOAST pointer", that is, the information needed</font></div><div><font size="2"   >&nbsp;* to fetch a Datum stored in an out-of-line on-disk Datum. The data is</font></div><div><font size="2"   >&nbsp;* compressed if and only if va_extsize &lt; va_rawsize - VARHDRSZ. &nbsp;This struct</font></div><div><font size="2"   >&nbsp;* must not contain any padding, because we sometimes compare pointers using</font></div><div><font size="2"   >&nbsp;* memcmp.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Note that this information is stored unaligned within actual tuples, so</font></div><div><font size="2"   >&nbsp;* you need to memcpy from the tuple into a local struct variable before</font></div><div><font size="2"   >&nbsp;* you can look at these fields! &nbsp;(The reason we use memcmp is to avoid</font></div><div><font size="2"   >&nbsp;* having to do that just to detect equality of two TOAST pointers...)</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >typedef struct varatt_external</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; va_rawsize; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Original data size (includes header) */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; va_extsize; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* External saved size (doesn't) */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; va_valueid; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Unique ID of value within TOAST table */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; va_toastrelid; &nbsp;/* RelID of TOAST table containing it */</font></div><div><font size="2"   >} &nbsp; &nbsp; &nbsp; varatt_external;</font></div><p></p></pre></div><div>最后要说的是，关键在于TOAST表的OID，如果能修改，一切就搞定了。</div><div>虽然不容易修改pg_class.oid，但是我们可以删除pg_class的记录并重新导入，只是这里还牵涉到其他CATALOG，所以都需要修改。</div><div>涉及的元表有3张，</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >test=# \d pg_index</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Table "pg_catalog.pg_index"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;Column &nbsp; &nbsp; | &nbsp; &nbsp; Type &nbsp; &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >----------------+--------------+-----------</font></div><div><font size="2"   >&nbsp;indexrelid &nbsp; &nbsp; | oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;indrelid &nbsp; &nbsp; &nbsp; | oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;indnatts &nbsp; &nbsp; &nbsp; | smallint &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;indisunique &nbsp; &nbsp;| boolean &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;indisprimary &nbsp; | boolean &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;indisexclusion | boolean &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;indimmediate &nbsp; | boolean &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;indisclustered | boolean &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;indisvalid &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;indcheckxmin &nbsp; | boolean &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;indisready &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;indislive &nbsp; &nbsp; &nbsp;| boolean &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;indisreplident | boolean &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;indkey &nbsp; &nbsp; &nbsp; &nbsp; | int2vector &nbsp; | not null</font></div><div><font size="2"   >&nbsp;indcollation &nbsp; | oidvector &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;indclass &nbsp; &nbsp; &nbsp; | oidvector &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;indoption &nbsp; &nbsp; &nbsp;| int2vector &nbsp; | not null</font></div><div><font size="2"   >&nbsp;indexprs &nbsp; &nbsp; &nbsp; | pg_node_tree |&nbsp;</font></div><div><font size="2"   >&nbsp;indpred &nbsp; &nbsp; &nbsp; &nbsp;| pg_node_tree |&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_index_indexrelid_index" UNIQUE, btree (indexrelid)</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_index_indrelid_index" btree (indrelid)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >test=# \d pg_attribute</font></div><div><font size="2"   >&nbsp; &nbsp; Table "pg_catalog.pg_attribute"</font></div><div><font size="2"   >&nbsp; &nbsp; Column &nbsp; &nbsp; | &nbsp; Type &nbsp; &nbsp;| Modifiers&nbsp;</font></div><div><font size="2"   >---------------+-----------+-----------</font></div><div><font size="2"   >&nbsp;attrelid &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;attname &nbsp; &nbsp; &nbsp; | name &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;atttypid &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;attstattarget | integer &nbsp; | not null</font></div><div><font size="2"   >&nbsp;attlen &nbsp; &nbsp; &nbsp; &nbsp;| smallint &nbsp;| not null</font></div><div><font size="2"   >&nbsp;attnum &nbsp; &nbsp; &nbsp; &nbsp;| smallint &nbsp;| not null</font></div><div><font size="2"   >&nbsp;attndims &nbsp; &nbsp; &nbsp;| integer &nbsp; | not null</font></div><div><font size="2"   >&nbsp;attcacheoff &nbsp; | integer &nbsp; | not null</font></div><div><font size="2"   >&nbsp;atttypmod &nbsp; &nbsp; | integer &nbsp; | not null</font></div><div><font size="2"   >&nbsp;attbyval &nbsp; &nbsp; &nbsp;| boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;attstorage &nbsp; &nbsp;| "char" &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;attalign &nbsp; &nbsp; &nbsp;| "char" &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;attnotnull &nbsp; &nbsp;| boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;atthasdef &nbsp; &nbsp; | boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;attisdropped &nbsp;| boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;attislocal &nbsp; &nbsp;| boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;attinhcount &nbsp; | integer &nbsp; | not null</font></div><div><font size="2"   >&nbsp;attcollation &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;attacl &nbsp; &nbsp; &nbsp; &nbsp;| aclitem[] |&nbsp;</font></div><div><font size="2"   >&nbsp;attoptions &nbsp; &nbsp;| text[] &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;attfdwoptions | text[] &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_attribute_relid_attnam_index" UNIQUE, btree (attrelid, attname)</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_attribute_relid_attnum_index" UNIQUE, btree (attrelid, attnum)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >test=# \d pg_class</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; Table "pg_catalog.pg_class"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;Column &nbsp; &nbsp; | &nbsp; Type &nbsp; &nbsp;| Modifiers&nbsp;</font></div><div><font size="2"   >----------------+-----------+-----------</font></div><div><font size="2"   >&nbsp;relname &nbsp; &nbsp; &nbsp; &nbsp;| name &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;relnamespace &nbsp; | oid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;reltype &nbsp; &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;reloftype &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relowner &nbsp; &nbsp; &nbsp; | oid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relam &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relfilenode &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;reltablespace &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relpages &nbsp; &nbsp; &nbsp; | integer &nbsp; | not null</font></div><div><font size="2"   >&nbsp;reltuples &nbsp; &nbsp; &nbsp;| real &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;relallvisible &nbsp;| integer &nbsp; | not null</font></div><div><font size="2"   >&nbsp;reltoastrelid &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relhasindex &nbsp; &nbsp;| boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relisshared &nbsp; &nbsp;| boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relpersistence | "char" &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;relkind &nbsp; &nbsp; &nbsp; &nbsp;| "char" &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;relnatts &nbsp; &nbsp; &nbsp; | smallint &nbsp;| not null</font></div><div><font size="2"   >&nbsp;relchecks &nbsp; &nbsp; &nbsp;| smallint &nbsp;| not null</font></div><div><font size="2"   >&nbsp;relhasoids &nbsp; &nbsp; | boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relhaspkey &nbsp; &nbsp; | boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relhasrules &nbsp; &nbsp;| boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relhastriggers | boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relhassubclass | boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relispopulated | boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relreplident &nbsp; | "char" &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;relfrozenxid &nbsp; | xid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relminmxid &nbsp; &nbsp; | xid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relacl &nbsp; &nbsp; &nbsp; &nbsp; | aclitem[] |&nbsp;</font></div><div><font size="2"   >&nbsp;reloptions &nbsp; &nbsp; | text[] &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_class_oid_index" UNIQUE, btree (oid)</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_class_relname_nsp_index" UNIQUE, btree (relname, relnamespace)</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_class_tblspc_relfilenode_index" btree (reltablespace, relfilenode)</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >下面开始操作：</span></div><div><span style="line-height: 28px;"   >记录新库TOAST表对应的OID，也就是需要被替换掉的OID。</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select reltoastrelid from pg_class where relname='tbl';<br> reltoastrelid <br>---------------<br>         50159</font></div><div><span style="line-height: 28px;"   ><font size="2"   >test=# select reltoastrelid from pg_class where relname='tbl';</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >51170</font></span></div><p></p></pre></div><div><span style="line-height: 28px;"   >这个OID需要变更为50159，即HEAP tuple的TOAST pointer中记录的OID。</span></div><div><span style="line-height: 28px;"   >将需要修改的记录（即toast对应的那条记录）COPY到STDOUT</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >test=# copy (select 50159,* from pg_class where oid=(select reltoastrelid from pg_class where relname='tbl')) to stdout csv;</font></div><div><font size="2"   >50159,pg_toast_51167,99,51171,0,10,0,51170,0,0,0,0,0,t,f,p,t,3,0,f,t,f,f,f,t,n,6095720,1,,</font></div><p></p></pre></div><div>删除toast对应的记录</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >test=# delete from pg_class where oid=51170;</font></div><div><font size="2"   >DELETE 1</font></div><p></p></pre></div><div>使用COPY重新插入，并使用新的OID</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >test=# copy pg_class from stdin with(oids, format csv);</font></div><div><font size="2"   >Enter data to be copied followed by a newline.</font></div><div><font size="2"   >End with a backslash and a period on a line by itself.</font></div><div><font size="2"   >&gt;&gt; 50159,pg_toast_51167,99,51171,0,10,0,51170,0,0,0,0,0,t,f,p,t,3,0,f,t,f,f,f,t,n,6095720,1,,</font></div><div><font size="2"   >&gt;&gt; \.</font></div><div><font size="2"   >COPY 1</font></div><div><font size="2"   >test=# select oid from pg_class where oid=50159;</font></div><div><font size="2"   >&nbsp; oid &nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;50159</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div>将tbl表对应的<span style="line-height: 28px;"   >reltoastrelid修改为新的OID。</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >test=# update pg_class set reltoastrelid=50159 where &nbsp;oid='tbl'::regclass;</font></div><div><font size="2"   >UPDATE 1</font></div><p></p></pre></div><div>将字段信息，索引对应TOAST的也修改掉。</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >test=# update pg_attribute set attrelid=50159 where attrelid=51170;</font></div><div><font size="2"   >UPDATE 9</font></div></div><div><div><font size="2"   >test=# update pg_index set indrelid = 50159 where indrelid = 51170;</font></div><div><font size="2"   >UPDATE 1</font></div></div><p></p></pre></div><div>现在重启数据库，重新加载relcache。查询tbl的TOAST数据正常。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >test=# select sum(hashtext(tbl.*::text)) from tbl;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;sum &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp;-21870423441</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>注意事项，</div><div>1. 如果你的环境中有流复制的环境，那么所有节点都必须做同样的处理，所以也是非常繁琐的。</div><div>2. 建议数据文件在同一个表空间内移动，这样的话不需要拷贝，mv即可。但是操作完后源库就不能操作对应的表了，所以这种方法是迁移而不是复制表。</div><div>3. 这种方法同样适用跨集群的数据迁移，前提是PostgreSQL集群的软件编译参数一致，例如数据块的大小必须一致。(见pg_config的输出)。其次迁移的目标库上TOAST对象的OID不能有冲突否则也无法完成，最后是目标库的XID和CLOG必须在源库产生被迁移数据的XID之后（即未来），否则数据不可读，除非使用脏读获取数据。那就有点像pg_upgrade干的事情了。</div><div><br></div><div><wbr><div>[参考]</div><div>1.&nbsp;src/include/postgres.h</div><div>2.&nbsp;src/backend/rewrite/rewriteHandler.c</div><div>3.&nbsp;src/backend/parser/parse_target.c</div></div></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402015345228317/"   >http://blog.163.com/digoal@126/blog/static/1638770402015345228317/</a></div><div>5.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201183043153622/"   >http://blog.163.com/digoal@126/blog/static/163877040201183043153622/</a></div><div><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402015345228317/"   ><font color="#000000"   ><br></font></a><span style="line-height: 28px;"   >
</span><a style="line-height: 28px;" rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="Fast move table between databases by move datafiles ? Be careful TOAST pointer - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div></div>
	</div>
</div>
</body>
</html>