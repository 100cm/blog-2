<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">geoip - Geolocation using GeoIP</h2>
	<h5 id="">2015-04-27 10:56:22&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402015327103744232/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>geoip是使用IP地址查询地理位置的一个插件，提供了以下几个查询函数。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >geoip_country_code(inet) - returns country code (2 chars)</font></div><div><font size="2"   >geoip_country(inet) - returns all country info (code, name, ...)</font></div><div><font size="2"   >geoip_city_location(inet) - returns just location ID (INT)</font></div><div><font size="2"   >geoip_city(inet) - returns all the city info (GPS, ZIP code, ...)</font></div><div><font size="2"   >geoip_asn(inet) - retusn ASN name and IP range</font></div><p></p></pre></div><div>这个插件需要用到IP地址库，地址库可以到&nbsp;www.maxmind.com下载。</div><div>安装</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >wget&nbsp;http://api.pgxn.org/dist/geoip/0.2.3/geoip-0.2.3.zip</font></div><div><font size="2"   >unzip&nbsp;<span style="line-height: 28px;"   >geoip-0.2.3.zip</span></font></div><div><font size="2"   >export PATH=/opt/pgsql/bin:$PATH</font></div><div><font size="2"   >cd&nbsp;<span style="line-height: 28px;"   >geoip-0.2.3</span></font></div><div><font size="2"   >gmake clean; gmake; gmake install</font></div><div><font size="2"   >psql</font></div><div><font size="2"   >=# create extension geoip;</font></div><p></p></pre></div><div>导入地址库：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >wget http://download.maxmind.com/download/geoip/database/asnum/GeoIPASNum2.zip</font></div><div><font size="2"   >wget http://geolite.maxmind.com/download/geoip/database/GeoIPCountryCSV.zip</font></div><div><font size="2"   >wget http://geolite.maxmind.com/download/geoip/database/GeoLiteCity_CSV/GeoLiteCity-latest.zip</font></div><div><font size="2"   >unzip ...</font></div><div><div><font size="2"   >$ sed 's/^\("[^"]*","[^"]*",\)"[^"]*","[^"]*",\("[^"]*","[^"]*"\)/\1\2/' <span style="line-height: 28px;"   >GeoIPCountryWhois.csv &gt; countries.csv</span></font></div></div><div><font size="2"   ><span style="line-height: 28px;"   >$ </span>tail -$((`wc -l GeoLiteCity-Location.csv | awk '{print $1}'`-2))&nbsp;<span style="line-height: 28px;"   >GeoLiteCity-Location.csv &gt; locations.csv</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   >$ cd </span>GeoLiteCity_20150407</font></div><div><font size="2"   >$ tail -$((`wc -l GeoLiteCity-Blocks.csv | awk '{print $1}'`-2)) GeoLiteCity-Blocks.csv &gt; blocks.csv</font></div><div><font size="2"   >$ tail -$((`wc -l GeoLiteCity-Location.csv | awk '{print $1}'`-2))&nbsp;<span style="line-height: 28px;"   >GeoLiteCity-Location.csv &gt; locations.csv</span></font></div><div><div><font size="2"   >postgres@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.4.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# COPY geoip_country FROM '/home/postgres/countries.csv' WITH csv DELIMITER ',' NULL '' QUOTE '"' ENCODING 'ISO-8859-2';</font></div><div><font size="2"   >COPY 104679</font></div><div><font size="2"   >postgres=# CREATE TEMPORARY TABLE geoip_city_block_tmp (</font></div><div><font size="2"   >postgres(# &nbsp; &nbsp; begin_ip &nbsp; &nbsp;BIGINT &nbsp; &nbsp; &nbsp;NOT NULL,</font></div><div><font size="2"   >postgres(# &nbsp; &nbsp; end_ip &nbsp; &nbsp; &nbsp;BIGINT &nbsp; &nbsp; &nbsp;NOT NULL,</font></div><div><font size="2"   >postgres(# &nbsp; &nbsp; loc_id &nbsp; &nbsp; &nbsp;INTEGER &nbsp; &nbsp; NOT NULL</font></div><div><font size="2"   >postgres(# );</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# CREATE TEMPORARY TABLE geoip_asn_tmp (</font></div><div><font size="2"   >postgres(# &nbsp; &nbsp; begin_ip &nbsp; &nbsp;BIGINT &nbsp; &nbsp; &nbsp;NOT NULL,</font></div><div><font size="2"   >postgres(# &nbsp; &nbsp; end_ip &nbsp; &nbsp; &nbsp;BIGINT &nbsp; &nbsp; &nbsp;NOT NULL,</font></div><div><font size="2"   >postgres(# &nbsp; &nbsp; name &nbsp; &nbsp; &nbsp; &nbsp;TEXT &nbsp; &nbsp; &nbsp; &nbsp;NOT NULL</font></div><div><font size="2"   >postgres(# );</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# COPY geoip_city_block_tmp FROM '/home/postgres/GeoLiteCity_20150407/blocks.csv' WITH csv DELIMITER ',' NULL '' QUOTE '"' ENCODING 'ISO-8859-2';</font></div><div><font size="2"   >COPY 2018008</font></div><div><font size="2"   >postgres=# COPY geoip_city_location FROM '/home/postgres/GeoLiteCity_20150407/locations.csv' WITH csv DELIMITER ',' NULL '' QUOTE '"' ENCODING 'ISO-8859-2';</font></div><div><font size="2"   >COPY 658951</font></div><div><font size="2"   >postgres=# COPY geoip_asn_tmp FROM '/home/postgres/GeoIPASNum2.csv' WITH csv DELIMITER ',' NULL '' QUOTE '"' ENCODING 'ISO-8859-2';</font></div><div><font size="2"   >COPY 224846</font></div><div><font size="2"   >postgres=# INSERT INTO geoip_city_block</font></div><div><font size="2"   >postgres-# &nbsp; &nbsp; &nbsp;SELECT geoip_bigint_to_inet(begin_ip),</font></div><div><font size="2"   >postgres-# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; geoip_bigint_to_inet(end_ip), loc_id</font></div><div><font size="2"   >postgres-# &nbsp; &nbsp; &nbsp; &nbsp;FROM geoip_city_block_tmp;</font></div><div><font size="2"   >INSERT 0 2018008</font></div><div><font size="2"   >postgres=# INSERT INTO geoip_asn</font></div><div><font size="2"   >postgres-# &nbsp; &nbsp; &nbsp;SELECT geoip_bigint_to_inet(begin_ip),</font></div><div><font size="2"   >postgres-# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; geoip_bigint_to_inet(end_ip), name</font></div><div><font size="2"   >postgres-# &nbsp; &nbsp; &nbsp; &nbsp;FROM geoip_asn_tmp;</font></div><div><font size="2"   >INSERT 0 224846</font></div></div><p></p></pre></div><div>测试：</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# SELECT * FROM geoip_city('78.45.133.255'::inet);</font></div><div><font size="2"   >&nbsp;loc_id | country | region | city &nbsp;| postal_code | latitude | longitude | metro_code | area_code&nbsp;</font></div><div><font size="2"   >--------+---------+--------+-------+-------------+----------+-----------+------------+-----------</font></div><div><font size="2"   >&nbsp; 54219 | CZ &nbsp; &nbsp; &nbsp;| 78 &nbsp; &nbsp; | Ceska | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;49.2814 | &nbsp; 16.5648 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# SELECT * FROM geoip_city('202.101.172.35'::inet);</font></div><div><font size="2"   >&nbsp;loc_id | country | region | &nbsp; city &nbsp; | postal_code | latitude | longitude | metro_code | area_code&nbsp;</font></div><div><font size="2"   >--------+---------+--------+----------+-------------+----------+-----------+------------+-----------</font></div><div><font size="2"   >&nbsp; 68433 | CN &nbsp; &nbsp; &nbsp;| 02 &nbsp; &nbsp; | Hangzhou | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;30.2936 | &nbsp;120.1614 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >postgres=# SELECT * FROM geoip_asn('202.101.172.37'::inet);</font></div><div><font size="2"   >&nbsp; &nbsp;begin_ip &nbsp; | &nbsp; &nbsp; end_ip &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;name &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------+----------------+-----------------</font></div><div><font size="2"   >&nbsp;202.101.64.0 | 202.102.51.255 | AS4134 Chinanet</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>性能：</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select count(*) from (SELECT geoip_asn('202.101.172.37'::inet) from generate_series(1,1000000)) t;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1000000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 57561.637 ms</font></div><p></p></pre></div><div>单次查询约0.057毫秒。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select count(*) from (SELECT geoip_city('202.101.172.37'::inet) from generate_series(1,100000)) t;</font></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;100000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 10020.797 ms</font></div><p></p></pre></div></div><div>单次查询约0.1毫秒。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select count(*) from (SELECT geoip_country('202.101.172.37'::inet) from generate_series(1,100000)) t;</font></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;100000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 2977.582 ms</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >单次查询约0.03毫秒。</span></div><div><span style="line-height: 28px;"   >其他：</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select count(*) from (SELECT geoip_city_location('202.101.172.37'::inet) from generate_series(1,100000)) t;</font></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;100000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 8339.120 ms</font></div><div><font size="2"   >postgres=# select count(*) from (SELECT geoip_country_code('202.101.172.37'::inet) from generate_series(1,100000)) t;</font></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;100000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 2931.577 ms</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://pgxn.org/dist/geoip/0.2.3/"   >http://pgxn.org/dist/geoip/0.2.3/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://dev.maxmind.com/geoip/legacy/geolite/"   >http://dev.maxmind.com/geoip/legacy/geolite/</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="geoip - Geolocation using GeoIP - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>