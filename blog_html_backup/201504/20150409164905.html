<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.5 new feature - pg_rewind fast sync Split Brain Primary & Standby</h2>
	<h5 id="">2015-04-09 16:49:05&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020153933135677/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><span style="line-height: 28px;"   >PostgreSQL 9.5 将pg_rewind纳入源码, pg_rewind是一个非常好的工具.</span></div><div><span style="line-height: 28px;"   >当我们在使用PostgreSQL流复制实施主备复制时, 如果在某些情况下, 例如主机有问题时, 备机激活成为读写, 并对外提供服务.</span></div><div><span style="line-height: 28px;"   >但是如果主机那边还有读写的话, 主备就会出现脑裂的情况.</span></div><div>出现脑裂之后, 原来的主机要变成备机怎么办?</div><div>一般我们需要重建备机, 即把数据文件删掉, 重新同步.</div><div>另一种方法是用rsync , 同步修改的文件.</div><div>如果数据量很大, 以上两种方法都需要耗费大量的时间.</div><div>pg_rewind的原理,&nbsp;</div><div>1. 首选获得备机激活的时间线</div><div>2. 根据备机激活的时间线, 在老的主机上找到这个时间线之前的最后一个checkpoint</div><div>3. 在老的主机根据这个checkpoint位置, 找到自此以后老的主机产生的所有的XLOG.</div><div>4. 从这些XLOG中解析出变更的数据块.</div><div>5. 从新的主机将这些数据块抓取过来, 并覆盖掉老的主机上的这些数据块. (同时老库上面新增的块被被删掉.)</div><div>6. 从新主机拷贝所有除数据文件以外的所有文件(如clog, etc等)到老的主机.</div><div>7. 现在老的主机回到了时间线的位置,&nbsp;</div><div>pg_rewind退出后只能到达以上状态, 以下步骤需要手工执行.</div><div>8. 修改老主机的配置文件, 例如 postgresql.conf, recovery.conf, pg_hba.conf 以成为新主机的standby.</div><div>9. 特别需要注意配置 restore_command, 因为新主机在发生promote后产生的XLOG可能已经归档了.</div><div>10. 启动老主机, 开始恢复.</div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >接下来测试一下 :&nbsp;</span></div><div>测试环境 :&nbsp;</div><div>在同一台主机上测试, 主备配置不同的cluster_name.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cluster_name=db1</font></div><div><font size="2"   >cluster_name=db2</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >db1</font></div><div><font size="2"   >$PGDATA &nbsp; &nbsp;/data02/pgdata95/pg_root</font></div><div><font size="2"   >$ARCH &nbsp; &nbsp; &nbsp; &nbsp; /data02/pgdata95/pg_arch</font></div><div><font size="2"   >$PGPORT &nbsp; &nbsp;1922</font></div><div><font size="2"   ><br></font></div><div><div style="line-height: 28px;"   ><font size="2"   >db2</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >$PGDATA &nbsp; &nbsp;/data03/pgdata95/pg_root</font></div><div style="line-height: 28px;"   ><font size="2"   >$ARCH &nbsp; &nbsp; &nbsp; &nbsp; /data03/pgdata95/pg_arch</font></div><div style="line-height: 28px;"   ><font size="2"   >$PGPORT &nbsp; &nbsp;1923</font></div></div></div><p></p></pre></div><div><br></div><div>配置primary</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># grep "^[a-z]" postgresql.conf</font></div><div><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"   >port = 1922 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >max_connections = 199 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >superuser_reserved_connections = 13 &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_directories = '.' &nbsp; # comma-separated list of directories</font></div><div><font size="2"   >unix_socket_permissions = 0700 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# begin with 0 to use octal notation</font></div><div><font size="2"   >tcp_keepalives_idle = 60 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPIDLE, in seconds;</font></div><div><font size="2"   >tcp_keepalives_interval = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPINTVL, in seconds;</font></div><div><font size="2"   >tcp_keepalives_count = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # TCP_KEEPCNT;</font></div><div><font size="2"   >shared_buffers = 1024MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div><font size="2"   >huge_pages = try &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# on, off, or try</font></div><div><font size="2"   >dynamic_shared_memory_type = posix &nbsp; &nbsp; &nbsp;# the default is the first option</font></div><div><font size="2"   >vacuum_cost_delay = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 0-100 milliseconds</font></div><div><font size="2"   >vacuum_cost_limit = 10000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 credits</font></div><div><font size="2"   >bgwriter_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 10-10000ms between rounds</font></div><div><font size="2"   >wal_level = logical &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, hot_standby, or logical</font></div><div><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level;</font></div><div><font size="2"   >wal_sync_method = open_sync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # the default is the first option</font></div><div><font size="2"   >full_page_writes = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # recover from partial page writes</font></div><div><font size="2"   >wal_compression = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# enable compression of full-page writes</font></div><div><font size="2"   >wal_log_hints = on</font></div><div><font size="2"   >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"   >archive_mode = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # allows archiving to be done</font></div><div><font size="2"   >archive_command = 'test ! -f /data02/pgdata95/pg_arch/%f &amp;&amp; cp %p /data02/pgdata95/pg_arch/%f' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# command to use to archive a logfile segment</font></div><div><font size="2"   >max_wal_senders = 12 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of walsender processes</font></div><div><font size="2"   >max_replication_slots = 12 &nbsp; &nbsp; &nbsp;# max number of replication slots</font></div><div><font size="2"   >track_commit_timestamp = on &nbsp; &nbsp; # collect timestamp of transaction commit</font></div><div><font size="2"   >hot_standby = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# "on" allows queries during recovery</font></div><div><font size="2"   >wal_receiver_status_interval = 1s &nbsp; &nbsp; &nbsp; # send replies at least this often</font></div><div><font size="2"   >hot_standby_feedback = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # send info from standby to prevent</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_directory = 'pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_disconnections = on</font></div><div><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div><font size="2"   >log_replication_commands = on</font></div><div><font size="2"   >log_timezone = 'PRC'</font></div><div><font size="2"   >cluster_name = 'db1' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# added to process titles if nonempty</font></div><div><font size="2"   >autovacuum = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Enable autovacuum subprocess? &nbsp;'on'</font></div><div><font size="2"   >log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >timezone = 'PRC'</font></div><div><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >pg_hba.conf</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># replication privilege.</font></div><div><font size="2"   >local &nbsp; replication &nbsp; &nbsp; postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div><div><font size="2"   >host &nbsp; &nbsp;replication &nbsp; &nbsp; postgres &nbsp; &nbsp; &nbsp; &nbsp;127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div><div><font size="2"   >host &nbsp; &nbsp;replication &nbsp; &nbsp; postgres &nbsp; &nbsp; &nbsp; &nbsp;::1/128 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trust</font></div><p></p></pre></div><div>recovery.conf&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg95@db-172-16-3-150-&gt; cp /opt/pgsql9.5/share/recovery.conf.sample $PGDATA/</font></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; cd $PGDATA</font></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; mv recovery.conf.sample recovery.done</font></div></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; vi recovery.done&nbsp;</font></div><div><div><font size="2"   >restore_command = 'cp /data03/pgdata95/pg_arch/%f %p' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # e.g. 'cp /mnt/server/archivedir/%f %p'</font></div><div><font size="2"   >recovery_target_timeline = 'latest'</font></div><div><font size="2"   >standby_mode = on</font></div><div><font size="2"   >primary_conninfo = 'host=127.0.0.1 port=1923 user=postgres keepalives_idle=60' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# e.g. 'host=localhost port=5432'</font></div></div><p></p></pre></div><div>归档&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 postgresql-7320681]# mkdir /data02/pgdata95/pg_arch</font></span></div><div><font size="2"   >[root@db-172-16-3-150 postgresql-7320681]# chown pg95:pg95 /data02/pgdata95/pg_arch</font></div><p></p></pre></div><div>启动数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg_ctl restart -m fast</font></div><div></div><p></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >创建primary-standby 环境</span></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 postgresql-7320681]# mkdir -p /data03/pgdata95/pg_root</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 postgresql-7320681]# mkdir -p /data03/pgdata95/pg_arch</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 postgresql-7320681]# chown -R pg95:pg95 /data03/pgdata95</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 postgresql-7320681]# chmod 700 /data03/pgdata95/pg_root</font></div></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-150 postgresql-7320681]# su - pg95</font></div><div><div><font size="2"   >pg95@db-172-16-3-150-&gt; pg_basebackup -D /data03/pgdata95/pg_root -F p -U postgres -h 127.0.0.1 -p 1922</font></div><div><font size="2"   >WARNING: &nbsp;skipping special file "./.s.PGSQL.1922"</font></div><div><font size="2"   >NOTICE: &nbsp;pg_stop_backup complete, all required WAL segments have been archived</font></div></div><p></p></pre></div></div><div>修改配置文件 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg95@db-172-16-3-150-&gt; cd /data03/pgdata95/pg_root/</font></div><div><div><font size="2"   >pg95@db-172-16-3-150-&gt; mv recovery.done recovery.conf</font></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; vi recovery.conf &nbsp; &nbsp;修改两处</font></div></div><div><div><font size="2"   >restore_command = 'cp /data02/pgdata95/pg_arch/%f %p' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # e.g. 'cp /mnt/server/archivedir/%f %p'</font></div><div><font size="2"   >primary_conninfo = 'host=127.0.0.1 port=1922 user=postgres keepalives_idle=60' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# e.g. 'host=localhost port=5432'</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; vi postgresql.conf</font></div><div><font size="2"   >修改</font></div><div><font size="2"   >port = 1923</font></div><div><font size="2"   >cluster_name = 'db2'</font></div><div><font size="2"   >archive_command = 'test ! -f /data03/pgdata95/pg_arch/%f &amp;&amp; cp %p /data03/pgdata95/pg_arch/%f'</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >启动standby</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg95@db-172-16-3-150-&gt; pg_ctl start -D /data03/pgdata95/pg_root</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; LOG: &nbsp;00000: redirecting log output to logging collector process</font></div><div><font size="2"   >HINT: &nbsp;Future log output will appear in directory "pg_log".</font></div><div><font size="2"   >LOCATION: &nbsp;SysLogger_Start, syslogger.c:622</font></div><p></p></pre></div><div><br></div><div>可以看到已经启动了</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 postgresql-7320681]# ps -ewf|grep pg95</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 27194 &nbsp; &nbsp; 1 &nbsp;0 15:49 pts/2 &nbsp; &nbsp;00:00:00 /opt/pgsql9.5/bin/postgres</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 27196 27194 &nbsp;0 15:49 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: db1: logger process &nbsp;&nbsp;</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 27198 27194 &nbsp;0 15:49 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: db1: checkpointer process &nbsp;&nbsp;</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 27199 27194 &nbsp;0 15:49 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: db1: writer process &nbsp;&nbsp;</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 27200 27194 &nbsp;0 15:49 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: db1: wal writer process &nbsp;&nbsp;</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 27201 27194 &nbsp;0 15:49 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: db1: autovacuum launcher process &nbsp;&nbsp;</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 27202 27194 &nbsp;0 15:49 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: db1: archiver process &nbsp; last was 000000010000000000000002</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 27203 27194 &nbsp;0 15:49 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: db1: stats collector process &nbsp;&nbsp;</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 27349 &nbsp; &nbsp; 1 &nbsp;0 15:57 pts/2 &nbsp; &nbsp;00:00:00 /opt/pgsql9.5/bin/postgres -D /data03/pgdata95/pg_root</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 27351 27349 &nbsp;0 15:57 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: db2: logger process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 27352 27349 &nbsp;0 15:57 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: db2: startup process &nbsp; recovering 000000010000000000000003</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 27355 27349 &nbsp;0 15:57 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: db2: checkpointer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 27356 27349 &nbsp;0 15:57 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: db2: writer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 27357 27349 &nbsp;0 15:57 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: db2: stats collector process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 27359 27349 &nbsp;0 15:57 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: db2: wal receiver process &nbsp; streaming 0/3000140</font></div><div><font size="2"   >pg95 &nbsp; &nbsp; 27360 27194 &nbsp;0 15:57 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: db1: wal sender process postgres 127.0.0.1(16326) streaming 0/3000140</font></div><div><font size="2"   >root &nbsp; &nbsp; 27401 &nbsp;1264 &nbsp;0 15:58 pts/2 &nbsp; &nbsp;00:00:00 grep pg95</font></div><p></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >创建一些测试数据, 执行checkpoint</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg95@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 1922</font></div><div><font size="2"   >psql (9.5devel)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><div><font size="2"   >postgres=# create table t1(id int, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# insert into t1 select generate_series(1,1000000), md5(random()::text);</font></div><div><font size="2"   >INSERT 0 1000000</font></div></div><div><div><font size="2"   >postgres=# select sum(hashtext(t1.*::text)) from t1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; sum &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp;-585064225655</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >postgres=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   >确保已同步</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg95@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 1923</font></div><div><font size="2"   >psql (9.5devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# select sum(hashtext(t1.*::text)) from t1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; sum &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp;-585064225655</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >激活standby.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg95@db-172-16-3-150-&gt; pg_ctl promote -D /data03/pgdata95/pg_root</font></div><div><font size="2"   >server promoting</font></div><p></p></pre></div><div><br></div><div>此时主备已经没有同步关系了, 模拟脑裂</div><div>在老的primary执行.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg95@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 1922</font></div><div><font size="2"   >psql (9.5devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# insert into t1 select generate_series(1,1000000), md5(random()::text);</font></div><div><font size="2"   >INSERT 0 1000000</font></div><div><font size="2"   >postgres=# insert into t1 select generate_series(1,5000000), md5(random()::text);</font></div><div><font size="2"   >INSERT 0 5000000</font></div><div><font size="2"   >postgres=# delete from t1;</font></div><div><font size="2"   >DELETE 7000000</font></div><div><font size="2"   >postgres=# insert into t1 select generate_series(1,5000000), md5(random()::text);</font></div><div><font size="2"   >INSERT 0 5000000</font></div><div><font size="2"   >postgres=# select sum(hashtext(t1.*::text)) from t1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;sum &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp;316362957898</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >postgres=# create table t2 as select * from t1;</font></div><div><font size="2"   >SELECT 5000000</font></div><div><font size="2"   >postgres=# create index idx_t1 on t1(id);</font></div><div><font size="2"   >CREATE INDEX</font></div><div><font size="2"   >postgres=# create function ft() returns void as $$</font></div><div><font size="2"   >postgres$# declare</font></div><div><font size="2"   >postgres$# begin</font></div><div><font size="2"   >postgres$# return;</font></div><div><font size="2"   >postgres$# end;</font></div><div><font size="2"   >postgres$# $$ language plpgsql;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >postgres=# alter table t1 add column crt_time timestamp;</font></div><div><font size="2"   >ALTER TABLE</font></div></div><div><font size="2"   >postgres=# alter table t1 add constraint pk primary key(id);</font></div><div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >postgres=# create view vt1 as select * from t1 where id&lt;100;</font></div><div><font size="2"   >CREATE VIEW</font></div></div><p></p></pre></div><div><br></div><div>在新的primary执行 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg95@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 1923</font></div><div><font size="2"   >psql (9.5devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# insert into t1 select generate_series(1,6000000), md5(random()::text);</font></div><div><font size="2"   >INSERT 0 6000000</font></div><div><font size="2"   >postgres=# delete from t1;</font></div><div><font size="2"   >DELETE 7000000</font></div><div><font size="2"   >postgres=# insert into t1 select generate_series(1,5000000), md5(random()::text);</font></div><div><font size="2"   >INSERT 0 5000000</font></div><div><font size="2"   >postgres=# select sum(hashtext(t1.*::text)) from t1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; sum &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp;1868065255940</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>现在的目标是老的primary要变成standby.</div><div>停止老的primary :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg95@db-172-16-3-150-&gt; pg_ctl stop -m fast -D /data02/pgdata95/pg_root</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >执行测试, 但不执行恢复 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg95@db-172-16-3-150-&gt; pg_rewind -D /data02/pgdata95/pg_root --source-server='hostaddr=127.0.0.1 port=1923 user=postgres dbname=postgres password=postgres' -P --debug -n</font></div><div><font size="2"   >connected to remote server</font></div><div><font size="2"   >fetched file "global/pg_control", length 8192</font></div><div><font size="2"   >fetched file "pg_xlog/00000002.history", length 41</font></div><div><font size="2"   >The servers diverged at WAL position 0/8BF34E0 on timeline 1.</font></div><div><font size="2"   >could not open file "/data02/pgdata95/pg_root/pg_xlog/000000010000000000000008": No such file or directory</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >could not find previous WAL record at 0/8BF34E0</font></div><div><font size="2"   >Failure, exiting</font></div><p></p></pre></div><div>pg_rewind需要知道老的primary在timeline之后发生了哪些变更, 这些变更需要从pg_xlog取出. 这些变更的数据块需要从新库复制过来.</div><div>因为老的primary脑裂后经过了大量的数据变更, 很多xlog已经归档了, 所以需要从归档拷贝到pg_xlog目录.</div><div>拷贝 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg95@db-172-16-3-150-&gt; cd /data02/pgdata95/pg_arch/</font></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; ll</font></div><div><font size="2"   >total 2.4G</font></div><div><font size="2"   >-rw------- 1 pg95 pg95 16M Apr &nbsp;9 15:50 000000010000000000000001</font></div><div><font size="2"   >-rw------- 1 pg95 pg95 16M Apr &nbsp;9 15:50 000000010000000000000002</font></div><div><font size="2"   >-rw------- 1 pg95 pg95 302 Apr &nbsp;9 15:50 000000010000000000000002.00000060.backup</font></div><div><font size="2"   >-rw------- 1 pg95 pg95 16M Apr &nbsp;9 15:59 000000010000000000000003</font></div><div><font size="2"   >-rw------- 1 pg95 pg95 16M Apr &nbsp;9 15:59 000000010000000000000004</font></div><div><font size="2"   >-rw------- 1 pg95 pg95 16M Apr &nbsp;9 15:59 000000010000000000000005</font></div><div><font size="2"   >-rw------- 1 pg95 pg95 16M Apr &nbsp;9 15:59 000000010000000000000006</font></div><div><font size="2"   >-rw------- 1 pg95 pg95 16M Apr &nbsp;9 15:59 000000010000000000000007</font></div><div><font size="2"   >-rw------- 1 pg95 pg95 16M Apr &nbsp;9 16:02 000000010000000000000008</font></div><div><font size="2"   >-rw------- 1 pg95 pg95 16M Apr &nbsp;9 16:02 000000010000000000000009</font></div></div><div><font size="2"   >.....</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; cp * /data02/pgdata95/pg_root/pg_xlog/</font></div><p></p></pre></div><div><br></div><div>再次测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg95@db-172-16-3-150-&gt; pg_rewind -D /data02/pgdata95/pg_root --source-server='hostaddr=127.0.0.1 port=1923 user=postgres dbname=postgres password=postgres' -P -n</font></div><div><font size="2"   >connected to remote server</font></div><div><font size="2"   >The servers diverged at WAL position 0/8BF34E0 on timeline 1.</font></div><div><font size="2"   >Rewinding from last common checkpoint at 0/8BF3438 on timeline 1</font></div><div><font size="2"   >reading source file list</font></div><div><font size="2"   >reading target file list</font></div><div><div><font size="2"   >reading WAL in target</font></div><div><font size="2"   >Need to copy 1755 MB (total source directory size is 1786 MB)</font></div><div><font size="2"   >1797713/1797713 kB (100%) copied</font></div><div><font size="2"   >creating backup label and updating control file</font></div><div><font size="2"   >Done!</font></div></div><p></p></pre></div><div><br></div><div>测试没问题就可以直接执行了, 去掉-n参数即可.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg95@db-172-16-3-150-&gt; pg_rewind -D /data02/pgdata95/pg_root --source-server='hostaddr=127.0.0.1 port=1923 user=postgres dbname=postgres password=postgres' -P</font></div><div><font size="2"   >connected to remote server</font></div><div><font size="2"   >The servers diverged at WAL position 0/8BF34E0 on timeline 1.</font></div><div><font size="2"   >Rewinding from last common checkpoint at 0/8BF3438 on timeline 1</font></div><div><font size="2"   >reading source file list</font></div><div><font size="2"   >reading target file list</font></div><div><font size="2"   >reading WAL in target</font></div><div><font size="2"   >Need to copy 1755 MB (total source directory size is 1786 MB)</font></div><div><font size="2"   >1797714/1797714 kB (100%) copied</font></div><div><font size="2"   >creating backup label and updating control file</font></div><div><font size="2"   >Done!</font></div><p></p></pre></div><div><br></div><div>执行完后, 老的primary数据库需要手工启动,&nbsp;</div><div>启动前, 请先修改配置 :&nbsp;</div><div>recovery.conf</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg95@db-172-16-3-150-&gt; cd /data02/pgdata95/pg_root/</font></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; ll</font></div><div><font size="2"   >total 148K</font></div><div><font size="2"   >-rw------- 1 pg95 pg95 &nbsp;175 Apr &nbsp;9 16:21 backup_label</font></div><div><font size="2"   >-rw------- 1 pg95 pg95 &nbsp;206 Apr &nbsp;9 16:21 backup_label.old</font></div><div><font size="2"   >drwx------ 5 pg95 pg95 4.0K Apr &nbsp;9 16:21 base</font></div><div><font size="2"   >drwx------ 2 pg95 pg95 4.0K Apr &nbsp;9 16:21 global</font></div><div><font size="2"   >drwx------ 2 pg95 pg95 4.0K Apr &nbsp;9 09:04 pg_clog</font></div><div><font size="2"   >drwx------ 2 pg95 pg95 4.0K Apr &nbsp;9 11:09 pg_commit_ts</font></div><div><font size="2"   >drwx------ 2 pg95 pg95 4.0K Apr &nbsp;9 09:04 pg_dynshmem</font></div><div><font size="2"   >-rw------- 1 pg95 pg95 4.4K Apr &nbsp;9 16:21 pg_hba.conf</font></div><div><font size="2"   >-rw------- 1 pg95 pg95 1.6K Apr &nbsp;9 16:21 pg_ident.conf</font></div><div><font size="2"   >drwx------ 2 pg95 pg95 4.0K Apr &nbsp;9 16:21 pg_log</font></div><div><font size="2"   >drwx------ 4 pg95 pg95 4.0K Apr &nbsp;9 09:04 pg_logical</font></div><div><font size="2"   >drwx------ 4 pg95 pg95 4.0K Apr &nbsp;9 09:04 pg_multixact</font></div><div><font size="2"   >drwx------ 2 pg95 pg95 4.0K Apr &nbsp;9 16:14 pg_notify</font></div><div><font size="2"   >drwx------ 2 pg95 pg95 4.0K Apr &nbsp;9 09:04 pg_replslot</font></div><div><font size="2"   >drwx------ 2 pg95 pg95 4.0K Apr &nbsp;9 09:04 pg_serial</font></div><div><font size="2"   >drwx------ 2 pg95 pg95 4.0K Apr &nbsp;9 09:04 pg_snapshots</font></div><div><font size="2"   >drwx------ 2 pg95 pg95 4.0K Apr &nbsp;9 16:21 pg_stat</font></div><div><font size="2"   >drwx------ 2 pg95 pg95 4.0K Apr &nbsp;9 16:21 pg_stat_tmp</font></div><div><font size="2"   >drwx------ 2 pg95 pg95 4.0K Apr &nbsp;9 09:04 pg_subtrans</font></div><div><font size="2"   >drwx------ 2 pg95 pg95 4.0K Apr &nbsp;9 09:04 pg_tblspc</font></div><div><font size="2"   >drwx------ 2 pg95 pg95 4.0K Apr &nbsp;9 09:04 pg_twophase</font></div><div><font size="2"   >-rw------- 1 pg95 pg95 &nbsp; &nbsp;4 Apr &nbsp;9 09:04 PG_VERSION</font></div><div><font size="2"   >drwx------ 3 pg95 pg95 &nbsp;16K Apr &nbsp;9 16:21 pg_xlog</font></div><div><font size="2"   >-rw------- 1 pg95 pg95 &nbsp; 88 Apr &nbsp;9 16:21 postgresql.auto.conf</font></div><div><font size="2"   >-rw------- 1 pg95 pg95 &nbsp;22K Apr &nbsp;9 16:21 postgresql.conf</font></div><div><font size="2"   >-rw------- 1 pg95 pg95 &nbsp; 27 Apr &nbsp;9 16:14 postmaster.opts</font></div><div><font size="2"   >-rw-r--r-- 1 pg95 pg95 5.7K Apr &nbsp;9 16:21 recovery.done</font></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; mv recovery.done recovery.conf</font></div></div><div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >pg95@db-172-16-3-150-&gt; vi recovery.conf &nbsp; &nbsp;修改两处</font></div></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >restore_command = 'cp /data03/pgdata95/pg_arch/%f %p' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # e.g. 'cp /mnt/server/archivedir/%f %p'</font></div><div style="line-height: 28px;"   ><font size="2"   >primary_conninfo = 'host=127.0.0.1 port=1923 user=postgres keepalives_idle=60' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# e.g. 'host=localhost port=5432'</font></div></div></div><p></p></pre></div><div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >pg95@db-172-16-3-150-&gt; vi postgresql.conf</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >修改</font></div><div style="line-height: 28px;"   ><font size="2"   >port = 1922</font></div><div style="line-height: 28px;"   ><font size="2"   >cluster_name = 'db1'</font></div><div style="line-height: 28px;"   ><font size="2"   >archive_command = 'test ! -f /data02/pgdata95/pg_arch/%f &amp;&amp; cp %p /data02/pgdata95/pg_arch/%f'</font></div><p></p></pre></div></div><div><br></div><div>启动老的主库, 变成standby,</div><div>并检查是否解决了脑裂, 与新的primary完全一致, 例如脑裂过程创建的约束, 函数, 视图都会消失.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg95@db-172-16-3-150-&gt; pg_ctl start -D /data02/pgdata95/pg_root</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; LOG: &nbsp;00000: redirecting log output to logging collector process</font></div><div><font size="2"   >HINT: &nbsp;Future log output will appear in directory "pg_log".</font></div><div><font size="2"   >LOCATION: &nbsp;SysLogger_Start, syslogger.c:622</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >pg95@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 1922</font></div><div><font size="2"   >psql (9.5devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | Name | Type &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >--------+------+-------+----------</font></div><div><font size="2"   >&nbsp;public | t1 &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | tbl &nbsp;| table | postgres</font></div><div><font size="2"   >&nbsp;public | test | table | postgres</font></div><div><font size="2"   >(3 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# \dv</font></div><div><font size="2"   >No relations found.</font></div><div><font size="2"   >postgres=# \d+ t1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "public.t1"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers | Storage &nbsp;| Stats target | Description&nbsp;</font></div><div><font size="2"   >--------+---------+-----------+----------+--------------+-------------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; | integer | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;info &nbsp; | text &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div></div><div><div style="line-height: 28px;"   ><font size="2"   >postgres=# \df ft</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of functions</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;Schema | Name | Result data type | Argument data types | Type&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >--------+------+------------------+---------------------+------</font></div><div style="line-height: 28px;"   ><font size="2"   >(0 rows)</font></div></div><div><div><font size="2"   >postgres=# select sum(hashtext(t1.*::text)) from t1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; sum &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp;1868065255940 &nbsp; 数据和新的primary吻合</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >再检查一下老库上新增的表是否还在? 通过SIZE来区分</font></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; psql<br>psql (9.5devel)<br>Type "help" for help.<br><br>postgres=# select oid from pg_database where datname='postgres';<br>  oid  <br>-------<br> 13253<br>(1 row)<br><br>postgres=# select pg_relation_filepath('t1');<br> pg_relation_filepath <br>----------------------<br> base/13253/16451<br>(1 row)<br><br><br>这是t1表<br>pg95@db-172-16-3-150-&gt; cd /data02/pgdata95/pg_root/base/13253/<br>pg95@db-172-16-3-150-&gt; ll 16451*<br>-rw------- 1 pg95 pg95 780M Apr  9 16:31 16451<br>-rw------- 1 pg95 pg95 128K Apr  9 16:21 16451_fsm<br>-rw------- 1 pg95 pg95  32K Apr  9 16:31 16451_vm<br>可以看到, 除了t1, 老库上分裂时创建的t2显然不在了. 注意size</font></div><div><font size="2"   >如果你要更加精确的区分, 在老库执行pg_rewind之前, 记录一下t2的pg_relation_filepath, 然后来这里比对看看文件还在不在.<br>pg95@db-172-16-3-150-&gt; ll -S | head -n 10<br>total 796M<br>-rw------- 1 pg95 pg95 780M Apr  9 16:31 16451<br>-rw------- 1 pg95 pg95 576K Apr  9 16:21 1255<br>-rw------- 1 pg95 pg95 480K Apr  9 16:21 2618<br>-rw------- 1 pg95 pg95 448K Apr  9 16:31 2608<br>-rw------- 1 pg95 pg95 448K Apr  9 16:31 2674<br>-rw------- 1 pg95 pg95 416K Apr  9 16:31 2673<br>-rw------- 1 pg95 pg95 384K Apr  9 16:31 1249<br>-rw------- 1 pg95 pg95 288K Apr  9 12:27 2609<br>-rw------- 1 pg95 pg95 256K Apr  9 16:21 2691<br><br></font></div><p></p></pre></div><div><span style="line-height: 28px;"   >至此恢复结束.</span></div><div><br></div><div>[注意]</div><div>pg_rewind 可以实施的前提条件</div><div>1. 需要打开wal_log_hints 选项或者初始化数据库是开启了checksum.</div><div>否则会报错 :&nbsp;</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >pg95@db-172-16-3-150-&gt; pg_rewind -D /data02/pgdata95/pg_root --source-server='hostaddr=127.0.0.1 port=1923 user=postgres dbname=postgres password=postgres' -P --debug -n</font></div><div style="line-height: 28px;"   ><font size="2"   >connected to remote server</font></div><div style="line-height: 28px;"   ><font size="2"   >fetched file "global/pg_control", length 8192</font></div><div style="line-height: 28px;"   ><font size="2"   >target server need to use either data checksums or "wal_log_hints = on"</font></div><div style="line-height: 28px;"   ><font size="2"   >Failure, exiting</font></div><p></p></pre></div></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >2. 需要开启full_page_writes</span></div><div>3. 执行pg_rewind的过程中, 老的主库需要发生failover前的最后一个checkpoint之后产生的所有xlog都放到pg_xlog目录.</div><div>pg_rewind不会帮你执行restore_command自动去获取archive file.</div><div>4. 老的主库必须在干净的关闭数据库后执行pg_rewind.</div><div><br></div><div>[参考]</div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/app-pgrewind.html"   >http://www.postgresql.org/docs/devel/static/app-pgrewind.html</a><br><wbr><div>2.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/libpq-envars.html"   >http://www.postgresql.org/docs/devel/static/libpq-envars.html</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL 9.5 new feature - pg_rewind fast sync Split Brain Primary  Standby - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>