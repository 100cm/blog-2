<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Can we use event trigger implement like Oracle recycle bin? - Not Now, you can use hook in tcop/utility.h</h2>
	<h5 id="">2015-04-29 11:16:56&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201532981647330/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><span style="line-height: 28px;"   >早上一位网友问我，能否让用户在删除表时，不执行删除操作，而是重命名表。</span></div><div>这不就是Oracle的recycle bin的特性吗？即删表时将表放到回收站，以后还可以恢复。</div><div>从9.3开始，<span style="line-height: 28px;"   >PostgreSQL</span><span style="line-height: 28px;"   >提供了event trigger的功能。目前支持几个TAG：</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ddl_command_start</font></div><div><font size="2"   >sql_drop</font></div><div><font size="2"   >table_rewrite</font></div><div><font size="2"   >ddl_command_end</font></div><p></p></pre></div><div>如果要获取被删除的对象名，目前只有sql_drop的TAG支持，也就是在sql_drop的事件触发器函数中可以调用以下函数类获取对象信息。</div><div><p style="font-size: 12.1599998474121px; line-height: 1.5em; margin: 1.2em 0em; font-family: verdana, sans-serif;"   ><code>pg_event_trigger_dropped_objects</code>&nbsp;returns a list of all objects dropped by the command in whose&nbsp;<tt>sql_drop</tt>&nbsp;event it is called. If called in any other context,&nbsp;<code>pg_event_trigger_dropped_objects</code>&nbsp;raises an error.&nbsp;<code>pg_event_trigger_dropped_objects</code>&nbsp;returns the following columns:</p><div style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: normal;"   ><a id="AEN22939" name="AEN22939" rel="nofollow"   ></a><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; border: 2px solid rgb(167, 198, 223); background-color: rgb(224, 236, 239);"   ><colgroup><col><col><col><thead><tr><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Name</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Type</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Description</th></tr></thead><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>classid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>Oid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >OID of catalog the object belonged in</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>objid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>Oid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >OID the object had within the catalog</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>objsubid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>int32</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Object sub-id (e.g. attribute number for columns)</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>original</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>bool</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Flag used to identify the root object(s) of the deletion</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>normal</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>bool</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Flag indicating that there's a normal dependency relationship in the dependency graph leading to this object</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>is_temporary</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>bool</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Flag indicating that the object was a temporary object.</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>object_type</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>text</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Type of the object</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>schema_name</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>text</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Name of the schema the object belonged in, if any; otherwise&nbsp;<tt>NULL</tt>. No quoting is applied.</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>object_name</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>text</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Name of the object, if the combination of schema and name can be used as a unique identifier for the object; otherwise&nbsp;<tt>NULL</tt>. No quoting is applied, and name is never schema-qualified.</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>object_identity</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>text</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Text rendering of the object identity, schema-qualified. Each and every identifier present in the identity is quoted if necessary.</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>address_names</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>text[]</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >An array that, together with&nbsp;<tt>object_type</tt>&nbsp;and&nbsp;<tt>address_args</tt>, can be used by the&nbsp;<code>pg_get_object_address()</code>&nbsp;to recreate the object address in a remote server containing an identically named object of the same kind.</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>address_args</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>text[]</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Complement for&nbsp;<tt>address_names</tt>&nbsp;above.</td></tr></table></div></div><div>那么我们是否能用它来实现类似oracle recycle bin的功能呢？即</div><div><span style="line-height: 28px;"   >用户在删除表时，不执行删除操作，而是重命名表。</span></div><div>答案是不行的，因为SQL_DROP触发时表已经删除了，再执行alter table rename等操作会报对象不存在的错误。</div><div>我们在事务中可以模拟这样的情形。例子：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# drop table test2;</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >postgres=# alter table test2 rename to t;</font></div><div><font size="2"   >ERROR: &nbsp;relation "test2" does not exist</font></div><div><font size="2"   >postgres=# rollback;</font></div><div><font size="2"   >ROLLBACK</font></div><p></p></pre></div><div>我们用事件触发器会得到同样的结果：</div><div>例如我们创建一个schema来存放重命名的对象。用一个表来记录重命名的前后关系。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create schema recyclebin;</font></div><div><font size="2"   >postgres=# create table recyclebin.trace(id serial8 primary key,type_name text,nsp_name text,obj_name text,tg_tag text,new_nsp_name text,new_obj_name text,crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div>创建一个事件触发器函数进行测试：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >CREATE OR REPLACE FUNCTION test_event_trigger_for_drops()<br>        RETURNS event_trigger LANGUAGE plpgsql AS $$<br>DECLARE<br>    obj record;<br>    v_type_name text[] := '{}'::text[];<br>    v_nsp_name text[] := '{}'::text[];<br>    v_obj_name text[] := '{}'::text[];<br>    v_tg_tag text := TG_TAG;<br>    v_crt_time timestamp := now();<br>    i int := 1;<br>    v_new_nsp_name text := 'recyclebin';<br>    v_new_obj_name text;<br>    have_table boolean := false;<br>    x text;<br>    tt text;<br>BEGIN<br>    FOR obj IN SELECT * FROM pg_event_trigger_dropped_objects()<br>    LOOP<br>	RAISE NOTICE '% dropped object: % %.% %',<br>                     v_tg_tag,<br>                     obj.object_type,<br>                     obj.schema_name,<br>                     obj.object_name,<br>                     obj.object_identity;<br><br>	v_type_name := array_append(v_type_name, obj.object_type);<br>	v_nsp_name := array_append(v_nsp_name, obj.schema_name);<br>	v_obj_name := array_append(v_obj_name, obj.object_name);<br><br>--  调试, 在这里已经查不到被删除对象的信息了.<br>      select t.*::text into tt from pg_class t where relname=obj.object_name and relnamespace=(select oid from pg_namespace where nspname=obj.schema_name);<br>      raise notice '%', tt;<br><br>        if (obj.object_type = 'table') then<br>	  RAISE NOTICE 'Found table in drop list. %', v_obj_name;<br>	  have_table := true;<br>	end if;<br><br>    END LOOP;<br>    <br>    if ( have_table = true ) then<br>      RAISE NOTICE 'Move table to recycle bin';<br>      RAISE exception 'Found table in drop list.';<br>    end if;<br><br>    EXCEPTION WHEN others then<br>      raise notice 'exception handler';<br>--  调试, 在这里已经查不到被删除对象的信息了.<br>      select t.*::text into tt from pg_class t where relname=obj.object_name and relnamespace=(select oid from pg_namespace where nspname=obj.schema_name);<br>      raise notice '%', tt;<br><br>      FOREACH x in ARRAY v_obj_name LOOP<br>        raise notice 'loop';<br>	if v_type_name[i] = 'table' then<br>	  v_new_obj_name := 'md5'||md5(random()::text||clock_timestamp()::text);<br>	  execute 'alter table '||v_nsp_name[i]||'.'||x||' set schema '||v_new_nsp_name;<br>          execute 'alter table '||v_new_nsp_name||'.'||x||' rename to '||v_new_obj_name;<br>          insert into recyclebin.trace(type_name,nsp_name,obj_name,tg_tag,new_nsp_name,new_obj_name,crt_time) <br>	    values (v_type_name[i],v_nsp_name[i],v_obj_name[i],v_tg_tag,v_new_nsp_name,v_new_obj_name,v_crt_time);<br>	end if;<br>        i := i+1;<br>      END LOOP;<br>END;<br>$$;</span></font></div><p></p></pre></div><div>创建事件触发器：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE EVENT TRIGGER test_event_trigger_for_drops</font></div><div><font size="2"   >&nbsp; &nbsp;ON sql_drop&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;EXECUTE PROCEDURE test_event_trigger_for_drops();</font></div><p></p></pre></div><div>删除表测试：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# drop table test2;</font></div><div><font size="2"   >NOTICE: &nbsp;DROP TABLE dropped object: table public.test2 public.test2</font></div><div><font size="2"   >NOTICE: &nbsp;&lt;NULL&gt;</font></div><div><font size="2"   >NOTICE: &nbsp;Found table in drop list. {test2}</font></div><div><font size="2"   >NOTICE: &nbsp;Move table to recycle bin</font></div><div><font size="2"   >NOTICE: &nbsp;exception handler</font></div><div><font size="2"   >NOTICE: &nbsp;&lt;NULL&gt;</font></div><div><font size="2"   >NOTICE: &nbsp;loop</font></div><div><font size="2"   >ERROR: &nbsp;relation "public.test2" does not exist</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "alter table public.test2 set schema recyclebin"</font></div><div><font size="2"   >PL/pgSQL function test_event_trigger_for_drops() line 56 at EXECUTE statement</font></div><p></p></pre></div><div>和我们预想的一样。</div><div>也就是说，使用事件触发器无法实现这个场景的功能，我们只能做到抛出异常，然后告诉用户执行rename。</div><div>下面我们修改一下这个事件触发器函数，来一个温馨提示：</div><div>例如：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION test_event_trigger_for_drops()</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; RETURNS event_trigger LANGUAGE plpgsql AS $$</font></div><div><font size="2"   >DECLARE</font></div><div><font size="2"   >&nbsp; &nbsp; obj record;</font></div><div><font size="2"   >&nbsp; &nbsp; v_type_name text[] := '{}'::text[];</font></div><div><font size="2"   >&nbsp; &nbsp; v_nsp_name text[] := '{}'::text[];</font></div><div><font size="2"   >&nbsp; &nbsp; v_obj_name text[] := '{}'::text[];</font></div><div><font size="2"   >&nbsp; &nbsp; v_tg_tag text := TG_TAG;</font></div><div><font size="2"   >&nbsp; &nbsp; v_crt_time timestamp := now();</font></div><div><font size="2"   >&nbsp; &nbsp; i int := 1;</font></div><div><font size="2"   >&nbsp; &nbsp; v_new_nsp_name text := 'recyclebin';</font></div><div><font size="2"   >&nbsp; &nbsp; v_new_obj_name text;</font></div><div><font size="2"   >&nbsp; &nbsp; have_table boolean := false;</font></div><div><font size="2"   >&nbsp; &nbsp; x text;</font></div><div><font size="2"   >&nbsp; &nbsp; tt text := '';</font></div><div><font size="2"   >&nbsp; &nbsp; v_sql text[];</font></div><div><font size="2"   >&nbsp; &nbsp; v_sqlend text := '';</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >&nbsp; &nbsp; FOR obj IN SELECT * FROM pg_event_trigger_dropped_objects()</font></div><div><font size="2"   >&nbsp; &nbsp; LOOP</font></div><div><font size="2"   >	RAISE NOTICE '% dropped object: % %.% %',</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_tg_tag,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;obj.object_type,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;obj.schema_name,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;obj.object_name,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;obj.object_identity;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >	v_type_name := array_append(v_type_name, obj.object_type);</font></div><div><font size="2"   >	v_nsp_name := array_append(v_nsp_name, obj.schema_name);</font></div><div><font size="2"   >	v_obj_name := array_append(v_obj_name, obj.object_name);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (obj.object_type = 'table') then</font></div><div><font size="2"   >	 &nbsp;have_table := true;</font></div><div><font size="2"   >	end if;</font></div><div><font size="2"   >&nbsp; &nbsp; END LOOP;</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; if ( have_table = true ) then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; RAISE NOTICE 'Move table to recycle bin';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; RAISE exception 'Found table in drop list.';</font></div><div><font size="2"   >&nbsp; &nbsp; end if;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; EXCEPTION WHEN others then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice 'You can not exec DROP, please execute these SQL instead: ';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice '-----------------------------------------------------------';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; FOREACH x in ARRAY v_obj_name LOOP</font></div><div><font size="2"   >	if v_type_name[i] = 'table' then</font></div><div><font size="2"   >	 &nbsp;v_new_obj_name := 'md5'||md5(random()::text||clock_timestamp()::text);</font></div><div><font size="2"   >	 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_sql[1] := 'alter table '||v_nsp_name[i]||'.'||x||' set schema '||v_new_nsp_name||';';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_sql[2] := 'alter table '||v_new_nsp_name||'.'||x||' rename to '||v_new_obj_name||';'; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >	 &nbsp;v_sql[3] := 'insert into recyclebin.trace(type_name,nsp_name,obj_name,tg_tag,new_nsp_name,new_obj_name,crt_time)&nbsp;</font></div><div><font size="2"   >	 &nbsp; &nbsp;values ('||quote_nullable(v_type_name[i])||','||quote_nullable(v_nsp_name[i])||','||quote_nullable(v_obj_name[i])||','||quote_nullable(v_tg_tag)||','||quote_nullable(v_new_nsp_name)||','||quote_nullable(v_new_obj_name)||','||quote_nullable(v_crt_time)||');';</font></div><div><font size="2"   >	 &nbsp;v_sqlend := v_sqlend||v_sql[1]||v_sql[2]||v_sql[3];</font></div><div><font size="2"   >	end if;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; i := i+1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; END LOOP;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice 'BEGIN; % COMMIT;', v_sqlend;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice '-----------------------------------------------------------';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise exception 'Please Execute these SQL above, Good Luck.';</font></div><div><font size="2"   >END;</font></div><div><font size="2"   >$$;</font></div><p></p></pre></div><div>测试：</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create table t1(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table t2(like t1) inherits(t1);</font></div><div><font size="2"   >NOTICE: &nbsp;merging column "id" with inherited definition</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table t3(like t1) inherits(t1);</font></div><div><font size="2"   >NOTICE: &nbsp;merging column "id" with inherited definition</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div>现在是温柔的提示：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# drop table t1 cascade;</font></div><div><font size="2"   >NOTICE: &nbsp;drop cascades to 2 other objects</font></div><div><font size="2"   >DETAIL: &nbsp;drop cascades to table t2</font></div><div><font size="2"   >drop cascades to table t3</font></div><div><font size="2"   >NOTICE: &nbsp;DROP TABLE dropped object: table public.t1 public.t1</font></div><div><font size="2"   >NOTICE: &nbsp;DROP TABLE dropped object: type public.t1 public.t1</font></div><div><font size="2"   >NOTICE: &nbsp;DROP TABLE dropped object: type public._t1 public.t1[]</font></div><div><font size="2"   >NOTICE: &nbsp;DROP TABLE dropped object: table public.t2 public.t2</font></div><div><font size="2"   >NOTICE: &nbsp;DROP TABLE dropped object: type public.t2 public.t2</font></div><div><font size="2"   >NOTICE: &nbsp;DROP TABLE dropped object: type public._t2 public.t2[]</font></div><div><font size="2"   >NOTICE: &nbsp;DROP TABLE dropped object: table public.t3 public.t3</font></div><div><font size="2"   >NOTICE: &nbsp;DROP TABLE dropped object: type public.t3 public.t3</font></div><div><font size="2"   >NOTICE: &nbsp;DROP TABLE dropped object: type public._t3 public.t3[]</font></div><div><font size="2"   >NOTICE: &nbsp;Move table to recycle bin</font></div><div><font size="2"   >NOTICE: &nbsp;You can not exec DROP, please execute these SQL instead:&nbsp;</font></div><div><font size="2"   >NOTICE: &nbsp;-----------------------------------------------------------</font></div><div><font size="2"   >NOTICE: &nbsp;BEGIN; alter table public.t1 set schema recyclebin;alter table recyclebin.t1 rename to md5fc6e07f4c89aec008d2a80123fe7f788;insert into recyclebin.trace(type_name,nsp_name,obj_name,tg_tag,new_nsp_name,new_obj_name,crt_time)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; values ('table','public','t1','DROP TABLE','recyclebin','md5fc6e07f4c89aec008d2a80123fe7f788','2015-04-29 10:59:51.306056');alter table public.t2 set schema recyclebin;alter table recyclebin.t2 rename to md5e0749f673c5c94db0993a93490091c50;insert into recyclebin.trace(type_name,nsp_name,obj_name,tg_tag,new_nsp_name,new_obj_name,crt_time)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; values ('table','public','t2','DROP TABLE','recyclebin','md5e0749f673c5c94db0993a93490091c50','2015-04-29 10:59:51.306056');alter table public.t3 set schema recyclebin;alter table recyclebin.t3 rename to md59ed6eeedce6faf153cb8a006882c8f45;insert into recyclebin.trace(type_name,nsp_name,obj_name,tg_tag,new_nsp_name,new_obj_name,crt_time)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; values ('table','public','t3','DROP TABLE','recyclebin','md59ed6eeedce6faf153cb8a006882c8f45','2015-04-29 10:59:51.306056'); COMMIT;</font></div><div><font size="2"   >NOTICE: &nbsp;-----------------------------------------------------------</font></div><div><font size="2"   >ERROR: &nbsp;Please Execute these SQL above, Good Luck.</font></div><p></p></pre></div><div>我们只需要照着执行以上SQL就可以了：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >BEGIN; alter table public.t1 set schema recyclebin;alter table recyclebin.t1 rename to md5fc6e07f4c89aec008d2a80123fe7f788;insert into recyclebin.trace(type_name,nsp_name,obj_name,tg_tag,new_nsp_name,new_obj_name,crt_time)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; values ('table','public','t1','DROP TABLE','recyclebin','md5fc6e07f4c89aec008d2a80123fe7f788','2015-04-29 10:59:51.306056');alter table public.t2 set schema recyclebin;alter table recyclebin.t2 rename to md5e0749f673c5c94db0993a93490091c50;insert into recyclebin.trace(type_name,nsp_name,obj_name,tg_tag,new_nsp_name,new_obj_name,crt_time)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; values ('table','public','t2','DROP TABLE','recyclebin','md5e0749f673c5c94db0993a93490091c50','2015-04-29 10:59:51.306056');alter table public.t3 set schema recyclebin;alter table recyclebin.t3 rename to md59ed6eeedce6faf153cb8a006882c8f45;insert into recyclebin.trace(type_name,nsp_name,obj_name,tg_tag,new_nsp_name,new_obj_name,crt_time)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; values ('table','public','t3','DROP TABLE','recyclebin','md59ed6eeedce6faf153cb8a006882c8f45','2015-04-29 10:59:51.306056'); COMMIT;</font></div><p></p></pre></div><div>在recyclebin可以找到我们刚才“删除"的表：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from recyclebin.trace where obj_name in ('t1','t2','t3');</font></div><div><font size="2"   >&nbsp;id | type_name | nsp_name | obj_name | &nbsp; tg_tag &nbsp; | new_nsp_name | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_obj_name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >----+-----------+----------+----------+------------+--------------+-------------------------------------+---------------------------</font></div><div><font size="2"   >-</font></div><div><font size="2"   >&nbsp; 4 | table &nbsp; &nbsp; | public &nbsp; | t1 &nbsp; &nbsp; &nbsp; | DROP TABLE | recyclebin &nbsp; | md5fc6e07f4c89aec008d2a80123fe7f788 | 2015-04-29 10:59:51.306056</font></div><div><font size="2"   >&nbsp; 5 | table &nbsp; &nbsp; | public &nbsp; | t2 &nbsp; &nbsp; &nbsp; | DROP TABLE | recyclebin &nbsp; | md5e0749f673c5c94db0993a93490091c50 | 2015-04-29 10:59:51.306056</font></div><div><font size="2"   >&nbsp; 6 | table &nbsp; &nbsp; | public &nbsp; | t3 &nbsp; &nbsp; &nbsp; | DROP TABLE | recyclebin &nbsp; | md59ed6eeedce6faf153cb8a006882c8f45 | 2015-04-29 10:59:51.306056</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div></div><div><br></div><div>[其他方法]</div><div>1. hook, 用在执行utility命令时。</div><div><span style="line-height: 28px;"   >图例</span></div><div><div><img title="Can we use event trigger implement like Oracle recycle bin? - Not Now, you can use hook in tcop/utility.h - 德哥@Digoal - PostgreSQL research"   alt="Can we use event trigger implement like Oracle recycle bin? - Not Now, you can use hook in tcop/utility.h - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/A_dq7HU7KtwgZVgIkPSzFw==/2436447398425581675.png"   ></div><br></div><div>钩子代码：</div><div>src/backend/tcop/utility.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; 70 /* Hook for plugins to get control in ProcessUtility() */</font></div><div><font size="2"   >&nbsp; 71 ProcessUtility_hook_type ProcessUtility_hook = NULL;</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >&nbsp;273 /*</font></div><div><font size="2"   >&nbsp;274 &nbsp;* ProcessUtility</font></div><div><font size="2"   >&nbsp;275 &nbsp;* &nbsp; &nbsp; &nbsp;general utility function invoker</font></div><div><font size="2"   >&nbsp;276 &nbsp;*</font></div><div><font size="2"   >&nbsp;277 &nbsp;* &nbsp;parsetree: the parse tree for the utility statement</font></div><div><font size="2"   >&nbsp;278 &nbsp;* &nbsp;queryString: original source text of command</font></div><div><font size="2"   >&nbsp;279 &nbsp;* &nbsp;context: identifies source of statement (toplevel client command,</font></div><div><font size="2"   >&nbsp;280 &nbsp;* &nbsp; &nbsp; &nbsp;non-toplevel client command, subcommand of a larger utility command)</font></div><div><font size="2"   >&nbsp;281 &nbsp;* &nbsp;params: parameters to use during execution</font></div><div><font size="2"   >&nbsp;282 &nbsp;* &nbsp;dest: where to send results</font></div><div><font size="2"   >&nbsp;283 &nbsp;* &nbsp;completionTag: points to a buffer of size COMPLETION_TAG_BUFSIZE</font></div><div><font size="2"   >&nbsp;284 &nbsp;* &nbsp; &nbsp; &nbsp;in which to store a command completion status string.</font></div><div><font size="2"   >&nbsp;285 &nbsp;*</font></div><div><font size="2"   >&nbsp;286 &nbsp;* Notes: as of PG 8.4, caller MUST supply a queryString; it is not</font></div><div><font size="2"   >&nbsp;287 &nbsp;* allowed anymore to pass NULL. &nbsp;(If you really don't have source text,</font></div><div><font size="2"   >&nbsp;288 &nbsp;* you can pass a constant string, perhaps "(query not available)".)</font></div><div><font size="2"   >&nbsp;289 &nbsp;*</font></div><div><font size="2"   >&nbsp;290 &nbsp;* completionTag is only set nonempty if we want to return a nondefault status.</font></div><div><font size="2"   >&nbsp;291 &nbsp;*</font></div><div><font size="2"   >&nbsp;292 &nbsp;* completionTag may be NULL if caller doesn't want a status string.</font></div><div><font size="2"   >&nbsp;293 &nbsp;*/</font></div><div><font size="2"   >&nbsp;294 void</font></div><div><font size="2"   >&nbsp;295 ProcessUtility(Node *parsetree,</font></div><div><font size="2"   >&nbsp;296 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;const char *queryString,</font></div><div><font size="2"   >&nbsp;297 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ProcessUtilityContext context,</font></div><div><font size="2"   >&nbsp;298 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ParamListInfo params,</font></div><div><font size="2"   >&nbsp;299 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DestReceiver *dest,</font></div><div><font size="2"   >&nbsp;300 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;char *completionTag)</font></div><div><font size="2"   >&nbsp;301 {</font></div><div><font size="2"   >&nbsp;302 &nbsp; &nbsp; Assert(queryString != NULL); &nbsp; &nbsp;/* required as of 8.4 */</font></div><div><font size="2"   >&nbsp;303&nbsp;</font></div><div><font size="2"   >&nbsp;304 &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp;305 &nbsp; &nbsp; &nbsp;* We provide a function hook variable that lets loadable plugins get</font></div><div><font size="2"   >&nbsp;306 &nbsp; &nbsp; &nbsp;* control when ProcessUtility is called. &nbsp;Such a plugin would normally</font></div><div><font size="2"   >&nbsp;307 &nbsp; &nbsp; &nbsp;* call standard_ProcessUtility().</font></div><div><font size="2"   >&nbsp;308 &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp;309 &nbsp; &nbsp; if (ProcessUtility_hook)</font></div><div><font size="2"   >&nbsp;310 &nbsp; &nbsp; &nbsp; &nbsp; (*ProcessUtility_hook) (parsetree, queryString,</font></div><div><font size="2"   >&nbsp;311 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; context, params,</font></div><div><font size="2"   >&nbsp;312 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dest, completionTag);</font></div><div><font size="2"   >&nbsp;313 &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp;314 &nbsp; &nbsp; &nbsp; &nbsp; standard_ProcessUtility(parsetree, queryString,</font></div><div><font size="2"   >&nbsp;315 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; context, params,</font></div><div><font size="2"   >&nbsp;316 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dest, completionTag);</font></div><div><font size="2"   >&nbsp;317 }</font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   >利用这个钩子的例子：</span></div><div><a target="_blank" rel="nofollow" href="https://github.com/petere/pgtrashcan"   >https://github.com/petere/pgtrashcan</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014339374747"   >http://blog.163.com/digoal@126/blog/static/1638770402014339374747</a></div><div>钩子例子截取自pgtrashcan：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#if PG_VERSION_NUM &gt;= 90300</font></div><div><font size="2"   >static void</font></div><div><font size="2"   >pgtrashcan_ProcessUtility(Node *parsetree,</font></div><div><font size="2"   ><span>						</span> &nbsp;const char *queryString,</font></div><div><font size="2"   ><span>						</span> &nbsp;ProcessUtilityContext context,</font></div><div><font size="2"   ><span>						</span> &nbsp;ParamListInfo params,</font></div><div><font size="2"   ><span>						</span> &nbsp;DestReceiver *dest,</font></div><div><font size="2"   ><span>						</span> &nbsp;char *completionTag)</font></div><div><font size="2"   >#else</font></div><div><font size="2"   >static void</font></div><div><font size="2"   >pgtrashcan_ProcessUtility(Node *parsetree,</font></div><div><font size="2"   ><span>						</span> &nbsp;const char *queryString,</font></div><div><font size="2"   ><span>						</span> &nbsp;ParamListInfo params,</font></div><div><font size="2"   ><span>						</span> &nbsp;bool isTopLevel,</font></div><div><font size="2"   ><span>						</span> &nbsp;DestReceiver *dest,</font></div><div><font size="2"   ><span>						</span> &nbsp;char *completionTag)</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   >{</font></div><div><font size="2"   ><span>	</span>if (nodeTag(parsetree) == T_DropStmt)</font></div><div><font size="2"   ><span>	</span>{</font></div><div><font size="2"   ><span>		</span>DropStmt *stmt = (DropStmt *) parsetree;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span>		</span>if (stmt-&gt;removeType == OBJECT_TABLE)</font></div><div><font size="2"   ><span>		</span>{</font></div><div><font size="2"   ><span>			</span>RangeVar *r;</font></div><div><font size="2"   ><span>			</span>AlterObjectSchemaStmt *newstmt = makeNode(AlterObjectSchemaStmt);</font></div><div><font size="2"   ><span>			</span>newstmt-&gt;objectType = stmt-&gt;removeType;</font></div><div><font size="2"   ><span>			</span>newstmt-&gt;newschema = pstrdup(trashcan_nspname); &nbsp; // 重设SCHEMA</font></div><div><font size="2"   >#if PG_VERSION_NUM &gt;= 90200</font></div><div><font size="2"   ><span>			</span>newstmt-&gt;missing_ok = stmt-&gt;missing_ok;</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   ><span>			</span>if (stmt-&gt;behavior != DROP_RESTRICT)</font></div><div><font size="2"   ><span>			</span>ereport(ERROR,</font></div><div><font size="2"   ><span>					</span>(errcode(ERRCODE_FEATURE_NOT_SUPPORTED),</font></div><div><font size="2"   ><span>					</span> errmsg("trash can does not support DROP CASCADE")));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span>			</span>r = makeRangeVarFromAnyName(linitial(stmt-&gt;objects));</font></div><div><font size="2"   ><span>			</span>r-&gt;inhOpt = INH_YES;</font></div><div><font size="2"   ><span>			</span>r-&gt;alias = NULL;</font></div><div><font size="2"   ><span>			</span>newstmt-&gt;relation = r;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span>			</span>if (!r-&gt;schemaname || strcmp(r-&gt;schemaname, trashcan_nspname) != 0)</font></div><div><font size="2"   ><span>			</span>{</font></div><div><font size="2"   ><span>				</span>parsetree = (Node *) newstmt;</font></div><div><font size="2"   ><span>				</span>create_trashcan_schema();</font></div><div><font size="2"   ><span>			</span>}</font></div><div><font size="2"   ><span>		</span>}</font></div><div><font size="2"   ><span>	</span>}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#if PG_VERSION_NUM &gt;= 90300</font></div><div><font size="2"   ><span>	</span>(*prev_ProcessUtility) (parsetree, queryString,<span>	</span>context, params, dest, completionTag);&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; // 传送至PG&nbsp;<span style="line-height: 28px;"   >ProcessUtility@</span><span style="line-height: 28px;"   >src/backend/tcop/utility.c</span></font></div><div><font size="2"   >#else</font></div><div><font size="2"   ><span>	</span>(*prev_ProcessUtility) (parsetree, queryString,<span>	</span>params, isTopLevel, dest, completionTag);</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/functions-event-triggers.html"   >http://www.postgresql.org/docs/devel/static/functions-event-triggers.html</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014339374747"   >http://blog.163.com/digoal@126/blog/static/1638770402014339374747<br></a><span style="line-height: 28px;"   >
</span><a style="line-height: 28px;" rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="Can we use event trigger implement like Oracle recycle bin? - Not Now - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div></div>
	</div>
</div>
</body>
</html>