<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL aggregate function 4 : Hypothetical-Set Aggregate Functions</h2>
	<h5 id="">2015-04-07 14:11:31&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020153713222764/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>本文讲一下聚合函数的最后一个分类,&nbsp;Hypothetical-Set Aggregate Functions.</div><div>这类聚合函数还有对应的窗口函数, 首先来看一下对应窗口函数的用法.</div><div><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: normal; background-color: rgb(224, 236, 239);"   ><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>rank()</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>bigint</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >rank of the current row with gaps; same as&nbsp;<code>row_number</code>&nbsp;of its first peer</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>dense_rank()</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>bigint</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >rank of the current row without gaps; this function counts peer groups</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>percent_rank()</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>double precision</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >relative rank of the current row: (<code>rank</code>&nbsp;- 1) / (total rows - 1)</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>cume_dist()</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>double precision</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >relative rank of the current row: (number of rows preceding or peer with current row) / (total rows)</td></tr></table></div><div>the four ranking functions are defined so that they give the same answer for any two peer rows.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >rank 返回值在分组内的等级, 如果值有重复的话, 跳级处理.</font></div><div><span style="line-height: 28px;"   ><font size="2"   >dense_rank 返回值在分组内的等级, 如果值有重复的话, 不跳级处理.</font></span></div><div><font size="2"   >percent_rank 返回&nbsp;(rank - 1) / (total rows - 1), rank指当前rank值, rows指当前组的记录数</font></div><font size="2"   ><wbr></font><div><font size="2"   >cume_dist 返回(number of rows preceding or peer with current row) / (total rows), 即截至当前记录等级一共有多少行除以本组的总行数.</font></div><p></p></pre></div><div>看一个例子比较明白.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select *,row_number() over(partition by info order by id),rank() over(partition by info order by id),dense_rank() over(partition by info order by id),percent_rank() over(partition by info order by id),cume_dist() over(partition by info order by id) from test;</font></div><div><font size="2"   >&nbsp; id &nbsp;| info &nbsp;| row_number | rank | dense_rank | percent_rank | &nbsp; &nbsp; cume_dist &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------+-------+------------+------+------------+--------------+-------------------</font></div><div><font size="2"   >&nbsp; &nbsp; 1 | test1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | test2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | 0.444444444444444</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | test2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | 0.444444444444444</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | test2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | 0.444444444444444</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | test2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | 0.444444444444444</font></div><div><font size="2"   >&nbsp; &nbsp; 3 | test2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5 | &nbsp; &nbsp;5 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.5 | 0.555555555555556</font></div><div><font size="2"   >&nbsp; &nbsp; 4 | test2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6 | &nbsp; &nbsp;6 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3 | &nbsp; &nbsp; &nbsp; &nbsp;0.625 | 0.666666666666667</font></div><div><font size="2"   >&nbsp; &nbsp; 5 | test2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;7 | &nbsp; &nbsp;7 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 | &nbsp; &nbsp; &nbsp; &nbsp; 0.75 | 0.777777777777778</font></div><div><font size="2"   >&nbsp; &nbsp; 6 | test2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8 | &nbsp; &nbsp;8 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5 | &nbsp; &nbsp; &nbsp; &nbsp;0.875 | 0.888888888888889</font></div><div><font size="2"   >&nbsp; &nbsp; 7 | test2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9 | &nbsp; &nbsp;9 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >&nbsp; &nbsp; 8 | test3 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.5</font></div><div><font size="2"   >&nbsp; 100 | test3 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >&nbsp;1000 | test4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >(13 rows)</font></div><p></p></pre></div><div>算法 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >以info='test2'这个组为例 :&nbsp;</font></div><div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 2 | test2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | 0.444444444444444</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 2 | test2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | 0.444444444444444</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 2 | test2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | 0.444444444444444</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 2 | test2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | 0.444444444444444</font></div></div><div style="line-height: 28px;"   ><font size="2"   >id=2 的 rank和dense_rank都是1.</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >percent_rank 返回&nbsp;(rank - 1) / (total rows - 1), rank指当前rank值, rows指当前组的记录数</font></div><font size="2"   ><wbr style="line-height: 28px;"   ></font><div style="line-height: 28px;"   ><font size="2"   >cume_dist 返回(number of rows preceding or peer with current row) / (total rows), 截至当前记录等级一共有多少行除以本组的总行数.</font></div><div style="line-height: 28px;"   ><font size="2"   >所以</font></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >percent_rank = (1-1)/(9-1)=0</font></span></div><div style="line-height: 28px;"   ><font size="2"   ><span style="line-height: 28px;"   >cume_dist = (4)/(9) =&nbsp;</span><span style="line-height: 28px;"   >0.444444444444444</span></font></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   ><br></font></span></div></div><div><span style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 3 | test2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5 | &nbsp; &nbsp;5 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.5 | 0.555555555555556</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >rank = 5, 跳级</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >dense_rank = 2, 不跳级</font></span></div><div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >percent_rank = (5-1)/(9-1)=0.5</font></span></div><div style="line-height: 28px;"   ><font size="2"   ><span style="line-height: 28px;"   >cume_dist = (5)/(9) =&nbsp;</span><span style="line-height: 28px;"   >0.555555555555556</span></font></div></div><p></p></pre></div><div><br></div><div>接下来回到正题, 我们看看这些窗口函数的另一种用法, 聚合用法.</div><div><p style="font-size: 12.1599998474121px; line-height: 1.5em; margin: 1.2em 0em; font-family: verdana, sans-serif;"   >Each of the aggregates listed in&nbsp;<a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/functions-aggregate.html#FUNCTIONS-HYPOTHETICAL-TABLE"   >Table 9-52</a>&nbsp;is associated with a window function of the same name defined in&nbsp;<a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/functions-window.html"   >Section 9.21</a>. In each case, the aggregate result is the value that the associated window function would have returned for the&nbsp;<span>"hypothetical"</span>&nbsp;row constructed from&nbsp;<tt style="font-style: italic;"   >args</tt>, if such a row had been added to the sorted group of rows computed from the&nbsp;<tt style="font-style: italic;"   >sorted_args</tt>.</p><div style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: normal;"   ><a id="FUNCTIONS-HYPOTHETICAL-TABLE" name="FUNCTIONS-HYPOTHETICAL-TABLE" rel="nofollow"   ></a><p style="font-size: 1em; line-height: 1.5em; margin: 1.2em 0em; font-weight: bold;"   >Table 9-52. Hypothetical-Set Aggregate Functions</p><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; border: 2px solid rgb(167, 198, 223); background-color: rgb(224, 236, 239);"   ><colgroup><col><col><col><col><col><thead><tr><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Function</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Direct Argument Type(s)</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Aggregated Argument Type(s)</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Return Type</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Description</th></tr></thead><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>rank(<tt style="font-style: italic; font-size: 1em;"   >args</tt>) WITHIN GROUP (ORDER BY&nbsp;<tt style="font-style: italic; font-size: 1em;"   >sorted_args</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>VARIADIC</tt>&nbsp;<tt>"any"</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>VARIADIC</tt>&nbsp;<tt>"any"</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>bigint</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >rank of the hypothetical row, with gaps for duplicate rows</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>dense_rank(<tt style="font-style: italic; font-size: 1em;"   >args</tt>) WITHIN GROUP (ORDER BY&nbsp;<tt style="font-style: italic; font-size: 1em;"   >sorted_args</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>VARIADIC</tt>&nbsp;<tt>"any"</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>VARIADIC</tt>&nbsp;<tt>"any"</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>bigint</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >rank of the hypothetical row, without gaps</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>percent_rank(<tt style="font-style: italic; font-size: 1em;"   >args</tt>) WITHIN GROUP (ORDER BY<tt style="font-style: italic; font-size: 1em;"   >sorted_args</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>VARIADIC</tt>&nbsp;<tt>"any"</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>VARIADIC</tt>&nbsp;<tt>"any"</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>double precision</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >relative rank of the hypothetical row, ranging from 0 to 1</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>cume_dist(<tt style="font-style: italic; font-size: 1em;"   >args</tt>) WITHIN GROUP (ORDER BY&nbsp;<tt style="font-style: italic; font-size: 1em;"   >sorted_args</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>VARIADIC</tt>&nbsp;<tt>"any"</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>VARIADIC</tt>&nbsp;<tt>"any"</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>double precision</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >relative rank of the hypothetical row, ranging from 1/<tt style="font-style: italic;"   >N</tt>&nbsp;to 1</td></tr></table></div><p style="font-size: 12.1599998474121px; line-height: 1.5em; margin: 1.2em 0em; font-family: verdana, sans-serif;"   >For each of these hypothetical-set aggregates, the list of direct arguments given in&nbsp;<tt style="font-style: italic;"   >args</tt>&nbsp;must match the number and types of the aggregated arguments given in&nbsp;<tt style="font-style: italic;"   >sorted_args</tt>. Unlike most built-in aggregates, these aggregates are not strict, that is they do not drop input rows containing nulls. Null values sort according to the rule specified in the&nbsp;<tt>ORDER BY</tt>&nbsp;clause.</p></div><div>这些用法比较奇特, 其实是要返回给定参数在集合中的位置.</div><div>例如 &nbsp;:&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >1</font></div><div><font size="2"   >2</font></div><div><font size="2"   >3</font></div><div><font size="2"   >4</font></div><div><font size="2"   >5</font></div><p></p></pre></div><div>如果我们给一个参数值是2.2, 应该排在以上数据中的第三行.</div><div>例子 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select * from test order by info,id;</font></div><div><font size="2"   >&nbsp; id &nbsp;| info &nbsp;</font></div><div><font size="2"   >------+-------</font></div><div><font size="2"   >&nbsp; &nbsp; 1 | test1</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | test2</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | test2</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | test2</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | test2</font></div><div><font size="2"   >&nbsp; &nbsp; 3 | test2</font></div><div><font size="2"   >&nbsp; &nbsp; 4 | test2</font></div><div><font size="2"   >&nbsp; &nbsp; 5 | test2</font></div><div><font size="2"   >&nbsp; &nbsp; 6 | test2</font></div><div><font size="2"   >&nbsp; &nbsp; 7 | test2</font></div><div><font size="2"   >&nbsp; &nbsp; 8 | test3</font></div><div><font size="2"   >&nbsp; 100 | test3</font></div><div><font size="2"   >&nbsp;1000 | test4</font></div><div><font size="2"   >(13 rows)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# select info,rank(4.9) within group (order by id),dense_rank(4.9) within group (order by id) from test group by info;</font></div><div><font size="2"   >&nbsp;info &nbsp;| rank | dense_rank&nbsp;</font></div><div><font size="2"   >-------+------+------------</font></div><div><font size="2"   >&nbsp;test1 | &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >&nbsp;test2 | &nbsp; &nbsp;7 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4</font></div><div><font size="2"   >&nbsp;test3 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >&nbsp;test4 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >(4 rows)</font></div></div><p></p></pre></div><div>4.9在test1这个分组, 排名第2, 并且这个分组只有1个值, 所以没有gap.</div><div>重点关注test2这个组, 这个组有9个值, 其中有4个重复值2, 所以4.9在这里排名需要考虑gap.&nbsp;</div><div>rank 返回7, 即4.9在这里考虑GAP排名第7</div><div><span style="line-height: 28px;"   >dense_rank 返回4,&nbsp;</span><span style="line-height: 28px;"   >即4.9在这里不考虑GAP排名第4.</span></div><div><span style="line-height: 28px;"   >又如 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select info,rank(5) within group (order by id),dense_rank(5) within group (order by id) from test group by info;</font></div><div><font size="2"   >&nbsp;info &nbsp;| rank | dense_rank&nbsp;</font></div><div><font size="2"   >-------+------+------------</font></div><div><font size="2"   >&nbsp;test1 | &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >&nbsp;test2 | &nbsp; &nbsp;7 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4</font></div><div><font size="2"   >&nbsp;test3 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >&nbsp;test4 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >(4 rows)</font></div></div><div><div><font size="2"   >postgres=# select info,rank(5.1) within group (order by id),dense_rank(5.1) within group (order by id) from test group by info;</font></div><div><font size="2"   >&nbsp;info &nbsp;| rank | dense_rank&nbsp;</font></div><div><font size="2"   >-------+------+------------</font></div><div><font size="2"   >&nbsp;test1 | &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >&nbsp;test2 | &nbsp; &nbsp;8 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5</font></div><div><font size="2"   >&nbsp;test3 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >&nbsp;test4 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >(4 rows)</font></div></div><p></p></pre></div><div><br></div><div>最后要看计算0~1代表位置的聚合函数<span style="line-height: 28px;"   >percent_rank和</span><span style="line-height: 28px;"   >cume_dist</span><span style="line-height: 28px;"   >.</span></div><div><span style="line-height: 28px;"   >算法</span></div><div><div style="line-height: 28px;"   >percent_rank 返回 (rank - 1) / (total rows - 1), rank指当前rank值, rows指当前组的记录数</div><div style="line-height: 28px;"   >cume_dist 返回(number of rows preceding or peer with current row) / (total rows), 截至当前记录等级一共有多少行除以本组的总行数.</div></div><div><span style="line-height: 28px;"   >例子1 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select info,rank(4.9) within group (order by id),dense_rank(4.9) within group (order by id),percent_rank(4.9) within group (order by id),cume_dist(4.9) within group (order by id) from test group by info;</font></div><div><font size="2"   >&nbsp;info &nbsp;| rank | dense_rank | &nbsp; percent_rank &nbsp; &nbsp;| &nbsp; &nbsp; cume_dist &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------+------+------------+-------------------+-------------------</font></div><div><font size="2"   >&nbsp;test1 | &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >&nbsp;test2 | &nbsp; &nbsp;7 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 | 0.666666666666667 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.7</font></div><div><font size="2"   >&nbsp;test3 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | 0.333333333333333</font></div><div><font size="2"   >&nbsp;test4 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.5</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div><div>同样以test2为分组, 讲解算法. 把4.9插入到这个分组后. 数据应该变成 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; 2 | test2</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | test2</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | test2</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | test2</font></div><div><font size="2"   >&nbsp; &nbsp; 3 | test2</font></div><div><font size="2"   >&nbsp; &nbsp; 4 | test2</font></div><div><font size="2"   >&nbsp; &nbsp; 4.9 | test2 &nbsp;<span style="line-height: 28px;"   ># 计算位置</span></font></div><div><font size="2"   >&nbsp; &nbsp; 5 | test2</font></div><div><font size="2"   >&nbsp; &nbsp; 6 | test2</font></div><div><font size="2"   >&nbsp; &nbsp; 7 | test2</font></div><p></p></pre></div><div>一共10行.</div><div><div>percent_rank 返回 (rank - 1) / (total rows - 1), rank指当前rank值, rows指当前组的记录数</div><div>cume_dist 返回(number of rows preceding or peer with current row) / (total rows), 截至当前记录等级一共有多少行除以本组的总行数.</div></div><div>所以4.9对应的<span style="line-height: 28px;"   >percent_rank 和&nbsp;</span><span style="line-height: 28px;"   >cume_dist 分别为 :&nbsp;</span></div><div><span style="line-height: 28px;"   >percent_rank =&nbsp;</span><span style="line-height: 28px;"   >(rank - 1) / (total rows - 1) = (7-1)/(10-1) =&nbsp;</span><span style="line-height: 28px;"   >0.666666666666667</span><span style="line-height: 28px;"   >&nbsp;</span></div><div><span style="line-height: 28px;"   >cume_dist = (7)/10 = 0.7</span></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >例子2 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select info,rank(5) within group (order by id),dense_rank(5) within group (order by id),percent_rank(5) within group (order by id),cume_dist(5) within group (order by id) from test group by info;</font></div><div><font size="2"   >&nbsp;info &nbsp;| rank | dense_rank | &nbsp; percent_rank &nbsp; &nbsp;| &nbsp; &nbsp; cume_dist &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------+------+------------+-------------------+-------------------</font></div><div><font size="2"   >&nbsp;test1 | &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >&nbsp;test2 | &nbsp; &nbsp;7 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 | 0.666666666666667 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.8</font></div><div><font size="2"   >&nbsp;test3 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | 0.333333333333333</font></div><div><font size="2"   >&nbsp;test4 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.5</font></div><div><font size="2"   >(4 rows)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >插入计算值5后, 数据变成</font></div><div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 2 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 2 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 2 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 2 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 3 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 4 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 5 | test2 &nbsp;# 计算位置, 即参数值</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 5 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 6 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 7 | test2</font></div></div><p></p></pre></div><div style="line-height: 28px;"   >依旧10行. 但是<span style="line-height: 28px;"   >截至当前记录等级一共有多少行? 注意是8了.</span></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >percent_rank =&nbsp;</span><span style="line-height: 28px;"   >(rank - 1) / (total rows - 1) = (7-1)/(10-1) =&nbsp;</span><span style="line-height: 28px;"   >0.666666666666667</span><span style="line-height: 28px;"   >&nbsp;</span></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >cume_dist = (8)/10 = 0.8</span></div></div><div><br></div><div><span style="line-height: 28px;"   >例子3 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select info,rank(5.1) within group (order by id),dense_rank(5.1) within group (order by id),percent_rank(5.1) within group (order by id),cume_dist(5.1) within group (order by id) from test group by info;</font></div><div><font size="2"   >&nbsp;info &nbsp;| rank | dense_rank | &nbsp; percent_rank &nbsp; &nbsp;| &nbsp; &nbsp; cume_dist &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------+------+------------+-------------------+-------------------</font></div><div><font size="2"   >&nbsp;test1 | &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >&nbsp;test2 | &nbsp; &nbsp;8 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5 | 0.777777777777778 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.8</font></div><div><font size="2"   >&nbsp;test3 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | 0.333333333333333</font></div><div><font size="2"   >&nbsp;test4 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.5</font></div><div><font size="2"   >(4 rows)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >插入计算值5.1后, 数据变成 :&nbsp;</font></div><div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 2 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 2 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 2 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 2 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 3 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 4 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 5 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 5.1 | test2 &nbsp;<span style="line-height: 28px;"   ># 计算位置, 即参数值</span></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 6 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 7 | test2</font></div></div><p></p></pre></div><div style="line-height: 28px;"   >结果自己验证吧.</div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >例子4 :&nbsp;</span></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >postgres=# select info,rank(5) within group (order by id desc),dense_rank(5) within group (order by id desc),percent_rank(5) within group (order by id desc),cume_dist(5) within group (order by id desc) from test group by info;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;info &nbsp;| rank | dense_rank | &nbsp; percent_rank &nbsp; &nbsp;| cume_dist&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >-------+------+------------+-------------------+-----------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;test1 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; 0.5</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;test2 | &nbsp; &nbsp;3 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3 | 0.222222222222222 | &nbsp; &nbsp; &nbsp; 0.4</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;test3 | &nbsp; &nbsp;3 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;test4 | &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div style="line-height: 28px;"   ><font size="2"   >(4 rows)</font></div><p></p></pre></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >插入计算值5后, 数据变成 :&nbsp;</span></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 7 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 6 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 5 | test2 &nbsp;# 注意, 这才是计算位置, 即插入位置.</font></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 5 | test2</font></span></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 4 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 3 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 2 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 2 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 2 | test2</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 2 | test2</font></div><p></p></pre></div></div></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >结果自己验证吧.</span></div><div style="line-height: 28px;"   ><br></div></div>[参考]<div>1.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020152223539859/"   >http://blog.163.com/digoal@126/blog/static/16387704020152223539859/</a></div><div>2.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402015224124337/"   >http://blog.163.com/digoal@126/blog/static/1638770402015224124337/</a></div><div>3.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402015379286873/"   >http://blog.163.com/digoal@126/blog/static/1638770402015379286873/</a></div><div>4.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/functions-window.html"   >http://www.postgresql.org/docs/devel/static/functions-window.html</a></div><div>5.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/functions-aggregate.html"   >http://www.postgresql.org/docs/devel/static/functions-aggregate.html</a></div><div><br></div><div><wbr><a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL aggregate function 4 : Hypothetical-Set Aggregate Functions - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a><br></div></div>
	</div>
</div>
</body>
</html>