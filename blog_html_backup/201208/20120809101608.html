<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">struct vs union</h2>
	<h5 id="">2012-08-09 10:16:08&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020127983113536/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">从定义上来看struct和union定义的风格都差不多.<wbr><div>但是union只能存储一个元素, 与struct 一样也是固定长度. 长度取决于union中定义的所有ITEM中占用空间最大的那个.</div><div>为什么C这么多固定长度的东西呢, 原因是指针, 如果不定长, 存储这些类型的数组及数组型指针将使用起来非常困难. 因为需要定长, 地址运算的时候才比较方便. 如char a[10], a+1 地址加1字节. int a[10], a+1 则地址加4字节. 如果使用下面这个union 定义的 test a[10], a+1 地址加104字节. 如果不是定长, 那就不好搞了.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >typedef union test {</font></div><div><font size="2"  >&nbsp; int a;</font></div><div><font size="2"  >&nbsp; long b;</font></div><div><font size="2"  >&nbsp; float c;</font></div><div><font size="2"  >&nbsp; short d;</font></div><div><font size="2"  >&nbsp; char a[100];</font></div><div><font size="2"  >} test;</font></div><div><font size="2"  >这个union的长度取决于a[100], 理论上应该是100, 但是由于alignment, 需要一些pad空间, 所以是104.</font></div><p></p></pre></div><div>例如 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 ~]# cat f.c</font></div><div><font size="2"  >#include &lt;stdio.h&gt;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >typedef union test {</font></div><div><font size="2"  >&nbsp; int a;</font></div><div><font size="2"  >&nbsp; long b;</font></div><div><font size="2"  >&nbsp; float c;</font></div><div><font size="2"  >&nbsp; short d;</font></div><div><font size="2"  >&nbsp; char e[100];</font></div><div><font size="2"  >} test;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >int main() {</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "sizeof(test):%lu\n", sizeof(test));</font></div><div><font size="2"  >&nbsp; return 0;</font></div><div><font size="2"  >}</font></div><div><font size="2"  >结果</font></div><div><font size="2"  >[root@db-172-16-3-150 ~]# gcc -g ./f.c -o f &amp;&amp; ./f</font></div><div><font size="2"  >sizeof(test):104</font></div><p></p></pre></div><div><br></div><div>union用在什么场景呢? 例如要存储一个数量, 可能是个数(int), 也可能是重量(float), 也可能是体积(float).</div><div>如下面的例子 :&nbsp;</div><div><br></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 ~]# cat e.c</font></div><div><font size="2"  >#include &lt;stdio.h&gt;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >typedef union quantity {</font></div><div><font size="2"  >&nbsp; int count;</font></div><div><font size="2"  >&nbsp; float kg;</font></div><div><font size="2"  >&nbsp; float ml;</font></div><div><font size="2"  >} quantity;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >typedef struct goods {</font></div><div><font size="2"  >&nbsp; const char *name;</font></div><div><font size="2"  >&nbsp; const char *country;</font></div><div><font size="2"  >&nbsp; quantity amount;</font></div><div><font size="2"  >} goods;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >int main() {</font></div><div><font size="2"  >&nbsp; goods apple = {"apple", "china", {.kg = 10}};</font></div><div><font size="2"  >&nbsp; goods watermelon = {"watermelon", "china", {5}};</font></div><div><font size="2"  >&nbsp; goods mango = {"mango", "china", {.kg = 6}};</font></div><div><font size="2"  >&nbsp; goods wine = {"wine", "franch", {.ml=10000}};</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "apple.amount.kg:%f, watermelon.amount.count:%i, mango.amount.kg:%f, wine.amount.ml:%f\n", apple.amount.kg, watermelon.amount.count, mango.amount.kg, wine.amount.ml);</font></div><div><font size="2"  >&nbsp; // 如果把wine.amount改成count存储, 那读取的时候也要修改. wine.amount.count, 输出为%i.&nbsp;</font></div><div><font size="2"  >&nbsp; wine.amount.count=999;</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "apple.amount.kg:%f, watermelon.amount.count:%i, mango.amount.kg:%f, wine.amount.count:%i\n", apple.amount.kg, watermelon.amount.count, mango.amount.kg, wine.amount.count);</font></div><div><font size="2"  >&nbsp; wine.amount.kg=888.88;</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "apple.amount.kg:%f, watermelon.amount.count:%i, mango.amount.kg:%f, wine.amount.ml:%f\n", apple.amount.kg, watermelon.amount.count, mango.amount.kg, wine.amount.kg);</font></div><div><font size="2"  >&nbsp; wine.amount.ml=777.77;</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "apple.amount.kg:%f, watermelon.amount.count:%i, mango.amount.kg:%f, wine.amount.ml:%f\n", apple.amount.kg, watermelon.amount.count, mango.amount.kg, wine.amount.ml);</font></div><div><font size="2"  >&nbsp; return 0;</font></div><div><font size="2"  >}</font></div><div><font size="2"  >结果 :&nbsp;</font></div><div><font size="2"  >[root@db-172-16-3-150 ~]# gcc -O3 -Wall -Wextra -Werror -g ./e.c -o e &amp;&amp; ./e</font></div><div><font size="2"  >apple.amount.kg:10.000000, watermelon.amount.count:5, mango.amount.kg:6.000000, wine.amount.ml:10000.000000</font></div><div><font size="2"  >apple.amount.kg:10.000000, watermelon.amount.count:5, mango.amount.kg:6.000000, wine.amount.count:999</font></div><div><font size="2"  >apple.amount.kg:10.000000, watermelon.amount.count:5, mango.amount.kg:6.000000, wine.amount.ml:888.880005</font></div><div><font size="2"  >apple.amount.kg:10.000000, watermelon.amount.count:5, mango.amount.kg:6.000000, wine.amount.ml:777.770020</font></div><p></p></pre></div><div><br></div><div>使用union 一个需要注意的地方是, 没有地方跟踪你存储的到底是哪个类型, 如这个union里面包含了int, float, short. 怎么知道我存储的到底是什么类型呢, 如果存储的是int, 但是使用float去格式化输出肯定是有问题的, 结果不可预期.</div><div><br></div><div>使用enum 枚举来判别用的union里面的什么类型是一个比较好的方法.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 ~]# cat f.c</font></div><div><font size="2"  >#include &lt;stdio.h&gt;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >typedef enum unit_of_measure {</font></div><div><font size="2"  >&nbsp; COUNT, KG, ML</font></div><div><font size="2"  >} unit_of_measure;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >typedef union quantity {</font></div><div><font size="2"  >&nbsp; short count;</font></div><div><font size="2"  >&nbsp; float weight;</font></div><div><font size="2"  >&nbsp; float volume;</font></div><div><font size="2"  >} quantity;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >typedef struct fruit_order {</font></div><div><font size="2"  >&nbsp; const char *name;</font></div><div><font size="2"  >&nbsp; const char *country;</font></div><div><font size="2"  >&nbsp; quantity amount;</font></div><div><font size="2"  >&nbsp; unit_of_measure units;</font></div><div><font size="2"  >} fruit_order;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >void display(const fruit_order * order) {</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "This order contains ");</font></div><div><font size="2"  >&nbsp; if (order-&gt;units == ML)&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; fprintf(stdout, "%2.2f ml of %s\n", order-&gt;amount.volume, order-&gt;name);</font></div><div><font size="2"  >&nbsp; else if (order-&gt;units == KG)</font></div><div><font size="2"  >&nbsp; &nbsp; fprintf(stdout, "%2.2f kg of %s\n", order-&gt;amount.weight, order-&gt;name);</font></div><div><font size="2"  >&nbsp; else</font></div><div><font size="2"  >&nbsp; &nbsp; fprintf(stdout, "%i %s\n", order-&gt;amount.count, order-&gt;name);</font></div><div><font size="2"  >}</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >int main() {</font></div><div><font size="2"  >&nbsp; fruit_order apples = {"apples", "china", .amount.count=188, COUNT};</font></div><div><font size="2"  >&nbsp; fruit_order wines = {"wines", "franch", {.volume=650.0}, ML};</font></div><div><font size="2"  >&nbsp; fruit_order mangos = {"mangos", "china", .amount.weight=7.6, KG};</font></div><div><font size="2"  >&nbsp; display(&amp;apples);</font></div><div><font size="2"  >&nbsp; display(&amp;wines);</font></div><div><font size="2"  >&nbsp; display(&amp;mangos);</font></div><div><font size="2"  >&nbsp; return 0;</font></div><div><font size="2"  >}</font></div><div><font size="2"  >结果 :&nbsp;</font></div><div><font size="2"  >[root@db-172-16-3-150 ~]# gcc -O3 -Wall -Wextra -Werror -g ./f.c -o f &amp;&amp; ./f</font></div><div><font size="2"  >This order contains 188 apples</font></div><div><font size="2"  >This order contains 650.00 ml of wines</font></div><div><font size="2"  >This order contains 7.60 kg of mangos</font></div><p></p></pre></div><div><br></div><div>其他 :&nbsp;</div><div>1. &nbsp;type name 与 struct name, enum name, union name</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >typedef struct fish {</font></div><div><font size="2"  >&nbsp; int age;</font></div><div><font size="2"  >&nbsp; float weight;</font></div><div><font size="2"  >&nbsp; char * name;</font></div><div><font size="2"  >} fish;</font></div><div><font size="2"  >其中strunt name 指的是struct fish这里定义的fish.</font></div><div><font size="2"  >type name 指的是最后一行的fish.</font></div><div><font size="2"  >struct name 和 type name 可以不一样. 也可以一样.</font></div><div><font size="2"  >如果上面的定义改成 :&nbsp;</font></div><div><font size="2"  >struct fish&nbsp;<span style="line-height: 22px;"  >{</span></font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; int age;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; float weight;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; char * name;</font></div><div style="line-height: 22px;"  ><font size="2"  >};</font></div><div style="line-height: 22px;"  ><font size="2"  >那么就没有type name.</font></div><div style="line-height: 22px;"  ><font size="2"  >如果没有type name , 定义变量时必须写成这样 : struct fish f1 = {.....};</font></div><div style="line-height: 22px;"  ><font size="2"  >如果有type name, 那么定义变量可以写成fish f1 = {.....}; &nbsp;(注意这里的fish是type name)</font></div><p></p></pre></div><div style="line-height: 22px;"  ><br></div><div style="line-height: 22px;"  >2. 赋值</div><div style="line-height: 22px;"  >struct :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >struct fish&nbsp;<span style="line-height: 22px;"  >{</span></font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; int age;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; float weight;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; char * name;</font></div><div style="line-height: 22px;"  ><font size="2"  >};</font></div><div style="line-height: 22px;"  ><font size="2"  >// 定义变量的时候赋值struct fish f1 = {10, 5.6, "linux"};</font></div><div style="line-height: 22px;"  ><font size="2"  >// 或者写成{.age = 10, .weight=5.6, .name="linux"};</font></div><div style="line-height: 22px;"  ><font size="2"  >// 定义完变量再赋值</font></div><div style="line-height: 22px;"  ><font size="2"  >// f1.age=10;</font></div><div style="line-height: 22px;"  ><font size="2"  >// f1.weight=5.6;</font></div><div style="line-height: 22px;"  ><font size="2"  >// f1.name = "linux";</font></div><p></p></pre></div><div style="line-height: 22px;"  ><br></div></div><div style="line-height: 22px;"  >enum :&nbsp;</div><div style="line-height: 22px;"  >与上面类似.</div><div style="line-height: 22px;"  ><br></div><div style="line-height: 22px;"  >union :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >与上面类似, 唯一的不同是.</font></div><div style="line-height: 22px;"  ><font size="2"  >union a {</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; int count;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; float weight;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; float volumn;</font></div><div style="line-height: 22px;"  ><font size="2"  >};</font></div><div style="line-height: 22px;"  ><font size="2"  >union a a1 = {1.5};</font></div><div style="line-height: 22px;"  ><font size="2"  >这个1.5 是union 的第一个元素count的值.</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>