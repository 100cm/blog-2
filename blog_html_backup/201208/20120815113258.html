<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">static and dynamic libraries</h2>
	<h5 id="">2012-08-15 11:32:58&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020127158102358/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><font face="宋体"  >在将一堆c文件生成二进制可执行文件时, 有4个阶段, 最后一个阶段是link阶段, 这其实不是gcc做的事情(gcc只是一个compiler), 而是linker做的, 在linux里面是ld命令 . gcc调用ld去将object file link输出到bin file的. ld是隐藏在幕后干活的.</font></div><div><font face="宋体"  ><br></font></div><div><font face="宋体"  >static library(linux中可以使用ar将对象文件归档到静态库里面,&nbsp;</font><span style="font-family: 宋体; line-height: 22px;"  >文件名</span><span style="font-family: 宋体;"  >以lib开头, .a结尾) :&nbsp;</span></div><div><font face="宋体"  >在link过程,使用静态库的话,在.a文件中需要用到的object file将打包到二进制文件中. 没有用到的object file不会link进去.</font></div><div><div><img title="static and dynamic libraries - 德哥@Digoal - The Heart,The World."  alt="static and dynamic libraries - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img4.ph.126.net/VsR0u_Z8RlocTjynVZJ7kg==/2604487959521470204.jpg"  ></div>&nbsp;</div><div><font face="宋体"  ><br></font></div><div><font face="宋体"  >dynamic library(linux中称为shared object, 使用gcc -shared 将object file(s)打包到so文件. 文件名</font><span style="font-family: 宋体; line-height: 22px;"  >以lib开头, .</span><span style="font-family: 宋体;"  >so结尾.) :&nbsp;</span></div><div><font face="宋体"  >在link过程不会把对象文件合并到bin文件, 而只是放置占位符, 当程序执行的时候, 再加载相关的对象文件.</font></div><div><div><img title="static and dynamic libraries - 德哥@Digoal - The Heart,The World."  alt="static and dynamic libraries - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img7.ph.126.net/r_vA-Yn0I6SV101uqSch4Q==/6597347943098803347.jpg"  ></div><div><br></div><div><img title="static and dynamic libraries - 德哥@Digoal - The Heart,The World."  alt="static and dynamic libraries - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img4.ph.126.net/YoFtmlNtBcN31LKai7XWcA==/42784196477839404.jpg"  ></div>&nbsp;&nbsp;</div><div><span style="font-family: 宋体;"  >编译时用到静态库的程序拷贝到其他机器上使用时不会因为缺少对象文件而异常。 用到动态库的, 把程序拷贝到其他机器上同时还需要把so文件拷贝过去, 否则不能使用.&nbsp;</span></div><div><font face="宋体"  >动态库的好处是, 当用到的动态库需要变更时, 不需要重新编译程序, 只需要替换so 文件即可. 另外, 对于比较大的程序, 更适合使用动态库, 因为编译的程序文件不会太大.</font></div><div><font face="宋体"  ><br></font></div><div><font face="宋体"  >【创建】</font></div><div><font face="宋体"  >1. 静态库 :&nbsp;</font></div><div><font face="宋体"  >c文件 :&nbsp;</font></div><div><font face="宋体"  ><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 zzz]# cat a.c</font></div><div><font size="2"  >#include &lt;stdio.h&gt;</font></div><div><font size="2"  >#include "a.h"</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >void display() {</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "this is display function in a.c\n");</font></div><div><font size="2"  >}</font></div><p></p></pre></div><div>头文件 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 zzz]# cat a.h</font></div><div><font size="2"  >void display();</font></div><p></p></pre></div><div>生成静态库 :&nbsp;</div><div>首先要生成object file.</div><div><pre class="prettyprint"  ><p><font size="2"  >[root@db-172-16-3-150 zzz]# gcc -O3 -Wall -Wextra -Werror -g -c ./a.c -o a.o</font></p></pre></div><div><div>gcc 简述 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >DESCRIPTION</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;When you invoke GCC, it normally does preprocessing, compilation, assembly and linking. &nbsp;The "overall options"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;allow you to stop this process at an intermediate stage. &nbsp;For example, the -c option says not to run the</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;linker. &nbsp;Then the output consists of object files output by the assembler.</font></div><p></p></pre></div></div></font></div><div><font face="宋体"  >这里使用了-c , 所以输出的是对象文件, 没有去调用linker(ld).</font></div><div><font face="宋体"  ><br></font></div><div><font face="宋体"  >接下来要把object file a.o打包到静态库liba.a, 注意命名规则 :&nbsp;</font></div><div><pre class="prettyprint"  ><p><font size="2"  >[root@db-172-16-3-150 zzz]# ar -rcs liba.a ./a.o</font></p></pre></div><div><font face="宋体"  >查看这个静态库文件包含了哪些对象文件：</font></div><div><font face="宋体"  ><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 zzz]# ar -t liba.a&nbsp;</font></div><div><font size="2"  >a.o</font></div><p></p></pre></div><div>查看liba.a静态库文件里面的symbols :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 zzz]# nm liba.a&nbsp;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >a.o:</font></div><div><font size="2"  >0000000000000000 T display &nbsp; // 这个是display函数</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;U fwrite</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;U stdout</font></div><p></p></pre></div></font></div><div><font face="宋体"  ><br></font></div><div><span style="font-family: 宋体;"  >2. 动态库 :&nbsp;</span></div><div><span style="font-family: 宋体;"  >与静态库不一样的地方, 创建object file时需要加-fPIC 参数.</span></div><div><font face="宋体"  >PIC是position-independent code的缩写, 为什么要这么做呢? 原因是和操作系统加载动态库的方式有关, 如果程序调用动态库时内核不是将动态库加载到内存, 而程序要通过offset去获取动态库中的代码段时, 可能会有问题, PIC是要解决这个问题的。</font></div><div><span style="font-family: 宋体;"  >如下 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font face="宋体"  size="1"  >&nbsp; &nbsp; &nbsp; &nbsp;-fpic</font></div><div><font face="宋体"  size="1"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Generate position-independent code (PIC) suitable for use in a shared library, if supported for the target</font></div><div><font face="宋体"  size="1"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;machine. &nbsp;Such code accesses all constant addresses through a global offset table (GOT). &nbsp;The dynamic</font></div><div><font face="宋体"  size="1"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;loader resolves the GOT entries when the program starts (the dynamic loader is not part of GCC; it is part</font></div><div><font face="宋体"  size="1"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;of the operating system). &nbsp;If the GOT size for the linked executable exceeds a machine-specific maximum</font></div><div><font face="宋体"  size="1"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;size, you get an error message from the linker indicating that -fpic does not work; in that case, recompile</font></div><div><font face="宋体"  size="1"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;with -fPIC instead. &nbsp;(These maximums are 8k on the SPARC and 32k on the m68k and RS/6000. &nbsp;The 386 has no</font></div><div><font face="宋体"  size="1"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;such limit.)</font></div><div><font face="宋体"  size="1"  ><br></font></div><div><font face="宋体"  size="1"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Position-independent code requires special support, and therefore works only on certain machines. &nbsp;For the</font></div><div><font face="宋体"  size="1"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;386, GCC supports PIC for System V but not for the Sun 386i. &nbsp;Code generated for the IBM RS/6000 is always</font></div><div><font face="宋体"  size="1"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;position-independent.</font></div><div><font face="宋体"  size="1"  ><br></font></div><div><font face="宋体"  size="1"  >&nbsp; &nbsp; &nbsp; &nbsp;-fPIC</font></div><div><font face="宋体"  size="1"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;If supported for the target machine, emit position-independent code, suitable for dynamic linking and</font></div><div><font face="宋体"  size="1"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;avoiding any limit on the size of the global offset table. &nbsp;This option makes a difference on the m68k,</font></div><div><font face="宋体"  size="1"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PowerPC and SPARC.</font></div><div><font face="宋体"  size="1"  ><br></font></div><div><font face="宋体"  size="1"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Position-independent code requires special support, and therefore works only on certain machines.</font></div><p></p></pre></div><div><font face="宋体"  >接下来创建object file :&nbsp;</font></div><div><font face="宋体"  >c文件 :&nbsp;</font></div><div><font face="宋体"  ><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 zzz]# cat a.c</font></div><div><font size="2"  >#include &lt;stdio.h&gt;</font></div><div><font size="2"  >#include "a.h"</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >void display() {</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "this is display function in a.c\n");</font></div><div><font size="2"  >}</font></div><p></p></pre></div><div>头文件 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 zzz]# cat a.h</font></div><div><font size="2"  >void display();</font></div><p></p></pre></div><div>生成object file :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >[root@db-172-16-3-150 zzz]# gcc -O3 -Wall -Wextra -Werror -g -fPIC -c ./a.c -o a.o</font></p></pre></div></font></div><div><span style="font-family: 宋体;"  >这个object file 也可以直接使用 :&nbsp;</span></div><div><font face="宋体"  ><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 zzz]# gcc -O3 -Wall -Wextra -Werror -g ./b.c a.o -o b</font></div><div><div><font size="2"  >[root@db-172-16-3-150 zzz]# ./b</font></div><div><font size="2"  >this is display function in a.c</font></div></div><p></p></pre></div><div><br></div><div>接下来就生成<span style="line-height: 22px;"  >包含a.o的</span>动态库文件liba.so吧 :&nbsp;</div><div>如果生成a.o时未加-fPIC, 创建liba.so将报错 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >[root@db-172-16-3-150 zzz]# gcc -O3 -Wall -Wextra -Werror -g -shared a.o -o liba.so</font></div><div><font size="2"  >/usr/bin/ld: a.o: relocation R_X86_64_32 against `a local symbol' can not be used when making a shared object; recompile with -fPIC</font></div><div><font size="2"  >a.o: could not read symbols: Bad value</font></div><div><font size="2"  >collect2: ld returned 1 exit status</font></div></div><div><font size="2"  >所以必须加上-fPIC :&nbsp;</font></div><div><div><font size="2"  >[root@db-172-16-3-150 zzz]# gcc -O3 -Wall -Wextra -Werror -g -fPIC -c ./a.c -o a.o</font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# gcc -O3 -Wall -Wextra -Werror -g -shared a.o -o liba.so</font></div></div><p></p></pre></div><div><br></div></font></div><div><font face="宋体"  >【命名规则】</font></div><div><font face="宋体"  >静态库 :&nbsp;</font></div><div><font face="宋体"  >lib?.a</font></div><div><font face="宋体"  >动态库 :&nbsp;</font></div><div><font face="宋体"  >lib?.so</font></div><div><div><img title="static and dynamic libraries - 德哥@Digoal - The Heart,The World."  alt="static and dynamic libraries - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img8.ph.126.net/KS-gJ5DmmR9asUUNPP6iyg==/3092565569137750588.jpg"  ></div>&nbsp;</div><div><font face="宋体"  ><br></font></div><div><font face="宋体"  >【使用】</font></div><div><font face="宋体"  >不管是动态还是静态库, 编译时都是使用 "-L目录名" "-l库名"&nbsp;</font></div><div><font face="宋体"  >如果库文件放在系统的库文件目录中(如/usr/lib), 则不需要使用</font><span style="font-family: 宋体; line-height: 22px;"  >"-L目录名"指出这个库文件在哪里.</span></div><div><span style="font-family: 宋体; line-height: 22px;"  >或者配置LD_LIBRARY_PATH(linux)或PATH(windows)</span></div><div><div><img title="static and dynamic libraries - 德哥@Digoal - The Heart,The World."  alt="static and dynamic libraries - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img8.ph.126.net/8YpAHrnI6vgjuz-KBpP3Sw==/1577104294527577628.jpg"  ></div>&nbsp;</div><div><font face="宋体"  >静态库和动态库在生成bin文件的使用是一样的 :&nbsp;</font></div><div><pre class="prettyprint"  ><p><font size="2"  >[root@db-172-16-3-150 zzz]# gcc -O3 -Wall -Wextra -Werror -g b.c -L. -la -o b</font></p></pre></div><div><font face="宋体"  >注意c文件一定要放在库文件前面, 否则可能会报错. b.c -L. -la 如果改成 -L. -la b.c 就可能报错.</font></div><div><font face="宋体"  >-L 表示库文件在什么目录找.</font></div><div><font face="宋体"  >-l 表示需要用到那个库</font></div><div><font face="宋体"  ><br></font></div><div><font face="宋体"  >如果动态库和静态库都有的情况下会使用哪个呢?</font></div><div><font face="宋体"  >如 :&nbsp;</font></div><div><font face="宋体"  ><div><pre class="prettyprint"  ><p></p><div><font size="2"  >-rw-r--r-- 1 root root 6168 Aug 15 10:26 liba.a</font></div><div><font size="2"  >-rwxr-xr-x 1 root root 8465 Aug 15 10:56 liba.so</font></div><p></p></pre></div><div><br></div><div>默认使用的是动态库 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 zzz]# ll</font></div><div><font size="2"  >total 40</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp;110 Aug 15 09:58 a.c</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp; 16 Aug 15 09:58 a.h</font></div><div><font size="2"  >-rw-r--r-- 1 root root 6064 Aug 15 11:09 a.o</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp; 56 Aug 15 09:58 b.c</font></div><div><font size="2"  >-rw-r--r-- 1 root root 6208 Aug 15 11:09 liba.a</font></div><div><font size="2"  >-rwxr-xr-x 1 root root 8449 Aug 15 11:10 liba.so</font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# gcc -O3 -Wall -Wextra -Werror -g b.c -L. -la -o b</font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# ./b</font></div><div><font size="2"  >./b: error while loading shared libraries: liba.so: cannot open shared object file: No such file or directory</font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# export LD_LIBRARY_PATH=.</font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# ll</font></div><p></p></pre></div><div>显然使用动态库编译的bin文件b要比使用静态库的小(<span style="line-height: 22px;"  >8185 bytes</span>).</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >total 48</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp;110 Aug 15 09:58 a.c</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp; 16 Aug 15 09:58 a.h</font></div><div><font size="2"  >-rw-r--r-- 1 root root 6064 Aug 15 11:09 a.o</font></div><div><font size="2"  >-rwxr-xr-x 1 root root 8185 Aug 15 11:14 b</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp; 56 Aug 15 09:58 b.c</font></div><div><font size="2"  >-rw-r--r-- 1 root root 6208 Aug 15 11:09 liba.a</font></div><div><font size="2"  >-rwxr-xr-x 1 root root 8449 Aug 15 11:10 liba.so</font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# ./b</font></div><div><font size="2"  >this is display function in a.c</font></div><p></p></pre></div></div><div><br></div><div>使用-static强制静态编译.</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >[root@db-172-16-3-150 zzz]# gcc -O3 -Wall -Wextra -Werror -g -static b.c -L. -la -o b</font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# ll</font></div><div><font size="2"  >total 640</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp; &nbsp;110 Aug 15 09:58 a.c</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp; &nbsp; 16 Aug 15 09:58 a.h</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp; 6064 Aug 15 11:09 a.o</font></div><div><font size="2"  >-rwxr-xr-x 1 root root 609720 Aug 15 11:14 b</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp; &nbsp; 56 Aug 15 09:58 b.c</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp; 6208 Aug 15 11:09 liba.a</font></div><div><font size="2"  >-rwxr-xr-x 1 root root &nbsp; 8449 Aug 15 11:10 liba.so</font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# ./b</font></div><div><font size="2"  >this is display function in a.c</font></div><div><font size="2"  >// 修改LD_LIBRARY_PATH后依旧可用使用, 说明却是已经不是动态状态了. 但是文件硕大(<span style="line-height: 22px;"  >609720 bytes</span>). 不建议使用.</font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# export LD_LIBRARY_PATH=/usr/lib</font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# ./b</font></div><div><font size="2"  >this is display function in a.c</font></div></div><div><div><font size="2"  >说明 &nbsp;:&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;-static</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;On systems that support dynamic linking, this prevents linking with the shared libraries. &nbsp;On other sys-</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tems, this option has no effect.</font></div></div><p></p></pre></div><div><br></div><div>使用静态库编译出来b的大小(9973 bytes) :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 zzz]# mv liba.so libb.so</font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# gcc -O3 -Wall -Wextra -Werror -g b.c -L. -la -o b</font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# ll -a</font></div><div><font size="2"  >total 64</font></div><div><font size="2"  >drwxr-xr-x &nbsp;2 root root 4096 Aug 15 11:18 .</font></div><div><font size="2"  >drwxr-x--- 16 root root 4096 Aug &nbsp;9 11:22 ..</font></div><div><font size="2"  >-rw-r--r-- &nbsp;1 root root &nbsp;110 Aug 15 09:58 a.c</font></div><div><font size="2"  >-rw-r--r-- &nbsp;1 root root &nbsp; 16 Aug 15 09:58 a.h</font></div><div><font size="2"  >-rw-r--r-- &nbsp;1 root root 6064 Aug 15 11:09 a.o</font></div><div><font size="2"  >-rwxr-xr-x &nbsp;1 root root 9973 Aug 15 11:18 b</font></div><div><font size="2"  >-rw-r--r-- &nbsp;1 root root &nbsp; 56 Aug 15 09:58 b.c</font></div><div><font size="2"  >-rw-r--r-- &nbsp;1 root root 6208 Aug 15 11:09 liba.a</font></div><div><font size="2"  >-rwxr-xr-x &nbsp;1 root root 8449 Aug 15 11:10 libb.so</font></div><p></p></pre></div><div><br></div><div>【注意】</div><div>1. 有书说动态库的名字修改后不能使用, 如liba.so 改成libb.so 使用-lb编译也无法使用. 实际测试可用使用.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 zzz]# mv liba.so libb.so</font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# gcc -O3 -Wall -Wextra -Werror -g b.c -L. -lb -o b</font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# ./b</font></div><div><font size="2"  >./b: error while loading shared libraries: libb.so: cannot open shared object file: No such file or directory</font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# export LD_LIBRARY_PATH=.</font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# ./b</font></div><div><font size="2"  >this is display function in a.c</font></div><p></p></pre></div></font></div><div><font face="宋体"  ><br></font></div><div><font face="宋体"  >【参考】</font></div><div><a rel="nofollow" href="http://en.wikipedia.org/wiki/Linker_(computing)"  >http://en.wikipedia.org/wiki/Linker_(computing)</a> </div><div><a rel="nofollow" href="http://en.wikipedia.org/wiki/Shared_library"  >http://en.wikipedia.org/wiki/Shared_library</a> </div><div><font face="宋体"  >man ar, nm, gcc</font></div><div><pre class="prettyprint"  ><p></p><div><font face="宋体"  size="1"  >ar :&nbsp;</font></div><div><font face="宋体"  size="1"  ><div><div>&nbsp; &nbsp; &nbsp; &nbsp;r &nbsp; Insert the files member... into archive (with replacement). This operation differs from q in that any &nbsp;pre-</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;viously existing members are deleted if their names match those being added.</div><div><br></div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;If one of the files named in member... does not exist, ar displays an error message, and leaves undisturbed</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;any existing members of the archive matching that name.</div><div><br></div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;By default, new members are added at the end of the file; but you may use one of the modifiers a, b, &nbsp;or &nbsp;i</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;to request placement relative to some existing member.</div><div><br></div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;The &nbsp;modifier v used with this operation elicits a line of output for each file inserted, along with one of</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;the letters a or r to indicate whether the file was appended (no old member deleted) or replaced.</div></div><div>&nbsp; &nbsp; &nbsp; &nbsp;c &nbsp; Create &nbsp;the &nbsp;archive. &nbsp; The &nbsp;specified &nbsp;archive &nbsp;is always created if it did not exist, when you request an</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;update. &nbsp;But a warning is issued unless you specify in advance that you expect to create it, by using &nbsp;this</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;modifier.</div><div><div>&nbsp; &nbsp; &nbsp; &nbsp;s &nbsp; Write an object-file index into the archive, or update an existing one, even if no other change is made &nbsp;to</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;the &nbsp;archive. &nbsp; You &nbsp;may &nbsp;use &nbsp;this &nbsp;modifier flag either with any operation, or alone. &nbsp;Running ar s on an</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;archive is equivalent to running ranlib on it.</div></div></font></div><div><font face="宋体"  size="1"  ><div>&nbsp; &nbsp; &nbsp; &nbsp;t &nbsp; Display a table listing the contents of archive, or those of the files listed in member... that are present</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;in &nbsp;the &nbsp;archive. &nbsp;Normally only the member name is shown; if you also want to see the modes (permissions),</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;timestamp, owner, group, and size, you can request that by also specifying the v modifier.</div><div><br></div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;If you do not specify a member, all files in the archive are listed.</div><div><br></div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;If there is more than one file with the same name (say, fie) in an archive (say b.a), ar t &nbsp;b.a &nbsp;fie &nbsp;lists</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;only the first instance; to see them all, you must ask for a complete listing---in our example, ar t b.a.</div></font></div><p></p></pre></div><div><font face="宋体"  >查看一个静态库文件里面包含了哪些对象文件 :&nbsp;</font></div><div><pre class="prettyprint"  ><p></p><div><font face="宋体"  size="1"  >[root@db-172-16-3-150 lib]# cd /usr/lib</font></div><div><font face="宋体"  size="1"  ><div>[root@db-172-16-3-150 lib]# ar -t libz.a</div><div>adler32.o</div><div>compress.o</div><div>crc32.o</div><div>gzio.o</div><div>uncompr.o</div><div>deflate.o</div><div>trees.o</div><div>zutil.o</div><div>inflate.o</div><div>infback.o</div><div>inftrees.o</div><div>inffast.o</div></font></div><p></p></pre></div><div><font face="宋体"  ><br></font></div><div><font face="宋体"  >查看库文件中的symbol信息 :</font></div><div><font face="宋体"  ><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 lib]# nm ./libz.a</font></div><div><font size="2"  >adler32.o:</font></div><div><font size="2"  >0000000000000000 T adler32</font></div><div><font size="2"  >0000000000000390 T adler32_combine</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >compress.o:</font></div><div><font size="2"  >0000000000000000 r .LC0</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;U _GLOBAL_OFFSET_TABLE_</font></div><div><font size="2"  >0000000000000000 T __i686.get_pc_thunk.bx</font></div><div><font size="2"  >00000000000000f0 T compress</font></div><div><font size="2"  >0000000000000020 T compress2</font></div><div><font size="2"  >0000000000000000 T compressBound</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;U deflate</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;U deflateEnd</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;U deflateInit_</font></div><div><font size="2"  >.......</font></div><div><font size="2"  >这里标记的意思可参考man nm</font></div><div><div><font size="2"  >[root@db-172-16-3-150 zzz]# nm liba.so</font></div><div><font size="2"  >0000000000200660 a _DYNAMIC</font></div><div><font size="2"  >0000000000200800 a _GLOBAL_OFFSET_TABLE_</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;w _Jv_RegisterClasses</font></div><div><font size="2"  >0000000000200638 d __CTOR_END__</font></div><div><font size="2"  >0000000000200630 d __CTOR_LIST__</font></div><div><font size="2"  >0000000000200648 d __DTOR_END__</font></div><div><font size="2"  >0000000000200640 d __DTOR_LIST__</font></div><div><font size="2"  >0000000000000628 r __FRAME_END__</font></div><div><font size="2"  >0000000000200650 d __JCR_END__</font></div><div><font size="2"  >0000000000200650 d __JCR_LIST__</font></div><div><font size="2"  >0000000000200828 A __bss_start</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;w __cxa_finalize@@GLIBC_2.2.5</font></div><div><font size="2"  >0000000000000570 t __do_global_ctors_aux</font></div><div><font size="2"  >00000000000004a0 t __do_global_dtors_aux</font></div><div><font size="2"  >0000000000200658 d __dso_handle</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;w __gmon_start__</font></div><div><font size="2"  >0000000000200828 A _edata</font></div><div><font size="2"  >0000000000200838 A _end</font></div><div><font size="2"  >00000000000005a8 T _fini</font></div><div><font size="2"  >0000000000000438 T _init</font></div><div><font size="2"  >0000000000000480 t call_gmon_start</font></div><div><font size="2"  >0000000000200830 b completed.6145</font></div><div><font size="2"  >0000000000000550 T display</font></div><div><font size="2"  >0000000000200828 b dtor_idx.6147</font></div><div><font size="2"  >0000000000000520 t frame_dummy</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;U fwrite@@GLIBC_2.2.5</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;U stdout@@GLIBC_2.2.5</font></div></div><p></p></pre></div><div>gcc 常用参数 :&nbsp;</div></font></div><div><font face="宋体"  >-O3 &nbsp;代码优化,级别3</font></div><div><font face="宋体"  >-Wall &nbsp;警告</font></div><div><font face="宋体"  >-Wextra &nbsp;额外警告</font></div><div><font face="宋体"  >-Werror &nbsp;将警告当做error处理</font></div><div><font face="宋体"  >-g &nbsp;包含debug信息到bin文件</font></div><div><font face="宋体"  >-L &nbsp;指出LIBRARY检索目录</font></div><div><font face="宋体"  >-I &nbsp;指出头文件检索目录</font></div><div><font face="宋体"  >-l &nbsp;指出库名字</font></div></div>
	</div>
</div>
</body>
</html>