<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL Partition Table Example</h2>
	<h5 id="">2012-04-25 11:19:43&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012325111528424/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">最近在写PostgreSQL 2Day DBA的培训PPT, 写到分区表章节. 记录一下. 以前写过分区表调优的案例, 也不建议使用数据库来分区, 至少PG中是这样的, 原因可以参考如下<div><div>PostgreSQL partition table's arithmetic tuning example</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402011210114036419/"  >http://blog.163.com/digoal@126/blog/static/1638770402011210114036419/</a></div><div><br></div><div>Range分区表的使用实例 :&nbsp;</div><div>其他的诸如list, hash, complex的分区实例照葫芦画瓢.</div><div><div><br></div><div>-- 创建主表</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >CREATE TABLE p (</font></div><div><font size="2"  >&nbsp; &nbsp; city_id &nbsp; &nbsp; &nbsp; &nbsp; int not null,</font></div><div><font size="2"  >&nbsp; &nbsp; logtime &nbsp; &nbsp; &nbsp; &nbsp; timestamp(0) not null,</font></div><div><font size="2"  >&nbsp; &nbsp; peaktemp &nbsp; &nbsp; &nbsp; &nbsp;int,</font></div><div><font size="2"  >&nbsp; &nbsp; unitsales &nbsp; &nbsp; &nbsp; int</font></div><div><font size="2"  >);</font></div><p></p></pre></div><div>-- 在分区字段上创建索引</div><div><pre class="prettyprint"  ><p><font size="2"  >CREATE INDEX idx_p_logtime ON p (logtime);</font></p></pre></div><div>-- 创建子表</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >CREATE TABLE p_201201 (LIKE p INCLUDING all) INHERITS (p);</font></div><div><font size="2"  >CREATE TABLE p_201202 (LIKE p INCLUDING all) INHERITS (p);</font></div><div><font size="2"  >CREATE TABLE p_201203 (LIKE p INCLUDING all) INHERITS (p);</font></div><div><font size="2"  >CREATE TABLE p_201204 (LIKE p INCLUDING all) INHERITS (p);</font></div><div><font size="2"  >CREATE TABLE p_201205 (LIKE p INCLUDING all) INHERITS (p);</font></div><div><font size="2"  >CREATE TABLE p_201206 (LIKE p INCLUDING all) INHERITS (p);</font></div><div><font size="2"  >CREATE TABLE p_201207 (LIKE p INCLUDING all) INHERITS (p);</font></div><div><font size="2"  >CREATE TABLE p_201208 (LIKE p INCLUDING all) INHERITS (p);</font></div><div><font size="2"  >CREATE TABLE p_201209 (LIKE p INCLUDING all) INHERITS (p);</font></div><div><font size="2"  >CREATE TABLE p_201210 (LIKE p INCLUDING all) INHERITS (p);</font></div><div><font size="2"  >CREATE TABLE p_201211 (LIKE p INCLUDING all) INHERITS (p);</font></div><div><font size="2"  >CREATE TABLE p_201212 (LIKE p INCLUDING all) INHERITS (p);</font></div><div><font size="2"  >CREATE TABLE p_default (LIKE p INCLUDING all) INHERITS (p);</font></div><p></p></pre></div><div>-- 添加分区字段约束</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ALTER TABLE p_201201 ADD CONSTRAINT p_201201_ck1 CHECK (logtime&gt;=date '2012-01-01' and logtime&lt;date '2012-02-01');</font></div><div><font size="2"  >ALTER TABLE p_201202 ADD CONSTRAINT p_201202_ck1 CHECK (logtime&gt;=date '2012-02-01' and logtime&lt;date '2012-03-01');</font></div><div><font size="2"  >ALTER TABLE p_201203 ADD CONSTRAINT p_201203_ck1 CHECK (logtime&gt;=date '2012-03-01' and logtime&lt;date '2012-04-01');</font></div><div><font size="2"  >ALTER TABLE p_201204 ADD CONSTRAINT p_201204_ck1 CHECK (logtime&gt;=date '2012-04-01' and logtime&lt;date '2012-05-01');</font></div><div><font size="2"  >ALTER TABLE p_201205 ADD CONSTRAINT p_201205_ck1 CHECK (logtime&gt;=date '2012-05-01' and logtime&lt;date '2012-06-01');</font></div><div><font size="2"  >ALTER TABLE p_201206 ADD CONSTRAINT p_201206_ck1 CHECK (logtime&gt;=date '2012-06-01' and logtime&lt;date '2012-07-01');</font></div><div><font size="2"  >ALTER TABLE p_201207 ADD CONSTRAINT p_201207_ck1 CHECK (logtime&gt;=date '2012-07-01' and logtime&lt;date '2012-08-01');</font></div><div><font size="2"  >ALTER TABLE p_201208 ADD CONSTRAINT p_201208_ck1 CHECK (logtime&gt;=date '2012-08-01' and logtime&lt;date '2012-09-01');</font></div><div><font size="2"  >ALTER TABLE p_201209 ADD CONSTRAINT p_201209_ck1 CHECK (logtime&gt;=date '2012-09-01' and logtime&lt;date '2012-10-01');</font></div><div><font size="2"  >ALTER TABLE p_201210 ADD CONSTRAINT p_201210_ck1 CHECK (logtime&gt;=date '2012-10-01' and logtime&lt;date '2012-11-01');</font></div><div><font size="2"  >ALTER TABLE p_201211 ADD CONSTRAINT p_201211_ck1 CHECK (logtime&gt;=date '2012-11-01' and logtime&lt;date '2012-12-01');</font></div><div><font size="2"  >ALTER TABLE p_201212 ADD CONSTRAINT p_201212_ck1 CHECK (logtime&gt;=date '2012-12-01' and logtime&lt;date '2013-01-01');</font></div><div><font size="2"  >ALTER TABLE p_default ADD CONSTRAINT p_default_ck1 CHECK (logtime&lt;date '2012-01-01' or logtime&gt;=date '2013-01-01');</font></div><p></p></pre></div><div>-- 其中的一个子表展示, including all继承了主表的索引, 存储, 约束等特性.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# \d p_201201</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "public.p_201201"</font></div><div><font size="2"  >&nbsp; Column &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Modifiers&nbsp;</font></div><div><font size="2"  >-----------+--------------------------------+-----------</font></div><div><font size="2"  >&nbsp;city_id &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"  >&nbsp;logtime &nbsp; | timestamp(0) without time zone | not null</font></div><div><font size="2"  >&nbsp;peaktemp &nbsp;| integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;unitsales | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >Indexes:</font></div><div><font size="2"  >&nbsp; &nbsp; "p_201201_logtime_idx" btree (logtime)</font></div><div><font size="2"  >Check constraints:</font></div><div><font size="2"  >&nbsp; &nbsp; "p_201201_ck1" CHECK (logtime &gt;= '2012-01-01'::date AND logtime &lt; '2012-02-01'::date)</font></div><div><font size="2"  >Inherits: p</font></div><p></p></pre></div><div>-- 创建插入触发器函数</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >CREATE OR REPLACE FUNCTION p_insert_trigger()</font></div><div><font size="2"  >RETURNS TRIGGER AS $$</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >&nbsp; &nbsp; IF &nbsp; &nbsp;( NEW.logtime &gt;= DATE '2012-01-01' AND NEW.logtime &lt; DATE '2012-02-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; INSERT INTO p_201201 VALUES (NEW.*);</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( NEW.logtime &gt;= DATE '2012-02-01' AND NEW.logtime &lt; DATE '2012-03-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; INSERT INTO p_201202 VALUES (NEW.*);</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( NEW.logtime &gt;= DATE '2012-03-01' AND NEW.logtime &lt; DATE '2012-04-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; INSERT INTO p_201203 VALUES (NEW.*);</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( NEW.logtime &gt;= DATE '2012-04-01' AND NEW.logtime &lt; DATE '2012-05-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; INSERT INTO p_201204 VALUES (NEW.*);</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( NEW.logtime &gt;= DATE '2012-05-01' AND NEW.logtime &lt; DATE '2012-06-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; INSERT INTO p_201205 VALUES (NEW.*);</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( NEW.logtime &gt;= DATE '2012-06-01' AND NEW.logtime &lt; DATE '2012-07-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; INSERT INTO p_201206 VALUES (NEW.*);</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( NEW.logtime &gt;= DATE '2012-07-01' AND NEW.logtime &lt; DATE '2012-08-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; INSERT INTO p_201207 VALUES (NEW.*);</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( NEW.logtime &gt;= DATE '2012-08-01' AND NEW.logtime &lt; DATE '2012-09-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; INSERT INTO p_201208 VALUES (NEW.*);</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( NEW.logtime &gt;= DATE '2012-09-01' AND NEW.logtime &lt; DATE '2012-10-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; INSERT INTO p_201209 VALUES (NEW.*);</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( NEW.logtime &gt;= DATE '2012-10-01' AND NEW.logtime &lt; DATE '2012-11-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; INSERT INTO p_201210 VALUES (NEW.*);</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( NEW.logtime &gt;= DATE '2012-11-01' AND NEW.logtime &lt; DATE '2012-12-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; INSERT INTO p_201211 VALUES (NEW.*);</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( NEW.logtime &gt;= DATE '2012-12-01' AND NEW.logtime &lt; DATE '2013-01-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; INSERT INTO p_201212 VALUES (NEW.*);</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( NEW.logtime &gt;= DATE '2013-01-01' OR NEW.logtime &lt; DATE '2012-01-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; INSERT INTO p_default VALUES (NEW.*);</font></div><div><font size="2"  >&nbsp; &nbsp; ELSE</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; RAISE EXCEPTION 'Date out of range. &nbsp;Fix the p_insert_trigger() function!';</font></div><div><font size="2"  >&nbsp; &nbsp; END IF;</font></div><div><font size="2"  >&nbsp; &nbsp; RETURN NULL;</font></div><div><font size="2"  >END;</font></div><div><font size="2"  >$$ LANGUAGE plpgsql;</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- 创建删除触发器函数</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >CREATE OR REPLACE FUNCTION p_delete_trigger()</font></div><div><font size="2"  >RETURNS TRIGGER AS $$</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >&nbsp; &nbsp; IF &nbsp; &nbsp;( OLD.logtime &gt;= DATE '2012-01-01' AND OLD.logtime &lt; DATE '2012-02-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; DELETE FROM p_201201 WHERE logtime=OLD.logtime;</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( OLD.logtime &gt;= DATE '2012-02-01' AND OLD.logtime &lt; DATE '2012-03-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; DELETE FROM p_201202 WHERE logtime=OLD.logtime;</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( OLD.logtime &gt;= DATE '2012-03-01' AND OLD.logtime &lt; DATE '2012-04-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; DELETE FROM p_201203 WHERE logtime=OLD.logtime;</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( OLD.logtime &gt;= DATE '2012-04-01' AND OLD.logtime &lt; DATE '2012-05-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; DELETE FROM p_201204 WHERE logtime=OLD.logtime;</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( OLD.logtime &gt;= DATE '2012-05-01' AND OLD.logtime &lt; DATE '2012-06-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; DELETE FROM p_201205 WHERE logtime=OLD.logtime;</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( OLD.logtime &gt;= DATE '2012-06-01' AND OLD.logtime &lt; DATE '2012-07-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; DELETE FROM p_201206 WHERE logtime=OLD.logtime;</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( OLD.logtime &gt;= DATE '2012-07-01' AND OLD.logtime &lt; DATE '2012-08-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; DELETE FROM p_201207 WHERE logtime=OLD.logtime;</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( OLD.logtime &gt;= DATE '2012-08-01' AND OLD.logtime &lt; DATE '2012-09-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; DELETE FROM p_201208 WHERE logtime=OLD.logtime;</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( OLD.logtime &gt;= DATE '2012-09-01' AND OLD.logtime &lt; DATE '2012-10-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; DELETE FROM p_201209 WHERE logtime=OLD.logtime;</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( OLD.logtime &gt;= DATE '2012-10-01' AND OLD.logtime &lt; DATE '2012-11-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; DELETE FROM p_201210 WHERE logtime=OLD.logtime;</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( OLD.logtime &gt;= DATE '2012-11-01' AND OLD.logtime &lt; DATE '2012-12-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; DELETE FROM p_201211 WHERE logtime=OLD.logtime;</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( OLD.logtime &gt;= DATE '2012-12-01' AND OLD.logtime &lt; DATE '2013-01-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; DELETE FROM p_201212 WHERE logtime=OLD.logtime;</font></div><div><font size="2"  >&nbsp; &nbsp; ELSIF ( OLD.logtime &gt;= DATE '2013-01-01' OR OLD.logtime &lt; DATE '2012-01-01' ) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; DELETE FROM p_default WHERE logtime=OLD.logtime;</font></div><div><font size="2"  >&nbsp; &nbsp; ELSE</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; RAISE EXCEPTION 'Date out of range. &nbsp;Fix the p_insert_trigger() function!';</font></div><div><font size="2"  >&nbsp; &nbsp; END IF;</font></div><div><font size="2"  >&nbsp; &nbsp; RETURN NULL;</font></div><div><font size="2"  >END;</font></div><div><font size="2"  >$$ LANGUAGE plpgsql;</font></div><p></p></pre></div><div>-- 创建主表的插入和删除触发器, 更新操作实际上就是delete+insert. 所以不需要新增触发器.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >CREATE TRIGGER insert_p_trigger</font></div><div><font size="2"  >&nbsp; &nbsp; BEFORE INSERT ON p</font></div><div><font size="2"  >&nbsp; &nbsp; FOR EACH ROW EXECUTE PROCEDURE p_insert_trigger();</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >CREATE TRIGGER delete_p_trigger</font></div><div><font size="2"  >&nbsp; &nbsp; BEFORE DELETE ON p</font></div><div><font size="2"  >&nbsp; &nbsp; FOR EACH ROW EXECUTE PROCEDURE p_delete_trigger();</font></div><p></p></pre></div><div>-- 插入测试数据, 分布在每个范围段</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >INSERT INTO p (city_id, logtime, peaktemp, unitsales) VALUES (1, timestamp '2012-01-02 12:59:59', 20, 10);</font></div><div><font size="2"  >INSERT INTO p (city_id, logtime, peaktemp, unitsales) VALUES (2, timestamp '2012-02-02 12:59:59', 20, 10);</font></div><div><font size="2"  >INSERT INTO p (city_id, logtime, peaktemp, unitsales) VALUES (3, timestamp '2012-03-02 12:59:59', 20, 10);</font></div><div><font size="2"  >INSERT INTO p (city_id, logtime, peaktemp, unitsales) VALUES (4, timestamp '2012-04-02 12:59:59', 20, 10);</font></div><div><font size="2"  >INSERT INTO p (city_id, logtime, peaktemp, unitsales) VALUES (5, timestamp '2012-05-02 12:59:59', 20, 10);</font></div><div><font size="2"  >INSERT INTO p (city_id, logtime, peaktemp, unitsales) VALUES (6, timestamp '2012-06-02 12:59:59', 20, 10);</font></div><div><font size="2"  >INSERT INTO p (city_id, logtime, peaktemp, unitsales) VALUES (7, timestamp '2012-07-02 12:59:59', 20, 10);</font></div><div><font size="2"  >INSERT INTO p (city_id, logtime, peaktemp, unitsales) VALUES (8, timestamp '2012-08-02 12:59:59', 20, 10);</font></div><div><font size="2"  >INSERT INTO p (city_id, logtime, peaktemp, unitsales) VALUES (9, timestamp '2012-09-02 12:59:59', 20, 10);</font></div><div><font size="2"  >INSERT INTO p (city_id, logtime, peaktemp, unitsales) VALUES (10, timestamp '2012-10-02 12:59:59', 20, 10);</font></div><div><font size="2"  >INSERT INTO p (city_id, logtime, peaktemp, unitsales) VALUES (11, timestamp '2012-11-02 12:59:59', 20, 10);</font></div><div><font size="2"  >INSERT INTO p (city_id, logtime, peaktemp, unitsales) VALUES (12, timestamp '2012-12-02 12:59:59', 20, 10);</font></div><div><font size="2"  >INSERT INTO p (city_id, logtime, peaktemp, unitsales) VALUES (13, timestamp '2013-01-02 12:59:59', 20, 10);</font></div><div><font size="2"  >INSERT INTO p (city_id, logtime, peaktemp, unitsales) VALUES (14, timestamp '2011-12-02 12:59:59', 20, 10);</font></div><p></p></pre></div><div>-- 查看数据插入的准确性</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >SELECT t1.relname,t2.* FROM p t2,pg_class t1 WHERE t2.tableoid=t1.oid ORDER BY t2.logtime;</font></div><div><font size="2"  >&nbsp; relname &nbsp;| city_id | &nbsp; &nbsp; &nbsp; logtime &nbsp; &nbsp; &nbsp; | peaktemp | unitsales&nbsp;</font></div><div><font size="2"  >-----------+---------+---------------------+----------+-----------</font></div><div><font size="2"  >&nbsp;p_default | &nbsp; &nbsp; &nbsp;14 | 2011-12-02 12:59:59 | &nbsp; &nbsp; &nbsp; 20 | &nbsp; &nbsp; &nbsp; &nbsp;10</font></div><div><font size="2"  >&nbsp;p_201201 &nbsp;| &nbsp; &nbsp; &nbsp; 1 | 2012-01-02 12:59:59 | &nbsp; &nbsp; &nbsp; 20 | &nbsp; &nbsp; &nbsp; &nbsp;10</font></div><div><font size="2"  >&nbsp;p_201202 &nbsp;| &nbsp; &nbsp; &nbsp; 2 | 2012-02-02 12:59:59 | &nbsp; &nbsp; &nbsp; 20 | &nbsp; &nbsp; &nbsp; &nbsp;10</font></div><div><font size="2"  >&nbsp;p_201203 &nbsp;| &nbsp; &nbsp; &nbsp; 3 | 2012-03-02 12:59:59 | &nbsp; &nbsp; &nbsp; 20 | &nbsp; &nbsp; &nbsp; &nbsp;10</font></div><div><font size="2"  >&nbsp;p_201204 &nbsp;| &nbsp; &nbsp; &nbsp; 4 | 2012-04-02 12:59:59 | &nbsp; &nbsp; &nbsp; 20 | &nbsp; &nbsp; &nbsp; &nbsp;10</font></div><div><font size="2"  >&nbsp;p_201205 &nbsp;| &nbsp; &nbsp; &nbsp; 5 | 2012-05-02 12:59:59 | &nbsp; &nbsp; &nbsp; 20 | &nbsp; &nbsp; &nbsp; &nbsp;10</font></div><div><font size="2"  >&nbsp;p_201206 &nbsp;| &nbsp; &nbsp; &nbsp; 6 | 2012-06-02 12:59:59 | &nbsp; &nbsp; &nbsp; 20 | &nbsp; &nbsp; &nbsp; &nbsp;10</font></div><div><font size="2"  >&nbsp;p_201207 &nbsp;| &nbsp; &nbsp; &nbsp; 7 | 2012-07-02 12:59:59 | &nbsp; &nbsp; &nbsp; 20 | &nbsp; &nbsp; &nbsp; &nbsp;10</font></div><div><font size="2"  >&nbsp;p_201208 &nbsp;| &nbsp; &nbsp; &nbsp; 8 | 2012-08-02 12:59:59 | &nbsp; &nbsp; &nbsp; 20 | &nbsp; &nbsp; &nbsp; &nbsp;10</font></div><div><font size="2"  >&nbsp;p_201209 &nbsp;| &nbsp; &nbsp; &nbsp; 9 | 2012-09-02 12:59:59 | &nbsp; &nbsp; &nbsp; 20 | &nbsp; &nbsp; &nbsp; &nbsp;10</font></div><div><font size="2"  >&nbsp;p_201210 &nbsp;| &nbsp; &nbsp; &nbsp;10 | 2012-10-02 12:59:59 | &nbsp; &nbsp; &nbsp; 20 | &nbsp; &nbsp; &nbsp; &nbsp;10</font></div><div><font size="2"  >&nbsp;p_201211 &nbsp;| &nbsp; &nbsp; &nbsp;11 | 2012-11-02 12:59:59 | &nbsp; &nbsp; &nbsp; 20 | &nbsp; &nbsp; &nbsp; &nbsp;10</font></div><div><font size="2"  >&nbsp;p_201212 &nbsp;| &nbsp; &nbsp; &nbsp;12 | 2012-12-02 12:59:59 | &nbsp; &nbsp; &nbsp; 20 | &nbsp; &nbsp; &nbsp; &nbsp;10</font></div><div><font size="2"  >&nbsp;p_default | &nbsp; &nbsp; &nbsp;13 | 2013-01-02 12:59:59 | &nbsp; &nbsp; &nbsp; 20 | &nbsp; &nbsp; &nbsp; &nbsp;10</font></div><p></p></pre></div><div><br></div><div>-- 查看在WHERE条件中使用分区字段和常量比较的更新操作的执行计划</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# EXPLAIN UPDATE p SET unitsales=unitsales+1 WHERE logtime=timestamp '2011-12-02 12:59:59';</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Update on p &nbsp;(cost=0.00..9.79 rows=9 width=26)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on p &nbsp;(cost=0.00..0.00 rows=1 width=26)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (logtime = '2011-12-02 12:59:59'::timestamp without time zone)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Bitmap Heap Scan on p_default p &nbsp;(cost=2.31..9.78 rows=8 width=26)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Recheck Cond: (logtime = '2011-12-02 12:59:59'::timestamp without time zone)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on p_default_logtime_idx &nbsp;(cost=0.00..2.31 rows=8 width=0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (logtime = '2011-12-02 12:59:59'::timestamp without time zone)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >UPDATE p SET unitsales=unitsales+1 WHERE logtime=timestamp '2011-12-02 12:59:59';</font></div><div><font size="2"  >&nbsp; relname &nbsp;| city_id | &nbsp; &nbsp; &nbsp; logtime &nbsp; &nbsp; &nbsp; | peaktemp | unitsales&nbsp;</font></div><div><font size="2"  >-----------+---------+---------------------+----------+-----------</font></div><div><font size="2"  >&nbsp;p_default | &nbsp; &nbsp; &nbsp;14 | 2011-12-02 12:59:59 | &nbsp; &nbsp; &nbsp; 20 | &nbsp; &nbsp; &nbsp; &nbsp;11</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"  >-- 查看在WHERE条件中使用分区字段和常量比较的删除操作的执行计划</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# EXPLAIN DELETE FROM p WHERE logtime=timestamp '2011-12-02 12:59:59';</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Delete on p &nbsp;(cost=0.00..9.76 rows=9 width=6)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on p &nbsp;(cost=0.00..0.00 rows=1 width=6)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (logtime = '2011-12-02 12:59:59'::timestamp without time zone)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Bitmap Heap Scan on p_default p &nbsp;(cost=2.31..9.76 rows=8 width=6)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Recheck Cond: (logtime = '2011-12-02 12:59:59'::timestamp without time zone)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on p_default_logtime_idx &nbsp;(cost=0.00..2.31 rows=8 width=0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (logtime = '2011-12-02 12:59:59'::timestamp without time zone)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >DELETE FROM p WHERE logtime=timestamp '2011-12-02 12:59:59';</font></div><div><font size="2"  >DELETE 1</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- 查看在WHERE条件中使用分区字段和常量比较的查询操作的执行计划</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# EXPLAIN SELECT * FROM p WHERE logtime=timestamp '2011-12-02 12:59:59';</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Result &nbsp;(cost=0.00..9.76 rows=9 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Append &nbsp;(cost=0.00..9.76 rows=9 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on p &nbsp;(cost=0.00..0.00 rows=1 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (logtime = '2011-12-02 12:59:59'::timestamp without time zone)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Heap Scan on p_default p &nbsp;(cost=2.31..9.76 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Recheck Cond: (logtime = '2011-12-02 12:59:59'::timestamp without time zone)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on p_default_logtime_idx &nbsp;(cost=0.00..2.31 rows=8 width=0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (logtime = '2011-12-02 12:59:59'::timestamp without time zone)</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"  >-- 查看在WHERE条件中使用分区字段和函数比较的操作的执行计划</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select proname,provolatile,proargtypes from pg_proc where prorettype in (select oid from pg_type where typname ~ 'timestamp') order by proargtypes;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;proname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| provolatile | &nbsp;proargtypes &nbsp;&nbsp;</font></div><div><font size="2"  >--------------------------------------+-------------+----------------</font></div><div><font size="2"  >&nbsp;transaction_timestamp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| s &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;statement_timestamp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| s &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;pg_stat_get_bgwriter_stat_reset_time | s &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;pg_conf_load_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| s &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;pg_postmaster_start_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | s &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;pg_last_xact_replay_timestamp &nbsp; &nbsp; &nbsp; &nbsp;| v &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;clock_timestamp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| v &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;now &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| s &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><p></p></pre></div><div>-- 确认已经开启了constraint_exclusion</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# show constraint_exclusion;</font></div><div><font size="2"  >&nbsp;constraint_exclusion&nbsp;</font></div><div><font size="2"  >----------------------</font></div><div><font size="2"  >&nbsp;partition</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# EXPLAIN SELECT * FROM p WHERE logtime=now();</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Result &nbsp;(cost=0.00..127.23 rows=105 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Append &nbsp;(cost=0.00..127.23 rows=105 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on p &nbsp;(cost=0.00..0.00 rows=1 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Heap Scan on p_201201 p &nbsp;(cost=2.31..9.79 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Recheck Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on p_201201_logtime_idx &nbsp;(cost=0.00..2.31 rows=8 width=0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Heap Scan on p_201202 p &nbsp;(cost=2.31..9.79 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Recheck Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on p_201202_logtime_idx &nbsp;(cost=0.00..2.31 rows=8 width=0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Heap Scan on p_201203 p &nbsp;(cost=2.31..9.79 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Recheck Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on p_201203_logtime_idx &nbsp;(cost=0.00..2.31 rows=8 width=0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Heap Scan on p_201204 p &nbsp;(cost=2.31..9.79 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Recheck Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on p_201204_logtime_idx &nbsp;(cost=0.00..2.31 rows=8 width=0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Heap Scan on p_201205 p &nbsp;(cost=2.31..9.79 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Recheck Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on p_201205_logtime_idx &nbsp;(cost=0.00..2.31 rows=8 width=0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Heap Scan on p_201206 p &nbsp;(cost=2.31..9.79 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Recheck Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on p_201206_logtime_idx &nbsp;(cost=0.00..2.31 rows=8 width=0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Heap Scan on p_201207 p &nbsp;(cost=2.31..9.79 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Recheck Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on p_201207_logtime_idx &nbsp;(cost=0.00..2.31 rows=8 width=0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Heap Scan on p_201208 p &nbsp;(cost=2.31..9.79 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Recheck Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on p_201208_logtime_idx &nbsp;(cost=0.00..2.31 rows=8 width=0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Heap Scan on p_201209 p &nbsp;(cost=2.31..9.79 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Recheck Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on p_201209_logtime_idx &nbsp;(cost=0.00..2.31 rows=8 width=0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Heap Scan on p_201210 p &nbsp;(cost=2.31..9.79 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Recheck Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on p_201210_logtime_idx &nbsp;(cost=0.00..2.31 rows=8 width=0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Heap Scan on p_201211 p &nbsp;(cost=2.31..9.79 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Recheck Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on p_201211_logtime_idx &nbsp;(cost=0.00..2.31 rows=8 width=0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Heap Scan on p_201212 p &nbsp;(cost=2.31..9.79 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Recheck Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on p_201212_logtime_idx &nbsp;(cost=0.00..2.31 rows=8 width=0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Heap Scan on p_default p &nbsp;(cost=2.31..9.79 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Recheck Cond: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on p_default_logtime_idx &nbsp;(cost=0.00..2.31 rows=8 width=0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (logtime = now())</font></div><p></p></pre></div><div>-- 修改函数稳定性并重测.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# ALTER FUNCTION now() IMMUTABLE;</font></div><div><font size="2"  >ALTER FUNCTION</font></div><div><font size="2"  >postgres=# EXPLAIN SELECT * FROM p WHERE logtime=now();</font></div><div><font size="2"  >-- 同上</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# ALTER FUNCTION now() VOLATILE;</font></div><div><font size="2"  >ALTER FUNCTION</font></div><div><font size="2"  >postgres=# EXPLAIN SELECT * FROM p WHERE logtime=now();</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >-------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Result &nbsp;(cost=0.00..447.85 rows=105 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Append &nbsp;(cost=0.00..447.85 rows=105 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on p &nbsp;(cost=0.00..0.00 rows=1 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on p_201201 p &nbsp;(cost=0.00..34.45 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on p_201202 p &nbsp;(cost=0.00..34.45 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on p_201203 p &nbsp;(cost=0.00..34.45 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on p_201204 p &nbsp;(cost=0.00..34.45 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on p_201205 p &nbsp;(cost=0.00..34.45 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on p_201206 p &nbsp;(cost=0.00..34.45 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on p_201207 p &nbsp;(cost=0.00..34.45 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on p_201208 p &nbsp;(cost=0.00..34.45 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on p_201209 p &nbsp;(cost=0.00..34.45 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on p_201210 p &nbsp;(cost=0.00..34.45 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on p_201211 p &nbsp;(cost=0.00..34.45 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on p_201212 p &nbsp;(cost=0.00..34.45 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (logtime = now())</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on p_default p &nbsp;(cost=0.00..34.45 rows=8 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (logtime = now())</font></div><div><font size="2"  >(30 rows)</font></div><p></p></pre></div><div><br></div><div>【小结】</div><div><div>分区表使用注意事项 :&nbsp;</div><div><br></div><div>尽量将分区功能移至应用端代码中.</div><div>constraint_exclusion = partition</div><div>WHERE条件中与分区字段的约束契合必须使用constant</div><div>简化分区规则, 分区字段上使用简单的b-tree索引, 尽量避免函数索引.</div><div>使用数据库分区的潜在问题</div><div>CPU开销(触发器或rule, 硬解析)</div></div><div><br></div><div>【参考】</div><div>Thinking PostgreSQL Function's Volatility Categories</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201151011105494/"  >http://blog.163.com/digoal@126/blog/static/163877040201151011105494/</a></div><div><br></div><div>PostgreSQL partition table's arithmetic tuning example</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402011210114036419/"  >http://blog.163.com/digoal@126/blog/static/1638770402011210114036419/</a></div></div><div><br></div><div><br><br><wbr></div></div></div>
	</div>
</div>
</body>
</html>