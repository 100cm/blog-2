<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.2 devel Syntax : DROP INDEX CONCURRENTLY</h2>
	<h5 id="">2012-04-10 15:59:19&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201231032433370/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在PostgreSQL中创建索引有两种方法，</div><div>1. CREATE INDEX</div><div>被创建索引的表在创建索引期间不能进行insert, update, delete操作， 只能进行select 操作.</div><div>大多数生产系统不会允许这么来做, 即便要做也是要确定在创建索引期间不会对这个表进行写操作。否则会带来严重的锁等待问题。</div><div><br></div><div>2. CREATE INDEX CONCURRENTLY</div><div>分为两个事务，第一个事务在系统表中增加索引并置为INVALID。</div><div>第二个事务要扫描两次表，成功后将索引置为VALID。</div><div>如果建立的是unique的index, 并且在创建过程中失败了, 那么不会通过这个索引限制该列的唯一性. 但是这个索引还是有DML的overhead的。</div><div>invalid的索引可以通过REINDEX， 或者删掉重新创建来修复.</div><div>另外需要注意的是<span style="line-height: 22px;"   >CREATE INDEX CONCURRENTLY不能放在事务里面.</span></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >例如 :&nbsp;</span></div><div><div><pre class="prettyprint"   ><div><div><font size="2"   >digoal=&gt; create index concurrently idx_test_info on test(info);</font></div></div><div><font size="2"   >创建过程中查看</font></div><div><div><font size="2"   >digoal=&gt; \d test</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;Table "digoal.test"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >--------+---------+-----------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; | integer |&nbsp;</font></div><div><font size="2"   >&nbsp;info &nbsp; | text &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "idx_test_info" btree (info) INVALID</font></div></div><div><font size="2"   >创建完成后查看</font></div><div><div><font size="2"   >digoal=&gt; \d test</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;Table "digoal.test"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >--------+---------+-----------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; | integer |&nbsp;</font></div><div><font size="2"   >&nbsp;info &nbsp; | text &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "idx_test_info" btree (info)</font></div></div><p></p></pre></div></div><div>删除索引同样会阻挡DML操作, SELECT操作除外.</div><div>所以PostgreSQL9.2 将引入<span style="font-family: monospace; font-size: small; line-height: 19px; white-space: pre;"   >drop index concurrently语法.</span></div><div><font face="monospace"   size="2"   ><span style="line-height: 19px; white-space: pre;"   ><br></span></font></div><div><span style="font-family: monospace; font-size: small; line-height: 19px; white-space: pre;"   >例如 : </span></div><div><pre class="prettyprint"   ><p></p><div><font face="monospace"   size="2"   ><span style="line-height: 19px;"   >postgres=# create table test (id int,info text); CREATE TABLE</span></font></div><div><font face="monospace"   size="2"   ><span style="line-height: 19px;"   >postgres=# create unique index concurrently idx_test_info on test (info);</span></font></div><div><font face="monospace"   size="2"   ><span style="line-height: 19px;"   ><br></span></font></div><div><font face="monospace"   size="2"   ><span style="line-height: 19px;"   ># 强制关库</span></font></div><div><font face="monospace"   size="2"   ><div style="line-height: 19px;"   >pg92@db-172-16-3-150-&gt; pg_ctl stop -m immediate</div><div style="line-height: 19px;"   >waiting for server to shut down.... done</div><div style="line-height: 19px;"   >server stopped</div><div style="line-height: 19px;"   ># 启库</div><div>pg92@db-172-16-3-150-&gt; pg_ctl start</div><div><br></div><div># 查看索引状态</div><div>postgres=# \d test     &nbsp;</div><div>Table "public.test" &nbsp;</div><div>Column |  Type   | Modifiers</div><div>--------+---------+-----------</div><div>id     | integer |   info   | text    | &nbsp;</div><div>Indexes:     "idx_test_info"&nbsp;</div><div>    UNIQUE, btree (info) INVALID</div><div><br></div><div># 插入重复数据, 正常. 验证</div><div>postgres=# insert into test values (1,'digoal1') postgres-# ;&nbsp;</div><div>INSERT 0 1&nbsp;</div><div>postgres=# select * from test where id=1; &nbsp;</div><div>id |  info   &nbsp;</div><div>----+---------  &nbsp;</div><div>1 | digoal1  &nbsp;</div><div>1 | digoal1&nbsp;</div><div>(2 rows)</div><div><br></div><div># 使用<span style="line-height: 19px;"   >drop index concurrently删除invalid 索引.</span></div><div>postgres=# drop index concurrently idx_test_info;&nbsp;</div><div>DROP INDEX&nbsp;</div><div>postgres=# \d test     &nbsp;</div><div>Table "public.test" &nbsp;</div><div>Column |  Type   | Modifiers &nbsp;</div><div>--------+---------+----------- &nbsp;</div><div>id     | integer |   info   | text    | </div><div># 删除正常索引</div><div>postgres=# create index idx_test_info on test (info);&nbsp;</div><div>CREATE INDEX&nbsp;</div><div>postgres=# drop index concurrently idx_test_info;&nbsp;</div><div>DROP INDEX</div></font></div><p></p></pre></div><div><font face="monospace"   size="2"   ><div style="white-space: pre;"   ><br></div></font></div>【参考】<div><a rel="nofollow" href="https://commitfest.postgresql.org/action/patch_view?id=742"   >https://commitfest.postgresql.org/action/patch_view?id=742</a>&nbsp;<br><wbr><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/sql-createindex.html"   >http://www.postgresql.org/docs/9.1/static/sql-createindex.html</a> </div><div>src/backend/catalog/index.c</div><div>src/backend/commands/cluster.c</div><br></div></div>
	</div>
</div>
</body>
</html>