<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">pg_logforward</h2>
	<h5 id="">2012-04-15 15:44:41&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201231533230710/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>pg_logforward 使用后台执行的EmitErrorReport()函数收集postgresql产生的日志, 并通过UDP把日志发送到远端的logserver.</div><div><br></div><div>下载地址 :&nbsp;</div><div>https://github.com/mpihlak/pg_logforward/zipball/master</div><div><br></div><div>安装 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >su - root</font></div><div><font size="2"  >unzip&nbsp;mpihlak-pg_logforward-d55a09d.zip</font></div><div><font size="2"  >mv pg_logforward postgresql-9.2devel/contrib/</font></div><div><font size="2"  >chown -R pg92:pg92 /opt/soft_bak/postgresql-9.2devel/contrib/pg_logforward</font></div><div><font size="2"  >. /home/pg92/.bash_profile&nbsp;</font></div><div><font size="2"  >make</font></div><div><font size="2"  >make install</font></div><p></p></pre></div><div><br></div><div>在远程或本地启动logserver的监听服务(用到testing中的test_logserver.py).</div><div>python&nbsp;test_logserver.py</div><div><br></div><div>配置postgresql.conf示例 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >#custom_variable_classes = 'logforward' &nbsp; &nbsp; &nbsp; &nbsp; # deprecated in 9.2, PostgreSQL 9.2不需要配置此行</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >logforward.target_names = 'syslog,jsonsrv,netstr'</font></div><div><font size="2"  >logforward.syslog_host = '127.0.0.1'</font></div><div><font size="2"  >logforward.syslog_port = 23456</font></div><div><font size="2"  >logforward.syslog_min_elevel = 19 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # WARNING and above</font></div><div><font size="2"  >logforward.syslog_format = 'syslog' &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >logforward.syslog_facility = 'local1' &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >logforward.jsonsrv_host = '127.0.0.1'</font></div><div><font size="2"  >logforward.jsonsrv_port = 23456</font></div><div><font size="2"  >logforward.jsonsrv_message_filter = 'connect'</font></div><div><font size="2"  >logforward.jsonsrv_format = 'json'</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >logforward.netstr_host = '127.0.0.1'</font></div><div><font size="2"  >logforward.netstr_port = 23456</font></div><div><font size="2"  >logforward.netstr_message_filter = 'connect'</font></div><div><font size="2"  >logforward.netstr_format = 'netstr'</font></div><p></p></pre></div><div><br></div><div>logserver输出示例 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >-&gt; python ./test_logserver.py&nbsp;</font></div><div><font size="2"  >Listening on :23456</font></div><div><font size="2"  >raw message: { "username": null, "database": null, "remotehost": null, "debug_query_string": null, "elevel": 15, "funcname": "reaper", "sqlerrcode": 0, "message": "database system is ready to accept connections", "detail": null, "hint": null, "context": null }</font></div><div><font size="2"  >json parsing error: No module named json</font></div><div><font size="2"  >raw message: 2:15,1:0,0:,0:,0:,6:reaper,46:database system is ready to accept connections,0:,0:,0:,0:,</font></div><div><font size="2"  >netstr parsing error: No module named netstring</font></div><p></p></pre></div><div><br></div><div>release的时候需要再完善一下手册内容.</div><div><br></div><div>【参考】</div><div><a rel="nofollow" href="https://github.com/mpihlak/pg_logforward"  >https://github.com/mpihlak/pg_logforward</a> </div><div><a rel="nofollow" href="https://commitfest.postgresql.org/action/patch_view?id=717"  >https://commitfest.postgresql.org/action/patch_view?id=717</a> </div><div>README</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >Introduction</font></div><div><font size="2"  >============</font></div><div><font size="2"  >pg_logforward is a custom logging handler for PostgreSQL. It intercepts</font></div><div><font size="2"  >all PostgreSQL log messages by hooking into EmitErrorReport() function</font></div><div><font size="2"  >in the backend. The intercepted log messages are forwarded via UDP to</font></div><div><font size="2"  >a remote location.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Requires PostgreSQL logging hooks patch - included in the patches directory.</font></div><div><font size="2"  >The patch is against 9.2devel but also applies against 9.1 and 8.3. Although</font></div><div><font size="2"  >some offsets are expected.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Output formats</font></div><div><font size="2"  >==============</font></div><div><font size="2"  >The current version supports JSON, netstring and Syslog output formats.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Usage</font></div><div><font size="2"  >=====</font></div><div><font size="2"  >Modify postgresql.conf to include:</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >shared_preload_libraries = 'pg_logforward' &nbsp; &nbsp; &nbsp;# requires restart</font></div><div><font size="2"  >custom_variable_classes = 'logforward' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# deprecated in 9.2</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >logforward.target_names = 'syslog,jsonsrv,netstr'</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >logforward.syslog_host = '127.0.0.1'</font></div><div><font size="2"  >logforward.syslog_port = 23456</font></div><div><font size="2"  >logforward.syslog_min_elevel = 19 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # WARNING and above</font></div><div><font size="2"  >logforward.syslog_format = 'syslog' &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >logforward.syslog_facility = 'local1' &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >logforward.jsonsrv_host = '127.0.0.1'</font></div><div><font size="2"  >logforward.jsonsrv_port = 23457</font></div><div><font size="2"  >logforward.jsonsrv_message_filter = 'connect'</font></div><div><font size="2"  >logforward.jsonsrv_format = 'json'</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >logforward.netstr_host = '127.0.0.1'</font></div><div><font size="2"  >logforward.netstr_port = 23458</font></div><div><font size="2"  >logforward.netstr_message_filter = 'connect'</font></div><div><font size="2"  >logforward.netstr_format = 'netstr'</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Note that you need to copy the shared library also to $libdir/plugins if you</font></div><div><font size="2"  >are planning to use local_preload_libraries instead of shared_preload_libraries.</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>