<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Recover PostgreSQL data when truncated or droped table .</h2>
	<h5 id="">2012-04-23 11:30:10&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012323112445397/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">truncate表后, PostgreSQL把原来的数据文件删掉, 重新分配数据文件.<div>删掉的包含fsm,vm文件, 数据表的main数据文件, 索引相关的数据文件, toast表相关的数据文件.</div><div>数据存储在main文件和toast表的数据文件中. 所以要恢复必须先恢复这些数据文件.&nbsp;</div><div>恢复操作可以借助相关的磁盘恢复工具, 把删除掉的文件找回来. 所以这是前提条件.</div><div>下面我模拟的是文件找回后如何恢复, 其实很简单, 只是恢复后需要reindex和重新analyze .</div><div>创建测试表以及插入测试数据, 测试表包含text字段并使用了toast存储, 这是不了解PG的同学会忽略的地方.</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# create table drop_recovery_test(id int,info text);</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >postgres=# insert into drop_recovery_test select generate_series(1,100000),repeat('digoal',50);</font></div><div><font size="2"  >INSERT 0 100000</font></div><p></p></pre></div><div>创建索引, &nbsp;方便在恢复后查看一个特殊情况, 就是貌似数据还没找回, 原因是执行计划是走的索引但是索引没有恢复哦.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# create index idx_test on drop_recovery_test (info);</font></div><div><font size="2"  >CREATE INDEX</font></div><div><font size="2"  >postgres=# create index idx_test_1 on drop_recovery_test (id);</font></div><div><font size="2"  >CREATE INDEX</font></div><p></p></pre></div><div>首先要知道我们要恢复的文件是哪些个文件.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select relname from pg_class where oid in (select reltoastrelid from pg_class where relname='drop_recovery_test');</font></div><div><font size="2"  >&nbsp; &nbsp; relname &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----------------</font></div><div><font size="2"  >&nbsp;pg_toast_26056</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select pg_relation_filepath('drop_recovery_test');</font></div><div><font size="2"  >&nbsp;pg_relation_filepath&nbsp;</font></div><div><font size="2"  >----------------------</font></div><div><font size="2"  >&nbsp;base/12699/26062</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select pg_relation_filepath('pg_toast.pg_toast_26056');</font></div><div><font size="2"  >&nbsp;pg_relation_filepath&nbsp;</font></div><div><font size="2"  >----------------------</font></div><div><font size="2"  >&nbsp;base/12699/26063</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>停库</div><div><pre class="prettyprint"  ><p>pg_ctl stop</p></pre></div><div>把数据文件移动到别的地方</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >cd $PGDATA</font></div><div><font size="2"  >mv base/12699/26062 $PGDATA/26062</font></div><div><font size="2"  >mv base/12699/26063 $PGDATA/26063</font></div><p></p></pre></div><div>启库</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg_ctl start</font></div><div><font size="2"  >truncate 表</font></div><div><font size="2"  >postgres=# truncate table drop_recovery_test ;</font></div><div><font size="2"  >TRUNCATE TABLE</font></div><div><font size="2"  >postgres=# select * from drop_recovery_test ;</font></div><div><font size="2"  >&nbsp;id | info&nbsp;</font></div><div><font size="2"  >----+------</font></div><div><font size="2"  >(0 rows)</font></div><p></p></pre></div><div>truncate完后, 找到新分配的文件位置</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select relname from pg_class where oid in (select reltoastrelid from pg_class where relname='drop_recovery_test');</font></div><div><font size="2"  >&nbsp; &nbsp; relname &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----------------</font></div><div><font size="2"  >&nbsp;pg_toast_26056</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select pg_relation_filepath('drop_recovery_test');</font></div><div><font size="2"  >&nbsp;pg_relation_filepath&nbsp;</font></div><div><font size="2"  >----------------------</font></div><div><font size="2"  >&nbsp;base/12699/26067</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select pg_relation_filepath('pg_toast.pg_toast_26056');</font></div><div><font size="2"  >&nbsp;pg_relation_filepath&nbsp;</font></div><div><font size="2"  >----------------------</font></div><div><font size="2"  >&nbsp;base/12699/26068</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>停库, 恢复</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg_ctl stop</font></div><div><font size="2"  >cd $PGDATA</font></div><div><font size="2"  >mv 26062 base/12699/26067</font></div><div><font size="2"  >mv 26063 base/12699/26068</font></div><p></p></pre></div><div>启库, 查看恢复结果</div><div><pre class="prettyprint"  ><p><font size="2"  >pg_ctl start</font></p></pre></div><div>这个查询是全部扫描, 所以能看到数据</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select * from drop_recovery_test limit 1;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+-------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >-------------------------------------------</font></div><div><font size="2"  >&nbsp; 1 | digoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoal</font></div><div><font size="2"  >digoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoal</font></div><div><font size="2"  >digoaldigoaldigoaldigoaldigoaldigoaldigoal</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# \d+ drop_recovery_test&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Table "public.drop_recovery_test"</font></div><div><font size="2"  >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers | Storage &nbsp;| Description&nbsp;</font></div><div><font size="2"  >--------+---------+-----------+----------+-------------</font></div><div><font size="2"  >&nbsp;id &nbsp; &nbsp; | integer | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;info &nbsp; | text &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended |&nbsp;</font></div><div><font size="2"  >Indexes:</font></div><div><font size="2"  >&nbsp; &nbsp; "idx_test" btree (info)</font></div><div><font size="2"  >&nbsp; &nbsp; "idx_test_1" btree (id)</font></div><div><font size="2"  >Has OIDs: no</font></div><p></p></pre></div><div>这个查询为啥没有数据呢, 因为走的是索引但是索引没恢复嘛</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select * from drop_recovery_test where id=1;</font></div><div><font size="2"  >&nbsp;id | info&nbsp;</font></div><div><font size="2"  >----+------</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  >postgres=# explain select * from drop_recovery_test where id=1;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >-------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Bitmap Heap Scan on drop_recovery_test &nbsp;(cost=8.13..799.53 rows=500 width=36)</font></div><div><font size="2"  >&nbsp; &nbsp;Recheck Cond: (id = 1)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on idx_test_1 &nbsp;(cost=0.00..8.01 rows=500 width=0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (id = 1)</font></div><div><font size="2"  >(4 rows)</font></div><p></p></pre></div><div><br></div><div>-- 重建索引后走索引的数据就正常了</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# reindex table drop_recovery_test;</font></div><div><font size="2"  >REINDEX</font></div><div><font size="2"  >postgres=# select * from drop_recovery_test where id=1;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+-------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >-------------------------------------------</font></div><div><font size="2"  >&nbsp; 1 | digoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoal</font></div><div><font size="2"  >digoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoaldigoal</font></div><div><font size="2"  >digoaldigoaldigoaldigoaldigoaldigoaldigoal</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>但是貌似不应该用bitmap</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# explain select * from drop_recovery_test where id=1;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >-------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Bitmap Heap Scan on drop_recovery_test &nbsp;(cost=8.13..799.53 rows=500 width=36)</font></div><div><font size="2"  >&nbsp; &nbsp;Recheck Cond: (id = 1)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on idx_test_1 &nbsp;(cost=0.00..8.01 rows=500 width=0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (id = 1)</font></div><div><font size="2"  >(4 rows)</font></div><p></p></pre></div><div>所以vacuum analyze 后执行计划正常.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# vacuum analyze drop_recovery_test ;</font></div><div><font size="2"  >VACUUM</font></div><div><font size="2"  >postgres=# explain select * from drop_recovery_test where id=1;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >---------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Index Scan using idx_test_1 on drop_recovery_test &nbsp;(cost=0.00..4.27 rows=1 width=308)</font></div><div><font size="2"  >&nbsp; &nbsp;Index Cond: (id = 1)</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div><br></div><div>如果是drop表的话, 恢复方法与上面类似.&nbsp;</div><div>1. 在表所在的文件系统中使用文件恢复工具找回RM掉的文件.</div><div>2. 如果文件已经找不回来了 , 如果有基础备份, 那就用基础备份做PITR的恢复.</div><div>3. 如果没有基础备份但是有pg_dump的逻辑备份, 可从逻辑备份恢复.</div><div>4. 如果以上都没有, 但是有standby数据库, 可以考虑从standby库重复以上方法.</div><div>5. 如果有基础备份, 但是不想做PITR, 只想找到对应的文件. 并使用雷同以上truncate的恢复方法恢复. 那就把基础备份恢复到某个时间点. 把基础备份的目录当成$PGDATA, 启动数据库, 注意启动时修改一下备份的PGDATA的postgresql.conf以免端口冲突.</div><div>6. 如果基础备份因为种种原因起不来, 可以尝试一下postgres单用户启动.(设置pg_clog比特位=0). 修改前注意备份.</div><br><wbr></div></div>
	</div>
</div>
</body>
</html>