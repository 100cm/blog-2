<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use pgsql_fdw create PostgreSQL Foreign Table</h2>
	<h5 id="">2012-04-15 15:03:26&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201231514057303/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>以前有写过在PostgreSQL数据库中创建redis, oracle, mysql, csv等外部表的BLOG, 有兴趣的朋友可以参考如下</div><div><div><font color="#0000ee"  >PostgreSQL Foreign Table - pgsql_fdw</font></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201231514057303/"  >http://blog.163.com/digoal@126/blog/static/163877040201231514057303/</a></div><div><font color="#0000ee"  >PostgreSQL Foreign Table - oracle_fdw 1</font></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201181505331588/"  >http://blog.163.com/digoal@126/blog/static/163877040201181505331588/</a></div><div><font color="#0000ee"  >PostgreSQL Foreign Table - oracle_fdw 2</font></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020118151162340/"  >http://blog.163.com/digoal@126/blog/static/16387704020118151162340/</a></div><div><font color="#0000ee"  >PostgreSQL Foreign Table - oracle_fdw 3</font></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020118951953408/"  >http://blog.163.com/digoal@126/blog/static/16387704020118951953408/</a></div><div><font color="#0000ee"  >PostgreSQL Foreign Table - file_fdw</font></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201141641148311/"  >http://blog.163.com/digoal@126/blog/static/163877040201141641148311/</a></div><div><font color="#0000ee"  >PostgreSQL Foreign Table - redis_fdw</font></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020119181188247/"  >http://blog.163.com/digoal@126/blog/static/16387704020119181188247/</a></div><div><font color="#0000ee"  >PostgreSQL Foreign Table - mysql_fdw 1</font></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402011111233524987/"  >http://blog.163.com/digoal@126/blog/static/1638770402011111233524987/</a></div><div><font color="#0000ee"  >PostgreSQL Foreign Table - mysql_fdw 2</font></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020121108551698/"  >http://blog.163.com/digoal@126/blog/static/16387704020121108551698/</a></div></div><div style="line-height: 22px;"  ><br></div><div>今天主要是讲一下使用pgsql_fdw来创建PostgreSQL外部表的情况,</div><div>pgsql_fdw下载地址</div><div><a rel="nofollow" href="http://download.opensuse.org/repositories//server:/database:/postgresql/openSUSE_12.1/src/"  >http://download.opensuse.org/repositories//server:/database:/postgresql/openSUSE_12.1/src/</a> </div><div>下载后执行如下进行安装</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >su - root</font></div><div><font size="2"  >rpm -ivh&nbsp;pgsql_fdw-1.0-1.2.src.rpm</font></div><div><font size="2"  >cd /usr/src/redhat/SOURCES/</font></div><div><font size="2"  >tar -zxvf&nbsp;pgsql_fdw-1.0.tar.gz</font></div><div><font size="2"  >chown -R postgres:postgres pgsql_fdw-1.0</font></div><div><font size="2"  >mv pgsql_fdw-1.0 /opt/soft_bak/postgresql-9.1.3/contrib/</font></div><div><font size="2"  >cd /opt/soft_bak/postgresql-9.1.3/contrib/pgsql_fdw</font></div><div><font size="2"  >. /home/postgres/.bash_profile</font></div><div><font size="2"  >USE_PGXS=1 make</font></div><div><font size="2"  >USE_PGXS=1 make install</font></div><p></p></pre></div><div>创建 pgsql_fdw extension</div><div><pre class="prettyprint"  ><p><font size="2"  >postgres=# create extension pgsql_fdw;</font></p></pre></div><div>在远程库创建测试数据</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >test=# create table user_info (id int,info text);</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >test=# insert into user_info select generate_series(1,1000000),'digoal';</font></div><div><font size="2"  >INSERT 0 1000000</font></div><p></p></pre></div><div>在本地库创建SERVER</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# CREATE SERVER test FOREIGN DATA WRAPPER pgsql_fdw</font></div><div><font size="2"  >postgres-# OPTIONS (host '172.16.3.150', port '5432', dbname 'test');</font></div><div><font size="2"  >CREATE SERVER</font></div><p></p></pre></div><div>在本地库创建user mapping</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# CREATE USER MAPPING FOR postgres SERVER test</font></div><div><font size="2"  >postgres-# OPTIONS (user 'postgres', password 'postgres');</font></div><div><font size="2"  >CREATE USER MAPPING</font></div><p></p></pre></div><div>创建foreign table</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# CREATE FOREIGN TABLE user_info (</font></div><div><font size="2"  >postgres(# id int,</font></div><div><font size="2"  >postgres(# info text) server test</font></div><div><font size="2"  >postgres-# ;</font></div><div><font size="2"  >CREATE FOREIGN TABLE</font></div><div><font size="2"  >postgres=# select count(*) from user_info ;</font></div><div><font size="2"  >&nbsp; count &nbsp;</font></div><div><font size="2"  >---------</font></div><div><font size="2"  >&nbsp;1000000</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div></div><div>执行计划 :&nbsp;</div><div>1 . 未用到的列以null替代.</div><div>2. 远程SQL使用的是declare scroll cursor的SQL.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# explain verbose select count(*) from user_info ;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Aggregate &nbsp;(cost=13817.72..13817.73 rows=1 width=0)</font></div><div><font size="2"  >&nbsp; &nbsp;Output: count(*)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Foreign Scan on public.user_info &nbsp;(cost=100.00..12155.38 rows=664938 width=0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id, info</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Remote SQL: DECLARE pgsql_fdw_cursor_3 SCROLL CURSOR FOR SELECT NULL, NULL FROM public.user_info</font></div><div><font size="2"  >(5 rows)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# explain verbose select * from user_info ;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >--------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Foreign Scan on public.user_info &nbsp;(cost=100.00..12155.38 rows=664938 width=36)</font></div><div><font size="2"  >&nbsp; &nbsp;Output: id, info</font></div><div><font size="2"  >&nbsp; &nbsp;Remote SQL: DECLARE pgsql_fdw_cursor_4 SCROLL CURSOR FOR SELECT id, info FROM public.user_info</font></div><div><font size="2"  >(3 rows)</font></div><p></p></pre></div><div>查询完后pgsql_fdw 不会离开释放远程连接, 以便后来的SQL可以服用这个连接. 但是如果事务abort的话会释放.</div><div>查看当前已经存在的连接</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >postgres=# select * from pgsql_fdw_get_connections();</font></div><div><font size="2"  >&nbsp;srvid | usesysid&nbsp;</font></div><div><font size="2"  >-------+----------</font></div><div><font size="2"  >&nbsp;25420 | &nbsp; &nbsp; &nbsp; 10</font></div><div><font size="2"  >(1 row)</font></div></div><div><div><font size="2"  >postgres=# select oid,* from pg_foreign_server ;</font></div><div><font size="2"  >&nbsp; oid &nbsp;| srvname | srvowner | srvfdw | srvtype | srvversion | srvacl | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;srvoptions &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >-------+---------+----------+--------+---------+------------+--------+-------------------------------------------</font></div><div><font size="2"  >&nbsp;25420 | test &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 10 | &nbsp;25407 | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| {host=172.16.3.150,port=1921,dbname=test}</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div>强制断开连接 :&nbsp;</div><div><div><pre class="prettyprint"  ><div><font size="2"  >postgres=# select * from pgsql_fdw_disconnect(25420,10);</font></div><div><font size="2"  >&nbsp;pgsql_fdw_disconnect&nbsp;</font></div><div><font size="2"  >----------------------</font></div><div><font size="2"  >&nbsp;OK</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# select * from pgsql_fdw_get_connections();</font></div><div><font size="2"  >&nbsp;srvid | usesysid&nbsp;</font></div><div><font size="2"  >-------+----------</font></div><div><font size="2"  >(0 rows)</font></div><p></p></pre></div></div><div><br></div><div>同一个SQL语句中如果使用了多个FOREIGN TABLE并且对应的FOREIGN SERVER是同一个， 那么可以共享一个连接.</div><div><br></div><div>【其他】</div><div>1. server, user mapping, foreign table可用的参数参考README.</div><div>2.&nbsp;<span style="line-height: 22px;"  >事务相关参考README.</span></div><div><br></div>【参考】<wbr><div><a rel="nofollow" href="http://interdbconnect.sourceforge.net/pgsql_fdw/pgsql_fdw-en.html"  >http://interdbconnect.sourceforge.net/pgsql_fdw/pgsql_fdw-en.html</a> </div><div><a rel="nofollow" href="http://archives.postgresql.org/message-id/4F7D8BBF.4050004@gmail.com"  >http://archives.postgresql.org/message-id/4F7D8BBF.4050004@gmail.com</a> </div><div><a rel="nofollow" href="http://download.opensuse.org/repositories//server:/database:/postgresql/openSUSE_12.1/src/"  >http://download.opensuse.org/repositories//server:/database:/postgresql/openSUSE_12.1/src/</a> </div><div>README</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >SQL sent to remote PostgreSQL</font></div><div><font size="2"  >-----------------------------</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Foreign tables can be used in any SELECT statement, including CTE, subquery and</font></div><div><font size="2"  >PREPARE statement. &nbsp;Currently pgsql_fdw sends SELECT query for each foreign</font></div><div><font size="2"  >table appears in the local query. &nbsp;This means that every join is done on local</font></div><div><font size="2"  >side.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Some kind of query can be optimized by pgsql_fdw.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; 1) unused column reference would be replaced with "NULL".</font></div><div><font size="2"  >&nbsp; &nbsp; 2) some part of WHERE/JOIN clause, which consists of limited elements, can</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;be sent and evaluated on remote side. &nbsp;Expressions can be sent are:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * constant value</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * array, if every elements suit these rules recursively</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * immutable built-in functions, if every arguments suit these rules</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; recursively</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * built-in operators implemented with immutable functions, if every</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; operands suit these rules recursively</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * Boolean expressions such as AND, OR and NOT</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * x IS NULL and x IS NOT NULL</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * x IS DISTINCT FROM y</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * scalar op ANY/ALL (array), if op is immutable and built-in</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * argument of EXECUTE statement</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * reference to the column of the foreign table</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >The pgsql_fdw always uses DECLARE statement to declare a cursor for each scan,</font></div><div><font size="2"  >and fetches result separately when next bunch of result is required.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >FDW options</font></div><div><font size="2"  >-----------</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >The pgsql_fdw accepts various FDW options, and they can be classified to some</font></div><div><font size="2"  >groups.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >* Connection options</font></div><div><font size="2"  >The pgsql_fdw reads connection information from FDW options of foreign</font></div><div><font size="2"  >server and user mapping. &nbsp;The pgsql_fdw accepts subset of libpq connection</font></div><div><font size="2"  >options:</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; * For server option</font></div><div><font size="2"  >&nbsp; &nbsp; authtype, service, connect_timeout, dbname, host, hostaddr, port, tty,</font></div><div><font size="2"  >&nbsp; &nbsp; options, application_name, keepalives, keepalives_idle,</font></div><div><font size="2"  >&nbsp; &nbsp; keepalives_interval, keepalives_count, requiressl, sslmode, sslcert,</font></div><div><font size="2"  >&nbsp; &nbsp; sslkey, sslrootcert, sslcrl, requirepeer, krbsrvname, gsslib</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; * For user mapping option</font></div><div><font size="2"  >&nbsp; &nbsp; user, password</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Note: If you omit connection information, pgsql_fdw takes the alternatives from</font></div><div><font size="2"  >environment variables of the user who launched the postgres server. &nbsp;Usually</font></div><div><font size="2"  >such omission would cause unexpected result, so it's strongly recommended to</font></div><div><font size="2"  >specify connection information explicitly as much as you can.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >* Object name options</font></div><div><font size="2"  >You can specify schema name and relation name of a remote table as foreign</font></div><div><font size="2"  >table's FDW option nspname and relname respectively. &nbsp;These options allow</font></div><div><font size="2"  >you to define local foreign tables with different name from remote side.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >* Cursor options</font></div><div><font size="2"  >You can control number of rows fetched at a time by specifying fetch_count FDW</font></div><div><font size="2"  >option on foreign table or foreign server. &nbsp;If you specified on both, setting</font></div><div><font size="2"  >of foreign table is used. &nbsp;Default value is 10000.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Connection management</font></div><div><font size="2"  >---------------------</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Connection to a foreign server is established in the beginning of first query</font></div><div><font size="2"  >which uses a foreign server, and it is kept even though the query has finished.</font></div><div><font size="2"  >The pgsql_fdw shares a connection when multiple foreign tables are used in a</font></div><div><font size="2"  >local query and they belong to same foreign server.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >However, if local transaction aborts, all connections are discarded</font></div><div><font size="2"  >automatically. &nbsp;This behavior would avoid possible connection leak on error</font></div><div><font size="2"  >cases.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >When you want to discard persistent connection at arbitrary timing, use</font></div><div><font size="2"  >pgsql_fdw_disconnect() with server oid and user oid in the session which has</font></div><div><font size="2"  >established the connection. &nbsp;You can also see list of active connections via</font></div><div><font size="2"  >pgsql_fdw_connections view.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Transaction management</font></div><div><font size="2"  >----------------------</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >The pgsql_fdw executes BEGIN when a new connection has established. &nbsp;This means</font></div><div><font size="2"  >that all remote queries are executed in a transaction. &nbsp;Since the default</font></div><div><font size="2"  >transaction isolation level is READ COMMITTED, multiple foreign scans in a</font></div><div><font size="2"  >local query might produce inconsistent results.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >To avoid this inconsistency, you can use SERIALIZABLE level for remote</font></div><div><font size="2"  >transaction with setting default_transaction_isolation for the user used for</font></div><div><font size="2"  >pgsql_fdw connection on remote side.</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>