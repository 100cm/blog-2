<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">linux下内存释放问题[转]</h2>
	<h5 id="">2010-07-09 9:08:33&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201069983381/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><span style="font-family: song, Verdana; line-height: normal; font-size: 12px; border-collapse: collapse;"  ><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >细心的朋友会注意到,当你在linux下频繁存取文件后,物理内存会很快被用光,当程序结束后,内存不会被正常释放,而是一直作为caching.这个问题,貌似有不少人在问,不过都没有看到有什么很好解决的办法.那么我来谈谈这个问题.</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >先来说说free命令</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >[root@server ~]# free -m<br style="font: normal normal normal 12px/normal song, Verdana;"  >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; total&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; used&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; free&nbsp;&nbsp;&nbsp;&nbsp; shared&nbsp;&nbsp;&nbsp; buffers&nbsp;&nbsp;&nbsp;&nbsp; cached<br style="font: normal normal normal 12px/normal song, Verdana;"  >Mem:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 249&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 163&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 86&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 94<br style="font: normal normal normal 12px/normal song, Verdana;"  >-/+ buffers/cache:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 58&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 191<br style="font: normal normal normal 12px/normal song, Verdana;"  >Swap:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 511&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 511</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  ><font size="4"  >其中:</font></font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >total 内存总数</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >used 已经使用的内存数</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >free 空闲的内存数</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >shared 多个进程共享的内存总额</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >buffers Buffer Cache和</font><font size="3"  >cached Page Cache 磁盘缓存的大小</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >-buffers/cache 的内存数:used - buffers - cached</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >+buffers/cache 的内存数:free + buffers + cached</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >可用的memory=free memory+buffers+cached</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >有了这个基础后,可以得知,我现在used为163MB,free为86,buffer和cached分别为10,94</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >那么我们来看看,如果我执行复制文件,内存会发生什么变化.</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >[root@server ~]# cp -r /etc ~/test/<br style="font: normal normal normal 12px/normal song, Verdana;"  >[root@server ~]# free -m<br style="font: normal normal normal 12px/normal song, Verdana;"  >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; total&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; used&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; free&nbsp;&nbsp;&nbsp;&nbsp; shared&nbsp;&nbsp;&nbsp; buffers&nbsp;&nbsp;&nbsp;&nbsp; cached<br style="font: normal normal normal 12px/normal song, Verdana;"  >Mem:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 249&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 244&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 174<br style="font: normal normal normal 12px/normal song, Verdana;"  >-/+ buffers/cache:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 62&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 187<br style="font: normal normal normal 12px/normal song, Verdana;"  >Swap:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 511&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 511</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >在我命令执行结束后,used为244MB,free为4MB,buffers为8MB,cached为174MB,天呐都被cached吃掉了.别紧张,这是为了提高文件读取效率的做法.</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >引用<a style="text-decoration: underline; color: rgb(0, 68, 182);" rel="nofollow" href="http://www.wujianrong.com/archives/2007/09/linux_free.html"  ><font color="#0000ff"  >http://www.wujianrong.com/archives/2007/09/linux_free.html</font></a>"为了提高磁盘存取效率, Linux做了一些精心的设计, 除了对dentry进行缓存(用于VFS,加速文件路径名到inode的转换), 还采取了两种主要Cache方式：Buffer Cache和Page Cache。前者针对磁盘块的读写，后者针对文件inode的读写。这些Cache有效缩短了 I/O系统调用(比如read,write,getdents)的时间。"</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >那么有人说过段时间,linux会自动释放掉所用的内存,我们使用free再来试试,看看是否有释放&gt;?</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >[root@server test]# free -m<br style="font: normal normal normal 12px/normal song, Verdana;"  >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; total&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; used&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; free&nbsp;&nbsp;&nbsp;&nbsp; shared&nbsp;&nbsp;&nbsp; buffers&nbsp;&nbsp;&nbsp;&nbsp; cached<br style="font: normal normal normal 12px/normal song, Verdana;"  >Mem:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 249&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 244&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 174<br style="font: normal normal normal 12px/normal song, Verdana;"  >-/+ buffers/cache:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 61&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 188<br style="font: normal normal normal 12px/normal song, Verdana;"  >Swap:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 511&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 511</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >MS没有任何变化,那么我能否手动释放掉这些内存呢???回答是可以的!</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >/proc是一个虚拟文件系统,我们可以通过对它的读写操作做为与kernel实体间进行通信的一种手段.也就是说可以通过修改/proc中的文件,来对当前kernel的行为做出调整.那么我们可以通过调整/proc/sys/vm/drop_caches来释放内存.操作如下:</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >[root@server test]# cat /proc/sys/vm/drop_caches<br style="font: normal normal normal 12px/normal song, Verdana;"  >0</font><br style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >首先,/proc/sys/vm/drop_caches的值,默认为0</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >[root@server test]# sync</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >手动执行sync命令(描述:<span>sync</span>&nbsp;命令运行&nbsp;<span>sync</span>&nbsp;子例程。如果必须停止系统，则运行&nbsp;<span>sync</span>&nbsp;命令以确保文件系统的完整性。<span>sync</span>&nbsp;命令将所有未写的系统缓冲区写到磁盘中，包含已修改的 i-node、已延迟的块 I/O 和读写映射文件)</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >[root@server test]# echo 3 &gt; /proc/sys/vm/drop_caches<br style="font: normal normal normal 12px/normal song, Verdana;"  >[root@server test]# cat /proc/sys/vm/drop_caches<br style="font: normal normal normal 12px/normal song, Verdana;"  >3</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >将/proc/sys/vm/drop_caches值设为3</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >[root@server test]# free -m<br style="font: normal normal normal 12px/normal song, Verdana;"  >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; total&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; used&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; free&nbsp;&nbsp;&nbsp;&nbsp; shared&nbsp;&nbsp;&nbsp; buffers&nbsp;&nbsp;&nbsp;&nbsp; cached<br style="font: normal normal normal 12px/normal song, Verdana;"  >Mem:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 249&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 66&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 182&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 11<br style="font: normal normal normal 12px/normal song, Verdana;"  >-/+ buffers/cache:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 194<br style="font: normal normal normal 12px/normal song, Verdana;"  >Swap:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 511&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 511</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >再来运行free命令,发现现在的used为66MB,free为182MB,buffers为0MB,cached为11MB.那么有效的释放了buffer和cache.</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >有关/proc/sys/vm/drop_caches的用法在下面进行了说明</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >/proc/sys/vm/drop_caches (since Linux 2.6.16)<br style="font: normal normal normal 12px/normal song, Verdana;"  >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Writing&nbsp; to&nbsp; this&nbsp; file&nbsp; causes the kernel to drop clean caches,<br style="font: normal normal normal 12px/normal song, Verdana;"  >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dentries and inodes from memory, causing that memory&nbsp; to&nbsp; become<br style="font: normal normal normal 12px/normal song, Verdana;"  >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; free.</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; To&nbsp; free&nbsp; pagecache,&nbsp; use&nbsp; echo 1 &gt; /proc/sys/vm/drop_caches; to<br style="font: normal normal normal 12px/normal song, Verdana;"  >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; free dentries and inodes, use echo 2 &gt; /proc/sys/vm/drop_caches;<br style="font: normal normal normal 12px/normal song, Verdana;"  >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; to&nbsp;&nbsp; free&nbsp;&nbsp; pagecache,&nbsp;&nbsp; dentries&nbsp; and&nbsp; inodes,&nbsp; use&nbsp; echo&nbsp; 3&nbsp; &gt;<br style="font: normal normal normal 12px/normal song, Verdana;"  >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /proc/sys/vm/drop_caches.</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Because this is a non-destructive operation&nbsp; and&nbsp; dirty&nbsp; objects<br style="font: normal normal normal 12px/normal song, Verdana;"  >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; are not freeable, the user should run sync(8) first.</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  >[from]</font></p><p align="left"  style="font: normal normal normal 12px/normal song, Verdana;"  ><font size="3"  ><a rel="nofollow" href="http://blog.chinaunix.net/u/27173/showart_467689.html"  >http://blog.chinaunix.net/u/27173/showart_467689.html</a></font></p></span></div>
	</div>
</div>
</body>
</html>