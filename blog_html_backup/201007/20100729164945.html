<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use posix_fadvise pre-cache frequency data</h2>
	<h5 id="">2010-07-29 16:49:45&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201062944945126/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><p>数据库启动的时候，数据是冷却的，在执行SQL时需要到磁盘搜索BLOCK并载入到BUFFER，这个时候的SQL响应速度比命中情况下的响应速度一般要慢10倍以上，这种一般被称为未命中的查询。</p>  <p>如果数据库启动的时候刚好遇到SQL执行高峰，可能应为SQL响应速度过慢导致应用被堵塞死。造成长时间的应用堵塞，恶性循环。</p>  <p>那么怎么更好的解决这种类似的情况，今天刚好看到了PostgreSQL上的一个很好的例子。</p>  <p>pgfincore,这个项目是利用posix_fadvise来对PostgreSQL数据库对象文件进行缓存，放到OS级别的缓存中（注意不是数据库buffer）。所以数据库去文件系统取BLOCK的时候实际上是在操作系统的缓存就拿到的。比直接从磁盘取要快很多。</p>  <p>下面是posix_fadvise的简单描述：</p>  <p></p><pre class="prettyprint"   ><p></p><p><font size="2"   >The <i>posix_fadvise</i>() function shall advise the implementation on the expected behavior of the application with respect to the data in the file associated with the open file descriptor, <i>fd</i>, starting at <i>offset</i> and continuing for <i>len</i> bytes. The specified range need not currently exist in the file. If <i>len</i> is zero, all data following <i>offset</i> is specified. The implementation may use this information to optimize handling of the specified data. The <i>posix_fadvise</i>() function shall have no effect on the semantics of other operations on the specified data, although it may affect the performance of other operations.</font></p>  <p><font size="2"   >The advice to be applied to the data is specified by the <i>advice</i> parameter and may be one of the following values:</font></p>  <dl compact=""   >  <dt><font size="2"   >POSIX_FADV_NORMAL   </font></dt><dd><font size="2"   >Specifies that the application has no advice to give on its behavior with respect to the specified data. It is the default characteristic if no advice is given for an open file.   </font></dd><dt><font size="2"   >POSIX_FADV_SEQUENTIAL   </font></dt><dd><font size="2"   >Specifies that the application expects to access the specified data sequentially from lower offsets to higher offsets.   </font></dd><dt><font size="2"   >POSIX_FADV_RANDOM   </font></dt><dd><font size="2"   >Specifies that the application expects to access the specified data in a random order.   </font></dd><dt><font size="2"   >POSIX_FADV_WILLNEED   </font></dt><dd><font size="2"   >Specifies that the application expects to access the specified data in the near future.   </font></dd><dt><font size="2"   >POSIX_FADV_DONTNEED   </font></dt><dd><font size="2"   >Specifies that the application expects that it will not access the specified data in the near future.   </font></dd><dt><font size="2"   >POSIX_FADV_NOREUSE   </font></dt><dd><font size="2"   >Specifies that the application expects to access the specified data once and then not reuse it thereafter.</font></dd></dl>  <h4><font size="2"   ><a name="tag_03_421_04" rel="nofollow"   ></a>RETURN VALUE</font></h4>  <blockquote>  <p><font size="2"   >Upon successful completion, <i>posix_fadvise</i>() shall return zero; otherwise, an error number shall be returned to indicate the error.</font></p></blockquote>  <h4><font size="2"   ><a name="tag_03_421_05" rel="nofollow"   ></a>ERRORS</font></h4>  <blockquote>  <p><font size="2"   >The <i>posix_fadvise</i>() function shall fail if:</font></p>  <dl compact=""   >  <dt><font size="2"   >[EBADF]   </font></dt><dd><font size="2"   >The <i>fd</i> argument is not a valid file descriptor.   </font></dd><dt><font size="2"   >[EINVAL]   </font></dt><dd><font size="2"   >The value of <i>advice</i> is invalid.   </font></dd><dt><font size="2"   >[ESPIPE]   </font></dt><dd><font size="2"   >The <i>fd</i> argument is associated with a pipe or FIFO.</font></dd></dl></blockquote><p></p></pre>  <p>下面进入主题：</p>  <p>&nbsp;</p>  <p>1. 安装pgfincore：</p>  <p>1.1 将下载好的pgfincore解压后,拷贝到postgresql的源代码目录/contrib/</p>  <p></p><pre class="prettyprint"   ><p></p><p><font size="2"   >chown -R postgres:postgres postgresql的源代码目录</font></p>  <p><font size="2"   >su - postgres</font></p>  <p><font size="2"   >cd postgresql的源代码目录/contrib/pgfincore </font></p>  <p><font size="2"   >USE_PGXS=1 make clean<br>USE_PGXS=1 make</font></p><p></p></pre>  <p>1.2 su - root</p>  <p></p><pre class="prettyprint"   ><p></p><p><font size="2"   >. /home/postgres/.bash_profile</font></p>  <p><font size="2"   >cd postgresql的源代码目录/contrib/pgfincore </font></p>  <p><font size="2"   >USE_PGXS=1 make install</font></p><p></p></pre>  <p>1.3 su - postgres</p>  <p></p><pre class="prettyprint"   ><p></p><p><font size="2"   >cd postgresql的安装目录/share/contrib</font></p>  <p><font size="2"   >psql mydb superuser -f ./pgfincore.sql</font></p><p></p></pre>  <p>2.&nbsp;使用场景：</p>  <p>2.1 将表或者索引的数据文件加载到OS缓存：</p>  <p></p><pre class="prettyprint"   ><p>cedric=# select * from pgfadv_willneed('pgbench_accounts');<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; relpath&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | block_size | block_disk | block_free <br>--------------------+------------+------------+------------<br>base/16384/24598&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp; 262144 |&nbsp;&nbsp;&nbsp;&nbsp; 111882<br>base/16384/24598.1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 55318 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 56764<br>(2 rows)<br>&nbsp;<br>Time: 39309,294 ms</p></pre>  <p>relpath代表文件名。</p>  <p>block_size代表块大小。</p>  <p>block_disk代表数据对象大小，使用块为单位。</p>  <p>block_free代表OS cache还有多少，使用块为单位。</p>  <p>2.2 将表或索引的在内存中的状态保存到磁盘（这里保存的应该是类似地址的东西，会在数据文件目录创建带有_mincore后缀的文件）.</p>  <p>当数据库刚启动的时候，查询会比较慢，应为PostgreSQL和OS级别的缓存都还没有缓存需要的BLOCK。</p>  <p>执行下面的命令来快照和还原一个OS CACHE。</p>  <p></p><pre class="prettyprint"   ><p></p><p><font size="2"   >-- Snapshot<br>cedric=# select * from pgmincore_snapshot('pgbench_accounts');<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; relpath&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | block_size | block_disk | block_mem | group_mem <br>--------------------+------------+------------+-----------+-----------<br>base/16384/24598&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp; 262144 |&nbsp;&nbsp;&nbsp; 131745 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1<br>base/16384/24598.1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 55318 |&nbsp;&nbsp;&nbsp;&nbsp; 55318 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1<br>&nbsp;<br>-- Restore<br>cedric=# select * from pgfadv_willneed_snapshot('pgbench_accounts');<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; relpath&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | block_size | block_disk | block_free <br>--------------------+------------+------------+------------<br>base/16384/24598&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp; 262144 |&nbsp;&nbsp;&nbsp;&nbsp; 105335<br>base/16384/24598.1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 55318 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 50217<br>(2 rows)<br>&nbsp;<br>Time: 38745,140 ms</font></p>  <p><font size="2"   ><em>The column “block_mem” report how many blocks of the file are in memory.</em> <em>The column “group_mem” report that all the bloks in memory are contigous (only one group).</em></font></p><p></p></pre>  <p>BLOCK_MEM：对应这行的文件有多少个块已经缓存在OS CACHE中了。</p>  <p>GREOUP_MEM：有多少组连续内存。</p>  <p>3. 函数解说：</p>  <p>3.1 <a id="pgsysconf" name="pgsysconf" rel="nofollow"   >pgsysconf</a>：</p>  <p>输出当前操作系统的块大小，剩余多少可用的CACHE（块）。</p>  <p></p><pre class="prettyprint"   ><p><font size="2"   >cedric=# select * from pgsysconf();<br>block_size | block_free<br>------------+------------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp; 417534</font></p></pre>  <p>3.2 pgmincore</p>  <p>输入表名，索引名或OID</p>  <p>输出：</p>  <p></p><pre class="prettyprint"   ><p></p><p><font size="2"   >relpath : the relation path <br>block_size : the size of one block disk<br>block_disk : the total number of file system blocks of the relation<br>block_mem : the total number of file system blocks of the relation in page cache. (not the shared buffers from PostgreSQL but the <acronym title="Operating System"   >OS cache)<br>group_mem : the number of groups of adjacent block_mem</font></p>  <p><font size="2"   >cedric=# select * from pgmincore('pgbench_accounts');<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; relpath&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | block_size | block_disk | block_mem | group_mem<br>--------------------+------------+------------+-----------+-----------<br>base/16384/16603&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp; 262144 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br>base/16384/16603.1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 65726 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br><br>cedric=# select * from pgbench_accounts limit 10000;<br><br>cedric=# select * from pgmincore('pgbench_accounts');<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; relpath&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | block_size | block_disk | block_mem | group_mem<br>--------------------+------------+------------+-----------+-----------<br>base/16384/16603&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp; 262144 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 414 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1<br>base/16384/16603.1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 65726 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0</font></p><p></p></pre>  <p><br>3.3 pgmincore_snapshot</p>  <p>将当前的数据库对象在OS 缓存中的状态记录下来。一遍后续的预加载操作。</p>  <p></p><pre class="prettyprint"   ><p><font size="2"   >cedric=# select * from pgmincore_snapshot('pgbench_accounts');<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; relpath&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | block_size | block_disk | block_mem | group_mem<br>----------------------------+------------+------------+-----------+-----------<br>base/16385/49240_mincore&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp; 262144 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br>base/16385/49240.1_mincore |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp; 262144 |&nbsp;&nbsp;&nbsp; 238180 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2<br>base/16385/49240.2_mincore |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp; 262144 |&nbsp;&nbsp;&nbsp;&nbsp; 56478 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2<br>base/16385/49240.3_mincore |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 46902 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br><br># ls -1 /var/lib/postgresql/8.4/main/base/16385/49240*<br>49240<br>49240.1<br>49240.1_mincore<br>49240.2<br>49240.2_mincore<br>49240.3<br>49240.3_mincore<br>49240_fsm<br>49240_mincore<br>49240_vm</font></p></pre><br>3.4 pgfadv_dontneed  <p>告知系统，被标识的表的数据文件，在系统需要申请CACHE时，具有更高的优先级被刷出缓存。</p>  <p></p><pre class="prettyprint"   ><p><font size="2"   >cedric=# select * from pgfadv_dontneed('pgbench_accounts');<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; relpath&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | block_size | block_disk | block_free <br>--------------------+------------+------------+------------<br>base/16384/24598&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp; 262144 |&nbsp;&nbsp;&nbsp;&nbsp; 178743<br>base/16384/24598.1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 55318 |&nbsp;&nbsp;&nbsp;&nbsp; 234078</font></p></pre><br>3.5 pgfadv_willneed  <p>告知系统尽可能多的加载数据库对象文件到OS缓存。</p>  <p></p><pre class="prettyprint"   ><p><font size="2"   >cedric=# select * from pgfadv_willneed('pgbench_accounts');<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; relpath&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | block_size | block_disk | block_free<br>--------------------+------------+------------+------------<br>base/16384/16603&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp; 262144 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3744<br>base/16384/16603.1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 65726 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4236</font></p></pre><br>3.6 pgfadv_willneed_snapshot  <p>告知系统调用pgmincore_snapshot产生的快照，加载当时缓存中的BLOCK到OS缓存。</p>  <p></p><pre class="prettyprint"   ><p><font size="2"   >cedric=# select * from pgfadv_willneed_snapshot('pgbench_accounts');<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; relpath&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | block_size | block_disk | block_free <br>--------------------+------------+------------+------------<br>base/16384/24598&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp; 262144 |&nbsp;&nbsp;&nbsp;&nbsp; 105335<br>base/16384/24598.1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 55318 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 50217</font></p></pre>  <p>剩余的这三个和刚开始对于的行为习惯一致。不多解释了。<br>3.7 pgfadv_normal</p>  <p>3.8 pgfadv_random<br>3.9 pgfadv_sequential<br></p>  <p>下面引用一下作者的测试报告：</p>  <p></p><pre class="prettyprint"   ><p><font size="2"   >cedric=# show track_disk ;<br> track_disk <br>------------<br> on<br><br>cedric=# SELECT relname, <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; heap_blks_hit,heap_blks_read,heap_blks_real_read/2 as heap_blks_real_read,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; idx_blks_hit,idx_blks_read,idx_blks_real_read/2 as idx_blks_real_read <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; from pg_statio_user_tables&nbsp; where relname = 'pgbench_accounts';<br>-[ RECORD 1 ]-------+-----------------<br>relname&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | pgbench_accounts<br>heap_blks_hit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 0<br>heap_blks_read&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 0<br>heap_blks_real_read | 0<br>idx_blks_hit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 0<br>idx_blks_read&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 0<br>idx_blks_real_read&nbsp; | 0<br><br>./pgbench -S -t 100 -c2<br>tps = 43.698998 (including connections establishing)<br>tps = 43.785598 (excluding connections establishing)<br><br>relname&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | pgbench_accounts<br>heap_blks_hit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 0<br>heap_blks_read&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 200<br>heap_blks_real_read/2| 200<br>idx_blks_hit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 342<br>idx_blks_read&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 262<br>idx_blks_real_read/2 | 181<br><br>--<br>-- After some runs<br>--<br><br>tps = 99.057743 (including connections establishing)<br>tps = 99.105170 (excluding connections establishing)<br><br>relname&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | pgbench_accounts<br>heap_blks_hit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 217<br>heap_blks_read&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 19610<br>heap_blks_real_read/2| 17663<br>idx_blks_hit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 41026<br>idx_blks_read&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 18570<br>idx_blks_real_read/2 | 4631<br><br>--<br>-- After some more runs<br>--<br><br>tps = 143.658449 (including connections establishing)<br>tps = 144.511803 (excluding connections establishing)<br><br>relname&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | pgbench_accounts<br>heap_blks_hit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 442<br>heap_blks_read&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 39838<br>heap_blks_real_read | 31023<br>idx_blks_hit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 83635<br>idx_blks_read&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 37372<br>idx_blks_real_read&nbsp; | 7112<br><br>cedric=# select * from pgmincore('pgbench_accounts');<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; relpath&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | block_size | block_disk | block_mem | group_mem <br>--------------------+------------+------------+-----------+-----------<br> base/16384/24598&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp; 262144 |&nbsp;&nbsp;&nbsp; 126140 |&nbsp;&nbsp;&nbsp;&nbsp; 15422<br> base/16384/24598.1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 55318 |&nbsp;&nbsp;&nbsp;&nbsp; 26180 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3228<br>(2 rows)<br><br>cedric=# select * from pgmincore('pgbench_accounts_pkey');<br>&nbsp;&nbsp;&nbsp;&nbsp; relpath&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | block_size | block_disk | block_mem | group_mem <br>------------------+------------+------------+-----------+-----------<br> base/16384/24603 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 43892 |&nbsp;&nbsp;&nbsp;&nbsp; 43825 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 29<br><br>-- <br>-- snapshot pgbench_accounts and pgbench_accounts_pkey<br>-- restart postgresql<br>-- flush OS cache for pgbench_accounts and pgbench_accounts_pkey<br>--<br><br>cedric=# select * from pgmincore_snapshot('pgbench_accounts');<br>cedric=# select * from pgmincore_snapshot('pgbench_accounts_pkey');<br><br>cedric=# select * from pgfadv_dontneed('pgbench_accounts');<br>cedric=# select * from pgfadv_dontneed('pgbench_accounts_pkey');<br><br>cedric=# select pg_stat_reset();<br><br>-- run a pgbench <br>./pgbench -S -t 100 -c2<br>tps = 38.497385 (including connections establishing)<br>tps = 38.569719 (excluding connections establishing)<br><br>-- restore buffer cache<br>select * from pgfadv_willneed_snapshot('pgbench_accounts');<br>select * from pgfadv_willneed_snapshot('pgbench_accounts_pkey');<br><br>-- run a pgbench <br>./pgbench -S -t 100 -c2<br>tps = 169.629961 (including connections establishing)<br>tps = 170.889926 (excluding connections establishing)</font></p></pre>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="use posix_fadvise pre-cache frequency data - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>