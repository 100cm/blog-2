<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap BUG? : stap "-R no effect"</h2>
	<h5 id="">2013-10-14 15:12:57&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020139142437763/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在查看stap man手册时, 对手册上所述的stap处理流程的第一部分验证, 发现描述和测试结果不符有1处.</div><div>1. 手册上所述stap -R 指定内核版本可以让stap根据指定的内核版本搜索-I 指定目录的相关子目录, 发现这个完全不符.</div><div>手册上的描述如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >PROCESSING</font></div><div><font size="2"   >The translator begins pass 1 by parsing the given input script, and all scripts (files named *.stp) found in a tapset directory.&nbsp;</font></div><div><font size="2"   >The directories listed with -I are processed in sequence, each processed in "guru mode".&nbsp;</font></div><div><font size="2"   >"guru mode" : Enable parsing of unsafe expert-level constructs like embedded C.</font></div><div><font size="2"   >For each directory, a number of subdirectories are also searched.&nbsp;</font></div><div><font size="2"   ><u>These subdirectories are derived from the selected kernel version (the -R option), in order to allow more kernel-version-specific scripts to override less specific ones.&nbsp;</u></font></div><div><font size="2"   >For example, for a kernel version 2.6.12-23.FC3 the following patterns would be searched, in sequence:&nbsp;</font></div><div><font size="2"   >&nbsp; 2.6.12-23.FC3/*.stp,&nbsp;</font></div><div><font size="2"   >&nbsp; 2.6.12/*.stp,&nbsp;</font></div><div><font size="2"   >&nbsp; 2.6/*.stp,&nbsp;</font></div><div><font size="2"   >and finally *.stp Stopping the translator after pass 1 causes it to print the parse trees.</font></div><p></p></pre></div><div>测试方法很简单, 自建alias探针, 看看能否匹配到自建的探针.</div><div>1. 查看当前的内核版本号</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 tmp]# uname -r</font></div><div><font size="2"   >2.6.32-358.el6.x86_64</font></div><p></p></pre></div><div>2. 创建自定义库文件以及自定义探针.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 tmp]# cd /tmp</font></div><div><font size="2"   >[root@db-172-16-3-150 tmp]# mkdir 2.6.31</font></div><div><font size="2"   >[root@db-172-16-3-150 tmp]# cd 2.6.31</font></div><div><font size="2"   >[root@db-172-16-3-150 2.6.31]# vi test.stp</font></div><div><font size="2"   >probe p1 = syscall.read {</font></div><div><font size="2"   >&nbsp; var1 = "hello"</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>3. 使用刚才的探针, 但是我们只指定/tmp目录, 同时指定-R参数, 验证第1条不符的情况</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 tmp]# cd</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# stap&nbsp;<span style="line-height: 28px;"   >--vp 50000</span><span style="line-height: 28px;"   >&nbsp;-I /tmp -R 2.6.31 -e 'probe p1 {println(var1); exit()}'</span></font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.32-358.el6.x86_64/build/.config", containing 3166 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.32-358.el6.x86_64/build/Module.symvers, which contained 5541 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 10, processed: 10</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 82, processed: 82</font></div><div><font size="2"   >Pass 1: parsed user script and 92 library script(s) using 203488virt/31760res/3104shr/29424data kb, in 300usr/10sys/307real ms.</font></div><div><font size="2"   >semantic error: while resolving probe point: identifier 'p1' at &lt;input&gt;:1:7</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; source: probe p1 {println(var1); exit()}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >semantic error: probe point mismatch at position 0 &nbsp;(alternatives: __nfs __scheduler __signal __tcpmib __vm _linuxmib _signal _sunrpc _syscall _vfs begin begin(number) end end(number) error error(number) generic hotspot ioblock ioblock_trace ioscheduler ioscheduler_trace ipmib irq_handler kernel kprobe kprocess linuxmib module(string) nd_syscall netdev netfilter never nfs nfsd perf process process(number) process(string) procfs procfs(string) python scheduler scsi signal socket softirq stap staprun sunrpc syscall tcp tcpmib timer tty udp vfs vm workqueue): identifier 'p1' at :1:7</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; source: probe p1 {println(var1); exit()}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Pass 2: analysis failed. &nbsp;Try again with another '--vp 01' option.</font></div><p></p></pre></div><div>4. 如果把目录名改为<span style="line-height: 28px;"   >2.6.32(uname -r输出的内核版本的母项) 可以匹配到这个子目录中的test.stp, 输出正常.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 tmp]# cd /tmp</font></div><div><font size="2"   >[root@db-172-16-3-150 tmp]# mv 2.6.31 2.6.32</font></div><div><font size="2"   >[root@db-172-16-3-150 tmp]# cd</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# stap --vp 50000 -I /tmp -e 'probe p1 {println(var1); exit()}'</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.32-358.el6.x86_64/build/.config", containing 3166 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.32-358.el6.x86_64/build/Module.symvers, which contained 5541 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 10, processed: 10</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 82, processed: 82</font></div><div><font size="2"   >Searched: " /tmp/2.6.32/*.stp ", found: 1, processed: 1</font></div><div><font size="2"   >Pass 1: parsed user script and 93 library script(s) using 203484virt/31760res/3104shr/29420data kb, in 290usr/20sys/307real ms.</font></div><div><font size="2"   >hello</font></div><p></p></pre></div><div>5. 验证当前目录以及子目录的匹配顺序.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 tmp]# cd /tmp</font></div><div><font size="2"   >[root@db-172-16-3-150 tmp]# mkdir 2.6.32-358.el6.x86_64</font></div><div><font size="2"   >[root@db-172-16-3-150 tmp]# mkdir 2.6</font></div><div><font size="2"   >[root@db-172-16-3-150 tmp]# cp 2.6.32/test.stp 2.6/</font></div><div><font size="2"   >[root@db-172-16-3-150 tmp]# cp 2.6.32/test.stp 2.6.32-358.el6.x86_64/</font></div><div><font size="2"   >[root@db-172-16-3-150 tmp]# cp 2.6.32/test.stp ./</font></div><div><font size="2"   >[root@db-172-16-3-150 tmp]# cat test.stp</font></div><div><font size="2"   >probe p1 = syscall.read {</font></div><div><font size="2"   >&nbsp; var1 = "hello"</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>一共在4个stp文件中定义了probe p1,&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/tmp/test.stp</font></div><div><font size="2"   >/tmp/<span style="line-height: 28px;"   >2.6.32/test.stp</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   >/tmp/</span><span style="line-height: 28px;"   >2.6.32-358.el6.x86_64/test.stp</span></font></div><div><span style="line-height: 28px;"   ><font size="2"   >/tmp/2.6/test.stp</font></span></div><p></p></pre></div><div>最终会匹配哪个呢?</div><div><pre class="prettyprint"   ><div><font size="2"   >[root@db-172-16-3-150 tmp]# cd</font></div><div><div><font size="2"   >[root@db-172-16-3-150 ~]# stap --vp 50000 -I /tmp -e 'probe p1 {println(var1); exit()}'</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.32-358.el6.x86_64/build/.config", containing 3166 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.32-358.el6.x86_64/build/Module.symvers, which contained 5541 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 10, processed: 10</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 82, processed: 82</font></div><div><font size="2"   >Searched: " /tmp/2.6.32-358.el6.x86_64/*.stp ", found: 1, processed: 1</font></div><div><font size="2"   >Searched: " /tmp/2.6.32/*.stp ", found: 1, processed: 1</font></div><div><font size="2"   >Searched: " /tmp/2.6/*.stp ", found: 1, processed: 1</font></div><div><font size="2"   >Searched: " /tmp/*.stp ", found: 1, processed: 1</font></div><div><font size="2"   >Pass 1: parsed user script and 96 library script(s) using 203484virt/31776res/3104shr/29420data kb, in 290usr/20sys/309real ms.</font></div><div><font size="2"   >hello</font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   >从以上输出的检索顺序来看, 应该使用的是</span><span style="line-height: 28px;"   >/tmp/2.6.32-358.el6.x86_64/*.stp, 下面修改</span><span style="line-height: 28px;"   >/tmp/2.6.32-358.el6.x86_64/test.stp看看是不是这样的.</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 ~]# vi /tmp/2.6.32-358.el6.x86_64/test.stp&nbsp;</font></div><div><font size="2"   >probe p1 = syscall.read {</font></div><div><font size="2"   >&nbsp; var1 = "HELLO"</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   >输出 :&nbsp;</font></div><div><div><font size="2"   >[root@db-172-16-3-150 ~]# stap --vp 50000 -I /tmp -e 'probe p1 {println(var1); exit()}'</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.32-358.el6.x86_64/build/.config", containing 3166 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.32-358.el6.x86_64/build/Module.symvers, which contained 5541 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 10, processed: 10</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 82, processed: 82</font></div><div><font size="2"   >Searched: " /tmp/2.6.32-358.el6.x86_64/*.stp ", found: 1, processed: 1</font></div><div><font size="2"   >Searched: " /tmp/2.6.32/*.stp ", found: 1, processed: 1</font></div><div><font size="2"   >Searched: " /tmp/2.6/*.stp ", found: 1, processed: 1</font></div><div><font size="2"   >Searched: " /tmp/*.stp ", found: 1, processed: 1</font></div><div><font size="2"   >Pass 1: parsed user script and 96 library script(s) using 203480virt/31772res/3104shr/29416data kb, in 300usr/10sys/308real ms.</font></div><div><font size="2"   >hello</font></div></div><div><font size="2"   >结果不是这样, 还是输出小写的hello.</font></div><p></p></pre></div><div>原因 :&nbsp;</div><div><span style="line-height: 28px;"   >对于重名的probe alias, 最后匹配的那个alias将覆盖前面的alias定义, 所以这里匹配的probe p1是</span><span style="line-height: 28px;"   >/tmp/test.stp</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 ~]# vi /tmp/test.stp&nbsp;</font></div><div><font size="2"   >probe p1 = syscall.read {</font></div><div><font size="2"   >&nbsp; var1 = "Hello"</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   >输出 :&nbsp;</font></div><div><div><font size="2"   >[root@db-172-16-3-150 ~]# stap --vp 50000 -I /tmp -e 'probe p1 {println(var1); exit()}'</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.32-358.el6.x86_64/build/.config", containing 3166 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.32-358.el6.x86_64/build/Module.symvers, which contained 5541 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 10, processed: 10</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 82, processed: 82</font></div><div><font size="2"   >Searched: " /tmp/2.6.32-358.el6.x86_64/*.stp ", found: 1, processed: 1</font></div><div><font size="2"   >Searched: " /tmp/2.6.32/*.stp ", found: 1, processed: 1</font></div><div><font size="2"   >Searched: " /tmp/2.6/*.stp ", found: 1, processed: 1</font></div><div><font size="2"   >Searched: " /tmp/*.stp ", found: 1, processed: 1</font></div><div><font size="2"   >Pass 1: parsed user script and 96 library script(s) using 203484virt/31776res/3104shr/29420data kb, in 290usr/20sys/309real ms.</font></div><div><font size="2"   >Hello</font></div></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" href="http://blog.163.com/digoal@126/blog/static/163877040201391391613269/"   >http://blog.163.com/digoal@126/blog/static/163877040201391391613269/</a></div><div>2.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/man/stap.1.html"   >https://sourceware.org/systemtap/man/stap.1.html</a></div><div>3. man stap</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;--vp ABCDE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Increase &nbsp;verbosity &nbsp;on &nbsp;a &nbsp;per-pass basis. &nbsp;For example, "--vp 002" adds 2 units of verbosity to pass 3</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; only. &nbsp;The combination "-v --vp 00004" adds 1 unit of verbosity for all passes, and 4 more for pass 5.</font></div><p></p></pre></div><div>ABCDE分别代表stap的5步, 每步可以指定对应的输出verbose级别, 例如--vp 04000表示 pass2的verbose级别为4, 其他pass的verbose级别为0.</div><wbr></div>
	</div>
</div>
</body>
</html>