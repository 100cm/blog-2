<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap EXP: PostgreSQL IN-BUILD mark Class 1 - transaction</h2>
	<h5 id="">2013-10-16 10:06:56&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201391684012713/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>本文开始将以PostgreSQL内建的探针为例, 探讨一下围绕这些探针可以实现哪些想要的功能.</div><div><span style="line-height: 28px;"   >使用systemtap时, 需要把postgresql mark name中的-换成两个下划线.</span></div><div>第一个分类是事务相关探针 :&nbsp;</div><div><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; background-color: rgb(224, 236, 239); border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"   ><thead><tr><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Name</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Parameters</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Description</th></tr></thead><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   >transaction-start</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   >(LocalTransactionId)</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   >Probe that fires at the start of a new transaction. arg0 is the transaction ID.</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >transaction-commit</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >(LocalTransactionId)</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Probe that fires when a transaction completes successfully. arg0 is the transaction ID.</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >transaction-abort</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >(LocalTransactionId)</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Probe that fires when a transaction completes unsuccessfully. arg0 is the transaction ID.</td></tr></table></div><div>事务开始, 事务提交, 事务回滚3个mark.</div><div>探针信息 :&nbsp;</div><div>src/backend/utils/probes.h</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/* TRACE_POSTGRESQL_TRANSACTION_START ( unsigned int) */</font></div><div><font size="2"   >#if defined STAP_SDT_V1</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_TRANSACTION_START_ENABLED() __builtin_expect (transaction__start_semaphore, 0)</font></div><div><font size="2"   >#define postgresql_transaction__start_semaphore transaction__start_semaphore</font></div><div><font size="2"   >#else</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_TRANSACTION_START_ENABLED() __builtin_expect (postgresql_transaction__start_semaphore, 0)</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   >__extension__ extern unsigned short postgresql_transaction__start_semaphore __attribute__ ((unused)) __attribute__ ((section (".probes")));</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_TRANSACTION_START(arg1) \</font></div><div><font size="2"   >DTRACE_PROBE1(postgresql,transaction__start,arg1)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >/* TRACE_POSTGRESQL_TRANSACTION_COMMIT ( unsigned int) */</font></div><div><font size="2"   >#if defined STAP_SDT_V1</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_TRANSACTION_COMMIT_ENABLED() __builtin_expect (transaction__commit_semaphore, 0)</font></div><div><font size="2"   >#define postgresql_transaction__commit_semaphore transaction__commit_semaphore</font></div><div><font size="2"   >#else</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_TRANSACTION_COMMIT_ENABLED() __builtin_expect (postgresql_transaction__commit_semaphore, 0)</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   >__extension__ extern unsigned short postgresql_transaction__commit_semaphore __attribute__ ((unused)) __attribute__ ((section (".probes")));</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_TRANSACTION_COMMIT(arg1) \</font></div><div><font size="2"   >DTRACE_PROBE1(postgresql,transaction__commit,arg1)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >/* TRACE_POSTGRESQL_TRANSACTION_ABORT ( unsigned int) */</font></div><div><font size="2"   >#if defined STAP_SDT_V1</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_TRANSACTION_ABORT_ENABLED() __builtin_expect (transaction__abort_semaphore, 0)</font></div><div><font size="2"   >#define postgresql_transaction__abort_semaphore transaction__abort_semaphore</font></div><div><font size="2"   >#else</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_TRANSACTION_ABORT_ENABLED() __builtin_expect (postgresql_transaction__abort_semaphore, 0)</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   >__extension__ extern unsigned short postgresql_transaction__abort_semaphore __attribute__ ((unused)) __attribute__ ((section (".probes")));</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_TRANSACTION_ABORT(arg1) \</font></div><div><font size="2"   >DTRACE_PROBE1(postgresql,transaction__abort,arg1)</font></div><p></p></pre></div><div>探针在pg源码中的信息 :&nbsp;</div><div>src/backend/access/transam/xact.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;StartTransaction</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static void</font></div><div><font size="2"   >StartTransaction(void)</font></div><div><font size="2"   >{</font></div></div><div><font size="2"   >...</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; VirtualTransactionId vxid;</font></div><div><font size="2"   >...</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TRACE_POSTGRESQL_TRANSACTION_START(vxid.localTransactionId);</font></div></div><div><font size="2"   >...</font></div><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;CommitTransaction</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* NB: if you change this routine, better look at PrepareTransaction too!</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static void</font></div><div><font size="2"   >CommitTransaction(void)</font></div><div><font size="2"   >{</font></div></div><div><font size="2"   >...</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TRACE_POSTGRESQL_TRANSACTION_COMMIT(MyProc-&gt;lxid);</font></div><div><font size="2"   >...&nbsp;</font></div><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;AbortTransaction</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static void</font></div><div><font size="2"   >AbortTransaction(void)</font></div></div><div><font size="2"   >...</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TRACE_POSTGRESQL_TRANSACTION_ABORT(MyProc-&gt;lxid);</font></div><p></p></pre></div><div>这三个探针对应的参数为本地事务号, 和全局事务号无关.</div><div>本地事务类型定义 :&nbsp;</div><div>src/include/storage/lock.h</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* Top-level transactions are identified by VirtualTransactionIDs comprising</font></div><div><font size="2"   >&nbsp;* the BackendId of the backend running the xact, plus a locally-assigned</font></div><div><font size="2"   >&nbsp;* LocalTransactionId. &nbsp;These are guaranteed unique over the short term,</font></div><div><font size="2"   >&nbsp;* but will be reused after a database restart; hence they should never</font></div><div><font size="2"   >&nbsp;* be stored on disk.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Note that struct VirtualTransactionId can not be assumed to be atomically</font></div><div><font size="2"   >&nbsp;* assignable as a whole. &nbsp;However, type LocalTransactionId is assumed to</font></div><div><font size="2"   >&nbsp;* be atomically assignable, and the backend ID doesn't change often enough</font></div><div><font size="2"   >&nbsp;* to be a problem, so we can fetch or assign the two fields separately.</font></div><div><font size="2"   >&nbsp;* We deliberately refrain from using the struct within PGPROC, to prevent</font></div><div><font size="2"   >&nbsp;* coding errors from trying to use struct assignment with it; instead use</font></div><div><font size="2"   >&nbsp;* GET_VXID_FROM_PGPROC().</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >typedef struct</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; BackendId &nbsp; &nbsp; &nbsp; backendId; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* determined at backend startup */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LocalTransactionId localTransactionId; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* backend-local transaction</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* id */</font></div><div><font size="2"   >} VirtualTransactionId;</font></div><p></p></pre></div><div>使用事务相关的探针, 一般可以用于统计以下信息 :&nbsp;</div><div>1. 每秒新建, 提交, 回滚的事务数</div><div>2. 记录每个事务的时长</div><div>3. 结合内核探针, 可以记录每个事务的io开销, 网络开销, 单步指令等.</div><div>例子 :&nbsp;</div><div>1.&nbsp;<span style="line-height: 28px;"   >每秒新建, 提交, 回滚的事务数</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   ><div>digoal=#&nbsp;</div><div>CREATE OR REPLACE FUNCTION public.f_test(i_id integer)</div><div>&nbsp;RETURNS void</div><div>&nbsp;LANGUAGE plpgsql</div><div>&nbsp;STRICT</div><div>AS $function$</div><div>declare</div><div>begin</div><div>&nbsp; update test set info=md5(random()::text), crt_time=clock_timestamp() where id=i_id;</div><div>&nbsp; if not found then</div><div>&nbsp; &nbsp; insert into test(id,info,crt_time) values(i_id,md5(random()::text),clock_timestamp());</div><div>&nbsp; end if;</div><div>&nbsp; return;</div><div>&nbsp; exception when others then</div><div>&nbsp; &nbsp; return;</div><div>end;</div><div>$function$;</div><div><div>digoal=# create table test(id int primary key, info text, crt_time timestamp);</div><div>CREATE TABLE</div></div><div><br></div><div><div>pg93@db-172-16-3-150-&gt; cat test.sql</div><div>\setrandom id 1 5000000</div><div>select f_test(:id);</div></div><div><br></div></font></span></div><div><font size="2"   >[root@db-172-16-3-150 ~]# <span style="line-height: 21px;"   >stap -e '</span></font></div><font size="2"   ><span style="line-height: 21px;"   >global var1<br>probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("transaction__start") {<br>  var1["START"]++<br>} <br>probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("transaction__commit") {<br>  var1["COMMIT"]++<br>} <br>probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("transaction__abort") {<br>  var1["ABORT"]++<br>} <br>probe timer.s(1) {<br>  printf("START/s:%d, COMMIT/s:%d, ABORT/s:%d\n", var1["START"], var1["COMMIT"], var1["ABORT"])<br>  var1["START"]=0<br>  var1["COMMIT"]=0<br>  var1["ABORT"]=0<br>}'</span></font><div><font size="2"   ><br></font></div><div><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 8 -j 1 -T 10</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 175602</font></div><div><font size="2"   >tps = 17559.485329 (including connections establishing)</font></div><div><font size="2"   >tps = 17601.731285 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001609 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.451537 &nbsp; &nbsp; &nbsp; &nbsp;select f_test(:id);</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >stap输出 :&nbsp;</font></div><div><div><font size="2"   >START/s:0, COMMIT/s:0, ABORT/s:0</font></div><div><font size="2"   >START/s:0, COMMIT/s:0, ABORT/s:0</font></div><div><font size="2"   >START/s:7484, COMMIT/s:7483, ABORT/s:0</font></div><div><font size="2"   >START/s:18035, COMMIT/s:18032, ABORT/s:0</font></div><div><font size="2"   >START/s:17345, COMMIT/s:17346, ABORT/s:0</font></div><div><font size="2"   >START/s:17151, COMMIT/s:17150, ABORT/s:0</font></div><div><font size="2"   >START/s:17517, COMMIT/s:17520, ABORT/s:0</font></div><div><font size="2"   >START/s:18048, COMMIT/s:18046, ABORT/s:0</font></div><div><font size="2"   >START/s:17597, COMMIT/s:17600, ABORT/s:0</font></div><div><font size="2"   >START/s:17648, COMMIT/s:17645, ABORT/s:0</font></div><div><font size="2"   >START/s:17728, COMMIT/s:17724, ABORT/s:0</font></div><div><font size="2"   >START/s:17346, COMMIT/s:17348, ABORT/s:0</font></div><div><font size="2"   >START/s:9720, COMMIT/s:9725, ABORT/s:0</font></div><div><font size="2"   >START/s:0, COMMIT/s:0, ABORT/s:0</font></div><div><font size="2"   >START/s:0, COMMIT/s:0, ABORT/s:0</font></div></div><p></p></pre></div><div><br></div><div>2. 记录每个事务的时长, 输出柱状图</div><div>首先要确保三个探针的本地事务号一致 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# stap -e '</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("transaction__start") {</font></div><div><font size="2"   >&nbsp; println(pn(),$arg1)</font></div><div><font size="2"   >}<span style="line-height: 28px;"   >&nbsp;</span></font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("transaction__commit") {</font></div><div><font size="2"   >&nbsp; println(pn(),$arg1)</font></div><div><font size="2"   >}&nbsp;</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("transaction__abort") {</font></div><div><font size="2"   >&nbsp; println(pn(),$arg1)</font></div><div><font size="2"   >}'</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# select 1;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# abort;</font></div><div><font size="2"   >ROLLBACK</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("transaction__start")55238</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("transaction__commit")55238</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("transaction__start")55239</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("transaction__abort")55239</font></div><p></p></pre></div><div>stap脚本如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >stap -e '<br>global var1%[819200], var2, var3<br>probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("transaction__start") {<br>  var1[pid(),$arg1] = gettimeofday_ms()<br>} <br>probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("transaction__commit") {<br>  if (var1[pid(),$arg1] != 0)<br>    var2 &lt;&lt;&lt; (gettimeofday_ms()-var1[pid(),$arg1])<br>} <br>probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("transaction__abort") {<br>  if (var1[pid(),$arg1] != 0)<br>    var3 &lt;&lt;&lt; (gettimeofday_ms()-var1[pid(),$arg1])<br>} <br>probe timer.s($1) {<br>  if (@count(var2) != 0) {<br>    printf("COMMIT/s:%d\n", @count(var2) / $1)<br>    println(@hist_log(var2)) <br>    delete var2<br>  }<br>  if (@count(var3) != 0) {<br>    printf("ABORT/s:%d\n", @count(var3) / $1)<br>    println(@hist_log(var3)) <br>    delete var3<br>  }<br>}' 3</span></font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 8 -j 1 -T 30</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 737912</font></div><div><font size="2"   >tps = 24596.734611 (including connections establishing)</font></div><div><font size="2"   >tps = 24615.235172 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002188 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.321188 &nbsp; &nbsp; &nbsp; &nbsp;select f_test(:id);</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >输出</font></div><div><div><font size="2"   >COMMIT/s:29660</font></div><div><font size="2"   >value |-------------------------------------------------- count</font></div><div><font size="2"   >&nbsp; &nbsp; 0 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ &nbsp;72349</font></div><div><font size="2"   >&nbsp; &nbsp; 1 |@@@@@@@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16600</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;32</font></div><div><font size="2"   >&nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; 8 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >COMMIT/s:57109</font></div><div><font size="2"   >value |-------------------------------------------------- count</font></div><div><font size="2"   >&nbsp; &nbsp; 0 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ &nbsp;138167</font></div><div><font size="2"   >&nbsp; &nbsp; 1 |@@@@@@@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 33128</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 29</font></div><div><font size="2"   >&nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >&nbsp; &nbsp; 8 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >&nbsp; &nbsp;16 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >&nbsp; &nbsp;32 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >COMMIT/s:24830</font></div><div><font size="2"   >value |-------------------------------------------------- count</font></div><div><font size="2"   >&nbsp; &nbsp; 0 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ &nbsp;58175</font></div><div><font size="2"   >&nbsp; &nbsp; 1 |@@@@@@@@@@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 16310</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 7</font></div><div><font size="2"   >&nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; 8 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >COMMIT/s:22335</font></div><div><font size="2"   >value |-------------------------------------------------- count</font></div><div><font size="2"   >&nbsp; &nbsp; 0 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ &nbsp;51034</font></div><div><font size="2"   >&nbsp; &nbsp; 1 |@@@@@@@@@@@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;15960</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 9</font></div><div><font size="2"   >&nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; 8 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2</font></div><div><font size="2"   >&nbsp; &nbsp;16 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp;32 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >COMMIT/s:20267</font></div><div><font size="2"   >value |-------------------------------------------------- count</font></div><div><font size="2"   >&nbsp; &nbsp; 0 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ &nbsp;45321</font></div><div><font size="2"   >&nbsp; &nbsp; 1 |@@@@@@@@@@@@@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;15468</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;13</font></div><div><font size="2"   >&nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; 8 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >COMMIT/s:18493</font></div><div><font size="2"   >value |-------------------------------------------------- count</font></div><div><font size="2"   >&nbsp; &nbsp; 0 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ &nbsp;40386</font></div><div><font size="2"   >&nbsp; &nbsp; 1 |@@@@@@@@@@@@@@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 15087</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5</font></div><div><font size="2"   >&nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >&nbsp; &nbsp; 8 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp;16 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div></div><p></p></pre></div><div>[其他]</div><div>1. 第二个例子可能存在偏差, 与stap全局变量锁有关, 不要除以定量时间即可.</div><div>修改如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >stap -e '</font></div><div><font size="2"   >global var1%[819200], var2, var3, var4</font></div><div><font size="2"   >probe begin {</font></div><div><font size="2"   >&nbsp; var4=gettimeofday_ms()</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("transaction__start") {</font></div><div><font size="2"   >&nbsp; var1[pid(),$arg1] = gettimeofday_ms()</font></div><div><font size="2"   >}&nbsp;</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("transaction__commit") {</font></div><div><font size="2"   >&nbsp; if (var1[pid(),$arg1] != 0)</font></div><div><font size="2"   >&nbsp; &nbsp; var2 &lt;&lt;&lt; (gettimeofday_ms()-var1[pid(),$arg1])</font></div><div><font size="2"   >}&nbsp;</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("transaction__abort") {</font></div><div><font size="2"   >&nbsp; if (var1[pid(),$arg1] != 0)</font></div><div><font size="2"   >&nbsp; &nbsp; var3 &lt;&lt;&lt; (gettimeofday_ms()-var1[pid(),$arg1])</font></div><div><font size="2"   >}&nbsp;</font></div><div><font size="2"   >probe timer.s($1) {</font></div><div><font size="2"   >&nbsp; now=gettimeofday_ms()</font></div><div><font size="2"   >&nbsp; if (@count(var2) != 0) {</font></div><div><font size="2"   >&nbsp; &nbsp; printf("COMMIT/s:%d\n", (1000*@count(var2)) / (now-var4))</font></div><div><font size="2"   >&nbsp; &nbsp; println(@hist_log(var2))&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; delete var2</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >&nbsp; if (@count(var3) != 0) {</font></div><div><font size="2"   >&nbsp; &nbsp; printf("ABORT/s:%d\n", (1000*@count(var3)) / (now-var4))</font></div><div><font size="2"   >&nbsp; &nbsp; println(@hist_log(var3))&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; delete var3</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >&nbsp; var4=now</font></div><div><font size="2"   >}' 3</font></div><p></p></pre></div><div><br></div><div>输出精准 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >COMMIT/s:16364</font></div><div><font size="2"   >value |-------------------------------------------------- count</font></div><div><font size="2"   >&nbsp; &nbsp; 0 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ &nbsp;39936</font></div><div><font size="2"   >&nbsp; &nbsp; 1 |@@@@@@@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 9137</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;20</font></div><div><font size="2"   >&nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; 8 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >COMMIT/s:16427</font></div><div><font size="2"   >value |-------------------------------------------------- count</font></div><div><font size="2"   >&nbsp; &nbsp; 0 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ &nbsp;39927</font></div><div><font size="2"   >&nbsp; &nbsp; 1 |@@@@@@@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 9346</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10</font></div><div><font size="2"   >&nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; 8 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >COMMIT/s:16436</font></div><div><font size="2"   >value |-------------------------------------------------- count</font></div><div><font size="2"   >&nbsp; &nbsp; 0 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ &nbsp;40073</font></div><div><font size="2"   >&nbsp; &nbsp; 1 |@@@@@@@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 9223</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;13</font></div><div><font size="2"   >&nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; 8 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >COMMIT/s:16287</font></div><div><font size="2"   >value |-------------------------------------------------- count</font></div><div><font size="2"   >&nbsp; &nbsp; 0 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ &nbsp;39649</font></div><div><font size="2"   >&nbsp; &nbsp; 1 |@@@@@@@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 9195</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;17</font></div><div><font size="2"   >&nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; 8 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >COMMIT/s:16233</font></div><div><font size="2"   >value |-------------------------------------------------- count</font></div><div><font size="2"   >&nbsp; &nbsp; 0 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ 39250</font></div><div><font size="2"   >&nbsp; &nbsp; 1 |@@@@@@@@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9432</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;17</font></div><div><font size="2"   >&nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; 8 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >COMMIT/s:15605</font></div><div><font size="2"   >value |-------------------------------------------------- count</font></div><div><font size="2"   >&nbsp; &nbsp; 0 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ &nbsp;37605</font></div><div><font size="2"   >&nbsp; &nbsp; 1 |@@@@@@@@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9191</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;21</font></div><div><font size="2"   >&nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; 8 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >COMMIT/s:15581</font></div><div><font size="2"   >value |-------------------------------------------------- count</font></div><div><font size="2"   >&nbsp; &nbsp; 0 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ &nbsp;37382</font></div><div><font size="2"   >&nbsp; &nbsp; 1 |@@@@@@@@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9350</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;11</font></div><div><font size="2"   >&nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >&nbsp; &nbsp; 8 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp;16 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >COMMIT/s:15422</font></div><div><font size="2"   >value |-------------------------------------------------- count</font></div><div><font size="2"   >&nbsp; &nbsp; 0 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ &nbsp;36838</font></div><div><font size="2"   >&nbsp; &nbsp; 1 |@@@@@@@@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9412</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16</font></div><div><font size="2"   >&nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >&nbsp; &nbsp; 8 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp;16 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >COMMIT/s:15521</font></div><div><font size="2"   >value |-------------------------------------------------- count</font></div><div><font size="2"   >&nbsp; &nbsp; 0 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ &nbsp;37117</font></div><div><font size="2"   >&nbsp; &nbsp; 1 |@@@@@@@@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9437</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;11</font></div><div><font size="2"   >&nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; 8 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><p></p></pre></div><div><br></div><div>结合内核探针的例子可参考 :&nbsp;</div><div>Systemtap EXP: Trace PostgreSQL iostat per SQL statement</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020139152191581/"   >http://blog.163.com/digoal@126/blog/static/16387704020139152191581/</a></div><div>Systemtap EXP: trace PostgreSQL netflow per session or per sql</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020139153195701/"   >http://blog.163.com/digoal@126/blog/static/16387704020139153195701/</a></div><div>Systemtap EXP: trace PostgreSQL instruction or block of instructions per sql or per session</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020139153455311/"   >http://blog.163.com/digoal@126/blog/static/16387704020139153455311/</a></div><div><br></div><div><span style="line-height: 28px;"   >[参考]</span></div><wbr><div>1.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/dynamic-trace.html"   >http://www.postgresql.org/docs/9.3/static/dynamic-trace.html</a></div><div>2.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="http://doxygen.postgresql.org/"   >http://doxygen.postgresql.org/</a></div><div>3.&nbsp;<span style="line-height: 28px;"   >src/backend/access/transam/xact.c</span></div><div><span style="line-height: 28px;"   >4.&nbsp;</span><span style="line-height: 28px;"   >src/backend/utils/probes.h</span></div><div><span style="line-height: 28px;"   >5.&nbsp;</span>src/include/storage/lock.h</div><div>6.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/"   >https://sourceware.org/systemtap/tapsets/</a></div></div>
	</div>
</div>
</body>
</html>