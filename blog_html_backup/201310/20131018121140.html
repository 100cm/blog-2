<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL Dynamic Tracing using systemtap env prepare</h2>
	<h5 id="">2013-10-18 12:11:40&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020139102940694/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>本文介绍一下PostgreSQL动态跟踪环境的搭建, 方便对PG内核动态跟踪感兴趣的童鞋参阅.</div><wbr>环境准备 :&nbsp;<div>一准备systemtap环境 :&nbsp;<br><div>首先要确定内核版本</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# uname -r</font></div><div><font size="2"   >2.6.32-358.el6.x86_64</font></div><p></p></pre></div><div><br></div><div>安装systemtap包</div><pre class="prettyprint"   ><p></p><div><font size="2"   >yum install -y&nbsp;systemtap-devel&nbsp;systemtap-client&nbsp;systemtap-runtime&nbsp;systemtap-sdt-devel&nbsp;systemtap</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >其中</span><span style="line-height: 28px;"   >systemtap-sdt-devel 是PostgreSQL --enable-dtrace需要的包.</span></div><div><div><br></div><div>安装内核debuginfo包, 不是必须的, 但是最好安装一下, 方便将内核调试和PostgreSQL动态探针结合起来使用.</div><div>开启debug源, enabled=1</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# vi /etc/yum.repos.d/CentOS-Debuginfo.repo&nbsp;</font></div><div><div><font size="2"   >[debug]</font></div><div><font size="2"   >name=CentOS-6 - Debuginfo</font></div><div><font size="2"   >baseurl=http://debuginfo.centos.org/6/$basearch/</font></div><div><font size="2"   >gpgcheck=1</font></div><div><font size="2"   >gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-Debug-6</font></div><div><font size="2"   >enabled=1</font></div></div><p></p></pre></div><div>安装与内核版本对应的debuginfo包</div><div>[root@db-172-16-3-150 ~]# yum install -y kernel-debuginfo-2.6.32-358.el6.x86_64</div><div><br></div><div>测试stap是否可以正常使用 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# stap -e 'probe syscall.read { println("Hello"); exit() }'</font></div><div><font size="2"   >Hello</font></div><p></p></pre></div><div><br></div><div>接下来准备PostgreSQL环境 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >useradd pg93</font></div><div><font size="2"   >su - pg93</font></div><div><font size="2"   >vi ~/.bash_profile</font></div><div><font size="2"   >export PS1="$USER@`/bin/hostname -s`-&gt; "</font></div><div><font size="2"   >export PGPORT=1999</font></div><div><font size="2"   >export PGDATA=/pgdata/digoal/1921/data03/pg93/pg_root</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/home/pg93/pgsql</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"   >export PGUSER=postgres</font></div><div><font size="2"   >export PGHOST=$PGDATA</font></div><div><font size="2"   >alias rm='rm -i'</font></div><div><font size="2"   >alias ll='ls -lh'</font></div><div><font size="2"   >export PGDATABASE=digoal</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >su - root</font></div><div><font size="2"   >wget http://ftp.postgresql.org/pub/source/v9.3.1/postgresql-9.3.1.tar.bz2</font></div><div><font size="2"   >tar -jxvf postgresql-9.3.1.tar.bz2</font></div><div><font size="2"   >cd postgresql-9.3.1</font></div><p></p></pre></div><div>编译时必须带上--enable-dtrace选项</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >./configure --prefix=/home/pg93/pgsql9.3.1 --with-pgport=1999 --with-perl --with-tcl --with-python --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=16 --enable-dtrace --enable-debug &amp;&amp; gmake world &amp;&amp; gmake install-world</font></div><div><font size="2"   >ln -s /home/pg93/pgsql9.3.1 /home/pg93/pgsql</font></div><div><font size="2"   >mkdir -p /pgdata/digoal/1921/data03/pg93/pg_root</font></div><div><font size="2"   >chown -R pg93:pg93 /pgdata/digoal/1921/data03/pg93/pg_root</font></div><p></p></pre></div><div>初始化数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - pg93</font></div><div><font size="2"   >initdb -D $PGDATA -E UTF8 --locale=C -W -U postgres</font></div><p></p></pre></div><div>配置数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd $PGDATA</font></div><div><font size="2"   >vi pg_hba.conf</font></div><div><font size="2"   >host all all 0.0.0.0/0 md5</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >vi postgresql.conf</font></div><div><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"   >port = 1999 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >max_connections = 500 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_directories = '.' &nbsp; # comma-separated list of directories</font></div><div><font size="2"   >unix_socket_permissions = 0700 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# begin with 0 to use octal notation</font></div><div><font size="2"   >password_encryption = on</font></div><div><font size="2"   >tcp_keepalives_idle = 60 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPIDLE, in seconds;</font></div><div><font size="2"   >tcp_keepalives_interval = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPINTVL, in seconds;</font></div><div><font size="2"   >tcp_keepalives_count = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # TCP_KEEPCNT;</font></div><div><font size="2"   >shared_buffers = 2048MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div><font size="2"   >max_stack_depth = 8MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 100kB</font></div><div><font size="2"   >shared_preload_libraries = 'pg_stat_statements' &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >vacuum_cost_delay = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 0-100 milliseconds</font></div><div><font size="2"   >vacuum_cost_limit = 10000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 credits</font></div><div><font size="2"   >bgwriter_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 10-10000ms between rounds</font></div><div><font size="2"   >wal_level = hot_standby &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, or hot_standby</font></div><div><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level;</font></div><div><font size="2"   >wal_sync_method = fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # the default is the first option</font></div><div><font size="2"   >wal_buffers = 16384kB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 32kB, -1 sets based on shared_buffers</font></div><div><font size="2"   >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"   >checkpoint_segments = 256 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # in logfile segments, min 1, 16MB each</font></div><div><font size="2"   >archive_mode = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # allows archiving to be done</font></div><div><font size="2"   >archive_command = '/bin/date' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # command to use to archive a logfile segment</font></div><div><font size="2"   >max_wal_senders = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of walsender processes</font></div><div><font size="2"   >wal_keep_segments = 1024 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# in logfile segments, 16MB each; 0 disables</font></div><div><font size="2"   >hot_standby = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# "on" allows queries during recovery</font></div><div><font size="2"   >max_standby_archive_delay = 300s &nbsp; &nbsp; &nbsp; &nbsp;# max delay before canceling queries</font></div><div><font size="2"   >max_standby_streaming_delay = 300s &nbsp; &nbsp; &nbsp;# max delay before canceling queries</font></div><div><font size="2"   >wal_receiver_status_interval = 1s &nbsp; &nbsp; &nbsp; # send replies at least this often</font></div><div><font size="2"   >hot_standby_feedback = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # send info from standby to prevent</font></div><div><font size="2"   >random_page_cost = 1.5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# same scale as above</font></div><div><font size="2"   >effective_cache_size = 8192MB</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_directory = 'pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,</font></div><div><font size="2"   >log_file_mode = 0600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# creation mode for log files,</font></div><div><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div><font size="2"   >log_rotation_age = 1d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Automatic rotation of logfiles will</font></div><div><font size="2"   >log_rotation_size = 10MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Automatic rotation of logfiles will</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_disconnections = on</font></div><div><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div><font size="2"   >log_lock_waits = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # log lock waits &gt;= deadlock_timeout</font></div><div><font size="2"   >log_statement = 'ddl' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # none, ddl, mod, all</font></div><div><font size="2"   >log_timezone = 'PRC'</font></div><div><font size="2"   >track_activity_query_size = 4096 &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >autovacuum = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Enable autovacuum subprocess? &nbsp;'on'</font></div><div><font size="2"   >log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</font></div><div><font size="2"   >autovacuum_freeze_max_age = 1500000000 &nbsp;# maximum XID age before forced vacuum</font></div><div><font size="2"   >vacuum_freeze_min_age = 50000000</font></div><div><font size="2"   >vacuum_freeze_table_age = 1200000000</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >timezone = 'PRC'</font></div><div><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><div><font size="2"   >deadlock_timeout = 1s</font></div><div><font size="2"   >pg_stat_statements.max = 1000</font></div><div><font size="2"   >pg_stat_statements.track = all</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-150 pg93]# su - pg93</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; pg_ctl start</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; LOG: &nbsp;00000: loaded library "pg_stat_statements"</font></div><div><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1296</font></div><div><font size="2"   >LOG: &nbsp;00000: redirecting log output to logging collector process</font></div><div><font size="2"   >HINT: &nbsp;Future log output will appear in directory "pg_log".</font></div><div><font size="2"   >LOCATION: &nbsp;SysLogger_Start, syslogger.c:649</font></div><p></p></pre></div><div>创建测试库以及测试表, 测试函数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; psql postgres postgres</font></div><div><font size="2"   >psql (9.3.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# create database digoal;</font></div><div><font size="2"   >CREATE DATABASE</font></div><div><font size="2"   >postgres=# create extension pg_stat_statements;</font></div><div><font size="2"   >CREATE EXTENSION</font></div><div><div><font size="2"   >digoal=# create table test(id int primary key, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >digoal=# create or replace function f_test(i_id int) returns void as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; update test set info=md5(random()::text), crt_time=clock_timestamp() where id=i_id;</font></div><div><font size="2"   >&nbsp; if not found then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into test(id,info,crt_time) values(i_id,md5(random()::text),clock_timestamp());</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; return;</font></div><div><font size="2"   >&nbsp; exception when others then</font></div><div><font size="2"   >&nbsp; &nbsp; return;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div></div><p></p></pre></div><div><br></div><div>测试PostgreSQL探针是否可以正常使用 :</div><div><span style="line-height: 28px;"   >查看有多少个探针 :&nbsp;</span></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 utils]# stap -l 'process("/home/pg93/pgsql9.3.1/bin/postgres").mark("**")'</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("buffer__checkpoint__done")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("buffer__checkpoint__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("buffer__checkpoint__sync__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("buffer__flush__done")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("buffer__flush__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("buffer__read__done")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("buffer__read__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("buffer__sync__done")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("buffer__sync__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("buffer__sync__written")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("buffer__write__dirty__done")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("buffer__write__dirty__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("checkpoint__done")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("checkpoint__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("clog__checkpoint__done")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("clog__checkpoint__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("deadlock__found")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("lock__wait__done")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("lock__wait__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("lwlock__acquire")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("lwlock__condacquire")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("lwlock__condacquire__fail")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("lwlock__release")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("lwlock__wait__done")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("lwlock__wait__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("lwlock__wait__until__free")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("lwlock__wait__until__free__fail")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("multixact__checkpoint__done")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("multixact__checkpoint__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__done")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__execute__done")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__execute__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__parse__done")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__parse__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__plan__done")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__plan__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__rewrite__done")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__rewrite__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__read__done")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__read__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("sort__done")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("sort__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("statement__status")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("subtrans__checkpoint__done")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("subtrans__checkpoint__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("transaction__abort")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("transaction__commit")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("transaction__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("twophase__checkpoint__done")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("twophase__checkpoint__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("wal__buffer__write__dirty__done")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("wal__buffer__write__dirty__start")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("xlog__insert")</font></div><div style="line-height: 28px;"   ><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("xlog__switch")</font></div><p></p></pre></div></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >探针使用测试 :&nbsp;</div><div style="line-height: 28px;"   >每隔3秒输出qps.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-150-&gt; vi test.sql</font></div><div><font size="2"   >\setrandom id 1 50000000</font></div><div><font size="2"   >select f_test(:id);</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-150 ~]# stap -e '</font></div><div><font size="2"   >global var</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__execute__done") {</font></div><div><font size="2"   >&nbsp; var++</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe timer.s($1) {</font></div><div><font size="2"   >&nbsp; printf("qps:%d\n", var/$1)</font></div><div><font size="2"   >&nbsp; var=0</font></div><div><font size="2"   >}' 3</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -T 30</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >qps:31842</font></div><div><font size="2"   >qps:35328</font></div><div><font size="2"   >qps:35392</font></div><div><font size="2"   >qps:35504</font></div><div><font size="2"   >qps:35425</font></div><div><font size="2"   >qps:35520</font></div><div><font size="2"   >qps:35503</font></div><div><font size="2"   >qps:35467</font></div><div><font size="2"   >qps:35436</font></div><div><font size="2"   >qps:3034</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 1037188</font></div><div><font size="2"   >tps = 34572.359432 (including connections establishing)</font></div><div><font size="2"   >tps = 34586.329195 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003126 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 50000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.457397 &nbsp; &nbsp; &nbsp; &nbsp;select f_test(:id);</font></div></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >PostgreSQL中与动态跟踪相关的文件 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgresql-9.3.1/src/backend/utils/probes.d</font></div><div><font size="2"   >postgresql-9.3.1/src/backend/utils/probes.h</font></div><div><span style="line-height: 28px;"   ><font size="2"   >/usr/include/sys/sdt.h</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >http://www.postgresql.org/docs/9.3/static/dynamic-trace.html</font></span></div><div><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/"   ><font size="2"   >https://sourceware.org/systemtap/tapsets/</font></a></div><p></p></pre></div><div><br></div><div>PostgreSQL动态跟踪的详细使用参考 :&nbsp;</div><div><div>Systemtap EXP: PostgreSQL IN-BUILD mark Class 1 - transaction</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201391684012713/"   >http://blog.163.com/digoal@126/blog/static/163877040201391684012713/</a></div><div>Systemtap EXP: PostgreSQL IN-BUILD mark Class 2 - query</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013916101117367/"   >http://blog.163.com/digoal@126/blog/static/1638770402013916101117367/</a></div><div>Systemtap EXP: PostgreSQL IN-BUILD mark Class 3 - checkpoint</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201391622459221/"   >http://blog.163.com/digoal@126/blog/static/163877040201391622459221/</a></div><div>Systemtap EXP: PostgreSQL IN-BUILD mark Class 4 - buffer</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013916488761/"   >http://blog.163.com/digoal@126/blog/static/1638770402013916488761/</a></div><div>Systemtap EXP: PostgreSQL IN-BUILD mark Class 5 - read|write relation</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201391653616103/"   >http://blog.163.com/digoal@126/blog/static/163877040201391653616103/</a></div><div>Systemtap EXP: PostgreSQL IN-BUILD mark Class 6 - lock</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201391674922879/"   >http://blog.163.com/digoal@126/blog/static/163877040201391674922879/</a></div><div>Systemtap EXP: PostgreSQL IN-BUILD mark Class 7 - others(statement,xlog,sort)</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013916221518/"   >http://blog.163.com/digoal@126/blog/static/1638770402013916221518/</a></div></div><div><br></div><div><div>下面截取一个probe定义进行讲解 :&nbsp;</div><div>src/backend/utils/probes.h</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#include &lt;sys/sdt.h&gt;</font></div><div><font size="2"   >/* TRACE_POSTGRESQL_TRANSACTION_START ( unsigned int) */</font></div><div><font size="2"   >#if defined STAP_SDT_V1</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_TRANSACTION_START_ENABLED() __builtin_expect (transaction__start_semaphore, 0)</font></div><div><font size="2"   >#define postgresql_transaction__start_semaphore transaction__start_semaphore</font></div><div><font size="2"   >#else</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_TRANSACTION_START_ENABLED() __builtin_expect (postgresql_transaction__start_semaphore, 0)</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   >__extension__ extern unsigned short postgresql_transaction__start_semaphore __attribute__ ((unused)) __attribute__ ((section (".probes")));</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_TRANSACTION_START(arg1) \</font></div><div><font size="2"   >DTRACE_PROBE1(postgresql,transaction__start,arg1)</font></div><p></p></pre></div><div><br></div><div>probe定义 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#define TRACE_POSTGRESQL_TRANSACTION_START(arg1) \</font></div><div><font size="2"   >DTRACE_PROBE1(postgresql,transaction__start,arg1)</font></div><p></p></pre></div><div>对应</div><div>/usr/include/sys/sdt.h</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/* DTrace compatible macro names. &nbsp;*/</font></div><div><font size="2"   >#define DTRACE_PROBE1(provider,probe,parm1) &nbsp; &nbsp; \</font></div><div><font size="2"   >&nbsp; STAP_PROBE1(provider,probe,parm1)</font></div><p></p></pre></div><div>所以这个定义的probe = transaction__start</div><div>参数为arg1.</div><div><div>参数含义在代码中可以找到, 如下 :&nbsp;</div><div>TRACE_POSTGRESQL_TRANSACTION_START 宏在代码中使用的位置</div><div>src/backend/access/transam/xact.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/* ----------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;interface routines</font></div><div><font size="2"   >&nbsp;* ----------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;StartTransaction</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static void</font></div><div><font size="2"   >StartTransaction(void)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TransactionState s;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; VirtualTransactionId vxid;</font></div><div><font size="2"   >...</font></div><div><font size="2"   >略</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Advertise it in the proc array. &nbsp; &nbsp; &nbsp;We assume assignment of</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* LocalTransactionID is atomic, and the backendId should be set already.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Assert(MyProc-&gt;backendId == vxid.backendId);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; MyProc-&gt;lxid = vxid.localTransactionId;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TRACE_POSTGRESQL_TRANSACTION_START(vxid.localTransactionId);</font></div><div><font size="2"   >...</font></div><div><font size="2"   >略</font></div><p></p></pre></div></div></div><div>自定义PostgreSQL探针参考 :&nbsp;</div></div></div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201391123645546/"   >http://blog.163.com/digoal@126/blog/static/163877040201391123645546/</a></div></div>
	</div>
</div>
</body>
</html>