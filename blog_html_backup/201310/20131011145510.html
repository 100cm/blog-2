<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL Systemtap example : Customize probe "connect and disconnect"</h2>
	<h5 id="">2013-10-11 14:55:10&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201391123645546/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>本文要讲一下PostgreSQL的定制化探针, 系统自带的探针以后再讲.</div><div>源码下过来之后, 在编译前, 我们能看到数据库探针的定义文件在src/backend/utils/probes.d中.&nbsp;</div><div>probes.h文件是编译时生成的, 所以要添加探针的话, 只需要修改<span style="line-height: 28px;"   >probes.d文件, 本文添加的探针没有参数, 如果要添加参数, 请注意参数的类型, 如果没有合适的类型, 请先把类型定义写到probes.d中.</span></div><div><span style="line-height: 28px;"   >使用探针的前提, 编译时使用了enable-dtrace选项.</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >./configure --prefix=/home/pg93/pgsql9.3.1 --with-pgport=1999 --with-perl --with-tcl --with-python --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=16 --enable-dtrace --enable-debug</font></span></div><div></div><p></p></pre></div><div>接下来是添加自定义探针的步骤如下 :&nbsp;</div><div>例如我们要添加2个探针, 分别选择在连接数据库和断开连接时触发.</div><div>修改probes.d, 添加探针.</div><div><span style="line-height: 28px;"   >vi src/backend/utils/probes.d</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >provider postgresql {</font></div><div><font size="2"   >// add by digoal</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; probe client_conn();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; probe client_close();</font></div><p></p></pre></div><div>编译probes.d, 将在probes.h生成探针宏, 这个宏遵循&nbsp;/usr/include/sys/sdt.h 标准 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 postgresql-9.3.1]# cd src/backend/utils/</font></div><div><font size="2"   >[root@db-172-16-3-39 utils]# make</font></div></div><div><font size="2"   >[root@db-172-16-3-39 utils]# less probes.h</font></div><div><div><font size="2"   >/* TRACE_POSTGRESQL_CLIENT_CONN () */</font></div><div><font size="2"   >#if defined STAP_SDT_V1</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_CLIENT_CONN_ENABLED() __builtin_expect (client_conn_semaphore, 0)</font></div><div><font size="2"   >#define postgresql_client_conn_semaphore client_conn_semaphore</font></div><div><font size="2"   >#else</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_CLIENT_CONN_ENABLED() __builtin_expect (postgresql_client_conn_semaphore, 0)</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   >__extension__ extern unsigned short postgresql_client_conn_semaphore __attribute__ ((unused)) __attribute__ ((section (".probes")));</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_CLIENT_CONN() \</font></div><div><font size="2"   >DTRACE_PROBE(postgresql,client_conn)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >/* TRACE_POSTGRESQL_CLIENT_CLOSE () */</font></div><div><font size="2"   >#if defined STAP_SDT_V1</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_CLIENT_CLOSE_ENABLED() __builtin_expect (client_close_semaphore, 0)</font></div><div><font size="2"   >#define postgresql_client_close_semaphore client_close_semaphore</font></div><div><font size="2"   >#else</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_CLIENT_CLOSE_ENABLED() __builtin_expect (postgresql_client_close_semaphore, 0)</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   >__extension__ extern unsigned short postgresql_client_close_semaphore __attribute__ ((unused)) __attribute__ ((section (".probes")));</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_CLIENT_CLOSE() \</font></div><div><font size="2"   >DTRACE_PROBE(postgresql,client_close)</font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   >把刚才生成的宏</span><span style="line-height: 28px;"   >TRACE_POSTGRESQL_CLIENT_CONN()以及</span><span style="line-height: 28px;"   >TRACE_POSTGRESQL_CLIENT_CLOSE()添加到PostgreSQL相应的源码中.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 utils]# cd /opt/soft_bak/postgresql-9.3.1/src/backend/libpq</font></div><div><font size="2"   >[root@db-172-16-3-39 libpq]# vi pqcomm.c</font></div><div><font size="2"   >// 所有加探针的源文件都必须包含pg_trace.h头, 以包含宏的定义</font></div><div><div><font size="2"   >// add by digoal</font></div><div><font size="2"   >#include "pg_trace.h"</font></div></div><div><font size="2"   >.... 略</font></div><div><font size="2"   >在pq_init函数开头加上宏<span style="line-height: 28px;"   >TRACE_POSTGRESQL_CLIENT_CONN();</span></font></div><div><div><font size="2"   >/* --------------------------------</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pq_init - initialize libpq at backend startup</font></div><div><font size="2"   >&nbsp;* --------------------------------</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >void</font></div><div><font size="2"   >pq_init(void)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; // add by digoal</font></div><div><font size="2"   >TRACE_POSTGRESQL_CLIENT_CONN();</font></div></div><div><font size="2"   >.... 略</font></div><div><font size="2"   ><span style="line-height: 28px;"   >在pq_close函数开头加上宏</span><span style="line-height: 28px;"   >TRACE_POSTGRESQL_CLIENT_CLOSE();</span></font></div><div><div><font size="2"   >/* --------------------------------</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pq_close - shutdown libpq at backend exit</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Note: in a standalone backend MyProcPort will be null,</font></div><div><font size="2"   >&nbsp;* don't crash during exit...</font></div><div><font size="2"   >&nbsp;* --------------------------------</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static void</font></div><div><font size="2"   >pq_close(int code, Datum arg)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >// add by digoal</font></div><div><font size="2"   >TRACE_POSTGRESQL_CLIENT_CLOSE();</font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   >重新编译PostgreSQL</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 libpq]# cd /opt/soft_bak/postgresql-9.3.1</font></div><div><font size="2"   >[root@db-172-16-3-39 postgresql-9.3.1]# gmake &amp;&amp; gmake install</font></div><p></p></pre></div><div>重启数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 postgresql-9.3.1]# su - pg93</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; pg_ctl restart -m fast</font></div><p></p></pre></div><div><br></div><div>测试新增的两个探针 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >[root@db-172-16-3-39 postgresql-9.3.1]# stap -e 'probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("client_conn"),process("/home/pg93/pgsql9.3.1/bin/postgres").mark("client_close") {printdln("---",pn(),execname(),cmdline_str(),pid())}'</font></p></pre></div><div>在其他会话中连接和断开数据库</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-39-&gt; psql</font></div><div><font size="2"   >psql (9.3.1)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><div><font size="2"   >digoal=# select pg_backend_pid();</font></div><div><font size="2"   >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11436</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >digoal=# \q</font></div><p></p></pre></div><div><br></div><div>在stap中可以看到输出 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("client_conn")---postgres---/home/pg93/pgsql9.3.1/bin/postgres---11436</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("client_close")---postgres---postgres: postgres digoal [local] idle---11436</font></div><p></p></pre></div><div><br></div><div><div>自定义探针步骤</div><div>1. 在源码中找到想要放探针的位置, 以及是否需要捕捉变量值</div><div>2. 修改probes.d, 新增类型定义(可选)</div><div>3. 修probes.d, 新增探针</div><div>4. 生成probes.h</div><div>5. 在源码相应位置插入探针</div><div>6. 在插入探针的源码中添加pg_trace.h头文件</div><div>7. 重新编译PostgreSQL</div><div>8. 重启数据库</div><div>9. 测试探针</div></div><div><br></div><div><br></div><div>[其他]</div><div>1. 如果在数据库的配置文件中配置了记录连接和断开连接的log, 那么可以从日志中看到类似如下信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2013-10-11 14:34:24.066 CST,,,10880,"",52579bf0.2a80,1,"",2013-10-11 14:34:24 CST,,0,LOG,00000,"connection received: host=[local]",,,,,,,,"BackendInitialize, postmaster.c:3857",""</font></div><div><font size="2"   >2013-10-11 14:34:24.067 CST,"postgres","digoal",10880,"[local]",52579bf0.2a80,2,"authentication",2013-10-11 14:34:24 CST,2/1,0,LOG,00000,"connection authorized: user=postgres database=digoal",,,,,,,,"PerformAuthentication, postinit.c:239",""</font></div><div><font size="2"   >2013-10-11 14:34:25.202 CST,"postgres","digoal",10880,"[local]",52579bf0.2a80,3,"idle",2013-10-11 14:34:24 CST,,0,LOG,00000,"disconnection: session time: 0:00:01.135 user=postgres database=digoal host=[local]",,,,,,,,"log_disconnections, postgres.c:4429","psql"</font></div><p></p></pre></div><div>所以在放连接和断开连接的探针时, 也可以选择以上几个代码的位置.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/dynamic-trace.html"   >http://www.postgresql.org/docs/9.3/static/dynamic-trace.html</a></div><div>2.&nbsp;<a style="line-height: 28px;" href="http://blog.163.com/digoal@126/blog/static/163877040201383044341926/"   >http://blog.163.com/digoal@126/blog/static/163877040201383044341926/</a></div><div>3.&nbsp;src/backend/utils/probes.d</div><div>4.&nbsp;src/include/pg_trace.h</div><div>5.&nbsp;<span style="line-height: 28px;"   >src/backend/utils/probes.h</span></div><div><span style="line-height: 28px;"   >6.&nbsp;</span>src/backend/libpq/pqcomm.c</div><div>7.&nbsp;/usr/include/sys/sdt.h</div></div>
	</div>
</div>
</body>
</html>