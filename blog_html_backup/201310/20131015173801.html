<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap EXP: trace PostgreSQL netflow per session or per sql</h2>
	<h5 id="">2013-10-15 17:38:01&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020139153195701/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>前面几篇blog介绍了使用systemtap统计PostgreSQL单挑SQL以及整个会话的io操作.</div><div>本文将要介绍一下对数据库单条SQL的网络传输包, 传输字节数的统计. 以及整个会话的统计.</div><div>需要用到的探针如下 :&nbsp;</div><div>tapset/tcp.stp</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/**</font></div><div><font size="2"   >&nbsp;* probe tcp.recvmsg.return - Receiving TCP message complete</font></div><div><font size="2"   >&nbsp;* @name: Name of this probe</font></div><div><font size="2"   >&nbsp;* @size: Number of bytes received or error code if an error occurred.</font></div><div><font size="2"   >&nbsp;* @family: IP address family</font></div><div><font size="2"   >&nbsp;* @saddr: A string representing the source IP address</font></div><div><font size="2"   >&nbsp;* @daddr: A string representing the destination IP address</font></div><div><font size="2"   >&nbsp;* @sport: TCP source port&nbsp;</font></div><div><font size="2"   >&nbsp;* @dport: TCP destination port</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Context:</font></div><div><font size="2"   >&nbsp;* &nbsp;The process which receives a tcp message</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >probe tcp.recvmsg.return = kernel.function("tcp_recvmsg").return {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; name = "tcp.recvmsg"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; size = $return</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; family &nbsp;= __ip_sock_family($sk)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; saddr &nbsp; = format_ipaddr(__ip_sock_saddr($sk), __ip_sock_family($sk))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; daddr &nbsp; = format_ipaddr(__ip_sock_daddr($sk), __ip_sock_family($sk))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sport = __tcp_sock_sport($sk)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; dport = __tcp_sock_dport($sk)</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >/**</font></div><div><font size="2"   >&nbsp;* probe tcp.sendmsg.return - &nbsp;Sending TCP message is done</font></div><div><font size="2"   >&nbsp;* @name: Name of this probe</font></div><div><font size="2"   >&nbsp;* @size: Number of bytes sent or error code if an error occurred.&nbsp;</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Context:</font></div><div><font size="2"   >&nbsp;* &nbsp;The process which sends a tcp message</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >probe tcp.sendmsg.return = kernel.function("tcp_sendmsg").return {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; name = "tcp.sendmsg"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; size = $return&nbsp;</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>以上探针对应的linux 源码 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 tapset]# stap -l 'kernel.function("tcp_sendmsg")'</font></div><div><font size="2"   >kernel.function("tcp_sendmsg@net/ipv4/tcp.c:902")</font></div><div><font size="2"   >[root@db-172-16-3-150 tapset]# less /usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/net/ipv4/tcp.c&nbsp;</font></div><div><font size="2"   >int tcp_sendmsg(struct kiocb *iocb, struct socket *sock, struct msghdr *msg,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size_t size)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct sock *sk = sock-&gt;sk;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct iovec *iov;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct tcp_sock *tp = tcp_sk(sk);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct sk_buff *skb;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int iovlen, flags;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int mss_now, size_goal;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int err, copied;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; long timeo;</font></div><p></p></pre></div></div><div>接下来写stp脚本, tcp.sendmsg.return没有源和目的ip信息, 所以需要自己写 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# cat t.stp</font></div><div><font size="2"   >global var1%[60000] &nbsp;// 记录每SQL网络传输流量统计信息</font></div><div><font size="2"   >global var11%[60000] &nbsp;// 记录每SQL网络传输时间统计信息</font></div><div><font size="2"   >global var2%[60000] &nbsp;// 记录所有会话网络传输流量统计信息</font></div><div><font size="2"   >global var22%[60000] &nbsp;// 记录所有会话网络传输时间统计信息</font></div><div><font size="2"   >global del%[120000] // 因为foreach中不允许修改本数组, 所以需要使用另一个数组来存储索引, 方便删除</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe tcp.sendmsg.return {</font></div><div><font size="2"   >&nbsp; if ($return&gt;0 &amp;&amp; execname()=="postgres") {</font></div><div><font size="2"   >&nbsp; &nbsp; v_us = gettimeofday_us() - @entry(gettimeofday_us())</font></div><div><font size="2"   >&nbsp; &nbsp; saddr = format_ipaddr(__ip_sock_saddr($sock-&gt;sk), __ip_sock_family($sock-&gt;sk))</font></div><div><font size="2"   >&nbsp; &nbsp; daddr = format_ipaddr(__ip_sock_daddr($sock-&gt;sk), __ip_sock_family($sock-&gt;sk))</font></div><div><font size="2"   >&nbsp; &nbsp; sport = __tcp_sock_sport($sock-&gt;sk)</font></div><div><font size="2"   >&nbsp; &nbsp; dport = __tcp_sock_dport($sock-&gt;sk)</font></div><div><font size="2"   >&nbsp; &nbsp; var1[pid(),execname(),saddr,sport,daddr,dport,"S"] &lt;&lt;&lt; $return</font></div><div><font size="2"   >&nbsp; &nbsp; var11[pid(),execname(),saddr,sport,daddr,dport,"S"] &lt;&lt;&lt; v_us</font></div><div><font size="2"   >&nbsp; &nbsp; var2[saddr,sport,daddr,dport,"S"] &lt;&lt;&lt; $return</font></div><div><font size="2"   >&nbsp; &nbsp; var22[saddr,sport,daddr,dport,"S"] &lt;&lt;&lt; v_us</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe tcp.recvmsg.return {</font></div><div><font size="2"   >&nbsp; if ($return&gt;0 &amp;&amp; execname()=="postgres") {</font></div><div><font size="2"   >&nbsp; &nbsp; v_us = gettimeofday_us() - @entry(gettimeofday_us())</font></div><div><font size="2"   >&nbsp; &nbsp; var1[pid(),execname(),saddr,sport,daddr,dport,"R"] &lt;&lt;&lt; $return</font></div><div><font size="2"   >&nbsp; &nbsp; var11[pid(),execname(),saddr,sport,daddr,dport,"R"] &lt;&lt;&lt; v_us</font></div><div><font size="2"   >&nbsp; &nbsp; var2[saddr,sport,daddr,dport,"R"] &lt;&lt;&lt; $return</font></div><div><font size="2"   >&nbsp; &nbsp; var22[saddr,sport,daddr,dport,"R"] &lt;&lt;&lt; v_us</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__start") {</font></div><div><font size="2"   >&nbsp; foreach([a,b,c,d,e,f,g] in var1) {</font></div><div><font size="2"   >&nbsp; &nbsp; if (a==pid() &amp;&amp; b==execname()) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; del[a,b,c,d,e,f,g]=1</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >&nbsp; foreach([a,b,c,d,e,f,g] in del) {</font></div><div><font size="2"   >&nbsp; &nbsp; delete var1[a,b,c,d,e,f,g]</font></div><div><font size="2"   >&nbsp; &nbsp; delete var11[a,b,c,d,e,f,g]</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >&nbsp; delete del</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__done") {</font></div><div><font size="2"   >&nbsp; // 输出SQL语句</font></div><div><font size="2"   >&nbsp; printf("query: %s\n", user_string($arg1))</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; foreach([a,b,c,d,e,f,g] in var1 @sum -) {</font></div><div><font size="2"   >&nbsp; &nbsp; if (g=="S" &amp;&amp; a==pid() &amp;&amp; b==execname()) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; v1 = @count(var1[a,b,c,d,e,f,g]) &nbsp;// 发送包数</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; v2 = @sum(var1[a,b,c,d,e,f,g]) / 1024 &nbsp;// 发送K字节数</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; v3 = @sum(var11[a,b,c,d,e,f,g]) &nbsp;// 发送时间</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; spv1 = ((v3!=0) ? ((1000000*v1)/v3) : 0) &nbsp;// 发送包每秒</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; spv2 = ((v3!=0) ? ((1000000*v2)/v3) : 0) &nbsp;// 发送K字节数每秒</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; printf("-%s-from:%s:%d-to:%s:%d, pkgs:%d, Kbytes:%d, pkgs/s:%d, Kbytes/s:%d\n", g,c,d,e,f, v1, v2, spv1, spv2)</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; if (g=="R" &amp;&amp; a==pid() &amp;&amp; b==execname()) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; v4 = @count(var1[a,b,c,d,e,f,g]) &nbsp;// 接收包数</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; v5 = @sum(var1[a,b,c,d,e,f,g]) / 1024 &nbsp;// 接收K字节数</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; v6 = @sum(var11[a,b,c,d,e,f,g]) &nbsp;// 接收时间</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; spv3 = ((v6!=0) ? ((1000000*v4)/v6) : 0) &nbsp;// 接收包每秒</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; spv4 = ((v6!=0) ? ((1000000*v5)/v6) : 0) &nbsp;// 接收K字节数每秒</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; printf("-%s-from:%s:%d-to:%s:%d, pkgs:%d, Kbytes:%d, pkgs/s:%d, Kbytes/s:%d\n", g,e,f,c,d, v4, v5, spv3, spv4)</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; del[a,b,c,d,e,f,g]=1</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; foreach([a,b,c,d,e,f,g] in del) {</font></div><div><font size="2"   >&nbsp; &nbsp; delete var1[a,b,c,d,e,f,g]</font></div><div><font size="2"   >&nbsp; &nbsp; delete var11[a,b,c,d,e,f,g]</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >&nbsp; delete del</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe end {</font></div><div><font size="2"   >&nbsp; println("----------END----------")</font></div><div><font size="2"   >&nbsp; foreach([a,b,c,d,e] in var2 @sum -) {</font></div><div><font size="2"   >&nbsp; &nbsp; if (e == "S") {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; v1 = @count(var2[a,b,c,d,e]) &nbsp;// 发送包数</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; v2 = @sum(var2[a,b,c,d,e]) / 1024 &nbsp;// 发送K字节数</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; v3 = @sum(var22[a,b,c,d,e]) &nbsp;// 发送时间</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; spv1 = ((v3!=0) ? ((1000000*v1)/v3) : 0) &nbsp;// 发送包每秒</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; spv2 = ((v3!=0) ? ((1000000*v2)/v3) : 0) &nbsp;// 发送K字节数每秒</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; printf("-%s-from:%s:%d-to:%s:%d, pkgs:%d, Kbytes:%d, pkgs/s:%d, Kbytes/s:%d\n", e,a,b,c,d, v1, v2, spv1, spv2)</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; if (e == "R") {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; v4 = @count(var2[a,b,c,d,e]) &nbsp;// 接收包数</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; v5 = @sum(var2[a,b,c,d,e]) / 1024 &nbsp;// 接收K字节数</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; v6 = @sum(var22[a,b,c,d,e]) &nbsp;// 接收时间</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; spv3 = ((v6!=0) ? ((1000000*v4)/v6) : 0) &nbsp;// 接收包每秒</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; spv4 = ((v6!=0) ? ((1000000*v5)/v6) : 0) &nbsp;// 接收K字节数每秒</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; printf("-%s-from:%s:%d-to:%s:%d, pkgs:%d, Kbytes:%d, pkgs/s:%d, Kbytes/s:%d\n", e,c,d,a,b, v4, v5, spv3, spv4)</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >&nbsp; delete var1</font></div><div><font size="2"   >&nbsp; delete var11</font></div><div><font size="2"   >&nbsp; delete var2</font></div><div><font size="2"   >&nbsp; delete var22</font></div><div><font size="2"   >&nbsp; delete del</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>测试 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# /opt/systemtap/bin/stap -u t.stp</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >执行以下SQL :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# drop table t;</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >digoal=# create table t(id int, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into t select generate_series(1,1000000), md5(random()::text), clock_timestamp();</font></div><div><font size="2"   >INSERT 0 1000000</font></div><div><span style="line-height: 28px;"   ><font size="2"   >digoal=# \dt+</font></span></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | Name | Type &nbsp;| &nbsp;Owner &nbsp; | Size &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+------+-------+----------+-------+-------------</font></div><div><font size="2"   >&nbsp;public | t &nbsp; &nbsp;| table | postgres | 73 MB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><span style="line-height: 28px;"   ><font size="2"   >digoal=# \q</font></span></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; psql -h 172.16.3.150 -p 1921 -c "copy t to stdout"|psql -h 172.16.3.150 -p 1921 -c "copy t from stdin"</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; psql -h 172.16.3.150 -p 1921 -c "copy t to stdout"|psql -h 172.16.3.150 -p 1921 -c "copy t from stdin"</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >stap输出结果如下</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >query: drop table t;</font></div><div><font size="2"   >-R-from:172.16.3.39:37919-to:172.16.3.150:1921, pkgs:2, Kbytes:0, pkgs/s:5141, Kbytes/s:0</font></div><div><font size="2"   >-S-from:172.16.3.150:1921-to:172.16.3.39:37919, pkgs:2, Kbytes:0, pkgs/s:60606, Kbytes/s:0</font></div><div><font size="2"   >query: create table t(id int, info text, crt_time timestamp);</font></div><div><font size="2"   >-R-from:172.16.3.39:37919-to:172.16.3.150:1921, pkgs:2, Kbytes:0, pkgs/s:5141, Kbytes/s:0</font></div><div><font size="2"   >-S-from:172.16.3.150:1921-to:172.16.3.39:37919, pkgs:2, Kbytes:0, pkgs/s:60606, Kbytes/s:0</font></div><div><font size="2"   >query: insert into t select generate_series(1,1000000), md5(random()::text), clock_timestamp();</font></div><div><font size="2"   >-R-from:172.16.3.39:37919-to:172.16.3.150:1921, pkgs:2, Kbytes:0, pkgs/s:5141, Kbytes/s:0</font></div><div><font size="2"   >-S-from:172.16.3.150:1921-to:172.16.3.39:37919, pkgs:3, Kbytes:0, pkgs/s:53571, Kbytes/s:0</font></div><div><font size="2"   >query: SELECT n.nspname as "Schema",</font></div><div><font size="2"   >&nbsp; c.relname as "Name",</font></div><div><font size="2"   >&nbsp; CASE c.relkind WHEN 'r' THEN 'table' WHEN 'v' THEN 'view' WHEN 'm' THEN 'materialized view' WHEN 'i' THEN 'index' WHEN 'S' THEN 'sequence' WHEN 's' THEN 'special' WHEN 'f' THEN 'foreign table' END as "Type",</font></div><div><font size="2"   >&nbsp; pg_catalog.pg_get_userbyid(c.relowner) as "Owner",</font></div><div><font size="2"   >&nbsp; pg_catalog.pg_size_pretty(pg_catalog.pg_table_size(c.oid)) as "Size",</font></div><div><font size="2"   >&nbsp; pg_catalog.obj_description(c.oid, 'pg_class') as "Description"</font></div><div><font size="2"   >FROM pg_catalog.pg_class c</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LEFT JOIN pg_catalog.pg_na</font></div><div><font size="2"   >-R-from:172.16.3.39:37920-to:172.16.3.150:1921, pkgs:1, Kbytes:0, pkgs/s:83333, Kbytes/s:0</font></div><div><font size="2"   >-S-from:172.16.3.150:1921-to:172.16.3.39:37920, pkgs:1, Kbytes:0, pkgs/s:83333, Kbytes/s:0</font></div><div><font size="2"   >query: copy t to stdout</font></div><div><font size="2"   >-S-from:172.16.3.150:1921-to:172.16.3.39:37921, pkgs:8761, Kbytes:70088, pkgs/s:7313, Kbytes/s:58505</font></div><div><font size="2"   >query: copy t from stdin</font></div><div><font size="2"   >-R-from:172.16.3.39:37922-to:172.16.3.150:1921, pkgs:8765, Kbytes:70094, pkgs/s:72554, Kbytes/s:580224</font></div><div><font size="2"   >-S-from:172.16.3.150:1921-to:172.16.3.39:37922, pkgs:2, Kbytes:0, pkgs/s:7662, Kbytes/s:0</font></div><div><font size="2"   >query: copy t to stdout</font></div><div><font size="2"   >-S-from:172.16.3.150:1921-to:172.16.3.39:37933, pkgs:17523, Kbytes:140184, pkgs/s:4478, Kbytes/s:35829</font></div><div><font size="2"   >query: copy t from stdin</font></div><div><font size="2"   >-R-from:172.16.3.39:37932-to:172.16.3.150:1921, pkgs:8636, Kbytes:69078, pkgs/s:64990, Kbytes/s:519848</font></div><div><font size="2"   >-S-from:172.16.3.150:1921-to:172.16.3.39:37932, pkgs:1, Kbytes:0, pkgs/s:38461, Kbytes/s:0</font></div></div><div><div><font size="2"   >^C----------END----------</font></div><div><font size="2"   >-S-from:172.16.3.150:1921-to:172.16.3.39:37933, pkgs:17527, Kbytes:140190, pkgs/s:4479, Kbytes/s:35831</font></div><div><font size="2"   >-R-from:172.16.3.39:37932-to:172.16.3.150:1921, pkgs:17530, Kbytes:140190, pkgs/s:55968, Kbytes/s:447589</font></div><div><font size="2"   >-S-from:172.16.3.150:1921-to:172.16.3.39:37921, pkgs:8765, Kbytes:70095, pkgs/s:7316, Kbytes/s:58509</font></div><div><font size="2"   >-R-from:172.16.3.39:37922-to:172.16.3.150:1921, pkgs:8769, Kbytes:70095, pkgs/s:71634, Kbytes/s:572610</font></div><div><font size="2"   >-R-from:172.16.3.39:37919-to:172.16.3.150:1921, pkgs:9, Kbytes:0, pkgs/s:0, Kbytes/s:0</font></div><div><font size="2"   >-R-from:172.16.3.39:37920-to:172.16.3.150:1921, pkgs:5, Kbytes:0, pkgs/s:0, Kbytes/s:0</font></div><div><font size="2"   >-S-from:172.16.3.150:1921-to:172.16.3.39:37919, pkgs:9, Kbytes:0, pkgs/s:56603, Kbytes/s:0</font></div><div><font size="2"   >-S-from:172.16.3.150:1921-to:172.16.3.39:37920, pkgs:4, Kbytes:0, pkgs/s:70175, Kbytes/s:0</font></div><div><font size="2"   >-S-from:172.16.3.150:1921-to:172.16.3.39:37922, pkgs:5, Kbytes:0, pkgs/s:16722, Kbytes/s:0</font></div><div><font size="2"   >-S-from:172.16.3.150:1921-to:172.16.3.39:37932, pkgs:5, Kbytes:0, pkgs/s:16501, Kbytes/s:0</font></div><div><font size="2"   >-R-from:172.16.3.39:37921-to:172.16.3.150:1921, pkgs:5, Kbytes:0, pkgs/s:87, Kbytes/s:0</font></div><div><font size="2"   >-R-from:172.16.3.39:37933-to:172.16.3.150:1921, pkgs:5, Kbytes:0, pkgs/s:61, Kbytes/s:0</font></div></div><p></p></pre></div><div>从PostgreSQL发送包到客户端的速度明显慢于从客户端发送到服务端的速度.</div><div>这可能和测试环境有关, 如果直接输出到/dev/null是快的, 例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >psql -h 172.16.3.150 -p 1921 -c "copy t to stdout" &gt;/dev/null 2&gt;&amp;1</font></div><div><font size="2"   >输出的速率提高到了433MB/s</font></div><div><div><font size="2"   >query: copy t to stdout</font></div><div><font size="2"   >-S-from:172.16.3.150:1921-to:172.16.3.39:37961, pkgs:70096, Kbytes:560752, pkgs/s:54195, Kbytes/s:433552</font></div><div><font size="2"   >-R-from:172.16.3.39:37961-to:172.16.3.150:1921, pkgs:2, Kbytes:0, pkgs/s:4889, Kbytes/s:0</font></div></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/useful-systemtap-scripts.html"   >https://sourceware.org/systemtap/SystemTap_Beginners_Guide/useful-systemtap-scripts.html</a></div><div>2.&nbsp;<a style="line-height: 28px;" href="http://blog.163.com/digoal@126/blog/static/16387704020139152191581/"   >http://blog.163.com/digoal@126/blog/static/16387704020139152191581/</a></div></div>
	</div>
</div>
</body>
</html>