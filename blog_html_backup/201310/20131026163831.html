<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL bulk COPY load Bottleneck by extend lock waiting</h2>
	<h5 id="">2013-10-26 16:38:31&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201392641033482/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>今天在pg大会上和一位兄弟聊天的时候了解到他们有大的数据入库需求, 入库文件约300MB每个, 但是导入数据库速度只有约100MB每秒, 即使使用unlogged table也没有多大的提高, 而硬盘拷贝的速度远远不止这个速度.&nbsp;</div><div>接下来分析一下原因. 从分析来看, 目前批量数据导入到瓶颈是在数据文件的扩展上.&nbsp;</div><div>测试场景 :&nbsp;</div><div>服务器 8核, 144GB内存, 硬盘ssd.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >降频到1.6GHz&nbsp;</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >数据库 9.3.1</span></div><div><span style="line-height: 28px;"   >配置 &nbsp;:&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; pg_config&nbsp;</font></div><div><font size="2"   >BINDIR = /home/pg93/pgsql9.3.1/bin</font></div><div><font size="2"   >DOCDIR = /home/pg93/pgsql9.3.1/share/doc</font></div><div><font size="2"   >HTMLDIR = /home/pg93/pgsql9.3.1/share/doc</font></div><div><font size="2"   >INCLUDEDIR = /home/pg93/pgsql9.3.1/include</font></div><div><font size="2"   >PKGINCLUDEDIR = /home/pg93/pgsql9.3.1/include</font></div><div><font size="2"   >INCLUDEDIR-SERVER = /home/pg93/pgsql9.3.1/include/server</font></div><div><font size="2"   >LIBDIR = /home/pg93/pgsql9.3.1/lib</font></div><div><font size="2"   >PKGLIBDIR = /home/pg93/pgsql9.3.1/lib</font></div><div><font size="2"   >LOCALEDIR = /home/pg93/pgsql9.3.1/share/locale</font></div><div><font size="2"   >MANDIR = /home/pg93/pgsql9.3.1/share/man</font></div><div><font size="2"   >SHAREDIR = /home/pg93/pgsql9.3.1/share</font></div><div><font size="2"   >SYSCONFDIR = /home/pg93/pgsql9.3.1/etc</font></div><div><font size="2"   >PGXS = /home/pg93/pgsql9.3.1/lib/pgxs/src/makefiles/pgxs.mk</font></div><div><font size="2"   >CONFIGURE = '--prefix=/home/pg93/pgsql9.3.1' '--with-pgport=1921' '--with-perl' '--with-tcl' '--with-python' '--with-openssl' '--with-pam' '--without-ldap' '--with-libxml' '--with-libxslt' '--enable-thread-safety' '--with-wal-blocksize=16' '--enable-dtrace' '--enable-debug'</font></div><div><font size="2"   >CC = gcc</font></div><div><font size="2"   >CPPFLAGS = -D_GNU_SOURCE -I/usr/include/libxml2</font></div><div><font size="2"   >CFLAGS = -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -g</font></div><div><font size="2"   >CFLAGS_SL = -fpic</font></div><div><font size="2"   >LDFLAGS = -L../../../src/common -Wl,--as-needed -Wl,-rpath,'/home/pg93/pgsql9.3.1/lib',--enable-new-dtags</font></div><div><font size="2"   >LDFLAGS_EX =&nbsp;</font></div><div><font size="2"   >LDFLAGS_SL =&nbsp;</font></div><div><font size="2"   >LIBS = -lpgport -lpgcommon -lxslt -lxml2 -lpam -lssl -lcrypto -lz -lreadline -lcrypt -ldl -lm&nbsp;</font></div><div><font size="2"   >VERSION = PostgreSQL 9.3.1</font></div><p></p></pre></div><div>操作系统 CentOS 6.4 x64</div><div>数据库配置 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"   >max_connections = 100 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >superuser_reserved_connections = 13 &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_directories = '.' &nbsp; # comma-separated list of directories</font></div><div><font size="2"   >shared_buffers = 2048MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div><font size="2"   >maintenance_work_mem = 1024MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 1MB</font></div><div><font size="2"   >max_stack_depth = 8MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 100kB</font></div><div><font size="2"   >vacuum_cost_delay = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 0-100 milliseconds</font></div><div><font size="2"   >vacuum_cost_limit = 10000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 credits</font></div><div><font size="2"   >bgwriter_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 10-10000ms between rounds</font></div><div><font size="2"   >wal_level = hot_standby &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, or hot_standby</font></div><div><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level;</font></div><div><font size="2"   >wal_buffers = 16384kB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 32kB, -1 sets based on shared_buffers</font></div><div><font size="2"   >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"   >checkpoint_segments = 256 &nbsp; &nbsp; &nbsp; # in logfile segments, min 1, 16MB each</font></div><div><font size="2"   >archive_mode = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # allows archiving to be done</font></div><div><font size="2"   >archive_command = '/bin/date' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # command to use to archive a logfile segment</font></div><div><font size="2"   >max_wal_senders = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of walsender processes</font></div><div><font size="2"   >random_page_cost = 1.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# same scale as above</font></div><div><font size="2"   >effective_cache_size = 128000MB</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_directory = 'pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,</font></div><div><font size="2"   >log_file_mode = 0600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# creation mode for log files,</font></div><div><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div><font size="2"   >log_rotation_age = 1d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Automatic rotation of logfiles will</font></div><div><font size="2"   >log_rotation_size = 10MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Automatic rotation of logfiles will</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_disconnections = on</font></div><div><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div><font size="2"   >log_timezone = 'PRC'</font></div><div><font size="2"   >autovacuum = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Enable autovacuum subprocess? &nbsp;'on'</font></div><div><font size="2"   >log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</font></div><div><font size="2"   >autovacuum_freeze_max_age = 1900000000 &nbsp;# maximum XID age before forced vacuum</font></div><div><font size="2"   >vacuum_freeze_min_age = 50000000</font></div><div><font size="2"   >vacuum_freeze_table_age = 1500000000</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >timezone = 'PRC'</font></div><div><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><p></p></pre></div><div>pg_xlog和表空间,索引表空间放在3个不同的ssd硬盘.</div><div>测试表 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table t (id int, c1 text, c2 text, c3 text, c4 text, c5 text, c6 text, c7 text, c8 text, c9 text, c10 text, c11 text, c12 text, c13 timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div>测试数据 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into t select generate_series(1,10000), md5(random()::text), md5(random()::text), md5(random()::text), md5(random()::text), md5(random()::text), md5(random()::text), md5(random()::text), md5(random()::text), md5(random()::text), md5(random()::text), md5(random()::text), md5(random()::text), clock_timestamp();</font></div><div><font size="2"   >INSERT 0 10000</font></div><p></p></pre></div><div>每个数据块8KB存储18条记录. &nbsp;平均每条记录455字节.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select ctid from t;</font></div><div><font size="2"   >&nbsp; &nbsp;ctid &nbsp;&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;(0,1)</font></div><div><font size="2"   >&nbsp;(0,2)</font></div><div><font size="2"   >&nbsp;(0,3)</font></div><div><font size="2"   >&nbsp;(0,4)</font></div><div><font size="2"   >&nbsp;(0,5)</font></div><div><font size="2"   >&nbsp;(0,6)</font></div><div><font size="2"   >&nbsp;(0,7)</font></div><div><font size="2"   >&nbsp;(0,8)</font></div><div><font size="2"   >&nbsp;(0,9)</font></div><div><font size="2"   >&nbsp;(0,10)</font></div><div><font size="2"   >&nbsp;(0,11)</font></div><div><font size="2"   >&nbsp;(0,12)</font></div><div><font size="2"   >&nbsp;(0,13)</font></div><div><font size="2"   >&nbsp;(0,14)</font></div><div><font size="2"   >&nbsp;(0,15)</font></div><div><font size="2"   >&nbsp;(0,16)</font></div><div><font size="2"   >&nbsp;(0,17)</font></div><div><font size="2"   >&nbsp;(0,18)</font></div><div><font size="2"   >&nbsp;(1,1)</font></div><p></p></pre></div><div>插入60万条测试数据</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into t select generate_series(1,600000), md5(random()::text), md5(random()::text), md5(random()::text), md5(random()::text), md5(random()::text), md5(random()::text), md5(random()::text), md5(random()::text), md5(random()::text), md5(random()::text), md5(random()::text), md5(random()::text), clock_timestamp();</font></div><div><font size="2"   >INSERT 0 600000</font></div><p></p></pre></div><div>创建1个btree索引.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create index idx_t_id on t(id);</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >表达大小265MB</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \dt+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp; Schema &nbsp;| Name | Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp;Size &nbsp;| Description&nbsp;</font></div><div><font size="2"   >----------+------+-------+----------+--------+-------------</font></div><div><font size="2"   >&nbsp;postgres | t &nbsp; &nbsp;| table | postgres | 265 MB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>把数据拷贝到硬盘&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# copy t to '/home/pg93/t.dmp' with (header off);</font></div><div><font size="2"   >COPY 0 610000</font></div><div><font size="2"   >digoal=# \! ls -lh /home/pg93/t.dmp</font></div><div><font size="2"   >-rw-r--r-- 1 pg93 pg93 250M Oct 26 15:07 /home/pg93/t.dmp</font></div><p></p></pre></div><div>创建pgbench测试脚本,&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; vi test.sql</font></div><div><font size="2"   >copy t from '/home/pg93/t.dmp' with (header off);</font></div><div></div><p></p></pre></div><div>使用8个并发连接, 每个执行4遍.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 8 -j 4 -t 4&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >number of transactions per client: 4</font></div><div><font size="2"   >number of transactions actually processed: 32/32</font></div><div><font size="2"   >tps = 0.365815 (including connections establishing)</font></div><div><font size="2"   >tps = 0.365846 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 21834.036437 &nbsp; &nbsp;copy t from '/home/pg93/t.dmp' with (header off);</font></div><p></p></pre></div><div>每秒约导入91MB 或 22.3万条记录.</div><div>使用unlogged table再次测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# update pg_class set relpersistence='u' where relname='t';</font></div><div><font size="2"   >digoal=# update pg_class set relpersistence='u' where relname='idx_t_id';</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >测试结果 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 8 -j 4 -t 4&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >number of transactions per client: 4</font></div><div><font size="2"   >number of transactions actually processed: 32/32</font></div><div><font size="2"   >tps = 0.423626 (including connections establishing)</font></div><div><font size="2"   >tps = 0.423670 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 18879.816156 &nbsp; &nbsp;copy t from '/home/pg93/t.dmp' with (header off);</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >每秒约导入106MB 或 25.8万条记录.</span></div><div><span style="line-height: 28px;"   ><br></span></div><div>测试过程中发现有大量的copy waiting.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >21551 pg93 &nbsp; &nbsp; &nbsp;20 &nbsp; 0 2271m 1.9g 1.9g S 24.1 &nbsp;2.0 &nbsp; 0:12.54 postgres: postgres digoal [local] COPY waiting &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >21553 pg93 &nbsp; &nbsp; &nbsp;20 &nbsp; 0 2271m 1.9g 1.9g S 24.1 &nbsp;2.0 &nbsp; 0:12.51 postgres: postgres digoal [local] COPY waiting &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >21554 pg93 &nbsp; &nbsp; &nbsp;20 &nbsp; 0 2271m 1.9g 1.9g R 24.1 &nbsp;2.0 &nbsp; 0:12.70 postgres: postgres digoal [local] COPY &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >21560 pg93 &nbsp; &nbsp; &nbsp;20 &nbsp; 0 2271m 1.9g 1.9g S 24.1 &nbsp;2.0 &nbsp; 0:12.69 postgres: postgres digoal [local] COPY waiting &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >21548 pg93 &nbsp; &nbsp; &nbsp;20 &nbsp; 0 2271m 1.9g 1.9g S 20.7 &nbsp;2.0 &nbsp; 0:12.70 postgres: postgres digoal [local] COPY waiting &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >21549 pg93 &nbsp; &nbsp; &nbsp;20 &nbsp; 0 2271m 1.9g 1.9g S 20.7 &nbsp;2.0 &nbsp; 0:12.72 postgres: postgres digoal [local] COPY waiting &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >21550 pg93 &nbsp; &nbsp; &nbsp;20 &nbsp; 0 2271m 1.9g 1.9g S 20.7 &nbsp;2.0 &nbsp; 0:12.65 postgres: postgres digoal [local] COPY waiting &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >21552 pg93 &nbsp; &nbsp; &nbsp;20 &nbsp; 0 2271m 1.9g 1.9g S 20.7 &nbsp;2.0 &nbsp; 0:12.76 postgres: postgres digoal [local] COPY waiting &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >21555 pg93 &nbsp; &nbsp; &nbsp;20 &nbsp; 0 2271m 1.9g 1.9g S 20.7 &nbsp;2.0 &nbsp; 0:12.71 postgres: postgres digoal [local] COPY waiting &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >21557 pg93 &nbsp; &nbsp; &nbsp;20 &nbsp; 0 2271m 1.9g 1.9g S 20.7 &nbsp;2.0 &nbsp; 0:12.62 postgres: postgres digoal [local] COPY waiting &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >21558 pg93 &nbsp; &nbsp; &nbsp;20 &nbsp; 0 2271m 1.9g 1.9g S 20.7 &nbsp;2.0 &nbsp; 0:12.45 postgres: postgres digoal [local] COPY waiting &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >21559 pg93 &nbsp; &nbsp; &nbsp;20 &nbsp; 0 2271m 1.9g 1.9g S 20.7 &nbsp;2.0 &nbsp; 0:12.77 postgres: postgres digoal [local] COPY waiting &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >21561 pg93 &nbsp; &nbsp; &nbsp;20 &nbsp; 0 2271m 1.9g 1.9g R 20.7 &nbsp;2.0 &nbsp; 0:12.63 postgres: postgres digoal [local] COPY &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >21562 pg93 &nbsp; &nbsp; &nbsp;20 &nbsp; 0 2271m 1.9g 1.9g R 20.7 &nbsp;2.0 &nbsp; 0:12.83 postgres: postgres digoal [local] COPY &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >21563 pg93 &nbsp; &nbsp; &nbsp;20 &nbsp; 0 2271m 1.9g 1.9g S 20.7 &nbsp;2.0 &nbsp; 0:12.71 postgres: postgres digoal [local] COPY waiting &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >21556 pg93 &nbsp; &nbsp; &nbsp;20 &nbsp; 0 2271m 1.9g 1.9g S 17.2 &nbsp;2.0 &nbsp; 0:12.58 postgres: postgres digoal [local] COPY waiting</font></div><p></p></pre></div><div>通过pg_locks, 发现是存储扩展锁.</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >digoal=# select * from pg_locks where not granted;</font></span></div><div><font size="2"   >&nbsp;locktype | database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualtransaction | &nbsp;pid</font></div><div><font size="2"   >&nbsp; | &nbsp; &nbsp; mode &nbsp; &nbsp; &nbsp;| granted | fastpath&nbsp;</font></div><div><font size="2"   >----------+----------+----------+------+-------+------------+---------------+---------+-------+----------+--------------------+-----</font></div><div><font size="2"   >--+---------------+---------+----------</font></div><div><font size="2"   >&nbsp;extend &nbsp; | &nbsp; &nbsp;16384 | &nbsp; &nbsp;65765 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 6/30 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2159</font></div><div><font size="2"   >6 | ExclusiveLock | f &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >&nbsp;extend &nbsp; | &nbsp; &nbsp;16384 | &nbsp; &nbsp;65765 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 9/30 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2159</font></div><div><font size="2"   >9 | ExclusiveLock | f &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >&nbsp;extend &nbsp; | &nbsp; &nbsp;16384 | &nbsp; &nbsp;65765 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 8/30 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2159</font></div><div><font size="2"   >8 | ExclusiveLock | f &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >&nbsp;extend &nbsp; | &nbsp; &nbsp;16384 | &nbsp; &nbsp;65765 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3/49 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2159</font></div><div><font size="2"   >3 | ExclusiveLock | f &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >&nbsp;extend &nbsp; | &nbsp; &nbsp;16384 | &nbsp; &nbsp;65765 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2/143 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2159</font></div><div><font size="2"   >2 | ExclusiveLock | f &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div><div>并发越大, 锁概率越大, 下面我们使用stap来跟踪,&nbsp;<span style="line-height: 28px;"   >锁耗费了多少时间.</span></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -t 1&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 28px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 28px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 28px;"   ><font size="2"   >number of clients: 16</font></div><div style="line-height: 28px;"   ><font size="2"   >number of threads: 4</font></div><div style="line-height: 28px;"   ><font size="2"   >number of transactions per client: 1</font></div><div style="line-height: 28px;"   ><font size="2"   >number of transactions actually processed: 16/16</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 0.261183 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 0.261247 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 61234.802062 &nbsp; &nbsp;copy t from '/home/pg93/t.dmp' with (header off);</font></div><p></p></pre></div></div><div style="line-height: 28px;"   >一次copy的时间是61秒.</div><div style="line-height: 28px;"   >锁耗费的时间是47.5秒.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >stap -e '</font></div><div><font size="2"   >global arr1%[12000] , arr2%[12000]</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("lock__wait__start") {</font></div><div><font size="2"   >&nbsp; arr1[pid(),$arg1,$arg2,$arg3,$arg4,$arg5,$arg6] = gettimeofday_us()</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("lock__wait__done") {</font></div><div><font size="2"   >&nbsp; t = gettimeofday_us()</font></div><div><font size="2"   >&nbsp; pid = pid()</font></div><div><font size="2"   >&nbsp; lv = arr1[pid,$arg1,$arg2,$arg3,$arg4,$arg5,$arg6]</font></div><div><font size="2"   >&nbsp; if ( lv )</font></div><div><font size="2"   >&nbsp; &nbsp; arr2[pid,$arg1,$arg2,$arg3,$arg4,$arg5,$arg6] &lt;&lt;&lt; t - lv</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe timer.s(1) {</font></div><div><font size="2"   >&nbsp; println("-----")</font></div><div><font size="2"   >&nbsp; foreach([a,b,c,d,e,f,g] in arr1)</font></div><div><font size="2"   >&nbsp; &nbsp; printf("pid: %d; obj: %d, %d, %d, %d; objtype:%d, locktype: %d, waitcnt:%d, waitus:%d\n", a, b, c, d, e, f, g, @count(arr2[a,b,c,d,e,f,g]), @sum(arr2[a,b,c,d,e,f,g]))</font></div><div><font size="2"   >}'</font></div><p></p></pre></div><div><pre class="prettyprint"   ><div><font size="2"   >pid: 21549; obj: 16384, 65765, 0, 0; objtype:1, locktype: 7, waitcnt:33978, waitus:47513070</font></div><div><font size="2"   >pid: 21552; obj: 16384, 65765, 0, 0; objtype:1, locktype: 7, waitcnt:33969, waitus:47575317</font></div><div><font size="2"   >pid: 21553; obj: 16384, 65765, 0, 0; objtype:1, locktype: 7, waitcnt:33967, waitus:47946887</font></div><div><font size="2"   >pid: 21551; obj: 16384, 65765, 0, 0; objtype:1, locktype: 7, waitcnt:33981, waitus:48020588</font></div><div><font size="2"   >pid: 21556; obj: 16384, 65765, 0, 0; objtype:1, locktype: 7, waitcnt:33971, waitus:47723644</font></div><div><font size="2"   >pid: 21554; obj: 16384, 65765, 0, 0; objtype:1, locktype: 7, waitcnt:33984, waitus:47569972</font></div><div><font size="2"   >pid: 21558; obj: 16384, 65765, 0, 0; objtype:1, locktype: 7, waitcnt:33973, waitus:47941600</font></div><div><font size="2"   >pid: 21560; obj: 16384, 65765, 0, 0; objtype:1, locktype: 7, waitcnt:33966, waitus:47576161</font></div><div><font size="2"   >pid: 21562; obj: 16384, 65765, 0, 0; objtype:1, locktype: 7, waitcnt:33967, waitus:47137802</font></div><div><font size="2"   >pid: 21550; obj: 16384, 65765, 0, 0; objtype:1, locktype: 7, waitcnt:33981, waitus:47695491</font></div><div><font size="2"   >pid: 21548; obj: 16384, 65765, 0, 0; objtype:1, locktype: 7, waitcnt:33971, waitus:47685924</font></div><div><font size="2"   >pid: 21555; obj: 16384, 65765, 0, 0; objtype:1, locktype: 7, waitcnt:33972, waitus:47581269</font></div><div><font size="2"   >pid: 21561; obj: 16384, 65765, 0, 0; objtype:1, locktype: 7, waitcnt:33981, waitus:47614633</font></div><div><font size="2"   >pid: 21557; obj: 16384, 65765, 0, 0; objtype:1, locktype: 7, waitcnt:33971, waitus:47644666</font></div><div><font size="2"   >pid: 21559; obj: 16384, 65765, 0, 0; objtype:1, locktype: 7, waitcnt:33986, waitus:47157181</font></div><div><font size="2"   >pid: 21563; obj: 16384, 65765, 0, 0; objtype:1, locktype: 7, waitcnt:33977, waitus:47592679</font></div><p></p></pre></div><div><div>显然PostgreSQL 扩展main fork时. 每次仅仅申请1个块(8KB).</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select 33978*8/1024;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 265</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div><br></div><div>锁对象类型和锁类型如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >LOCKTAG_RELATION_EXTEND, &nbsp; &nbsp; &nbsp; &nbsp;/* the right to extend a relation */</font></div><div><font size="2"   >#define ExclusiveLock &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 7 &nbsp; &nbsp;</font></div><p></p></pre></div><div>参考 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201391674922879/"   >http://blog.163.com/digoal@126/blog/static/163877040201391674922879/</a></div></div><div><br></div><div>我们保留最后一行, 把前面的数据使用delete删除掉, 可以达到类似初始化的目的. 避免main fork 扩展.&nbsp;</div><div>然后测试一下性能 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select 2168900*8/1024/1024||'GB';</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;16GB</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select max(ctid) from t;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;max &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp;(2168900,16)</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# delete from t where ctid&lt;&gt;'(2168900,16)';</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# vacuum (freeze,verbose,analyze) t;</font></div><div><font size="2"   >WARNING: &nbsp;pgstat wait timeout</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "postgres.t"</font></div><div><font size="2"   >INFO: &nbsp;scanned index "idx_t_id" to remove 39039999 row versions</font></div><div><font size="2"   >DETAIL: &nbsp;CPU 0.41s/23.03u sec elapsed 24.84 sec.</font></div><div><font size="2"   >INFO: &nbsp;"t": removed 39039999 row versions in 2168901 pages</font></div><div><font size="2"   >DETAIL: &nbsp;CPU 15.37s/7.40u sec elapsed 180.92 sec.</font></div><div><font size="2"   >INFO: &nbsp;index "idx_t_id" now contains 1 row versions in 135228 pages</font></div><div><font size="2"   >DETAIL: &nbsp;39039999 index row versions were removed.</font></div><div><font size="2"   >134262 index pages have been deleted, 0 are currently reusable.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;"t": found 39039999 removable, 1 nonremovable row versions in 2168901 out of 2168901 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 31.58s/41.81u sec elapsed 337.35 sec.</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "pg_toast.pg_toast_65765"</font></div><div><font size="2"   >INFO: &nbsp;index "pg_toast_65765_index" now contains 0 row versions in 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 index row versions were removed.</font></div><div><font size="2"   >0 index pages have been deleted, 0 are currently reusable.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;"pg_toast_65765": found 0 removable, 0 nonremovable row versions in 0 out of 0 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;analyzing "postgres.t"</font></div><div><font size="2"   >INFO: &nbsp;"t": scanned 30000 of 2168901 pages, containing 0 live rows and 0 dead rows; 0 rows in sample, 1 estimated total rows</font></div><div><font size="2"   >VACUUM</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# \dt+ t</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp; Schema &nbsp;| Name | Type &nbsp;| &nbsp;Owner &nbsp; | Size &nbsp;| Description&nbsp;</font></div><div><font size="2"   >----------+------+-------+----------+-------+-------------</font></div><div><font size="2"   >&nbsp;postgres | t &nbsp; &nbsp;| table | postgres | 17 GB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -t 4</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >number of transactions per client: 4</font></div><div><font size="2"   >number of transactions actually processed: 64/64</font></div><div><font size="2"   >tps = 0.750399 (including connections establishing)</font></div><div><font size="2"   >tps = 0.750523 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 20898.632172 &nbsp; &nbsp;copy t from '/home/pg93/t.dmp' with (header off);</font></div><p></p></pre></div><div>在没有main fork extend的情况下(有少量的index main fork extend).</div><div><span style="line-height: 28px;"   >每秒约导入188MB 或 45.77万条记录.</span></div><div><br></div><div>将硬盘更换为ocz REVOdrive3 240G pci-e 速度再次提升 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 8 -j 4 -t 4</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >number of transactions per client: 4</font></div><div><font size="2"   >number of transactions actually processed: 32/32</font></div><div><font size="2"   >tps = 0.891562 (including connections establishing)</font></div><div><font size="2"   >tps = 0.891753 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 8830.211750 &nbsp; &nbsp; copy t from '/home/pg93/t.dmp' with (header off);</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >每秒约导入236MB 或 54.3万条记录.</span></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >删除索引后, 纯粹的文本导入. 性能再次提升 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# drop index idx_t_id;</font></div><div><span style="line-height: 28px;"   ><font size="2"   ><div>pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 8 -j 4 -t 4</div><div>transaction type: Custom query</div><div>scaling factor: 1</div><div>query mode: prepared</div><div>number of clients: 8</div><div>number of threads: 4</div><div>number of transactions per client: 4</div><div>number of transactions actually processed: 32/32</div><div>tps = 1.077338 (including connections establishing)</div><div>tps = 1.077610 (excluding connections establishing)</div><div>statement latencies in milliseconds:</div><div>&nbsp; &nbsp; &nbsp; &nbsp; 7243.755187 &nbsp; &nbsp; copy t from '/home/pg93/t.dmp' with (header off);</div></font></span></div><p></p></pre></div><div><span style="line-height: 28px;"   >每秒约导入285.5MB 或 65.7万条记录.</span></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >同样场景下, 接下来要做的是将blocksize调成最大(即32KB), wal block也调整成最大(64KB), 并且不初始化表的情况下来压一下, 看看性能有多少提升. 理论上会有一定的提升.</span></div><div><span style="line-height: 28px;"   >对比</span><span style="line-height: 28px;"   >每秒约导入106MB 或 25.8万条记录, 这个测试结果.</span></div><div><span style="line-height: 28px;"   >&nbsp;场景中除了wal和block块大小不一样其他都一样.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >./configure --prefix=/home/pg931/pgsql9.3.1 --with-pgport=1922 --with-perl --with-tcl --with-python --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=64 --with-blocksize=32 --enable-dtrace --enable-debug</font></div><div><font size="2"   ><br></font></div><div><span style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 ssd1]# mkdir -p /ssd1/pg931/pg_root</font></span></div><div><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 ssd1]# mkdir -p /ssd2/pg931/pg_xlog</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 ssd1]# mkdir -p /ssd3/pg931/tbs_digoal</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 ssd1]# mkdir -p /ssd4/pg931/tbs_digoal_idx</font></div><div><font size="2"   >[root@db-172-16-3-150 postgresql-9.3.1]# chown -R pg931:pg931 /ssd*/pg931</font></div></div><div><font size="2"   ><br></font></div><div><span style="line-height: 28px;"   ><font size="2"   ><div>[root@db-172-16-3-150 postgresql-9.3.1]# su - pg931</div><div>pg931@db-172-16-3-150-&gt; initdb -D $PGDATA -E UTF8 --locale=C -U postgres -W -X /ssd2/pg931/pg_xlog</div><div><div>[root@db-172-16-3-150 postgresql-9.3.1]# cp /ssd1/pg93/pg_root/postgresql.conf /ssd1/pg931/pg_root/</div><div>cp: overwrite `/ssd1/pg931/pg_root/postgresql.conf'? y</div><div>[root@db-172-16-3-150 postgresql-9.3.1]# cp /ssd1/pg93/pg_root/pg_hba.conf /ssd1/pg931/pg_root/</div><div>cp: overwrite `/ssd1/pg931/pg_root/pg_hba.conf'? y</div></div></font></span></div><div><font size="2"   >chown -R pg931:pg931 /ssd1/pg931</font></div><div><font size="2"   >vi postgresql.conf</font></div><div><font size="2"   >port = 1922</font></div><div><font size="2"   >pg_ctl start</font></div><div><font size="2"   >psql</font></div><div><div><font size="2"   >postgres=# create role digoal;</font></div><div><font size="2"   >CREATE ROLE</font></div><div><font size="2"   >postgres=# create tablespace tbs_digoal location '/ssd3/pg931/tbs_digoal';</font></div><div><font size="2"   >CREATE TABLESPACE</font></div><div><font size="2"   >postgres=# create tablespace tbs_digoal_idx location '/ssd4/pg931/tbs_digoal_idx';</font></div><div><font size="2"   >CREATE TABLESPACE</font></div><div><font size="2"   >postgres=# create database digoal template template0 encoding 'UTF8' tablespace tbs_digoal;</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# \c digoal</font></div><div><font size="2"   >You are now connected to database "digoal" as user "postgres".</font></div><div><font size="2"   >digoal=# create table t (id int, c1 text, c2 text, c3 text, c4 text, c5 text, c6 text, c7 text, c8 text, c9 text, c10 text, c11 text, c12 text, c13 timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# create index idx_t_id on t(id);</font></div><div><font size="2"   >CREATE INDEX</font></div></div><div><div><font size="2"   >digoal=# update pg_class set relpersistence='u' where relname='t';</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >digoal=# update pg_class set relpersistence='u' where relname='idx_t_id';</font></div><div><font size="2"   >UPDATE 1</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# cp /home/pg93/test.sql /home/pg93/t.dmp /home/pg931/</font></div><div><font size="2"   >chown pg931:pg931 /home/pg931/*</font></div><div><div><font size="2"   >pg931@db-172-16-3-150-&gt; vi test.sql</font></div><div><font size="2"   >copy t from '/home/pg931/t.dmp' with (header off);</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >pg931@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 8 -j 4 -t 4</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >number of transactions per client: 4</font></div><div><font size="2"   >number of transactions actually processed: 32/32</font></div><div><font size="2"   >tps = 0.799815 (including connections establishing)</font></div><div><font size="2"   >tps = 0.799973 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 9899.317000 &nbsp; &nbsp; copy t from '/home/pg931/t.dmp' with (header off);</font></div></div><p></p></pre></div><div>性能提升非常明显</div><div><span style="line-height: 28px;"   >每秒约导入212MB 或 48.8万条记录.</span></div><div>使用32KB的blocksize, 同时使用unlogged table, 并且删除索引. 导入速度还有提升 &nbsp;:&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >pg931@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 8 -j 4 -t 4<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 8<br>number of threads: 4<br>number of transactions per client: 4<br>number of transactions actually processed: 32/32<br>tps = 1.245248 (including connections establishing)<br>tps = 1.245620 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        6414.338875     copy t from '/home/pg931/t.dmp' with (header off);</span></font></div><p></p></pre></div><div><span style="line-height: 28px;"   >每秒约导入330MB 或 76万条记录.</span></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >下面使用初始化main fork, 测试</span><span style="line-height: 28px;"   >速度再次提升</span><span style="line-height: 28px;"   >&nbsp;:&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select max(ctid) from t;</font></div><div><font size="2"   >&nbsp; &nbsp; max &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------</font></div><div><font size="2"   >&nbsp;(520544,4)</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# delete from t where ctid &lt;&gt; '(520544,4)';</font></div><div><font size="2"   >DELETE 39039999</font></div></div><div><font size="2"   >digoal=# vacuum (analyze,verbose) t;</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >pg931@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 8 -j 4 -t 4</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >number of transactions per client: 4</font></div><div><font size="2"   >number of transactions actually processed: 32/32</font></div><div><font size="2"   >tps = 1.384007 (including connections establishing)</font></div><div><font size="2"   >tps = 1.384453 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 5759.885594 &nbsp; &nbsp; copy t from '/home/pg931/t.dmp' with (header off);</font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   >每秒约导入367MB 或 84.4万条记录.</span></div><div><span style="line-height: 28px;"   >除此之外还有可以提升的方面是CPU核数以及CPU 频率. 有条件的朋友也可以自己测试一下.</span></div><div><span style="line-height: 28px;"   >以下是一台32核的机器测试的结果 :&nbsp;</span></div><div><span style="line-height: 28px;"   >CPU</span></div><div>Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; X7560 &nbsp;@ 2.27GHz</div><div>内存: 32GB</div><div><div><pre class="prettyprint"   ><p style="line-height: 28px;"   ></p><div style="line-height: 28px;"   ><font size="2"   >pg93@db-192-168-100-34-&gt; ll</font></div><div style="line-height: 28px;"   ><font size="2"   >-rw-r--r-- 1 pg93 pg93 205M Oct 28 13:49 t.dmp</font></div><div style="line-height: 28px;"   ><font size="2"   >-rw-rw-r-- 1 pg93 pg93 &nbsp; 48 Oct 28 12:32 test.sql</font></div><div style="line-height: 28px;"   ><div><font size="2"   >pg93@db-192-168-100-34-&gt; wc -l t.dmp&nbsp;</font></div><div><font size="2"   >500000 t.dmp</font></div></div><div><font size="2"   ><span style="line-height: 21px;"   >pg93@db-192-168-100-34-&gt; pgbench -M prepared -n -r -f ./test.sql -c 32 -j 32 -t 2<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 32<br>number of threads: 32<br>number of transactions per client: 2<br>number of transactions actually processed: 64/64<br>tps = 5.352594 (including connections establishing)<br>tps = 5.358381 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        5918.995641     copy t from '/dev/shm/t.dmp' with (header off);</span></font></div><p style="line-height: 28px;"   ></p></pre></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >每秒约导入1097.3MB 或 267.6 万条记录(平均每条记录455字节).&nbsp;</span></div></div><div><br></div><div><span style="line-height: 28px;"   >[小结]</span></div><div>对于大数据量的copy导入, 性能优化的方法可以考虑以下几个方面.</div><div>1. auto analyze 调整(尽量减少或者导入阶段关闭后续再打开)</div><div>2. table blocksize(如果业务形态是以大批量导入数据为主, 可以调整到最大)</div><div>3. unlogged table, (使用unlogged table可以减少wal flush带来的负担, 注意删除fork init文件, 避免db crash后删数据. )</div><div>4. 初始化table, (这不是一个常规用法, 仅用于本文测试, 如果pg可以做到设置extended的块个数, 则可以减少waiting)</div><div>5. shared buffer, wal buffer, 加大checkpoint_segments.</div><div>6. oscache fadvise(will not need, 减少os cache占用).</div><div>7. 提高硬盘写入速度</div><div>8.&nbsp;<span style="line-height: 28px;"   >如果pg可以做到设置extended的块个数, 那么就可以</span><span style="line-height: 28px;"   >通过提高cpu核数. 提高并行度. 从而提高导入速度.</span></div><div><span style="line-height: 28px;"   >9. 或者支持异步io写入也许会有提高.</span></div><div><span style="line-height: 28px;"   >man aio_write</span></div><div><a rel="nofollow" href="http://www.wikivs.com/wiki/MySQL_vs_PostgreSQL#PostgreSQL_Synchronous_Replication"   >http://www.wikivs.com/wiki/MySQL_vs_PostgreSQL#PostgreSQL_Synchronous_Replication</a></div><div><a rel="nofollow" href="http://www.postgresql.org/docs/devel/static/libpq-async.html"   >http://www.postgresql.org/docs/devel/static/libpq-async.html</a></div><div><a rel="nofollow" href="http://grokbase.com/t/postgresql/pgsql-hackers/984pzfvztr/hackers-async-io-description"   >http://grokbase.com/t/postgresql/pgsql-hackers/984pzfvztr/hackers-async-io-description</a></div><div><a rel="nofollow" href="http://blog.sina.com.cn/s/blog_742eb90201010yul.html"   >http://blog.sina.com.cn/s/blog_742eb90201010yul.html</a></div><div><a rel="nofollow" href="http://linux.die.net/man/3/aio_write"   >http://linux.die.net/man/3/aio_write</a></div><div><br></div><div>[其他注意事项]</div><div>1. 如果要调大block_size, 需要考虑几个问题.</div><div>-- 每次checkpoint后, 第一次变更的block需要写整个page页到wal日志(这个block后续变更都是增量写的). 所以block_size调大会使得wal的产量也变大一些.</div><div>-- block_size变大后, 对shared buffer的需求也会变大, 因为shared buffer用量的最小单位是以数据块为单位的, (例如一个表有10000个8K数据块, 离散活跃数据在shared buffer中可能占用100个块, 数据块变32K后, 这个表虽然只有2500个数据块, 但是<span style="line-height: 28px;"   >离散活跃数据在shared buffer中可能还是占用100个块, 这个需求其实无形中放大了4倍</span><span style="line-height: 28px;"   >).</span></div><div>-- block_size变大后, 某些查询的效率可能受到影响, 同样因为<span style="line-height: 28px;"   >shared buffer用量的最小单位是以数据块为单位的, 对数据块个数有同样需求的场景, 无形中放大了数据块操作的成本.</span></div><div><span style="line-height: 28px;"   >-- block_size变大后, 数据块的锁冲突也会更明显, 因为存储的数据条目更多了.</span></div><div><a target="_blank" rel="nofollow" href="https://community.oracle.com/thread/687418?start=0&amp;tstart=0"   >https://community.oracle.com/thread/687418?start=0&amp;tstart=0</a></div><div><a target="_blank" rel="nofollow" href="http://www.dba-oracle.com/s_oracle_block_size.htm"   >http://www.dba-oracle.com/s_oracle_block_size.htm</a></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" href="http://blog.163.com/digoal@126/blog/static/163877040201391674922879/"   >http://blog.163.com/digoal@126/blog/static/163877040201391674922879/</a></div><div>2.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="http://postgresql.1045698.n5.nabble.com/COPY-extend-ExclusiveLock-td5587556.html"   >http://postgresql.1045698.n5.nabble.com/COPY-extend-ExclusiveLock-td5587556.html</a></div><div>3.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="http://postgresql.1045698.n5.nabble.com/Process-11812-still-waiting-for-ExclusiveLock-on-extension-of-relation-td5716947.html"   >http://postgresql.1045698.n5.nabble.com/Process-11812-still-waiting-for-ExclusiveLock-on-extension-of-relation-td5716947.html</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL bulk COPY load Bottleneck by extend lock waiting - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">renny - 2014-12-19 17:19:26</h5>
				<div>看起来德哥好想要oracle里面的那个next参数……</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 renny - 2014-12-19 17:19:26</h5>
				<div style="width:600px;"><img src="http://b.bst.126.net/common/portrait/face/preview/face1.gif"  >太了解我了</div>
			</div>
	</div>
</div>
</body>
</html>