<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 pg_upgrade improve</h2>
	<h5 id="">2013-05-20 15:38:23&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201341981648918/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p></p><div><font size="2"   >E.1.3.10.1. pg_upgrade</font></div><div><font size="2"   >Allow pg_upgrade --jobs to do parallelism (Bruce Momjian)</font></div><div><font size="2"   >This allows parallel schema dump/restore of databases, as well as parallel copy/link of data files per tablespace.</font></div><div><font size="2"   >Have pg_upgrade create unix-domain sockets in the current directory (Bruce Momjian, Tom Lane)</font></div><div><font size="2"   >This reduces the possibility that someone will accidentally connect during the upgrade.</font></div><div><font size="2"   >Have pg_upgrade --check mode properly detect the location of non-default socket directories (Bruce Momjian, Tom Lane)</font></div><div><font size="2"   >Improve performance of pg_upgrade for databases with many tables (Bruce Momjian)</font></div><div><font size="2"   >Increase pg_upgrade logging content by showing executed command (?lvaro Herrera)</font></div><div><font size="2"   >Improve pg_upgrade's status display during copy/link (Bruce Momjian)</font></div><p></p></pre></div><div><br></div><div>pg_upgrade使用介绍 :&nbsp;</div><div>测试环境 :&nbsp;</div><div>CentOS 5.x 64bit</div><div>PostgreSQL 9.0 beta2</div><div>postgis</div><div>升级到 PostgreSQL 9.3 beta1</div><div><br></div><div><div><br></div><div>一. 安装PostgreSQL 9.0 beta2测试环境.</div><div>[root@db-172-16-3-33 soft_bak]# useradd uptest</div><div>su - uptest</div><div>vi .bash_profile</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># add by digoal</font></div><div><font size="2"   >export PS1="$USER@`/bin/hostname -s`-&gt; "</font></div><div><font size="2"   >export PGPORT=1099</font></div><div><font size="2"   >export PGDATA=/pgdata1099</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/opt/pgsql9.0beta2</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"   >export PGUSER=postgres</font></div><div><font size="2"   >export PGHOST=$PGDATA</font></div><div><font size="2"   >alias rm='rm -i'</font></div><div><font size="2"   >alias ll='ls -lh'</font></div><p></p></pre></div><div><br></div><div>vi /etc/sysctl.conf</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># add by digoal</font></div><div><font size="2"   ># Controls the maximum size of a message, in bytes</font></div><div><font size="2"   >kernel.msgmnb = 65536</font></div><div><font size="2"   ># Controls the default maxmimum size of a mesage queue</font></div><div><font size="2"   >kernel.msgmax = 65536</font></div><div><font size="2"   ># Controls the maximum shared segment size, in bytes</font></div><div><font size="2"   >kernel.shmmax = 68719476736</font></div><div><font size="2"   ># Controls the maximum number of shared memory segments, in pages</font></div><div><font size="2"   >kernel.shmall = 4294967296</font></div><div><font size="2"   >kernel.shmmni = 4096</font></div><div><font size="2"   >kernel.sem = 50100 64128000 50100 1280</font></div><div><font size="2"   >fs.file-max = 7672460</font></div><div><font size="2"   >net.ipv4.ip_local_port_range = 9000 65000</font></div><div><font size="2"   >net.core.rmem_default = 1048576</font></div><div><font size="2"   >net.core.rmem_max = 4194304</font></div><div><font size="2"   >net.core.wmem_default = 262144</font></div><div><font size="2"   >net.core.wmem_max = 1048576</font></div><div><font size="2"   >net.ipv4.tcp_tw_recycle = 1</font></div><div><font size="2"   >net.ipv4.tcp_max_syn_backlog = 4096</font></div><div><font size="2"   >net.core.netdev_max_backlog = 10000</font></div><div><font size="2"   >net.ipv4.ip_conntrack_max = 655360</font></div><div><font size="2"   >fs.aio-max-nr = 1048576</font></div><div><font size="2"   >net.ipv4.tcp_timestamps = 0</font></div><div><font size="2"   >vm.overcommit_memory = 0</font></div><p></p></pre></div><div><br></div><div>sysctl -p</div><div><br></div><div>vi /etc/security/limits.conf</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >* soft &nbsp; &nbsp;nofile &nbsp;131072</font></div><div><font size="2"   >* hard &nbsp; &nbsp;nofile &nbsp;131072</font></div><div><font size="2"   >* soft &nbsp; &nbsp;nproc &nbsp; 131072</font></div><div><font size="2"   >* hard &nbsp; &nbsp;nproc &nbsp; 131072</font></div><div><font size="2"   >* soft &nbsp; &nbsp;core &nbsp; &nbsp;unlimited</font></div><div><font size="2"   >* hard &nbsp; &nbsp;core &nbsp; &nbsp;unlimited</font></div><div><font size="2"   >* soft &nbsp; &nbsp;memlock 50000000</font></div><div><font size="2"   >* hard &nbsp; &nbsp;memlock 50000000</font></div><p></p></pre></div><div><br></div><div>[root@db-172-16-3-33 soft_bak]# cd flex-2.5.35</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >./configure</font></div><div><font size="2"   >make</font></div><div><font size="2"   >make install</font></div><p></p></pre></div><div><br></div><div>[root@db-172-16-3-33 soft_bak]# tar -jxvf postgresql-9.0beta2.tar.bz2</div><div>[root@db-172-16-3-33 soft_bak]# cd postgresql-9.0beta2</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >./configure --prefix=/opt/pgsql9.0beta2 --with-pgport=1099 --with-segsize=8 --with-wal-segsize=64 --with-wal-blocksize=64 --with-perl --with-python --with-openssl --with-pam --with-ldap --with-libxml --with-libxslt --enable-thread-safety</font></div><div><font size="2"   >gmake world</font></div><div><font size="2"   >gmake install-world</font></div><p></p></pre></div><div><br></div><div>初始化数据库 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 postgresql-9.0beta2]# mkdir /pgdata1099</font></div><div><font size="2"   >[root@db-172-16-3-33 postgresql-9.0beta2]# chown uptest:uptest /pgdata1099</font></div><div><font size="2"   >[root@db-172-16-3-33 postgresql-9.0beta2]# su - uptest</font></div><div><font size="2"   >uptest@db-172-16-3-33-&gt; initdb -D $PGDATA -E UTF8 --locale=C -W -U postgres</font></div><p></p></pre></div><div><br></div><div>配置postgresql.conf</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"   >port = 1099 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >max_connections = 100 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >superuser_reserved_connections = 13 &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_directory = '.' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_permissions = 0700 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# begin with 0 to use octal notation</font></div><div><font size="2"   >shared_buffers = 1024MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div><font size="2"   >max_stack_depth = 8MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 100kB</font></div><div><font size="2"   >shared_preload_libraries = 'pg_stat_statements' &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >wal_level = hot_standby &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, or hot_standby</font></div><div><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# immediate fsync at commit</font></div><div><font size="2"   >wal_sync_method = fsync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # the default is the first option&nbsp;</font></div><div><font size="2"   >full_page_writes = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # recover from partial page writes</font></div><div><font size="2"   >wal_buffers = 16384kB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 32kB</font></div><div><font size="2"   >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"   >checkpoint_segments = 128 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # in logfile segments, min 1, 16MB each</font></div><div><font size="2"   >archive_mode = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # allows archiving to be done</font></div><div><font size="2"   >archive_command = '/bin/date' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # command to use to archive a logfile segment</font></div><div><font size="2"   >hot_standby = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# allows queries during recovery</font></div><div><font size="2"   >max_wal_senders = 16 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of walsender processes</font></div><div><font size="2"   >wal_sender_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"   >wal_keep_segments = 256 &nbsp; &nbsp; &nbsp; &nbsp; # in logfile segments, 16MB each; 0 disables</font></div><div><font size="2"   >random_page_cost = 2.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# same scale as above</font></div><div><font size="2"   >effective_cache_size = 8192MB</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_directory = 'pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,</font></div><div><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file of the</font></div><div><font size="2"   >log_rotation_age = 1d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Automatic rotation of logfiles will</font></div><div><font size="2"   >log_rotation_size = 10MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Automatic rotation of logfiles will&nbsp;</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_disconnections = on</font></div><div><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div><font size="2"   >log_lock_waits = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # log lock waits &gt;= deadlock_timeout</font></div><div><font size="2"   >log_statement = 'ddl' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # none, ddl, mod, all</font></div><div><font size="2"   >autovacuum = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Enable autovacuum subprocess? &nbsp;'on'&nbsp;</font></div><div><font size="2"   >log_autovacuum_min_duration = 0 &nbsp; &nbsp; &nbsp; &nbsp; # -1 disables, 0 logs all actions and</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><div><font size="2"   >custom_variable_classes = 'pg_stat_statements'</font></div><div><font size="2"   >pg_stat_statements.max = 1000</font></div><div><font size="2"   >pg_stat_statements.track = all</font></div><p></p></pre></div><div><br></div><div>启动数据库 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >uptest@db-172-16-3-33-&gt; pg_ctl start</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >uptest@db-172-16-3-33-&gt; LOG: &nbsp;00000: loaded library "pg_stat_statements"</font></div><div><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1201</font></div><div><font size="2"   >Not safe to send CSV data</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"   >安装模块 :&nbsp;</span></div><div>pgfincore</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 soft_bak]# tar -zxvf pgfincore-v1.1.1.tar.gz</font></div><div><font size="2"   >[root@db-172-16-3-33 soft_bak]# mv pgfincore-1.1.1 postgresql-9.0beta2/contrib/</font></div><div><font size="2"   >[root@db-172-16-3-33 soft_bak]# cd postgresql-9.0beta2/contrib/pgfincore-1.1.1/</font></div><div><font size="2"   >[root@db-172-16-3-33 pgfincore-1.1.1]# export PATH=/opt/pgsql9.0beta2/bin:$PATH</font></div><div><font size="2"   >[root@db-172-16-3-33 pgfincore-1.1.1]# which pg_config</font></div><div><font size="2"   >/opt/pgsql9.0beta2/bin/pg_config</font></div><div><font size="2"   >[root@db-172-16-3-33 pgfincore-1.1.1]# gmake clean</font></div><div><font size="2"   >[root@db-172-16-3-33 pgfincore-1.1.1]# gmake</font></div><div><font size="2"   >[root@db-172-16-3-33 pgfincore-1.1.1]# gmake install</font></div><div><font size="2"   >uptest@db-172-16-3-33-&gt; psql -f /opt/pgsql9.0beta2/share/contrib/pgfincore.sql&nbsp;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><p></p></pre></div><div><br></div><div>pg_stat_statements</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >uptest@db-172-16-3-33-&gt; psql&nbsp;</font></div><div><font size="2"   >psql (9.0beta2)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# \q</font></div><div><font size="2"   >uptest@db-172-16-3-33-&gt; psql -f /opt/pgsql9.0beta2/share/contrib/pg_stat_statements.sql&nbsp;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE VIEW</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >REVOKE</font></div><p></p></pre></div><div><br></div><div>postgis</div><div>安装参考 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012513055140/"   >http://blog.163.com/digoal@126/blog/static/1638770402012513055140/</a></div><div>下载安装包 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >http://download.osgeo.org/gdal/1.10.0/gdal-1.10.0.tar.gz</font></div><div><font size="2"   >http://download.osgeo.org/geos/geos-3.3.8.tar.bz2</font></div><div><font size="2"   >http://download.osgeo.org/proj/proj-4.8.0.tar.gz</font></div><div><font size="2"   >https://github.com/json-c/json-c</font></div><div><font size="2"   >http://download.osgeo.org/postgis/source/postgis-2.0.3.tar.gz</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >tar -zxvf gdal-1.10.0.tar.gz</font></div><div><font size="2"   >cd gdal-1.10.0</font></div><div><font size="2"   >./configure --prefix=/opt/gdal-1.10.0</font></div><div><font size="2"   >make</font></div><div><font size="2"   >make install</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >tar -jxvf geos-3.3.8.tar.bz2</font></div><div><font size="2"   >cd geos-3.3.8</font></div><div><font size="2"   >./configure --prefix=/opt/geos-3.3.8</font></div><div><font size="2"   >make</font></div><div><font size="2"   >make install</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >tar -zxvf proj-4.8.0.tar.gz</font></div><div><font size="2"   >cd proj-4.8.0</font></div><div><font size="2"   >./configure --prefix=/opt/proj-4.8.0</font></div><div><font size="2"   >make</font></div><div><font size="2"   >make install</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >tar -zxvf unzip json-c-master.zip</font></div><div><font size="2"   >cd json-c-master</font></div><div><font size="2"   >./autogen.sh</font></div><div><font size="2"   >./configure --prefix=/opt/json-c-git20130520</font></div><div><font size="2"   >make</font></div><div><font size="2"   >make install</font></div><div><font size="2"   >使用, add to Makefile</font></div><div><font size="2"   >JSON_C_DIR=/opt/json-c-git20130520</font></div><div><font size="2"   >CFLAGS += -I$(JSON_C_DIR)/include/json-c</font></div><div><font size="2"   >LDFLAGS+= -L$(JSON_C_DIR)/lib -ljson-c</font></div><p></p></pre></div><div><br></div><div>su - uptest</div><div>vi .bash_profile</div><div><pre class="prettyprint"   ><p><font size="2"   >export LD_LIBRARY_PATH=/opt/gdal-1.10.0/lib:/opt/geos-3.3.8/lib:/opt/json-c-git20130520/lib:/opt/proj-4.8.0/lib:$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH</font></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >tar -zxvf postgis-2.0.3.tar.gz</font></div><div><font size="2"   >cd postgis-2.0.3</font></div><div><font size="2"   >./configure --prefix=/opt/postgis-2.0.3 --with-pgconfig=/opt/pgsql9.0beta2/bin/pg_config --with-gdalconfig=/opt/gdal-1.10.0/bin/gdal-config --with-geosconfig=/opt/geos-3.3.8/bin/geos-config --with-xml2config=/usr/bin/xml2-config --with-projdir=/opt/proj-4.8.0 --with-libiconv=/usr/bin --with-jsondir=/opt/json-c-git20130520 --with-gui --with-raster --with-topology --with-gettext=no</font></div><div><font size="2"   >gmake</font></div><div><font size="2"   >gmake install</font></div><p></p></pre></div><div>重启数据库.</div><div>pg_ctl restart -m fast</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >psql -f /opt/pgsql9.0beta2/share/contrib/postgis-2.0/postgis.sql&nbsp;</font></div><div><font size="2"   >psql -f /opt/pgsql9.0beta2/share/contrib/postgis-2.0/spatial_ref_sys.sql&nbsp;</font></div><div><font size="2"   >psql -f /opt/pgsql9.0beta2/share/contrib/postgis-2.0/postgis_comments.sql&nbsp;</font></div><div><font size="2"   >psql -f /opt/pgsql9.0beta2/share/contrib/postgis-2.0/rtpostgis.sql&nbsp;</font></div><div><font size="2"   >psql -f /opt/pgsql9.0beta2/share/contrib/postgis-2.0/raster_comments.sql&nbsp;</font></div><div><font size="2"   >psql -f /opt/pgsql9.0beta2/share/contrib/postgis-2.0/topology.sql&nbsp;</font></div><div><font size="2"   >psql -f /opt/pgsql9.0beta2/share/contrib/postgis-2.0/topology_comments.sql&nbsp;</font></div><div><font size="2"   >psql -f /opt/pgsql9.0beta2/share/contrib/postgis-2.0/legacy.sql</font></div><p></p></pre></div><div><br></div><div>测试数据 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >uptest@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.0beta2)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# create table test (id int primary key, info text);;</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "test_pkey" for table "test"</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# insert into test select generate_series(1,10000);</font></div><div><font size="2"   >INSERT 0 10000</font></div><p></p></pre></div><div><br></div><div>二. 升级准备 :&nbsp;</div><div>1. 检查老版本configure选项</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >uptest@db-172-16-3-33-&gt; pg_config --pkgincludedir</font></div><div><font size="2"   >/opt/pgsql9.0beta2/include</font></div><div><font size="2"   >uptest@db-172-16-3-33-&gt; pg_config --cflags</font></div><div><font size="2"   >-O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -fno-strict-aliasing -fwrapv</font></div><div><font size="2"   >uptest@db-172-16-3-33-&gt; pg_config --cflags_sl</font></div><div><font size="2"   >-fpic</font></div><div><font size="2"   >uptest@db-172-16-3-33-&gt; pg_config --ldflags</font></div><div><font size="2"   >-Wl,-rpath,'/opt/pgsql9.0beta2/lib',--enable-new-dtags</font></div><div><font size="2"   >uptest@db-172-16-3-33-&gt; pg_config --libs</font></div><div><font size="2"   >-lpgport -lxslt -lxml2 -lpam -lssl -lcrypto -lz -lreadline -ltermcap -lcrypt -ldl -lm&nbsp;</font></div><div><font size="2"   >uptest@db-172-16-3-33-&gt; pg_config --configure</font></div><div><font size="2"   >'--prefix=/opt/pgsql9.0beta2' '--with-pgport=1099' '--with-segsize=8' '--with-wal-segsize=64' '--with-wal-blocksize=64' '--with-perl' '--with-python' '--with-openssl' '--with-pam' '--with-ldap' '--with-libxml' '--with-libxslt' '--enable-thread-safety'</font></div><p></p></pre></div><div>或者查看老版本的config.log</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 soft_bak]# cd postgresql-9.0beta2</font></div><div><font size="2"   >[root@db-172-16-3-33 postgresql-9.0beta2]# less config.log&nbsp;</font></div><div><font size="2"   >&nbsp; $ ./configure --prefix=/opt/pgsql9.0beta2 --with-pgport=1099 --with-segsize=8 --with-wal-segsize=64 --with-wal-blocksize=64 --with-perl --with-python --with-openssl --with-pam --with-ldap --with-libxml --with-libxslt --enable-thread-safety</font></div><p></p></pre></div><div><br></div><div>2. 检查老版本initdb选项</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >uptest@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.0beta2)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# \l+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of databases</font></div><div><font size="2"   >&nbsp; &nbsp;Name &nbsp; &nbsp;| &nbsp;Owner &nbsp; | Encoding | Collation | Ctype | &nbsp; Access privileges &nbsp; | &nbsp;Size &nbsp; | Tablespace | &nbsp; &nbsp; &nbsp; &nbsp;Description &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------+----------+----------+-----------+-------+-----------------------+---------+------------+---------------------------</font></div><div><font size="2"   >&nbsp;postgres &nbsp;| postgres | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 11 MB &nbsp; | pg_default |&nbsp;</font></div><div><font size="2"   >&nbsp;template0 | postgres | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | =c/postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+| 5273 kB | pg_default |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | postgres=CTc/postgres | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;template1 | postgres | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | =c/postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+| 5273 kB | pg_default | default template database</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | postgres=CTc/postgres | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div><div><br></div><div>3. 根据老版本的configure选项以及其他环境变量编译postgresql 9.3beta1</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >wget http://ftp.postgresql.org/pub/source/v9.3beta1/postgresql-9.3beta1.tar.bz2</font></div><div><font size="2"   >tar -jxvf postgresql-9.3beta1.tar.bz2</font></div><div><font size="2"   >cd postgresql-9.3beta1</font></div><p></p></pre></div><div>注意端口不要和老版本重复.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >./configure --prefix=/opt/pgsql9.3beta1 --with-pgport=2099 --with-segsize=8 --with-wal-segsize=64 --with-wal-blocksize=64 --with-perl --with-python --with-openssl --with-pam --with-ldap --with-libxml --with-libxslt --enable-thread-safety</font></div><div><font size="2"   >gmake world</font></div><div><font size="2"   >gmake install-world</font></div><p></p></pre></div><div><br></div><div>4. 初始化数据库集群</div><div><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 postgresql-9.3beta1]# cd /</font></div><div><font size="2"   >[root@db-172-16-3-33 /]# mkdir pgdata2099</font></div><div><font size="2"   >[root@db-172-16-3-33 /]# chown -R uptest:uptest pgdata2099</font></div><div><font size="2"   >[root@db-172-16-3-33 /]# su - uptest</font></div><div><font size="2"   >uptest@db-172-16-3-33-&gt; LD_LIBRARY_PATH=/opt/pgsql9.3beta1/lib /opt/pgsql9.3beta1/bin/initdb -D /pgdata2099 -E UTF8 --locale=C -U postgres -W</font></div><p></p></pre></div><p></p></div><div>配置postgresql.conf, 注意端口不要和老的重复.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"   >port = 2099 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >max_connections = 100 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >superuser_reserved_connections = 13 &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_directories = '.' &nbsp; # comma-separated list of directories</font></div><div><font size="2"   >unix_socket_permissions = 0700 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# begin with 0 to use octal notation</font></div><div><font size="2"   >shared_buffers = 1024MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div><font size="2"   >maintenance_work_mem = 1024MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 1MB</font></div><div><font size="2"   >max_stack_depth = 8MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 100kB</font></div><div><font size="2"   >shared_preload_libraries = 'pg_stat_statements' &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >wal_level = hot_standby &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, or hot_standby</font></div><div><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level;</font></div><div><font size="2"   >wal_sync_method = fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # the default is the first option</font></div><div><font size="2"   >wal_buffers = 16384kB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 32kB, -1 sets based on shared_buffers</font></div><div><font size="2"   >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"   >checkpoint_segments = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# in logfile segments, min 1, 16MB each</font></div><div><font size="2"   >archive_mode = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # allows archiving to be done</font></div><div><font size="2"   >archive_command = '/bin/date' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # command to use to archive a logfile segment</font></div><div><font size="2"   >max_wal_senders = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of walsender processes</font></div><div><font size="2"   >wal_keep_segments = 128 &nbsp; &nbsp; &nbsp; &nbsp; # in logfile segments, 16MB each; 0 disables</font></div><div><font size="2"   >hot_standby = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# "on" allows queries during recovery</font></div><div><font size="2"   >wal_receiver_status_interval = 1s &nbsp; &nbsp; &nbsp; # send replies at least this often</font></div><div><font size="2"   >hot_standby_feedback = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # send info from standby to prevent</font></div><div><font size="2"   >random_page_cost = 2.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# same scale as above</font></div><div><font size="2"   >effective_cache_size = 8192MB</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_directory = 'pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,</font></div><div><font size="2"   >log_file_mode = 0600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# creation mode for log files,</font></div><div><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div><font size="2"   >log_rotation_age = 1d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Automatic rotation of logfiles will</font></div><div><font size="2"   >log_rotation_size = 10MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Automatic rotation of logfiles will</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_disconnections = on</font></div><div><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div><font size="2"   >log_timezone = 'PRC'</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >timezone = 'PRC'</font></div><div><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><div><font size="2"   >pg_stat_statements.max = 1000</font></div><div><font size="2"   >pg_stat_statements.track = all</font></div><p></p></pre></div><div><br></div><div>5. 启动新集群</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >uptest@db-172-16-3-33-&gt; LD_LIBRARY_PATH=/opt/pgsql9.3beta1/lib /opt/pgsql9.3beta1/bin/pg_ctl start -D /pgdata2099</font></div><div><font size="2"   >server starting</font></div><p></p></pre></div><div><br></div><div>6. 安装老版本上一致的加载模块的so动态链接库. 本例 : pgfincore, postgis, pg_stat_statements(自带)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 /]# cd /opt/soft_bak/</font></div><div><font size="2"   >[root@db-172-16-3-33 soft_bak]# tar -zxvf pgfincore-v1.1.1.tar.gz</font></div><div><font size="2"   >[root@db-172-16-3-33 soft_bak]# mv pgfincore-1.1.1 postgresql-9.3beta1/contrib/</font></div><div><font size="2"   >[root@db-172-16-3-33 soft_bak]# cd postgresql-9.3beta1/contrib/pgfincore-1.1.1/</font></div><div><font size="2"   >[root@db-172-16-3-33 pgfincore-1.1.1]# export PATH=/opt/pgsql9.3beta1/bin:$PATH</font></div><div><font size="2"   >[root@db-172-16-3-33 pgfincore-1.1.1]# which pg_config</font></div><div><font size="2"   >/opt/pgsql9.3beta1/bin/pg_config</font></div><div><font size="2"   ># 确保当前是postgresq9.3beta1的pg_config</font></div><div><font size="2"   >[root@db-172-16-3-33 pgfincore-1.1.1]# gmake clean</font></div><div><font size="2"   >[root@db-172-16-3-33 pgfincore-1.1.1]# gmake</font></div><div><font size="2"   >[root@db-172-16-3-33 pgfincore-1.1.1]# gmake install</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 soft_bak]# cd /opt/soft_bak/</font></div><div><font size="2"   >[root@db-172-16-3-33 soft_bak]# mv postgis-2.0.3 postgis-2.0.3_for_9.0beta2</font></div><div><font size="2"   >[root@db-172-16-3-33 soft_bak]# tar -zxvf postgis-2.0.3.tar.gz</font></div><div><font size="2"   >[root@db-172-16-3-33 pgfincore-1.1.1]# export PATH=/opt/pgsql9.3beta1/bin:$PATH</font></div><div><font size="2"   >[root@db-172-16-3-33 pgfincore-1.1.1]# which pg_config</font></div><div><font size="2"   >/opt/pgsql9.3beta1/bin/pg_config</font></div><div><font size="2"   ># 确保当前是postgresq9.3beta1的pg_config</font></div><div><font size="2"   >[root@db-172-16-3-33 postgis-2.0.3]# cd /opt/soft_bak/postgis-2.0.3</font></div><div><font size="2"   ># 注意修改pgsql路径,postgis路径.</font></div><div><font size="2"   >./configure --prefix=/opt/postgis-2.0.3-for9.3 --with-pgconfig=/opt/pgsql9.3beta1/bin/pg_config --with-gdalconfig=/opt/gdal-1.10.0/bin/gdal-config --with-geosconfig=/opt/geos-3.3.8/bin/geos-config --with-xml2config=/usr/bin/xml2-config --with-projdir=/opt/proj-4.8.0 --with-libiconv=/usr/bin --with-jsondir=/opt/json-c-git20130520 --with-gui --with-raster --with-topology --with-gettext=no</font></div><div><font size="2"   >gmake</font></div><div><font size="2"   >gmake install</font></div><p></p></pre></div><div><br></div><div>7. 调整新老版本数据库本地无密码认证</div><div>cd /pgdata1099</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi pg_hba.conf</font></div><div><font size="2"   ># "local" is for Unix domain socket connections only</font></div><div><font size="2"   >local &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trust</font></div><div><font size="2"   ># IPv4 local connections:</font></div><div><font size="2"   >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div><p></p></pre></div><div><br></div><div>cd /pgdata2099</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi pg_hba.conf</font></div><div><font size="2"   ># "local" is for Unix domain socket connections only</font></div><div><font size="2"   >local &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trust</font></div><div><font size="2"   ># IPv4 local connections:</font></div><div><font size="2"   >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >LD_LIBRARY_PATH=/opt/pgsql9.0beta2/lib /opt/pgsql9.0beta2/bin/pg_ctl restart -m fast -D /pgdata1099</font></div><div><font size="2"   >LD_LIBRARY_PATH=/opt/pgsql9.3beta1/lib /opt/pgsql9.3beta1/bin/pg_ctl restart -m fast -D /pgdata2099</font></div><p></p></pre></div><div><br></div><div>8. 停库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >LD_LIBRARY_PATH=/opt/pgsql9.0beta2/lib /opt/pgsql9.0beta2/bin/pg_ctl stop -m fast -D /pgdata1099</font></div><div><font size="2"   >LD_LIBRARY_PATH=/opt/pgsql9.3beta1/lib /opt/pgsql9.3beta1/bin/pg_ctl stop -m fast -D /pgdata2099</font></div><p></p></pre></div><div><br></div><div>9. 运行pg_upgrade(注意必须运行新版的pg_upgrade)</div><div>9.1 检查, 但不执行更新. pg_upgrade需要在当前目录存放日志文件, 所以当前目录要有写权限</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >mkdir upgrade_test</font></div><div><font size="2"   >cd upgrade_test</font></div><div><font size="2"   >uptest@db-172-16-3-33-&gt; LD_LIBRARY_PATH=/opt/pgsql9.3beta1/lib /opt/pgsql9.3beta1/bin/pg_upgrade -c -b /opt/pgsql9.0beta2/bin -B /opt/pgsql9.3beta1/bin -d /pgdata1099 -D /pgdata2099 -p 1099 -P 2099 -u postgres -v</font></div><p></p></pre></div><div><br></div><div>报错 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Checking for presence of required libraries &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fatal</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Your installation references loadable libraries that are missing from the</font></div><div><font size="2"   >new installation. &nbsp;You can add these libraries to the new installation,</font></div><div><font size="2"   >or remove the functions using them from the old installation. &nbsp;A list of</font></div><div><font size="2"   >problem libraries is in the file:</font></div><div><font size="2"   >&nbsp; &nbsp; loadable_libraries.txt</font></div><div><font size="2"   >Failure, exiting</font></div><div><font size="2"   >"/opt/pgsql9.3beta1/bin/pg_ctl" -w -D "/pgdata2099" -o "" -m fast stop &gt;&gt; "pg_upgrade_server.log" 2&gt;&amp;1</font></div><p></p></pre></div><div>查看导致错误的模块详细信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >uptest@db-172-16-3-33-&gt; less loadable_libraries.txt</font></div><div><font size="2"   >Could not load library "$libdir/rtpostgis-2.0"</font></div><div><font size="2"   >ERROR: &nbsp;could not load library "/opt/pgsql9.3beta1/lib/rtpostgis-2.0.so": libgdal.so.1: cannot open shared object file: No such file or directory</font></div><div><font size="2"   >Could not load library "$libdir/postgis-2.0"</font></div><div><font size="2"   >ERROR: &nbsp;could not load library "/opt/pgsql9.3beta1/lib/postgis-2.0.so": libgeos_c.so.1: cannot open shared object file: No such file or directory</font></div><p></p></pre></div><div>指定LD_LIBRARY_PATH后, 报错变了:</div><div><pre class="prettyprint"   ><p><font size="2"   >LD_LIBRARY_PATH=/opt/pgsql9.3beta1/lib:/opt/postgis-2.0.3-for9.3/lib:/opt/gdal-1.10.0/lib:/opt/geos-3.3.8/lib:/opt/json-c-git20130520/lib:/opt/proj-4.8.0/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib /opt/pgsql9.3beta1/bin/pg_upgrade -c -b /opt/pgsql9.0beta2/bin -B /opt/pgsql9.3beta1/bin -d /pgdata1099 -D /pgdata2099 -p 1099 -P 2099 -u postgres -v</font></p></pre></div><div>依旧报错 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >uptest@db-172-16-3-33-&gt; less loadable_libraries.txt&nbsp;</font></div><div><font size="2"   >Could not load library "$libdir/postgis-2.0"</font></div><div><font size="2"   >ERROR: &nbsp;could not load library "/opt/pgsql9.3beta1/lib/postgis-2.0.so": /opt/pgsql9.3beta1/lib/postgis-2.0.so: undefined symbol: GETSTRUCT</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 发现这个函数GETSTRUCT在geometry_estimate.c中调用.由于9.3修改了对应的头文件, 所以重新包含以下.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi /opt/soft_bak/postgis-2.0.3/postgis/geometry_estimate.c</font></div><div><font size="2"   >#if POSTGIS_PGSQL_VERSION &gt;= 93</font></div><div><font size="2"   >&nbsp; #include "access/htup_details.h"</font></div><div><font size="2"   >#endif</font></div><p></p></pre></div><div><div>PostgreSQL 9.3的GETSTRUCT macro定义如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >src/include/access/htup_details.h</font></div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* GETSTRUCT - given a HeapTuple pointer, return address of the user data</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >#define GETSTRUCT(TUP) ((char *) ((TUP)-&gt;t_data) + (TUP)-&gt;t_data-&gt;t_hoff)</font></div><p></p></pre></div></div><div><br></div><div>重新编译即可.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd /opt/soft_bak/postgis-2.0.3</font></div><div><font size="2"   >gmake</font></div><div><font size="2"   >gmake install</font></div><p></p></pre></div><div><br></div><div>重新执行</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >LD_LIBRARY_PATH=/opt/pgsql9.3beta1/lib:/opt/postgis-2.0.3-for9.3/lib:/opt/gdal-1.10.0/lib:/opt/geos-3.3.8/lib:/opt/json-c-git20130520/lib:/opt/proj-4.8.0/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib /opt/pgsql9.3beta1/bin/pg_upgrade -c -b /opt/pgsql9.0beta2/bin -B /opt/pgsql9.3beta1/bin -d /pgdata1099 -D /pgdata2099 -p 1099 -P 2099 -u postgres -v</font></div><div><font size="2"   >通过.</font></div><div><font size="2"   >*Clusters are compatible*</font></div><p></p></pre></div><div><br></div><div>三. 升级.</div><div>建议执行升级前, 先备份一下老版本的数据库, 表空间以及xlog. 便于回滚. 可以打开归档来备份, 减少停机时间.</div><div><br></div><div>升级把上面的-c参数去掉就可以了.&nbsp;</div><div>如果数据库巨大, 建议使用-k做硬链接, 但是$PGDATA必须在同一个文件系统中.</div><div>详见 :&nbsp;</div><div><a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201341722927382/"   >http://blog.163.com/digoal@126/blog/static/163877040201341722927382/</a></div><div><span style="line-height: 22px;"   >下面使用硬链接进行升级. 同时9.3新增了并行的功能. -j参数控制并行度.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - uptest</font></div><div><font size="2"   >LD_LIBRARY_PATH=/opt/pgsql9.3beta1/lib:/opt/postgis-2.0.3-for9.3/lib:/opt/gdal-1.10.0/lib:/opt/geos-3.3.8/lib:/opt/json-c-git20130520/lib:/opt/proj-4.8.0/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib /opt/pgsql9.3beta1/bin/pg_upgrade -b /opt/pgsql9.0beta2/bin -B /opt/pgsql9.3beta1/bin -d /pgdata1099 -D /pgdata2099 -p 1099 -P 2099 -u postgres -v -k -j 16</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Upgrade Complete</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >Optimizer statistics are not transferred by pg_upgrade so,</font></div><div><font size="2"   >once you start the new server, consider running:</font></div><div><font size="2"   >&nbsp; &nbsp; analyze_new_cluster.sh</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Running this script will delete the old cluster's data files:</font></div><div><font size="2"   >&nbsp; &nbsp; delete_old_cluster.sh</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >使用硬链接, 实际上是拷贝了inode number. 所以新老$PGDATA里面的自定义对象对应的文件(除了initdb初始化集群文件以外的文件)对应的inode number一样.</span></div><div><span style="line-height: 22px;"   >新版本集群 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >cd&nbsp;</span>/pgdata2099/base/12815</font></div><div><font size="2"   >ll -i</font></div><div><div><font size="2"   >3042182 -rw------- 2 uptest uptest &nbsp;3.2M May 20 15:57 16637</font></div><div><font size="2"   >3042187 -rw------- 2 uptest uptest &nbsp; 24K May 20 15:57 16637_fsm</font></div><div><font size="2"   >3042183 -rw------- 2 uptest uptest &nbsp; &nbsp; 0 May 20 15:55 16641</font></div><div><font size="2"   >3042184 -rw------- 2 uptest uptest &nbsp;8.0K May 20 15:55 16643</font></div><div><font size="2"   >3042185 -rw------- 2 uptest uptest &nbsp;144K May 20 15:57 16644</font></div><div><font size="2"   >3042188 -rw------- 2 uptest uptest &nbsp;8.0K May 20 15:57 17513</font></div><div><font size="2"   >3042189 -rw------- 2 uptest uptest &nbsp; &nbsp; 0 May 20 15:55 17515</font></div><div><font size="2"   >3042190 -rw------- 2 uptest uptest &nbsp; &nbsp; 0 May 20 15:55 17520</font></div><div><font size="2"   >3042191 -rw------- 2 uptest uptest &nbsp;8.0K May 20 15:55 17522</font></div><div><font size="2"   >3042192 -rw------- 2 uptest uptest &nbsp;8.0K May 20 15:55 17523</font></div><div><font size="2"   >3042193 -rw------- 2 uptest uptest &nbsp;8.0K May 20 15:55 17525</font></div><div><font size="2"   >3042194 -rw------- 2 uptest uptest &nbsp; &nbsp; 0 May 20 15:55 17528</font></div><div><font size="2"   >3042195 -rw------- 2 uptest uptest &nbsp; &nbsp; 0 May 20 15:55 17532</font></div><div><font size="2"   >3042196 -rw------- 2 uptest uptest &nbsp;8.0K May 20 15:55 17534</font></div><div><font size="2"   >3042197 -rw------- 2 uptest uptest &nbsp;8.0K May 20 15:55 17535</font></div><div><font size="2"   >3042198 -rw------- 2 uptest uptest &nbsp;8.0K May 20 15:55 17537</font></div><div><font size="2"   >3042199 -rw------- 2 uptest uptest &nbsp;360K May 20 15:57 17915</font></div><div><font size="2"   >3041504 -rw------- 2 uptest uptest &nbsp; 24K May 20 15:56 17915_fsm</font></div><div><font size="2"   >3042200 -rw------- 2 uptest uptest &nbsp; &nbsp; 0 May 20 15:56 17918</font></div><div><font size="2"   >3042201 -rw------- 2 uptest uptest &nbsp;8.0K May 20 15:56 17920</font></div><div><font size="2"   >3042202 -rw------- 2 uptest uptest &nbsp;240K May 20 15:57 17921</font></div></div><p></p></pre></div><div>老版本集群抽样 :&nbsp;</div><div>对应的inode number一致.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd&nbsp;/pgdata1099/base/11874</font></div><div><div><font size="2"   >uptest@db-172-16-3-33-&gt; ll -i 17915_fsm</font></div><div><font size="2"   >3041504 -rw------- 2 uptest uptest 24K May 20 15:56 17915_fsm</font></div></div><div><div><font size="2"   >uptest@db-172-16-3-33-&gt; stat 17915_fsm</font></div><div><font size="2"   >&nbsp; File: `17915_fsm'</font></div><div><font size="2"   >&nbsp; Size: 24576 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Blocks: 48 &nbsp; &nbsp; &nbsp; &nbsp; IO Block: 4096 &nbsp; regular file</font></div><div><font size="2"   >Device: 6801h/26625d &nbsp; &nbsp;Inode: 3041504 &nbsp; &nbsp; Links: 2</font></div><div><font size="2"   >Access: (0600/-rw-------) &nbsp;Uid: ( &nbsp;512/ &nbsp;uptest) &nbsp; Gid: ( &nbsp;512/ &nbsp;uptest)</font></div><div><font size="2"   >Access: 2013-05-20 15:56:06.000000000 +0800</font></div><div><font size="2"   >Modify: 2013-05-20 15:56:06.000000000 +0800</font></div><div><font size="2"   >Change: 2013-05-20 15:58:39.000000000 +0800</font></div></div><p></p></pre></div><div>link数为2.</div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >最后执行这两个脚本 :&nbsp;</span></div><div>因为pg_upgrade启动时的监听指定了当前目录, 所以要加两个变量.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >uptest@db-172-16-3-33-&gt; </span>PGHOST=/home/uptest/upgrade_test PGPORT=2099 ./analyze_new_cluster.sh</font></div><div><div><font size="2"   ><span style="line-height: 19px;"   >uptest@db-172-16-3-33-&gt; </span>PGHOST=/home/uptest/upgrade_test PGPORT=2099 ./delete_old_cluster.sh&nbsp;</font></div><div><font size="2"   >rm: cannot remove directory `/pgdata1099': Permission denied</font></div></div><p></p></pre></div><div>无法删除因为放在根目录.</div><div><br></div><div>最后, 修改uptest用户的环境变量, 重启数据库.</div><div>vi /home/uptest/.bash_profile</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># add by digoal</font></div><div><font size="2"   >export PS1="$USER@`/bin/hostname -s`-&gt; "</font></div><div><font size="2"   >export PGPORT=2099</font></div><div><font size="2"   >export PGDATA=/pgdata2099</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/opt/pgsql9.3beta1</font></div><div><font size="2"   >export LD_LIBRARY_PATH=/opt/gdal-1.10.0/lib:/opt/geos-3.3.8/lib:/opt/json-c-git20130520/lib:/opt/proj-4.8.0/lib:$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"   >export PGUSER=postgres</font></div><div><font size="2"   >export PGHOST=$PGDATA</font></div><div><font size="2"   >alias rm='rm -i'</font></div><div><font size="2"   >alias ll='ls -lh'</font></div><p></p></pre></div><div>重启数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - uptest</font></div><div><font size="2"   >pg_ctl stop -m fast</font></div><div><font size="2"   >pg_ctl start</font></div><p></p></pre></div><div><br></div><div>四. 其他</div><div>1. 安装postgis for postgresql 9.0beta2时遇到问题 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >lwgeom_accum.c:316:66: error: macro "InitFunctionCallInfoData" passed 6 arguments, but takes just 5</font></div><div><font size="2"   >lwgeom_accum.c: In function ‘PGISDirectFunctionCall1’:</font></div><div><font size="2"   >lwgeom_accum.c:316: error: ‘InitFunctionCallInfoData’ undeclared (first use in this function)</font></div><div><font size="2"   >lwgeom_accum.c:316: error: (Each undeclared identifier is reported only once</font></div><div><font size="2"   >lwgeom_accum.c:316: error: for each function it appears in.)</font></div><div><font size="2"   >gmake[1]: *** [lwgeom_accum.o] Error 1</font></div><div><font size="2"   >gmake[1]: Leaving directory `/opt/soft_bak/postgis-2.0.3/postgis'</font></div><div><font size="2"   >gmake: *** [all] Error 1</font></div><p></p></pre></div><div>解决 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi configure</font></div><div><font size="2"   >修改如下, 改成当前版本 :&nbsp;</font></div><div><font size="2"   >#POSTGIS_PGSQL_VERSION="$PGSQL_MAJOR_VERSION$PGSQL_MINOR_VERSION"</font></div><div><font size="2"   >POSTGIS_PGSQL_VERSION="90"</font></div><p></p></pre></div><div><br></div><div>2. 调用不同版本的bin时, 最好加上LD_LIBRARY_PATH路径. 否则会有问题.</div><div><br></div><div>3. 升级到9.3后, 外部模块不是extension管理的.&nbsp;</div><div><br></div><div>4. 如果是没有数据的模块, 尽量在老版本中删除. 在升级完后, 新版本中再使用extension加载.</div><div><br></div><div>5. 一些注意事项参考 :&nbsp;</div><div>升级前一定要做好功课.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Notes</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg_upgrade does not support upgrading of databases containing these reg* OID-referencing system data types: regproc, regprocedure, regoper, regoperator, regconfig, and regdictionary. (regtype can be upgraded.)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >All failure, rebuild, and reindex cases will be reported by pg_upgrade if they affect your installation; post-upgrade scripts to rebuild tables and indexes will be generated automatically.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >For deployment testing, create a schema-only copy of the old cluster, insert dummy data, and upgrade that.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >If you are upgrading a pre-PostgreSQL 9.2 cluster that uses a configuration-file-only directory, you must pass the real data directory location to pg_upgrade, and pass the configuration directory location to the server, e.g. -d /real-data-directory -o '-D /configuration-directory'.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >If using a pre-9.1 old server that is using a non-default Unix-domain socket directory or a default that differs from the default of the new cluster, set PGHOST to point to the old server's socket location. (This is not relevant on Windows.)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >A Log-Shipping Standby Server (Section 25.2) cannot be upgraded because the server must allow writes. The simplest way is to upgrade the primary and use rsync to rebuild the standbys. You can run rsync while the primary is down, or as part of a base backup (Section 24.3.2) which overwrites the old standby cluster.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >If you want to use link mode and you do not want your old cluster to be modified when the new cluster is started, make a copy of the old cluster and upgrade that in link mode. To make a valid copy of the old cluster, use rsync to create a dirty copy of the old cluster while the server is running, then shut down the old server and run rsync again to update the copy with any changes to make it consistent. You might want to exclude some files, e.g. postmaster.pid, as documented in Section 24.3.3.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Limitations in Upgrading from PostgreSQL 8.3</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Upgrading from PostgreSQL 8.3 has additional restrictions not present when upgrading from later PostgreSQL releases. For example, pg_upgrade will not work for upgrading from 8.3 if a user column is defined as:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >a tsquery data type</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >data type name and is not the first column</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >You must drop any such columns and upgrade them manually.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg_upgrade will not work if the ltree contrib module is installed in a database.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg_upgrade will require a table rebuild if:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >a user column is of data type tsvector</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg_upgrade will require a reindex if:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >an index is of type hash or GIN</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >an index uses bpchar_pattern_ops</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Also, the default datetime storage format changed to integer after PostgreSQL 8.3. pg_upgrade will check that the datetime storage format used by the old and new clusters match. Make sure your new cluster is built with the configure flag --disable-integer-datetimes.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >For Windows users, note that due to different integer datetimes settings used by the graphical installer and the MSI installer, it is only possible to upgrade from version 8.3 of the installer distribution to version 8.4 or later of the installer distribution. It is not possible to upgrade from the MSI installer to the new graphical installer.</font></div><p></p></pre></div><div><br></div></div>【参考】<div>1.&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/devel/static/pgupgrade.html"   >http://www.postgresql.org/docs/devel/static/pgupgrade.html</a></div><div>2.&nbsp;<a rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=a89c46f9bc314ed549245d888da09b8c5cace104"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=a89c46f9bc314ed549245d888da09b8c5cace104</a></div><div>3.&nbsp;<a rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=6f1b9e4efd94fc644f5de5377829d42e48c3c758"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=6f1b9e4efd94fc644f5de5377829d42e48c3c758</a></div><div>4.&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012513055140/"   >http://blog.163.com/digoal@126/blog/static/1638770402012513055140/</a></div><div>5.&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201341722927382/"   >http://blog.163.com/digoal@126/blog/static/163877040201341722927382/</a><br><br><wbr></div></div>
	</div>
</div>
</body>
</html>