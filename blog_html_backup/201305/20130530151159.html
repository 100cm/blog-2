<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL Daily Maintenance - reindex</h2>
	<h5 id="">2013-05-30 15:11:59&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201343031159876/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >Reindex日志维护</span></div><div style="line-height: 22px;"   >随着DML的发生, 索引会出现碎片. &nbsp;持续膨胀. &nbsp;降低效率. 虽然<span style="line-height: 22px;"   >PostgreSQL有vacuum机制, 但是索引不像heap表, vacuum后的dead tuple占用的空间可以被马上回收复用, 以b-tree索引为例, 一个b-tree page只有当所有的item全部变成不可用后这个page才能被复用. 所以索引膨胀的概率比表大很多.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >例一 :&nbsp;</span></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# truncate tbl;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >TRUNCATE TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 1070.523 ms</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# insert into tbl select generate_series(1,1000000),'test';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INSERT 0 1000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 4534.320 ms</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# analyze tbl;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ANALYZE</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 58.228 ms</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select pg_relation_size('tbl');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_relation_size&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;44285952</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 0.371 ms</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select pg_relation_size('idx_tbl_1');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_relation_size&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;22487040</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 0.304 ms</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# update tbl set id=id+1000000;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >UPDATE 1000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 5786.052 ms</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select pg_relation_size('tbl');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_relation_size&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;88563712</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 0.281 ms</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select pg_relation_size('idx_tbl_1');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_relation_size&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;44941312</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 0.308 ms</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >第一次全量更新后, 表和索引都膨胀了1倍.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# vacuum tbl;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >VACUUM</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 17.052 ms</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >vacuum后表的垃圾会回收, 但是索引的不会被回收.</div><div style="line-height: 22px;"   >所以第二次全量更新, 表不会再膨胀了, 但是索引继续膨胀.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# update tbl set id=id-1000000;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >UPDATE 1000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 6063.763 ms</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select pg_relation_size('tbl');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_relation_size&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;88563712</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 0.814 ms</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select pg_relation_size('idx_tbl_1');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_relation_size&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;65585152</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 0.353 ms</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >第三次vacuum与第二次类似.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# vacuum tbl;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >VACUUM</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 2111.606 ms</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >全量更新后,&nbsp;<span style="line-height: 22px;"   >表未膨胀, 索引膨胀.</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# update tbl set id=id+1000000;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >UPDATE 1000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 7829.064 ms</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select pg_relation_size('tbl');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_relation_size&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;88563712</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 0.310 ms</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select pg_relation_size('idx_tbl_1');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_relation_size&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;88907776</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 0.397 ms</font></div><p style="line-height: 22px;"   ></p></pre></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >例二 :&nbsp;</div><div style="line-height: 22px;"   >创建表, 索引, 插入500万测试数据 :&nbsp;</div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# create table tbl(id int primary key, info int);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CREATE TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# insert into tbl select generate_series(1,5000000),1;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INSERT 0 5000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# create index idx_tbl_1 on tbl(info);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CREATE INDEX</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# vacuum analyze tbl;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >VACUUM</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >记录当前的表, 索引的大小.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select pg_relation_size('tbl');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_relation_size&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 181239808</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select pg_relation_size('tbl_pkey');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_relation_size&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 112328704</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select pg_relation_size('idx_tbl_1');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_relation_size&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 112336896</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >使用pgbench对这个表做更新操作 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pg93@db-172-16-3-33-&gt; vi update.sql</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >\setrandom id 1 5000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >update tbl set info=trunc(5000000*random()) where id=:id;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -r -n -c 8 -j 2 -f ./update.sql -T 60</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of clients: 8</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of threads: 2</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >duration: 60 s</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of transactions actually processed: 361126</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 5994.525604 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 5995.828525 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001356 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 5000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.331439 &nbsp; &nbsp; &nbsp; &nbsp;update tbl set info=trunc(5000000*random()) where id=:id;</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >第一批更新后对表做vacuum, 回收dead tuple占用的空间 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# vacuum verbose analyze tbl;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;vacuuming "public.tbl"</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;scanned index "tbl_pkey" to remove 361126 row versions</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DETAIL: &nbsp;CPU 0.08s/1.54u sec elapsed 1.74 sec.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;scanned index "idx_tbl_1" to remove 361126 row versions</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DETAIL: &nbsp;CPU 0.20s/1.88u sec elapsed 4.00 sec.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;"tbl": removed 361126 row versions in 23350 pages</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DETAIL: &nbsp;CPU 0.14s/0.34u sec elapsed 1.13 sec.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;index "tbl_pkey" now contains 5000000 row versions in 13761 pages</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DETAIL: &nbsp;361082 index row versions were removed.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >0 index pages have been deleted, 0 are currently reusable.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;index "idx_tbl_1" now contains 5000000 row versions in 14972 pages</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DETAIL: &nbsp;361126 index row versions were removed.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >0 index pages have been deleted, 0 are currently reusable.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;"tbl": found 300838 removable, 5000000 nonremovable row versions in 23459 out of 23459 pages</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >There were 0 unused item pointers.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >0 pages are entirely empty.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CPU 0.62s/4.34u sec elapsed 7.77 sec.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;analyzing "public.tbl"</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;"tbl": scanned 23459 of 23459 pages, containing 5000000 live rows and 0 dead rows; 30000 rows in sample, 5000000 estimated total rows</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >VACUUM</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >查看当前表的大小和索引的大小, 比创建表时大了一些. tbl_pkey没变大多少是因为HOT机制造成的.&nbsp;</div><div style="line-height: 22px;"   >HOT的详细介绍可以参考src/backend/access/heap/README.HOT</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select pg_relation_size('tbl');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_relation_size&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 192176128</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select pg_relation_size('tbl_pkey');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_relation_size&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 112730112</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select pg_relation_size('idx_tbl_1');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_relation_size&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 122650624</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >再次使用pgbench对测试表其进行更新 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -r -n -c 8 -j 2 -f ./update.sql -T 60</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of clients: 8</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of threads: 2</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >duration: 60 s</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >number of transactions actually processed: 417661</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 6960.793225 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >tps = 6962.199893 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001263 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 5000000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.146337 &nbsp; &nbsp; &nbsp; &nbsp;update tbl set info=trunc(5000000*random()) where id=:id;</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >再次执行vacuum,</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# vacuum verbose analyze tbl;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;vacuuming "public.tbl"</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;scanned index "tbl_pkey" to remove 417660 row versions</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DETAIL: &nbsp;CPU 0.09s/1.64u sec elapsed 1.88 sec.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;scanned index "idx_tbl_1" to remove 417660 row versions</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DETAIL: &nbsp;CPU 0.24s/1.96u sec elapsed 3.89 sec.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;"tbl": removed 417660 row versions in 23635 pages</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DETAIL: &nbsp;CPU 0.41s/1.28u sec elapsed 5.38 sec.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;index "tbl_pkey" now contains 5000000 row versions in 14191 pages</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DETAIL: &nbsp;417335 index row versions were removed.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >0 index pages have been deleted, 0 are currently reusable.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;index "idx_tbl_1" now contains 5000000 row versions in 16433 pages</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DETAIL: &nbsp;417660 index row versions were removed.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >0 index pages have been deleted, 0 are currently reusable.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;"tbl": found 361383 removable, 5000000 nonremovable row versions in 23727 out of 23727 pages</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >There were 23313 unused item pointers.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >0 pages are entirely empty.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CPU 0.93s/5.76u sec elapsed 12.46 sec.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;analyzing "public.tbl"</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;"tbl": scanned 23727 of 23727 pages, containing 5000000 live rows and 0 dead rows; 30000 rows in sample, 5000000 estimated total rows</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >VACUUM</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >当前表的膨胀几乎停止, 因为第一次vacuum后回收了dead tuple的空间.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select pg_relation_size('tbl');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_relation_size&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 194371584</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select pg_relation_size('tbl_pkey');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_relation_size&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 116252672</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >被更新列的索引继续膨胀, 因为索引页的复用需要这个页上的tuple itempoint完全失效后才可以.</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select pg_relation_size('idx_tbl_1');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_relation_size&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 134619136</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div></div></div><div style="line-height: 22px;"   >所以要经常给索引瘦身, 同时又不能影响数据库的DML操作.</div><div style="line-height: 22px;"   >可以使用如下方法, 重建例一中的索引 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# \d tbl</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; Table "public.tbl"</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >--------+---------+-----------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;id &nbsp; &nbsp; | integer |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;info &nbsp; | text &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Indexes:</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; "idx_tbl_1" btree (id)</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >创建索引的同时不影响表的 DML操作.</div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# create index concurrently &nbsp;idx_tbl_2 on tbl(id);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CREATE INDEX</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 2599.077 ms</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >创建好后删除索引1.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# drop index idx_tbl_1;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DROP INDEX</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 21.757 ms</font></div><p style="line-height: 22px;"   ></p></pre></div></div><div style="line-height: 22px;"   >新建的索引又瘦下去了.</div></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select pg_relation_size('idx_tbl_2');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_relation_size&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;22487040</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 0.450 ms</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >对于primary key或者unique key也可以使用此方法.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# create unique index concurrently user_info_username_key_1 on user_info(username);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CREATE INDEX</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# begin;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >BEGIN</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# alter table user_info drop constraint user_info_username_key;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ALTER TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# alter table user_info add constraint user_info_username_key unique using index user_info_username_key_1;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >NOTICE: &nbsp;ALTER TABLE / ADD CONSTRAINT USING INDEX will rename index "user_info_username_key_1" to "user_info_username_key"</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ALTER TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# end;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >COMMIT</font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# create unique index concurrently user_info_pkey_1 on user_info(id);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CREATE INDEX</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# begin;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >BEGIN</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# alter table user_info drop constraint user_info_pkey;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ALTER TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# alter table user_info add constraint user_info_pkey primary key using index user_info_pkey_1;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >NOTICE: &nbsp;ALTER TABLE / ADD CONSTRAINT USING INDEX will rename index "user_info_pkey_1" to "user_info_pkey"</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ALTER TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# end;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >COMMIT</font></div></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ></div><wbr></div>
	</div>
</div>
</body>
</html>