<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL quote ident and literal</h2>
	<h5 id="">2013-05-21 16:08:58&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201342135151904/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">前面一篇介绍了SQL注入, 其中利用字符逃逸漏洞的占了主要部分.<div><br></div><div>PostgreSQL 提供了几个函数用来输出转义后的字符串.</div><div><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; background-color: rgb(224, 236, 239); border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"   ><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>quote_ident(<tt style="font-size: 1em;"   >string</tt>&nbsp;<tt style="font-size: 1em;"   >text</tt>)</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>text</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Return the given string suitably quoted to be used as an identifier in an&nbsp;<acronym>SQL&nbsp;statement string. Quotes are added only if necessary (i.e., if the string contains non-identifier characters or would be case-folded). Embedded quotes are properly doubled. See also&nbsp;<a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/plpgsql-statements.html#PLPGSQL-QUOTE-LITERAL-EXAMPLE"   >Example 40-1</a>.</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>quote_ident('Foo bar')</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>"Foo bar"</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>quote_literal(<tt style="font-size: 1em;"   >string</tt>&nbsp;<tt style="font-size: 1em;"   >text</tt>)</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>text</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Return the given string suitably quoted to be used as a string literal in an&nbsp;<acronym>SQL&nbsp;statement string. Embedded single-quotes and backslashes are properly doubled. Note that&nbsp;<code>quote_literal</code>&nbsp;returns null on null input; if the argument might be null,&nbsp;<code>quote_nullable</code>&nbsp;is often more suitable. See also&nbsp;<a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/plpgsql-statements.html#PLPGSQL-QUOTE-LITERAL-EXAMPLE"   >Example 40-1</a>.</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>quote_literal(E'O\'Reilly')</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>'O''Reilly'</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   ><tt>quote_literal(<tt style="font-size: 1em;"   >value</tt><tt style="font-size: 1em;"   >anyelement</tt>)</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   ><tt>text</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   >Coerce the given value to text and then quote it as a literal. Embedded single-quotes and backslashes are properly doubled.</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   ><tt>quote_literal(42.5)</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   ><tt>'42.5'</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>quote_nullable(<tt style="font-size: 1em;"   >string</tt>&nbsp;<tt style="font-size: 1em;"   >text</tt>)</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>text</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Return the given string suitably quoted to be used as a string literal in an&nbsp;<acronym>SQL&nbsp;statement string; or, if the argument is null, return&nbsp;<tt>NULL</tt>. Embedded single-quotes and backslashes are properly doubled. See also&nbsp;<a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/plpgsql-statements.html#PLPGSQL-QUOTE-LITERAL-EXAMPLE"   >Example 40-1</a>.</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>quote_nullable(NULL)</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>NULL</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>quote_nullable(<tt style="font-size: 1em;"   >value</tt><tt style="font-size: 1em;"   >anyelement</tt>)</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>text</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Coerce the given value to text and then quote it as a literal; or, if the argument is null, return&nbsp;<tt>NULL</tt>. Embedded single-quotes and backslashes are properly doubled.</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>quote_nullable(42.5)</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>'42.5'</tt></td></tr></table></div><div>一般可用于构造SQL语句, 例如dblink中的动态SQL语句的构造 :&nbsp;</div><div><div style="line-height: 22px;"   >2.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020128772037884/"   >http://blog.163.com/digoal@126/blog/static/16387704020128772037884/</a></div><div style="line-height: 22px;"   >3.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201321125220134/"   >http://blog.163.com/digoal@126/blog/static/163877040201321125220134/</a></div><div style="line-height: 22px;"   >4.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/1638770402012731944439/"   >http://blog.163.com/digoal@126/blog/static/1638770402012731944439/</a></div></div><div style="line-height: 22px;"   >防止因为输入问题造成的不正确SQL.</div><div style="line-height: 22px;"   >quote_ident用于构造数据库对象名, 例如表名, 列名.</div><div style="line-height: 22px;"   >quote_literal用于构造字符串.</div><div style="line-height: 22px;"   >quote_nullable和quote_literal类似, 只是空参数的处理不一样.</div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >quote_literal是strict的, 输入空, 返回空.</span></div><div style="line-height: 22px;"   >quote_nullable是not strict的, 内部处理空值, 返回NULL字符串.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select proisstrict,provolatile,proname from pg_proc where proname ~ 'quote';</font></div><div><font size="2"   >&nbsp;proisstrict | provolatile | &nbsp; &nbsp;proname &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------------+-------------+----------------</font></div><div><font size="2"   >&nbsp;t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | i &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | quote_ident</font></div><div><font size="2"   >&nbsp;t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | i &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | quote_literal</font></div><div><font size="2"   >&nbsp;t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | s &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | quote_literal</font></div><div><font size="2"   >&nbsp;f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | i &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | quote_nullable</font></div><div><font size="2"   >&nbsp;f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | s &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | quote_nullable</font></div><div><font size="2"   >(5 rows)</font></div></pre></div><div>src/backend/utils/adt/quote.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* quote_nullable -</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;Returns a properly quoted literal, with null values returned</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;as the text string 'NULL'.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >Datum</font></div><div><font size="2"   >quote_nullable(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (PG_ARGISNULL(0))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_TEXT_P(cstring_to_text("NULL"));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_DATUM(DirectFunctionCall1(quote_literal,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_GETARG_DATUM(0)));</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div><div>quote_nullable和quote_literal的差异 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select 1 where quote_nullable(null) is null;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >(0 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select 1 where quote_literal(null) is null;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select 1 where quote_literal(null)='NULL';</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >(0 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select 1 where quote_nullable(null)='NULL';</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div><br></div><div><br></div><div>构造动态SQL举例.</div><div>不使用quote :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create or replace function f_test(i_tablename text, i_cname text, i_cval text) returns void as $$</font></div><div><font size="2"   >declare&nbsp;</font></div><div><font size="2"   >&nbsp; v_sql text;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; v_sql := 'create table '||i_tablename||'('||i_cname||' text)';</font></div><div><font size="2"   >&nbsp; raise notice '%', v_sql;</font></div><div><font size="2"   >&nbsp; execute v_sql;</font></div><div><font size="2"   >&nbsp; v_sql := 'insert into '||i_tablename||'('||i_cname||') values ('||i_cval||')';</font></div><div><font size="2"   >&nbsp; raise notice '%', v_sql;</font></div><div><font size="2"   >&nbsp; execute v_sql;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><p></p></pre></div><div># 当表名, 列名中有空格或其他特殊字符时, 必须要用双引号, 因此以下调用将报错.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select f_test('a b','d e','''');</font></div><div><font size="2"   >NOTICE: &nbsp;00000: create table a b(d e text)</font></div><div><font size="2"   >LOCATION: &nbsp;exec_stmt_raise, pl_exec.c:2985</font></div><div><font size="2"   >ERROR: &nbsp;42601: syntax error at or near "b"</font></div><div><font size="2"   >LINE 1: create table a b(d e text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >QUERY: &nbsp;create table a b(d e text)</font></div><div><font size="2"   >CONTEXT: &nbsp;PL/pgSQL function f_test(text,text,text) line 7 at EXECUTE statement</font></div><div><font size="2"   >LOCATION: &nbsp;scanner_yyerror, scan.l:1044</font></div><p></p></pre></div><div># 当字符串中使用单引号时, 也必须逃逸, 使用双单引号. 这里也会报错.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select f_test('ab','de','''');</font></div><div><font size="2"   >NOTICE: &nbsp;00000: create table ab(de text)</font></div><div><font size="2"   >LOCATION: &nbsp;exec_stmt_raise, pl_exec.c:2985</font></div><div><font size="2"   >NOTICE: &nbsp;00000: insert into ab(de) values (')</font></div><div><font size="2"   >LOCATION: &nbsp;exec_stmt_raise, pl_exec.c:2985</font></div><div><font size="2"   >ERROR: &nbsp;42601: unterminated quoted string at or near "')"</font></div><div><font size="2"   >LINE 1: insert into ab(de) values (')</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >QUERY: &nbsp;insert into ab(de) values (')</font></div><div><font size="2"   >CONTEXT: &nbsp;PL/pgSQL function f_test(text,text,text) line 10 at EXECUTE statement</font></div><div><font size="2"   >LOCATION: &nbsp;scanner_yyerror, scan.l:1044</font></div><p></p></pre></div></div><div><br></div><div>使用quote :&nbsp;</div><div>使用quote函数后, 数据库会自动根据需要帮你加上双引号和其他逃逸.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create or replace function f_quote(i_tablename text, i_cname text, i_cval text) returns void as $$</font></div><div><font size="2"   >declare&nbsp;</font></div><div><font size="2"   >&nbsp; v_sql text;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; v_sql := 'create table '||quote_ident(i_tablename)||'('||quote_ident(i_cname)||' text)';</font></div><div><font size="2"   >&nbsp; raise notice '%', v_sql;</font></div><div><font size="2"   >&nbsp; execute v_sql;</font></div><div><font size="2"   >&nbsp; v_sql := 'insert into '||quote_ident(i_tablename)||'('||quote_ident(i_cname)||') values ('||quote_literal(i_cval)||')';</font></div><div><font size="2"   >&nbsp; raise notice '%', v_sql;</font></div><div><font size="2"   >&nbsp; execute v_sql;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select f_quote('a b','d e','''');</font></div><div><font size="2"   >NOTICE: &nbsp;00000: create table "a b"("d e" text)</font></div><div><font size="2"   >LOCATION: &nbsp;exec_stmt_raise, pl_exec.c:2985</font></div><div><font size="2"   >NOTICE: &nbsp;00000: insert into "a b"("d e") values ('''')</font></div><div><font size="2"   >LOCATION: &nbsp;exec_stmt_raise, pl_exec.c:2985</font></div><div><font size="2"   >&nbsp;f_quote&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from "a b";</font></div><div><font size="2"   >&nbsp;d e&nbsp;</font></div><div><font size="2"   >-----</font></div><div><font size="2"   >&nbsp;'</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div>[参考]<wbr></div><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/functions-string.html"   >http://www.postgresql.org/docs/devel/static/functions-string.html</a></div><div>2.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020128772037884/"   >http://blog.163.com/digoal@126/blog/static/16387704020128772037884/</a></div><div>3.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201321125220134/"   >http://blog.163.com/digoal@126/blog/static/163877040201321125220134/</a></div><div>4.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/1638770402012731944439/"   >http://blog.163.com/digoal@126/blog/static/1638770402012731944439/</a></div></div>
	</div>
</div>
</body>
</html>