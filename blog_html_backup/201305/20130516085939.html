<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 initdb add -S only do fsync used with pg_upgrade when server set fsync from off to on</h2>
	<h5 id="">2013-05-16 8:59:39&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201341685247880/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Add initdb --sync-only option to sync the data directory to durable</font></div><div><font size="2"   >storage.</font></div><div><font size="2"   >Have pg_upgrade use it, and enable server options fsync=off and</font></div><div><font size="2"   >full_page_writes=off.</font></div><div><font size="2"   >Document that users turning fsync from off to on should run initdb</font></div><div><font size="2"   >--sync-only.</font></div><p></p></pre></div><div>initdb -S选项目前仅仅被pg_upgrade用于fsync数据库集群目录, 因为pg_upgrade使用了fsync=off来加速升级过程.</div><div>然后在数据库集群起来之前会修改为fsync=on, 这个过程之间必须要将kernel或文件系统cache中的脏块写入持久化存储中.</div><div>所以就有了initdb -S这个选项, 用来做fsync的事情.</div><div>initdb src:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >+ &nbsp; /* If we only need to fsync, just to it and exit */</font></div><div><font size="2"   >+ &nbsp; if (sync_only)</font></div><div><font size="2"   >+ &nbsp; {</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; setup_pgdata();</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; perform_fsync();</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; return 0;</font></div><div><font size="2"   >+ &nbsp; }</font></div><p></p></pre></div><div>contrib/pg_upgrade/server.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >+ &nbsp; &nbsp;* Turn off durability requirements to improve object creation speed, and</font></div><div><font size="2"   >+ &nbsp; &nbsp;* we only modify the new cluster, so only use it there. &nbsp;If there is a</font></div><div><font size="2"   >+ &nbsp; &nbsp;* crash, the new cluster has to be recreated anyway. &nbsp;fsync=off is a big</font></div><div><font size="2"   >+ &nbsp; &nbsp;* win on ext4.</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(cluster == &amp;new_cluster) ?</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; " -c synchronous_commit=off -c fsync=off -c full_page_writes=off" : "",</font></div></div><p></p></pre></div><div>contrib/pg_upgrade/pg_upgrade.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >+ &nbsp; prep_status("Sync data directory to disk");</font></div><div><font size="2"   >+ &nbsp; exec_prog(UTILITY_LOG_FILE, NULL, true,</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "\"%s/initdb\" --sync-only \"%s\"", new_cluster.bindir,</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_cluster.pgdata);</font></div><div><font size="2"   >+ &nbsp; check_ok();</font></div><p></p></pre></div><div>doc/src/sgml/config.sgml</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;For reliable recovery when changing &lt;varname&gt;fsync&lt;/varname&gt;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;off to on, it is necessary to force all modified buffers in the</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;kernel to durable storage. &nbsp;This can be done while the cluster</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;is shutdown or while fsync is on by running &lt;command&gt;initdb</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;--sync-only&lt;/command&gt;, running &lt;command&gt;sync&lt;/&gt;, unmounting the</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;file system, or rebooting the server.</font></div><p></p></pre></div><div>doc/src/sgml/ref/initdb.sgml</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;Safely write all database files to disk and exit. &nbsp;This does not</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;perform any of the normal &lt;application&gt;initdb&lt;/&gt; operations.</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=630cd14426dc1daf85163ad417f3a224eb4ac7b0"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=630cd14426dc1daf85163ad417f3a224eb4ac7b0</a></div><div>2. man initdb</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;-S, --sync-only</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Safely write all database files to disk and exit. This does not perform any of the normal initdb</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;operations.</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>