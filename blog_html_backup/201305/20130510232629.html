<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL extension for json build</h2>
	<h5 id="">2013-05-10 23:26:29&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201341095640769/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>本文介绍的是json数据类型的build函数.</div><div>下载:&nbsp;<a rel="nofollow" href="https://github.com/pgexperts/json_build"   >https://github.com/pgexperts/json_build</a></div><div>安装 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@db-172-16-3-33-&gt; pwd</font></div><div><font size="2"   >/opt/soft_bak</font></div><div><font size="2"   >root@db-172-16-3-33-&gt; cd json_build-master</font></div><div><font size="2"   >root@db-172-16-3-33-&gt; ll</font></div><div><font size="2"   >total 36K</font></div><div><font size="2"   >drwxr-xr-x 2 root root 4.0K May &nbsp;6 22:59 doc</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;140 May &nbsp;6 22:59 json_build.control</font></div><div><font size="2"   >-rw-r--r-- 1 root root 1.1K May &nbsp;6 22:59 License</font></div><div><font size="2"   >-rw-r--r-- 1 root root 1019 May &nbsp;6 22:59 Makefile</font></div><div><font size="2"   >-rw-r--r-- 1 root root 1.2K May &nbsp;6 22:59 META.json</font></div><div><font size="2"   >-rw-r--r-- 1 root root 2.0K May &nbsp;6 22:59 README.md</font></div><div><font size="2"   >drwxr-xr-x 2 root root 4.0K May &nbsp;6 22:59 sql</font></div><div><font size="2"   >drwxr-xr-x 2 root root 4.0K May &nbsp;6 22:59 src</font></div><div><font size="2"   >drwxr-xr-x 4 root root 4.0K May &nbsp;6 22:59 test</font></div><div><font size="2"   >root@db-172-16-3-33-&gt; gmake clean</font></div><div><font size="2"   >rm -f json_build.so &nbsp; libjson_build.a &nbsp;libjson_build.pc</font></div><div><font size="2"   >rm -f src/json_build.o</font></div><div><font size="2"   >rm -rf sql/json_build--1.0.0.sql</font></div><div><font size="2"   >rm -rf test/results/ test/regression.diffs test/regression.out tmp_check/ log/</font></div><div><font size="2"   >root@db-172-16-3-33-&gt; gmake</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -g -fpic -I. -I. -I/opt/pgsql9.3/include/server -I/opt/pgsql9.3/include/internal -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o src/json_build.o src/json_build.c</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -g -fpic -shared -o json_build.so src/json_build.o -L/opt/pgsql9.3/lib &nbsp;-Wl,-rpath,'/opt/pgsql9.3/lib',--enable-new-dtags &nbsp;</font></div><div><font size="2"   >cp sql/json_build.sql sql/json_build--1.0.0.sql</font></div><div><font size="2"   >root@db-172-16-3-33-&gt; gmake install</font></div><div><font size="2"   >/bin/mkdir -p '/opt/pgsql9.3/lib'</font></div><div><font size="2"   >/bin/mkdir -p '/opt/pgsql9.3/share/extension'</font></div><div><font size="2"   >/bin/mkdir -p '/opt/pgsql9.3/share/extension'</font></div><div><font size="2"   >/bin/mkdir -p '/opt/pgsql9.3/share/doc/extension'</font></div><div><font size="2"   >/usr/bin/install -c -m 755 &nbsp;json_build.so '/opt/pgsql9.3/lib/json_build.so'</font></div><div><font size="2"   >/usr/bin/install -c -m 644 ./json_build.control '/opt/pgsql9.3/share/extension/'</font></div><div><font size="2"   >/usr/bin/install -c -m 644 ./sql/json_build--1.0.0.sql &nbsp;'/opt/pgsql9.3/share/extension/'</font></div><div><font size="2"   >/usr/bin/install -c -m 644 ./doc/json_build.md '/opt/pgsql9.3/share/doc/extension/'</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd /opt/pgsql9.3/share/</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd extension/</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; less json_build</font></div><div><font size="2"   >json_build--1.0.0.sql &nbsp;json_build.control</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; less json_build--1.0.0.sql&nbsp;</font></div><div><font size="2"   >-- complain if script is sourced in psql, rather than via CREATE EXTENSION</font></div><div><font size="2"   >\echo Use "CREATE EXTENSION json_build" to load this file. \quit</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION build_json_object(VARIADIC "any")</font></div><div><font size="2"   >RETURNS json</font></div><div><font size="2"   >AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >LANGUAGE C IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- degenerate case - return empty object</font></div><div><font size="2"   >CREATE FUNCTION build_json_object()</font></div><div><font size="2"   >RETURNS json</font></div><div><font size="2"   >AS 'select json $${}$$ '</font></div><div><font size="2"   >LANGUAGE SQL IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION build_json_array(VARIADIC "any")</font></div><div><font size="2"   >RETURNS json</font></div><div><font size="2"   >AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >LANGUAGE C IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- degenerate case - return empty array</font></div><div><font size="2"   >CREATE FUNCTION build_json_array()</font></div><div><font size="2"   >RETURNS json</font></div><div><font size="2"   >AS 'select json $$[]$$ '</font></div><div><font size="2"   >LANGUAGE SQL IMMUTABLE;</font></div></div><div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# create extension json_build;</font></div><div><font size="2"   >CREATE EXTENSION</font></div></div><p></p></pre></div><div><br></div><div>总共有4个函数, 分别创建json对象和array json结构.</div><div>测试</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# SELECT build_json_object(&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;'a', build_json_object('b',false,'c',99),&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;'d', build_json_object('e',array[9,8,7]::int[],</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'f', (select row_to_json(r) from ( select relkind, oid::regclass as name&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; from pg_class where relname = 'pg_class') r)));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; build_json_object &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;{"a" : {"b" : false, "c" : 99}, "d" : {"e" : [9,8,7], "f" : {"relkind":"r","name":"pg_class"}}}</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >array=# SELECT build_json_array( &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;'a', build_json_object('b',false,'c',99),&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;'d', build_json_object('e',array[9,8,7]::int[],</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'f', (select row_to_json(r) from ( select relkind, oid::regclass as name&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; from pg_class where relname = 'pg_class') r)));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;build_json_array &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;["a", {"b" : false, "c" : 99}, "d", {"e" : [9,8,7], "f" : {"relkind":"r","name":"pg_class"}}]</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>【参考】</div><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="https://github.com/pgexperts/json_build"   >https://github.com/pgexperts/json_build</a></div><wbr></div>
	</div>
</div>
</body>
</html>