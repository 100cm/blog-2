<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL Daily Maintenance - Timing Tasks</h2>
	<h5 id="">2013-05-31 15:26:58&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201342744342780/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><span style="line-height: 22px;"   >定时任务管理 :&nbsp;</span></div><div><span style="line-height: 22px;"   >PostgreSQL 定时任务可以通过操作系统的定时任务功能来实现, 例如Linux 的crontab.&nbsp;</span></div><div><span style="line-height: 22px;"   >也可以通过pgagent插件来实现.</span></div><div><span style="line-height: 22px;"   >pgagent的调度信息存储在PostgreSQL数据库的postgres库中, 可以通过pgadmin可以在图形化界面来配置调度表.</span></div><div><span style="line-height: 22px;"   >pgagent是一个后台进程, 时刻读取配置好的调度信息, 根据调度信息执行job, 并记录执行日志.</span></div><div>一般来说建议将pgagent安装在本地数据库服务器中, 调度信息也存放在本地数据库的postgres库中, 那么在执行job时, pgagent连接本地数据库即可. 否则的话还需要配置目标库的密码, 建议用.pgpass来配置, 如果配置在命令行中容易被ps进程发现.</div><div><span style="line-height: 22px;"   >pgagent的安装 :&nbsp;</span></div><div><span style="line-height: 22px;"   >首先下载pgagent :&nbsp;</span></div><div><a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=pgagent.git;a=summary"   >http://git.postgresql.org/gitweb/?p=pgagent.git;a=summary</a></div><div>阅读README, 编译pgagent需要先安装以下软件 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >- A C/C++ compiler, such as GCC or Microsoft Visual C++ on Windows.</font></div><div><font size="2"   >- CMake 2.6 (from www.cmake.org)</font></div><div><font size="2"   >- A wxWidgets 2.8.x installation, configured per the requirements for</font></div><div><font size="2"   >&nbsp; pgAdmin:</font></div><div><font size="2"   >&nbsp; http://git.postgresql.org/gitweb/?p=pgadmin3.git;a=blob_plain;f=INSTALL;hb=HEAD</font></div><div><font size="2"   >- A PostgreSQL 8.3 or higher installation</font></div><p></p></pre></div><div><br></div><div>安装gcc</div><div><pre class="prettyprint"   ><p><font size="2"   >rpm -ivh gcc-4.1.2-51.el5</font></p></pre></div><div>安装cmake</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >tar -zxvf cmake-2.8.8.tar.gz</font></div><div><font size="2"   >cd cmake-2.8.8</font></div><div><font size="2"   >./bootstrap --prefix=/opt/cmake2.8.8</font></div><div><font size="2"   >gmake</font></div><div><font size="2"   >gmake install</font></div><div><font size="2"   >安装好后将cmake的bin目录放到PATH变量.</font></div><div><font size="2"   >vi ~/.bash_profile</font></div><div><font size="2"   >export PATH=/opt/cmake2.8.8/bin:$PATH</font></div><div><font size="2"   >. ~/.bash_profile</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >安装wxWidgets</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >wget http://prdownloads.sourceforge.net/wxwindows/wxGTK-2.8.12.tar.gz</font></div><div><font size="2"   >tar -zxvf&nbsp;<span style="line-height: 22px;"   >wxGTK-2.8.12.tar.gz</span></font></div><div><font size="2"   ><span style="line-height: 22px;"   >cd&nbsp;</span><span style="line-height: 22px;"   >wxGTK-2.8.12</span></font></div><div><font size="2"   >./configure --enable-shared=no --enable-unicode=yes --prefix=/opt/wxGTK-2.8.12</font></div><div><font size="2"   >make</font></div><div><font size="2"   >make install</font></div><div><font size="2"   >将bin加入PATH</font></div><div><font size="2"   >vi ~/.bash_profile<br>export PATH=/opt/wxGTK-2.8.12/bin:$PATH<br>export LD_LIBRARY_PATH=/opt/wxGTK-2.8.12/lib:$LD_LIBRARY_PATH<br>. ~/.bash_profile</font></div><p></p></pre></div><div>安装PostgreSQL, 略.</div><div>将pg_config加入PATH</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi ~/.bash_profile</font></div><div><font size="2"   >export PATH=/opt/pgsql9.3/bin:$PATH</font></div><div><font size="2"   >. ~/.bash_profile</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >安装pgagent</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >tar -zxvf&nbsp;pgagent-d6c5a80.tar.gz</font></div><div><font size="2"   >cd&nbsp;pgagent-d6c5a80</font></div><div><font size="2"   >ccmake ./</font></div><div><font size="2"   >生成配置</font></div><div><div><font size="2"   >&nbsp;CMAKE_BUILD_TYPE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;CMAKE_INSTALL_PREFIX &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 修改为此项 /opt/pgagent &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;PG_CONFIG_PATH &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /opt/pgsql9.3/bin/pg_config &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;STATIC_BUILD &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ON &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;WX_CONFIG_PATH &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /opt/wxGTK-2.8.12/bin/wx-config &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;WX_DEBUG &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; OFF</font></div></div><div><font size="2"   >按c配置,然后按g产生配置</font></div><div><font size="2"   >接下来就可以编译安装了</font></div><div><div style="line-height: 22px;"   ><font size="2"   >make</font></div><div style="line-height: 22px;"   ><font size="2"   >make install</font></div><div style="line-height: 22px;"   ><font size="2"   >配置.bash_profile</font></div><div><font size="2"   >vi ~/.bash_profile</font></div><div><font size="2"   >export PATH=/opt/pgagent/bin:$PATH</font></div><div><font size="2"   >. ~/.bash_profile</font></div></div><p></p></pre></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >在本地库的postgres库中创建调度信息, 表, 函数 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >psql -h 127.0.0.1 -p 1999 -U postgres -d postgres -f /opt/pgagent/</span>share/pgagent.sql</font></div><div></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >安装好后, 使用pgadmin连接到本地库就可以看到jobs选项 :&nbsp;</span></div><div style="line-height: 22px;"   ><div><img title="PostgreSQL Daily Maintenance - Timing Tasks - 德哥@Digoal - PostgreSQL"   alt="PostgreSQL Daily Maintenance - Timing Tasks - 德哥@Digoal - PostgreSQL"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/Y0p0BAsnh5K7CG_YTzGOVw==/6597885604285820119.png"   ></div>&nbsp;</div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >pgagent配置举例</span></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >启动pgagent.</span></div><div style="line-height: 22px;"   >pgagent是一个后台进程, 时刻要去读取存储在数据库中的调度信息以执行定时任务. 所以首先要启动pgagent.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 ~]# pgagent --help</font></div><div><font size="2"   >Usage:</font></div><div><font size="2"   >pgagent [options] &lt;connect-string&gt;</font></div><div><font size="2"   >options:</font></div><div><font size="2"   >-f run in the foreground (do not detach from the terminal)</font></div><div><font size="2"   >-t &lt;poll time interval in seconds (default 10)&gt;</font></div><div><font size="2"   >-r &lt;retry period after connection abort in seconds (&gt;=10, default 30)&gt;</font></div><div><font size="2"   >-s &lt;log file (messages are logged to STDOUT if not specified&gt;</font></div><div><font size="2"   >-l &lt;logging verbosity (ERROR=0, WARNING=1, DEBUG=2, default 0)&gt;</font></div><p></p></pre></div><div>例如, -t 1表示每秒读取一次调度数据 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pgagent -t 1 -l 2 -s /var/log/pgagent.log hostaddr=127.0.0.1 port=1999 dbname=postgres user=postgres</font></div><div><font size="2"   >不要把password配置在命令行中, 尽量配置在密码文件中 :&nbsp;</font></div><div><font size="2"   >vi ~/.pgpass</font></div><div><font size="2"   >127.0.0.1:1999:postgres:postgres:postgres</font></div><div><font size="2"   >chmod 400 ~/.pgpass</font></div><p></p></pre></div><div style="line-height: 22px;"   >启动好pgagent后就可以配置job了.</div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >案例1 :&nbsp;</span></div><div>需求 : 在本地数据库中定时执行sql</div><div><span style="line-height: 22px;"   >job配置</span></div><div><span style="line-height: 22px;"   >1. 在pgadmin的jobs上右键新建job.</span></div><div><span style="line-height: 22px;"   >2. 在属性栏配置job name, 例如j1.</span></div><div><span style="line-height: 22px;"   >3. 在steps中新建并配置step name, 本地库名;</span></div><div><span style="line-height: 22px;"   >在定义栏配置要执行的sql :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >create table if not exists test_sum(sdate date, cnt int8);</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >insert into test_sum select current_date,count(*) from pg_class group by current_date;</font></span></div><p></p></pre></div><div>可以配置多个step, 执行时按名称以及step id排序执行 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >// job.cpp - pgAgent job</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >int Job::Execute()</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int rc = 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bool succeeded = false;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; DBresult *steps = threadConn-&gt;Execute(</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wxT("SELECT * ")</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wxT(" &nbsp;FROM pgagent.pga_jobstep ")</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wxT(" WHERE jstenabled ")</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wxT(" &nbsp; AND jstjobid=") + jobid +</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wxT(" ORDER BY jstname, jstid"));</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >4. 在schedule栏中</span><span style="line-height: 22px;"   >新建并</span><span style="line-height: 22px;"   >配置调度名, 开始时间, 如果有结束时间的话还需要配置结束时间.</span></div><div><span style="line-height: 22px;"   >days中可以配置周, 月, 日</span></div><div>times中可以配置小时, 分钟.</div><div>exceptions中配置排他.</div><div>配置完后, 在steps以及jos的统计信息栏可以看到每次JOB或者step执行的情况.</div><div><br></div><div><span style="line-height: 22px;"   >案例2 :&nbsp;</span></div><div><span style="line-height: 22px;"   >需求 : 定时执行脚本(batch)</span></div><div><span style="line-height: 22px;"   >脚本配置</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-33 ~]# cat /root/b.sh</font></div><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   >psql -h 127.0.0.1 -p 1999 -U postgres postgres &lt;&lt;EOF</font></div><div><font size="2"   >create table if not exists t(id int);</font></div><div><font size="2"   >insert into t values (1);</font></div><div><font size="2"   >EOF</font></div></div><div><font size="2"   >exit $?</font></div><div><font size="2"   >chmod 500&nbsp;<span style="line-height: 22px;"   >b.sh</span></font></div><p></p></pre></div><div><span style="line-height: 22px;"   >以上假设pgagent是以root用户执行的. 否则要考虑脚本的可执行权限.</span></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >job配置, 同上</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >schedule</span><span style="line-height: 22px;"   >配置, 同上</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >step</span><span style="line-height: 22px;"   >配置, 选择batch, 不需要选择数据库. 定义中输入/root/b.sh .其他同上.</span></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div><div style="line-height: 22px;"   >案例3 :&nbsp;</div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >需求 : 在远程数据库中定时执行SQL</span></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >job配置, 同上.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >schedule</span><span style="line-height: 22px;"   >配置, 同上.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >step</span><span style="line-height: 22px;"   >配置, 需要输入远程数据库的连接信息. 密码配置在conn string中. 所以不安全.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >例如 :&nbsp;</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >hostaddr=172.16.3.150 port=1000 user=postgres dbname=postgres password=pwd</font></div><div style="line-height: 22px;"   ></div><p></p></pre><div><span style="line-height: 22px;"   >这里支持.pgpass. 所以建议不要使用远程定时任务.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >连接信息参考 :&nbsp;</span></div><div style="line-height: 22px;"   ><a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/libpq-connect.html"   >http://www.postgresql.org/docs/devel/static/libpq-connect.html</a></div></div></div><div><br></div><div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/libpq-connect.html"   >http://www.postgresql.org/docs/devel/static/libpq-connect.html</a></div><div>2.&nbsp;<a rel="nofollow" href="http://pgadmin.org/"   >http://pgadmin.org/</a></div></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">曾经是风 - 2013-05-31 16:44:53</h5>
				<div>定时任务可块，我还没用过！<br><br></div>
			</div>
	</div>
</div>
</body>
</html>