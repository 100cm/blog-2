<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 Allow the statistics collector to operate properly in cases where the system clock goes backwards</h2>
	<h5 id="">2013-05-08 8:38:43&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020134745326551/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Allow the statistics collector to operate properly in cases where the system clock goes backwards (Tom Lane)</font></div><div><font size="2"   >Previously statistics collection would stop until the time again reached the previously-stored latest time.</font></div><div><div><font size="2"   >Fix stats collector to recover nicely when system clock goes backwards.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Formerly, if the system clock went backwards, the stats collector would</font></div><div><font size="2"   >fail to update the stats file any more until the clock reading again</font></div><div><font size="2"   >exceeds whatever timestamp was last written into the stats file. &nbsp;Such</font></div><div><font size="2"   >glitches in the clock's behavior are not terribly unlikely on machines</font></div><div><font size="2"   >not using NTP. &nbsp;Such a scenario has been observed to cause regression test</font></div><div><font size="2"   >failures in the buildfarm, and it could have bad effects on the behavior</font></div><div><font size="2"   >of autovacuum, so it seems prudent to install some defenses.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >We could directly detect the clock going backwards by adding</font></div><div><font size="2"   >GetCurrentTimestamp calls in the stats collector's main loop, but that</font></div><div><font size="2"   >would hurt performance on platforms where GetCurrentTimestamp is expensive.</font></div><div><font size="2"   >To minimize the performance hit in normal cases, adopt a more complicated</font></div><div><font size="2"   >scheme wherein backends check for clock skew when reading the stats file,</font></div><div><font size="2"   >and if they see it, signal the stats collector by sending an extra stats</font></div><div><font size="2"   >inquiry message. &nbsp;The stats collector does an extra GetCurrentTimestamp</font></div><div><font size="2"   >only when it receives an inquiry with an apparently out-of-order</font></div><div><font size="2"   >timestamp.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >To avoid unnecessary GetCurrentTimestamp calls, expand the inquiry messages</font></div><div><font size="2"   >to carry the backend's current clock reading as well as its stats cutoff</font></div><div><font size="2"   >time. &nbsp;The latter, being intentionally slightly in-the-past, would trigger</font></div><div><font size="2"   >more clock rechecks than we need if it were used for this purpose.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >We might want to backpatch this change at some point, but let's let it</font></div><div><font size="2"   >shake out in the buildfarm for awhile first.</font></div></div><p></p></pre></div><div><br></div><div><div>[测试]</div><div>PostgreSQL 9.3 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[pg93@db-172-16-3-33 pg_stat_tmp]$ psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \set VERBOSITY verbose</font></div><div><font size="2"   >digoal=# set client_min_messages='log';</font></div><div><font size="2"   >digoal=# vacuum test;</font></div><div><font size="2"   >VACUUM</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >-- 当前库统计信息文件状态</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd $PGDATA/pg_stat_tmp/</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; stat db_12815.stat&nbsp;</font></div><div><font size="2"   >&nbsp; File: `db_12815.stat'</font></div><div><font size="2"   >&nbsp; Size: 14708 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Blocks: 32 &nbsp; &nbsp; &nbsp; &nbsp; IO Block: 4096 &nbsp; regular file</font></div><div><font size="2"   >Device: fd00h/64768d &nbsp; &nbsp;Inode: 918401 &nbsp; &nbsp; &nbsp;Links: 1</font></div><div><font size="2"   >Access: (0600/-rw-------) &nbsp;Uid: ( &nbsp;511/ &nbsp; &nbsp;pg93) &nbsp; Gid: ( &nbsp;511/ &nbsp; &nbsp;pg93)</font></div><div><font size="2"   >Access: 2013-05-08 08:25:08.970408501 +0800</font></div><div><font size="2"   >Modify: 2013-05-08 08:25:08.960408501 +0800</font></div><div><font size="2"   >Change: 2013-05-08 08:25:08.960408501 +0800</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >-- 修改系统时间</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 ~]# date -s "2012-01-01 00:00:00"</font></div><div><font size="2"   >Sun Jan &nbsp;1 00:00:00 CST 2012</font></div><p></p></pre></div><div>-- 再次vacuum, 有一个日志输出.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# vacuum test;</font></div><div><font size="2"   >LOG: &nbsp;stats collector's time 2013-05-08 08:25:08.960954+08 is later than backend local time 2012-01-01 00:00:10.655758+08</font></div><div><font size="2"   >LOCATION: &nbsp;backend_read_statsfile, pgstat.c:4307</font></div><div><font size="2"   >VACUUM</font></div><p></p></pre></div><div>-- 但是注意时间戳, stat文件也更新了. 所以9.3不依赖系统时间. 即使时间跳跃也可以正常收集和更新统计信息.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd pg_stat_tmp/</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; ll</font></div><div><font size="2"   >total 24K</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 2.2K May &nbsp;6 &nbsp;2013 db_0.stat</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 &nbsp;15K Jan &nbsp;1 00:01 db_12815.stat</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 &nbsp;471 Jan &nbsp;1 00:01 global.stat</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; stat db_12815.stat&nbsp;</font></div><div><font size="2"   >&nbsp; File: `db_12815.stat'</font></div><div><font size="2"   >&nbsp; Size: 14708 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Blocks: 32 &nbsp; &nbsp; &nbsp; &nbsp; IO Block: 4096 &nbsp; regular file</font></div><div><font size="2"   >Device: fd00h/64768d &nbsp; &nbsp;Inode: 918397 &nbsp; &nbsp; &nbsp;Links: 1</font></div><div><font size="2"   >Access: (0600/-rw-------) &nbsp;Uid: ( &nbsp;511/ &nbsp; &nbsp;pg93) &nbsp; Gid: ( &nbsp;511/ &nbsp; &nbsp;pg93)</font></div><div><font size="2"   >Access: 2012-01-01 00:00:03.158373485 +0800</font></div><div><font size="2"   >Modify: 2012-01-01 00:00:03.158373485 +0800</font></div><div><font size="2"   >Change: 2012-01-01 00:00:03.158373485 +0800</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >最后调回正常时间</span></div><div><pre class="prettyprint"   ><p><font size="2"   >/usr/sbin/ntpdate asia.pool.ntp.org &amp;&amp; /sbin/hwclock --systohc</font></p></pre></div><div><br></div><div>PostgreSQL 9.2 :&nbsp;</div><div>-- 修改系统当前时间</div><div><pre class="prettyprint"   ><p><font size="2"   >[root@db-172-16-3-33 ~]# date -s "2014-01-01 00:00:00"</font></p></pre></div><div>-- 执行vacuum</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.2.4)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# set client_min_messages='log';</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# \set VERBOSITY verbose</font></div><div><font size="2"   >digoal=# vacuum test;</font></div><div><font size="2"   >VACUUM</font></div><p></p></pre></div><div>-- 再次修改系统时间</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 ~]# /usr/sbin/ntpdate asia.pool.ntp.org &amp;&amp; /sbin/hwclock --systohc</font></div><div><font size="2"   >&nbsp;8 May 08:28:20 ntpdate[10301]: step time server 59.106.180.168 offset 42625559.504544 sec</font></div><p></p></pre></div><div>-- 再次vacuum</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# vacuum test;</font></div><div><font size="2"   >VACUUM</font></div><p></p></pre></div><div>-- # 只要系统时间早于pgstat的时间戳, 就不会更新pgstat.stat了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-33-&gt; stat pgstat.stat&nbsp;</font></div><div><font size="2"   >&nbsp; File: `pgstat.stat'</font></div><div><font size="2"   >&nbsp; Size: 14484 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Blocks: 32 &nbsp; &nbsp; &nbsp; &nbsp; IO Block: 4096 &nbsp; regular file</font></div><div><font size="2"   >Device: fd00h/64768d &nbsp; &nbsp;Inode: 131847 &nbsp; &nbsp; &nbsp;Links: 1</font></div><div><font size="2"   >Access: (0600/-rw-------) &nbsp;Uid: ( &nbsp;501/ &nbsp; &nbsp;pg92) &nbsp; Gid: ( &nbsp;501/ &nbsp; &nbsp;pg92)</font></div><div><font size="2"   >Access: 2013-05-08 08:28:39.385911187 +0800</font></div><div><font size="2"   >Modify: 2014-01-01 00:00:01.674048473 +0800</font></div><div><font size="2"   >Change: 2014-01-01 00:00:01.674048473 +0800</font></div><p></p></pre></div><div>-- 将时间再调到未来</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 ~]# date -s "2014-01-01 00:01:00"</font></div><div><font size="2"   >Wed Jan &nbsp;1 00:01:00 CST 2014</font></div><p></p></pre></div><div>-- 可以正常更新stat文件</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.2.4)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# vacuum test;</font></div><div><font size="2"   >VACUUM</font></div><div><font size="2"   >digoal=# \q</font></div><div><font size="2"   >pg92@db-172-16-3-33-&gt; stat pgstat.stat&nbsp;</font></div><div><font size="2"   >&nbsp; File: `pgstat.stat'</font></div><div><font size="2"   >&nbsp; Size: 14484 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Blocks: 32 &nbsp; &nbsp; &nbsp; &nbsp; IO Block: 4096 &nbsp; regular file</font></div><div><font size="2"   >Device: fd00h/64768d &nbsp; &nbsp;Inode: 131106 &nbsp; &nbsp; &nbsp;Links: 1</font></div><div><font size="2"   >Access: (0600/-rw-------) &nbsp;Uid: ( &nbsp;501/ &nbsp; &nbsp;pg92) &nbsp; Gid: ( &nbsp;501/ &nbsp; &nbsp;pg92)</font></div><div><font size="2"   >Access: 2014-01-01 00:01:04.853129363 +0800</font></div><div><font size="2"   >Modify: 2014-01-01 00:01:04.843129363 +0800</font></div><div><font size="2"   >Change: 2014-01-01 00:01:04.843129363 +0800</font></div><p></p></pre></div></div><div><br></div><div>PostgreSQL 9.3以下的版本遇到此问题怎么办呢?</div><div>将系统时间修正后, touch stat文件即可.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-33 ~]# /usr/sbin/ntpdate asia.pool.ntp.org &amp;&amp; /sbin/hwclock --systohc</font></div><div><font size="2"   >&nbsp;8 May 08:36:12 ntpdate[10328]: step time server 211.233.84.186 offset -20532610.162256 sec</font></div></div><div><div><font size="2"   >pg92@db-172-16-3-33-&gt; touch pgstat.stat&nbsp;</font></div><div><font size="2"   >pg92@db-172-16-3-33-&gt; stat pgstat.stat&nbsp;</font></div><div><font size="2"   >&nbsp; File: `pgstat.stat'</font></div><div><font size="2"   >&nbsp; Size: 14484 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Blocks: 32 &nbsp; &nbsp; &nbsp; &nbsp; IO Block: 4096 &nbsp; regular file</font></div><div><font size="2"   >Device: fd00h/64768d &nbsp; &nbsp;Inode: 131106 &nbsp; &nbsp; &nbsp;Links: 1</font></div><div><font size="2"   >Access: (0600/-rw-------) &nbsp;Uid: ( &nbsp;501/ &nbsp; &nbsp;pg92) &nbsp; Gid: ( &nbsp;501/ &nbsp; &nbsp;pg92)</font></div><div><font size="2"   >Access: 2013-05-08 08:36:15.313867694 +0800</font></div><div><font size="2"   >Modify: 2013-05-08 08:36:15.313867694 +0800</font></div><div><font size="2"   >Change: 2013-05-08 08:36:15.313867694 +0800</font></div></div><p></p></pre></div><div>如果有遇到有规律的时钟跳跃那就没有好的办法了, 还是升级到9.3吧.</div><div>例如我们一起有一台IBM X3950的堆叠, 堆叠时时钟就会跳跃, 拆除堆叠就没有问题了.</div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=9e18eacbdff2ae2abd5ff38eee725e6399e39b41"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=9e18eacbdff2ae2abd5ff38eee725e6399e39b41</a></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (file_ts &gt;= TimestampTzPlusMilliseconds(cur_ts, 1000))</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *filetime;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *mytime;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Copy because timestamptz_to_str returns a static buffer */</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; filetime = pstrdup(timestamptz_to_str(file_ts));</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mytime = pstrdup(timestamptz_to_str(cur_ts));</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(LOG, "stats collector's time %s is later than backend local time %s",</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;filetime, mytime);</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pfree(filetime);</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pfree(mytime);</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div><div><br></div><wbr></div>
	</div>
</div>
</body>
</html>