<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 format function like c sprintf</h2>
	<h5 id="">2013-05-06 8:39:20&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013459414863/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.3 引入的一个格式化输出函数, 有点类似C的sprintf用法.</div><div>语法如下 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >format(formatstr text [, formatarg "any" [, ...] ])</font></p></pre></div><div>其中formatstr是需要格式化的字符串, 包含普通字符以及格式字符.</div><div>后面的动态参数用来替换formatstr中的格式字符.</div><div>格式字符的语法如下 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >%[position][flags][width]type</font></p></pre></div><div>其中position, flags, width都是可选项. type是必须的.</div><div>1. position 指变量位置.</div><div><pre class="prettyprint"   ><p><font size="2"   >A string of the form n$ where n is the index of the argument to print. Index 1 means the first argument after formatstr. If the position is omitted, the default is to use the next argument in sequence.</font></p></pre></div><div>注意<span style="line-height: 22px;"   >the next argument是指前一个已经取过的位置的下一个位置.</span></div><div>2. flags目前只有-, 且需要与width配合使用, -表示右补齐, 没有-表示左补齐.</div><div><pre class="prettyprint"   ><p><font size="2"   >Additional options controlling how the format specifier's output is formatted. Currently the only supported flag is a minus sign (-) which will cause the format specifier's output to be left-justified. This has no effect unless the width field is also specified.</font></p></pre></div><div>width指显示的宽度, 当宽度大于实际字符串时用空格补齐, 当宽度小于实际字符串长度时不会截断字符串, 相当于width不起作用. width也可以使用3. format函数的参数值来代替直接写在formatstr中.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Specifies the minimum number of characters to use to display the format specifier's output. The output is padded on the left or right (depending on the - flag) with spaces as needed to fill the width. A too-small width does not cause truncation of the output, but is simply ignored. The width may be specified using any of the following:&nbsp;</font></div><div><font size="2"   >a positive integer;&nbsp;</font></div><div><font size="2"   >an asterisk (*) to use the next function argument as the width;&nbsp;</font></div><div><font size="2"   >or a string of the form *n$ to use the nth function argument as the width.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >If the width comes from a function argument, that argument is consumed before the argument that is used for the format specifier's value. If the width argument is negative, the result is left aligned (as if the - flag had been specified) within a field of length abs(width).</font></div><p></p></pre></div><div>注意如果同一个格式中宽度用到了参数, 那么宽度优先消耗这个参数. 因此如果没有指定位置时, 默认会消耗下一个参数. 也就是宽度消耗的参数的下一个参数.</div><div>4. type指字符串类型, 目前可以使用s, I, L. 分别表示字符串, identified, 和literal.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >The type of format conversion to use to produce the format specifier's output. The following types are supported:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >s formats the argument value as a simple string. A null value is treated as an empty string.</font></div><div><font size="2"   >I treats the argument value as an SQL identifier, double-quoting it if necessary. It is an error for the value to be null.</font></div><div><font size="2"   >L quotes the argument value as an SQL literal. A null value is displayed as the string NULL, without quotes.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >In addition to the format specifiers described above, the special sequence %% may be used to output a literal % character.</font></div><p></p></pre></div><div><br></div><div>[使用举例]</div><div>1.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select format ('|abc|%*2$s|', E'wab c\t', '10', 'ab c');</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; format &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp;|abc| &nbsp; &nbsp; &nbsp;ab c|</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>*2$指width取第二个参数. 10</div><div>s指字符串, 这里去下一个参数也就是第三个参数'ab c'</div><div>2.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select format ('|abc|%*s|','8', E'wab c', '10', 'ab c');</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp;format &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;|abc| &nbsp; wab c|</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>*指width, 取下一个参数. 因为前面没有取过任何参数, 所以这里是'8'</div><div>s<span style="line-height: 22px;"   >指字符串, 这里去下一个参数也就是第2个参数</span><span style="line-height: 22px;"   >E'wab c'.</span></div><div><span style="line-height: 22px;"   >3.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select format ('|abc|%-*s|','8', E'wab c', '10', 'ab c');</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp;format &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;|abc|wab c &nbsp; |</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><div style="line-height: 22px;"   >*指width, 取下一个参数. 因为前面没有取过任何参数, 所以这里是'8'</div><div style="line-height: 22px;"   >s<span style="line-height: 22px;"   >指字符串, 这里去下一个参数也就是第2个参数</span><span style="line-height: 22px;"   >E'wab c'.</span></div></div><div>- 表示右边补齐</div><div>4.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select format ('|abc|%3$-*s|','4', E'wab c', '10', 'ab c');</font></div><div><div><font size="2"   >&nbsp; &nbsp;format &nbsp;&nbsp;</font></div><div><font size="2"   >------------</font></div><div><font size="2"   >&nbsp;|abc|10 &nbsp;|</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>这里的*取的是第一个参数'4', 因为前面没有取过参数, 从1开始.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select format ('|abc|%2$s|%3$-*s|','4', E'wab c', '10', 'ab c');</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;format &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------</font></div><div><font size="2"   >&nbsp;|abc|wab c|10 &nbsp; &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>这里的*取的是第3个参数. 也就是%2$后面的一个参数.</div><div><span style="line-height: 22px;"   >%3$-*s这个格式中, 是先取width参数, 再取其他参数的.</span></div><div>5.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select format ('|abc|%2$I|%3$-*I|','4', E'wab c', '10', 'ab c');</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; format &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;|abc|"wab c"|"10" &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>I指identified, 类似表名, 字段名. 所以如果是包含了特殊字符则需要用双引号.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select format ('|abc|%2$I|%3$-*I|','4', E'wABc', '10', 'ab c');</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;format &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------------------</font></div><div><font size="2"   >&nbsp;|abc|"wABc"|"10" &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >digoal=# select format ('|abc|%2$I|%3$-*I|','4', E'wabc', '10', 'ab c');</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; format &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;|abc|wabc|"10" &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>6.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select format ('|abc|%2$L|%3$-*L|','4', E'wa\bc\t', '10', 'ab c');</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; format &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------------------------------</font></div><div><font size="2"   >&nbsp;|abc|'wa\x08c &nbsp; '|'10' &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >digoal=# select format ('|abc|%2$L|%3$-*L|','4', E'wa\bc\t\\', '10', 'ab c');</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;format &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------------------</font></div><div><font size="2"   >&nbsp;|abc|E'wa\x08c &nbsp;\\'|'10' &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>L指literal, 类似字符串类型的值, 所以涉及逃逸. 如山.</div><div>7.</div><div>因此format可用于构造动态SQL.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >SELECT format('INSERT INTO %I VALUES(%L)', 'Foo bar', E'O\'Reilly');</font></div><div><font size="2"   >Result: INSERT INTO "Foo bar" VALUES('O''Reilly')</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SELECT format('INSERT INTO %I VALUES(%L)', 'locations', E'C:\\Program Files');</font></div><div><font size="2"   >Result: INSERT INTO locations VALUES(E'C:\\Program Files')</font></div><p></p></pre></div><div><br></div>【参考】<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/functions-string.html"   >http://www.postgresql.org/docs/devel/static/functions-string.html</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/plpgsql-statements.html#PLPGSQL-QUOTE-LITERAL-EXAMPLE"   >http://www.postgresql.org/docs/devel/static/plpgsql-statements.html#PLPGSQL-QUOTE-LITERAL-EXAMPLE</a></div><div>3. man 3 sprintf</div></div>
	</div>
</div>
</body>
</html>