<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 Change the WAL record format to allow splitting the record header across pages</h2>
	<h5 id="">2013-05-09 11:19:21&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020134993845555/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >Change the WAL record format to allow splitting the record header across pages (Heikki Linnakangas)</font></div><div><font size="2"   >The new format is slightly more compact, and is more efficient to write.</font></div></div><div><div><font size="2"   ><br></font></div><div><font size="2"   >Allow WAL record header to be split across pages.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This saves a few bytes of WAL space, but the real motivation is to make it</font></div><div><font size="2"   >predictable how much WAL space a record requires, as it no longer depends</font></div><div><font size="2"   >on whether we need to waste the last few bytes at end of WAL page because</font></div><div><font size="2"   >the header doesn't fit.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The total length field of WAL record, xl_tot_len, is moved to the beginning</font></div><div><font size="2"   >of the WAL record header, so that it is still always found on the first page</font></div><div><font size="2"   >where a WAL record begins.</font></div><div><font size="2"   >Bump WAL version number again as this is an incompatible change.</font></div></div></pre></div><div>变更前的xlogrecord结构 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; 41 typedef struct XLogRecord</font></div><div><font size="2"   >&nbsp; 42 {</font></div><div><font size="2"   >&nbsp; 43 &nbsp; &nbsp; pg_crc32 &nbsp; &nbsp;xl_crc; &nbsp; &nbsp; &nbsp; &nbsp; /* CRC for this record */</font></div><div><font size="2"   >&nbsp; 44 &nbsp; &nbsp; XLogRecPtr &nbsp;xl_prev; &nbsp; &nbsp; &nbsp; &nbsp;/* ptr to previous record in log */</font></div><div><font size="2"   >&nbsp; 45 &nbsp; &nbsp; TransactionId xl_xid; &nbsp; &nbsp; &nbsp; /* xact id */</font></div><div><font size="2"   >&nbsp; 46 &nbsp; &nbsp; uint32 &nbsp; &nbsp; &nbsp;xl_tot_len; &nbsp; &nbsp; /* total len of entire record */</font></div><div><font size="2"   >&nbsp; 47 &nbsp; &nbsp; uint32 &nbsp; &nbsp; &nbsp;xl_len; &nbsp; &nbsp; &nbsp; &nbsp; /* total len of rmgr data */</font></div><div><font size="2"   >&nbsp; 48 &nbsp; &nbsp; uint8 &nbsp; &nbsp; &nbsp; xl_info; &nbsp; &nbsp; &nbsp; &nbsp;/* flag bits, see below */</font></div><div><font size="2"   >&nbsp; 49 &nbsp; &nbsp; RmgrId &nbsp; &nbsp; &nbsp;xl_rmid; &nbsp; &nbsp; &nbsp; &nbsp;/* resource manager for this record */</font></div><div><font size="2"   >&nbsp; 50&nbsp;</font></div><div><font size="2"   >&nbsp; 51 &nbsp; &nbsp; /* Depending on MAXALIGN, there are either 2 or 6 wasted bytes here */</font></div><div><font size="2"   >&nbsp; 52&nbsp;</font></div><div><font size="2"   >&nbsp; 53 &nbsp; &nbsp; /* ACTUAL LOG DATA FOLLOWS AT END OF STRUCT */</font></div><div><font size="2"   >&nbsp; 54&nbsp;</font></div><div><font size="2"   >&nbsp; 55 } XLogRecord;</font></div></pre></div><div>变更后的xlogrecord结构 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; 41 typedef struct XLogRecord</font></div><div><font size="2"   >&nbsp; 42 {</font></div><div><font size="2"   >&nbsp; 43 &nbsp; &nbsp; uint32 &nbsp; &nbsp; &nbsp;xl_tot_len; &nbsp; &nbsp; /* total len of entire record */</font></div><div><font size="2"   >&nbsp; 44 &nbsp; &nbsp; TransactionId xl_xid; &nbsp; &nbsp; &nbsp; /* xact id */</font></div><div><font size="2"   >&nbsp; 45 &nbsp; &nbsp; uint32 &nbsp; &nbsp; &nbsp;xl_len; &nbsp; &nbsp; &nbsp; &nbsp; /* total len of rmgr data */</font></div><div><font size="2"   >&nbsp; 46 &nbsp; &nbsp; uint8 &nbsp; &nbsp; &nbsp; xl_info; &nbsp; &nbsp; &nbsp; &nbsp;/* flag bits, see below */</font></div><div><font size="2"   >&nbsp; 47 &nbsp; &nbsp; RmgrId &nbsp; &nbsp; &nbsp;xl_rmid; &nbsp; &nbsp; &nbsp; &nbsp;/* resource manager for this record */</font></div><div><font size="2"   >&nbsp; 48 &nbsp; &nbsp; /* 2 bytes of padding here, initialize to zero */</font></div><div><font size="2"   >&nbsp; 49 &nbsp; &nbsp; XLogRecPtr &nbsp;xl_prev; &nbsp; &nbsp; &nbsp; &nbsp;/* ptr to previous record in log */</font></div><div><font size="2"   >&nbsp; 50 &nbsp; &nbsp; pg_crc32 &nbsp; &nbsp;xl_crc; &nbsp; &nbsp; &nbsp; &nbsp; /* CRC for this record */</font></div><div><font size="2"   >&nbsp; 51&nbsp;</font></div><div><font size="2"   >&nbsp; 52 &nbsp; &nbsp; /* If MAXALIGN==8, there are 4 wasted bytes here */</font></div><div><font size="2"   >&nbsp; 53&nbsp;</font></div><div><font size="2"   >&nbsp; 54 &nbsp; &nbsp; /* ACTUAL LOG DATA FOLLOWS AT END OF STRUCT */</font></div><div><font size="2"   >&nbsp; 55&nbsp;</font></div><div><font size="2"   >&nbsp; 56 } XLogRecord;</font></div><p></p></pre></div><div>xlog文件分析可参考 :&nbsp;</div><div><a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201312311244246/"   >http://blog.163.com/digoal@126/blog/static/163877040201312311244246/</a></div><div><br></div><div>[测试]</div><div><div>PostgreSQL 9.2 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table t(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_current_xlog_insert_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_insert_location&nbsp;</font></div><div><font size="2"   >---------------------------------</font></div><div><font size="2"   >&nbsp;1/A2019E50</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;1/A2019E50</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# insert into t select generate_series(1,1000000);</font></div><div><font size="2"   >INSERT 0 1000000</font></div><div><font size="2"   >digoal=# select pg_current_xlog_insert_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_insert_location&nbsp;</font></div><div><font size="2"   >---------------------------------</font></div><div><font size="2"   >&nbsp;1/A5D417C0</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;1/A5D417C0</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select pg_xlog_location_diff('1/A5D417C0','1/A2019E50');</font></div><div><font size="2"   >&nbsp;pg_xlog_location_diff&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64125296</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >PostgreSQL 9.3 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table t(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_current_xlog_insert_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_insert_location&nbsp;</font></div><div><font size="2"   >---------------------------------</font></div><div><font size="2"   >&nbsp;2/59A70730</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;2/59A70730</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# insert into t select generate_series(1,1000000);</font></div><div><font size="2"   >INSERT 0 1000000</font></div><div><font size="2"   >digoal=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;2/5D790660</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select pg_current_xlog_insert_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_insert_location&nbsp;</font></div><div><font size="2"   >---------------------------------</font></div><div><font size="2"   >&nbsp;2/5D790660</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select pg_xlog_location_diff('2/5D790660','2/59A70730');</font></div><div><font size="2"   >&nbsp;pg_xlog_location_diff&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64094000</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div>pg_xlogdump :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_xlogdump -b -n 10 -p $PGDATA/pg_xlog 00000003000000020000005D 00000003000000020000005D -x 12159136&nbsp;</font></div><div><font size="2"   >rmgr: Heap &nbsp; &nbsp; &nbsp; &nbsp;len (rec/tot): &nbsp; &nbsp; 31/ &nbsp; &nbsp;63, tx: &nbsp; 12159136, lsn: 2/5D794B90, prev 2/5D794B28, bkp: 0000, desc: insert(init): rel 1663/12815/17899; tid 0/1</font></div><div><font size="2"   >rmgr: Heap &nbsp; &nbsp; &nbsp; &nbsp;len (rec/tot): &nbsp; &nbsp; 31/ &nbsp; &nbsp;63, tx: &nbsp; 12159136, lsn: 2/5D794BD0, prev 2/5D794B90, bkp: 0000, desc: insert: rel 1663/12815/17899; tid 0/2</font></div><div><font size="2"   >rmgr: Heap &nbsp; &nbsp; &nbsp; &nbsp;len (rec/tot): &nbsp; &nbsp; 31/ &nbsp; &nbsp;63, tx: &nbsp; 12159136, lsn: 2/5D794C10, prev 2/5D794BD0, bkp: 0000, desc: insert: rel 1663/12815/17899; tid 0/3</font></div><div><font size="2"   >rmgr: Heap &nbsp; &nbsp; &nbsp; &nbsp;len (rec/tot): &nbsp; &nbsp; 31/ &nbsp; &nbsp;63, tx: &nbsp; 12159136, lsn: 2/5D794C50, prev 2/5D794C10, bkp: 0000, desc: insert: rel 1663/12815/17899; tid 0/4</font></div><div><font size="2"   >rmgr: Heap &nbsp; &nbsp; &nbsp; &nbsp;len (rec/tot): &nbsp; &nbsp; 31/ &nbsp; &nbsp;63, tx: &nbsp; 12159136, lsn: 2/5D794C90, prev 2/5D794C50, bkp: 0000, desc: insert: rel 1663/12815/17899; tid 0/5</font></div><div><font size="2"   >rmgr: Heap &nbsp; &nbsp; &nbsp; &nbsp;len (rec/tot): &nbsp; &nbsp; 31/ &nbsp; &nbsp;63, tx: &nbsp; 12159136, lsn: 2/5D794CD0, prev 2/5D794C90, bkp: 0000, desc: insert: rel 1663/12815/17899; tid 0/6</font></div><div><font size="2"   >rmgr: Heap &nbsp; &nbsp; &nbsp; &nbsp;len (rec/tot): &nbsp; &nbsp; 31/ &nbsp; &nbsp;63, tx: &nbsp; 12159136, lsn: 2/5D794D10, prev 2/5D794CD0, bkp: 0000, desc: insert: rel 1663/12815/17899; tid 0/7</font></div><div><font size="2"   >rmgr: Heap &nbsp; &nbsp; &nbsp; &nbsp;len (rec/tot): &nbsp; &nbsp; 31/ &nbsp; &nbsp;63, tx: &nbsp; 12159136, lsn: 2/5D794D50, prev 2/5D794D10, bkp: 0000, desc: insert: rel 1663/12815/17899; tid 0/8</font></div><div><font size="2"   >rmgr: Heap &nbsp; &nbsp; &nbsp; &nbsp;len (rec/tot): &nbsp; &nbsp; 31/ &nbsp; &nbsp;63, tx: &nbsp; 12159136, lsn: 2/5D794D90, prev 2/5D794D50, bkp: 0000, desc: insert: rel 1663/12815/17899; tid 0/9</font></div><div><font size="2"   >rmgr: Heap &nbsp; &nbsp; &nbsp; &nbsp;len (rec/tot): &nbsp; &nbsp; 31/ &nbsp; &nbsp;63, tx: &nbsp; 12159136, lsn: 2/5D794DD0, prev 2/5D794D90, bkp: 0000, desc: insert: rel 1663/12815/17899; tid 0/10</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/message-id/flat/4FDA5136.6080206@enterprisedb.com#4FDA5136.6080206@enterprisedb.com"   >http://www.postgresql.org/message-id/flat/4FDA5136.6080206@enterprisedb.com#4FDA5136.6080206@enterprisedb.com</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=061e7efb1b4c5b8a5d02122b7780531b8d5bf23d"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=061e7efb1b4c5b8a5d02122b7780531b8d5bf23d</a></div><div>3.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201312311244246/"   >http://blog.163.com/digoal@126/blog/static/163877040201312311244246/</a></div><div>4.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2012-06-24<span>	</span>Heikki Linnakangas<span>	</span>Use UINT64CONST for 64-bit integer constants.<span>	</span>commit | commitdiff | tree | snapshot</font></div><div><font size="2"   >2012-06-24<span>	</span>Heikki Linnakangas<span>	</span>Oops. Remove stray paren.<span>	</span>commit | commitdiff | tree | snapshot</font></div><div><font size="2"   >2012-06-24<span>	</span>Heikki Linnakangas<span>	</span>Use LL suffix for 64-bit constants.<span>	</span>commit | commitdiff | tree | snapshot</font></div><div><font size="2"   >2012-06-24<span>	</span>Heikki Linnakangas<span>	</span>Replace XLogRecPtr struct with a 64-bit integer.<span>	</span>commit | commitdiff | tree | snapshot</font></div><div><font size="2"   >2012-06-24<span>	</span>Heikki Linnakangas<span>	</span>Allow WAL record header to be split across pages.<span>	</span>commit | commitdiff | tree | snapshot</font></div><div><font size="2"   >2012-06-24<span>	</span>Heikki Linnakangas<span>	</span>Move WAL continuation record information to WAL page...<span>	</span>commit | commitdiff | tree | snapshot</font></div><div><font size="2"   >2012-06-24<span>	</span>Heikki Linnakangas<span>	</span>Don't waste the last segment of each 4GB logical log...<span>	</span>commit | commitdiff | tree | snapshot</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>