<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 Allow OLD and NEW in multi-row VALUES within rules</h2>
	<h5 id="">2013-05-09 14:01:55&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020134915429197/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>Allow OLD and NEW in multi-row VALUES within rules.</div><div>Now that we have LATERAL, it's fairly painless to allow this case, which</div><div>was left as a TODO in the original multi-row VALUES implementation.</div></div><div>简单来说就是允许规则触发的sql中在多行输入时使用new和old关键字.</div><div>rule的详细用法参见 :&nbsp;</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-createrule.html"   >http://www.postgresql.org/docs/devel/static/sql-createrule.html</a></div><div><br></div><div>[测试]</div><div>取自regress test.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;937 --</font></div><div><font size="2"   >&nbsp;938 -- check multi-rule VALUES in rules</font></div><div><font size="2"   >&nbsp;939 --</font></div><div><font size="2"   >&nbsp;940&nbsp;</font></div><div><font size="2"   >&nbsp;941 create table rules_src(f1 int, f2 int);</font></div><div><font size="2"   >&nbsp;942 create table rules_log(f1 int, f2 int, tag text);</font></div><div><font size="2"   >&nbsp;943 insert into rules_src values(1,2), (11,12);</font></div><div><font size="2"   >&nbsp;944 create rule r1 as on update to rules_src do also</font></div><div><font size="2"   >&nbsp;945 &nbsp; insert into rules_log values(old.*, 'old'), (new.*, 'new');</font></div><div><font size="2"   >&nbsp;946 update rules_src set f2 = f2 + 1;</font></div><div><font size="2"   >&nbsp;947 update rules_src set f2 = f2 * 10;</font></div><div><font size="2"   >&nbsp;948 select * from rules_src;</font></div><div><font size="2"   >&nbsp;949 select * from rules_log;</font></div><div><font size="2"   >&nbsp;950 create rule r2 as on update to rules_src do also</font></div><div><font size="2"   >&nbsp;951 &nbsp; values(old.*, 'old'), (new.*, 'new');</font></div><div><font size="2"   >&nbsp;952 update rules_src set f2 = f2 / 10;</font></div><div><font size="2"   >&nbsp;953 select * from rules_src;</font></div><div><font size="2"   >&nbsp;954 select * from rules_log;</font></div><div><font size="2"   >&nbsp;955 \d+ rules_src</font></div><p></p></pre></div><div><div>测试结果 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table rules_src(f1 int, f2 int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# create table rules_log(f1 int, f2 int, tag text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into rules_src values(1,2), (11,12);</font></div><div><font size="2"   >INSERT 0 2</font></div><div><font size="2"   >digoal=# create rule r1 as on update to rules_src do also</font></div><div><font size="2"   >postgres-# &nbsp; insert into rules_log values(old.*, 'old'), (new.*, 'new');</font></div><div><font size="2"   >CREATE RULE</font></div><div><font size="2"   >digoal=# update rules_src set f2 = f2 + 1;</font></div><div><font size="2"   >UPDATE 2</font></div><div><font size="2"   >digoal=# update rules_src set f2 = f2 * 10;</font></div><div><font size="2"   >UPDATE 2</font></div><div><font size="2"   >digoal=# select * from rules_src;</font></div><div><font size="2"   >&nbsp;f1 | f2 &nbsp;</font></div><div><font size="2"   >----+-----</font></div><div><font size="2"   >&nbsp; 1 | &nbsp;30</font></div><div><font size="2"   >&nbsp;11 | 130</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from rules_log;</font></div><div><font size="2"   >&nbsp;f1 | f2 &nbsp;| tag&nbsp;</font></div><div><font size="2"   >----+-----+-----</font></div><div><font size="2"   >&nbsp; 1 | &nbsp; 2 | old</font></div><div><font size="2"   >&nbsp; 1 | &nbsp; 3 | new</font></div><div><font size="2"   >&nbsp;11 | &nbsp;12 | old</font></div><div><font size="2"   >&nbsp;11 | &nbsp;13 | new</font></div><div><font size="2"   >&nbsp; 1 | &nbsp; 3 | old</font></div><div><font size="2"   >&nbsp; 1 | &nbsp;30 | new</font></div><div><font size="2"   >&nbsp;11 | &nbsp;13 | old</font></div><div><font size="2"   >&nbsp;11 | 130 | new</font></div><div><font size="2"   >(8 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# create rule r2 as on update to rules_src do also</font></div><div><font size="2"   >postgres-# &nbsp; values(old.*, 'old'), (new.*, 'new');</font></div><div><font size="2"   >CREATE RULE</font></div><div><font size="2"   >-- 这个有点意思, 相当于返回values中的内容. 类似update returning...</font></div><div><font size="2"   >digoal=# update rules_src set f2 = f2 / 10;</font></div><div><font size="2"   >&nbsp;column1 | column2 | column3&nbsp;</font></div><div><font size="2"   >---------+---------+---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp;30 | old</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; 3 | new</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 11 | &nbsp; &nbsp; 130 | old</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 11 | &nbsp; &nbsp; &nbsp;13 | new</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >UPDATE 2</font></div><div><font size="2"   >digoal=# select * from rules_src;</font></div><div><font size="2"   >&nbsp;f1 | f2&nbsp;</font></div><div><font size="2"   >----+----</font></div><div><font size="2"   >&nbsp; 1 | &nbsp;3</font></div><div><font size="2"   >&nbsp;11 | 13</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from rules_log;</font></div><div><font size="2"   >&nbsp;f1 | f2 &nbsp;| tag&nbsp;</font></div><div><font size="2"   >----+-----+-----</font></div><div><font size="2"   >&nbsp; 1 | &nbsp; 2 | old</font></div><div><font size="2"   >&nbsp; 1 | &nbsp; 3 | new</font></div><div><font size="2"   >&nbsp;11 | &nbsp;12 | old</font></div><div><font size="2"   >&nbsp;11 | &nbsp;13 | new</font></div><div><font size="2"   >&nbsp; 1 | &nbsp; 3 | old</font></div><div><font size="2"   >&nbsp; 1 | &nbsp;30 | new</font></div><div><font size="2"   >&nbsp;11 | &nbsp;13 | old</font></div><div><font size="2"   >&nbsp;11 | 130 | new</font></div><div><font size="2"   >&nbsp; 1 | &nbsp;30 | old</font></div><div><font size="2"   >&nbsp; 1 | &nbsp; 3 | new</font></div><div><font size="2"   >&nbsp;11 | 130 | old</font></div><div><font size="2"   >&nbsp;11 | &nbsp;13 | new</font></div><div><font size="2"   >(12 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# \d+ rules_src</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "public.rules_src"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers | Storage | Stats target | Description&nbsp;</font></div><div><font size="2"   >--------+---------+-----------+---------+--------------+-------------</font></div><div><font size="2"   >&nbsp;f1 &nbsp; &nbsp; | integer | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;f2 &nbsp; &nbsp; | integer | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >Rules:</font></div><div><font size="2"   >&nbsp; &nbsp; r1 AS</font></div><div><font size="2"   >&nbsp; &nbsp; ON UPDATE TO rules_src DO &nbsp;INSERT INTO rules_log (f1, f2, tag) VALUES (old.f1,old.f2,'old'::text), (new.f1,new.f2,'new'::text)</font></div><div><font size="2"   >&nbsp; &nbsp; r2 AS</font></div><div><font size="2"   >&nbsp; &nbsp; ON UPDATE TO rules_src DO &nbsp;VALUES (old.f1,old.f2,'old'::text), (new.f1,new.f2,'new'::text)</font></div><div><font size="2"   >Has OIDs: no</font></div><p></p></pre></div></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=092d7ded29f36b0539046b23b81b9f0bf2d637f1"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=092d7ded29f36b0539046b23b81b9f0bf2d637f1</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-createrule.html"   >http://www.postgresql.org/docs/devel/static/sql-createrule.html</a></div></div>
	</div>
</div>
</body>
</html>