<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL : WITH RECURSIVE Queries use case (Hierarchical Queries)</h2>
	<h5 id="">2011-04-28 16:43:50&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201132843255911/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">昨天那位同事又提出了新的问题，有一个场景需要异构查询：<br>如图：<br><div><img title="PostgreSQL : WITH RECURSIVE Queries use case (Hierarchical Queries) - 德哥@Digoal - The Heart,The World."  alt="PostgreSQL : WITH RECURSIVE Queries use case (Hierarchical Queries) - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img229.ph.126.net/mEBbZJKlvzqbEdESBR1U5A==/1463106928943642706.gif"  ></div>&nbsp;<br>假如2(t),3(t),4(f),5(t),6(f),<br>当输入条件为2并且附加条件为t时，需要查出2(t),3(t),4(f)<br><br>表结构:<br><br><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; \d tbl_role<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Table "digoal.tbl_role"<br>&nbsp;Column |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Modifiers <br>--------+-----------------------+-----------<br>&nbsp;id&nbsp;&nbsp;&nbsp;&nbsp; | integer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp; -- 唯一ID<br>&nbsp;code&nbsp;&nbsp; | character varying(32) |&nbsp; -- 树形结构代码<br>&nbsp;extend | boolean&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp; -- 是否可扩展</font></p></pre><br>数据:<br><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; select * from tbl_role order by code;<br>&nbsp;id |&nbsp;&nbsp;&nbsp;&nbsp; code&nbsp;&nbsp;&nbsp;&nbsp; | extend <br>----+--------------+--------<br>&nbsp; 1 | 001&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | t<br>&nbsp; 4 | 001001&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | t<br>&nbsp; 5 | 001002&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | f<br>&nbsp; 6 | 001003&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | f<br>&nbsp; 7 | 001003001&nbsp;&nbsp;&nbsp; | t<br>&nbsp;10 | 001005&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | t<br>&nbsp;11 | 001005001&nbsp;&nbsp;&nbsp; | f<br>&nbsp;11 | 001005001001 | t<br>&nbsp; 2 | 002&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | t<br>&nbsp; 8 | 002001&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | f<br>&nbsp; 3 | 003&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | t<br>&nbsp; 9 | 003001&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | f<br>(12 rows)</font></p></pre><br>思路:<br>因为这个兄弟设计的数型数据存储在一个字段code里面，所以首先要把对应的父级找出来，才好去做子级和父级的关联查询.<br>然后使用递归查询得出所要的结果.<br><br>具体实现:<br>例如要查询code='001',包含所有的扩展结果, (遇到extend=f时仅取出本条，下级的数据不取出) :<br><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; with recursive sub as&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>(<br>select id,code,coalesce(case when length(substring(code,1,length(code)-3))=0 then null else substring(code,1,length(code)-3) end,'root') parcode,extend from tbl_role where code ='001'<br>union<br>select d.* from (select id,code,coalesce(case when length(substring(code,1,length(code)-3))=0 then null else substring(code,1,length(code)-3) end,'root') parcode,extend from tbl_role where code like '001%') as d<br>join<br>sub as sd<br>on (d.parcode=sd.code and (sd.extend='t' or sd.parcode='root'))<br>)<br>select * from sub;<br>&nbsp;id |&nbsp;&nbsp; code&nbsp;&nbsp;&nbsp; | parcode | extend <br>----+-----------+---------+--------<br>&nbsp; 1 | 001&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | root&nbsp;&nbsp;&nbsp; | t<br>&nbsp; 4 | 001001&nbsp;&nbsp;&nbsp; | 001&nbsp;&nbsp;&nbsp;&nbsp; | t<br>&nbsp; 5 | 001002&nbsp;&nbsp;&nbsp; | 001&nbsp;&nbsp;&nbsp;&nbsp; | f<br>&nbsp; 6 | 001003&nbsp;&nbsp;&nbsp; | 001&nbsp;&nbsp;&nbsp;&nbsp; | f<br>&nbsp;10 | 001005&nbsp;&nbsp;&nbsp; | 001&nbsp;&nbsp;&nbsp;&nbsp; | t<br>&nbsp;11 | 001005001 | 001005&nbsp; | f<br>(6 rows)</font></p></pre><br>换个取code='001005'<br><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; with recursive sub as&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>(<br>select id,code,coalesce(case when length(substring(code,1,length(code)-3))=0 then null else substring(code,1,length(code)-3) end,'root') parcode,extend from tbl_role where code ='001005'<br>union<br>select d.* from (select id,code,coalesce(case when length(substring(code,1,length(code)-3))=0 then null else substring(code,1,length(code)-3) end,'root') parcode,extend from tbl_role where code like '001005%') as d<br>join<br>sub as sd<br>on (d.parcode=sd.code and (sd.extend='t' or sd.parcode='root'))<br>)<br>select * from sub;<br>&nbsp;id |&nbsp;&nbsp; code&nbsp;&nbsp;&nbsp; | parcode | extend <br>----+-----------+---------+--------<br>&nbsp;10 | 001005&nbsp;&nbsp;&nbsp; | 001&nbsp;&nbsp;&nbsp;&nbsp; | t<br>&nbsp;11 | 001005001 | 001005&nbsp; | f<br>(2 rows)</font></p></pre><div><br></div><div>多个code的场景</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; with recursive sub as &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >(</font></div><div><font size="2"  >select id,code,coalesce(case when length(substring(code,1,length(code)-3))=0 then null else substring(code,1,length(code)-3) end,'root') parcode,extend from tbl_role where code in ('001005','001003')</font></div><div><font size="2"  >union</font></div><div><font size="2"  >select d.* from (select id,code,coalesce(case when length(substring(code,1,length(code)-3))=0 then null else substring(code,1,length(code)-3) end,'root') parcode,extend from tbl_role where (code like '001005%' or code like '001003%')) as d</font></div><div><font size="2"  >join</font></div><div><font size="2"  >sub as sd</font></div><div><font size="2"  >on (d.parcode=sd.code and (sd.extend='t' or sd.parcode='root'))</font></div><div><font size="2"  >)</font></div><div><font size="2"  >select * from sub;</font></div><div><font size="2"  >&nbsp;id | &nbsp; code &nbsp; &nbsp;| parcode | extend&nbsp;</font></div><div><font size="2"  >----+-----------+---------+--------</font></div><div><font size="2"  >&nbsp;&nbsp;6 | 001003 &nbsp; &nbsp;| 001 &nbsp; &nbsp; | f</font></div><div><font size="2"  >&nbsp;10 | 001005 &nbsp; &nbsp;| 001 &nbsp; &nbsp; | t</font></div><div><font size="2"  >&nbsp;11 | 001005001 | 001005 &nbsp;| f</font></div><div><font size="2"  >(3 rows)</font></div><p></p></pre></div><br>小结：<br>PostgreSQL的with recursive查询提供了类似ORACLE的<pre><pre class="prettyprint"  ><p><font size="2"  >[ <b>START WITH</b> condition ] <b>CONNECT BY</b> [ <b>NOCYCLE</b> ] condition</font></p></pre></pre>的异构查询功能。<br><br>参考 : <br>http://wiki.postgresql.org/wiki/CTEReadme<br>http://www.postgresql.org/docs/9.0/static/queries-with.html</div><div><br></div><div><br></div><div>补充,另外一个更简易的树形查询的例子:</div><div>TABLE:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# &nbsp;\d tbl_menu</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Table "public.tbl_menu"</font></div><div><font size="2"  >&nbsp; &nbsp;Column &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; Modifiers &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >------------+-----------------------------+---------------------------</font></div><div><font size="2"  >&nbsp;id &nbsp; &nbsp; &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"  >&nbsp;name &nbsp; &nbsp; &nbsp; | character varying(50) &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"  >&nbsp;parentid &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"  >&nbsp;type &nbsp; &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"  >&nbsp;status &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"  >&nbsp;grade &nbsp; &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"  >&nbsp;filename &nbsp; | character varying(50) &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;md5 &nbsp; &nbsp; &nbsp; &nbsp;| character varying(50) &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;brief &nbsp; &nbsp; &nbsp;| character varying(500) &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;orderid &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null default 99999999</font></div><div><font size="2"  >&nbsp;updatetime | timestamp without time zone |&nbsp;</font></div><div><font size="2"  >&nbsp;createtime | timestamp without time zone | default now()</font></div><p></p></pre></div><div><br></div><div>DATA:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select * from tbl_menu;</font></div><div><font size="2"  >&nbsp;id | &nbsp;name &nbsp;| parentid | type | status | grade | filename | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; md5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;brief &nbsp; | orderid &nbsp;| &nbsp; &nbsp; &nbsp; updateti</font></div><div><font size="2"  >me &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; createtime &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----+--------+----------+------+--------+-------+----------+----------------------------------+----------+----------+---------------</font></div><div><font size="2"  >----------+----------------------------</font></div><div><font size="2"  >&nbsp;18 | 言情 &nbsp; | &nbsp; &nbsp; &nbsp; 14 | &nbsp; &nbsp;4 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| d41d8cd98f00b204e9800998ecf8427e | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;2 | 2011-05-19 14:</font></div><div><font size="2"  >41:17.287 | 2011-05-19 14:37:44.11</font></div><div><font size="2"  >&nbsp;19 | 玄幻 &nbsp; | &nbsp; &nbsp; &nbsp; 14 | &nbsp; &nbsp;4 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | 1.png &nbsp; &nbsp;| ad5df343eb6b83d3e1100bdbccf98264 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;3 | 2011-05-19 14:</font></div><div><font size="2"  >41:25.287 | 2011-05-19 14:38:06.39</font></div><div><font size="2"  >&nbsp;20 | 明星 &nbsp; | &nbsp; &nbsp; &nbsp; 13 | &nbsp; &nbsp;3 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | 1.png &nbsp; &nbsp;| ad5df343eb6b83d3e1100bdbccf98264 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 99999999 | 2011-05-19 15:</font></div><div><font size="2"  >39:24.118 | 2011-05-19 15:34:38.719</font></div><div><font size="2"  >&nbsp;21 | 免费 &nbsp; | &nbsp; &nbsp; &nbsp; 12 | &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| d41d8cd98f00b204e9800998ecf8427e | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 99999999 | 2011-05-19 20:</font></div><div><font size="2"  >06:30.016 | 2011-05-19 20:06:30.016</font></div><div><font size="2"  >&nbsp;22 | 专辑 &nbsp; | &nbsp; &nbsp; &nbsp; 11 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | 1.png &nbsp; &nbsp;| ad5df343eb6b83d3e1100bdbccf98264 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 99999999 | 2011-05-19 20:</font></div><div><font size="2"  >06:43.328 | 2011-05-19 20:06:43.328</font></div><div><font size="2"  >&nbsp;25 | 复古 &nbsp; | &nbsp; &nbsp; &nbsp; 22 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| d41d8cd98f00b204e9800998ecf8427e | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;1 | 2011-05-19 21:</font></div><div><font size="2"  >45:47.459 | 2011-05-19 21:45:47.459</font></div><div><font size="2"  >&nbsp;24 | 流行 &nbsp; | &nbsp; &nbsp; &nbsp; 22 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;26 | 1.png &nbsp; &nbsp;| ad5df343eb6b83d3e1100bdbccf98264 | 流行音乐 | &nbsp; &nbsp; &nbsp; &nbsp;2 | 2011-05-19 21:</font></div><div><font size="2"  >45:54.365 | 2011-05-19 21:41:51.749</font></div><div><font size="2"  >&nbsp;35 | 高清 &nbsp; | &nbsp; &nbsp; &nbsp; 33 | &nbsp; &nbsp;6 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| d41d8cd98f00b204e9800998ecf8427e | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;1 | 2011-05-23 14:</font></div><div><font size="2"  >07:44.659 | 2011-05-23 14:07:44.659</font></div><div><font size="2"  >&nbsp;36 | 明星 &nbsp; | &nbsp; &nbsp; &nbsp; 33 | &nbsp; &nbsp;6 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;26 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| d41d8cd98f00b204e9800998ecf8427e | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;2 | 2011-05-23 14:</font></div><div><font size="2"  >08:04.175 | 2011-05-23 14:08:04.175</font></div><div><font size="2"  >&nbsp;37 | 浙江 &nbsp; | &nbsp; &nbsp; &nbsp; 34 | &nbsp; &nbsp;5 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| d41d8cd98f00b204e9800998ecf8427e | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;1 | 2011-05-23 14:</font></div><div><font size="2"  >11:56.77 &nbsp;| 2011-05-23 14:11:56.77</font></div><div><font size="2"  >&nbsp;11 | 音乐 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;1 | 2011-05-23 14:</font></div><div><font size="2"  >12:08.411 | 2011-05-19 14:25:24.966436</font></div><div><font size="2"  >&nbsp;12 | 视频 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;2 | 2011-05-23 14:</font></div><div><font size="2"  >12:17.192 | 2011-05-19 14:25:37.569062</font></div><div><font size="2"  >&nbsp;13 | 图酷 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp;3 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;3 | 2011-05-23 14:</font></div><div><font size="2"  >12:22.896 | 2011-05-19 14:25:47.118481</font></div><div><font size="2"  >&nbsp;14 | 书籍 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp;4 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;4 | 2011-05-23 14:</font></div><div><font size="2"  >12:29.317 | 2011-05-19 14:26:11.781762</font></div><div><font size="2"  >&nbsp;34 | 直播 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp;5 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;5 | 2011-05-23 14:</font></div><div><font size="2"  >12:34.786 | 2011-05-19 14:25:24.966436</font></div><div><font size="2"  >&nbsp;33 | 点播 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp;6 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;6 | 2011-05-23 14:</font></div><div><font size="2"  >12:38.567 | 2011-05-19 14:25:24.966436</font></div><div><font size="2"  >&nbsp;38 | 北京 &nbsp; | &nbsp; &nbsp; &nbsp; 34 | &nbsp; &nbsp;5 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| d41d8cd98f00b204e9800998ecf8427e | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;1 | 2011-05-23 14:</font></div><div><font size="2"  >13:37.162 | 2011-05-23 14:13:37.162</font></div><div><font size="2"  >&nbsp;39 | 漫画 &nbsp; | &nbsp; &nbsp; &nbsp; 13 | &nbsp; &nbsp;3 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| d41d8cd98f00b204e9800998ecf8427e | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;1 | 2011-05-23 14:</font></div><div><font size="2"  >28:56.777 | 2011-05-23 14:28:56.777</font></div><div><font size="2"  >&nbsp;40 | 刘德华 | &nbsp; &nbsp; &nbsp; 25 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| d41d8cd98f00b204e9800998ecf8427e | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;1 | 2011-05-25 15:</font></div><div><font size="2"  >36:33.139 | 2011-05-25 15:36:33.139</font></div><div><font size="2"  >(19 rows)</font></div><p></p></pre></div><div><br></div><div>向上查询:</div><div><pre class="prettyprint"  ><p></p><div><div><div><font size="2"  >with recursive t_result as &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >(</font></div><div><font size="2"  >select id,name,parentid,type,status,grade,filename,md5,brief,orderid,updatetime,createtime from tbl_menu as t_initial where name ~ '刘德华'</font></div><div><font size="2"  >union</font></div><div><font size="2"  >select t_working.id,t_working.name,t_working.parentid,t_working.type,t_working.status,t_working.grade,t_working.filename,t_working.md5,t_working.brief,t_working.orderid,t_working.updatetime,t_working.createtime from tbl_menu as t_working</font></div><div><font size="2"  >join</font></div><div><font size="2"  >t_result</font></div><div><font size="2"  >on (t_result.parentid=t_working.id)</font></div><div><font size="2"  >)</font></div><div><font size="2"  >select id,name,parentid,type,status,grade,filename,md5,brief,orderid,updatetime,createtime from t_result;</font></div></div></div><div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp;id | &nbsp;name &nbsp;| parentid | type | status | grade | filename | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; md5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| brief | orderid &nbsp;| &nbsp; &nbsp; &nbsp; updatetime&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; createtime &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----+--------+----------+------+--------+-------+----------+----------------------------------+-------+----------+------------------</font></div><div><font size="2"  >-------+----------------------------</font></div><div><font size="2"  >&nbsp;40 | 刘德华 | &nbsp; &nbsp; &nbsp; 25 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| d41d8cd98f00b204e9800998ecf8427e | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;1 | 2011-05-25 15:36:</font></div><div><font size="2"  >33.139 | 2011-05-25 15:36:33.139</font></div><div><font size="2"  >&nbsp;25 | 复古 &nbsp; | &nbsp; &nbsp; &nbsp; 22 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| d41d8cd98f00b204e9800998ecf8427e | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;1 | 2011-05-19 21:45:</font></div><div><font size="2"  >47.459 | 2011-05-19 21:45:47.459</font></div><div><font size="2"  >&nbsp;22 | 专辑 &nbsp; | &nbsp; &nbsp; &nbsp; 11 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | 1.png &nbsp; &nbsp;| ad5df343eb6b83d3e1100bdbccf98264 | &nbsp; &nbsp; &nbsp; | 99999999 | 2011-05-19 20:06:</font></div><div><font size="2"  >43.328 | 2011-05-19 20:06:43.328</font></div><div><font size="2"  >&nbsp;11 | 音乐 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;1 | 2011-05-23 14:12:</font></div><div><font size="2"  >08.411 | 2011-05-19 14:25:24.966436</font></div><div><font size="2"  >(4 rows)</font></div></div><p></p></pre></div><div><br></div><div>向下查询:</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >with recursive t_result as &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >(</font></div><div><font size="2"  >select id,name,parentid,type,status,grade,filename,md5,brief,orderid,updatetime,createtime from tbl_menu as t_initial where name ~ '音乐'</font></div><div><font size="2"  >union</font></div><div><font size="2"  >select t_working.id,t_working.name,t_working.parentid,t_working.type,t_working.status,t_working.grade,t_working.filename,t_working.md5,t_working.brief,t_working.orderid,t_working.updatetime,t_working.createtime from tbl_menu as t_working</font></div><div><font size="2"  >join</font></div><div><font size="2"  >t_result</font></div><div><font size="2"  >on (t_working.parentid=t_result.id)</font></div><div><font size="2"  >)</font></div><div><font size="2"  >select id,name,parentid,type,status,grade,filename,md5,brief,orderid,updatetime,createtime from t_result;</font></div></div><div><div><font size="2"  >&nbsp;id | &nbsp;name &nbsp;| parentid | type | status | grade | filename | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; md5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;brief &nbsp; | orderid &nbsp;| &nbsp; &nbsp; &nbsp; updateti</font></div><div><font size="2"  >me &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; createtime &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----+--------+----------+------+--------+-------+----------+----------------------------------+----------+----------+---------------</font></div><div><font size="2"  >----------+----------------------------</font></div><div><font size="2"  >&nbsp;11 | 音乐 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;1 | 2011-05-23 14:</font></div><div><font size="2"  >12:08.411 | 2011-05-19 14:25:24.966436</font></div><div><font size="2"  >&nbsp;22 | 专辑 &nbsp; | &nbsp; &nbsp; &nbsp; 11 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | 1.png &nbsp; &nbsp;| ad5df343eb6b83d3e1100bdbccf98264 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 99999999 | 2011-05-19 20:</font></div><div><font size="2"  >06:43.328 | 2011-05-19 20:06:43.328</font></div><div><font size="2"  >&nbsp;25 | 复古 &nbsp; | &nbsp; &nbsp; &nbsp; 22 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| d41d8cd98f00b204e9800998ecf8427e | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;1 | 2011-05-19 21:</font></div><div><font size="2"  >45:47.459 | 2011-05-19 21:45:47.459</font></div><div><font size="2"  >&nbsp;24 | 流行 &nbsp; | &nbsp; &nbsp; &nbsp; 22 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;26 | 1.png &nbsp; &nbsp;| ad5df343eb6b83d3e1100bdbccf98264 | 流行音乐 | &nbsp; &nbsp; &nbsp; &nbsp;2 | 2011-05-19 21:</font></div><div><font size="2"  >45:54.365 | 2011-05-19 21:41:51.749</font></div><div><font size="2"  >&nbsp;40 | 刘德华 | &nbsp; &nbsp; &nbsp; 25 | &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;24 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| d41d8cd98f00b204e9800998ecf8427e | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;1 | 2011-05-25 15:</font></div><div><font size="2"  >36:33.139 | 2011-05-25 15:36:33.139</font></div><div><font size="2"  >(5 rows)</font></div></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>