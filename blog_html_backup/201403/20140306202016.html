<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Attention: PostgreSQL Use gdb close ($filedescripts) when process zombied instead of pg_terminate_backend and pg_cancel_backend</h2>
	<h5 id="">2014-03-06 20:20:16&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020142653317582/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><span style="line-height: 28px;"   >在某些特殊情况下, 数据库中一些进程使用pg_terminate_backend或者pg_cancel_backend函数去中断会话或者中断正在运行的SQL时, 这两个函数返回true, 但是实际上却无法达到预期的</span><span style="line-height: 28px;"   >中断会话或者中断正在运行的SQL的目的, 这个进程照样还在那里, 就像 僵尸一样.</span></div><div>比如这个场景, 一个查询跑了几个小时, 使用pg_terminate_backend或者pg_cancel_backend无法正常的杀掉 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select pg_terminate_backend(pid),pg_cancel_backend(pid),pid,query_start,client_addr,query from pg_stat_activity where pid=28414;</font></div><div><font size="2"   >-[ RECORD 1 ]--------+------------------------------------</font></div><div><font size="2"   >pg_terminate_backend | t</font></div><div><font size="2"   >pg_cancel_backend &nbsp; &nbsp;| t</font></div><div><font size="2"   >pid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 28414</font></div><div><font size="2"   >query_start &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2014-03-06 15:00:02.385606+08</font></div><div><font size="2"   >client_addr &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| xxxx</font></div><div><font size="2"   >query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| select ....</font></div><p></p></pre></div><div>怎么杀也杀不掉, 在使用pg_terminate_backend和pg_cancel_backend时:</div><div><div style="line-height: 28px;"   >使用strace跟踪到这个进程的输出如下, 有接收到这两个函数发出的SIGINT (cancel)和SIGTERM (terminate)信号, 但是没有退出的动作.</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >strace -p&nbsp;<span style="line-height: 28px;"   >28414</span></font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >Process 28414 attached - interrupt to quit</font></div><div style="line-height: 28px;"   ><font size="2"   >sendto(9, "\0\0\0\32\0\2\0\0\0\t212473390\0\0\0\003250D\0\0\0\32\0"..., 6336, 0, NULL, 0) = ? ERESTARTSYS (To be restarted)</font></div><div style="line-height: 28px;"   ><font size="2"   >--- SIGTERM (Terminated) @ 0 (0) ---</font></div><div style="line-height: 28px;"   ><font size="2"   >rt_sigreturn(0x7fd0fde25d7c) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 44</font></div><div style="line-height: 28px;"   ><font size="2"   >sendto(9, "\0\0\0\32\0\2\0\0\0\t212473390\0\0\0\003250D\0\0\0\32\0"..., 6336, 0, NULL, 0) = ? ERESTARTSYS (To be restarted)</font></div><div style="line-height: 28px;"   ><font size="2"   >--- SIGINT (Interrupt) @ 0 (0) ---</font></div><div style="line-height: 28px;"   ><font size="2"   >--- SIGTERM (Terminated) @ 0 (0) ---</font></div><div style="line-height: 28px;"   ><font size="2"   >rt_sigreturn(0x7fd0fde25d7c) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div><div style="line-height: 28px;"   ><font size="2"   >rt_sigreturn(0x7fd0fde25d7c) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 44</font></div><div style="line-height: 28px;"   ><font size="2"   >sendto(9, "\0\0\0\32\0\2\0\0\0\t212473390\0\0\0\003250D\0\0\0\32\0"..., 6336, 0, NULL, 0) = ? ERESTARTSYS (To be restarted)</font></div><div style="line-height: 28px;"   ><font size="2"   >--- SIGTERM (Terminated) @ 0 (0) ---</font></div><div style="line-height: 28px;"   ><font size="2"   >rt_sigreturn(0x7fd0fde25d7c) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 44</font></div></div><p></p></pre></div></div></div><div><br></div><div>正常的话pg_cancel_backen后, 应该进行类似如下的响应</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >--- SIGINT (Interrupt) @ 0 (0) ---</font></div><div><font size="2"   >rt_sigreturn(0x7fdc1febd71c) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 32768</font></div><div><font size="2"   >rt_sigprocmask(SIG_SETMASK, [], NULL, 8) = 0</font></div><div><font size="2"   >sendto(9, "T\0\0\0\36\0\1count\0\0\0\0\0\0\0\0\0\0\24\0\10\377\377\377\377\0\0E"..., 129, 0, NULL, 0) = 129 -- 关闭打开的网络会话请求</font></div><div><font size="2"   >rt_sigprocmask(SIG_SETMASK, [], NULL, 8) = 0</font></div><div><font size="2"   >munmap(0x7fdb9d90f000, 528384) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div><div><font size="2"   >munmap(0x7fdb9d990000, 266240) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div><div><font size="2"   >munmap(0x7fdb9d9d1000, 135168) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div><div><font size="2"   >munmap(0x7fdb9d8ea000, 151552) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div><div><font size="2"   >close(12) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = 0  -- 关闭文件</font></div><div><font size="2"   >stat("base/pgsql_tmp/pgsql_tmp19515.3", {st_mode=S_IFREG|0600, st_size=570425344, ...}) = 0</font></div><div><font size="2"   >unlink("base/pgsql_tmp/pgsql_tmp19515.3") = 0</font></div><div><font size="2"   >sendto(8, "\17\0\0\0\30\0\0\0\0@\0\0003\0\0\0\0\0\0\"\0\0\0\0", 24, 0, NULL, 0) = 24  -- 关闭打开的网络会话请求</font></div><div><font size="2"   >close(11) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = 0</font></div><div><font size="2"   >stat("base/pgsql_tmp/pgsql_tmp19515.2", {st_mode=S_IFREG|0600, st_size=1073741824, ...}) = 0</font></div><div><font size="2"   >unlink("base/pgsql_tmp/pgsql_tmp19515.2") = 0</font></div><div><font size="2"   >sendto(8, "\17\0\0\0\30\0\0\0\0@\0\0\0\0\0\0\0\0\0@\0\0\0\0", 24, 0, NULL, 0) = 24</font></div><div><font size="2"   >close(10) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = 0</font></div><div><font size="2"   >stat("base/pgsql_tmp/pgsql_tmp19515.1", {st_mode=S_IFREG|0600, st_size=1073741824, ...}) = 0</font></div><div><font size="2"   >unlink("base/pgsql_tmp/pgsql_tmp19515.1") = 0</font></div><div><font size="2"   >sendto(8, "\17\0\0\0\30\0\0\0\0@\0\0\0\0\0\0\0\0\0@\0\0\0\0", 24, 0, NULL, 0) = 24</font></div><div><font size="2"   >close(7) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div><div><font size="2"   >stat("base/pgsql_tmp/pgsql_tmp19515.0", {st_mode=S_IFREG|0600, st_size=1073741824, ...}) = 0</font></div><div><font size="2"   >unlink("base/pgsql_tmp/pgsql_tmp19515.0") = 0</font></div><div><font size="2"   >sendto(8, "\17\0\0\0\30\0\0\0\0@\0\0\0\0\0\0\0\0\0@\0\0\0\0", 24, 0, NULL, 0) = 24</font></div><div><font size="2"   >sendto(8, "\2\0\0\0\320\3\0\0\0@\0\0\t\0\0\0\0\0\0\0\1\0\0\0\0\0\0\0\0\0\0\0"..., 976, 0, NULL, 0) = 976</font></div><div><font size="2"   >sendto(8, "\2\0\0\0\370\0\0\0\0@\0\0\2\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"..., 248, 0, NULL, 0) = 248</font></div><div><font size="2"   >sendto(9, "Z\0\0\0\5I", 6, 0, NULL, 0) &nbsp;= 6</font></div><div><font size="2"   >recvfrom(9, "X\0\0\0\4", 8192, 0, NULL, NULL) = 5</font></div><div><font size="2"   >write(2, "\0\0\37\1;L\0\0T2014-03-06 11:44:13.955"..., 296) = 296</font></div><div><font size="2"   >exit_group(0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = ?</font></div><p></p></pre></div><div><br></div><div>如果收到pg_terminate_backend发出的信号, 正常的响应如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >--- SIGTERM (Terminated) @ 0 (0) ---</font></div><div><font size="2"   >rt_sigreturn(0x7fdc1febd71c) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 25380</font></div><div><font size="2"   >write(2, "\0\0000\1DM\0\0T2014-03-06 11:45:36.059"..., 313) = 313</font></div><div><font size="2"   >sendto(9, "T\0\0\0\36\0\1count\0\0\0\0\0\0\0\0\0\0\24\0\10\377\377\377\377\0\0E"..., 141, 0, NULL, 0) = 141</font></div><div><font size="2"   >rt_sigprocmask(SIG_SETMASK, [], NULL, 8) = 0</font></div><div><font size="2"   >munmap(0x7fdb9d90f000, 528384) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div><div><font size="2"   >munmap(0x7fdb9d990000, 266240) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div><div><font size="2"   >munmap(0x7fdb9d9d1000, 135168) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div><div><font size="2"   >munmap(0x7fdb9d8ea000, 151552) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div><div><font size="2"   >close(10) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = 0</font></div><div><font size="2"   >stat("base/pgsql_tmp/pgsql_tmp19780.1", {st_mode=S_IFREG|0600, st_size=652673024, ...}) = 0</font></div><div><font size="2"   >unlink("base/pgsql_tmp/pgsql_tmp19780.1") = 0</font></div><div><font size="2"   >sendto(8, "\17\0\0\0\30\0\0\0\0@\0\0\377\177\0\0\0\0\347&amp;\0\0\0\0", 24, 0, NULL, 0) = 24</font></div><div><font size="2"   >close(7) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div><div><font size="2"   >stat("base/pgsql_tmp/pgsql_tmp19780.0", {st_mode=S_IFREG|0600, st_size=1073741824, ...}) = 0</font></div><div><font size="2"   >unlink("base/pgsql_tmp/pgsql_tmp19780.0") = 0</font></div><div><font size="2"   >sendto(8, "\17\0\0\0\30\0\0\0\0@\0\0\0\0\0\0\0\0\0@\0\0\0\0", 24, 0, NULL, 0) = 24</font></div><div><font size="2"   >sendto(8, "\2\0\0\0\320\3\0\0\0@\0\0\t\0\0\0\0\0\0\0\1\0\0\0\0\0\0\0\0\0\0\0"..., 976, 0, NULL, 0) = 976</font></div><div><font size="2"   >sendto(8, "\2\0\0\0\370\0\0\0\0@\0\0\2\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"..., 248, 0, NULL, 0) = 248</font></div><div><font size="2"   >write(2, "\0\0!\1DM\0\0T2014-03-06 11:45:36.710"..., 298) = 298</font></div><div><font size="2"   >exit_group(1) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = ?</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >显然, 会话处于ESTABLISHED状态, 但实际上在strace中未看到有任何数据发给客户端.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># netstat -anop|grep 28414</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 690752 xxx.xxx.xxx.xxx:xxxx &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xxx.xxx.xxx.xxx:xxxx &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESTABLISHED 28414/postgres &nbsp; &nbsp; &nbsp;probe (20.76/0/0)</font></div><p></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >使用lsof或者proc/$pid/fd可以看到这个进程打开的文件描述符, TCP|UDP SOCK等等.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># lsof -np 28414</font></div><div><font size="2"   >COMMAND &nbsp; &nbsp;PID &nbsp; &nbsp; USER &nbsp; FD &nbsp; TYPE &nbsp;DEVICE &nbsp; SIZE/OFF &nbsp; &nbsp; NODE NAME</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;cwd &nbsp; &nbsp;DIR &nbsp; &nbsp; 8,5 &nbsp; &nbsp; &nbsp; 4096 11796483 /data01/pgdata/digoal/pg_root</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;rtd &nbsp; &nbsp;DIR &nbsp; &nbsp; 8,2 &nbsp; &nbsp; &nbsp; 4096 &nbsp; &nbsp; &nbsp; &nbsp;2 /</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;txt &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp;5899085 &nbsp;3810234 /opt/pgsql9.3.3/bin/postgres</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp; &nbsp;65928 &nbsp;2885812 /lib64/libnss_files-2.12.so</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;DEL &nbsp; &nbsp;REG &nbsp; &nbsp; 0,4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 21050 /dev/zero</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp; &nbsp;32816 &nbsp;3811061 /opt/pgsql9.3.3/lib/pg_stat_statements.so</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; 99158576 &nbsp;2623572 /usr/lib/locale/locale-archive</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp; 122040 &nbsp;2885890 /lib64/libselinux.so.1</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp; 142640 &nbsp;2885820 /lib64/libpthread-2.12.so</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp; 110960 &nbsp;2885822 /lib64/libresolv-2.12.so</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp; &nbsp;10192 &nbsp;2887631 /lib64/libkeyutils.so.1.3</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp; &nbsp;43728 &nbsp;2887642 /lib64/libkrb5support.so.0.1</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp; 383504 &nbsp;2885789 /lib64/libfreebl3.so</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp; 174840 &nbsp;2887638 /lib64/libk5crypto.so.3.1</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp; &nbsp;14664 &nbsp;2885887 /lib64/libcom_err.so.2.1</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp; 941920 &nbsp;2887640 /lib64/libkrb5.so.3.3</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp; 277704 &nbsp;2887634 /lib64/libgssapi_krb5.so.2.2</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp; &nbsp;40400 &nbsp;2885800 /lib64/libcrypt-2.12.so</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp; 113096 &nbsp;2885861 /lib64/libaudit.so.1.0.0</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp; &nbsp;88600 &nbsp;2885853 /lib64/libz.so.1.2.3</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp;1921216 &nbsp;2885796 /lib64/libc-2.12.so</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp; 596264 &nbsp;2885804 /lib64/libm-2.12.so</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp; &nbsp;19536 &nbsp;2885802 /lib64/libdl-2.12.so</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp;1950976 &nbsp;2623419 /usr/lib64/libcrypto.so.1.0.1e</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp; 437016 &nbsp;2623421 /usr/lib64/libssl.so.1.0.1e</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp; &nbsp;55848 &nbsp;2887163 /lib64/libpam.so.0.82.2</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp;1380832 &nbsp;2622910 /usr/lib64/libxml2.so.2.7.6</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;mem &nbsp; &nbsp;REG &nbsp; &nbsp; 8,2 &nbsp; &nbsp; 154520 &nbsp;2885787 /lib64/ld-2.12.so</font></div><div><font size="2"   >postgres 28414 postgres &nbsp;DEL &nbsp; &nbsp;REG &nbsp; &nbsp; 0,4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 32768 /SYSV001d4fe9</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; &nbsp;0r &nbsp; CHR &nbsp; &nbsp; 1,3 &nbsp; &nbsp; &nbsp; &nbsp;0t0 &nbsp; &nbsp; 3842 /dev/null</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; &nbsp;1w &nbsp;FIFO &nbsp; &nbsp; 0,8 &nbsp; &nbsp; &nbsp; &nbsp;0t0 &nbsp; &nbsp;21054 pipe</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; &nbsp;2w &nbsp;FIFO &nbsp; &nbsp; 0,8 &nbsp; &nbsp; &nbsp; &nbsp;0t0 &nbsp; &nbsp;21054 pipe</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; &nbsp;3r &nbsp;FIFO &nbsp; &nbsp; 0,8 &nbsp; &nbsp; &nbsp; &nbsp;0t0 &nbsp;6152911 pipe</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; &nbsp;4w &nbsp;FIFO &nbsp; &nbsp; 0,8 &nbsp; &nbsp; &nbsp; &nbsp;0t0 &nbsp;6152911 pipe</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; &nbsp;5r &nbsp;FIFO &nbsp; &nbsp; 0,8 &nbsp; &nbsp; &nbsp; &nbsp;0t0 &nbsp; &nbsp;21053 pipe</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; &nbsp;6u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp; 8192 &nbsp;9569391 /data03/pgdata/digoal/PG_9.3_201306121/35022/12698</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; &nbsp;7u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; 212992 &nbsp;9569289 /data03/pgdata/digoal/PG_9.3_201306121/35022/12657</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; &nbsp;8u &nbsp;IPv4 &nbsp; 21061 &nbsp; &nbsp; &nbsp; &nbsp;0t0 &nbsp; &nbsp; &nbsp;UDP 127.0.0.1:51056-&gt;127.0.0.1:51056&nbsp;</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; &nbsp;9u &nbsp;IPv4 6152910 &nbsp; &nbsp; &nbsp; &nbsp;0t0 &nbsp; &nbsp; &nbsp;TCP xxx.xxx.xxx.xxx:noadmin-&gt;xxx.xxx.xxx.xxx:4807 (ESTABLISHED)</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 10u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; 524288 &nbsp;9569240 /data03/pgdata/digoal/PG_9.3_201306121/35022/12651</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 11u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp;16384 &nbsp;9569222 /data03/pgdata/digoal/PG_9.3_201306121/35022/12720</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 12u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp; 8192 &nbsp;9569300 /data03/pgdata/digoal/PG_9.3_201306121/35022/12718</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 13u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp;73728 &nbsp;9569410 /data03/pgdata/digoal/PG_9.3_201306121/35022/12656</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 14u &nbsp; REG &nbsp; &nbsp;8,33 1073741824 &nbsp;9569883 /data03/pgdata/digoal/PG_9.3_201306121/35022/35443</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 15u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp;109903872 &nbsp;9570014 /data03/pgdata/digoal/PG_9.3_201306121/35022/35443.1</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 16u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; 28295168 &nbsp;9569985 /data03/pgdata/digoal/PG_9.3_201306121/35022/35670</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 17u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; 63946752 &nbsp;9569995 /data03/pgdata/digoal/PG_9.3_201306121/35022/35680</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 18u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; 55189504 &nbsp;9569997 /data03/pgdata/digoal/PG_9.3_201306121/35022/35682</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 19u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp;73728 &nbsp;9569909 /data03/pgdata/digoal/PG_9.3_201306121/35022/35502</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 20u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp;9569967 /data03/pgdata/digoal/PG_9.3_201306121/35022/35638 (deleted)</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 21u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp;9569998 /data03/pgdata/digoal/PG_9.3_201306121/35022/35683 (deleted)</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 22u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp; 8192 &nbsp;9569911 /data03/pgdata/digoal/PG_9.3_201306121/35022/35507</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 23u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp;9569968 /data03/pgdata/digoal/PG_9.3_201306121/35022/35640 (deleted)</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 24u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp; 8192 &nbsp;9569939 /data03/pgdata/digoal/PG_9.3_201306121/35022/35577</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 25u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp;9569980 /data03/pgdata/digoal/PG_9.3_201306121/35022/35664 (deleted)</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 26u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp; 8192 &nbsp;9569865 /data03/pgdata/digoal/PG_9.3_201306121/35022/35400</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 27u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp;9569953 /data03/pgdata/digoal/PG_9.3_201306121/35022/35610 (deleted)</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 28u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp;3211264 &nbsp;9569898 /data03/pgdata/digoal/PG_9.3_201306121/35022/35477</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 29u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp;9569964 /data03/pgdata/digoal/PG_9.3_201306121/35022/35632 (deleted)</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 30u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp;9569906 /data03/pgdata/digoal/PG_9.3_201306121/35022/35495 (deleted)</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 31u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp;9569996 /data03/pgdata/digoal/PG_9.3_201306121/35022/35681 (deleted)</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 32u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp;24576 &nbsp;9570015 /data03/pgdata/digoal/PG_9.3_201306121/35022/35449_fsm</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 33u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; 14680064 &nbsp;9569886 /data03/pgdata/digoal/PG_9.3_201306121/35022/35449</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 34u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; 311296 &nbsp;9570012 /data03/pgdata/digoal/PG_9.3_201306121/35022/35443_fsm</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 35u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp;283402240 &nbsp;9569884 /data03/pgdata/digoal/PG_9.3_201306121/35022/35446</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 36u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; 376832 &nbsp;9569894 /data03/pgdata/digoal/PG_9.3_201306121/35022/35467</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 37u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp;9569990 /data03/pgdata/digoal/PG_9.3_201306121/35022/35675 (deleted)</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 38u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp;24576 &nbsp;9569692 /data03/pgdata/digoal/PG_9.3_201306121/35022/35534</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 39u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp;9569974 /data03/pgdata/digoal/PG_9.3_201306121/35022/35652 (deleted)</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 40u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp;9570000 /data03/pgdata/digoal/PG_9.3_201306121/35022/35685 (deleted)</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 41u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp;2531328 &nbsp;9569923 /data03/pgdata/digoal/PG_9.3_201306121/35022/35537</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 42u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp;9569973 /data03/pgdata/digoal/PG_9.3_201306121/35022/35650 (deleted)</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 43u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp;9569987 /data03/pgdata/digoal/PG_9.3_201306121/35022/35672 (deleted)</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 44u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp;9569999 /data03/pgdata/digoal/PG_9.3_201306121/35022/35684 (deleted)</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 45u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; 68247552 &nbsp;9569871 /data03/pgdata/digoal/PG_9.3_201306121/35022/35415</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 46u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp;9569989 /data03/pgdata/digoal/PG_9.3_201306121/35022/35674 (deleted)</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 47u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; &nbsp; &nbsp;57344 &nbsp;9569333 /data03/pgdata/digoal/PG_9.3_201306121/35022/12661</font></div><div><font size="2"   >postgres 28414 postgres &nbsp; 48u &nbsp; REG &nbsp; &nbsp;8,33 &nbsp; 43491328 &nbsp;9569951 /data03/pgdata/digoal/PG_9.3_201306121/35022/35605</font></div><p></p></pre></div><div><br></div><div>或者进入进程对应的proc目录, 也可以查看到以上信息.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># cd /proc/28414/fd</font></div><div><div><font size="2"   ># ll</font></div><div><font size="2"   >total 0</font></div><div><font size="2"   >lr-x------ 1 postgres postgres 64 Mar &nbsp;6 16:25 0 -&gt; /dev/null</font></div><div><font size="2"   >l-wx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 1 -&gt; pipe:[21054]</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 10 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/12651</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 11 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/12720</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 12 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/12718</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 13 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/12656</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 14 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35443</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 15 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35443.1</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 16 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35670</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 17 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35680</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 18 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35682</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 19 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35502</font></div><div><font size="2"   >l-wx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 2 -&gt; pipe:[21054]</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 20 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35638 (deleted)</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 21 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35683 (deleted)</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 22 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35507</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 23 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35640 (deleted)</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 24 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35577</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 25 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35664 (deleted)</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 26 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35400</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 27 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35610 (deleted)</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 28 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35477</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 29 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35632 (deleted)</font></div><div><font size="2"   >lr-x------ 1 postgres postgres 64 Mar &nbsp;6 16:25 3 -&gt; pipe:[6152911]</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 30 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35495 (deleted)</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 31 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35681 (deleted)</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 32 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35449_fsm</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 33 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35449</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 34 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35443_fsm</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 35 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35446</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 36 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35467</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 37 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35675 (deleted)</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 38 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35534</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 39 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35652 (deleted)</font></div><div><font size="2"   >l-wx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 4 -&gt; pipe:[6152911]</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 40 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35685 (deleted)</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 41 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35537</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 42 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35650 (deleted)</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 43 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35672 (deleted)</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 44 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35684 (deleted)</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 45 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35415</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 46 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35674 (deleted)</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 47 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/12661</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 48 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/35605</font></div><div><font size="2"   >lr-x------ 1 postgres postgres 64 Mar &nbsp;6 16:25 5 -&gt; pipe:[21053]</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 6 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/12698</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 7 -&gt; /data03/pgdata/digoal/PG_9.3_201306121/35022/12657</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 8 -&gt; socket:[21061]</font></div><div><font size="2"   >lrwx------ 1 postgres postgres 64 Mar &nbsp;6 16:25 9 -&gt; socket:[6152910]</font></div></div><p></p></pre></div><div><br></div><div>可以尝试使用gdb绑定这个进程, 发起退出信号. (<span style="line-height: 28px;"   >当然, 最好先关闭连接的资源.&nbsp;</span><span style="line-height: 28px;"   >)</span></div><div><span style="line-height: 28px;"   >在使用gdb绑定这个PID后, 发起exit(0)即可.</span></div><div><pre class="prettyprint"   ><div><font size="2"   >(gdb) call exit(0)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Program exited normally.</font></div><div><font size="2"   >The program being debugged exited while in a function called from GDB.</font></div><div><font size="2"   >Evaluation of the expression containing the function</font></div><div><font size="2"   >(exit) will be abandoned.</font></div><p></p></pre></div><div><br></div><div>如果在退出前, 要先关闭资源, 例如sock, 那么在gdb下关闭这些资源如下 :&nbsp;</div><div>使用gdb前, 关闭这个程序的跟踪strace, 否则gdb会报ptrace错误, 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@ fd]# gdb -p 28414</font></div><div><font size="2"   >GNU gdb (GDB) Red Hat Enterprise Linux (7.2-60.el6_4.1)</font></div><div><font size="2"   >Copyright (C) 2010 Free Software Foundation, Inc.</font></div><div><font size="2"   >License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</font></div><div><font size="2"   >This is free software: you are free to change and redistribute it.</font></div><div><font size="2"   >There is NO WARRANTY, to the extent permitted by law. &nbsp;Type "show copying"</font></div><div><font size="2"   >and "show warranty" for details.</font></div><div><font size="2"   >This GDB was configured as "x86_64-redhat-linux-gnu".</font></div><div><font size="2"   >For bug reporting instructions, please see:</font></div><div><font size="2"   >&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</font></div><div><font size="2"   >Attaching to process 28414</font></div><div><font size="2"   >ptrace: Operation not permitted.</font></div><p></p></pre></div><div>关闭该进程的strace后, 正常进入调试界面如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@ fd]# gdb -p 28414</font></div><div><font size="2"   >GNU gdb (GDB) Red Hat Enterprise Linux (7.2-60.el6_4.1)</font></div><div><font size="2"   >Copyright (C) 2010 Free Software Foundation, Inc.</font></div><div><font size="2"   >License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</font></div><div><font size="2"   >This is free software: you are free to change and redistribute it.</font></div><div><font size="2"   >There is NO WARRANTY, to the extent permitted by law. &nbsp;Type "show copying"</font></div><div><font size="2"   >and "show warranty" for details.</font></div><div><font size="2"   >This GDB was configured as "x86_64-redhat-linux-gnu".</font></div><div><font size="2"   >For bug reporting instructions, please see:</font></div><div><font size="2"   >&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</font></div><div><font size="2"   >Attaching to process 28414</font></div><div><font size="2"   >Reading symbols from /opt/pgsql9.3.3/bin/postgres...(no debugging symbols found)...done.</font></div><div><font size="2"   >Reading symbols from /usr/lib64/libxml2.so.2...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /usr/lib64/libxml2.so.2</font></div><div><font size="2"   >Reading symbols from /lib64/libpam.so.0...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /lib64/libpam.so.0</font></div><div><font size="2"   >Reading symbols from /usr/lib64/libssl.so.10...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /usr/lib64/libssl.so.10</font></div><div><font size="2"   >Reading symbols from /usr/lib64/libcrypto.so.10...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /usr/lib64/libcrypto.so.10</font></div><div><font size="2"   >Reading symbols from /lib64/libdl.so.2...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /lib64/libdl.so.2</font></div><div><font size="2"   >Reading symbols from /lib64/libm.so.6...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /lib64/libm.so.6</font></div><div><font size="2"   >Reading symbols from /lib64/libc.so.6...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /lib64/libc.so.6</font></div><div><font size="2"   >Reading symbols from /lib64/libz.so.1...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /lib64/libz.so.1</font></div><div><font size="2"   >Reading symbols from /lib64/libaudit.so.1...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /lib64/libaudit.so.1</font></div><div><font size="2"   >Reading symbols from /lib64/libcrypt.so.1...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /lib64/libcrypt.so.1</font></div><div><font size="2"   >Reading symbols from /lib64/libgssapi_krb5.so.2...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /lib64/libgssapi_krb5.so.2</font></div><div><font size="2"   >Reading symbols from /lib64/libkrb5.so.3...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /lib64/libkrb5.so.3</font></div><div><font size="2"   >Reading symbols from /lib64/libcom_err.so.2...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /lib64/libcom_err.so.2</font></div><div><font size="2"   >Reading symbols from /lib64/libk5crypto.so.3...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /lib64/libk5crypto.so.3</font></div><div><font size="2"   >Reading symbols from /lib64/ld-linux-x86-64.so.2...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /lib64/ld-linux-x86-64.so.2</font></div><div><font size="2"   >Reading symbols from /lib64/libfreebl3.so...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /lib64/libfreebl3.so</font></div><div><font size="2"   >Reading symbols from /lib64/libkrb5support.so.0...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /lib64/libkrb5support.so.0</font></div><div><font size="2"   >Reading symbols from /lib64/libkeyutils.so.1...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /lib64/libkeyutils.so.1</font></div><div><font size="2"   >Reading symbols from /lib64/libresolv.so.2...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /lib64/libresolv.so.2</font></div><div><font size="2"   >Reading symbols from /lib64/libpthread.so.0...(no debugging symbols found)...done.</font></div><div><font size="2"   >[Thread debugging using libthread_db enabled]</font></div><div><font size="2"   >Loaded symbols for /lib64/libpthread.so.0</font></div><div><font size="2"   >Reading symbols from /lib64/libselinux.so.1...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /lib64/libselinux.so.1</font></div><div><font size="2"   >Reading symbols from /opt/pgsql9.3.3/lib/pg_stat_statements.so...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /opt/pgsql9.3.3/lib/pg_stat_statements.so</font></div><div><font size="2"   >Reading symbols from /lib64/libnss_files.so.2...(no debugging symbols found)...done.</font></div><div><font size="2"   >Loaded symbols for /lib64/libnss_files.so.2</font></div><div><font size="2"   >0x00007fd10c7fba52 in send () from /lib64/libc.so.6</font></div><div><font size="2"   >Missing separate debuginfos, use: debuginfo-install audit-libs-2.2-2.el6.x86_64 glibc-2.12-1.132.el6.x86_64 keyutils-libs-1.4-4.el6.x86_64 krb5-libs-1.10.3-10.el6_4.6.x86_64 libcom_err-1.41.12-18.el6.x86_64 libselinux-2.0.94-5.3.el6_4.1.x86_64 libxml2-2.7.6-14.el6.x86_64 nss-softokn-freebl-3.12.9-11.el6.x86_64 openssl-1.0.1e-16.el6_5.4.x86_64 pam-1.1.1-17.el6.x86_64 zlib-1.2.3-29.el6.x86_64</font></div><div><font size="2"   >(gdb) call close(9)</font></div><div><font size="2"   >$1 = 0</font></div><p></p></pre></div><div><br></div><div>但是要小心gdb给进程发SIGSEGV信号, 这个信号会导致Segment fault. 并且在$PGDATA产生一个core dump文件.</div><div>从而导致数据库重启.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@ fd]# gdb -p 28414</font></div><div><font size="2"   >GNU gdb (GDB) Red Hat Enterprise Linux (7.2-60.el6_4.1)</font></div><div><font size="2"   >Copyright (C) 2010 Free Software Foundation, Inc.</font></div><div><font size="2"   >License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</font></div><div><font size="2"   >This is free software: you are free to change and redistribute it.</font></div><div><font size="2"   >There is NO WARRANTY, to the extent permitted by law. &nbsp;Type "show copying"</font></div><div><font size="2"   >and "show warranty" for details.</font></div><div><font size="2"   >This GDB was configured as "x86_64-redhat-linux-gnu".</font></div><div><font size="2"   >For bug reporting instructions, please see:</font></div><div><font size="2"   >&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</font></div><div><font size="2"   >Attaching to process 28414</font></div><div><font size="2"   >^CUnable to attach: program terminated with signal SIGSEGV, Segmentation fault.</font></div><div><font size="2"   >(gdb) quit</font></div><p></p></pre></div><div><div style="line-height: 28px;"   >以上操作因为attaching过程中Ctrl+c了, gdb发了信号11给这个进程.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >man 7 signal</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;SIGSEGV &nbsp; &nbsp; &nbsp;11 &nbsp; &nbsp; &nbsp; Core &nbsp; &nbsp;Invalid memory reference</font></div><p></p></pre></div></div><div>数据库任何进程发生Segment fault后, 会进入crash状态自动重启, 指配置了restart_after_crash=on的情形下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2014-03-06 17:19:59.128 CST,,,5720,,530d8834.1658,31,,2014-02-26 14:22:44 CST,,0,LOG,00000,"server process (PID 28414) was terminate</font></div><div><font size="2"   >d by signal 11: Segmentation fault","Failed process was running: Select xxx from xxx",,,,,,,"LogChildExit, postmaste</font></div><div><font size="2"   >r.c:3242",""</font></div><p></p></pre></div><div>发生crash时, 对应的postgresql日志</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2014-03-06 17:19:59.128 CST,,,5720,,530d8834.1658,32,,2014-02-26 14:22:44 CST,,0,LOG,00000,"terminating any other active server proc</font></div><div><font size="2"   >esses",,,,,,,,"HandleChildCrash, postmaster.c:2973",""</font></div><div><font size="2"   >2014-03-06 17:19:59.128 CST,"xxx","xxx",20527,"xxx.xxx.xxx.xxx:39957",53183d65.502f,3,"idle",2014-03-06 17:18:29 CST,9/0,0,WARNING,57P02,"terminating connection because of crash of another server process","The postmaster has commanded this server process to roll back the current transaction and exit, because another server process exited abnormally and possibly corrupted shared memory.","In a moment you should be able to reconnect to the database and repeat your command.",,,,,,"quickdie, postgres.c:2555",""</font></div><p></p></pre></div><div><br></div></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://superuser.com/questions/127863/manually-closing-a-port-from-commandline"   >http://superuser.com/questions/127863/manually-closing-a-port-from-commandline</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://stackoverflow.com/questions/323146/how-to-close-a-file-descriptor-from-another-process-in-unix-systems"   >http://stackoverflow.com/questions/323146/how-to-close-a-file-descriptor-from-another-process-in-unix-systems</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://blog.mellenthin.de/archives/2010/10/18/gdb-attach-fails-with-ptrace-operation-not-permitted/"   >http://blog.mellenthin.de/archives/2010/10/18/gdb-attach-fails-with-ptrace-operation-not-permitted/</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.totalnetsolutions.net/2012/06/26/gdb-ptrace-operation-not-permitted/"   >http://www.totalnetsolutions.net/2012/06/26/gdb-ptrace-operation-not-permitted/</a></div><div>5.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/message-id/flat/20081031153635.GM4519@zedcore.com#20081031153635.GM4519@zedcore.com"   >http://www.postgresql.org/message-id/flat/CD95EF5E.ACFB%george.caragea@emc.com#CD95EF5E.ACFB%george.caragea@emc.com</a></div><div>6.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/message-id/flat/20081031153635.GM4519@zedcore.com#20081031153635.GM4519@zedcore.com"   >http://www.postgresql.org/message-id/flat/20081031153635.GM4519@zedcore.com#20081031153635.GM4519@zedcore.com</a></div><div>7. man 7 signal</div><div>8.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://wiki.postgresql.org/wiki/Pgsrcstructure"   >https://wiki.postgresql.org/wiki/Pgsrcstructure</a></div><div>9.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://wiki.postgresql.org/wiki/Getting_a_stack_trace_of_a_running_PostgreSQL_backend_on_Linux/BSD"   >https://wiki.postgresql.org/wiki/Getting_a_stack_trace_of_a_running_PostgreSQL_backend_on_Linux/BSD</a></div>10.&nbsp;<a target="_blank" rel="nofollow" href="https://wiki.postgresql.org/wiki/Performance_Analysis_Tools"   >https://wiki.postgresql.org/wiki/Performance_Analysis_Tools</a></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">德哥@Digoal - 2014-07-28 7:59:50</h5>
				<div>call close关闭进程占用的资源, exit(0)退出进程.</div>
			</div>
			<div id="">
				<h5 id="">byfei163 - 2014-07-26 15:18:39</h5>
				<div><P>这类进程你是怎么杀的，"kill -9 {spid}"又不能用。</P></div>
			</div>
	</div>
</div>
</body>
</html>