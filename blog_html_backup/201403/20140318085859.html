<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL csvlog maintenance automatic</h2>
	<h5 id="">2014-03-18 8:58:59&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014217696894/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前面一篇文章我提了一下定制PostgreSQL日志记录级别, 因为目前只有all, none, ddl, mod几个级别, 还不够精细, 如果要记录除INSERT以外的DML语句需要修改获取COMMAND级别的函数, 比较麻烦, 如下 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201421702248430/"   >http://blog.163.com/digoal@126/blog/static/163877040201421702248430/</a></div><div>还有一种情形是, 开启数据库MOD日志级别后, 会产生大量的日志, 对性能有一定影响同时也占用存储空间.</div><div>通过挂载网络存储来管理csvlog有一定的风险, 一旦网络故障, 将导致数据库需要些日志的进程堵塞. 大家可以测试一下如使用nfs作为csvlog目录, 打开mod日志级别, 然后开启pgbench进行INSERT测试, 然后试图把远端的nfs进程停掉. 这种情形下, insert将堵塞.</div><div>一个比较折中的方法是本地存储csvlog, 同时定时将csvlog上次到远端存储并删除本地文件.</div><div>例如使用rsync作为传输工具.</div><div>远端存储服务端配置.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[192.168.9.9 csvlog]# cat /etc/rsyncd.conf&nbsp;</font></div><div><font size="2"   >port = 873</font></div><div><font size="2"   >hosts deny = 0.0.0.0/0</font></div><div><font size="2"   >read only = false</font></div><div><font size="2"   >write only = false</font></div><div><font size="2"   >gid = 0</font></div><div><font size="2"   >uid = 0</font></div><div><font size="2"   >use chroot = no</font></div><div><font size="2"   >max connections = 100</font></div><div><font size="2"   >pid file = /var/run/rsync.pid</font></div><div><font size="2"   >lock file = /var/run/rsync.lock</font></div><div><font size="2"   >log file = /var/log/rsync.log</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[csvlog]</font></div><div><font size="2"   >path = /data01/csvlog</font></div><div><font size="2"   >comment = PostgreSQL csvlog</font></div><div><font size="2"   >hosts allow = 192.168.1.0/24,192.168.2.0/24,192.168.3.100</font></div><p></p></pre></div><div>如果有新的数据库主机要加入, 先配置hosts allow.</div><div><br></div><div>启动rsync后台进程.</div><pre class="prettyprint"   ><p></p><div><font size="2"   ># /usr/bin/rsync -v --daemon --config=/etc/rsyncd.conf</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >创建和主机相关的目录, 例如数据库主机的IP为192.168.1.2 , 创建上次目录.</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   ># mkdir -p /data01/csvlog/192.168.1.2/upload_dir</font></div><div></div><p></p></pre><div><br></div><div>在数据库主机上使用rsync上传 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi csvlog_upload.sh</font></div><div><font size="2"   ><span style="line-height: 21px;"   >#!/bin/bash<br><br># .bash_profile<br># Get the aliases and functions<br>if [ -f ~/.bashrc ]; then<br>        . ~/.bashrc<br>fi<br># User specific environment and startup programs<br>PATH=$PATH:$HOME/bin<br>export PATH<br>. /home/postgres/.bash_profile<br><br>NET_DEV="`/sbin/route -n|grep UG|awk '{print $8}'|head -n 1`"<br>IP_ADDR="`/sbin/ip addr show $NET_DEV|grep inet|grep "global $NET_DEV$"|awk '{print $2}'|awk -F "/" '{print $1}'`"<br>LOCAL_IP="$IP_ADDR"<br>LOCAL_CSVLOG_DIR="`grep log_directory $PGDATA/postgresql.conf|awk -F "=" '{print $2}'|awk -F "'" '{print $2}'`"<br>RSYNC_IP="192.168.9.9"<br>RSYNC_DIR="csvlog/$LOCAL_IP/upload_dir/"<br><br><br># find $LOCAL_CSVLOG_DIR -regextype posix-extended -regex '.*postgresql-[0-9]{4}-[0-9]{2}-[0-9]{2}.*csv' -type f -mmin +60<br># find $LOCAL_CSVLOG_DIR -regextype posix-extended -regex '.*postgresql-[0-9]{4}-[0-9]{2}-[0-9]{2}.*log' -type f -mtime +1<br><br>cd $PGDATA</span></font></div><div><font size="2"   ><span style="line-height: 21px;"   >for ((i=1;i&gt;0;i=1))<br>do<br># 查找60分钟前修改过的CSV文件, 上传并删除<br>find $LOCAL_CSVLOG_DIR -regextype posix-extended -regex '.*postgresql-[0-9]{4}-[0-9]{2}-[0-9]{2}.*csv' -type f -mmin +60 -exec rsync -acvz {} $RSYNC_IP::$RSYNC_DIR \; -exec rm -f {} \;<br># 查找2天前修改过的LOG文件, 上传并删除<br>find $LOCAL_CSVLOG_DIR -regextype posix-extended -regex '.*postgresql-[0-9]{4}-[0-9]{2}-[0-9]{2}.*log' -type f -mtime +1 -exec rsync -acvz {} $RSYNC_IP::$RSYNC_DIR \; -exec rm -f {} \;<br><br>sleep 60<br><br>done</span></font></div><p></p></pre></div><div>修改权限</div><pre class="prettyprint"   ><p></p><div><font size="2"   >chmod 500 csvlog_upload.sh</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >启动</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >nohup ./csvlog_upload.sh &gt;/dev/null 2&gt;&amp;1 &amp;</font></div><div></div><p></p></pre></div><div>放到rc.local</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># vi /etc/rc.local</font></div><div><font size="2"   >su - postgres -c "/home/postgres/script/csvlog_upload.sh &gt;/dev/null 2&gt;&amp;1 &amp;"</font></div><p></p></pre></div><div>如果要限制上传速度, 可以使用rsync --bwlimit</div><br><div><br></div><div>后期的维护, 例如每个月打包成一个压缩文件.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd /data01/csvlog/192.168.100.12/upload_dir</font></div><div><font size="2"   >FILE="2014-03"; test -f ../$FILE.tar.bz2 || nohup tar --remove-files -jcvf 
../$FILE.tar.bz2 postgresql-$FILE* &gt;/dev/null 2&gt;&amp;1 &amp;</font></div><p></p></pre></div><div>如果<span style="line-height: 28px;"   >文件数过多可能会造成tar的argments too many的错误, 而且后期的解压这种大目录也有弊端, 所以建议一个文件一个文件的压缩.</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >vi compress.sh</font></span></div><div><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   >FILE="2014-03"</font></div><div><font size="2"   >DIR=/data01/csvlog/192.168.100.12/upload_dir</font></div><div><font size="2"   >FILE=$2</font></div><div><font size="2"   >DIR=$1</font></div><div><font size="2"   >cd $DIR</font></div><div><font size="2"   >for filename in ./postgresql-$FILE*; do</font></div><div><font size="2"   >&nbsp; tar --remove-files -jcvf ../$filename.tar.bz2 $filename &gt;/dev/null 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >done</font></div></div><div><font size="2"   >chmod 500 compress.sh</font></div><div><font size="2"   >./<span style="line-height: 28px;"   >compress</span>.sh /root "2014-03"</font></div><p></p></pre></div><div><br></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL csvlog maintenance automatic - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>