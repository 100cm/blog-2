<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Attention: Use pg_statsinfo set correct timezone and log_timezone in repo and monitored instance.</h2>
	<h5 id="">2014-03-05 8:14:29&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014257448826/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">在使用pg_statsinfo 2.5.0 这个版本时, 有一个比较严重的值得关注的问题, 当被监控的数据库和存储监控数据的数据库设置的时区不正确时, 会造成严重后果.<wbr><div>例如, 按照pg_statsinfo的手册, 将被监控数据库的log_timezone设置为'UTC'.&nbsp;</div><div>如果这个时候repo设置的timezone也是'UTC'的话, 将会造成收集到的checkpoint, autovacuum, autoanalyze等数据的时间正常, 但是snapshot表的时间却加了8个小时. (假设服务器的时间是PRC的).</div><div>这样的话将导致repo库的一些函数无法正常的统计数据.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >statsrepo=&gt; &nbsp;\sf get_autovacuum_activity</font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION statsrepo.get_autovacuum_activity(snapid_begin bigint, snapid_end bigint, OUT datname text, OUT nspname text, OUT relname text, OUT count bigint, OUT avg_tup_removed numeric, OUT avg_tup_remain numeric, OUT avg_index_scans numeric, OUT avg_duration numeric, OUT max_duration numeric)</font></div><div><font size="2"   >&nbsp;RETURNS SETOF record</font></div><div><font size="2"   >&nbsp;LANGUAGE sql</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SELECT</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; database,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; schema,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "table",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; count(*),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; round(avg(tup_removed)::numeric,3),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; round(avg(tup_remain)::numeric,3),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; round(avg(index_scans)::numeric,3),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; round(avg(duration)::numeric,3),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; round(max(duration)::numeric,3)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; FROM</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; statsrepo.autovacuum v,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (SELECT min(time) AS time FROM statsrepo.snapshot WHERE snapid &gt;= $1) b,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (SELECT max(time) AS time FROM statsrepo.snapshot WHERE snapid &lt;= $2) e</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; WHERE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.start BETWEEN b.time AND e.time</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AND v.instid = (SELECT instid FROM statsrepo.snapshot WHERE snapid = $2)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; GROUP BY</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; database, schema, "table"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ORDER BY</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 DESC;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div>这些函数都要使用snapshot的time, 然后从统计表例如autovacuum取数据, 如果它们的时间有偏差, 例如本文提到的偏差了8小时, 那么无法取到正确的数据, 因为取到的数据将与实际偏差8个小时.</div><div><br></div><div>目前可以正常采集数据的配置如下, 请参照配置 :&nbsp;</div><div>1. 被监控数据库服务器以及repo服务器的时区</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/etc/sysconfig/clock</font></div><div><font size="2"   >ZONE="Asia/Shanghai"</font></div><p></p></pre></div><div>2. 被监控机数据库的timezone和log_timezone</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >$ grep timezone postgresql.conf&nbsp;</font></div><div><font size="2"   >log_timezone = 'UTC'</font></div><div><font size="2"   >timezone = 'PRC'</font></div><div><font size="2"   >#timezone_abbreviations = 'Default' &nbsp; &nbsp; # Select the set of available time zone</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # share/timezonesets/.</font></div><p></p></pre></div><div>3. 被监控服务器的启动环境PGUSER=postgres, 超级用户.</div><div>4. repo数据库的时区配置</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >$ grep timezone postgresql.conf&nbsp;</font></div><div><font size="2"   >log_timezone = 'UTC' &nbsp;# 这个无关紧要, 如果仅作为repo库的话.</font></div><div><font size="2"   >timezone = 'PRC'</font></div><div><font size="2"   >#timezone_abbreviations = 'Default' &nbsp; &nbsp; # Select the set of available time zone</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # share/timezonesets/.</font></div><p></p></pre></div><div><br></div><div>另外, 修改了log_timezone, 必须把pg_log/里的日志文件清除后, 重启数据库或者switch log, 按照新的时区产生一个正确的文件名, 否则statsinfo会无法正常取日志里的内容.</div></div>
	</div>
</div>
</body>
</html>