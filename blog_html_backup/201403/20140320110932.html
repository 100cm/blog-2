<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL log and trace and debug</h2>
	<h5 id="">2014-03-20 11:09:32&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201422083228624/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL在代码中放了大量的输出数据库运行状态的函数, 例如这段代码, 在参数文件postgresql.conf中开启了log_connections的情况下, 将输出数据库接收到连接请求时的客户端主机和端口信息.</div><div><div>src/backend/postmaster/postmaster.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (Log_connections)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (remote_port[0])</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errmsg("connection received: host=%s port=%s",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; remote_host,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; remote_port)));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errmsg("connection received: host=%s",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; remote_host)));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div></div><div>PostgreSQL一般使用elog或ereport来输出消息. 输出消息时包含了消息级别, 这些级别被用于日志文件或客户端作为过滤条件, 定义如下 :&nbsp;</div><div>src/include/utils/elog.h</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >#ifdef HAVE__BUILTIN_CONSTANT_P</font></div><div><font size="2"   >#define elog(elevel, ...) &nbsp;\</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; do { \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog_start(__FILE__, __LINE__, PG_FUNCNAME_MACRO); \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog_finish(elevel, __VA_ARGS__); \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (__builtin_constant_p(elevel) &amp;&amp; (elevel) &gt;= ERROR) \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pg_unreachable(); \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; } while(0)</font></div><div><font size="2"   >#else &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* !HAVE__BUILTIN_CONSTANT_P */</font></div><div><font size="2"   >#define elog(elevel, ...) &nbsp;\</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; do { \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elevel_; \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog_start(__FILE__, __LINE__, PG_FUNCNAME_MACRO); \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elevel_ = (elevel); \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog_finish(elevel_, __VA_ARGS__); \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (elevel_ &gt;= ERROR) \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pg_unreachable(); \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; } while(0)</font></div><div><font size="2"   >#endif &nbsp; /* HAVE__BUILTIN_CONSTANT_P */</font></div></div><div><div><font size="2"   >#define ereport(elevel, rest) &nbsp; \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ereport_domain(elevel, TEXTDOMAIN, rest)</font></div></div><p></p></pre></div><div>消息级别的定义如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/* Error level codes */</font></div><div><font size="2"   >#define DEBUG5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* Debugging messages, in categories of</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* decreasing detail. */</font></div><div><font size="2"   >#define DEBUG4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;11</font></div><div><font size="2"   >#define DEBUG3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;12</font></div><div><font size="2"   >#define DEBUG2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;13</font></div><div><font size="2"   >#define DEBUG1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;14 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* used by GUC debug_* variables */</font></div><div><font size="2"   >#define LOG &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 15 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* Server operational messages; sent only to</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* server log by default. */</font></div><div><font size="2"   >#define COMMERROR &nbsp; &nbsp; &nbsp; 16 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* Client communication problems; same as LOG</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* for server reporting, but never sent to</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* client. */</font></div><div><font size="2"   >#define INFO &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;17 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* Messages specifically requested by user (eg</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* VACUUM VERBOSE output); always sent to</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* client regardless of client_min_messages,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* but by default not sent to server log. */</font></div><div><font size="2"   >#define NOTICE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;18 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* Helpful messages to users about query</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* operation; sent to client and server log by</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* default. */</font></div><div><font size="2"   >#define WARNING &nbsp; &nbsp; &nbsp; &nbsp; 19 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* Warnings. &nbsp;NOTICE is for expected messages</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* like implicit sequence creation by SERIAL.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* WARNING is for unexpected messages. */</font></div><div><font size="2"   >#define ERROR &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 20 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* user error - abort transaction; return to</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* known state */</font></div><div><font size="2"   >#ifdef WIN32<br>#define PGERROR         20<br>#endif<br>#define FATAL           21                      /* fatal error - abort process */<br>#define PANIC           22                      /* take down the other backends with me */</font></div><p></p></pre></div><div>那么这些信息都输出到哪里去了呢? PostgreSQL日志信息输出位置配置, 如下举例 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # stderr, csvlog, syslog, and eventlog,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # depending on platform. &nbsp;csvlog</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # requires logging_collector to be on.</font></div></div><div><div><font size="2"   >log_directory = '/mnt/csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # directory where log files are written,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # can be absolute or relative to PGDATA</font></div><div><font size="2"   >#log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' &nbsp; &nbsp; &nbsp; &nbsp;# log file name pattern,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # can include strftime() escapes</font></div></div><div><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >以csvlog为例, 日志信息记录在/mnt/csvlog中, 信息举例 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; less postgresql-2014-03-19_171700.csv</font></div><div><font size="2"   >2014-03-19 17:17:02.870 CST,,,17705,"",5329608e.4529,1,"",2014-03-19 17:17:02 CST,,0,LOG,00000,"connection received: host=[local]",,,,,,,,"BackendInitialize, postmaster.c:3854",""</font></div><p></p></pre></div><div>因为设置了log_error_verbosity = verbose, 将输出代码信息, 指这条log信息是哪个函数输出的.</div><div>哪些日志会打印到csvlog, 或者客户端会话呢? 由以下参数决定, 级别越高, 输出的消息越多 :&nbsp;</div><div>需要注意log_min_messages的log位置在比较低的级别, 如果设置为log, 将不会在csvlog中输出error级别以及以上级别的消息.</div><div>但是client_min_messages的log位置在error之上, 所以设置为log的话, 客户端能看到错误级别的消息.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#client_min_messages = notice &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # values in order of decreasing detail:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; debug5</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; debug4</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; debug3</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; debug2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; debug1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; log</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; notice</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; warning</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; error</font></div><div><font size="2"   >#log_min_messages = warning &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # values in order of decreasing detail:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; debug5</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; debug4</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; debug3</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; debug2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; debug1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; info</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; notice</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; warning</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; error</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; log</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; fatal</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; panic</font></div><div><font size="2"   >#log_min_error_statement = error &nbsp; &nbsp; &nbsp; &nbsp;# values in order of decreasing detail:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; debug5</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; debug4</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; debug3</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; debug2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; debug1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; info</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; notice</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; warning</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; error</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; log</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; fatal</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; panic (effectively off)</font></div><p></p></pre></div><div>例如 :&nbsp;</div><div>把客户端的日志打印级别改为error, 那么notice级别的消息将不会被打印.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# set client_min_messages=error;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# do language plpgsql $$</font></div><div><font size="2"   >digoal$# declare</font></div><div><font size="2"   >digoal$# begin</font></div><div><font size="2"   >digoal$# &nbsp; raise notice 'this is a test.';</font></div><div><font size="2"   >digoal$# end;</font></div><div><font size="2"   >digoal$# $$;</font></div><div><font size="2"   >DO</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >把客户端的日志打印级别改为notice, 那么这个例子的notice级别的消息会被打印出来.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# set client_min_messages=notice;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; raise notice 'this is a test.';</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >NOTICE: &nbsp;this is a test.</font></div><div><font size="2"   >DO</font></div><p></p></pre></div><div>因此要输出最详细的全局信息, 把log_min_messages设置为debug5, 如果要得到当前会话的最详细的信息, 把client_min_messages设置为debug5即可.</div><div>除此之外, 数据库还定义了一些隐藏的消息输出, 需要开启某些参数, 或者在编译前打开一些定义才会输出, 例如 :&nbsp;</div><div>1. 开发参数中提到的某些参数需要在编译时开启某些宏的定义, 这些参数才能生效.</div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/runtime-config-developer.html"   >http://www.postgresql.org/docs/9.3/static/runtime-config-developer.html</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >debug_assertions 需要开启宏USE_ASSERT_CHECKING&nbsp;</font></div><div><font size="2"   >trace_locks , trace_lwlocks , trace_userlocks , trace_lock_oidmin , trace_lock_table , debug_deadlocks 需要开启宏LOCK_DEBUG&nbsp;</font></div><div><font size="2"   >log_btree_build_stats 需要开启宏BTREE_BUILD_STATS&nbsp;</font></div><div><font size="2"   >wal_debug 需要开启宏WAL_DEBUG.</font></div><p></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >2. &nbsp;在参数文件What To Log中提到的一些</span></div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/runtime-config-logging.html#RUNTIME-CONFIG-LOGGING-WHAT"   >http://www.postgresql.org/docs/9.3/static/runtime-config-logging.html#RUNTIME-CONFIG-LOGGING-WHAT</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >application_name (string) 输出客户端指定的应用名</font></div><div><font size="2"   >debug_print_parse (boolean) 输出parse阶段的信息</font></div><div><font size="2"   >debug_print_rewritten (boolean) 输出rewritten阶段的信息</font></div><div><font size="2"   >debug_print_plan (boolean) 输出执行计划信息</font></div><div><font size="2"   >debug_pretty_print (boolean) 以比较易读的方式输出以上三个参数的信息</font></div><div><font size="2"   >log_checkpoints (boolean) 输出检查点信息</font></div><div><font size="2"   >log_connections (boolean) 输出连接信息</font></div><div><font size="2"   >log_disconnections (boolean) 输出断开连接信息</font></div><div><font size="2"   >log_duration (boolean) 输出SQL语句执行时间信息</font></div><div><font size="2"   >log_error_verbosity (enum) 输出详细级别, 例如函数以及代码文件名</font></div><div><font size="2"   >log_hostname (boolean) 主机名</font></div><div><font size="2"   >log_line_prefix (string) 输出位置为标准输出或者系统日志时, 指定输出格式</font></div><div><font size="2"   >log_lock_waits (boolean) 输出锁等待</font></div><div><font size="2"   >log_statement (enum) 按过滤条件输出SQL语句, 例如ddl, mod, all</font></div><div><font size="2"   >log_temp_files (integer) &nbsp;按过滤条件输出临时文件相关信息</font></div><div><font size="2"   >log_timezone (string) 指定时区</font></div><p></p></pre></div><div><br></div><div>3. 在代码中定义的宏, 可以开启一些隐藏的输出, 例如:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >src/include/pg_config_manual.h</font></div><div><font size="2"   >/*<br> * Define this to force all parse and plan trees to be passed through<br> * copyObject(), to facilitate catching errors and omissions in<br> * copyObject().<br> */<br>/* #define COPY_PARSE_PLAN_TREES */<br>/*<br> * Enable debugging print statements for lock-related operations.<br> */<br>/* #define LOCK_DEBUG */<br>/*<br> * Enable debugging print statements for WAL-related operations; see<br> * also the wal_debug GUC var.<br> */<br>/* #define WAL_DEBUG */<br>/*<br> * Enable tracing of resource consumption during sort operations;<br> * see also the trace_sort GUC var.  For 8.1 this is enabled by default.<br> */<br>#define TRACE_SORT 1<br>/*<br> * Enable tracing of syncscan operations (see also the trace_syncscan GUC var).<br> */<br>/* #define TRACE_SYNCSCAN */<br>/*<br> * Other debug #defines (documentation, anyone?)<br> */<br>/* #define HEAPDEBUGALL */<br>/* #define ACLDEBUG */<br>/* #define RTDEBUG */</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >src/backend/optimizer/path/allpaths.c</font></div><div><div><font size="2"   >#ifdef OPTIMIZER_DEBUG</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; debug_print_rel(root, rel);</font></div><div><font size="2"   >#endif</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >src/backend/optimizer/geqo/geqo_main.c</font></div><div><div><font size="2"   >#ifdef GEQO_DEBUG</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; elog(DEBUG1, "GEQO best is %.2f after %d generations",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pool-&gt;data[0].worth, number_generations);</font></div><div><font size="2"   >#endif</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >src/backend/regex/regcomp.c</font></div><div><div><font size="2"   >#ifdef REG_DEBUG</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (debug != NULL)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(debug, "\n\n\n========= TREE FIXED ==========\n");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dumpst(v-&gt;tree, debug, 1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >#endif</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >src/backend/utils/adt/acl.c</font></div><div><div><font size="2"   >#ifdef ACLDEBUG</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; elog(LOG, "aclparse: input = \"%s\"", s);</font></div><div><font size="2"   >#endif</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >src/backend/utils/adt/arrayfuncs.c</font></div><div><div><font size="2"   >#ifdef ARRAYDEBUG</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; printf("array_in- ndim %d (", ndim);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; for (i = 0; i &lt; ndim; i++)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; printf(" %d", dim[i]);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; };</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; printf(") for %s\n", string);</font></div><div><font size="2"   >#endif</font></div></div><div><font size="2"   >...</font></div><p></p></pre></div><div><br></div><div>PostgreSQL还有专门的统计信息收集进程, 用来收集数据库运行过程的信息.&nbsp;</div><div>例如在postgresql.conf文件中可以定义的参数如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#track_activities = on &nbsp; &nbsp;# 跟踪SQL语句的状态以及SQL语句的内容. 输出到pg_stat_activity</font></div><div><font size="2"   >#track_counts = on &nbsp; &nbsp;# 计数器, 例如表被插入了多少次, 更新了多少次</font></div><div><font size="2"   >#track_io_timing = off &nbsp; # &nbsp;跟踪IO操作的时间, 例如一个SQL语句带来的IO时间是多少.&nbsp;</font></div><div><font size="2"   >#track_functions = none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # none, pl, all &nbsp; # 跟踪函数的调用次数, 时间.</font></div><div><font size="2"   >track_activity_query_size = 4096 &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart) &nbsp;# 输出SQL语句的最大长度, 超出截断</font></div><div><font size="2"   >#update_process_title = on &nbsp; # 更新进程状态信息, 例如从select到idle, 显示进程当前的状态.</font></div><div><font size="2"   >#stats_temp_directory = 'pg_stat_tmp' &nbsp;</font></div><div><font size="2"   ># - Statistics Monitoring -</font></div><div><font size="2"   >#log_parser_stats = off</font></div><div><font size="2"   >#log_planner_stats = off</font></div><div><font size="2"   >#log_executor_stats = off</font></div><div><font size="2"   >#log_statement_stats = off</font></div><p></p></pre></div><div><br></div><div>使用举例 :&nbsp;</div><div>默认情况下可跟踪的信息举例</div><div>1. 跟踪排序</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# set client_min_messages=log;</font></div><div><font size="2"   >digoal=# set trace_sort=on;</font></div><div><div><font size="2"   >digoal=# select count(*) from (select * from pg_class order by relpages) t;</font></div><div><font size="2"   >LOG: &nbsp;begin tuple sort: nkeys = 1, workMem = 1024, randomAccess = f</font></div><div><font size="2"   >LOG: &nbsp;performsort starting: CPU 0.00s/0.00u sec elapsed 0.00 sec</font></div><div><font size="2"   >LOG: &nbsp;performsort done: CPU 0.00s/0.00u sec elapsed 0.00 sec</font></div><div><font size="2"   >LOG: &nbsp;internal sort ended, 108 KB used: CPU 0.00s/0.00u sec elapsed 0.00 sec</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp;304</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   >2. 跟踪执行计划</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >digoal=# set client_min_messages=log;</font></span></div><div><font size="2"   >digoal=# set debug_pretty_print = on;</font></div><div><div style="line-height: 28px;"   ><font size="2"   >digoal=# set debug_print_parse=on;</font></div><div style="line-height: 28px;"   ><font size="2"   >SET</font></div><div style="line-height: 28px;"   ><font size="2"   >digoal=# select count(*) from (select * from pg_class order by relpages) t;</font></div><div style="line-height: 28px;"   ><font size="2"   >LOG: &nbsp;parse tree:</font></div><div style="line-height: 28px;"   ><font size="2"   >DETAIL: &nbsp; &nbsp; {QUERY&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >... 略</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >digoal=# set debug_print_rewritten = on;</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >LOG: &nbsp;rewritten parse tree:</font></div><div style="line-height: 28px;"   ><font size="2"   >DETAIL: &nbsp;(</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;{QUERY&nbsp;</font></div></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >... 略</font></span></div></div><div><font size="2"   >digoal=# set debug_print_plan = on;</font></div><div><span style="line-height: 28px;"   ><font size="2"   >digoal=# select count(*) from (select * from pg_class order by relpages) t;</font></span></div><div><div><font size="2"   >LOG: &nbsp;plan:</font></div><div><font size="2"   >DETAIL: &nbsp; &nbsp; {PLANNEDSTMT&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:commandType 1&nbsp;</font></div></div><div><span style="line-height: 28px;"   ><font size="2"   >... 略</font></span></div></div><p></p></pre></div><div><div><span style="line-height: 28px;"   >3. 跟踪死锁</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >SESSION A :&nbsp;</font></div><div><div><font size="2"   >digoal=# create table t(id int, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into t values (1,'test'),(2,'test');</font></div><div><font size="2"   >INSERT 0 2</font></div><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# update t set info='new' where id=1;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >SESSOIN B :&nbsp;</font></div><div><div style="line-height: 28px;"   ><font size="2"   >digoal=# begin;</font></div><div style="line-height: 28px;"   ><font size="2"   >BEGIN</font></div><div style="line-height: 28px;"   ><font size="2"   >digoal=# update t set info='new' where id=2;</font></div><div style="line-height: 28px;"   ><font size="2"   >UPDATE 1</font></div></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >digoal=# update t set info='new' where id=1;</font></div></div><div style="line-height: 28px;"   ><font size="2"   >SESSION A :&nbsp;</font></div><div><font size="2"   >digoal=# update t set info='new' where id=2;</font></div><div><font size="2"   >ERROR: &nbsp;deadlock detected</font></div><div><font size="2"   >DETAIL: &nbsp;Process 6173 waits for ShareLock on transaction 3268512748; blocked by process 6214.</font></div><div><font size="2"   >Process 6214 waits for ShareLock on transaction 3268512747; blocked by process 6173.</font></div><div><font size="2"   >HINT: &nbsp;See server log for query details.</font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   >4. 跟踪锁超时SQL</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >log_lock_waits = on</font></div><div><font size="2"   >deadlock_timeout = 1s</font></div><div><font size="2"   >SESSION A :&nbsp;</font></div><div><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# update t set info='new' where id=1;</font></div><div><font size="2"   >UPDATE 1</font></div></div><div><font size="2"   >SESSION B :&nbsp;</font></div><div><div><font size="2"   >digoal=# set client_min_messages=log;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# update t set info='new' where id=1;</font></div><div><font size="2"   >LOG: &nbsp;statement: update t set info='new' where id=1;</font></div><div><font size="2"   >LOG: &nbsp;process 6499 still waiting for ShareLock on transaction 3268512749 after 1000.177 ms</font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   >5. 跟踪超时SQL</span></div><div>log_min_duration_statement = 100ms &nbsp;# 记录执行时间超过100毫秒的SQL</div><div><span style="line-height: 28px;"   >6. 跟踪检查点,连接和断开连接信息</span></div><div><span style="line-height: 28px;"   ><div>log_checkpoints = on</div><div>log_connections = on</div><div>log_disconnections = on</div></span></div><div><span style="line-height: 28px;"   >7. 跟踪函数</span></div><div>track_functions = all</div><div><br></div><div><span style="line-height: 28px;"   >需要打开某些宏才可以跟踪的信息, 不推荐在生产环境中使用, 举例</span></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 postgresql-9.3.3]# vi src/Makefile.custom</font></div><div><div><font size="2"   >CFLAGS+=-DLOCK_DEBUG</font></div><div><font size="2"   >CFLAGS+=-DBTREE_BUILD_STATS</font></div><div><font size="2"   >CFLAGS+=-DWAL_DEBUG</font></div><div><font size="2"   >CFLAGS+=-DOPTIMIZER_DEBUG</font></div><div><font size="2"   >CFLAGS+=-DGEQO_DEBUG</font></div><div><font size="2"   >CFLAGS+=-DCOPY_PARSE_PLAN_TREES</font></div><div><font size="2"   >CFLAGS+=-DTRACE_SYNCSCAN</font></div></div><p></p></pre></div><div>重新编译安装PostgreSQL.</div><div><span style="line-height: 28px;"   >1. 跟踪btree索引建立时的信息</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table test(id int, info text);</font></div><div><font size="2"   >digoal=# set client_min_messages=log;</font></div><div><div><font size="2"   >digoal=# insert into test select generate_series(1,100000),'test';</font></div><div><font size="2"   >LOG: &nbsp;statement: insert into test select generate_series(1,100000),'test';</font></div><div><font size="2"   >INSERT 0 100000</font></div><div><font size="2"   >digoal=# set log_btree_build_stats =on;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# \set VERBOSITY verbose</font></div><div><font size="2"   ><span style="line-height: 21px;"   >digoal=# create index idx_test_1 on test(id);<br>LOG:  00000: statement: create index idx_test_1 on test(id);<br>LOCATION:  exec_simple_query, postgres.c:890<br>LOG:  00000: BTREE BUILD (Spool) STATISTICS<br>DETAIL:  ! system usage stats:<br>!       0.048502 elapsed 0.040993 user 0.006999 system sec<br>!       [0.328949 user 0.038994 sys total]<br>!       0/0 [0/13888] filesystem blocks in/out<br>!       0/1706 [0/8926] page faults/reclaims, 0 [0] swaps<br>!       0 [0] signals rcvd, 0/0 [0/0] messages rcvd/sent<br>!       0/0 [74/1] voluntary/involuntary context switches<br>LOCATION:  ShowUsage, postgres.c:4400<br>LOG:  00000: BTREE BUILD STATS<br>DETAIL:  ! system usage stats:<br>!       0.043534 elapsed 0.031996 user 0.002999 system sec<br>!       [0.360945 user 0.041993 sys total]<br>!       0/4864 [0/18752] filesystem blocks in/out<br>!       0/741 [0/9667] page faults/reclaims, 0 [0] swaps<br>!       0 [0] signals rcvd, 0/0 [0/0] messages rcvd/sent<br>!       9/1 [83/2] voluntary/involuntary context switches<br>LOCATION:  ShowUsage, postgres.c:4400<br>CREATE INDEX</span></font></div></div><p></p></pre></div><div>2. 跟踪锁</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# set trace_locks=on;</font></div><div><font size="2"   >LOG: &nbsp;00000: LockReleaseAll: lockmethod=1</font></div><div><font size="2"   >LOCATION: &nbsp;LockReleaseAll, lock.c:1954</font></div><div><font size="2"   >LOG: &nbsp;00000: LockReleaseAll done</font></div><div><font size="2"   >LOCATION: &nbsp;LockReleaseAll, lock.c:2199</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# update t set info='test' where id=1;</font></div><div><font size="2"   >LOG: &nbsp;00000: statement: update t set info='test' where id=1;</font></div><div><font size="2"   >LOCATION: &nbsp;exec_simple_query, postgres.c:890</font></div><div><font size="2"   >LOG: &nbsp;00000: LockAcquire: lock [16384,26061] RowExclusiveLock</font></div><div><font size="2"   >LINE 1: update t set info='test' where id=1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >LOCATION: &nbsp;LockAcquireExtended, lock.c:729</font></div><div><font size="2"   >LOG: &nbsp;00000: LockAcquire: lock [16384,26061] RowExclusiveLock</font></div><div><font size="2"   >LOCATION: &nbsp;LockAcquireExtended, lock.c:729</font></div><div><font size="2"   >LOG: &nbsp;00000: LockAcquire: lock [16384,26061] ExclusiveLock</font></div><div><font size="2"   >LOCATION: &nbsp;LockAcquireExtended, lock.c:729</font></div><div><font size="2"   >LOG: &nbsp;00000: LockAcquire: new: lock(0x7f6970d12b00) id(16384,26061,0,1,3,1) grantMask(0) req(0,0,0,0,0,0,0)=0 grant(0,0,0,0,0,0,0)=0 wait(0) type(ExclusiveLock)</font></div><div><font size="2"   >LOCATION: &nbsp;LOCK_PRINT, lock.c:318</font></div><div><font size="2"   >LOG: &nbsp;00000: LockAcquire: new: proclock(0x7f6970d98440) lock(0x7f6970d12b00) method(1) proc(0x7f6971004860) hold(0)</font></div><div><font size="2"   >LOCATION: &nbsp;PROCLOCK_PRINT, lock.c:330</font></div><div><font size="2"   >LOG: &nbsp;00000: LockCheckConflicts: no conflict: proclock(0x7f6970d98440) lock(0x7f6970d12b00) method(1) proc(0x7f6971004860) hold(0)</font></div><div><font size="2"   >LOCATION: &nbsp;PROCLOCK_PRINT, lock.c:330</font></div><div><font size="2"   >LOG: &nbsp;00000: GrantLock: lock(0x7f6970d12b00) id(16384,26061,0,1,3,1) grantMask(80) req(0,0,0,0,0,0,1)=1 grant(0,0,0,0,0,0,1)=1 wait(0) type(ExclusiveLock)</font></div><div><font size="2"   >LOCATION: &nbsp;LOCK_PRINT, lock.c:318</font></div><div><font size="2"   >LOG: &nbsp;00000: process 6499 still waiting for ShareLock on transaction 3268512749 after 1000.118 ms</font></div><div><font size="2"   >LOCATION: &nbsp;ProcSleep, proc.c:1246</font></div><div><font size="2"   >LOG: &nbsp;00000: process 6499 acquired ShareLock on transaction 3268512749 after 5021.627 ms</font></div><div><font size="2"   >LOCATION: &nbsp;ProcSleep, proc.c:1250</font></div><div><font size="2"   >LOG: &nbsp;00000: LockRelease: lock [16384,26061] ExclusiveLock</font></div><div><font size="2"   >LOCATION: &nbsp;LockRelease, lock.c:1761</font></div><div><font size="2"   >LOG: &nbsp;00000: LockRelease: found: lock(0x7f6970d12b00) id(16384,26061,0,1,3,1) grantMask(80) req(0,0,0,0,0,0,1)=1 grant(0,0,0,0,0,0,1)=1 wait(0) type(ExclusiveLock)</font></div><div><font size="2"   >LOCATION: &nbsp;LOCK_PRINT, lock.c:318</font></div><div><font size="2"   >LOG: &nbsp;00000: LockRelease: found: proclock(0x7f6970d98440) lock(0x7f6970d12b00) method(1) proc(0x7f6971004860) hold(80)</font></div><div><font size="2"   >LOCATION: &nbsp;PROCLOCK_PRINT, lock.c:330</font></div><div><font size="2"   >LOG: &nbsp;00000: UnGrantLock: updated: lock(0x7f6970d12b00) id(16384,26061,0,1,3,1) grantMask(0) req(0,0,0,0,0,0,0)=0 grant(0,0,0,0,0,0,0)=0 wait(0) type(ExclusiveLock)</font></div><div><font size="2"   >LOCATION: &nbsp;LOCK_PRINT, lock.c:318</font></div><div><font size="2"   >LOG: &nbsp;00000: UnGrantLock: updated: proclock(0x7f6970d98440) lock(0x7f6970d12b00) method(1) proc(0x7f6971004860) hold(0)</font></div><div><font size="2"   >LOCATION: &nbsp;PROCLOCK_PRINT, lock.c:330</font></div><div><font size="2"   >LOG: &nbsp;00000: CleanUpLock: deleting: proclock(0x7f6970d98440) lock(0x7f6970d12b00) method(1) proc(0x7f6971004860) hold(0)</font></div><div><font size="2"   >LOCATION: &nbsp;PROCLOCK_PRINT, lock.c:330</font></div><div><font size="2"   >LOG: &nbsp;00000: CleanUpLock: deleting: lock(0x7f6970d12b00) id(16384,26061,0,1,3,1) grantMask(0) req(0,0,0,0,0,0,0)=0 grant(0,0,0,0,0,0,0)=0 wait(0) type(INVALID)</font></div><div><font size="2"   >LOCATION: &nbsp;LOCK_PRINT, lock.c:318</font></div><div><font size="2"   >LOG: &nbsp;00000: LockReleaseAll: lockmethod=1</font></div><div><font size="2"   >LOCATION: &nbsp;LockReleaseAll, lock.c:1954</font></div><div><font size="2"   >LOG: &nbsp;00000: LockReleaseAll done</font></div><div><font size="2"   >LOCATION: &nbsp;LockReleaseAll, lock.c:2199</font></div><div><font size="2"   >UPDATE 1</font></div><p></p></pre></div><div>3. 跟踪wal</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >#ifdef WAL_DEBUG</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >static void</font></div><div><font size="2"   >xlog_outrec(StringInfo buf, XLogRecord *record)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(buf, "prev %X/%X; xid %u",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(uint32) (record-&gt;xl_prev &gt;&gt; 32),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(uint32) record-&gt;xl_prev,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;record-&gt;xl_xid);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(buf, "; len %u",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;record-&gt;xl_len);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; for (i = 0; i &lt; XLR_MAX_BKP_BLOCKS; i++)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (record-&gt;xl_info &amp; XLR_BKP_BLOCK(i))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(buf, "; bkpb%d", i);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(buf, ": %s", RmgrTable[record-&gt;xl_rmid].rm_name);</font></div><div><font size="2"   >}</font></div><div><font size="2"   >#endif &nbsp; /* WAL_DEBUG */</font></div></div><div><font size="2"   >digoal=# set wal_debug=on;</font></div><div><div><font size="2"   >digoal=# select pg_switch_xlog();</font></div><div><font size="2"   >LOG: &nbsp;00000: INSERT @ 20E/D4BB2878: prev 20E/D4BB2848; xid 0; len 0: XLOG</font></div><div><font size="2"   >LOCATION: &nbsp;XLogInsert, xlog.c:1077</font></div><div><font size="2"   >&nbsp;pg_switch_xlog&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;20E/D4BB2898</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>其他跟踪方法, 本文不再举例.</div><div>1. stap</div><div>2. strace</div><div>3. gdb</div><div>...</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201302843359574/"   >http://blog.163.com/digoal@126/blog/static/163877040201302843359574/</a></div><div>2.&nbsp;src/include/utils/elog.h</div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/runtime-config-developer.html"   >http://www.postgresql.org/docs/9.3/static/runtime-config-developer.html</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/runtime-config-logging.html#RUNTIME-CONFIG-LOGGING-WHAT"   >http://www.postgresql.org/docs/9.3/static/runtime-config-logging.html#RUNTIME-CONFIG-LOGGING-WHAT</a></div></div>
	</div>
</div>
</body>
</html>