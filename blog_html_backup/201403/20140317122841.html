<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL customize log_statement by GetCommandLogLevel@src/backend/tcop/utility.c</h2>
	<h5 id="">2014-03-17 12:28:41&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201421702248430/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">PostgreSQL 的 log_statement参数用于配置数据库日志中记录SQL语句的级别.&nbsp;<wbr><div><dt style=" font-size: 12px;font-family: verdana, sans-serif; line-height: normal;"   ><tt>log_statement</tt>&nbsp;(<tt>enum</tt>)</dt><dd style=" font-size: 12px;font-family: verdana, sans-serif; line-height: normal;"   ><p style="font-size: 1em; margin: 1.2em 0em; line-height: 1.5em;"   >Controls which SQL statements are logged. Valid values are&nbsp;<tt>none</tt>&nbsp;(off),&nbsp;<tt>ddl</tt>,&nbsp;<tt>mod</tt>, and&nbsp;<tt>all</tt>&nbsp;(all statements).&nbsp;<tt>ddl</tt>&nbsp;logs all data definition statements, such as&nbsp;<tt>CREATE</tt>,&nbsp;<tt>ALTER</tt>, and&nbsp;<tt>DROP</tt>statements.&nbsp;<tt>mod</tt>&nbsp;logs all&nbsp;<tt>ddl</tt>&nbsp;statements, plus data-modifying statements such as&nbsp;<tt>INSERT</tt>,&nbsp;<tt>UPDATE</tt>,&nbsp;<tt>DELETE</tt>,&nbsp;<tt>TRUNCATE</tt>, and&nbsp;<tt>COPY FROM</tt>.&nbsp;<tt>PREPARE</tt>,&nbsp;<tt>EXECUTE</tt>, and&nbsp;<tt>EXPLAIN ANALYZE</tt>&nbsp;statements are also logged if their contained command is of an appropriate type. For clients using extended query protocol, logging occurs when an Execute message is received, and values of the Bind parameters are included (with any embedded single-quote marks doubled).</p><p style="font-size: 1em; margin: 1.2em 0em; line-height: 1.5em;"   >The default is&nbsp;<tt>none</tt>. Only superusers can change this setting.</p><div><blockquote style=" overflow: auto; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border: 1px solid rgb(219, 219, 204); border-bottom-right-radius: 8px; width: 572px;-webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; background-color: rgb(238, 238, 221); border-top-right-radius: 8px; border-top-left-radius: 8px; margin: 4ex auto; padding: 14px; border-bottom-left-radius: 8px;"   ><p style=" margin-bottom: 0px;font-size: 1em; margin-top: 0px; line-height: 1.5em;"   ><b>Note:</b>&nbsp;Statements that contain simple syntax errors are not logged even by the<tt>log_statement</tt>&nbsp;=&nbsp;<tt>all</tt>&nbsp;setting, because the log message is emitted only after basic parsing has been done to determine the statement type. In the case of extended query protocol, this setting likewise does not log statements that fail before the Execute phase (i.e., during parse analysis or planning). Set&nbsp;<tt>log_min_error_statement</tt>&nbsp;to&nbsp;<tt>ERROR</tt>&nbsp;(or lower) to log such statements.</p></blockquote></div></dd></div><div>如果配置为ALL的话, 将记录下所有的SQL语句. 对于特别重要的系统, 可以这么来做.</div><div>但是一般的系统, 且事务非常频繁的话, 开启ALL会产生大量的日志, 除了需要大量的存储空间, 对性能也有一定影响.</div><div>如果配置为DDL, 那么会记录下所有DDL的操作, 如果配置为MOD, 那么会记录所有的DML语句, 包含INSERT.</div><div>对于日志型的数据库, 可能产生大量的插入, 但是更新, 删除比较少, 如果不关心插入但是又要记下删除和更新的话, 我们没有好的选择, 因为要么就是配置ALL要么就是MOD, 但是MOD也包含了INSERT的记录.</div><div>这个时候, 我们可以通过修改代码来实现, 增加几个日志记录级别, 例如把insert, update, delete单独拎出来.</div><div>我这里图方便, 只是把INSERT语句改到ALL级别了. 如下 :</div><div>src/backend/tcop/utility.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* GetCommandLogLevel</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;utility to get the minimum log_statement level for a command,</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;given either a raw (un-analyzed) parsetree or a planned query.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* This must handle all command types, but since the vast majority</font></div><div><font size="2"   >&nbsp;* of 'em are utility commands, it seems sensible to keep it here.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >LogStmtLevel</font></div><div><font size="2"   >GetCommandLogLevel(Node *parsetree)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LogStmtLevel lev;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; switch (nodeTag(parsetree))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* raw plannable queries */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_InsertStmt: &nbsp;// 这个改一下</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_DeleteStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_UpdateStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lev = LOGSTMT_MOD;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_SelectStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (((SelectStmt *) parsetree)-&gt;intoClause)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lev = LOGSTMT_DDL; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* SELECT INTO */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lev = LOGSTMT_ALL;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* utility statements --- same whether raw or cooked */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_TransactionStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lev = LOGSTMT_ALL;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_DeclareCursorStmt:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lev = LOGSTMT_ALL;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><p></p></pre></div><div>改成如下 :&nbsp;</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_DeleteStmt:</font></span></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_UpdateStmt:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lev = LOGSTMT_MOD;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_InsertStmt: &nbsp;// 这个改一下</font></span></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lev = LOGSTMT_ALL;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div></div><p></p></pre></div></div><div>重新编译即可, 那么使用mod级别的话不再记录insert语句.</div><div>以上修改只对简单调用有效, 如果是prepared statement, 还需要修改以下部分对应的INSERT级别 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* already-planned queries */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_PlannedStmt:</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* parsed-and-rewritten-but-not-planned queries */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_Query:</font></div></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>