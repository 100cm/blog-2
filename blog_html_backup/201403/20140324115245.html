<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL patch : update/delete .. order by .. limit ..</h2>
	<h5 id="">2014-03-24 11:52:45&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014224113459340/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>这个特性目前还没有commit, 甚至不知道会不会commit, 但是它确实是一个非常好的特性.</div><div>例如我们要按照某条件, 根据时间倒序, 更新最近的一条记录.&nbsp;</div><div>原来的做法可能比较繁琐, 例如先select for update这条记录, 然后更新它. 或者把这个操作合并到函数或者inline language block中执行.</div><div>有了这个补丁后就变得简单了, 只需要update/delete .. where .. order by .. limit ..</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >+ &nbsp; If the &lt;literal&gt;ORDER BY&lt;/&gt; clause is present, the rows will be</font></div><div><font size="2"   >+ &nbsp; processed in the specified order. &nbsp;In its absence, rows are</font></div><div><font size="2"   >+ &nbsp; processed in whichever order the system finds fastest to</font></div><div><font size="2"   >+ &nbsp; produce.</font></div><div><font size="2"   >+ &nbsp;&lt;/para&gt;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp;&lt;para&gt;</font></div><div><font size="2"   >+ &nbsp; If the &lt;literal&gt;LIMIT&lt;/&gt; (or &lt;literal&gt;FETCH FIRST&lt;/&gt;) clause</font></div><div><font size="2"   >+ &nbsp; is present, processing will stop after the system has attempted</font></div><div><font size="2"   >+ &nbsp; to delete the specified amount of rows. &nbsp;In particular, if a row</font></div><div><font size="2"   >+ &nbsp; was concurrently changed not to match the given &lt;literal&gt;WHERE&lt;/&gt;</font></div><div><font size="2"   >+ &nbsp; clause, it will count towards the &lt;literal&gt;LIMIT&lt;/&gt; despite it</font></div><div><font size="2"   >+ &nbsp; not being actually deleted. &nbsp;Unlike in &lt;literal&gt;SELECT&lt;/&gt;, the</font></div><div><font size="2"   >+ &nbsp; &lt;literal&gt;OFFSET&lt;/literal&gt; clause is not available in</font></div><div><font size="2"   >+ &nbsp; &lt;literal&gt;DELETE&lt;/&gt;.</font></div><div><font size="2"   >+ &nbsp;&lt;/para&gt;</font></div><p></p></pre></div><div>我们来测试一下这个补丁.</div><div>首先下载一个开发版的postgresql源码.</div><div><a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=e85a5ffba8ae559b612b6fbc07acf1b16636887e"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=e85a5ffba8ae559b612b6fbc07acf1b16636887e</a></div><div>然后下载这个补丁</div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/message-id/flat/1393112801.59251.YahooMailNeo@web163006.mail.bf1.yahoo.com#1393112801.59251.YahooMailNeo@web163006.mail.bf1.yahoo.com"   >http://www.postgresql.org/message-id/flat/1393112801.59251.YahooMailNeo@web163006.mail.bf1.yahoo.com#1393112801.59251.YahooMailNeo@web163006.mail.bf1.yahoo.com</a></div><pre class="prettyprint"   ><p></p><div><font size="2"   >wget&nbsp;http://www.postgresql.org/message-id/attachment/32654/update_delete_order_by_limit_v2.diff</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >应用补丁 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >tar -zxvf&nbsp;<span style="line-height: 28px;"   >postgresql-e85a5ff.tar.gz</span></font></div><div><font size="2"   ># mv update_delete_order_by_limit_v2.diff postgresql-e85a5ff</font></div><div><font size="2"   ># cd postgresql-e85a5ff</font></div><div><font size="2"   ># patch -p1 &lt; ./update_delete_order_by_limit_v2.diff</font></div><div><font size="2"   ># ./configure --prefix=/home/pg94/pgsql9.4devel --with-pgport=1933 --with-perl --with-tcl --with-python --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=64 --with-blocksize=32 --enable-dtrace --enable-debug &amp;&amp; gmake &amp;&amp; gmake install</font></div><p></p></pre></div><div><br></div><div>测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table test(id int, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into test select generate_series(1,10),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >INSERT 0 10</font></div><div><font size="2"   >digoal=# select * from test;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | f56c42b659725bd8b38c85a3e4625819 | 2014-03-24 11:51:58.11588</font></div><div><font size="2"   >&nbsp; 2 | 63108e63ffcfc46532607656aa4ac0e8 | 2014-03-24 11:51:58.116047</font></div><div><font size="2"   >&nbsp; 3 | 229408f323ce9cf2ceb6f08317e2a824 | 2014-03-24 11:51:58.116058</font></div><div><font size="2"   >&nbsp; 4 | 59de2a967344a0395ee3a656f346488e | 2014-03-24 11:51:58.116065</font></div><div><font size="2"   >&nbsp; 5 | 71ef0f4d0dbe4e7b256f8baa5e977a00 | 2014-03-24 11:51:58.116072</font></div><div><font size="2"   >&nbsp; 6 | 2c84fdc617e5d538586f2ce01a0bc650 | 2014-03-24 11:51:58.116078</font></div><div><font size="2"   >&nbsp; 7 | ea5a5d78f0f71d4d20905e52dad388a2 | 2014-03-24 11:51:58.116085</font></div><div><font size="2"   >&nbsp; 8 | 924ca225fa2e7951b81b811f0313feca | 2014-03-24 11:51:58.116091</font></div><div><font size="2"   >&nbsp; 9 | e7edea0cf4f2fde613d401088263551c | 2014-03-24 11:51:58.116099</font></div><div><font size="2"   >&nbsp;10 | b43e8ea178f9ba4793726bd504b9de05 | 2014-03-24 11:51:58.116105</font></div><div><font size="2"   >(10 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# update test set info='new' order by crt_time desc limit 1;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >digoal=# select * from test;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | f56c42b659725bd8b38c85a3e4625819 | 2014-03-24 11:51:58.11588</font></div><div><font size="2"   >&nbsp; 2 | 63108e63ffcfc46532607656aa4ac0e8 | 2014-03-24 11:51:58.116047</font></div><div><font size="2"   >&nbsp; 3 | 229408f323ce9cf2ceb6f08317e2a824 | 2014-03-24 11:51:58.116058</font></div><div><font size="2"   >&nbsp; 4 | 59de2a967344a0395ee3a656f346488e | 2014-03-24 11:51:58.116065</font></div><div><font size="2"   >&nbsp; 5 | 71ef0f4d0dbe4e7b256f8baa5e977a00 | 2014-03-24 11:51:58.116072</font></div><div><font size="2"   >&nbsp; 6 | 2c84fdc617e5d538586f2ce01a0bc650 | 2014-03-24 11:51:58.116078</font></div><div><font size="2"   >&nbsp; 7 | ea5a5d78f0f71d4d20905e52dad388a2 | 2014-03-24 11:51:58.116085</font></div><div><font size="2"   >&nbsp; 8 | 924ca225fa2e7951b81b811f0313feca | 2014-03-24 11:51:58.116091</font></div><div><font size="2"   >&nbsp; 9 | e7edea0cf4f2fde613d401088263551c | 2014-03-24 11:51:58.116099</font></div><div><font size="2"   >&nbsp;10 | new &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2014-03-24 11:51:58.116105</font></div><div><font size="2"   >(10 rows)</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=e85a5ffba8ae559b612b6fbc07acf1b16636887e"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=e85a5ffba8ae559b612b6fbc07acf1b16636887e</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/message-id/1393112801.59251.YahooMailNeo@web163006.mail.bf1.yahoo.com"   >http://www.postgresql.org/message-id/1393112801.59251.YahooMailNeo@web163006.mail.bf1.yahoo.com</a></div></div>
	</div>
</div>
</body>
</html>