<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL index page reclaim must vacuum twice ?</h2>
	<h5 id="">2014-03-28 16:03:05&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201422823228214/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>我在测试一个索引页的回收利用时, 发现索引页必须两次vacuum才能被复用.</div><div><span style="line-height: 28px;"   >第一次vacuum时, main fork的freespace map文件会生成, 但是不生成索引的free space map文件.&nbsp;</span></div><div><span style="line-height: 28px;"   >具体原因参见 :&nbsp;</span></div><div>src/backend/access/nbtree/README</div><div>索引page的回收分两个阶段, 第一个阶段把页面变成half dead状态, 第二个阶段才回收它.</div><div><span style="line-height: 28px;"   ><br></span></div><div>索引页的重复利用必须符合1个条件, 页面中没有任何引用才行.</div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/routine-reindex.html"   >http://www.postgresql.org/docs/9.3/static/routine-reindex.html</a></div><div><pre class="prettyprint"   ><p><font size="2"   >B-tree index pages that have become completely empty are reclaimed for re-use. However, there is still a possibility of inefficient use of space: if all but a few index keys on a page have been deleted, the page remains allocated. Therefore, a usage pattern in which most, but not all, keys in each range are eventually deleted will see poor use of space. For such usage patterns, periodic reindexing is recommended.</font></p></pre></div><div><br></div><div>我们需要一个工具来观察索引页的引用或条目.</div><div>同时为了观察方便, 先把autovacuum关闭.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create extension pageinspect;</font></div><div><font size="2"   >CREATE EXTENSION</font></div><p></p></pre></div><div>创建测试表</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table test(id int primary key, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into test select generate_series(1,5000000),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >INSERT 0 5000000</font></div><p></p></pre></div><div>查看索引metapage的信息</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from bt_metap('test_pkey');</font></div><div><font size="2"   >&nbsp;magic &nbsp;| version | root | level | fastroot | fastlevel&nbsp;</font></div><div><font size="2"   >--------+---------+------+-------+----------+-----------</font></div><div><font size="2"   >&nbsp;340322 | &nbsp; &nbsp; &nbsp; 2 | 1640 | &nbsp; &nbsp; 2 | &nbsp; &nbsp; 1640 | &nbsp; &nbsp; &nbsp; &nbsp; 2</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>查看索引页1的状态信息</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from bt_page_stats('test_pkey', 1);</font></div><div><font size="2"   >&nbsp;blkno | type | live_items | dead_items | avg_item_size | page_size | free_size | btpo_prev | btpo_next | btpo | btpo_flags&nbsp;</font></div><div><font size="2"   >-------+------+------------+------------+---------------+-----------+-----------+-----------+-----------+------+------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;1 | l &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 1472 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16 | &nbsp; &nbsp; 32768 | &nbsp; &nbsp; &nbsp;3284 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >查看索引页2的状态信息</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from bt_page_stats('test_pkey', 2);</font></div><div><font size="2"   >&nbsp;blkno | type | live_items | dead_items | avg_item_size | page_size | free_size | btpo_prev | btpo_next | btpo | btpo_flags&nbsp;</font></div><div><font size="2"   >-------+------+------------+------------+---------------+-----------+-----------+-----------+-----------+------+------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;2 | l &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 1472 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16 | &nbsp; &nbsp; 32768 | &nbsp; &nbsp; &nbsp;3284 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; 4 | &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div>查看索引页的引用信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from bt_page_items('test_pkey', 1);</font></div><div><font size="2"   >&nbsp;itemoffset | &nbsp;ctid &nbsp; | itemlen | nulls | vars | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------+---------+---------+-------+------+-------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | (3,182) | &nbsp; &nbsp; &nbsp;16 | f &nbsp; &nbsp; | f &nbsp; &nbsp;| c0 05 00 00 00 00 00 00</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | (0,1) &nbsp; | &nbsp; &nbsp; &nbsp;16 | f &nbsp; &nbsp; | f &nbsp; &nbsp;| 01 00 00 00 00 00 00 00</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3 | (0,2) &nbsp; | &nbsp; &nbsp; &nbsp;16 | f &nbsp; &nbsp; | f &nbsp; &nbsp;| 02 00 00 00 00 00 00 00</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 | (0,3) &nbsp; | &nbsp; &nbsp; &nbsp;16 | f &nbsp; &nbsp; | f &nbsp; &nbsp;| 03 00 00 00 00 00 00 00</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 | (0,4) &nbsp; | &nbsp; &nbsp; &nbsp;16 | f &nbsp; &nbsp; | f &nbsp; &nbsp;| 04 00 00 00 00 00 00 00</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 6 | (0,5) &nbsp; | &nbsp; &nbsp; &nbsp;16 | f &nbsp; &nbsp; | f &nbsp; &nbsp;| 05 00 00 00 00 00 00 00</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 7 | (0,6) &nbsp; | &nbsp; &nbsp; &nbsp;16 | f &nbsp; &nbsp; | f &nbsp; &nbsp;| 06 00 00 00 00 00 00 00</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8 | (0,7) &nbsp; | &nbsp; &nbsp; &nbsp;16 | f &nbsp; &nbsp; | f &nbsp; &nbsp;| 07 00 00 00 00 00 00 00</font></div><div><font size="2"   >&nbsp; &nbsp; ..... 中间 略去</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1471 | (3,180) | &nbsp; &nbsp; &nbsp;16 | f &nbsp; &nbsp; | f &nbsp; &nbsp;| be 05 00 00 00 00 00 00</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1472 | (3,181) | &nbsp; &nbsp; &nbsp;16 | f &nbsp; &nbsp; | f &nbsp; &nbsp;| bf 05 00 00 00 00 00 00</font></div><div><font size="2"   >(1472 rows)</font></div><p></p></pre></div><div>删除数据, 仅保留一行.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# delete from test where id&lt;&gt;5000000;</font></div><div><font size="2"   >DELETE 4999999</font></div><p></p></pre></div><div>第一次vacuum , 注意<span style="line-height: 28px;"   >3398 index pages have been deleted, 0 are currently reusable.</span></div><div><span style="line-height: 28px;"   >重用页为0, 为什么呢?</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# vacuum verbose analyze test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.test"</font></div><div><font size="2"   >INFO: &nbsp;scanned index "test_pkey" to remove 4999999 row versions</font></div><div><font size="2"   >DETAIL: &nbsp;CPU 0.00s/1.75u sec elapsed 1.77 sec.</font></div><div><font size="2"   >INFO: &nbsp;"test": removed 4999999 row versions in 11628 pages</font></div><div><font size="2"   >DETAIL: &nbsp;CPU 0.00s/0.19u sec elapsed 0.22 sec.</font></div><div><font size="2"   >INFO: &nbsp;index "test_pkey" now contains 1 row versions in 3404 pages</font></div><div><font size="2"   >DETAIL: &nbsp;4999999 index row versions were removed.</font></div><div><font size="2"   >3398 index pages have been deleted, 0 are currently reusable.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;"test": found 4999999 removable, 1 nonremovable row versions in 11628 out of 11628 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.01s/2.83u sec elapsed 2.91 sec.</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "pg_toast.pg_toast_16432"</font></div><div><font size="2"   >INFO: &nbsp;index "pg_toast_16432_index" now contains 0 row versions in 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 index row versions were removed.</font></div><div><font size="2"   >0 index pages have been deleted, 0 are currently reusable.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;"pg_toast_16432": found 0 removable, 0 nonremovable row versions in 0 out of 0 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;analyzing "public.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": scanned 11628 of 11628 pages, containing 1 live rows and 0 dead rows; 1 rows in sample, 1 estimated total rows</font></div><div><font size="2"   >VACUUM</font></div><p></p></pre></div><div>为什么重用页为0呢? 我们要使用pageinspect插件来看看第一次vacuum后的索引页的内容.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from bt_metap('test_pkey');</font></div><div><font size="2"   >&nbsp;magic &nbsp;| version | root | level | fastroot | fastlevel&nbsp;</font></div><div><font size="2"   >--------+---------+------+-------+----------+-----------</font></div><div><font size="2"   >&nbsp;340322 | &nbsp; &nbsp; &nbsp; 2 | 1640 | &nbsp; &nbsp; 2 | &nbsp; &nbsp; 3403 | &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>标记为删除状态的索引页状态信息, d表示已删除, 理论上来说, 这个状态的页可以回收重复利用 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from bt_page_stats('test_pkey', 1);</font></div><div><font size="2"   >&nbsp;blkno | type | live_items | dead_items | avg_item_size | page_size | free_size | btpo_prev | btpo_next | btpo | btpo_flags&nbsp;</font></div><div><font size="2"   >-------+------+------------+------------+---------------+-----------+-----------+-----------+-----------+------+------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;1 | d &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; 32768 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;-1 | &nbsp; &nbsp; &nbsp; &nbsp;-1 | 1857 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select * from bt_page_stats('test_pkey', 2);</font></div><div><font size="2"   >&nbsp;blkno | type | live_items | dead_items | avg_item_size | page_size | free_size | btpo_prev | btpo_next | btpo | btpo_flags&nbsp;</font></div><div><font size="2"   >-------+------+------------+------------+---------------+-----------+-----------+-----------+-----------+------+------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;2 | d &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; 32768 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;-1 | &nbsp; &nbsp; &nbsp; &nbsp;-1 | 1857 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>保留的root页和leaf页信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from bt_page_stats('test_pkey', 1640);</font></div><div><font size="2"   >&nbsp;blkno | type | live_items | dead_items | avg_item_size | page_size | free_size | btpo_prev | btpo_next | btpo | btpo_flags&nbsp;</font></div><div><font size="2"   >-------+------+------------+------------+---------------+-----------+-----------+-----------+-----------+------+------------</font></div><div><font size="2"   >&nbsp; 1640 | r &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8 | &nbsp; &nbsp; 32768 | &nbsp; &nbsp; 32712 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select * from bt_page_stats('test_pkey', 3403);</font></div><div><font size="2"   >&nbsp;blkno | type | live_items | dead_items | avg_item_size | page_size | free_size | btpo_prev | btpo_next | btpo | btpo_flags&nbsp;</font></div><div><font size="2"   >-------+------+------------+------------+---------------+-----------+-----------+-----------+-----------+------+------------</font></div><div><font size="2"   >&nbsp; 3403 | l &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16 | &nbsp; &nbsp; 32768 | &nbsp; &nbsp; 32704 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div>对于标记为删除的索引页, 我们看看它的引用, 保留了第一条引用, 其他的都删除了</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from bt_page_items('test_pkey', 1);</font></div><div><font size="2"   >NOTICE: &nbsp;page is deleted</font></div><div><font size="2"   >&nbsp;itemoffset | &nbsp;ctid &nbsp; | itemlen | nulls | vars | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------+---------+---------+-------+------+-------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | (3,182) | &nbsp; &nbsp; &nbsp;16 | f &nbsp; &nbsp; | f &nbsp; &nbsp;| c0 05 00 00 00 00 00 00</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select * from bt_page_items('test_pkey', 2);</font></div><div><font size="2"   >NOTICE: &nbsp;page is deleted</font></div><div><font size="2"   >&nbsp;itemoffset | &nbsp;ctid &nbsp; | itemlen | nulls | vars | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------+---------+---------+-------+------+-------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | (6,363) | &nbsp; &nbsp; &nbsp;16 | f &nbsp; &nbsp; | f &nbsp; &nbsp;| 7f 0b 00 00 00 00 00 00</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>保留页的前后页也被删除了 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from bt_page_items('test_pkey', 1640);</font></div><div><font size="2"   >&nbsp;itemoffset | &nbsp; ctid &nbsp; | itemlen | nulls | vars | data&nbsp;</font></div><div><font size="2"   >------------+----------+---------+-------+------+------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | (2786,1) | &nbsp; &nbsp; &nbsp; 8 | f &nbsp; &nbsp; | f &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><div style="line-height: 28px;"   ><font size="2"   >digoal=# select * from bt_page_items('test_pkey', 1641);</font></div><div style="line-height: 28px;"   ><font size="2"   >NOTICE: &nbsp;page is deleted</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;itemoffset | &nbsp; &nbsp;ctid &nbsp; &nbsp;| itemlen | nulls | vars | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >------------+------------+---------+-------+------+-------------------------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | (5603,209) | &nbsp; &nbsp; &nbsp;16 | f &nbsp; &nbsp; | f &nbsp; &nbsp;| 1b c4 24 00 00 00 00 00</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div></div><div><font size="2"   >digoal=# select * from bt_page_items('test_pkey', 3403);</font></div><div><font size="2"   >&nbsp;itemoffset | &nbsp; &nbsp;ctid &nbsp; &nbsp; | itemlen | nulls | vars | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------+-------------+---------+-------+------+-------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | (11627,390) | &nbsp; &nbsp; &nbsp;16 | f &nbsp; &nbsp; | f &nbsp; &nbsp;| 40 4b 4c 00 00 00 00 00</font></div><div><font size="2"   >(1 row)</font></div><div><div><font size="2"   >digoal=# select * from bt_page_items('test_pkey', 3402);</font></div><div><font size="2"   >NOTICE: &nbsp;page is deleted</font></div><div><font size="2"   >&nbsp;itemoffset | &nbsp; &nbsp;ctid &nbsp; &nbsp; | itemlen | nulls | vars | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------+-------------+---------+-------+------+-------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | (11624,139) | &nbsp; &nbsp; &nbsp;16 | f &nbsp; &nbsp; | f &nbsp; &nbsp;| 3b 45 4c 00 00 00 00 00</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>保留的索引页, 只有leaf页是能检索到数据的.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from test where ctid='(11627,390)';</font></div><div><font size="2"   >&nbsp; &nbsp;id &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------+----------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp;5000000 | 50695277872b9da4d56b962a747556c2 | 2014-03-28 14:31:58.849432</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select * from test where ctid='(2786,1)';</font></div><div><font size="2"   >&nbsp;id | info | crt_time&nbsp;</font></div><div><font size="2"   >----+------+----------</font></div><div><font size="2"   >(0 rows)</font></div><p></p></pre></div></div><div>第一次vacuum后, 索引占用的pages不变 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select relpages from pg_class where relname='test_pkey';</font></div><div><font size="2"   >&nbsp;relpages&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;3404</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>这个时候, 如果往这个表插入数据, 被删除的索引页不会被重用, 原因是它们还保留了1条引用, 所以这个索引页是不能被重用的.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# insert into test select generate_series(1,4999999),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >INSERT 0 4999999</font></div></div><div><div><font size="2"   >digoal=# \di+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; Name &nbsp; &nbsp;| Type &nbsp;| &nbsp;Owner &nbsp; | Table | &nbsp;Size &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+-----------+-------+----------+-------+--------+-------------</font></div><div><font size="2"   >&nbsp;public | test_pkey | index | postgres | test &nbsp;| 213 MB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>接下来, 我们测试同样的场景, 只是在删除数据后, 执行两次vacuum.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# truncate test;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >digoal=# insert into test select generate_series(1,5000000),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >INSERT 0&nbsp;<span style="line-height: 28px;"   >5000000</span></font></div><div><font size="2"   >digoal=# delete from test where id&lt;&gt;5000000;</font></div><div><font size="2"   >DELETE 4999999</font></div><p></p></pre></div><div>第一次vacuum, 注意看<span style="line-height: 28px;"   >3398 index pages have been deleted, 0 are currently reusable.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# vacuum verbose analyze test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.test"</font></div><div><font size="2"   >INFO: &nbsp;scanned index "test_pkey" to remove 4999999 row versions</font></div><div><font size="2"   >DETAIL: &nbsp;CPU 0.00s/1.75u sec elapsed 1.77 sec.</font></div><div><font size="2"   >INFO: &nbsp;"test": removed 4999999 row versions in 11628 pages</font></div><div><font size="2"   >DETAIL: &nbsp;CPU 0.00s/0.19u sec elapsed 0.22 sec.</font></div><div><font size="2"   >INFO: &nbsp;index "test_pkey" now contains 1 row versions in 3404 pages</font></div><div><font size="2"   >DETAIL: &nbsp;4999999 index row versions were removed.</font></div><div><font size="2"   >3398 index pages have been deleted, 0 are currently reusable.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;"test": found 4999999 removable, 1 nonremovable row versions in 11628 out of 11628 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/2.84u sec elapsed 2.91 sec.</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "pg_toast.pg_toast_16432"</font></div><div><font size="2"   >INFO: &nbsp;index "pg_toast_16432_index" now contains 0 row versions in 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 index row versions were removed.</font></div><div><font size="2"   >0 index pages have been deleted, 0 are currently reusable.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;"pg_toast_16432": found 0 removable, 0 nonremovable row versions in 0 out of 0 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;analyzing "public.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": scanned 11628 of 11628 pages, containing 1 live rows and 0 dead rows; 1 rows in sample, 1 estimated total rows</font></div><div><font size="2"   >VACUUM</font></div><p></p></pre></div><div>第一次vacuum后, 没有生成索引的free space map文件.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from fsm_page_contents(get_raw_page('test_pkey','fsm',0));</font></div><div><font size="2"   >ERROR: &nbsp;could not open file "base/16384/16471_fsm": No such file or directory</font></div><div><font size="2"   >digoal=# select * from fsm_page_contents(get_raw_page('test_pkey','fsm',1));</font></div><div><font size="2"   >ERROR: &nbsp;could not open file "base/16384/16471_fsm": No such file or directory</font></div><div><font size="2"   >digoal=# select * from fsm_page_contents(get_raw_page('test_pkey','fsm',2));</font></div><div><font size="2"   >ERROR: &nbsp;could not open file "base/16384/16471_fsm": No such file or directory</font></div><p></p></pre></div><div><br></div><div>第二次vacuum, 注意看<span style="line-height: 28px;"   >3400 index pages have been deleted, 3400 are currently reusable.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# vacuum verbose analyze test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.test"</font></div><div><font size="2"   >INFO: &nbsp;index "test_pkey" now contains 1 row versions in 3404 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 index row versions were removed.</font></div><div><font size="2"   >3400 index pages have been deleted, 3400 are currently reusable.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;"test": found 0 removable, 0 nonremovable row versions in 0 out of 11628 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "pg_toast.pg_toast_16432"</font></div><div><font size="2"   >INFO: &nbsp;index "pg_toast_16432_index" now contains 0 row versions in 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 index row versions were removed.</font></div><div><font size="2"   >0 index pages have been deleted, 0 are currently reusable.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;"pg_toast_16432": found 0 removable, 0 nonremovable row versions in 0 out of 0 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;analyzing "public.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": scanned 11628 of 11628 pages, containing 1 live rows and 0 dead rows; 1 rows in sample, 1 estimated total rows</font></div><div><font size="2"   >VACUUM</font></div><p></p></pre></div><div>第二次vacuum后, 我们看一下被删除的索引页的引用是否被全部清除了. 因为如果被全部清除了, 才能被重用.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from bt_page_items('test_pkey', 1);</font></div><div><font size="2"   >NOTICE: &nbsp;page is deleted</font></div><div><font size="2"   >&nbsp;itemoffset | &nbsp;ctid &nbsp; | itemlen | nulls | vars | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------+---------+---------+-------+------+-------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | (3,182) | &nbsp; &nbsp; &nbsp;16 | f &nbsp; &nbsp; | f &nbsp; &nbsp;| c0 05 00 00 00 00 00 00</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select * from bt_page_items('test_pkey', 2);</font></div><div><font size="2"   >NOTICE: &nbsp;page is deleted</font></div><div><font size="2"   >&nbsp;itemoffset | &nbsp;ctid &nbsp; | itemlen | nulls | vars | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------+---------+---------+-------+------+-------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | (6,363) | &nbsp; &nbsp; &nbsp;16 | f &nbsp; &nbsp; | f &nbsp; &nbsp;| 7f 0b 00 00 00 00 00 00</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>使用pageinspece看不出来和第一次vacuum的差别. 但是free space map文件生成了.</div><div>(值得注意的是, 第一次vacuum时, main fork的freespace map文件会生成, 但是为什么不生成索引的free space map文件呢?)</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select * from fsm_page_contents(get_raw_page('test_pkey','fsm',0));</font></div><div><font size="2"   >&nbsp;fsm_page_contents&nbsp;</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp;0: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;1: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;3: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;7: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;15: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;31: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;63: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;127: 255 &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;255: 255 &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;511: 255 &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;1023: 255 &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;2047: 255 &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;4095: 255 &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;8191: 255 &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;16383: 255 &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;fp_next_slot: 0 &nbsp;+</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from fsm_page_contents(get_raw_page('test_pkey','fsm',1));</font></div><div><font size="2"   >&nbsp;fsm_page_contents&nbsp;</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp;0: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;1: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;3: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;7: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;15: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;31: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;63: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;127: 255 &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;255: 255 &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;511: 255 &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;1023: 255 &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;2047: 255 &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;4095: 255 &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;8191: 255 &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;16383: 255 &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;fp_next_slot: 0 &nbsp;+</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from fsm_page_contents(get_raw_page('test_pkey','fsm',2));</font></div><div><font size="2"   >&nbsp;fsm_page_contents&nbsp;</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp;0: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;1: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;3: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;7: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;15: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;31: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;63: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;64: 255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;127: 255 &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;128: 255 &nbsp; &nbsp; &nbsp; &nbsp; +</font></div></div><div><font size="2"   >... 略去</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >第二次vacuum后, 插入数据, 索引页清除并更新了free space map, 所以重新插入数据是, 索引页从fsm取, 不需要extend index main fork, 因此索引没有膨胀.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into test select generate_series(1,4999999),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >INSERT 0 4999999</font></div><div><font size="2"   >digoal=# \di+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; Name &nbsp; &nbsp;| Type &nbsp;| &nbsp;Owner &nbsp; | Table | &nbsp;Size &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+-----------+-------+----------+-------+--------+-------------</font></div><div><font size="2"   >&nbsp;public | test_pkey | index | postgres | test &nbsp;| 106 MB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/routine-reindex.html"   >http://www.postgresql.org/docs/9.3/static/routine-reindex.html</a></div><div>2.&nbsp;src/backend/access/nbtree/README</div><wbr></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">xmarker - 2014-06-23 13:57:51</h5>
				<div>德哥，这个问题怎么解决呢，只能靠两次vacuum么，这算是pg的bug吧？<br><br></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 xmarker - 2014-06-23 13:57:51</h5>
				<div style="width:600px;">目前是的.</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 xmarker - 2014-06-23 13:57:51</h5>
				<div style="width:600px;">不是BUG.</div>
			</div>
	</div>
</div>
</body>
</html>