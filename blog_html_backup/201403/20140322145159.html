<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL DBA's Bad habits Case</h2>
	<h5 id="">2014-03-22 14:51:59&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014221540439/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在数据库管理过程中, 你可能会遇到这样的场景, 某些表的数据因为某些原因可能要备份一份存档.</div><div>例如tbl表, 我们要保留当天的一个镜像, 这个镜像数据可能后期不会使用, 也可能因为某种原因要回退到这个镜像.</div><div>一般的做法可能是直接生成一份同样的表, 例如.</div><div>create table tbl_20140322 as select * from tbl;</div><div>这样的话, 数据库中多了一份和当前的tbl一样的数据, 这种表数据库中仅仅是多占用了一些空间这么简单吗?</div><div>那么会有哪些副作用呢?</div><div>1. 增加存储空间. 同时也增加了物理备份的存储空间.</div><div>2. 增加逻辑备份的时间, 当然你可以在备份时排除这个表.</div><div>3. 逻辑备份由于需要开启一个repeatable read事务, 备份时间越长, 对垃圾回收影响就越大.</div><div>4. 这点可能是容易忽略的, 那就是因为PostgreSQL的MVCC机制, 每条记录上都有一个事务信息, 这个事务信息在随着数据库新事务的产生是需要freeze的. freeze即把xmin改成frozenid, 因此会产生IO操作, 同时也会产生XLOG信息. 如果这种表比较大的话, 这个负面影响也是比较大的. 具体原理参看http://blog.163.com/digoal@126/blog/static/163877040201412282455978/.</div><div>我们来举一个例子 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create table tbl(id int, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >digoal=# insert into tbl select generate_series(1,100000000),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >INSERT 0 100000000</font></div><div><font size="2"   >digoal=# \dt+ tbl</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | Name | Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp;Size &nbsp; | Description&nbsp;</font></div><div><font size="2"   >--------+------+-------+----------+---------+-------------</font></div><div><font size="2"   >&nbsp;public | tbl &nbsp;| table | postgres | 7268 MB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=# create table tbl_20140322 as select * from tbl;</font></div><div><font size="2"   >SELECT 100000000</font></div></div><div><div><font size="2"   >digoal=# select txid_current(),relname,age(relfrozenxid) from pg_class where relname='tbl_20140322';</font></div><div><font size="2"   >&nbsp;txid_current | &nbsp; relname &nbsp; &nbsp;| age&nbsp;</font></div><div><font size="2"   >--------------+--------------+-----</font></div><div><font size="2"   >&nbsp; &nbsp;3269512911 | tbl_20140322 | &nbsp; 0</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select txid_current(),relname,age(relfrozenxid) from pg_class where relname='tbl_20140322';</font></div><div><font size="2"   >&nbsp;txid_current | &nbsp; relname &nbsp; &nbsp;| age&nbsp;</font></div><div><font size="2"   >--------------+--------------+-----</font></div><div><font size="2"   >&nbsp; &nbsp;3269512912 | tbl_20140322 | &nbsp; 1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select txid_current(),relname,age(relfrozenxid) from pg_class where relname='tbl_20140322';</font></div><div><font size="2"   >&nbsp;txid_current | &nbsp; relname &nbsp; &nbsp;| age&nbsp;</font></div><div><font size="2"   >--------------+--------------+-----</font></div><div><font size="2"   >&nbsp; &nbsp;3269512913 | tbl_20140322 | &nbsp; 2</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=# vacuum freeze tbl_20140322 ;</font></div><div><font size="2"   >VACUUM</font></div><div><font size="2"   >digoal=# select txid_current(),relname,age(relfrozenxid) from pg_class where relname='tbl_20140322';</font></div><div><font size="2"   >&nbsp;txid_current | &nbsp; relname &nbsp; &nbsp;| age&nbsp;</font></div><div><font size="2"   >--------------+--------------+-----</font></div><div><font size="2"   >&nbsp; &nbsp;3269512914 | tbl_20140322 | &nbsp; 0</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select txid_current(),relname,age(relfrozenxid) from pg_class where relname='tbl_20140322';</font></div><div><font size="2"   >&nbsp;txid_current | &nbsp; relname &nbsp; &nbsp;| age&nbsp;</font></div><div><font size="2"   >--------------+--------------+-----</font></div><div><font size="2"   >&nbsp; &nbsp;3269512915 | tbl_20140322 | &nbsp; 1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select txid_current(),relname,age(relfrozenxid) from pg_class where relname='tbl_20140322';</font></div><div><font size="2"   >&nbsp;txid_current | &nbsp; relname &nbsp; &nbsp;| age&nbsp;</font></div><div><font size="2"   >--------------+--------------+-----</font></div><div><font size="2"   >&nbsp; &nbsp;3269512916 | tbl_20140322 | &nbsp; 2</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_current_xlog_insert_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_insert_location&nbsp;</font></div><div><font size="2"   >---------------------------------</font></div><div><font size="2"   >&nbsp;218/D8DCDA60</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><div>第一次vacuum freeze, 产生数据文件的读和写IO, 以及写相应的xlog.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# vacuum (freeze,verbose) tbl_20140322 ;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.tbl_20140322"</font></div><div><font size="2"   >INFO: &nbsp;"tbl_20140322": found 0 removable, 100000000 nonremovable row versions in 232559 out of 232559 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 14.32s/66.81u sec elapsed 182.06 sec.</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "pg_toast.pg_toast_26123"</font></div><div><font size="2"   >INFO: &nbsp;index "pg_toast_26123_index" now contains 0 row versions in 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 index row versions were removed.</font></div><div><font size="2"   >0 index pages have been deleted, 0 are currently reusable.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;"pg_toast_26123": found 0 removable, 0 nonremovable row versions in 0 out of 0 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><div><font size="2"   >digoal=# select pg_current_xlog_insert_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_insert_location&nbsp;</font></div><div><font size="2"   >---------------------------------</font></div><div><font size="2"   >&nbsp;21A/A040AF70</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div>这次vacuum freeze产生的XLOG写入量和表差不多大.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select pg_xlog_location_diff('21A/A040AF70','218/D8DCDA60')/1024/1024.0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;?column? &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;7286.2395172119140625</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>接下来我们模拟在数据库中产生一定量的的事务.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; vi test.sql</font></div><div><font size="2"   >select txid_current();</font></div><div><span style="line-height: 28px;"   ><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -T 30</font></span></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 681050</font></div><div><font size="2"   >tps = 22701.077952 (including connections establishing)</font></div><div><font size="2"   >tps = 22712.325750 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.702341 &nbsp; &nbsp; &nbsp; &nbsp;select txid_current();</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -T 300</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 300 s</font></div><div><font size="2"   >number of transactions actually processed: 6842670</font></div><div><font size="2"   >tps = 22808.842446 (including connections establishing)</font></div><div><font size="2"   >tps = 22810.005145 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.699292 &nbsp; &nbsp; &nbsp; &nbsp;select txid_current();</font></div><p></p></pre></div><div>执行检查点.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.3.3)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><p></p></pre></div><div>查看当前表的年龄, 已经随着事务的增长而增长了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select txid_current(),relname,age(relfrozenxid) from pg_class where relname='tbl_20140322';</font></div><div><font size="2"   >&nbsp;txid_current | &nbsp; relname &nbsp; &nbsp;| &nbsp; age &nbsp;&nbsp;</font></div><div><font size="2"   >--------------+--------------+---------</font></div><div><font size="2"   >&nbsp; &nbsp;3277036664 | tbl_20140322 | 7523720</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>记录当前的XLOG位置.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select pg_current_xlog_insert_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_insert_location&nbsp;</font></div><div><font size="2"   >---------------------------------</font></div><div><font size="2"   >&nbsp;21A/B5C9C768</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>执行vacuum freeze (这个操作在到一定时候也会自动发送, 我们这里只是模拟它立刻发生)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# vacuum (freeze,verbose) tbl_20140322 ;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.tbl_20140322"</font></div><div><font size="2"   >INFO: &nbsp;"tbl_20140322": found 0 removable, 100000000 nonremovable row versions in 232559 out of 232559 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 2.12s/11.14u sec elapsed 15.86 sec.</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "pg_toast.pg_toast_26123"</font></div><div><font size="2"   >INFO: &nbsp;index "pg_toast_26123_index" now contains 0 row versions in 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 index row versions were removed.</font></div><div><font size="2"   >0 index pages have been deleted, 0 are currently reusable.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;"pg_toast_26123": found 0 removable, 0 nonremovable row versions in 0 out of 0 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><p></p></pre></div><div>记录vacuum freeze后的XLOG位置</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select pg_current_xlog_insert_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_insert_location&nbsp;</font></div><div><font size="2"   >---------------------------------</font></div><div><font size="2"   >&nbsp;21A/B5CA3B10</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>第二次vacuum freeze, 这个表还是要全部扫描一遍的, 所以产生了大量的读IO, 但是仅仅产生少量的写IO, 以及少量的XLOG.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select pg_xlog_location_diff('21A/B5CA3B10','21A/B5C9C768')/1024/1024.0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------</font></div><div><font size="2"   >&nbsp;0.02823638916015625000</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>执行完vacuum freeze后, 年龄回到0.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select txid_current(),relname,age(relfrozenxid) from pg_class where relname='tbl_20140322';</font></div><div><font size="2"   >&nbsp;txid_current | &nbsp; relname &nbsp; &nbsp;| age&nbsp;</font></div><div><font size="2"   >--------------+--------------+-----</font></div><div><font size="2"   >&nbsp; &nbsp;3277036665 | tbl_20140322 | &nbsp; 0</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div>为什么第二次只产生了少量的写, 因为第一次vacuum freeze后, tuple的xmin以及变更成FrozenXID了, 只是在pg_class.relfrozenxid还记录了VACUUM是的事务号, 所以第二次不需要再变更tuple上的xmin , 只需要变更<span style="line-height: 28px;"   >pg_class.relfrozenxid.</span></div><div><span style="line-height: 28px;"   >我们可以看到vacuum freeze后xmin变更成FrozenXID, 所以以后不需要再修改tuple的xmin.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select xmin from tbl_20140322 limit 1;</font></div><div><font size="2"   >&nbsp;xmin&nbsp;</font></div><div><font size="2"   >------</font></div><div><font size="2"   >&nbsp; &nbsp; 2</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >使用数据表对应的数据文件MD5值也可以看到, 第二次VACUUM FREEZE没有写操作.</span></div><div><span style="line-height: 28px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select pg_relation_filepath('tbl_20140322');</font></div><div><font size="2"   >&nbsp;pg_relation_filepath&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;base/16384/26123</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>第二次vacuum freeze以后发生的vacuum freeze 前后md5没有变化.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd $PGDATA</font></div><div><div><font size="2"   >pg93@db-172-16-3-150-&gt; md5sum base/16384/26123*</font></div><div><font size="2"   >e922da723c5259cc54398d52b69a17c2 &nbsp;base/16384/26123</font></div><div><font size="2"   >26c77fc26e8302f7678b827942ac71e0 &nbsp;base/16384/26123.1</font></div><div><font size="2"   >258bd29204f9713bf67c2cfac02e24cd &nbsp;base/16384/26123.2</font></div><div><font size="2"   >116b4a8ab93c416ffe3154e7be5e1645 &nbsp;base/16384/26123.3</font></div><div><font size="2"   >c0118b1d800b4a1e987aa53b7223ffc9 &nbsp;base/16384/26123.4</font></div><div><font size="2"   >06bd9bf0d82fafdec3d88ea2e964288b &nbsp;base/16384/26123.5</font></div><div><font size="2"   >df4e09895c7c26a7b4e02ce28b825c4b &nbsp;base/16384/26123.6</font></div><div><font size="2"   >cddf603ef305fc6a267592f8f6693a24 &nbsp;base/16384/26123.7</font></div><div><font size="2"   >b6fe1c8dc4163e915b0aabc11c8649a4 &nbsp;base/16384/26123_fsm</font></div><div><font size="2"   >ec1cc6e5e6b74b282ff54bc575ed2c17 &nbsp;base/16384/26123_vm</font></div></div><p></p></pre></div></span></div><div><br></div><div>经常有人问我, PostgreSQL支持多大的数据库? 理论上是没有大小限制的, 但是我们也必须考虑到mvcc的机制, 数据库越大, 它在vacuum freeze产生的IO也越大, 如果数据库的事务请求特别频繁的话, vacuum freeze的间隙就越短, 当IO能力不够的情况下, 就会出现问题. &nbsp;</div><div>例如一个数据库的硬件可以支撑1天对20TB的数据完成vacuum freeze操作. 那么如果1个表的大小大于20TB并且1天大于20亿的新事务ID请求的话就会有问题. 因为没有足够的时间完成vacuum freeze, 使得年龄问题得到解决.</div><div><br></div><div>为了避免类似问题, 作为PostgreSQL管理员, 尽量不要在数据库中保留过多的无用数据. 因为至少产生一次全表的写IO以及XLOG, 以后经过一定的事务后也会不断的带来读IO.&nbsp;</div><div><br></div><div>对于需要定期清理数据的业务, 例如每个月清理一次历史的日志数据.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >tbl</font></div><div><font size="2"   >tbl_201301</font></div><div><span style="line-height: 28px;"   ><font size="2"   >tbl_201302</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >tbl_201303</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >tbl_201304</font></span></div><p></p></pre></div><div><span style="line-height: 28px;"   >这种场景, 为了节约auto vacuum freeze带来的IO操作, 最好在表的年龄到达自动触发全表的vacuum freeze前, 就清理掉.</span></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201412282455978/"   >http://blog.163.com/digoal@126/blog/static/163877040201412282455978/</a></div></div>
	</div>
</div>
</body>
</html>