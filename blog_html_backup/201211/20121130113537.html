<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Why PostgreSQL enjoy return resultset once?</h2>
	<h5 id="">2012-11-30 11:35:37&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012103083845957/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>昨天一位朋友聊到的一个场景.</div><div>他们使用的客户端程序是java开发的, 在取大表的数据时, 经常被oom掉.</div><div>这可能和返回的结果集太大有关, 导致java进程被系统KILL掉了.</div><div>我这里没有java环境, 所以用psql来模拟一下 :&nbsp;</div><div>psql去查询1个40GB的表, 看看psql会占用多少内存.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; begin;</font></div><div><font size="2"   >select * from ocz_test ;</font></div><div><font size="2"   >BEGIN</font></div><p></p></pre></div><div>执行过程中psql的内存缓慢的增长. 从TOP的输出可以看出, psql最终占了40GB内存. 怪不得java会被KILL掉.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;RES &nbsp;SHR S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >12496 ocz &nbsp; &nbsp; &nbsp; 25 &nbsp; 0 41.8g &nbsp;40g 1952 R 98.5 43.0 &nbsp; 2:31.08 psql</font></div><p></p></pre></div><div>在SELECT的过程中, 从select开始时直到SELECT开始返回数据给客户端, 或者这个select所在的事务获取事务号后开始直到这个事务结束. 这段时间内, vacuum都无法回收<span style="line-height: 22px;"   >从select开始或者</span><span style="line-height: 22px;"   >这个select所在的事务获取事务号以后系统中产生的任何垃圾数据. 除非truncate.</span></div><div>那么为什么psql会占用这么大的内存呢, 原因是psql一次将所有的记录get过来了, 然后再全部展示出来.</div><div>这对客户端程序来说可能不太妥当, 那么有没有办法让它分批次获取呢?</div><div>当然是有的, 例如使用游标.</div><div>不建议使用hold. 因为声明hold游标消耗更多的数据库资源, 同时事务结束后依旧存在, 如果这个SESSION一直存在并且游标忘记关闭, 引起垃圾回收的问题导致数据库膨胀.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; begin;</font></div><div><font size="2"   >BEGIN</font></div><p></p></pre></div><div>声明游标 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; declare test no scroll cursor without hold for select * from ocz_test ;</font></div><div><font size="2"   >DECLARE CURSOR</font></div><p></p></pre></div><div>查看当前声明的游标 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from pg_cursor();</font></div><div><font size="2"   >&nbsp;name | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;statement &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| is_holdable | is_binary | is_scrollable | &nbsp; &nbsp; &nbsp; &nbsp;c</font></div><div><font size="2"   >reation_time &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------+-------------------------------------------------------------------------+-------------+-----------+---------------+---------</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;test | declare test no scroll cursor without hold for select * from ocz_test ; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-11-</font></div><div><font size="2"   >30 09:41:05.27593+08</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div>从游标中取数据 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; fetch FORWARD 10 from test;</font></div><div><font size="2"   >&nbsp; &nbsp; id &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------+-------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >---------------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp;67518035 | 2012-11-30 09:29:02.779353+082012-11-30 09:29:02.779353+082012-11-30 09:29:02.779353+082012-11-30 09:29:02.779353+082012</font></div><div><font size="2"   >-11-30 09:29:02.779353+082012-11-30 09:29:02.779353+082012-11-30 09:29:02.779353+082012-11-30 09:29:02.779353+082012-11-30 09:29:02.</font></div><div><font size="2"   >779353+082012-11-30 09:29:02.779353+08 | 2012-11-30 09:29:02.779359</font></div><div><font size="2"   >&nbsp;64609584 | 2012-11-30 04:59:58.854476+082012-11-30 04:59:58.854476+082012-11-30 04:59:58.854476+082012-11-30 04:59:58.854476+082012</font></div><div><font size="2"   >-11-30 04:59:58.854476+082012-11-30 04:59:58.854476+082012-11-30 04:59:58.854476+082012-11-30 04:59:58.854476+082012-11-30 04:59:58.</font></div><div><font size="2"   >854476+082012-11-30 04:59:58.854476+08 | 2012-11-30 04:59:58.854484</font></div><div><font size="2"   >&nbsp;49808795 | 2012-11-30 07:29:44.685951+082012-11-30 07:29:44.685951+082012-11-30 07:29:44.685951+082012-11-30 07:29:44.685951+082012</font></div><div><font size="2"   >-11-30 07:29:44.685951+082012-11-30 07:29:44.685951+082012-11-30 07:29:44.685951+082012-11-30 07:29:44.685951+082012-11-30 07:29:44.</font></div><div><font size="2"   >685951+082012-11-30 07:29:44.685951+08 | 2012-11-30 07:29:44.685957</font></div><div><font size="2"   >&nbsp;80556276 | 2012-11-30 02:53:48.140628+082012-11-30 02:53:48.140628+082012-11-30 02:53:48.140628+082012-11-30 02:53:48.140628+082012</font></div><div><font size="2"   >-11-30 02:53:48.140628+082012-11-30 02:53:48.140628+082012-11-30 02:53:48.140628+082012-11-30 02:53:48.140628+082012-11-30 02:53:48.</font></div><div><font size="2"   >140628+082012-11-30 02:53:48.140628+08 | 2012-11-30 02:53:48.140635</font></div><div><font size="2"   >&nbsp;56476518 | 2012-11-30 09:39:57.710581+082012-11-30 09:39:57.710581+082012-11-30 09:39:57.710581+082012-11-30 09:39:57.710581+082012</font></div><div><font size="2"   >-11-30 09:39:57.710581+082012-11-30 09:39:57.710581+082012-11-30 09:39:57.710581+082012-11-30 09:39:57.710581+082012-11-30 09:39:57.</font></div><div><font size="2"   >710581+082012-11-30 09:39:57.710581+08 | 2012-11-30 09:39:57.710587</font></div><div><font size="2"   >&nbsp;76607269 | 2012-11-30 09:33:07.913726+082012-11-30 09:33:07.913726+082012-11-30 09:33:07.913726+082012-11-30 09:33:07.913726+082012</font></div><div><font size="2"   >-11-30 09:33:07.913726+082012-11-30 09:33:07.913726+082012-11-30 09:33:07.913726+082012-11-30 09:33:07.913726+082012-11-30 09:33:07.</font></div><div><font size="2"   >913726+082012-11-30 09:33:07.913726+08 | 2012-11-30 09:33:07.913733</font></div><div><font size="2"   >&nbsp;48187718 | 2012-11-30 07:35:29.279959+082012-11-30 07:35:29.279959+082012-11-30 07:35:29.279959+082012-11-30 07:35:29.279959+082012</font></div><div><font size="2"   >-11-30 07:35:29.279959+082012-11-30 07:35:29.279959+082012-11-30 07:35:29.279959+082012-11-30 07:35:29.279959+082012-11-30 07:35:29.</font></div><div><font size="2"   >279959+082012-11-30 07:35:29.279959+08 | 2012-11-30 07:35:29.279966</font></div><div><font size="2"   >&nbsp;30986857 | 2012-11-30 00:07:19.829985+082012-11-30 00:07:19.829985+082012-11-30 00:07:19.829985+082012-11-30 00:07:19.829985+082012</font></div><div><font size="2"   >-11-30 00:07:19.829985+082012-11-30 00:07:19.829985+082012-11-30 00:07:19.829985+082012-11-30 00:07:19.829985+082012-11-30 00:07:19.</font></div><div><font size="2"   >829985+082012-11-30 00:07:19.829985+08 | 2012-11-30 00:07:19.829991</font></div><div><font size="2"   >&nbsp;42493720 | 2012-11-29 19:42:25.974969+082012-11-29 19:42:25.974969+082012-11-29 19:42:25.974969+082012-11-29 19:42:25.974969+082012</font></div><div><font size="2"   >-11-29 19:42:25.974969+082012-11-29 19:42:25.974969+082012-11-29 19:42:25.974969+082012-11-29 19:42:25.974969+082012-11-29 19:42:25.</font></div><div><font size="2"   >974969+082012-11-29 19:42:25.974969+08 | 2012-11-29 19:42:25.974975</font></div><div><font size="2"   >&nbsp;38207570 | 2012-11-30 05:21:54.31637+082012-11-30 05:21:54.31637+082012-11-30 05:21:54.31637+082012-11-30 05:21:54.31637+082012-11-</font></div><div><font size="2"   >30 05:21:54.31637+082012-11-30 05:21:54.31637+082012-11-30 05:21:54.31637+082012-11-30 05:21:54.31637+082012-11-30 05:21:54.31637+08</font></div><div><font size="2"   >2012-11-30 05:21:54.31637+08 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-11-30 05:21:54.316376</font></div><div><font size="2"   >(10 rows)</font></div><p></p></pre></div><div>获取下一条 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; fetch forward from test;</font></div><div><font size="2"   >&nbsp; &nbsp; id &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------+-------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >---------------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp;70335365 | 2012-11-30 06:55:30.675203+082012-11-30 06:55:30.675203+082012-11-30 06:55:30.675203+082012-11-30 06:55:30.675203+082012</font></div><div><font size="2"   >-11-30 06:55:30.675203+082012-11-30 06:55:30.675203+082012-11-30 06:55:30.675203+082012-11-30 06:55:30.675203+082012-11-30 06:55:30.</font></div><div><font size="2"   >675203+082012-11-30 06:55:30.675203+08 | 2012-11-30 06:55:30.675211</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>关闭游标 :&nbsp;</div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; close test;</font></div><div><font size="2"   >CLOSE CURSOR</font></div><p></p></pre></div><div>或者结束事务, 游标自动释放.</div><div><br></div><div>接下来要说的是, 为什么PostgreSQL更喜欢一次性将所有结果返回, 而不是分段返回呢?</div><div>来举个例子 :&nbsp;</div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=&gt; declare test no scroll cursor without hold for select * from ocz_test ;</font></div><div><font size="2"   >DECLARE CURSOR</font></div><p></p></pre></div><div><br></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; select count(*) from test;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp;10</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=&gt; update test set id=4;</font></div><div><font size="2"   >UPDATE 10</font></div><div><font size="2"   >digoal=&gt; end;</font></div><div><font size="2"   >COMMIT</font></div></div><div><font size="2"   >digoal=&gt; vacuum verbose test ;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "digoal.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": found 0 removable, 20 nonremovable row versions in 1 out of 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;10 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><p></p></pre></div><div>注意看, SESSION B 中更新了test表的10条记录, 但是无法将老版本的tuple vacuum掉.</div><div>同样vacuum full也不能回收这部分空间.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; vacuum full verbose test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "digoal.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": found 0 removable, 30 nonremovable row versions in 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;20 dead row versions cannot be removed yet.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><p></p></pre></div><div>将游标关闭后, vacuum 就可以回收这些空间了. 变成 0 dead row versions cannot be removed yet.</div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; close test;</font></div><div><font size="2"   >CLOSE CURSOR</font></div><p></p></pre></div><div><br></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; vacuum verbose test ;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "digoal.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": found 0 removable, 10 nonremovable row versions in 1 out of 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><p></p></pre></div><div><br></div><div>那是为什么呢? 因为游标开着的情况下和SELECT正在查询的过程一样(不包含返回结果集的过程). vacuum不能在此时回收.</div><div>只有当select检索数据结束, (进入返回结果集的状态). 或者游标被关闭后. vacuum才可以回收这些垃圾空间.</div><div>因此使用游标必须注意这点, 别让游标开太久了, 否则从开启这个游标开始以后产生的垃圾数据都将无法回收.</div><div>而在此之前产生的垃圾数据是可以回收的. (根据txid_current_snapshot()的xmin来判断, 如果垃圾tuples的xmin以及xmax都小于这个xmin就可以回收)</div><div>例如 :</div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; update test set id=10;</font></div><div><font size="2"   >UPDATE 10</font></div></div><div><div><font size="2"   >digoal=# select * from txid_current_snapshot();</font></div><div><font size="2"   >&nbsp;txid_current_snapshot&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;171985835:171985835:</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=&gt; declare test no scroll cursor without hold for select * from ocz_test;</font></div><div><font size="2"   >DECLARE CURSOR</font></div><p></p></pre></div><div><br></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from txid_current_snapshot();</font></div><div><font size="2"   >&nbsp;txid_current_snapshot&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;171985835:171985835:</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>说明declare不分配事务号, 但是它同样会阻止vacuum回收垃圾. 只是阻止在此之后发生的DML产生的垃圾tuples的回收, 不阻止在此之前产生的垃圾tuples的回收.</div><div><br></div><div>看一下page 信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from heap_page_items(get_raw_page('digoal.test',0));</font></div><div><font size="2"   >&nbsp;lp | lp_off | lp_flags | lp_len | &nbsp;t_xmin &nbsp; | &nbsp;t_xmax &nbsp; | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"   >----+--------+----------+--------+-----------+-----------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"   >&nbsp; 1 | &nbsp; 8160 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985832 | 171985834 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,11) | &nbsp; &nbsp; &nbsp; 16385 | &nbsp; &nbsp; &nbsp; 8448 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 2 | &nbsp; 8128 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985832 | 171985834 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,12) | &nbsp; &nbsp; &nbsp; 16385 | &nbsp; &nbsp; &nbsp; 8448 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 3 | &nbsp; 8096 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985832 | 171985834 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,13) | &nbsp; &nbsp; &nbsp; 16385 | &nbsp; &nbsp; &nbsp; 8448 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 4 | &nbsp; 8064 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985832 | 171985834 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,14) | &nbsp; &nbsp; &nbsp; 16385 | &nbsp; &nbsp; &nbsp; 8448 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 5 | &nbsp; 8032 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985832 | 171985834 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,15) | &nbsp; &nbsp; &nbsp; 16385 | &nbsp; &nbsp; &nbsp; 8448 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 6 | &nbsp; 8000 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985832 | 171985834 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,16) | &nbsp; &nbsp; &nbsp; 16385 | &nbsp; &nbsp; &nbsp; 8448 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 7 | &nbsp; 7968 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985832 | 171985834 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,17) | &nbsp; &nbsp; &nbsp; 16385 | &nbsp; &nbsp; &nbsp; 8448 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 8 | &nbsp; 7936 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985832 | 171985834 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,18) | &nbsp; &nbsp; &nbsp; 16385 | &nbsp; &nbsp; &nbsp; 8448 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 9 | &nbsp; 7904 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985832 | 171985834 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,19) | &nbsp; &nbsp; &nbsp; 16385 | &nbsp; &nbsp; &nbsp; 8448 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;10 | &nbsp; 7872 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985832 | 171985834 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,20) | &nbsp; &nbsp; &nbsp; 16385 | &nbsp; &nbsp; &nbsp; 8448 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;11 | &nbsp; 7840 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,11) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10240 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;12 | &nbsp; 7808 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,12) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10240 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;13 | &nbsp; 7776 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,13) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10240 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;14 | &nbsp; 7744 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,14) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10240 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;15 | &nbsp; 7712 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,15) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10240 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;16 | &nbsp; 7680 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,16) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10240 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;17 | &nbsp; 7648 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,17) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10240 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;18 | &nbsp; 7616 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,18) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10240 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;19 | &nbsp; 7584 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,19) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10240 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;20 | &nbsp; 7552 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,20) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10240 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(20 rows)</font></div><p></p></pre></div><div><br></div><div>接下来的vacuum说明了这个问题, 在声明cursor前产生的垃圾tuples已经被回收了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# vacuum verbose digoal.test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "digoal.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": found 10 removable, 10 nonremovable row versions in 1 out of 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><p></p></pre></div><div><br></div><div>再看看PAGE信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from heap_page_items(get_raw_page('digoal.test',0));</font></div><div><font size="2"   >&nbsp;lp | lp_off | lp_flags | lp_len | &nbsp;t_xmin &nbsp; | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"   >----+--------+----------+--------+-----------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"   >&nbsp; 1 | &nbsp; &nbsp; 11 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 2 | &nbsp; &nbsp; 12 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 3 | &nbsp; &nbsp; 13 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 4 | &nbsp; &nbsp; 14 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 5 | &nbsp; &nbsp; 15 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 6 | &nbsp; &nbsp; 16 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 7 | &nbsp; &nbsp; 17 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 8 | &nbsp; &nbsp; 18 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 9 | &nbsp; &nbsp; 19 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;10 | &nbsp; &nbsp; 20 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;11 | &nbsp; 8160 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,11) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10496 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;12 | &nbsp; 8128 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,12) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10496 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;13 | &nbsp; 8096 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,13) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10496 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;14 | &nbsp; 8064 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,14) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10496 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;15 | &nbsp; 8032 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,15) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10496 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;16 | &nbsp; 8000 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,16) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10496 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;17 | &nbsp; 7968 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,17) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10496 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;18 | &nbsp; 7936 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,18) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10496 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;19 | &nbsp; 7904 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,19) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10496 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;20 | &nbsp; 7872 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,20) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10496 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(20 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >xid=171985832的数据都被vacuum掉了.</span></div><div><br></div><div>在声明游标后发生的UPDATE, 产生的垃圾数据, 无法被回收 :&nbsp;</div><div>SESSION B :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# update digoal.test set id=101;</font></div><div><font size="2"   >UPDATE 10</font></div><div><div><font size="2"   >digoal=# select * from txid_current_snapshot();</font></div><div><font size="2"   >&nbsp;txid_current_snapshot&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;171985836:171985836:</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# select * from heap_page_items(get_raw_page('digoal.test',0));</font></div><div><font size="2"   >&nbsp;lp | lp_off | lp_flags | lp_len | &nbsp;t_xmin &nbsp; | &nbsp;t_xmax &nbsp; | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"   >----+--------+----------+--------+-----------+-----------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"   >&nbsp; 1 | &nbsp; &nbsp; 11 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 2 | &nbsp; &nbsp; 12 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 3 | &nbsp; &nbsp; 13 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 4 | &nbsp; &nbsp; 14 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 5 | &nbsp; &nbsp; 15 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 6 | &nbsp; &nbsp; 16 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 7 | &nbsp; &nbsp; 17 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 8 | &nbsp; &nbsp; 18 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 9 | &nbsp; &nbsp; 19 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;10 | &nbsp; &nbsp; 20 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;11 | &nbsp; 8160 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | 171985835 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,21) | &nbsp; &nbsp; &nbsp; 49153 | &nbsp; &nbsp; &nbsp; 8448 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;12 | &nbsp; 8128 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | 171985835 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,22) | &nbsp; &nbsp; &nbsp; 49153 | &nbsp; &nbsp; &nbsp; 8448 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;13 | &nbsp; 8096 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | 171985835 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,23) | &nbsp; &nbsp; &nbsp; 49153 | &nbsp; &nbsp; &nbsp; 8448 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;14 | &nbsp; 8064 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | 171985835 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,24) | &nbsp; &nbsp; &nbsp; 49153 | &nbsp; &nbsp; &nbsp; 8448 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;15 | &nbsp; 8032 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | 171985835 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,25) | &nbsp; &nbsp; &nbsp; 49153 | &nbsp; &nbsp; &nbsp; 8448 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;16 | &nbsp; 8000 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | 171985835 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,26) | &nbsp; &nbsp; &nbsp; 49153 | &nbsp; &nbsp; &nbsp; 8448 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;17 | &nbsp; 7968 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | 171985835 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,27) | &nbsp; &nbsp; &nbsp; 49153 | &nbsp; &nbsp; &nbsp; 8448 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;18 | &nbsp; 7936 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | 171985835 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,28) | &nbsp; &nbsp; &nbsp; 49153 | &nbsp; &nbsp; &nbsp; 8448 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;19 | &nbsp; 7904 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | 171985835 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,29) | &nbsp; &nbsp; &nbsp; 49153 | &nbsp; &nbsp; &nbsp; 8448 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;20 | &nbsp; 7872 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985834 | 171985835 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,30) | &nbsp; &nbsp; &nbsp; 49153 | &nbsp; &nbsp; &nbsp; 8448 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;21 | &nbsp; 7840 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985835 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,21) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10240 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;22 | &nbsp; 7808 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985835 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,22) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10240 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;23 | &nbsp; 7776 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985835 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,23) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10240 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;24 | &nbsp; 7744 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985835 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,24) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10240 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;25 | &nbsp; 7712 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985835 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,25) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10240 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;26 | &nbsp; 7680 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985835 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,26) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10240 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;27 | &nbsp; 7648 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985835 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,27) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10240 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;28 | &nbsp; 7616 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985835 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,28) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10240 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;29 | &nbsp; 7584 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985835 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,29) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10240 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;30 | &nbsp; 7552 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | 171985835 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,30) | &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10240 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(30 rows)</font></div></div><p></p></pre></div><div><br></div><div>这些都无法被回收.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# vacuum verbose digoal.test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "digoal.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": found 0 removable, 20 nonremovable row versions in 1 out of 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;10 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><p></p></pre></div></div><div><br></div><div>将所有数据fetch掉,&nbsp;<span style="line-height: 22px;"   >再次回收, 依然无法回收</span></div><div>SESISON A :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >digoal=&gt; fetch all from test ;</font></p></pre></div><div>SESISON B :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# vacuum verbose digoal.test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "digoal.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": found 0 removable, 20 nonremovable row versions in 1 out of 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;10 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div></div><div></div><p></p></pre></div></div><div>关闭游标, 可以回收.</div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; close test;</font></div><div><font size="2"   >CLOSE CURSOR</font></div><p></p></pre></div><div><br></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# vacuum verbose digoal.test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "digoal.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": found 10 removable, 10 nonremovable row versions in 1 out of 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 10 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><p></p></pre></div><div><br></div><div>另一种情况是查询大表, 在数据扫描过程中, 返回结果集前, 这段时间内vacuum是无法回收在这些SQL语句开始之后产生的垃圾tuples的.</div><div><br></div><div>最后一种情况是获得了xid的事务, 例如update, delete, insert. 或者执行txid_current()后.&nbsp;</div><div>这些事务只要不关闭, vacuum就无法回收在此事务之后产生的垃圾tuples.</div><div>在此之前产生的垃圾tuples是可以被回收的.</div><div>例如 :&nbsp;</div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; begin;</font></div><div><font size="2"   >BEGIN</font></div><p></p></pre></div><div><br></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# update digoal.test set id=101;</font></div><div><font size="2"   >UPDATE 10</font></div><p></p></pre></div><div><br></div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select txid_current();</font></div><div><font size="2"   >&nbsp;txid_current&nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp; &nbsp; 171985838</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select * from txid_current_snapshot();</font></div><div><font size="2"   >&nbsp;txid_current_snapshot&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;171985838:171985838:</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=# vacuum verbose digoal.test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "digoal.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": found 10 removable, 10 nonremovable row versions in 1 out of 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div></div><p></p></pre></div><div>在SESSION A执行了<span style="line-height: 22px;"   >txid_current()后产生的垃圾tuples就无法回收了.</span></div><div><span style="line-height: 22px;"   >SESSION B :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# update digoal.test set id=101;</font></div><div><font size="2"   >UPDATE 10</font></div><div><font size="2"   >digoal=# vacuum verbose digoal.test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "digoal.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": found 0 removable, 20 nonremovable row versions in 1 out of 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;10 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><p></p></pre></div><div><br></div><div>以上所有测试基于版本PostgreSQL 9.2.</div><div><br></div><div>【小结】</div><div>以下情况vacuum无法回收一部分垃圾tuples.</div><div>1. 系统中存在执行过insert,update,delete并且未结束的<span style="line-height: 22px;"   >事务;</span></div><div><span style="line-height: 22px;"   >&nbsp; &nbsp; 直到事务结束, 都无法回收从拿到事务号开始所产生的垃圾tuples. (指整个数据库产生的垃圾, 而非事务本身)</span></div><div>2. 系统中存在任何分配了事务号的并且未结束的事务(例如txid_current);</div><div><span style="line-height: 22px;"   >&nbsp; &nbsp; 直到事务结束, 都无法回收从拿到事务号开始所产生的垃圾tuples.&nbsp;</span><span style="line-height: 22px;"   >(指整个数据库产生的垃圾, 而非事务本身)</span></div><div>3. 系统中存在正在处理的SQL语句,&nbsp;</div><div>&nbsp; &nbsp; (例如正在select一个很大的表, 不包括返回结果集的过程, 注意很大的表, 返回结果集也是需要很久的.);</div><div>&nbsp; &nbsp; 直到SQL开始返回结果集结束, 都无法回收SQL语句执行过程中产生的垃圾tuples.&nbsp;<span style="line-height: 22px;"   >(指整个数据库产生的垃圾, 而非事务本身)</span></div><div>4. 事务中有未关闭的游标;</div><div>&nbsp; &nbsp; 直到游标被close, 都无法回收从游标被声明的时刻到游标被close之间所产生的垃圾tuples.&nbsp;<span style="line-height: 22px;"   >(指整个数据库产生的垃圾, 而非事务本身)</span></div><div>相比游标, 一次性取完所有数据能节约时间, 对整体的垃圾回收影响较之更小.</div><div>当然如果你本来就只需要取部分数据, 或者遇到客户端OOM的情况, 还是需要游标来解决的.</div><div><br></div>【参考】<div>1.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201011162912604/"   >http://blog.163.com/digoal@126/blog/static/163877040201011162912604/</a></div><div>2.&nbsp;src/backend/utils/adt/txid.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* txid_current() returns int8</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;Return the current toplevel transaction ID as TXID</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;If the current transaction does not have one, one is assigned.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >Datum</font></div><div><font size="2"   >txid_current(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; txid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;val;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TxidEpoch &nbsp; &nbsp; &nbsp; state;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Must prevent during recovery because if an xid is not assigned we try</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* to assign one, which would fail. Programs already rely on this function</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* to always return a valid current xid, so we should not change this to</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* return NULL or similar invalid xid.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PreventCommandDuringRecovery("txid_current()");</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; load_xid_epoch(&amp;state);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; val = convert_xid(GetTopTransactionId(), &amp;state);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_INT64(val);</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* txid_current_snapshot() returns txid_snapshot</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Return current snapshot in TXID format</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Note that only top-transaction XIDs are included in the snapshot.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >Datum</font></div><div><font size="2"   >txid_current_snapshot(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TxidSnapshot *snap;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; uint32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nxip,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TxidEpoch &nbsp; &nbsp; &nbsp; state;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Snapshot &nbsp; &nbsp; &nbsp; &nbsp;cur;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; cur = GetActiveSnapshot();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (cur == NULL)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, "no active snapshot set");</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; load_xid_epoch(&amp;state);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* allocate */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; nxip = cur-&gt;xcnt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; size = TXID_SNAPSHOT_SIZE(nxip);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; snap = palloc(size);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SET_VARSIZE(snap, size);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* fill */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; snap-&gt;xmin = convert_xid(cur-&gt;xmin, &amp;state);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; snap-&gt;xmax = convert_xid(cur-&gt;xmax, &amp;state);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; snap-&gt;nxip = nxip;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; for (i = 0; i &lt; nxip; i++)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snap-&gt;xip[i] = convert_xid(cur-&gt;xip[i], &amp;state);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* we want them guaranteed to be in ascending order */</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sort_snapshot(snap);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_POINTER(snap);</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div><br></div><div>3.&nbsp;src/backend/commands/vacuum.c</div><div>4.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020129248105943/"   >http://blog.163.com/digoal@126/blog/static/16387704020129248105943/</a></div><div>5.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020114273265960/"   >http://blog.163.com/digoal@126/blog/static/16387704020114273265960/</a></div></div>
	</div>
</div>
</body>
</html>