<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use hdparm change ATA SATA DISK's Write-Read-Verify feature set</h2>
	<h5 id="">2012-11-27 17:46:14&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012102753828433/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前面测试了OCZ PCI-E接口的SSD硬盘RevoDrive3的性能, 确实不错.</div><div>其中hdparm看到的信息如下 :&nbsp;</div><div>有一条, Write-Read-Verify feature set</div><div>也就是说这个硬盘支持这个特性, 只是没有开启.</div><div>但是hdparm系统带的版本不能修改这个. 需要用到更新的hdparm版本.</div><div>下载地址 :&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://sourceforge.net/projects/hdparm/"  >http://sourceforge.net/projects/hdparm/</a></div><div>编译时会有点问题, 我这用到的是CentOS 5.7 x64的版本.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >hdparm.o: In function `dump_sectors':</font></div><div><font size="2"  >hdparm.c:(.text+0x19c0): undefined reference to `le16toh'</font></div><div><font size="2"  >hdparm.c:(.text+0x19ee): undefined reference to `le16toh'</font></div><div><font size="2"  >hdparm.c:(.text+0x1a24): undefined reference to `le16toh'</font></div><div><font size="2"  >collect2: ld returned 1 exit status</font></div><div><font size="2"  >gmake: *** [hdparm] Error 1</font></div><p></p></pre></div><div>原因是找不到这个函数, 这个函数原本应该在endian.h中声明的. 但是CentOS 5.7 x64的endian.h中没有.&nbsp;</div><div>这个函数的功能参考 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://www.kernel.org/doc/man-pages/online/pages/man3/endian.3.html"  >http://www.kernel.org/doc/man-pages/online/pages/man3/endian.3.html</a></div><div>所以需要修改一下hdparm.c 以下行 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >printf("%04x", le16toh(w[0])); &nbsp;</font></p></pre></div><div>注释这行</div><div><pre class="prettyprint"  ><p><font size="2"  >// printf("%04x", le16toh(w[0])); &nbsp;</font></p></pre></div><div>或者修改这行.</div><div><pre class="prettyprint"  ><p><font size="2"  >printf("%04x", w[0]); &nbsp;</font></p></pre></div><div>再编译 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >gmake</font></div><div><font size="2"  >gmake install</font></div><p></p></pre></div><div>确认版本信息 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 hdparm-9.43]# hdparm -V</font></div><div><font size="2"  >hdparm v9.43</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >使用帮助 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 hdparm-9.43]# hdparm -h</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >hdparm - get/set hard disk parameters - version v9.43, by Mark Lord.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Usage: &nbsp;hdparm &nbsp;[options] [device ...]</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Options:</font></div><div><font size="2"  >&nbsp;-a &nbsp; Get/set fs readahead</font></div><div><font size="2"  >&nbsp;-A &nbsp; Get/set the drive look-ahead flag (0/1)</font></div><div><font size="2"  >&nbsp;-b &nbsp; Get/set bus state (0 == off, 1 == on, 2 == tristate)</font></div><div><font size="2"  >&nbsp;-B &nbsp; Set Advanced Power Management setting (1-255)</font></div><div><font size="2"  >&nbsp;-c &nbsp; Get/set IDE 32-bit IO setting</font></div><div><font size="2"  >&nbsp;-C &nbsp; Check drive power mode status</font></div><div><font size="2"  >&nbsp;-d &nbsp; Get/set using_dma flag</font></div><div><font size="2"  >&nbsp;-D &nbsp; Enable/disable drive defect management</font></div><div><font size="2"  >&nbsp;-E &nbsp; Set cd/dvd drive speed</font></div><div><font size="2"  >&nbsp;-f &nbsp; Flush buffer cache for device on exit</font></div><div><font size="2"  >&nbsp;-F &nbsp; Flush drive write cache</font></div><div><font size="2"  >&nbsp;-g &nbsp; Display drive geometry</font></div><div><font size="2"  >&nbsp;-h &nbsp; Display terse usage information</font></div><div><font size="2"  >&nbsp;-H &nbsp; Read temperature from drive (Hitachi only)</font></div><div><font size="2"  >&nbsp;-i &nbsp; Display drive identification</font></div><div><font size="2"  >&nbsp;-I &nbsp; Detailed/current information directly from drive</font></div><div><font size="2"  >&nbsp;-J &nbsp; Get/set Western DIgital "Idle3" timeout for a WDC "Green" drive (DANGEROUS)</font></div><div><font size="2"  >&nbsp;-k &nbsp; Get/set keep_settings_over_reset flag (0/1)</font></div><div><font size="2"  >&nbsp;-K &nbsp; Set drive keep_features_over_reset flag (0/1)</font></div><div><font size="2"  >&nbsp;-L &nbsp; Set drive doorlock (0/1) (removable harddisks only)</font></div><div><font size="2"  >&nbsp;-m &nbsp; Get/set multiple sector count</font></div><div><font size="2"  >&nbsp;-M &nbsp; Get/set acoustic management (0-254, 128: quiet, 254: fast)</font></div><div><font size="2"  >&nbsp;-n &nbsp; Get/set ignore-write-errors flag (0/1)</font></div><div><font size="2"  >&nbsp;-N &nbsp; Get/set max visible number of sectors (HPA) (VERY DANGEROUS)</font></div><div><font size="2"  >&nbsp;-p &nbsp; Set PIO mode on IDE interface chipset (0,1,2,3,4,...)</font></div><div><font size="2"  >&nbsp;-P &nbsp; Set drive prefetch count</font></div><div><font size="2"  >&nbsp;-q &nbsp; Change next setting quietly</font></div><div><font size="2"  >&nbsp;-Q &nbsp; Get/set DMA queue_depth (if supported)</font></div><div><font size="2"  >&nbsp;-r &nbsp; Get/set device readonly flag (DANGEROUS to set)</font></div><div><font size="2"  >&nbsp;-R &nbsp; Get/set device write-read-verify flag</font></div><div><font size="2"  >&nbsp;-s &nbsp; Set power-up in standby flag (0/1) (DANGEROUS)</font></div><div><font size="2"  >&nbsp;-S &nbsp; Set standby (spindown) timeout</font></div><div><font size="2"  >&nbsp;-t &nbsp; Perform device read timings</font></div><div><font size="2"  >&nbsp;-T &nbsp; Perform cache read timings</font></div><div><font size="2"  >&nbsp;-u &nbsp; Get/set unmaskirq flag (0/1)</font></div><div><font size="2"  >&nbsp;-U &nbsp; Obsolete</font></div><div><font size="2"  >&nbsp;-v &nbsp; Use defaults; same as -acdgkmur for IDE drives</font></div><div><font size="2"  >&nbsp;-V &nbsp; Display program version and exit immediately</font></div><div><font size="2"  >&nbsp;-w &nbsp; Perform device reset (DANGEROUS)</font></div><div><font size="2"  >&nbsp;-W &nbsp; Get/set drive write-caching flag (0/1)</font></div><div><font size="2"  >&nbsp;-x &nbsp; Obsolete</font></div><div><font size="2"  >&nbsp;-X &nbsp; Set IDE xfer mode (DANGEROUS)</font></div><div><font size="2"  >&nbsp;-y &nbsp; Put drive in standby mode</font></div><div><font size="2"  >&nbsp;-Y &nbsp; Put drive to sleep</font></div><div><font size="2"  >&nbsp;-z &nbsp; Re-read partition table</font></div><div><font size="2"  >&nbsp;-Z &nbsp; Disable Seagate auto-powersaving mode</font></div><div><font size="2"  >&nbsp;--dco-freeze &nbsp; &nbsp; &nbsp;Freeze/lock current device configuration until next power cycle</font></div><div><font size="2"  >&nbsp;--dco-identify &nbsp; &nbsp;Read/dump device configuration identify data</font></div><div><font size="2"  >&nbsp;--dco-restore &nbsp; &nbsp; Reset device configuration back to factory defaults</font></div><div><font size="2"  >&nbsp;--direct &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Use O_DIRECT to bypass page cache for timings</font></div><div><font size="2"  >&nbsp;--drq-hsm-error &nbsp; Crash system with a "stuck DRQ" error (VERY DANGEROUS)</font></div><div><font size="2"  >&nbsp;--fallocate &nbsp; &nbsp; &nbsp; Create a file without writing data to disk</font></div><div><font size="2"  >&nbsp;--fibmap &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Show device extents (and fragmentation) for a file</font></div><div><font size="2"  >&nbsp;--fwdownload &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Download firmware file to drive (EXTREMELY DANGEROUS)</font></div><div><font size="2"  >&nbsp;--fwdownload-mode3 &nbsp; &nbsp; &nbsp;Download firmware using min-size segments (EXTREMELY DANGEROUS)</font></div><div><font size="2"  >&nbsp;--fwdownload-mode3-max &nbsp;Download firmware using max-size segments (EXTREMELY DANGEROUS)</font></div><div><font size="2"  >&nbsp;--fwdownload-mode7 &nbsp; &nbsp; &nbsp;Download firmware using a single segment (EXTREMELY DANGEROUS)</font></div><div><font size="2"  >&nbsp;--idle-immediate &nbsp;Idle drive immediately</font></div><div><font size="2"  >&nbsp;--idle-unload &nbsp; &nbsp; Idle immediately and unload heads</font></div><div><font size="2"  >&nbsp;--Istdin &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Read identify data from stdin as ASCII hex</font></div><div><font size="2"  >&nbsp;--Istdout &nbsp; &nbsp; &nbsp; &nbsp; Write identify data to stdout as ASCII hex</font></div><div><font size="2"  >&nbsp;--make-bad-sector Deliberately corrupt a sector directly on the media (VERY DANGEROUS)</font></div><div><font size="2"  >&nbsp;--offset &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;use with -t, to begin timings at given offset (in GiB) from start of drive</font></div><div><font size="2"  >&nbsp;--prefer-ata12 &nbsp; &nbsp;Use 12-byte (instead of 16-byte) SAT commands when possible</font></div><div><font size="2"  >&nbsp;--read-sector &nbsp; &nbsp; Read and dump (in hex) a sector directly from the media</font></div><div><font size="2"  >&nbsp;--security-help &nbsp; Display help for ATA security commands</font></div><div><font size="2"  >&nbsp;--trim-sector-ranges &nbsp; &nbsp; &nbsp; &nbsp;Tell SSD firmware to discard unneeded data sectors: lba:count ..</font></div><div><font size="2"  >&nbsp;--trim-sector-ranges-stdin &nbsp;Same as above, but reads lba:count pairs from stdin</font></div><div><font size="2"  >&nbsp;--verbose &nbsp; &nbsp; &nbsp; &nbsp; Display extra diagnostics from some commands</font></div><div><font size="2"  >&nbsp;--write-sector &nbsp; &nbsp;Repair/overwrite a (possibly bad) sector directly on the media (VERY DANGEROUS)</font></div><p></p></pre></div><div>开启write-read-verify :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 hdparm-9.43]# hdparm -R 2 /dev/mapper/mpath1</font></div><div><font size="2"  >/dev/mapper/mpath1:</font></div><div><font size="2"  >&nbsp;setting write-read-verify to 2</font></div><div><font size="2"  >&nbsp;write-read-verify = &nbsp;2</font></div><p></p></pre></div><div>确认已经开启 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 hdparm-9.43]# hdparm -I /dev/mapper/mpath1|grep Write-Read-Verify</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp;Write-Read-Verify feature set</font></div><p></p></pre></div><div>开启后IO性能将急剧下降.</div><div><br></div><div>关闭write-read-verify :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 hdparm-9.43]# hdparm -R 0 /dev/mapper/mpath1</font></div><div><font size="2"  >/dev/mapper/mpath1:</font></div><div><font size="2"  >&nbsp;setting write-read-verify to 0</font></div><div><font size="2"  >&nbsp;write-read-verify = &nbsp;0</font></div><p></p></pre></div><div>确认已经关闭 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 hdparm-9.43]# hdparm -I /dev/mapper/mpath1|grep Write-Read-Verify</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Write-Read-Verify feature set</font></div><p></p></pre></div><div><br></div>【参考】<div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://sourceforge.net/projects/hdparm/"  >http://sourceforge.net/projects/hdparm/</a></div><div>2.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201210279569426/"  >http://blog.163.com/digoal@126/blog/static/163877040201210279569426/</a></div><div>3.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012102613815282/"  >http://blog.163.com/digoal@126/blog/static/1638770402012102613815282/</a><br>4.&nbsp;<wbr><a target="_blank" rel="nofollow" href="http://www.kernel.org/doc/man-pages/online/pages/man3/endian.3.html"  >http://www.kernel.org/doc/man-pages/online/pages/man3/endian.3.html</a></div></div>
	</div>
</div>
</body>
</html>