<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">[转]UCARP use Common Address Redundancy Protocol (CARP) like VRRP and HSRP</h2>
	<h5 id="">2012-11-02 15:37:13&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201210233052896/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>UCARP is a portable implementation of the CARP protocol.</div><div>UCARP allows a couple of hosts to share common virtual IP addresses in order</div><div>to provide automatic failover. It is a portable userland implementation of the</div><div>secure and patent-free Common Address Redundancy Protocol (CARP, OpenBSD’s</div><div>alternative to the patents-bloated VRRP).</div><div><br></div><div>Strong points of the CARP protocol are: very low overhead, cryptographically signed messages, interoperability between different operating systems and no need for any dedicated extra network link between redundant hosts.</div></div><div><br></div><div>配置如下 :&nbsp;</div><div><div>《Ucarp. Virtual IP for Linux boxes》</div><div><br></div><div>UCARP allows a couple of hosts to share common virtual IP addresses in order to provide automatic failover. UCARP is a portable implementation of the CARP protocol.</div><div><br></div><div>#Start script for first host</div><div><br></div><div><pre class="prettyprint"  ><p><font size="2"  >/usr/sbin/ucarp -B -z -P -b 1 --interface=eth0 --srcip=10.10.10.1 --vhid=1 --pass=zxcvbn --addr=10.10.10.10 --upscript=/etc/vip-up.sh --downscript=/etc/vip-down.sh</font></p></pre></div><div><br></div><div>#Start script for second host</div><div><br></div><div><pre class="prettyprint"  ><p><font size="2"  >/usr/sbin/ucarp -z -B -b 2 -k 200 -r 4 --interface=eth0 --srcip=10.10.10.2--vhid=1 --pass=zxcvbn --addr=10.10.10.10 --upscript=/etc/vip-up.sh --downscript=/etc/vip-down.sh</font></p></pre></div><div><br></div><div>-------------------------------------</div><div>Startup script /etc/vip-up.sh</div><div><br></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >#!/bin/bash</font></div><div><font size="2"  >/sbin/ifconfig eth0:1 10.10.10.10/24 &gt; /dev/null 2&gt;&amp;1</font></div><p></p></pre></div><div><br></div><div>-------------------------------------</div><div>Shutdown script /etc/vip-down.sh</div><div><br></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >#!/bin/bash</font></div><div><font size="2"  >/sbin/ifconfig eth0:1 down &gt; /dev/null 2&gt;&amp;1</font></div><p></p></pre></div><div><br></div><div>Make scripts executable</div><div><br></div><div>#chmod 500 /etc/vip-up.sh</div><div>#chmod 500 /etc/vip-down.sh</div><div><br></div><div>If you want create init script /etc/init.d/ucarp (for RedHat family)</div><div><br></div><div>Create file /etc/init.d/ucarp (don't forget replace ip addresses and switches in script)</div><div><br></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >#!/bin/bash&nbsp;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># chkconfig: 2345 85 15&nbsp;</font></div><div><font size="2"  ># description: UCARP startup&nbsp;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># Source function library.</font></div><div><font size="2"  >. /etc/rc.d/init.d/functions</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >RETVAL=0</font></div><div><font size="2"  >prog="ucarp"</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >start()</font></div><div><font size="2"  >{</font></div><div><font size="2"  ># Start daemons.</font></div><div><font size="2"  >echo -n $"Starting $prog: "</font></div><div><font size="2"  >daemon /usr/sbin/ucarp z -B -b 2 -k 200 -r 4 --interface=eth0 --srcip=10.10.10.2 --vhid=1 --pass=password --addr=10.10.10.10 --upscript=/etc/vip-up.sh --downscript=/etc/vip-down.sh</font></div><div><font size="2"  >RETVAL=$?</font></div><div><font size="2"  >echo</font></div><div><font size="2"  >return $RETVAL</font></div><div><font size="2"  >}</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >stop()</font></div><div><font size="2"  >{</font></div><div><font size="2"  ># Stop daemons.</font></div><div><font size="2"  >echo -n $"Shutting down $prog: "</font></div><div><font size="2"  >killproc $prog</font></div><div><font size="2"  >RETVAL=$?</font></div><div><font size="2"  >echo</font></div><div><font size="2"  >return $RETVAL</font></div><div><font size="2"  >}</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ><br></font></div><div><font size="2"  >case "$1" in</font></div><div><font size="2"  >start)</font></div><div><font size="2"  >start</font></div><div><font size="2"  >;;</font></div><div><font size="2"  >stop)</font></div><div><font size="2"  >stop</font></div><div><font size="2"  >;;</font></div><div><font size="2"  >restart|reload)</font></div><div><font size="2"  >stop</font></div><div><font size="2"  >start</font></div><div><font size="2"  >RETVAL=$?</font></div><div><font size="2"  >;;</font></div><div><font size="2"  >*)</font></div><div><font size="2"  >echo "Usage: ucarp {start:stop:restart:reload}" &gt;&amp;2</font></div><div><font size="2"  >;;</font></div><div><font size="2"  >esac</font></div><div><font size="2"  >exit 0</font></div><p></p></pre></div><div><br></div><div>Make this file executable</div><div><br></div><div>#chmod 500 /etc/init.d/ucarp</div><div><br></div><div>Add to init</div><div><br></div><div>chkconfig -add ucarp</div><div><br></div><div>If everything done correct, when you run</div><div><br></div><div>#chkconfig --list ucarp</div><div><br></div><div>you have to see</div><div><br></div><div>ucarp 0:off 1:off 2:on 3:on 4:on 5:on 6:off</div></div><div><br></div><div><br></div><div><br></div><div>【参考】</div><div>1.&nbsp;<a rel="nofollow" href="http://en.wikipedia.org/wiki/Common_Address_Redundancy_Protocol"  >http://en.wikipedia.org/wiki/Common_Address_Redundancy_Protocol</a></div><div>2.&nbsp;<a rel="nofollow" href="http://en.wikipedia.org/wiki/Pfsyncd"  >http://en.wikipedia.org/wiki/Pfsyncd</a></div><div>3.&nbsp;<a rel="nofollow" href="http://www.pureftpd.org/project/ucarp"  >http://www.pureftpd.org/project/ucarp</a></div>4.&nbsp;<a rel="nofollow" href="http://www.openbsd.org/cgi-bin/man.cgi?query=carp"  >http://www.openbsd.org/cgi-bin/man.cgi?query=carp</a><div>5.&nbsp;<a rel="nofollow" href="http://www.openbsd.org/lyrics.html#35"  >http://www.openbsd.org/lyrics.html#35</a></div><div>6.&nbsp;<a rel="nofollow" href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfsync"  >http://www.openbsd.org/cgi-bin/man.cgi?query=pfsync</a></div><div>7.&nbsp;<a rel="nofollow" href="http://www.countersiege.com/doc/pfsync-carp/"  >http://www.countersiege.com/doc/pfsync-carp/</a></div><div>8.&nbsp;<a rel="nofollow" href="http://www.openbsd.org/cgi-bin/cvsweb/src/sys/netinet/ip_carp.c#rev1.1"  >http://www.openbsd.org/cgi-bin/cvsweb/src/sys/netinet/ip_carp.c#rev1.1</a></div>9.&nbsp;<a rel="nofollow" href="http://pf4freebsd.love2party.net/carp.html"  >http://pf4freebsd.love2party.net/carp.html</a><br><div>10.&nbsp;<a rel="nofollow" href="http://www.netbsd.org/docs/guide/en/chap-carp.html"  >http://www.netbsd.org/docs/guide/en/chap-carp.html</a></div><div>11.&nbsp;<a rel="nofollow" href="http://www.openbsd.org/faq/faq6.html#CARP"  >http://www.openbsd.org/faq/faq6.html#CARP</a></div></div>
	</div>
</div>
</body>
</html>