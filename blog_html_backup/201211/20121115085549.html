<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL Temproary table style</h2>
	<h5 id="">2012-11-15 8:55:49&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012101575032326/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>SQL标准中临时表是一次创建, 以后使用的时候无须再次创建的. 并且每个会话保持各自的数据.</div><div>但是在PostgreSQL中, 临时表的使用有所改变.</div><div>1. 临时表在会话结束后会自动删除（或者在事务结束后删除on commit drop）. 也就是说每个会话中需要使用临时表的话需要重新创建.</div><div>&nbsp; &nbsp; 这个有好处也有坏处, 好处是不同的会话能够使用同名但是不同结构的临时表. SQL标准无法做到.&nbsp;</div><div>&nbsp; &nbsp; 坏处是新建的会话如果只是要使用同名同结构的临时表也有重新创建.&nbsp;</div><div>2. 临时表可以选择在事务结束后删除数据或者保留数据或者删除表.</div><div><br></div><div>【语法】</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >CREATE [ [ <font color="#ff0000"  >GLOBAL | LOCAL ] { TEMPORARY | TEMP</font> } | UNLOGGED ] TABLE [ IF NOT EXISTS ] table_name ( [</font></div><div><font size="2"  >&nbsp; { column_name data_type [ COLLATE collation ] [ column_constraint [ ... ] ]</font></div><div><font size="2"  >&nbsp; &nbsp; | table_constraint</font></div><div><font size="2"  >&nbsp; &nbsp; | LIKE source_table [ like_option ... ] }</font></div><div><font size="2"  >&nbsp; &nbsp; [, ... ]</font></div><div><font size="2"  >] )</font></div><div><font size="2"  >[ INHERITS ( parent_table [, ... ] ) ]</font></div><div><font size="2"  >[ WITH ( storage_parameter [= value] [, ... ] ) | WITH OIDS | WITHOUT OIDS ]</font></div><div><font size="2"  >[ <font color="#ff0000"  >ON COMMIT { PRESERVE ROWS | DELETE ROWS | DROP</font> } ]</font></div><div><font size="2"  >[ TABLESPACE tablespace_name ]</font></div><p></p></pre></div><div>红色部分是与临时表有关的. 其中GLOBAL和LOCAL在这个语法中是一样的, 没有分别, 但是在SQL标准中是不一样的.</div><div><span style="color: rgb(255, 0, 0); line-height: 22px;"  >ON COMMIT { PRESERVE ROWS | DELETE ROWS | DROP&nbsp;</span></div><div><span style="color: rgb(255, 0, 0); line-height: 22px;"  >PRESERVE ROWS&nbsp;</span><span style="color: rgb(255, 0, 0); line-height: 22px;"  >表示临时表的数据在事务结束后保留.</span></div><div><span style="color: rgb(255, 0, 0); line-height: 22px;"  >DELETE ROWS 表示</span><span style="color: rgb(255, 0, 0); line-height: 22px;"  >临时表的数据在事务结束后truncate掉.</span></div><div><span style="color: rgb(255, 0, 0); line-height: 22px;"  >DROP&nbsp;</span><span style="line-height: 22px; color: rgb(255, 0, 0);"  >表示</span><span style="line-height: 22px; color: rgb(255, 0, 0);"  >临时表在事务结束后删除.</span></div><div><span style="line-height: 22px; color: rgb(255, 0, 0);"  >默认使用的是</span><span style="color: rgb(255, 0, 0); line-height: 22px;"  >PRESERVE ROWS.</span></div><div><span style="color: rgb(255, 0, 0); line-height: 22px;"  ><br></span></div><div><span style="line-height: 22px;"  >【例子】</span></div><div><span style="line-height: 22px;"  >1.&nbsp;</span><span style="line-height: 22px;"  >临时表在会话结束后会自动删除（或者在事务结束后删除on commit drop）.</span><span style="line-height: 22px;"  >&nbsp;</span></div><div><span style="line-height: 22px;"  >会话1 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><span style="line-height: 22px;"  ><font size="2"  ><div>pg9.2.0@db-172-16-3-150-&gt; psql digoal digoal</div><div>psql (9.2.0)</div><div>Type "help" for help.</div></font></span></div><div><div style="line-height: 22px;"  ><font size="2"  >digoal=&gt; create temp table t(id int);</font></div><div style="line-height: 22px;"  ><font size="2"  >CREATE TABLE</font></div><div style="line-height: 22px;"  ><font size="2"  >digoal=&gt; select relname,relnamespace,oid from pg_class where relname='t';</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp;relname | relnamespace | &nbsp;oid &nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  >---------+--------------+-------</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp;t &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;41192 | 41203</font></div><div style="line-height: 22px;"  ><font size="2"  >(1 row)</font></div><div style="line-height: 22px;"  ><div><font size="2"  >digoal=&gt; select nspname from pg_namespace where oid=41192;</font></div><div><font size="2"  >&nbsp; nspname &nbsp;</font></div><div><font size="2"  >-----------</font></div><div><font size="2"  >&nbsp;pg_temp_2</font></div><div><font size="2"  >(1 row)</font></div></div></div><p></p></pre></div><div><div style="line-height: 22px;"  >退出会话1后重进, 临时表已经被删除了.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; \q</font></div><div><font size="2"  >pg9.2.0@db-172-16-3-150-&gt; psql digoal digoal</font></div><div><font size="2"  >psql (9.2.0)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  >digoal=&gt; select nspname from pg_namespace where oid=41192;</font></div><div><font size="2"  >&nbsp; nspname &nbsp;</font></div><div><font size="2"  >-----------</font></div><div><font size="2"  >&nbsp;pg_temp_2</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=&gt; select relname,relnamespace,oid from pg_class where relname='t';</font></div><div><font size="2"  >&nbsp;relname | relnamespace | oid&nbsp;</font></div><div><font size="2"  >---------+--------------+-----</font></div><div><font size="2"  >(0 rows)</font></div><p></p></pre></div><div style="line-height: 22px;"  ><br></div></div><div><span style="line-height: 22px;"  >2.&nbsp;</span><span style="line-height: 22px;"  >每个会话中需要使用临时表的话需要重新创建.&nbsp;</span><span style="line-height: 22px;"  >好处是不同的会话能够使用同名但是不同结构的临时表.</span></div><div><span style="line-height: 22px;"  >会话1</span></div><div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div><div style="line-height: 22px;"  ><font size="2"  >pg9.2.0@db-172-16-3-150-&gt; psql digoal digoal</font></div><div style="line-height: 22px;"  ><font size="2"  >psql (9.2.0)</font></div><div style="line-height: 22px;"  ><font size="2"  >Type "help" for help.</font></div></div><div><span style="line-height: 22px;"  ><font size="2"  ><div>digoal=&gt; create temp table t(id int);</div><div>CREATE TABLE</div></font></span></div><p></p></pre></div></div><div><span style="line-height: 22px;"  >会话2</span></div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >pg9.2.0@db-172-16-3-150-&gt; psql digoal digoal</font></div><div><font size="2"  >psql (9.2.0)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  >digoal=&gt; create temp table t(id text,id2 int);</font></div><div><font size="2"  >CREATE TABLE</font></div></div><div><div><font size="2"  >digoal=&gt; select relname,relnamespace,oid from pg_class where relname='t';</font></div><div><font size="2"  >&nbsp;relname | relnamespace | &nbsp;oid &nbsp;</font></div><div><font size="2"  >---------+--------------+-------</font></div><div><font size="2"  >&nbsp;t &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;11194 | 41206</font></div><div><font size="2"  >&nbsp;t &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;41192 | 41209</font></div><div><font size="2"  >(2 rows)</font></div><div><font size="2"  >digoal=&gt; select nspname from pg_namespace where oid in (11194, 41192);</font></div><div><font size="2"  >&nbsp; nspname &nbsp;</font></div><div><font size="2"  >-----------</font></div><div><font size="2"  >&nbsp;pg_temp_1</font></div><div><font size="2"  >&nbsp;pg_temp_2</font></div><div><font size="2"  >(2 rows)</font></div></div><p></p></pre></div><div>会话3</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg9.2.0@db-172-16-3-150-&gt; psql digoal digoal</font></div><div><font size="2"  >psql (9.2.0)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  >digoal=&gt; create temp table t(id text,id2 int,info text);</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >digoal=&gt; select relname,relnamespace,oid from pg_class where relname='t';</font></div><div><font size="2"  >&nbsp;relname | relnamespace | &nbsp;oid &nbsp;</font></div><div><font size="2"  >---------+--------------+-------</font></div><div><font size="2"  >&nbsp;t &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;11194 | 41206</font></div><div><font size="2"  >&nbsp;t &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;41192 | 41209</font></div><div><font size="2"  >&nbsp;t &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;41215 | 41217</font></div><div><font size="2"  >(3 rows)</font></div><div><font size="2"  >digoal=&gt; select nspname from pg_namespace where oid in (11194, 41192, 41215);</font></div><div><font size="2"  >&nbsp; nspname &nbsp;</font></div><div><font size="2"  >-----------</font></div><div><font size="2"  >&nbsp;pg_temp_1</font></div><div><font size="2"  >&nbsp;pg_temp_2</font></div><div><font size="2"  >&nbsp;pg_temp_3</font></div><div><font size="2"  >(3 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  ><br></span></div><div><span style="line-height: 22px;"  >3.&nbsp;</span><span style="line-height: 22px;"  >临时表可以选择在事务结束后删除数据或者保留数据或者删除表.</span></div><div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >digoal=&gt; begin;</font></div><div style="line-height: 22px;"  ><font size="2"  >BEGIN</font></div><div style="line-height: 22px;"  ><div><font size="2"  >digoal=&gt; create temp table test (id int) on commit preserve rows;</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >digoal=&gt; create temp table test1 (id int) on commit delete rows;</font></div><div><font size="2"  >CREATE TABLE</font></div></div><div style="line-height: 22px;"  ><div><font size="2"  >digoal=&gt; create temp table test2 (id int) on commit drop;</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >digoal=&gt; select relname,relnamespace,oid from pg_class where relname in ('test', 'test1', 'test2');</font></div><div><font size="2"  >&nbsp;relname | relnamespace | &nbsp;oid &nbsp;</font></div><div><font size="2"  >---------+--------------+-------</font></div><div><font size="2"  >&nbsp;test &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;41215 | 41223</font></div><div><font size="2"  >&nbsp;test1 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;41215 | 41226</font></div><div><font size="2"  >&nbsp;test2 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;41215 | 41232</font></div><div><font size="2"  >(3 rows)</font></div></div><div><div><font size="2"  >digoal=&gt; insert into test values (1);</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; insert into test1 values (1);</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; commit;</font></div><div><font size="2"  >COMMIT</font></div></div><p></p></pre></div><div><div>事务提交后test2已经被自动drop掉了.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select relname,relnamespace,oid from pg_class where relname in ('test', 'test1', 'test2');</font></div><div><font size="2"  >&nbsp;relname | relnamespace | &nbsp;oid &nbsp;</font></div><div><font size="2"  >---------+--------------+-------</font></div><div><font size="2"  >&nbsp;test &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;41215 | 41223</font></div><div><font size="2"  >&nbsp;test1 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;41215 | 41226</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div>test的数据事务提交后数据保留.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select * from test;</font></div><div><font size="2"  >&nbsp;id&nbsp;</font></div><div><font size="2"  >----</font></div><div><font size="2"  >&nbsp; 1</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >test1的数据事务提交后数据已删除.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select * from test1;</font></div><div><font size="2"  >&nbsp;id&nbsp;</font></div><div><font size="2"  >----</font></div><div><font size="2"  >(0 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >test2在事务提交后表已删除.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select * from test2;</font></div><div><font size="2"  >ERROR: &nbsp;relation "test2" does not exist</font></div><div><font size="2"  >LINE 1: select * from test2;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><p></p></pre></div></div></div><div><span style="line-height: 22px;"  ><br></span></div><div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >4. 如果有临时表和非临时表重名了, 那么默认是使用临时表的, 如果要使用非临时表, 需要带上schema, 如schema.table.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create table dup_table_name (id int);</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >digoal=&gt; create temp table dup_table_name (id int);</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >digoal=&gt; insert into digoal.dup_table_name values (1);</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; select * from dup_table_name ;</font></div><div><font size="2"  >&nbsp;id&nbsp;</font></div><div><font size="2"  >----</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  >digoal=&gt; insert into dup_table_name values (2);</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; select * from dup_table_name ;</font></div><div><font size="2"  >&nbsp;id&nbsp;</font></div><div><font size="2"  >----</font></div><div><font size="2"  >&nbsp; 2</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=&gt; select * from digoal.dup_table_name ;</font></div><div><font size="2"  >&nbsp;id&nbsp;</font></div><div><font size="2"  >----</font></div><div><font size="2"  >&nbsp; 1</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><br></span></div><div style="line-height: 22px;"  >5. 临时表上创建的索引也是临时的.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create index idx_test on dup_table_name (id);</font></div><div><font size="2"  >CREATE INDEX</font></div><div><font size="2"  >digoal=&gt; \d dup_table_name&nbsp;</font></div><div><font size="2"  >Table "pg_temp_3.dup_table_name"</font></div><div><font size="2"  >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"  >--------+---------+-----------</font></div><div><font size="2"  >&nbsp;id &nbsp; &nbsp; | integer |&nbsp;</font></div><div><font size="2"  >Indexes:</font></div><div><font size="2"  >&nbsp; &nbsp; "idx_test" btree (id)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; \di idx_test&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"  >&nbsp; Schema &nbsp; | &nbsp; Name &nbsp; | Type &nbsp;| Owner &nbsp;| &nbsp; &nbsp; Table &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >-----------+----------+-------+--------+----------------</font></div><div><font size="2"  >&nbsp;pg_temp_3 | idx_test | index | digoal | dup_table_name</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div style="line-height: 22px;"  ><br></div><div style="line-height: 22px;"  >6. 临时表无法选择性的创建在某个schema下面, 它是存在于临时schema的, 例如pg_temp_?. 对应的TOAST表也在临时的schema下, 例如(pg_toast_temp_?) . 虽然无法选择schema但是tablespace是可以指定的.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create temp table digoal.tmp_test (id int);</font></div><div><font size="2"  >ERROR: &nbsp;cannot create temporary relation in non-temporary schema</font></div><p></p></pre></div><div style="line-height: 22px;"  ><br></div><div style="line-height: 22px;"  >7. PostgreSQL 中临时表的统计信息不会被autovacuum daemo自动收集. 所以如果有复杂查询的话, 最好再有DML后自己执行analyze.</div></div><div><br></div><div>【小结】</div><div><span style="line-height: 22px;"  >1. 如果有临时表和非临时表重名了, 那么默认是使用临时表的, 如果要使用非临时表, 需要带上schema, 如schema.table.</span></div><div>2. 临时表上创建的索引也是临时的.</div><div>3. 临时表无法选择性的创建在某个schema下面, 它是存在于临时schema的, 例如pg_temp_?. 对应的TOAST表也在临时的schema下, 例如(pg_toast_temp_?) . 虽然无法选择schema但是tablespace是可以指定的.</div><div>4. PostgreSQL 中临时表的统计信息不会被autovacuum daemo自动收集. 所以如果有索引的情况下, 最好再有DML后自己执行analyze.</div><div><br></div>【参考】<div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/sql-createtable.html"  >http://www.postgresql.org/docs/9.2/static/sql-createtable.html</a></div><div>2.&nbsp;src/backend/catalog/namespace.c<br><br><wbr></div></div>
	</div>
</div>
</body>
</html>