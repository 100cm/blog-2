<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">[转]setup [ heartbeat 2.1.3-6 under debian lenny ]: use two servers</h2>
	<h5 id="">2012-11-02 13:59:34&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201210215427333/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">一直以来就没用过heartbeat, 转一篇老外介绍heartbeat的简单配置文章, 下一篇转一个vrrp或者carp的.<div><div><br></div><div>Can anyone explain what is the major difference between Heartbeat and UCarp for IP fail-over scenarios?</div><div>They both seem to provide this functionality, perhaps UCarp simpler to set-up?</div><div><br></div><div>i assume you're interested in simple active-passive setup.</div><div>ucarp &amp; heartbeat in such setup do pretty much the same thing. in essence - they run provided scripts when machine is elected to be master / hot-standby.</div><div>heartbeat might look much more complicated [ since it can help you autoamte drdb mounts, restarting multiple services etc ] but at the end - you can script all of this and let ucarp invoke it .</div><div>personally - i run heartbeat with single resource - that is script that does following:</div><div>1. [un]binds appropriate ip address</div><div>2. runs couple of arp-broadcasts, VIP在切换后拿到VIP的主机需要发出arp广播包, 告诉网络上的设备VIP对应的新MAC地址.</div><div>3. starts[stops] required services</div><div><br></div><div>my very simplistic setup [ heartbeat 2.1.3-6 under debian lenny ]:&nbsp;</div><div>i have two servers:</div><div>1. ser0 [preferred active node] with permanently assigned 10.0.0.2/24 at eth0</div><div>2. ser0b [hot-standby node waiting to replace master] with permanently assigned 10.0.0.3/24 at eth0</div><div>3. 'floating ip' - assigned to the active node is 10.0.1.1/24 assigned to eth1</div><div><br></div><div>in this case service that gets high availability is apache. i separately sync apache's configs and content that is served from ser0 to ser0b.</div><div><br></div><div>files below are identical on both machines with one marked exception:</div><div><br></div><div>vi /etc/ha.d/authkeys:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >auth 1</font></div><div><font size="2"  >1 md5 somethingrandom</font></div><p></p></pre></div><div><br></div><div>vi /etc/ha.d/haresources</div><div><pre class="prettyprint"  ><p><font size="2"  >ser0 ha.sh</font></p></pre></div><div><br></div><div>vi /etc/ha.d/ha.cf , 主机和备机的配置不同之处以下已经之处.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >keepalive 2</font></div><div><font size="2"  >deadtime 10</font></div><div><font size="2"  >udpport &nbsp; &nbsp; &nbsp; &nbsp;694&nbsp;</font></div><div><font size="2"  >; below - address permanently assigned to the peer node . this is for master:</font></div><div><font size="2"  >ucast eth1 10.0.0.3</font></div><div><font size="2"  >; and on slave i have&nbsp;</font></div><div><font size="2"  >; ucast eth1 10.0.0.2</font></div><div><font size="2"  >udp &nbsp; &nbsp; eth0</font></div><div><font size="2"  >logfacility &nbsp; &nbsp; local0</font></div><div><font size="2"  >auto_failback on</font></div><div><font size="2"  >node &nbsp; &nbsp;ser0</font></div><div><font size="2"  >node &nbsp; &nbsp;ser0b</font></div><p></p></pre></div><div><br></div><div>vi /etc/init.d/ha.cf&nbsp;</div><div># [ it can as well be in /etc/ha.d/resources.d/ha.cf ]</div><div><br></div><div>#!/bin/bash</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >case "$1" in</font></div><div><font size="2"  >&nbsp; start)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; ip link set dev eth1 up</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; # bind 'floating' ip to the interface</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; ip a a 10.0.1.1/24 dev eth1</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; # you might want to add some route-changes here if needed</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; /usr/lib/heartbeat/send_arp -r 10 eth1 10.0.0.1 auto 10.0.0.255 255.255.255.0</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; # to make sure apache reloads it's config when machine becomes master</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; /etc/init.d/apache2 restart</font></div><div><font size="2"  >&nbsp; ;;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; stop)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; # we are no longer active, un-bind 'floating' ip from the interface</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; ip a d 10.0.1.1/24 dev eth1</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; # you could stop it as well or just skip this step</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; /etc/init.d/apache2 restart</font></div><div><font size="2"  >&nbsp; ;;</font></div><div><font size="2"  >esac</font></div><div><font size="2"  >exit 0</font></div><p></p></pre></div><div><br><br><wbr></div></div></div>
	</div>
</div>
</body>
</html>