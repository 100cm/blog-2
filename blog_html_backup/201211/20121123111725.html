<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL report LOG stats by csvlog and file_fdw</h2>
	<h5 id="">2012-11-23 11:17:25&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020121023105322442/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>当管理的数据库非常多的时候, 要了解数据库打印的日志都是一件非常痛苦的事情.</div><div>怎么样减轻这种痛苦呢, 以下以file_fdw为例, 通过分析日志的error_severity计数, 找出你应该重点关注的数据库集群.</div><div>注意要读文件必须是超级用户.</div><div>另外要解释以下, file_fdw是服务端接口, 所以读的是服务端的文件, 而不是客户端的文件, 所以可以通过客户端远程连过去进行统计.</div><div>另外就是csvlog的格式需要统一一下.</div><div><br></div><div>PostgreSQL 9.2.1 为例 :&nbsp;</div><div>日志格式以及rotate等.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select name,setting from pg_settings where name ~ 'log';</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;setting &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >-----------------------------+--------------------------------</font></div><div><font size="2"  >&nbsp;log_destination &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | csvlog</font></div><div><font size="2"  >&nbsp;log_directory &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | pg_log</font></div><div><font size="2"  >&nbsp;log_file_mode &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 0600</font></div><div><font size="2"  >&nbsp;log_filename &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| postgresql-%Y-%m-%d_%H%M%S.log</font></div><div><font size="2"  >&nbsp;log_rotation_age &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1440</font></div><div><font size="2"  >&nbsp;log_rotation_size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 10240</font></div><div><font size="2"  >&nbsp;log_statement &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | ddl</font></div><div><font size="2"  >&nbsp;log_timezone &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| PRC</font></div><div><font size="2"  >&nbsp;log_truncate_on_rotation &nbsp; &nbsp;| on</font></div><div><font size="2"  >&nbsp;logging_collector &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | on</font></div><p></p></pre></div><div>创建file_fdw extension :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# create extension file_fdw;</font></div><div><font size="2"  >CREATE EXTENSION</font></div><div><font size="2"  >digoal=# CREATE SERVER pglog FOREIGN DATA WRAPPER file_fdw;</font></div><div><font size="2"  >CREATE SERVER</font></div><p></p></pre></div><div>列出pg_log下的文件名, 这里用到的是pg_ls_dir函数 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select filename from (select pg_ls_dir(setting) as filename from pg_settings where name='log_directory') t where t.filename ~ '.*2012-11-22.*csv$';</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;filename &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----------------------------------</font></div><div><font size="2"  >&nbsp;postgresql-2012-11-22_000000.csv</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>创建pglog外部表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# CREATE FOREIGN TABLE pglog (</font></div><div><font size="2"  >&nbsp; log_time timestamp(3) with time zone,</font></div><div><font size="2"  >&nbsp; user_name text,</font></div><div><font size="2"  >&nbsp; database_name text,</font></div><div><font size="2"  >&nbsp; process_id integer,</font></div><div><font size="2"  >&nbsp; connection_from text,</font></div><div><font size="2"  >&nbsp; session_id text,</font></div><div><font size="2"  >&nbsp; session_line_num bigint,</font></div><div><font size="2"  >&nbsp; command_tag text,</font></div><div><font size="2"  >&nbsp; session_start_time timestamp with time zone,</font></div><div><font size="2"  >&nbsp; virtual_transaction_id text,</font></div><div><font size="2"  >&nbsp; transaction_id bigint,</font></div><div><font size="2"  >&nbsp; error_severity text,</font></div><div><font size="2"  >&nbsp; sql_state_code text,</font></div><div><font size="2"  >&nbsp; message text,</font></div><div><font size="2"  >&nbsp; detail text,</font></div><div><font size="2"  >&nbsp; hint text,</font></div><div><font size="2"  >&nbsp; internal_query text,</font></div><div><font size="2"  >&nbsp; internal_query_pos integer,</font></div><div><font size="2"  >&nbsp; context text,</font></div><div><font size="2"  >&nbsp; query text,</font></div><div><font size="2"  >&nbsp; query_pos integer,</font></div><div><font size="2"  >&nbsp; location text,</font></div><div><font size="2"  >&nbsp; application_name text</font></div><div><font size="2"  >) SERVER pglog</font></div><div><font size="2"  >OPTIONS ( filename 'pg_log/postgresql-2012-11-22_000000.csv', format 'csv' );</font></div><div><font size="2"  >CREATE FOREIGN TABLE</font></div><p></p></pre></div><div><br></div><div>这样就可以检索这个表了 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select * from pglog limit 1;</font></div><div><font size="2"  >-[ RECORD 1 ]----------+---------------------------</font></div><div><font size="2"  >log_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-11-22 14:00:52.735+08</font></div><div><font size="2"  >user_name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >database_name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >process_id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 4923</font></div><div><font size="2"  >connection_from &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >session_id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 50ac4200.133b</font></div><div><font size="2"  >session_line_num &nbsp; &nbsp; &nbsp; | 618</font></div><div><font size="2"  >command_tag &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >session_start_time &nbsp; &nbsp; | 2012-11-22 00:52:48+08</font></div><div><font size="2"  >virtual_transaction_id |&nbsp;</font></div><div><font size="2"  >transaction_id &nbsp; &nbsp; &nbsp; &nbsp; | 0</font></div><div><font size="2"  >error_severity &nbsp; &nbsp; &nbsp; &nbsp; | LOG</font></div><div><font size="2"  >sql_state_code &nbsp; &nbsp; &nbsp; &nbsp; | 00000</font></div><div><font size="2"  >message &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| checkpoint starting: time</font></div><div><font size="2"  >detail &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >hint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >internal_query &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >internal_query_pos &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >context &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >query_pos &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >location &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >application_name &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><p></p></pre></div><div><br></div><div>但是这样还不够, 我们需要稍微智能一些, 因为1天可能产生很多个csv文件, 所以用函数来建外部表是比较方便快捷的 :&nbsp;</div><div>根据日期创建对应的外部表 :&nbsp;</div><div>外部表的格式也进行统一如 : pglog_$yyyymmdd_$x</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function create_pglog_table (i_date date) returns void as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_path text;</font></div><div><font size="2"  >v_filename text;</font></div><div><font size="2"  >v_suffix int;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >v_suffix := 0;</font></div><div><font size="2"  >select setting into v_path from pg_settings where name = 'log_directory';</font></div><div><font size="2"  >for v_filename in execute $$select filename from (select pg_ls_dir(setting) as filename from pg_settings where name='log_directory') t where t.filename ~ '.*$$||i_date::text||$$.*csv'$$ loop</font></div><div><font size="2"  >execute $$CREATE FOREIGN TABLE IF NOT EXISTS pglog_$$||to_char(i_date,'yyyymmdd')||'_'||v_suffix||$$ (</font></div><div><font size="2"  >&nbsp; log_time timestamp(3) with time zone,</font></div><div><font size="2"  >&nbsp; user_name text,</font></div><div><font size="2"  >&nbsp; database_name text,</font></div><div><font size="2"  >&nbsp; process_id integer,</font></div><div><font size="2"  >&nbsp; connection_from text,</font></div><div><font size="2"  >&nbsp; session_id text,</font></div><div><font size="2"  >&nbsp; session_line_num bigint,</font></div><div><font size="2"  >&nbsp; command_tag text,</font></div><div><font size="2"  >&nbsp; session_start_time timestamp with time zone,</font></div><div><font size="2"  >&nbsp; virtual_transaction_id text,</font></div><div><font size="2"  >&nbsp; transaction_id bigint,</font></div><div><font size="2"  >&nbsp; error_severity text,</font></div><div><font size="2"  >&nbsp; sql_state_code text,</font></div><div><font size="2"  >&nbsp; message text,</font></div><div><font size="2"  >&nbsp; detail text,</font></div><div><font size="2"  >&nbsp; hint text,</font></div><div><font size="2"  >&nbsp; internal_query text,</font></div><div><font size="2"  >&nbsp; internal_query_pos integer,</font></div><div><font size="2"  >&nbsp; context text,</font></div><div><font size="2"  >&nbsp; query text,</font></div><div><font size="2"  >&nbsp; query_pos integer,</font></div><div><font size="2"  >&nbsp; location text,</font></div><div><font size="2"  >&nbsp; application_name text</font></div><div><font size="2"  >) SERVER pglog</font></div><div><font size="2"  >OPTIONS ( filename '$$||v_path||'/'||v_filename||$$', format 'csv' )$$;</font></div><div><font size="2"  >raise notice 'created foreign table: %', $$pglog_$$||to_char(i_date,'yyyymmdd')||'_'||v_suffix ;</font></div><div><font size="2"  >v_suffix := v_suffix + 1;</font></div><div><font size="2"  >end loop;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><p></p></pre></div><div><br></div><div>外部表统计完就可以删掉了, 否则一堆的外部表看着也不舒服.</div><div>根据日期进行删除 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function drop_pglog_table (i_date date) returns void as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_tablename text;</font></div><div><font size="2"  >v_schema text;</font></div><div><font size="2"  >v_sql text;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >for v_tablename in execute $$select relname from pg_class&nbsp;</font></div><div><font size="2"  >where oid in (select ftrelid from pg_foreign_table)&nbsp;</font></div><div><font size="2"  >and relname ~ 'pglog_$$||to_char(i_date,'yyyymmdd')||$$'$$ loop</font></div><div><font size="2"  >select t2.nspname into v_schema from pg_class t1, pg_namespace t2&nbsp;</font></div><div><font size="2"  >where t1.oid in (select ftrelid from pg_foreign_table)&nbsp;</font></div><div><font size="2"  >and t1.relnamespace=t2.oid</font></div><div><font size="2"  >and t1.relname=v_tablename;</font></div><div><font size="2"  >v_sql := 'DROP FOREIGN TABLE IF EXISTS '||v_schema||'.'||v_tablename ;</font></div><div><font size="2"  >execute v_sql;</font></div><div><font size="2"  >raise notice 'droped foreign table: %', v_schema||'.'||v_tablename;</font></div><div><font size="2"  >end loop;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><p></p></pre></div><div><br></div><div>这个是统计函数, 用来统计error_severity的各个维度的计数 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function error_stats</font></div><div><font size="2"  >(</font></div><div><font size="2"  >IN i_date date,</font></div><div><font size="2"  >OUT o_error_severity text,</font></div><div><font size="2"  >OUT o_count bigint</font></div><div><font size="2"  >)</font></div><div><font size="2"  >returns setof record as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_tablename text;</font></div><div><font size="2"  >v_schema text;</font></div><div><font size="2"  >v_sql text;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >for v_tablename in execute $$select relname from pg_class&nbsp;</font></div><div><font size="2"  >where oid in (select ftrelid from pg_foreign_table)&nbsp;</font></div><div><font size="2"  >and relname ~ 'pglog_$$||to_char(i_date,'yyyymmdd')||$$'$$ loop</font></div><div><font size="2"  >select t2.nspname into v_schema from pg_class t1, pg_namespace t2&nbsp;</font></div><div><font size="2"  >where t1.oid in (select ftrelid from pg_foreign_table)&nbsp;</font></div><div><font size="2"  >and t1.relnamespace=t2.oid</font></div><div><font size="2"  >and t1.relname=v_tablename;</font></div><div><font size="2"  >v_sql := 'select error_severity,count(*) from '||v_schema||'.'||v_tablename||' group by error_severity';</font></div><div><font size="2"  >return query execute v_sql;</font></div><div><font size="2"  >end loop;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><p></p></pre></div><div>创建2012-11-19那天的csvlog外部表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select * from create_pglog_table('2012-11-19');</font></div><div><div><font size="2"  >NOTICE: &nbsp;created foreign table: pglog_20121119_0</font></div><div><font size="2"  >NOTICE: &nbsp;created foreign table: pglog_20121119_1</font></div><div><font size="2"  >NOTICE: &nbsp;created foreign table: pglog_20121119_2</font></div><div><font size="2"  >NOTICE: &nbsp;created foreign table: pglog_20121119_3</font></div><div><font size="2"  >NOTICE: &nbsp;created foreign table: pglog_20121119_4</font></div><div><font size="2"  >NOTICE: &nbsp;created foreign table: pglog_20121119_5</font></div><div><font size="2"  >NOTICE: &nbsp;created foreign table: pglog_20121119_6</font></div><div><font size="2"  >NOTICE: &nbsp;created foreign table: pglog_20121119_7</font></div><div><font size="2"  >&nbsp;create_pglog_table&nbsp;</font></div><div><font size="2"  >--------------------</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div>统计2012-11-19那天的日志 :&nbsp;</div><div>这里请务必在连接是使用IP地址和端口, 不要使用socket或者127.0.0.1, 否则inet_server_addr出来的信息会不对.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select '2012-11-19'::date as stat_date,inet_server_addr(),inet_server_port(),o_error_severity,sum(o_count) from error_stats('2012-11-19') group by inet_server_addr(),inet_server_port(),o_error_severity order by o_error_severity;</font></div><div><font size="2"  >&nbsp;stat_date &nbsp;| inet_server_addr | inet_server_port | o_error_severity | &nbsp;sum &nbsp;&nbsp;</font></div><div><font size="2"  >------------+------------------+------------------+------------------+--------</font></div><div><font size="2"  >&nbsp;2012-11-19 | 172.16.3.150 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 9200 | ERROR &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;9</font></div><div><font size="2"  >&nbsp;2012-11-19 | 172.16.3.150 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 9200 | LOG &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;861</font></div><div><font size="2"  >&nbsp;2012-11-19 | 172.16.3.150 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 9200 | WARNING &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 224165</font></div><div><font size="2"  >(3 rows)</font></div><p></p></pre></div><div>有了这个信息基础, 我们可以创建一个统计信息库, 设计一个统计表, 将每个数据库每天的这些信息插入到这个统计表中, 然后我们可以定一个阈值, 例如将1天的ERROR超过多少条的数据库展示出来. 对于这种数据库进行重点的关注.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# create table pglog_stats</font></div><div><font size="2"  >(stat_date date, server_addr inet, server_port int, error_severity text, cnt int,&nbsp;</font></div><div><font size="2"  >primary key(stat_date,server_addr,server_port,error_severity));</font></div><p></p></pre></div><div><br></div><div>删表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select * from drop_pglog_table('2012-11-19');</font></div><div><font size="2"  >NOTICE: &nbsp;droped foreign table: public.pglog_20121119_0</font></div><div><font size="2"  >NOTICE: &nbsp;droped foreign table: public.pglog_20121119_1</font></div><div><font size="2"  >NOTICE: &nbsp;droped foreign table: public.pglog_20121119_2</font></div><div><font size="2"  >NOTICE: &nbsp;droped foreign table: public.pglog_20121119_3</font></div><div><font size="2"  >NOTICE: &nbsp;droped foreign table: public.pglog_20121119_4</font></div><div><font size="2"  >NOTICE: &nbsp;droped foreign table: public.pglog_20121119_5</font></div><div><font size="2"  >NOTICE: &nbsp;droped foreign table: public.pglog_20121119_6</font></div><div><font size="2"  >NOTICE: &nbsp;droped foreign table: public.pglog_20121119_7</font></div><div><font size="2"  >&nbsp;drop_pglog_table&nbsp;</font></div><div><font size="2"  >------------------</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>批量创建和删除 :</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select create_pglog_table(t.i_date) from (select date(generate_series('2012-11-01', '2012-11-23', interval '1 day')) as i_date) t;</font></div><div><font size="2"  >digoal=# select drop_pglog_table(t.i_date) from (select date(generate_series('2012-11-01', '2012-11-23', interval '1 day')) as i_date) t;</font></div><div></div><p></p></pre></div><wbr></div>
	</div>
</div>
</body>
</html>