<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL freespacemap file crash recovery</h2>
	<h5 id="">2011-06-14 16:55:00&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020115144243244/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>自从PostgreSQL 8.4以后,freespace map 就单独记录到文件里面了，以前都是在数据库启动以后记录在内存里面的.</div><div>freespacemap 由数据库对象对应的系统文件加一个后缀_fsm组成.</div><div>在PostgreSQL中，每个字节记录一个PAGE的freespace信息。也就是说一个PAGE记录的剩余空间最小单位是page_size/2^8 。</div><div>为了提高FSM的查询速度，FSM自身的PAGE里面是TREE的结构。为了性能考虑,freespacemap的信息并不是实时更新的,另外需要注意的是，对于索引，只记录了两种状态，使用和完全未使用的PAGE状态。</div><div>关于FSM具体可以参考我以前写的相关BLOG或参考源代码。</div><div><br></div><div>下面主要是测试一下fsm被破坏之后如何修复。</div><div>1. 首先创建测试数据</div><div><div>digoal=&gt; create table tbl_user_log (id int,firstname text,lastname text,corp text,createtime timestamp without time zone);</div><div>CREATE TABLE</div></div><div><div>digoal=&gt; insert into tbl_user_log select generate_series(1,1000000),'zhou','digoal'||generate_series(1,1000000),'sky-mobi',clock_timestamp();</div><div>INSERT 0 1000000</div></div><div>2. 查找到文件路径</div><div><div>digoal=&gt; select pg_relation_filepath('tbl_user_log'::regclass);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pg_relation_filepath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>----------------------------------------------</div><div>&nbsp;pg_tblspc/16385/PG_9.1_201105231/16386/57372</div><div>(1 row)</div></div><div>3. 新建pg_freespacemap模块,用于查找FREESPACEMAP.</div><div>\c digoal postgres</div><div>create extension pg_freespacemap;</div><div><br></div><div>fsm crash场景测试 :&nbsp;</div><div>1. 删除fsm&nbsp;</div><div>postgres@db5-&gt; cd $PGDATA/pg_tblspc/16385/PG_9.1_201105231/16386/</div><div><div>postgres@db5-&gt; ll|grep 57372</div><div>-rw------- 1 postgres postgres &nbsp;66M Jun 14 16:36 57372</div><div>-rw------- 1 postgres postgres &nbsp;40K Jun 14 16:33 57372_fsm</div></div><div>#&nbsp;57372_fsm 这个就是对应的tbl_user_log的freespace map 文件.</div><div><div>postgres@db5-&gt; rm 57372_fsm</div><div>rm: remove regular file `57372_fsm'? y</div></div><div># 查看freespacemap信息,返回正常(这部分信息是从共享内存区取出)。</div><div>digoal=# select pg_freespace('digoal.tbl_user_log');</div><div># 修复</div><div><div>digoal=&gt; vacuum verbose tbl_user_log;</div><div>INFO: &nbsp;vacuuming "digoal.tbl_user_log"</div><div>INFO: &nbsp;"tbl_user_log": found 0 removable, 1000000 nonremovable row versions in 8334 out of 8334 pages</div><div>DETAIL: &nbsp;0 dead row versions cannot be removed yet.</div><div>There were 0 unused item pointers.</div><div>0 pages are entirely empty.</div><div>CPU 0.00s/0.00u sec elapsed 8.22 sec.</div><div>INFO: &nbsp;vacuuming "pg_toast.pg_toast_57372"</div><div>INFO: &nbsp;index "pg_toast_57372_index" now contains 0 row versions in 1 pages</div><div>DETAIL: &nbsp;0 index row versions were removed.</div><div>0 index pages have been deleted, 0 are currently reusable.</div><div>CPU 0.00s/0.00u sec elapsed 0.00 sec.</div><div>INFO: &nbsp;"pg_toast_57372": found 0 removable, 0 nonremovable row versions in 0 out of 0 pages</div><div>DETAIL: &nbsp;0 dead row versions cannot be removed yet.</div><div>There were 0 unused item pointers.</div><div>0 pages are entirely empty.</div><div>CPU 0.00s/0.00u sec elapsed 0.00 sec.</div><div>VACUUM</div><div>digoal=&gt; \q</div><div>postgres@db5-&gt; ll|grep 57372</div><div>-rw------- 1 postgres postgres &nbsp;66M Jun 14 16:40 57372</div><div>-rw------- 1 postgres postgres &nbsp;40K Jun 14 16:39 57372_fsm</div><div>-rw------- 1 postgres postgres 8.0K Jun 14 16:39 57372_vm</div></div><div><br></div><div><div>2. 编辑，纂改 fsm</div><div># 首先找到测试删除数据的对应PAGE</div><div><div>digoal=# select min(ctid),max(ctid) from digoal.tbl_user_log where id&lt;20000;</div><div>&nbsp; &nbsp;min &nbsp; | &nbsp; max &nbsp; &nbsp;</div><div>---------+----------</div><div>&nbsp;(0,1) | (166,79)</div><div>(1 row)</div></div><div>一会把这些数据删掉，那么page从0-166应该出现剩余空间.</div><div><div>digoal=# delete from digoal.tbl_user_log where id&lt;=20000;</div><div>DELETE 20000</div></div><div># 立刻去查看freespacemap</div><div><div>digoal=# select pg_freespace('digoal.tbl_user_log');</div><div>&nbsp;pg_freespace&nbsp;</div><div>--------------</div></div><div><div>&nbsp;(0,0)</div><div>&nbsp;(1,0)</div><div>&nbsp;(2,0)</div><div>&nbsp;(3,0)</div><div>&nbsp;(4,0)</div><div>&nbsp;(5,0)</div></div><div>.......</div><div><div>&nbsp;(166,0)</div><div>&nbsp;(167,0)</div><div>&nbsp;(168,0)</div></div><div>＃ 可以看出freespacemap确实不是实时更新的。</div><div># 下面来更新一下.</div><div><div>digoal=# vacuum verbose digoal.tbl_user_log;</div><div>INFO: &nbsp;vacuuming "digoal.tbl_user_log"</div><div>INFO: &nbsp;"tbl_user_log": removed 10001 row versions in 167 pages</div><div>INFO: &nbsp;"tbl_user_log": found 10001 removable, 40 nonremovable row versions in 167 out of 8334 pages</div><div>DETAIL: &nbsp;0 dead row versions cannot be removed yet.</div><div>There were 0 unused item pointers.</div><div>0 pages are entirely empty.</div><div>CPU 0.00s/0.00u sec elapsed 0.01 sec.</div><div>INFO: &nbsp;vacuuming "pg_toast.pg_toast_57372"</div><div>INFO: &nbsp;index "pg_toast_57372_index" now contains 0 row versions in 1 pages</div><div>DETAIL: &nbsp;0 index row versions were removed.</div><div>0 index pages have been deleted, 0 are currently reusable.</div><div>CPU 0.00s/0.00u sec elapsed 0.00 sec.</div><div>INFO: &nbsp;"pg_toast_57372": found 0 removable, 0 nonremovable row versions in 0 out of 0 pages</div><div>DETAIL: &nbsp;0 dead row versions cannot be removed yet.</div><div>There were 0 unused item pointers.</div><div>0 pages are entirely empty.</div><div>CPU 0.00s/0.00u sec elapsed 0.00 sec.</div><div>VACUUM</div></div><div># 再次查看freespacemap</div><div><div>digoal=# select pg_freespace('digoal.tbl_user_log');</div><div>&nbsp;pg_freespace&nbsp;</div><div>--------------</div><div>&nbsp;(0,7680)</div><div>&nbsp;(1,7680)</div><div>&nbsp;(2,7680)</div><div>&nbsp;(3,7680)</div></div><div>................</div><div><div>&nbsp;(165,7680)</div><div>&nbsp;(166,5120)</div><div>&nbsp;(167,0)</div><div>&nbsp;(168,0)</div></div><div># 结果与预期一致.</div><div># 下面来纂改一下fsm的数据</div><div><div>postgres@db5-&gt; pg_ctl stop -m fast</div><div>waiting for server to shut down..... done</div><div>server stopped</div></div><div># md5值先保留一下</div><div><div>postgres@db5-&gt; md5sum 57372_fsm</div><div>c97a9f672900532f38560bc87a6ab7e0 &nbsp;57372_fsm</div></div><div># 纂改后MD5</div><div><div>postgres@db5-&gt; md5sum 57372_fsm</div><div>cf642ab29c09733666eaea3e0acb4b97 &nbsp;57372_fsm</div></div><div># 启动数据库</div><div>pg_ctl start</div><div># FSM数据不可用，查询当前的FSM</div><div><div>postgres@db5-&gt; psql -h 127.0.0.1 digoal postgres</div><div>psql (9.1beta2)</div><div>Type "help" for help.</div><div><br></div><div>digoal=# select pg_freespace('digoal.tbl_user_log');</div><div>&nbsp;pg_freespace&nbsp;</div><div>--------------</div><div>&nbsp;(0,0)</div><div>&nbsp;(1,0)</div><div>&nbsp;(2,0)</div><div>&nbsp;(3,0)</div><div>&nbsp;(4,0)</div></div><div>。。。。。。。。。。。。</div><div><div>&nbsp;(165,0)</div><div>&nbsp;(166,0)</div><div>&nbsp;(167,0)</div><div>&nbsp;(168,0)</div><div>&nbsp;(169,0)</div></div><div><br></div><div># 修复</div><div><div>digoal=# vacuum verbose digoal.tbl_user_log ;</div><div>INFO: &nbsp;vacuuming "digoal.tbl_user_log"</div><div>INFO: &nbsp;"tbl_user_log": found 0 removable, 40 nonremovable row versions in 167 out of 8334 pages</div><div>DETAIL: &nbsp;0 dead row versions cannot be removed yet.</div><div>There were 20000 unused item pointers.</div><div>0 pages are entirely empty.</div><div>CPU 0.00s/0.00u sec elapsed 0.24 sec.</div><div>WARNING: &nbsp;invalid page header in block 0 of relation pg_tblspc/16385/PG_9.1_201105231/16386/57372_fsm; zeroing out page</div><div>WARNING: &nbsp;invalid page header in block 1 of relation pg_tblspc/16385/PG_9.1_201105231/16386/57372_fsm; zeroing out page</div><div>INFO: &nbsp;vacuuming "pg_toast.pg_toast_57372"</div><div>INFO: &nbsp;index "pg_toast_57372_index" now contains 0 row versions in 1 pages</div><div>DETAIL: &nbsp;0 index row versions were removed.</div><div>0 index pages have been deleted, 0 are currently reusable.</div><div>CPU 0.00s/0.00u sec elapsed 0.00 sec.</div><div>INFO: &nbsp;"pg_toast_57372": found 0 removable, 0 nonremovable row versions in 0 out of 0 pages</div><div>DETAIL: &nbsp;0 dead row versions cannot be removed yet.</div><div>There were 0 unused item pointers.</div><div>0 pages are entirely empty.</div><div>CPU 0.00s/0.00u sec elapsed 0.00 sec.</div><div>VACUUM</div></div><div># 查看当前fsm，恢复正常</div><div><div>digoal=# select pg_freespace('digoal.tbl_user_log');</div><div>&nbsp;pg_freespace&nbsp;</div><div>--------------</div><div>&nbsp;(0,7680)</div><div>&nbsp;(1,7680)</div><div>&nbsp;(2,7680)</div><div>&nbsp;(3,7680)</div><div>&nbsp;(4,7680)</div></div><div>。。。。。。。。</div></div><div><div>&nbsp;(165,7680)</div><div>&nbsp;(166,5120)</div><div>&nbsp;(167,0)</div><div>&nbsp;(168,0)</div><div>&nbsp;(169,0)</div></div><div><br></div><div># 重新看fsm文件的MD5，未变化，还是不正常.</div><div><div>postgres@db5-&gt; md5sum 57372_fsm</div><div>cf642ab29c09733666eaea3e0acb4b97 &nbsp;57372_fsm</div></div><div><br></div><div># vacuum freeze verbose tbl_user_log之后,恢复正常.</div><div><div>postgres@db5-&gt; md5sum 57372_fsm</div><div>a8f5d5028a3329cc1395eeb0e3bf3f31 &nbsp;57372_fsm</div></div><div># 如果还是不行,可以选择vacuum full。</div></div>
	</div>
</div>
</body>
</html>