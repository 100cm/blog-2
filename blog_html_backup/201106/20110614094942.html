<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use pg_buffercache to see what's happening in the shared buffer cache in real time</h2>
	<h5 id="">2011-06-14 9:49:42&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020115149458640/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">pg_buffercache extension 创建的时候，同时创建一个C函数，一个视图.<div><div><br></div><div>-- Register the function.</div><div>CREATE FUNCTION pg_buffercache_pages()</div><div>RETURNS SETOF RECORD</div><div>AS 'MODULE_PATHNAME', 'pg_buffercache_pages'</div><div>LANGUAGE C;</div><div><br></div><div>-- Create a view for convenient access.</div><div>CREATE VIEW pg_buffercache AS</div><div>&nbsp; &nbsp; &nbsp; &nbsp; SELECT P.* FROM pg_buffercache_pages() AS P</div><div>&nbsp; &nbsp; &nbsp; &nbsp; (bufferid integer, relfilenode oid, reltablespace oid, reldatabase oid,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;relforknumber int2, relblocknumber int8, isdirty bool, usagecount int2);</div><div><br></div><div>-- Don't want these to be available to public.</div><div>REVOKE ALL ON FUNCTION pg_buffercache_pages() FROM PUBLIC;</div><div>REVOKE ALL ON pg_buffercache FROM PUBLIC;</div><div>由于buffercache包含了整个集群的BUFFER内容,为了安全考虑，创建时收回了PUBLIC的权限.</div><div><br></div><div>视图结构如下:</div><wbr><div><p style="font-size: 1em; line-height: 1.5em; margin-top: 1.2em; margin-right: 0em; margin-bottom: 1.2em; margin-left: 0em; font-family: verdana, sans-serif;"><b style="font-weight: bold;">&nbsp;<tt>pg_buffercache</tt>&nbsp;Columns</b></p><table border="1" style="margin-left: 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; border-collapse: collapse; margin-top: 2ex; margin-right: 0px; margin-bottom: 2ex; background-color: rgb(224, 236, 239); border-top-width: 2px; border-right-width: 2px; border-bottom-width: 2px; border-left-width: 2px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"><colgroup><col><col><col><col><thead><tr><th style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;">Name</th><th style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;">Type</th><th style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;">References</th><th style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;">Description</th></tr></thead><tbody><tr><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"><tt>bufferid</tt></td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"><tt>integer</tt></td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;">&nbsp;</td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;">ID, in the range 1..<tt>shared_buffers</tt></td></tr><tr><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"><tt>relfilenode</tt></td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"><tt>oid</tt></td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"><tt>pg_class.relfilenode</tt></td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;">Filenode number of the relation</td></tr><tr><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"><tt>reltablespace</tt></td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"><tt>oid</tt></td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"><tt>pg_tablespace.oid</tt></td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;">Tablespace OID of the relation</td></tr><tr><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"><tt>reldatabase</tt></td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"><tt>oid</tt></td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"><tt>pg_database.oid</tt></td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;">Database OID of the relation</td></tr><tr><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"><tt>relblocknumber</tt></td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"><tt>bigint</tt></td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;">&nbsp;</td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;">Page number within the relation</td></tr><tr><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"><tt>relforknumber</tt></td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"><tt>smallint</tt></td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;">&nbsp;</td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;">Fork number within the relation</td></tr><tr><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"><tt>isdirty</tt></td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"><tt>boolean</tt></td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;">&nbsp;</td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;">Is the page dirty?</td></tr><tr><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"><tt>usagecount</tt></td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"><tt>smallint</tt></td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;">&nbsp;</td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;">Page LRU count</td></tr></table></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; font-size: 12px; line-height: normal;"><br></span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; font-size: 12px; line-height: normal;">在pg_buffercache里面的计数单位为block.</span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; font-size: 12px; line-height: normal;">block的大小是创建数据库集群的时候决定的，如果忘记了可以使用pg_controldata来查看，如下</span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; font-size: 12px; line-height: 19px;">postgres@db5-&gt; pg_controldata</span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; font-size: 12px; line-height: 19px;">Database block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8192</span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; font-size: 12px; line-height: 19px;">以上block=8K Bytes</span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; font-size: 12px; line-height: 19px;"><br></span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; font-size: 12px; line-height: 19px;">注意，pg_buffercache获得的是一致性结果，因此需要对内存加锁，虽然很快，但是频繁的调用也会给数据库带来一定的负载，特别是并发调用。</span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; line-height: 18px;">加锁</span></font></div><div><font face="verdana, sans-serif"><div style="border-collapse: collapse; line-height: 18px;">for (i = 0; i &lt; NUM_BUFFER_PARTITIONS; i++)</div><div style="border-collapse: collapse; line-height: 18px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LWLockAcquire(FirstBufMappingLock + i, LW_SHARED);</div><div style="border-collapse: collapse; line-height: 18px;">释放锁是反向的,原因在代码里面有说明:</div><div><div><span style="border-collapse: collapse;"><br></span></div><div><span style="border-collapse: collapse;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</span></div><div><span style="border-collapse: collapse;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* And release locks. &nbsp;We do this in reverse order for two reasons:</span></div><div><span style="border-collapse: collapse;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* (1) Anyone else who needs more than one of the locks will be trying</span></div><div><span style="border-collapse: collapse;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* to lock them in increasing order; we don't want to release the</span></div><div><span style="border-collapse: collapse;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* other process until it can get all the locks it needs. (2) This</span></div><div><span style="border-collapse: collapse;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* avoids O(N^2) behavior inside LWLockRelease.</span></div><div><span style="border-collapse: collapse;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</span></div></div><div style="border-collapse: collapse; line-height: 18px;"><div>for (i = NUM_BUFFER_PARTITIONS; --i &gt;= 0;)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LWLockRelease(FirstBufMappingLock + i);</div></div></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; font-size: 12px; line-height: 19px;"><br></span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; font-size: 12px; line-height: 19px;">下面举例说明pg_buffercache 的使用情况.</span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; font-size: 12px; line-height: 19px;">示例1 :&nbsp;</span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; font-size: 12px; line-height: 19px;">1. 创建extension,在需要查看的数据库中创建extension.使用超级用户</span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; font-size: 12px; line-height: 19px;"><div>digoal=# \c digoal postgres</div><div>You are now connected to database "digoal" as user "postgres".</div><div>digoal=# create extension pg_buffercache;</div><div>CREATE EXTENSION</div><div><br></div><div>2. 查看shared_buffers由多少个block组成.</div><div><div>digoal=# select count(*) from pg_buffercache ;</div><div>&nbsp;count &nbsp;</div><div>--------</div><div>&nbsp;262144</div><div>(1 row)</div></div><div><div>digoal=# select 262144*8/1024||'MB';</div><div>&nbsp;?column?&nbsp;</div><div>----------</div><div>&nbsp;2048MB</div><div>(1 row)</div></div><div># 刚好等于shared_buffers设置的大小</div><div><div>digoal=# show shared_buffers;</div><div>&nbsp;shared_buffers&nbsp;</div><div>----------------</div><div>&nbsp;2GB</div><div>(1 row)</div></div><div><br></div><div>示例2 :&nbsp;</div><div># 查看shared_buffers已经使用了多少.</div><div># 因为未使用的buffers除了bufferid以为，其他的字段都为空，所以我们可以通过下面的SQL来查看未使用的BUFFERS。</div><div><div><div>digoal=# select count(*)*8/1024||'MB' from pg_buffercache where relfilenode is null and reltablespace is null and reldatabase is null and relforknumber is null and relblocknumber is null and isdirty is null and usagecount is null;</div><div>&nbsp;?column?&nbsp;</div><div>----------</div><div>&nbsp;2006MB</div><div>(1 row)</div></div></div><div><br></div><div>示例3 :&nbsp;</div><div># 查看当前数据库使用的buffers.</div><div><div>digoal=# select count(*)*8/1024||'MB' from pg_buffercache where reldatabase=(select oid from pg_database where datname=current_database());</div><div>&nbsp;?column?&nbsp;</div><div>----------</div><div>&nbsp;38MB</div><div>(1 row)</div></div><div><br></div></span></font><span style="border-collapse: collapse; font-family: verdana, sans-serif; line-height: 18px;"><div style="line-height: 22px;">示例4 :&nbsp;</div></span><font face="verdana, sans-serif"><span style="border-collapse: collapse; line-height: 19px;"># 查看当前数据库 以及 共享的系统表所使用掉的BUFFERS。（系统表属于database.oid=0的库）</span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; line-height: 19px;"><div>digoal=# select count(*)*8/1024||'MB' from pg_buffercache where reldatabase=(select oid from pg_database where datname=current_database()) or reldatabase=0;</div><div>&nbsp;?column?&nbsp;</div><div>----------</div><div>&nbsp;38MB</div><div>(1 row)</div><div><br></div><div>示例5 :&nbsp;</div><div># 查看当前数据库的脏页面</div></span></font><div><font face="verdana, sans-serif"><span style="border-collapse: collapse;">digoal=# select count(*) from pg_buffercache where isdirty is true and&nbsp;</span></font><span style="border-collapse: collapse; font-family: verdana, sans-serif;">reldatabase=(select oid from pg_database where datname=current_database())</span><span style="border-collapse: collapse; font-family: verdana, sans-serif;">&nbsp;;</span></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse;">&nbsp;count&nbsp;</span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse;">-------</span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse;">&nbsp; &nbsp; &nbsp;0</span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse;">(1 row)</span></font></div></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; font-size: 12px; line-height: 19px;"># 在一个事务中删除部分数据，同时查看脏页面</span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; font-size: 12px; line-height: 19px;"><div>digoal=# begin;</div><div>BEGIN</div><div>digoal=# delete from tbl_test ;</div><div>DELETE 1000100</div><div><div>digoal=# select count(*) from pg_buffercache where isdirty is true and reldatabase=(select oid from pg_database where datname=current_database()) ;</div><div>&nbsp;count&nbsp;</div><div>-------</div><div>&nbsp; 4426</div><div>(1 row)</div></div><div><br></div><div><div>digoal=# select pg_relation_size('tbl_test') /1024/8;</div><div>&nbsp;?column?&nbsp;</div><div>----------</div><div>&nbsp; &nbsp; &nbsp;4426</div><div>(1 row)</div></div></span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; font-size: 12px; line-height: 19px;"><br></span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; font-size: 12px; line-height: 19px;"># 脏页面数刚好等于这个表的SIZE。</span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; font-size: 12px; line-height: 19px;"><br></span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse;">示例6 :&nbsp;</span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse;"># 查看当前数据库以及0库的buffercache对象使用排名.</span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse;"><div>digoal=# SELECT c.relname, count(*) AS buffers</div><div>digoal-# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FROM pg_buffercache b INNER JOIN pg_class c</div><div>digoal-# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ON b.relfilenode = pg_relation_filenode(c.oid) AND</div><div>digoal-# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b.reldatabase IN (0, (SELECT oid FROM pg_database</div><div>digoal(# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHERE datname = current_database()))</div><div>digoal-# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;GROUP BY c.relname</div><div>digoal-# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ORDER BY 2 DESC</div><div>digoal-# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LIMIT 10;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | buffers&nbsp;</div><div>--------------------------------+---------</div><div>&nbsp;tbl_test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp;4426</div><div>&nbsp;pg_proc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;67</div><div>&nbsp;tbl_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;66</div><div>&nbsp;pg_attribute &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;52</div><div>&nbsp;idx_row_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;30</div><div>&nbsp;pg_statistic &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;27</div><div>&nbsp;pg_proc_proname_args_nsp_index | &nbsp; &nbsp; &nbsp;26</div><div>&nbsp;pg_depend_reference_index &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;15</div><div>&nbsp;pg_operator &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;14</div><div>&nbsp;pg_depend &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;12</div><div>(10 rows)</div><div><br></div></span></font></div><div><span style="border-collapse: collapse; font-family: verdana, sans-serif;"><br></span></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; font-size: 12px; line-height: 19px;"><br></span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; font-size: 12px; line-height: normal;"><br></span></font></div><div><font face="verdana, sans-serif"><span style="border-collapse: collapse; font-size: 12px; line-height: normal;"><br></span></font></div></div></div>
	</div>
</div>
</body>
</html>