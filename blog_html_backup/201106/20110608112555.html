<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use dblink extension's function building insert/delete/update SQL</h2>
	<h5 id="">2011-06-08 11:25:55&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201158102837903/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">dblink 模块有几个比较有意思的函数 :&nbsp;<wbr><div><div>dblink_get_pkey(text relname) returns setof dblink_pkey_results</div><div>用于获得表的主键信息</div><div><br></div><div>dblink_build_sql_insert(text relname,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int2vector primary_key_attnums,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; integer num_primary_key_atts,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; text[] src_pk_att_vals_array,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; text[] tgt_pk_att_vals_array) returns text</div><div>用于获取构建符合条件的insert语句</div><div><br></div><div>dblink_build_sql_delete(text relname,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int2vector primary_key_attnums,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; integer num_primary_key_atts,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; text[] tgt_pk_att_vals_array) returns text</div><div>用于获取构建符合条件的delete语句</div><div><br></div><div>dblink_build_sql_update(text relname,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int2vector primary_key_attnums,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; integer num_primary_key_atts,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; text[] src_pk_att_vals_array,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; text[] tgt_pk_att_vals_array) returns text</div></div><div>用于获取构建符合条件的update语句</div><div><br></div><div>用法举例 :&nbsp;</div><div><br></div><div><div><br></div><div>postgres@db5-&gt; psql -h 127.0.0.1 digoal digoal</div><div>psql (9.1beta1)</div><div>Type "help" for help.</div><div><br></div><div>digoal=&gt; \c digoal postgres</div><div>You are now connected to database "digoal" as user "postgres".</div><div>digoal=# create extension dblink;</div><div>CREATE EXTENSION</div><div>digoal=# \c digoal digoal</div><div>You are now connected to database "digoal" as user "digoal".</div></div><div><br></div><div><div>digoal=&gt; create table tbl_user_info (id int primary key,firstname text,lastname text,corp text);</div><div>NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "tbl_user_info_pkey" for table "tbl_user_info"</div><div>CREATE TABLE</div><div>digoal=&gt; insert into tbl_user_info select generate_series(1,10000),'zhou'||generate_series(1,10000),'digoal'||generate_series(1,10000),'sky-mobi';</div><div>digoal=&gt; select dblink_get_pkey('tbl_user_info');</div><div>&nbsp;dblink_get_pkey&nbsp;</div><div>-----------------</div><div>&nbsp;(1,id)</div><div>(1 row)</div></div><div><br></div><div><br></div><div>下面的例子说明了dblink_get_pkey返回的列顺序是什么顺序?</div><div><div>digoal=&gt; create table tbl_music (id int,zone text,gender text,singer text,song text,primary key(song,singer,zone,gender));</div><div>NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "tbl_music_pkey" for table "tbl_music"</div><div>CREATE TABLE</div></div><div><div>digoal=&gt; select attnum,attname from pg_attribute where attrelid=(select oid from pg_class where relname='tbl_music');</div><div>&nbsp;attnum | attname &nbsp;</div><div>--------+----------</div><div>&nbsp; &nbsp; &nbsp;-7 | tableoid</div><div>&nbsp; &nbsp; &nbsp;-6 | cmax</div><div>&nbsp; &nbsp; &nbsp;-5 | xmax</div><div>&nbsp; &nbsp; &nbsp;-4 | cmin</div><div>&nbsp; &nbsp; &nbsp;-3 | xmin</div><div>&nbsp; &nbsp; &nbsp;-1 | ctid</div><div>&nbsp; &nbsp; &nbsp; 1 | id</div><div>&nbsp; &nbsp; &nbsp; 2 | zone</div><div>&nbsp; &nbsp; &nbsp; 3 | gender</div><div>&nbsp; &nbsp; &nbsp; 4 | singer</div><div>&nbsp; &nbsp; &nbsp; 5 | song</div></div><div>digoal=&gt; select dblink_get_pkey('tbl_music');</div><div><div>&nbsp;dblink_get_pkey&nbsp;</div><div>-----------------</div><div>&nbsp;(1,song)</div><div>&nbsp;(2,singer)</div><div>&nbsp;(3,zone)</div><div>&nbsp;(4,gender)</div></div><div><br></div><div>因此dblink_get_pkey获得的顺序是定义PK时的顺序，而不是物理顺序。</div><div><br></div><div>dblink_build_sql_insert 举例 :&nbsp;</div><div># 需要注意的是,这里面用到的attnum来自于pg_attribute，而不是dblink_get_pkey函数的返回值.</div><div><div>digoal=&gt; SELECT dblink_build_sql_insert('tbl_user_info', '1', 1, '{1}', '{2}');</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dblink_build_sql_insert &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>------------------------------------------------------------------------------------------------</div><div>&nbsp;INSERT INTO tbl_user_info(id,firstname,lastname,corp) VALUES('2','zhou1','digoal1','sky-mobi')</div><div>(1 row)</div><div><br></div><div>digoal=&gt; select * from tbl_user_info where id=1;</div><div>&nbsp;id | firstname | lastname | &nbsp; corp &nbsp;&nbsp;</div><div>----+-----------+----------+----------</div><div>&nbsp; 1 | zhou1 &nbsp; &nbsp; | digoal1 &nbsp;| sky-mobi</div><div>(1 row)</div></div><div><br></div><div><div>digoal=&gt; insert into tbl_music select generate_series(1,10000),'China','man','Andy','TianYi'||generate_series(1,10000);</div><div>INSERT 0 10000</div></div><div><div>digoal=&gt; SELECT dblink_build_sql_insert('tbl_music', '5 4 2 3', 4, '{"TianYi1","Andy","China","man"}', '{"TianYi1","Andy","China","man"}');</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dblink_build_sql_insert &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>----------------------------------------------------------------------------------------------</div><div>&nbsp;INSERT INTO tbl_music(id,zone,gender,singer,song) VALUES('1','China','man','Andy','TianYi1')</div><div>(1 row)</div></div><div><br></div><div>#&nbsp;'{"TianYi1","Andy","China","man"}', '{"TianYi1","Andy","China","man"}' 这两个参数值，前面的是用于搜索到需要生成SQL的ROW，后面的参数</div><div>用于生成SQL后替换。如下(把Andy替换成Jack):</div><div><div>digoal=&gt; SELECT dblink_build_sql_insert('tbl_music', '5 4 2 3', 4, '{"TianYi1","Andy","China","man"}', '{"TianYi1","Jack","China","man"}');</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dblink_build_sql_insert &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>----------------------------------------------------------------------------------------------</div><div>&nbsp;INSERT INTO tbl_music(id,zone,gender,singer,song) VALUES('1','China','man','Jack','TianYi1')</div><div>(1 row)</div></div><div><br></div><div><br></div><div>dblink_build_sql_delete和dblink_build_sql_update用法与此类似，不举例了。</div><div>下面结合DBLINK举例怎么把一个表复制到另一个数据库。</div><div>将digoal库的tbl_music复制到postgres库.</div><div><br></div><div># 首先在目标库创建表结构</div><div><div>digoal=&gt; \c postgres postgres</div><div>You are now connected to database "postgres" as user "postgres".</div><div>postgres=# create table tbl_music (id int,zone text,gender text,singer text,song text,primary key(song,singer,zone,gender));</div><div>NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "tbl_music_pkey" for table "tbl_music"</div><div>CREATE TABLE</div></div><div><br></div><div># 在源库创建生成SQL的函数</div><div><div>CREATE OR REPLACE FUNCTION cp_tbl_music_sql()</div><div>&nbsp;RETURNS SETOF text</div><div>&nbsp;LANGUAGE plpgsql</div><div>AS $function$</div><div>declare&nbsp;</div><div>i_zone text;</div><div>i_gender text;</div><div>i_singer text;</div><div>i_song text;</div><div>begin</div><div>for i_zone,i_gender,i_singer,i_song in select zone,gender,singer,song from tbl_music loop</div><div>return query execute $$select dblink_build_sql_insert('tbl_music', '2 3 4 5', 4,'{"$$||i_zone||$$","$$||i_gender||$$","$$||i_singer||$$","$$||i_song||$$"}','{"$$||i_zone||$$","$$||i_gender||$$","$$||i_singer||$$","$$||i_song||$$"}')$$;</div><div>end loop;</div><div>return;</div><div>end;</div><div>$function$;</div></div><div><br></div><div># 在源库创建远程执行SQL的函数,需要调用dblink_exec</div><div><div>CREATE OR REPLACE FUNCTION cp_tbl_music()</div><div>&nbsp;RETURNS void</div><div>&nbsp;LANGUAGE plpgsql</div><div>AS $function$</div><div>declare</div><div>i_sql text;</div><div>begin</div><div>for i_sql in select cp_tbl_music_sql() loop</div><div>execute 'select dblink_exec(''myconn'', $$'||i_sql||'$$);';</div><div>end loop;</div><div>return;</div><div>end;</div><div>$function$;</div></div><div><br></div><div># 复制操作</div><div># 因为连接目标库使用了超级用户,所以用普通用户DIGOAL建立DBLNK的时候需要用到dblink_connect_u函数,这个需要得到赋权.</div><div>digoal=&gt; \c digoal postgres</div><div><div>digoal=# grant execute on function dblink_connect_u(text,text) to digoal;&nbsp;</div><div>GRANT</div><div>digoal=# \c digoal digoal</div><div>You are now connected to database "digoal" as user "digoal".</div></div><div><div>digoal=# \c digoal digoal</div><div>You are now connected to database "digoal" as user "digoal".</div><div># 创建dblink(当前SESSION有效).</div><div>digoal=&gt; SELECT dblink_connect_u('myconn', 'hostaddr=127.0.0.1 port=1921 dbname=postgres user=postgres password=postgres');</div><div>&nbsp;dblink_connect_u&nbsp;</div><div>------------------</div><div>&nbsp;OK</div><div>(1 row)</div></div><div># 执行复制函数</div><div><div>digoal=&gt; select cp_tbl_music();</div><div>&nbsp;cp_tbl_music&nbsp;</div><div>--------------</div><div>&nbsp;</div><div>(1 row)</div></div><div><br></div><div># 验证复制是否正常</div><div><div>digoal=&gt; \c postgres postgres</div><div>You are now connected to database "postgres" as user "postgres".</div><div>postgres=# select count(*) from tbl_music;</div><div>&nbsp;count&nbsp;</div><div>-------</div><div>&nbsp;10000</div><div>(1 row)</div><div><br></div><div>postgres=# select * from tbl_music limit 3;</div><div>&nbsp;id | zone &nbsp;| gender | singer | &nbsp;song &nbsp;&nbsp;</div><div>----+-------+--------+--------+---------</div><div>&nbsp; 1 | China | man &nbsp; &nbsp;| Andy &nbsp; | TianYi1</div><div>&nbsp; 2 | China | man &nbsp; &nbsp;| Andy &nbsp; | TianYi2</div><div>&nbsp; 3 | China | man &nbsp; &nbsp;| Andy &nbsp; | TianYi3</div><div>(3 rows)</div></div><div><br></div><div>当然这种复制操作不灵活,不太适合生产上面使用.</div></div>
	</div>
</div>
</body>
</html>