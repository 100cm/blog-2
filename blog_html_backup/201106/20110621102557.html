<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">mongoDB 4 nodes testing shard implement</h2>
	<h5 id="">2011-06-21 10:25:57&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402011521102557657/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>一、概述 :&nbsp;</div><div>Server1 : 10.10.10.40 ( configsrv and mongod )</div><div>Server2 : 10.10.10.41 ( configsrv and mongod )</div><div>Server3 : 10.10.10.42 ( configsrv and mongod )</div><div>Server4 : 10.10.10.43 ( mongos(test) and mongod )</div><div><br></div><div>replication group :&nbsp;</div><div>s6543_4041 :&nbsp;</div><div>10.10.10.40:6543</div><div>10.10.10.41:6543</div><div>s6543_4243 :&nbsp;</div><div>10.10.10.42:6543</div><div>10.10.10.43:6543</div><div>s6544_4041 :&nbsp;</div><div>10.10.10.40:6544</div><div>10.10.10.41:6544</div><div>s6544_4243 :&nbsp;</div><div>10.10.10.42:6544</div><div>10.10.10.43:6544</div><div><br></div><div>configsrv :&nbsp;</div><div>10.10.10.40:6545</div><div>10.10.10.41:6545</div><div>10.10.10.42:6545</div><div><br></div><div>mongos :&nbsp;</div><div>10.10.10.43:6546</div><div><br></div><div>服务器配置:</div><div>6块磁盘,3个raid1组.</div><div>disk1 : /opt/mongo6545</div><div>disk2 : /data1/mongo6543</div><div>disk3 : /data2/mongo6544</div><div><br></div><div>二、配置文件 :&nbsp;</div><div>repl6543配置 :&nbsp;</div><div>-- mongod6543.conf</div><div>vi /opt/mongo/conf/mongod6543.conf</div><div>logpath=/var/log/mongo/mongod6543.log</div><div>logappend=true</div><div>fork = true</div><div>port = 6543</div><div>dbpath=/data1/mongo6543</div><div>noauth = true</div><div>nohttpinterface = true</div><div>nssize = 1024</div><div>directoryperdb = true</div><div>maxConns = 15000</div><div>oplogSize = 20480</div><div>journal = true</div><div>profile = 1</div><div>slowms = 100</div><div>replSet = s6543_4041 / s6543_4243</div><div><br></div><div>repl6544配置 :&nbsp;</div><div>-- mongod6544.conf&nbsp;</div><div>vi /opt/mongo/conf/mongod6544.conf</div><div>logpath=/var/log/mongo/mongod6544.log</div><div>logappend=true</div><div>fork = true</div><div>port = 6544</div><div>dbpath=/data2/mongo6544</div><div>noauth = true</div><div>nohttpinterface = true</div><div>nssize = 1024</div><div>directoryperdb = true</div><div>maxConns = 15000</div><div>oplogSize = 20480</div><div>journal = true</div><div>profile = 1</div><div>slowms = 100</div><div>replSet = s6544_4041 / s6544_4243</div><div><br></div><div>configsrv配置 :&nbsp;</div><div>-- mongod6545.conf&nbsp;</div><div>vi /opt/mongo/conf/mongod6545.conf</div><div>logpath = /var/log/mongo/mongod6545.log</div><div>logappend = true</div><div>fork = true</div><div>port = 6545</div><div>dbpath = /opt/mongo6545</div><div>noauth = true</div><div>nohttpinterface = true</div><div>nssize = 1024</div><div>directoryperdb = true</div><div>maxConns = 15000</div><div>journal = true</div><div>profile = 1</div><div>slowms = 100</div><div>configsvr = true</div><div><br></div><div>mongos配置 :&nbsp;</div><div>-- mongos6546.conf&nbsp;</div><div>vi /opt/mongo/conf/mongod6546.conf</div><div>logpath = /var/log/mongo/mongos6546.log</div><div>logappend = true</div><div>fork = true</div><div>bind_ip = 127.0.0.1</div><div>port = 6546</div><div>maxConns = 300</div><div>chunkSize = 200</div><div>configdb = 10.10.10.40:6545,10.10.10.41:6545,10.10.10.42:6545</div><div><br></div><div>chown -R mongo:mongo /opt/mongo</div><div>chmod 400 /opt/mongo/conf/*.conf</div><div><br></div><div>三、mongod服务器防火墙配置: (由于关闭了auth)</div><div># 如果mongodb扩容,后续增加的数据库IP应该被增加到允许列表.</div><div>-A RH-Firewall-1-INPUT -s 127.0.0.1/32 -j ACCEPT</div><div>-A RH-Firewall-1-INPUT -s 10.10.10.40/32 -j ACCEPT</div><div>-A RH-Firewall-1-INPUT -s 10.10.10.41/32 -j ACCEPT</div><div>-A RH-Firewall-1-INPUT -s 10.10.10.42/32 -j ACCEPT</div><div>-A RH-Firewall-1-INPUT -s 10.10.10.43/32 -j ACCEPT</div><div># 允许应用的mongos访问,如果增加了mongos服务器,也应该加入到以下允许范围.</div><div># -A RH-Firewall-1-INPUT -s xxx.xxx.xxx.xxx/32 -j ACCEPT</div><div># 如果mongod服务器上需增加mongod进程,后续增加的监听端口应该拒绝除应用以及数据库本身以外的IP访问.</div><div>-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 6543 -j REJECT</div><div>-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 6544 -j REJECT</div><div>-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 6545 -j REJECT</div><div># 其他配置接续</div><div><br></div><div><br></div><div>启动顺序 :&nbsp;</div><div>1. 启动 shard with replSet</div><div>mongod -f $MONGO_HOME/conf/mongod6543.conf</div><div>mongod -f $MONGO_HOME/conf/mongod6544.conf</div><div><br></div><div>2. 配置replSet :&nbsp;</div><div>connect to 10.10.10.40:6543/admin</div><div>&gt; config = {_id: 's6543_4041', members: [</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {_id: 0, host: '10.10.10.40:6543', arbiterOnly: false},</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {_id: 1, host: '10.10.10.41:6543', arbiterOnly: false}]</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</div><div><br></div><div>&gt; rs.initiate(config);</div><div>{</div><div>&nbsp; &nbsp;"info" : "Config now saved locally. &nbsp;Should come online in about a minute.",</div><div>&nbsp; &nbsp;"ok" : 1</div><div>}</div><div><br></div><div>connect to 10.10.10.41:6544/admin</div><div>&gt; config = {_id: 's6544_4041', members: [</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {_id: 0, host: '10.10.10.41:6544', arbiterOnly: false},</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {_id: 1, host: '10.10.10.40:6544', arbiterOnly: false}]</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</div><div><br></div><div>&gt; rs.initiate(config);</div><div>{</div><div>&nbsp; &nbsp;"info" : "Config now saved locally. &nbsp;Should come online in about a minute.",</div><div>&nbsp; &nbsp;"ok" : 1</div><div>}</div><div><br></div><div>connect to 10.10.10.42:6543/admin</div><div>&gt; config = {_id: 's6543_4243', members: [</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {_id: 0, host: '10.10.10.42:6543', arbiterOnly: false},</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {_id: 1, host: '10.10.10.43:6543', arbiterOnly: false}]</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</div><div><br></div><div>&gt; rs.initiate(config);</div><div>{</div><div>&nbsp; &nbsp;"info" : "Config now saved locally. &nbsp;Should come online in about a minute.",</div><div>&nbsp; &nbsp;"ok" : 1</div><div>}</div><div><br></div><div>connect to 10.10.10.43:6544/admin</div><div>&gt; config = {_id: 's6544_4243', members: [</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {_id: 0, host: '10.10.10.43:6544', arbiterOnly: false},</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {_id: 1, host: '10.10.10.42:6544', arbiterOnly: false}]</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</div><div><br></div><div>&gt; rs.initiate(config);</div><div>{</div><div>&nbsp; &nbsp;"info" : "Config now saved locally. &nbsp;Should come online in about a minute.",</div><div>&nbsp; &nbsp;"ok" : 1</div><div>}</div><div><br></div><div>&gt; rs.status()&nbsp;</div><div>查看状态</div><div><br></div><div>3. 启动 configsrv</div><div>10.10.10.40</div><div>10.10.10.41</div><div>10.10.10.42</div><div>mongod -f $MONGO_HOME/conf/mongod6545.conf</div><div><br></div><div>4. 启动 mongos</div><div>10.10.10.43</div><div>mongos -f $MONGO_HOME/conf/mongod6546.conf</div><div><br></div><div>5. 配置shard (限制每个shard的使用最多80GB)</div><div>connect to 10.10.10.43:6546/admin</div><div>&gt; db.runCommand({"addShard" : "s6543_4041/10.10.10.40:6543,10.10.10.41:6543", "maxSize" : 81920});</div><div>&gt; db.runCommand({"addShard" : "s6544_4041/10.10.10.40:6544,10.10.10.41:6544", "maxSize" : 81920});</div><div>&gt; db.runCommand({"addShard" : "s6543_4243/10.10.10.42:6543,10.10.10.43:6543", "maxSize" : 81920});</div><div>&gt; db.runCommand({"addShard" : "s6544_4243/10.10.10.42:6544,10.10.10.43:6544", "maxSize" : 81920});</div><div><br></div><div>四、启动概要 :&nbsp;</div><div><br></div><div>10.10.10.40</div><div>mongod -f $MONGO_HOME/conf/mongod6543.conf</div><div>10.10.10.41</div><div>mongod -f $MONGO_HOME/conf/mongod6543.conf</div><div><br></div><div>10.10.10.41</div><div>mongod -f $MONGO_HOME/conf/mongod6544.conf</div><div>10.10.10.40</div><div>mongod -f $MONGO_HOME/conf/mongod6544.conf</div><div><br></div><div>10.10.10.42</div><div>mongod -f $MONGO_HOME/conf/mongod6543.conf</div><div>10.10.10.43</div><div>mongod -f $MONGO_HOME/conf/mongod6543.conf</div><div><br></div><div>10.10.10.43</div><div>mongod -f $MONGO_HOME/conf/mongod6544.conf</div><div>10.10.10.42</div><div>mongod -f $MONGO_HOME/conf/mongod6544.conf</div><div><br></div><div>10.10.10.40</div><div>10.10.10.41</div><div>10.10.10.42</div><div>mongod -f $MONGO_HOME/conf/mongod6545.conf</div><div><br></div><div>10.10.10.43</div><div>mongos -f $MONGO_HOME/conf/mongos6546.conf</div><div><br></div><div><br></div><div>五、详细配置过程</div><div>MongoDB replicSet 1.8.2 产品部署推荐:</div><div>1. 文件系统加载时使用参数noatime</div><div>2. no VM PAGEs</div><div>3. 推荐使用逻辑卷,文件系统推荐ext4或xfs</div><div>4. replicaSet建议:3个full nodes 或 2个full nodes+1个arbiter node (最好是奇数个物理服务器,否则仲裁会有问题，例如两台物理机，两个mongod进程，相互网络不通的话，任何一台都无法达到majority，因此都无法成为primary。那就是只读了.因如果物理服务器只有2台是不合理的。)</div><div>&nbsp; &nbsp;当然服务器可以后期增加.</div><div>5. 如果使用auth,keyFile建议权限400 (遗憾的是SHARD不支持auth,而且auth也存在一些BUG,因此在这个版本还不推荐使用)</div><div>6. 推荐关闭http访问</div><div>7. 建议开启journal , 注意，开启journal后一个逻辑写将产生最多4个物理写(最恶劣的情况是这样的)</div><div>&nbsp; &nbsp;(1main,1journal,1local,1journal)</div><div>&nbsp; &nbsp;但是由于IO是异步的，所以一般不会有4个物理写这么严重。</div><div><br></div><div>详细配置:</div><div>1. 操作系统版本 Red Hat Enterprise Linux Server release 5.6 (Tikanga) 64位</div><div><br></div><div>2. root用户 crontab配置</div><div>8 * * * * /usr/sbin/ntpdate asia.pool.ntp.org &amp;&amp; /sbin/hwclock --systohc</div><div><br></div><div>3. ntpd配置</div><div>vi /etc/sysconfig/ntpd</div><div>SYNC_HWCLOCK=yes</div><div><br></div><div>4. sysctl.conf配置</div><div><br></div><div>5. vi /etc/security/limits.conf</div><div><br></div><div>6. 主机名配置</div><div>hostname db-10-10-10-40.digoal.com.cn</div><div>vi /etc/sysconfig/network</div><div>HOSTNAME=db-10-10-10-40.digoal.com.cn</div><div><br></div><div>7. vi /etc/resolv.conf</div><div>search digoal.com.cn</div><div>nameserver 10.10.10.1</div><div><br></div><div>8. 主机名配置</div><div>vi /etc/hosts</div><div>127.0.0.1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; localhost.localdomain localhost</div><div>192.168.164.40 db-10-10-10-40.digoal.com.cn db-10-10-10-40</div><div>192.168.164.41 db-10-10-10-41.digoal.com.cn db-10-10-10-41</div><div>192.168.164.42 db-10-10-10-42.digoal.com.cn db-10-10-10-42</div><div>192.168.164.43 db-10-10-10-43.digoal.com.cn db-10-10-10-43</div><div><br></div><div>9. 配置iptables</div><div><br></div><div>10. 密码配置</div><div>useradd mongo</div><div>passwd root</div><div>passwd mongo</div><div><br></div><div>11. mongo用户profile</div><div>vi .bash_profile</div><div>export PS1="$USER@`/bin/hostname -s`-&gt; "&nbsp;</div><div>export MONGO_HOME=/opt/mongo</div><div>export PATH=$MONGO_HOME/bin:$PATH:.</div><div>umask 022</div><div>alias rm='rm -i'</div><div>alias ll='ls -lh'</div><div><br></div><div>12. 下载解压最新的稳定版</div><div>wget mongodb-linux-x86_64-1.8.2.tar</div><div><br></div><div>tar -zxvf mongodb-linux-x86_64-1.8.2.tgz</div><div>mv mongodb-linux-x86_64-1.8.2 /opt/mongo</div><div><br></div><div>chown -R mongo:mongo /opt/mongo</div><div><br></div><div>13. 建立日志目录</div><div>mkdir /var/log/mongo</div><div>chown -R mongo:mongo /var/log/mongo</div><div><br></div><div>14. 建立配置文件目录和数据文件目录</div><div>mkdir -p /opt/mongo/conf</div><div>chown -R mongo:mongo /opt/mongo</div><div><br></div><div>建立存储:</div><div>pvcreate /dev/sdb</div><div>pvcreate /dev/sdc</div><div>vgcreate vg0 /dev/sdb</div><div>vgcreate vg1 /dev/sdc</div><div>lvcreate -l 100%VG -n lv0 -v vg0</div><div>lvcreate -l 100%VG -n lv1 -v vg1</div><div><br></div><div>[root@192_168_168_40 ~]# lvs</div><div>&nbsp; LV &nbsp; VG &nbsp; Attr &nbsp; LSize &nbsp; Origin Snap% &nbsp;Move Log Copy% &nbsp;Convert</div><div>&nbsp; lv0 &nbsp;vg0 &nbsp;-wi-a- 136.12G &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>&nbsp; lv1 &nbsp;vg1 &nbsp;-wi-a- 136.12G</div><div><br></div><div>创建文件系统:</div><div>mkfs.ext4 /dev/mapper/vg0-lv0</div><div>mkfs.ext4 /dev/mapper/vg1-lv1</div><div><br></div><div>mkdir -p /data1</div><div>mkdir -p /data2</div><div><br></div><div>vi /etc/fstab</div><div>/dev/mapper/vg0-lv0 &nbsp; &nbsp; /data1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ext4 &nbsp; &nbsp;defaults,noatime 0 0</div><div>/dev/mapper/vg1-lv1 &nbsp; &nbsp; /data2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ext4 &nbsp; &nbsp;defaults,noatime 0 0</div><div><br></div><div>mount -a</div><div><br></div><div>mkdir -p /data1/mongo6543</div><div>mkdir -p /data2/mongo6544</div><div><br></div><div>chown -R mongo:mongo /data1</div><div>chown -R mongo:mongo /data2</div><div><br></div><div>配置configsrv目录</div><div>mkdir -p /opt/mongo6545</div><div>chown -R mongo:mongo /opt/mongo6545</div><div><br></div><div>15. 配置启动文件:</div><div><br></div><div>16. 启动所有节点并初始化replicaSet</div><div><br></div><div># 初始化(只需要连到一个节点操作)</div><div><br></div><div># 等待local初始完成(确保所有节点都正常),添加用户</div><div><br></div><div># 状态正常,新建用户</div><div>mongo 127.0.0.1:6543/admin</div><div>db.addUser("xxx","xxxxx");</div><div><br></div><div># 新增业库blss务用户</div><div>use digoal</div><div>db.addUser("digoal","Fdigoal-")</div><div><br></div><div>17. 查看日志</div><div><br></div><div>18. 其他管理命令</div><div>rs.?</div><div><br></div><div>19. 切换,自动</div><div><br></div><div>20. 配置监控(nagios)</div><div><br></div><div>21. 控制是否要把READ请求发给slave</div><div>Then, you can use the driver normally. By default, it will send all the requests, reads and writes, to the master. Bit you can configure the driver to send only writes to the master, the reads will be dispatched on the slaves. And it's only one line of code to do this:</div><div>mongo.slaveOk();</div><div><br></div><div>22. shard</div><div>If we are sharding a collection with data in it, the data must have an index on the shard</div><div>key. All documents must have a value for the shard key, too (and the value cannot be</div><div>null). After you’ve sharded the collection, you can insert documents with a null shard</div><div>key value.</div><wbr></div>
	</div>
</div>
</body>
</html>