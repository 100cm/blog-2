<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Use pgbench test Your PostgreSQL DBSystem performace</h2>
	<h5 id="">2011-06-15 16:10:19&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201151534631313/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">pgbench，可用于模拟真实应用调用数据库SQL的场景。也可用于进行简单的压力测试。<div>参数如下</div><div><div><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >postgres@db5-&gt; pgbench --help</font></div><div style="line-height: 22px;"  ><font size="2"  >pgbench is a benchmarking tool for PostgreSQL.</font></div><div style="line-height: 22px;"  ><font size="2"  ><br style="line-height: 22px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  >Usage:</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; pgbench [OPTIONS]... [DBNAME]</font></div><div style="line-height: 22px;"  ><font size="2"  ><br style="line-height: 22px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  >Initialization options:</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -i &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invokes initialization mode</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -F NUM &nbsp; &nbsp; &nbsp; fill factor</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -s NUM &nbsp; &nbsp; &nbsp; scaling factor</font></div><div style="line-height: 22px;"  ><font size="2"  ><br style="line-height: 22px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  >Benchmarking options:</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -c NUM &nbsp; &nbsp; &nbsp; number of concurrent database clients (default: 1)</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -C &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; establish new connection for each transaction</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -D VARNAME=VALUE</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;define variable for use by custom script</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -f FILENAME &nbsp;read transaction script from FILENAME</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -j NUM &nbsp; &nbsp; &nbsp; number of threads (default: 1)</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -l &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; write transaction times to log file</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -M {simple|extended|prepared}</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;protocol for submitting queries to server (default: simple)</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -n &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; do not run VACUUM before tests</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -N &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; do not update tables "pgbench_tellers" and "pgbench_branches"</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -r &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; report average latency per command</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -s NUM &nbsp; &nbsp; &nbsp; report this scale factor in output</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -S &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; perform SELECT-only transactions</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -t NUM &nbsp; &nbsp; &nbsp; number of transactions each client runs (default: 10)</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -T NUM &nbsp; &nbsp; &nbsp; duration of benchmark test in seconds</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -v &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vacuum all four standard tables before tests</font></div><div style="line-height: 22px;"  ><font size="2"  ><br style="line-height: 22px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  >Common options:</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; print debugging output</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -h HOSTNAME &nbsp;database server host or socket directory</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -p PORT &nbsp; &nbsp; &nbsp;database server port number</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; -U USERNAME &nbsp;connect as specified database user</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; --help &nbsp; &nbsp; &nbsp; show this help, then exit</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; --version &nbsp; &nbsp;output version information, then exit</font></div><p></p></pre></div><div style="line-height: 22px;"  ><br></div><wbr><div>下面以PostgreSQL 9.0.4带的pgbench版本进行测试。9.1多了一个打印每句SQL的执行时间的功能。</div><div>为了模拟比较真实,开启了服务器autovacuum，测试时不使用pgbench的vacuum(使用-n参数)来预先进行垃圾回收。</div><div>在进行R:W=1:4的测试时，瓶颈最有可能出现在存储上。</div><div><div><br></div></div><div>测试环境：</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >PostgreSQL Database Server :&nbsp;</font></div><div><font size="2"  >CPU : 8核 2GHZ</font></div><div><font size="2"  >MEM : 24GB</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Storage :&nbsp;</font></div><div><font size="2"  >HP EVA6400 : 71 * 300GB FC 15K</font></div><div><font size="2"  >RAID 1/0</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >pgbench Server 1 :&nbsp;</font></div><div><font size="2"  >CPU : 8核 2GHZ</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >pgbench Server 2 :&nbsp;</font></div></div><div><font size="2"  >CPU : 8核 2GHZ</font></div><p></p></pre></div></div><div><br></div><div># 数据库参数配置,</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >listen_addresses = '*' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"  >port = 1921 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"  >max_connections = 2000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"  >superuser_reserved_connections = 13 &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"  >unix_socket_directory = '/database/pgdata/1921/pg_root' &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"  >unix_socket_permissions = 0700 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# begin with 0 to use octal notation</font></div><div><font size="2"  >password_encryption = on</font></div><div><font size="2"  >tcp_keepalives_idle = 60 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPIDLE, in seconds;</font></div><div><font size="2"  >tcp_keepalives_interval = 30 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPINTVL, in seconds;</font></div><div><font size="2"  >tcp_keepalives_count = 9 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPCNT;</font></div><div><font size="2"  >shared_buffers = 2048MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div><font size="2"  >maintenance_work_mem = 2048MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 1MB</font></div><div><font size="2"  >max_stack_depth = 8MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 100kB</font></div><div><font size="2"  >max_files_per_process = 10000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 25</font></div><div><font size="2"  >vacuum_cost_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 0-100 milliseconds</font></div><div><font size="2"  >wal_level = hot_standby &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, or hot_standby</font></div><div><font size="2"  >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# immediate fsync at commit</font></div><div><font size="2"  >wal_buffers = 65536kB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 32kB</font></div><div><font size="2"  >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"  >checkpoint_segments = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# in logfile segments, min 1, 16MB each</font></div><div><font size="2"  >checkpoint_timeout = 10min &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# range 30s-1h</font></div><div><font size="2"  >archive_mode = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # allows archiving to be done</font></div><div><font size="2"  >archive_command = '/bin/date' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # command to use to archive a logfile segment</font></div><div><font size="2"  >max_wal_senders = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of walsender processes</font></div><div><font size="2"  >wal_keep_segments = 100 &nbsp; &nbsp; &nbsp; &nbsp; # in logfile segments, 16MB each; 0 disables</font></div><div><font size="2"  >random_page_cost = 2.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# same scale as above</font></div><div><font size="2"  >effective_cache_size = 20480MB</font></div><div><font size="2"  >constraint_exclusion = partition &nbsp; &nbsp; &nbsp; &nbsp;# on, off, or partition</font></div><div><font size="2"  >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"  >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"  >log_directory = '/var/applog/pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div><font size="2"  >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,</font></div><div><font size="2"  >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file of the</font></div><div><font size="2"  >log_rotation_age = 1d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Automatic rotation of logfiles will</font></div><div><font size="2"  >log_rotation_size = 10MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Automatic rotation of logfiles will&nbsp;</font></div><div><font size="2"  >log_min_duration_statement = 1000ms &nbsp; &nbsp; # -1 is disabled, 0 logs all statements</font></div><div><font size="2"  >log_checkpoints = on</font></div><div><font size="2"  >log_lock_waits = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # log lock waits &gt;= deadlock_timeout</font></div><div><font size="2"  >log_statement = 'ddl' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # none, ddl, mod, all</font></div><div><font size="2"  >track_activity_query_size = 2048 &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"  >autovacuum = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Enable autovacuum subprocess? &nbsp;'on'&nbsp;</font></div><div><font size="2"  >log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</font></div><div><font size="2"  >datestyle = 'iso, mdy'</font></div><div><font size="2"  >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div><font size="2"  >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div><font size="2"  >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div><font size="2"  >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div><font size="2"  >default_text_search_config = 'pg_catalog.english'</font></div><div><font size="2"  >deadlock_timeout = 1s</font></div><div><font size="2"  ># 开启SQL跟踪</font></div><div><font size="2"  >shared_preload_libraries = 'pg_stat_statements'</font></div><div><font size="2"  >custom_variable_classes = 'pg_stat_statements' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# list of custom variable class names</font></div><div><font size="2"  >pg_stat_statements.max = 10000</font></div><div><font size="2"  >pg_stat_statements.track = all</font></div><p></p></pre></div><div><br></div><div># 本次测试模型使用pgbench自带的,如果是用的自己的模板,需要自己造测试数据.</div><div># 初始化数据</div><div><pre class="prettyprint"  ><p><font size="2"  >pgbench -i -F 100 -s 500 -h 127.0.0.1 -U digoal digoal</font></p></pre></div><div>创建4个表，大小分别如下</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pgbench_accounts</font></div><div><font size="2"  >50000000</font></div><div><font size="2"  >pgbench_branches</font></div><div><font size="2"  >500</font></div><div><font size="2"  >pgbench_tellers</font></div><div><font size="2"  >5000</font></div><div><font size="2"  >pgbench_history</font></div><p></p></pre></div><div>表结构如下</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; \d pgbench_accounts</font></div><div><font size="2"  >&nbsp; &nbsp;Table "digoal.pgbench_accounts"</font></div><div><font size="2"  >&nbsp; Column &nbsp;| &nbsp; &nbsp; Type &nbsp; &nbsp; &nbsp;| Modifiers&nbsp;</font></div><div><font size="2"  >----------+---------------+-----------</font></div><div><font size="2"  >&nbsp;aid &nbsp; &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"  >&nbsp;bid &nbsp; &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;abalance | integer &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;filler &nbsp; | character(84) |&nbsp;</font></div><div><font size="2"  >Indexes:</font></div><div><font size="2"  >&nbsp; &nbsp; "pgbench_accounts_pkey" PRIMARY KEY, btree (aid)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; \d pgbench_branches</font></div><div><font size="2"  >&nbsp; &nbsp;Table "digoal.pgbench_branches"</font></div><div><font size="2"  >&nbsp; Column &nbsp;| &nbsp; &nbsp; Type &nbsp; &nbsp; &nbsp;| Modifiers&nbsp;</font></div><div><font size="2"  >----------+---------------+-----------</font></div><div><font size="2"  >&nbsp;bid &nbsp; &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"  >&nbsp;bbalance | integer &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;filler &nbsp; | character(88) |&nbsp;</font></div><div><font size="2"  >Indexes:</font></div><div><font size="2"  >&nbsp; &nbsp; "pgbench_branches_pkey" PRIMARY KEY, btree (bid)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; \d pgbench_tellers</font></div><div><font size="2"  >&nbsp; &nbsp; Table "digoal.pgbench_tellers"</font></div><div><font size="2"  >&nbsp; Column &nbsp;| &nbsp; &nbsp; Type &nbsp; &nbsp; &nbsp;| Modifiers&nbsp;</font></div><div><font size="2"  >----------+---------------+-----------</font></div><div><font size="2"  >&nbsp;tid &nbsp; &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"  >&nbsp;bid &nbsp; &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;tbalance | integer &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;filler &nbsp; | character(84) |&nbsp;</font></div><div><font size="2"  >Indexes:</font></div><div><font size="2"  >&nbsp; &nbsp; "pgbench_tellers_pkey" PRIMARY KEY, btree (tid)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; \d pgbench_history</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "digoal.pgbench_history"</font></div><div><font size="2"  >&nbsp;Column | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"  >--------+-----------------------------+-----------</font></div><div><font size="2"  >&nbsp;tid &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;bid &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;aid &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;delta &nbsp;| integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;mtime &nbsp;| timestamp without time zone |&nbsp;</font></div><div><font size="2"  >&nbsp;filler | character(22) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><p></p></pre></div><div># 数据库大小</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select pg_database_size('digoal')/1024/1024/1024||' GB';</font></div><div><font size="2"  >&nbsp;?column?&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;7 GB</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>测试前使用pgfincore将除历史表以外的表放入内存。</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select * from pgmincore('pgbench_accounts');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relpath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | block_size | block_disk | block_mem | group_mem&nbsp;</font></div><div><font size="2"  >------------------------------------------------+------------+------------+-----------+-----------</font></div><div><font size="2"  >&nbsp;pg_tblspc/16386/PG_9.0_201008051/16387/16401 &nbsp; | &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp;1048576 | &nbsp; &nbsp;949382 | &nbsp; &nbsp; 44941</font></div><div><font size="2"  >&nbsp;pg_tblspc/16386/PG_9.0_201008051/16387/16401.1 | &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; 618108 | &nbsp; &nbsp;581867 | &nbsp; &nbsp; 16723</font></div><div><font size="2"  >(2 rows)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; select * from pgmincore('pgbench_branches');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;relpath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| block_size | block_disk | block_mem | group_mem&nbsp;</font></div><div><font size="2"  >----------------------------------------------+------------+------------+-----------+-----------</font></div><div><font size="2"  >&nbsp;pg_tblspc/16386/PG_9.0_201008051/16387/16389 | &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; &nbsp;718 | &nbsp; &nbsp; &nbsp; 718 | &nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; select * from pgmincore('pgbench_tellers');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;relpath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| block_size | block_disk | block_mem | group_mem&nbsp;</font></div><div><font size="2"  >----------------------------------------------+------------+------------+-----------+-----------</font></div><div><font size="2"  >&nbsp;pg_tblspc/16386/PG_9.0_201008051/16387/16392 | &nbsp; &nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; &nbsp;938 | &nbsp; &nbsp; &nbsp; 938 | &nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>测试时使用pgbench调用外部脚本的选项。</div><div>注意 :&nbsp;</div><div>这里初始化的时候scale使用了500，也就是创建了5000W条account记录.</div><div>压力测试时,为了避免update 冲突, -c 参数应该小于500。（越小，冲突可能性越小）</div><div>-j &nbsp;参数必须是可被 -c 参数整除 . (例如 -c 15 -j 10 不允许,因为15/10不能整除. -c 15 -j 3是允许的)</div><div><br></div><div>分别测试了3个脚本：(只读，读写，读写(函数))</div><div>只读测试结果 : &nbsp; &nbsp;tps : 57296 &nbsp; LOAD :&nbsp;9.06</div><div>读写测试结果 : &nbsp; &nbsp;tps : 7841 &nbsp; &nbsp; LOAD :&nbsp;6.43</div><div>读写(函数)测试结果 : &nbsp; &nbsp;tps : 8968 &nbsp; LOAD : &nbsp;4.37</div><div><br></div><div>下面是具体的测试数据 ：</div><div><br></div><div>1. 只读测试</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ># 首先清空SQL统计信息,方便后面统计</font></div><div><div><font size="2"  >digoal=# select pg_stat_statements_reset();</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># 脚本内容</font></div><div><font size="2"  >\set naccounts 100000 * :scale</font></div><div><font size="2"  >\setrandom aid 1 :naccounts</font></div><div><font size="2"  >SELECT abalance FROM pgbench_accounts WHERE aid = :aid;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># 测试时间段内的数据库负载</font></div><div><font size="2"  >top - 14:47:08 up 7 days, 23:59, &nbsp;2 users, &nbsp;load average: 9.06, 8.74, 6.61</font></div><div><font size="2"  >Tasks: 229 total, &nbsp;19 running, 210 sleeping, &nbsp; 0 stopped, &nbsp; 0 zombie</font></div><div><font size="2"  >Cpu(s): 54.5%us, 12.0%sy, &nbsp;0.0%ni, 22.9%id, &nbsp;0.0%wa, &nbsp;0.4%hi, 10.2%si, &nbsp;0.0%st</font></div><div><font size="2"  >Mem: &nbsp;24682088k total, 23569324k used, &nbsp;1112764k free, &nbsp; &nbsp;20116k buffers</font></div><div><font size="2"  >Swap: 16779884k total, &nbsp; &nbsp; &nbsp;296k used, 16779588k free, 21832984k cached</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># pgbench Server 1 的测试结果</font></div><div><font size="2"  >postgres@db-192-168-xx-&gt; pgbench -c 25 -j 25 -M prepared -n -s 500 -T 60 -f ./pgbench.sql -h 192.168.173.66 -p 1921 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 500</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 25</font></div><div><font size="2"  >number of threads: 25</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 1722341</font></div><div><font size="2"  >tps = 28642.093113 (including connections establishing)</font></div><div><font size="2"  >tps = 28654.758879 (excluding connections establishing)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># pgbench Server 2 的测试结果</font></div><div><font size="2"  >postgres@db-bak-192-168-xx-&gt; pgbench -c 25 -j 25 -M prepared -n -s 500 -T 60 -f ./pgbench.sql -h 192.168.173.66 -p 1921 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 500</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 25</font></div><div><font size="2"  >number of threads: 25</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 1724716</font></div><div><font size="2"  >tps = 28654.279301 (including connections establishing)</font></div><div><font size="2"  >tps = 28662.002556 (excluding connections establishing)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># 查看数据库中SQL的统计结果,与上面的测试结果一致。</font></div><div><font size="2"  >digoal=# SELECT query, calls, total_time, rows, 100.0 * shared_blks_hit /</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nullif(shared_blks_hit + shared_blks_read, 0) AS hit_percent</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FROM pg_stat_statements ORDER BY total_time DESC LIMIT 5;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;calls &nbsp;| &nbsp; &nbsp;total_time &nbsp; &nbsp;| &nbsp;rows &nbsp; | &nbsp; &nbsp; hit_percen</font></div><div><font size="2"  >t &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >-----------------------------------------------------------------------------+---------+------------------+---------+---------------</font></div><div><font size="2"  >------</font></div><div><font size="2"  >&nbsp;SELECT abalance FROM pgbench_accounts WHERE aid = $1; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 3447057 | 1896.21127399291 | 3447057 | 95.40027515756</font></div><div><font size="2"  >15473</font></div></div><p></p></pre></div><div><br></div><div><div>2. 读写测试</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ># 首先清空SQL统计信息,方便后面统计</font></div><div><font size="2"  >digoal=# select pg_stat_statements_reset();</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># 脚本内容</font></div><div><font size="2"  >\set nbranches :scale</font></div><div><font size="2"  >\set ntellers 10 * :scale</font></div><div><font size="2"  >\set naccounts 100000 * :scale</font></div><div><font size="2"  >\setrandom aid 1 :naccounts</font></div><div><font size="2"  >\setrandom bid 1 :nbranches</font></div><div><font size="2"  >\setrandom tid 1 :ntellers</font></div><div><font size="2"  >\setrandom delta -5000 5000</font></div><div><font size="2"  >BEGIN;</font></div><div><font size="2"  >UPDATE pgbench_accounts SET abalance = abalance + :delta WHERE aid = :aid;</font></div><div><font size="2"  >SELECT abalance FROM pgbench_accounts WHERE aid = :aid;</font></div><div><font size="2"  >UPDATE pgbench_tellers SET tbalance = tbalance + :delta WHERE tid = :tid;</font></div><div><font size="2"  >UPDATE pgbench_branches SET bbalance = bbalance + :delta WHERE bid = :bid;</font></div><div><font size="2"  >INSERT INTO pgbench_history (tid, bid, aid, delta, mtime) VALUES (:tid, :bid, :aid, :delta, CLOCK_TIMESTAMP());</font></div><div><font size="2"  >END;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># 测试时间段内的数据库负载</font></div><div><font size="2"  >top - 14:50:55 up 8 days, 2 min, &nbsp;2 users, &nbsp;load average: 6.43, 5.94, 5.83</font></div><div><font size="2"  >Tasks: 209 total, &nbsp; 2 running, 207 sleeping, &nbsp; 0 stopped, &nbsp; 0 zombie</font></div><div><font size="2"  >Cpu(s): &nbsp;0.1%us, &nbsp;1.7%sy, &nbsp;0.0%ni, 86.0%id, &nbsp;9.7%wa, &nbsp;0.0%hi, &nbsp;2.5%si, &nbsp;0.0%st</font></div><div><font size="2"  >Mem: &nbsp;24682088k total, 24609248k used, &nbsp; &nbsp;72840k free, &nbsp; &nbsp;22900k buffers</font></div><div><font size="2"  >Swap: 16779884k total, &nbsp; &nbsp; &nbsp;328k used, 16779556k free, 23244488k cached</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># pgbench Server 1 的测试结果</font></div><div><font size="2"  >postgres@db-192-168-xx-&gt; pgbench -c 15 -j 15 -M prepared -n -s 500 -T 60 -f ./pgbench.sql -h 192.168.173.66 -p 1921 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 500</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 15</font></div><div><font size="2"  >number of threads: 15</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 298054</font></div><div><font size="2"  >tps = 4962.600179 (including connections establishing)</font></div><div><font size="2"  >tps = 4963.328133 (excluding connections establishing)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># pgbench Server 2 的测试结果</font></div><div><font size="2"  >postgres@db-bak-192-168-xx-&gt; pgbench -c 15 -j 15 -M prepared -n -s 500 -T 60 -f ./pgbench.sql -h 192.168.173.66 -p 1921 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 500</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 15</font></div><div><font size="2"  >number of threads: 15</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 172939</font></div><div><font size="2"  >tps = 2879.138242 (including connections establishing)</font></div><div><font size="2"  >tps = 2880.133417 (excluding connections establishing)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># 查看数据库中SQL的统计结果,与上面的测试结果一致。</font></div><div><font size="2"  >digoal=# SELECT query, calls, total_time, rows, 100.0 * shared_blks_hit /</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nullif(shared_blks_hit + shared_blks_read, 0) AS hit_percent</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FROM pg_stat_statements ORDER BY total_time DESC LIMIT 5;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | calls &nbsp;| &nbsp; &nbsp;total_time &nbsp; &nbsp;|</font></div><div><font size="2"  >&nbsp; rows &nbsp;| &nbsp; &nbsp; hit_percent &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >-------------------------------------------------------------------------------------------------------+--------+------------------+</font></div><div><font size="2"  >--------+----------------------</font></div><div><font size="2"  >&nbsp;UPDATE pgbench_accounts SET abalance = abalance + $1 WHERE aid = $2; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 470993 | 728.671936000011 |</font></div><div><font size="2"  >&nbsp;470993 | &nbsp;82.1983131773130262</font></div><div><font size="2"  >&nbsp;UPDATE pgbench_branches SET bbalance = bbalance + $1 WHERE bid = $2; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 470993 | 30.2564640000121 |</font></div><div><font size="2"  >&nbsp;470993 | &nbsp;99.9948907810998778</font></div><div><font size="2"  >&nbsp;UPDATE pgbench_tellers SET tbalance = tbalance + $1 WHERE tid = $2; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 470993 | 28.5014480000199 |</font></div><div><font size="2"  >&nbsp;470993 | &nbsp;99.9802910232559609</font></div><div><font size="2"  >&nbsp;INSERT INTO pgbench_history (tid, bid, aid, delta, mtime) VALUES ($1, $2, $3, $4, CLOCK_TIMESTAMP()); | 470993 | 19.9543690000304 |</font></div><div><font size="2"  >&nbsp;470993 | &nbsp;99.3704301893951686</font></div><div><font size="2"  >&nbsp;SELECT abalance FROM pgbench_accounts WHERE aid = $1; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 470993 | &nbsp;7.6473580000007 |</font></div><div><font size="2"  >&nbsp;470993 | 100.0000000000000000</font></div><div><font size="2"  >(5 rows)</font></div><p></p></pre></div></div><div><br></div><div><div>3. 读写测试(函数)</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ># 主要是为了对比调用函数和直接使用SQL做同样的事情的性能差别</font></div><div><font size="2"  ># 创建如下函数</font></div><div><font size="2"  >digoal=&gt; create or replace function pgbench(i_aid int,i_bid int,i_tid int,i_delta int) returns setof int as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >begin &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >UPDATE pgbench_accounts SET abalance = abalance + i_delta WHERE aid = i_aid;</font></div><div><font size="2"  >UPDATE pgbench_tellers SET tbalance = tbalance + i_delta WHERE tid = i_tid;&nbsp;</font></div><div><font size="2"  >UPDATE pgbench_branches SET bbalance = bbalance + i_delta WHERE bid = i_bid;</font></div><div><font size="2"  >INSERT INTO pgbench_history (tid, bid, aid, delta, mtime) VALUES (i_tid, i_bid, i_aid, i_delta, CURRENT_TIMESTAMP);</font></div><div><font size="2"  >return query SELECT abalance FROM pgbench_accounts WHERE aid = i_aid; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >end; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># 清空SQL统计信息,方便后面统计</font></div><div><font size="2"  >digoal=# select pg_stat_statements_reset();</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># 脚本内容</font></div><div><font size="2"  >\set nbranches :scale</font></div><div><font size="2"  >\set ntellers 10 * :scale</font></div><div><font size="2"  >\set naccounts 100000 * :scale</font></div><div><font size="2"  >\setrandom aid 1 :naccounts</font></div><div><font size="2"  >\setrandom bid 1 :nbranches</font></div><div><font size="2"  >\setrandom tid 1 :ntellers</font></div><div><font size="2"  >\setrandom delta -5000 5000</font></div><div><font size="2"  >select pgbench(:aid,:bid,:tid,:delta);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># 测试时间段内的数据库负载</font></div><div><font size="2"  >top - 15:44:13 up 8 days, 56 min, &nbsp;2 users, &nbsp;load average: 4.37, 2.11, 1.58</font></div><div><font size="2"  >Tasks: 209 total, &nbsp;10 running, 199 sleeping, &nbsp; 0 stopped, &nbsp; 0 zombie</font></div><div><font size="2"  >Cpu(s): 53.9%us, &nbsp;8.7%sy, &nbsp;0.0%ni, 28.2%id, &nbsp;4.9%wa, &nbsp;0.2%hi, &nbsp;4.0%si, &nbsp;0.0%st</font></div><div><font size="2"  >Mem: &nbsp;24682088k total, 24611580k used, &nbsp; &nbsp;70508k free, &nbsp; &nbsp;18344k buffers</font></div><div><font size="2"  >Swap: 16779884k total, &nbsp; &nbsp; &nbsp;208k used, 16779676k free, 23313096k cached</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># pgbench Server 1 的测试结果</font></div><div><font size="2"  >postgres@db-192-168-173-82-&gt; pgbench -c 15 -j 15 -M prepared -n -s 500 -T 60 -f ./pgbench.sql -h 192.168.173.66 -p 1921 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 500</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 15</font></div><div><font size="2"  >number of threads: 15</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 265757</font></div><div><font size="2"  >tps = 4425.763818 (including connections establishing)</font></div><div><font size="2"  >tps = 4427.260370 (excluding connections establishing)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># pgbench Server 2 的测试结果</font></div><div><font size="2"  >postgres@db-bak-192-168-173-95-&gt; pgbench -c 15 -j 15 -M prepared -n -s 500 -T 60 -f ./pgbench.sql -h 192.168.173.66 -p 1921 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 500</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 15</font></div><div><font size="2"  >number of threads: 15</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 272930</font></div><div><font size="2"  >tps = 4543.256940 (including connections establishing)</font></div><div><font size="2"  >tps = 4544.110079 (excluding connections establishing)</font></div><p></p></pre></div></div><div><br></div><div>[脚本语法参考]</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/pgbench.html"  >http://www.postgresql.org/docs/9.1/static/pgbench.html</a></div></div>
	</div>
</div>
</body>
</html>