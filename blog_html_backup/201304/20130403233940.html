<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Postgres-XC add coordinator or repair coordinator catalog - 2</h2>
	<h5 id="">2013-04-03 23:39:40&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201333105156289/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">&nbsp;上一篇BLOG聊到了修复coordinator元数据与其他的coordinator节点不一致的情况下的修复方法.<div>用到了重命名所有datanode上的表, 然后在异常或新加入coordinator节点上新建元数据的方法.</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020133345813184/"   >http://blog.163.com/digoal@126/blog/static/16387704020133345813184/</a></div><div>这里要介绍另一种方法.</div><div>不需要重命名所有datanode上的表, 而是通过dummy datanode的方法来解决.</div><div><div>1. 首先将192.168.122.178的coordinator从其他的coordinator配置中去除.</div><div>模拟当前只有5个coordinator的情况.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >psql -h 192.168.122.173 -p 1921 -U postgres postgres -c "drop node coordinate_6";</font></div><div><font size="2"   >psql -h 192.168.122.174 -p 1921 -U postgres postgres -c "drop node coordinate_6";</font></div><div><font size="2"   >psql -h 192.168.122.175 -p 1921 -U postgres postgres -c "drop node coordinate_6";</font></div><div><font size="2"   >psql -h 192.168.122.176 -p 1921 -U postgres postgres -c "drop node coordinate_6";</font></div><div><font size="2"   >psql -h 192.168.122.177 -p 1921 -U postgres postgres -c "drop node coordinate_6";</font></div><p></p></pre></div><div><br></div><div>2. 在这5个coordinator中的任意一个中新建一个测试表</div><div># 因为修改了node信息, 所以先重载一下pool</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[pgxc@db-192-168-122-173 ~]$ psql -h 192.168.122.177 -p 1921 -U postgres postgres</font></div><div><font size="2"   >psql (PGXC 1.0.2, based on PG 9.1.7)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# select pgxc_pool_reload();</font></div><div><font size="2"   >postgres=# create table new_user_info(id int primary key, info text, crt_time timestamp) distribute by hash(id) to group gp0;</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "new_user_info_pkey" for table "new_user_info"</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div><br></div><div>3. 在192.168.122.178的coordinator中看不到这个新建的new_user_info表.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[pgxc@db-192-168-122-173 pgxc_ddl]$ psql -h 192.168.122.178 -p 1921 -U postgres postgres</font></div><div><font size="2"   >psql (PGXC 1.0.2, based on PG 9.1.7)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; Name &nbsp; &nbsp;| Type &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >--------+-----------+-------+----------</font></div><div><font size="2"   >&nbsp;public | t1 &nbsp; &nbsp; &nbsp; &nbsp;| table | postgres</font></div><div><font size="2"   >&nbsp;public | user_info | table | postgres</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div><br></div><div>4. 现在要让new_user_info表出现在192.168.122.178的coordinator中, 直接加肯定是不行的, 因为各个datanode中已经存在这个表了.</div><div>本文的做法如下 :&nbsp;</div><div>1. 将192.168.122.178的coordinator添加到现有的coordinator中.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >psql -h 192.168.122.173 -p 1921 -U postgres postgres -c "create node coordinate_6 with (type=coordinator, host='db-192-168-122-178', port=1921);"</font></div><div><font size="2"   >psql -h 192.168.122.174 -p 1921 -U postgres postgres -c "create node coordinate_6 with (type=coordinator, host='db-192-168-122-178', port=1921);"</font></div><div><font size="2"   >psql -h 192.168.122.175 -p 1921 -U postgres postgres -c "create node coordinate_6 with (type=coordinator, host='db-192-168-122-178', port=1921);"</font></div><div><font size="2"   >psql -h 192.168.122.176 -p 1921 -U postgres postgres -c "create node coordinate_6 with (type=coordinator, host='db-192-168-122-178', port=1921);"</font></div><div><font size="2"   >psql -h 192.168.122.177 -p 1921 -U postgres postgres -c "create node coordinate_6 with (type=coordinator, host='db-192-168-122-178', port=1921);"</font></div><p></p></pre></div><div># 重载pool</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >psql -h 192.168.122.173 -p 1921 -U postgres postgres -c "select pgxc_pool_reload()"</font></div><div><font size="2"   >psql -h 192.168.122.174 -p 1921 -U postgres postgres -c "select pgxc_pool_reload()"</font></div><div><font size="2"   >psql -h 192.168.122.175 -p 1921 -U postgres postgres -c "select pgxc_pool_reload()"</font></div><div><font size="2"   >psql -h 192.168.122.176 -p 1921 -U postgres postgres -c "select pgxc_pool_reload()"</font></div><div><font size="2"   >psql -h 192.168.122.177 -p 1921 -U postgres postgres -c "select pgxc_pool_reload()"</font></div><p></p></pre></div><div><br></div><div>2. 关闭当前所有有应用程序连接的coordinator(或者阻断他们与外界的任何连接, 包括select, dml等等), 假设当前为5个coordinator.</div><div>主要是防止现有coordinator的catalog又会发生变更(例如变更表结构, &nbsp;删除表或者新建表等等, 并且一会在192.168.122.178上还要用到其中的一个datanode来做引子, 所以务必小心操作).</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[pgxc@db-192-168-122-173]$ pg_ctl -Z coordinator stop -m fast -D /data02/pgxc_coordinate</font></div><div><font size="2"   >[pgxc@db-192-168-122-174]$ pg_ctl -Z coordinator stop -m fast -D /data02/pgxc_coordinate</font></div><div><font size="2"   >[pgxc@db-192-168-122-175]$ pg_ctl -Z coordinator stop -m fast -D /data02/pgxc_coordinate</font></div><div><font size="2"   >[pgxc@db-192-168-122-176]$ pg_ctl -Z coordinator stop -m fast -D /data02/pgxc_coordinate</font></div><div><font size="2"   >[pgxc@db-192-168-122-177]$ pg_ctl -Z coordinator stop -m fast -D /data02/pgxc_coordinate</font></div><p></p></pre></div><div><br></div><div>3. 新建一个dummy datanode(或者在现有的datanode中选择1个作为dummy datanode), 重命名new_user_info表</div><div># 本例选择192.168.122.178 -p 1923作为dummy datanode</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[pgxc@db-192-168-122-178 ~]$ psql -h 192.168.122.178 -p 1923 -U postgres postgres</font></div><div><font size="2"   >psql (PGXC 1.0.2, based on PG 9.1.7)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; Name &nbsp; &nbsp; &nbsp;| Type &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >--------+---------------+-------+----------</font></div><div><font size="2"   >&nbsp;public | new_user_info | table | postgres</font></div><div><font size="2"   >&nbsp;public | t1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| table | postgres</font></div><div><font size="2"   >&nbsp;public | user_info &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >(3 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# alter table new_user_info rename to digoal_new_user_info;</font></div><div><font size="2"   >ALTER TABLE</font></div><p></p></pre></div><div><br></div><div>4. 连接到192.168.122.178的coordinator.</div><div>删除所有除本地coordinator以外的其他coordinator节点, 然后新建user_info表.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[pgxc@db-192-168-122-178 ~]$ psql -h 192.168.122.178 -p 1921 -U postgres postgres</font></div><div><font size="2"   >psql (PGXC 1.0.2, based on PG 9.1.7)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >drop node coordinate_1;</font></div><div><font size="2"   >drop node coordinate_2;</font></div><div><font size="2"   >drop node coordinate_3;</font></div><div><font size="2"   >drop node coordinate_4;</font></div><div><font size="2"   >drop node coordinate_5;</font></div><p></p></pre></div><div>记录下当前的datanode的oid(后面将要用于还原)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select oid,* from pgxc_node order by node_name;</font></div><div><font size="2"   >&nbsp; oid &nbsp;| &nbsp;node_name &nbsp; | node_type | node_port | &nbsp; &nbsp; node_host &nbsp; &nbsp; &nbsp;| nodeis_primary | nodeis_preferred | &nbsp; node_id &nbsp;&nbsp;</font></div><div><font size="2"   >-------+--------------+-----------+-----------+--------------------+----------------+------------------+-------------</font></div><div><font size="2"   >&nbsp;11129 | coordinate_6 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1921 | db-192-168-122-178 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;15814306</font></div><div><font size="2"   >&nbsp;16437 | datanode_1 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-173 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;-675012441</font></div><div><font size="2"   >&nbsp;16432 | datanode_2 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-174 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| -1047623914</font></div><div><font size="2"   >&nbsp;16433 | datanode_3 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-175 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;1787525382</font></div><div><font size="2"   >&nbsp;16434 | datanode_4 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-176 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; -83063638</font></div><div><font size="2"   >&nbsp;16435 | datanode_5 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-177 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; 137889650</font></div><div><font size="2"   >&nbsp;16436 | datanode_6 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-178 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;-678318491</font></div><p></p></pre></div><div><br></div><div>删除所有除dummy datanode以外的其他datanode节点, 然后在这个dummy datanode新建new_user_info表.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# drop node datanode_1;</font></div><div><font size="2"   >DROP NODE</font></div><div><font size="2"   >postgres=# drop node datanode_2;</font></div><div><font size="2"   >DROP NODE</font></div><div><font size="2"   >postgres=# drop node datanode_3;</font></div><div><font size="2"   >DROP NODE</font></div><div><font size="2"   >postgres=# drop node datanode_4;</font></div><div><font size="2"   >DROP NODE</font></div><div><font size="2"   >postgres=# drop node datanode_5;</font></div><div><font size="2"   >DROP NODE</font></div><div><font size="2"   >postgres=# select pgxc_pool_reload();</font></div><div><font size="2"   >&nbsp;pgxc_pool_reload&nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp;t</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# create table new_user_info(id int primary key, info text, crt_time timestamp) distribute by hash(id) to node datanode_6;</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "new_user_info_pkey" for table "new_user_info"</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div># 注意新建的表分布规则与其他节点不一致, 一会需要调整.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from pgxc_class;</font></div><div><font size="2"   >&nbsp;pcrelid | pclocatortype | pcattnum | pchashalgorithm | pchashbuckets | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nodeoids &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------+---------------+----------+-----------------+---------------+-------------------------------------</font></div><div><font size="2"   >&nbsp; &nbsp;16447 | H &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4096 | 16437 16432 16433 16434 16435 16436</font></div><div><font size="2"   >&nbsp; &nbsp;24730 | H &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4096 | 16437 16432 16433 16434 16435 16436</font></div><div><font size="2"   >&nbsp; &nbsp;24751 | H &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4096 | 16436</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div><div># pgxc_group一会修复后也需要更新.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from pgxc_group;</font></div><div><font size="2"   >&nbsp;group_name | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;group_members &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------+-------------------------------------</font></div><div><font size="2"   >&nbsp;gp0 &nbsp; &nbsp; &nbsp; &nbsp;| 16437 16432 16433 16434 16435 16436</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>5. 连接到dummy datanode, 修改表名.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[pgxc@db-192-168-122-178 ~]$ psql -h 192.168.122.178 -p 1923 -U postgres postgres</font></div><div><font size="2"   >psql (PGXC 1.0.2, based on PG 9.1.7)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp; &nbsp; Name &nbsp; &nbsp; &nbsp; &nbsp; | Type &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >--------+----------------------+-------+----------</font></div><div><font size="2"   >&nbsp;public | digoal_new_user_info | table | postgres</font></div><div><font size="2"   >&nbsp;public | new_user_info &nbsp; &nbsp; &nbsp; &nbsp;| table | postgres</font></div><div><font size="2"   >&nbsp;public | t1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | user_info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| table | postgres</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   >postgres=# drop table new_user_info;</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >postgres=# alter table digoal_new_user_info rename to new_user_info;</font></div><div><font size="2"   >ALTER TABLE</font></div><p></p></pre></div><div><br></div><div>6. 连接到192.168.122.178的coordinator, 新建前面删除掉的coordinator以及datanode节点.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[pgxc@db-192-168-122-178 pgxc-v1.0.2]$ psql -h 192.168.122.178 -p 1921 -U postgres postgres&nbsp;</font></div><div><font size="2"   >psql (PGXC 1.0.2, based on PG 9.1.7)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# select oid,* from pgxc_node;</font></div><div><font size="2"   >&nbsp; oid &nbsp;| &nbsp;node_name &nbsp; | node_type | node_port | &nbsp; &nbsp; node_host &nbsp; &nbsp; &nbsp;| nodeis_primary | nodeis_preferred | &nbsp;node_id &nbsp;&nbsp;</font></div><div><font size="2"   >-------+--------------+-----------+-----------+--------------------+----------------+------------------+------------</font></div><div><font size="2"   >&nbsp;16436 | datanode_6 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-178 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| -678318491</font></div><div><font size="2"   >&nbsp;11129 | coordinate_6 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1921 | db-192-168-122-178 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; 15814306</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   >postgres=# create node coordinate_1 with (type=coordinator, host='db-192-168-122-173', port=1921);</font></div><div><font size="2"   >CREATE NODE</font></div><div><font size="2"   >postgres=# create node coordinate_2 with (type=coordinator, host='db-192-168-122-174', port=1921);</font></div><div><font size="2"   >CREATE NODE</font></div><div><font size="2"   >postgres=# create node coordinate_3 with (type=coordinator, host='db-192-168-122-175', port=1921);</font></div><div><font size="2"   >CREATE NODE</font></div><div><font size="2"   >postgres=# create node coordinate_4 with (type=coordinator, host='db-192-168-122-176', port=1921);</font></div><div><font size="2"   >CREATE NODE</font></div><div><font size="2"   >postgres=# create node coordinate_5 with (type=coordinator, host='db-192-168-122-177', port=1921);</font></div><div><font size="2"   >CREATE NODE</font></div><div><font size="2"   >postgres=# create node datanode_1 with (type=datanode, host='db-192-168-122-173', port=1923, primary=true, preferred=false);</font></div><div><font size="2"   >CREATE NODE</font></div><div><font size="2"   >postgres=# create node datanode_2 with (type=datanode, host='db-192-168-122-174', port=1923, primary=false, preferred=false);</font></div><div><font size="2"   >CREATE NODE</font></div><div><font size="2"   >postgres=# create node datanode_3 with (type=datanode, host='db-192-168-122-175', port=1923, primary=false, preferred=false);</font></div><div><font size="2"   >CREATE NODE</font></div><div><font size="2"   >postgres=# create node datanode_4 with (type=datanode, host='db-192-168-122-176', port=1923, primary=false, preferred=false);</font></div><div><font size="2"   >CREATE NODE</font></div><div><font size="2"   >postgres=# create node datanode_5 with (type=datanode, host='db-192-168-122-177', port=1923, primary=false, preferred=false);</font></div><div><font size="2"   >CREATE NODE</font></div><div><font size="2"   >postgres=# clean connection to all for database postgres;</font></div><div><font size="2"   >CLEAN CONNECTION</font></div><div><font size="2"   >postgres=# select pgxc_pool_reload();</font></div><div><font size="2"   >&nbsp;pgxc_pool_reload&nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp;t</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select oid,* from pgxc_node order by node_name;</font></div><div><font size="2"   >&nbsp; oid &nbsp;| &nbsp;node_name &nbsp; | node_type | node_port | &nbsp; &nbsp; node_host &nbsp; &nbsp; &nbsp;| nodeis_primary | nodeis_preferred | &nbsp; node_id &nbsp;&nbsp;</font></div><div><font size="2"   >-------+--------------+-----------+-----------+--------------------+----------------+------------------+-------------</font></div><div><font size="2"   >&nbsp;24759 | coordinate_1 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1921 | db-192-168-122-173 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;-922782310</font></div><div><font size="2"   >&nbsp;24760 | coordinate_2 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1921 | db-192-168-122-174 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;1027955327</font></div><div><font size="2"   >&nbsp;24761 | coordinate_3 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1921 | db-192-168-122-175 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; 183504851</font></div><div><font size="2"   >&nbsp;24762 | coordinate_4 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1921 | db-192-168-122-176 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| -1338651536</font></div><div><font size="2"   >&nbsp;24763 | coordinate_5 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1921 | db-192-168-122-177 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;2058409530</font></div><div><font size="2"   >&nbsp;11129 | coordinate_6 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1921 | db-192-168-122-178 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;15814306</font></div><div><font size="2"   >&nbsp;24764 | datanode_1 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-173 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;-675012441</font></div><div><font size="2"   >&nbsp;24765 | datanode_2 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-174 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| -1047623914</font></div><div><font size="2"   >&nbsp;24766 | datanode_3 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-175 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;1787525382</font></div><div><font size="2"   >&nbsp;24767 | datanode_4 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-176 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; -83063638</font></div><div><font size="2"   >&nbsp;24768 | datanode_5 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-177 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; 137889650</font></div><div><font size="2"   >&nbsp;16436 | datanode_6 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-178 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;-678318491</font></div><div><font size="2"   >(12 rows)</font></div><p></p></pre></div><div><br></div><div>7. 根据以上结果, 由于pgxc_node中datanode的oid变更了, 所以必须修改192.168.122.178的coordinator 节点的pgxc_class的oid信息. 以及pgxc_group的信息.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# update pgxc_group set group_members=oidvector '24764 24765 24766 24767 24768 16436';</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# update pgxc_class set nodeoids=oidvector '24764 24765 24766 24767 24768 16436' where pcrelid in (16447, 24730, 24751);</font></div><div><font size="2"   >UPDATE 3</font></div><div><font size="2"   >postgres=# select * from pgxc_class;</font></div><div><font size="2"   >&nbsp;pcrelid | pclocatortype | pcattnum | pchashalgorithm | pchashbuckets | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nodeoids &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------+---------------+----------+-----------------+---------------+-------------------------------------</font></div><div><font size="2"   >&nbsp; &nbsp;16447 | H &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4096 | 24764 24765 24766 24767 24768 16436</font></div><div><font size="2"   >&nbsp; &nbsp;24730 | H &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4096 | 24764 24765 24766 24767 24768 16436</font></div><div><font size="2"   >&nbsp; &nbsp;24751 | H &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4096 | 24764 24765 24766 24767 24768 16436</font></div><div><font size="2"   >(3 rows)</font></div><div><font size="2"   >postgres=# select * from pgxc_group;</font></div><div><font size="2"   >&nbsp;group_name | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;group_members &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------+-------------------------------------</font></div><div><font size="2"   >&nbsp;gp0 &nbsp; &nbsp; &nbsp; &nbsp;| 24764 24765 24766 24767 24768 16436</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# clean connection to all for database postgres;</font></div><div><font size="2"   >CLEAN CONNECTION</font></div><div><font size="2"   >postgres=# select pgxc_pool_reload();</font></div><div><font size="2"   >&nbsp;pgxc_pool_reload&nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp;t</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# insert into new_user_info select generate_series(1,10000), md5(random()::text), clock_timestamp();</font></div><div><font size="2"   >INSERT 0 10000</font></div><div><font size="2"   >postgres=# select count(*) from new_user_info ;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;10000</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>8. 启动其他coordinator</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[pgxc@db-192-168-122-173]$ pg_ctl -Z coordinator start -D /data02/pgxc_coordinate</font></div><div><font size="2"   >[pgxc@db-192-168-122-174]$ pg_ctl -Z coordinator start -D /data02/pgxc_coordinate</font></div><div><font size="2"   >[pgxc@db-192-168-122-175]$ pg_ctl -Z coordinator start -D /data02/pgxc_coordinate</font></div><div><font size="2"   >[pgxc@db-192-168-122-176]$ pg_ctl -Z coordinator start -D /data02/pgxc_coordinate</font></div><div><font size="2"   >[pgxc@db-192-168-122-177]$ pg_ctl -Z coordinator start -D /data02/pgxc_coordinate</font></div><p></p></pre></div><div><br></div><div>[其他]</div><div>1. # 建议pg-xc提供一个dummy datanode, 这样的话修复数据就不需要用到真实的datanode了.</div></div></div>
	</div>
</div>
</body>
</html>