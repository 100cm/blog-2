<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL notreal-time insert-only count(*) performance tuning case - 7</h2>
	<h5 id="">2013-04-27 11:38:41&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020133271134563/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">这一篇主要针对的是数组的瘦身优化, 因为前面6篇blog中在统计时抽取的是所有字段组成的数组, 这样内存空间消耗会比较大.<div>实际上我们只需要被用于统计的字段.</div><div>例如log_c1_cnt_day这个统计表, &nbsp;只需要用到xid, c1, crt_time这三个字段.</div><div>因此需要新建统计维度相关的类型. 用法如下.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create type log_c1_stat AS(xid int8, c1 int, crt_time timestamp);</font></div><div><font size="2"   >CREATE TYPE</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span style="line-height: 19px;"   >postgres=# do language plpgsql $$<br>declare<br>  v_log_c1_stat log_c1_stat[];<br>begin<br>  select array_agg(i_stat) into v_log_c1_stat from (select (xid,c1,crt_time)::log_c1_stat as i_stat from log limit 10) t;<br>  raise notice '%', v_log_c1_stat;<br>  raise notice '%', (v_log_c1_stat[1]).xid;<br>end;<br>$$;<br>NOTICE:  {"(505354161,0,\"2013-04-27 11:04:09.815764\")","(505354161,9,\"2013-04-27 11:04:09.815764\")","(505354161,8,\"2013-04-27 11:04:09.815764\")","(505354161,1,\"2013-04-27 11:04:09.815764\")","(505354161,0,\"2013-04-27 11:04:09.815764\")","(505354161,4,\"2013-04-27 11:04:09.815764\")","(505354161,1,\"2013-04-27 11:04:09.815764\")","(505354161,9,\"2013-04-27 11:04:09.815764\")","(505354161,1,\"2013-04-27 11:04:09.815764\")","(505354161,1,\"2013-04-27 11:04:09.815764\")"}<br>NOTICE:  505354161<br>DO</span></font></div><p></p></pre></div><div>具体的函数我就不重写了.</div><div>大家可以参考前面的6篇BLOG进行相应修改.</div><div>另一个可以优化的点是多维度处理时的优化, 例如首先计算天的count, 那么在计算按周的count时, 可以使用天的count结果, 而不需要从原始数据进行统计. 按月, 年的统计依次类推.&nbsp;</div><div><br></div><div>【参考】</div><div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >1.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136); cursor: pointer;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201331252945440/"   >http://blog.163.com/digoal@126/blog/static/163877040201331252945440/</a></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >2.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020133151402415/"   >http://blog.163.com/digoal@126/blog/static/16387704020133151402415/</a></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >3.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020133155179877/"   >http://blog.163.com/digoal@126/blog/static/16387704020133155179877/</a></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >4.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020133156636579/"   >http://blog.163.com/digoal@126/blog/static/16387704020133156636579/</a></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >5.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020133218305242/"   >http://blog.163.com/digoal@126/blog/static/16387704020133218305242/</a></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >6.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020133224161563/"   >http://blog.163.com/digoal@126/blog/static/16387704020133224161563/</a></div></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><span style="line-height: 22px;"   >7.&nbsp;</span><a style="line-height: 22px; text-decoration: none; color: rgb(85, 108, 136);" href="http://blog.163.com/digoal@126/blog/static/16387704020133271134563/"   >http://blog.163.com/digoal@126/blog/static/16387704020133271134563/</a></div></div>8.&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020134311144755/"   >http://blog.163.com/digoal@126/blog/static/16387704020134311144755/</a></div>
	</div>
</div>
</body>
</html>