<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL A simple WAN disaster recovery implement</h2>
	<h5 id="">2013-04-24 23:10:10&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013324103828603/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">本文简单的讲述一下PostgreSQL跨广域网的容灾.<div>1. 广域网首先要考虑网络稳定情况, 丢包率等.</div><div>&nbsp; &nbsp; 使用PostgreSQL 流复制不依赖网络稳定情况, 所以比较有弹性.&nbsp;</div><div>&nbsp; &nbsp; 通过配置archive_command, 或者wal_keep_segments保证有足够的pg_xlog文件, 确保网络极度不稳定或者长时间中断的情况下不需要重做基础备份.</div><div>2. 广域网环境<span style="line-height: 22px;"   >同时还需要考虑数据被截取的可能.</span><div><div>&nbsp; &nbsp; 使用ssh建立隧道, 加密传输数据.</div><div>3.&nbsp;<span style="line-height: 22px;"   >广域网环境还需要考虑</span><span style="line-height: 22px;"   >带宽的问题.</span></div><div><span style="line-height: 22px;"   >&nbsp; &nbsp; 使用ssh建立隧道, &nbsp;增加数据压缩选项.</span></div><div><span style="line-height: 22px;"   ><br></span></div><div>环境 :&nbsp;</div><div><span style="line-height: 22px;"   >IDC1</span></div><div><span style="line-height: 22px;"   >IDC1_server1</span></div><div><pre class="prettyprint"   ><p><font size="2"   >ssh-keygen -t rsa</font></p></pre></div><div><br></div><div><div style="line-height: 22px;"   >IDC2</div><div style="line-height: 22px;"   >IDC2_server1</div></div><div style="line-height: 22px;"   >将id_rsa.pub拷贝到~/.ssh/authorized_keys</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >chmod 700 ~</font></div><div style="line-height: 22px;"   ><font size="2"   >chmod 700 ~/.ssh</font></div><div style="line-height: 22px;"   ><font size="2"   >chmod 400&nbsp;<span style="line-height: 22px;"   >~/.ssh/authorized_keys</span></font></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >IDC2_db1 :&nbsp;<span style="line-height: 22px;"   >-- 主库</span></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >IDC1_server1 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >ssh -o TCPKeepAlive=90 -o ServerAliveInterval=10 -o ServerAliveCountMax=10 -o CompressionLevel=9 -p 22 -CqTfnN -L *:17100:<span style="line-height: 22px;"   >IDC2_db1_ip</span>:5432 postgres@IDC2_server1_ip</font></p></pre></div><div>将在本地启动一个监听17100端口. 访问17100端口相当于通过IDC2_server1访问IDC2_db1_ip:5432端口.</div><div>数据加密和压缩发生在IDC1_server1和IDC2_server1之间.</div><div>数据库pg_hba.conf应该开放IDC2_server1的访问许可.</div><div><br></div><div>[监控]</div><div><div># cat check_pg_rongzai.sh&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#!/bin/bash<br><br>export LANG=en_US.utf8<br>export PGHOME=/opt/pgsql<br>export LD_LIBRARY_PATH=$ORACLE_HOME/lib:$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib<br>export PATH=$PGHOME/bin:$PATH:.<br>export MANPATH=$PGHOME/share/man:$MANPATH<br>alias rm='rm -i'<br>alias ll='ls -lh'<br><br>if [ $1 == "digoal" ]; then<br># 监控本地ssh代理监听端口<br>  echo -e "192.168.1.2 PostgreSQL rongzai."<br>  CNT=`netstat -anpo|grep 15432|grep -v grep|grep LISTEN|wc -l`<br>  if [ $CNT -eq 0 ]; then<br>    echo -e "15432 LISTEN Failed."<br>    exit 2<br>  fi<br># 监控数据库监听端口<br>  CNT=`netstat -anpo|grep 5432|grep -v grep|grep LISTEN|wc -l`<br>  if [ $CNT -eq 0 ]; then<br>    echo -e "5432 LISTEN Failed."<br>    exit 2<br>  fi<br># 监控数据库流复制接收进程<br>  CNT=`ps -ewf|grep -v grep|grep postgres|grep "wal receiver"|wc -l`<br>  if [ $CNT -eq 0 ]; then<br>    echo -e "postgres wal receiver Failed."<br>    exit 2<br>  fi<br># 监控流复制延迟<br>  psql -h 127.0.0.1 -p 5432 -U postgres -d postgres -c "select 'standby_good' as stat from (select (pg_stat_file('pg_xlog/'||i)).*,i from pg_ls_dir('pg_xlog') i)t where now()-modification&lt; interval '12 min' limit 1;"|grep standby_good<br>  if [ $? -ne 0 ]; then<br>    echo -e "postgres standby lagged 30 minutes."<br>    exit 2<br>  fi<br>  exit 0<br>fi</font></div><div><font size="2"   ><span style="line-height: 19px;"   ><br></span></font></div><div><font size="2"   >echo -e "参数错误"<br>exit 1</font></div><div><font size="2"   ># Author: digoal.zhou</font></div><p></p></pre></div></div><div>配置nagios</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi /usr/local/nagios/etc/nrpe.cfg</font></div><div><font size="2"   >command[check_pg_rongzai1]=/root/script/check_pg_rongzai.sh digoal</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >service xinetd restart</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ><br></span></div><div>【参考】<wbr><div>1.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020115294425540/"   >http://blog.163.com/digoal@126/blog/static/16387704020115294425540/</a></div><div>2.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201152753352356/"   >http://blog.163.com/digoal@126/blog/static/163877040201152753352356/</a></div><div>3.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020132279020755/"   >http://blog.163.com/digoal@126/blog/static/16387704020132279020755/</a></div><div>4.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.psc.edu/index.php/hpn-ssh"   >http://www.psc.edu/index.php/hpn-ssh</a></div></div></div></div><div>ssh 广域网加速补丁.</div></div>
	</div>
</div>
</body>
</html>