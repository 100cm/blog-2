<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL load data performance test</h2>
	<h5 id="">2013-04-12 9:24:49&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020133103581541/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>最近一位网友在对数据库做选型, 业务大概是收集终端的日志导入数据库, 每秒约1万条记录. 每天8.6亿. 假设按天分表.</div><div>现在跑在MySQL下面, 在load数据库的时候会产生锁, 导致并发的读请求需要等待.&nbsp;<span style="line-height: 22px;"   >原因 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[广州]sheen(403239566) &nbsp;10:07:57</font></div><div><font size="2"   >[杭州]-德哥(276732431) &nbsp;9:47:41</font></div><div><font size="2"   >PostgreSQL load data performance test &nbsp;</font></div><div><font size="2"   >http://blog.163.com/digoal@126/blog/static/16387704020133103581541/</font></div><div><font size="2"   >看了下mysql 的表引擎 是myisam ，</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >对MyISAM表的写操作，则会阻塞其他用户对同一表的读和写操作；MyISAM表的读操作与写操作之间，以及写操作之间是串行的.</font></div><div><font size="2"   >这个是他导入数据会锁的原因</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >我以前针对PostgreSQL的batch insert做过较为详细的测试, 有兴趣的朋友可以参考如下.</span></div><div><div style="line-height: 22px;"   >1.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201092805732741/"   >http://blog.163.com/digoal@126/blog/static/163877040201092805732741/</a></div><div style="line-height: 22px;"   >2.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020109276295217/"   >http://blog.163.com/digoal@126/blog/static/16387704020109276295217/</a></div><div style="line-height: 22px;"   >3.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020125421816584/"   >http://blog.163.com/digoal@126/blog/static/16387704020125421816584/</a></div><div style="line-height: 22px;"   >4.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201242331551545/"   >http://blog.163.com/digoal@126/blog/static/163877040201242331551545/</a></div></div><div><br></div><div>接下来本文主要针对这位网友的场景进行针对性的测试.</div><div>(本文不对MySQL进行验证测试, 仅仅针对PostgreSQL以及这个场景进行测试)</div><div>最终得出的测试结果是否满足这位网友的需求呢?&nbsp;</div><div><br></div><div>1. 首先介绍一下MYSQL中的数据结构 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE TABLE `t_log_nat`(</font></div><div><font size="2"   >&nbsp; `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',</font></div><div><font size="2"   >&nbsp; `device_id` int(11) NOT NULL COMMENT '设备ID',</font></div><div><font size="2"   >&nbsp; `src_ip` bigint(20) DEFAULT NULL COMMENT '源IP地址',</font></div><div><font size="2"   >&nbsp; `src_transfer_ip` bigint(20) DEFAULT NULL COMMENT '目的IP地址',</font></div><div><font size="2"   >&nbsp; `dst_ip` bigint(20) DEFAULT NULL COMMENT '目的IP地址',</font></div><div><font size="2"   >&nbsp; `src_port` int(11) DEFAULT NULL COMMENT '源端口',</font></div><div><font size="2"   >&nbsp; `dst_port` int(11) DEFAULT NULL COMMENT '目的端口',</font></div><div><font size="2"   >&nbsp; `transfer_port` int(11) DEFAULT NULL COMMENT '转换后端口',</font></div><div><font size="2"   >&nbsp; `type` varchar(32) DEFAULT NULL COMMENT 'nat类型，snat，dnat，bnat', -- 改成int2了.</font></div><div><font size="2"   >&nbsp; `ip_version` tinyint DEFAULT 0 COMMENT 'ip版本,0:ipv4,1:ipv6',</font></div><div><font size="2"   >&nbsp; `protocol_id` int(11) DEFAULT NULL COMMENT '协议ID',</font></div><div><font size="2"   >&nbsp; `rule_id` int(11) DEFAULT NULL COMMENT '规则ID',</font></div><div><font size="2"   >&nbsp; `create_time` &nbsp;timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,</font></div><div><font size="2"   >&nbsp; PRIMARY KEY (`id`,`create_time`)</font></div><div><font size="2"   >) ENGINE=MyISAM DEFAULT CHARSET=utf8 COLLATE=utf8_bin</font></div><div><font size="2"   >PARTITION BY RANGE ( UNIX_TIMESTAMP(create_time) ) (</font></div><div><font size="2"   >&nbsp; &nbsp; PARTITION pmaxvalue VALUES LESS THAN (MAXVALUE)</font></div><div><font size="2"   >);</font></div></pre></div><div>除了主键外还有其他4个btree索引 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >src_ip,</font></div><div><font size="2"   >dst_ip,</font></div><div><font size="2"   >device_id,</font></div><div><font size="2"   >create_time</font></div><p></p></pre></div><div><div><span style="line-height: 22px;"   >转换成PostgreSQL后的数据结构 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE TABLE t_log_nat(</font></div><div><font size="2"   >&nbsp; id serial8 NOT NULL ,-- COMMENT '主键'</font></div><div><font size="2"   >&nbsp; device_id int NOT NULL ,-- COMMENT '设备ID'</font></div><div><font size="2"   >&nbsp; src_ip bigint DEFAULT NULL ,-- COMMENT '源IP地址'</font></div><div><font size="2"   >&nbsp; src_transfer_ip bigint DEFAULT NULL ,-- COMMENT '目的IP地址'</font></div><div><font size="2"   >&nbsp; dst_ip bigint DEFAULT NULL ,-- COMMENT '目的IP地址'</font></div><div><font size="2"   >&nbsp; src_port int2 DEFAULT NULL ,-- COMMENT '源端口'</font></div><div><font size="2"   >&nbsp; dst_port int2 DEFAULT NULL ,-- COMMENT '目的端口'</font></div><div><font size="2"   >&nbsp; transfer_port int DEFAULT NULL ,-- COMMENT '转换后端口'</font></div><div><font size="2"   >&nbsp; type int2 DEFAULT NULL ,-- COMMENT 'nat类型,snat,dnat,bnat'</font></div><div><font size="2"   >&nbsp; ip_version int2 DEFAULT 0 ,-- COMMENT 'ip版本,0:ipv4,1:ipv6'</font></div><div><font size="2"   >&nbsp; protocol_id int DEFAULT NULL ,-- COMMENT '协议ID'</font></div><div><font size="2"   >&nbsp; rule_id int DEFAULT NULL ,-- COMMENT '规则ID'</font></div><div><font size="2"   >&nbsp; create_time timestamp NOT NULL DEFAULT clock_timestamp(),</font></div><div><font size="2"   >&nbsp; primary key(id)</font></div><div><font size="2"   >);</font></div><p></p></pre></div><div>索引 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create index idx_t_log_nat_1 on t_log_nat(src_ip);</font></div><div><font size="2"   >create index idx_t_log_nat_2 on t_log_nat(dst_ip);</font></div><div><font size="2"   >create index idx_t_log_nat_3 on t_log_nat(device_id);</font></div><div><font size="2"   >create index idx_t_log_nat_4 on t_log_nat(create_time);</font></div><p></p></pre></div><div><br></div><div># 测试环境 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >DELL R610</font></div><div><font size="2"   >CPU : Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >OS : Ubuntu 12.04 x64</font></div><div><font size="2"   >KERNEL :</font></div><div><font size="2"   >Linux digoal-PowerEdge-R610 3.5.0-26-generic #42~precise1-Ubuntu SMP Mon Mar 11 22:17:58 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux</font></div><div><font size="2"   >MEM : 98GB</font></div><div><font size="2"   >DISK : (Table)OCZ-VERTEX4 512GB, (Index)OCZ-RevoDrive3 240G, (pg_xlog)10k转146G</font></div><div><font size="2"   >RAID card : 03:00.0 RAID bus controller: LSI Logic / Symbios Logic MegaRAID SAS 1078 (rev 04)</font></div><div><font size="2"   >Database : PostgreSQL 9.2.4</font></div><p></p></pre></div><div>数据库参数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"   >port = 1919 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >max_connections = 2000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >superuser_reserved_connections = 13 &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_directory = '.' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_permissions = 0700 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# begin with 0 to use octal notation</font></div><div><font size="2"   >tcp_keepalives_idle = 60 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPIDLE, in seconds;</font></div><div><font size="2"   >tcp_keepalives_interval = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPINTVL, in seconds;</font></div><div><font size="2"   >tcp_keepalives_count = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # TCP_KEEPCNT;</font></div><div><font size="2"   >shared_buffers = 8096MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div><font size="2"   >max_stack_depth = 6MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 100kB</font></div><div><font size="2"   >vacuum_cost_delay = 10ms                # 0-100 milliseconds</font></div><div><font size="2"   >vacuum_cost_limit = 10000               # 1-10000 credits</font></div><div><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level;</font></div><div><font size="2"   >wal_sync_method = open_datasync &nbsp; &nbsp; &nbsp; &nbsp; # the default is the first option</font></div><div><font size="2"   >wal_buffers = 16384kB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 32kB, -1 sets based on shared_buffers</font></div><div><font size="2"   >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"   >checkpoint_segments = 512 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # in logfile segments, min 1, 16MB each</font></div><div><font size="2"   >random_page_cost = 1.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# same scale as above</font></div><div><font size="2"   >effective_cache_size = 81920MB</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_directory = 'pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,</font></div><div><font size="2"   >log_file_mode = 0600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# creation mode for log files,</font></div><div><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div><font size="2"   >log_rotation_age = 1d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Automatic rotation of logfiles will</font></div><div><font size="2"   >log_rotation_size = 10MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Automatic rotation of logfiles will</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_disconnections = on</font></div><div><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div><font size="2"   >log_timezone = 'PRC'</font></div><div><font size="2"   >log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >timezone = 'PRC'</font></div><div><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 生成测试数据的函数1, 固定输入数据类型, 本文末尾提供一个不固定输入类型的函数, 方便使用.</span></div><div><span style="line-height: 22px;"   ># 不固定输入类型时, 如果不指定类型, 类型将在第一次使用时被固化, 所以不需要传入时指定. 方便使用.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >drop function insert_t_log_nat(int,int8,int8,int8,int2,int2,int,int2,int2,int,int);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create or replace function insert_t_log_nat</font></div><div><font size="2"   >(i_device_id int,&nbsp;</font></div><div><font size="2"   >i_src_ip int8,&nbsp;</font></div><div><font size="2"   >i_src_transfer_ip int8,&nbsp;</font></div><div><font size="2"   >i_dst_ip int8,&nbsp;</font></div><div><font size="2"   >i_src_port int2,&nbsp;</font></div><div><font size="2"   >i_dst_port int2,&nbsp;</font></div><div><font size="2"   >i_transfer_port int,&nbsp;</font></div><div><font size="2"   >i_type int2,</font></div><div><font size="2"   >i_ip_version int2,</font></div><div><font size="2"   >i_protocol_id int,</font></div><div><font size="2"   >i_rule_id int</font></div><div><font size="2"   >)&nbsp;</font></div><div><font size="2"   >returns void as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; insert into t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id)</font></div><div><font size="2"   >&nbsp; values</font></div><div><font size="2"   >&nbsp; (i_device_id ,&nbsp;</font></div><div><font size="2"   >    i_src_ip ,&nbsp;</font></div><div><font size="2"   >    i_src_transfer_ip ,&nbsp;</font></div><div><font size="2"   >    i_dst_ip ,&nbsp;</font></div><div><font size="2"   >    i_src_port ,&nbsp;</font></div><div><font size="2"   >    i_dst_port ,&nbsp;</font></div><div><font size="2"   >    i_transfer_port ,&nbsp;</font></div><div><font size="2"   >    i_type ,</font></div><div><font size="2"   >    i_ip_version ,</font></div><div><font size="2"   >    i_protocol_id ,</font></div><div><font size="2"   >    i_rule_id&nbsp;</font></div><div><font size="2"   >    ) ;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql;</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 生成测试数据的pgbench脚本,&nbsp;</span><span style="line-height: 22px;"   >使用这种方法生成随机数据, 确保索引列的数据随机. 具备真实性.</span></div><div><span style="line-height: 22px;"   ># 模拟实际数据要考虑的因素主要是索引列上的值要真实, 例如本例的索引共5个(主键, device_id, src_ip, dst_ip, create_time)</span></div><div><span style="line-height: 22px;"   ># 其中主键和create_time是数据库自动生成的, 连续性与实际场景相符</span></div><div><span style="line-height: 22px;"   ># 那么脚本中要设计的就是device_id, src_ip, dst_ip的值了, 这里使用的是随机生成的值, 离散度会远远高于实际生产的数据.</span></div><div><span style="line-height: 22px;"   ># 所以测出的导入性能和实际的生产导入性能会有一定的偏差, 理论上会小于实际导入速度.</span></div><div><span style="line-height: 22px;"   ># 例如本文测试出来是4w/s, 实际生产可能就可以达到10W/s.的导入速度.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >\setrandom i_device_id 1 20000000</font></div><div><font size="2"   >\setrandom i_src_ip 1 2000000000</font></div><div><font size="2"   >\setrandom i_dst_ip 1 2000000000</font></div><div><font size="2"   >select insert_t_log_nat(:i_device_id::int,:i_src_ip::int8,:i_src_ip::int8,:i_dst_ip::int8,1::int2,1::int2,1::int,0::int2,0::int2,1::int,1::int);</font></div><p></p></pre></div><div># 调用pgbench插入数据</div></div><div><pre class="prettyprint"   ><p><font size="2"   >pg92@db-172-16-3-33-&gt; nohup pgbench -M prepared -r -c 16 -f ./insert.sql -j 8 -n -T 300000 -h 172.16.3.150 -p 1919 -U postgres postgres &gt;&gt;./bench.log 2&gt;&amp;1 &amp;</font></p></pre></div><div># 测试数据生成完后, 开始模拟数据导入. 从已经生成的测试数据中取出80万条随机数据, 放到8个文件中.</div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >copy (select device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id from t_log_nat</font></div><div><font size="2"   >&nbsp;where id in</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; (select floor(random() * (max_id - min_id))::int</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + min_id</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;from generate_series(1,100000),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (select max(id) as max_id,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; min(id) as min_id</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;from t_log_nat) s1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; )) to '/data01/pg92/t_log_nat1.dmp';</font></div><p></p></pre></div><div>执行8次, 取出80W条随机记录.</div><div><br></div><div># 编辑pgbench数据导入测试语句:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; cat copy.sql&nbsp;</font></div><div><font size="2"   >copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat1.dmp';</font></div><div><font size="2"   >copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat2.dmp';</font></div><div><font size="2"   >copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat3.dmp';</font></div><div><font size="2"   >copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat4.dmp';</font></div><div><font size="2"   >copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat5.dmp';</font></div><div><font size="2"   >copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat6.dmp';</font></div><div><font size="2"   >copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat7.dmp';</font></div><div><font size="2"   >copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat8.dmp';</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 查询当前t_log_nat记录数</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select count(*) from t_log_nat;</font></div><div><font size="2"   >&nbsp; &nbsp;count &nbsp;&nbsp;</font></div><div><font size="2"   >-----------</font></div><div><font size="2"   >&nbsp;105070012</font></div><div><font size="2"   >(1 row)</font></div></pre></div><div># 导入结果 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; date;pgbench -M prepared -r -n -f ./copy.sql -c 16 -j 8 -T 60 -h $PGDATA -p 1919 -U postgres postgres;date;</font></div><div><font size="2"   >Thu Apr 11 23:22:27 CST 2013</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 16</font></div><div><font size="2"   >tps = 0.052661 (including connections establishing)</font></div><div><font size="2"   >tps = 0.052663 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 39115.213812 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat1.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 38753.329625 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat2.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 38626.822375 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat3.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 38034.551125 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat4.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 37485.141625 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat5.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 37306.804812 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat6.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 37125.665250 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat7.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 37328.476000 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat8.dmp';</font></div><div><font size="2"   >Thu Apr 11 23:27:31 CST 2013</font></div><p></p></pre></div><div># 耗时304秒</div><div><br></div><div># 查询导入测试结束后t_log_nat记录数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select count(*) from t_log_nat;</font></div><div><font size="2"   >&nbsp; &nbsp;count &nbsp;&nbsp;</font></div><div><font size="2"   >-----------</font></div><div><font size="2"   >&nbsp;117861708</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 计算每秒导入的速度 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select (117861708-105070012)/304.0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------------</font></div><div><font size="2"   >&nbsp;42077.947368421053</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>每秒导入42077.9条数据.</div><div><br></div><div># 多次导入后, 数据量达到<span style="line-height: 22px;"   >130653404&nbsp;</span><span style="line-height: 22px;"   >t_log_nat数据表的大小 12GB :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select pg_relation_size('t_log_nat')/1024/1024/1024;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;12</font></div><p></p></pre></div><div># 算上索引后的大小 28GB &nbsp;:&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >postgres=# select pg_total_relation_size('t_log_nat')/1024/1024/1024;</font></span></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;28</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 数据导入的同时对数据库进行查询, 如下, 返回587条记录, 走索引, 查询速度约10毫秒.</span></div><div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >postgres=# select id,device_id,create_time from t_log_nat where device_id&gt;=10000000 and device_id&lt;10000100 order by create_time desc;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; id &nbsp; &nbsp; | device_id | &nbsp; &nbsp; &nbsp; &nbsp;create_time &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >-----------+-----------+----------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;120758136 | &nbsp;10000086 | 2013-04-11 23:32:14.657665</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;120758074 | &nbsp;10000086 | 2013-04-11 23:32:14.656145</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;120758062 | &nbsp;10000086 | 2013-04-11 23:32:14.655861</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;120758059 | &nbsp;10000086 | 2013-04-11 23:32:14.65583</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;120758006 | &nbsp;10000086 | 2013-04-11 23:32:14.654482</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;120757895 | &nbsp;10000086 | 2013-04-11 23:32:14.651929</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;120757890 | &nbsp;10000086 | 2013-04-11 23:32:14.651841</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;此处省略......</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp;1350515 | &nbsp;10000010 | 2013-04-11 16:49:11.348698</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp;1323334 | &nbsp;10000043 | 2013-04-11 16:49:10.053747</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; 628804 | &nbsp;10000087 | 2013-04-11 16:48:36.021167</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; 407184 | &nbsp;10000026 | 2013-04-11 16:47:32.296035</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; 299771 | &nbsp;10000065 | 2013-04-11 16:44:27.968158</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; 224439 | &nbsp;10000086 | 2013-04-11 16:44:23.94885</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp;65973 | &nbsp;10000068 | 2013-04-11 16:42:01.920676</font></div><div style="line-height: 22px;"   ><font size="2"   >(587 rows)</font></div><div style="line-height: 22px;"   ><font size="2"   >Time: 10.788 ms</font></div><p></p></pre></div></div></div><div><br></div><div># 继续生成测试数据, 使用最开始的方法生成随机数据, 确保索引列的数据随机. 具备真实性.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-33-&gt; jobs</font></div><div><font size="2"   >[1]- &nbsp;Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nohup pgbench -M prepared -r -c 8 -f ./insert.sql -j 8 -n -t 1500000000 -h 172.16.3.150 -p 1919 -U postgres postgres &gt;&gt; ./bench.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >[2]+ &nbsp;Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nohup pgbench -M prepared -r -c 8 -f ./insert.sql -j 8 -n -t 1500000000 -h 172.16.3.150 -p 1919 -U postgres postgres &gt;&gt; ./bench.log 2&gt;&amp;1 &amp;</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 执行以上数据插入程序, 当单表数据量增加到3.75亿左右再测试导入性能. 以及查询性能.&nbsp;</span></div><div><div style="line-height: 22px;"   ># 目前表的大小以及包含索引后的大小. (单表35GB, 包含索引后81GB)</div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >postgres=# select pg_relation_size('t_log_nat')/1024/1024/1024;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;?column?&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >----------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;35</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >postgres=# select pg_total_relation_size('t_log_nat')/1024/1024/1024;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;?column?&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >----------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;81</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div></div></pre></div></div></div><div># 数据量到达3.75亿后, 再次测试<span style="line-height: 22px;"   >导入</span></div><div><span style="line-height: 22px;"   ># 当前数据</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >postgres=# select count(*) from t_log_nat;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp;count &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >-----------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;362575684</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="line-height: 22px;"   ># 导入测试</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; date;pgbench -M prepared -r -n -f ./copy.sql -c 16 -j 8 -T 60 -h $PGDATA -p 1919 -U postgres postgres;date;</font></div><div><font size="2"   >Fri Apr 12 08:09:13 CST 2013</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 16</font></div><div><font size="2"   >tps = 0.051573 (including connections establishing)</font></div><div><font size="2"   >tps = 0.051574 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 39345.002125 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat1.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 38809.249500 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat2.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 37935.941000 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat3.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 39468.084250 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat4.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 39687.854188 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat5.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 36542.220000 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat6.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 38437.234875 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat7.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 39990.318500 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat8.dmp';</font></div><div><font size="2"   >Fri Apr 12 08:14:23 CST 2013</font></div><p></p></pre></div></div><div># 导入完后数据量</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select count(*) from t_log_nat;</font></div><div><font size="2"   >&nbsp; &nbsp;count &nbsp;&nbsp;</font></div><div><font size="2"   >-----------</font></div><div><font size="2"   >&nbsp;375367380</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select 362575684-375367380;</font></div><div><font size="2"   >&nbsp;?column? &nbsp;</font></div><div><font size="2"   >-----------</font></div><div><font size="2"   >&nbsp;-12791696</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div># 导入速度和之前差别不大 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select 12791696/310.0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------------</font></div><div><font size="2"   >&nbsp;41263.535483870968</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div><span style="line-height: 22px;"   ># 调整sequence cache, 理论上可以减少cpu耗费.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from t_log_nat_id_seq ;</font></div><div><font size="2"   >&nbsp; sequence_name &nbsp; | last_value | start_value | increment_by | &nbsp; &nbsp; &nbsp;max_value &nbsp; &nbsp; &nbsp;| min_value | cache_value | log_cnt | is_cycled |&nbsp;</font></div><div><font size="2"   >is_called&nbsp;</font></div><div><font size="2"   >------------------+------------+-------------+--------------+---------------------+-----------+-------------+---------+-----------+-</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;t_log_nat_id_seq | &nbsp;375567272 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | 9223372036854775807 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp;19 | f &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >t</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# alter sequence t_log_nat_id_seq cache 100000;</font></div><div><font size="2"   >ALTER SEQUENCE</font></div><p></p></pre></div><div># 继续测试导入</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; date;pgbench -M prepared -r -n -f ./copy.sql -c 16 -j 8 -T 60 -h $PGDATA -p 1919 -U postgres postgres;date;</font></div><div><font size="2"   >Fri Apr 12 08:25:09 CST 2013</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 16</font></div><div><font size="2"   >tps = 0.050657 (including connections establishing)</font></div><div><font size="2"   >tps = 0.050658 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 39354.917500 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat1.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 39780.023062 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat2.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 39446.035125 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat3.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 38788.305625 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat4.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 40780.025938 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat5.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 37838.100688 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat6.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 37923.570437 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat7.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 41910.572875 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat8.dmp';</font></div><div><font size="2"   >Fri Apr 12 08:30:24 CST 2013</font></div><p></p></pre></div><div># 导入结束后数据量</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select count(*) from t_log_nat;</font></div><div><font size="2"   >&nbsp; &nbsp;count &nbsp;&nbsp;</font></div><div><font size="2"   >-----------</font></div><div><font size="2"   >&nbsp;388358954</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div># 导入速度<span style="line-height: 22px;"   >41243每秒.</span></div><div><pre class="prettyprint"   ><p><font size="2"   ><span style="line-height: 22px;"   >(</span><span style="line-height: 22px;"   >388358954</span><span style="line-height: 22px;"   >-375367380</span><span style="line-height: 22px;"   >)/315 =&nbsp;</span>41243 ;</font></p></pre></div><div># 导入过程中测试查询速度是否受到影响, 同样使用1亿数据时的SQL, 查询耗费5毫秒.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# explain select count(*) from (select id,device_id,create_time from t_log_nat where device_id&gt;=10000000 and device_id&lt;10000100 order by create_time desc) t;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Aggregate &nbsp;(cost=2114.99..2115.00 rows=1 width=0)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=2086.16..2090.97 rows=1922 width=20)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: t_log_nat.create_time</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using idx_t_log_nat_3 on t_log_nat &nbsp;(cost=0.00..1981.33 rows=1922 width=20)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: ((device_id &gt;= 10000000) AND (device_id &lt; 10000100))</font></div><div><font size="2"   >(5 rows)</font></div></div><div><div><font size="2"   >postgres=# select count(*) from (select id,device_id,create_time from t_log_nat where device_id&gt;=10000000 and device_id&lt;10000100 order by create_time desc) t;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; 1906</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 5.327 ms</font></div></div><p></p></pre></div><div># 查询20W记录耗时225毫秒</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select count(*) from (select id,device_id,create_time from t_log_nat where device_id&gt;=10000000 and device_id&lt;10010000 ) t;</font></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;199677</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 225.151 ms</font></div></div><div><div><font size="2"   >postgres=# explain select count(*) from (select id,device_id,create_time from t_log_nat where device_id&gt;=10000000 and device_id&lt;10010000 ) t;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Aggregate &nbsp;(cost=197129.56..197129.57 rows=1 width=0)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Index Only Scan using idx_t_log_nat_3 on t_log_nat &nbsp;(cost=0.00..196639.92 rows=195855 width=0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: ((device_id &gt;= 10000000) AND (device_id &lt; 10010000))</font></div><div><font size="2"   >(3 rows)</font></div><div><font size="2"   >Time: 0.622 ms</font></div></div><p></p></pre></div><div># 20W数据中, 进行数据翻页, 最短耗时1毫秒(首页), 最长耗时338毫秒(末尾页).</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# explain select count(*) from (select id,device_id,create_time from t_log_nat where device_id&gt;=10000000 and device_id&lt;10010000 order by device_id limit 100 offset 100000) t;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Aggregate &nbsp;(cost=100502.93..100502.94 rows=1 width=0)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Limit &nbsp;(cost=100401.28..100501.68 rows=100 width=20)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using idx_t_log_nat_3 on t_log_nat &nbsp;(cost=0.00..198393.92 rows=197601 width=20)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: ((device_id &gt;= 10000000) AND (device_id &lt; 10010000))</font></div><div><font size="2"   >(4 rows)</font></div></div><div><div><font size="2"   >postgres=# select count(*) from (select id,device_id,create_time from t_log_nat where device_id&gt;=10000000 and device_id&lt;10010000 order by device_id limit 100 offset 0) t;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp;100</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 1.052 ms</font></div></div><div><div><font size="2"   >postgres=# select count(*) from (select id,device_id,create_time from t_log_nat where device_id&gt;=10000000 and device_id&lt;10010000 order by device_id limit 100 offset 199577) t;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp;100</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 338.059 ms</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 提高导入并行度, 以上两次并行度都是CPU核的2倍, 也就是16个并发.</span></div><div># 提高到32个并发, 继续测试性能, 注意并行导入时, 可能遇到数据块扩展瓶颈, 建议使用32K的postgresql block size.</div><div># 参考</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201392641033482"   >http://blog.163.com/digoal@126/blog/static/163877040201392641033482</a></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; date;pgbench -M prepared -r -n -f ./copy.sql -c 32 -j 8 -T 60 -h $PGDATA -p 1919 -U postgres postgres;date;</font></div><div><font size="2"   >Fri Apr 12 09:03:52 CST 2013</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 32</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 32</font></div><div><font size="2"   >tps = 0.051920 (including connections establishing)</font></div><div><font size="2"   >tps = 0.051921 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 79397.675656 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat1.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 76724.902563 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat2.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 79072.056687 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat3.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 75542.704563 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat4.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 75984.743844 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat5.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 78727.274625 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat6.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 75262.292875 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat7.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 75554.252875 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat8.dmp';</font></div><div><font size="2"   >Fri Apr 12 09:14:09 CST 2013</font></div><p></p></pre></div><div>速度 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select max(id) from t_log_nat;</font></div><div><font size="2"   >&nbsp; &nbsp; max &nbsp; &nbsp;</font></div><div><font size="2"   >-----------</font></div><div><font size="2"   >&nbsp;401166753</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 0.860 ms</font></div></div><div><div><font size="2"   >postgres=# select max(id) from t_log_nat;</font></div><div><font size="2"   >&nbsp; &nbsp; max &nbsp; &nbsp;</font></div><div><font size="2"   >-----------</font></div><div><font size="2"   >&nbsp;426766753</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select (426766753-401166753)/617.0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------------</font></div><div><font size="2"   >&nbsp;41491.085899513776</font></div><div><font size="2"   >(1 row)</font></div></div></pre></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   ># 单表数据量到达7亿后, 单表大小70GB, 加上索引共计170GB.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; | Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp; &nbsp;Size &nbsp; &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+-----------------+-------+----------+------------+-------------</font></div><div><font size="2"   >&nbsp;public | t_log_nat &nbsp; &nbsp; &nbsp; | table | postgres | 70 GB &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 索引的分别大小</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; | Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp; &nbsp;Table &nbsp; &nbsp; | &nbsp;Size &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+-----------------+-------+----------+--------------+--------+-------------</font></div><div><font size="2"   >&nbsp;public | idx_t_log_nat_1 | index | postgres | t_log_nat &nbsp; &nbsp;| 21 GB &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | idx_t_log_nat_2 | index | postgres | t_log_nat &nbsp; &nbsp;| 21 GB &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | idx_t_log_nat_3 | index | postgres | t_log_nat &nbsp; &nbsp;| 21 GB &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | idx_t_log_nat_4 | index | postgres | t_log_nat &nbsp; &nbsp;| 16 GB &nbsp;|&nbsp;</font></div></div><div><font size="2"   >&nbsp;public | t_log_nat_pkey &nbsp;| index | postgres | t_log_nat &nbsp; &nbsp;| 22 GB &nbsp;|&nbsp;</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 再次测试导入, 同时测试导入数据的同时进行查询.</span></div><div><span style="line-height: 22px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; date;pgbench -M prepared -r -n -f ./copy.sql -c 16 -j 4 -t 20 -h $PGDATA -p 1919 -U postgres postgres;date;</font></div><div><font size="2"   >Fri Apr 12 10:47:36 CST 2013</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >number of transactions per client: 20</font></div><div><font size="2"   >number of transactions actually processed: 320/320</font></div><div><font size="2"   >tps = 0.048879 (including connections establishing)</font></div><div><font size="2"   >tps = 0.048879 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 41356.507434 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat1.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 41133.114569 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat2.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 40853.623953 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat3.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 40862.861253 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat4.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 40688.835200 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat5.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 40615.129241 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat6.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 40779.250894 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat7.dmp';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 41009.791787 &nbsp; &nbsp;copy t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id) from '/data01/pg92/t_log_nat8.dmp';</font></div><div><font size="2"   >Fri Apr 12 12:36:43 CST 2013</font></div><p></p></pre></div><div># 每个文件80W记录, 计算出导入速率&nbsp;39101每秒.</div><div><br></div><div># 查询效率</div></span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# explain select count(*) from (select id,device_id,create_time from t_log_nat where device_id&gt;=10000000 and device_id&lt;10010000 ) t;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Aggregate &nbsp;(cost=367419.89..367419.90 rows=1 width=0)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Index Only Scan using idx_t_log_nat_3 on t_log_nat &nbsp;(cost=0.00..366507.41 rows=364994 width=0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: ((device_id &gt;= 10000000) AND (device_id &lt; 10010000))</font></div><div><font size="2"   >(3 rows)</font></div><div><font size="2"   >postgres=# select count(*) from (select id,device_id,create_time from t_log_nat where device_id&gt;=10000000 and device_id&lt;10010000 ) t;</font></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;383507</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 501.402 ms</font></div></div><div><font size="2"   ><br></font></div><div><span style="line-height: 22px;"   ><font size="2"   ><div>postgres=# explain select count(*) from (select id,device_id,create_time from t_log_nat where device_id&gt;=10000000 and device_id&lt;10000100 order by create_time desc) t;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>----------------------------------------------------------------------------------------------------</div><div>&nbsp;Aggregate &nbsp;(cost=4040.51..4040.52 rows=1 width=0)</div><div>&nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=3985.69..3994.82 rows=3655 width=20)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: t_log_nat.create_time</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using idx_t_log_nat_3 on t_log_nat &nbsp;(cost=0.00..3769.39 rows=3655 width=20)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: ((device_id &gt;= 10000000) AND (device_id &lt; 10000100))</div><div>(5 rows)</div></font></span></div><div><div><font size="2"   >postgres=# select count(*) from (select id,device_id,create_time from t_log_nat where device_id&gt;=10000000 and device_id&lt;10000100 order by create_time desc) t;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; 3644</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 9.860 ms</font></div></div><div><span style="line-height: 22px;"   ><font size="2"   ><br></font></span></div><div><span style="line-height: 22px;"   ><font size="2"   ><div>postgres=# explain select count(*) from (select id,device_id,create_time from t_log_nat where device_id&gt;=10000000 and device_id&lt;10010000 order by device_id limit 100 offset 100000) t;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>--------------------------------------------------------------------------------------------------------</div><div>&nbsp;Aggregate &nbsp;(cost=100516.44..100516.45 rows=1 width=0)</div><div>&nbsp; &nbsp;-&gt; &nbsp;Limit &nbsp;(cost=100414.77..100515.19 rows=100 width=20)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using idx_t_log_nat_3 on t_log_nat &nbsp;(cost=0.00..367360.42 rows=365843 width=20)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: ((device_id &gt;= 10000000) AND (device_id &lt; 10010000))</div><div>(4 rows)</div></font></span></div><div><div><font size="2"   >postgres=# select count(*) from (select id,device_id,create_time from t_log_nat where device_id&gt;=10000000 and device_id&lt;10010000 order by device_id limit 100 offset 0) t;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp;100</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 0.888 ms</font></div></div><div><div><font size="2"   >postgres=# select count(*) from (select id,device_id,create_time from t_log_nat where device_id&gt;=10000000 and device_id&lt;10010000 order by device_id limit 100 offset 199577) t;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp;100</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 393.783 ms</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >[小结]</span></div><div>1. 从iostat来看, pg_xlog磁盘的util维持在15%, table<span style="line-height: 22px;"   >磁盘的util维持在1%, 偶尔到达60% index</span><span style="line-height: 22px;"   >磁盘的util维持在5%, 偶尔到达100%. (io异步,所以不影响导入)</span><span style="line-height: 22px;"   >整个测试过程, 瓶颈在cpu.&nbsp;</span></div><div><span style="line-height: 22px;"   >(如果增加CPU能力, 同上可以达到导入速度的目的. ) 如果瓶颈在数据块的扩展上, 增加并行度没有提升效果, 唯有提高单个数据块的大小, PostgreSQL支持的最大block size 32KB.</span></div><div><span style="line-height: 22px;"   >参考 :&nbsp;</span></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201392641033482"   >http://blog.163.com/digoal@126/blog/static/163877040201392641033482</a></div><div><br></div><div><span style="line-height: 22px;"   >2. 数据load过程不影响查询, 这是肯定的, 因为COPY是</span>RowExclusiveLock锁, 查询是AccessShareLock, 两种锁不冲突.</div><div>3. 对于本例的场景, t_log_nat表的autovacuum可以选择关闭或者不关闭的情况下调大autovacuum_vacuum_scale_factor, autovacuum_analyze_scale_factor 减少扫描次数.&nbsp;</div><div>&nbsp; &nbsp;调大autovacuum_freeze_max_age, autovacuum_freeze_table_age, 例如调整到最大10亿, (默认是2亿, 1.5亿). (减少freeze操作扫全表的几率)</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# alter table t_log_nat set (autovacuum_vacuum_scale_factor=0.8, autovacuum_analyze_scale_factor=0.8, autovacuum_freeze_max_age=1000000000, autovacuum_freeze_table_age=1000000000);</font></div><div><font size="2"   >ALTER TABLE</font></div></div><div><div><font size="2"   >postgres=# \d+ t_log_nat</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Table "public.t_log_nat"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;Column &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Modifiers &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Storage | Stats target | D</font></div><div><font size="2"   >escription&nbsp;</font></div><div><font size="2"   >-----------------+-----------------------------+--------------------------------------------------------+---------+--------------+--</font></div><div><font size="2"   >-----------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null default nextval('t_log_nat_id_seq'::regclass) | plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;device_id &nbsp; &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;src_ip &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;src_transfer_ip | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;dst_ip &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;src_port &nbsp; &nbsp; &nbsp; &nbsp;| smallint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;dst_port &nbsp; &nbsp; &nbsp; &nbsp;| smallint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;transfer_port &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| smallint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;ip_version &nbsp; &nbsp; &nbsp;| smallint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| default 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;protocol_id &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;rule_id &nbsp; &nbsp; &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;create_time &nbsp; &nbsp; | timestamp without time zone | not null default clock_timestamp() &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "t_log_nat_pkey" PRIMARY KEY, btree (id), tablespace "tbs_pg92"</font></div><div><font size="2"   >&nbsp; &nbsp; "idx_t_log_nat_1" btree (src_ip), tablespace "tbs_pg92"</font></div><div><font size="2"   >&nbsp; &nbsp; "idx_t_log_nat_2" btree (dst_ip), tablespace "tbs_pg92"</font></div><div><font size="2"   >&nbsp; &nbsp; "idx_t_log_nat_3" btree (device_id), tablespace "tbs_pg92"</font></div><div><font size="2"   >&nbsp; &nbsp; "idx_t_log_nat_4" btree (create_time), tablespace "tbs_pg92"</font></div><div><font size="2"   >Has OIDs: no</font></div><div><font size="2"   >Options: autovacuum_vacuum_scale_factor=0.8, autovacuum_analyze_scale_factor=0.8, autovacuum_freeze_max_age=1000000000, autovacuum_f</font></div><div><font size="2"   >reeze_table_age=1000000000</font></div></div><p></p></pre></div><div>4. 表分区的建议, 如果按照时间以及device_id为查询条件的查询较多, 那么可以第一层按照device_id hash分区, 第二层按照时间分区.</div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201092805732741/"   >http://blog.163.com/digoal@126/blog/static/163877040201092805732741/</a></div><div>2.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020109276295217/"   >http://blog.163.com/digoal@126/blog/static/16387704020109276295217/</a></div><div>3.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020125421816584/"   >http://blog.163.com/digoal@126/blog/static/16387704020125421816584/</a></div><div>4.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201242331551545/"   >http://blog.163.com/digoal@126/blog/static/163877040201242331551545/</a></div>5.&nbsp;<div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ># 插入数据的函数2, 任意类型参数. 方便插入脚本使用.</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 22px;"   ><font size="2"   >drop function insert_t_log_nat(anyelement,anyelement,anyelement,anyelement,anyelement,anyelement,anyelement,anyelement,anyelement,anyelement,anyelement);</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >create or replace function insert_t_log_nat</font></div><div style="line-height: 22px;"   ><font size="2"   >(i_device_id anyelement,&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >i_src_ip anyelement,&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >i_src_transfer_ip anyelement,&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >i_dst_ip anyelement,&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >i_src_port anyelement,&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >i_dst_port anyelement,&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >i_transfer_port anyelement,&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >i_type anyelement,</font></div><div style="line-height: 22px;"   ><font size="2"   >i_ip_version anyelement,</font></div><div style="line-height: 22px;"   ><font size="2"   >i_protocol_id anyelement,</font></div><div style="line-height: 22px;"   ><font size="2"   >i_rule_id anyelement</font></div><div style="line-height: 22px;"   ><font size="2"   >)&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >returns void as $$</font></div><div style="line-height: 22px;"   ><font size="2"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; insert into t_log_nat (device_id,src_ip,src_transfer_ip,dst_ip,src_port,dst_port,transfer_port,type,ip_version,protocol_id,rule_id)</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; values</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; (i_device_id ,&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >i_src_ip ,&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >i_src_transfer_ip ,&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >i_dst_ip ,&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >i_src_port ,&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >i_dst_port ,&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >i_transfer_port ,&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >i_type ,</font></div><div style="line-height: 22px;"   ><font size="2"   >i_ip_version ,</font></div><div style="line-height: 22px;"   ><font size="2"   >i_protocol_id ,</font></div><div style="line-height: 22px;"   ><font size="2"   >i_rule_id&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >) ;</font></div><div style="line-height: 22px;"   ><font size="2"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   >$$ language plpgsql;</font></div></div><div style="line-height: 22px;"   ><font size="2"   ># 这里插入可以不需要指定类型了, 在insert时会固化类型</font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >\setrandom i_device_id 1 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom i_src_ip 1 2000000000</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom i_dst_ip 1 2000000000</font></div><div style="line-height: 22px;"   ><font size="2"   >select insert_t_log_nat(:i_device_id,:i_src_ip,:i_src_ip,:i_dst_ip,1,1,1,0,0,1,1);</font></div></div><p></p></pre></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >6.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/sql-createtable.html#SQL-CREATETABLE-STORAGE-PARAMETERS"   >http://www.postgresql.org/docs/9.2/static/sql-createtable.html#SQL-CREATETABLE-STORAGE-PARAMETERS</a></div></div></div>
	</div>
</div>
</body>
</html>