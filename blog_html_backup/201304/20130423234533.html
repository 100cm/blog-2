<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL array's head or tail ordering match case - 1</h2>
	<h5 id="">2013-04-23 23:45:33&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013323103719510/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>本文主要讲解一下数组的匹配案例, 例如 :&nbsp;</div><div>[1,2,3,4,5] 包含 [1,2,3] 返回真.</div><div>[1,2,3,4,5] 包含 [2,1,3] 返回假.</div><div>也就是需要按从头开始的顺序进行匹配.</div><div>最简单的做法就是转换成text类型进行匹配.</div><div>例如 :&nbsp;</div><div>'{1,2,3,4,5}' ~ E'^\\{1,2,3'.</div><div><br></div><div><div>【具体方法如下 : 】</div><div>-- 创建测试表</div><div><pre class="prettyprint"   ><p><font size="2"   >digoal=# create table t(id int[]);</font></p></pre></div><div>-- 创建数组转text的immutable函数, 用于函数索引.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create or replace function intarray_to_text(int[]) returns text as $$</font></div><div><font size="2"   >&nbsp; &nbsp;select textin(array_out($1));</font></div><div><font size="2"   >&nbsp;$$ language sql strict immutable;</font></div><p></p></pre></div><div>-- 创建索引</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create index idx_t_1 on t(intarray_to_text(id));</font></div><div><font size="2"   >digoal=# create index idx_t_2 on t(array_length(id,1));</font></div><p></p></pre></div><div>-- 插入测试数据</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into t select array[round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000),round(random()*100000)] from generate_series(1,1000000);</font></div><div><font size="2"   >Time: 86062.617 ms</font></div><p></p></pre></div><div>-- 每秒约插入11619 .&nbsp;</div><div>-- 查询</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from t limit 1;</font></div><div><font size="2"   >{40241,86365,43946,48807,99558,11987,82836,24504,97856,62515,14241,81148,65980,35811,5017,88976,51379,76457,42701,34981,93450,72379</font></div><div><font size="2"   >,8785,38390,51686,8603,18504,54890,42702,50231,49994,82943,36596,93940,31749,36154,5927,14585,60659,3783,77100,74900,84932,43080,107</font></div><div><font size="2"   >11,89949,32056,62090,66405,74757,97071,59856,47136,5856,98246,98822,14459,16750,53712,57161,66981,3705,40103,3577,97645,71853,39732,</font></div><div><font size="2"   >3572,86438,390,7355,63538,75290,92287,6618,86001,82236,38675,48091,48641,13432,45162,8497,60568,51018,6743,59390,65476,23493,13102,2</font></div><div><font size="2"   >2637,90474,16807,62740,94051,14452,34593,33783}</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >-- 索引检索, 前10个元素匹配, 速度还行.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain analyze select * from t where intarray_to_text(id) ~ E'^\\{40241,86365,43946,48807,99558,11987,82836,24504,97856,62515,';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >--------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using idx_t_1 on t &nbsp;(cost=0.50..7.66 rows=100 width=416) (actual time=0.120..0.122 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: ((intarray_to_text(id) &gt;= '{40241,86365,43946,48807,99558,11987,82836,24504,97856,62515,'::text) AND (intarray_to_tex</font></div><div><font size="2"   >t(id) &lt; '{40241,86365,43946,48807,99558,11987,82836,24504,97856,62515-'::text))</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (intarray_to_text(id) ~ '^\\{40241,86365,43946,48807,99558,11987,82836,24504,97856,62515,'::text)</font></div><div><font size="2"   >&nbsp;Total runtime: 0.145 ms</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   >Time: 1.695 ms</font></div><p></p></pre></div></div><div><br></div><div>【intarray extension】</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/intarray.html"   >http://www.postgresql.org/docs/9.2/static/intarray.html</a></div><div>intarray扩展了int数组的操作符, 函数等. 例如支持元素排序等.&nbsp;</div><div>当然使用array_agg(i order by i) from unnest(array) g(i) 也可以排序.</div><div><div style="font-family: verdana, sans-serif; line-height: normal;"   ><p style="line-height: 1.5em; margin: 1.2em 0em; font-weight: bold;"   ><font size="2"   >Table F-8.&nbsp;<tt>intarray</tt>&nbsp;Functions</font></p><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; background-color: rgb(224, 236, 239); border: 2px solid rgb(167, 198, 223);"   ><colgroup><col><col><col><col><col><thead><tr><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   ><font size="2"   >Function</font></th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   ><font size="2"   >Return Type</font></th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   ><font size="2"   >Description</font></th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   ><font size="2"   >Example</font></th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   ><font size="2"   >Result</font></th></tr></thead><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><code><font size="2"   >icount(int[])</font></code></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >number of elements in array</font></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >icount('{1,2,3}'::int[])</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >3</font></tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><code><font size="2"   >sort(int[], text dir)</font></code></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >sort array ―&nbsp;<tt>dir</tt>&nbsp;must be&nbsp;<tt>asc</tt>&nbsp;or&nbsp;<tt>desc</tt></font></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >sort('{1,2,3}'::int[], 'desc')</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >{3,2,1}</font></tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><code><font size="2"   >sort(int[])</font></code></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >sort in ascending order</font></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >sort(array[11,77,44])</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >{11,44,77}</font></tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><code><font size="2"   >sort_asc(int[])</font></code></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >sort in ascending order</font></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><code><font size="2"   >sort_desc(int[])</font></code></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >sort in descending order</font></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><code><font size="2"   >uniq(int[])</font></code></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >remove adjacent duplicates</font></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >uniq(sort('{1,2,3,2,1}'::int[]))</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >{1,2,3}</font></tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><code><font size="2"   >idx(int[], int item)</font></code></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >index of first element matching&nbsp;<tt>item</tt>&nbsp;(0 if none)</font></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >idx(array[11,22,33,22,11], 22)</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >2</font></tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><code><font size="2"   >subarray(int[], int start, int len)</font></code></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >portion of array starting at position&nbsp;<tt>start</tt>,&nbsp;<tt>len</tt>&nbsp;elements</font></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >subarray('{1,2,3,2,1}'::int[], 2, 3)</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >{2,3,2}</font></tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><code><font size="2"   >subarray(int[], int start)</font></code></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >portion of array starting at position&nbsp;<tt>start</tt></font></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >subarray('{1,2,3,2,1}'::int[], 2)</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >{2,3,2,1}</font></tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><code><font size="2"   >intset(int)</font></code></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >make single-element array</font></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >intset(42)</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >{42}</font></tt></td></tr></table></div><div style="font-family: verdana, sans-serif; font-size: 13.333333969116211px; line-height: normal;"   ><font size="2"   ><a id="INTARRAY-OP-TABLE" name="INTARRAY-OP-TABLE" rel="nofollow"   ></a></font><p style="line-height: 1.5em; margin: 1.2em 0em; font-weight: bold;"   ><font size="2"   >Table F-9.&nbsp;<tt>intarray</tt>&nbsp;Operators</font></p><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; background-color: rgb(224, 236, 239); border: 2px solid rgb(167, 198, 223);"   ><colgroup><col><col><col><thead><tr><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   ><font size="2"   >Operator</font></th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   ><font size="2"   >Returns</font></th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   ><font size="2"   >Description</font></th></tr></thead><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[] &amp;&amp; int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >boolean</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >overlap ―&nbsp;<tt>true</tt>&nbsp;if arrays have at least one common element</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[] @&gt; int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >boolean</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >contains ―&nbsp;<tt>true</tt>&nbsp;if left array contains right array</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[] &lt;@ int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >boolean</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >contained ―&nbsp;<tt>true</tt>&nbsp;if left array is contained in right array</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   ># int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >number of elements in array</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[] # int</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >index (same as&nbsp;<code>idx</code>&nbsp;function)</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[] + int</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >push element onto array (add it to end of array)</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[] + int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >array concatenation (right array added to the end of left one)</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[] - int</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >remove entries matching right argument from array</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[] - int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >remove elements of right array from left</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[] | int</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >union of arguments</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[] | int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >union of arrays</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[] &amp; int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >intersection of arrays</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >int[] @@ query_int</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >boolean</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   ><tt>true</tt>&nbsp;if array satisfies query (see below)</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   ><tt><font size="2"   >query_int ~~ int[]</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   ><tt><font size="2"   >boolean</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   ><font size="2"   ><tt>true</tt>&nbsp;if array satisfies query (commutator of&nbsp;<tt>@@</tt>)</font></td></tr></table></div></div><div><br></div><div>【text 类型】</div><div>因为本例没有用到数组的其他特性, 所以可以使用text类型来替代id字段.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# create table t1 (id text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# insert into t1 select id::text from t;</font></div></div><div><font size="2"   >INSERT 0 1000000</font></div><div><div><font size="2"   >postgres=# create index idx_t1_1 on t1(id);</font></div><div><font size="2"   >CREATE INDEX</font></div></div><div><font size="2"   >postgres=# create index idx_t1_2 on t1(array_length(regexp_split_to_array(id,','),1));</font></div><div><font size="2"   >-- SIZE</font></div><div><div><font size="2"   >postgres=# \dt+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | Name | Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp;Size &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+------+-------+----------+--------+-------------</font></div><div><font size="2"   >&nbsp;public | t &nbsp; &nbsp;| table | postgres | 434 MB |&nbsp;</font></div><div><font size="2"   >&nbsp;public | t1 &nbsp; | table | postgres | 601 MB |&nbsp;</font></div><div><font size="2"   >(2 rows)</font></div></div><div><div><font size="2"   >postgres=# \di+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; Name &nbsp; | Type &nbsp;| &nbsp;Owner &nbsp; | Table | &nbsp;Size &nbsp; | Description&nbsp;</font></div><div><font size="2"   >--------+----------+-------+----------+-------+---------+-------------</font></div><div><font size="2"   >&nbsp;public | idx_t1_1 | index | postgres | t1 &nbsp; &nbsp;| 723 MB &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | idx_t_1 &nbsp;| index | postgres | t &nbsp; &nbsp; | 1031 MB |&nbsp;</font></div><div><font size="2"   >&nbsp;public | idx_t_2 &nbsp;| index | postgres | t &nbsp; &nbsp; | 27 MB &nbsp; |&nbsp;</font></div><div><font size="2"   >(3 rows)</font></div></div><p></p></pre></div><div>-- 查询效率</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# explain analyze select * from t1 where id ~ E'^\\{40241,86365,43946,48807,99558,11987,82836,24504,97856,62515,';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >--------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Only Scan using idx_t1_1 on t1 &nbsp;(cost=0.00..6.12 rows=100 width=582) (actual time=0.031..0.032 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: ((id &gt;= '{40241,86365,43946,48807,99558,11987,82836,24504,97856,62515,'::text) AND (id &lt; '{40241,86365,43946,48807,99</font></div><div><font size="2"   >558,11987,82836,24504,97856,62515-'::text))</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (id ~ '^\\{40241,86365,43946,48807,99558,11987,82836,24504,97856,62515,'::text)</font></div><div><font size="2"   >&nbsp; &nbsp;Heap Fetches: 1</font></div><div><font size="2"   >&nbsp;Total runtime: 0.040 ms</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div><div>-- 使用text查询耗时更短, 因为不需要运算intarray_to_text, 如果查询并发高的话, 可以考虑使用text替代前面的int array.</div><div><br></div><div>【其他】</div><div>1. 如果是数组的中间部分顺序匹配, 例如 :&nbsp;</div><div>[1,2,3,4,5] @&gt; [2,3,4]</div><div>这种查询如果一定要在数据库中大量进行, 那么建议使用gist索引, 先查出包含后, 然后进行顺序匹配过滤.</div><div><br></div><div>2. 索引字段长度不要超过8191</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into t select arr from (select array_agg(i) AS arr from (select round(random()*1000000) AS i from generate_series(1,10000)) t) t;</font></div><div><font size="2"   >ERROR: &nbsp;54000: index row requires 50656 bytes, maximum size is 8191</font></div><div><font size="2"   >LOCATION: &nbsp;index_form_tuple, indextuple.c:170</font></div><p></p></pre></div><div>-- 如下</div></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >src/backend/access/common/indextuple.c</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   ><div>&nbsp; &nbsp; &nbsp; &nbsp; if ((size &amp; INDEX_SIZE_MASK) != size)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_PROGRAM_LIMIT_EXCEEDED),</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("index row requires %lu bytes, maximum size is %lu",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (unsigned long) size,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (unsigned long) INDEX_SIZE_MASK)));</div></font></span></div><div><font size="2"   >src/include/access/itup.h</font></div><div><font size="2"   >#define INDEX_SIZE_MASK &nbsp; 0x1FFF</font></div><p></p></pre></div><div><br></div>【参考】<wbr><div><div>1. A case, choose array , hstore or text type, or split column</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020120453516936/"   >http://blog.163.com/digoal@126/blog/static/16387704020120453516936/</a></div><div>2. PostgreSQL row , record , composite , table type used in array and prepared statement case</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020132695425525/"   >http://blog.163.com/digoal@126/blog/static/16387704020132695425525/</a></div><div>3. PostgreSQL varbit type used case : railway | train ticket sales</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201302092558484/"   >http://blog.163.com/digoal@126/blog/static/163877040201302092558484/</a></div><div>4. PostgreSQL large row|column performance tuning case</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020130931040444/"   >http://blog.163.com/digoal@126/blog/static/16387704020130931040444/</a></div><div>5. PostgreSQL array subscript out of range error explain</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201201272718196/"   >http://blog.163.com/digoal@126/blog/static/163877040201201272718196/</a></div><div>6. PostgreSQL 9.2 add array elements statistics</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020124180182088/"   >http://blog.163.com/digoal@126/blog/static/16387704020124180182088/</a></div><div>7. PostgreSQL ADD atomic array_replace and array_remove element value(s) from ARRAY</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201261273149437/"   >http://blog.163.com/digoal@126/blog/static/163877040201261273149437/</a></div><div>8. PostgreSQL file text array fdw used for unpredictable columns of text file</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201302410511382/"   >http://blog.163.com/digoal@126/blog/static/163877040201302410511382/</a></div><div>9. PostgreSQL ARRAY datatype introduce</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201201275922529/"   >http://blog.163.com/digoal@126/blog/static/163877040201201275922529/</a></div><div>10. PostgreSQL array compare and array element's sort</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020130682522480/"   >http://blog.163.com/digoal@126/blog/static/16387704020130682522480/</a></div><div>11. PostgreSQL Function to return the intersection of 2 ARRAYs</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013030104627983/"   >http://blog.163.com/digoal@126/blog/static/1638770402013030104627983/</a></div></div></div>
	</div>
</div>
</body>
</html>