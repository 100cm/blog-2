<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL real-time count(*) performance tuning case - 1</h2>
	<h5 id="">2013-04-13 18:47:22&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201331252945440/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">PostgreSQL 的count确实是一大软肋, 特别是全表的count.<div>在9.2以前全表的count只能通过扫描全表来得到, 即使有pk也必须扫描全表.</div><div>9.2版本增加了index only scan的功能, count(*)可以通过仅仅扫描pk就可以得到.</div><div>但是如果是一个比较大的表, pk也是很大的, 扫描pk也是个不小的开销.</div><div>那么有没有办法来优化count全表的操作呢, 如果你的场景真的有必要频繁的count全表, 那么可以尝试一下使用以下方法来优化你的场景.</div><div>其实非常简单, 就是给表建立几个触发器, 每次插入,删除,truncate表时触发, 将表的记录数更新到一个记录表中.</div><div>但是要知道, 这样会带来一个问题, 并发的插入和删除操作, 如果仅仅使用1条记录来存储表的count(*)值的话, 会有严重的锁冲突的问题.</div><div>例如两个session ,同时插入1条记录, 在触发触发器时, 由于都要更新count表的同一条记录, 那么会发生行锁等待.</div><div>因此, 可以使用多条记录来缓解行锁冲突的问题, 如下 :&nbsp;</div><div># 创建测试表, a, 假设要经常count(*) from a.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; psql</font></div><div><font size="2"   >psql (9.2.4)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# drop table a;</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >postgres=# create table a(id serial4 primary key, info text, crt_time timestamp(0) default now());</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE will create implicit sequence "a_id_seq" for serial column "a.id"</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "a_pkey" for table "a"</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div># 创建记录a表记录数的表</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create table cnt_a(id int primary key, cnt int);</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "cnt_a_pkey" for table "cnt_a"</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div># 为了缓解行锁冲突, 这里使用了1001条记录来存储count(*) from a的值.</div><div># 在计算count(*) a时, 使用sum(cnt) from cnt_a就可以了. 因此只需要扫描1001行.</div><div># 后面会看到当a表的记录数越多, 性能提升约明显.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into cnt_a select generate_series(0,1000),0;</font></div><div><font size="2"   >INSERT 0 1001</font></div><p></p></pre></div><div># 创建插入触发器函数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION public.tg_insert_a()</font></div><div><font size="2"   >&nbsp;RETURNS trigger</font></div><div><font size="2"   >&nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; m_id int;</font></div><div><font size="2"   >&nbsp; rm numeric;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select max(id),random() into m_id,rm from cnt_a;</font></div><div><font size="2"   >&nbsp; update cnt_a set cnt=cnt+1 where id=(rm*m_id)::int;</font></div><div><font size="2"   >&nbsp; return null;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div># 创建删除触发器函数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION public.tg_delete_a()</font></div><div><font size="2"   >&nbsp;RETURNS trigger</font></div><div><font size="2"   >&nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; m_id int;</font></div><div><font size="2"   >&nbsp; rm numeric;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select max(id),random() into m_id,rm from cnt_a;</font></div><div><font size="2"   >&nbsp; update cnt_a set cnt=cnt-1 where id=(rm*m_id)::int;</font></div><div><font size="2"   >&nbsp; return null;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div>#　创建truncate触发器函数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION public.tg_truncate_a()</font></div><div><font size="2"   >&nbsp;RETURNS trigger</font></div><div><font size="2"   >&nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; update cnt_a set cnt=0 where not cnt=0;</font></div><div><font size="2"   >&nbsp; return null;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div><br></div><div># 创建触发器</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create trigger tg1 after insert on a for each row execute procedure tg_insert_a();</font></div><div><font size="2"   >create trigger tg2 after delete on a for each row execute procedure tg_delete_a();</font></div><div><font size="2"   >create trigger tg3 after truncate on a for each statement execute procedure tg_truncate_a();</font></div><p></p></pre></div><div><br></div><div># 创建pgbench 使用的插入脚本</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; cat insert.sql&nbsp;</font></div><div><font size="2"   >insert into a (info) values ('test');</font></div><p></p></pre></div><div># pgbench做插入测试</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; pgbench -M prepared -r -n -f ./insert.sql -h $PGDATA -p 1919 -U postgres -T 60 -c 16 -j 4 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 1831418</font></div><div><font size="2"   >tps = 30514.831839 (including connections establishing)</font></div><div><font size="2"   >tps = 30522.057886 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.522411 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><p></p></pre></div><div># 测试完后通过count(*) 和sum(cnt)比对数据是否一致</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select count(*) from a;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1755964</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 285.491 ms</font></div><div><font size="2"   >postgres=# select sum(cnt) from cnt_a ;</font></div><div><font size="2"   >&nbsp; &nbsp;sum &nbsp;&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1755964</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 0.689 ms</font></div><p></p></pre></div><div># 性能提升非常明显.</div><div><br></div><div># 创建pgbench用于删除a表记录的测试脚本</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi delete.sql</font></div><div><font size="2"   >\setrandom id 1 1000000</font></div><div><font size="2"   >delete from a where id=:id;</font></div><p></p></pre></div><div># 进行测试</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; pgbench -M prepared -r -n -f ./delete.sql -h $PGDATA -p 1919 -U postgres -T 60 -c 16 -j 4 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 3353233</font></div><div><font size="2"   >tps = 55865.635772 (including connections establishing)</font></div><div><font size="2"   >tps = 55878.855793 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002594 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 1000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.282123 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><p></p></pre></div><div># 测试完删除操作后, 比对count(*)和sum(cnt)是否一致</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select count(*) from a;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;9687739</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 1550.239 ms</font></div><div><font size="2"   >postgres=# select sum(cnt) from cnt_a ;</font></div><div><font size="2"   >&nbsp; &nbsp;sum &nbsp;&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;9687739</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 0.817 ms</font></div><p></p></pre></div><div>当记录数到达千万级别后, 性能以及提升几千倍了.</div><div><br></div><div># 创建同时进行删除和插入操作的测试脚本</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi id.sql</font></div><div><font size="2"   >\setrandom id 1 20000000</font></div><div><font size="2"   >delete from a where id=:id;</font></div><div><font size="2"   >insert into a (info) values ('test');</font></div><p></p></pre></div><div># 测试</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; pgbench -M prepared -r -n -f ./id.sql -h $PGDATA -p 1919 -U postgres -T 60 -c 16 -j 4 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 1061090</font></div><div><font size="2"   >tps = 17680.045577 (including connections establishing)</font></div><div><font size="2"   >tps = 17684.251890 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003181 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 20000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.381986 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.516256 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><p></p></pre></div><div># 测试完后比对count(*)和sum(cnt)的结果是否一致</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select count(*) from a;</font></div><div><font size="2"   >&nbsp; count &nbsp;&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;10219555</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 1648.371 ms</font></div><div><font size="2"   >postgres=# select sum(cnt) from cnt_a ;</font></div><div><font size="2"   >&nbsp; &nbsp;sum &nbsp; &nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;10219555</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 1.339 ms</font></div><p></p></pre></div><div><br></div><div># 最后要测试的是truncate表.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# truncate a;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >Time: 434.581 ms</font></div></div><div><font size="2"   >postgres=# select count(*) from a;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 0.831 ms</font></div><div><font size="2"   >postgres=# select sum(cnt) from cnt_a ;</font></div><div><font size="2"   >&nbsp;sum&nbsp;</font></div><div><font size="2"   >-----</font></div><div><font size="2"   >&nbsp; &nbsp;0</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 1.354 ms</font></div><p></p></pre></div><div><br></div><div># 当并行的超过1001时, 或者以及明显感觉到行锁冲突时, 可以通过实时增加cnt_a表的记录来达到缓解行锁冲突的目的.</div><div># 不需要中断业务, 但是必须注意cnt_a表的id必须连续, 并且cnt的初始值必须为0. 不要出现空档. 否则使用以上触发器函数会出现数据不准确的现象.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >pgbench -M prepared -r -n -f ./id.sql -h $PGDATA -p 1919 -U postgres -T 60 -c 16 -j 4 postgres</font></p></pre></div><div><span style="line-height: 22px;"   >在测试的同时添加记录</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into cnt_a (id,cnt) select generate_series(1001,2000),0;</font></div><div><font size="2"   >INSERT 0 1000</font></div><p></p></pre></div><div># 测试完后检查是否准确, 测试新增的cnt_a.id是否有计数.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select count(*) from a;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1283144</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select sum(cnt) from cnt_a ;</font></div><div><font size="2"   >&nbsp; &nbsp;sum &nbsp;&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1283144</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select sum(cnt) from cnt_a where id&gt;1000;</font></div><div><font size="2"   >&nbsp; sum &nbsp;&nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;623957</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div># 如果要避免不准确的现象, 除了cnt_a.id连续, 还可以在触发器函数中添加一个异常捕获.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION public.tg_insert_a()</font></div><div><font size="2"   >&nbsp;RETURNS trigger</font></div><div><font size="2"   >&nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; m_id int;</font></div><div><font size="2"   >&nbsp; rm numeric;</font></div><div><font size="2"   >&nbsp; new_cnt int;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select max(id),random() into m_id,rm from cnt_a;</font></div><div><font size="2"   >&nbsp; update cnt_a set cnt=cnt+1 where id=(rm*m_id)::int returning cnt into new_cnt;</font></div><div><font size="2"   >&nbsp; if not found or new_cnt is null then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; raise exception '';</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; return null;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$function$;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION public.tg_delete_a()</font></div><div><font size="2"   >&nbsp;RETURNS trigger</font></div><div><font size="2"   >&nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; m_id int;</font></div><div><font size="2"   >&nbsp; rm numeric;</font></div><div><font size="2"   >&nbsp; new_cnt int;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select max(id),random() into m_id,rm from cnt_a;</font></div><div><font size="2"   >&nbsp; update cnt_a set cnt=cnt-1 where id=(rm*m_id)::int returning cnt into new_cnt;</font></div><div><font size="2"   >&nbsp; if not found or new_cnt is null then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; raise exception '';</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; return null;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div><br></div><div># 测试 :&nbsp;</div><div># 插入cnt=null的非法值, 看看会不会捕获异常, 看看结果是否正确.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into cnt_a (id,cnt) select 2001,null;</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div># 测试pgbench</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; pgbench -M prepared -r -n -f ./id.sql -h $PGDATA -p 1919 -U postgres -T 60 -c 16 -j 4 postgres</font></div><div><font size="2"   >Client 13 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 6 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 8 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 1 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 0 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 2 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 7 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 11 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 4 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 3 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 9 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 12 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 10 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 14 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 15 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 5 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 54704</font></div><div><font size="2"   >tps = 7617.195278 (including connections establishing)</font></div><div><font size="2"   >tps = 7632.604983 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003084 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 20000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.184270 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.366083 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><p></p></pre></div><div># 结果校验, 加了异常捕获, 所以结果正确.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select sum(cnt) from cnt_a;</font></div><div><font size="2"   >&nbsp; &nbsp;sum &nbsp;&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1334221</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select count(*) from a;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1334221</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div># 插入不连续的id, 看看是否可以捕获异常, 比对结果是否准确</div><div>直接跳过1000条, 导致id不连续. random()*max_id将有可能取到无记录的情况. 所以会出现not found, 捕获这个异常</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into cnt_a (id,cnt) select 3001,null;</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div># 如下pgbench实际每个连接平均只处理了28条, 看看结果是否正确</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; pgbench -M prepared -r -n -f ./id.sql -h $PGDATA -p 1919 -U postgres -T 60 -c 16 -j 4 postgres</font></div><div><font size="2"   >Client 0 aborted in state 1: ERROR: &nbsp;</font></div><div><font size="2"   >Client 3 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 13 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 14 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 7 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 2 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 8 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 4 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 5 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 10 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 6 aborted in state 1: ERROR: &nbsp;</font></div><div><font size="2"   >Client 1 aborted in state 1: ERROR: &nbsp;</font></div><div><font size="2"   >Client 9 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 11 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 15 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >Client 12 aborted in state 2: ERROR: &nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 28</font></div><div><font size="2"   >tps = 801.167415 (including connections establishing)</font></div><div><font size="2"   >tps = 1372.515380 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.004773 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 20000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.731136 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2.530098 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><p></p></pre></div><div># 结果正确</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select sum(cnt) from cnt_a;</font></div><div><font size="2"   >&nbsp; &nbsp;sum &nbsp;&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1334246</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select count(*) from a;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1334246</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>【小结】</div><div>1. 使用这种方法带来来优化count(*), 如果insert和delete本来就不是系统瓶颈的话, 是值得提倡的.</div><div>2. random()函数为volatile属性, 所以同一个事务中多次调用时需要多次运算. rm*max_id势必得到不同的id.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select provolatile from pg_proc where proname='random';</font></div><div><font size="2"   >&nbsp;provolatile&nbsp;</font></div><div><font size="2"   >-------------</font></div><div><font size="2"   >&nbsp;v</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>因此可以想象一下.</div><div>&nbsp; 2.1. random()多次运算比一次运算的开销大.</div><div>&nbsp; 2.2. 由于每次得到的id不一样, 如果是批量插入的话, 一个事务中将会锁cnt_a表的多行, 这种场景容易产生死锁.</div><div>要解决这个问题, 可以尝试使用stable或者immutable随机函数. 那么一个事务中多次调用的话都将得到同一个值, 减少了运算量同时也避免了以上场景中死锁的产生. 实现方法是<span style="line-height: 22px;"   >使用advisory lock, 如下 :&nbsp;</span></div><div><div># 新增pid和lock_time用来记录会话pid和事务启动时间.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# alter table cnt_a add column pid int;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >Time: 18.649 ms</font></div><div><font size="2"   >postgres=# alter table cnt_a add column lock_time timestamp;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >Time: 1.018 ms</font></div><div><font size="2"   >postgres=# \d cnt_a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "public.cnt_a"</font></div><div><font size="2"   >&nbsp; Column &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; Modifiers &nbsp;&nbsp;</font></div><div><font size="2"   >-----------+-----------------------------+---------------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;cnt &nbsp; &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;pid &nbsp; &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;lock_time | timestamp without time zone |&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "cnt_a_pkey" PRIMARY KEY, btree (id)</font></div><p></p></pre></div><div><br></div><div># 创建插入触发器函数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION public.tg_insert_a()</font></div><div><font size="2"   >&nbsp;RETURNS trigger</font></div><div><font size="2"   >&nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; m_id int;</font></div><div><font size="2"   >&nbsp; a_lock boolean;</font></div><div><font size="2"   >&nbsp; rm numeric;</font></div><div><font size="2"   >&nbsp; max_id int;</font></div><div><font size="2"   >&nbsp; new_cnt int;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; -- now()为stable, 同一事务结果一致.</font></div><div><font size="2"   >&nbsp; select id into m_id from cnt_a where pid=pg_backend_pid() and lock_time=now() limit 1;</font></div><div><font size="2"   >&nbsp; if found then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; update cnt_a set cnt=cnt+1 where id=m_id returning cnt into new_cnt;</font></div><div><font size="2"   >&nbsp; &nbsp; if new_cnt is null then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise exception 'cnt_a.cnt is null, please init with zero.';</font></div><div><font size="2"   >&nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; &nbsp; return null;</font></div><div><font size="2"   >&nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; -- 1 由于read committed, 并发时可能同时抢锁1条记录. 造成不必要的等待.</font></div><div><font size="2"   >&nbsp; &nbsp; -- 1 select id into m_id from cnt_a where locked=false limit 1 for update; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; -- 2 使用这种方法可以减轻锁同一记录的压力,但是增加了查询开销.</font></div><div><font size="2"   >&nbsp; &nbsp; -- 2 select id into m_id from cnt_a where locked=false order by random() limit 1 for update; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; -- 3 通过55P03捕获异常. 并发明显时, 这种异常会很多.</font></div><div><font size="2"   >&nbsp; &nbsp; -- 3 select id into m_id from cnt_a where locked=false limit 1 for update nowait; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; -- 4 以下需要关注高并发的情况下, 得到锁需要遍历的记录条数, 还有优化的空间. (结合mvcc与检索机制)</font></div><div><font size="2"   >&nbsp; &nbsp; for a_lock,m_id in select pg_try_advisory_xact_lock(id),id from cnt_a loop&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; if a_lock then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; -- 加锁成功</font></div><div><font size="2"   ><span>	</span>update cnt_a set cnt=cnt+1,pid=pg_backend_pid(),lock_time=now() where id=m_id returning cnt into new_cnt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if new_cnt is null then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; raise exception 'cnt_a.cnt is null, please init with zero.';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; end if;</font></div><div><font size="2"   ><span>	</span>return null;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; &nbsp; end loop;</font></div><div><font size="2"   >&nbsp; &nbsp; -- 到这里说明遍历所有的cnt_a都没有加锁成功, 原因是都被锁了.</font></div><div><font size="2"   >&nbsp; &nbsp; -- 那么随机取一条更新进行等待即可</font></div><div><font size="2"   >&nbsp; &nbsp; select max(id),random() into max_id,rm from cnt_a;</font></div><div><font size="2"   >&nbsp; &nbsp; update cnt_a set cnt=cnt+1,pid=pg_backend_pid(),lock_time=now() where id=(rm*m_id)::int returning cnt into new_cnt;</font></div><div><font size="2"   >&nbsp; &nbsp; if not found or new_cnt is null then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise exception 'cnt_a.id:%, cnt_a.cnt:%.', (rm*m_id)::int, new_cnt;</font></div><div><font size="2"   >&nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; &nbsp; return null;</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >return null;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div><br></div><div># 创建删除触发器函数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION public.tg_delete_a()</font></div><div><font size="2"   >&nbsp;RETURNS trigger</font></div><div><font size="2"   >&nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; m_id int;</font></div><div><font size="2"   >&nbsp; a_lock boolean;</font></div><div><font size="2"   >&nbsp; rm numeric;</font></div><div><font size="2"   >&nbsp; max_id int;</font></div><div><font size="2"   >&nbsp; new_cnt int;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; -- now()为stable, 同一事务结果一致.</font></div><div><font size="2"   >&nbsp; select id into m_id from cnt_a where pid=pg_backend_pid() and lock_time=now() limit 1;</font></div><div><font size="2"   >&nbsp; if found then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; update cnt_a set cnt=cnt-1 where id=m_id returning cnt into new_cnt;</font></div><div><font size="2"   >&nbsp; &nbsp; if new_cnt is null then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise exception 'cnt_a.cnt is null, please init with zero.';</font></div><div><font size="2"   >&nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; &nbsp; return null;</font></div><div><font size="2"   >&nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; -- 1 由于read committed, 并发时可能同时抢锁1条记录. 造成不必要的等待.</font></div><div><font size="2"   >&nbsp; &nbsp; -- 1 select id into m_id from cnt_a where locked=false limit 1 for update; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; -- 2 使用这种方法可以减轻锁同一记录的压力,但是增加了查询开销.</font></div><div><font size="2"   >&nbsp; &nbsp; -- 2 select id into m_id from cnt_a where locked=false order by random() limit 1 for update; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; -- 3 通过55P03捕获异常. 并发明显时, 这种异常会很多.</font></div><div><font size="2"   >&nbsp; &nbsp; -- 3 select id into m_id from cnt_a where locked=false limit 1 for update nowait; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; -- 4 以下需要关注高并发的情况下, 得到锁需要遍历的记录条数, 还有优化的空间. (结合mvcc与检索机制)</font></div><div><font size="2"   >&nbsp; &nbsp; for a_lock,m_id in select pg_try_advisory_xact_lock(id),id from cnt_a loop&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; if a_lock then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; -- 加锁成功</font></div><div><font size="2"   ><span>	</span>update cnt_a set cnt=cnt-1,pid=pg_backend_pid(),lock_time=now() where id=m_id returning cnt into new_cnt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if new_cnt is null then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; raise exception 'cnt_a.cnt is null, please init with zero.';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; end if;</font></div><div><font size="2"   ><span>	</span>return null;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; &nbsp; end loop;</font></div><div><font size="2"   >&nbsp; &nbsp; -- 到这里说明遍历所有的cnt_a都没有加锁成功, 原因是都被锁了.</font></div><div><font size="2"   >&nbsp; &nbsp; -- 那么随机取一条更新进行等待即可</font></div><div><font size="2"   >&nbsp; &nbsp; select max(id),random() into max_id,rm from cnt_a;</font></div><div><font size="2"   >&nbsp; &nbsp; update cnt_a set cnt=cnt-1,pid=pg_backend_pid(),lock_time=now() where id=(rm*m_id)::int returning cnt into new_cnt;</font></div><div><font size="2"   >&nbsp; &nbsp; if not found or new_cnt is null then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise exception 'cnt_a.id:%, cnt_a.cnt:%.', (rm*m_id)::int, new_cnt;</font></div><div><font size="2"   >&nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; &nbsp; return null;</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >return null;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$function$;</font></div></pre></div><div><br></div><div># 以下测试原始场景16个并发以及16条cnt_a记录的单事务多sql的场景, 发生了可以预料到的死锁.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# truncate a;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >postgres=# delete from cnt_a ;</font></div><div><font size="2"   >DELETE 2002</font></div><div><font size="2"   >postgres=# insert into cnt_a(id,cnt) select generate_series(0,15),0;</font></div><div><font size="2"   >INSERT 0 16</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; pgbench -M prepared -r -n -f ./id.sql -h $PGDATA -p 1919 -U postgres -T 60 -c 16 -j 4 postgres</font></div><div><font size="2"   >Client 2 aborted in state 8: ERROR: &nbsp;deadlock detected</font></div><div><font size="2"   >DETAIL: &nbsp;Process 10738 waits for ShareLock on transaction 433211275; blocked by process 10737.</font></div><div><font size="2"   >Process 10737 waits for ShareLock on transaction 433211280; blocked by process 10738.</font></div><div><font size="2"   >HINT: &nbsp;See server log for query details.</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "update cnt_a set cnt=cnt+1 where id=(rm*m_id)::int returning cnt"</font></div><div><font size="2"   >PL/pgSQL function tg_insert_a() line 8 at SQL statement</font></div><div><font size="2"   >Client 3 aborted in state 8: ERROR: &nbsp;deadlock detected</font></div><div><font size="2"   >DETAIL: &nbsp;Process 10742 waits for ShareLock on transaction 433211275; blocked by process 10737.</font></div><div><font size="2"   >Process 10737 waits for ExclusiveLock on tuple (0,11) of relation 25592 of database 12044; blocked by process 10740.</font></div><div><font size="2"   >Process 10740 waits for ShareLock on transaction 433211281; blocked by process 10742.</font></div><div><font size="2"   >HINT: &nbsp;See server log for query details.</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "update cnt_a set cnt=cnt+1 where id=(rm*m_id)::int returning cnt"</font></div><div><font size="2"   >PL/pgSQL function tg_insert_a() line 8 at SQL statement</font></div><div><font size="2"   >Client 12 aborted in state 4: ERROR: &nbsp;deadlock detected</font></div><div><font size="2"   >DETAIL: &nbsp;Process 10732 waits for ShareLock on transaction 433211286; blocked by process 10740.</font></div><div><font size="2"   >Process 10740 waits for ShareLock on transaction 433211276; blocked by process 10736.</font></div><div><font size="2"   >Process 10736 waits for ExclusiveLock on tuple (0,12) of relation 25592 of database 12044; blocked by process 10734.</font></div><div><font size="2"   >Process 10734 waits for ShareLock on transaction 433211275; blocked by process 10737.</font></div><div><font size="2"   >Process 10737 waits for ExclusiveLock on tuple (0,11) of relation 25592 of database 12044; blocked by process 10732.</font></div><div><font size="2"   >HINT: &nbsp;See server log for query details.</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "update cnt_a set cnt=cnt+1 where id=(rm*m_id)::int returning cnt"</font></div><div><font size="2"   >PL/pgSQL function tg_insert_a() line 8 at SQL statement</font></div><div><font size="2"   >Client 13 aborted in state 11: ERROR: &nbsp;deadlock detected</font></div><div><font size="2"   >DETAIL: &nbsp;Process 10736 waits for ExclusiveLock on tuple (0,12) of relation 25592 of database 12044; blocked by process 10734.</font></div><div><font size="2"   >Process 10734 waits for ShareLock on transaction 433211275; blocked by process 10737.</font></div><div><font size="2"   >Process 10737 waits for ShareLock on transaction 433211286; blocked by process 10740.</font></div><div><font size="2"   >Process 10740 waits for ShareLock on transaction 433211276; blocked by process 10736.</font></div><div><font size="2"   >HINT: &nbsp;See server log for query details.</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "update cnt_a set cnt=cnt+1 where id=(rm*m_id)::int returning cnt"</font></div><div><font size="2"   >PL/pgSQL function tg_insert_a() line 8 at SQL statement</font></div><div><font size="2"   >Client 5 aborted in state 12: ERROR: &nbsp;deadlock detected</font></div><div><font size="2"   >DETAIL: &nbsp;Process 10737 waits for ShareLock on transaction 433211286; blocked by process 10740.</font></div><div><font size="2"   >Process 10740 waits for ShareLock on transaction 433211272; blocked by process 10731.</font></div><div><font size="2"   >Process 10731 waits for ShareLock on transaction 433211279; blocked by process 10734.</font></div><div><font size="2"   >Process 10734 waits for ShareLock on transaction 433211275; blocked by process 10737.</font></div><div><font size="2"   >HINT: &nbsp;See server log for query details.</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "update cnt_a set cnt=cnt+1 where id=(rm*m_id)::int returning cnt"</font></div><div><font size="2"   >PL/pgSQL function tg_insert_a() line 8 at SQL statement</font></div><div><font size="2"   >Client 1 aborted in state 10: ERROR: &nbsp;deadlock detected</font></div><div><font size="2"   >DETAIL: &nbsp;Process 10734 waits for ShareLock on transaction 433211287; blocked by process 10730.</font></div><div><font size="2"   >Process 10730 waits for ShareLock on transaction 433211286; blocked by process 10740.</font></div><div><font size="2"   >Process 10740 waits for ShareLock on transaction 433211272; blocked by process 10731.</font></div><div><font size="2"   >Process 10731 waits for ShareLock on transaction 433211279; blocked by process 10734.</font></div><div><font size="2"   >HINT: &nbsp;See server log for query details.</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "update cnt_a set cnt=cnt+1 where id=(rm*m_id)::int returning cnt"</font></div><div><font size="2"   >PL/pgSQL function tg_insert_a() line 8 at SQL statement</font></div><div><font size="2"   >Client 7 aborted in state 8: ERROR: &nbsp;deadlock detected</font></div><div><font size="2"   >DETAIL: &nbsp;Process 10743 waits for ShareLock on transaction 433211288; blocked by process 10744.</font></div><div><font size="2"   >Process 10744 waits for ShareLock on transaction 433211282; blocked by process 10733.</font></div><div><font size="2"   >Process 10733 waits for ExclusiveLock on tuple (0,22) of relation 25592 of database 12044; blocked by process 10730.</font></div><div><font size="2"   >Process 10730 waits for ShareLock on transaction 433211286; blocked by process 10740.</font></div><div><font size="2"   >Process 10740 waits for ShareLock on transaction 433211284; blocked by process 10743.</font></div><div><font size="2"   >HINT: &nbsp;See server log for query details.</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "update cnt_a set cnt=cnt+1 where id=(rm*m_id)::int returning cnt"</font></div><div><font size="2"   >PL/pgSQL function tg_insert_a() line 8 at SQL statement</font></div><div><font size="2"   >Client 14 aborted in state 12: ERROR: &nbsp;deadlock detected</font></div><div><font size="2"   >DETAIL: &nbsp;Process 10740 waits for ExclusiveLock on tuple (0,16) of relation 25592 of database 12044; blocked by process 10735.</font></div><div><font size="2"   >Process 10735 waits for ShareLock on transaction 433211274; blocked by process 10739.</font></div><div><font size="2"   >Process 10739 waits for ShareLock on transaction 433211282; blocked by process 10733.</font></div><div><font size="2"   >Process 10733 waits for ExclusiveLock on tuple (0,22) of relation 25592 of database 12044; blocked by process 10730.</font></div><div><font size="2"   >Process 10730 waits for ShareLock on transaction 433211286; blocked by process 10740.</font></div><div><font size="2"   >HINT: &nbsp;See server log for query details.</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "update cnt_a set cnt=cnt+1 where id=(rm*m_id)::int returning cnt"</font></div><div><font size="2"   >PL/pgSQL function tg_insert_a() line 8 at SQL statement</font></div><div><font size="2"   >Client 11 aborted in state 4: ERROR: &nbsp;deadlock detected</font></div><div><font size="2"   >DETAIL: &nbsp;Process 10745 waits for ExclusiveLock on tuple (0,3) of relation 25592 of database 12044; blocked by process 10741.</font></div><div><font size="2"   >Process 10741 waits for ShareLock on transaction 433211278; blocked by process 10735.</font></div><div><font size="2"   >Process 10735 waits for ShareLock on transaction 433211274; blocked by process 10739.</font></div><div><font size="2"   >Process 10739 waits for ShareLock on transaction 433211291; blocked by process 10733.</font></div><div><font size="2"   >Process 10733 waits for ShareLock on transaction 433211290; blocked by process 10730.</font></div><div><font size="2"   >Process 10730 waits for ExclusiveLock on tuple (0,3) of relation 25592 of database 12044; blocked by process 10745.</font></div><div><font size="2"   >HINT: &nbsp;See server log for query details.</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "update cnt_a set cnt=cnt+1 where id=(rm*m_id)::int returning cnt"</font></div><div><font size="2"   >PL/pgSQL function tg_insert_a() line 8 at SQL statement</font></div><div><font size="2"   >Client 0 aborted in state 10: ERROR: &nbsp;deadlock detected</font></div><div><font size="2"   >DETAIL: &nbsp;Process 10730 waits for ExclusiveLock on tuple (0,3) of relation 25592 of database 12044; blocked by process 10741.</font></div><div><font size="2"   >Process 10741 waits for ShareLock on transaction 433211278; blocked by process 10735.</font></div><div><font size="2"   >Process 10735 waits for ShareLock on transaction 433211274; blocked by process 10739.</font></div><div><font size="2"   >Process 10739 waits for ShareLock on transaction 433211291; blocked by process 10733.</font></div><div><font size="2"   >Process 10733 waits for ShareLock on transaction 433211290; blocked by process 10730.</font></div><div><font size="2"   >HINT: &nbsp;See server log for query details.</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "update cnt_a set cnt=cnt+1 where id=(rm*m_id)::int returning cnt"</font></div><div><font size="2"   >PL/pgSQL function tg_insert_a() line 8 at SQL statement</font></div><div><font size="2"   >Client 8 aborted in state 10: ERROR: &nbsp;deadlock detected</font></div><div><font size="2"   >DETAIL: &nbsp;Process 10731 waits for ShareLock on transaction 433211294; blocked by process 10733.</font></div><div><font size="2"   >Process 10733 waits for ExclusiveLock on tuple (0,76) of relation 25592 of database 12044; blocked by process 10744.</font></div><div><font size="2"   >Process 10744 waits for ShareLock on transaction 433211289; blocked by process 10731.</font></div><div><font size="2"   >HINT: &nbsp;See server log for query details.</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "update cnt_a set cnt=cnt+1 where id=(rm*m_id)::int returning cnt"</font></div><div><font size="2"   >PL/pgSQL function tg_insert_a() line 8 at SQL statement</font></div><div><font size="2"   >Client 4 aborted in state 8: ERROR: &nbsp;deadlock detected</font></div><div><font size="2"   >DETAIL: &nbsp;Process 10733 waits for ShareLock on transaction 433211293; blocked by process 10744.</font></div><div><font size="2"   >Process 10744 waits for ExclusiveLock on tuple (0,89) of relation 25592 of database 12044; blocked by process 10735.</font></div><div><font size="2"   >Process 10735 waits for ShareLock on transaction 433211294; blocked by process 10733.</font></div><div><font size="2"   >HINT: &nbsp;See server log for query details.</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "update cnt_a set cnt=cnt+1 where id=(rm*m_id)::int returning cnt"</font></div><div><font size="2"   >PL/pgSQL function tg_insert_a() line 8 at SQL statement</font></div><div><font size="2"   >Client 15 aborted in state 4: ERROR: &nbsp;deadlock detected</font></div><div><font size="2"   >DETAIL: &nbsp;Process 10744 waits for ShareLock on transaction 433211296; blocked by process 10735.</font></div><div><font size="2"   >Process 10735 waits for ShareLock on transaction 433211298; blocked by process 10739.</font></div><div><font size="2"   >Process 10739 waits for ExclusiveLock on tuple (0,90) of relation 25592 of database 12044; blocked by process 10744.</font></div><div><font size="2"   >HINT: &nbsp;See server log for query details.</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "update cnt_a set cnt=cnt+1 where id=(rm*m_id)::int returning cnt"</font></div><div><font size="2"   >PL/pgSQL function tg_insert_a() line 8 at SQL statement</font></div><div><font size="2"   >Client 9 aborted in state 10: ERROR: &nbsp;deadlock detected</font></div><div><font size="2"   >DETAIL: &nbsp;Process 10735 waits for ShareLock on transaction 433211298; blocked by process 10739.</font></div><div><font size="2"   >Process 10739 waits for ShareLock on transaction 433211296; blocked by process 10735.</font></div><div><font size="2"   >HINT: &nbsp;See server log for query details.</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "update cnt_a set cnt=cnt+1 where id=(rm*m_id)::int returning cnt"</font></div><div><font size="2"   >PL/pgSQL function tg_insert_a() line 8 at SQL statement</font></div><div><font size="2"   >Client 6 aborted in state 11: ERROR: &nbsp;deadlock detected</font></div><div><font size="2"   >DETAIL: &nbsp;Process 10741 waits for ShareLock on transaction 433211317; blocked by process 10739.</font></div><div><font size="2"   >Process 10739 waits for ShareLock on transaction 433211316; blocked by process 10741.</font></div><div><font size="2"   >HINT: &nbsp;See server log for query details.</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "update cnt_a set cnt=cnt+1 where id=(rm*m_id)::int returning cnt"</font></div><div><font size="2"   >PL/pgSQL function tg_insert_a() line 8 at SQL statement</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 23826</font></div><div><font size="2"   >tps = 397.094633 (including connections establishing)</font></div><div><font size="2"   >tps = 397.187975 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002638 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 20000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.063353 &nbsp; &nbsp; &nbsp; &nbsp;begin;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.098917 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.090903 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.541656 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.096450 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.784244 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.095878 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.899185 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.096219 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.942108 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.441609 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.482926 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.079380 &nbsp; &nbsp; &nbsp; &nbsp;end;</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"   ># 以下测试改进函数后的场景16个并发以及16条cnt_a记录的单事务多sql的场景, 避免了死锁, 同上提高了tps.</span></div><div><pre class="prettyprint"   ><p></p><div><div><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; pgbench -M prepared -r -n -f ./id.sql -h $PGDATA -p 1919 -U postgres -T 60 -c 16 -j 4 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 42402</font></div><div><font size="2"   >tps = 706.377762 (including connections establishing)</font></div><div><font size="2"   >tps = 706.544148 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.004023 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 20000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.128100 &nbsp; &nbsp; &nbsp; &nbsp;begin;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.376305 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.149250 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 14.473279 &nbsp; &nbsp; &nbsp; insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.206936 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.340881 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.207271 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.301736 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.209022 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.294269 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.342260 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.337499 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.250370 &nbsp; &nbsp; &nbsp; &nbsp;end;</font></div></div></div><div><div><font size="2"   >postgres=# select count(*) from a;</font></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;396719</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select sum(cnt) from cnt_a ;</font></div><div><font size="2"   >&nbsp; sum &nbsp;&nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;396719</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div></div><div><br></div><div># 测试原始场景单事务单sql, 16并发16条cnt_a记录的结果. 比对于改进后的函数tps</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; pgbench -M prepared -r -n -f ./insert.sql -h $PGDATA -p 1919 -U postgres -T 60 -c 16 -j 4 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 1480488</font></div><div><font size="2"   >tps = 24668.474181 (including connections establishing)</font></div><div><font size="2"   >tps = 24674.365320 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.646597 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 测试改进函数后的场景单事务单sql, 16并发16条cnt_a记录的结果.&nbsp;</span><span style="line-height: 22px;"   >比对于改进后的函数tps</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; pgbench -M prepared -r -n -f ./insert.sql -h $PGDATA -p 1919 -U postgres -T 60 -c 16 -j 4 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 736812</font></div><div><font size="2"   >tps = 12278.457482 (including connections establishing)</font></div><div><font size="2"   >tps = 12281.288634 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.300583 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 测试cnt_a记录足够多的情况下(例如2000条),&nbsp;</span><span style="line-height: 22px;"   >测试原始场景单事务单sql, 16并发 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into cnt_a(id,cnt) select generate_series(16,1999),0;</font></div><div><font size="2"   >INSERT 0 1984</font></div><div><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; pgbench -M prepared -r -n -f ./insert.sql -h $PGDATA -p 1919 -U postgres -T 60 -c 16 -j 4 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 1722562</font></div><div><font size="2"   >tps = 28705.262293 (including connections establishing)</font></div><div><font size="2"   >tps = 28712.163471 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.555513 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   ># 测试cnt_a记录足够多的情况下(例如2000条),&nbsp;</span><span style="line-height: 22px;"   >测试改进函数后的场景单事务单sql, 16并发 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; pgbench -M prepared -r -n -f ./insert.sql -h $PGDATA -p 1919 -U postgres -T 60 -c 16 -j 4 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 482195</font></div><div><font size="2"   >tps = 8034.913678 (including connections establishing)</font></div><div><font size="2"   >tps = 8036.928653 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.988503 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 测试cnt_a记录足够多的情况下(例如2000条),&nbsp;</span><span style="line-height: 22px;"   >测试原始场景单事务多sql, 16并发 :&nbsp;</span></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ># 与上面的测试一样出现了大量的死锁</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; pgbench -M prepared -r -n -f ./id.sql -h $PGDATA -p 1919 -U postgres -T 60 -c 16 -j 4 postgres</font></div><div><font size="2"   >Client 0 aborted in state 12: ERROR: &nbsp;deadlock detected</font></div></div><div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 123264</font></div><div><font size="2"   >tps = 2054.315191 (including connections establishing)</font></div><div><font size="2"   >tps = 2054.804565 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002890 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 20000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.055029 &nbsp; &nbsp; &nbsp; &nbsp;begin;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.154473 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.092312 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.398831 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.099380 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.374859 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.099221 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.400103 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.099028 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.397862 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.444252 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.460034 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.082733 &nbsp; &nbsp; &nbsp; &nbsp;end;</font></div></div></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ># 测试cnt_a记录足够多的情况下(例如2000条),&nbsp;</span><span style="line-height: 22px;"   >测试改进函数后的场景单事务多sql, 16并发 :&nbsp;</span></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; pgbench -M prepared -r -n -f ./id.sql -h $PGDATA -p 1919 -U postgres -T 60 -c 16 -j 4 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 178495</font></div><div><font size="2"   >tps = 2974.062219 (including connections establishing)</font></div><div><font size="2"   >tps = 2974.751878 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003536 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 20000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.145519 &nbsp; &nbsp; &nbsp; &nbsp;begin;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.432378 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.190400 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.394283 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.250328 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.443856 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.234544 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.420465 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.225787 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.412413 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.436313 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.437742 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.333693 &nbsp; &nbsp; &nbsp; &nbsp;end;</font></div><p></p></pre></div><div># 综合以上测试,&nbsp;<span style="line-height: 22px;"   >改进后的函数在单事务中只有单条a表dml操作的场景中没有优势, 在事务中处理需要处理多条a记录的情况下有优势.</span></div><div><span style="line-height: 22px;"   ># 对于改进函数的二次改进, 见下一篇blog</span></div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020133151402415/"   >http://blog.163.com/digoal@126/blog/static/16387704020133151402415/</a></div><div><br></div><div>【参考】</div><div>以前写的几篇优化group by和count(distinct column)的文章, 有兴趣的朋友也可以参考一下 &nbsp;</div><div>1.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020129851138327/"   >http://blog.163.com/digoal@126/blog/static/16387704020129851138327/</a></div><div>2.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020128142829610/"   >http://blog.163.com/digoal@126/blog/static/16387704020128142829610/</a></div><div>关于函数的稳定性 :&nbsp;</div><div>1.&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201211241434248/"   >http://blog.163.com/digoal@126/blog/static/163877040201211241434248/</a></div><div>2.&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201151011105494/"   >http://blog.163.com/digoal@126/blog/static/163877040201151011105494/</a></div><div>随机查询优化 :&nbsp;</div></div><div>1.&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201111292628555/"   >http://blog.163.com/digoal@126/blog/static/163877040201111292628555/</a></div><div>advisory locks, 应用程序锁 :&nbsp;</div><div>1.&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201172492217830/"   >http://blog.163.com/digoal@126/blog/static/163877040201172492217830/</a></div><br><div><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 25px;"   >[参考]</span><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><div style="line-height: 25px;"   >为方便大家查询, 汇总PostgreSQL实时和非实时数据统计的案例分析文章系列 - 如下 :&nbsp;</div><div style="line-height: 25px;"   >1.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201331252945440/"   >http://blog.163.com/digoal@126/blog/static/163877040201331252945440/</a></div><div style="line-height: 25px;"   >2.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020133151402415/"   >http://blog.163.com/digoal@126/blog/static/16387704020133151402415/</a></div><div style="line-height: 25px;"   >3.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020133155179877/"   >http://blog.163.com/digoal@126/blog/static/16387704020133155179877/</a></div><div style="line-height: 25px;"   >4.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020133156636579/"   >http://blog.163.com/digoal@126/blog/static/16387704020133156636579/</a></div><div style="line-height: 25px;"   >5.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020133218305242/"   >http://blog.163.com/digoal@126/blog/static/16387704020133218305242/</a></div><div style="line-height: 25px;"   >6.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020133224161563/"   >http://blog.163.com/digoal@126/blog/static/16387704020133224161563/</a></div></div></div>7.&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020133271134563/"   >http://blog.163.com/digoal@126/blog/static/16387704020133271134563/</a><br><div><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 25px;"   >8.&nbsp;</span><a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136); font-family: Arial, Helvetica, simsun, u5b8bu4f53;" href="http://blog.163.com/digoal@126/blog/static/16387704020134311144755/"   >http://blog.163.com/digoal@126/blog/static/16387704020134311144755/</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL real-time count(*) performance tuning case - 1 - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>