<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL change unlogged table to logged table</h2>
	<h5 id="">2013-04-27 16:53:45&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020133274380469/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">今天一位网友给我留言能不能将unlogged table 改成normal table, 也就是logged table.<div>答案是可以的.</div><div>unlogged table的变更不记录pg_xlog, 所以这点在流复制环境或者log shipping 复制环境会遇到小小的麻烦, 但是不要紧, 这个是可以解决的.</div><div>以下是修改过程 :&nbsp;</div><div>主库, 创建unlogged table :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create unlogged table t(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=&gt; insert into t values (1);</font></div><div><font size="2"   >INSERT 0 1</font></div><div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=&gt; select * from pg_class where relname='t';</font></div><div><font size="2"   >&nbsp;relname | relnamespace | reltype | reloftype | relowner | relam | relfilenode | reltablespace | relpages | reltuples | relal</font></div><div><font size="2"   >lvisible | reltoastrelid | reltoastidxid | relhasindex | relisshared | relpersistence | relkind | relnatts | relchecks | relh</font></div><div><font size="2"   >asoids | relhaspkey | relhasrules | relhastriggers | relhassubclass | relfrozenxid | relacl | reloptions&nbsp;</font></div><div><font size="2"   >---------+--------------+---------+-----------+----------+-------+-------------+---------------+----------+-----------+------</font></div><div><font size="2"   >---------+---------------+---------------+-------------+-------------+----------------+---------+----------+-----------+-----</font></div><div><font size="2"   >-------+------------+-------------+----------------+----------------+--------------+--------+------------</font></div><div><font size="2"   >&nbsp;t &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; 2200 | &nbsp;154316 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp;24602 | &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp;154314 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | u &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| r &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | f &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; 32079149 | &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>注意<span style="line-height: 22px;"   >relpersistence=u, 也就是unlogged的意思.</span></div><div><span style="line-height: 22px;"   >此时去standby节点查询, 有t表, &nbsp;但是查询数据会报错.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   ><div><span style="line-height: 22px;"   >digoal</span>=&gt; \dt</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</div><div>&nbsp;Schema | &nbsp; &nbsp; Name &nbsp; &nbsp; | Type &nbsp;| &nbsp; Owner &nbsp; &nbsp;</div><div>--------+--------------+-------+------------</div><div>&nbsp;public | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| table |&nbsp;<span style="line-height: 22px;"   >digoal</span></div></span><span style="line-height: 22px;"   ><div>(2 rows)</div></span></font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=&gt; select * from t;</font></div><div><font size="2"   >ERROR: &nbsp;cannot access temporary or unlogged relations during recovery</font></div><p></p></pre></div><div>在主库将t表改成logged的. 使用超级用户</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=&gt; \c&nbsp;<span style="line-height: 22px;"   >digoal&nbsp;</span>postgres</font></div><div><font size="2"   >You are now connected to database "postgres" as user "postgres".</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# update pg_class set relpersistence='p' where relname='t';</font></div><div><font size="2"   >UPDATE 1</font></div><p></p></pre></div><div>此时去standby查询t表报错变了, 原因是unlogged表的dml操作不会写pg_xlog, 因此数据块不会复制到standby节点.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=&gt; select * from t;</font></div><div><font size="2"   >ERROR: &nbsp;could not open file "base/12788/154314": No such file or directory</font></div><p></p></pre></div><div>此时在主节点插入一条记录</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# insert into t values (1);</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div>再到standby节点查询</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=&gt; select * from t;</font></div><div><font size="2"   >&nbsp;id&nbsp;</font></div><div><font size="2"   >----</font></div><div><font size="2"   >&nbsp; 1</font></div><div><font size="2"   >&nbsp; 1</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>正常了, 这又是为什么呢, 因为t表已经改成logged了, pg_xlog会记录, 所以数据块被复制到standby节点了.</div><div><br></div><div>但是再来看一个测试 .</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# drop table t;</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# create unlogged table t(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# insert into t select generate_series(1,1000);</font></div><div><font size="2"   >INSERT 0 1000</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# select min(ctid),max(ctid) from t;</font></div><div><font size="2"   >&nbsp; min &nbsp;| &nbsp;max &nbsp;&nbsp;</font></div><div><font size="2"   >-------+--------</font></div><div><font size="2"   >&nbsp;(0,1) | (4,96)</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>-- 注意现在t表有5个数据块. 而不是1个数据块.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# update pg_class set relpersistence='p' where relname='t';</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# insert into t select generate_series(1,1000);</font></div><div><font size="2"   >INSERT 0 1000</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# select count(*) from t;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; 2000</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# select min(ctid), max(ctid) from t;</font></div><div><font size="2"   >&nbsp; min &nbsp;| &nbsp; max &nbsp;&nbsp;</font></div><div><font size="2"   >-------+---------</font></div><div><font size="2"   >&nbsp;(0,1) | (8,192)</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div></div><div>在standby节点看看数据是否都复制过来了呢?&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=&gt; \c postgres postgres</font></div><div><font size="2"   >You are now connected to database "postgres" as user "postgres".</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# select count(*) from t;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; 1096</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# select min(ctid), max(ctid) from t;</font></div><div><font size="2"   >&nbsp; min &nbsp;| &nbsp; max &nbsp;&nbsp;</font></div><div><font size="2"   >-------+---------</font></div><div><font size="2"   >&nbsp;(4,1) | (8,192)</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>注意是从4号数据块开始复制过来的. 原因是t表变成logged后的DML操作只影响到了4号数据块,并且新建了几个数据块, 老的数据块没有改变, 所以不会记入pg_xlog, 因此复制也只复制了4号数据块开始的新数据块.</div><div>遇到这个问题怎么处理呢?</div><div>方法1 :&nbsp;</div><div>如果表比较小, vacuum full就可以了, 因为vacuum full会重建表. pg_xlog也会重新生成.</div><div>主库执行 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# vacuum full t;</font></div><div><font size="2"   >VACUUM</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# select count(*) from t;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; 2000</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>standby库验证 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# select min(ctid), max(ctid) from t;</font></div><div><font size="2"   >&nbsp; min &nbsp;| &nbsp; max &nbsp;&nbsp;</font></div><div><font size="2"   >-------+---------</font></div><div><font size="2"   >&nbsp;(0,1) | (8,192)</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# select count(*) from t;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; 2000</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>方法2 :&nbsp;</div><div>如果表很大了, 例如超过了1个数据文件时. 那么可以冻结t表的dml操作, 直接复制未在standby创建的的数据文件. 以及覆盖不完整的数据文件.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# select pg_relation_filepath('t'::regclass);</font></div><div><font size="2"   >&nbsp;pg_relation_filepath&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;base/12788/154322</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>把这个文件以及<span style="line-height: 22px;"   >base/12788/154322.*</span><span style="line-height: 22px;"   >复制到standby即可.</span></div><div>复制完后解冻.</div><div><br></div><div>[其他注意事项]</div><div>1. 如果unlogged表涉及到索引, 索引也需要修改.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create unlogged table t(id int primary key, info text);</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "t_pkey" for table "t"</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# select relpersistence from pg_class where oid='t'::regclass;</font></div><div><font size="2"   >&nbsp;relpersistence&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;u</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# select relpersistence from pg_class where oid='t_pkey'::regclass;</font></div><div><font size="2"   >&nbsp;relpersistence&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;u</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# update pg_class set relpersistence='p' where oid='t'::regclass;</font></div><div><font size="2"   >UPDATE 1</font></div></div><div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# update pg_class set relpersistence='p' where oid='t_pkey'::regclass;</font></div><div><font size="2"   >UPDATE 1</font></div></div><p></p></pre></div><div><br></div><wbr></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">dongying--2003 - 2013-04-28 16:43:05</h5>
				<div>好东西，推荐！</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 dongying--2003 - 2013-04-28 16:43:05</h5>
				<div style="width:600px;">通过修改PostgreSQL的系统表实现的.<br></div>
			</div>
	</div>
</div>
</body>
</html>