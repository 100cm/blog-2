<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Postgres-XC add coordinator or repair coordinator catalog - 1</h2>
	<h5 id="">2013-04-03 17:44:24&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020133345813184/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">本文讲解的环境参考 :&nbsp;<div><a href="http://blog.163.com/digoal@126/blog/static/16387704020133292915600/"   >http://blog.163.com/digoal@126/blog/static/16387704020133292915600/</a></div><div><br></div><div>1. 首先将192.168.122.178的coordinator从其他的coordinator配置中去除.</div><div>模拟当前只有5个coordinator的情况.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >psql -h 192.168.122.173 -p 1921 -U postgres postgres -c "drop node coordinate_6";</font></div><div><font size="2"   >psql -h 192.168.122.174 -p 1921 -U postgres postgres -c "drop node coordinate_6";</font></div><div><font size="2"   >psql -h 192.168.122.175 -p 1921 -U postgres postgres -c "drop node coordinate_6";</font></div><div><font size="2"   >psql -h 192.168.122.176 -p 1921 -U postgres postgres -c "drop node coordinate_6";</font></div><div><font size="2"   >psql -h 192.168.122.177 -p 1921 -U postgres postgres -c "drop node coordinate_6";</font></div><p></p></pre></div><div><br>2. 在这5个coordinator中的任意一个中新建一个测试表<wbr></div><div># 因为修改了node信息, 所以先重载一下pool</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select pgxc_pool_reload();</font></div><div><div><font size="2"   >postgres=# create table user_info(id int primary key, info text, crt_time timestamp) distribute by hash(id) to group gp0;</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "user_info_pkey" for table "user_info"</font></div><div><font size="2"   >CREATE TABLE</font></div></div><p></p></pre></div><div><br></div><div>3. 在192.168.122.178的coordinator中看不到这个新建的user_info表.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[pgxc@db-192-168-122-173 pgxc_ddl]$ psql -h 192.168.122.178 -p 1921 -U postgres postgres</font></div><div><font size="2"   >psql (PGXC 1.0.2, based on PG 9.1.7)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | Name | Type &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >--------+------+-------+----------</font></div><div><font size="2"   >&nbsp;public | t1 &nbsp; | table | postgres</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>4. 现在要让user_info表出现在192.168.122.178的coordinator中, 直接加肯定是不行的, 因为各个datanode中已经存在这个表了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >psql -h 192.168.122.178 -p 1921 -U postgres postgres</font></div><div><div><font size="2"   >postgres=# create table user_info(id int primary key, info text, crt_time timestamp) distribute by hash(id) to group gp0;</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "user_info_pkey" for table "user_info"</font></div><div><font size="2"   >ERROR: &nbsp;relation "user_info" already exists</font></div></div><p></p></pre></div><div>做法如下 :&nbsp;</div><div>1. 将<span style="line-height: 22px;"   >192.168.122.178的coordinator添加到现有的coordinator中.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >psql -h 192.168.122.173 -p 1921 -U postgres postgres -c "create node coordinate_6 with (type=coordinator, host='db-192-168-122-178', port=1921);"</font></div><div><font size="2"   ><span style="line-height: 22px;"   >psql -h 192.168.122.174 -p 1921 -U postgres postgres -c "create node coordinate_6 with (type=coordinator, host='db-192-168-122-178', port=1921);</span><span style="line-height: 22px;"   >"</span></font></div><div><font size="2"   ><span style="line-height: 22px;"   >psql -h 192.168.122.175 -p 1921 -U postgres postgres -c "create node coordinate_6 with (type=coordinator, host='db-192-168-122-178', port=1921);</span><span style="line-height: 22px;"   >"</span></font></div><div><font size="2"   ><span style="line-height: 22px;"   >psql -h 192.168.122.176 -p 1921 -U postgres postgres -c "create node coordinate_6 with (type=coordinator, host='db-192-168-122-178', port=1921);</span><span style="line-height: 22px;"   >"</span></font></div><div><font size="2"   ><span style="line-height: 22px;"   >psql -h 192.168.122.177 -p 1921 -U postgres postgres -c "create node coordinate_6 with (type=coordinator, host='db-192-168-122-178', port=1921);</span><span style="line-height: 22px;"   >"</span></font></div><p></p></pre></div><div># 重载pool</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >psql -h 192.168.122.173 -p 1921 -U postgres postgres -c "select pgxc_pool_reload()"</font></div><div><font size="2"   >psql -h 192.168.122.174 -p 1921 -U postgres postgres -c "select pgxc_pool_reload()"</font></div><div><font size="2"   >psql -h 192.168.122.175 -p 1921 -U postgres postgres -c "select pgxc_pool_reload()"</font></div><div><font size="2"   >psql -h 192.168.122.176 -p 1921 -U postgres postgres -c "select pgxc_pool_reload()"</font></div><div><font size="2"   >psql -h 192.168.122.177 -p 1921 -U postgres postgres -c "select pgxc_pool_reload()"</font></div><p></p></pre></div><div>2. 关闭当前所有有应用程序连接的coordinator(或者阻断他们与外界的任何连接, 包括select, dml等等), 假设当前为5个coordinator.</div><div>主要是防止现有coordinator的catalog又会发生变更(例如变更表结构, &nbsp;删除表或者新建表等等, 并且一会在192.168.122.178上还要用到其中的一个datanode来做引子, 所以务必小心操作).</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[pgxc@db-192-168-122-173]$ pg_ctl -Z coordinator stop -m fast -D /data02/pgxc_coordinate</font></div><div><div style="line-height: 22px;"   ><font size="2"   >[pgxc@db-192-168-122-174]$ pg_ctl -Z coordinator stop -m fast -D /data02/pgxc_coordinate</font></div></div><div><div style="line-height: 22px;"   ><font size="2"   >[pgxc@db-192-168-122-175]$ pg_ctl -Z coordinator stop -m fast -D /data02/pgxc_coordinate</font></div></div><div><div style="line-height: 22px;"   ><font size="2"   >[pgxc@db-192-168-122-176]$ pg_ctl -Z coordinator stop -m fast -D /data02/pgxc_coordinate</font></div></div><div><div style="line-height: 22px;"   ><font size="2"   >[pgxc@db-192-168-122-177]$ pg_ctl -Z coordinator stop -m fast -D /data02/pgxc_coordinate</font></div></div><p></p></pre></div><div>3. 连接到所有datanode, 重命名user_info表</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[pgxc@db-192-168-122-173 pgxc_ddl]$ psql -h 192.168.122.178 -p 1923 -U postgres postgres</font></div><div><font size="2"   >psql (PGXC 1.0.2, based on PG 9.1.7)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; Name &nbsp; &nbsp;| Type &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >--------+-----------+-------+----------</font></div><div><font size="2"   >&nbsp;public | t1 &nbsp; &nbsp; &nbsp; &nbsp;| table | postgres</font></div><div><font size="2"   >&nbsp;public | user_info | table | postgres</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# alter table user_info rename to digoal_user_info;</font></div><div><font size="2"   >ALTER TABLE</font></div><p></p></pre></div><div># 其他节点</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[pgxc@db-192-168-122-174 pg_log]$ psql -h 192.168.122.173 -p 1923 -U postgres postgres -c "alter table user_info rename to digoal_user_info;"</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >[pgxc@db-192-168-122-174 pg_log]$ psql -h 192.168.122.174 -p 1923 -U postgres postgres -c "alter table user_info rename to digoal_user_info;"</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >[pgxc@db-192-168-122-174 pg_log]$ psql -h 192.168.122.175 -p 1923 -U postgres postgres -c "alter table user_info rename to digoal_user_info;"</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >[pgxc@db-192-168-122-174 pg_log]$ psql -h 192.168.122.176 -p 1923 -U postgres postgres -c "alter table user_info rename to digoal_user_info;"</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >[pgxc@db-192-168-122-174 pg_log]$ psql -h 192.168.122.177 -p 1923 -U postgres postgres -c "alter table user_info rename to digoal_user_info;"</font></div><div><font size="2"   >ALTER TABLE</font></div><p></p></pre></div><div><br></div><div>4. 连接到192.168.122.178的coordinator.</div><div>删除所有除本地coordinator以外的其他coordinator节点, 然后新建<span style="line-height: 22px;"   >user_info表.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >drop node&nbsp;</span>coordinate_1;</font></div><div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >drop node&nbsp;</span>coordinate_2;</font></div></div><div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >drop node&nbsp;</span>coordinate_3;</font></div></div><div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >drop node&nbsp;</span>coordinate_4;</font></div></div><div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >drop node&nbsp;</span>coordinate_5;</font></div></div><div><div><font size="2"   >postgres=# create table user_info(id int primary key, info text, crt_time timestamp) distribute by hash(id) to group gp0;</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "user_info_pkey" for table "user_info"</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div></div><p></p></pre></div><div>5. 连接到所有datanode删除user_info表, 然后将digoal_user_info表改回user_info. 为什么要这么做呢? 参考本文参考部分的第2点.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[pgxc@db-192-168-122-178 pgxc-v1.0.2]$ psql -h 192.168.122.173 -p 1923 -U postgres postgres -c "drop table user_info;"</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >[pgxc@db-192-168-122-178 pgxc-v1.0.2]$ psql -h 192.168.122.174 -p 1923 -U postgres postgres -c "drop table user_info;"</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >[pgxc@db-192-168-122-178 pgxc-v1.0.2]$ psql -h 192.168.122.175 -p 1923 -U postgres postgres -c "drop table user_info;"</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >[pgxc@db-192-168-122-178 pgxc-v1.0.2]$ psql -h 192.168.122.176 -p 1923 -U postgres postgres -c "drop table user_info;"</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >[pgxc@db-192-168-122-178 pgxc-v1.0.2]$ psql -h 192.168.122.177 -p 1923 -U postgres postgres -c "drop table user_info;"</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >[pgxc@db-192-168-122-178 pgxc-v1.0.2]$ psql -h 192.168.122.178 -p 1923 -U postgres postgres -c "drop table user_info;"</font></div><div><font size="2"   >DROP TABLE</font></div></div><div><div><font size="2"   >[pgxc@db-192-168-122-178 pgxc-v1.0.2]$ psql -h 192.168.122.178 -p 1923 -U postgres postgres -c "alter table digoal_user_info rename to user_info;"</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >[pgxc@db-192-168-122-178 pgxc-v1.0.2]$ psql -h 192.168.122.177 -p 1923 -U postgres postgres -c "alter table digoal_user_info rename to user_info;"</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >[pgxc@db-192-168-122-178 pgxc-v1.0.2]$ psql -h 192.168.122.176 -p 1923 -U postgres postgres -c "alter table digoal_user_info rename to user_info;"</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >[pgxc@db-192-168-122-178 pgxc-v1.0.2]$ psql -h 192.168.122.175 -p 1923 -U postgres postgres -c "alter table digoal_user_info rename to user_info;"</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >[pgxc@db-192-168-122-178 pgxc-v1.0.2]$ psql -h 192.168.122.174 -p 1923 -U postgres postgres -c "alter table digoal_user_info rename to user_info;"</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >[pgxc@db-192-168-122-178 pgxc-v1.0.2]$ psql -h 192.168.122.173 -p 1923 -U postgres postgres -c "alter table digoal_user_info rename to user_info;"</font></div><div><font size="2"   >ALTER TABLE</font></div></div><p></p></pre></div><div><br></div><div>6. 连接到192.168.122.178的coordinator, 新建删除掉的coordinator.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[pgxc@db-192-168-122-178 pgxc-v1.0.2]$ psql -h 192.168.122.178 -p 1921 -U postgres postgres&nbsp;</font></div><div><font size="2"   >psql (PGXC 1.0.2, based on PG 9.1.7)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# select * from pgxc_node;</font></div><div><font size="2"   >&nbsp; node_name &nbsp; | node_type | node_port | &nbsp; &nbsp; node_host &nbsp; &nbsp; &nbsp;| nodeis_primary | nodeis_preferred | &nbsp; node_id &nbsp;&nbsp;</font></div><div><font size="2"   >--------------+-----------+-----------+--------------------+----------------+------------------+-------------</font></div><div><font size="2"   >&nbsp;datanode_1 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-173 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;-675012441</font></div><div><font size="2"   >&nbsp;datanode_2 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-174 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| -1047623914</font></div><div><font size="2"   >&nbsp;datanode_3 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-175 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;1787525382</font></div><div><font size="2"   >&nbsp;datanode_4 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-176 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; -83063638</font></div><div><font size="2"   >&nbsp;datanode_5 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-177 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; 137889650</font></div><div><font size="2"   >&nbsp;datanode_6 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-178 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;-678318491</font></div><div><font size="2"   >&nbsp;coordinate_6 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1921 | db-192-168-122-178 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;15814306</font></div><div><font size="2"   >(7 rows)</font></div></div><div><div><font size="2"   >postgres=# create node coordinate_1 with (type=coordinator, host='db-192-168-122-173', port=1921);</font></div><div><font size="2"   >CREATE NODE</font></div><div><font size="2"   >postgres=# create node coordinate_2 with (type=coordinator, host='db-192-168-122-174', port=1921);</font></div><div><font size="2"   >CREATE NODE</font></div><div><font size="2"   >postgres=# create node coordinate_3 with (type=coordinator, host='db-192-168-122-175', port=1921);</font></div><div><font size="2"   >CREATE NODE</font></div><div><font size="2"   >postgres=# create node coordinate_4 with (type=coordinator, host='db-192-168-122-176', port=1921);</font></div><div><font size="2"   >CREATE NODE</font></div><div><font size="2"   >postgres=# create node coordinate_5 with (type=coordinator, host='db-192-168-122-177', port=1921);</font></div><div><font size="2"   >CREATE NODE</font></div></div><div><div><font size="2"   >postgres=# clean connection to all for database postgres;</font></div><div><font size="2"   >CLEAN CONNECTION</font></div></div><div><div><font size="2"   >postgres=# select pgxc_pool_reload();</font></div><div><font size="2"   >&nbsp;pgxc_pool_reload&nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp;t</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>7. 启动其他coordinator</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >[pgxc@db-192-168-122-173]$ pg_ctl -Z coordinator start -D /data02/pgxc_coordinate</font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >[pgxc@db-192-168-122-174]$ pg_ctl -Z coordinator start -D /data02/pgxc_coordinate</font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >[pgxc@db-192-168-122-175]$ pg_ctl -Z coordinator start -D /data02/pgxc_coordinate</font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >[pgxc@db-192-168-122-176]$ pg_ctl -Z coordinator start -D /data02/pgxc_coordinate</font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >[pgxc@db-192-168-122-177]$ pg_ctl -Z coordinator start -D /data02/pgxc_coordinate</font></div></div><p></p></pre></div></div><div><br></div><div>[其他]</div><div>1. # 建议pg-xc提供一个dummy datanode, 这样的话修复数据就不需要用到真实的datanode了.</div><div>2. 指定to node nodename, 还是会在其他datanode执行SQL. 保持所有的datanode信息一致.</div><div>例如 :&nbsp;</div><div>datanode_1的log中看到的一条消息 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >2013-04-03 09:27:56.205 CST,"postgres","postgres",23928,"192.168.122.178:23977",515b84df.5d78,7,"idle in transaction",2013-04-03 09:24:47 CST,5/24,0,LOG,00000,"statement: create table user_info1(id int primary key, info text, crt_time timestamp) distribute by hash(id) to node datanode_6;",,,,,,,,"exec_simple_query, postgres.c:933","pgxc"</font></p></pre></div><div>所以本例修复数据可以采用另外的方法, 下一篇blog将会介绍.</div></div>
	</div>
</div>
</body>
</html>