<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL on OCZ VERTEX4 512G performance test</h2>
	<h5 id="">2013-04-11 15:13:55&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013311242145/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">测试环境 :&nbsp;<div><pre class="prettyprint"   ><p></p><div><font size="2"   >DELL R610</font></div><div><font size="2"   >CPU :&nbsp;Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >OS : Ubuntu 12.04 x64</font></div><div><font size="2"   >KERNEL :&nbsp;</font></div><div><font size="2"   >Linux digoal-PowerEdge-R610 3.5.0-26-generic #42~precise1-Ubuntu SMP Mon Mar 11 22:17:58 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux</font></div><div><font size="2"   >MEM : 98GB</font></div><div><font size="2"   >DISK :&nbsp;OCZ-VERTEX4 512GB</font></div><div><font size="2"   >RAID card :&nbsp;03:00.0 RAID bus controller: LSI Logic / Symbios Logic MegaRAID SAS 1078 (rev 04)</font></div><div><font size="2"   >Database : PostgreSQL 9.2.4</font></div><p></p></pre></div><div><br></div><div># 硬盘信息如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@digoal-PowerEdge-R610:~# smartctl -x -d megaraid,3 /dev/sdc</font></div><div><font size="2"   >smartctl 5.41 2011-06-09 r3365 [x86_64-linux-3.5.0-26-generic] (local build)</font></div><div><font size="2"   >Copyright (C) 2002-11 by Bruce Allen, http://smartmontools.sourceforge.net</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >/dev/sdc [megaraid_disk_03] [SAT]: Device open changed type from 'megaraid' to 'sat'</font></div><div><font size="2"   >=== START OF INFORMATION SECTION ===</font></div><div><font size="2"   >Device Model: &nbsp; &nbsp; OCZ-VERTEX4</font></div><div><font size="2"   >Serial Number: &nbsp; &nbsp;OCZ-69ZP9CV0NG6QQTCH</font></div><div><font size="2"   >LU WWN Device Id: 5 e83a97 b67351960</font></div><div><font size="2"   >Firmware Version: 1.5</font></div><div><font size="2"   >User Capacity: &nbsp; &nbsp;512,110,190,592 bytes [512 GB]</font></div><div><font size="2"   >Sector Size: &nbsp; &nbsp; &nbsp;512 bytes logical/physical</font></div><div><font size="2"   >Device is: &nbsp; &nbsp; &nbsp; &nbsp;Not in smartctl database [for details use: -P showall]</font></div><div><font size="2"   >ATA Version is: &nbsp; 9</font></div><div><font size="2"   >ATA Standard is: &nbsp;Exact ATA specification draft version not indicated</font></div><div><font size="2"   >Local Time is: &nbsp; &nbsp;Thu Apr 11 14:42:32 2013 CST</font></div><div><font size="2"   >SMART support is: Available - device has SMART capability.</font></div><div><font size="2"   >SMART support is: Enabled</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >=== START OF READ SMART DATA SECTION ===</font></div><div><font size="2"   >SMART overall-health self-assessment test result: PASSED</font></div><div><font size="2"   >Warning: This result is based on an Attribute check.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >General SMART Values:</font></div><div><font size="2"   >Offline data collection status: &nbsp;(0x00) Offline data collection activity</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; was never started.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Auto Offline Data Collection: Disabled.</font></div><div><font size="2"   >Self-test execution status: &nbsp; &nbsp; &nbsp;( &nbsp; 0) The previous self-test routine completed</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; without error or no self-test has ever&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; been run.</font></div><div><font size="2"   >Total time to complete Offline&nbsp;</font></div><div><font size="2"   >data collection: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;( &nbsp; &nbsp;0) seconds.</font></div><div><font size="2"   >Offline data collection</font></div><div><font size="2"   >capabilities: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(0x1d) SMART execute Offline immediate.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; No Auto Offline data collection support.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Abort Offline collection upon new</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; command.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Offline surface scan supported.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Self-test supported.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; No Conveyance Self-test supported.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; No Selective Self-test supported.</font></div><div><font size="2"   >SMART capabilities: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(0x0003) Saves SMART data before entering</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; power-saving mode.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Supports SMART auto save timer.</font></div><div><font size="2"   >Error logging capability: &nbsp; &nbsp; &nbsp; &nbsp;(0x00) Error logging NOT supported.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; General Purpose Logging supported.</font></div><div><font size="2"   >Short self-test routine&nbsp;</font></div><div><font size="2"   >recommended polling time: &nbsp; &nbsp; &nbsp; &nbsp;( &nbsp; 0) minutes.</font></div><div><font size="2"   >Extended self-test routine</font></div><div><font size="2"   >recommended polling time: &nbsp; &nbsp; &nbsp; &nbsp;( &nbsp; 0) minutes.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SMART Attributes Data Structure revision number: 18</font></div><div><font size="2"   >Vendor Specific SMART Attributes with Thresholds:</font></div><div><font size="2"   >ID# ATTRIBUTE_NAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FLAGS &nbsp; &nbsp;VALUE WORST THRESH FAIL RAW_VALUE</font></div><div><font size="2"   >&nbsp; 1 Raw_Read_Error_Rate &nbsp; &nbsp; ------ &nbsp; 007 &nbsp; 000 &nbsp; 000 &nbsp; &nbsp;- &nbsp; &nbsp;7</font></div><div><font size="2"   >&nbsp; 3 Spin_Up_Time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;------ &nbsp; 100 &nbsp; 100 &nbsp; 000 &nbsp; &nbsp;- &nbsp; &nbsp;0</font></div><div><font size="2"   >&nbsp; 4 Start_Stop_Count &nbsp; &nbsp; &nbsp; &nbsp;------ &nbsp; 100 &nbsp; 100 &nbsp; 000 &nbsp; &nbsp;- &nbsp; &nbsp;0</font></div><div><font size="2"   >&nbsp; 5 Reallocated_Sector_Ct &nbsp; ------ &nbsp; 100 &nbsp; 100 &nbsp; 000 &nbsp; &nbsp;- &nbsp; &nbsp;0</font></div><div><font size="2"   >&nbsp; 9 Power_On_Hours &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;------ &nbsp; 100 &nbsp; 100 &nbsp; 000 &nbsp; &nbsp;- &nbsp; &nbsp;83</font></div><div><font size="2"   >&nbsp;12 Power_Cycle_Count &nbsp; &nbsp; &nbsp; ------ &nbsp; 100 &nbsp; 100 &nbsp; 000 &nbsp; &nbsp;- &nbsp; &nbsp;9</font></div><div><font size="2"   >232 Available_Reservd_Space ------ &nbsp; 100 &nbsp; 100 &nbsp; 000 &nbsp; &nbsp;- &nbsp; &nbsp;6835587931</font></div><div><font size="2"   >233 Media_Wearout_Indicator ------ &nbsp; 100 &nbsp; 000 &nbsp; 000 &nbsp; &nbsp;- &nbsp; &nbsp;100</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ||||||_ K auto-keep</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |||||__ C event count</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ||||___ R error rate</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |||____ S speed/performance</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ||_____ O updated online</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |______ P prefailure warning</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >General Purpose Log Directory Version 0</font></div><div><font size="2"   >SMART &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Log Directory Version 1 [multi-sector log support]</font></div><div><font size="2"   >GP/S &nbsp;Log at address 0x00 has &nbsp; &nbsp;1 sectors [Log Directory]</font></div><div><font size="2"   >SMART Log at address 0x06 has &nbsp; &nbsp;1 sectors [SMART self-test log]</font></div><div><font size="2"   >SMART Log at address 0x07 has &nbsp; &nbsp;1 sectors [Extended self-test log]</font></div><div><font size="2"   >SMART Log at address 0x09 has &nbsp; &nbsp;1 sectors [Selective self-test log]</font></div><div><font size="2"   >SMART Log at address 0x10 has &nbsp; &nbsp;1 sectors [NCQ Command Error]</font></div><div><font size="2"   >SMART Log at address 0xa0 has &nbsp;255 sectors [Device vendor specific log]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SMART Extended Comprehensive Error Log (GP Log 0x03) not supported</font></div><div><font size="2"   >SMART Error Log not supported</font></div><div><font size="2"   >SMART Extended Self-test Log (GP Log 0x07) not supported</font></div><div><font size="2"   >Warning! SMART Self-Test Log Structure error: invalid SMART checksum.</font></div><div><font size="2"   >SMART Self-test log structure revision number 1</font></div><div><font size="2"   >No self-tests have been logged. &nbsp;[To run self-tests, use: smartctl -t]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Device does not support Selective Self Tests/Logging</font></div><div><font size="2"   >Warning: device does not support SCT Commands</font></div><div><font size="2"   >SATA Phy Event Counters (GP Log 0x11) not supported</font></div><p></p></pre></div><div><br></div><div># 关闭raid cache后的iops测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; cd /data04/pg92</font></div><div><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; pg_test_fsync&nbsp;</font></div><div><font size="2"   >2 seconds per test</font></div><div><font size="2"   >O_DIRECT supported on this platform for open_datasync and open_sync.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Compare file sync methods using one 16kB write:</font></div><div><font size="2"   >(in wal_sync_method preference order, except fdatasync</font></div><div><font size="2"   >is Linux's default)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open_datasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11309.527 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9873.674 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fsync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9083.037 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fsync_writethrough &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;n/a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open_sync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 10592.235 ops/sec</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Compare file sync methods using two 16kB writes:</font></div><div><font size="2"   >(in wal_sync_method preference order, except fdatasync</font></div><div><font size="2"   >is Linux's default)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open_datasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5739.670 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6533.026 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fsync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5925.739 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fsync_writethrough &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;n/a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open_sync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5277.821 ops/sec</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Compare open_sync with different write sizes:</font></div><div><font size="2"   >(This is designed to compare the cost of writing 16kB</font></div><div><font size="2"   >in different write open_sync sizes.)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 * 16kB open_sync write &nbsp; &nbsp; &nbsp; 10545.957 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 * &nbsp;8kB open_sync writes &nbsp; &nbsp; &nbsp; 6830.758 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 * &nbsp;4kB open_sync writes &nbsp; &nbsp; &nbsp; 3976.476 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8 * &nbsp;2kB open_sync writes &nbsp; &nbsp; &nbsp; 2178.427 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16 * &nbsp;1kB open_sync writes &nbsp; &nbsp; &nbsp; 1130.901 ops/sec</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Test if fsync on non-write file descriptor is honored:</font></div><div><font size="2"   >(If the times are similar, fsync() can sync data written</font></div><div><font size="2"   >on a different descriptor.)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; write, fsync, close &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8421.806 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; write, close, fsync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8394.089 ops/sec</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Non-Sync'ed 16kB writes:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; write &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 146398.402 ops/sec</font></div></div><p></p></pre></div><div><br></div><div>测试模型参考 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201221382150858/"   >http://blog.163.com/digoal@126/blog/static/163877040201221382150858/</a></div><div>包含:select, insert, update.</div><div><br></div><div>测试表 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create table user_info</font></div><div><font size="2"   >(userid int,</font></div><div><font size="2"   >engname text,</font></div><div><font size="2"   >cnname text,</font></div><div><font size="2"   >occupation text,</font></div><div><font size="2"   >birthday date,</font></div><div><font size="2"   >signname text,</font></div><div><font size="2"   >email text,</font></div><div><font size="2"   >qq numeric,</font></div><div><font size="2"   >crt_time timestamp without time zone,</font></div><div><font size="2"   >mod_time timestamp without time zone</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create table user_session</font></div><div><font size="2"   >(userid int,</font></div><div><font size="2"   >logintime timestamp(0) without time zone,</font></div><div><font size="2"   >login_count bigint default 0,</font></div><div><font size="2"   >logouttime timestamp(0) without time zone,</font></div><div><font size="2"   >online_interval interval default interval '0'</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create table user_login_rec</font></div><div><font size="2"   >(userid int,</font></div><div><font size="2"   >login_time timestamp without time zone,</font></div><div><font size="2"   >ip inet</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create table user_logout_rec</font></div><div><font size="2"   >(userid int,</font></div><div><font size="2"   >logout_time timestamp without time zone,</font></div><div><font size="2"   >ip inet</font></div><div><font size="2"   >);</font></div><p></p></pre></div><div><br></div><div>初始化数据 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >insert into user_info (userid,engname,cnname,occupation,birthday,signname,email,qq,crt_time,mod_time)</font></div><div><font size="2"   >select generate_series(1,20000000),</font></div><div><font size="2"   >'digoal.zhou',</font></div><div><font size="2"   >'德哥',</font></div><div><font size="2"   >'DBA',</font></div><div><font size="2"   >'1970-01-01'</font></div><div><font size="2"   >,E'公益是一辈子的事, I\'m Digoal.Zhou, Just do it!',</font></div><div><font size="2"   >'digoal@126.com',</font></div><div><font size="2"   >276732431,</font></div><div><font size="2"   >clock_timestamp(),</font></div><div><font size="2"   >NULL;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >insert into user_session (userid) select generate_series(1,20000000);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >set work_mem='2048MB';</font></div><div><font size="2"   >set maintenance_work_mem='2048MB';</font></div><div><font size="2"   >alter table user_info add constraint pk_user_info primary key (userid);</font></div><div><font size="2"   >alter table user_session add constraint pk_user_session primary key (userid);</font></div><p></p></pre></div><div><br></div><div>测试函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-- 模拟用户登录的函数</font></div><div><font size="2"   >create or replace function f_user_login&nbsp;</font></div><div><font size="2"   >(i_userid int,</font></div><div><font size="2"   >OUT o_userid int,</font></div><div><font size="2"   >OUT o_engname text,</font></div><div><font size="2"   >OUT o_cnname text,</font></div><div><font size="2"   >OUT o_occupation text,</font></div><div><font size="2"   >OUT o_birthday date,</font></div><div><font size="2"   >OUT o_signname text,</font></div><div><font size="2"   >OUT o_email text,</font></div><div><font size="2"   >OUT o_qq numeric</font></div><div><font size="2"   >)</font></div><div><font size="2"   >as $BODY$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div><font size="2"   >into o_userid,o_engname,o_cnname,o_occupation,o_birthday,o_signname,o_email,o_qq</font></div><div><font size="2"   >from user_info where userid=i_userid;</font></div><div><font size="2"   >insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"   >update user_session set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div><font size="2"   >return;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$BODY$</font></div><div><font size="2"   >language plpgsql;</font></div><div><font size="2"   >-- 模拟用户退出的函数</font></div><div><font size="2"   >create or replace function f_user_logout</font></div><div><font size="2"   >(i_userid int,</font></div><div><font size="2"   >OUT o_result int</font></div><div><font size="2"   >)</font></div><div><font size="2"   >as $BODY$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >insert into user_logout_rec (userid,logout_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"   >update user_session set logouttime=now(),online_interval=online_interval+(now()-logintime) where userid=i_userid;</font></div><div><font size="2"   >o_result := 0;</font></div><div><font size="2"   >return;</font></div><div><font size="2"   >exception&nbsp;</font></div><div><font size="2"   >when others then</font></div><div><font size="2"   >o_result := 1;</font></div><div><font size="2"   >return;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$BODY$</font></div><div><font size="2"   >language plpgsql;</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"   >数据库配置 :&nbsp;</span></div><div><span style="line-height: 22px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"   >port = 1919 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >max_connections = 8000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >superuser_reserved_connections = 13 &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_directory = '.' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_permissions = 0700 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# begin with 0 to use octal notation</font></div><div><font size="2"   >tcp_keepalives_idle = 60 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPIDLE, in seconds;</font></div><div><font size="2"   >tcp_keepalives_interval = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPINTVL, in seconds;</font></div><div><font size="2"   >tcp_keepalives_count = 1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPCNT;</font></div><div><font size="2"   >shared_buffers = 8096MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div><font size="2"   >max_prepared_transactions = 100 &nbsp; &nbsp; &nbsp; &nbsp; # zero disables the feature</font></div><div><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div><font size="2"   >max_stack_depth = 6MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 100kB</font></div><div><font size="2"   >synchronous_commit = on &nbsp; &nbsp; &nbsp; &nbsp; # synchronization level;</font></div><div><font size="2"   >wal_sync_method = open_datasync &nbsp; &nbsp; &nbsp; &nbsp; # the default is the first option</font></div><div><font size="2"   >checkpoint_segments = 128 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # in logfile segments, min 1, 16MB each</font></div><div><font size="2"   >random_page_cost = 1.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# same scale as above</font></div><div><font size="2"   >effective_cache_size = 81920MB</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_directory = 'pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,</font></div><div><font size="2"   >log_file_mode = 0600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# creation mode for log files,</font></div><div><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div><font size="2"   >log_rotation_age = 1d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Automatic rotation of logfiles will</font></div><div><font size="2"   >log_rotation_size = 10MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Automatic rotation of logfiles will</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_disconnections = on</font></div><div><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div><font size="2"   >log_timezone = 'PRC'</font></div><div><font size="2"   >log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >timezone = 'PRC'</font></div><div><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"   >raid配置 :&nbsp;</span></div><div><span style="line-height: 22px;"   >(改成write back, 相当于启用RAID写缓存)</span></div><div><div><img title="PostgreSQL OCZ VERTEX4 512G performance test - 德哥@Digoal - The Heart,The World."   alt="PostgreSQL OCZ VERTEX4 512G performance test - 德哥@Digoal - The Heart,The World."   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/rKFLGK_EOa8eOAEVIKP56A==/6597966968145943103.png"   ></div>&nbsp;</div></span></div><div>测试结果 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg92@db-172-16-3-33-&gt; cat login.sql&nbsp;</font></div><div><font size="2"   >\setrandom userid 1 20000000</font></div><div><font size="2"   >SELECT f_user_login(:userid);</font></div></div><div><font size="2"   >pg92@db-172-16-3-33-&gt; nohup pgbench -M prepared -r -c 16 -f ./login.sql -j 8 -n -T 1800 -h 172.16.3.150 -p 1919 -U postgres postgres &gt;&gt;./bench.log 2&gt;&amp;1 &amp;</font></div><div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 1800 s</font></div><div><font size="2"   >number of transactions actually processed: 24242107</font></div><div><font size="2"   >tps = 13467.713701 (including connections establishing)</font></div><div><font size="2"   >tps = 13467.789458 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001491 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 20000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.184882 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login(:userid);</font></div></div><p></p></pre></div><div><div><br></div><div><span style="line-height: 22px;"   >raid配置 :&nbsp;</span></div><div><span style="line-height: 22px;"   >(改成write through, 相当于不启用RAID写缓存)</span></div><div><div><img title="PostgreSQL OCZ VERTEX4 512G performance test - 德哥@Digoal - The Heart,The World."   alt="PostgreSQL OCZ VERTEX4 512G performance test - 德哥@Digoal - The Heart,The World."   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/MXbtm1pWWe7SXRHsXCb4Ow==/6597963669611059828.png"   ></div>&nbsp;</div><div><div style="line-height: 22px;"   >测试结果 :&nbsp;</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >pg92@db-172-16-3-33-&gt; cat login.sql&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 1 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login(:userid);</font></div><div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 1800 s</font></div><div><font size="2"   >number of transactions actually processed: 25311714</font></div><div><font size="2"   >tps = 14061.938174 (including connections establishing)</font></div><div><font size="2"   >tps = 14062.024086 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001499 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 20000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.134695 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login(:userid);</font></div></div><p></p></pre></div><div># 性能超越开启raid cache的情况.</div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >iostat :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >avg-cpu: &nbsp;%user &nbsp; %nice %system %iowait &nbsp;%steal &nbsp; %idle</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 60.64 &nbsp; &nbsp;0.00 &nbsp; 13.89 &nbsp; &nbsp;2.42 &nbsp; &nbsp;0.00 &nbsp; 23.06</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Device: &nbsp; &nbsp; &nbsp; &nbsp; rrqm/s &nbsp; wrqm/s &nbsp; &nbsp; r/s &nbsp; &nbsp; w/s &nbsp; &nbsp;rkB/s &nbsp; &nbsp;wkB/s avgrq-sz avgqu-sz &nbsp; await r_await w_await &nbsp;svctm &nbsp;%util</font></div><div><font size="2"   >sda &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; &nbsp;0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div><font size="2"   >sdb &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; &nbsp;0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div><font size="2"   >sdc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 7.00 &nbsp; &nbsp;1.00 5076.00 &nbsp; &nbsp;56.00 86788.00 &nbsp; &nbsp;34.21 &nbsp; &nbsp; 0.46 &nbsp; &nbsp;0.09 &nbsp; &nbsp;4.00 &nbsp; &nbsp;0.09 &nbsp; 0.09 &nbsp;45.20</font></div><div><font size="2"   >dm-0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;1.00 5083.00 &nbsp; &nbsp;56.00 86788.00 &nbsp; &nbsp;34.16 &nbsp; &nbsp; 0.44 &nbsp; &nbsp;0.09 &nbsp; &nbsp;4.00 &nbsp; &nbsp;0.09 &nbsp; 0.09 &nbsp;43.60</font></div><p></p></pre></div></div></div><div><span style="line-height: 22px;"   ><div>表大小 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \dt+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; | Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp; &nbsp;Size &nbsp; &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+-----------------+-------+----------+------------+-------------</font></div><div><font size="2"   >&nbsp;public | user_info &nbsp; &nbsp; &nbsp; | table | postgres | 3006 MB &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_login_rec &nbsp;| table | postgres | 4220 MB &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_logout_rec | table | postgres | 8192 bytes |&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_session &nbsp; &nbsp;| table | postgres | 1496 MB &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div><div><br></div></span></div><div><span style="line-height: 22px;"   >[小结]</span></div><div><span style="line-height: 22px;"   >1. OCZ vertex 4的硬盘素质还算不错. 关闭raid 写cache的情况下. util没到100%</span></div><div><span style="line-height: 22px;"   >2. 在多次restart -m immediate的情形下, 未出现数据丢失以及阿弟测试中出现的主键重复的现象.</span></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >[参考]</span></div><div><span style="line-height: 22px;"   >1.&nbsp;</span><a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201221382150858/"   >http://blog.163.com/digoal@126/blog/static/163877040201221382150858/</a></div><wbr></div></div>
	</div>
</div>
</body>
</html>