<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Postgres-XC compare 4 distribute method insert speed and copy speed</h2>
	<h5 id="">2013-04-05 23:49:03&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013356404821/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>本文主要测试Postgres-XC的几种分布式策略下的insert, copy的性能与单节点的性能比对.</div><div><br></div><div>【环境】</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >gtm : 172.16.19.11</font></div><div><font size="2"   >gtm_standby :&nbsp;<span style="line-height: 22px;"   >172.16.19.13</span></font></div><div><font size="2"   >coordinator :&nbsp;<span style="line-height: 22px;"   >172.16.19.13</span></font></div><div><font size="2"   >datanode :&nbsp;<span style="line-height: 22px;"   >172.16.19.11,&nbsp;</span><span style="line-height: 22px;"   >172.16.19.13,&nbsp;</span><span style="line-height: 22px;"   >172.16.19.15,&nbsp;</span><span style="line-height: 22px;"   >172.16.19.17,&nbsp;</span><span style="line-height: 22px;"   >172.16.19.19</span></font></div><p></p></pre></div><div><br></div><div>【测试】</div><div>1. insert</div><div>Postgres-XC, round robin :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >$ psql -h 172.16.19.13</font></div><div><font size="2"   >psql (PGXC 1.0.2, based on PG 9.1.7)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><font size="2"   >postgres=#</font></div><div><div><font size="2"   >digoal=&gt; create table test(id int primary key, info text) tablespace tbs_digoal distribute by round robin to group gp0;</font></div><div><font size="2"   >ERROR: &nbsp;Cannot locally enforce a unique index on round robin distributed table.</font></div></div><p></p></pre></div><div><div># 因为轮循模式没法保证单一节点的唯一约束, 所以不允许在round robin分发策略中使用唯一约束.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; \c digoal postgres</font></div><div><font size="2"   >You are now connected to database "digoal" as user "postgres".</font></div><div><font size="2"   >digoal=# create node group gp0 WITH datanode_1,datanode_2,datanode_3,datanode_4,datanode_5;</font></div></div><div><font size="2"   >digoal=&gt; create table test(id int, info text) tablespace tbs_digoal distribute by round robin to group gp0;</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div></div><div># 插入10W条数据.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; \timing</font></div><div><font size="2"   >Timing is on.</font></div></div><div><div><font size="2"   >digoal=&gt; insert into test select generate_series(1,100000),repeat('digoal',100);</font></div><div><font size="2"   >INSERT 0 100000</font></div><div><font size="2"   >Time: 36311.054 ms</font></div></div><p></p></pre></div><div>每秒插入2754条.</div><div><br></div><div><span style="line-height: 22px;"   >Postgres-XC, hash :&nbsp;</span></div><div><span style="line-height: 22px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create table test1(id int, info text) tablespace tbs_digoal distribute by hash(id) to group gp0;</font></div><div><font size="2"   >CREATE TABLE</font></div><div><div><font size="2"   >digoal=&gt; insert into test1 select generate_series(1,100000),repeat('digoal',100);</font></div><div><font size="2"   >INSERT 0 100000</font></div><div><font size="2"   >Time: 34532.678 ms</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >每秒插入2896条.</span></div></span></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >Postgres-XC, modulo :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create table test2(id int, info text) tablespace tbs_digoal distribute by modulo(id) to group gp0;</font></div><div><font size="2"   >CREATE TABLE</font></div><div><div><font size="2"   >digoal=&gt; insert into test2 select generate_series(1,100000),repeat('digoal',100);</font></div><div><font size="2"   >INSERT 0 100000</font></div><div><font size="2"   >Time: 36091.095 ms</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >每秒插入2771条.</span></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >Postgres-XC, replication :&nbsp;</span></div><div><span style="line-height: 22px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create table test3(id int, info text) tablespace tbs_digoal distribute by replication to group gp0;</font></div><div><font size="2"   >CREATE TABLE</font></div><div><div><font size="2"   >digoal=&gt; insert into test3 select generate_series(1,100000),repeat('digoal',100);</font></div><div><font size="2"   >INSERT 0 100000</font></div><div><font size="2"   >Time: 31529.019 ms</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >每秒插入3172条.</span></div></span></div><div><span style="line-height: 22px;"   ><br></span></div><div>PostgreSQL :&nbsp;</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 22px;"   ><font size="2"   >$ psql digoal digoal</font></div><div style="line-height: 22px;"   ><font size="2"   >psql (9.2.3)</font></div><div style="line-height: 22px;"   ><font size="2"   >Type "help" for help.</font></div></div><div><div><font size="2"   >digoal=&gt; create table test(id int, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >digoal=&gt; \timing</font></div><div><font size="2"   >Timing is on.</font></div><div><font size="2"   >digoal=&gt; insert into test select generate_series(1,100000),repeat('digoal',100);</font></div><div><font size="2"   >INSERT 0 100000</font></div><div><font size="2"   >Time: 731.288 ms</font></div></div><p></p></pre></div></div><div>每秒插入136745条.</div><div><br></div><div>2. copy</div><div>Postgres-XC, copy to file :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# set search_path='digoal';</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# copy digoal.test to '/home/postgres/test.csv' with(format csv, header false);</font></div><div><font size="2"   >COPY 100000</font></div><div><font size="2"   >Time: 514.814 ms</font></div><p></p></pre></div><div>每秒COPY OUT 194245 条.</div><div><br></div><div>Postgres-XC, copy from file :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# copy digoal.test from '/home/postgres/test.csv' with(format csv, header false);</font></div><div><font size="2"   >COPY 100000</font></div><div><font size="2"   >Time: 933.529 ms</font></div><p></p></pre></div><div>每秒COPY IN&nbsp;107120&nbsp;条.</div><div><br></div><div>PostgreSQL, copy to file :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# copy test to '/data01/postgres/test.csv' with(format csv, header false);</font></div><div><font size="2"   >COPY 100000</font></div><div><font size="2"   >Time: 660.987 ms</font></div><p></p></pre></div><div>每秒COPY OUT&nbsp;151289&nbsp;条.</div></div><div><span style="line-height: 22px;"   ><br></span></div><div>PostgreSQL, copy from file :&nbsp;</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >digoal=# copy test from '/data01/postgres/test.csv' with(format csv, header false);</font></div><div style="line-height: 22px;"   ><font size="2"   >COPY 100000</font></div><div style="line-height: 22px;"   ><font size="2"   >Time: 1614.158 ms</font></div><p></p></pre></div></div><div><span style="line-height: 22px;"   >每秒COPY IN &nbsp;</span>61952&nbsp;<span style="line-height: 22px;"   >条.</span></div><div style="line-height: 22px;"   ><br></div><div>3. select</div><div>Postgres-XC :&nbsp;</div><div># group by hash列</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select count(*) from (select id from test2 group by id) t;</font></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;100000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 136.235 ms</font></div></div><div><div><font size="2"   >digoal=# explain select count(*) from (select id from test2 group by id) t;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Aggregate &nbsp;(cost=2.52..2.53 rows=1 width=0)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;HashAggregate &nbsp;(cost=2.50..2.51 rows=1 width=4)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Materialize &nbsp;(cost=0.00..0.00 rows=0 width=0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Data Node Scan on "__REMOTE_GROUP_QUERY__" &nbsp;(cost=0.00..0.00 rows=1000 width=4)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Node/s: datanode_1, datanode_2, datanode_3, datanode_4, datanode_5</font></div><div><font size="2"   >(5 rows)</font></div></div><p></p></pre></div><div><div><br></div><div># 窗口函数</div><div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select count(*) from (select id,info from (select id,info,row_number() over(partition by id order by info desc) as rn from test2)t where rn=1) t;</font></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;100000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 805.109 ms</font></div></div><div><div><font size="2"   >digoal=# explain select count(*) from (select id,info from (select id,info,row_number() over(partition by id order by info desc) as rn from test2)t where rn=1) t;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Aggregate &nbsp;(cost=82.34..82.35 rows=1 width=0)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Subquery Scan on t &nbsp;(cost=49.83..82.33 rows=5 width=0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (t.rn = 1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;WindowAgg &nbsp;(cost=49.83..69.83 rows=1000 width=36)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=49.83..52.33 rows=1000 width=36)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: test2.id, test2.info</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Result &nbsp;(cost=0.00..0.00 rows=1000 width=36)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Data Node Scan on test2 &nbsp;(cost=0.00..0.00 rows=1000 width=36)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Node/s: datanode_1, datanode_2, datanode_3, datanode_4, datanode_5</font></div><div><font size="2"   >(9 rows)</font></div></div><p></p></pre></div></div><div><div># 聚合函数</div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select max(id) from test2;</font></div><div><font size="2"   >&nbsp; max &nbsp;&nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;100000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 8.352 ms</font></div><p></p></pre></div><div><br></div></div><div>PostgreSQL :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select count(*) from (select id from test group by id) t;</font></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;100000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 294.653 ms</font></div></div><div><div><font size="2"   >digoal=# select count(*) from (select id,info from (select id,info,row_number() over(partition by id order by info desc) as rn from test)t where rn=1) t;</font></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;100000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 755.836 ms</font></div><div><font size="2"   >digoal=# explain select count(*) from (select id,info from (select id,info,row_number() over(partition by id order by info desc) as rn from test)t where rn=1) t;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Aggregate &nbsp;(cost=135359.14..135359.15 rows=1 width=0)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Subquery Scan on t &nbsp;(cost=128856.64..135356.64 rows=1000 width=0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (t.rn = 1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;WindowAgg &nbsp;(cost=128856.64..132856.64 rows=200000 width=608)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=128856.64..129356.64 rows=200000 width=608)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: test.id, test.info</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on test &nbsp;(cost=0.00..18667.00 rows=200000 width=608)</font></div><div><font size="2"   >(7 rows)</font></div><div><div><font size="2"   >digoal=# select max(id) from test;</font></div><div><font size="2"   >&nbsp; max &nbsp;&nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;100000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 56.967 ms</font></div></div></div><p></p></pre></div><div><br></div><div><br></div><div>【小结】</div><div>1. Postgres-XC的INSERT语句性能较差, 需要通过增加coordinator节点来解决, 或者提高coordinator节点的insert效率.</div><div>2. Postgres-XC的COPY性能要比单节点的PostgreSQL的COPY性能好.</div><div><br></div><div><br></div>【参考】<wbr><div>1.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020133292915600/"   >http://blog.163.com/digoal@126/blog/static/16387704020133292915600/</a></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">xmarker - 2013-10-02 19:47:10</h5>
				<div>看了很多楼主的博客，写的很不错，想几个问题，<div>1.postgres-xc在真实环境中用的多么？</div><div>2.在数据仓库报表查询类的业务中，用postgres-xc的mpp性能怎么样?有什么优缺点？ 特别是缺点。<br>3.有更值得推荐的大数据量数据仓库报表查询类的pg解决方案么？</div><div>希望能得到您的指导和意见，谢谢</div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 xmarker - 2013-10-02 19:47:10</h5>
				<div style="width:600px;">HI, 推荐使用greenplum.<div>pgxc尚不成熟.</div></div>
			</div>
	</div>
</div>
</body>
</html>