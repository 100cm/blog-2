<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL real-time count(*) performance tuning case - 2</h2>
	<h5 id="">2013-04-15 13:57:04&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020133151402415/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">接上一篇blog<div><a href="http://blog.163.com/digoal@126/blog/static/163877040201331252945440/"   >http://blog.163.com/digoal@126/blog/static/163877040201331252945440/</a></div><div>上一篇blog的后面一部分讲解了如何利用advisory lock来规避死锁的问题.</div><div>但是在事务中如果a的dml sql只有1条, 即不可能发生死锁的情况下, 这种方法性能远不如不做死锁规避的函数.&nbsp;</div><div>因此还有其他更优秀的方法来规避死锁吗?</div><div>当然有的, 这里就要介绍另一种方法, 结合Linux process id来使用.</div><div>当一个客户端连接PostgreSQL的时候, Postgres进行会fork一个进程出来, 称为PostgreSQL backend process. 这个进程负责与客户端进行交互.</div><div>接下来就要用PostgreSQL backend process的process id来标记cnt_a中的id字段.</div><div>因为同一时间点每个backend process 的pid不一样, 完全规避了死锁的问题.</div><div>具体方法如下 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create table a(id serial4 primary key, info text, crt_time timestamp(0) default now());</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE will create implicit sequence "a_id_seq" for serial column "a.id"</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "a_pkey" for table "a"</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# create table cnt_a(id int primary key, cnt int);</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "cnt_a_pkey" for table "cnt_a"</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># cnt_a不需要初始值了</span></div><div><br></div><div># 创建插入触发器函数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION public.tg_insert_a()</font></div><div><font size="2"   >&nbsp;RETURNS trigger</font></div><div><font size="2"   >&nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; update cnt_a set cnt=cnt+1 where id=pg_backend_pid();</font></div><div><font size="2"   >&nbsp; if not found then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into cnt_a(id, cnt) values (pg_backend_pid(), 1);</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; return null;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div># 创建删除触发器函数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION public.tg_delete_a()</font></div><div><font size="2"   >&nbsp;RETURNS trigger</font></div><div><font size="2"   >&nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; update cnt_a set cnt=cnt-1 where id=pg_backend_pid();</font></div><div><font size="2"   >&nbsp; if not found then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into cnt_a(id, cnt) values (pg_backend_pid(), -1);</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; return null;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div>#　创建truncate触发器函数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION public.tg_truncate_a()</font></div><div><font size="2"   >&nbsp;RETURNS trigger</font></div><div><font size="2"   >&nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; update cnt_a set cnt=0 where not cnt=0;</font></div><div><font size="2"   >&nbsp; return null;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div><br></div><div># 创建触发器</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create trigger tg1 after insert on a for each row execute procedure tg_insert_a();</font></div><div><font size="2"   >create trigger tg2 after delete on a for each row execute procedure tg_delete_a();</font></div><div><font size="2"   >create trigger tg3 after truncate on a for each statement execute procedure tg_truncate_a();</font></div><p></p></pre></div><div><br></div><div># 测试单dmlsql场景pgbench, 有显著提升.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; pgbench -M prepared -r -n -f ./insert.sql -h $PGDATA -p 1919 -U postgres -T 60 -c 16 -j 4 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 2137104</font></div><div><font size="2"   >tps = 35606.972536 (including connections establishing)</font></div><div><font size="2"   >tps = 35615.523750 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.447084 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 验证</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select count(*) from a;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;2137104</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select sum(cnt) from cnt_a ;</font></div><div><font size="2"   >&nbsp; &nbsp;sum &nbsp;&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;2137104</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 测试多dmlsql场景pgbench, 有显著提升.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; pgbench -M prepared -r -n -f ./id.sql -h $PGDATA -p 1919 -U postgres -T 60 -c 16 -j 4 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 275704</font></div><div><font size="2"   >tps = 4593.421227 (including connections establishing)</font></div><div><font size="2"   >tps = 4594.495475 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003119 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 20000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.179727 &nbsp; &nbsp; &nbsp; &nbsp;begin;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.215766 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.215785 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.335462 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.222234 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.328336 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.222417 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.325938 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.221347 &nbsp; &nbsp; &nbsp; &nbsp;delete from a where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.325768 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.329100 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.328841 &nbsp; &nbsp; &nbsp; &nbsp;insert into a (info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.212162 &nbsp; &nbsp; &nbsp; &nbsp;end;</font></div><p></p></pre></div><div># 验证</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select count(*) from a;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;3791328</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select sum(cnt) from cnt_a ;</font></div><div><font size="2"   >&nbsp; &nbsp;sum &nbsp;&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;3791328</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div></div><div>[小结]</div><div>1. # 需要注意, 因为linux进程id范围可能会比较大, 最后cnt_a表也许会变得比较大.</div><div># 如果有方法能够限定启动postgresql数据库用户的pid分配范围, 那么这将不会成为一个问题.</div><div># 当然你也可以对cnt_a表进行整理, 合并掉一些记录. 给cnt_a表瘦身.&nbsp;</div><div>如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# select * from cnt_a limit 1;</font></div><div><font size="2"   >&nbsp; id &nbsp; | &nbsp;cnt &nbsp;&nbsp;</font></div><div><font size="2"   >-------+--------</font></div><div><font size="2"   >&nbsp;11305 | 122315</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select sum(cnt) from cnt_a ;</font></div><div><font size="2"   >&nbsp; &nbsp;sum &nbsp;&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;3791328</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# update cnt_a set cnt=3791328 where id=11305;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# delete from cnt_a where id&lt;&gt;11305;</font></div><div><font size="2"   >DELETE 31</font></div><div><font size="2"   >postgres=# end;</font></div><div><font size="2"   >COMMIT</font></div><p></p></pre></div><div>2. 应用本例的触发器函数, 最终的dml qps如下 :&nbsp;</div><div>单事务单dml sql场景 : 35615 qps</div><div>单事务多dml sql场景 : 50534 qps</div><div><br></div><div><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 25px;"   >[参考]</span><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><div style="line-height: 25px;"   >为方便大家查询, 汇总PostgreSQL实时和非实时数据统计的案例分析文章系列 - 如下 :&nbsp;</div><div style="line-height: 25px;"   >1.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201331252945440/"   >http://blog.163.com/digoal@126/blog/static/163877040201331252945440/</a></div><div style="line-height: 25px;"   >2.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020133151402415/"   >http://blog.163.com/digoal@126/blog/static/16387704020133151402415/</a></div><div style="line-height: 25px;"   >3.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020133155179877/"   >http://blog.163.com/digoal@126/blog/static/16387704020133155179877/</a></div><div style="line-height: 25px;"   >4.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020133156636579/"   >http://blog.163.com/digoal@126/blog/static/16387704020133156636579/</a></div><div style="line-height: 25px;"   >5.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020133218305242/"   >http://blog.163.com/digoal@126/blog/static/16387704020133218305242/</a></div><div style="line-height: 25px;"   >6.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020133224161563/"   >http://blog.163.com/digoal@126/blog/static/16387704020133224161563/</a></div></div></div><span style="line-height: 22px;"   >7.&nbsp;</span><a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020133271134563/"   >http://blog.163.com/digoal@126/blog/static/16387704020133271134563/</a><br><div><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 25px;"   >8.&nbsp;</span><a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136); font-family: Arial, Helvetica, simsun, u5b8bu4f53;" href="http://blog.163.com/digoal@126/blog/static/16387704020134311144755/"   >http://blog.163.com/digoal@126/blog/static/16387704020134311144755/</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL real-time count(*) performance tuning case - 2 - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>