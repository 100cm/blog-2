<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreS-XL don't support FDW yet</h2>
	<h5 id="">2014-07-25 11:32:00&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014625103041845/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>上次杭州PG交流的时候, 有朋友提出想把citusdb的cstore和hdfs fdw移植到pg-xl上面来,</div><div>这样可以结合pg-xl的分布式运算和hdfs的存储能力, 达到比较好的效果.</div><div>本文将测试一下是否可行.</div><div>安装参考 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020146243755910/"   >http://blog.163.com/digoal@126/blog/static/16387704020146243755910/</a></div><div><br></div><div>创建file fdw, 失败, 原因见代码&nbsp;<span style="line-height: 28px;"   >src/backend/tcop/utility.c.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \set VERBOSITY verbose</font></div><div><font size="2"   >postgres=# create extension file_fdw;</font></div><div><font size="2"   >ERROR: &nbsp;0A000: Postgres-XL does not support FOREIGN DATA WRAPPER yet</font></div><div><font size="2"   >DETAIL: &nbsp;The feature is not currently supported</font></div><div><font size="2"   >LOCATION: &nbsp;standard_ProcessUtility, utility.c:869</font></div><p></p></pre></div><div><br></div><div>修改以下代码, 注释掉一些内容, 重新编译后, 可以创建fdw.</div><div>src/backend/tcop/utility.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CreateFdwStmt:</font></div><div><font size="2"   >/* #ifdef PGXC</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_FEATURE_NOT_SUPPORTED),</font></div><div><font size="2"   >#ifdef XCP</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("Postgres-XL does not support FOREIGN DATA WRAPPER yet"),</font></div><div><font size="2"   >#else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("Postgres-XC does not support FOREIGN DATA WRAPPER yet"),</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errdetail("The feature is not currently supported")));</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   >*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CreateForeignDataWrapper((CreateFdwStmt *) parsetree);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CreateForeignServerStmt:</font></div><div><font size="2"   >/* #ifdef PGXC</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_FEATURE_NOT_SUPPORTED),</font></div><div><font size="2"   >#ifdef XCP</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("Postgres-XL does not support SERVER yet"),</font></div><div><font size="2"   >#else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("Postgres-XC does not support SERVER yet"),</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errdetail("The feature is not currently supported")));</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   >*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CreateForeignServer((CreateForeignServerStmt *) parsetree);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_CreateUserMappingStmt:</font></div><div><font size="2"   >/* #ifdef PGXC</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_FEATURE_NOT_SUPPORTED),</font></div><div><font size="2"   >#ifdef XCP</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("Postgres-XL does not support USER MAPPING yet"),</font></div><div><font size="2"   >#else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("Postgres-XC does not support USER MAPPING yet"),</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errdetail("The feature is not currently supported")));</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   >*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CreateUserMapping((CreateUserMappingStmt *) parsetree);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><p></p></pre></div><div>重新编译</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >gmake world &amp;&amp; gmake install-world</font></div><div></div><p></p></pre></div><div>现在可以创建fdw了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pgxl@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 11921 postgres postgres</font></div><div><font size="2"   >psql (PGXL 9.2.0, based on PG 9.2.4 (Postgres-XL 9.2.0))</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# create extension file_fdw;</font></div><div><font size="2"   >postgres=# \dx</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of installed extensions</font></div><div><font size="2"   >&nbsp; &nbsp;Name &nbsp; | Version | &nbsp; Schema &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Description &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------+---------+------------+-------------------------------------------</font></div><div><font size="2"   >&nbsp;file_fdw | 1.0 &nbsp; &nbsp; | public &nbsp; &nbsp; | foreign-data wrapper for flat file access</font></div><div><font size="2"   >&nbsp;plpgsql &nbsp;| 1.0 &nbsp; &nbsp; | pg_catalog | PL/pgSQL procedural language</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>数据节点的fdw也自动创建.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pgxl@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 11922 postgres postgres</font></div><div><font size="2"   >psql (PGXL 9.2.0, based on PG 9.2.4 (Postgres-XL 9.2.0))</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# \dx</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of installed extensions</font></div><div><font size="2"   >&nbsp; &nbsp;Name &nbsp; | Version | &nbsp; Schema &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Description &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------+---------+------------+-------------------------------------------</font></div><div><font size="2"   >&nbsp;file_fdw | 1.0 &nbsp; &nbsp; | public &nbsp; &nbsp; | foreign-data wrapper for flat file access</font></div><div><font size="2"   >&nbsp;plpgsql &nbsp;| 1.0 &nbsp; &nbsp; | pg_catalog | PL/pgSQL procedural language</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   >postgres=# select * from pg_foreign_data_wrapper ;</font></div><div><font size="2"   >&nbsp;fdwname &nbsp;| fdwowner | fdwhandler | fdwvalidator | fdwacl | fdwoptions&nbsp;</font></div><div><font size="2"   >----------+----------+------------+--------------+--------+------------</font></div><div><font size="2"   >&nbsp;file_fdw | &nbsp; &nbsp; &nbsp; 10 | &nbsp; &nbsp; &nbsp;16471 | &nbsp; &nbsp; &nbsp; &nbsp;16472 | &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>接下来创建foreign server, 注意foreign server不会在数据节点自动创建.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pgxl@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 11921 postgres postgres</font></div><div><font size="2"   >postgres=# create server file foreign data wrapper file_fdw;</font></div><div><font size="2"   >CREATE SERVER</font></div><div><font size="2"   >postgres=# select * from pg_foreign_server ;</font></div><div><font size="2"   >&nbsp;srvname | srvowner | srvfdw | srvtype | srvversion | srvacl | srvoptions&nbsp;</font></div><div><font size="2"   >---------+----------+--------+---------+------------+--------+------------</font></div><div><font size="2"   >&nbsp;file &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 10 | &nbsp;16473 | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>所以需要手工在所有的数据节点创建foreign server.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pgxl@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 11922 postgres postgres</font></div><div><font size="2"   >psql (PGXL 9.2.0, based on PG 9.2.4 (Postgres-XL 9.2.0))</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# select * from pg_foreign_server ;</font></div><div><font size="2"   >&nbsp;srvname | srvowner | srvfdw | srvtype | srvversion | srvacl | srvoptions&nbsp;</font></div><div><font size="2"   >---------+----------+--------+---------+------------+--------+------------</font></div><div><font size="2"   >(0 rows)</font></div><p></p></pre></div><div>在数据节点执行DML会失败, 原因是防止误操作, 数据节点默认是read only的.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \set VERBOSITY verbose</font></div><div><font size="2"   >postgres=# create server file foreign data wrapper file_fdw;</font></div><div><font size="2"   >ERROR: &nbsp;25006: cannot execute CREATE SERVER in a read-only transaction</font></div><div><font size="2"   >LOCATION: &nbsp;PreventCommandIfReadOnly, utility.c:296</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >出错代码位置 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* PreventCommandIfReadOnly: throw error if XactReadOnly</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* This is useful mainly to ensure consistency of the error message wording;</font></div><div><font size="2"   >&nbsp;* most callers have checked XactReadOnly for themselves.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >void</font></div><div><font size="2"   >PreventCommandIfReadOnly(const char *cmdname)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (XactReadOnly)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_READ_ONLY_SQL_TRANSACTION),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* translator: %s is name of a SQL command, eg CREATE */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("cannot execute %s in a read-only transaction",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmdname)));</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >这个只要开启读写事务即可解决, 在所有的数据节点创建foreign server.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# begin transaction read write;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# create server file foreign data wrapper file_fdw;</font></div><div><font size="2"   >CREATE SERVER</font></div><div><font size="2"   >postgres=# end;</font></div><div><font size="2"   >COMMIT</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pgxl@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 11923 postgres postgres</font></div><div><font size="2"   >psql (PGXL 9.2.0, based on PG 9.2.4 (Postgres-XL 9.2.0))</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# begin transaction read write;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# create server file foreign data wrapper file_fdw;</font></div><div><font size="2"   >CREATE SERVER</font></div><div><font size="2"   >postgres=# end;</font></div><div><font size="2"   >COMMIT</font></div><div><font size="2"   >postgres=# \q</font></div><div><font size="2"   >pgxl@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 11924 postgres postgres</font></div><div><font size="2"   >psql (PGXL 9.2.0, based on PG 9.2.4 (Postgres-XL 9.2.0))</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# begin transaction read write;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# create server file foreign data wrapper file_fdw;</font></div><div><font size="2"   >CREATE SERVER</font></div><div><font size="2"   >postgres=# end;</font></div><div><font size="2"   >COMMIT</font></div><div><font size="2"   >postgres=# \q</font></div><div><font size="2"   >pgxl@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 11925 postgres postgres</font></div><div><font size="2"   >psql (PGXL 9.2.0, based on PG 9.2.4 (Postgres-XL 9.2.0))</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# begin transaction read write;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# create server file foreign data wrapper file_fdw;</font></div><div><font size="2"   >CREATE SERVER</font></div><div><font size="2"   >postgres=# end;</font></div><div><font size="2"   >COMMIT</font></div><div><font size="2"   >postgres=# \q</font></div><p></p></pre></div><div><br></div><div>接下来在coordinator节点创建外部表.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# begin transaction read write;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# CREATE FOREIGN TABLE ft_file1 (id int, info text, crt_time timestamp) server file options (filename '/home/pgxl/test.csv', format 'csv');</font></div><div><font size="2"   >CREATE FOREIGN TABLE</font></div><div><font size="2"   >postgres=# end;</font></div><div><font size="2"   >COMMIT</font></div><p></p></pre></div><div>外部表的定义会自动在所有的数据节点自动创建.</div><div>接下来查询这个外部表, 报错. 错误代码出现在数据节点的<span style="line-height: 28px;"   >DataNodeCopyFinish时.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select count(*) from ft_file1;</font></div><div><font size="2"   >ERROR: &nbsp;XX000: Error while running COPY</font></div><div><font size="2"   >LOCATION: &nbsp;DataNodeCopyFinish, execRemote.c:4624</font></div><div><font size="2"   >postgres=# \q</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >报错信息, coordinator节点, 爆出来的实际上是datanode的错误.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2014-07-25 10:59:38.688 CST,"postgres","postgres",9204,"127.0.0.1:19894",53d1c80a.23f4,8,"SELECT",2014-07-25 10:59:22 CST,2/168,25095,LOG,00000,"Connection error cannot copy to foreign table ""ft_file1""",,,,,,"select * from ft_file1 limit 1;",,"add_error_message, pgxcnode.c:2025","psql"</font></div><div><font size="2"   >2014-07-25 10:59:38.688 CST,"postgres","postgres",9204,"127.0.0.1:19894",53d1c80a.23f4,9,"SELECT",2014-07-25 10:59:22 CST,2/168,25095,LOG,00000,"Connection error cannot copy to foreign table ""ft_file1""",,,,,,"select * from ft_file1 limit 1;",,"add_error_message, pgxcnode.c:2025","psql"</font></div><div><font size="2"   >2014-07-25 10:59:38.688 CST,"postgres","postgres",9204,"127.0.0.1:19894",53d1c80a.23f4,10,"SELECT",2014-07-25 10:59:22 CST,2/168,25095,LOG,00000,"Connection error cannot copy to foreign table ""ft_file1""",,,,,,"select * from ft_file1 limit 1;",,"add_error_message, pgxcnode.c:2025","psql"</font></div><div><font size="2"   >2014-07-25 10:59:38.688 CST,"postgres","postgres",9204,"127.0.0.1:19894",53d1c80a.23f4,11,"SELECT",2014-07-25 10:59:22 CST,2/168,25095,LOG,00000,"Connection error cannot copy to foreign table ""ft_file1""",,,,,,"select * from ft_file1 limit 1;",,"add_error_message, pgxcnode.c:2025","psql"</font></div><p></p></pre></div><div>报错信息, 数据节点. 真正的错误原因是, datanode不允许 copy 到外部表, cannot copy to foreign table .</div><div>但是为什么要copy到外部表呢? 看样子问题出在外部表的分布式执行计划上.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2014-07-25 10:59:27.247 CST,,,9207,"",53d1c80f.23f7,1,"",2014-07-25 10:59:27 CST,,0,LOG,00000,"connection received: host=127.0.0.1 port=47287",,,,,,,,"BackendInitialize, postmaster.c:3742",""</font></div><div><font size="2"   >2014-07-25 10:59:28.248 CST,"postgres","postgres",9207,"127.0.0.1:47287",53d1c80f.23f7,2,"authentication",2014-07-25 10:59:27 CST,2/189,25081,LOG,00000,"Will fall back to local snapshot for XID = 25081, source = 0, gxmin = 0, autovac launch = 0, autovac = 0, normProcMode = 0, postEnv = 1",,,,,,,,"GetPGXCSnapshotData, procarray.c:2740",""</font></div><div><font size="2"   >2014-07-25 10:59:28.248 CST,"postgres","postgres",9207,"127.0.0.1:47287",53d1c80f.23f7,3,"authentication",2014-07-25 10:59:27 CST,2/189,25081,LOG,00000,"connection authorized: user=postgres database=postgres",,,,,,,,"PerformAuthentication, postinit.c:237",""</font></div><div><font size="2"   >2014-07-25 10:59:31.267 CST,"postgres","postgres",9207,"127.0.0.1:47287",53d1c80f.23f7,4,"BEGIN",2014-07-25 10:59:27 CST,2/192,0,LOG,00000,"duration: 4018.784 ms &nbsp;statement: BEGIN",,,,,,,,"exec_simple_query, postgres.c:1356","pgxc"</font></div><div><font size="2"   >2014-07-25 10:59:31.268 CST,"postgres","postgres",9207,"127.0.0.1:47287",53d1c80f.23f7,5,"COPY",2014-07-25 10:59:27 CST,2/192,0,ERROR,42809,"cannot copy to foreign table ""ft_file1""",,,,,,"COPY public.ft_file1 FROM STDIN CSV",,"CopyFrom, copy.c:2100","pgxc"</font></div><div><font size="2"   >2014-07-25 10:59:31.269 CST,"postgres","postgres",9207,"127.0.0.1:47287",53d1c80f.23f7,6,"COMMIT",2014-07-25 10:59:27 CST,2/0,0,LOG,00000,"duration: 4018.698 ms &nbsp;statement: COMMIT TRANSACTION",,,,,,,,"exec_simple_query, postgres.c:1356","pgxc"</font></div><div><font size="2"   >2014-07-25 10:59:31.270 CST,"postgres","postgres",9207,"127.0.0.1:47287",53d1c80f.23f7,7,"RESET",2014-07-25 10:59:27 CST,2/0,0,LOG,00000,"duration: 4019.029 ms &nbsp;statement: RESET ALL;RESET SESSION AUTHORIZATION;RESET transaction_isolation;",,,,,,,,"exec_simple_query, postgres.c:1356","pgxc"</font></div><div><font size="2"   >2014-07-25 10:59:38.685 CST,"postgres","postgres",9207,"127.0.0.1:47287",53d1c80f.23f7,8,"SET",2014-07-25 10:59:27 CST,2/0,0,LOG,00000,"duration: 4018.958 ms &nbsp;statement: SET global_session TO c11921_9204;",,,,,,,,"exec_simple_query, postgres.c:1356","pgxc"</font></div><div><font size="2"   >2014-07-25 10:59:38.688 CST,"postgres","postgres",9207,"127.0.0.1:47287",53d1c80f.23f7,9,"COPY",2014-07-25 10:59:27 CST,2/195,0,ERROR,42809,"cannot copy to foreign table ""ft_file1""",,,,,,"COPY public.ft_file1 FROM STDIN CSV",,"CopyFrom, copy.c:2100","pgxc"</font></div><p></p></pre></div><div><br></div><div>直接连接到数据节点, 查询外部表的定义, 或者直接查询数据都正常.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pgxl@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 11922 postgres postgres</font></div><div><font size="2"   >psql (PGXL 9.2.0, based on PG 9.2.4 (Postgres-XL 9.2.0))</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# select * from pg_foreign_table ;</font></div><div><font size="2"   >&nbsp;ftrelid | ftserver | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ftoptions &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------+----------+-------------------------------------------</font></div><div><font size="2"   >&nbsp; &nbsp;16463 | &nbsp; &nbsp;16462 | {filename=/home/pgxl/test.csv,format=csv}</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select count(*) from ft_file1;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1000000</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>在coordinator节点, 直接使用数据节点查询, 也是正常的.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# execute direct on (d11922) $$select count(*) from ft_file1$$;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1000000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# \q</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pgxl@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 11923 postgres postgres</font></div><div><font size="2"   >psql (PGXL 9.2.0, based on PG 9.2.4 (Postgres-XL 9.2.0))</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# select count(*) from ft_file1;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1000000</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>接下来把文件改成5个文件, coordinator节点和datanode节点使用不同的文件名.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-rw-r--r-- 1 pgxl pgxl &nbsp;64M Jul 25 10:02 1.csv</font></div><div><font size="2"   >-rw-r--r-- 1 pgxl pgxl &nbsp;64M Jul 25 09:43 2.csv</font></div><div><font size="2"   >-rw-r--r-- 1 pgxl pgxl &nbsp;64M Jul 25 09:43 3.csv</font></div><div><font size="2"   >-rw-r--r-- 1 pgxl pgxl &nbsp;64M Jul 25 09:43 4.csv</font></div><div><font size="2"   >drwxr-xr-x 6 root root 4.0K Jul 24 15:04 pgxl9.2</font></div><div><font size="2"   >-rw-r--r-- 1 pgxl pgxl &nbsp;64M Jul 25 10:02 test.csv</font></div><p></p></pre></div><div><br></div><div>在datanode开启read write事务, 修改外部表定义, 指向不同的csv文件.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >psql -h 127.0.0.1 -p 11922 postgres postgres</font></div><div><font size="2"   >postgres=# alter foreign table ft_file1 options (set filename '/home/pgxl/1.csv');</font></div><div><font size="2"   >psql -h 127.0.0.1 -p 11923 postgres postgres</font></div><div><font size="2"   >postgres=# alter foreign table ft_file1 options (set filename '/home/pgxl/2.csv');</font></div><div><font size="2"   >psql -h 127.0.0.1 -p 11924 postgres postgres</font></div><div><font size="2"   >postgres=# alter foreign table ft_file1 options (set filename '/home/pgxl/3.csv');</font></div><div><font size="2"   >psql -h 127.0.0.1 -p 11925 postgres postgres</font></div><div><font size="2"   >postgres=# alter foreign table ft_file1 options (set filename '/home/pgxl/4.csv');</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >创建普通表, 将数据节点的外部表名替换成普通表名.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >psql -h 127.0.0.1 -p 11921 postgres postgres</font></div><div><font size="2"   >postgres=# create table t4(id int, info text, crt_time timestamp) distribute by roundrobin to group gp1;</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div><br></div><div>所有数据节点, 将foreign table替换成t4. 不过执行会报错, 原因是file path不对.</div><div>貌似缓存了filepath, 因为pgxc_class里面没有这部分的信息.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pgxl@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 11922 postgres postgres</font></div><div><span style="line-height: 28px;"   ><font size="2"   >pgxl@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 11923 postgres postgres</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >pgxl@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 11924 postgres postgres</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >pgxl@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 11925 postgres postgres</font></span></div><div><font size="2"   >psql (PGXL 9.2.0, based on PG 9.2.4 (Postgres-XL 9.2.0))</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# begin read write;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# drop table t4;</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >postgres=# alter foreign table ft_file1 rename to t4;</font></div><div><font size="2"   >ALTER FOREIGN TABLE</font></div><div><font size="2"   >postgres=# end;</font></div><div><font size="2"   >COMMIT</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# \set VERBOSITY verbose</font></div><div><font size="2"   >postgres=# select * from t4 limit 1;</font></div><div><font size="2"   >ERROR: &nbsp;58P01: could not open file "base/12892/16463": No such file or directory</font></div><div><font size="2"   >LOCATION: &nbsp;ExecRemoteSubplan, execRemote.c:8802</font></div><div><font size="2"   >postgres=# select pg_relation_filepath('t4');</font></div><div><font size="2"   >&nbsp;pg_relation_filepath&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;base/12892/16481</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>coordinator节点错误</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2014-07-25 10:47:24.135 CST,"postgres","postgres",8770,"[local]",53d1c4ce.2242,8,"SELECT",2014-07-25 10:45:34 CST,2/160,24943,LOG,00000,"Connection error could not open file ""base/12892/16463"": No such file or directory",,,,,,"select * from t4 limit 1;",,"add_error_message, pgxcnode.c:2025","psql"</font></div><div><font size="2"   >2014-07-25 10:47:24.135 CST,"postgres","postgres",8770,"[local]",53d1c4ce.2242,9,"SELECT",2014-07-25 10:45:34 CST,2/160,24943,LOG,00000,"Connection error could not open file ""base/12892/16463"": No such file or directory",,,,,,"select * from t4 limit 1;",,"add_error_message, pgxcnode.c:2025","psql"</font></div><div><font size="2"   >2014-07-25 10:47:24.135 CST,"postgres","postgres",8770,"[local]",53d1c4ce.2242,10,"SELECT",2014-07-25 10:45:34 CST,2/160,24943,LOG,00000,"Connection error could not open file ""base/12892/16463"": No such file or directory",,,,,,"select * from t4 limit 1;",,"add_error_message, pgxcnode.c:2025","psql"</font></div><div><font size="2"   >2014-07-25 10:47:24.135 CST,"postgres","postgres",8770,"[local]",53d1c4ce.2242,11,"SELECT",2014-07-25 10:45:34 CST,2/160,24943,LOG,00000,"Connection error could not open file ""base/12892/16463"": No such file or directory",,,,,,"select * from t4 limit 1;",,"add_error_message, pgxcnode.c:2025","psql"</font></div><div><font size="2"   >2014-07-25 10:47:24.135 CST,"postgres","postgres",8770,"[local]",53d1c4ce.2242,12,"SELECT",2014-07-25 10:45:34 CST,2/160,24943,ERROR,58P01,"could not open file ""base/12892/16463"": No such file or directory",,,,,,"select * from t4 limit 1;",,"ExecRemoteSubplan, execRemote.c:8802","psql"</font></div><p></p></pre></div><div><br></div><div>数据节点错误日志</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >2014-07-25 10:45:41.809 CST,,,8777,"",53d1c4d5.2249,1,"",2014-07-25 10:45:41 CST,,0,LOG,00000,"connection received: host=127.0.0.1 port=30853",,,,,,,,"BackendInitialize, postmaster.c:3742",""</font></span></div><div><font size="2"   >2014-07-25 10:45:42.809 CST,"postgres","postgres",8777,"127.0.0.1:30853",53d1c4d5.2249,2,"authentication",2014-07-25 10:45:41 CST,2/162,24932,LOG,00000,"Will fall back to local snapshot for XID = 24932, source = 0, gxmin = 0, autovac launch = 0, autovac = 0, normProcMode = 0, postEnv = 1",,,,,,,,"GetPGXCSnapshotData, procarray.c:2740",""</font></div><div><font size="2"   >2014-07-25 10:45:42.810 CST,"postgres","postgres",8777,"127.0.0.1:30853",53d1c4d5.2249,3,"authentication",2014-07-25 10:45:41 CST,2/162,24932,LOG,00000,"connection authorized: user=postgres database=postgres",,,,,,,,"PerformAuthentication, postinit.c:237",""</font></div><div><font size="2"   >2014-07-25 10:45:42.818 CST,"postgres","postgres",8777,"127.0.0.1:30853",53d1c4d5.2249,4,"BEGIN",2014-07-25 10:45:41 CST,2/165,0,LOG,00000,"duration: 5023.009 ms &nbsp;statement: BEGIN",,,,,,,,"exec_simple_query, postgres.c:1356","pgxc"</font></div><div><font size="2"   >2014-07-25 10:45:42.819 CST,"postgres","postgres",8777,"127.0.0.1:30853",53d1c4d5.2249,5,"PLAN",2014-07-25 10:45:41 CST,2/165,0,LOG,00000,"duration: 5026.198 ms &nbsp;parse p_1_2242_1: Remote Subplan",,,,,,,,"exec_plan_message, postgres.c:1802","pgxc"</font></div><div><font size="2"   >2014-07-25 10:45:42.819 CST,"postgres","postgres",8777,"127.0.0.1:30853",53d1c4d5.2249,6,"BIND",2014-07-25 10:45:41 CST,2/165,0,ERROR,58P01,"could not open file ""base/12892/16463"": No such file or directory",,,,,,"Remote Subplan",,"mdopen, md.c:579","pgxc"</font></div><div><font size="2"   >2014-07-25 10:45:42.820 CST,"postgres","postgres",8777,"127.0.0.1:30853",53d1c4d5.2249,7,"ROLLBACK",2014-07-25 10:45:41 CST,2/0,0,LOG,00000,"duration: 5025.866 ms &nbsp;statement: ROLLBACK TRANSACTION",,,,,,,,"exec_simple_query, postgres.c:1356","pgxc"</font></div><div><font size="2"   >2014-07-25 10:45:42.821 CST,"postgres","postgres",8777,"127.0.0.1:30853",53d1c4d5.2249,8,"RESET",2014-07-25 10:45:41 CST,2/0,0,LOG,00000,"duration: 5026.020 ms &nbsp;statement: RESET ALL;RESET SESSION AUTHORIZATION;RESET transaction_isolation;",,,,,,,,"exec_simple_query, postgres.c:1356","pgxc"</font></div><p></p></pre></div><div><br></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >postgres=# execute direct on (d11922) $$select count(*) from t4$$;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;count &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >--------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;1000000</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >postgres=# execute direct on (d11923) $$select count(*) from t4$$;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; count &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >---------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;1000000</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >postgres=# execute direct on (d11924) $$select count(*) from t4$$;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; count &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >---------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;1000000</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >postgres=# execute direct on (d11925) $$select count(*) from t4$$;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; count &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >---------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;1000000</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >接下来折腾一下cstoro插件.</div><div style="line-height: 28px;"   >参考</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020144141052312/"   >http://blog.163.com/digoal@126/blog/static/16387704020144141052312/</a></div><div>显然不支持9.2, 停止折腾.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 cstore_fdw]# export PATH=/home/pgxl/pgxl9.2/bin:$PATH</font></div><div><font size="2"   >[root@db-172-16-3-150 cstore_fdw]# which pg_config</font></div><div><font size="2"   >/home/pgxl/pgxl9.2/bin/pg_config</font></div><div><font size="2"   >[root@db-172-16-3-150 cstore_fdw]# gmake clean</font></div><div><font size="2"   >Makefile:42: *** PostgreSQL 9.3 or 9.4 is required to compile this extension. &nbsp;Stop.</font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020146243755910/"   >http://blog.163.com/digoal@126/blog/static/16387704020146243755910/</a></div><div>2.&nbsp;<span style="line-height: 28px;"   >src/backend/tcop/utility.c</span></div><div><span style="line-height: 28px;"   >3.&nbsp;</span><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020144141052312/"   >http://blog.163.com/digoal@126/blog/static/16387704020144141052312/</a></div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreS-XL dont support FDW yet - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>