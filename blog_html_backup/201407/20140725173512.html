<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Postgres-XL you can only see databases with CREATE privilege</h2>
	<h5 id="">2014-07-25 17:35:12&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201462552243293/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>Postgres-XL改写了SQL parser, 并新增了storm_catalog这个catalog.</div><div>目的可能是提高安全性, 例如pg_database这个表, 在storm_catalog中创建一个同名视图, 正常情况下会先访问pg_catalog.pg_database, 但是因为改了parser代码, 所以直接访问的是storm_catalog.pg_database.</div><div>这个视图的定义说明了这个问题 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \dn *.*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; List of schemas</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Name &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------+----------</font></div><div><font size="2"   >&nbsp;information_schema | postgres</font></div><div><font size="2"   >&nbsp;pg_catalog &nbsp; &nbsp; &nbsp; &nbsp; | postgres</font></div><div><font size="2"   >&nbsp;pg_temp_1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| postgres</font></div><div><font size="2"   >&nbsp;pg_toast &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | postgres</font></div><div><font size="2"   >&nbsp;pg_toast_temp_1 &nbsp; &nbsp;| postgres</font></div><div><font size="2"   >&nbsp;public &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | postgres</font></div><div><font size="2"   >&nbsp;storm_catalog &nbsp; &nbsp; &nbsp;| postgres</font></div><div><font size="2"   >(7 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# \d pg_database</font></div><div><font size="2"   >&nbsp; &nbsp;View "storm_catalog.pg_database"</font></div><div><font size="2"   >&nbsp; &nbsp; Column &nbsp; &nbsp; | &nbsp; Type &nbsp; &nbsp;| Modifiers&nbsp;</font></div><div><font size="2"   >---------------+-----------+-----------</font></div><div><font size="2"   >&nbsp;tableoid &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | oid &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;datname &nbsp; &nbsp; &nbsp; | name &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;datdba &nbsp; &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;encoding &nbsp; &nbsp; &nbsp;| integer &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;datcollate &nbsp; &nbsp;| name &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;datctype &nbsp; &nbsp; &nbsp;| name &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;datistemplate | boolean &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;datallowconn &nbsp;| boolean &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;datconnlimit &nbsp;| integer &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;datlastsysoid | oid &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;datfrozenxid &nbsp;| xid &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;dattablespace | oid &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;datacl &nbsp; &nbsp; &nbsp; &nbsp;| aclitem[] |&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# \d+ pg_database</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; View "storm_catalog.pg_database"</font></div><div><font size="2"   >&nbsp; &nbsp; Column &nbsp; &nbsp; | &nbsp; Type &nbsp; &nbsp;| Modifiers | Storage &nbsp;| Description&nbsp;</font></div><div><font size="2"   >---------------+-----------+-----------+----------+-------------</font></div><div><font size="2"   >&nbsp;tableoid &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | oid &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;datname &nbsp; &nbsp; &nbsp; | name &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;datdba &nbsp; &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;encoding &nbsp; &nbsp; &nbsp;| integer &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;datcollate &nbsp; &nbsp;| name &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;datctype &nbsp; &nbsp; &nbsp;| name &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;datistemplate | boolean &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;datallowconn &nbsp;| boolean &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;datconnlimit &nbsp;| integer &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;datlastsysoid | oid &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;datfrozenxid &nbsp;| xid &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;dattablespace | oid &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;datacl &nbsp; &nbsp; &nbsp; &nbsp;| aclitem[] | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended |&nbsp;</font></div><div><font size="2"   >View definition:</font></div><div><font size="2"   >&nbsp;SELECT pg_database.tableoid, pg_database.oid, pg_database.datname,&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; pg_database.datdba, pg_database.encoding, pg_database.datcollate,&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; pg_database.datctype, pg_database.datistemplate, pg_database.datallowconn,&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; pg_database.datconnlimit, pg_database.datlastsysoid,&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; pg_database.datfrozenxid, pg_database.dattablespace, pg_database.datacl</font></div><div><font size="2"   >&nbsp; &nbsp;FROM pg_catalog.pg_database</font></div><div><font size="2"   >&nbsp; WHERE pg_database.datallowconn AND (has_database_privilege(pg_database.datname::text, 'CREATE'::text) OR split_part("current_user"()::text, '@'::text, 2) = pg_database.datname::text);</font></div><p></p></pre></div><div>这个视图只允许你查看拥有CREATE权限的数据库, 所以一个普通用户可能只能看到部分数据库.</div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \c postgres digoal</font></div><div><font size="2"   >You are now connected to database "postgres" as user "digoal".</font></div><div><font size="2"   >postgres=&gt; \l</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of databases</font></div><div><font size="2"   >&nbsp;Name | Owner &nbsp;| Encoding | Collate | Ctype | Access privileges&nbsp;</font></div><div><font size="2"   >------+--------+----------+---------+-------+-------------------</font></div><div><font size="2"   >&nbsp;test | digoal | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | =Tc/digoal &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | digoal=CTc/digoal</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>连接到超级用户, 可以查看到全部的数据库.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; \c postgres postgres</font></div><div><font size="2"   >You are now connected to database "postgres" as user "postgres".</font></div><div><font size="2"   >postgres=# \l</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of databases</font></div><div><font size="2"   >&nbsp; &nbsp;Name &nbsp; &nbsp;| &nbsp;Owner &nbsp; | Encoding | Collate | Ctype | &nbsp; Access privileges &nbsp;&nbsp;</font></div><div><font size="2"   >-----------+----------+----------+---------+-------+-----------------------</font></div><div><font size="2"   >&nbsp;postgres &nbsp;| postgres | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | =Tc/postgres &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | postgres=CTc/postgres</font></div><div><font size="2"   >&nbsp;template0 | postgres | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | =c/postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | postgres=CTc/postgres</font></div><div><font size="2"   >&nbsp;template1 | postgres | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | =c/postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | postgres=CTc/postgres</font></div><div><font size="2"   >&nbsp;test &nbsp; &nbsp; &nbsp;| digoal &nbsp; | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | =Tc/digoal &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | digoal=CTc/digoal</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div><div><br></div><div>不仅如此, Postgres-XL还改了pg_catalog.pg_database_size函数的权限, 普通用户没有执行权限.&nbsp;</div><div>而且会先执行<span style="line-height: 28px;"   >storm_catalog.pg_databas_size() , 这个函数返回的是当前连接的数据库的SIZE, 当前没有连接的数据库显示SIZE=0.</span></div><div>具体看它的代码.</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >postgres=&gt; \df+ pg_database_size</font></span></div><div><div><font size="2"   >List of functions</font></div><div><font size="2"   >-[ RECORD 1 ]-------+--------------------------------------------</font></div><div><font size="2"   >Schema &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| storm_catalog</font></div><div><font size="2"   >Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| pg_database_size</font></div><div><font size="2"   >Result data type &nbsp; &nbsp;| bigint</font></div><div><font size="2"   >Argument data types | name</font></div><div><font size="2"   >Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >Volatility &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| volatile</font></div><div><font size="2"   >Owner &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | postgres</font></div><div><font size="2"   >Language &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| plpgsql</font></div><div><font size="2"   >Source code &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | BEGIN</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; IF $1 = current_database() THEN</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; return pg_catalog.pg_database_size($1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; END IF;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; return 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | END</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >Description &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >-[ RECORD 2 ]-------+--------------------------------------------</font></div><div><font size="2"   >Schema &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| storm_catalog</font></div><div><font size="2"   >Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| pg_database_size</font></div><div><font size="2"   >Result data type &nbsp; &nbsp;| bigint</font></div><div><font size="2"   >Argument data types | oid</font></div><div><font size="2"   >Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >Volatility &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| volatile</font></div><div><font size="2"   >Owner &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | postgres</font></div><div><font size="2"   >Language &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| plpgsql</font></div><div><font size="2"   >Source code &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | DECLARE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; is_current_db boolean;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | BEGIN</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; SELECT $1 = oid</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; INTO is_current_db</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; FROM pg_catalog.pg_database</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp;WHERE datname = current_database();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; IF is_current_db THEN</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; return pg_catalog.pg_database_size($1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; END IF;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; return 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | END</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >Description &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div></div><p></p></pre></div><div><br></div><div>要查看真实的SIZE, 建议使用超级用户查询pg_catalog.pg_database_size(oid)或者(name).</div><div>也可以将权限赋予给普通用户.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \c postgres postgres</font></div><div><font size="2"   >grant execute on funciton pg_catalog.pg_database_size(oid) to digoal;</font></div><div><span style="line-height: 28px;"   ><font size="2"   >grant execute on funciton pg_catalog.pg_database_size(name) to digoal;</font></span></div><p></p></pre></div><div><span style="line-height: 28px;"   >而且这个权限需要每个数据库赋予.</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# \c postgres digoal</font></div><div><font size="2"   >You are now connected to database "postgres" as user "digoal".</font></div><div><font size="2"   >postgres=&gt; select * from pg_catalog.pg_database_size('postgres');</font></div><div><font size="2"   >&nbsp;pg_database_size&nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;61245920</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=&gt; select * from pg_catalog.pg_database_size('test');</font></div><div><font size="2"   >&nbsp;pg_database_size&nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >postgres=&gt; \c test digoal</font></div><div><font size="2"   >You are now connected to database "test" as user "digoal".</font></div><div><font size="2"   >test=&gt; select * from pg_catalog.pg_database_size('test');</font></div><div><font size="2"   >ERROR: &nbsp;permission denied for function pg_database_size</font></div><div><font size="2"   >CONTEXT: &nbsp;PL/pgSQL function pg_database_size(name) line 4 at RETURN</font></div></div><p></p></pre></div><div>test库又需要重新赋予权限才行,&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >test=&gt; \c test postgres</font></div><div><font size="2"   >You are now connected to database "test" as user "postgres".</font></div><div><font size="2"   >test=# grant execute on function pg_catalog.pg_database_size(oid) to digoal;</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >test=# grant execute on function pg_catalog.pg_database_size(name) to digoal;</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >test=# \c test digoal</font></div><div><font size="2"   >You are now connected to database "test" as user "digoal".</font></div><div><font size="2"   >test=&gt; select * from pg_catalog.pg_database_size('test');</font></div><div><font size="2"   >&nbsp;pg_database_size&nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;59181536</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>如果普通用户经常要查询这个的话, 建议在模板库(template0, template1)赋予权限, 以后新建的库就不需要赋予了.</div><div><br></div><div>[参考]</div><div>1.&nbsp;src/backend/parser/parse_relation.c</div><div>2.&nbsp;src/backend/parser/analyze.c</div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="Postgres-XL you can only see database with CREATE privilege - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>