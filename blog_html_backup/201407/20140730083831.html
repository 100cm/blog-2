<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">short & long connection performance between unix socket vs loopback vs IP</h2>
	<h5 id="">2014-07-30 8:38:31&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201463074329894/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>众所周知PostgreSQL是进程模式, 每个客户端连接, 都需要从服务端fork一个backend process来"对付"它.</div><div>所以短连接和长连接的并发性有极大的差别, 鉴于此, 对于短连接业务, 我们需要部署连接池, 例如pgbouncer连接池.</div><div>以下是一组测试数据.</div><div>测试SQL, select 1;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@39-&gt; cat test.sql</font></div><div><font size="2"   >select 1;</font></div><p></p></pre></div><div>测试结果汇总 :&nbsp;</div><div><table width="80%"   border="1"   cellpadding="1"   cellspacing="1"   ><tbody><tr><td><font size="2"   >&nbsp;conn mode \ tps</font></td><td><font size="2"   >&nbsp;短连接, 单连接, 单进程</font></td><td><font size="2"   >&nbsp;<span style="line-height: 28px;"   >短连接, 多连接, 多进程</span></font></td><td><font size="2"   >&nbsp;长<span style="line-height: 28px;"   >连接, 单连接, 单进程</span></font></td><td><font size="2"   ><span style="line-height: 28px;"   >长连接, 多连接, 多进程</span>&nbsp;</font></td></tr><tr><td><font size="2"   >&nbsp;unix socket</font></td><td><font size="2"   >&nbsp;337</font></td><td><font size="2"   >&nbsp;1355</font></td><td><font size="2"   >&nbsp;26250</font></td><td><font size="2"   >&nbsp;166630</font></td></tr><tr><td><font size="2"   >&nbsp;loop back</font></td><td><font size="2"   >&nbsp;310</font></td><td><font size="2"   >&nbsp;1245</font></td><td><font size="2"   >&nbsp;17467</font></td><td><font size="2"   >&nbsp;114761</font></td></tr><tr><td><font size="2"   >&nbsp;eth0</font></td><td><font size="2"   >&nbsp;309</font></td><td><font size="2"   >&nbsp;464</font></td><td><font size="2"   >&nbsp;17783</font></td><td><font size="2"   >&nbsp;118102</font></td></tr></table>从测试结果来看, 短连接相比长连接性能损失极其巨大, 不管是短连接还是长连接, unix socket和TCP连接方式的性能有较大的差别, 单连接计划没有差别, 多连接和ETH0(1GB)接口可以体现出较大的差别.&nbsp;</div><div>所以如果数据库和业务在同一个服务器上的话, 建议使用unix socket连接.</div><div><br></div><div>测试详细结果.</div><div>长连接, 单连接, 单线程.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@39-&gt; pgbench -M prepared -n -r -f ./test.sql -h $PGDATA -c 1 -j 1 -T 30</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 787502</font></div><div><font size="2"   >tps = 26249.961667 (including connections establishing)</font></div><div><font size="2"   >tps = 26252.432011 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.037277 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@39-&gt; pgbench -M prepared -n -r -f ./test.sql -h 127.0.0.1 -c 1 -j 1 -T 30</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 524007</font></div><div><font size="2"   >tps = 17466.801604 (including connections establishing)</font></div><div><font size="2"   >tps = 17468.668994 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.056171 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@39-&gt; pgbench -M prepared -n -r -f ./test.sql -h 172.16.3.39 -c 1 -j 1 -T 30</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 533505</font></div><div><font size="2"   >tps = 17783.407526 (including connections establishing)</font></div><div><font size="2"   >tps = 17785.230503 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.055167 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><p></p></pre></div><div><br></div><div>长连接, 多连接, 多线程.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@39-&gt; pgbench -M prepared -n -r -f ./test.sql -h $PGDATA -c 12 -j 4 -T 30</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 12</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 4998931</font></div><div><font size="2"   >tps = 166630.372366 (including connections establishing)</font></div><div><font size="2"   >tps = 166682.288137 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.071148 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@39-&gt; pgbench -M prepared -n -r -f ./test.sql -h 127.0.0.1 -c 12 -j 4 -T 30</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 12</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 3442923</font></div><div><font size="2"   >tps = 114760.829316 (including connections establishing)</font></div><div><font size="2"   >tps = 114799.418041 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.103285 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@39-&gt; pgbench -M prepared -n -r -f ./test.sql -h 172.16.3.39 -c 12 -j 4 -T 30</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 12</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 3543119</font></div><div><font size="2"   >tps = 118102.116400 (including connections establishing)</font></div><div><font size="2"   >tps = 118140.332230 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.100409 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><p></p></pre></div><div><br></div><div>短连接, 单连接, 单线程</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres@39-&gt; pgbench -M extended -n -r -f ./test.sql -C -h $PGDATA -T 30</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: extended</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 10113</font></div><div><font size="2"   >tps = 337.067113 (including connections establishing)</font></div><div><font size="2"   >tps = 2185.829436 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.439708 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@39-&gt; pgbench -M extended -n -r -f ./test.sql -C -h 127.0.0.1 -T 30</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: extended</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 9290</font></div><div><font size="2"   >tps = 309.649636 (including connections establishing)</font></div><div><font size="2"   >tps = 1926.787069 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.478594 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres@39-&gt; pgbench -M extended -n -r -f ./test.sql -C -h 172.16.3.39 -T 30</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: extended</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 9266</font></div><div><font size="2"   >tps = 308.858276 (including connections establishing)</font></div><div><font size="2"   >tps = 1948.086624 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.472647 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div></div><p></p></pre></div><div><br></div><div>短连接, 多连接, 多线程</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@39-&gt; pgbench -M extended -n -r -f ./test.sql -C -h $PGDATA -c 12 -j 4 -T 30</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: extended</font></div><div><font size="2"   >number of clients: 12</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 40660</font></div><div><font size="2"   >tps = 1355.155356 (including connections establishing)</font></div><div><font size="2"   >tps = 105398.087748 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 5.923797 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@39-&gt; pgbench -M extended -n -r -f ./test.sql -C -h 127.0.0.1 -c 12 -j 4 -T 30</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: extended</font></div><div><font size="2"   >number of clients: 12</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 37356</font></div><div><font size="2"   >tps = 1244.968975 (including connections establishing)</font></div><div><font size="2"   >tps = 63769.612728 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 6.454358 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@39-&gt; pgbench -M extended -n -r -f ./test.sql -C -h 172.16.3.39 -c 12 -j 4 -T 30</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: extended</font></div><div><font size="2"   >number of clients: 12</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 28165</font></div><div><font size="2"   >tps = 464.333385 (including connections establishing)</font></div><div><font size="2"   >tps = 4954.486537 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 15.765824 &nbsp; &nbsp; &nbsp; select 1;</font></div><p></p></pre></div><wbr><div><br></div><div><br><div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="short  long connection performance between unix socket vs loopback vs IP - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a><br></div></div></div>
	</div>
</div>
</body>
</html>