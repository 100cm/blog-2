<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">MonetDB load balance method by build-in forward or HAPROXY</h2>
	<h5 id="">2014-08-17 15:56:25&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201471734336495/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>monetdbd支持使用广播协议进行发现, 同时支持设置数据库的tag, 支持使用通配符连接数据库.</div><div>支持通配符有一个好处, 如果通配符匹配多个数据库的话, 会采用round-robin的方式连接, 例如 :</div><div>在一个广播域中, 有两个数据库名都是test, 分别设置了tag 221和150</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# monetdb discover</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;location</font></div><div><font size="2"   >mapi:monetdb://150.sky-mobi.com:50000/test/150</font></div><div><font size="2"   >mapi:monetdb://db-172-16-3-221:50000/test/221</font></div><p></p></pre></div><div>如果使用通配符, test/* 则匹配test/150 和test/221 .</div><div>那么会轮询方式连接, 例如</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-221 ~]# mclient -h 172.16.3.221 test/*</font></span></div><div><div><font size="2"   >Welcome to mclient, the MonetDB/SQL interactive terminal (Jan2014-SP3)</font></div><div><font size="2"   >Database: MonetDB v11.17.21 (Jan2014-SP3), 'mapi:monetdb://150.sky-mobi.com:50000/test'</font></div><div><font size="2"   >Type \q to quit, \? for a list of available commands</font></div><div><font size="2"   >auto commit mode: on</font></div><div><font size="2"   >sql&gt;\q</font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# mclient -h 172.16.3.221 test/*</font></div><div><font size="2"   >Welcome to mclient, the MonetDB/SQL interactive terminal (Jan2014-SP3)</font></div><div><font size="2"   >Database: MonetDB v11.17.21 (Jan2014-SP3), 'mapi:monetdb://db-172-16-3-221:50000/test'</font></div><div><font size="2"   >Type \q to quit, \? for a list of available commands</font></div><div><font size="2"   >auto commit mode: on</font></div><div><font size="2"   >sql&gt;\q</font></div></div><p></p></pre></div><div>如果库名不一样的话, 使用*/来匹配, 即用*来替换库名. 例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# mclient -h 172.16.3.221 */221</font></div><div><font size="2"   >Welcome to mclient, the MonetDB/SQL interactive terminal (Jan2014-SP3)</font></div><div><font size="2"   >Database: MonetDB v11.17.21 (Jan2014-SP3), 'mapi:monetdb://db-172-16-3-221:50000/test'</font></div><div><font size="2"   >Type \q to quit, \? for a list of available commands</font></div><div><font size="2"   >auto commit mode: on</font></div><div><font size="2"   >sql&gt;\q</font></div><p></p></pre></div><div>又或者*/*</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# mclient -h 172.16.3.221 */*</font></div><div><font size="2"   >Welcome to mclient, the MonetDB/SQL interactive terminal (Jan2014-SP3)</font></div><div><font size="2"   >Database: MonetDB v11.17.21 (Jan2014-SP3), 'mapi:monetdb://db-172-16-3-221:50000/test'</font></div><div><font size="2"   >Type \q to quit, \? for a list of available commands</font></div><div><font size="2"   >auto commit mode: on</font></div><div><font size="2"   >sql&gt;\q</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# mclient -h 172.16.3.221 */*</font></div><div><font size="2"   >Welcome to mclient, the MonetDB/SQL interactive terminal (Jan2014-SP3)</font></div><div><font size="2"   >Database: MonetDB v11.17.21 (Jan2014-SP3), 'mapi:monetdb://150.sky-mobi.com:50000/test'</font></div><div><font size="2"   >Type \q to quit, \? for a list of available commands</font></div><div><font size="2"   >auto commit mode: on</font></div><div><font size="2"   >sql&gt;\q</font></div><p></p></pre></div><div><br></div><div>如果客户端和数据库可以直接连接, 那么建议网络中的monetdbd, 设置forward=redirect.</div><div><br></div><div>如果客户端不能直接和数据库相连, 那么建议设置forward=proxy, 例如处于网络边界的monetdbd, 设置forward=proxy.</div><div><br></div><div>因此MonetDB天生就具备了负载均衡的能力, 当然还可以使用其他的方案, 例如常用的haproxy.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.haproxy.com/"   >http://www.haproxy.com/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.haproxy.org"   >http://www.haproxy.org</a></div><div>3. man monetdbd</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >REMOTE DATABASES</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The neighbor discovery capabilities of monetdbd allow a user to contact a remote database transparently, as &nbsp;if</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;it &nbsp;were &nbsp;a &nbsp;local database. &nbsp;By default, all local databases are announced in the network, such that neighbors</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;can pick them up to make them available for their local users. &nbsp;This feature can be disabled &nbsp;globally, &nbsp;or &nbsp;on</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;database level. &nbsp;For the latter, the monetdb(1) utility can be used to change the share property of a database.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;While neighbor discovery in itself is sufficient to locate a database in a cluster, it is &nbsp;limited &nbsp;in &nbsp;expres-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;siveness. &nbsp; For &nbsp;instance, &nbsp;database &nbsp;names &nbsp;are assumed to be unique throughout the entire system. &nbsp;This means</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;local databases overshadow remote ones, and duplicate remote entries cannot be &nbsp;distinguished. &nbsp; To &nbsp;compensate</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;for this, monetdbd allows to adds a tag to each database that is being shared. &nbsp;This tag is sent in addition to</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;the database name, and only understood by other monetdbds.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Tags are arbitrary ASCII-strings matching the pattern [A-Za-z0-9./]+. &nbsp;There are no assumed &nbsp;semantics &nbsp;in &nbsp;the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;tag, &nbsp;which &nbsp;allows for multiple approaches when using the tag. &nbsp;The tag is always used in combination with the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;database name. &nbsp;For this, the ‘/’ character is used as separator, which hence suggests the &nbsp;user &nbsp;to &nbsp;use &nbsp;that</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;character &nbsp;as &nbsp;separator &nbsp;for &nbsp;multilevel &nbsp;tags. &nbsp;Monetdbd allows common path globbing using ‘*’ on tags, which</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;allows for many use-cases. &nbsp;Consider for instance the following three databases with their tag:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;dbX/master/tableQ</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;dbY/slave/tableQ</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;dbZ/slave/tableQ</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;A default match has implicit ‘/*’ added to the search, making more generic search strings match &nbsp;more &nbsp;specific</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ones. &nbsp;Hence, a connect with database dbX is the same as dbX/* and hence matches dbX/master/tableQ. &nbsp;Similar, a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;database connect for */master matches the same database as before. &nbsp;Note that the implicit ‘/*’ is not added if</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;that &nbsp;would &nbsp;cause &nbsp;no matches, such as for */master/tableQ which would return all masters for tableQ, which in</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;our hypothetical example is only dbX. &nbsp;In contrast, a database connect for */slave/tableQ matches &nbsp;with &nbsp;either</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;dbY or dbZ. &nbsp;Monetdbd returns the two options to the client in a round-robin fashion, such that subsequent con-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;nects for the same pattern result in a load-balanced connect to either of both databases.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;With tags in use, one can possibly make distinction between databases, if setup like that. &nbsp;The previous &nbsp;exam-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ple could hence also be setup like this:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;tableQ/master</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;tableQ/slave</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;tableQ/slave</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Connecting &nbsp;to &nbsp;tableQ/slave &nbsp;would &nbsp;now return either of both databases even though they are not unique (apart</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;from the host they are located on, which is not shown in the example). &nbsp;While being confusing for &nbsp;humans, &nbsp;for</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;monetdbd &nbsp;it is the same situation as in the previous example. &nbsp;However, because globbing allows to make things</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;easier to understand, tags for both slaves could be changed to slaveX or slave/X and use the necessary &nbsp;pattern</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;to match them. &nbsp;It is up to the user to decide how to use the tags.</font></div></div><p></p></pre></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="MonetDB load balance method by build-in forward or HAPROXY - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>