<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">USE OpenVSwitch Isolating VM traffic using VLANs</h2>
	<h5 id="">2014-08-01 11:20:48&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020147111145122/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>[原文]</div><div><a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://openvswitch.org/support/config-cookbooks/vlan-configuration-cookbook/"   >http://openvswitch.org/support/config-cookbooks/vlan-configuration-cookbook/</a></div><div>openvswitch在虚拟化环境中, 使用vlan隔离虚拟机通讯.</div><div>本文模拟环境有2台物理机, 2个物理网卡(eth0和eth1), 其中eth0加入网桥br0, 用于虚拟机通讯; eth1未加入虚拟网桥, 用于物理连接.</div><div>因为eth1已经用于管理了, 所以br0可以配, 也可以不配IP. eth0则不需要配置IP(配了也不通), 因为已经作为虚拟交换机端口使用了.</div><div>tap0, tap1在KVM环境可能叫vnet0, vnet1; 是创建虚拟机时, 在网桥br0中生成的端口, 本文通过控制这些端口在虚拟交换机中的vlan tag, 来隔离他们之间的通讯.</div><div>注意ETH0连接的物理交换机的端口, 必须是trunk口, 才能携带TAG信息.</div><div><h1 style="margin: 1em 0px 0.5em; padding: 0px; border: 0px; font-family: Arial, Helvetica, sans-serif; line-height: 1em; vertical-align: baseline; color: rgb(68, 68, 68);"   >VLANs</h1><div style="margin: 0px; padding: 0px; border: 0px; font-family: Arial, Helvetica, sans-serif; font-size: 14px; line-height: 21px; vertical-align: baseline; clear: both; color: rgb(68, 68, 68);"   ><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   ><span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: 700; line-height: inherit; vertical-align: baseline;"   >Topic:</span></p><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   >Isolating VM traffic using VLANs</p><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   ><span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: 700; line-height: inherit; vertical-align: baseline;"   >Setup:</span></p><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   ><span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; text-decoration: underline;"   >Two Physical Networks:</span></p><ul style="margin-top: 0px; margin-bottom: 1.6em; margin-left: 1.5em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; list-style-position: initial; list-style-image: initial;"   ><li style="margin: 0px 0px 0px 0.85em; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   >Data Network:&nbsp; Ethernet network for VM data traffic, which will carry VLAN tagged traffic between VMs.&nbsp; Your physical switch(es) must be capable of forwarding VLAN tagged traffic and the physical switch ports should be VLAN trunks (Usually this is default behavior.&nbsp; Configuring your physical switching hardware is beyond the scope of this document).</li><li style="margin: 0px 0px 0px 0.85em; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   >Management Network: This network is not strictly required, but it is a simple way to give the physical host an IP address for remote access, since an IP address cannot be assigned directly to eth0.&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: 700; line-height: inherit; vertical-align: baseline;"   ><br></span></li></ul><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   ><span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; text-decoration: underline;"   >Two Physical Hosts:</span></p><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   >Host1, Host2.&nbsp; Both hosts are running Open vSwitch.&nbsp; Each host has two NICs:</p><ul style="margin-top: 0px; margin-bottom: 1.6em; margin-left: 1.5em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; list-style-position: initial; list-style-image: initial;"   ><li style="margin: 0px 0px 0px 0.85em; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   >eth0 is connected to the Data Network.&nbsp; No IP address can be assigned on eth0.</li><li style="margin: 0px 0px 0px 0.85em; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   >eth1 is connected to the Management Network (if necessary).&nbsp;&nbsp; eth1 has an IP address that is used to reach the physical host for management.</li></ul><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   ><span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; text-decoration: underline;"   >Four VMs:</span></p><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   >VM1,VM2 run on Host1.&nbsp; VM3,VM4 run on Host2.</p><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   >Each VM has a single interface that appears as a Linux device (e.g., “tap0″) on the physical host.&nbsp; (Note: for Xen/XenServer, VM interfaces appears as Linux devices with names like “vif1.0″)</p><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; text-align: center;"   ><img title="2host-4vm"   src="http://openvswitch.org/wordpress/wp-content/uploads/2010/07/2host-4vm.png"   alt=""   style="margin: 5px auto; padding: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; display: block; max-width: 98%; height: auto;"   ></p><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   ><a style="margin: 0px; padding: 0.3em 0px 0.1em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: 700; line-height: inherit; vertical-align: baseline; color: rgb(68, 112, 153); text-decoration: none; position: relative;" rel="nofollow" href="http://openvswitch.org/wp-content/uploads/2010/07/2host-4vm.png"   ><br></a><span id="more-146"   style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   ></span><br><span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: 700; line-height: inherit; vertical-align: baseline;"   ></span></p><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   ><span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: 700; line-height: inherit; vertical-align: baseline;"   >Goal:</span></p><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   >Isolate VMs using VLANs on the Data Network.<br>VLAN 1: VM1,VM3<br>VLAN 2: VM2,VM4</p><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   ></p><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   ><span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: 700; line-height: inherit; vertical-align: baseline;"   >Configuration:</span></p><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   >Perform the following configuration on Host 1:</p><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   >Create an OVS bridge:</p><blockquote style="margin-top: 1.6em; margin-bottom: 1.6em; margin-left: 0px; padding: 0px 1em; border-top-width: 4px; border-bottom-width: 4px; border-style: double none; border-top-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; quotes: none;"   ><p style="margin: 20px; padding-left: 12px; border: 0px; font-family: Georgia, 'Times New Roman', Times, serif; font-size: 18px; font-style: italic; font-variant: inherit; font-weight: inherit; line-height: 26px; vertical-align: baseline; color: rgb(153, 153, 153);"   >ovs-vsctl add-br br0</p></blockquote><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   >Add eth0 to the bridge (by default, all OVS ports are VLAN trunks, so eth0 will pass all VLANs):</p><blockquote style="margin-top: 1.6em; margin-bottom: 1.6em; margin-left: 0px; padding: 0px 1em; border-top-width: 4px; border-bottom-width: 4px; border-style: double none; border-top-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; quotes: none;"   ><p style="margin: 20px; padding-left: 12px; border: 0px; font-family: Georgia, 'Times New Roman', Times, serif; font-size: 18px; font-style: italic; font-variant: inherit; font-weight: inherit; line-height: 26px; vertical-align: baseline; color: rgb(153, 153, 153);"   >ovs-vsctl add-port br0 eth0</p></blockquote><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   >Add VM1 as an “access port” on VLAN 1: &nbsp;注意tap0是虚拟机创建好之后, 自动生成的, 不是使用ovs-vsctl生成的. 所以必须先创建虚拟机.&nbsp;</p><blockquote style="margin-top: 1.6em; margin-bottom: 1.6em; margin-left: 0px; padding: 0px 1em; border-top-width: 4px; border-bottom-width: 4px; border-style: double none; border-top-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; quotes: none;"   ><p style="margin: 20px; padding-left: 12px; border: 0px; font-family: Georgia, 'Times New Roman', Times, serif; font-size: 18px; font-style: italic; font-variant: inherit; font-weight: inherit; line-height: 26px; vertical-align: baseline; color: rgb(153, 153, 153);"   >ovs-vsctl add-port br0 tap0 tag=1</p></blockquote><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   >Add VM2 on VLAN 2:</p><blockquote style="margin-top: 1.6em; margin-bottom: 1.6em; margin-left: 0px; padding: 0px 1em; border-top-width: 4px; border-bottom-width: 4px; border-style: double none; border-top-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; quotes: none;"   ><p style="margin: 20px; padding-left: 12px; border: 0px; font-family: Georgia, 'Times New Roman', Times, serif; font-size: 18px; font-style: italic; font-variant: inherit; font-weight: inherit; line-height: 26px; vertical-align: baseline; color: rgb(153, 153, 153);"   >ovs-vsctl add-port br0 tap1 tag=2</p></blockquote><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   >On Host 2, repeat the same configuration to setup a bridge with eth0 as a trunk:</p><blockquote style="margin-top: 1.6em; margin-bottom: 1.6em; margin-left: 0px; padding: 0px 1em; border-top-width: 4px; border-bottom-width: 4px; border-style: double none; border-top-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; quotes: none;"   ><p style="margin: 20px; padding-left: 12px; border: 0px; font-family: Georgia, 'Times New Roman', Times, serif; font-size: 18px; font-style: italic; font-variant: inherit; font-weight: inherit; line-height: 26px; vertical-align: baseline; color: rgb(153, 153, 153);"   >ovs-vsctl add-br br0</p><p style="margin: 20px; padding-left: 12px; border: 0px; font-family: Georgia, 'Times New Roman', Times, serif; font-size: 18px; font-style: italic; font-variant: inherit; font-weight: inherit; line-height: 26px; vertical-align: baseline; color: rgb(153, 153, 153);"   >ovs-vsctl add-port br0 eth0</p></blockquote><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   >Add VM3 to VLAN 1:</p><blockquote style="margin-top: 1.6em; margin-bottom: 1.6em; margin-left: 0px; padding: 0px 1em; border-top-width: 4px; border-bottom-width: 4px; border-style: double none; border-top-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; quotes: none;"   ><p style="margin: 20px; padding-left: 12px; border: 0px; font-family: Georgia, 'Times New Roman', Times, serif; font-size: 18px; font-style: italic; font-variant: inherit; font-weight: inherit; line-height: 26px; vertical-align: baseline; color: rgb(153, 153, 153);"   >ovs-vsctl add-port br0 tap0 tag=1</p></blockquote><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   >Add VM4 to VLAN 2:</p><blockquote style="margin-top: 1.6em; margin-bottom: 1.6em; margin-left: 0px; padding: 0px 1em; border-top-width: 4px; border-bottom-width: 4px; border-style: double none; border-top-color: rgb(221, 221, 221); border-bottom-color: rgb(221, 221, 221); font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline; quotes: none;"   ><p style="margin: 20px; padding-left: 12px; border: 0px; font-family: Georgia, 'Times New Roman', Times, serif; font-size: 18px; font-style: italic; font-variant: inherit; font-weight: inherit; line-height: 26px; vertical-align: baseline; color: rgb(153, 153, 153);"   >ovs-vsctl add-port br0 tap1 tag=2</p></blockquote><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   ><span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: 700; line-height: inherit; vertical-align: baseline;"   ></span></p><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   ><span style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: 700; line-height: inherit; vertical-align: baseline;"   >Trouble-Shooting:</span></p><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   >Ping from VM1 to VM3, this should succeed.</p><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   >Ping from VM2 to VM4, this should succeed.</p><p style="margin-top: 0px; margin-bottom: 1.6em; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; vertical-align: baseline;"   >Ping from VM1/VM3 to VM2/VM4, this should not succeed (unless you have a router configured to forward between the VLANs, in which case, packets arriving at VM3 should have the source MAC address of the router, not of VM1).</p></div></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://openvswitch.org/support/config-cookbooks/vlan-configuration-cookbook/"   >http://openvswitch.org/support/config-cookbooks/vlan-configuration-cookbook/</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="USE OpenVSwitch Isolating VM traffic using VLANs - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>