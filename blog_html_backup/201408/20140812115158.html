<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Linux iptables SNAT exp</h2>
	<h5 id="">2014-08-12 11:51:58&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014712112251980/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>本文介绍一下使用linux iptables防火墙实现源地址转换, 达到内网机器通过可以访问外网的Linux机器来访问外网的目的.</div><div>例如</div><div>Linux机器有2个网卡, eth0和eth1.</div><div>eth0连接外网, eth1连接内网, 内网机器可以通过linux来访问外网.</div><div><div><img title="Linux iptables SNAT exp - 德哥@Digoal - PostgreSQL research"   alt="Linux iptables SNAT exp - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/gajF6Syq1GUHDDkd9E5TbQ==/6598186870472283855.png"   ></div><div><br></div>又例如, br0网段可以访问外网, 但是<span style="line-height: 28px;"   >如果虚拟机使用的网段不是br0网段的话, &nbsp;可以在Linux主机配置br0:1, br0:1和虚拟机同网段, 首先让Linux主机和虚拟机可以相互通讯, 然后在Linux主机做SNAT, 达到虚拟机也可以访问外网的目的.</span></div><div><div><img title="Linux iptables SNAT exp - 德哥@Digoal - PostgreSQL research"   alt="Linux iptables SNAT exp - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/CPekJcJojD8WDK3KBAlg0Q==/6599303974285422022.png"   ></div><br></div><div>环境介绍</div><div>虚拟机网段: 172.16.13.0/24</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># ifconfig</font></div><div><font size="2"   >eth0 &nbsp; &nbsp; &nbsp;Link encap:Ethernet &nbsp;HWaddr 00:1A:4A:9A:38:1C &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:172.16.13.2 &nbsp;Bcast:172.16.13.255 &nbsp;Mask:255.255.255.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet6 addr: fe80::21a:4aff:fe9a:381c/64 Scope:Link</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:243952 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:6416 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:1000&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:35806421 (34.1 MiB) &nbsp;TX bytes:483841 (472.5 KiB)</font></div><p></p></pre></div><div><br></div><div>Linux主机br0网段: 172.16.3.0/24</div><div><span style="line-height: 28px;"   >Linux主机br0:1网段: 172.16.13.0/24</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># ifconfig</font></div><div><div><font size="2"   >br0 Link encap:Ethernet &nbsp;HWaddr 00:23:7D:A3:F0:4E &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:172.16.3.176 &nbsp;Bcast:172.16.3.255 &nbsp;Mask:255.255.255.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet6 addr: fe80::223:7dff:fea3:f04e/64 Scope:Link</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:5573697 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:4202453 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:2475677006 (2.3 GiB) &nbsp;TX bytes:522026043 (497.8 MiB)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >br0:1 Link encap:Ethernet &nbsp;HWaddr 00:23:7D:A3:F0:4E &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:172.16.13.103 &nbsp;Bcast:172.16.13.255 &nbsp;Mask:255.255.255.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >测试Linux 主机和虚拟机可以相互通讯.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@176 ~]# ping 172.16.13.2</font></div><div><font size="2"   >PING 172.16.13.2 (172.16.13.2) 56(84) bytes of data.</font></div><div><font size="2"   >64 bytes from 172.16.13.2: icmp_seq=1 ttl=64 time=0.447 ms</font></div><p></p></pre></div><div><br></div><div>配置虚拟机网关, dns</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@13 ~]# cat /etc/sysconfig/network</font></div><div><font size="2"   >NETWORKING=yes</font></div><div><font size="2"   >HOSTNAME=13.2.sky-mobi.com</font></div><div><font size="2"   >GATEWAY=172.16.13.103</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@13 ~]# cat /etc/sysconfig/network-scripts/ifcfg-eth0</font></div><div><font size="2"   >DEVICE=eth0</font></div><div><font size="2"   >TYPE=Ethernet</font></div><div><font size="2"   >UUID=d6da67cd-092d-4a0d-a165-0a8d397c1e9c</font></div><div><font size="2"   >ONBOOT=yes</font></div><div><font size="2"   >NM_CONTROLLED=yes</font></div><div><font size="2"   >BOOTPROTO=none</font></div><div><font size="2"   >HWADDR=00:1A:4A:9A:38:1C</font></div><div><font size="2"   >IPADDR=172.16.13.2</font></div><div><font size="2"   >PREFIX=24</font></div><div><font size="2"   >GATEWAY=172.16.13.103</font></div><div><font size="2"   >DEFROUTE=yes</font></div><div><font size="2"   >IPV4_FAILURE_FATAL=yes</font></div><div><font size="2"   >IPV6INIT=no</font></div><div><font size="2"   >NAME=eth0</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@13 ~]# cat /etc/resolv.conf&nbsp;</font></div><div><font size="2"   >nameserver 202.101.172.35</font></div></div><div><span style="line-height: 28px;"   ><font size="2"   >[root@13 ~]# service network restart</font></span></div><p></p></pre></div><div><br></div><div>配置Linux主机的iptables</div><div>分别对nat和filter链表插入几条记录.</div><div>172.16.3.176是Linux主机br0的地址, 用于外部通讯,</div><div>172.16.13.103是Linux主机br0:1的地址, 用于与虚拟机通讯,</div><div>172.16.13.2是虚拟机eth0的地址.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 28px;"   >[root@176 ~]#</span><span style="line-height: 28px;"   >&nbsp;</span><span style="line-height: 28px;"   >iptables -t nat&nbsp;</span>-I POSTROUTING -s 172.16.13.0/24 -j SNAT --to-source 172.16.3.176</font></div><div><div><font size="2"   >[root@176 ~]# iptables -t filter -I FORWARD -d 172.16.13.0/24 -j ACCEPT</font></div><div><font size="2"   >[root@176 ~]# iptables -t filter -I FORWARD -s 172.16.13.0/24 -j ACCEPT</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >查看当前配置</font></div><div><div><font size="2"   >[root@176 ~]# iptables-save</font></div><div><font size="2"   ># Generated by iptables-save v1.4.7 on Tue Aug 12 11:40:51 2014</font></div><div><font size="2"   >*nat</font></div><div><font size="2"   >:PREROUTING ACCEPT [179:25078]</font></div><div><font size="2"   >:POSTROUTING ACCEPT [1:76]</font></div><div><font size="2"   >:OUTPUT ACCEPT [1:76]</font></div><div><font size="2"   >-A POSTROUTING -s 172.16.13.0/24 -j SNAT --to-source 172.16.3.176&nbsp;</font></div><div><font size="2"   >COMMIT</font></div><div><font size="2"   ># Completed on Tue Aug 12 11:40:51 2014</font></div><div><font size="2"   ># Generated by iptables-save v1.4.7 on Tue Aug 12 11:40:51 2014</font></div><div><font size="2"   >*filter</font></div><div><font size="2"   >:INPUT ACCEPT [0:0]</font></div><div><font size="2"   >:FORWARD ACCEPT [0:0]</font></div><div><font size="2"   >:OUTPUT ACCEPT [835:177362]</font></div><div><font size="2"   >-A INPUT -p gre -j ACCEPT&nbsp;</font></div><div><font size="2"   >-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT&nbsp;</font></div><div><font size="2"   >-A INPUT -p icmp -j ACCEPT&nbsp;</font></div><div><font size="2"   >-A INPUT -i lo -j ACCEPT&nbsp;</font></div><div><font size="2"   >-A INPUT -s 192.168.0.0/16 -j ACCEPT&nbsp;</font></div><div><font size="2"   >-A INPUT -s 10.0.0.0/8 -j ACCEPT&nbsp;</font></div><div><font size="2"   >-A INPUT -s 172.16.0.0/16 -j ACCEPT&nbsp;</font></div><div><font size="2"   >-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT&nbsp;</font></div><div><font size="2"   >-A INPUT -j REJECT --reject-with icmp-host-prohibited&nbsp;</font></div><div><font size="2"   >-A FORWARD -s 172.16.13.0/24 -j ACCEPT&nbsp;</font></div><div><font size="2"   >-A FORWARD -d 172.16.13.0/24 -j ACCEPT&nbsp;</font></div><div><font size="2"   >-A FORWARD -j REJECT --reject-with icmp-host-prohibited&nbsp;</font></div><div><font size="2"   >COMMIT</font></div><div><font size="2"   ># Completed on Tue Aug 12 11:40:51 2014</font></div></div><p></p></pre></div><div>以上内容拷贝到配置文件 /etc/sysconfig/iptables .</div><div><br></div><div>查看nat和filter链表当前情况.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@176 ~]# iptables -L -v -n -t nat</font></div><div><font size="2"   >Chain PREROUTING (policy ACCEPT 810 packets, 98255 bytes)</font></div><div><font size="2"   >&nbsp;pkts bytes target &nbsp; &nbsp; prot opt in &nbsp; &nbsp; out &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Chain POSTROUTING (policy ACCEPT 16 packets, 1038 bytes)</font></div><div><font size="2"   >&nbsp;pkts bytes target &nbsp; &nbsp; prot opt in &nbsp; &nbsp; out &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;51 &nbsp;3318 SNAT &nbsp; &nbsp; &nbsp; all &nbsp;-- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 172.16.13.0/24 &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; to:172.16.3.176&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Chain OUTPUT (policy ACCEPT 16 packets, 1038 bytes)</font></div><div><font size="2"   >&nbsp;pkts bytes target &nbsp; &nbsp; prot opt in &nbsp; &nbsp; out &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@176 ~]# iptables -L -v -n -t filter</font></div><div><font size="2"   >Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</font></div><div><font size="2"   >&nbsp;pkts bytes target &nbsp; &nbsp; prot opt in &nbsp; &nbsp; out &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; 0 &nbsp; &nbsp; 0 ACCEPT &nbsp; &nbsp; 47 &nbsp; -- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; 28M 9271M ACCEPT &nbsp; &nbsp; all &nbsp;-- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state RELATED,ESTABLISHED&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; 7 &nbsp; 588 ACCEPT &nbsp; &nbsp; icmp -- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;1031 53181 ACCEPT &nbsp; &nbsp; all &nbsp;-- &nbsp;lo &nbsp; &nbsp; * &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; 0 &nbsp; &nbsp; 0 ACCEPT &nbsp; &nbsp; all &nbsp;-- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 192.168.0.0/16 &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; 0 &nbsp; &nbsp; 0 ACCEPT &nbsp; &nbsp; all &nbsp;-- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 10.0.0.0/8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;162K &nbsp; 11M ACCEPT &nbsp; &nbsp; all &nbsp;-- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 172.16.0.0/16 &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; 0 &nbsp; &nbsp; 0 ACCEPT &nbsp; &nbsp; tcp &nbsp;-- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state NEW tcp dpt:22&nbsp;</font></div><div><font size="2"   >&nbsp;116K &nbsp; 58M REJECT &nbsp; &nbsp; all &nbsp;-- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reject-with icmp-host-prohibited&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</font></div><div><font size="2"   >&nbsp;pkts bytes target &nbsp; &nbsp; prot opt in &nbsp; &nbsp; out &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; 351 29448 ACCEPT &nbsp; &nbsp; all &nbsp;-- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 172.16.13.0/24 &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; 350 29650 ACCEPT &nbsp; &nbsp; all &nbsp;-- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;172.16.13.0/24 &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 308 25550 REJECT &nbsp; &nbsp; all &nbsp;-- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reject-with icmp-host-prohibited&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Chain OUTPUT (policy ACCEPT 24597 packets, 6048K bytes)</font></div><div><font size="2"   >&nbsp;pkts bytes target &nbsp; &nbsp; prot opt in &nbsp; &nbsp; out &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@176 ~]# iptables -L -v -n -t mangle</font></div><div><font size="2"   >Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</font></div><div><font size="2"   >&nbsp;pkts bytes target &nbsp; &nbsp; prot opt in &nbsp; &nbsp; out &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</font></div><div><font size="2"   >&nbsp;pkts bytes target &nbsp; &nbsp; prot opt in &nbsp; &nbsp; out &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</font></div><div><font size="2"   >&nbsp;pkts bytes target &nbsp; &nbsp; prot opt in &nbsp; &nbsp; out &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</font></div><div><font size="2"   >&nbsp;pkts bytes target &nbsp; &nbsp; prot opt in &nbsp; &nbsp; out &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</font></div><div><font size="2"   >&nbsp;pkts bytes target &nbsp; &nbsp; prot opt in &nbsp; &nbsp; out &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@176 ~]# iptables -L -v -n -t raw</font></div><div><font size="2"   >Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</font></div><div><font size="2"   >&nbsp;pkts bytes target &nbsp; &nbsp; prot opt in &nbsp; &nbsp; out &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</font></div><div><font size="2"   >&nbsp;pkts bytes target &nbsp; &nbsp; prot opt in &nbsp; &nbsp; out &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div></div><p></p></pre></div><div><br></div><div>如果写错了用-D删除, 别忘记指定链表,&nbsp;<span style="line-height: 28px;"   >例如</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >[root@176 ~]# iptables -t filter -D FORWARD -d 172.16.13.0/24 -j ACCEPT</font></span></div><div></div><p></p></pre></div><div>也可以指定行号删除.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@176 ~]# iptables -t filter -L -v -n --line-numbers</font></div><div><font size="2"   >Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</font></div><div><font size="2"   >num &nbsp; pkts bytes target &nbsp; &nbsp; prot opt in &nbsp; &nbsp; out &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >1 &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; 0 ACCEPT &nbsp; &nbsp; 47 &nbsp; -- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >2 &nbsp; &nbsp; 229K &nbsp; 87M ACCEPT &nbsp; &nbsp; all &nbsp;-- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state RELATED,ESTABLISHED&nbsp;</font></div><div><font size="2"   >3 &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; 0 ACCEPT &nbsp; &nbsp; icmp -- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >4 &nbsp; &nbsp; &nbsp; 13 &nbsp;1474 ACCEPT &nbsp; &nbsp; all &nbsp;-- &nbsp;lo &nbsp; &nbsp; * &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >5 &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; 0 ACCEPT &nbsp; &nbsp; all &nbsp;-- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 192.168.0.0/16 &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >6 &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; 0 ACCEPT &nbsp; &nbsp; all &nbsp;-- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 10.0.0.0/8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >7 &nbsp; &nbsp; &nbsp;658 51009 ACCEPT &nbsp; &nbsp; all &nbsp;-- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 172.16.0.0/16 &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >8 &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; 0 ACCEPT &nbsp; &nbsp; tcp &nbsp;-- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state NEW tcp dpt:22&nbsp;</font></div><div><font size="2"   >9 &nbsp; &nbsp; &nbsp;850 &nbsp;426K REJECT &nbsp; &nbsp; all &nbsp;-- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reject-with icmp-host-prohibited&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</font></div><div><font size="2"   >num &nbsp; pkts bytes target &nbsp; &nbsp; prot opt in &nbsp; &nbsp; out &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >1 &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; 0 ACCEPT &nbsp; &nbsp; all &nbsp;-- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 172.16.13.0/24 &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >2 &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; 0 ACCEPT &nbsp; &nbsp; all &nbsp;-- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;172.16.13.0/24 &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >3 &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; 0 REJECT &nbsp; &nbsp; all &nbsp;-- &nbsp;* &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reject-with icmp-host-prohibited&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Chain OUTPUT (policy ACCEPT 230K packets, 57M bytes)</font></div><div><font size="2"   >num &nbsp; pkts bytes target &nbsp; &nbsp; prot opt in &nbsp; &nbsp; out &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination&nbsp;</font></div><p></p></pre></div><div>删除第一行</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >iptables -t filter -D INPUT 1</font></div><div></div><p></p></pre></div><div>配置Linux主机ipforward, icmp转发.</div><div>开启ip_forward.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 28px;"   >[root@176 ~]</span># sysctl -w&nbsp;net.ipv4.ip_forward=1</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@176 ~]# vi /etc/sysctl.conf</font></div><div><div><font size="2"   ># Controls IP packet forwarding</font></div><div><font size="2"   >net.ipv4.ip_forward = 1</font></div></div><p></p></pre></div><div><br></div><div>默认已经开启了ICMP转发.所以不需要配置.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@176 ~]# sysctl -a|grep send_redirects</font></div><div><font size="2"   >net.ipv4.conf.all.send_redirects = 1</font></div><div><font size="2"   >net.ipv4.conf.default.send_redirects = 1</font></div><div><font size="2"   >net.ipv4.conf.lo.send_redirects = 1</font></div><div><font size="2"   >net.ipv4.conf.eth0.send_redirects = 1</font></div><div><font size="2"   >net.ipv4.conf.eth1.send_redirects = 1</font></div><div><font size="2"   >net.ipv4.conf.ovirtmgmt.send_redirects = 1</font></div><p></p></pre></div><div><br></div><div>测试虚拟机是否可以上外网.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@13 ~]# ping www.baidu.com</font></div><div><font size="2"   >PING www.a.shifen.com (115.239.210.27) 56(84) bytes of data.</font></div><div><font size="2"   >64 bytes from 115.239.210.27: icmp_seq=1 ttl=55 time=2.47 ms</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1. man iptables</div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.netfilter.org/documentation/HOWTO//NAT-HOWTO.html"   >http://www.netfilter.org/documentation/HOWTO//NAT-HOWTO.html<br></a><span style="line-height: 28px;"   >
</span><a style="line-height: 28px;" rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="Linux iptables SNAT exp - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div></div>
	</div>
</div>
</body>
</html>