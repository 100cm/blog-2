<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">MonetDB remote database forward method : proxy or redirect</h2>
	<h5 id="">2014-08-17 15:35:07&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020147172325701/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>MonetDB一个比较好用的功能, 共享数据库.</div><div>也就是说, monetdb可以通过共享数据库的方式, 让客户端连接一个节点就可以连接到其他节点.</div><div>如图 :&nbsp;</div><div><div><div><img title="MonetDB remote database forward method : proxy or redirect - 德哥@Digoal - PostgreSQL research"   alt="MonetDB remote database forward method : proxy or redirect - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/yEmLw2gv23fF4qV4QXy4oQ==/6608511284655107702.png"   ></div>&nbsp;</div>例如我在两台服务器上分别启动了一个monetdbd. 分别有一个数据库都名为test.</div><div>172.16.3.150</div><div>172.16.3.221</div><div>那么只要配置了数据库的shared=yes或者其他tag, 并且启动monetdbd时配置了discovery=yes, monetdb就可以在广播域发现它.</div><div>默认都是yes的. 如果不是, 可以直接修改.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 ~]# monetdbd set discovery=yes /data02/mdb1</font></div><div><span style="line-height: 28px;"   ><font size="2"   >[root@150 ~]# monetdbd set shared=yes|tag test</font></span></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@150 ~]# monetdb get shared test</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;prop &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; value</font></div><div><font size="2"   >test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shared &nbsp; &nbsp;local &nbsp; &nbsp;yes</font></div></div><div><div><font size="2"   >[root@150 ~]# monetdbd get discovery /data02/mdb1</font></div><div><font size="2"   >&nbsp; &nbsp;property &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;value</font></div><div><font size="2"   >discovery &nbsp; &nbsp; &nbsp; &nbsp;yes</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# monetdbd get discovery /data01/mdb1</font></div><div><font size="2"   >&nbsp; &nbsp;property &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;value</font></div><div><font size="2"   >discovery &nbsp; &nbsp; &nbsp; &nbsp;yes</font></div></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# monetdb get shared test</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;prop &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; value</font></div><div><font size="2"   >test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shared &nbsp; &nbsp;local &nbsp; &nbsp;yes</font></div></div><p></p></pre></div><div><br></div><div>只要这两台主机在同一个广播域, 就可以相互发现.</div><div>使用命令<span style="line-height: 28px;"   >&nbsp;</span><span style="line-height: 28px;"   >monetdb discover&nbsp;</span><span style="line-height: 28px;"   >.</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@150 ~]# monetdb discover</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;location</font></div><div><font size="2"   >mapi:monetdb://150.sky-mobi.com:50000/test</font></div><div><font size="2"   >mapi:monetdb://db-172-16-3-221:50000/test</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# monetdb discover</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;location</font></div><div><font size="2"   >mapi:monetdb://150.sky-mobi.com:50000/test</font></div><div><font size="2"   >mapi:monetdb://db-172-16-3-221:50000/test</font></div></div><p></p></pre></div><div><br></div><div>如果某个数据库的shared=no, 那么这个数据库就不可发现.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 ~]# monetdb set shared=no test</font></div><div><font size="2"   >[root@150 ~]# monetdb discover</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;location</font></div><div><font size="2"   >mapi:monetdb://db-172-16-3-221:50000/test</font></div><p></p></pre></div><div>150的test库就不可发现了.</div><div><br></div><div>注意发现协议和端口有关, (默认是50000端口), 同时只能发现一个端口. 后面我们说的round-robin连接也是同一个端口的.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 ~]# monetdbd create /data01/mdb1</font></div><div><div><font size="2"   >[root@150 mdb1]# monetdbd set port=50001 /data01/mdb1</font></div><div><font size="2"   >[root@150 mdb1]# monetdbd start /data01/mdb1</font></div></div><div><div><font size="2"   >[root@150 mdb1]# monetdb -p 50001 create test</font></div><div><font size="2"   >created database in maintenance mode: test</font></div><div><font size="2"   >[root@150 mdb1]# monetdb -p 50001 release test</font></div><div><font size="2"   >taken database out of maintenance mode: test</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@150 mdb1]# monetdb discover</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;location</font></div><div><font size="2"   >mapi:monetdb://db-172-16-3-221:50000/test</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@150 mdb1]# monetdb -p 50001 discover</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;location</font></div><div><font size="2"   >mapi:monetdb://150.sky-mobi.com:50001/test</font></div></div><p></p></pre></div><div><br></div><div>接下来要说的是客户端连接的到底是哪个数据库呢?</div><div>因为使用发现协议之后, 就可以连接本地数据库一样连接远程数据库. 这是monetdb的一个特性之一 - remote database.</div><div>我们先了解一下本地<span style="line-height: 28px;"   >monetdbd</span>服务用什么方法来连接远程数据库, 有两种方法.</div><div>一种是代理 proxy, 一种是重定向 redirect. 默认是proxy.</div><div>代理的意思是代理客户端请求, 所以客户端连接的是当前的monetdbd, 当前的monetdb连接到远程的monetdbd. (<span style="line-height: 28px;"   >&nbsp;</span><span style="line-height: 28px;"   >注意URI里面包含的地址是主机名, 所以必须能解析这个主机名, 或者写在hosts里面.</span><span style="line-height: 28px;"   >)</span></div><div>重定向指返回给客户端远程数据库是怎么连的(URI), 客户端直接和远程客户端连接, 这种方法在客户端不能直接连远程数据库时无法使用. 注意URI里面包含的地址是主机名, 所以必须能解析这个主机名, 或者写在hosts里面.</div><div>来看个例子 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 mdb1]# monetdbd get forward /data02/mdb1</font></div><div><font size="2"   >&nbsp; &nbsp;property &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;value</font></div><div><font size="2"   >forward &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;proxy</font></div><p></p></pre></div><div>当前<span style="line-height: 28px;"   >monetdbd</span>是代理模式的.</div><div>使用discover发现有两个数据库在本广播域.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 mdb1]# monetdb discover</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;location</font></div><div><font size="2"   >mapi:monetdb://150.sky-mobi.com:50000/test</font></div><div><font size="2"   >mapi:monetdb://db-172-16-3-221:50000/test</font></div><p></p></pre></div><div>接下来要配置remote database访问, 因为数据库名重复了, 所以必须区分, 如果不区分开来, 访问的就是当前库, 而不会转发到远程库. 设置库的shared tag即可.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@150 postgresql-9.3.5]# monetdb set shared=150 test</font></div><div><font size="2"   >[root@150 postgresql-9.3.5]# monetdb get shared test</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;prop &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; value</font></div><div><font size="2"   >test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shared &nbsp; &nbsp;local &nbsp; &nbsp;150</font></div></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# monetdb set shared=221 test</font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# monetdb get shared test</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;prop &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; value</font></div><div><font size="2"   >test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shared &nbsp; &nbsp;local &nbsp; &nbsp;221</font></div></div><p></p></pre></div><div>然后要配置主机名, 否则有URI也会因为无法解析而无法连接.</div><div>主机名需要在所有的monetdbd操作系统配置, 同时需要在mclient客户端操作系统配置.</div><div>例如本例需要配置2个条目, 包括所有monetdbd的主机名.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi /etc/hosts</font></div><div><div><font size="2"   >172.16.3.150 150.sky-mobi.com</font></div><div><font size="2"   >172.16.3.221 db-172-16-3-221</font></div></div><p></p></pre></div><div>然后现在发现一下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# monetdb discover</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;location</font></div><div><font size="2"   >mapi:monetdb://150.sky-mobi.com:50000/test/150</font></div><div><font size="2"   >mapi:monetdb://db-172-16-3-221:50000/test/221</font></div><p></p></pre></div><div>URI已经可以区分出database name了.分别是test/150和test/221.</div><div>接下来看看forward proxy和redirect的区别, 查看当前forward配置.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# monetdbd get forward /data01/mdb1</font></div><div><font size="2"   >&nbsp; &nbsp;property &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;value</font></div><div><font size="2"   >forward &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;proxy</font></div><p></p></pre></div><div><br></div><div>代理例子 :&nbsp;</div><div>当前monetdbd的端口信息</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-221 ~]# netstat -anp|grep 50000</font></div><div style="line-height: 28px;"   ><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:50000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;28180/monetdbd &nbsp; &nbsp; &nbsp;监听端口</font></div><div style="line-height: 28px;"   ><font size="2"   >udp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:50000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 28180/monetdbd &nbsp; &nbsp; &nbsp;-- 用于发现协议</font></div><div style="line-height: 28px;"   ><font size="2"   >unix &nbsp;2 &nbsp; &nbsp; &nbsp;[ ACC ] &nbsp; &nbsp; STREAM &nbsp; &nbsp; LISTENING &nbsp; &nbsp; 1226862 28180/monetdbd &nbsp; &nbsp; &nbsp;/tmp/.s.monetdb.50000</font></div><div style="line-height: 28px;"   ><font size="2"   >unix &nbsp;2 &nbsp; &nbsp; &nbsp;[ ACC ] &nbsp; &nbsp; STREAM &nbsp; &nbsp; LISTENING &nbsp; &nbsp; 1226867 28180/monetdbd &nbsp; &nbsp; &nbsp;/tmp/.s.merovingian.50000</font></div><p></p></pre></div></div><div style="line-height: 28px;"   >使用tag连接remote database</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# mclient -h 127.0.0.1 test/221</font></div><div><font size="2"   >Welcome to mclient, the MonetDB/SQL interactive terminal (Jan2014-SP3)</font></div><div><font size="2"   >Database: MonetDB v11.17.21 (Jan2014-SP3), 'mapi:monetdb://db-172-16-3-221:50000/test'</font></div><div><font size="2"   >Type \q to quit, \? for a list of available commands</font></div><div><font size="2"   >auto commit mode: on</font></div><div><font size="2"   >sql&gt;</font></div><p></p></pre></div><div>连接后的端口状态</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# netstat -anp|grep 50000</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:50000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;28180/monetdbd &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 172.16.3.221:10589 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;172.16.3.221:50000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ESTABLISHED 28180/monetdbd &nbsp; &nbsp; &nbsp;--&nbsp;<span style="line-height: 28px;"   >与远程数据库建立的连接 (用于代理客户端的请求)</span></font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 127.0.0.1:50000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1:16563 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESTABLISHED 28180/monetdbd &nbsp; &nbsp; &nbsp;--&nbsp;<span style="line-height: 28px;"   >与客户端建立的连接</span></font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 172.16.3.221:50000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;172.16.3.221:10589 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ESTABLISHED 28232/mserver5 &nbsp; &nbsp; &nbsp;-- 存储访问接口mserver5</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 127.0.0.1:16563 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1:50000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESTABLISHED 28396/mclient &nbsp; &nbsp; &nbsp; -- 客户端</font></div><div><font size="2"   >udp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:50000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 28180/monetdbd &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >unix &nbsp;2 &nbsp; &nbsp; &nbsp;[ ACC ] &nbsp; &nbsp; STREAM &nbsp; &nbsp; LISTENING &nbsp; &nbsp; 1226862 28180/monetdbd &nbsp; &nbsp; &nbsp;/tmp/.s.monetdb.50000</font></div><div><font size="2"   >unix &nbsp;2 &nbsp; &nbsp; &nbsp;[ ACC ] &nbsp; &nbsp; STREAM &nbsp; &nbsp; LISTENING &nbsp; &nbsp; 1226867 28180/monetdbd &nbsp; &nbsp; &nbsp;/tmp/.s.merovingian.50000</font></div><p></p></pre></div><div>使用tag连接remote database</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-221 ~]# mclient -h 127.0.0.1 test/150</font></div><div><font size="2"   >Welcome to mclient, the MonetDB/SQL interactive terminal (Jan2014-SP3)</font></div><div><font size="2"   >Database: MonetDB v11.17.21 (Jan2014-SP3), 'mapi:monetdb://150.sky-mobi.com:50000/test'</font></div><div><font size="2"   >Type \q to quit, \? for a list of available commands</font></div><div><font size="2"   >auto commit mode: on</font></div><div><font size="2"   >sql&gt;</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# netstat -anp|grep 50000</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:50000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;28180/monetdbd &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 172.16.3.221:11050 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;172.16.3.150:50000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ESTABLISHED 28180/monetdbd &nbsp; &nbsp; &nbsp;-- 与远程数据库建立的连接 (用于代理客户端的请求)</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 127.0.0.1:16565 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1:50000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESTABLISHED 28410/mclient &nbsp; &nbsp; &nbsp; -- 客户端</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 127.0.0.1:50000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1:16565 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESTABLISHED 28180/monetdbd &nbsp; &nbsp; &nbsp;<span style="line-height: 28px;"   >&nbsp; -- 与客户端建立的连接</span></font></div><div><font size="2"   >udp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:50000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 28180/monetdbd &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >unix &nbsp;2 &nbsp; &nbsp; &nbsp;[ ACC ] &nbsp; &nbsp; STREAM &nbsp; &nbsp; LISTENING &nbsp; &nbsp; 1226862 28180/monetdbd &nbsp; &nbsp; &nbsp;/tmp/.s.monetdb.50000</font></div><div><font size="2"   >unix &nbsp;2 &nbsp; &nbsp; &nbsp;[ ACC ] &nbsp; &nbsp; STREAM &nbsp; &nbsp; LISTENING &nbsp; &nbsp; 1226867 28180/monetdbd &nbsp; &nbsp; &nbsp;/tmp/.s.merovingian.50000</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >172.16.3.150上的端口状态</font></div><div><div><font size="2"   >[root@150 mdb1]# netstat -anp|grep 50000</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:50000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;30864/monetdbd &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 172.16.3.150:50000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;172.16.3.221:11050 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ESTABLISHED 30957/mserver5 &nbsp; &nbsp; &nbsp;-- 存储访问接口</font></div><div><font size="2"   >udp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:50000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 30864/monetdbd &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >unix &nbsp;2 &nbsp; &nbsp; &nbsp;[ ACC ] &nbsp; &nbsp; STREAM &nbsp; &nbsp; LISTENING &nbsp; &nbsp; 17478087 30864/monetdbd &nbsp; &nbsp; &nbsp;/tmp/.s.monetdb.50000</font></div><div><font size="2"   >unix &nbsp;2 &nbsp; &nbsp; &nbsp;[ ACC ] &nbsp; &nbsp; STREAM &nbsp; &nbsp; LISTENING &nbsp; &nbsp; 17478092 30864/monetdbd &nbsp; &nbsp; &nbsp;/tmp/.s.merovingian.50000</font></div><div><font size="2"   >unix &nbsp;2 &nbsp; &nbsp; &nbsp;[ ] &nbsp; &nbsp; &nbsp; &nbsp; STREAM &nbsp; &nbsp; CONNECTED &nbsp; &nbsp; 17482281 30957/mserver5 &nbsp; &nbsp; &nbsp;/tmp/.s.monetdb.50000</font></div></div><p></p></pre></div><div><br></div><div>重定向例子 :</div><div>将172.16.3.221的monetdbd &nbsp;forward改成redirect.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# monetdbd set forward=redirect /data01/mdb1</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >连接</span><span style="line-height: 28px;"   >172.16.3.221的monetdbd.</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-221 ~]# mclient -h 172.16.3.221 test/150</font></div><div><font size="2"   >Welcome to mclient, the MonetDB/SQL interactive terminal (Jan2014-SP3)</font></div><div><font size="2"   >Database: MonetDB v11.17.21 (Jan2014-SP3), 'mapi:monetdb://150.sky-mobi.com:50000/test'</font></div><div><font size="2"   >Type \q to quit, \? for a list of available commands</font></div><div><font size="2"   >auto commit mode: on</font></div><div><font size="2"   >sql&gt;</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# netstat -anp|grep 50000</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:50000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;28180/monetdbd &nbsp; &nbsp; &nbsp;</font></div><div><span style="line-height: 28px;"   ><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 172.16.3.221:11052 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;172.16.3.150:50000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ESTABLISHED 28437/mclient &nbsp; &nbsp; &nbsp; -- 直接连接到远程库了, 没有用到代理.&nbsp;</font></span></div><div><font size="2"   >udp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:50000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 28180/monetdbd &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >unix &nbsp;2 &nbsp; &nbsp; &nbsp;[ ACC ] &nbsp; &nbsp; STREAM &nbsp; &nbsp; LISTENING &nbsp; &nbsp; 1226862 28180/monetdbd &nbsp; &nbsp; &nbsp;/tmp/.s.monetdb.50000</font></div><div><font size="2"   >unix &nbsp;2 &nbsp; &nbsp; &nbsp;[ ACC ] &nbsp; &nbsp; STREAM &nbsp; &nbsp; LISTENING &nbsp; &nbsp; 1226867 28180/monetdbd &nbsp; &nbsp; &nbsp;/tmp/.s.merovingian.50000</font></div></div><p></p></pre></div><div><br></div><div>[其他]</div><div>1. 因为URI包含主机名. 如果不能解析主机名, 将无法连接.</div><div>例如, 注释221的/etc/hosts条目 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#172.16.3.221 db-172-16-3-221</font></div><div></div><p></p></pre></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@150 postgresql-9.3.5]# ping db-172-16-3-221</font></div><div><font size="2"   >PING db-172-16-3-221.sky-mobi.com (60.191.124.236) 56(84) bytes of data.</font></div><div><font size="2"   >64 bytes from mailitciberia.com (60.191.124.236): icmp_seq=1 ttl=250 time=1.18 ms</font></div><div><font size="2"   >64 bytes from mailitciberia.com (60.191.124.236): icmp_seq=2 ttl=250 time=1.25 ms</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@150 postgresql-9.3.5]# monetdb discover</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;location</font></div><div><font size="2"   >mapi:monetdb://150.sky-mobi.com:50000/test/150</font></div><div><font size="2"   >mapi:monetdb://db-172-16-3-221:50000/test/221</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >现在连接test/221会因为无法连接到<span style="line-height: 28px;"   >db-172-16-3-221:50000</span><span style="line-height: 28px;"   >超时.</span></font></div><div><font size="2"   >[root@150 postgresql-9.3.5]# mclient -h 172.16.3.150 test/221</font></div><p></p></pre></div><div><br></div></div><div>[参考]</div><div>1. man monetdbd</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;discovery</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Specifies whether neighbor discovery is to be enabled using UDP broadcasts or not. &nbsp;The &nbsp;broadcasts &nbsp;are</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; done on the same portnumber as the port setting.</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;forward</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; monetdbd &nbsp;has &nbsp;two &nbsp;ways in which it can "attach" a connecting client to the target database. &nbsp;The first</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; method, redirect, uses a redirect sent to the client with the responsible mserver process. &nbsp; The &nbsp;second</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; method, &nbsp;proxy, &nbsp;proxies &nbsp;the client to the mserver over monetdbd. &nbsp;While redirect is more efficient, it</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; requires the connecting client to be able to connect to the mserver. &nbsp;In many settings this may be unde-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sirable &nbsp;or &nbsp;even &nbsp;impossible, &nbsp;since a wide range of open ports and routing are necessary for this. &nbsp;In</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; such case the proxy technique of monetdbd is a good solution, which also allows a monetdbd &nbsp;instance &nbsp;on</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; the &nbsp;border &nbsp;of &nbsp;a network to serve requests to nodes in the local (unreachable) network. &nbsp;Note that for</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; local databases, the proxy method uses a UNIX domain socket feature &nbsp;to &nbsp;pass &nbsp;file-descriptors &nbsp;to &nbsp;the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; local &nbsp;mserver. &nbsp; This &nbsp;effectively &nbsp;is &nbsp;as efficient as the redirect approach, but still hides away the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mservers properly behind monetdbd. &nbsp;Hence, in practice it is only relevant &nbsp;for &nbsp;connections &nbsp;to &nbsp;remote</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; databases &nbsp;to use redirects instead of proxies. &nbsp;Changing this property takes effect immediately at run-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; time.</font></div></div><p></p></pre></div><div><br></div><div>2. man monetdb</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;discover [expression]</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Returns a list of remote monetdbds and database URIs that were discovered by monetdbd(1). &nbsp;All databases</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; listed &nbsp;can &nbsp;be &nbsp;connected &nbsp;to via the local MonetDB Database Server as if it were local databases using</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; their database name. &nbsp;The connection is redirected or &nbsp;proxied &nbsp;based &nbsp;on &nbsp;configuration &nbsp;settings. &nbsp; If</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; expression &nbsp;is &nbsp;given, &nbsp;only &nbsp;those &nbsp;discovered &nbsp;databases &nbsp;are returned for which their URI matches the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; expression. &nbsp;The expression syntax is described in the section EXPRESSIONS. &nbsp;Next to database &nbsp;URIs &nbsp;the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hostnames and ports for monetdbds that allow to be controlled remotely can be found in the discover list</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; masked with an asterisk. &nbsp;These entries can easily be filtered out using an expression (e.g. &nbsp;"mapi:mon-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; etdb:*") &nbsp;if &nbsp;desired. &nbsp;The control entries come in handy when one wants to get an overview of available</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; monetdbds in e.g. a local cluster. &nbsp;Note that for monetdbd to announce its control port, &nbsp;the &nbsp;mero_con-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trolport setting for that monetdbd must be enabled in the configuration file.</font></div><p></p></pre></div><wbr><div><br></div><a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="MonetDB remote database forward method : proxy or redirect - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>