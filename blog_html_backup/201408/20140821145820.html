<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Modify keepalived max auth password length to more than 8 (but be careful)</h2>
	<h5 id="">2014-08-21 14:58:20&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201472123810816/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>keepalived vrrp可以使用ipsec协议进行路由器之间的认证. 密码的长度最长是8, 超过的长度自动截断, 也就是说只要前8位一致, 密码就能通过.</div><div>例如两台主机的实例密码验证配置如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; &nbsp; authentication {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; auth_type PASS</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; auth_pass 1234567890</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div></div><div><font size="2"   ><br></font></div><div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; authentication {</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; auth_type PASS</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; auth_pass 1234567891</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; }</font></div></div><p></p></pre></div><div style="line-height: 28px;"   >以上不会报密码错误. 因为前8位是一致的.</div><div><br></div><div>查看源码, 和密码长度有关的代码有几处 :&nbsp;</div><div>1. keepalived/include/vrrp.h</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >#define VRRP_AUTH_NONE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* no authentification -- rfc2338.5.3.6 */</font></div><div><font size="2"   >#define VRRP_AUTH_PASS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* password authentification -- rfc2338.5.3.6 */</font></div><div><font size="2"   >#define VRRP_AUTH_AH &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* AH(IPSec) authentification - rfc2338.5.3.6 */</font></div></div><div><font size="2"   >密码长度为8</font></div><div><font size="2"   >#define VRRP_AUTH_LEN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8</font></div><div><font size="2"   >vrrp数据包的数据结构, 里面包含了认证类型和认证密码 :</font></div><div><div><font size="2"   >/* parameters per virtual router -- rfc2338.6.1.2 */</font></div><div><font size="2"   >typedef struct _vrrp_t {</font></div></div><div><font size="2"   >....</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Authentication data */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; auth_type; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* authentification type. VRRP_AUTH_* */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; uint8_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; auth_data[8]; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* authentification data */</font></div></div><div><font size="2"   >...</font></div><div><font size="2"   >} vrrp_t;</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >因为使用uint8_t[8]存储密码, 所以长度8位用掉8个字节, 这个协定刚好和vrrp协议一致 :&nbsp;</span></div><div><a target="_blank" rel="nofollow" href="http://www.ietf.org/rfc/rfc2338.txt"   >http://www.ietf.org/rfc/rfc2338.txt</a></div><div><pre style="line-height: normal; word-wrap: break-word; white-space: pre-wrap;"   ><pre class="prettyprint"   ><p><font size="2"   >5.1  VRRP Packet Format

   This section defines the format of the VRRP packet and the relevant
   fields in the IP header.

       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |Version| Type  | Virtual Rtr ID|   Priority    | Count IP Addrs|
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |   Auth Type   |   Adver Int   |          Checksum             |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         IP Address (1)                        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                            .                                  |
      |                            .                                  |
      |                            .                                  |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         IP Address (n)                        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                     Authentication Data (1)                   |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                     Authentication Data (2)                   |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</font></p></pre></pre></div><div>未达8字节的部分填充bit 0, 所以如果我们把密码长度拉长的话, 无形中和这个协定就出现了冲突, 你的环境中可能没有问题, 换到其他使用vrrp标准协议的场景, 可能就有问题了. 需要注意.</div><div><br></div><div>2. vrrp数据包解析代码, 密码处理函数, 用到了vrrp数据结构中设置的长度 :&nbsp;</div><div>keepalived/vrrp/vrrp_parser.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >static void</font></div><div><font size="2"   >vrrp_auth_pass_handler(vector_t *strvec)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; vrrp_t *vrrp = LIST_TAIL_DATA(vrrp_data-&gt;vrrp);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char *str = vector_slot(strvec, 1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int max_size = sizeof (vrrp-&gt;auth_data);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int str_len = strlen(str);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (str_len &gt; max_size) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; str_len = max_size;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log_message(LOG_INFO,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Truncating auth_pass to %d characters", max_size);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; memset(vrrp-&gt;auth_data, 0, max_size);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; memcpy(vrrp-&gt;auth_data, str, str_len);</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div><br></div><div>3. 密码长度校验</div><div>keepalived/vrrp/vrrp.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* check the authentication if it is a passwd */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (hd-&gt;auth_type == VRRP_AUTH_PASS) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; char *pw = (char *) ip + ntohs(ip-&gt;tot_len)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - sizeof (vrrp-&gt;auth_data);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (memcmp(pw, vrrp-&gt;auth_data, sizeof(vrrp-&gt;auth_data)) != 0) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log_message(LOG_INFO, "receive an invalid passwd!");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return VRRP_PACKET_KO;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div><div><br></div><div>所以如果需要调整密码长度超过8 , 需要修改2处代码 :&nbsp;</div><div>例如长度修改为16</div><div><span style="line-height: 28px;"   >1. keepalived/include/vrrp.h</span></div><wbr><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >#define VRRP_AUTH_LEN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 16   // 修改1</font></span></div><div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >/* parameters per virtual router -- rfc2338.6.1.2 */</font></div><div style="line-height: 28px;"   ><font size="2"   >typedef struct _vrrp_t {</font></div></div><div style="line-height: 28px;"   ><font size="2"   >....</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Authentication data */</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; auth_type; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* authentification type. VRRP_AUTH_* */</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; uint8_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; auth_data[16]; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* authentification data */  // 修改2</font></div></div><div style="line-height: 28px;"   ><font size="2"   >...</font></div><div style="line-height: 28px;"   ><font size="2"   >} vrrp_t;</font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   >重新编译即可, 注意场景中所有的keepalived都需要重新编译.</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >gmake &amp;&amp; gmake install</font></span></div><div></div><p></p></pre></div><div><span style="line-height: 28px;"   >现在可以设置最长16位的密码了.</span></div><div><span style="line-height: 28px;"   ><br></span></div><div><div style="line-height: 28px;"   >例如两台主机的实例密码验证配置如下 :&nbsp;</div><div style="line-height: 28px;"   ><pre class="prettyprint"   style="line-height: 28px;"   ><p style="line-height: 28px;"   ></p><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; &nbsp; authentication {</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; &nbsp; &nbsp; &nbsp; auth_type PASS</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; &nbsp; &nbsp; &nbsp; auth_pass 1234567890</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; &nbsp; }</font></div></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><br style="line-height: 21px;"   ></font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; &nbsp; authentication {</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; &nbsp; &nbsp; &nbsp; auth_type PASS</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; &nbsp; &nbsp; &nbsp; auth_pass 1234567891</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; &nbsp; }</font></div></div><p style="line-height: 28px;"   ></p></pre></div><div style="line-height: 28px;"   >现在的话会报密码错误了, 需要改成一样的密码才行, 因为变成16位截断了.</div></div><div><span style="line-height: 28px;"   ><br></span></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020147203020835/"   >http://blog.163.com/digoal@126/blog/static/16387704020147203020835/</a></div><div>2.&nbsp;keepalived/include/vrrp.h</div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.ietf.org/rfc/rfc2338.txt"   >http://www.ietf.org/rfc/rfc2338.txt</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="change keepalived max auth password length from 8 to large - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>