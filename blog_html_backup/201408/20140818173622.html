<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">modify array_length, return 0 when array is null</h2>
	<h5 id="">2014-08-18 17:36:22&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201471853114386/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>群里的兄弟问的一个问题, 当使用array_length获取数组长度时, 如果数组为空, 返回值为空.&nbsp;</div><div>因为array_length是internal函数, 所以直接在arrayfuncs.c里面添加的话, 还需要修改catalog(src/include/catalog/pg_proc.h), 并且只有initdb时会调用. 那个不适合生产环境, 建议使用C函数来满足需求.</div><div>如果想要<span style="line-height: 28px;"   >数组为空, 返回长度为0. 可以新增一个函数来满足.&nbsp;</span></div><div><span style="line-height: 28px;"   >如下 :&nbsp;</span></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   ># vi array_length1.c</font></div><div><font size="2"   >#include "postgres.h"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#include &lt;ctype.h&gt;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#include "access/htup_details.h"</font></div><div><font size="2"   >#include "funcapi.h"</font></div><div><font size="2"   >#include "libpq/pqformat.h"</font></div><div><font size="2"   >#include "utils/array.h"</font></div><div><font size="2"   >#include "utils/builtins.h"</font></div><div><font size="2"   >#include "utils/datum.h"</font></div><div><font size="2"   >#include "utils/lsyscache.h"</font></div><div><font size="2"   >#include "utils/memutils.h"</font></div><div><font size="2"   >#include "utils/typcache.h"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >PG_MODULE_MAGIC;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >PG_FUNCTION_INFO_V1(array_length1);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* array_length1 :</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;returns the length, of the dimension requested, for</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;the array pointed to by "v", as an int4</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >Datum</font></div><div><font size="2"   >array_length1(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ArrayType &nbsp;*v = PG_GETARG_ARRAYTYPE_P(0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reqdim = PG_GETARG_INT32(1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*dimv;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result;</font></div><div><font size="2"   >// 添加以下2行</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (ARR_NDIM(v) &lt;= 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_INT32(0);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Sanity check: does it look like an array at all? */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (ARR_NDIM(v) &lt;= 0 || ARR_NDIM(v) &gt; MAXDIM)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Sanity check: was the requested dim valid */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (reqdim &lt;= 0 || reqdim &gt; ARR_NDIM(v))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; dimv = ARR_DIMS(v);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; result = dimv[reqdim - 1];</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_INT32(result);</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@150 soft_bak]# gcc -O3 -Wall -Wextra -Werror -I /opt/soft_bak/postgresql-9.3.5/src/include -g -fPIC -c ./array_length1.c -o array_length1.o</font></div><div><font size="2"   >[root@150 soft_bak]# gcc -O3 -Wall -Wextra -Werror -I /opt/soft_bak/postgresql-9.3.5/src/include -g -shared array_length1.o -o array_length1.so</font></div><div><font size="2"   >[root@150 soft_bak]# cp array_length1.so /opt/pgsql/lib/</font></div></div><p></p></pre></div></div><div><div><br></div><div>测试是否满足需求 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@150 soft_bak]# su - postgres</font></div><div><font size="2"   >postgres@150-&gt; psql</font></div><div><font size="2"   >psql (9.3.5)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# create function array_length1 (anyarray,int) returns int language c as 'array_length1' strict immutable;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >postgres=# select array_length1('{1,2}'::int[],0); &nbsp;-- 维度输入不正确依旧返回空, 如果这个也需要的话, 那么代码修改一下就好了.</font></div><div><font size="2"   >&nbsp;array_length1&nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select array_length1('{1,2}'::int[],1); &nbsp;-- 正常返回长度</font></div><div><font size="2"   >&nbsp;array_length1&nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select array_length1('{}'::int[],1); &nbsp;-- 维度正确时, 返回0.</font></div><div><font size="2"   >&nbsp;array_length1&nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# select array_length1('{}'::int[],2);</font></div><div><font size="2"   >&nbsp;array_length1&nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div></div><div><br></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201302192427651/"   >http://blog.163.com/digoal@126/blog/static/163877040201302192427651/</a></div><div>2.&nbsp;src/backend/utils/adt/arrayfuncs.c</div><div>3.&nbsp;src/include/utils/array.h</div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="modify array_length, return 0 when array is null - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>