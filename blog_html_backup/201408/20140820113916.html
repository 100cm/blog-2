<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">keepalived track script introduce</h2>
	<h5 id="">2014-08-20 11:39:16&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201472010332545/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前面简单的介绍了一下keepalived track script | interface weight &amp; instance priority &amp; election的关系,&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201471992259474/"   >http://blog.163.com/digoal@126/blog/static/163877040201471992259474/</a></div><div>本文将重点介绍一下keepalived跟踪脚本的配置用法以及参数的解释 :&nbsp;</div><div>keepalived VRRP配置中有一个配置项,&nbsp;<span style="line-height: 28px;"   >vrrp_script</span><span style="line-height: 28px;"   >&nbsp;:&nbsp;</span></div><div>截取自 : keepalived.conf.SYNOPSIS</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2.1. VRRP scripts</font></span></div><div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; The configuration block looks like :</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >vrrp_script &lt;STRING&gt; { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# VRRP script declaration</font></div><div><font size="2"   >&nbsp; &nbsp; script &lt;QUOTED_STRING&gt; &nbsp; &nbsp; &nbsp;# script to run periodically</font></div><div><font size="2"   >&nbsp; &nbsp; interval &lt;INTEGER&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# run the script this every seconds</font></div><div><font size="2"   >&nbsp; &nbsp; weight &lt;INTEGER:-254..254&gt; &nbsp;# adjust priority by this weight &nbsp;, 用于动态变更vrrp_instance优先级(by vrrp_update_priority). 或者路由器状态(当weight=0)</font></div><div><font size="2"   >&nbsp; &nbsp; fall &lt;INTEGER&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# required number of failures for KO switch ,&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; rise &lt;INTEGER&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# required number of successes for OK switch</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The script will be executed periodically, every &lt;interval&gt; seconds. Its exit</font></div><div><font size="2"   >code will be recorded for all VRRP instances which will want to monitor it.</font></div><div><font size="2"   >Note that the script will only be executed if at least one VRRP instance</font></div><div><font size="2"   >monitors it with a non-zero weight. Thus, any number of scripts may be</font></div><div><font size="2"   >declared without taking the system down.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >If unspecified, the weight equals 2, which means that a success will add +2</font></div><div><font size="2"   >to the priority of all VRRP instances which monitor it. On the opposite, a</font></div><div><font size="2"   >negative weight will be subtracted from the initial priority in case of</font></div><div><font size="2"   >failure.</font></div></div><p></p></pre></div><div><br></div><div>以上是对脚本的配置, 是否在实例中使用(监控), 需要在相应的<span style="line-height: 28px;"   >vrrp_instance</span><span style="line-height: 28px;"   >&nbsp;</span><span style="line-height: 28px;"   >配置 :&nbsp;</span></div><div><span style="line-height: 28px;"   >这里的weight配置将覆盖vrrp_script中weight的配置.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vrrp_instance &lt;STRING&gt; { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# VRRP instance declaration</font></div><div><div><font size="2"   >&nbsp; &nbsp; track_script { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Scripts state we monitor</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;STRING&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;STRING&gt; weight &lt;INTEGER:-254..254&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; ...</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div></div><div><font size="2"   >}</font></div><p></p></pre></div><div><br></div><div>脚本对应的数据结构 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/* external script we call to track local processes */</font></div><div><font size="2"   >typedef struct _vrrp_script {</font></div><div><font size="2"   ><span>	</span>char<span>			</span>*sname;<span>		</span>/* instance name */</font></div><div><font size="2"   ><span>	</span>char<span>			</span>*script;<span>	</span>/* the command to be called */</font></div><div><font size="2"   ><span>	</span>long<span>			</span>interval;<span>	</span>/* interval between script calls */</font></div><div><font size="2"   ><span>	</span>long<span>			</span>timeout;<span>	</span>/* seconds before script timeout */</font></div><div><font size="2"   ><span>	</span>int<span>			</span>weight;<span>		</span>/* weight associated to this script */</font></div><div><font size="2"   ><span>	</span>int<span>			</span>result;<span>		</span>/* result of last call to this script: 0..R-1 = KO, R..R+F-1 = OK */</font></div><div><font size="2"   ><span>	</span>int<span>			</span>inuse;<span>		</span>/* how many users have weight&gt;0 ? */ &nbsp; </font></div><div><font size="2"   ><span>	</span>int<span>			</span>rise;<span>		</span>/* R: how many successes before OK */ &nbsp;</font></div><div><font size="2"   ><span>	</span>int<span>			</span>fall;<span>		</span>/* F: how many failures before KO */</font></div><div><font size="2"   >} vrrp_script_t;</font></div><p></p></pre></div><div>注意当配置的weight不等于0时, 用于动态调整vrrp instance的优先级. 并不会直接的改变vrrp的状态.</div><div>当weight=0时, 用于变更vrrp_instance的状态例如脚本检测失败, 则vrrp的状态直接变为FAULT. (不管有没有其他节点存在来接管MASTER)</div><div><br></div><div>只有脚本的weight配置不等于0时才需要被跟踪(用于跟踪result, 判断ko和ok状态). &nbsp;跟踪脚本对应的数据结构 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/* Tracked script structure definition */</font></div><div><font size="2"   >typedef struct _tracked_sc {</font></div><div><font size="2"   ><span>	</span>int<span>			</span>weight;<span>		</span>/* tracking weight when non-zero */</font></div><div><font size="2"   ><span>	</span>vrrp_script_t<span>		</span>*scr;<span>		</span>/* script pointer, cannot be NULL */</font></div><div><font size="2"   >} tracked_sc_t;</font></div><p></p></pre></div><div><br></div><div>脚本一旦配置在vrrp instance中启用,&nbsp;</div><div>在调用过程中, 就会动态的改变对应的instance的优先级. (when weight&lt;&gt;0)</div><div>或者变更vrrp instance的状态 (when weight=0)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vrrp_script &lt;STRING&gt; { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# VRRP script declaration</font></div><div><font size="2"   >&nbsp; &nbsp; script &lt;QUOTED_STRING&gt; &nbsp; &nbsp; &nbsp;# script to run periodically</font></div><div><font size="2"   >&nbsp; &nbsp; interval &lt;INTEGER&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# run the script this every seconds</font></div><div><font size="2"   >&nbsp; &nbsp; weight &lt;INTEGER:-254..254&gt; &nbsp;# adjust priority by this weight &nbsp;, 不等于0时用于动态变更vrrp_instance优先级(by vrrp_update_priority).</font></div><div><font size="2"   >&nbsp; &nbsp; fall &lt;INTEGER&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# required number of failures for KO switch ,&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; rise &lt;INTEGER&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# required number of successes for OK switch</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>当脚本为OK状态时, 并且最终weight(以track_script中的weight覆盖值为准)&gt;0, 则优先级可以加上weight.</div><div>当脚本为KO状态时, 并且终止的weight<span style="line-height: 28px;"   >(以track_script中的weight覆盖值为准)&lt;0, 则优先级可以减去weight.</span></div><div><span style="line-height: 28px;"   >优先级最终的范围是(1到254)</span></div><div><span style="line-height: 28px;"   >OK和KO和fall, rise的配置有关. 不要关注状态, 就关注这两个值, 因为没有地方标记状态.</span></div><div><span style="line-height: 28px;"   >通过标记与变更脚本的result值, 通过result值和fall, rise来比较, 判断OK还是KO.</span></div><div>脚本状态的转换过程详细参考 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vrrp_script_child_thread 函数</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (WIFEXITED(wait_status)) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int status;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status = WEXITSTATUS(wait_status); &nbsp;// 脚本返回值为0, 表示执行成功, 非0表示失败.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (status == 0) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* success */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (vscript-&gt;result &lt; vscript-&gt;rise - 1) { &nbsp;// result &lt; rise-1, 表示当前还是KO状态</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vscript-&gt;result++; &nbsp; // KO状态下, 调用成功则result+1.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (vscript-&gt;result &lt; vscript-&gt;rise) &nbsp;// result = rise 表示当前是KO状态转变成OK状态</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log_message(LOG_INFO, "VRRP_Script(%s) succeeded", vscript-&gt;sname);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vscript-&gt;result = vscript-&gt;rise + vscript-&gt;fall - 1; &nbsp;// 脚本从failed状态转变到success状态后, 直接把result改成最大. 要变回KO的话, 还需要fall-1次failure.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* failure */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (vscript-&gt;result &gt; vscript-&gt;rise) { &nbsp;// result &gt; rise, 表示当前是OK状态</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vscript-&gt;result--; &nbsp;//OK状态下, 脚本调用失败的话, result-1.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (vscript-&gt;result &gt;= vscript-&gt;rise) &nbsp;// result=rise, 表示当前是OK状态转变成KO状态</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log_message(LOG_INFO, "VRRP_Script(%s) failed", vscript-&gt;sname);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vscript-&gt;result = 0; &nbsp;// 脚本从success状态转变到failed状态后, 直接把result改到最小.&nbsp;要变回OK的话还需要rise次success</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   >优先级的变动和脚本状态的关系参考 :&nbsp;</span></div><div><span style="line-height: 28px;"   >注意一个脚本对全局weigh的影响只有一次, 例如多次OK状态也最大加一次正的weight.</span></div><div>或者多次KO状态下, 最多也只加一次负的weight.</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >vrrp_script_weight 函数</font></span></div><div><div><font size="2"   ><span>	</span>for (e = LIST_HEAD(l); e; ELEMENT_NEXT(e)) {</font></div><div><font size="2"   ><span>		</span>tsc = ELEMENT_DATA(e);</font></div><div><font size="2"   ><span>		</span>if (tsc-&gt;scr-&gt;result == VRRP_SCRIPT_STATUS_DISABLED)</font></div><div><font size="2"   ><span>			</span>continue;</font></div><div><font size="2"   ><span>		</span>if (tsc-&gt;scr-&gt;result &gt;= tsc-&gt;scr-&gt;rise) { &nbsp; &nbsp; // 当脚本的result&gt;=配置的rise时(即OK态), 如果脚本配置的weight&gt;0 , 那么全局weight累加脚本weight.</font></div><div><font size="2"   ><span>			</span>if (tsc-&gt;weight &gt; 0)</font></div><div><font size="2"   ><span>				</span>weight += tsc-&gt;weight;</font></div><div><font size="2"   ><span>		</span>} else if (tsc-&gt;scr-&gt;result &lt; tsc-&gt;scr-&gt;rise) { &nbsp;// 当脚本的result&lt;配置的rise时(即KO态), 如果脚本配置的weight&lt;0, 那么全局weight减去脚本的weight. &nbsp;脚本的result在vrrp_script_child_thread中跟踪.</font></div><div><font size="2"   ><span>			</span>if (tsc-&gt;weight &lt; 0)</font></div><div><font size="2"   ><span>				</span>weight += tsc-&gt;weight;</font></div><div><font size="2"   ><span>		</span>}</font></div><div><font size="2"   ><span>	</span>}</font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   >动态调整优先级的范围 :&nbsp;</span></div><div>如果配置的instance的初始优先级是255的话, 则不受track weight的影响. 见vrrp_update_priority函数的内容.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   ><span>	</span>if (vrrp-&gt;base_priority == VRRP_PRIO_OWNER) {</font></div><div><font size="2"   ><span>		</span>/* we will not run a PRIO_OWNER into a non-PRIO_OWNER */</font></div><div><font size="2"   ><span>		</span>vrrp-&gt;effective_priority = VRRP_PRIO_OWNER;</font></div><div><font size="2"   ><span>	</span>} else {</font></div><div><font size="2"   ><span>		</span>/* WARNING! we must compute new_prio on a signed int in order</font></div><div><font size="2"   ><span>		</span> &nbsp; to detect overflows and avoid wrapping. */</font></div><div><font size="2"   ><span>		</span>new_prio = vrrp-&gt;base_priority + prio_offset;</font></div><div><font size="2"   ><span>		</span>if (new_prio &lt; 1)</font></div><div><font size="2"   ><span>			</span>new_prio = 1;</font></div><div><font size="2"   ><span>		</span>else if (new_prio &gt; 254)</font></div><div><font size="2"   ><span>			</span>new_prio = 254;</font></div><div><font size="2"   ><span>		</span>vrrp-&gt;effective_priority = new_prio;</font></div><div><font size="2"   ><span>	</span>}</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >keepalived / include / vrrp.h</font></div><div><font size="2"   >#define VRRP_PRIO_OWNER<span>		</span>255<span>		</span>/* priority of the ip owner -- rfc2338.5.3.4 */</font></div></div><p></p></pre></div><div><div>换句话说, 只有初始优先级配置&lt;255的instance, 才可以动态调整优先级. 并且动态调整后的优先级范围是1到254.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; &nbsp; priority &lt;INTEGER-0..255&gt;<span>		</span># VRRP PRIO</font></div></div><div></div><p></p></pre></div></div><div>[参考]</div><div>1. keepalived/vrrp/vrrp_scheduler.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/* if run after vrrp_init_state(), it will be able to detect scripts that</font></div><div><font size="2"   >&nbsp;* have been disabled because of a sync group and will avoid to start them.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static void</font></div><div><font size="2"   >vrrp_init_script(list l)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; vrrp_script_t *vscript;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; element e;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; for (e = LIST_HEAD(l); e; ELEMENT_NEXT(e)) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vscript = ELEMENT_DATA(e);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (vscript-&gt;inuse == 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vscript-&gt;result = VRRP_SCRIPT_STATUS_DISABLED;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (vscript-&gt;result == VRRP_SCRIPT_STATUS_INIT) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vscript-&gt;result = vscript-&gt;rise - 1; /* one success is enough */  // 初始化过程中设置result=rise-1 </font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; thread_add_event(master, vrrp_script_thread, vscript, vscript-&gt;interval);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else if (vscript-&gt;result == VRRP_SCRIPT_STATUS_INIT_GOOD) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vscript-&gt;result = vscript-&gt;rise; /* one failure is enough */   // 初始化成功, 设置result=rise</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; thread_add_event(master, vrrp_script_thread, vscript, vscript-&gt;interval);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >static int</font></div><div><font size="2"   >vrrp_script_child_thread(thread_t * thread)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int wait_status;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; vrrp_script_t *vscript = THREAD_ARG(thread);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (thread-&gt;type == THREAD_CHILD_TIMEOUT) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pid_t pid;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pid = THREAD_CHILD_PID(thread);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* The child hasn't responded. Kill it off. */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (vscript-&gt;result &gt; vscript-&gt;rise) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vscript-&gt;result--;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (vscript-&gt;result == vscript-&gt;rise)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log_message(LOG_INFO, "VRRP_Script(%s) timed out", vscript-&gt;sname);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vscript-&gt;result = 0;    // 初始化时, 脚本调用超时, 将result改成0(最小)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kill(pid, SIGTERM);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; thread_add_child(thread-&gt;master, vrrp_script_child_timeout_thread,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;vscript, pid, 2);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; wait_status = THREAD_CHILD_STATUS(thread);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (WIFEXITED(wait_status)) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int status;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status = WEXITSTATUS(wait_status);  // 脚本返回值为0, 表示执行成功, 非0表示失败.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (status == 0) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* success */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (vscript-&gt;result &lt; vscript-&gt;rise - 1) {  // result &lt; rise-1, 表示当前还是KO状态</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vscript-&gt;result++;   // KO状态下, 调用成功则result+1.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else { </font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (vscript-&gt;result &lt; vscript-&gt;rise)  // result = rise 表示当前是KO状态转变成OK状态</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log_message(LOG_INFO, "VRRP_Script(%s) succeeded", vscript-&gt;sname);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vscript-&gt;result = vscript-&gt;rise + vscript-&gt;fall - 1;  // 脚本从failed状态转变到success状态后, 直接把result改成最大.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* failure */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (vscript-&gt;result &gt; vscript-&gt;rise) {  // result &gt; rise, 表示当前是OK状态</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vscript-&gt;result--;  //OK状态下, 脚本调用失败的话, result-1.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (vscript-&gt;result &gt;= vscript-&gt;rise)  // result=rise, 表示当前是OK状态转变成KO状态</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log_message(LOG_INFO, "VRRP_Script(%s) failed", vscript-&gt;sname);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vscript-&gt;result = 0;  // 脚本从success状态转变到failed状态后, 直接把result改到最小</font><span style="line-height: 21px; font-size: small; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, 宋体;"   >. </span></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return 0;</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >/* Update VRRP effective priority based on multiple checkers.</font></div><div><font size="2"   >&nbsp;* This is a thread which is executed every adver_int.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static int</font></div><div><font size="2"   >vrrp_update_priority(thread_t * thread)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; vrrp_t *vrrp = THREAD_ARG(thread);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int prio_offset, new_prio;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* compute prio_offset right here */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; prio_offset = 0;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Now we will sum the weights of all interfaces which are tracked. */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if ((!vrrp-&gt;sync || vrrp-&gt;sync-&gt;global_tracking) &amp;&amp; !LIST_ISEMPTY(vrrp-&gt;track_ifp))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;prio_offset += vrrp_tracked_weight(vrrp-&gt;track_ifp);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Now we will sum the weights of all scripts which are tracked. */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if ((!vrrp-&gt;sync || vrrp-&gt;sync-&gt;global_tracking) &amp;&amp; !LIST_ISEMPTY(vrrp-&gt;track_script))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prio_offset += vrrp_script_weight(vrrp-&gt;track_script);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (vrrp-&gt;base_priority == VRRP_PRIO_OWNER) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* we will not run a PRIO_OWNER into a non-PRIO_OWNER */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vrrp-&gt;effective_priority = VRRP_PRIO_OWNER;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; } else {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* WARNING! we must compute new_prio on a signed int in order</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;to detect overflows and avoid wrapping. */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_prio = vrrp-&gt;base_priority + prio_offset;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (new_prio &lt; 1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_prio = 1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (new_prio &gt; 254)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_prio = 254;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vrrp-&gt;effective_priority = new_prio;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Register next priority update thread */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; thread_add_timer(master, vrrp_update_priority, vrrp, vrrp-&gt;adver_int);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return 0;</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div><br></div><div>2. keepalived/include/vrrp_track.h</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/* VRRP script tracking results.</font></div><div><font size="2"   >&nbsp;* The result is an integer between 0 and rise-1 to indicate a DOWN state,</font></div><div><font size="2"   >&nbsp;* or between rise-1 and rise+fall-1 to indicate an UP state. Upon failure,</font></div><div><font size="2"   >&nbsp;* we decrease result and set it to zero when we pass below rise. Upon</font></div><div><font size="2"   >&nbsp;* success, we increase result and set it to rise+fall-1 when we pass above</font></div><div><font size="2"   >&nbsp;* rise-1.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >#define VRRP_SCRIPT_STATUS_DISABLED &nbsp;-3</font></div><div><font size="2"   >#define VRRP_SCRIPT_STATUS_INIT_GOOD -2</font></div><div><font size="2"   >#define VRRP_SCRIPT_STATUS_INIT &nbsp; &nbsp; &nbsp;-1</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >/* external script we call to track local processes */</font></div><div><font size="2"   >typedef struct _vrrp_script {</font></div><div><font size="2"   >	char			*sname;		/* instance name */</font></div><div><font size="2"   >	char			*script;	/* the command to be called */</font></div><div><font size="2"   >	long			interval;	/* interval between script calls */</font></div><div><font size="2"   >	long			timeout;	/* seconds before script timeout */</font></div><div><font size="2"   >	int			weight;		/* weight associated to this script */</font></div><div><font size="2"   >	int			result;		/* result of last call to this script: 0..R-1 = KO, R..R+F-1 = OK */</font></div><div><font size="2"   >	int			inuse;		/* how many users have weight&gt;0 ? */</font></div><div><font size="2"   >	int			rise;		/* R: how many successes before OK */</font></div><div><font size="2"   >	int			fall;		/* F: how many failures before KO */</font></div><div><font size="2"   >} vrrp_script_t;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >/* Tracked script structure definition */</font></div><div><font size="2"   >typedef struct _tracked_sc {</font></div><div><font size="2"   >	int			weight;		/* tracking weight when non-zero */</font></div><div><font size="2"   >	vrrp_script_t		*scr;		/* script pointer, cannot be NULL */</font></div><div><font size="2"   >} tracked_sc_t;</font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201471992259474/"   >http://blog.163.com/digoal@126/blog/static/163877040201471992259474/</a></div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="keepalived track script introduce - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>