<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">MonetDB usage</h2>
	<h5 id="">2014-08-13 17:48:54&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020147135859247/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>MonetDB的安装参考 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020147138518796/"   >http://blog.163.com/digoal@126/blog/static/16387704020147138518796/</a></div><div>MonetDB的性能让我眼前一亮, 对比PostgreSQL, 某些查询远超PG.</div><div>下面看看MonetDB简单的使用.</div><div>首先是使用monetdbd初始化一个dbfarm. 生成配置文件.merovingian_properties</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@176 ~]# monetdbd create /data01/mdb2</font></div><div><font size="2"   >[root@176 ~]# ll -la /data01/mdb2</font></div><div><font size="2"   ><span style="line-height: 21px;"   >.merovingian_properties</span></font></div><p></p></pre></div><div>现在目录中只有一个配置文件, 在启动monetdbd前, 需要设置一下监听, 因为本地如果启用了多个monetdbd的话, 端口会冲突的.</div><div>首先获得当前创建的dbfarm的配置文件内容, 注意配置文件只能通过monetdbd来set.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># cat .merovingian_properties</font></div><div><font size="2"   ># DO NOT EDIT THIS FILE - use monetdb(1) and monetdbd(1) to set properties</font></div><div><font size="2"   ># This file is used by monetdbd</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >control=false</font></div><p></p></pre></div><div>获得配置文件 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@176 ~]# monetdbd get all /data01/mdb2</font></div><div><font size="2"   >&nbsp; &nbsp;property &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;value</font></div><div><font size="2"   >hostname &nbsp; &nbsp; &nbsp; &nbsp; 176.sky-mobi.com</font></div><div><font size="2"   >dbfarm &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /data01/mdb2</font></div><div><font size="2"   >status &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; no monetdbd is serving this dbfarm</font></div><div><font size="2"   >mserver &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unknown (monetdbd not running)</font></div><div><font size="2"   >logfile &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/data01/mdb2/merovingian.log</font></div><div><font size="2"   >pidfile &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/data01/mdb2/merovingian.pid</font></div><div><font size="2"   >sockdir &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/tmp</font></div><div><font size="2"   >port &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 50000</font></div><div><font size="2"   >exittimeout &nbsp; &nbsp; &nbsp;60</font></div><div><font size="2"   >forward &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;proxy</font></div><div><font size="2"   >discovery &nbsp; &nbsp; &nbsp; &nbsp;true</font></div><div><font size="2"   >discoveryttl &nbsp; &nbsp; 600</font></div><div><font size="2"   >control &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;no</font></div><div><font size="2"   >passphrase &nbsp; &nbsp; &nbsp; &lt;unknown&gt;</font></div><div><font size="2"   >mapisock &nbsp; &nbsp; &nbsp; &nbsp; /tmp/.s.monetdb.50000</font></div><div><font size="2"   >controlsock &nbsp; &nbsp; &nbsp;/tmp/.s.merovingian.50000</font></div><p></p></pre></div><div>设置属性, 一般设置监听端口即可, unix socket视情况修改.&nbsp;</div><div><div>[root@176 ~]# monetdbd set port=50001 /data01/mdb2</div></div><div>如果要通过monetdb远程控制它的话, 还需要设置passphrase和control, 注意测试一下passphrase, 好像超过4个字母会有问题</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@176 ~]# monetdbd set passphrase=1Digo /data01/mdb2</font></div><div><font size="2"   >[root@176 mdb2]# monetdbd set control=yes /data01/mdb2</font></div><div><div><font size="2"   >[root@176 mdb2]# monetdbd get all /data01/mdb2</font></div><div><font size="2"   >&nbsp; &nbsp;property &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;value</font></div><div><font size="2"   >hostname &nbsp; &nbsp; &nbsp; &nbsp; 176.sky-mobi.com</font></div><div><font size="2"   >dbfarm &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /data01/mdb2</font></div><div><font size="2"   >status &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; monetdbd[23923] 1.7 (Jan2014-SP3) is serving this dbfarm</font></div><div><font size="2"   >mserver &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/opt/monetdb11.17.21/bin/mserver5</font></div><div><font size="2"   >logfile &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/data01/mdb2/merovingian.log</font></div><div><font size="2"   >pidfile &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/data01/mdb2/merovingian.pid</font></div><div><font size="2"   >sockdir &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/tmp</font></div><div><font size="2"   >port &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 50001</font></div><div><font size="2"   >exittimeout &nbsp; &nbsp; &nbsp;60</font></div><div><font size="2"   >forward &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;proxy</font></div><div><font size="2"   >discovery &nbsp; &nbsp; &nbsp; &nbsp;yes</font></div><div><font size="2"   >discoveryttl &nbsp; &nbsp; 600</font></div><div><font size="2"   >control &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;yes</font></div><div><font size="2"   >passphrase &nbsp; &nbsp; &nbsp; {SHA512}d9343d4c860655ac2e815666f08d50750c58c974c05debe205aa243c0654706fa60f858fbcbd239f878777ee25f6558cd9e2af917e73ae00760a3aa522c52725</font></div><div><font size="2"   >mapisock &nbsp; &nbsp; &nbsp; &nbsp; /tmp/.s.monetdb.50001</font></div><div><font size="2"   >controlsock &nbsp; &nbsp; &nbsp;/tmp/.s.merovingian.50001</font></div></div><p></p></pre></div><div><br></div><div>启动monetdbd</div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@176 ~]# monetdbd start /data01/mdb2</font></div><div><div></div></div><p></p></pre><div><span style="line-height: 28px;"   >现在可以看到监听了, 目录下多了日志和PID文件.</span></div><div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@176 ~]# netstat -anp|grep 50001</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:50001 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;23923/monetdbd &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >udp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:50001 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 23923/monetdbd &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >unix &nbsp;2 &nbsp; &nbsp; &nbsp;[ ACC ] &nbsp; &nbsp; STREAM &nbsp; &nbsp; LISTENING &nbsp; &nbsp; 1036931 23923/monetdbd &nbsp; &nbsp; &nbsp;/tmp/.s.monetdb.50001</font></div><div><font size="2"   >unix &nbsp;2 &nbsp; &nbsp; &nbsp;[ ACC ] &nbsp; &nbsp; STREAM &nbsp; &nbsp; LISTENING &nbsp; &nbsp; 1036935 23923/monetdbd &nbsp; &nbsp; &nbsp;/tmp/.s.merovingian.50001</font></div><div><font size="2"   >[root@176 ~]# ll /data01/mdb2/</font></div><div><font size="2"   >total 2</font></div><div><font size="2"   >-rw------- 1 root root 666 Aug 13 17:13 merovingian.log</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; 6 Aug 13 17:13 merovingian.pid</font></div></div><div><div><font size="2"   >[root@176 ~]# ps -efw|grep monet</font></div><div><font size="2"   >root &nbsp; &nbsp; 24361 &nbsp; &nbsp; 1 &nbsp;0 17:30 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 monetdbd start /data01/mdb2</font></div><div><font size="2"   >root &nbsp; &nbsp; 24436 24361 &nbsp;6 17:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:46 /opt/monetdb11.17.21/bin/mserver5 --dbpath=/data01/mdb2/test --set merovingian_uri mapi:monetdb://176.sky-mobi.com:50001/test --set mapi_open false --set mapi_port 0 --set mapi_usock /data01/mdb2/test/.mapi.sock --set monet_vault_key /data01/mdb2/test/.vaultkey --set gdk_nr_threads 8 --set max_clients 64 --set sql_optimizer default_pipe --set monet_daemon yes</font></div></div><p></p></pre></div></div><div><div><br></div></div><div>接下来要使用monetdb连接这个monetdbd来创建数据库.</div><div>测试passphrase是否正常.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@176 mdb2]# monetdb -h 127.0.0.1 -p 50001 -P 1Digo discover</font></div><div><font size="2"   >discover: =OK</font></div><p></p></pre></div><div>创建1个数据库, 数据库创建的时候处于维护状态, 也就是LOCK状态, 必须release后才可以读写.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@176 mdb2]# monetdb -p 50001 create test</font></div><div><font size="2"   >created database in maintenance mode: test</font></div><div><font size="2"   >[root@176 mdb2]# monetdb -p 50001 release test</font></div><div><font size="2"   >taken database out of maintenance mode: test</font></div><p></p></pre></div><div>获得当前集群的配置信息,例如允许的线程数, 客户端连接数等.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@176 mdb2]# monetdb -p 50001 get all</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;prop &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; value</font></div><div><font size="2"   >test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp;test</font></div><div><font size="2"   >test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type &nbsp; &nbsp; &nbsp;default &nbsp;database</font></div><div><font size="2"   >test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shared &nbsp; &nbsp;default &nbsp;yes</font></div><div><font size="2"   >test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nthreads &nbsp;default &nbsp;8</font></div><div><font size="2"   >test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; optpipe &nbsp; default &nbsp;default_pipe</font></div><div><font size="2"   >test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; readonly &nbsp;default &nbsp;no</font></div><div><font size="2"   >test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nclients &nbsp;default &nbsp;64</font></div><p></p></pre></div><div>查看monetdbd状态</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@176 mdb2]# monetdb -p 50001 status -l</font></div><div><font size="2"   >test:</font></div><div><font size="2"   >&nbsp; connection uri: mapi:monetdb://176.sky-mobi.com:50001/test</font></div><div><font size="2"   >&nbsp; database name: test</font></div><div><font size="2"   >&nbsp; state: crashed</font></div><div><font size="2"   >&nbsp; locked: no</font></div><div><font size="2"   >&nbsp; scenarios: (none)</font></div><div><font size="2"   >&nbsp; start count: 0</font></div><div><font size="2"   >&nbsp; stop count: 0</font></div><div><font size="2"   >&nbsp; crash count: 0</font></div><div><font size="2"   >&nbsp; average uptime: 0s</font></div><div><font size="2"   >&nbsp; maximum uptime: 0s</font></div><div><font size="2"   >&nbsp; minimum uptime: 0s</font></div><div><font size="2"   >&nbsp; last start with crash: (unknown)</font></div><div><font size="2"   >&nbsp; last start: 1970-01-01 08:00:00</font></div><div><font size="2"   >&nbsp; last stop: (unknown)</font></div><div><font size="2"   >&nbsp; average of crashes in the last start attempt: 0</font></div><div><font size="2"   >&nbsp; average of crashes in the last 10 start attempts: 0.00</font></div><div><font size="2"   >&nbsp; average of crashes in the last 30 start attempts: 0.00</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@176 mdb2]# monetdb -p 50001 status -c</font></div><div><font size="2"   >database test, crashed on 1970-01-01 07:59:59</font></div><div><font size="2"   >&nbsp; crash average: 0.00 0.00 0.00 (over 1, 15, 30 starts) in total 0 crashes</font></div><div><font size="2"   >&nbsp; uptime stats (min/avg/max): 0s/0s/0s over 0 runs</font></div><p></p></pre></div></div><div><br></div><div>使用mclient连接到刚才创建的数据库, 现在需要用到默认的用户密码monetdb.</div><div>mclient的参数详见man mclient, 例如编码, 语言, 时区等.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@176 mdb2]# mclient -p 50001 test &nbsp;</font></div><div><font size="2"   >user(root):monetdb</font></div><div><font size="2"   >password: 输入monetdb</font></div><div><font size="2"   >Welcome to mclient, the MonetDB/SQL interactive terminal (Jan2014-SP3)</font></div><div><font size="2"   >Database: MonetDB v11.17.21 (Jan2014-SP3), 'mapi:monetdb://176.sky-mobi.com:50001/test'</font></div><div><font size="2"   >Type \q to quit, \? for a list of available commands</font></div><div><font size="2"   >auto commit mode: on</font></div><p></p></pre></div><div>查看帮助</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >sql&gt;\?</font></div><div><font size="2"   >\? &nbsp; &nbsp; &nbsp;- show this message</font></div><div><font size="2"   >\&lt;file &nbsp;- read input from file</font></div><div><font size="2"   >\&gt;file &nbsp;- save response in file, or stdout if no file is given</font></div><div><font size="2"   >\|cmd &nbsp; - pipe result to process, or stop when no command is given</font></div><div><font size="2"   >\h &nbsp; &nbsp; &nbsp;- show the readline history</font></div><div><font size="2"   >\D table- dumps the table, or the complete database if none given.</font></div><div><font size="2"   >\d[Stvsfn]+ [obj] - list database objects, or describe if obj given</font></div><div><font size="2"   >\A &nbsp; &nbsp; &nbsp;- enable auto commit</font></div><div><font size="2"   >\a &nbsp; &nbsp; &nbsp;- disable auto commit</font></div><div><font size="2"   >\e &nbsp; &nbsp; &nbsp;- echo the query in sql formatting mode</font></div><div><font size="2"   >\f &nbsp; &nbsp; &nbsp;- format using a built-in renderer {csv,tab,raw,sql,xml}</font></div><div><font size="2"   >\w# &nbsp; &nbsp; - set maximal page width (-1=unlimited, 0=terminal width, &gt;0=limit to num)</font></div><div><font size="2"   >\r# &nbsp; &nbsp; - set maximum rows per page (-1=raw)</font></div><div><font size="2"   >\L file - save client/server interaction</font></div><div><font size="2"   >\X &nbsp; &nbsp; &nbsp;- trace mclient code</font></div><div><font size="2"   >\q &nbsp; &nbsp; &nbsp;- terminate session</font></div><p></p></pre></div><div>查看系统表</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >sql&gt;\dSt</font></div><div><font size="2"   >SYSTEM TABLE &nbsp;sys._columns</font></div><div><font size="2"   >SYSTEM TABLE &nbsp;sys._tables</font></div><div><font size="2"   >SYSTEM TABLE &nbsp;sys.args</font></div><div><font size="2"   >SYSTEM TABLE &nbsp;sys.auths</font></div><div><font size="2"   >SYSTEM TABLE &nbsp;sys.connections</font></div><div><font size="2"   >SYSTEM TABLE &nbsp;sys.db_user_info</font></div><div><font size="2"   >SYSTEM TABLE &nbsp;sys.dependencies</font></div><div><font size="2"   >SYSTEM TABLE &nbsp;sys.functions</font></div><div><font size="2"   >SYSTEM TABLE &nbsp;sys.idxs</font></div><div><font size="2"   >SYSTEM TABLE &nbsp;sys.keys</font></div><div><font size="2"   >SYSTEM TABLE &nbsp;sys.objects</font></div><div><font size="2"   >SYSTEM TABLE &nbsp;sys.privileges</font></div><div><font size="2"   >SYSTEM TABLE &nbsp;sys.schemas</font></div><div><font size="2"   >SYSTEM TABLE &nbsp;sys.sequences</font></div><div><font size="2"   >SYSTEM TABLE &nbsp;sys.statistics</font></div><div><font size="2"   >SYSTEM TABLE &nbsp;sys.storagemodelinput</font></div><div><font size="2"   >SYSTEM TABLE &nbsp;sys.systemfunctions</font></div><div><font size="2"   >SYSTEM TABLE &nbsp;sys.triggers</font></div><div><font size="2"   >SYSTEM TABLE &nbsp;sys.types</font></div><div><font size="2"   >SYSTEM TABLE &nbsp;sys.user_role</font></div><p></p></pre></div><div>创建表, 插入测试数据</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >sql&gt;create table a(id int auto_increment primary key, info varchar(32));</font></div><div><font size="2"   >operation successful (16.583ms)</font></div><div><font size="2"   >sql&gt;insert into a (info) values ('test');</font></div><div><font size="2"   >1 affected rows, last generated key: 1 (7.604ms)</font></div></div><div><font size="2"   >sql&gt;insert into a (info) select info from a;</font></div><p></p></pre></div><div>多次执行, 再创建一个b表.</div><div>测试count和关联. 速度非常快.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >sql&gt;select count(*) from a;</font></div><div><font size="2"   >+----------+</font></div><div><font size="2"   >| L1 &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >+==========+</font></div><div><font size="2"   >| 33554432 |</font></div><div><font size="2"   >+----------+</font></div><div><font size="2"   >1 tuple (1.446ms)</font></div><div><font size="2"   >sql&gt;select count(*) from b;</font></div><div><font size="2"   >+----------+</font></div><div><font size="2"   >| L1 &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >+==========+</font></div><div><font size="2"   >| 33554432 |</font></div><div><font size="2"   >+----------+</font></div><div><font size="2"   >1 tuple (1.938ms)</font></div><div><font size="2"   >sql&gt;select count(*) from b,a where a.id=b.id;</font></div><div><font size="2"   >+----------+</font></div><div><font size="2"   >| L1 &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >+==========+</font></div><div><font size="2"   >| 33554432 |</font></div><div><font size="2"   >+----------+</font></div><div><font size="2"   >1 tuple (18.6s)</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >[参考]</span></div><wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://www.monetdb.org/Documentation"   >https://www.monetdb.org/Documentation</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://www.monetdb.org/Documentation/Extensions"   >https://www.monetdb.org/Documentation/Extensions</a></div><div>3. man monetdbd mclient monetdb</div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="MonetDB usage - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>