<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">keepalived vrrp script|interface weight when positive,nagtive,zero & vrrp's status transition</h2>
	<h5 id="">2014-08-20 16:57:14&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020147203020835/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>本文以实例的形式来展示一下脚本的weight对vrrp的影响(状态或优先级).</div><div>注意优先级的变化可能导致vrrp master重新选举, 从而导致状态的变化.</div><div>而直接导致状态的变化则是当script weight=0时, 可以直接导致状态的变化.(当然最后还是选举产生的, 除非backup配置了不降级, 那么就不会主动让位.)</div><div>首先来看一张图 :&nbsp;</div><div><div><div><div><img title="keepalived vrrp script weight when positive,nagtive,zero  vrrps status transition - 德哥@Digoal - PostgreSQL research"   alt="keepalived vrrp script weight when positive,nagtive,zero  vrrps status transition - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/6LFgg7NtojaEQUuXIbu3KQ==/6619275503490689613.png"   ></div></div></div>这张图表明了track interface或track script的weight在大于0, 小于0, 等于0这三种状态下, 对VRRP的影响.</div><div>(track interface的原理和本文将要讲的track script是一样的, 只是检测的是接口)</div><div>weight&gt;0 : 检查成功, 优先级加, 检查失败, 回归基本优先级.</div><div>weight=0<span style="line-height: 28px;"   >&nbsp;</span><span style="line-height: 28px;"   >: 检查成功, 状态不变, 检查失败, 状态变为FAULT, 再次检查成功, 状态回到初始状态, 可能会需要重新选举master. (能不能选为master就看是否符合vrrp的协定了, 当然还与backup是否配置允许降级有关)&nbsp;</span></div><div>weight&lt;0 :&nbsp;<span style="line-height: 28px;"   >检查成功, 优先级不变, 检查失败, 需要降低优先级, 再次检查成功, 回归正常优先级.</span></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >[注意]</span></div><div><span style="line-height: 28px;"   >初始优先级是255的话, 不受weight的动态优先级调整影响. 原因见 :&nbsp;</span></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020147212529175/"   >http://blog.163.com/digoal@126/blog/static/16387704020147212529175/</a></div><div><br></div><div>测试环境 :&nbsp;</div><div>192.168.173.203</div><div><span style="line-height: 28px;"   >192.168.173.204</span></div><div>虚拟IP, 因为只是测试, 我用了一个其他网段的IP.</div><div>172.16.173.100</div><div><br></div><div>keepalived的安装参考</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020147199133921/"   >http://blog.163.com/digoal@126/blog/static/16387704020147199133921/</a></div><div><br></div><div>vrrp script, 创建3个脚本, 分别用于weight配置为正, 负, 零 :&nbsp;</div><div>脚本返回值0表示成功, 非零表示失败, 我们通过改变文件内容来改变脚本的返回值.</div><div>例如pos.sh返回的是/root/pos.var的值. 默认我们都配置为0.&nbsp;</div><div>在测试keepalived的过程中只要修改pos.var, 就可以改变pos.sh脚本的返回值.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi /root/pos.sh</font></div><div><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   >res=$(cat /root/pos.var)</font></div><div><font size="2"   >exit $res</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >vi&nbsp;<span style="line-height: 28px;"   >/root/pos.var</span></font></div><div><span style="line-height: 28px;"   ><font size="2"   >0</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   ><br></font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >chmod 500 /root/pos.sh</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   ><br></font></span></div><div><div style="line-height: 28px;"   ><font size="2"   >vi /root/nag.sh</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >#!/bin/bash</font></div><div style="line-height: 28px;"   ><font size="2"   >res=$(cat /root/nag.var)</font></div><div style="line-height: 28px;"   ><font size="2"   >exit $res</font></div></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >vi&nbsp;<span style="line-height: 28px;"   >/root/nag.var</span></font></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >0</font></span></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></span></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >chmod 500 /root/nag.sh</font></span></div></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   ><br></font></span></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >vi /root/zero.sh</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >#!/bin/bash</font></div><div style="line-height: 28px;"   ><font size="2"   >res=$(cat /root/zero.var)</font></div><div style="line-height: 28px;"   ><font size="2"   >exit $res</font></div></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >vi&nbsp;<span style="line-height: 28px;"   >/root/zero.var</span></font></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >0</font></span></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></span></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >chmod 500 /root/zero.sh</font></span></div></div><p></p></pre></div><div><br></div><div>配置文件内容 :&nbsp;</div><div>2个节点唯一不同的配置是优先级<span style="line-height: 28px;"   >priority</span><span style="line-height: 28px;"   >&nbsp;. 一高一低即可.</span></div><div><span style="line-height: 28px;"   >192.168.173.203: 100</span></div><div><span style="line-height: 28px;"   >192.168.173.204: 99</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@192_168_173_204 ~]# cd /opt/keepalived/etc/keepalived/</font></div><div><font size="2"   >[root@192_168_173_204 keepalived]# cat keepalived.conf</font></div><div><font size="2"   >! Configuration File for keepalived &nbsp;!号或#号开头为注释</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >global_defs { &nbsp; &nbsp; &nbsp;# 全局配置除了router_id, 其他都无所谓, 因为我这里的测试只是观察script weight对vrrp的影响.</font></div><div><font size="2"   >&nbsp; &nbsp;notification_email {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;acassen@firewall.loc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;failover@firewall.loc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;sysadmin@firewall.loc</font></div><div><font size="2"   >&nbsp; &nbsp;}</font></div><div><font size="2"   >&nbsp; &nbsp;notification_email_from Alexandre.Cassen@firewall.loc</font></div><div><font size="2"   >&nbsp; &nbsp;smtp_server 192.168.200.1</font></div><div><font size="2"   >&nbsp; &nbsp;smtp_connect_timeout 30</font></div><div><font size="2"   >&nbsp; &nbsp;router_id DIGOAL_TEST &nbsp; # 两个节点一致</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >vrrp_script pos { &nbsp; # 脚本配置&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; script "/root/pos.sh"</font></div><div><font size="2"   >&nbsp; &nbsp; interval 1</font></div><div><font size="2"   >&nbsp; &nbsp; weight 0 &nbsp; # 配置默认weight 0, 后面可以在instance中覆盖</font></div><div><font size="2"   >&nbsp; &nbsp; fall 1 &nbsp; &nbsp;# 从OK到KO需要1次检测失败.</font></div><div><font size="2"   >&nbsp; &nbsp; rise 1 &nbsp; &nbsp;# 从KO到OK需要1次检测成功.</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><div style="line-height: 28px;"   ><font size="2"   >vrrp_script nag { &nbsp; # 脚本配置&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; script "/root/nag.sh"</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; interval 1</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; weight 0 &nbsp; # 配置默认weight 0, 后面可以在instance中覆盖</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; fall 1 &nbsp; &nbsp;# 从OK到KO需要1次检测失败.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; rise 1 &nbsp; &nbsp;# 从KO到OK需要1次检测成功.</font></div><div style="line-height: 28px;"   ><font size="2"   >}</font></div></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >vrrp_script zero { &nbsp; # 脚本配置&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; script "/root/zero.sh"</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; interval 1</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; weight 0 &nbsp; # 配置默认weight 0, 后面可以在instance中覆盖</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; fall 1 &nbsp; &nbsp;# 从OK到KO需要1次检测失败.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; rise 1 &nbsp; &nbsp;# 从KO到OK需要1次检测成功.</font></div><div style="line-height: 28px;"   ><font size="2"   >}</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >vrrp_instance vi_1 {</font></div><div><font size="2"   >&nbsp; &nbsp; state MASTER &nbsp; &nbsp;# 初始状态</font></div><div><font size="2"   >&nbsp; &nbsp; interface eth0</font></div><div><font size="2"   >&nbsp; &nbsp; virtual_router_id 51</font></div><div><font size="2"   >&nbsp; &nbsp; priority 99 &nbsp; # 初始优先级, 注意两个节点配置要不一样. 一高一低, 高的选举为master.</font></div><div><font size="2"   >&nbsp; &nbsp; advert_int 1</font></div><div><font size="2"   >&nbsp; &nbsp; authentication {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; auth_type PASS</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; auth_pass 1111</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; track_script {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; pos weight 3</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; zero weight 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; nag weight -5</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; unicast_peer { &nbsp; # 使用多播代替组播发送vrrp心跳.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 192.168.173.203</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 192.168.173.204</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; virtual_ipaddress { &nbsp; # 虚拟地址配置, 和ifconfig兼容</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 172.16.173.100/24 brd 172.16.173.255 dev eth0 scope link label eth0:1</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; debug &nbsp; # 打开debug, 方便调试, 本例没有用到</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>启动keepalived, -D打开详细日志.</div><div>我们先启动优先级低的节点, 这样可以观察到选举master的过程.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@192_168_173_204 ~]# keepalived -f /opt/keepalived/etc/keepalived/keepalived.conf -D</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >查看日志</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/var/log/messages</font></div><div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived[5920]: Starting Keepalived v1.2.13 (08/19,2014)</font></div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived[5921]: Starting Healthcheck child process, pid=5922</font></div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived[5921]: Starting VRRP child process, pid=5923</font></div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived_vrrp[5923]: Netlink reflector reports IP 192.168.173.204 added</font></div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived_vrrp[5923]: Netlink reflector reports IP fe80::f6ce:46ff:fe85:15fc added</font></div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived_vrrp[5923]: Registering Kernel netlink reflector</font></div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived_healthcheckers[5922]: Netlink reflector reports IP 192.168.173.204 added</font></div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived_vrrp[5923]: Registering Kernel netlink command channel</font></div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived_vrrp[5923]: Registering gratuitous ARP shared channel</font></div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived_healthcheckers[5922]: Netlink reflector reports IP fe80::f6ce:46ff:fe85:15fc added</font></div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived_healthcheckers[5922]: Registering Kernel netlink reflector</font></div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived_healthcheckers[5922]: Registering Kernel netlink command channel</font></div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived_healthcheckers[5922]: Opening file '/opt/keepalived/etc/keepalived/keepalived.conf'.</font></div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived_vrrp[5923]: Opening file '/opt/keepalived/etc/keepalived/keepalived.conf'.</font></div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived_healthcheckers[5922]: Configuration is using : 7935 Bytes</font></div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived_vrrp[5923]: Configuration is using : 69309 Bytes</font></div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived_vrrp[5923]: Using LinkWatch kernel netlink reflector...</font></div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived_vrrp[5923]: VRRP sockpool: [ifindex(2), proto(112), unicast(1), fd(10,11)]</font></div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived_healthcheckers[5922]: Using LinkWatch kernel netlink reflector...</font></div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Script(pos) succeeded</font></div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Script(zero) succeeded</font></div><div><font size="2"   >Aug 20 16:32:43 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Script(nag) succeeded</font></div><div><font size="2"   >Aug 20 16:32:44 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Transition to MASTER STATE</font></div><div><font size="2"   >Aug 20 16:32:45 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Entering MASTER STATE</font></div><div><font size="2"   >Aug 20 16:32:45 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) setting protocol VIPs.</font></div><div><font size="2"   >Aug 20 16:32:45 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Sending gratuitous ARPs on eth0 for 172.16.173.100</font></div><div><font size="2"   >Aug 20 16:32:45 192_168_173_204 Keepalived_healthcheckers[5922]: Netlink reflector reports IP 172.16.173.100 added</font></div><div><font size="2"   >Aug 20 16:32:50 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Sending gratuitous ARPs on eth0 for 172.16.173.100</font></div></div><p></p></pre></div><div>通过ifconfig可以看到虚拟IP已经起来了</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >eth0:1 &nbsp; &nbsp;Link encap:Ethernet &nbsp;HWaddr F4:CE:46:85:15:FC &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:172.16.173.100 &nbsp;Bcast:172.16.173.255 &nbsp;Mask:255.255.255.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><p></p></pre></div><div><br></div><div>简单的说一下日志, 可以看出keepalived进程结构分成3个部分, 主进程以及两个fork出来的子进程.</div><div>vrrp复制路由主节点的选举, vrrp心跳.</div><div>healthcheckers负责检测, 例如vrrp script和vrrp interface(本例没有配置vrrp interface check).</div><div>虚拟ip起来后, 发送了免费的ARP请求, 宣告IP和MAC地址.</div><div>现在, 192.168.173.204的优先级是99+3=102</div><div>好了, 现在启动<span style="line-height: 28px;"   >192.168.173.203的keepalived.</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@192_168_173_203 ~]# keepalived -f /opt/keepalived/etc/keepalived/keepalived.conf -D</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >查看日志</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived[23107]: Starting Keepalived v1.2.13 (08/19,2014)</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived[23108]: Starting Healthcheck child process, pid=23109</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived[23108]: Starting VRRP child process, pid=23110</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived_healthcheckers[23109]: Netlink reflector reports IP 192.168.173.203 added</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived_vrrp[23110]: Netlink reflector reports IP 192.168.173.203 added</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived_healthcheckers[23109]: Netlink reflector reports IP 192.168.173.156 added</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived_vrrp[23110]: Netlink reflector reports IP 192.168.173.156 added</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived_healthcheckers[23109]: Netlink reflector reports IP fe80::f6ce:46ff:fe86:4234 added</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived_vrrp[23110]: Netlink reflector reports IP fe80::f6ce:46ff:fe86:4234 added</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived_healthcheckers[23109]: Registering Kernel netlink reflector</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived_vrrp[23110]: Registering Kernel netlink reflector</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived_healthcheckers[23109]: Registering Kernel netlink command channel</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived_vrrp[23110]: Registering Kernel netlink command channel</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived_vrrp[23110]: Registering gratuitous ARP shared channel</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived_healthcheckers[23109]: Opening file '/opt/keepalived/etc/keepalived/keepalived.conf'.</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived_vrrp[23110]: Opening file '/opt/keepalived/etc/keepalived/keepalived.conf'.</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived_healthcheckers[23109]: Configuration is using : 7937 Bytes</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived_vrrp[23110]: Configuration is using : 69311 Bytes</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived_vrrp[23110]: Using LinkWatch kernel netlink reflector...</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived_vrrp[23110]: VRRP sockpool: [ifindex(2), proto(112), unicast(1), fd(10,11)]</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived_healthcheckers[23109]: Using LinkWatch kernel netlink reflector...</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Script(nag) succeeded</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Script(zero) succeeded</font></div><div><font size="2"   >Aug 20 16:38:28 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Script(pos) succeeded</font></div><p></p></pre></div><div>初始设置为MASTER, 所以有选举的过程, 但是刚起来的时候脚本还没开始检查, 优先级是100, 所以选举中变成了backup角色.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Aug 20 16:38:29 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) Transition to MASTER STATE</font></div><div><font size="2"   >Aug 20 16:38:29 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) Received higher prio advert</font></div><div><font size="2"   >Aug 20 16:38:29 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) Entering BACKUP STATE</font></div><p></p></pre></div><div>当开始检查脚本后, 优先级提高到了100+3=103, 大于192.168.173.204的102, 所以选举中变成了MASTER.</div><div>同时虚拟IP切换到了本节点</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Aug 20 16:38:30 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) forcing a new MASTER election</font></div><div><font size="2"   >Aug 20 16:38:30 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) forcing a new MASTER election</font></div><div><font size="2"   >Aug 20 16:38:31 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) Transition to MASTER STATE</font></div><div><font size="2"   >Aug 20 16:38:32 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) Entering MASTER STATE</font></div><div><font size="2"   >Aug 20 16:38:32 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) setting protocol VIPs.</font></div><div><font size="2"   >Aug 20 16:38:32 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) Sending gratuitous ARPs on eth0 for 172.16.173.100</font></div><div><font size="2"   >Aug 20 16:38:32 192_168_173_203 Keepalived_healthcheckers[23109]: Netlink reflector reports IP 172.16.173.100 added</font></div><div><span style="line-height: 28px;"   ><font size="2"   >Aug 20 16:38:37 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) Sending gratuitous ARPs on eth0 for 172.16.173.100</font></span></div><p></p></pre></div></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >查看192.168.173.204节点的日志, 选举为BACKUP后, 移除了虚拟IP.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Aug 20 16:38:08 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Transition to MASTER STATE</font></div><div><font size="2"   >Aug 20 16:38:09 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Entering MASTER STATE</font></div><div><font size="2"   >Aug 20 16:38:09 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) setting protocol VIPs.</font></div><div><font size="2"   >Aug 20 16:38:09 192_168_173_204 Keepalived_healthcheckers[5922]: Netlink reflector reports IP 172.16.173.100 added</font></div><div><font size="2"   >Aug 20 16:38:09 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Sending gratuitous ARPs on eth0 for 172.16.173.100</font></div><div><font size="2"   >Aug 20 16:38:14 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Sending gratuitous ARPs on eth0 for 172.16.173.100</font></div><div><font size="2"   >Aug 20 16:38:29 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Received lower prio advert, forcing new election</font></div><div><font size="2"   >Aug 20 16:38:29 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Sending gratuitous ARPs on eth0 for 172.16.173.100</font></div><div><font size="2"   >Aug 20 16:38:29 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Received lower prio advert, forcing new election</font></div><div><font size="2"   >Aug 20 16:38:29 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Sending gratuitous ARPs on eth0 for 172.16.173.100</font></div><div><font size="2"   >Aug 20 16:38:30 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Received higher prio advert</font></div><div><font size="2"   >Aug 20 16:38:30 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Entering BACKUP STATE</font></div><div><font size="2"   >Aug 20 16:38:30 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) removing protocol VIPs.</font></div><div><font size="2"   >Aug 20 16:38:30 192_168_173_204 Keepalived_healthcheckers[5922]: Netlink reflector reports IP 172.16.173.100 removed</font></div><p></p></pre></div><div><br></div><div>现在我们把192.168.173.203的pos.var改成1, 那么将降回初始优先级100. 比192.168.173.204的优先级102要低.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@192_168_173_203 ~]# echo 1 &gt; /root/pos.var</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >我们在192.168.173.204节点可以看到它重新选举变成了MASTER</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Aug 20 16:44:43 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) forcing a new MASTER election</font></div><div><font size="2"   >Aug 20 16:44:43 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) forcing a new MASTER election</font></div><div><font size="2"   >Aug 20 16:44:44 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Transition to MASTER STATE</font></div><div><font size="2"   >Aug 20 16:44:45 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Entering MASTER STATE</font></div><div><font size="2"   >Aug 20 16:44:45 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) setting protocol VIPs.</font></div><div><font size="2"   >Aug 20 16:44:45 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Sending gratuitous ARPs on eth0 for 172.16.173.100</font></div><div><font size="2"   >Aug 20 16:44:45 192_168_173_204 Keepalived_healthcheckers[5922]: Netlink reflector reports IP 172.16.173.100 added</font></div><div><font size="2"   >Aug 20 16:44:50 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Sending gratuitous ARPs on eth0 for 172.16.173.100</font></div><p></p></pre></div><div><br></div><div>接下来在192.168.173.204测试一下nag.sh脚本, 把nag.var改成1. 那么nag.sh将返回1, 也就是失败. 优先级需要减5. 变成102-5=97, vrrp重新选举的话, 变成BACKUP.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@192_168_173_204 ~]# echo 1 &gt; /root/nag.var&nbsp;</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >我们在192.168.173.203上可以看到它选举变成了master.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Aug 20 16:48:04 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) forcing a new MASTER election</font></div><div><font size="2"   >Aug 20 16:48:04 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) forcing a new MASTER election</font></div><div><font size="2"   >Aug 20 16:48:05 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) Transition to MASTER STATE</font></div><div><font size="2"   >Aug 20 16:48:06 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) Entering MASTER STATE</font></div><div><font size="2"   >Aug 20 16:48:06 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) setting protocol VIPs.</font></div><div><font size="2"   >Aug 20 16:48:06 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) Sending gratuitous ARPs on eth0 for 172.16.173.100</font></div><div><font size="2"   >Aug 20 16:48:06 192_168_173_203 Keepalived_healthcheckers[23109]: Netlink reflector reports IP 172.16.173.100 added</font></div><div><font size="2"   >Aug 20 16:48:11 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) Sending gratuitous ARPs on eth0 for 172.16.173.100</font></div><p></p></pre></div><div><br></div><div>现在的优先级构成如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >192.168.173.203  MASTER</font></div><div><font size="2"   >base=100</font></div><div><font size="2"   >pos.sh failed &nbsp;+0</font></div><div><font size="2"   >zero.sh success</font></div><div><font size="2"   >nag.sh success &nbsp;-0</font></div><div><font size="2"   >最终优先级: 100</font></div><div><font size="2"   ><br></font></div><div><span style="line-height: 28px;"   ><font size="2"   >192.168.173.204  BACKUP</font></span></div><div><div style="line-height: 28px;"   ><font size="2"   >base=99</font></div><div style="line-height: 28px;"   ><font size="2"   >pos.sh success &nbsp;+ 3</font></div><div style="line-height: 28px;"   ><font size="2"   >zero.sh success</font></div><div style="line-height: 28px;"   ><font size="2"   >nag.sh failed &nbsp;-5</font></div><div style="line-height: 28px;"   ><font size="2"   >最终优先级: 97</font></div></div><p></p></pre></div><div>接下来把192.168.173.203的nag.sh弄成failed, 那么将再次减5, 变成95. 选举将变成BACKUP.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@192_168_173_203 ~]# echo 1 &gt; /root/nag.var</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >可以看到192.168.173.204变成MASTER了.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Aug 20 16:52:29 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) forcing a new MASTER election</font></div><div><font size="2"   >Aug 20 16:52:29 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) forcing a new MASTER election</font></div><div><font size="2"   >Aug 20 16:52:30 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Transition to MASTER STATE</font></div><div><font size="2"   >Aug 20 16:52:31 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Entering MASTER STATE</font></div><div><font size="2"   >Aug 20 16:52:31 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) setting protocol VIPs.</font></div><div><font size="2"   >Aug 20 16:52:31 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Sending gratuitous ARPs on eth0 for 172.16.173.100</font></div><div><font size="2"   >Aug 20 16:52:31 192_168_173_204 Keepalived_healthcheckers[5922]: Netlink reflector reports IP 172.16.173.100 added</font></div><p></p></pre></div><div><br></div><div>最后测试一下zero脚本对状态的影响, 前面我们看到的nag.sh和pos.sh都只改变优先级, 不会直接对状态造成影响, 而是在选举的过程中简介的对状态造成的影响.</div><div>zero脚本的weight=0, 所以脚本调用的成功与否直接影响vrrp instance的状态</div><div>测试 :&nbsp;</div><div>把192.168.173.204的zero.var改成1,&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@192_168_173_204 ~]# echo 1 &gt;/root/zero.var&nbsp;</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >查看日志 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Aug 20 16:54:49 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Script(zero) failed</font></div><div><font size="2"   >Aug 20 16:54:50 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Entering FAULT STATE</font></div><div><font size="2"   >Aug 20 16:54:50 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) removing protocol VIPs.</font></div><div><font size="2"   >Aug 20 16:54:50 192_168_173_204 Keepalived_healthcheckers[5922]: Netlink reflector reports IP 172.16.173.100 removed</font></div><div><font size="2"   >Aug 20 16:54:50 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Now in FAULT state</font></div><p></p></pre></div><div>192.168.173.203变成了唯一的状态正常的主机, 所以理所当然就是MASTER了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Aug 20 16:54:50 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) Transition to MASTER STATE</font></div><div><font size="2"   >Aug 20 16:54:51 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) Entering MASTER STATE</font></div><div><font size="2"   >Aug 20 16:54:51 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) setting protocol VIPs.</font></div><div><font size="2"   >Aug 20 16:54:51 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) Sending gratuitous ARPs on eth0 for 172.16.173.100</font></div><div><font size="2"   >Aug 20 16:54:51 192_168_173_203 Keepalived_healthcheckers[23109]: Netlink reflector reports IP 172.16.173.100 added</font></div><div><span style="line-height: 28px;"   ><font size="2"   >Aug 20 16:54:56 192_168_173_203 Keepalived_vrrp[23110]: VRRP_Instance(vi_1) Sending gratuitous ARPs on eth0 for 172.16.173.100</font></span></div><p></p></pre></div><div>最后, 把zero.var改回0, 观察状态回到配置的初始状态. 并重新选举.</div><div>[root@192_168_173_204 ~]# echo 0 &gt;/root/zero.var</div><div>重新选举的过程中依然是先使用初始优先级进行选举, 状态定了以后, 再检查脚本, 动态的改变优先级.</div><div>本例192.168.173.204的初始优先级是99, 大于当前192.168.173.203的优先级95, 所以初始优先级就可以当选MASTER.</div><div>等检测开始后, 优先级变成99+3-5=97, 依然<span style="line-height: 28px;"   >大于当前192.168.173.203的优先级95, 所以继续MASTER.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Aug 20 17:02:05 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Script(zero) succeeded</font></div><div><font size="2"   >Aug 20 17:02:06 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) prio is higher than received advert</font></div><div><font size="2"   >Aug 20 17:02:06 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Transition to MASTER STATE</font></div><div><font size="2"   >Aug 20 17:02:06 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Received lower prio advert, forcing new election</font></div><div><font size="2"   >Aug 20 17:02:07 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Entering MASTER STATE</font></div><div><font size="2"   >Aug 20 17:02:07 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) setting protocol VIPs.</font></div><div><font size="2"   >Aug 20 17:02:07 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Sending gratuitous ARPs on eth0 for 172.16.173.100</font></div><div><font size="2"   >Aug 20 17:02:07 192_168_173_204 Keepalived_healthcheckers[5922]: Netlink reflector reports IP 172.16.173.100 added</font></div><div><font size="2"   >Aug 20 17:02:12 192_168_173_204 Keepalived_vrrp[5923]: VRRP_Instance(vi_1) Sending gratuitous ARPs on eth0 for 172.16.173.100</font></div><p></p></pre></div><div><br></div>[参考]<div>1.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020147199133921/"   >http://blog.163.com/digoal@126/blog/static/16387704020147199133921/</a><br><wbr><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201472010332545/"   >http://blog.163.com/digoal@126/blog/static/163877040201472010332545/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201471992259474/"   >http://blog.163.com/digoal@126/blog/static/163877040201471992259474/</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="keepalived vrrp script weight when positive,nagtive,zero  vrrps status transition - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a><br></div></div>
	</div>
</div>
</body>
</html>