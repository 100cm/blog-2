<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">GlusterFS cann't active in oVirt because gluster's brick directory & subd's permission problem not vdsm.kvm 755</h2>
	<h5 id="">2014-08-08 9:40:16&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020147883536498/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>今天在ovirt中使用glusterfs时, 发现一点问题, gfs deactive后就无法激活了, 查看日志.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/var/log/ovirt-engine/engine.log</font></div><div><div><font size="2"   >2014-08-08 08:26:09,087 ERROR [org.ovirt.engine.core.bll.storage.GLUSTERFSStorageHelper] (org.ovirt.thread.pool-6-thread-50) [d59bd20] The connection with details 172.16.3.150:/gfs1 failed because of error code 469 and error message is: permission settings on the specified path do not allow access to the storage.</font></div><div><font size="2"   >verify permission settings on the specified storage path.</font></div><div><font size="2"   >2014-08-08 08:26:09,091 ERROR [org.ovirt.engine.core.bll.storage.ConnectStorageToVdsCommand] (org.ovirt.thread.pool-6-thread-50) [d59bd20] Transaction rolled-back for command: org.ovirt.engine.core.bll.storage.ConnectStorageToVdsCommand.</font></div><div><font size="2"   >2014-08-08 08:26:09,092 INFO &nbsp;[org.ovirt.engine.core.vdsbroker.irsbroker.ActivateStorageDomainVDSCommand] (org.ovirt.thread.pool-6-thread-46) [2edf4d01] START, ActivateStorageDomainVDSCommand( storagePoolId = 00000002-0002-0002-0002-0000000000ec, ignoreFailoverLimit = false, storageDomainId = 8f6f0ec3-2183-48cd-9ec4-aface2540629), log id: 3a874700</font></div><div><font size="2"   >2014-08-08 08:26:09,179 ERROR [org.ovirt.engine.core.vdsbroker.irsbroker.ActivateStorageDomainVDSCommand] (org.ovirt.thread.pool-6-thread-46) [2edf4d01] Failed in ActivateStorageDomainVDS method</font></div><div><font size="2"   >2014-08-08 08:26:09,180 ERROR [org.ovirt.engine.core.vdsbroker.irsbroker.IrsBrokerCommand] (org.ovirt.thread.pool-6-thread-46) [2edf4d01] IrsBroker::Failed::ActivateStorageDomainVDS due to: IRSErrorException: IRSGenericException: IRSErrorException: Failed to ActivateStorageDomainVDS, error = Storage domain does not exist: ('8f6f0ec3-2183-48cd-9ec4-aface2540629',), code = 358</font></div></div><p></p></pre></div><div>问题出在权限上面.</div><div>查看brick的目录权限, 两个brick节点的权限都变成了root:root. 600.</div><div><span style="line-height: 28px;"   ><font size="2"   >drw------- &nbsp;4 root root &nbsp; &nbsp; &nbsp; 4096 Aug &nbsp;6 17:03 gfs_b1</font></span></div><div>而oVirt要求的目录是vdsm:kvm的, 不管是NFS还是GlusterFS. 都需要这样的owner和group.</div><div>查看&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://wiki.ovirt.org/Features/GlusterFS_Storage_Domain"   >http://wiki.ovirt.org/Features/GlusterFS_Storage_Domain</a></div><div>指出, 使用GlusterFS, 必须修改volume的权限.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Important Pre-requisites</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >If the GlusterFS volume is created using oVirt's GlusterFS GUI, then don't forget to click on "Optimize for virt. store" which helps set the right permissions and enables the optimum GlusterFS translators for virtualization usecase</font></div><div><font size="2"   >If the GlusterFS volume was created manually, then ensure the below options are set on the volume, so that its accessible from oVirt</font></div><div><font size="2"   >volume set &lt;volname&gt; storage.owner-uid=36</font></div><div><font size="2"   >volume set &lt;volname&gt; storage.owner-gid=36</font></div><div><font size="2"   >The below settings/options of GlusterFS volume must also be enabled for it to be able to work as a oVirt storage domain. Currently its not possible to set these from oVirt GlusterFS GUI</font></div><div><font size="2"   >option rpc-auth-allow-insecure on ==&gt; in glusterd.vol (ensure u restart glusterd service... for this to take effect)</font></div><div><font size="2"   >volume set &lt;volname&gt; server.allow-insecure on ==&gt; (ensure u stop and start the volume.. for this to take effect)</font></div><div><font size="2"   >Other packages that are needed on the hypervisor host (aka VDSM host) are...</font></div><div><font size="2"   >Needs minm libvirt version 1.0.1 (which has the gluster protocol/network disk support)</font></div><div><font size="2"   >Needs qemu version 1.3 (which has the gluster block backend support)</font></div><div><font size="2"   >Needs vdsm-gluster plugin, which pulls in all the related requirements (glusterfs, etc)</font></div><p></p></pre></div><div>修改gid, uid和server.allow-insecure.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@40 data01]# id vdsm</font></div><div><font size="2"   >uid=36(vdsm) gid=36(kvm) groups=36(kvm),179(sanlock),107(qemu)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@150 data01]# gluster</font></div><div><font size="2"   >gluster&gt; volume set gfs1 server.allow-insecure on</font></div></div><div><div><font size="2"   >gluster&gt; volume set gfs1 storage.owner-uid 36</font></div><div><font size="2"   >volume set: success</font></div><div><font size="2"   >gluster&gt; volume set gfs1 storage.owner-gid 36</font></div><div><font size="2"   >volume set: success</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >gluster&gt; volume info</font></div><div><font size="2"   >&nbsp;未修改的卷:</font></div><div><font size="2"   >Volume Name: sv1</font></div><div><font size="2"   >Type: Stripe</font></div><div><font size="2"   >Volume ID: eb236299-8344-4dde-bc51-36ad34594511</font></div><div><font size="2"   >Status: Started</font></div><div><font size="2"   >Number of Bricks: 1 x 2 = 2</font></div><div><font size="2"   >Transport-type: tcp</font></div><div><font size="2"   >Bricks:</font></div><div><font size="2"   >Brick1: 172.16.3.150:/data01/gfs2</font></div><div><font size="2"   >Brick2: 172.16.3.40:/data01/gfs2</font></div><div><font size="2"   >&nbsp;修改过的卷:</font></div><div><font size="2"   >Volume Name: gfs1</font></div><div><font size="2"   >Type: Replicate</font></div><div><font size="2"   >Volume ID: 1318eb16-6984-4ee3-baa0-c13cd26424ae</font></div><div><font size="2"   >Status: Started</font></div><div><font size="2"   >Number of Bricks: 1 x 2 = 2</font></div><div><font size="2"   >Transport-type: tcp</font></div><div><font size="2"   >Bricks:</font></div><div><font size="2"   >Brick1: 172.16.3.150:/data01/gfs_b1</font></div><div><font size="2"   >Brick2: 172.16.3.40:/data01/gfs_b1</font></div><div><font size="2"   >Options Reconfigured:</font></div><div><font size="2"   >server.allow-insecure: on</font></div><div><font size="2"   >storage.owner-gid: 36</font></div><div><font size="2"   >storage.owner-uid: 36</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >gluster&gt; volume status gfs1 detail</font></div><div><font size="2"   >Status of volume: gfs1</font></div><div><font size="2"   >------------------------------------------------------------------------------</font></div><div><font size="2"   >Brick &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: Brick 172.16.3.150:/data01/gfs_b1</font></div><div><font size="2"   >Port &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 49152 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >Online &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : Y &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >Pid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 2116 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >File System &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: ext4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >Device &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : /dev/sdb1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >Mount Options &nbsp; &nbsp; &nbsp; &nbsp;: rw,noatime,nodiratime,nobarrier</font></div><div><font size="2"   >Inode Size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 256 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >Disk Space Free &nbsp; &nbsp; &nbsp;: 173.9GB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >Total Disk Space &nbsp; &nbsp; : 182.8GB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >Inode Count &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 12173312 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >Free Inodes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 12173067 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------</font></div><div><font size="2"   >Brick &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: Brick 172.16.3.40:/data01/gfs_b1</font></div><div><font size="2"   >Port &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 49152 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >Online &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : Y &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >Pid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 6246 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >File System &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: ext4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >Device &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : /dev/mapper/360026b902fd4120014d4569d05d0d581</font></div><div><font size="2"   >Mount Options &nbsp; &nbsp; &nbsp; &nbsp;: rw,noatime,nodiratime,nobarrier</font></div><div><font size="2"   >Inode Size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 256 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >Disk Space Free &nbsp; &nbsp; &nbsp;: 131.8GB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >Total Disk Space &nbsp; &nbsp; : 134.0GB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >Inode Count &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 8921088 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >Free Inodes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 8920953</font></div></div><p></p></pre></div><div><br></div><div>修改所有 brick 目录的mod</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >on 40 exec # chmod -R 755 /data01/gfs_b1</font></div><div><font size="2"   ><span style="line-height: 28px;"   >on 150 exec #</span><span style="line-height: 28px;"   >&nbsp;</span><span style="line-height: 28px;"   >chmod -R 755 /data01/gfs_b1</span></font></div><p></p></pre></div><div><br></div><div>现在可以正常的激活GlusterFS domain了.</div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >[参考]</div><div style="line-height: 28px;"   >1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://blog.gluster.org/category/glusterfs-openstack-cinder/"   >http://blog.gluster.org/category/glusterfs-openstack-cinder/</a></div><div style="line-height: 28px;"   >2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://wiki.ovirt.org/Features/GlusterFS_Storage_Domain"   >http://wiki.ovirt.org/Features/GlusterFS_Storage_Domain</a></div><div style="line-height: 28px;"   >3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.middleswarth.net/2012/07/04/installing-ovirt-3-1-and-glusterfs-using-either-nfs-or-posix-native-file-system/"   >http://www.middleswarth.net/2012/07/04/installing-ovirt-3-1-and-glusterfs-using-either-nfs-or-posix-native-file-system/</a></div><div style="line-height: 28px;"   ><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="GlusterFS cannt active in oVirt because glusters brick directory  subds permission problem not vdsm.kvm 755 - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>