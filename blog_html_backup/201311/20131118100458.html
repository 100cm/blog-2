<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap examples, DISK IO - 3 Track Cumulative IO</h2>
	<h5 id="">2013-11-18 10:04:58&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013101885114320/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><span style="line-height: 28px;"   >例子来自</span><span style="line-height: 28px;"   >traceio.stp</span><span style="line-height: 28px;"   >&nbsp;脚本, 该脚本通过事件vfs.read.return和vfs.write.return统计进程的累计读写调用情况. 输出读写前10的进程信息以及累计的读, 写的字节数信息.</span></div><div><span style="line-height: 28px;"   >注意原始的例子中没有对devname做过滤, 所以读写包含了cache的操作, 也没有对return值是否大于0做过滤.</span></div><div>我稍微修改了一下, 增加了对return大于0的过滤, 如果读者有兴趣过滤cache, 可以再增加devname的过滤.</div><div>修改后的脚本内容以及注解 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 network]# cd /usr/share/systemtap/testsuite/systemtap.examples/io</font></div><div><font size="2"   >[root@db-172-16-3-150 io]# cat traceio.stp&nbsp;</font></div><div><div><font size="2"   >#!/usr/bin/stap</font></div><div><font size="2"   ># traceio.stp</font></div><div><font size="2"   ># Copyright (C) 2007 Red Hat, Inc., Eugene Teo &lt;eteo@redhat.com&gt;</font></div><div><font size="2"   ># Copyright (C) 2009 Kai Meyer &lt;kai@unixlords.com&gt;</font></div><div><font size="2"   ># &nbsp; Fixed a bug that allows this to run longer</font></div><div><font size="2"   ># &nbsp; And added the humanreadable function</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># This program is free software; you can redistribute it and/or modify</font></div><div><font size="2"   ># it under the terms of the GNU General Public License version 2 as</font></div><div><font size="2"   ># published by the Free Software Foundation.</font></div><div><font size="2"   >#</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >global reads, writes, total_io</font></div><div><font size="2"   >// reads 进程读字节数</font></div><div><font size="2"   >// writes 进程写字节数</font></div><div><font size="2"   >// total_io 进程读写字节数</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe vfs.read.return {</font></div><div><font size="2"   >&nbsp; if ($return &gt; 0) {</font></div><div><font size="2"   >&nbsp; &nbsp; reads[pid(),execname()] += $return</font></div><div><font size="2"   >&nbsp; &nbsp; total_io[pid(),execname()] += $return</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >}</font></div><div><font size="2"   >// 读者可以使用devname != "N/A"过滤cache.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe vfs.write.return {</font></div><div><font size="2"   >&nbsp; if ($return &gt; 0) {</font></div><div><font size="2"   >&nbsp; &nbsp; writes[pid(),execname()] += $return</font></div><div><font size="2"   >&nbsp; &nbsp; total_io[pid(),execname()] += $return</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >}</font></div><div><span style="line-height: 28px;"   ><font size="2"   >// 读者可以使用devname != "N/A"过滤cache.</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   ><br></font></span></div><div><font size="2"   >function humanreadable(bytes) {</font></div><div><font size="2"   >&nbsp; if (bytes &gt; 1024*1024*1024) {</font></div><div><font size="2"   >&nbsp; &nbsp; return sprintf("%d GiB", bytes/1024/1024/1024)</font></div><div><font size="2"   >&nbsp; } else if (bytes &gt; 1024*1024) {</font></div><div><font size="2"   >&nbsp; &nbsp; return sprintf("%d MiB", bytes/1024/1024)</font></div><div><font size="2"   >&nbsp; } else if (bytes &gt; 1024) {</font></div><div><font size="2"   >&nbsp; &nbsp; return sprintf("%d KiB", bytes/1024)</font></div><div><font size="2"   >&nbsp; } else {</font></div><div><font size="2"   >&nbsp; &nbsp; return sprintf("%d &nbsp; B", bytes)</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >}</font></div><div><font size="2"   >//&nbsp;<span style="line-height: 28px;"   >humanreadable函数把字节数转换成更可读的字符串.</span></font></div><div><span style="line-height: 28px;"   ><font size="2"   >// 但是请注意, 因为systemtap只支持整形, 转换后的精度不高.</font></span></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe timer.s(1) {</font></div><div><font size="2"   >&nbsp; foreach([p,e] in total_io- limit 10) &nbsp;// 按照读写字节数倒序输出前10读写最大的进程的读, 写信息.</font></div><div><font size="2"   >&nbsp; &nbsp; printf("%8d %15s r: %12s w: %12s\n",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;p, e, humanreadable(reads[p,e]),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;humanreadable(writes[p,e]))</font></div><div><font size="2"   >&nbsp; printf("\n")</font></div><div><font size="2"   >&nbsp; # Note we don't zero out reads, writes and total_io,</font></div><div><font size="2"   >&nbsp; # so the values are cumulative since the script started.</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   >// 每秒输出一次</font></div><p></p></pre></div><div><br></div><div>执行输出举例 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 io]# stap traceio.stp&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;10992 &nbsp; &nbsp; &nbsp; &nbsp;postgres r: &nbsp; &nbsp; &nbsp;116 &nbsp; B w: &nbsp; &nbsp; &nbsp; &nbsp;9 MiB</font></div><div><font size="2"   >&nbsp; &nbsp; 5804 &nbsp; &nbsp; &nbsp; &nbsp;postgres r: &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; B w: &nbsp; &nbsp; &nbsp;472 KiB</font></div><div><font size="2"   >&nbsp; &nbsp;10991 &nbsp; &nbsp; &nbsp; &nbsp;postgres r: &nbsp; &nbsp; &nbsp; 14 &nbsp; B w: &nbsp; &nbsp; &nbsp; 14 &nbsp; B</font></div><div><font size="2"   >&nbsp; &nbsp; 5820 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;stapio r: &nbsp; &nbsp; &nbsp; 12 &nbsp; B w: &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; B</font></div><div><font size="2"   >&nbsp; &nbsp; 1706 &nbsp; &nbsp;avahi-daemon r: &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; B w: &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; B</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;10992 &nbsp; &nbsp; &nbsp; &nbsp;postgres r: &nbsp; &nbsp; &nbsp;236 &nbsp; B w: &nbsp; &nbsp; &nbsp; 18 MiB</font></div><div><font size="2"   >&nbsp; &nbsp; 5804 &nbsp; &nbsp; &nbsp; &nbsp;postgres r: &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; B w: &nbsp; &nbsp; &nbsp;888 KiB</font></div><div><font size="2"   >&nbsp; &nbsp; 5823 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sh r: &nbsp; &nbsp; &nbsp; &nbsp;4 KiB w: &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; B</font></div><div><font size="2"   >&nbsp; &nbsp; 5823 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;date r: &nbsp; &nbsp; &nbsp; &nbsp;3 KiB w: &nbsp; &nbsp; &nbsp; 29 &nbsp; B</font></div><div><font size="2"   >&nbsp; &nbsp; 1903 &nbsp; &nbsp; &nbsp; automount r: &nbsp; &nbsp; &nbsp; &nbsp;2 KiB w: &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; B</font></div><div><font size="2"   >&nbsp; &nbsp; 5823 &nbsp; &nbsp; &nbsp; &nbsp;postgres r: &nbsp; &nbsp; &nbsp;788 &nbsp; B w: &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; B</font></div><div><font size="2"   >&nbsp; &nbsp; 3992 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sshd r: &nbsp; &nbsp; &nbsp;292 &nbsp; B w: &nbsp; &nbsp; &nbsp;340 &nbsp; B</font></div><div><font size="2"   >&nbsp; &nbsp; 5820 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;stapio r: &nbsp; &nbsp; &nbsp;298 &nbsp; B w: &nbsp; &nbsp; &nbsp;286 &nbsp; B</font></div><div><font size="2"   >&nbsp; &nbsp;10991 &nbsp; &nbsp; &nbsp; &nbsp;postgres r: &nbsp; &nbsp; &nbsp; 30 &nbsp; B w: &nbsp; &nbsp; &nbsp; 30 &nbsp; B</font></div><div><font size="2"   >&nbsp; &nbsp;10988 &nbsp; &nbsp; &nbsp; &nbsp;postgres r: &nbsp; &nbsp; &nbsp; 29 &nbsp; B w: &nbsp; &nbsp; &nbsp; 29 &nbsp; B</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;10992 &nbsp; &nbsp; &nbsp; &nbsp;postgres r: &nbsp; &nbsp; &nbsp;349 &nbsp; B w: &nbsp; &nbsp; &nbsp; 27 MiB</font></div><div><font size="2"   >&nbsp; &nbsp; 5804 &nbsp; &nbsp; &nbsp; &nbsp;postgres r: &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; B w: &nbsp; &nbsp; &nbsp; &nbsp;1 MiB</font></div><div><font size="2"   >&nbsp; &nbsp; 5823 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sh r: &nbsp; &nbsp; &nbsp; &nbsp;4 KiB w: &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; B</font></div><div><font size="2"   >&nbsp; &nbsp; 5823 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;date r: &nbsp; &nbsp; &nbsp; &nbsp;3 KiB w: &nbsp; &nbsp; &nbsp; 29 &nbsp; B</font></div><div><font size="2"   >&nbsp; &nbsp; 1903 &nbsp; &nbsp; &nbsp; automount r: &nbsp; &nbsp; &nbsp; &nbsp;2 KiB w: &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; B</font></div><div><font size="2"   >&nbsp; &nbsp; 3992 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sshd r: &nbsp; &nbsp; &nbsp;874 &nbsp; B w: &nbsp; &nbsp; &nbsp;968 &nbsp; B</font></div><div><font size="2"   >&nbsp; &nbsp; 5820 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;stapio r: &nbsp; &nbsp; &nbsp;869 &nbsp; B w: &nbsp; &nbsp; &nbsp;857 &nbsp; B</font></div><div><font size="2"   >&nbsp; &nbsp; 5823 &nbsp; &nbsp; &nbsp; &nbsp;postgres r: &nbsp; &nbsp; &nbsp;788 &nbsp; B w: &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; B</font></div><div><font size="2"   >&nbsp; &nbsp;10991 &nbsp; &nbsp; &nbsp; &nbsp;postgres r: &nbsp; &nbsp; &nbsp; 44 &nbsp; B w: &nbsp; &nbsp; &nbsp; 44 &nbsp; B</font></div><div><font size="2"   >&nbsp; &nbsp;10988 &nbsp; &nbsp; &nbsp; &nbsp;postgres r: &nbsp; &nbsp; &nbsp; 29 &nbsp; B w: &nbsp; &nbsp; &nbsp; 29 &nbsp; B</font></div><p></p></pre></div><div><br></div><div>本文用到的几个probe alias原型(包含对应的call原型).</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/usr/share/systemtap/tapset/vfs.stp</font></div><div><div><font size="2"   >probe vfs.read = kernel.function("vfs_read")</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; file = $file</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; pos = $pos</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; buf = $buf</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bytes_to_read = $count</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; dev = __file_dev($file)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; devname = __find_bdevname(dev, __file_bdev($file))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ino = __file_ino($file)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; name = "vfs.read"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; argstr = sprintf("%d, %d, %p", $count, $pos, $buf)</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe vfs.read.return = kernel.function("vfs_read").return</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; name = "vfs.read"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; retstr = sprintf("%d", $return)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; file = $file</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; pos = $pos</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; buf = $buf</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bytes_to_read = $count</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; dev = __file_dev($file)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; devname = __find_bdevname(dev, __file_bdev($file))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ino = __file_ino($file)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ret = $return</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bytes_read = $return &gt; 0 ? $return : 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; error = $return &lt; 0 ? $return : 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; error_str = error ? errno_str(error) : ""</font></div><div><font size="2"   >}</font></div></div><div><div><font size="2"   >probe vfs.write = kernel.function("vfs_write")</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; file = $file</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; pos = $pos</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; buf = $buf</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bytes_to_write = $count</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; dev = __file_dev($file)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; devname = __find_bdevname(dev, __file_bdev($file))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ino = __file_ino($file)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; name = "vfs.write"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; argstr = sprintf("%d, %d, %p", $count, $pos, $buf)</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe vfs.write.return = kernel.function("vfs_write").return</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; name = "vfs.write"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; retstr = sprintf("%d", $return)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; file = $file</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; pos = $pos</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; buf = $buf</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bytes_to_write = $count</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; dev = __file_dev($file)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; devname = __find_bdevname(dev, __file_bdev($file))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ino = __file_ino($file)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ret = $return</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bytes_written = $return &gt; 0 ? $return : 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; error = $return &lt; 0 ? $return : 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; error_str = error ? errno_str(error) : ""</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div><br></div><div>这几个函数的源码位置信息: (源码这里就不贴出来了)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 io]stap -L 'kernel.function("vfs_read")'</font></div><div><font size="2"   >kernel.function("vfs_read@fs/read_write.c:294") $file:struct file* $buf:char* $count:size_t $pos:loff_t*</font></div><div><font size="2"   >[root@db-172-16-3-150 io]# stap -L 'kernel.function("vfs_read").return'</font></div><div><font size="2"   >kernel.function("vfs_read@fs/read_write.c:294").return $return:ssize_t $file:struct file* $buf:char* $count:size_t $pos:loff_t*</font></div><div><font size="2"   >[root@db-172-16-3-150 io]# stap -L 'kernel.function("vfs_write")'</font></div><div><font size="2"   >kernel.function("vfs_write@fs/read_write.c:349") $file:struct file* $buf:char const* $count:size_t $pos:loff_t*</font></div><div><font size="2"   >[root@db-172-16-3-150 io]# stap -L 'kernel.function("vfs_write").return'</font></div><div><font size="2"   >kernel.function("vfs_write@fs/read_write.c:349").return $return:ssize_t $file:struct file* $buf:char const* $count:size_t $pos:loff_t*</font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/mainsect-disk.html"   >https://sourceware.org/systemtap/SystemTap_Beginners_Guide/mainsect-disk.html</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://sourceware.org/systemtap/examples/"   >https://sourceware.org/systemtap/examples/</a></div><div>3. /usr/share/systemtap/testsuite/systemtap.examples</div><div>4. systemtap-testsuite</div><div>5. /usr/share/systemtap/testsuite/systemtap.examples/index.txt</div><div>6. /usr/share/systemtap/testsuite/systemtap.examples/keyword-index.txt</div><div>7. /usr/share/systemtap/tapset</div><div>8.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-ctime.html"   >https://sourceware.org/systemtap/tapsets/API-ctime.html</a></div><div>9.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-gettimeofday-s.html"   >https://sourceware.org/systemtap/tapsets/API-gettimeofday-s.html</a></div><div><br></div><wbr></div>
	</div>
</div>
</body>
</html>