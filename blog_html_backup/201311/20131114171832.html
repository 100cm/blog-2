<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap kernel.trace("*") events source code</h2>
	<h5 id="">2013-11-14 17:18:32&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020131014562216/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>我们知道内核trace event可以使用stap -l或-L查看, 而trace的源代码则可以在<span style="line-height: 28px;"   >/usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/include/trace/events中查找到.</span></div><div><span style="line-height: 28px;"   >(关注你的内核版本. 目录地址可能不同)</span></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >输出系统所有支持的kernel.trace, 使用stap -l 或者stap -L. 如下.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 events]# stap -l 'kernel.trace("**")'</font></div><div><font size="2"   >kernel.trace("__extent_writepage")</font></div><div><font size="2"   >kernel.trace("block_bio_backmerge")</font></div><div><font size="2"   >kernel.trace("block_bio_bounce")</font></div><div><font size="2"   >kernel.trace("block_bio_complete")</font></div><div><font size="2"   >kernel.trace("block_bio_frontmerge")</font></div><div><font size="2"   >kernel.trace("block_bio_queue")</font></div><div><font size="2"   >kernel.trace("block_getrq")</font></div><div><font size="2"   >kernel.trace("block_plug")</font></div><div><font size="2"   >kernel.trace("block_remap")</font></div><div><font size="2"   >kernel.trace("block_rq_abort")</font></div><div><font size="2"   >kernel.trace("block_rq_complete")</font></div><div><font size="2"   >kernel.trace("block_rq_insert")</font></div><div><font size="2"   >kernel.trace("block_rq_issue")</font></div><div><font size="2"   >kernel.trace("block_rq_remap")</font></div><div><font size="2"   >kernel.trace("block_rq_requeue")</font></div><div><font size="2"   >kernel.trace("block_sleeprq")</font></div><div><font size="2"   >kernel.trace("block_split")</font></div><div><font size="2"   >kernel.trace("block_unplug_io")</font></div><div><font size="2"   >kernel.trace("block_unplug_timer")</font></div><div><font size="2"   >kernel.trace("btrfs_chunk_alloc")</font></div><div><font size="2"   >kernel.trace("btrfs_chunk_free")</font></div><div><font size="2"   >kernel.trace("btrfs_cow_block")</font></div><div><font size="2"   >kernel.trace("btrfs_delayed_data_ref")</font></div><div><font size="2"   >kernel.trace("btrfs_delayed_ref_head")</font></div><div><font size="2"   >kernel.trace("btrfs_delayed_tree_ref")</font></div><div><font size="2"   >kernel.trace("btrfs_failed_cluster_setup")</font></div><div><font size="2"   >kernel.trace("btrfs_find_cluster")</font></div><div><font size="2"   >kernel.trace("btrfs_get_extent")</font></div><div><font size="2"   >kernel.trace("btrfs_inode_evict")</font></div><div><font size="2"   >kernel.trace("btrfs_inode_new")</font></div><div><font size="2"   >kernel.trace("btrfs_inode_request")</font></div><div><font size="2"   >kernel.trace("btrfs_ordered_extent_add")</font></div><div><font size="2"   >kernel.trace("btrfs_ordered_extent_put")</font></div><div><font size="2"   >kernel.trace("btrfs_ordered_extent_remove")</font></div><div><font size="2"   >kernel.trace("btrfs_ordered_extent_start")</font></div><div><font size="2"   >kernel.trace("btrfs_reserve_extent")</font></div><div><font size="2"   >kernel.trace("btrfs_reserve_extent_cluster")</font></div><div><font size="2"   >kernel.trace("btrfs_reserved_extent_alloc")</font></div><div><font size="2"   >kernel.trace("btrfs_reserved_extent_free")</font></div><div><font size="2"   >kernel.trace("btrfs_setup_cluster")</font></div><div><font size="2"   >kernel.trace("btrfs_space_reservation")</font></div><div><font size="2"   >kernel.trace("btrfs_sync_file")</font></div><div><font size="2"   >kernel.trace("btrfs_sync_fs")</font></div><div><font size="2"   >kernel.trace("btrfs_transaction_commit")</font></div><div><font size="2"   >kernel.trace("btrfs_writepage_end_io_hook")</font></div><div><font size="2"   >kernel.trace("consume_skb")</font></div><div><font size="2"   >kernel.trace("ext3_alloc_new_reservation")</font></div><div><font size="2"   >kernel.trace("ext3_allocate_blocks")</font></div><div><font size="2"   >kernel.trace("ext3_allocate_inode")</font></div><div><font size="2"   >kernel.trace("ext3_delete_inode")</font></div><div><font size="2"   >kernel.trace("ext3_direct_IO_enter")</font></div><div><font size="2"   >kernel.trace("ext3_direct_IO_exit")</font></div><div><font size="2"   >kernel.trace("ext3_discard_blocks")</font></div><div><font size="2"   >kernel.trace("ext3_discard_reservation")</font></div><div><font size="2"   >kernel.trace("ext3_forget")</font></div><div><font size="2"   >kernel.trace("ext3_free_blocks")</font></div><div><font size="2"   >kernel.trace("ext3_free_inode")</font></div><div><font size="2"   >kernel.trace("ext3_get_blocks_enter")</font></div><div><font size="2"   >kernel.trace("ext3_get_blocks_exit")</font></div><div><font size="2"   >kernel.trace("ext3_invalidatepage")</font></div><div><font size="2"   >kernel.trace("ext3_journalled_write_end")</font></div><div><font size="2"   >kernel.trace("ext3_journalled_writepage")</font></div><div><font size="2"   >kernel.trace("ext3_load_inode")</font></div><div><font size="2"   >kernel.trace("ext3_mark_inode_dirty")</font></div><div><font size="2"   >kernel.trace("ext3_ordered_write_end")</font></div><div><font size="2"   >kernel.trace("ext3_ordered_writepage")</font></div><div><font size="2"   >kernel.trace("ext3_read_block_bitmap")</font></div><div><font size="2"   >kernel.trace("ext3_readpage")</font></div><div><font size="2"   >kernel.trace("ext3_releasepage")</font></div><div><font size="2"   >kernel.trace("ext3_request_blocks")</font></div><div><font size="2"   >kernel.trace("ext3_request_inode")</font></div><div><font size="2"   >kernel.trace("ext3_reserved")</font></div><div><font size="2"   >kernel.trace("ext3_rsv_window_add")</font></div><div><font size="2"   >kernel.trace("ext3_sync_file_enter")</font></div><div><font size="2"   >kernel.trace("ext3_sync_file_exit")</font></div><div><font size="2"   >kernel.trace("ext3_sync_fs")</font></div><div><font size="2"   >kernel.trace("ext3_truncate_enter")</font></div><div><font size="2"   >kernel.trace("ext3_truncate_exit")</font></div><div><font size="2"   >kernel.trace("ext3_unlink_enter")</font></div><div><font size="2"   >kernel.trace("ext3_unlink_exit")</font></div><div><font size="2"   >kernel.trace("ext3_write_begin")</font></div><div><font size="2"   >kernel.trace("ext3_writeback_write_end")</font></div><div><font size="2"   >kernel.trace("ext3_writeback_writepage")</font></div><div><font size="2"   >kernel.trace("ext4_alloc_da_blocks")</font></div><div><font size="2"   >kernel.trace("ext4_allocate_blocks")</font></div><div><font size="2"   >kernel.trace("ext4_allocate_inode")</font></div><div><font size="2"   >kernel.trace("ext4_da_write_begin")</font></div><div><font size="2"   >kernel.trace("ext4_da_write_end")</font></div><div><font size="2"   >kernel.trace("ext4_da_write_pages")</font></div><div><font size="2"   >kernel.trace("ext4_da_writepages")</font></div><div><font size="2"   >kernel.trace("ext4_da_writepages_result")</font></div><div><font size="2"   >kernel.trace("ext4_discard_blocks")</font></div><div><font size="2"   >kernel.trace("ext4_discard_preallocations")</font></div><div><font size="2"   >kernel.trace("ext4_free_blocks")</font></div><div><font size="2"   >kernel.trace("ext4_free_inode")</font></div><div><font size="2"   >kernel.trace("ext4_journalled_write_end")</font></div><div><font size="2"   >kernel.trace("ext4_mb_discard_preallocations")</font></div><div><font size="2"   >kernel.trace("ext4_mb_new_group_pa")</font></div><div><font size="2"   >kernel.trace("ext4_mb_new_inode_pa")</font></div><div><font size="2"   >kernel.trace("ext4_mb_release_group_pa")</font></div><div><font size="2"   >kernel.trace("ext4_mb_release_inode_pa")</font></div><div><font size="2"   >kernel.trace("ext4_mballoc_alloc")</font></div><div><font size="2"   >kernel.trace("ext4_mballoc_discard")</font></div><div><font size="2"   >kernel.trace("ext4_mballoc_free")</font></div><div><font size="2"   >kernel.trace("ext4_mballoc_prealloc")</font></div><div><font size="2"   >kernel.trace("ext4_ordered_write_end")</font></div><div><font size="2"   >kernel.trace("ext4_request_blocks")</font></div><div><font size="2"   >kernel.trace("ext4_request_inode")</font></div><div><font size="2"   >kernel.trace("ext4_sync_file")</font></div><div><font size="2"   >kernel.trace("ext4_sync_fs")</font></div><div><font size="2"   >kernel.trace("ext4_trim_all_free")</font></div><div><font size="2"   >kernel.trace("ext4_trim_extent")</font></div><div><font size="2"   >kernel.trace("ext4_write_begin")</font></div><div><font size="2"   >kernel.trace("ext4_writeback_write_end")</font></div><div><font size="2"   >kernel.trace("ext4_writepage")</font></div><div><font size="2"   >... 略</font></div><div><font size="2"   >kernel.trace("xfs_lookup")</font></div><div><font size="2"   >kernel.trace("xfs_map_blocks_alloc")</font></div><div><font size="2"   >kernel.trace("xfs_map_blocks_found")</font></div><div><font size="2"   >kernel.trace("xfs_pagecache_inval")</font></div><div><font size="2"   >kernel.trace("xfs_perag_clear_reclaim")</font></div><div><font size="2"   >kernel.trace("xfs_perag_get")</font></div><div><font size="2"   >kernel.trace("xfs_perag_get_tag")</font></div><div><font size="2"   >kernel.trace("xfs_perag_put")</font></div><div><font size="2"   >kernel.trace("xfs_perag_set_reclaim")</font></div><div><font size="2"   >kernel.trace("xfs_readdir")</font></div><div><font size="2"   >kernel.trace("xfs_readlink")</font></div><div><font size="2"   >kernel.trace("xfs_releasepage")</font></div><div><font size="2"   >kernel.trace("xfs_remove")</font></div><div><font size="2"   >kernel.trace("xfs_rename")</font></div><div><font size="2"   >kernel.trace("xfs_reset_dqcounts")</font></div><div><font size="2"   >kernel.trace("xfs_setattr")</font></div><div><font size="2"   >kernel.trace("xfs_swap_extent_after")</font></div><div><font size="2"   >kernel.trace("xfs_swap_extent_before")</font></div><div><font size="2"   >kernel.trace("xfs_symlink")</font></div><div><font size="2"   >kernel.trace("xfs_trans_bhold")</font></div><div><font size="2"   >kernel.trace("xfs_trans_bhold_release")</font></div><div><font size="2"   >kernel.trace("xfs_trans_binval")</font></div><div><font size="2"   >kernel.trace("xfs_trans_bjoin")</font></div><div><font size="2"   >kernel.trace("xfs_trans_brelse")</font></div><div><font size="2"   >kernel.trace("xfs_trans_commit_lsn")</font></div><div><font size="2"   >kernel.trace("xfs_trans_get_buf")</font></div><div><font size="2"   >kernel.trace("xfs_trans_get_buf_recur")</font></div><div><font size="2"   >kernel.trace("xfs_trans_getsb")</font></div><div><font size="2"   >kernel.trace("xfs_trans_getsb_recur")</font></div><div><font size="2"   >kernel.trace("xfs_trans_log_buf")</font></div><div><font size="2"   >kernel.trace("xfs_trans_read_buf")</font></div><div><font size="2"   >kernel.trace("xfs_trans_read_buf_io")</font></div><div><font size="2"   >kernel.trace("xfs_trans_read_buf_recur")</font></div><div><font size="2"   >kernel.trace("xfs_trans_read_buf_shut")</font></div><div><font size="2"   >kernel.trace("xfs_unwritten_convert")</font></div><div><font size="2"   >kernel.trace("xfs_vm_bmap")</font></div><div><font size="2"   >kernel.trace("xfs_writepage")</font></div><p></p></pre></div></div><div>stap -L包含上下文变量信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 events]# stap -L 'kernel.trace("**")'|less</font></div><div><font size="2"   >kernel.trace("__extent_writepage") $page:struct page* $inode:struct inode* $wbc:struct writeback_control*</font></div><div><font size="2"   >kernel.trace("block_bio_backmerge") $q:struct request_queue* $bio:struct bio*</font></div><div><font size="2"   >kernel.trace("block_bio_bounce") $q:struct request_queue* $bio:struct bio*</font></div><div><font size="2"   >kernel.trace("block_bio_complete") $q:struct request_queue* $bio:struct bio*</font></div><div><font size="2"   >kernel.trace("block_bio_frontmerge") $q:struct request_queue* $bio:struct bio*</font></div><div><font size="2"   >kernel.trace("block_bio_queue") $q:struct request_queue* $bio:struct bio*</font></div><div><font size="2"   >kernel.trace("block_getrq") $q:struct request_queue* $bio:struct bio* $rw:int</font></div><p></p></pre></div><div>这些trace的source在<span style="line-height: 28px;"   >/usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/include/trace/events中可找到,</span></div><div><span style="line-height: 28px;"   >例如</span><span style="line-height: 28px;"   >block_bio_backmerge trace</span><span style="line-height: 28px;"   >&nbsp;:&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 events]# grep -rn block_bio_backmerge /usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/include/trace/events</font></span></div><div><div><font size="2"   >/usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/include/trace/events/block.h:203:DEFINE_EVENT(block_bio, block_bio_backmerge,</font></div></div><div><font size="2"   >对应的source code.</font></div><div><div><font size="2"   >DEFINE_EVENT(block_bio, block_bio_backmerge,</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TP_PROTO(struct request_queue *q, struct bio *bio),</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TP_ARGS(q, bio)</font></div><div><font size="2"   >);</font></div></div><p></p></pre></div><div>通过trace name, 追踪这个trace在哪些函数中被调用了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 events]# grep -rn block_bio_backmerge /usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/</font></div><div><font size="2"   >/usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/include/trace/events/block.h:203:DEFINE_EVENT(block_bio, block_bio_backmerge,</font></div><div><font size="2"   >/usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/block/blk-core.c:1421: &nbsp; &nbsp; &nbsp; &nbsp; trace_block_bio_backmerge(q, bio);</font></div><div><font size="2"   >/usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/kernel/trace/blktrace.c:946: &nbsp; ret = register_trace_block_bio_backmerge(blk_add_trace_bio_backmerge);</font></div><div><font size="2"   >/usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/kernel/trace/blktrace.c:982: &nbsp; unregister_trace_block_bio_backmerge(blk_add_trace_bio_backmerge);</font></div><p></p></pre></div><div>例如以上输出的<span style="line-height: 28px;"   >block/blk-core.c文件中包含了这个trace, 通过这个文件我们看一下它是在函数(</span><span style="line-height: 28px;"   >blk_queue_bio</span><span style="line-height: 28px;"   >)中被调用到了?</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 events]# less /usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/block/blk-core.c</font></div><div><div><font size="2"   >int blk_queue_bio(struct request_queue *q, struct bio *bio)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct request *req;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int el_ret;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; unsigned int bytes = bio-&gt;bi_size;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; const unsigned short prio = bio_prio(bio);</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; const bool sync = bio_rw_flagged(bio, BIO_RW_SYNCIO);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; const bool unplug = bio_rw_flagged(bio, BIO_RW_UNPLUG);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; const unsigned int ff = bio-&gt;bi_rw &amp; REQ_FAILFAST_MASK;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int where = ELEVATOR_INSERT_SORT;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int rw_flags;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* BIO_RW_BARRIER is deprecated */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (WARN_ONCE(bio_rw_flagged(bio, BIO_RW_BARRIER),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "block: BARRIER is deprecated, use FLUSH/FUA instead\n")) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bio_endio(bio, -EOPNOTSUPP);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* low level driver can indicate that it wants pages above a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* certain limit bounced to low memory (ie for highmem, or even</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* ISA dma in theory)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; blk_queue_bounce(q, &amp;bio);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; spin_lock_irq(q-&gt;queue_lock);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (bio-&gt;bi_rw &amp; (BIO_FLUSH | BIO_FUA)) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; where = ELEVATOR_INSERT_FLUSH;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto get_rq;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (elv_queue_empty(q))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto get_rq;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; el_ret = elv_merge(q, &amp;req, bio);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; switch (el_ret) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; case ELEVATOR_BACK_MERGE:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BUG_ON(!rq_mergeable(req));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!ll_back_merge_fn(q, req, bio))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div></div><div><font size="2"   >// 就在这里</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trace_block_bio_backmerge(q, bio);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ((req-&gt;cmd_flags &amp; REQ_FAILFAST_MASK) != ff)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; blk_rq_set_mixed_merge(req);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; req-&gt;biotail-&gt;bi_next = bio;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; req-&gt;biotail = bio;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; req-&gt;__data_len += bytes;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; req-&gt;ioprio = ioprio_best(req-&gt;ioprio, prio);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!blk_rq_cpu_valid(req))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; req-&gt;cpu = bio-&gt;bi_comp_cpu;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; drive_stat_acct(req, 0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elv_bio_merged(q, req, bio);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!attempt_back_merge(q, req))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elv_merged_request(q, req, el_ret);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto out;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; case ELEVATOR_FRONT_MERGE:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BUG_ON(!rq_mergeable(req));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!ll_front_merge_fn(q, req, bio))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trace_block_bio_frontmerge(q, bio);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ((req-&gt;cmd_flags &amp; REQ_FAILFAST_MASK) != ff) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; blk_rq_set_mixed_merge(req);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; req-&gt;cmd_flags &amp;= ~REQ_FAILFAST_MASK;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; req-&gt;cmd_flags |= ff;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bio-&gt;bi_next = req-&gt;bio;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; req-&gt;bio = bio;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* may not be valid. if the low level driver said</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* it didn't need a bounce buffer then it better</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* not touch req-&gt;buffer either...</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; req-&gt;buffer = bio_data(bio);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* The merge may happen accross partitions</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* We must update in_flight value accordingly</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; blk_account_io_front_merge(req, bio-&gt;bi_sector);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; req-&gt;__sector = bio-&gt;bi_sector;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; req-&gt;__data_len += bytes;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; req-&gt;ioprio = ioprio_best(req-&gt;ioprio, prio);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!blk_rq_cpu_valid(req))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; req-&gt;cpu = bio-&gt;bi_comp_cpu;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; drive_stat_acct(req, 0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elv_bio_merged(q, req, bio);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!attempt_front_merge(q, req))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elv_merged_request(q, req, el_ret);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto out;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* ELV_NO_MERGE: elevator says don't/can't merge. */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; default:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >get_rq:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* This sync check and mask will be re-done in init_request_from_bio(),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* but we need to set it earlier to expose the sync flag to the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* rq allocator and io schedulers.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; rw_flags = bio_data_dir(bio);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (sync)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rw_flags |= REQ_SYNC;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Grab a free request. This is might sleep but can not fail.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Returns with the queue unlocked.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; req = get_request_wait(q, rw_flags, bio);</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (unlikely(!req)) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bio_endio(bio, -ENODEV); &nbsp; &nbsp; &nbsp; &nbsp;/* @q is dead */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto out_unlock;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* After dropping the lock and possibly sleeping here, our request</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* may now be mergeable after it had proven unmergeable (above).</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* We don't worry about that case for efficiency. It won't happen</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* often, and the elevators are able to handle it.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; init_request_from_bio(req, bio);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; spin_lock_irq(q-&gt;queue_lock);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (test_bit(QUEUE_FLAG_SAME_COMP, &amp;q-&gt;queue_flags) ||</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bio_flagged(bio, BIO_CPU_AFFINE))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; req-&gt;cpu = raw_smp_processor_id();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (queue_should_plug(q) &amp;&amp; elv_queue_empty(q))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; blk_plug_device(q);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* insert the request into the elevator */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; drive_stat_acct(req, 1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; __elv_add_request(q, req, where, 0);</font></div><div><font size="2"   >out:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (unplug || !queue_should_plug(q))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __generic_unplug_device(q);</font></div><div><font size="2"   >out_unlock:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; spin_unlock_irq(q-&gt;queue_lock);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return 0;</font></div><div><font size="2"   >}</font></div><div><font size="2"   >EXPORT_SYMBOL_GPL(blk_queue_bio); &nbsp; &nbsp; &nbsp; /* for device mapper only */</font></div></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >[参考]</span></div><wbr><div>1.&nbsp;/usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/include/trace/events</div></div>
	</div>
</div>
</body>
</html>