<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">SystemTap User-Space Stack Backtraces for x86 processors arch only</h2>
	<h5 id="">2013-11-11 8:53:14&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201310835512336/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>systemtap 支持user-space的堆信息回溯输出.</div><div>使用方法参考 :&nbsp;</div><div><a rel="nofollow" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/ustack.html"   >https://sourceware.org/systemtap/SystemTap_Beginners_Guide/ustack.html</a></div><div>用到stap的 -d MODULE, --ldd选项.</div><div>同时需要安装被跟踪的进程的debuginfo包,&nbsp;<span style="line-height: 28px;"   >例如本例跟踪的/bin/ls, 在没有安装debuginfo包的时候会报错 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 pg93]# stap -d /bin/ls --ldd -e 'probe process("ls").function("xmalloc") {print_usyms(ubacktrace())}' -c "ls /"</font></div><div><font size="2"   >WARNING: cannot find module /bin/ls debuginfo: No DWARF information found [man warning::debuginfo]</font></div><div><font size="2"   >semantic error: while resolving probe point: identifier 'process' at &lt;input&gt;:1:7</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; source: probe process("ls").function("xmalloc") {print_usyms(ubacktrace())}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   >semantic error: no match</font></div><div><font size="2"   >Pass 2: analysis failed. &nbsp;[man error::pass2]</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >查找/bin/ls所在的包名</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 pg93]# rpm -qf /bin/ls</font></div><div><font size="2"   >coreutils-8.4-19.el6.x86_64</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >开启debuginfo源.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 pg93]# vi /etc/yum.repos.d/CentOS-Debuginfo.repo</font></div><div><div><font size="2"   >[debug]</font></div><div><font size="2"   >name=CentOS-6 - Debuginfo</font></div><div><font size="2"   >baseurl=http://debuginfo.centos.org/6/$basearch/</font></div><div><font size="2"   >gpgcheck=1</font></div><div><font size="2"   >gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-Debug-6</font></div><div><font size="2"   ># 加一条:</font></div><div><span style="line-height: 28px;"   ><font size="2"   >enabled=1</font></span></div></div><p></p></pre></div><div><span style="line-height: 28px;"   >安装</span><span style="line-height: 28px;"   >coreutils</span><span style="line-height: 28px;"   >对于的debuginfo包.</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 pg93]# yum install -y coreutils-debuginfo-8.4-19.el6.x86_64</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >注意debuginfo的版本号必须与</span><span style="line-height: 28px;"   >coreutils-8.4-19.el6.x86_64包一致.</span></div><div>安装完debuginfo后, stap可以正常的运行 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 pg93]# stap -d /bin/ls --ldd -e 'probe process("ls").function("xmalloc") {ut=ubacktrace(); println(ut); print_usyms(ut)}' -c "ls /"</font></div><div><font size="2"   >bin &nbsp; cgroup &nbsp; &nbsp; &nbsp;data01 &nbsp;etc &nbsp; lib &nbsp; &nbsp;lost+found &nbsp;misc &nbsp;net &nbsp;proc &nbsp;sbin &nbsp; &nbsp; srv &nbsp; ssd2 &nbsp;ssd4 &nbsp;tmp &nbsp;var</font></div><div><font size="2"   >boot &nbsp;core.19981 &nbsp;dev &nbsp; &nbsp; home &nbsp;lib64 &nbsp;media &nbsp; &nbsp; &nbsp; mnt &nbsp; opt &nbsp;root &nbsp;selinux &nbsp;ssd1 &nbsp;ssd3 &nbsp;sys &nbsp; usr</font></div><div><font size="2"   >0x4116b0 0x4116ec 0x40e6bb 0x408834 0x39bf41ecdd 0x402809</font></div><div><font size="2"   >&nbsp;0x4116b0 : xmalloc+0x0/0x20 [/bin/ls]</font></div><div><font size="2"   >&nbsp;0x4116ec : xmemdup+0x1c/0x40 [/bin/ls]</font></div><div><font size="2"   >&nbsp;0x40e6bb : clone_quoting_options+0x3b/0x50 [/bin/ls]</font></div><div><font size="2"   >&nbsp;0x408834 : main+0x3b4/0x1900 [/bin/ls]</font></div><div><font size="2"   >&nbsp;0x39bf41ecdd : __libc_start_main+0xfd/0x1d0 [/lib64/libc-2.12.so]</font></div><div><font size="2"   >&nbsp;0x402809 : _start+0x29/0x2c [/bin/ls]</font></div></div><div><font size="2"   >... 略</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/ustack.html"   >https://sourceware.org/systemtap/SystemTap_Beginners_Guide/ustack.html</a></div><div>2. man stap</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;-d MODULE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Add symbol/unwind information for the given module into the kernel object module. &nbsp;This may enable &nbsp;sym-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bolic &nbsp;tracebacks &nbsp;from &nbsp;those &nbsp;modules/programs, even if they do not have an explicit probe placed into</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; them.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;--ldd &nbsp;Add symbol/unwind information for all shared libraries suspected by ldd to be necessary &nbsp;for &nbsp;user-space</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; binaries &nbsp;being &nbsp;probe or listed with the -d option. &nbsp;Caution: this can make the probe modules consider-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ably larger.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;--all-modules</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Equivalent to specifying "-dkernel" and a "-d" for each kernel module that is &nbsp;currently &nbsp;loaded. &nbsp; Cau-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tion: this can make the probe modules considerably larger.</font></div><p></p></pre></div><div>3.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-uaddr.html"   >https://sourceware.org/systemtap/tapsets/API-uaddr.html</a></div><div>4.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-ubacktrace.html"   >https://sourceware.org/systemtap/tapsets/API-ubacktrace.html</a></div><div>5.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-ucallers.html"   >https://sourceware.org/systemtap/tapsets/API-ucallers.html</a></div><div>6.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-print-ubacktrace.html"   >https://sourceware.org/systemtap/tapsets/API-print-ubacktrace.html</a></div><div>7.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-print-ubacktrace-brief.html"   >https://sourceware.org/systemtap/tapsets/API-print-ubacktrace-brief.html</a></div><div>8.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-print-ustack.html"   >https://sourceware.org/systemtap/tapsets/API-print-ustack.html</a></div><div>9.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-print-usyms.html"   >https://sourceware.org/systemtap/tapsets/API-print-usyms.html</a></div><div>10.&nbsp;/usr/share/systemtap/tapset/ucontext*.stp</div><div>11.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Name</font></div><div><font size="2"   >    function::print_usyms ― Print out user stack from string</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Synopsis</font></div><div><font size="2"   >&nbsp; &nbsp; print_usyms(callers:string)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Arguments</font></div><div><font size="2"   >    callers</font></div><div><font size="2"   >    String with list of hexadecimal (user) addresses</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Description</font></div><div><font size="2"   >    This function performs a symbolic lookup of the addresses in the given string, which are assumed to be the result of prior calls to ustack, ucallers, and similar functions.</font></div><div><font size="2"   >    Prints one line per address, including the address, the name of the function containing the address, and an estimate of its position within that function, as obtained by usymdata. Returns nothing.</font></div><p></p></pre></div><div>12.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Name</font></div><div><font size="2"   >    function::ubacktrace ― Hex backtrace of current user-space task stack.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Synopsis</font></div><div><font size="2"   >&nbsp; &nbsp; ubacktrace:string()</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Arguments</font></div><div><font size="2"   >    None</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Description</font></div><div><font size="2"   >    Return a string of hex addresses that are a backtrace of the stack of the current task. Output may be truncated as per maximum string length. Returns empty string when current probe point cannot determine user backtrace. See backtrace for kernel traceback.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Note</font></div><div><font size="2"   >    To get (full) backtraces for user space applications and shared shared libraries not mentioned in the current script run stap with -d /path/to/exe-or-so and/or add --ldd to load all needed unwind data.</font></div><p></p></pre></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="SystemTap User-Space Stack Backtraces for x86 processors arch only - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>