<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">SystemTap Flight Recorder Mode</h2>
	<h5 id="">2013-11-06 16:56:28&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201310633139646/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p><font size="2"   >SystemTap's flight recorder mode allows you to run a SystemTap script run for long periods and just focus on recent output. The flight recorder mode (the -F option) limits the amount of output generated. There are two variations of the flight recorder mode: in-memory and file mode. In both cases the SystemTap script runs as a background process.</font></p></pre></div><div>systemtap飞行模式适合后台执行systemtap 脚本, 同时只保留stap最近的输出到限定大小的文件或内存中.</div><div>根据输出目标, 飞行模式分内存和文件模式.</div><div>使用stap -F选项可以打开飞行模式.</div><div>内存模式 :&nbsp;</div><div>最近的输出写入内存, 默认的内存大小为1MB, 超出会覆盖旧的输出的数据, 修改内存大小可使用-s选项.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >man stap</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;-sNUM &nbsp;Use &nbsp;NUM megabyte buffers for kernel-to-user data transfer. &nbsp;On a multiprocessor in bulk mode, this is a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; per-processor amount.</font></div></div><p></p></pre></div><div><br></div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# stap -F --vp 11111 -s10 -e '</font></div><div><font size="2"   >probe vfs.* {</font></div><div><font size="2"   >&nbsp; printdln("**", pn(), cmdline_str(), pid())</font></div><div><font size="2"   >}&nbsp;</font></div><div><font size="2"   >probe end {</font></div><div><font size="2"   >&nbsp; printf("exited\n")</font></div><div><font size="2"   >}'</font></div><p></p></pre></div><div>输出 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Pass 1: parsed user script and 96 library script(s) using 152024virt/25216res/2108shr/23932data kb, in 240usr/20sys/255real ms.</font></div><div><font size="2"   >Pass 2: analyzed script: 13 probe(s), 11 function(s), 6 embed(s), 0 global(s) using 385080virt/128228res/7468shr/119004data kb, in 2240usr/280sys/2599real ms.</font></div><div><font size="2"   >Pass 3: using cached /root/.systemtap/cache/7f/stap_7f1b46850d3110d61fa046ef63687b5b_8423.c</font></div><div><font size="2"   >Pass 4: using cached /root/.systemtap/cache/7f/stap_7f1b46850d3110d61fa046ef63687b5b_8423.ko</font></div><div><font size="2"   >Pass 5: starting run.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Disconnecting from systemtap module.</font></div><div><font size="2"   >To reconnect, type "staprun -A stap_7f1b46850d3110d61fa046ef63687b5b_1303"</font></div><div><font size="2"   >Pass 5: run completed in 0usr/20sys/34real ms.</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >命令行回到交互模式, 而非输出vfs.*的handler, 注意以上输出中的2行信息 :&nbsp;</span></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >Disconnecting from systemtap module.</font></div><div style="line-height: 28px;"   ><font size="2"   >To reconnect, type "staprun -A stap_7f1b46850d3110d61fa046ef63687b5b_1303"</font></div><p></p></pre></div></div><div style="line-height: 28px;"   >表示stap已经运行在飞行模式, 使用lsmod可以看到这个已加载的模块.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# lsmod|grep stap</font></div><div><font size="2"   >stap_7f1b46850d3110d61fa046ef63687b5b_1303 &nbsp; &nbsp;83009 &nbsp;0&nbsp;</font></div><p></p></pre></div><div>要观察这个stap的输出, 可以使用命令 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   ><div>[root@db-172-16-3-150 ~]# staprun -A stap_7f1b46850d3110d61fa046ef63687b5b_1303|less</div><div>vfs.read**/opt/systemtap/libexec/systemtap/stapio -L -R stap_7f1b46850d3110d61fa046ef63687b5b_1303 -F3**1303</div><div>vfs.do_sync_read**/opt/systemtap/libexec/systemtap/stapio -L -R stap_7f1b46850d3110d61fa046ef63687b5b_1303 -F3**1303</div><div>vfs.read**/opt/systemtap/libexec/systemtap/stapio -L -R stap_7f1b46850d3110d61fa046ef63687b5b_1303 -F3**1303</div><div>vfs.do_sync_read**/opt/systemtap/libexec/systemtap/stapio -L -R stap_7f1b46850d3110d61fa046ef63687b5b_1303 -F3**1303</div><div>vfs.write**/opt/systemtap/libexec/systemtap/stapio -L -R stap_7f1b46850d3110d61fa046ef63687b5b_1303 -F3**1303</div></font></span></div><div><font size="2"   >... 略</font></div><div><font size="2"   >ERROR: Couldn't write to output 1 for cpu 0, exiting.: Success</font></div><p></p></pre></div><div>使用内存模式的话, 重连模块后, 断开模块请使用Ctrl+\</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >^\ERROR: Couldn't write to output 1 for cpu 0, exiting.: Success</font></div><div><font size="2"   >^\</font></div><div><font size="2"   >Disconnecting from systemtap module.</font></div><div><font size="2"   >To reconnect, type "staprun -A stap_7f1b46850d3110d61fa046ef63687b5b_1375"</font></div><p></p></pre></div><div><div style="line-height: 28px;"   >使用Ctrl + \断开模块后, 模块不会被卸载</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 ~]# lsmod|grep stap</font></div><div style="line-height: 28px;"   ><font size="2"   >stap_7f1b46850d3110d61fa046ef63687b5b_1375 &nbsp; &nbsp;83009 &nbsp;0</font></div><p></p></pre></div></div></div><div><span style="line-height: 28px;"   >使用staprun连接和断开模块的方法参考man staprun :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >MODULE DETACHING AND ATTACHING</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;After the staprun program installs a Systemtap kernel module, users can detach from the kernel module and reat-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;tach &nbsp;to &nbsp;it later. &nbsp;The -L option loads the module and automatically detaches. &nbsp;Users can also detach from the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;kernel module interactively by sending the SIGQUIT signal from the keyboard (typically by typing Ctrl-\).</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;To reattach to a kernel module, the staprun -A option would be used.</font></div><p></p></pre></div><div>不再需要的模块可以使用staprun -d来卸载, 例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# staprun -d stap_7f1b46850d3110d61fa046ef63687b5b_1375</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# lsmod|grep stap</font></div><p></p></pre></div><div>参考 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >man staprun</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;-d &nbsp; &nbsp; Delete a module. &nbsp;Only detached or unused modules the user has permission to access will be deleted. Use</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "*" (quoted) to delete all unused modules.</font></div></div><p></p></pre></div><div><br></div><div>文件模式 :&nbsp;</div><div>与内存模式类似, 只是保存在文件中, 而非内存. 使用-o 选项.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# stap -F --vp 11111 -S 10,2 -o /tmp/test.log -e '</font></div><div><font size="2"   >probe vfs.* {</font></div><div><font size="2"   >&nbsp; printdln("**", pn(), cmdline_str(), pid())</font></div><div><font size="2"   >}&nbsp;</font></div><div><font size="2"   >probe end {</font></div><div><font size="2"   >&nbsp; printf("exited\n")</font></div><div><font size="2"   >}'</font></div><div><font size="2"   >Pass 1: parsed user script and 96 library script(s) using 152036virt/25252res/2120shr/23944data kb, in 240usr/10sys/254real ms.</font></div><div><font size="2"   >Pass 2: analyzed script: 13 probe(s), 11 function(s), 6 embed(s), 0 global(s) using 385092virt/128252res/7480shr/119016data kb, in 2250usr/270sys/2593real ms.</font></div><div><font size="2"   >Pass 3: using cached /root/.systemtap/cache/7f/stap_7f1b46850d3110d61fa046ef63687b5b_8423.c</font></div><div><font size="2"   >Pass 4: using cached /root/.systemtap/cache/7f/stap_7f1b46850d3110d61fa046ef63687b5b_8423.ko</font></div><div><font size="2"   >Pass 5: starting run.</font></div><div><font size="2"   >1515</font></div><div><font size="2"   >Pass 5: run completed in 0usr/10sys/28real ms.</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >输出单个文件最大10MB, 保留最近的2个文件(也就是说保留最近20MB的输出信息).</span></div><div>文件命名方式/tmp/test.log.[0-9]+</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# ll /tmp/test*</font></div><div><font size="2"   >-rw-r--r-- 1 root root 5190802 Nov &nbsp;6 16:32 /tmp/test.log.0</font></div><p></p></pre></div><div>注意stap的输出如下, 1515指的是stap后台进程的pid. 可用于关闭这个后台跑着的stap.</div><div><pre class="prettyprint"   style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >Pass 5: starting run.</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >1515</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >Pass 5: run completed in 0usr/10sys/28real ms.</font></div></pre></div><div><span style="line-height: 28px;"   >使用文件模式, 我们不需要使用staprun 连接到模块去获取输出,&nbsp;</span><span style="line-height: 28px;"   >直接查看文件即可.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# less /tmp/test.log.0</font></div><div><font size="2"   >vfs.read**/opt/systemtap/libexec/systemtap/stapio -o /tmp/test.log -D -R -S 10,2 stap_7f1b46850d3110d61fa046ef63687b5b_1514 -F3**1515</font></div><div><font size="2"   >vfs.read**/opt/systemtap/libexec/systemtap/stapio -o /tmp/test.log -D -R -S 10,2 stap_7f1b46850d3110d61fa046ef63687b5b_1514 -F3**1515</font></div><div><font size="2"   >vfs.read**postgres: wal writer process &nbsp; &nbsp;"" "" ""**7014</font></div><div><font size="2"   >vfs.do_sync_read**postgres: wal writer process &nbsp; &nbsp;"" "" ""**7014</font></div><div><font size="2"   >vfs.write**-bash**32376</font></div><div><font size="2"   >vfs.read**-bash**32376</font></div><div><font size="2"   >vfs.read**sshd: root@pts/2 ""**32374</font></div><div><font size="2"   >vfs.write**sshd: root@pts/2 ""**32374</font></div><div><font size="2"   >vfs.do_sync_write**sshd: root@pts/2 ""**32374</font></div><div><font size="2"   >vfs.read**/opt/systemtap/libexec/systemtap/stapio -o /tmp/test.log -D -R -S 10,2 stap_7f1b46850d3110d61fa046ef63687b5b_1514 -F3**1515</font></div><div><font size="2"   >... 略</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >关闭后台stap, 与内存模式不同的是, 我们可使用kill来关闭, 而内存模式直接卸载模块.</span></div><div><pre class="prettyprint"   ><p><font size="2"   >kill -s SIGTERM 1515</font></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/using-usage.html"   >https://sourceware.org/systemtap/SystemTap_Beginners_Guide/using-usage.html</a></div>2. man staprun</div>
	</div>
</div>
</body>
</html>