<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">plproxy 2.x fast deployment</h2>
	<h5 id="">2013-11-22 17:52:00&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013102242543765/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>我一直以来都比较推荐plproxy这个PostgreSQL代理软件, 因为它小巧灵活好用, 效率高.</div><div>最近朋友邀请我给他们做个分布式的方案, 所以又把plproxy翻出来了.</div><div>本文讲一讲在单节点中如何快速的部署plproxy环境.</div><div><span style="line-height: 28px;"   >环境 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >PostgreSQL 9.3.1</font></div><div><font size="2"   >plproxy 2.x</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >plrpoxy库 :&nbsp;</font></div><div><font size="2"   >hostaddr 172.16.3.150</font></div><div><font size="2"   >port 1921</font></div><div><font size="2"   >user proxy</font></div><div><font size="2"   >password proxy</font></div><div><font size="2"   >dbname proxy</font></div><div><font size="2"   >schema digoal &nbsp;// 这个schema名和数据节点一致, 可以省去写target的步骤.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >数据节点 :&nbsp;</font></div><div><div style="line-height: 28px;"   ><font size="2"   >hostaddr 172.16.3.150</font></div><div style="line-height: 28px;"   ><font size="2"   >port 1921</font></div><div style="line-height: 28px;"   ><font size="2"   >user digoal &nbsp;// plproxy将使用digoal用户连接数据节点.</font></div><div style="line-height: 28px;"   ><font size="2"   >password digoal</font></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div style="line-height: 28px;"   ><font size="2"   >dbname db0</font></div><div style="line-height: 28px;"   ><font size="2"   >schema digoal</font></div></div><div><div style="line-height: 28px;"   ><font size="2"   >dbname db1</font></div><div style="line-height: 28px;"   ><font size="2"   >schema digoal</font></div></div><div><div style="line-height: 28px;"   ><font size="2"   >dbname db2</font></div><div style="line-height: 28px;"   ><font size="2"   >schema digoal</font></div><div><div style="line-height: 28px;"   ><font size="2"   >dbname db3</font></div><div style="line-height: 28px;"   ><font size="2"   >schema digoal</font></div></div></div><p></p></pre></div><div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >首先在<a style="line-height: 28px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=plproxy.git;a=summary"   >http://git.postgresql.org/gitweb/?p=plproxy.git;a=summary</a>下载plproxy.</div><div style="line-height: 28px;"   >安装plproxy.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >tar -zxvf&nbsp;plproxy-d703683.tar.gz</font></div><div style="line-height: 28px;"   ><font size="2"   >mv&nbsp;plproxy-d703683 /opt/soft_bak/postgresql-9.3.1/contrib</font></div><div style="line-height: 28px;"   ><font size="2"   >cd&nbsp;/opt/soft_bak/postgresql-9.3.1/contrib/<span style="line-height: 28px;"   >plproxy-d703683</span></font></div><div><div><font size="2"   >[root@db-172-16-3-150 plproxy-d703683]# export PATH=/home/pg93/pgsql9.3.1/bin:$PATH</font></div><div><font size="2"   >[root@db-172-16-3-150 plproxy-d703683]# which pg_config</font></div></div><div><font size="2"   >[root@db-172-16-3-150 plproxy-d703683]# gmake clean</font></div><div><font size="2"   >[root@db-172-16-3-150 plproxy-d703683]# gmake</font></div><div><font size="2"   >[root@db-172-16-3-150 plproxy-d703683]# gmake install</font></div><p></p></pre></div><div><br></div><div>创建proxy库, proxy角色, 在proxy库创建plproxy extension.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.3.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><div><font size="2"   >postgres=# create role proxy nosuperuser login encrypted password 'proxy';</font></div><div><font size="2"   >CREATE ROLE</font></div></div><div><font size="2"   >digoal=# create database proxy;</font></div><div><font size="2"   >CREATE DATABASE</font></div><div><font size="2"   >digoal=# \c proxy</font></div><div><font size="2"   >You are now connected to database "proxy" as user "postgres".</font></div><div><font size="2"   >proxy=# create extension plproxy;</font></div><div><font size="2"   >CREATE EXTENSION</font></div><p></p></pre></div><div>调整proxy库权限</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >proxy=# grant all on database proxy to proxy;</font></div><div><font size="2"   >GRANT</font></div></div><div><div><font size="2"   >proxy=# \c proxy proxy</font></div><div><font size="2"   >You are now connected to database "proxy" as user "digoal".</font></div></div><p></p></pre></div><div><div>创建digoal schema, 目的是和数据节点的schema匹配, 这样的话可以省去在代理函数中写target强行指定schema.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >proxy=&gt; create schema digoal;</font></div><div><font size="2"   >CREATE SCHEMA</font></div><p></p></pre></div></div><div><br></div><div>创建节点数据库&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >proxy=&gt; \c postgres postgres&nbsp;</font></div><div><font size="2"   >You are now connected to database "postgres" as user "postgres".&nbsp;</font></div><div><font size="2"   >postgres=# create role digoal nosuperuser login encrypted password 'digoal';&nbsp;</font></div><div><font size="2"   >postgres=# create database db0;</font></div></div><div><span style="line-height: 28px;"   ><font size="2"   >postgres=# create database db1;</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >postgres=# create database db2;</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >postgres=# create database db3;</font></span></div><p></p></pre></div><div>调整权限, 赋予给后面将要给user mapping中配置的option user权限.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# grant all on database db0 to digoal;</font></div><div><span style="line-height: 28px;"   ><font size="2"   >postgres=# grant all on database db1 to digoal;</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >postgres=# grant all on database db2 to digoal;</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >postgres=# grant all on database db3 to digoal;</font></span></div><p></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >使用超级用户在proxy数据库中创建server.</span></div><div><pre class="prettyprint"   ><p><span style="line-height: 28px;"   ><font size="2"   ></font></span></p><div><font size="2"   >proxy=&gt; \c proxy postgres</font></div><div><font size="2"   >You are now connected to database "proxy" as user "postgres".</font></div><div><font size="2"   >proxy=#&nbsp;</font></div><div><font size="2"   ><span style="line-height: 28px;"   >CREATE SERVER cluster_srv1 FOREIGN DATA WRAPPER plproxy options&nbsp;</span></font></div><div><font size="2"   >(connection_lifetime '1800',</font></div><div><font size="2"   >p0 'dbname=db0 hostaddr=172.16.3.150 port=1921 application_name=test',</font></div><div><font size="2"   >p1 'dbname=db1 hostaddr=172.16.3.150 port=1921',</font></div><div><font size="2"   >p2 'dbname=db2 hostaddr=172.16.3.150 port=1921',</font></div><div><font size="2"   >p3 'dbname=db3 hostaddr=172.16.3.150 port=1921');</font></div><p></p></pre></div><div>创建server时可以使用libpq中的选项. 例如本例使用了<span style="line-height: 28px;"   >application_name.</span></div><div><span style="line-height: 28px;"   >将server权限赋予给proxy用户.</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >proxy=# grant usage on FOREIGN server cluster_srv1 to proxy;</font></div><div><font size="2"   >GRANT</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >配置proxy用户的连接cluster_srv1的选项.</span></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >proxy=# create user mapping for proxy server cluster_srv1 options (user 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING</font></div><p></p></pre></div><div>用户proxy连接到cluster_srv1时使用digoal用户连接, 这里不需要配置password, 因为我们将使用trust认证.</div><div><br></div><div>修改数据节点的pg_hba.conf</div><div>从proxy节点使用digoal用户连接数据库db0, db1, db2, db3使用trust认证.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi $PGDATA/pg_hba.conf</font></div><div><div><font size="2"   >host db0 digoal 172.16.3.150/32 trust</font></div><div><font size="2"   >host db1 digoal 172.16.3.150/32 trust</font></div><div><font size="2"   >host db2 digoal 172.16.3.150/32 trust</font></div><div><font size="2"   >host db3 digoal 172.16.3.150/32 trust</font></div></div><div><font size="2"   >pg_ctl reload</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >使用超级用户创建plproxy函数, 然后把函数权限赋予给proxy权限.&nbsp;</span></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >proxy=# CREATE OR REPLACE FUNCTION digoal.dy(sql text) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;RETURNS SETOF record</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;LANGUAGE plproxy</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;STRICT</font></div><div style="line-height: 28px;"   ><font size="2"   >AS $function$</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; cluster 'cluster_srv1';</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; run on all;</font></div><div style="line-height: 28px;"   ><font size="2"   >$function$;</font></div><div style="line-height: 28px;"   ><div><font size="2"   >proxy=# grant execute on function digoal.dy(text) to proxy;</font></div><div><font size="2"   >GRANT</font></div></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >在数据节点创建实体函数</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >proxy=# \c db0 digoal</font></div></div><div><span style="line-height: 28px;"   ><font size="2"   >db0=#&nbsp;</font></span></div><div><div><font size="2"   >CREATE OR REPLACE FUNCTION digoal.dy(sql text)</font></div><div><font size="2"   >&nbsp;RETURNS SETOF record</font></div><div><font size="2"   >&nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >&nbsp;STRICT</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >&nbsp; declare</font></div><div><font size="2"   >&nbsp; rec record;</font></div><div><font size="2"   >&nbsp; begin</font></div><div><font size="2"   >&nbsp; &nbsp; for rec in execute sql loop</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; return next rec;</font></div><div><font size="2"   >&nbsp; &nbsp; end loop;</font></div><div><font size="2"   >&nbsp; &nbsp; return;</font></div><div><font size="2"   >&nbsp; end;</font></div><div><font size="2"   >$function$;</font></div></div><div><span style="line-height: 28px;"   ><font size="2"   >db0=# \c db1 digoal</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >...</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >db1=# \c db2 digoal</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >...</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >db2=# \c db3 digoal</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >...</font></span></div><p></p></pre></div></div><div><br></div><div><span style="line-height: 28px;"   >在proxy库中就可以查询这个动态SQL了.</span></div><div><span style="line-height: 28px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >proxy=&gt; select * from digoal.dy('select count(*) from pg_class') as t(i int8);</font></div><div><font size="2"   >&nbsp; i &nbsp;</font></div><div><font size="2"   >-----</font></div><div><font size="2"   >&nbsp;293</font></div><div><font size="2"   >&nbsp;293</font></div><div><font size="2"   >&nbsp;293</font></div><div><font size="2"   >&nbsp;293</font></div><div><font size="2"   >(4 rows)</font></div><div><div><font size="2"   >proxy=&gt; select sum(i) from digoal.dy('select count(*) from pg_class') as t(i int8);</font></div><div><font size="2"   >&nbsp;sum &nbsp;</font></div><div><font size="2"   >------</font></div><div><font size="2"   >&nbsp;1172</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>几个小的测试 :&nbsp;</div></span></div><div style="line-height: 28px;"   >一. 修改foreign server测试, 观察连接将重置.</div><div style="line-height: 28px;"   >前面那个会话不要断开, 在另一个会话中观察proxy发起的连接到数据节点的连接.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from pg_stat_activity where usename='digoal';</font></div><div><font size="2"   >&nbsp;datid | datname | pid &nbsp;| usesysid | usename | application_name | client_addr &nbsp;| client_hostname | client_port | &nbsp; &nbsp; &nbsp; &nbsp; backend_sta</font></div><div><font size="2"   >rt &nbsp; &nbsp; &nbsp; &nbsp; | xact_start | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;query_start &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; state_change &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| waiting | state | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;q</font></div><div><font size="2"   >uery &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------+---------+------+----------+---------+------------------+--------------+-----------------+-------------+--------------------</font></div><div><font size="2"   >-----------+------------+-------------------------------+-------------------------------+---------+-------+-------------------------</font></div><div><font size="2"   >----------------------------</font></div><div><font size="2"   >&nbsp;91246 | db0 &nbsp; &nbsp; | 8171 | &nbsp; &nbsp;91250 | digoal &nbsp;| test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 172.16.3.150 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 47937 | 2013-11-22 17:23:26</font></div><div><font size="2"   >.138425+08 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2013-11-22 17:27:05.539286+08 | 2013-11-22 17:27:05.539745+08 | f &nbsp; &nbsp; &nbsp; | idle &nbsp;| select i::int8 from digo</font></div><div><font size="2"   >al.dy($1::text) as (i int8)</font></div><div><font size="2"   >&nbsp;91247 | db1 &nbsp; &nbsp; | 8172 | &nbsp; &nbsp;91250 | digoal &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 172.16.3.150 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 47938 | 2013-11-22 17:23:26</font></div><div><font size="2"   >.138688+08 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2013-11-22 17:27:05.53938+08 &nbsp;| 2013-11-22 17:27:05.539874+08 | f &nbsp; &nbsp; &nbsp; | idle &nbsp;| select i::int8 from digo</font></div><div><font size="2"   >al.dy($1::text) as (i int8)</font></div><div><font size="2"   >&nbsp;91248 | db2 &nbsp; &nbsp; | 8173 | &nbsp; &nbsp;91250 | digoal &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 172.16.3.150 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 47939 | 2013-11-22 17:23:26</font></div><div><font size="2"   >.138957+08 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2013-11-22 17:27:05.53938+08 &nbsp;| 2013-11-22 17:27:05.539841+08 | f &nbsp; &nbsp; &nbsp; | idle &nbsp;| select i::int8 from digo</font></div><div><font size="2"   >al.dy($1::text) as (i int8)</font></div><div><font size="2"   >&nbsp;91249 | db3 &nbsp; &nbsp; | 8174 | &nbsp; &nbsp;91250 | digoal &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 172.16.3.150 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 47940 | 2013-11-22 17:23:26</font></div><div><font size="2"   >.139178+08 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2013-11-22 17:27:05.539366+08 | 2013-11-22 17:27:05.539793+08 | f &nbsp; &nbsp; &nbsp; | idle &nbsp;| select i::int8 from digo</font></div><div><font size="2"   >al.dy($1::text) as (i int8)</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div><div>再次在proxy的同一会话中查询时, 这些会话会复用, 不会断开. 前面已经讲了plproxy是使用长连接的.</div><div>如果修改了server, 那么这些连接会断开, 重新连接. 所以不需要担心修改server带来的连接cache问题.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \c proxy postgres</font></div><div><font size="2"   >You are now connected to database "proxy" as user "postgres".</font></div><div><font size="2"   >proxy=# alter server cluster_srv1 options (set p1 'dbname=db1 hostaddr=172.16.3.150 port=1921 application_name=abc');</font></div><div><font size="2"   >ALTER SERVER</font></div><p></p></pre></div><div>再次在proxy的同一会话中查询后, 我们发现4个连接都变了, 说明alter server后, 如果再次发起plproxy函数的查询请求, 那么proxy会重置连接.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >proxy=&gt; select sum(i) from digoal.dy('select count(*) from pg_class') as t(i int8);</font></div><div><font size="2"   >&nbsp;sum &nbsp;</font></div><div><font size="2"   >------</font></div><div><font size="2"   >&nbsp;1172</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>在另一会话的查询结果 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >proxy=# select * from pg_stat_activity where usename='digoal';</font></div><div><font size="2"   >&nbsp;datid | datname | pid &nbsp;| usesysid | usename | application_name | client_addr &nbsp;| client_hostname | client_port | &nbsp; &nbsp; &nbsp; &nbsp; backend_sta</font></div><div><font size="2"   >rt &nbsp; &nbsp; &nbsp; &nbsp; | xact_start | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;query_start &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; state_change &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| waiting | state | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;q</font></div><div><font size="2"   >uery &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------+---------+------+----------+---------+------------------+--------------+-----------------+-------------+--------------------</font></div><div><font size="2"   >-----------+------------+-------------------------------+-------------------------------+---------+-------+-------------------------</font></div><div><font size="2"   >----------------------------</font></div><div><font size="2"   >&nbsp;91246 | db0 &nbsp; &nbsp; | 8245 | &nbsp; &nbsp;91250 | digoal &nbsp;| test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 172.16.3.150 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 47941 | 2013-11-22 17:30:36</font></div><div><font size="2"   >.933077+08 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2013-11-22 17:30:36.936784+08 | 2013-11-22 17:30:36.938837+08 | f &nbsp; &nbsp; &nbsp; | idle &nbsp;| select i::int8 from digo</font></div><div><font size="2"   >al.dy($1::text) as (i int8)</font></div><div><font size="2"   >&nbsp;91248 | db2 &nbsp; &nbsp; | 8247 | &nbsp; &nbsp;91250 | digoal &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 172.16.3.150 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 47943 | 2013-11-22 17:30:36</font></div><div><font size="2"   >.933502+08 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2013-11-22 17:30:36.936783+08 | 2013-11-22 17:30:36.938981+08 | f &nbsp; &nbsp; &nbsp; | idle &nbsp;| select i::int8 from digo</font></div><div><font size="2"   >al.dy($1::text) as (i int8)</font></div><div><font size="2"   >&nbsp;91249 | db3 &nbsp; &nbsp; | 8248 | &nbsp; &nbsp;91250 | digoal &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 172.16.3.150 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 47944 | 2013-11-22 17:30:36</font></div><div><font size="2"   >.933731+08 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2013-11-22 17:30:36.937147+08 | 2013-11-22 17:30:36.939015+08 | f &nbsp; &nbsp; &nbsp; | idle &nbsp;| select i::int8 from digo</font></div><div><font size="2"   >al.dy($1::text) as (i int8)</font></div><div><font size="2"   >&nbsp;91247 | db1 &nbsp; &nbsp; | 8246 | &nbsp; &nbsp;91250 | digoal &nbsp;| abc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 172.16.3.150 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 47942 | 2013-11-22 17:30:36</font></div><div><font size="2"   >.933288+08 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2013-11-22 17:30:36.93757+08 &nbsp;| 2013-11-22 17:30:36.939299+08 | f &nbsp; &nbsp; &nbsp; | idle &nbsp;| select i::int8 from digo</font></div><div><font size="2"   >al.dy($1::text) as (i int8)</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >二. run on 的几种形式测试.</div><div style="line-height: 28px;"   >在数据节点创建测试表.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >proxy=# \c db0 digoal</font></div><div><div><font size="2"   >db0=&gt; create table t(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >db0=&gt; \c db1</font></div><div><font size="2"   >You are now connected to database "db1" as user "digoal".</font></div><div><font size="2"   >db1=&gt; create table t(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >db1=&gt; \c db2</font></div><div><font size="2"   >You are now connected to database "db2" as user "digoal".</font></div><div><font size="2"   >db2=&gt; create table t(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >db2=&gt; \c db3</font></div><div><font size="2"   >You are now connected to database "db3" as user "digoal".</font></div><div><font size="2"   >db3=&gt; create table t(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><p></p></pre></div></div><div><br></div><div>在数据节点创建插入数据的实体函数, 每个节点返回不一样的数字.</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >\c db0 digoal</font></span></div><div><div style="line-height: 28px;"   ><font size="2"   >db0=&gt; create or replace function digoal.f_test4() returns int as $$</font></div><div style="line-height: 28px;"   ><font size="2"   >declare</font></div><div style="line-height: 28px;"   ><font size="2"   >begin</font></div><div style="line-height: 28px;"   ><font size="2"   >insert into t(id) values (1);</font></div><div style="line-height: 28px;"   ><font size="2"   >return 0;</font></div><div style="line-height: 28px;"   ><font size="2"   >end;</font></div><div style="line-height: 28px;"   ><font size="2"   >$$ language plpgsql strict;</font></div></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >db1=&gt; create or replace function&nbsp;<span style="line-height: 28px;"   >digoal.</span><span style="line-height: 28px;"   >f_test4() returns int as $$</span></font></div><div style="line-height: 28px;"   ><font size="2"   >declare</font></div><div style="line-height: 28px;"   ><font size="2"   >begin</font></div><div style="line-height: 28px;"   ><font size="2"   >insert into t(id) values (1);</font></div><div style="line-height: 28px;"   ><font size="2"   >return 1;</font></div><div style="line-height: 28px;"   ><font size="2"   >end;</font></div><div style="line-height: 28px;"   ><font size="2"   >$$ language plpgsql strict;</font></div></div><div><div style="line-height: 28px;"   ><font size="2"   >db2=&gt; create or replace function&nbsp;<span style="line-height: 28px;"   >digoal.</span><span style="line-height: 28px;"   >f_test4() returns int as $$</span></font></div><div style="line-height: 28px;"   ><font size="2"   >declare</font></div><div style="line-height: 28px;"   ><font size="2"   >begin</font></div><div style="line-height: 28px;"   ><font size="2"   >insert into t(id) values (1);</font></div><div style="line-height: 28px;"   ><font size="2"   >return 2;</font></div><div style="line-height: 28px;"   ><font size="2"   >end;</font></div><div style="line-height: 28px;"   ><font size="2"   >$$ language plpgsql strict;</font></div></div><div><div><font size="2"   >db3=&gt; create or replace function&nbsp;<span style="line-height: 28px;"   >digoal.</span><span style="line-height: 28px;"   >f_test4() returns int as $$</span></font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >insert into t(id) values (1);</font></div><div><font size="2"   >return 3;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div></div><p></p></pre></div><div><br></div><div>在proxy节点创建代理函数, 并且将执行权限赋予给proxy用户.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >proxy=&gt; \c proxy postgres</font></div><div><div><font size="2"   >create or replace function digoal.f_test4() returns int as $$</font></div><div><font size="2"   >cluster 'cluster_srv1';</font></div><div><font size="2"   >run on 0; &nbsp; -- 在指定的数据节点上运行, 本例可以设置为0到3, 顺序和创建的server中的配置顺序一致. p0, p1, p2, p3</font></div><div><font size="2"   >$$ language plproxy strict;</font></div></div><div><div><font size="2"   >proxy=# grant execute on function digoal.f_test4() to proxy;</font></div><div><font size="2"   >GRANT</font></div></div><div><div><font size="2"   >proxy=# \c proxy proxy</font></div><div><font size="2"   >You are now connected to database "proxy" as user "proxy".</font></div><div><font size="2"   >proxy=&gt; select * from digoal.f_test4();</font></div><div><font size="2"   >&nbsp;f_test4&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>如果run on 的数字改成0-3以外的数字, 运行时将报错.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >proxy=# create or replace function digoal.f_test4() returns int as $$</font></div><div><font size="2"   >cluster 'cluster_srv1';</font></div><div><font size="2"   >run on 4; &nbsp;</font></div><div><font size="2"   >$$ language plproxy strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >proxy=# \c proxy proxy</font></div><div><font size="2"   >You are now connected to database "proxy" as user "proxy".</font></div><div><font size="2"   >proxy=&gt; select * from digoal.f_test4();</font></div><div><font size="2"   >ERROR: &nbsp;PL/Proxy function digoal.f_test4(0): part number out of range</font></div><p></p></pre></div><div><br></div><div>run on any表示随机的选择一个数据节点运行.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >proxy=&gt; \c proxy postgres</font></div><div><font size="2"   >You are now connected to database "proxy" as user "postgres".</font></div><div><font size="2"   >proxy=# create or replace function digoal.f_test4() returns int as $$</font></div><div><font size="2"   >cluster 'cluster_srv1';</font></div><div><font size="2"   >run on any; &nbsp;</font></div><div><font size="2"   >$$ language plproxy strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div></div><div><div><font size="2"   >proxy=# \c proxy proxy</font></div><div><font size="2"   >You are now connected to database "proxy" as user "proxy".</font></div><div><font size="2"   >proxy=&gt; select * from digoal.f_test4();</font></div><div><font size="2"   >&nbsp;f_test4&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >proxy=&gt; select * from digoal.f_test4();</font></div><div><font size="2"   >&nbsp;f_test4&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;3</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >proxy=&gt; select * from digoal.f_test4();</font></div><div><font size="2"   >&nbsp;f_test4&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >proxy=&gt; select * from digoal.f_test4();</font></div><div><font size="2"   >&nbsp;f_test4&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;3</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >run on function() 则使用比特计算得到运行节点.</font></div><div><div><font size="2"   >proxy=&gt; create or replace function digoal.f(int) returns int as $$</font></div><div><font size="2"   >select $1;</font></div><div><font size="2"   >$$ language sql strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div></div><div><div><font size="2"   >proxy=&gt; \c proxy postgres</font></div><div><font size="2"   >You are now connected to database "proxy" as user "postgres".</font></div><div><font size="2"   >proxy=# create or replace function digoal.f_test4() returns int as $$</font></div><div><font size="2"   >cluster 'cluster_srv1';</font></div><div><font size="2"   >run on digoal.f(10); &nbsp;</font></div><div><font size="2"   >$$ language plproxy strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div></div><div><div><font size="2"   >proxy=&gt; select digoal.f_test4();</font></div><div><font size="2"   >&nbsp;f_test4&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >proxy=&gt; \c proxy postgres</font></div><div><font size="2"   >You are now connected to database "proxy" as user "postgres".</font></div><div><font size="2"   >proxy=# create or replace function digoal.f_test4() returns int as $$</font></div><div><font size="2"   >cluster 'cluster_srv1';</font></div><div><font size="2"   >run on digoal.f(11); &nbsp;</font></div><div><font size="2"   >$$ language plproxy strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >proxy=# \c proxy proxy</font></div><div><font size="2"   >You are now connected to database "proxy" as user "proxy".</font></div><div><font size="2"   >proxy=&gt; select digoal.f_test4();</font></div><div><font size="2"   >&nbsp;f_test4&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;3</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >proxy=&gt; \c proxy postgres</font></div><div><font size="2"   >You are now connected to database "proxy" as user "postgres".</font></div><div><font size="2"   >proxy=# create or replace function digoal.f_test4() returns int as $$</font></div><div><font size="2"   >cluster 'cluster_srv1';</font></div><div><font size="2"   >run on digoal.f(-11); &nbsp;</font></div><div><font size="2"   >$$ language plproxy strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >proxy=# \c proxy proxy</font></div><div><font size="2"   >You are now connected to database "proxy" as user "proxy".</font></div><div><font size="2"   >proxy=&gt; select digoal.f_test4();</font></div><div><font size="2"   >&nbsp;f_test4&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>run on all表示所有数据节点运行. 代理函数必须使用returns setof返回.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >proxy=&gt; \c proxy postgres</font></div><div><font size="2"   >You are now connected to database "proxy" as user "postgres".</font></div><div><font size="2"   >proxy=# create or replace function digoal.f_test4() returns int as $$</font></div><div><font size="2"   >cluster 'cluster_srv1';</font></div><div><font size="2"   >run on all; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >$$ language plproxy strict;</font></div><div><font size="2"   >ERROR: &nbsp;PL/Proxy function digoal.f_test4(0): RUN ON ALL requires set-returning function</font></div><div><font size="2"   >proxy=# drop function digoal.f_test4();</font></div><div><font size="2"   >DROP FUNCTION</font></div><div><font size="2"   >proxy=# create or replace function digoal.f_test4() returns setof int as $$</font></div><div><font size="2"   >cluster 'cluster_srv1';</font></div><div><font size="2"   >run on all; &nbsp;</font></div><div><font size="2"   >$$ language plproxy strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div></div><div><div><font size="2"   >proxy=# grant execute on function digoal.f_test4() to proxy;</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >proxy=# \c proxy proxy&nbsp;</font></div><div><font size="2"   >You are now connected to database "proxy" as user "proxy".</font></div><div><font size="2"   >proxy=&gt; select digoal.f_test4();</font></div><div><font size="2"   >&nbsp;f_test4&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;3</font></div><div><font size="2"   >(4 rows)</font></div></div><p></p></pre></div><div><br></div><div>[注意事项]</div><div>1. 设计时需要注意</div><div>plproxy函数所在的schema尽量和数据节点上实际函数的schema一致.</div><div>否则需要在plproxy函数中使用target指定 schema.functionname;</div><div>2. 数据节点的个数请保持2^n,&nbsp;</div><div>这么做有利于后期的节点扩展, 例如2个节点扩展到4个节点时, 数据不需要发生跨节点的重分布.</div><div>例如</div><div>mod(x,2)=0 那么<span style="line-height: 28px;"   >mod(x,4)=0或2</span></div><div>mod(x,2)=1 那么mod(x,4)=1或3</div><div>比较适合位运算的分布算法.</div><div>3. 如果业务为短连接的形式, 那么需要1层连接池, 在应用程序和plproxy数据库之间. 而不是plproxy和数据节点之间.</div><div>&nbsp; &nbsp;在应用程序和plproxy之间加连接池后, 其实对于plproxy来说就是长连接了, 所以在plproxy和数据节点之间也就不需要连接池了.</div><div>4. 长连接不需要连接池, 因为plproxy和数据节点之间的连接是长连接.</div><div>5. plproxy语法 :&nbsp;</div><div>&nbsp; &nbsp;connect, cluster, run, select, split, target.</div><div>6. 关于连接密码</div><div>&nbsp; &nbsp;出于安全考虑, 建议在任何配置中不要出现明文密码, 所以最好是plproxy服务器到数据节点是trust验证, 保护好plproxy即可.</div><div>&nbsp; &nbsp;假设plproxy在172.16.3.2上. 数据节点有4个, 库名和用户名都为digoal. 那么在4个节点上配置pg_hba.conf如下.</div><div>&nbsp; &nbsp;node0</div><div>&nbsp; &nbsp;host digoal digoal 172.16.3.2/32 trust</div><div>&nbsp; &nbsp;node1</div><div>&nbsp; &nbsp;host digoal digoal 172.16.3.2/32 trust</div><div>&nbsp; &nbsp;node2</div><div>&nbsp; &nbsp;host digoal digoal 172.16.3.2/32 trust</div><div>&nbsp; &nbsp;node3</div><div>&nbsp; &nbsp;host digoal digoal 172.16.3.2/32 trust</div><div><span style="line-height: 28px;"   >7. run 详解:</span></div><div>&nbsp; &nbsp;run on &lt;NR&gt;, &lt;NR&gt;是数字常量, 范围是0 到 nodes-1; 例如有4个节点 run on 0; (run on 4则报错).</div><div>&nbsp; &nbsp;run on ANY,&nbsp;</div><div>&nbsp; &nbsp;run on function(...), 这里用到的函数返回结果必须是int2, int4 或 int8.&nbsp;</div><div>&nbsp; &nbsp;run on ALL, 这种的plproxy函数必须是returns setof..., 实体函数没有setof的要求.</div><div>8. 一个plproxy中只能出现一条connect语句, 否则报错.</div><div><div>digoal=# create or replace function f_test3() returns setof int8 as $$</div><div>&nbsp; connect 'hostaddr=172.16.3.150 dbname=db0 user=digoal port=1921'; &nbsp;</div><div>&nbsp; connect 'hostaddr=172.16.3.150 dbname=db1 user=digoal port=1921'; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>&nbsp; select count(*) from pg_class;</div><div>$$ language plproxy strict;</div><div>ERROR: &nbsp;PL/Proxy function postgres.f_test3(0): Compile error at line 2: Only one CONNECT statement allowed</div></div><div>9. 不要把plproxy语言的权限赋予给普通用户, 因为开放了trust认证, 如果再开放plproxy语言的权限是非常危险的.</div><div>正确的做法是使用超级用户创建plproxy函数, 然后把函数的执行权限赋予给普通用户.</div><div>千万不要这样省事 :&nbsp;</div><div>update pg_language set lanpltrusted='t' where lanname='plproxy';</div><div>10. 如果有全局唯一的序列需求, 可以将序列的步调调整一下, 每个数据节点使用不同的初始值.</div><div>例如&nbsp;</div><div><div>db0=# create sequence seq1 increment by 4 start with 0;</div><div>CREATE SEQUENCE</div></div><div>db1=# create sequence seq1 increment by 4 start with 1;</div><div><span style="line-height: 28px;"   >db2=# create sequence seq1 increment by 4 start with 2;</span></div><div><span style="line-height: 28px;"   >db3=# create sequence seq1 increment by 4 start with 3;</span></div><div><span style="line-height: 28px;"   >考虑到扩容, 可以将步调调比较大, 例如1024. 那么可以容纳1024个节点.</span></div><div><span style="line-height: 28px;"   >...</span></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://kaiv.wordpress.com/2007/07/27/postgresql-cluster-partitioning-with-plproxy-part-i/"   >http://kaiv.wordpress.com/2007/07/27/postgresql-cluster-partitioning-with-plproxy-part-i/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://kaiv.wordpress.com/2007/09/02/postgresql-cluster-partitioning-with-plproxy-part-ii/"   >http://kaiv.wordpress.com/2007/09/02/postgresql-cluster-partitioning-with-plproxy-part-ii/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201041111304328/"   >http://blog.163.com/digoal@126/blog/static/163877040201041111304328/</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402010411113114315/"   >http://blog.163.com/digoal@126/blog/static/1638770402010411113114315/</a></div><div>5.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201192535630895/"   >http://blog.163.com/digoal@126/blog/static/163877040201192535630895/</a></div><div>6.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/libpq-connect.html#LIBPQ-CONNSTRING"   >http://www.postgresql.org/docs/9.3/static/libpq-connect.html#LIBPQ-CONNSTRING</a></div><div>7.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=plproxy.git;a=summary"   >http://git.postgresql.org/gitweb/?p=plproxy.git;a=summary</a></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="plproxy 2.x fast deployment - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">chinesejie - 2014-02-19 20:24:50</h5>
				<div>请教博主，某个数据节点坏了怎么办？<br></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 chinesejie - 2014-02-19 20:24:50</h5>
				<div style="width:600px;">还原坏的数据节点的数据.<div>使用pl/proxy部署分布式系统, 如果有跨库事务的话, 这种情况作数据恢复, 全局一致性无法得到保障.</div><div>如果需要全局一致性, 使用pg-xc.</div><div>另一种方法是自行维护一套全局事务管理系统, 包括全局事务ID, 各子系统的事务ID, 事务镜像等信息 会很繁琐.</div><div>建议使用pl/proxy同时需要全局一致性的话, 每个节点部署同步流复制比较好.</div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">chinesejie 回复 德哥@Digoal - 2014-02-19 20:24:50</h5>
				<div style="width:600px;"><div style=""  >使用pl/proxy部署分布式系统, 如果有跨库事务的话, , 使用pg-xc，还能保证全局一致性吗？</div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 chinesejie - 2014-02-19 20:24:50</h5>
				<div style="width:600px;">pg-xc有全局事务管理模块, 可以保证一致性.&nbsp;</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">chinesejie 回复 德哥@Digoal - 2014-02-19 20:24:50</h5>
				<div style="width:600px;">恩。。谢谢博主。这可能正是我 找的 plproxy跨库 事务管理的解决方案，去试下。</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 chinesejie - 2014-02-19 20:24:50</h5>
				<div style="width:600px;">pg-xc的架构你可以了解一下, 但是不推荐直接使用.<div>pg-xc目前的GTM效率并不高.</div></div>
			</div>
	</div>
</div>
</body>
</html>