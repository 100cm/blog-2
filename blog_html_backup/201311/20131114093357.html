<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap examples, Network - 2 Tracing Functions Called in Network Socket Code</h2>
	<h5 id="">2013-11-14 9:33:57&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013101485859717/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>这个例子来自socket-trace.stp&nbsp;脚本, 跟踪内核中函数在net/socket.c代码中的调用和返回, 帮助用户从内核层面了解进程和网络的交互情况.</div><div>脚本内容以及注解</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 network]# cd /usr/share/systemtap/testsuite/systemtap.examples/network</font></div><div><div><font size="2"   >[root@db-172-16-3-150 network]# cat socket-trace.stp&nbsp;</font></div><div><font size="2"   >#!/usr/bin/stap</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe kernel.function("*@net/socket.c").call {</font></div><div><font size="2"   >&nbsp; printf ("%s -&gt; %s\n", thread_indent(1), probefunc())</font></div><div><font size="2"   >}</font></div><div><font size="2"   >//&nbsp;<span style="line-height: 28px;"   >kernel.function("*@net/socket.c").call探针, 用了*通配符,&nbsp;</span><span style="line-height: 28px;"   >net/socket.c</span><span style="line-height: 28px;"   >所有函数的调用都会触发这个探针.</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   >//&nbsp;</span><span style="line-height: 28px;"   >thread_indent(1), 同一个线程, 每次执行</span><span style="line-height: 28px;"   >thread_indent时</span><span style="line-height: 28px;"   >加1个空格.&nbsp;</span></font></div><div><font size="2"   >probe kernel.function("*@net/socket.c").return {</font></div><div><font size="2"   >&nbsp; printf ("%s &lt;- %s\n", thread_indent(-1), probefunc())</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   ><span style="line-height: 28px;"   >//&nbsp;</span><span style="line-height: 28px;"   >thread_indent(-1), 与函数调用相反, 函数返回时, 这里同一个线程, 每次执行</span><span style="line-height: 28px;"   >thread_indent时减</span><span style="line-height: 28px;"   >1个空格.&nbsp;</span></font></div><div><span style="line-height: 28px;"   ><font size="2"   >// 这样的话更容易看清除调用和返回的层次.</font></span></div><div><font size="2"   ><span style="line-height: 28px;"   >//&nbsp;</span><span style="line-height: 28px;"   >probefunc()函数用于输出当前地址对应的函数名. 从内核符号表中根据地址取出函数名.</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   >// 参考</span><a style="line-height: 28px;" href="http://blog.163.com/digoal@126/blog/static/1638770402013101381844107/"   >http://blog.163.com/digoal@126/blog/static/1638770402013101381844107/</a></font></div><div><font size="2"   >//&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-probefunc.html"   >https://sourceware.org/systemtap/tapsets/API-probefunc.html</a></font></div><p></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >执行输出举例</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 network]# stap ./socket-trace.stp&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 init(1): -&gt; sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; 15 init(1): &lt;- do_select</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 init(1): -&gt; sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;4 init(1): &lt;- do_select</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 portreserve(1545): -&gt; sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;9 portreserve(1545): &lt;- do_select</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 udevd(1168): -&gt; sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 rpc.statd(1726): -&gt; sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;8 rpc.statd(1726): &lt;- do_select</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 rpc.statd(1726): -&gt; sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;3 rpc.statd(1726): &lt;- do_select</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 rpc.statd(1726): -&gt; sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;4 rpc.statd(1726): &lt;- do_select</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 rpc.statd(1726): -&gt; sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;3 rpc.statd(1726): &lt;- do_select</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 rpcbind(1595): -&gt; sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;9 rpcbind(1595): &lt;- do_sys_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 rpcbind(1595): -&gt; sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;4 rpcbind(1595): &lt;- do_sys_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 init(1): -&gt; sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;4 init(1): &lt;- do_select</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 init(1): -&gt; sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 rpcbind(1595): -&gt; sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;4 rpcbind(1595): &lt;- do_sys_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 rpcbind(1595): -&gt; sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; 14 init(1): &lt;- do_select</font></div><div><font size="2"   >&nbsp; &nbsp; 95 udevd(1168): &lt;- do_sys_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 rpc.statd(1726): -&gt; sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; 14 rpcbind(1595): &lt;- do_sys_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 rpcbind(1595): -&gt; sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 hald-addon-inpu(1874): -&gt; sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; 14 rpcbind(1595): &lt;- do_sys_poll</font></div><div><font size="2"   >&nbsp; &nbsp; 25 rpc.statd(1726): &lt;- do_select</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >probefunc()函数使用</span>symname(addr) 或者 usymname(uaddr) 函数从内核表中取出对应的函数名:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 network]# cat /boot/System.map-2.6.32-358.el6.x86_64 |grep sock_poll</font></div><div><font size="2"   >ffffffff81431450 t sock_poll</font></div><p></p></pre></div><div>例如把<span style="line-height: 28px;"   >socket-trace.stp 改一下, 同时输出当前探针的地址信息, 则更可以看出</span><span style="line-height: 28px;"   >probefunc()是通过符号表把地址转换成函数名的.</span></div><div><span style="line-height: 28px;"   >如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 network]# vi socket-trace.stp&nbsp;</font></div><div><div><font size="2"   >#!/usr/bin/stap</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe kernel.function("*@net/socket.c").call {</font></div><div><font size="2"   >&nbsp; printf ("%s -&gt; %p, %s\n", thread_indent(1), addr(), probefunc())</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe kernel.function("*@net/socket.c").return {</font></div><div><font size="2"   >&nbsp; printf ("%s &lt;- %p, %s\n", thread_indent(-1), addr(), probefunc())</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-150 network]# stap ./socket-trace.stp&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 init(1): -&gt; 0xffffffff81431450, sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; 17 init(1): &lt;- 0xffffffff81197f42, do_select</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 init(1): -&gt; 0xffffffff81431450, sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;4 init(1): &lt;- 0xffffffff81197f42, do_select</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 NetworkManager(1694): -&gt; 0xffffffff81431450, sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; 15 NetworkManager(1694): &lt;- 0xffffffff8119764b, do_sys_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 NetworkManager(1694): -&gt; 0xffffffff81431450, sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;5 NetworkManager(1694): &lt;- 0xffffffff8119764b, do_sys_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 NetworkManager(1694): -&gt; 0xffffffff81431450, sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;5 NetworkManager(1694): &lt;- 0xffffffff8119764b, do_sys_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 NetworkManager(1694): -&gt; 0xffffffff81431450, sock_poll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;4 NetworkManager(1694): &lt;- 0xffffffff8119764b, do_sys_poll</font></div></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >[参考]</span></div><div>1. /usr/share/systemtap/testsuite/systemtap.examples</div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/useful-systemtap-scripts.html"   >https://sourceware.org/systemtap/SystemTap_Beginners_Guide/useful-systemtap-scripts.html</a></div><div>3. systemtap-testsuite</div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://sourceware.org/systemtap/examples/"   >https://sourceware.org/systemtap/examples/</a></div><div>5. /usr/share/systemtap/testsuite/systemtap.examples/index.txt</div><div>6. /usr/share/systemtap/testsuite/systemtap.examples/keyword-index.txt</div><div>7.&nbsp;/usr/share/systemtap/tapset</div><div>8.&nbsp;/usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/net/socket.c</div><div>9.&nbsp;<a style="line-height: 28px;" href="http://blog.163.com/digoal@126/blog/static/16387704020131071118496/"   >http://blog.163.com/digoal@126/blog/static/16387704020131071118496/</a></div><div>10.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-probefunc.html"   >https://sourceware.org/systemtap/tapsets/API-probefunc.html</a></div><div>11.&nbsp;<a style="line-height: 28px;" href="http://blog.163.com/digoal@126/blog/static/1638770402013101381844107/"   >http://blog.163.com/digoal@126/blog/static/1638770402013101381844107/</a></div><wbr></div>
	</div>
</div>
</body>
</html>