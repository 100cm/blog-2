<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL explain cost constants alignment to timestamp</h2>
	<h5 id="">2013-11-26 22:09:35&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201310255717379/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>最近在写一个客户的PostgreSQL数据库培训PPT, 其中有explain的讲解需求, 刚刚接触PostgreSQL的童鞋对PostgreSQL的explain输出中cost的部分可能会一头雾水, 看不懂cost的值和SQL实际运行时间有什么联系.</div><div>为了让大家能更加深刻的了解explain, 我打算对explain的cost常量做一次校准, 这个校准的灵感来自天文望远镜赤道仪的校准. PostgreSQL cost常量在校准后, explain 的输出cost就会非常接近真实执行的时间.</div><div>接下来我们就来看一看如何校准PostgreSQL COST常量.</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/runtime-config-query.html#RUNTIME-CONFIG-QUERY-CONSTANTS"   >http://www.postgresql.org/docs/9.3/static/runtime-config-query.html#RUNTIME-CONFIG-QUERY-CONSTANTS</a></div><div>在赤道仪的校准中, 要用到北极星以及至少一颗已知赤经赤纬的亮星.</div><div>同样, 在PostgreSQL COST的校准中, 要用到的是已知算法以及真实的数据. 利用真实的数据和公式, 求出未知数, 达到校准的目的.</div><div>已知的数据可以来自硬件厂商或者自行测试得到, 已知的cost值算法则可以参考PostgreSQL手册或源代码.</div><div>src/backend/optimizer/path/costsize.c</div><div>PostgreSQL的cost常量如下 :&nbsp;</div><div>seq_page_cost &nbsp;-- 连续块扫描操作的单个块的cost. 例如全表扫描</div><div>random_page_cost &nbsp;-- 随机<span style="line-height: 28px;"   >块扫描操作的单个块的cost. 例如索引扫描</span></div><div>cpu_tuple_cost &nbsp;-- 处理每条记录的CPU开销</div><div>cpu_index_tuple_cost &nbsp;-- 扫描每个索引条目带来的CPU开销</div><div>cpu_operator_cost &nbsp;-- 操作符或函数带来的CPU开销.(需要注意函数以及操作符对应的函数的三态, 执行计划会根据三态做优化, 关系到多条记录时三态对应的调用次数是需要关心的)</div><div>接下来举例说明如何校对这几个常量.</div><div><br></div><div>1. 推算<span style="line-height: 28px;"   >seq_page_cost 以及&nbsp;</span><span style="line-height: 28px;"   >cpu_tuple_cost</span></div><div>创建测试表</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table tbl_cost_align (id int, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div>插入测试数据, 这里插入的ID为随机数, 这样的话可以使得我们后面要做的离散IO请求测试更准确一些.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into tbl_cost_align select (random()*2000000000)::int, md5(random()::text), clock_timestamp() from generate_series(1,100000);</font></div><div><font size="2"   >INSERT 0 100000</font></div><div><font size="2"   >digoal=# insert into tbl_cost_align select (random()*2000000000)::int, md5(random()::text), clock_timestamp() from generate_series(1,10000000);</font></div><div><font size="2"   >INSERT 0 10000000</font></div><p></p></pre></div><div>分析表, 获得统计信息</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# analyze tbl_cost_align;</font></div><div><font size="2"   >ANALYZE</font></div><p></p></pre></div><div>可以查看到占用的数据块个数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select relpages from pg_class where relname='tbl_cost_align';</font></div><div><font size="2"   >&nbsp;relpages&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; 94393</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>执行checkpoint后关闭数据库, 为了得到一个纯粹的物理磁盘的连续io请求的cost常量, 不能有shared buffer的干扰.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; pg_ctl stop -m fast</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div><p></p></pre></div><div>同时还不能有OS Cache的干扰, 所以要清理操作系统cache.</div><div>[root@db-172-16-3-150 ssd1]# sync;&nbsp;<span style="line-height: 28px;"   >echo 3 &gt; /proc/sys/vm/drop_caches</span></div><div>前面我们说了, 有些指标可以通过硬件厂商得到或者自行测试得到, 那么这里我们就要自己测试得到.</div><div>测试方法比较多, 本文将通过systemtap来得到每次IO请求的时间.</div><div>为了降低systemtap带来的额外开销, 请参考 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402013102610150692/"   >http://blog.163.com/digoal@126/blog/static/1638770402013102610150692/</a></div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402013102621826954/"   >http://blog.163.com/digoal@126/blog/static/1638770402013102621826954/</a></div><div>指定亲和1, 启动数据库 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; taskset -c 1 /home/pg93/pgsql9.3.1/bin/postgres &gt;/dev/null 2&gt;&amp;1</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >开启psql</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.3.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select pg_backend_pid();</font></div><div><font size="2"   >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5727</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>指定亲和7, 开启stap, 收集postgres进程相关的io信息.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# taskset -c 7 stap -e '</font></div><div><font size="2"   >global a</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__start") {</font></div><div><font size="2"   >&nbsp; delete a</font></div><div><font size="2"   >&nbsp; println("query__start ", user_string($arg1), "pid:", pid())</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe vfs.read.return {</font></div><div><font size="2"   >&nbsp; t = gettimeofday_ns() - @entry(gettimeofday_ns())</font></div><div><font size="2"   >&nbsp; # if (execname() == "postgres" &amp;&amp; devname != "N/A")</font></div><div><font size="2"   >&nbsp; &nbsp; a[pid()] &lt;&lt;&lt; t</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__done") {</font></div><div><font size="2"   >&nbsp; if (@count(a[pid()]))&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; printdln("**", pid(), @count(a[pid()]), @avg(a[pid()]))</font></div><div><font size="2"   >&nbsp; println("query__done ", user_string($arg1), "pid:", pid())</font></div><div><font size="2"   >&nbsp; if (@count(a[pid()])) {</font></div><div><font size="2"   >&nbsp; &nbsp; println(@hist_log(a[pid()]))</font></div><div><font size="2"   >&nbsp; &nbsp; #println(@hist_linear(a[pid()],1024,4096,100))</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >&nbsp; delete a</font></div><div><font size="2"   >}' -x 5727</font></div><p></p></pre></div><div>接下来在psql中执行explain analyze, 在explain的结果中可以得到一个值, 实际的执行时间(<span style="line-height: 28px;"   >3260.695</span><span style="line-height: 28px;"   >&nbsp;-</span><span style="line-height: 28px;"   >0.839</span><span style="line-height: 28px;"   >).</span></div><div><span style="line-height: 28px;"   >并且可以得到原始的cost(</span><span style="line-height: 28px;"   >195393.00</span><span style="line-height: 28px;"   >), 这个原始的cost有助于验证公式是否正确.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----</font></div><div><font size="2"   >&nbsp;Seq Scan on postgres.tbl_cost_align &nbsp;(cost=0.00..195393.00 rows=10100000 width=45) (actual time=0.839..3260.695 rows=10100000 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared read=94393 &nbsp;-- 注意这个read指的是未命中shared buffer, 如果是命中的话会有hit=?</font></div><div><font size="2"   >&nbsp;Total runtime: 4325.885 ms</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >执行完explain之后, 在stap输出中得到了我们想要的平均IO响应时间信息(</span><span style="line-height: 28px;"   >14329</span><span style="line-height: 28px;"   >).</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >query__start explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:5727</font></div><div><font size="2"   >5727**94417**14329</font></div><div><font size="2"   >query__done explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:5727</font></div><div><font size="2"   >&nbsp; value |-------------------------------------------------- count</font></div><div><font size="2"   >&nbsp; &nbsp;1024 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp;2048 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp;4096 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 153</font></div><div><font size="2"   >&nbsp; &nbsp;8192 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ &nbsp;86293</font></div><div><font size="2"   >&nbsp; 16384 |@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1864</font></div><div><font size="2"   >&nbsp; 32768 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 116</font></div><div><font size="2"   >&nbsp; 65536 |@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5918</font></div><div><font size="2"   >&nbsp;131072 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;59</font></div><div><font size="2"   >&nbsp;262144 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 7</font></div><div><font size="2"   >&nbsp;524288 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3</font></div><div><font size="2"   >1048576 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2</font></div><div><font size="2"   >2097152 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2</font></div><div><font size="2"   >4194304 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >8388608 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><p></p></pre></div><div>收集到以上数据后, 首先验证公式的正确性. 验证公式前, 需要解读explain的输出. 以及现有的2个常量.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# show seq_page_cost;</font></div><div><font size="2"   >&nbsp;seq_page_cost&nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# show cpu_tuple_cost;</font></div><div><font size="2"   >&nbsp;cpu_tuple_cost&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;0.01</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>公式正确 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 28px;"   >195393 = (</span><span style="line-height: 28px;"   >shared read=)94393*1(</span><span style="line-height: 28px;"   >seq_page_cost</span><span style="line-height: 28px;"   >) + (</span><span style="line-height: 28px;"   >rows=)10100000*</span><span style="line-height: 28px;"   >0.01(</span><span style="line-height: 28px;"   >cpu_tuple_cost)</span></font></div><div><div><font size="2"   >digoal=# select 94393+10100000*0.01;</font></div><div><font size="2"   >&nbsp;?column? &nbsp;</font></div><div><font size="2"   >-----------</font></div><div><font size="2"   >&nbsp;195393.00</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>那么从stap中我们得到io的平均响应时间是<span style="line-height: 28px;"   >14329纳秒(</span>0.014329毫秒<span style="line-height: 28px;"   >). 真实的执行时间是(</span><span style="line-height: 28px;"   >3260.695</span><span style="line-height: 28px;"   >&nbsp;-</span><span style="line-height: 28px;"   >0.839</span><span style="line-height: 28px;"   >).</span></div><div><span style="line-height: 28px;"   >套用到公式中.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 28px;"   >3260.695</span><span style="line-height: 28px;"   >&nbsp;-</span><span style="line-height: 28px;"   >0.839 =&nbsp;</span><span style="line-height: 28px;"   >94393*</span><span style="line-height: 28px;"   >0.014329 +&nbsp;</span><span style="line-height: 28px;"   >10100000*x</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   >x =&nbsp;</span>0.00018884145574257426</font></div><p></p></pre></div><div>接下来要做的是调整<span style="line-height: 28px;"   >seq_page_cost和</span><span style="line-height: 28px;"   >cpu_tuple_cost, 重新执行SQL.</span></div><div><div style="line-height: 28px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# set seq_page_cost=0.014329;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# set cpu_tuple_cost=0.00018884145574257426;</font></div><div><font size="2"   >SET</font></div><p></p></pre></div><div>重新执行SQL后, 我们看到评估出来的COST是<span style="line-height: 28px;"   >3259.86, 实际的执行时间是</span><span style="line-height: 28px;"   >1599.507ms.</span></div><div><span style="line-height: 28px;"   >不一致是因为现在用到了shared buffer, 已经没有直接读硬盘或者OS CACHE了.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >--</font></div><div><font size="2"   >&nbsp;Seq Scan on postgres.tbl_cost_align &nbsp;(cost=0.00..3259.86 rows=10100000 width=45) (actual time=0.011..1599.507 rows=10100000 loops=1</font></div><div><font size="2"   >)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=94393</font></div><div><font size="2"   >&nbsp;Total runtime: 2617.152 ms</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div></div><div style="line-height: 28px;"   >可以重启数据库并清除CACHE来测试, 一定会得到满意的答案.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; taskset -c 1 /home/pg93/pgsql9.3.1/bin/postgres &gt;/dev/null 2&gt;&amp;1</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# sync; echo 3 &gt; /proc/sys/vm/drop_caches</font></div><div><div><font size="2"   >digoal=# set seq_page_cost=0.014329;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# set cpu_tuple_cost=0.00018884145574257426;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >--</font></div><div><font size="2"   >&nbsp;Seq Scan on postgres.tbl_cost_align &nbsp;(cost=0.00..3259.86 rows=10100000 width=45) (actual time=0.915..3318.443 rows=10100000 loops=1</font></div><div><font size="2"   >)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared read=94393</font></div><div><font size="2"   >&nbsp;Total runtime: 4380.828 ms</font></div><div><font size="2"   >(4 rows)</font></div></div><p></p></pre></div><div>现在是完全从硬盘读取, 所以得出的cost就和实际执行时间相当接近了<span style="line-height: 28px;"   >3259.86 VS (</span><span style="line-height: 28px;"   >3318.443</span><span style="line-height: 28px;"   >&nbsp;-&nbsp;</span><span style="line-height: 28px;"   >0.915</span><span style="line-height: 28px;"   >)</span><span style="line-height: 28px;"   >.</span></div><div style="line-height: 28px;"   ><br></div></div><div><span style="line-height: 28px;"   >2.&nbsp;</span><span style="line-height: 28px;"   >推算</span><span style="line-height: 28px;"   >random_page_cost&nbsp;</span><span style="line-height: 28px;"   >以及&nbsp;</span><span style="line-height: 28px;"   >cpu_index_tuple_cost ,&nbsp;</span>cpu_operator_cost</div><div><span style="line-height: 28px;"   >random_page_cost 本文还是通过stap跟踪来获得.</span></div><div><span style="line-height: 28px;"   >cpu_index_tuple_cost 和&nbsp;</span><span style="line-height: 28px;"   >cpu_operator_cost 两个未知数不是很好推算, 基本上出现</span><span style="line-height: 28px;"   >cpu_index_tuple_cost</span><span style="line-height: 28px;"   >&nbsp;的场景, 另一个</span><span style="line-height: 28px;"   >cpu_operator_cost</span><span style="line-height: 28px;"   >&nbsp;也出现了, 所以</span><span style="line-height: 28px;"   >2个未知数都是同时出现. &nbsp;</span></div><div><span style="line-height: 28px;"   >那么我们只能给他们来个比例. 或者能够直接跟踪到其中的一个未知数, 才能得出另一个未知数.</span></div><div><span style="line-height: 28px;"   >本文利用</span><span style="line-height: 28px;"   >cpu_index_tuple_cost 和&nbsp;</span><span style="line-height: 28px;"   >cpu_operator_cost的默认占比来求得这两个值.</span></div><div><span style="line-height: 28px;"   >首先我们还是要确定公式, 为了方便公式验证, 把所有的常量都设置为1.</span></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >digoal=# set random_page_cost=1;</font></div><div style="line-height: 28px;"   ><font size="2"   >SET</font></div><div style="line-height: 28px;"   ><font size="2"   >digoal=# set cpu_tuple_cost=1;</font></div><div style="line-height: 28px;"   ><font size="2"   >SET</font></div><div style="line-height: 28px;"   ><div><font size="2"   >digoal=# set cpu_index_tuple_cost=1;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# set cpu_operator_cost=1;</font></div><div><font size="2"   >SET</font></div></div><div style="line-height: 28px;"   ><div><font size="2"   >digoal=# set enable_seqscan=off; set enable_bitmapscan=off; explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align where id&gt;1998999963;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >-------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using idx_tbl_cost_align_id on postgres.tbl_cost_align &nbsp;(cost=174.00..20181.67 rows=5031 width=45) (actual time=0.029..1</font></div><div><font size="2"   >7.773 rows=5037 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: (tbl_cost_align.id &gt; 1998999963)</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=5054</font></div><div><font size="2"   >&nbsp;Total runtime: 18.477 ms</font></div><div><font size="2"   >(5 rows)</font></div></div><p></p></pre></div><div style="line-height: 28px;"   >执行计划表明这是个索引扫描, 至于扫了多少个数据块是未知的, 索引的tuples也是未知的, 已知的是cost和rows.</div><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >20181.67 = blocks*<span style="line-height: 28px;"   >random_page_cost +&nbsp;</span><span style="line-height: 28px;"   >cpu_tuple_cost*</span><span style="line-height: 28px;"   >5031 +&nbsp;</span><span style="line-height: 28px;"   >cpu_index_tuple_cost*5031 +&nbsp;</span><span style="line-height: 28px;"   >cpu_operator_cost*?</span></font></div><div style="line-height: 28px;"   ></div><p></p></pre><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >求这个问号, 可以通过更改</span><span style="line-height: 28px;"   >cpu_operator_cost来得到.</span></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >digoal=# set cpu_operator_cost=2;</font></div><div style="line-height: 28px;"   ><font size="2"   >SET</font></div><div style="line-height: 28px;"   ><font size="2"   >digoal=# set enable_seqscan=off; set enable_bitmapscan=off; explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align where id&gt;1998999963;</font></div><div style="line-height: 28px;"   ><font size="2"   >SET</font></div><div style="line-height: 28px;"   ><font size="2"   >SET</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div style="line-height: 28px;"   ><font size="2"   >------------------------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;Index Scan using idx_tbl_cost_align_id on postgres.tbl_cost_align &nbsp;(cost=348.00..25386.67 rows=5031 width=45) (actual time=0.013..5</font></div><div style="line-height: 28px;"   ><font size="2"   >.785 rows=5037 loops=1)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Index Cond: (tbl_cost_align.id &gt; 1998999963)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=5054</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;Total runtime: 6.336 ms</font></div><div style="line-height: 28px;"   ><font size="2"   >(5 rows)</font></div><p></p></pre></div><div>25386.67-20181.67 =&nbsp;5205 得到本例通过索引扫描的条数. 等式就变成了</div></div></div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 28px;"   >20181.67 = blocks*</span><span style="line-height: 28px;"   >random_page_cost +&nbsp;</span><span style="line-height: 28px;"   >cpu_tuple_cost*</span><span style="line-height: 28px;"   >5031 +&nbsp;</span><span style="line-height: 28px;"   >cpu_index_tuple_cost*5031 +&nbsp;</span><span style="line-height: 28px;"   >cpu_operator_cost*5205</span></font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >接下来要求blocks, 也就是扫描的随机页数.</span></div><div><span style="line-height: 28px;"   >通过调整</span><span style="line-height: 28px;"   >random_page_cost得到.</span></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >digoal=# set random_page_cost = 2;</font></div><div style="line-height: 28px;"   ><font size="2"   >SET</font></div><div style="line-height: 28px;"   ><font size="2"   >digoal=# set enable_seqscan=off; set enable_bitmapscan=off; explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align where id&gt;1998999963;</font></div><div style="line-height: 28px;"   ><font size="2"   >SET</font></div><div style="line-height: 28px;"   ><font size="2"   >SET</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div style="line-height: 28px;"   ><font size="2"   >------------------------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;Index Scan using idx_tbl_cost_align_id on postgres.tbl_cost_align &nbsp;(cost=348.00..30301.33 rows=5031 width=45) (actual time=0.013..5</font></div><div style="line-height: 28px;"   ><font size="2"   >.778 rows=5037 loops=1)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Index Cond: (tbl_cost_align.id &gt; 1998999963)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=5054</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;Total runtime: 6.331 ms</font></div><div style="line-height: 28px;"   ><font size="2"   >(5 rows)</font></div><div><font size="2"   >30301.33-25386.67 =&nbsp;4914.66</font></div><p></p></pre></div></div><div>得到<span style="line-height: 28px;"   >blocks =&nbsp;</span><span style="line-height: 28px;"   >4914.66.</span></div><div>更新等式 &nbsp;:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 28px;"   >20181.67 =&nbsp;</span><span style="line-height: 28px;"   >4914.66</span><span style="line-height: 28px;"   >*</span><span style="line-height: 28px;"   >random_page_cost +&nbsp;</span><span style="line-height: 28px;"   >cpu_tuple_cost*</span><span style="line-height: 28px;"   >5031 +&nbsp;</span><span style="line-height: 28px;"   >cpu_index_tuple_cost*5031 +&nbsp;</span><span style="line-height: 28px;"   >cpu_operator_cost*5205</span></font></div><div></div><p></p></pre></div><div><span style="line-height: 28px;"   >接下来要做的是通过stap统计出</span><span style="line-height: 28px;"   >random_page_cost.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; taskset -c 1 /home/pg93/pgsql9.3.1/bin/postgres &gt;/dev/null 2&gt;&amp;1</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# sync; echo 3 &gt; /proc/sys/vm/drop_caches</font></div><div><div><font size="2"   >digoal=# select pg_backend_pid();</font></div><div><font size="2"   >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 10009</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-150 ~]# taskset -c 2 stap -e '</font></div><div><font size="2"   >global a</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__start") {</font></div><div><font size="2"   >&nbsp; delete a</font></div><div><font size="2"   >&nbsp; println("query__start ", user_string($arg1), "pid:", pid())</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe vfs.read.return {</font></div><div><font size="2"   >&nbsp; t = gettimeofday_ns() - @entry(gettimeofday_ns())</font></div><div><font size="2"   >&nbsp; # if (execname() == "postgres" &amp;&amp; devname != "N/A")</font></div><div><font size="2"   >&nbsp; &nbsp; a[pid()] &lt;&lt;&lt; t</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__done") {</font></div><div><font size="2"   >&nbsp; if (@count(a[pid()]))&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; printdln("**", pid(), @count(a[pid()]), @avg(a[pid()]))</font></div><div><font size="2"   >&nbsp; println("query__done ", user_string($arg1), "pid:", pid())</font></div><div><font size="2"   >&nbsp; if (@count(a[pid()])) {</font></div><div><font size="2"   >&nbsp; &nbsp; println(@hist_log(a[pid()]))</font></div><div><font size="2"   >&nbsp; &nbsp; #println(@hist_linear(a[pid()],1024,4096,100))</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >&nbsp; delete a</font></div><div><font size="2"   >}' -x 10009</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# set enable_seqscan=off; set enable_bitmapscan=off; explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align where id&gt;1998999963;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using idx_tbl_cost_align_id on postgres.tbl_cost_align &nbsp;(cost=0.43..5003.15 rows=5031 width=45) (actual time=0.609..1844</font></div><div><font size="2"   >.415 rows=5037 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: (tbl_cost_align.id &gt; 1998999963)</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=152 read=4902</font></div><div><font size="2"   >&nbsp;Total runtime: 1846.683 ms</font></div><div><font size="2"   >(5 rows)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >query__start explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align where id&gt;1998999963;pid:10009</font></div><div><font size="2"   >10009**4946**368362</font></div><div><font size="2"   >query__done explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align where id&gt;1998999963;pid:10009</font></div><div><font size="2"   >&nbsp; &nbsp;value |-------------------------------------------------- count</font></div><div><font size="2"   >&nbsp; &nbsp; 2048 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >&nbsp; &nbsp; 4096 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >&nbsp; &nbsp; 8192 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 33</font></div><div><font size="2"   >&nbsp; &nbsp;16384 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >&nbsp; &nbsp;32768 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6</font></div><div><font size="2"   >&nbsp; &nbsp;65536 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4</font></div><div><font size="2"   >&nbsp; 131072 |@@@@@@@@@@@@@@@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1193</font></div><div><font size="2"   >&nbsp; 262144 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ &nbsp;2971</font></div><div><font size="2"   >&nbsp; 524288 |@@@@@@@@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;729</font></div><div><font size="2"   >&nbsp;1048576 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >&nbsp;2097152 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5</font></div><div><font size="2"   >&nbsp;4194304 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >&nbsp;8388608 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >16777216 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >33554432 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div></div><p></p></pre></div><div><br></div><div><br></div><div>更新等式, 使用时间等式 :&nbsp;</div><div>等式1 :</div><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >1844<span style="line-height: 28px;"   >.415</span><span style="line-height: 28px;"   >&nbsp;=&nbsp;</span><span style="line-height: 28px;"   >4914.66</span><span style="line-height: 28px;"   >*</span><span style="line-height: 28px;"   >0.368362&nbsp;+&nbsp;</span><span style="line-height: 28px;"   >0.00018884145574257426</span><span style="line-height: 28px;"   >*</span><span style="line-height: 28px;"   >5031 +&nbsp;</span><span style="line-height: 28px;"   >cpu_index_tuple_cost*5031 +&nbsp;</span><span style="line-height: 28px;"   >cpu_operator_cost*5205</span></font></div><div></div><p></p></pre><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >cpu_tuple_cost用例子1中计算得到的</span><span style="line-height: 28px;"   >0.00018884145574257426</span></div><div><span style="line-height: 28px;"   >cpu_index_tuple_cost和</span><span style="line-height: 28px;"   >cpu_operator_cost的比例用系统默认的2 : 1.</span></div><div><span style="line-height: 28px;"   >等式2 :&nbsp;</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 28px;"   >cpu_index_tuple_cost/</span><span style="line-height: 28px;"   >cpu_operator_cost = 2</span></font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >最终得到 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 28px;"   >cpu_index_tuple_cost =&nbsp;</span>0.00433497085216479990</font></div><div><font size="2"   ><span style="line-height: 28px;"   >cpu_operator_cost</span><span style="line-height: 28px;"   >&nbsp;=&nbsp;</span>0.00216748542608239995</font></div><p></p></pre></div><div><br></div><div>结合例子1 得到的两个常量, 所有的5个常量值就调整好了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# set cpu_tuple_cost=0.00018884145574257426;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# set cpu_index_tuple_cost = 0.00433497085216479990;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# set cpu_operator_cost = 0.00216748542608239995;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# set seq_page_cost=0.014329;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# set random_page_cost = 0.368362;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# set enable_seqscan=off; set enable_bitmapscan=off; explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align where id&gt;1998999963;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using idx_tbl_cost_align_id on postgres.tbl_cost_align &nbsp;(cost=0.38..1844.42 rows=5031 width=45) (actual time=0.553..1346</font></div><div><font size="2"   >.468 rows=5037 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: (tbl_cost_align.id &gt; 1998999963)</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=152 read=4902</font></div><div><font size="2"   >&nbsp;Total runtime: 1348.428 ms</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div><div><br></div><div>以后使用调整后的cost常量, 就可以估算出SQL的真实执行时间, 真实执行时间会因为shared buffer hit以及os cache比explain得到的值略短, 但是已经非常接近了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# set enable_seqscan=off; set enable_bitmapscan=off; explain select * from tbl_cost_align where id&gt;1998999963;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using idx_tbl_cost_align_id on tbl_cost_align &nbsp;(cost=0.38..1844.42 rows=5031 width=45)</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: (id &gt; 1998999963)</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/runtime-config-query.html#RUNTIME-CONFIG-QUERY-CONSTANTS"   >http://www.postgresql.org/docs/9.3/static/runtime-config-query.html#RUNTIME-CONFIG-QUERY-CONSTANTS</a></div><div>2.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/sql-createfunction.html"   >http://www.postgresql.org/docs/9.3/static/sql-createfunction.html</a></div><div>3.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/sql-explain.html"   >http://www.postgresql.org/docs/9.3/static/sql-explain.html</a></div><div>4.&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/sql-altertable.html"   >http://www.postgresql.org/docs/9.3/static/sql-altertable.html</a></div><div>5.&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/using-explain.html"   >http://www.postgresql.org/docs/9.3/static/using-explain.html</a></div><div>6.&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/sql-alterdatabase.html"   >http://www.postgresql.org/docs/9.3/static/sql-alterdatabase.html</a></div><div>7.&nbsp;<a target="_blank" rel="nofollow" href="https://sourceware.org/systemtap/tapsets"   >https://sourceware.org/systemtap/tapsets</a></div><div>8.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/dynamic-trace.html"   >http://www.postgresql.org/docs/9.3/static/dynamic-trace.html</a></div><div>9.&nbsp;src/backend/optimizer/path/costsize.c</div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL explain cost constants alignment to timestamp - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">alexsunchenchen - 2014-04-10 22:28:25</h5>
				<div>有点晕。。。云主机默认配置不允许换内核，没法systemtap，还得弄虚拟机才行了~</div>
			</div>
	</div>
</div>
</body>
</html>