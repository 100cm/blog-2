<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL monitor - customize nagios script</h2>
	<h5 id="">2013-06-05 21:23:05&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020135562545536/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">前一个章节介绍了使用bucardo提供的check_postgres脚本和nagios来监控数据库.&nbsp;<div>本文主要介绍如何编写自定义监控脚本.</div><div>在编写自定义脚本前首先要搞清楚nagios的判断标准.</div><div>1. 脚本的返回值</div><div>nagios根据脚本返回值来输出该监控服务的状态. 返回值和状态对应关系如下.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >0 : (OK)</font></div><div><font size="2"   >1 : (WARNING)</font></div><div><font size="2"   >2 : (CRITICAL)</font></div><div><font size="2"   >other : (UNKNOWN)</font></div><p></p></pre></div><div><br></div><div>2. 脚本的标准输出</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --PGBINDIR=/opt/pgsql92/bin --output=nagios --datadir=/pgdata1919 --action=checkpoint -w 300s -c 600s</font></div><div><font size="2"   ><span style="line-height: 22px;"   >POSTGRES_CHECKPOINT CRITICAL: &nbsp;Last checkpoint was 11418 seconds ago | age=11418;300;600</span>&nbsp;</font></div><p></p></pre></div><div>以上监控命令的标准输出为</div><div><pre class="prettyprint"   ><p><font size="2"   >POSTGRES_CHECKPOINT CRITICAL: &nbsp;Last checkpoint was 11418 seconds ago | age=11418;300;600</font></p></pre></div><div>注意|这个字符, 这个字符分隔了两部分信息 :</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Status Information</font></div><div><font size="2"   >Performance Data</font></div><p></p></pre></div><div>如图 :&nbsp;</div><div><div><img title="PostgreSQL monitor - customize nagios script - 德哥@Digoal - PostgreSQL"   alt="PostgreSQL monitor - customize nagios script - 德哥@Digoal - PostgreSQL"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/GUe7L6HYaqJIvwID4wUjwg==/3326189799889913849.png"   ></div>&nbsp;</div><div>3. 被监控机上的脚本是在nagios服务端通过check_nrpe远程调用的方式执行的.</div><div>被监控端的nrpe程序以什么用户组执行在如下配置中 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 check_postgres-2.20.0]# cat /etc/xinetd.d/nrpe |grep -E "group|user"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; user &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= pg92</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; group &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = pg92</font></div><p></p></pre></div><div>因此监控脚本需要有以上用户组的可执行权限.</div><div><br></div><div>编写自定义脚本时需要遵循前面提到的3点.</div><div>使用nagios监控常用PostgreSQL监控项举例 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201412763135184/"   >http://blog.163.com/digoal@126/blog/static/163877040201412763135184/</a></div><div><br></div><div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >参考 :&nbsp;</div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >1.&nbsp;<a style="line-height: 22px; text-decoration: none; color: rgb(85, 108, 136);" href="http://blog.163.com/digoal@126/blog/static/1638770402013121102459107/"   >http://blog.163.com/digoal@126/blog/static/1638770402013121102459107/</a></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >2.&nbsp;<a style="line-height: 22px; color: rgb(85, 108, 136); cursor: pointer;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201312241028667/"   >http://blog.163.com/digoal@126/blog/static/163877040201312241028667/</a></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >3.&nbsp;<a style="line-height: 22px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201302714527/"   >http://blog.163.com/digoal@126/blog/static/163877040201302714527/</a></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >4.&nbsp;<a style="line-height: 22px; text-decoration: none; color: rgb(85, 108, 136);" href="http://blog.163.com/digoal@126/blog/static/16387704020130433036377/"   >http://blog.163.com/digoal@126/blog/static/16387704020130433036377/</a></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >5.&nbsp;<a style="line-height: 22px; text-decoration: none; color: rgb(85, 108, 136);" href="http://blog.163.com/digoal@126/blog/static/163877040201292245228613/"   >http://blog.163.com/digoal@126/blog/static/163877040201292245228613/</a></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >6.&nbsp;<a style="line-height: 22px; text-decoration: none; color: rgb(85, 108, 136);" href="http://blog.163.com/digoal@126/blog/static/163877040201141134748660/"   >http://blog.163.com/digoal@126/blog/static/163877040201141134748660/</a></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >7.&nbsp;<a style="line-height: 22px; text-decoration: none; color: rgb(85, 108, 136);" href="http://blog.163.com/digoal@126/blog/static/16387704020116111445381/"   >http://blog.163.com/digoal@126/blog/static/16387704020116111445381/</a></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >8.&nbsp;<a style="line-height: 22px; text-decoration: none; color: rgb(85, 108, 136);" href="http://blog.163.com/digoal@126/blog/static/16387704020130525628988/"   >http://blog.163.com/digoal@126/blog/static/16387704020130525628988/</a></div></div><div><br></div><div><br></div><div><br></div><div><br></div><div><br></div><br><wbr></div></div>
	</div>
</div>
</body>
</html>