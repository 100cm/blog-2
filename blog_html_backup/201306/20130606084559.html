<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL process management - kill|stop backend process</h2>
	<h5 id="">2013-06-06 8:45:59&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013568653116/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">PostgreSQL 进程从功能来划分的话, 分为如下几类.<div>主进程, autovacuum 监视进程和autovacuum worker进程, checkpoint进程, 记录日志的logger进程, 写xlog的wal writer进程, 写buffer脏数据的writer进程, 收集统计信息的stats进程. 以及与客户端交互的进程.</div><div>所有进程都是直接或间接从主进程fork出来的. 从父进程号可以看出, 一下进程都是主进程postgres fork出来的.</div><div><wbr><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@kefu ~]# ps -ewf|grep postgres|grep -v grep|sort -k 3</font></div><div><font size="2"   >postgres 31940 &nbsp; &nbsp; 1 &nbsp;0 Jun04 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 /opt/pgsql9.3beta1/bin/postgres</font></div></div><div><div><font size="2"   >postgres 11881 31940 &nbsp;0 08:06 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: postgres postgres [local] idle</font></div><div><font size="2"   >postgres 31946 31940 &nbsp;0 Jun04 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum launcher process &nbsp;&nbsp;</font></div><div><font size="2"   >postgres 31943 31940 &nbsp;0 Jun04 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp;&nbsp;</font></div><div><font size="2"   >postgres 31941 31940 &nbsp;0 Jun04 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: logger process &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >postgres 31945 31940 &nbsp;0 Jun04 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal writer process &nbsp;&nbsp;</font></div><div><font size="2"   >postgres 31944 31940 &nbsp;0 Jun04 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >postgres 31947 31940 &nbsp;0 Jun04 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:03 postgres: stats collector process &nbsp;</font></div></div><p></p></pre><div><span style="line-height: 22px;"   >如果开启了流复制, 还有用于流复制的sender或receiver进程. 以及启动数据库是可能会出现的执行数据库恢复的startup进程等.</span></div></div><div>本文主要介绍一下进程管理中可能会用到的杀进程.</div><div>杀进程严禁使用kill -9 pid这种方式来杀. 这样将导致数据库除主进程外的其他进程crash并自动重启(restart_after_crash = on).</div><div>如果使用kill-9 来结束进程, 会怎么样呢? 例如 :&nbsp;</div><div>开启一个事务 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@kefu-&gt; psql</font></div><div><font size="2"   >psql (9.3beta1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# select pg_backend_pid();</font></div><div><font size="2"   >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 12111</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>使用 kill -9 杀掉这个会话.</div><div><pre class="prettyprint"   ><p><font size="2"   >postgres@kefu-&gt; kill -9 12111</font></p></pre></div><div>查看数据库日志 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2013-06-06 08:20:11.124 CST,,,12108,,51afd5a6.2f4c,2,,2013-06-06 08:19:50 CST,1/0,0,WARNING,57P02,"terminating connection because of crash of another server process","The postmaster has commanded this server process to roll back the current transaction and exit, because another server process exited abnormally and possibly corrupted shared memory.","In a moment you should be able to reconnect to the database and repeat your command.",,,,,,"quickdie, postgres.c:2548",""</font></div><div><font size="2"   >2013-06-06 08:20:11.125 CST,,,12102,,51afd5a6.2f46,4,,2013-06-06 08:19:50 CST,,0,LOG,00000,"all server processes terminated; reinitializing",,,,,,,,"PostmasterStateMachine, postmaster.c:3472",""</font></div><div><font size="2"   >2013-06-06 08:20:11.230 CST,,,12114,,51afd5bb.2f52,1,,2013-06-06 08:20:11 CST,,0,LOG,00000,"database system was interrupted; last known up at 2013-06-06 08:19:50 CST",,,,,,,,"StartupXLOG, xlog.c:4909",""</font></div><div><font size="2"   >2013-06-06 08:20:11.231 CST,,,12114,,51afd5bb.2f52,2,,2013-06-06 08:20:11 CST,,0,LOG,00000,"database system was not properly shut down; automatic recovery in progress",,,,,,,,"StartupXLOG, xlog.c:5283",""</font></div><div><font size="2"   >2013-06-06 08:20:11.231 CST,,,12114,,51afd5bb.2f52,3,,2013-06-06 08:20:11 CST,,0,LOG,00000,"crash recovery starts in timeline 1 and has target timeline 1",,,,,,,,"StartupXLOG, xlog.c:5289",""</font></div><p></p></pre></div><div>所有的server process crash, 并自动重新初始化. 重新初始话后数据库可以被正常访问.</div><div><br></div><div><span style="line-height: 22px;"   >如果修改配置 restart_after_crash = off, 并重启数据库. 使用kill -9 杀进程会导致数据库停止.</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >postgres@kefu-&gt; pg_ctl restart</font></div><div style="line-height: 22px;"   ><font size="2"   >waiting for server to shut down.... done</font></div><div style="line-height: 22px;"   ><font size="2"   >server stopped</font></div><div style="line-height: 22px;"   ><font size="2"   >server starting</font></div><div style="line-height: 22px;"   ><font size="2"   >postgres@kefu-&gt; LOG: &nbsp;00000: loaded library "pg_stat_statements"</font></div><div style="line-height: 22px;"   ><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1296</font></div><p></p></pre></div><div style="line-height: 22px;"   >开启一个会话 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@kefu-&gt; psql</font></div><div><font size="2"   >psql (9.3beta1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# select pg_backend_pid();</font></div><div><font size="2"   >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 12144</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="line-height: 22px;"   >使用kill -9 杀掉这个会话&nbsp;</div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@kefu-&gt; kill -9 12144</font></div><div style="line-height: 22px;"   ></div><p></p></pre></div><div style="line-height: 22px;"   >查看数据库日志 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >2013-06-06 08:22:14.623 CST,,,12141,,51afd62a.2f6d,2,,2013-06-06 08:22:02 CST,1/0,0,WARNING,57P02,"terminating connection because of crash of another server process","The postmaster has commanded this server process to roll back the current transaction and exit, because another server process exited abnormally and possibly corrupted shared memory.","In a moment you should be able to reconnect to the database and repeat your command.",,,,,,"quickdie, postgres.c:2548",""</font></p></pre></div><div>数据库关闭, 不会自动重启.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@kefu-&gt; psql</font></div><div><font size="2"   >psql: could not connect to server: No such file or directory</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Is the server running locally and accepting</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; connections on Unix domain socket "/database/pgdata/pg_root/.s.PGSQL.1921"?</font></div><p></p></pre></div><div><br></div><div>所以如果遇到紧急情况需要杀进程, 例如因为正在执行的SQL占用太多的资源, 或者抢占了锁, DBA需要干预怎么做呢?</div><div>请使用pg_cancel_backend, 或者pg_terminate_backend函数来结束.</div><div>pg_cancel_backend(pid int)<span style="white-space:pre;"   >	</span>结束该进程的当前SQL, 使用超级用户 或 该会话同名用户(PostgreSQL 9.3)执行. 实际上发了个SIGINT信号给该进程.</div><div>pg_terminate_backend(pid int) &nbsp; 结束该进程,&nbsp;<span style="line-height: 22px;"   >使用超级用户 或 该会话同名用户(PostgreSQL 9.3)执行.&nbsp;</span><span style="line-height: 22px;"   >实际上发了个</span><span style="line-height: 22px;"   >SIGTERM</span><span style="line-height: 22px;"   >信号给该进程.</span></div><div>进程号可以通过pg_stat_activity查看, 或者操作系统的taskmgr或ps查看.</div><div>使用这两个函数比使用kill -9 发的SIGKILL信号要好多了. 不会导致数据库crash.&nbsp;</div><div>举例 :&nbsp;</div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres@kefu-&gt; psql</font></div><div><font size="2"   >psql (9.3beta1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# select pg_backend_pid();</font></div><div><font size="2"   >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 12287</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >执行一个long sql :&nbsp;</font></div><div><span style="line-height: 22px;"   ><font size="2"   >postgres=# select count(*) from generate_series(1,1000000000000000);</font></span></div><p></p></pre></div><div><br></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@kefu-&gt; psql</font></div><div><font size="2"   >psql (9.3beta1)</font></div><div><font size="2"   >Type "help" for help.</font></div><p></p></pre></div><div>查看当前数据库中的SQL</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select usename,backend_start,pid,state,query from pg_stat_activity;</font></div><div><font size="2"   >&nbsp;usename &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; backend_start &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;pid &nbsp;| state &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------+-------------------------------+-------+--------+---------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;postgres | 2013-06-06 08:38:39.136155+08 | 12287 | active | select count(*) from generate_series(1,1000000000000000);</font></div><div><font size="2"   >&nbsp;postgres | 2013-06-06 08:35:58.464465+08 | 12266 | active | select usename,backend_start,pid,state,query from pg_stat_activity;</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>使用pg_cancel_backend, 结束当前SQL. 如果是事务的话, 事务被回滚. 或回到savepoint.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select pg_cancel_backend(12287);</font></div><div><font size="2"   >&nbsp;pg_cancel_backend&nbsp;</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp;t</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>SESSION A :&nbsp;</div><div>事务回滚</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >ERROR: &nbsp;canceling statement due to user request</font></div></div><div><div><font size="2"   >postgres=# select now();</font></div><div><font size="2"   >ERROR: &nbsp;current transaction is aborted, commands ignored until end of transaction block</font></div></div><div><div><font size="2"   >postgres=# end;</font></div><div><font size="2"   >ROLLBACK</font></div></div><p></p></pre></div><div><br></div><div>SESSION B :&nbsp;</div><div>使用pg_terninate_backend, 将结束这个进程.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select pg_terminate_backend(12287);</font></div><div><font size="2"   >&nbsp;pg_terminate_backend&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;t</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>SESSION A :&nbsp;</div><div>进程被结束</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# begin;</font></div><div><font size="2"   >server closed the connection unexpectedly</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; This probably means the server terminated abnormally</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; before or while processing the request.</font></div><div><font size="2"   >The connection to the server was lost. Attempting reset: Succeeded.</font></div><p></p></pre></div><div><br></div><div>使用函数和发对应信号给进程效果是一样的. 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select usename,backend_start,pid,state,query from pg_stat_activity;</font></div><div><font size="2"   >&nbsp;usename &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; backend_start &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;pid &nbsp;| state &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------+-------------------------------+-------+--------+---------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;postgres | 2013-06-06 08:41:56.637691+08 | 12304 | active | select count(*) from generate_series(1,1000000000000000);</font></div><div><font size="2"   >&nbsp;postgres | 2013-06-06 08:43:02.848037+08 | 12309 | active | select usename,backend_start,pid,state,query from pg_stat_activity;</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# \q</font></div><div><font size="2"   >postgres@kefu-&gt; kill -SIGINT 12304</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# select count(*) from generate_series(1,1000000000000000);</font></div><div><font size="2"   >ERROR: &nbsp;canceling statement due to user request</font></div></div><p></p></pre></div><div><br></div><div><br></div></div></div>
	</div>
</div>
</body>
</html>