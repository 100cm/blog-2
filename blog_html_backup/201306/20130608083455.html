<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">$PGDATA/pg_snapshots directory's function</h2>
	<h5 id="">2013-06-08 8:34:55&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020135882037167/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>pg_snapshots目录在$PGDATA下, 它的作用是什么呢?</div><div>它和9.2新增的export snapshot功能有关, 用来存储到处的事务状态信息, 关于export snapshot可以参考 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402012416105232835/"   >http://blog.163.com/digoal@126/blog/static/1638770402012416105232835/</a></div><div>以下介绍一下这个目录中存放的是什么?</div><div>在没有导出事务镜像时, 这个目录中没有任何信息.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA/pg_snapshots</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; ll</font></div><div><font size="2"   >total 0</font></div><p></p></pre></div><div>开启一个repeatable read事务, 导出当前事务状态 :&nbsp;</div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# begin TRANSACTION ISOLATION LEVEL repeatable read;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# SELECT pg_export_snapshot();</font></div><div><font size="2"   >&nbsp;pg_export_snapshot&nbsp;</font></div><div><font size="2"   >--------------------</font></div><div><font size="2"   >&nbsp;00194F81-1</font></div><div><font size="2"   >(1 row)</font></div><div><div><font size="2"   >digoal=# select txid_current();</font></div><div><font size="2"   >&nbsp;txid_current&nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 1658753</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >查看$PGDATA/pg_snapshots目录, 多了个文件, 与使用</span><span style="line-height: 22px;"   >pg_export_snapshot()函数的返回值同名.</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; ll</font></div><div><font size="2"   >total 4.0K</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 87 Jun &nbsp;8 08:19 00194F81-1</font></div><p></p></pre></div><div>这个文件的内容如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cat 00194F81-1&nbsp;</font></div><div><font size="2"   >xid:1658753</font></div><div><font size="2"   >dbid:16385</font></div><div><font size="2"   >iso:2</font></div><div><font size="2"   >ro:0</font></div><div><font size="2"   >xmin:1658753</font></div><div><font size="2"   >xmax:1658753</font></div><div><font size="2"   >xcnt:0</font></div><div><font size="2"   >sof:0</font></div><div><font size="2"   >sxcnt:0</font></div><div><font size="2"   >rec:0</font></div><p></p></pre></div></div><div>这些字段的详解见本文末尾部分.</div><div>执行一些SQL后再次导出一个事务状态信息</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table t1(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into t1 values (1);</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# SELECT pg_export_snapshot();</font></div><div><font size="2"   >&nbsp;pg_export_snapshot&nbsp;</font></div><div><font size="2"   >--------------------</font></div><div><font size="2"   >&nbsp;00194F81-2</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>又多了个文件, 由于当前数据库中没有其他事务, 所以状态不变.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; ll</font></div><div><font size="2"   >total 8.0K</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 87 Jun &nbsp;8 08:19 00194F81-1</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 87 Jun &nbsp;8 08:21 00194F81-2</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cat 00194F81-2</font></div><div><font size="2"   >xid:1658753</font></div><div><font size="2"   >dbid:16385</font></div><div><font size="2"   >iso:2</font></div><div><font size="2"   >ro:0</font></div><div><font size="2"   >xmin:1658753</font></div><div><font size="2"   >xmax:1658753</font></div><div><font size="2"   >xcnt:0</font></div><div><font size="2"   >sof:0</font></div><div><font size="2"   >sxcnt:0</font></div><div><font size="2"   >rec:0</font></div></pre></div><div>结束导出镜像的事务后, 这两个文件将被清除掉.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# end;</font></div><div><font size="2"   >COMMIT</font></div></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; ll</font></div><div><font size="2"   >total 0</font></div></div><p></p></pre></div><div><br></div><div>9.3 新增了pg_dump的并行导出, 其中也用到了export snapshot, 所以在使用pg_dump做并行导出时这个目录中也会有信息.</div><div>并行导出请参考 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201322510519547/"   >http://blog.163.com/digoal@126/blog/static/163877040201322510519547/</a></div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201326829943/"   >http://blog.163.com/digoal@126/blog/static/163877040201326829943/</a></div><div>举例如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_dump -f ./postgres.dmp -F d -E UTF8 -j 2 -h $PGDATA -p 1999 -U postgres postgres</font></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; ll</font></div><div><font size="2"   >total 4.0K</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 87 Jun &nbsp;8 08:34 001956A7-1</font></div></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;src/backend/utils/time/snapmgr.c</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >/* Define pathname of exported-snapshot files */</font></div><div style="line-height: 22px;"   ><font size="2"   >#define SNAPSHOT_EXPORT_DIR "pg_snapshots"</font></div><div style="line-height: 22px;"   ><font size="2"   >#define XactExportFilePath(path, xid, num, suffix) \</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; snprintf(path, sizeof(path), SNAPSHOT_EXPORT_DIR "/%08X-%d%s", \</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;xid, num, suffix)</font></div><p></p></pre></div></div><div>2.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >static char *</font></span></div><div><font size="2"   >ExportSnapshot(Snapshot snapshot)</font></div><p></p></pre></div><div>3.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >void</font></div><div><font size="2"   >ImportSnapshot(const char *idstr)</font></div><p></p></pre></div><div>4.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/1638770402012416105232835/"   >http://blog.163.com/digoal@126/blog/static/1638770402012416105232835/</a></div><div>5.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201322510519547/"   >http://blog.163.com/digoal@126/blog/static/163877040201322510519547/</a></div><div>6.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201326829943/"   >http://blog.163.com/digoal@126/blog/static/163877040201326829943/</a></div><div>7. pg_export_snapshot导出的事务状态文件中包含的内容如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(&amp;buf, "xid:%u\n", topXid);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(&amp;buf, "dbid:%u\n", MyDatabaseId);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(&amp;buf, "iso:%d\n", XactIsoLevel);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(&amp;buf, "ro:%d\n", XactReadOnly);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(&amp;buf, "xmin:%u\n", snapshot-&gt;xmin);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(&amp;buf, "xmax:%u\n", snapshot-&gt;xmax);</font></div></div><div><font size="2"   >可能还会包含当前未结束的事务信息</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(&amp;buf, "xcnt:%d\n", snapshot-&gt;xcnt + addTopXid);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; for (i = 0; i &lt; snapshot-&gt;xcnt; i++)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(&amp;buf, "xip:%u\n", snapshot-&gt;xip[i]);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (addTopXid)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(&amp;buf, "xip:%u\n", topXid);</font></div></div><div><font size="2"   >以及子事务信息</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (snapshot-&gt;suboverflowed ||</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snapshot-&gt;subxcnt + nchildren &gt; GetMaxSnapshotSubxidCount())</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoString(&amp;buf, "sof:1\n");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoString(&amp;buf, "sof:0\n");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(&amp;buf, "sxcnt:%d\n", snapshot-&gt;subxcnt + nchildren);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for (i = 0; i &lt; snapshot-&gt;subxcnt; i++)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(&amp;buf, "sxp:%u\n", snapshot-&gt;subxip[i]);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for (i = 0; i &lt; nchildren; i++)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(&amp;buf, "sxp:%u\n", children[i]);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(&amp;buf, "rec:%u\n", snapshot-&gt;takenDuringRecovery);</font></div></div><p></p></pre></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PGDATA/pg_snapshots directorys function - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>