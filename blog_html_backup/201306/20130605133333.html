<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL monitor - check_postgres usage - 1</h2>
	<h5 id="">2013-06-05 13:33:33&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013548284410/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前面介绍了nagios的安装和配置, 本文要进入主题了, 介绍一下PostgreSQL的监控.</div><div>这里要用到的是Bucardo提供的PostgreSQL监控脚本, check_postgres.pl.&nbsp;</div><div>它兼容nagios, cacti, mrtg等监控平台软件.&nbsp;<span style="line-height: 22px;"   >使用perl语言编写, 支持监控的项目较多.</span></div><div><span style="line-height: 22px;"   >check_postgres依赖以下perl模块 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Access to a working version of psql, and the following very standard Perl modules:</font></div><div><font size="2"   >Cwd</font></div><div><font size="2"   >Getopt::Long</font></div><div><font size="2"   >File::Basename</font></div><div><font size="2"   >File::Temp</font></div><div><font size="2"   >Time::HiRes (if $opt{showtime} is set to true, which is the default)</font></div><div><font size="2"   >The settings_checksum action requires the Digest::MD5 module.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The checkpoint action requires the Date::Parse module.</font></div><div><font size="2"   >Some actions require access to external programs. If psql is not explicitly specified, the command which is used to find it. The program /bin/df is needed by the disk_space action.</font></div><p></p></pre></div><div>1. 安装perl</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >yum install -y perl</font></div><div></div><p></p></pre></div><div>2. 查看依赖的perl模块是否已安装 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; perl -MCwd -e 1</font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; echo $?</font></div><div><font size="2"   >0</font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; perl -MGetopt::Long -e 1</font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; perl -MFile::Basename -e 1</font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; perl -MFile::Temp -e 1</font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; perl -MTime::HiRes -e 1</font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; perl -MDigest::MD5 -e 1</font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; perl -MDate::Parse -e 1</font></div><div><font size="2"   >Can't locate Date/Parse.pm in @INC (@INC contains: /usr/lib64/perl5/site_perl/5.8.8/x86_64-linux-thread-multi /usr/lib/perl5/site_perl/5.8.8 /usr/lib/perl5/site_perl /usr/lib64/perl5/vendor_perl/5.8.8/x86_64-linux-thread-multi /usr/lib/perl5/vendor_perl/5.8.8 /usr/lib/perl5/vendor_perl /usr/lib64/perl5/5.8.8/x86_64-linux-thread-multi /usr/lib/perl5/5.8.8 .).</font></div><div><font size="2"   >BEGIN failed--compilation aborted.</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >3. 安装依赖的perl模块</span></div><div>从以上检测可以看出Date::Parse未安装.&nbsp;</div><div>方法1,使用cpan安装, 需要联网.&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 nrpe-2.14]# cpan Date::Parse</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >方法2,使用源码安装略</span></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >4. 下载check_postgres</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >wget&nbsp;</span>http://bucardo.org/downloads/check_postgres.tar.gz</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >解压</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >tar -zxvf&nbsp;<span style="line-height: 22px;"   >check_postgres.tar.gz</span></font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >5. check_postgres用法</span></div><div><span style="line-height: 22px;"   >5.1 命令行参数</span></div><div>输出格式参数, check_postgres支持nagios, mrtg, simple(cacti)格式, 本例选择nagios格式.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >--output=nagios</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >连接数据库的参数 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-H NAME or --host=NAME</font></div><div><font size="2"   >-p PORT or --port=PORT</font></div><div><font size="2"   >-db NAME or --dbname=NAME</font></div><div><font size="2"   >-u USERNAME or --dbuser=USERNAME</font></div><div><font size="2"   >--dbpass=PASSWORD</font></div><div><font size="2"   >--dbservice=NAME</font></div><p></p></pre></div><div>使用--dbservice时需要配置~/.pg_service.conf, 最好不要使用密码, 配置本地的pg_hba.conf 127.0.0.1为trust即可.</div><div>如果一定要配置密码的话, 那最好配置在~/.pgpass密码文件中, 并且使用400权限.</div><div><br></div><div>psql路径参数 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >--PGBINDIR</font></span></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >使用PGBINDIR前需要修改check_postgres.pl脚本中的&nbsp;</span><span style="line-height: 22px;"   >our $NO_PSQL_OPTION = 0;</span></div><div><br></div><div><span style="line-height: 22px;"   >创建符号链接的参数, 可以省去每次输入--action, 如果要以nagios为默认输出格式, 那么路径名中需要包含nagios.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 check_postgres-2.20.0]# mkdir /opt/nagios</font></div><div><font size="2"   >[root@db-172-16-3-33 check_postgres-2.20.0]# cd /opt/nagios</font></div><div><font size="2"   >[root@db-172-16-3-33 nagios]# ll</font></div><div><font size="2"   >total 0</font></div><div><font size="2"   >[root@db-172-16-3-33 nagios]# /opt/soft_bak/check_postgres-2.20.0/check_postgres.pl --symlinks</font></div><div><font size="2"   >Created "check_postgres_archive_ready"</font></div><div><font size="2"   >Created "check_postgres_autovac_freeze"</font></div><div><font size="2"   >Created "check_postgres_backends"</font></div><div><font size="2"   >Created "check_postgres_bloat"</font></div><div><font size="2"   >Created "check_postgres_checkpoint"</font></div><div><font size="2"   >Created "check_postgres_cluster_id"</font></div><div><font size="2"   >Created "check_postgres_commitratio"</font></div><div><font size="2"   >Created "check_postgres_connection"</font></div><div><font size="2"   >Created "check_postgres_custom_query"</font></div><div><font size="2"   >Created "check_postgres_database_size"</font></div><div><font size="2"   >Created "check_postgres_dbstats"</font></div><div><font size="2"   >Created "check_postgres_disabled_triggers"</font></div><div><font size="2"   >Created "check_postgres_disk_space"</font></div><div><font size="2"   >Created "check_postgres_fsm_pages"</font></div><div><font size="2"   >Created "check_postgres_fsm_relations"</font></div><div><font size="2"   >Created "check_postgres_hitratio"</font></div><div><font size="2"   >Created "check_postgres_hot_standby_delay"</font></div><div><font size="2"   >Created "check_postgres_index_size"</font></div><div><font size="2"   >Created "check_postgres_last_analyze"</font></div><div><font size="2"   >Created "check_postgres_last_autoanalyze"</font></div><div><font size="2"   >Created "check_postgres_last_autovacuum"</font></div><div><font size="2"   >Created "check_postgres_last_vacuum"</font></div><div><font size="2"   >Created "check_postgres_listener"</font></div><div><font size="2"   >Created "check_postgres_locks"</font></div><div><font size="2"   >Created "check_postgres_logfile"</font></div><div><font size="2"   >Created "check_postgres_new_version_bc"</font></div><div><font size="2"   >Created "check_postgres_new_version_box"</font></div><div><font size="2"   >Created "check_postgres_new_version_cp"</font></div><div><font size="2"   >Created "check_postgres_new_version_pg"</font></div><div><font size="2"   >Created "check_postgres_new_version_tnm"</font></div><div><font size="2"   >Created "check_postgres_pgagent_jobs"</font></div><div><font size="2"   >Created "check_postgres_pgb_pool_cl_active"</font></div><div><font size="2"   >Created "check_postgres_pgb_pool_cl_waiting"</font></div><div><font size="2"   >Created "check_postgres_pgb_pool_maxwait"</font></div><div><font size="2"   >Created "check_postgres_pgb_pool_sv_active"</font></div><div><font size="2"   >Created "check_postgres_pgb_pool_sv_idle"</font></div><div><font size="2"   >Created "check_postgres_pgb_pool_sv_login"</font></div><div><font size="2"   >Created "check_postgres_pgb_pool_sv_tested"</font></div><div><font size="2"   >Created "check_postgres_pgb_pool_sv_used"</font></div><div><font size="2"   >Created "check_postgres_pgbouncer_backends"</font></div><div><font size="2"   >Created "check_postgres_pgbouncer_checksum"</font></div><div><font size="2"   >Created "check_postgres_prepared_txns"</font></div><div><font size="2"   >Created "check_postgres_query_runtime"</font></div><div><font size="2"   >Created "check_postgres_query_time"</font></div><div><font size="2"   >Created "check_postgres_relation_size"</font></div><div><font size="2"   >Created "check_postgres_replicate_row"</font></div><div><font size="2"   >Created "check_postgres_same_schema"</font></div><div><font size="2"   >Created "check_postgres_sequence"</font></div><div><font size="2"   >Created "check_postgres_settings_checksum"</font></div><div><font size="2"   >Created "check_postgres_slony_status"</font></div><div><font size="2"   >Created "check_postgres_table_size"</font></div><div><font size="2"   >Created "check_postgres_timesync"</font></div><div><font size="2"   >Created "check_postgres_txn_idle"</font></div><div><font size="2"   >Created "check_postgres_txn_time"</font></div><div><font size="2"   >Created "check_postgres_txn_wraparound"</font></div><div><font size="2"   >Created "check_postgres_version"</font></div><div><font size="2"   >Created "check_postgres_wal_files"</font></div><p></p></pre></div><div><br></div><div>5.2 环境变量和相关文件 :&nbsp;</div><div>PATH : check_postgres依赖psql命令, 因此需要将$PGHOME/bin配置到PATH. 除此之外也可以使用--PGBINDIR参数指定psql的bin目录.</div><div>~/.pg_service.conf : 这个文件用于--dbservice参数.</div><div>~/.pg_service.conf格式举例 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 nagios]# cat ~/.pg_service.conf&nbsp;</font></div><div><font size="2"   >[mydb1]</font></div><div><font size="2"   >hostaddr=127.0.0.1</font></div><div><font size="2"   >port=1999</font></div><div><font size="2"   >user=postgres</font></div><div><font size="2"   >dbname=postgres</font></div><div><font size="2"   >password=postgres</font></div><div><font size="2"   >[mydb2]</font></div><div><font size="2"   >hostaddr=172.16.3.39</font></div><div><font size="2"   >port=1919</font></div><div><font size="2"   >user=postgres</font></div><div><font size="2"   >dbname=postgres</font></div><div><font size="2"   >password=postgres</font></div><p></p></pre></div><div>设置了密码, 最好设置一下权限</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >chmod 400 ~/.pg_service.conf</font></div><div></div><p></p></pre></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >5.3 阈值参数</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >--warning=VAL or -w VAL</font></div><div><font size="2"   >Sets the threshold at which a warning alert is fired. The valid options for this option depends on the action used.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >--critical=VAL or -c VAL</font></div><div><font size="2"   >Sets the threshold at which a critical alert is fired. The valid options for this option depends on the action used.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-t VAL or --timeout=VAL</font></div><div><font size="2"   >Sets the timeout in seconds after which the script will abort whatever it is doing and return an UNKNOWN status. The timeout is per Postgres cluster, not for the entire script. The default value is 10; the units are always in seconds.</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >5.4 check_postgres的返回值对应nagios状态 :&nbsp;</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >0 : OK</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >1 : WARNING</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >2 :&nbsp;CRITICAL</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >3 :&nbsp;UNKNOWN</font></div></pre></div></div><div><br></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6. 使用举例</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.1 将check_postgres目录移动到合适位置, 赋予postgres用户可执行权限. 本例将使用postgres数据库启动用户调用这些命令.</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 ~]# cd /opt</font></div><div><font size="2"   >[root@db-172-16-3-39 opt]# mv /opt/soft_bak/check_postgres-2.20.0 /opt/</font></div></div><div><div><font size="2"   >[root@db-172-16-3-39 opt]# chown -R pg92:pg92 /opt/check_postgres-2.20.0</font></div><div><font size="2"   >[root@db-172-16-3-39 opt]# chmod 755 /opt/check_postgres-2.20.0/check_postgres.pl</font></div></div><p></p></pre></div><div><div style="line-height: 22px;"   >6.2 配置pg92用户.bash_profile, 确保psql在路径中.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 opt]# su - pg92</font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; cat .bash_profile&nbsp;</font></div><div><font size="2"   >export PGHOME=/opt/pgsql92</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><p></p></pre></div><div style="line-height: 22px;"   >6.3 配置数据库pg_hba.conf, 允许本地trust连接.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; vi $PGDATA/pg_hba.conf</font></div><div><font size="2"   >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div><p></p></pre></div><div style="line-height: 22px;"   >重载</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; pg_ctl reload -D $PGDATA</font></div><div><font size="2"   >server signaled</font></div><p></p></pre></div><div style="line-height: 22px;"   >6.4 监控项详解, 抽取部分check_postgres常用的监控项详细讲解.</div><div style="line-height: 22px;"   >6.4.1 监控归档 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Checks how many WAL files with extension .ready exist in the pg_xlog/archive_status directory, which is found off of your data_directory.&nbsp;</font></div><div><font size="2"   >This action must be run as a superuser, in order to access the contents of the pg_xlog/archive_status directory.</font></div><div><div><font size="2"   >The --warning and --critical options are simply the number of .ready files in the pg_xlog/archive_status directory.&nbsp;</font></div><div><font size="2"   >Usually, these values should be low, turning on the archive mechanism, we usually want it to archive WAL files as fast as possible.</font></div><div><span style="line-height: 22px;"   ><font size="2"   >If the archive command fail, number of WAL in your pg_xlog directory will grow until exhausting all the disk space and force PostgreSQL to stop immediately.</font></span></div></div><p></p></pre></div><div>需要超级用户, 因为需要查看归档状态目录, ready结尾文件越少越好, 太大说明归档速度太慢. 测试监控如下, 10个警告, 20个严重. 如果这个值过大, DBA要考虑提高一下归档目录的写性能了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=archive_ready -w 10 -c 20</font></div><div><font size="2"   >POSTGRES_ARCHIVE_READY OK: DB "postgres" (host:127.0.0.1) (port=1919) WAL ".ready" files found: 0 | time=0.01s files=0;10;20&nbsp;</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >6.4.2 freeze监控 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >The --warning and --critical options should be expressed as percentages.&nbsp;</font></div><div><font size="2"   >The 'age' of the transactions in each database is compared to the autovacuum_freeze_max_age setting (200 million by default) to generate a rounded percentage.&nbsp;</font></div><div><font size="2"   >The default values are 90% for the warning and 95% for the critical.&nbsp;</font></div><div><font size="2"   >Databases can be filtered by use of the --include and --exclude options.</font></div><p></p></pre></div><div style="line-height: 22px;"   >因为当表的age达到一定值后, 数据库必须对这个表执行vacuum freeze操作, 确保数据不会因为mvcc机制而"消失", 不是真正的消失.</div><div style="line-height: 22px;"   >例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select age(datfrozenxid),datname from pg_database;</font></div><div><font size="2"   >&nbsp; &nbsp;age &nbsp; &nbsp;| &nbsp;datname &nbsp;</font></div><div><font size="2"   >----------+-----------</font></div><div><font size="2"   >&nbsp;41050570 | template1</font></div><div><font size="2"   >&nbsp;41050570 | template0</font></div><div><font size="2"   >&nbsp;41050570 | postgres</font></div><div><font size="2"   >&nbsp;41050570 | digoal_01</font></div><div><font size="2"   >&nbsp;41050570 | digoal_02</font></div><div><font size="2"   >&nbsp;41050570 | digoal</font></div><div><font size="2"   >(6 rows)</font></div><div><font size="2"   >postgres=# show autovacuum_freeze_max_age;</font></div><div><font size="2"   >&nbsp;autovacuum_freeze_max_age&nbsp;</font></div><div><font size="2"   >---------------------------</font></div><div><font size="2"   >&nbsp;200000000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select 41050570/200000000.0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------</font></div><div><font size="2"   >&nbsp;0.20525285000000000000</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>使用方法, 可以过滤一些不想检查的数据库. 如果告警了, 说明数据库快要被freeze了, 这个会带来巨大的io开销, 建议在自动触发前安排一下在数据库空闲时段手工执行vacuumdb --freeze操作. 或者找出age最大的表(age(pg_class.relfrozenxid))手工执行vacuum freeze. 总之尽量不要让数据库自动触发, 因为自动触发的时间无法控制, 可能发生在业务最繁忙的时候.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=autovac_freeze -w 90% -c 95% --exclude=template1,template0,postgres</font></div><div><font size="2"   >POSTGRES_AUTOVAC_FREEZE OK: DB "postgres" (host:127.0.0.1) (port=1919) &nbsp;digoal=21%;90;95 &nbsp;digoal_01=21%;90;95 &nbsp;digoal_02=21%;90;95 | time=0.01s digoal=21%;90;95 &nbsp;digoal_01=21%;90;95 &nbsp;digoal_02=21%;90;95&nbsp;</font></div><p></p></pre></div><div style="line-height: 22px;"   >6.4.3 连接数监控</div><div style="line-height: 22px;"   >阈值可以配置正数, 负数, 百分比.&nbsp;</div><div style="line-height: 22px;"   >正数表示已使用连接数</div><div style="line-height: 22px;"   >负数表示剩余可用连接数, 需要用到max_connections参数.</div><div style="line-height: 22px;"   >百分比表示已使用连接数占max_connections的百分比.</div><div style="line-height: 22px;"   >正数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=backends -w=120 -c=150</font></div><div><font size="2"   >POSTGRES_BACKENDS OK: DB "postgres" (host:127.0.0.1) (port=1919) 1 of 1000 connections (1%) | time=0.01s digoal=0;120;150;0;1000 digoal_01=0;120;150;0;1000 digoal_02=0;120;150;0;1000 postgres=1;120;150;0;1000 template0=0;120;150;0;1000 template1=0;120;150;0;1000&nbsp;</font></div><p></p></pre></div><div>负数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=backends -w=-120 -c=-100</font></div><div><font size="2"   >POSTGRES_BACKENDS OK: DB "postgres" (host:127.0.0.1) (port=1919) 1 of 1000 connections (1%) | time=0.01s digoal=0;880;900;0;1000 digoal_01=0;880;900;0;1000 digoal_02=0;880;900;0;1000 postgres=1;880;900;0;1000 template0=0;880;900;0;1000 template1=0;880;900;0;1000&nbsp;</font></div><p></p></pre></div><div>百分比</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=backends -w=80% -c=90%</font></div><div><font size="2"   >POSTGRES_BACKENDS OK: DB "postgres" (host:127.0.0.1) (port=1919) 1 of 1000 connections (1%) | time=0.01s digoal=0;800;900;0;1000 digoal_01=0;800;900;0;1000 digoal_02=0;800;900;0;1000 postgres=1;800;900;0;1000 template0=0;800;900;0;1000 template1=0;800;900;0;1000&nbsp;</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.4 表和索引的数据膨胀监控</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Checks the amount of bloat in tables and indexes.&nbsp;</font></div><div><font size="2"   >(Bloat is generally the amount of dead unused space taken up in a table or index. This space is usually reclaimed by use of the VACUUM command.)&nbsp;</font></div><div><font size="2"   >This action requires that stats collection be enabled on the target databases, and requires that ANALYZE is run frequently.&nbsp;</font></div><div><font size="2"   >The --include and --exclude options can be used to filter out which tables to look at.&nbsp;</font></div><p></p></pre></div><div>阈值可以使用数字或者百分比.</div><div>数字表示膨胀多少容量, 单位可以是bytes, kilobytes, megabytes, gigabytes, terabytes, exabytes, petabytes, and zettabytes. 可以使用两位缩写.</div><div>百分比表示膨胀的百分比.</div><div>--perflimit这个参数用来限制输出的对象个数. 如果膨胀超过阈值的比较多, 可以使用这个参数限制一下输出.</div><div>注意膨胀系数和以下参数有关 :&nbsp;</div><div>autovacuum_vacuum_scale_factor = 0.2, 这样的话基本上DML频繁的表都会膨胀20%左右. 所以告警的阈值最好设置在20%以上.</div><div>举例 :&nbsp;</div><div>百分比</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=bloat -w=30% -c=40% --perflimit=5</font></div><div><font size="2"   >POSTGRES_BLOAT CRITICAL: DB "postgres" (host:127.0.0.1) (port=1919) (db postgres) table public.test rows:1000000 pages:4425 shouldbe:4406 (1.0X) wasted size:155648 (152 kB) * (db postgres) index idx_test_id rows:? pages:2745 shouldbe:1958 (1.4X) wasted bytes:6447104 (6 MB) * (db postgres) table public.batch rows:9163560 pages:76363 shouldbe:76251 (1.0X) wasted size:917504 (896 kB) | idx_test_id=6447104B public.batch=917504B public.test=155648B pg_catalog.pg_depend_depender_index=0B pg_toast.pg_toast_2618=0B&nbsp;</font></div><p></p></pre></div><div>百分比和容量</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=bloat -w="30% and 100M" -c="40% and 200M" --perflimit=5</font></div><div><font size="2"   >POSTGRES_BLOAT OK: DB "postgres" (host:127.0.0.1) (port=1919) (db postgres) index idx_test_id rows:? pages:2745 shouldbe:1958 (1.4X) wasted bytes:6447104 (6 MB) | idx_test_id=6447104B public.batch=917504B public.test=155648B pg_catalog.pg_depend_depender_index=0B pg_toast.pg_toast_2618=0B&nbsp;</font></div><p></p></pre></div><div>百分比或容量</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=bloat -w="30% or 100M" -c="40% or 200M" --perflimit=5</font></div><div><font size="2"   >POSTGRES_BLOAT CRITICAL: DB "postgres" (host:127.0.0.1) (port=1919) (db postgres) table public.test rows:1000000 pages:4425 shouldbe:4406 (1.0X) wasted size:155648 (152 kB) * (db postgres) index idx_test_id rows:? pages:2745 shouldbe:1958 (1.4X) wasted bytes:6447104 (6 MB) * (db postgres) table public.batch rows:9163560 pages:76363 shouldbe:76251 (1.0X) wasted size:917504 (896 kB) | idx_test_id=6447104B public.batch=917504B public.test=155648B pg_catalog.pg_depend_depender_index=0B pg_toast.pg_toast_2618=0B&nbsp;</font></div><p></p></pre></div><div>如果发现膨胀太大, 可以使用vacuum full 回收空间. 百分比不准, 建议使用容量.</div><div>如果要监控多个数据库需要在参数中指定, 例如 :</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >--db postgres,digoal_01,digoal_02</font></div><div style="line-height: 22px;"   ></div><p></p></pre></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.5 checkpoint监控</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >检查最后一次checkpoint到现在已经过去多长时间了, 超过阈值则告警. 但是需要注意LC_TIME变量需要与数据库一致.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >checkpoint检测必须在本机进行, 不需要连接参数, 但是需要提供$PGDATA环境变量或目录, 同时pg_controldata要在路径中.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; export LC_TIME=C</font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios --datadir=$PGDATA --action=checkpoint -w 10s -c 200000s</font></div><div><font size="2"   >POSTGRES_CHECKPOINT WARNING: &nbsp;Last checkpoint was 1420 seconds ago | age=1420;10;200000&nbsp;</font></div><div><font size="2"   >或者写$PGDATA路径</font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios --datadir=/pgdata1919 --action=checkpoint -w 10s -c 200000s<br>POSTGRES_CHECKPOINT WARNING:  Last checkpoint was 1531 seconds ago | age=1531;10;200000 </font></div><p></p></pre></div><div>把LC_TIME写到环境变量中.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; vi ~/.bash_profile</font></div><div><font size="2"   >export LC_TIME=C</font></div><p></p></pre></div><div><br></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.6 检查数据库集群的ID是否发生变化</span></div><div style="line-height: 22px;"   >类似checkpoint, 只能用于本地监控. 首先使用-c 0 找出ID, 当然使用pg_controldata也可以找到这个id.&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios --datadir=/pgdata1919 --action=cluster_id -c 0</font></div><div><font size="2"   >POSTGRES_CLUSTER_ID UNKNOWN: &nbsp;cluster_id: 5742948541169127399&nbsp;</font></div><p></p></pre></div><div>然后正式监控使用这个id,&nbsp;</div><p></p><p></p><div><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios --datadir=/pgdata1919 --action=cluster_id -c 5742948541169127399</font></div><div></div><p></p><div></div><p></p><div><span style="line-height: 22px; font-family: Arial, Helvetica, sans-serif;"   ><font size="2"   >POSTGRES_CLUSTER_ID OK: &nbsp;cluster_id: 5742948541169127399&nbsp;</font></span></div><p></p></pre></div><p></p></div><div>如果ID发生变化, 告警.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios --datadir=/pgdata1919 --action=cluster_id -c 5742948541169127398</font></div><div><font size="2"   >POSTGRES_CLUSTER_ID CRITICAL: &nbsp;cluster_id: 5742948541169127399</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.7 监控数据库事务提交的百分比.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >反过来想, 其实是监控回滚的百分比.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from pg_stat_database</font></div><div><div><font size="2"   >-[ RECORD 3 ]--+------------------------------</font></div><div><font size="2"   >datid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 12788</font></div><div><font size="2"   >datname &nbsp; &nbsp; &nbsp; &nbsp;| postgres</font></div><div><font size="2"   >numbackends &nbsp; &nbsp;| 1</font></div><div><font size="2"   >xact_commit &nbsp; &nbsp;| 1498</font></div><div><font size="2"   >xact_rollback &nbsp;| 1</font></div><div><font size="2"   >blks_read &nbsp; &nbsp; &nbsp;| 347126</font></div><div><font size="2"   >blks_hit &nbsp; &nbsp; &nbsp; | 261131</font></div><div><font size="2"   >tup_returned &nbsp; | 40780490</font></div><div><font size="2"   >tup_fetched &nbsp; &nbsp;| 94728</font></div><div><font size="2"   >tup_inserted &nbsp; | 5223</font></div><div><font size="2"   >tup_updated &nbsp; &nbsp;| 1512</font></div><div><font size="2"   >tup_deleted &nbsp; &nbsp;| 4664</font></div><div><font size="2"   >conflicts &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"   >temp_files &nbsp; &nbsp; | 0</font></div><div><font size="2"   >temp_bytes &nbsp; &nbsp; | 0</font></div><div><font size="2"   >deadlocks &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"   >blk_read_time &nbsp;| 0</font></div><div><font size="2"   >blk_write_time | 0</font></div><div><font size="2"   >stats_reset &nbsp; &nbsp;| 2013-06-04 08:07:33.154495+08</font></div></div><p></p></pre></div></div><div>使用阈值百分比</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=commitratio -w 90% -c 80%</font></div><div><font size="2"   >POSTGRES_COMMITRATIO OK: DB "postgres" (host:127.0.0.1) (port=1919) postgres: 99.93 &nbsp;| time=0.02s postgres=99.93;90;80</font></div><p></p></pre></div><div><br></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.8 数据库连接状态监控</span></div><div><span style="line-height: 22px;"   >执行</span>SELECT version(), 如果正常则返回0. 异常则为psql的返回.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=connection</font></div><div><font size="2"   >POSTGRES_CONNECTION OK: DB "postgres" (host:127.0.0.1) (port=1919) version 9.2beta1 | time=0.01s&nbsp;</font></div><p></p></pre></div><div>不能连接的情况 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1918 -db postgres -u postgres --action=connection</font></div><div><font size="2"   >ERROR: could not connect to server: Connection refused</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Is the server running on host "127.0.0.1" and accepting</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TCP/IP connections on port 1918?</font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; echo $?</font></div><div><font size="2"   >3</font></div><p></p></pre></div></div></div><div><br></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.9 定制化SQL监控</span></div><div style="line-height: 22px;"   >SQL语句必须至少返回一个名为result的列值, 或者额外再返回一个任意列值. 也就是最多返回2个列.</div><div style="line-height: 22px;"   >result列作为返回值的阈值比较列.</div><div style="line-height: 22px;"   >返回值类型可以选择如下, 共计4种返回类型, 使用参数--valtype指定返回类型 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >integer: Does a simple integer comparison. The first column should be a simple integer, and the warning and critical values should be the same.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >string: The warning and critical are strings, and are triggered only if the value in the first column matches it exactly. This is case-sensitive.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >time: The warning and the critical are times, and can have units of seconds, minutes, hours, or days. Each may be written singular or abbreviated to just the first letter. If no units are given, seconds are assumed. The first column should be an integer representing the number of seconds to check.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >size: The warning and the critical are sizes, and can have units of bytes, kilobytes, megabytes, gigabytes, terabytes, or exabytes. Each may be abbreviated to the first letter. If no units are given, bytes are assumed. The first column should be an integer representing the number of bytes to check.</font></div><p></p></pre></div><div style="line-height: 22px;"   >阈值比较可以是大于或者小于, 默认是大于. 使用 --reverse 参数则是小于.</div><div style="line-height: 22px;"   >举例 :&nbsp;</div><div style="line-height: 22px;"   >1. 如果test这个对象的占用空间大于10个页面则严重警告.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=custom_query --valtype=string -c "test" --query="select relname AS result, relpages AS pages from pg_class where relpages&gt;10"</font></div><div><font size="2"   >POSTGRES_CUSTOM_QUERY CRITICAL: DB "postgres" (host:127.0.0.1) (port=1919) test | time=0.01s pages=4425;;test</font></div><p></p></pre></div></div><div>其他 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Example 2: Give a critical if the "foobar" function returns a number over 5MB:</font></div><div><font size="2"   >&nbsp; check_postgres_custom_query --critical='5MB'--valtype=size --query="SELECT foobar() AS result"</font></div><div><font size="2"   >Example 2: Warn if the function "snazzo" returns less than 42:</font></div><div><font size="2"   >&nbsp; check_postgres_custom_query --critical=42 --query="SELECT snazzo() AS result" --reverse</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.10 数据库容量监控</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >可以使用include或者exclude. 单个数据库的容量超过阈值则告警.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=database_size -w 10M -c 20M</font></div><div><font size="2"   >POSTGRES_DATABASE_SIZE CRITICAL: DB "postgres" (host:127.0.0.1) (port=1919) postgres: 770831480 (735 MB) digoal: 582435332 (555 MB) digoal_01: 169705988 (162 MB) digoal_02: 8094212 (7905 kB) template1: 6496772 (6345 kB) template0: 6488580 (6337 kB) &nbsp;| time=0.02s postgres=770831480;10485760;20971520 digoal=582435332;10485760;20971520 digoal_01=169705988;10485760;20971520 digoal_02=8094212;10485760;20971520 template1=6496772;10485760;20971520 template0=6488580;10485760;20971520&nbsp;</font></div><p></p></pre></div><div>使用exclude排除不监控的库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=database_size -w 10M -c 20M --exclude=template0,template1</font></div><div><font size="2"   >POSTGRES_DATABASE_SIZE CRITICAL: DB "postgres" (host:127.0.0.1) (port=1919) postgres: 770831480 (735 MB) digoal: 582435332 (555 MB) digoal_01: 169705988 (162 MB) digoal_02: 8094212 (7905 kB) &nbsp;| time=0.02s postgres=770831480;10485760;20971520 digoal=582435332;10485760;20971520 digoal_01=169705988;10485760;20971520 digoal_02=8094212;10485760;20971520&nbsp;</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.11 数据库运行统计信息, 这个一般给cacti用来画图. 不返回异常结果</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=dbstats</font></div><div><font size="2"   >backends:2 commits:1587 rollbacks:1 read:347126 hit:264246 idxscan:0 idxtupread:0 idxtupfetch:0 idxblksread:2744 idxblkshit:1 seqscan:12 seqtupread:40043328 ret:40799382 fetch:95747 ins:5223 upd:1512 del:4664 dbname:postgres</font></div><p></p></pre></div></div><div><br></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.12 触发器监控, 监控是否有disabled的触发器.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=disabled_triggers -w 1 -c 2</font></div><div><font size="2"   >POSTGRES_DISABLED_TRIGGERS OK: DB "postgres" (host:127.0.0.1) (port=1919) Disabled triggers: 0 | time=0.01s</font></div><p></p></pre></div></div><div>多个数据库则使用--db postgres,other_dbname,...指定.</div><div><br></div><div><div style="line-height: 22px;"   >6.4.13 磁盘空间监控</div><div style="line-height: 22px;"   >阈值为百分比或者容量.</div><div style="line-height: 22px;"   >使用超过指定的百分比或容量则告警.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=disk_space -w "10% or 5GB"</font></div><div><font size="2"   >POSTGRES_DISK_SPACE WARNING: DB "postgres" (host:127.0.0.1) (port=1919) FS /dev/sda1 mounted on / is using 9.34 GB of 28.38 GB (35%) | time=0.01s size=10027884544B&nbsp;</font></div><p></p></pre></div><div style="line-height: 22px;"   >使用规则表达式限定设备名.</div><div><pre class="prettyprint"   ><p><font size="2"   >--include=~^/dev/</font></p></pre></div><div>~符号后面是规则表达式<span style="line-height: 22px;"   >~^/dev/表示以/dev/开头的设备.</span></div><div><br></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.14 PostgreSQL buffer命中率监控</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >监控用到pg_stat_database视图,</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >blks_read<span>	</span>bigint<span>	</span>Number of disk blocks read in this database</font></div><div><font size="2"   >blks_hit<span>	</span>bigint<span>	</span>Number of times disk blocks were found already in the buffer cache, so that a read was not necessary (this only includes hits in the PostgreSQL buffer cache, not the operating system's file system cache)</font></div><p></p></pre></div><div>算法 :&nbsp;</div><div><span style="line-height: 22px;"   >blks_hit/(</span><span style="line-height: 22px;"   >blks_hit+</span><span style="line-height: 22px;"   >blks_read</span><span style="line-height: 22px;"   >)</span></div><div><span style="line-height: 22px;"   >但是请注意, blks_hit包含的是PostgreSQL buffer中的读, 而不包含操作系统的cache命中, 所以可能命中率很低, 但是实际上读物理IO并不高, 因为大部分可能在文件系统cache中了.</span></div><div><span style="line-height: 22px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=hitratio -w 90% -c 80%</font></div><div><font size="2"   >POSTGRES_HITRATIO CRITICAL: DB "postgres" (host:127.0.0.1) (port=1919) postgres: 43.60 &nbsp;| time=0.02s postgres=43.60;90;80&nbsp;</font></div><p></p></pre></div><div>使用pg_stat_database查询结果一致</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select datname,blks_read,blks_hit from pg_stat_database;</font></div><div><font size="2"   >&nbsp; datname &nbsp;| blks_read | blks_hit&nbsp;</font></div><div><font size="2"   >-----------+-----------+----------</font></div><div><font size="2"   >&nbsp;template1 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >&nbsp;template0 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >&nbsp;postgres &nbsp;| &nbsp; &nbsp;347127 | &nbsp; 268297</font></div><div><font size="2"   >&nbsp;digoal_01 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >&nbsp;digoal_02 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >&nbsp;digoal &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >(6 rows)</font></div></div><div><div><font size="2"   >postgres=# select 268297/(268297+347127.0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------</font></div><div><font size="2"   >&nbsp;0.43595472389767054908</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div></span></div><div><span style="line-height: 22px;"   >多个数据库使用--db dbname1,dbname2,...指定.</span></div><div><span style="line-height: 22px;"   ><br></span></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.15 hot_standby延迟监控, 用来计算slave xlog的接收延迟和apply延迟, slave必须是hot_standby模式, 因为需要连接到master和slave数据库中执行如下SQL :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >slave :&nbsp;</font></div><div><font size="2"   >SELECT pg_last_xlog_receive_location() AS receive, pg_last_xlog_replay_location() AS replay</font></div><div><font size="2"   >master :&nbsp;</font></div><div><font size="2"   >SELECT pg_current_xlog_location() AS location</font></div><p></p></pre></div><div>获得结果后, 比较偏移量. 根据偏移量和提供的阈值进行比较, 超出则告警.</div><div>告警阈值为偏移量, 这个不太好评估, 因为check_postgres是先查询slave, 再查询master的, 所以本质上来讲已经有一定的偏移了. 对于DML 繁忙的数据库, 需要微调告警阈值(字节数)才能达到不误报的效果.&nbsp;</div><div>例子 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create table test (id int primary key, info text);</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "test_pkey" for table "test"</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# insert into test select generate_series(1,1000000),md5(random()::text);</font></div><div><font size="2"   >INSERT 0 1000000</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; vi upd.sh</font></div><div><font size="2"   >\setrandom id 1 1000000</font></div><div><font size="2"   >update test set info=md5(random()::text) where id=:id;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; pgbench -M prepared -f ./upd.sh -n -r -h 127.0.0.1 -p 1919 -U postgres -c 8 -j 2 -T 60 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 2</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 2705800</font></div><div><font size="2"   >tps = 45095.767006 (including connections establishing)</font></div><div><font size="2"   >tps = 45104.988913 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002196 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 1000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.172358 &nbsp; &nbsp; &nbsp; &nbsp;update test set info=md5(random()::text) where id=:id;</font></div><p></p></pre></div><div>由于先查询slave, 再查询master带来的偏移量的问题,&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=hot_standby_delay -H 127.0.0.1 -p 11919 --db postgres -u postgres -w 1</font></div><div><font size="2"   >POSTGRES_HOT_STANDBY_DELAY WARNING: DB "postgres" (host:127.0.0.1) (port=11919) 47889704 | time=0.03s replay_delay=47889704;1 &nbsp;receive-delay=47889704;1&nbsp;</font></div><p></p></pre></div><div>pgbench结束后恢复 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=hot_standby_delay -H 127.0.0.1 -p 11919 --db postgres -u postgres -w 1 --verbose</font></div><div><font size="2"   >POSTGRES_HOT_STANDBY_DELAY OK: DB "postgres" (host:127.0.0.1) (port=11919) 0 | time=0.01s replay_delay=0;1 &nbsp;receive-delay=0;1</font></div><p></p></pre></div></div><div style="line-height: 22px;"   >前面的连接参数为master,&nbsp;</div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >-H 127.0.0.1 -p 1919 -db postgres -u postgres</font></span></div><div style="line-height: 22px;"   ></div><p></p></pre><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >后面的连接参数为slave.</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >-H 127.0.0.1 -p 11919 --db postgres -u postgres</font></span></div><div style="line-height: 22px;"   ></div><p></p></pre></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.16 监控表/索引对象的大小. 有超过阈值的对象则告警.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >action :&nbsp;</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >index_size, 只统计索引的大小. pg_class.relkind='i'</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >table_size</span><span style="line-height: 22px;"   >, 只统计表的大小. pg_class.relkind='t'</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >relation_size</span><span style="line-height: 22px;"   >, 统计所有对象的大小. pg_class.relkind 不区分.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >可以结合include, exclude, includeuser, excludeuser使用</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >需要指定被监控的数据库, 库多的话-db中用逗号把库隔开就好了.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >举例 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=table_size -w 200MB --exclude=batch --perflimit=3</font></div><div><font size="2"   >POSTGRES_TABLE_SIZE OK: DB "postgres" (host:127.0.0.1) (port=1919) largest table is "public.test": 114 MB | time=0.01s public.test=119578624B;209715200 pg_catalog.pg_proc=507904B;209715200&nbsp;</font></div><p></p></pre></div><div>多个数据库使用--db dbname1,dbname2,...指定</div></div><div><br></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.17 监控上一次vacuum, analyze, autovacuum, autoanalyze到现在的时间间隔. 超过阈值告警.</span></div><div><div>用到如下函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;pg_catalog | pg_stat_get_last_analyze_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| timestamp with time zone | oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | normal</font></div><div><font size="2"   >&nbsp;pg_catalog | pg_stat_get_last_autoanalyze_time &nbsp; &nbsp; &nbsp;| timestamp with time zone | oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | normal</font></div><div><font size="2"   >&nbsp;pg_catalog | pg_stat_get_last_autovacuum_time &nbsp; &nbsp; &nbsp; | timestamp with time zone | oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | normal</font></div><div><font size="2"   >&nbsp;pg_catalog | pg_stat_get_last_vacuum_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | timestamp with time zone | oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | normal</font></div><p></p></pre></div></div><div>阈值单位如下 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >seconds, minutes, hours, and days</font></div><div style="line-height: 22px;"   ></div><p></p></pre><div><span style="line-height: 22px;"   >需指定数据库监控. 监控范围受限于指定的数据库.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres --action=last_analyze --perflimit=3 -w '1 d'</font></div><div><font size="2"   >POSTGRES_LAST_ANALYZE OK: DB "postgres" (host:127.0.0.1) (port=1919) DB: postgres TABLE: public.batch: 15:45 June 04, 2013 (20 hours 4 minutes) | time=0.02s postgres.public.batch=72269s;86400 postgres.pg_catalog.pg_authid=72269s;86400; postgres.pg_catalog.pg_constraint=72269s;86400&nbsp;</font></div><p></p></pre></div></div><div>多个数据库需要使用--db dbname1,dbname2,...指定.</div><div><br></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.18 锁监控, 只监控数量, 不监控锁等待的时间.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >用到如下SQL :&nbsp;</span></div><div>SELECT granted, mode, datname FROM pg_locks l RIGHT JOIN pg_database d ON (d.oid=l.database) WHERE d.datallowconn</div><div>阈值内容包括锁总数, 等待数, 锁类型数量. 超过则告警.</div><div>锁类型截取lock字符, 大小写不敏感.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select mode from pg_locks &nbsp;group by 1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; mode &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----------------</font></div><div><font size="2"   >&nbsp;ExclusiveLock</font></div><div><font size="2"   >&nbsp;AccessShareLock</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>例如以上所类型为exclusive和accessshare</div><div>举例 :&nbsp;</div><div>返回结果包含所有数据库.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres --action=locks -w 100 -c total=250:waiting=5:exclusive=20</font></div><div><font size="2"   >POSTGRES_LOCKS OK: DB "postgres" (host:127.0.0.1) (port=1919) total=1 &nbsp;| time=0.02s digoal.total=0;100;250 digoal_01.total=0;100;250 digoal_02.total=0;100;250 postgres.total=1;100;250 template1.total=0;100;250&nbsp;</font></div><p></p></pre></div><div><br></div></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.19 pg_agent jobs执行失败监控</span></div><div>监控阈值, 时间范围, 例如1d, 表示监控1天内无执行失败的jobs.</div><div>需要读取pgagent.pga_job表的内容, 仅适用于安装了pg_agent插件的数据库.<br><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1999 -u postgres --db postgres --action=pgagent_jobs -w 1d</font></div><div><font size="2"   >Password for user postgres:&nbsp;</font></div><div><font size="2"   >POSTGRES_PGAGENT_JOBS OK: DB "postgres" (host:127.0.0.1) (port=1999) No failed jobs | time=2.11s&nbsp;</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div></div></div></div><div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.20 prepared transaction监控.</span></div><div style="line-height: 22px;"   >二阶事务监控, 当二阶事务在限定时间范围内未结束, 则告警. 因为事务长时间不提交会影响vacuum回收空间, 只要没有提交, 那么自那起DML产生的垃圾是肯定没有办法回收的. 将会导致数据库膨胀.</div><div style="line-height: 22px;"   >当然, 如果你的数据库没有开启二阶事务, 那就不需要监控这个了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#max_prepared_transactions = 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# zero disables the feature</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><p></p></pre></div><div style="line-height: 22px;"   >举例 :&nbsp;</div><div style="line-height: 22px;"   >阈值单位, 秒.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres --action=prepared_txns -w 10<br>POSTGRES_PREPARED_TXNS OK: DB "postgres" (host:127.0.0.1) (port=1919) No prepared transactions found | time=0.11s </span></font></div><p></p></pre></div><div><br></div></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.21 检查SQL的执行时长, 超过阈值的告警. 通过pg_stat_activity查询. 排除IDLE状态.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >sub check_query_time {</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; ## Check the length of running queries</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; check_txn_idle('qtime',</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;msg('queries'),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;msg('query-time'),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'query_start',</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;q{query_start IS NOT NULL AND current_query NOT LIKE '&lt;IDLE&gt;%'});</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; return;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >} ## end of check_query_time</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >可用单位 :&nbsp;</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >Valid units are 'seconds', 'minutes', 'hours', or 'days'</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >举例 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres --action=query_time -w '1s'</font></div><div><font size="2"   >POSTGRES_QUERY_TIME OK: DB "postgres" (host:127.0.0.1) (port=1919) longest query: 0s &nbsp;| time=0.01s query_time=0s;1&nbsp;</font></div><p></p></pre></div><div style="line-height: 22px;"   >监控包括所有数据库, 无需多个指定.</div></div><div style="line-height: 22px;"   ><br></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.22 利用UPDATE SQL监控主从复制延迟.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >前面介绍的是流复制的延迟监控, 通过主从的3个函数来实现. 这里要介绍的是通过UPDATE QUERY来实现监控延迟.&nbsp;</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >适用范围更广. 例如bucardo, londiste3, slony等复制插件都适合.</span></div><div style="line-height: 22px;"   >这种方法监控需要找一个表, 指定一个pk字段以及值, 再指定该表的另一个字段作为更新字段, 再指定这个更新字段的2个值, 每次监控时在这两个值之间更新. 通过判断主从的这个更新字段的值是否匹配来判断是否成功复制.</div><div style="line-height: 22px;"   >阈值单位 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >Valid units are 'seconds', 'minutes', 'hours', or 'days'.</font></div><div style="line-height: 22px;"   ></div><p></p></pre><div><span style="line-height: 22px;"   >阈值为时间,&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres --action=replicate_row -w 5 -H 127.0.0.1 -p 11919 -u postgres --db postgres --repinfo=test,id,1,info,12f5cc73549166aef1034909ce465969,b</font></div><div><font size="2"   >POSTGRES_REPLICATE_ROW OK: DB "postgres" (host:127.0.0.1) (port=1919) Row was replicated | time=2s</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >前面的连接参数是主库</span></div></div><pre class="prettyprint"   ><p></p><div><font size="2"   >-H 127.0.0.1 -p 1919 -u postgres --db postgres</font></div><div style="line-height: 22px;"   ></div><p></p></pre><div><span style="line-height: 22px;"   >后面的连接参数是从库</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >-H 127.0.0.1 -p 11919 -u postgres --db postgres</font></div><div style="line-height: 22px;"   ></div><p></p></pre><div><span style="line-height: 22px;"   >--repinfo&nbsp;</span><span style="line-height: 22px;"   >指定了6个字段, 分别代表表名, pk字段名, pk字段值, 更新字段名, 更新字段的两个值.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; psql -U postgres postgres -p 1919</font></div><div><font size="2"   >psql (9.2beta1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select * from test where id=1;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----+----------------------------------</font></div><div><font size="2"   >&nbsp; 1 | 12f5cc73549166aef1034909ce465969</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# \q</font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; psql -U postgres postgres -p 11919</font></div><div><font size="2"   >psql (9.2beta1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select * from test where id=1;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----+----------------------------------</font></div><div><font size="2"   >&nbsp; 1 | 12f5cc73549166aef1034909ce465969</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>执行1次监控后, info值被更新</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; psql -U postgres postgres -p 1919</font></div><div><font size="2"   >psql (9.2beta1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select * from test where id=1;</font></div><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | b</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# \q</font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; psql -U postgres postgres -p 11919</font></div><div><font size="2"   >psql (9.2beta1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select * from test where id=1;</font></div><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | b</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div><div style="line-height: 22px;"   >6.4.23 比较2个数据库的schema是否一致, 不比较数据, 只比较结构.</div><div style="line-height: 22px;"   >例1 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres --action=same_schema -H 127.0.0.1 -p 11919 -u postgres --db postgres</font></div><div><font size="2"   >POSTGRES_SAME_SCHEMA OK: DB "postgres" (host:127.0.0.1) (ports:1919,11919) All databases have identical items | time=0.76s&nbsp;</font></div><p></p></pre></div><div>例2 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres --action=same_schema -H 127.0.0.1 -p 11919 -u postgres --db digoal</font></div><div><font size="2"   >POSTGRES_SAME_SCHEMA CRITICAL: (databases:postgres,digoal) (host:127.0.0.1) (ports:1919,11919) Databases were different. Items not matched: 5 | time=0.71s&nbsp;</font></div><div><font size="2"   >DB 1: dbservice= port=1919 host=127.0.0.1 dbname=postgres user=postgres&nbsp;</font></div><div><font size="2"   >DB 1: PG version: 9.2beta1</font></div><div><font size="2"   >DB 1: Total objects: 33</font></div><div><font size="2"   >DB 2: dbservice= port=11919 host=127.0.0.1 dbname=digoal user=postgres&nbsp;</font></div><div><font size="2"   >DB 2: PG version: 9.2beta1</font></div><div><font size="2"   >DB 2: Total objects: 26</font></div><div><font size="2"   >Function "public.pg_freespace(regclass)" does not exist on all databases:</font></div><div><font size="2"   >&nbsp; Exists on: &nbsp;1</font></div><div><font size="2"   >&nbsp; Missing on: 2</font></div><div><font size="2"   >Function "public.pg_freespace(regclass,bigint)" does not exist on all databases:</font></div><div><font size="2"   >&nbsp; Exists on: &nbsp;1</font></div><div><font size="2"   >&nbsp; Missing on: 2</font></div><div><font size="2"   >Table "public.test" does not exist on all databases:</font></div><div><font size="2"   >&nbsp; Exists on: &nbsp;1</font></div><div><font size="2"   >&nbsp; Missing on: 2</font></div><div><font size="2"   >Index "public.test_pkey" does not exist on all databases:</font></div><div><font size="2"   >&nbsp; Exists on: &nbsp;1</font></div><div><font size="2"   >&nbsp; Missing on: 2</font></div><div><font size="2"   >Constraint "public.test_pkey" does not exist on all databases:</font></div><div><font size="2"   >&nbsp; Exists on: &nbsp;1</font></div><div><font size="2"   >&nbsp; Missing on: 2</font></div><p></p></pre></div><div style="line-height: 22px;"   >这个除了用于监控, 还可以用于数据迁移工作后的结构比对. 用法详见check_postgres手册.</div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.24 序列使用率监控, 用于监控序列值使用的百分比. 注意不管是否使用cycle, 只计较minvalue和increment by</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >SELECT last_value, slots, used, ROUND(used/slots*100) AS percent,</font></div><div><font size="2"   >&nbsp; CASE WHEN slots &lt; used THEN 0 ELSE slots - used END AS numleft</font></div><div><font size="2"   >FROM (</font></div><div><font size="2"   >&nbsp;SELECT last_value,</font></div><div><font size="2"   >&nbsp; CEIL((LEAST(max_value, $maxValue)-min_value::numeric+1)/increment_by::NUMERIC) AS slots,</font></div><div><font size="2"   >&nbsp; CEIL((last_value-min_value::numeric+1)/increment_by::NUMERIC) AS used</font></div><div><font size="2"   >FROM $seqname</font></div><p></p></pre></div><div>举例 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create sequence seq increment by 10 minvalue 100 maxvalue 200 cycle;</font></div><div><font size="2"   >CREATE SEQUENCE</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >使用率超过90%则告警.</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres --action=sequence -w 90%</font></div><div><font size="2"   >POSTGRES_SEQUENCE OK: DB "postgres" (host:127.0.0.1) (port=1919) public.seq=9% (calls left=10) | time=0.01s public.seq=9%;90%;%&nbsp;</font></div><p></p></pre></div><div>使用率超过1%则告警.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres --action=sequence -w 1%</font></div><div><font size="2"   >POSTGRES_SEQUENCE WARNING: DB "postgres" (host:127.0.0.1) (port=1919) public.seq=9% (calls left=10) | time=0.01s public.seq=9%;1%;%&nbsp;</font></div><p></p></pre></div></div><div style="line-height: 22px;"   >多个数据库不能使用--db dbname1,dbname2指定.</div><div style="line-height: 22px;"   >需要写成多条check_postgres监控命令.</div><div style="line-height: 22px;"   ><br></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.25 监控数据库的参数是否被改变.&nbsp;</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >首先要生成当前的md5</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres --action=settings_checksum -c 0</font></div><div><font size="2"   >POSTGRES_SETTINGS_CHECKSUM UNKNOWN: DB "postgres" (host:127.0.0.1) (port=1919) checksum: e70f4e6dc87fd4072c86fc2a3b2c25a8 | time=0.01s&nbsp;</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >然后根据这个md5进行监控</span></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres --action=settings_checksum -c e70f4e6dc87fd4072c86fc2a3b2c25a8</font></div><div style="line-height: 22px;"   ><font size="2"   >POSTGRES_SETTINGS_CHECKSUM OK: DB "postgres" (host:127.0.0.1) (port=1919) checksum: e70f4e6dc87fd4072c86fc2a3b2c25a8 | time=0.01s&nbsp;</font></div><p></p></pre></div></div><div style="line-height: 22px;"   >注意这个监控需要指定数据库和用户. &nbsp;因为可以为用户和数据库单独设置参数值.</div><div style="line-height: 22px;"   >不同的用户和数据库得到的md5值可能不一样.</div><div style="line-height: 22px;"   ><br></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.26 监控远程数据库与本地服务器的时间差</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres,digoal --action=timesync -w 1 -c 3</font></div><div><font size="2"   >POSTGRES_TIMESYNC OK: DB "digoal" (host:127.0.0.1) (port=1919) timediff=0 DB=2013-06-05 13:20:24 Local=2013-06-05 13:20:24 DB "postgres" (host:127.0.0.1) (port=1919) timediff=0 DB=2013-06-05 13:20:24 Local=2013-06-05 13:20:24 | time=0.01s diff=0s;1;3 time=0.01s diff=0s;1;3&nbsp;</font></div><p></p></pre></div><div>把IP 替换成远程数据库的IP.</div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.27 监控空闲事务, 根据数量以及可选时长进行告警.</span></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres,digoal --action=txn_idle -w "1 for 10s" -c "2 for 10s"</font></div><div><font size="2"   >POSTGRES_TXN_IDLE OK: DB "postgres" (host:127.0.0.1) (port=1919) no idle in transaction | time=0.01s transaction_time=0;1;10&nbsp;</font></div><p></p></pre></div><div>超过1个idle in transaction状态的事务告警.</div><div>超过2个<span style="line-height: 22px;"   >idle in transaction, 并且最长的idle已经</span><span style="line-height: 22px;"   >持续10秒以上则告警.</span></div><div>-w 和-c最好使用一种风格, 否则会有一个无效. 例如 -w 1 -c "2 for 10s" 不要这么使用.</div><div style="line-height: 22px;"   ><br></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.28 监控事务的执行时间, 超过则告警.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >postgres=# begin;<br>BEGIN<br>postgres=# alter database postgres set work_mem='10MB';<br>ALTER DATABASE</span></font></div><div><font size="2"   ><span style="line-height: 19px;"   >不关闭事务. 然后执行监控如下</span></font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres,digoal --action=txn_time -w 1s -c 2s<br>POSTGRES_TXN_TIME CRITICAL: DB "postgres" (host:127.0.0.1) (port=1919) longest txn: 44s PID:4752 database:postgres username:postgres | time=0.01s transaction_time=44s;1;2 </font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.29 监控数据库年龄, 或者理解为数据库中最老的数据库记录的版本号的年龄.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >一般是防止wrapping自动触发的.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >类似check_postgres freeze的监控, 只是这里用的不是百分比, &nbsp;而是事务数.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres,digoal --action=txn_wraparound -w 1</font></div><div><font size="2"   >POSTGRES_TXN_WRAPAROUND WARNING: DB "digoal" (host:127.0.0.1) (port=1919) digoal: 43758651 DB "postgres" (host:127.0.0.1) (port=1919) digoal: 43758651 | time=0.01s digoal=43758651;1;;0;2000000000 digoal_01=43758651;1;;0;2000000000 digoal_02=43758651;1;;0;2000000000 postgres=43758651;1;;0;2000000000 template1=43758651;1;;0;2000000000 time=0.01s digoal=43758651;1;;0;2000000000 digoal_01=43758651;1;;0;2000000000 digoal_02=43758651;1;;0;2000000000 postgres=43758651;1;;0;2000000000 template1=43758651;1;;0;2000000000&nbsp;</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div><div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.4.30 监控xlog文件数量, 超出阈值则告警.&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres --action=wal_files -w 100</font></div><div><font size="2"   >POSTGRES_WAL_FILES WARNING: DB "digoal" (host:127.0.0.1) (port=1919) WAL files found: 146 DB "postgres" (host:127.0.0.1) (port=1919) WAL files found: 146 | time=0.08s files=146;100 time=0.02s files=146;100&nbsp;</font></div><p></p></pre></div><div style="line-height: 22px;"   >超出可能是由于归档失败不断累积造成的.&nbsp;</div></div></div></div></div></div></div></div></div></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >下一篇将介绍check_postgres在nagios监控平台中的配置.</div></div>
	</div>
</div>
</body>
</html>