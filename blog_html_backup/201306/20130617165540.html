<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.0 modify pg_attribute.atttypmod extend variable char length avoid rewrite table</h2>
	<h5 id="">2013-06-17 16:55:40&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201351743331312/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><span style="line-height: 22px;"   >在PostgreSQL 9.1以及以下版本中扩展字段长度时, 需要rewrite table. 如果是大表, 这个操作是比较费时的, 索引很多的话时间还会拉长.</span></div><div><span style="line-height: 22px;"   >9.1 release</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Allow ALTER TABLE ... SET DATA TYPE to avoid table rewrites in appropriate cases (Noah Misch, Robert Haas)</font></div><div><font size="2"   >For example, converting a varchar column to text no longer requires a rewrite of the table. However, increasing the length constraint on a varchar column still requires a table rewrite.</font></div><p></p></pre></div><div>9.2 release</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Reduce need to rebuild tables and indexes for certain ALTER TABLE ... ALTER COLUMN TYPE operations (Noah Misch)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Increasing the length limit for a varchar or varbit column, or removing the limit altogether, no longer requires a table rewrite. Similarly, increasing the allowable precision of a numeric column, or changing a column from constrained numeric to unconstrained numeric, no longer requires a table rewrite. Table rewrites are also avoided in similar cases involving the interval, timestamp, and timestamptz types.</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ><br></span></div><div>如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >psql (9.0.0)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# create table test(id int,info varchar(100),crt_time timestamp)</font></div><div><font size="2"   >postgres-# ;</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# insert into test select generate_series(1,1000),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >INSERT 0 1000</font></div></div><div><div><font size="2"   >postgres=# select * from pg_relation_filepath('test');</font></div><div><font size="2"   >&nbsp;pg_relation_filepath&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;base/11874/9302962</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>使用alter table的方式扩展字段长度, 需要重写表. 也就是数据重新拷贝.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# alter table test alter column info type varchar(512);</font></div><div><font size="2"   >ALTER TABLE</font></div><p></p></pre></div><div>数据文件已经发生变更.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from pg_relation_filepath('test');</font></div><div><font size="2"   >&nbsp;pg_relation_filepath&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;base/11874/9303169</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div><br></div><div>那么有没有更好的办法来解决这个问题呢? 如下.</div><div>通过修改pg_attribute.atttypmod字段可以达到同样效果, 同时不需要rewrite table.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# drop table test;</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >postgres=# create table test(id int,info varchar(100),crt_time timestamp); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# insert into test select generate_series(1,1000),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >INSERT 0 1000</font></div><div><font size="2"   >postgres=# select * from pg_relation_filepath('test');</font></div><div><font size="2"   >&nbsp;pg_relation_filepath&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;base/11874/9303305</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >以下SQL插入的时候报错, 意思是超过100个字符.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into test select generate_series(1,1000),repeat(md5(random()::text),30),clock_timestamp();</font></div><div><font size="2"   >ERROR: &nbsp;value too long for type character varying(100)</font></div><div><font size="2"   >postgres=# \x</font></div><div><font size="2"   >Expanded display is on.</font></div><p></p></pre></div><div>查看pg_attribute中的atttypmod字段, 变长字段(可以用作toast存储)的头信息用掉了4个字节, 所以100的长度在这里显示的是104.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from pg_attribute where attrelid ='test'::regclass and attname='info';</font></div><div><font size="2"   >-[ RECORD 1 ]-+--------</font></div><div><font size="2"   >attrelid &nbsp; &nbsp; &nbsp;| 9303305</font></div><div><font size="2"   >attname &nbsp; &nbsp; &nbsp; | info</font></div><div><font size="2"   >atttypid &nbsp; &nbsp; &nbsp;| 1043</font></div><div><font size="2"   >attstattarget | -1</font></div><div><font size="2"   >attlen &nbsp; &nbsp; &nbsp; &nbsp;| -1</font></div><div><font size="2"   >attnum &nbsp; &nbsp; &nbsp; &nbsp;| 2</font></div><div><font size="2"   >attndims &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"   >attcacheoff &nbsp; | -1</font></div><div><font size="2"   >atttypmod &nbsp; &nbsp; | 104</font></div><div><font size="2"   >attbyval &nbsp; &nbsp; &nbsp;| f</font></div><div><font size="2"   >attstorage &nbsp; &nbsp;| x</font></div><div><font size="2"   >attalign &nbsp; &nbsp; &nbsp;| i</font></div><div><font size="2"   >attnotnull &nbsp; &nbsp;| f</font></div><div><font size="2"   >atthasdef &nbsp; &nbsp; | f</font></div><div><font size="2"   >attisdropped &nbsp;| f</font></div><div><font size="2"   >attislocal &nbsp; &nbsp;| t</font></div><div><font size="2"   >attinhcount &nbsp; | 0</font></div><div><font size="2"   >attacl &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >attoptions &nbsp; &nbsp;|&nbsp;</font></div><p></p></pre></div><div>更新为516, 那么这个字段的长度限制为512.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# update pg_attribute set atttypmod=516 where &nbsp;attrelid ='test'::regclass and attname='info';</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# select atttypmod from pg_attribute where attrelid ='test'::regclass and attname='info';</font></div><div><font size="2"   >-[ RECORD 1 ]--</font></div><div><font size="2"   >atttypmod | 516</font></div><p></p></pre></div><div>插入的时候报错, 意思是超过512个字符.&nbsp;<span style="line-height: 22px;"   >说明已经更新成功了.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into test select generate_series(1,1000),repeat(md5(random()::text),30),clock_timestamp();</font></div><div><font size="2"   >ERROR: &nbsp;value too long for type character varying(512)</font></div><p></p></pre></div><div>将字段长度更新为1028.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# update pg_attribute set atttypmod=1028 where &nbsp;attrelid ='test'::regclass and attname='info';</font></div><div><font size="2"   >UPDATE 1</font></div><p></p></pre></div><div>重新插入成功</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into test select generate_series(1,1000),repeat(md5(random()::text),30),clock_timestamp();</font></div><div><font size="2"   >INSERT 0 1000</font></div><div><font size="2"   >postgres=# \d test</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "public.test"</font></div><div><font size="2"   >&nbsp; Column &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >----------+-----------------------------+-----------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;info &nbsp; &nbsp; | character varying(1024) &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;crt_time | timestamp without time zone |&nbsp;</font></div><p></p></pre></div></div><div>数据文件不变.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select * from pg_relation_filepath('test');</font></div><div><font size="2"   >-[ RECORD 1 ]--------+-------------------</font></div><div><font size="2"   >pg_relation_filepath | base/11874/9303305</font></div></div><div><div><font size="2"   >postgres=# select * from test where id=1;</font></div><div><font size="2"   >-[ RECORD 1 ]----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >id &nbsp; &nbsp; &nbsp; | 1</font></div><div><font size="2"   >info &nbsp; &nbsp; | 81416de8f27294f4283ce67f6a505463</font></div><div><font size="2"   >crt_time | 2013-06-17 16:40:07.827194</font></div><div><font size="2"   >-[ RECORD 2 ]----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >id &nbsp; &nbsp; &nbsp; | 1</font></div><div><font size="2"   >info &nbsp; &nbsp; | d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69d2169b5852fd4eff728cae68933f0e69</font></div><div><font size="2"   >crt_time | 2013-06-17 16:41:38.173321</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >[其他测试]</span></div><div><span style="line-height: 22px;"   >如果原字段上有索引, 也可以正常使用执行计划.</span></div><div><span style="line-height: 22px;"   >使用pg_dump导出时, 字段长度也可以正常导出更新后的长度.&nbsp;</span></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201222210555500/"   >http://blog.163.com/digoal@126/blog/static/163877040201222210555500/</a></div><div>2.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201112251058216/"   >http://blog.163.com/digoal@126/blog/static/163877040201112251058216/</a></div><div>3. 变长字段(可选toast存储), 字段头为4字节.</div><div>如果是定长字段, 那么小于126字节时, 只需要1字节的头.</div><div>src/backend/access/common/heaptuple.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;* Before Postgres 8.3 varlenas always had a 4-byte length header, and</font></div><div><font size="2"   >&nbsp;* therefore always needed 4-byte alignment (at least). &nbsp;This wasted space</font></div><div><font size="2"   >&nbsp;* for short varlenas, for example CHAR(1) took 5 bytes and could need up to</font></div><div><font size="2"   >&nbsp;* 3 additional padding bytes for alignment.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Now, a short varlena (up to 126 data bytes) is reduced to a 1-byte header</font></div><div><font size="2"   >&nbsp;* and we don't align it. &nbsp;To hide this from datatype-specific functions that</font></div><div><font size="2"   >&nbsp;* don't want to deal with it, such a datum is considered "toasted" and will</font></div><div><font size="2"   >&nbsp;* be expanded back to the normal 4-byte-header format by pg_detoast_datum.</font></div><div><font size="2"   >&nbsp;* (In performance-critical code paths we can use pg_detoast_datum_packed</font></div><div><font size="2"   >&nbsp;* and the appropriate access macros to avoid that overhead.) &nbsp;Note that this</font></div><div><font size="2"   >&nbsp;* conversion is performed directly in heap_form_tuple, without invoking</font></div><div><font size="2"   >&nbsp;* tuptoaster.c.</font></div><p></p></pre></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">dazuiba_008 - 2013-06-18 11:12:18</h5>
				<div><img src="http://b.bst.126.net/common/portrait/face/preview/face30.gif"  ><br><br></div>
			</div>
			<div id="">
				<h5 id="">francs - 2013-06-17 17:05:24</h5>
				<div>这个好&nbsp;<img src="http://b.bst.126.net/common/portrait/face/preview/face55.gif"  ></div>
			</div>
	</div>
</div>
</body>
</html>