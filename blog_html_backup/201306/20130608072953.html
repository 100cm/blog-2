<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL BUG? - rename tablespace but role's default_tablespace not renamed auto</h2>
	<h5 id="">2013-06-08 7:29:53&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020135872339493/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>当重命名表空间时, 用户级的default_tablespace如果会继续使用重命名前的表空间名.&nbsp;</div><div>所以当重命名表空间后, 登录此类用户将告警, 同时默认表空间将使用系统级别的默认表空间.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><p></p></pre></div><div>创建表空间</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create tablespace tbs_digoal location '/pgdata1999/tbs_digoal';</font></div><div><font size="2"   >CREATE TABLESPACE</font></div><p></p></pre></div><div>给用户配置默认表空间</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# alter role digoal set default_tablespace=tbs_digoal;</font></div><div><font size="2"   >ALTER ROLE</font></div><p></p></pre></div><div>重命名这个表空间</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# alter tablespace tbs_digoal rename to tbs_digoal_new;</font></div><div><font size="2"   >ALTER TABLESPACE</font></div><div><font size="2"   >digoal=# \q</font></div><p></p></pre></div><div><br></div><div>以该用户登录, 会告警, 提示表空间名无效, 因为已经重命名了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql digoal digoal</font></div><div><font size="2"   >WARNING: &nbsp;invalid value for parameter "default_tablespace": "tbs_digoal"</font></div><div><font size="2"   >DETAIL: &nbsp;Tablespace "tbs_digoal" does not exist.</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><p></p></pre></div><div>查询pg_user表发现用户配置未更新.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_user;</font></div><div><font size="2"   >&nbsp;usename &nbsp;| usesysid | usecreatedb | usesuper | usecatupd | userepl | &nbsp;passwd &nbsp;| valuntil | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;useconfig &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------+----------+-------------+----------+-----------+---------+----------+----------+---------------------------------</font></div><div><font size="2"   >&nbsp;postgres | &nbsp; &nbsp; &nbsp; 10 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | ******** | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;digoal &nbsp; | &nbsp; &nbsp;16384 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; | ******** | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {default_tablespace=tbs_digoal}</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>查询当前数据库默认表空间</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; \l+ digoal</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of databases</font></div><div><font size="2"   >&nbsp; Name &nbsp;| &nbsp;Owner &nbsp; | Encoding | Collate | Ctype | Access privileges | &nbsp;Size &nbsp;| Tablespace | Description&nbsp;</font></div><div><font size="2"   >--------+----------+----------+---------+-------+-------------------+--------+------------+-------------</font></div><div><font size="2"   >&nbsp;digoal | postgres | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 431 MB | pg_default |&nbsp;</font></div><div><font size="2"   >(1 row)&nbsp;</font></div><p></p></pre></div><div>新建表, 查询新建表的表空间为系统级的默认表空间. 因为创建表可以成功, 所以日志也是告警级的, 而不是错误级的.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; create table t(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >digoal=&gt; select reltablespace,relname from pg_class where relname='t';</font></div><div><font size="2"   >&nbsp;reltablespace | relname&nbsp;</font></div><div><font size="2"   >---------------+---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | t</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>也许这不是一个BUG, 来看下面的SQL</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; alter role digoal set default_tablespace=tbs_digoal_err;</font></div><div><font size="2"   >NOTICE: &nbsp;tablespace "tbs_digoal_err" does not exist</font></div><div><font size="2"   >ALTER ROLE</font></div><p></p></pre></div><div><div style="line-height: 22px;"   >注意, 因为表空间tbs_digoal_err不存在, 所以有提示出来.</div><div style="line-height: 22px;"   >但是PostgreSQL允许用户修改<span style="line-height: 22px;"   >default_tablespace</span><span style="line-height: 22px;"   >为一个不存在的表空间, 这点非常难以理解.</span></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >难道是未来会建立这样的表空间, 所以允许用户这么设置, 当建立好后就可以使用了? 方便用户提前规划存储?</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from pg_user;</font></div><div><font size="2"   >&nbsp;usename &nbsp;| usesysid | usecreatedb | usesuper | usecatupd | userepl | &nbsp;passwd &nbsp;| valuntil | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;useconfig &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------+----------+-------------+----------+-----------+---------+----------+----------+-------------------------------------</font></div><div><font size="2"   >&nbsp;postgres | &nbsp; &nbsp; &nbsp; 10 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | ******** | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;digoal &nbsp; | &nbsp; &nbsp;16384 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; | ******** | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {default_tablespace=tbs_digoal_err}</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div></div><div>[小结]</div><div>1. 个人感觉在alter tablespace tbs rename to new_tbs的时候应该自动修改以前的关联配置项. 例如前面提到的用户级的default_tablespace用过自动被修改.</div><div>&nbsp; &nbsp; 即使不自动修改, 那也应该在执行alter tablespace tbs rename to new_tbs的时候来点提示, 啥都不提示显得不太妥当.</div><wbr></div>
	</div>
</div>
</body>
</html>