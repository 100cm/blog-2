<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL lock waiting order</h2>
	<h5 id="">2013-06-20 10:43:45&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201352010122653/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>本文介绍一下PostgreSQL数据库中多个会话的锁等待场景.</div><div>通过这个场景的介绍, 让大家了解一下PostgreSQL 9.3 引入的lock_timeout潜在用意之一.</div><div>场景介绍 :&nbsp;</div><div><div><img title="PostgreSQL lock waiting order - 德哥@Digoal - PostgreSQL"   alt="PostgreSQL lock waiting order - 德哥@Digoal - PostgreSQL"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/QgzVgCOxgo0TWbJueMKOzA==/95701492099614913.jpg"   ></div><div>最下面是一个时间线,</div>SESSION A是一个长事务, 并且它持有的锁与接下来的SESSION B有冲突.</div><div>当SESSION B开启后, SESSION B处于锁等待状态.</div><div>接下来发起的会话C和会话D, 如果C和D与B有锁冲突(这里PG假设B获得了锁), 那么即使目前B还没有获得锁, 并且C,D与会话A没有锁冲突, C,D也会处于等待状态无法进行下去.</div><div>原因是PostgreSQL的另一个设计理念, 如果不断的有像C和D这样的会话发起, 那么会话B永远都获取不到锁, 那么它会一直处于等待状态.</div><div>这么说, PG的锁是排队的, 先到先"得", 注意这个"得"是指不能违背的先到先得哦. 而不是完全按照已有的锁冲突来决定.</div><div>因此这里肯定是B先得到锁, 所以C,D就不能在B未得到锁前得到锁了.</div><div><br></div><div>但是这个设计理念带来的一个坏处就是, SESSION C和SESSION D会处于等待状态.</div><div>测试 :&nbsp;</div><div><span style="line-height: 22px;"   >SESSION A :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table lock_test(id int, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into lock_test values(1,'test');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# select pg_backend_pid();</font></div><div><font size="2"   >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1040</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# update lock_test set info='new' where id=1;</font></div><div><font size="2"   >UPDATE 1</font></div><p></p></pre></div><div><br></div><div>SESSION X :&nbsp;</div><div>查看SESSION A获得的锁 ,注意<span style="line-height: 22px;"   >virtualxid的</span><span style="line-height: 22px;"   >ExclusiveLock锁是在事务开启时就加载的,&nbsp;</span><span style="line-height: 22px;"   >transactionid的</span><span style="line-height: 22px;"   >ExclusiveLock是指该事务对数据库有更改的话需要获取的, 本例会话A有update操作, 因此会获取这个锁.&nbsp;</span><span style="line-height: 22px;"   >33155指lock_test的oid.&nbsp;</span><span style="line-height: 22px;"   >RowExclusiveLock</span><span style="line-height: 22px;"   >表锁.&nbsp;</span></div><div><span style="line-height: 22px;"   >锁冲突参考 :&nbsp;</span></div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/explicit-locking.html"   >http://www.postgresql.org/docs/9.3/static/explicit-locking.html</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_locks where pid=1040;</font></div><div><font size="2"   >&nbsp; &nbsp;locktype &nbsp; &nbsp;| database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualtransaction |</font></div><div><font size="2"   >&nbsp;pid &nbsp;| &nbsp; &nbsp; &nbsp; mode &nbsp; &nbsp; &nbsp; | granted | fastpath&nbsp;</font></div><div><font size="2"   >---------------+----------+----------+------+-------+------------+---------------+---------+-------+----------+--------------------+</font></div><div><font size="2"   >------+------------------+---------+----------</font></div><div><font size="2"   >&nbsp;relation &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;16385 | &nbsp; &nbsp;33155 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3/460349 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;1040 | RowExclusiveLock | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;virtualxid &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | 3/460349 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3/460349 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;1040 | ExclusiveLock &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;transactionid | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 3252961 | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3/460349 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;1040 | ExclusiveLock &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div><div><br></div><div>SESSION Y :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select pg_backend_pid();</font></div><div><font size="2"   >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3682</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# select * from lock_test ;</font></div><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | test</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>SESSION X :&nbsp;</div><div>会话Y没有数据库更改的操作, 因此只有两个锁如下, virtualxid的ExlcusiveLock和33155的AccessShareLock. 这个锁和<span style="line-height: 22px;"   >RowExclusiveLock不冲突, 所以可以granted.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# &nbsp;select * from pg_locks where pid=3682;</font></div><div><font size="2"   >&nbsp; locktype &nbsp;| database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualtransaction | pi</font></div><div><font size="2"   >d &nbsp;| &nbsp; &nbsp; &nbsp;mode &nbsp; &nbsp; &nbsp; | granted | fastpath&nbsp;</font></div><div><font size="2"   >------------+----------+----------+------+-------+------------+---------------+---------+-------+----------+--------------------+---</font></div><div><font size="2"   >---+-----------------+---------+----------</font></div><div><font size="2"   >&nbsp;relation &nbsp; | &nbsp; &nbsp;16385 | &nbsp; &nbsp;33155 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 4/106613 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 36</font></div><div><font size="2"   >82 | AccessShareLock | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;virtualxid | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | 4/106613 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 4/106613 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 36</font></div><div><font size="2"   >82 | ExclusiveLock &nbsp; | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div><br></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select pg_backend_pid();</font></div><div><font size="2"   >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4041</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# truncate lock_test;</font></div><p></p></pre></div><div><br></div><div>SESSION X :&nbsp;</div><div>会话B是truncate操作, 因此除了virtualxid和transactionid的ExclusiveLock, 还需要获取33155的AccessExclusiveLock.</div><div>这个和SESSION A, Y冲突, 所以处于等待状态.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# &nbsp;select * from pg_locks where pid=4041;</font></div><div><font size="2"   >&nbsp; &nbsp;locktype &nbsp; &nbsp;| database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualtransaction |</font></div><div><font size="2"   >&nbsp;pid &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;mode &nbsp; &nbsp; &nbsp; &nbsp; | granted | fastpath&nbsp;</font></div><div><font size="2"   >---------------+----------+----------+------+-------+------------+---------------+---------+-------+----------+--------------------+</font></div><div><font size="2"   >------+---------------------+---------+----------</font></div><div><font size="2"   >&nbsp;relation &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;16385 | &nbsp; &nbsp; 2663 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 5/5153 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;4041 | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;relation &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;16385 | &nbsp; &nbsp; 2662 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 5/5153 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;4041 | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;relation &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;16385 | &nbsp; &nbsp; 2685 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 5/5153 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;4041 | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;relation &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;16385 | &nbsp; &nbsp; 2684 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 5/5153 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;4041 | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;relation &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;16385 | &nbsp; &nbsp; 2615 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 5/5153 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;4041 | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;relation &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;16385 | &nbsp; &nbsp; 1259 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 5/5153 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;4041 | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;virtualxid &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | 5/5153 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 5/5153 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;4041 | ExclusiveLock &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;transactionid | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 3252962 | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 5/5153 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;4041 | ExclusiveLock &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >&nbsp;relation &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;16385 | &nbsp; &nbsp;33155 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 5/5153 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;4041 | AccessExclusiveLock | f &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >(9 rows)</font></div><p></p></pre></div><div><br></div><div>SESSION C :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select pg_backend_pid();</font></div><div><font size="2"   >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4872</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# select * from lock_test;</font></div><p></p></pre></div><div><br></div><div>SESSION X :&nbsp;</div><div>会话C处于等待状态.<span style="line-height: 22px;"   >AccessShareLock</span><span style="line-height: 22px;"   >&nbsp; 无法获取, 和会话B冲突.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# &nbsp;select * from pg_locks where pid=4872;</font></div><div><font size="2"   >&nbsp; locktype &nbsp;| database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualtransaction | pi</font></div><div><font size="2"   >d &nbsp;| &nbsp; &nbsp; &nbsp;mode &nbsp; &nbsp; &nbsp; | granted | fastpath&nbsp;</font></div><div><font size="2"   >------------+----------+----------+------+-------+------------+---------------+---------+-------+----------+--------------------+---</font></div><div><font size="2"   >---+-----------------+---------+----------</font></div><div><font size="2"   >&nbsp;relation &nbsp; | &nbsp; &nbsp;16385 | &nbsp; &nbsp; 2663 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 6/1311 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 48</font></div><div><font size="2"   >72 | AccessShareLock | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;relation &nbsp; | &nbsp; &nbsp;16385 | &nbsp; &nbsp; 2662 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 6/1311 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 48</font></div><div><font size="2"   >72 | AccessShareLock | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;relation &nbsp; | &nbsp; &nbsp;16385 | &nbsp; &nbsp; 2685 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 6/1311 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 48</font></div><div><font size="2"   >72 | AccessShareLock | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;relation &nbsp; | &nbsp; &nbsp;16385 | &nbsp; &nbsp; 2684 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 6/1311 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 48</font></div><div><font size="2"   >72 | AccessShareLock | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;relation &nbsp; | &nbsp; &nbsp;16385 | &nbsp; &nbsp; 2615 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 6/1311 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 48</font></div><div><font size="2"   >72 | AccessShareLock | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;relation &nbsp; | &nbsp; &nbsp;16385 | &nbsp; &nbsp; 1259 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 6/1311 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 48</font></div><div><font size="2"   >72 | AccessShareLock | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;virtualxid | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | 6/1311 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 6/1311 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 48</font></div><div><font size="2"   >72 | ExclusiveLock &nbsp; | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;relation &nbsp; | &nbsp; &nbsp;16385 | &nbsp; &nbsp;33155 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 6/1311 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 48</font></div><div><font size="2"   >72 | AccessShareLock | f &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >(8 rows)</font></div><p></p></pre></div><div><br></div><div>[小结]</div><div>1. 如果在生产环境中遇到了类似的情况, 可以通过配置锁超时来缓解这种问题.</div><div><span style="line-height: 22px;"   >lock_timeout = 0</span></div><div>这个参数也可以在会话或者事务中设置. 例如本文的SESSION B在事务开启或者会话中设置lock_timeout, 然后再执行truncate, 那么在指定时间内无法获取锁后将回滚, 不会长时间影响SESSION C和SESSION D.</div><div>如下 :&nbsp;</div><div>SESSION B :</div><div>设置5秒超时.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# set lock_timeout=5000;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# truncate lock_test ;</font></div><p></p></pre></div><div><br></div><div>SESSION C :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from lock_test;</font></div><div></div><p></p></pre></div><div>SESSION B :&nbsp;</div><div>5秒后报错.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >ERROR: &nbsp;canceling statement due to lock timeout</font></div></div><div></div><p></p></pre></div></div><div>SESSION C :&nbsp;</div><div>会话 B报错后, 会话C可以或的锁正常返回数据.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | test</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"   >[参考]</span></div><div>1.&nbsp;src/backend/storage/lmgr/README</div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/explicit-locking.html"   >http://www.postgresql.org/docs/9.3/static/explicit-locking.html</a></div><div><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; background-color: rgb(224, 236, 239); border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"   ><thead><tr><th rowspan="2"   style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Requested Lock Mode</th><th colspan="8"   style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Current Lock Mode</th></tr><tr><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >ACCESS SHARE</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >ROW SHARE</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >ROW EXCLUSIVE</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >SHARE UPDATE EXCLUSIVE</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >SHARE</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >SHARE ROW EXCLUSIVE</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >EXCLUSIVE</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >ACCESS EXCLUSIVE</th></tr></thead><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >ACCESS SHARE</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >ROW SHARE</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >ROW EXCLUSIVE</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >SHARE UPDATE EXCLUSIVE</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >SHARE</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >SHARE ROW EXCLUSIVE</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >EXCLUSIVE</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >ACCESS EXCLUSIVE</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td></tr></table></div><div><br></div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL lock waiting order - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>