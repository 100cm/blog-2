<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">dockerizing a sshd daemon based on Centos7</h2>
	<h5 id="">2014-11-27 11:54:46&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014102711413675/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>docker 有一个sshd服务是比较容易用来测试的, 所以有必要做一个sshd镜像.</div><div>docker文档里面有一篇是基于ubuntu : 14.04来制作sshd镜像的.</div><div>因为本人习惯了使用centos, 本文将基于centos7来制作一个sshd镜像.</div><div><br></div><div>先列出ubuntu制作sshd镜像的Dockerfile :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># sshd</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># VERSION &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.2</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >FROM ubuntu:14.04</font></div><div><font size="2"   >MAINTAINER Sven Dowideit &lt;SvenDowideit@docker.com&gt;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >RUN apt-get update &amp;&amp; apt-get install -y openssh-server</font></div><div><font size="2"   >RUN mkdir /var/run/sshd</font></div><div><font size="2"   ># 设置默认密码</font></div><div><font size="2"   >RUN echo 'root:screencast' | chpasswd</font></div><div><font size="2"   >RUN sed -i 's/PermitRootLogin without-password/PermitRootLogin yes/' /etc/ssh/sshd_config</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># SSH login fix. Otherwise user is kicked off after login</font></div><div><font size="2"   >RUN sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >ENV NOTVISIBLE "in users profile"</font></div><div><font size="2"   >RUN echo "export VISIBLE=now" &gt;&gt; /etc/profile</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >EXPOSE 22</font></div><div><font size="2"   >CMD ["/usr/sbin/sshd", "-D"]</font></div><p></p></pre></div><div><br></div><div>修改成适合centos7的版本 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># mkdir /data01/sshd</font></div><div><font size="2"   ># vi Dockerfile</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   ># sshd</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># VERSION &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.2</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >FROM centos:centos7</font></div><div><font size="2"   >MAINTAINER digoal.zhou</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >RUN yum install -y openssh-server</font></div><div><font size="2"   >RUN yum install -y <span style="line-height: 21px;"   >openssh-clients</span></font></div><div><font size="2"   >RUN mkdir /var/run/sshd</font></div><div><font size="2"   >RUN echo '<span style="line-height: 21px;"   >UseDNS no' &gt;&gt; /etc/ssh/sshd_config</span></font></div><div><font size="2"   >sed -i -e '/pam_loginuid.so/d' /etc/pam.d/sshd</font></div><div><span style="line-height: 28px;"   ><font size="2"   ># 设置默认密码</font></span></div><div><font size="2"   >RUN echo 'root:Digoal_sshd_1999' | chpasswd</font></div><div><font size="2"   >RUN /usr/bin/ssh-keygen -A</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># 要在其他主机访问的话, 建议expose出去.</font></div><div><font size="2"   >EXPOSE 22</font></div><div><font size="2"   >CMD ["/usr/sbin/sshd", "-D"]</font></div></div><p></p></pre></div><div><br></div><div>制作image :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >[root@localhost sshd]# docker build -t digoal/sshd .<br>Sending build context to Docker daemon  2.56 kB<br>Sending build context to Docker daemon <br>Step 0 : FROM centos:centos7<br> ---&gt; ae0c2d0bdc10<br>Step 1 : MAINTAINER digoal.zhou<br> ---&gt; Running in 072ae2460e25<br> ---&gt; 3c5e418bb4b1<br>Removing intermediate container 072ae2460e25<br>Step 2 : RUN yum install -y openssh-server<br> ---&gt; Running in bac9ecaa70cf<br>Loaded plugins: fastestmirror<br>Determining fastest mirrors<br> * base: mirrors.aliyun.com<br> * extras: mirrors.aliyun.com<br> * updates: centos.ustc.edu.cn<br>Resolving Dependencies<br>--&gt; Running transaction check<br>---&gt; Package openssh-server.x86_64 0:6.4p1-8.el7 will be installed<br>--&gt; Processing Dependency: openssh = 6.4p1-8.el7 for package: openssh-server-6.4p1-8.el7.x86_64<br>--&gt; Processing Dependency: fipscheck-lib(x86-64) &gt;= 1.3.0 for package: openssh-server-6.4p1-8.el7.x86_64<br>--&gt; Processing Dependency: libwrap.so.0()(64bit) for package: openssh-server-6.4p1-8.el7.x86_64<br>--&gt; Processing Dependency: libfipscheck.so.1()(64bit) for package: openssh-server-6.4p1-8.el7.x86_64<br>--&gt; Running transaction check<br>---&gt; Package fipscheck-lib.x86_64 0:1.4.1-5.el7 will be installed<br>--&gt; Processing Dependency: /usr/bin/fipscheck for package: fipscheck-lib-1.4.1-5.el7.x86_64<br>---&gt; Package openssh.x86_64 0:6.4p1-8.el7 will be installed<br>---&gt; Package tcp_wrappers-libs.x86_64 0:7.6-77.el7 will be installed<br>--&gt; Running transaction check<br>---&gt; Package fipscheck.x86_64 0:1.4.1-5.el7 will be installed<br>--&gt; Finished Dependency Resolution<br><br>Dependencies Resolved<br><br>================================================================================<br> Package                  Arch          Version               Repository   Size<br>================================================================================<br>Installing:<br> openssh-server           x86_64        6.4p1-8.el7           base        367 k<br>Installing for dependencies:<br> fipscheck                x86_64        1.4.1-5.el7           base         21 k<br> fipscheck-lib            x86_64        1.4.1-5.el7           base         11 k<br> openssh                  x86_64        6.4p1-8.el7           base        341 k<br> tcp_wrappers-libs        x86_64        7.6-77.el7            base         66 k<br><br>Transaction Summary<br>================================================================================<br>Install  1 Package (+4 Dependent packages)<br><br>Total download size: 806 k<br>Installed size: 1.9 M<br>Downloading packages:<br>warning: /var/cache/yum/x86_64/7/base/packages/fipscheck-lib-1.4.1-5.el7.x86_64.rpm: Header V3 RSA/SHA256 Signature, key ID f4a80eb5: NOKEY<br>Public key for fipscheck-lib-1.4.1-5.el7.x86_64.rpm is not installed<br>--------------------------------------------------------------------------------<br>Total                                              327 kB/s | 806 kB  00:02     <br>Retrieving key from file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7<br>Importing GPG key 0xF4A80EB5:<br> Userid     : "CentOS-7 Key (CentOS 7 Official Signing Key) &lt;security@centos.org&gt;"<br> Fingerprint: 6341 ab27 53d7 8a78 a7c2 7bb1 24c6 a8a7 f4a8 0eb5<br> Package    : centos-release-7-0.1406.el7.centos.2.5.x86_64 (@Updates/$releasever)<br> From       : /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7<br>Running transaction check<br>Running transaction test<br>Transaction test succeeded<br>Running transaction<br>  Installing : fipscheck-lib-1.4.1-5.el7.x86_64                             1/5 <br>  Installing : fipscheck-1.4.1-5.el7.x86_64                                 2/5 <br>  Installing : openssh-6.4p1-8.el7.x86_64                                   3/5 <br>  Installing : tcp_wrappers-libs-7.6-77.el7.x86_64                          4/5 <br>  Installing : openssh-server-6.4p1-8.el7.x86_64                            5/5 <br>  Verifying  : tcp_wrappers-libs-7.6-77.el7.x86_64                          1/5 <br>  Verifying  : fipscheck-1.4.1-5.el7.x86_64                                 2/5 <br>  Verifying  : openssh-server-6.4p1-8.el7.x86_64                            3/5 <br>  Verifying  : openssh-6.4p1-8.el7.x86_64                                   4/5 <br>  Verifying  : fipscheck-lib-1.4.1-5.el7.x86_64                             5/5 <br><br>Installed:<br>  openssh-server.x86_64 0:6.4p1-8.el7                                           <br><br>Dependency Installed:<br>  fipscheck.x86_64 0:1.4.1-5.el7      fipscheck-lib.x86_64 0:1.4.1-5.el7        <br>  openssh.x86_64 0:6.4p1-8.el7        tcp_wrappers-libs.x86_64 0:7.6-77.el7     <br><br>Complete!<br> ---&gt; c48a513d5431<br>Removing intermediate container bac9ecaa70cf<br>Step 3 : RUN mkdir /var/run/sshd<br> ---&gt; Running in b0b25471af5d<br> ---&gt; e61b7a8bb4d9<br>Removing intermediate container b0b25471af5d<br>Step 4 : RUN echo 'UseDNS no' &gt;&gt; /etc/ssh/sshd_config<br> ---&gt; Running in 3d7072b4b9f5<br> ---&gt; 8ed4d6eb45c1<br>Removing intermediate container 3d7072b4b9f5<br>Step 5 : RUN echo 'root:Digoal_sshd_1999' | chpasswd<br> ---&gt; Running in 54eebb17b732<br> ---&gt; ecb67638a0df<br>Removing intermediate container 54eebb17b732<br>Step 6 : RUN /usr/bin/ssh-keygen -A<br> ---&gt; Running in cc7fc7b7a49e<br>ssh-keygen: generating new host keys: RSA1 RSA DSA ECDSA <br> ---&gt; 2b73dfeaebf1<br>Removing intermediate container cc7fc7b7a49e<br>Step 7 : EXPOSE 22<br> ---&gt; Running in fa5ca073d31b<br> ---&gt; 6e0fcfed929b<br>Removing intermediate container fa5ca073d31b<br>Step 8 : CMD ["/usr/sbin/sshd", "-D"]<br> ---&gt; Running in 0d53a37829c1<br> ---&gt; 3e5d8edfaeee<br>Removing intermediate container 0d53a37829c1<br>Successfully built 3e5d8edfaeee</span></font></div><p></p></pre></div><div><br></div><div>上传到docker hub, 方便以后使用 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@localhost sshd]# docker login</font></div><div><font size="2"   >Username: digoal</font></div><div><font size="2"   >Password:&nbsp;</font></div><div><font size="2"   >Email: digoal@126.com</font></div><div><font size="2"   >Login Succeeded</font></div></div><div><div><font size="2"   >[root@localhost sshd]# docker push digoal/sshd</font></div></div><div><font size="2"   >...</font></div><div><font size="2"   >Pushing tag for rev [3e5d8edfaeee] on {https://cdn-registry-1.docker.io/v1/repositories/digoal/sshd/tags/latest}</font></div><p></p></pre></div><div><br></div><div>测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@localhost ~]# docker run -d --name digoal digoal/sshd</font></div><div><font size="2"   >486381d4428e917b6572eb1a802972eb576b0fa3731178c2cd055a5def9a02ea</font></div></div><div><div><font size="2"   >[root@localhost ~]# docker inspect -f '{{.NetworkSettings.IPAddress}}' digoal</font></div><div><font size="2"   >172.17.0.13</font></div></div><p></p></pre></div><div>使用Dockerfile设置的初始密码登录container :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# ssh root@172.17.0.13</font></div><div><font size="2"   >The authenticity of host '172.17.0.13 (172.17.0.13)' can't be established.</font></div><div><font size="2"   >ECDSA key fingerprint is 76:34:4f:98:d5:56:cd:2c:e4:f8:9c:14:5a:82:f6:bf.</font></div><div><font size="2"   >Are you sure you want to continue connecting (yes/no)? yes</font></div><div><font size="2"   >Warning: Permanently added '172.17.0.13' (ECDSA) to the list of known hosts.</font></div><div><font size="2"   >root@172.17.0.13's password:&nbsp;</font></div><p></p></pre></div><div>修改默认密码</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@486381d4428e ~]# echo 'root:helloworld' | chpasswd</font></div></div><div><div><font size="2"   >[root@486381d4428e ~]# exit</font></div><div><font size="2"   >logout</font></div><div><font size="2"   >Connection to 172.17.0.13 closed.</font></div></div><p></p></pre></div></div><div><div>使用新密码登录container :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# ssh root@172.17.0.13</font></div><div><font size="2"   >root@172.17.0.13's password:&nbsp;</font></div><div><font size="2"   >Last login: Thu Nov 27 11:52:03 2014 from 172.17.42.1</font></div><div><font size="2"   >[root@486381d4428e ~]#&nbsp;</font></div><p></p></pre></div></div><div><br></div><div>有了这个镜像, 想做测试就更方便了, 感觉就好像起了一个虚拟机.</div><div><br></div><div><font size="5"   >最后有一个建议, 参考 :&nbsp;</font></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201411165323773/"   >http://blog.163.com/digoal@126/blog/static/163877040201411165323773/</a></div><div>即建议修改 /etc/pam.d/sshd, 注释如下 :&nbsp;</div><div># session &nbsp; &nbsp;required &nbsp; &nbsp; pam_loginuid.so</div><div>修改后, 重新提交镜像.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://docs.docker.com/examples/running_ssh_service/"   >http://docs.docker.com/examples/running_ssh_service/</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="dockerizing a sshd daemon based on Centos7 - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>