<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use process's network device namespace on CentOS 6.5+ x64 by openstack modified iproute package</h2>
	<h5 id="">2014-11-06 15:16:45&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020141062106481/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在阅读docker 高级网络时, 发现原来还可以设置进程级别的网络设备namespace.</div><div>我这里的环境是CentOS 6.5 x64, 这个版本的iproute包还比较老, 不支持ip netns指令, 所以需要更新一下, 参考本文末尾,</div><div>如果你使用的也是CentOS 6.5, 请务必更新iproute后再来做这个实验.</div><div><br></div><div>使用ip netns自定义docker container的网络配置例子.</div><div>1. 启动2个container, 并且使用--net=none, 即不分配网络设备.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># Start up two containers in two terminal windows</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# docker run -i -t --rm --net=none --name a centos:centos6 /bin/bash</font></div><div><font size="2"   >bash-4.1#&nbsp;</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# docker run -i -t --rm --net=none --name b centos:centos6 /bin/bash</font></div><div><font size="2"   >bash-4.1#&nbsp;</font></div></div><p></p></pre></div><div>启动后, 我们使用ip link 只能看到回环口</div><div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >bash-4.1# ip link show</font></div><div><font size="2"   >24: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</font></div></div><div></div><p></p></pre></div></div><div>2. 接下来要获取两个container的pid, 一会要给这两个进程设置网络设备.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># Learn the container process IDs</font></div><div><font size="2"   ># and create their namespace entries</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# docker inspect -f '{{.State.Pid}}' a</font></div><div><font size="2"   >39162</font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# docker inspect -f '{{.State.Pid}}' b</font></div><div><font size="2"   >39221</font></div></div><p></p></pre></div><div><div>3. 创建netns进程空间目录. 并将进程的net目录软链接过来, 命名为进程号.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# mkdir -p /var/run/netns</font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# ln -s /proc/39162/ns/net /var/run/netns/39162</font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# ln -s /proc/39221/ns/net /var/run/netns/39221</font></div><p></p></pre></div></div><div>4. 在本地创建2个pointopoint端口的链路</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># Create the "peer" interfaces and hand them out</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# ip link add A type veth peer name B</font></div></div><p></p></pre></div><div><div>可以看到, 当前多了A,B两个接口</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# ip link show</font></div><div><font size="2"   >1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</font></div><div><font size="2"   >2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP qlen 1000</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 5c:f3:fc:94:12:00 brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >3: eth1: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc mq state DOWN qlen 1000</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 5c:f3:fc:94:12:02 brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >4: usb0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UNKNOWN qlen 1000</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 5e:f3:fc:95:12:03 brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >5: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >32: B: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN qlen 1000</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether ea:86:64:96:5f:a5 brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >33: A: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN qlen 1000</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 6e:81:ef:3f:9e:5a brd ff:ff:ff:ff:ff:ff</font></div><p></p></pre></div></div><div><br></div><div>5. 接下来的操作因为centos 6.5 不支持ip netns控制, (仅仅在6.5中添加了namespace支持), 所以需要添加openstack改过的包,&nbsp;</div><div>具体的安装步骤参考本文末尾的参考部分.</div><div>在ubuntu 14.04中是默认支持ip netns的.</div><div>将本地端口A,B分别指派给container进程, 并配置IP地址, 路由, 启动端口.</div><div><pre class="prettyprint"   ><p></p><div><div><span style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-221 ~]# ip link set A netns 39162</font></span></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# ip netns exec 39162 ip addr add 10.1.1.1/32 dev A</font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# ip netns exec 39162 ip link set A up</font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# ip netns exec 39162 ip route add 10.1.1.2/32 dev A</font></div></div><div><font size="2"   ><br></font></div></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# ip link set B netns 39221</font></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# ip netns exec 39221 ip addr add 10.1.1.2/32 dev B</font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# ip netns exec 39221 ip link set B up</font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# ip netns exec 39221 ip route add 10.1.1.1/32 dev B</font></div></div></div><p></p></pre></div></div><div><div>将端口分配给container后, 在本地就看不到这两个端口了, 所以必须使用ip netns exec来操作这两个端口.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# ip link show</font></div><div><font size="2"   >1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</font></div><div><font size="2"   >2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP qlen 1000</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 5c:f3:fc:94:12:00 brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >3: eth1: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc mq state DOWN qlen 1000</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 5c:f3:fc:94:12:02 brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >4: usb0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UNKNOWN qlen 1000</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 5e:f3:fc:95:12:03 brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >5: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff</font></div><p></p></pre></div><div>配置完后, 在container中可以查询到端口信息, 相互也能ping通 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >bash-4.1# ifconfig</font></div><div><font size="2"   >A &nbsp; &nbsp; &nbsp; &nbsp; Link encap:Ethernet &nbsp;HWaddr 0A:42:B9:F9:EA:59 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:10.1.1.1 &nbsp;Bcast:0.0.0.0 &nbsp;Mask:255.255.255.255</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:0 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:1000&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:0 (0.0 b) &nbsp;TX bytes:0 (0.0 b)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >bash-4.1# ifconfig</font></div><div><font size="2"   >B &nbsp; &nbsp; &nbsp; &nbsp; Link encap:Ethernet &nbsp;HWaddr E6:92:25:AB:A0:68 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:10.1.1.2 &nbsp;Bcast:0.0.0.0 &nbsp;Mask:255.255.255.255</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet6 addr: fe80::e492:25ff:feab:a068/64 Scope:Link</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:6 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:6 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:1000&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:468 (468.0 b) &nbsp;TX bytes:468 (468.0 b)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >lo &nbsp; &nbsp; &nbsp; &nbsp;Link encap:Local Loopback &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:127.0.0.1 &nbsp;Mask:255.0.0.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet6 addr: ::1/128 Scope:Host</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP LOOPBACK RUNNING &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:0 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:0 (0.0 b) &nbsp;TX bytes:0 (0.0 b)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >bash-4.1# ping 10.1.1.2</font></div><div><font size="2"   >PING 10.1.1.2 (10.1.1.2) 56(84) bytes of data.</font></div><div><font size="2"   >64 bytes from 10.1.1.2: icmp_seq=1 ttl=64 time=0.025 ms</font></div><div><font size="2"   >^C</font></div><div><font size="2"   >--- 10.1.1.2 ping statistics ---</font></div><div><font size="2"   >1 packets transmitted, 1 received, 0% packet loss, time 802ms</font></div><div><font size="2"   >rtt min/avg/max/mdev = 0.025/0.025/0.025/0.000 ms</font></div><div><font size="2"   >bash-4.1# ping 10.1.1.1</font></div><div><font size="2"   >PING 10.1.1.1 (10.1.1.1) 56(84) bytes of data.</font></div><div><font size="2"   >64 bytes from 10.1.1.1: icmp_seq=1 ttl=64 time=0.026 ms</font></div><div><font size="2"   >^C</font></div><div><font size="2"   >--- 10.1.1.1 ping statistics ---</font></div><div><font size="2"   >1 packets transmitted, 1 received, 0% packet loss, time 518ms</font></div><div><font size="2"   >rtt min/avg/max/mdev = 0.026/0.026/0.026/0.000 ms</font></div><div><font size="2"   >bash-4.1# ip route &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >10.1.1.1 dev B &nbsp;scope link&nbsp;</font></div></div><p></p></pre></div><div><br></div></div><div>[参考]</div><div>1. man ip</div><div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >ip link netns 相关操作说明 :&nbsp;</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ip link set DEVICE { up | down | arp { on | off } |</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;promisc { on | off } |</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;allmulticast { on | off } |</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dynamic { on | off } |</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;multicast { on | off } |</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;txqueuelen PACKETS |</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;name NEWNAME |</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;address LLADDR | broadcast LLADDR |</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mtu MTU |</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;netns PID |</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;netns NETNSNAME |</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;alias NAME |</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;vf NUM [ mac LLADDR ] [ vlan VLANID [ qos VLAN-QOS ] ] [ rate TXRATE ] &nbsp;}</font></div></div></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;netns PID</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; move the device to the network namespace associated with the process PID.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;netns NETNSNAME</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; move the device to the network namespace associated with name NETNSNAME.</font></div></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >ip netns 相关操作说明 :&nbsp;</font></span></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ip netns { list | monitor }</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ip netns { add | delete } NETNSNAME</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ip netns exec NETNSNAME command ...</font></div></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >ip netns - process network namespace management</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;A network namespace is logically another copy of the network stack, with it’s own routes, firewall &nbsp;rules, &nbsp;and</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;network devices.</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;By &nbsp;convention &nbsp;a &nbsp;named &nbsp;network &nbsp;namespace &nbsp;is an object at /var/run/netns/NAME that can be opened. &nbsp;The file</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;descriptor resulting from opening /var/run/netns/NAME refers to the specified network namespace. &nbsp;Holding &nbsp;that</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;file descriptor open keeps the network namespace alive. &nbsp;The file descriptor can be used with the setns(2) sys-</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;tem call to change the network namespace associated with a task.</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The convention for network namespace aware applications is to look for global network configuration files first</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;in /etc/netns/NAME/ then in /etc/. &nbsp;For example, if you want a different version of /etc/resolv.conf for a net-</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;work namespace used to isolate your vpn you would name it /etc/netns/myvpn/resolv.conf.</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ip netns exec automates handling of this configuration, file convention for network namespace unaware &nbsp;applica-</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;tions, &nbsp;by &nbsp;creating &nbsp;a mount namespace and bind mounting all of the per network namespace configure files into</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;their traditional location in /etc.</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;ip netns list - show all of the named network namespaces</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;ip netns monitor - report when network namespace names are created and destroyed</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;ip netns add NAME - create a new named network namespace</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;ip netns delete NAME - delete the name of a network namespace</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;ip netns exec NAME cmd ... - Run cmd in the named network namespace</font></div></div><p></p></pre></div></div></div><div>2. man ip-netns &nbsp;(ubuntu)</div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://github.com/amotoki/openvnet-test-tools/blob/master/README.md"   >https://github.com/amotoki/openvnet-test-tools/blob/master/README.md</a></div><div>我在写本文的时候, juno下已经没有epel6的目录了, 所以选择了havana, 如下</div><div><a target="_blank" rel="nofollow" href="https://repos.fedorapeople.org/repos/openstack/openstack-havana/epel-6/"   >https://repos.fedorapeople.org/repos/openstack/openstack-havana/epel-6/</a></div><div>你需要在yum里面修改一下,&nbsp;<span style="line-height: 28px;"   >baseurl里juno</span><span style="line-height: 28px;"   >改成 havana.</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 yum.repos.d]# vi rdo-release.repo&nbsp;</font></div><div><font size="2"   >[openstack-juno]</font></div><div><font size="2"   >name=OpenStack Juno Repository</font></div><div><font size="2"   >baseurl=http://repos.fedorapeople.org/repos/openstack/openstack-havana/epel-6/</font></div><div><font size="2"   >enabled=1</font></div><div><font size="2"   >skip_if_unavailable=0</font></div><div><font size="2"   >gpgcheck=0</font></div><div><font size="2"   >gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-RDO-Juno</font></div><p></p></pre></div><div><br></div><div>升级iproute包</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 yum.repos.d]# yum upgrade iproute</font></div><div><font size="2"   >Loaded plugins: fastestmirror, refresh-packagekit, security</font></div><div><font size="2"   >Setting up Upgrade Process</font></div><div><font size="2"   >Loading mirror speeds from cached hostfile</font></div><div><font size="2"   >&nbsp;* base: mirrors.aliyun.com</font></div><div><font size="2"   >&nbsp;* epel: mirrors.ustc.edu.cn</font></div><div><font size="2"   >&nbsp;* extras: mirrors.aliyun.com</font></div><div><font size="2"   >&nbsp;* updates: mirrors.aliyun.com</font></div><div><font size="2"   >openstack-juno &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2.9 kB &nbsp; &nbsp; 00:00 &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >openstack-juno/primary_db &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 975 kB &nbsp; &nbsp; 02:13 &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >updates &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3.4 kB &nbsp; &nbsp; 00:00 &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >updates/primary_db &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 188 kB &nbsp; &nbsp; 00:00 &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >Resolving Dependencies</font></div><div><font size="2"   >--&gt; Running transaction check</font></div><div><font size="2"   >---&gt; Package iproute.x86_64 0:2.6.32-31.el6 will be updated</font></div><div><font size="2"   >---&gt; Package iproute.x86_64 0:2.6.32-130.el6ost.netns.2 will be an update</font></div><div><font size="2"   >--&gt; Finished Dependency Resolution</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Dependencies Resolved</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >====================================================================================================================================</font></div><div><font size="2"   >&nbsp;Package &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Arch &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Version &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Repository &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Size</font></div><div><font size="2"   >====================================================================================================================================</font></div><div><font size="2"   >Updating:</font></div><div><font size="2"   >&nbsp;iproute &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;x86_64 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2.6.32-130.el6ost.netns.2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; openstack-juno &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;367 k</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Transaction Summary</font></div><div><font size="2"   >====================================================================================================================================</font></div><div><font size="2"   >Upgrade &nbsp; &nbsp; &nbsp; 1 Package(s)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Total download size: 367 k</font></div><div><font size="2"   >Is this ok [y/N]: y</font></div><p></p></pre></div></div><div><h2 style="box-sizing: border-box; margin-top: 1em; margin-bottom: 16px; line-height: 1.225; font-size: 1.75em;position:inherit; padding-bottom: 0.3em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(238, 238, 238); color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif;"   ><a id="user-content-network-namespace" style="box-sizing: border-box; color: rgb(65, 131, 196); text-decoration: none; position: absolute; top: 0px; bottom: 0px; left: 0px; display: block; padding-right: 6px; padding-left: 8px; margin-left: -30px; line-height: 1; background: transparent;" aria-hidden="true" rel="nofollow" href="https://github.com/amotoki/openvnet-test-tools/blob/master/README.md#network-namespace"   ><span style="box-sizing: border-box; font-weight: normal; font-stretch: normal; font-size: 16px; font-family: octicons; line-height: 1; display: inline-block; -webkit-font-smoothing: antialiased; -webkit-user-select: none; color: rgb(0, 0, 0); vertical-align: middle;"   ></span></a>Network Namespace</h2><p style="box-sizing: border-box; margin-top: 0px; margin-bottom: 16px; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; line-height: 25.6000003814697px;"   >In CentOS 6.x, network namespace is not supported, so we need to additional packages to use network namespace. OpenStack RDO provides network namespace aware kernel and iproute.</p><h3 style="box-sizing: border-box; margin-top: 1em; margin-bottom: 16px; line-height: 1.43; font-size: 1.5em;position:inherit; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif;"   ><a id="user-content-centos-65" style="box-sizing: border-box; color: rgb(65, 131, 196); text-decoration: none; position: absolute; top: 0px; bottom: 0px; left: 0px; display: block; padding-right: 6px; padding-left: 30px; margin-left: -30px; background: transparent;" aria-hidden="true" rel="nofollow" href="https://github.com/amotoki/openvnet-test-tools/blob/master/README.md#centos-65"   ></a>CentOS 6.5</h3><p style="box-sizing: border-box; margin-top: 0px; margin-bottom: 16px; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; line-height: 25.6000003814697px;"   >In CentOS 6.5, kernel itself supports network namespace, but iproute does not support network namespace (no "netns" subcommand).</p><p style="box-sizing: border-box; margin-top: 0px; margin-bottom: 16px; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; line-height: 25.6000003814697px;"   >The following commands setup OpenStack RDO release repository to /etc/yum.repos.d and "yum update" installs a new version of iproute (which supports network namespace),</p><pre style="box-sizing: border-box; overflow: auto; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 14px; margin-top: 0px; margin-bottom: 16px; font-stretch: normal; line-height: 1.45; padding: 16px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; word-wrap: normal; color: rgb(51, 51, 51); background-color: rgb(247, 247, 247);"   ><code style="box-sizing: border-box; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-stretch: normal; line-height: inherit; padding: 0px; margin: 0px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; word-break: normal; border: 0px; display: inline; word-wrap: normal; background: transparent;"   ># yum install http://rdo.fedorapeople.org/rdo-release.rpm
# yum install iproute
</code></pre><p style="box-sizing: border-box; margin-top: 0px; margin-bottom: 16px; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; line-height: 25.6000003814697px;"   >or you can install iproute package explicitly.</p><pre style="box-sizing: border-box; overflow: auto; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 14px; margin-top: 0px; margin-bottom: 16px; font-stretch: normal; line-height: 1.45; padding: 16px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; word-wrap: normal; color: rgb(51, 51, 51); background-color: rgb(247, 247, 247);"   ><code style="box-sizing: border-box; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-stretch: normal; line-height: inherit; padding: 0px; margin: 0px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; word-break: normal; border: 0px; display: inline; word-wrap: normal; background: transparent;"   ># yum install yum install http://rdo.fedorapeople.org/rdo-release.rpm
</code></pre><p style="box-sizing: border-box; margin-top: 0px; margin-bottom: 16px; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; line-height: 25.6000003814697px;"   >After the installation, check the appropriate iproute package is installed and it works.</p><pre style="box-sizing: border-box; overflow: auto; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 14px; margin-top: 0px; margin-bottom: 16px; font-stretch: normal; line-height: 1.45; padding: 16px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; word-wrap: normal; color: rgb(51, 51, 51); background-color: rgb(247, 247, 247);"   ><code style="box-sizing: border-box; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-stretch: normal; line-height: inherit; padding: 0px; margin: 0px; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; word-break: normal; border: 0px; display: inline; word-wrap: normal; background: transparent;"   ># rpm -qa | grep iproute
iproute-2.6.32-130.el6ost.netns.2.x86_64
# ip netns
# ip netns add testns1
# ip netns
testns1
# ip netns delete testns1
</code></pre><h3 style="box-sizing: border-box; margin-top: 1em; margin-bottom: 16px; line-height: 1.43; font-size: 1.5em;position:inherit; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif;"   ><a id="user-content-centos-64-or-older" style="box-sizing: border-box; color: rgb(65, 131, 196); text-decoration: none; position: absolute; top: 0px; bottom: 0px; left: 0px; display: block; padding-right: 6px; padding-left: 30px; margin-left: -30px; background: transparent;" aria-hidden="true" rel="nofollow" href="https://github.com/amotoki/openvnet-test-tools/blob/master/README.md#centos-64-or-older"   ></a>CentOS 6.4 or older</h3><p style="box-sizing: border-box; margin-top: 0px; margin-bottom: 16px; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; line-height: 25.6000003814697px;"   >I have not tested these version, but ROD provides network namespace aware kernel. The packages are available at:<a style="box-sizing: border-box; color: rgb(65, 131, 196); text-decoration: none; background: transparent;" rel="nofollow" href="http://repos.fedorapeople.org/repos/openstack/openstack-havana/epel-6/"   >http://repos.fedorapeople.org/repos/openstack/openstack-havana/epel-6/</a></p></div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="use processs network device namespace on CentOS 6.5+ x64 by openstack modified iproute package - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>