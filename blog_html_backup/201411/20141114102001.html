<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">docker network case with customized bridge</h2>
	<h5 id="">2014-11-14 10:20:01&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201410149302549/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>昨天一为朋友问我能不能让container和本机网络在同一个段, 当然是可以的.</div><div>首先docker安装好后, 会创建一个网桥, 默认网桥在172.17..42.1/16网段, 启动 container时, 会自动新建link, 并将link interface添加到桥里面, 分配172.17.0.0/16的IP.</div><div>那么要让container和外部网络通信的话, 一般是DNAT, 这样效率会很低下, 见我的一篇BLOG.</div><div>另一种比较简单的方法是将本机物理网卡加入虚拟网桥, 这样的话, 也可以打通物理机和container的通讯, (甚至可以使用ovs来管理VLAN).</div><div>做法如下 &nbsp;:&nbsp;</div><div>当前桥 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# brctl show</font></div><div><font size="2"   >bridge name &nbsp; &nbsp; bridge id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; STP enabled &nbsp; &nbsp; interfaces</font></div><div><font size="2"   >docker0 &nbsp; &nbsp; &nbsp; &nbsp; 8000.000000000000 &nbsp; &nbsp; &nbsp; no</font></div><p></p></pre></div><div>当前网络</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# ifconfig</font></div><div><font size="2"   >docker0 &nbsp; Link encap:Ethernet &nbsp;HWaddr D2:61:28:62:E9:8E &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:172.17.42.1 &nbsp;Bcast:0.0.0.0 &nbsp;Mask:255.255.0.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet6 addr: fe80::d061:28ff:fe62:e98e/64 Scope:Link</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:0 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:6 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:0 (0.0 b) &nbsp;TX bytes:468 (468.0 b)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >eth0 &nbsp; &nbsp; &nbsp;Link encap:Ethernet &nbsp;HWaddr 5C:F3:FC:94:12:00 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:172.16.3.221 &nbsp;Bcast:172.16.3.255 &nbsp;Mask:255.255.255.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet6 addr: fe80::5ef3:fcff:fe94:1200/64 Scope:Link</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:2495587 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:10409745 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:1000&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:265858486 (253.5 MiB) &nbsp;TX bytes:15226870694 (14.1 GiB)</font></div><p></p></pre></div></div><div>当前链路</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# ip link</font></div><div><font size="2"   >1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</font></div><div><font size="2"   >2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP qlen 1000</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 5c:f3:fc:94:12:00 brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >3: eth1: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc mq state DOWN qlen 1000</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 5c:f3:fc:94:12:02 brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >4: usb0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UNKNOWN qlen 1000</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 5e:f3:fc:95:12:03 brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >5: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether d2:61:28:62:e9:8e brd ff:ff:ff:ff:ff:ff</font></div><p></p></pre></div><div>当前链路地址</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# ip addr</font></div><div><font size="2"   >1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</font></div><div><font size="2"   >&nbsp; &nbsp; inet 127.0.0.1/8 scope host lo</font></div><div><font size="2"   >&nbsp; &nbsp; inet6 ::1/128 scope host&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;valid_lft forever preferred_lft forever</font></div><div><font size="2"   >2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP qlen 1000</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 5c:f3:fc:94:12:00 brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >&nbsp; &nbsp; inet 172.16.3.221/24 brd 172.16.3.255 scope global eth0</font></div><div><font size="2"   >&nbsp; &nbsp; inet6 fe80::5ef3:fcff:fe94:1200/64 scope link&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;valid_lft forever preferred_lft forever</font></div><div><font size="2"   >3: eth1: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc mq state DOWN qlen 1000</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 5c:f3:fc:94:12:02 brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >4: usb0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UNKNOWN qlen 1000</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 5e:f3:fc:95:12:03 brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >&nbsp; &nbsp; inet 169.254.95.120/24 brd 169.254.95.255 scope global usb0</font></div><div><font size="2"   >&nbsp; &nbsp; inet6 fe80::5cf3:fcff:fe95:1203/64 scope link&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;valid_lft forever preferred_lft forever</font></div><div><font size="2"   >5: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether d2:61:28:62:e9:8e brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >&nbsp; &nbsp; inet 172.17.42.1/16 scope global docker0</font></div><div><font size="2"   >&nbsp; &nbsp; inet6 fe80::d061:28ff:fe62:e98e/64 scope link&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;valid_lft forever preferred_lft forever</font></div><p></p></pre></div><div>使用brctl</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# brctl&nbsp;</font></div><div><font size="2"   >Usage: brctl [commands]</font></div><div><font size="2"   >commands:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; addbr &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;bridge&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;add bridge</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; delbr &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;bridge&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;delete bridge</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; addif &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;bridge&gt; &lt;device&gt; &nbsp; &nbsp; &nbsp; add interface to bridge</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; delif &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;bridge&gt; &lt;device&gt; &nbsp; &nbsp; &nbsp; delete interface from bridge</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; setageing &nbsp; &nbsp; &nbsp; &lt;bridge&gt; &lt;time&gt; &nbsp; &nbsp; &nbsp; &nbsp; set ageing time</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; setbridgeprio &nbsp; &lt;bridge&gt; &lt;prio&gt; &nbsp; &nbsp; &nbsp; &nbsp; set bridge priority</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; setfd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;bridge&gt; &lt;time&gt; &nbsp; &nbsp; &nbsp; &nbsp; set bridge forward delay</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sethello &nbsp; &nbsp; &nbsp; &nbsp;&lt;bridge&gt; &lt;time&gt; &nbsp; &nbsp; &nbsp; &nbsp; set hello time</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; setmaxage &nbsp; &nbsp; &nbsp; &lt;bridge&gt; &lt;time&gt; &nbsp; &nbsp; &nbsp; &nbsp; set max message age</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sethashel &nbsp; &nbsp; &nbsp; &lt;bridge&gt; &lt;int&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;set hash elasticity</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sethashmax &nbsp; &nbsp; &nbsp;&lt;bridge&gt; &lt;int&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;set hash max</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; setmclmc &nbsp; &nbsp; &nbsp; &nbsp;&lt;bridge&gt; &lt;int&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;set multicast last member count</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; setmcrouter &nbsp; &nbsp; &lt;bridge&gt; &lt;int&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;set multicast router</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; setmcsnoop &nbsp; &nbsp; &nbsp;&lt;bridge&gt; &lt;int&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;set multicast snooping</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; setmcsqc &nbsp; &nbsp; &nbsp; &nbsp;&lt;bridge&gt; &lt;int&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;set multicast startup query count</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; setmclmi &nbsp; &nbsp; &nbsp; &nbsp;&lt;bridge&gt; &lt;time&gt; &nbsp; &nbsp; &nbsp; &nbsp; set multicast last member interval</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; setmcmi &nbsp; &nbsp; &nbsp; &nbsp; &lt;bridge&gt; &lt;time&gt; &nbsp; &nbsp; &nbsp; &nbsp; set multicast membership interval</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; setmcqpi &nbsp; &nbsp; &nbsp; &nbsp;&lt;bridge&gt; &lt;time&gt; &nbsp; &nbsp; &nbsp; &nbsp; set multicast querier interval</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; setmcqi &nbsp; &nbsp; &nbsp; &nbsp; &lt;bridge&gt; &lt;time&gt; &nbsp; &nbsp; &nbsp; &nbsp; set multicast query interval</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; setmcqri &nbsp; &nbsp; &nbsp; &nbsp;&lt;bridge&gt; &lt;time&gt; &nbsp; &nbsp; &nbsp; &nbsp; set multicast query response interval</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; setmcqri &nbsp; &nbsp; &nbsp; &nbsp;&lt;bridge&gt; &lt;time&gt; &nbsp; &nbsp; &nbsp; &nbsp; set multicast startup query interval</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; setpathcost &nbsp; &nbsp; &lt;bridge&gt; &lt;port&gt; &lt;cost&gt; &nbsp;set path cost</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; setportprio &nbsp; &nbsp; &lt;bridge&gt; &lt;port&gt; &lt;prio&gt; &nbsp;set port priority</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; setportmcrouter &lt;bridge&gt; &lt;port&gt; &lt;int&gt; &nbsp; set port multicast router</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; show &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[ &lt;bridge&gt; ] &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;show a list of bridges</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; showmacs &nbsp; &nbsp; &nbsp; &nbsp;&lt;bridge&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;show a list of mac addrs</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; showstp &nbsp; &nbsp; &nbsp; &nbsp; &lt;bridge&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;show bridge stp info</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; stp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;bridge&gt; {on|off} &nbsp; &nbsp; &nbsp; turn stp on/off</font></div><p></p></pre></div><div><br></div><div>实际的话, 建议新建一个网桥, 不要用docker0, docker0会被dockerinit处理, 有一些默认的东西.</div><div>注意操作时要添加路由, 接口, 否则网络会中断, 那就得登录到终端去操作了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># vi network.sh</font></div><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   ><span style="line-height: 21px;"   >brctl addbr br0<br>ip link set dev br0 up<br>ip addr del 172.16.3.221/24 dev eth0<br>ip addr add 172.16.3.221/24 dev br0<br>brctl addif br0 eth0<br>ip route add default via 172.16.3.1 dev br0</span></font></div></div><div><font size="2"   >ip link set dev docker0 down</font></div><div><font size="2"   ><span style="line-height: 21px;"   >brctl delbr docker0</span></font></div><div><br></div><div><font size="2"   ># . ./network</font></div><p></p></pre></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># vi /etc/resolv.conf</font></div><div><font size="2"   >nameserver 202.101.172.35</font></div><p></p></pre></div><div>除此之外, 还需要修改docker服务文件.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># vi /etc/init.d/docker</font></div><div><font size="2"   >例如 : </font></div><div><font size="2"   ><span style="line-height: 21px;"   >        $exec -d -g /data01/docker &amp;&gt;&gt; $logfile &amp;</span></font></div><div><font size="2"   >改成</font></div><div><font size="2"   ><span style="line-height: 21px;"   >        $exec -d -b="br0" -g /data01/docker &amp;&gt;&gt; $logfile &amp;</span></font></div><p></p></pre></div><div><br></div><div>改完后, 最好把network服务关掉, 配置文件也重命名, 用脚本来启动网络.</div><div>将命令加入/etc/rc.local</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># chkconfig network off</font></div><div><font size="2"   ><span style="line-height: 21px;"   ># chkconfig NetworkManager off</span></font></div><div><font size="2"   ><span style="line-height: 21px;"   ># chkconfig docker off</span></font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># vi /etc/rc.local</font></div><div><font size="2"   >brctl addbr br0</font></div><div><div><font size="2"   >ip link set dev eth0 up</font></div><div><font size="2"   >ip link set dev br0 up</font></div><div><font size="2"   >ip addr add 172.16.3.221/24 dev br0</font></div><div><font size="2"   >brctl addif br0 eth0</font></div><div><font size="2"   >ip route add default via 172.16.3.1 dev br0</font></div><div><font size="2"   >service docker start</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# cd /etc/sysconfig/network-scripts/</font></div><div><font size="2"   >[root@db-172-16-3-221 network-scripts]# mv ifcfg-eth0 ifcfg-eth0.bak</font></div></div><p></p></pre></div><div><br></div><div>重启docker 服务, container 将以172.16.3.0/24网段来分配IP.</div><div>接下来问题来了, 因为docker container的网络地址是自动分配的, 如果有多台宿主机的话, 使用以上架构, 非常有可能出现IP冲突的情况(如果docker没有判断的话), 建议宿主机使用不同网段, 但是管理就太麻烦了, 所以docker 默认是DNAT通讯的, 省去了网络管理的繁杂, 如果是openstack的话, container的网络是由openstack集中管理的, 而不是docker自动分配, 所以也不会出现冲突的问题.</div><div>那么需要使用netns来对docker container进行网络设置.</div><div>参考<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020141062106481/"   >http://blog.163.com/digoal@126/blog/static/16387704020141062106481/</a></div><div><br></div><div><br></div><div>比较靠谱的方法 :&nbsp;</div><div>在主机上创建多个网桥, 一个由openvswitch管理, (目前docker还未直接支持openvswitch接口, 所以需要手工来管理)</div><div>将物理网卡添加到ovs管理的网桥, 并在物理交换机相连的接口使用trunck接口(以接收多个VLAN的包).</div><div>另一个网桥由bridge-utils管理, (docker目前仅支持bridge接口)</div><div>将物理网卡和bridge link加入ovs管理的网桥. 并分配不同的VLAN号. (隔离container和物理网段).</div><div>container和物理网段通信或对外通信交给路由器负责.</div><div><img title="docker network case with customized bridge - 德哥@Digoal - PostgreSQL research"   alt="docker network case with customized bridge - 德哥@Digoal - PostgreSQL research"   src="http://img0.ph.126.net/aGseTNunsb5koKD3_8uKGg==/976999644179637090.png"   style="line-height: 28px; margin: 0px 10px 0px 0px;"   ></div><div><br></div><wbr>[参考]<div>1. man brctl</div><div>2. man ip</div><div><br><div><wbr><a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="docker network case with customized bridge - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a><br></div></div></div>
	</div>
</div>
</body>
</html>