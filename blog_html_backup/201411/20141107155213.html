<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">docker cann't use openvswitch bridge direct, but can use bridge-utils managed bridge in OVS-VSCTL managed bridge</h2>
	<h5 id="">2014-11-07 15:52:13&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201410731345643/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>我这里是在CentOS 6.5 x64下测试的, 没有在7的环境下测试.</div><div>openvswitch是一个不错的开源虚拟交换软件, 但是目前docker还不支持直接使用ovs管理的网桥, 可能是还没有实现ovs的接口.</div><div>在centos下, 目前docker支持bridge-utils包管理的网桥, 也就是常用的brctl.</div><div>如果要使用openvswitch, 可以这么来做,</div><div>1. 以无网络方式启动container, 这样的话可以避开docker来调用一些网桥相关的接口配置网络而导致报错.</div><div>2. 使用ovs创建接口</div><div>3. 将接口指派给进程(iproute2的功能) ip netns exec .....配置IP等.</div><div>详见 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020141062106481/"   >http://blog.163.com/digoal@126/blog/static/16387704020141062106481/</a></div><div><br></div><div>首先我们看看如何使用自定义网桥启动docker 服务.</div><div>默认情况下在安装好docker-io包后, 会自动添加一个名为docker0的网桥, 地址是172.17.42.1/16.</div><div>docker0的地址如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# ip addr show docker0</font></div><div><font size="2"   >5: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >&nbsp; &nbsp; inet 172.17.42.1/16 scope global docker0</font></div><div><font size="2"   >&nbsp; &nbsp; inet6 fe80::c814:5eff:fee0:1759/64 scope link&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;valid_lft forever preferred_lft forever</font></div><p></p></pre></div><div><br></div><div><div style="line-height: 28px;"   >如果要修改默认网桥docker0的IP, 可以通过如下方法 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# service docker0 stop</font></div><div><font size="2"   ># 删除原IP</font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# ip addr del 172.17.42.1/16 dev docker0</font></div><div><font size="2"   ># 添加新IP</font></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# ip addr add 10.0.0.1/8 dev docker0</font></div><div><font size="2"   ># 查看</font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# ip addr show docker0</font></div><div><font size="2"   >5: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >&nbsp; &nbsp; inet 10.0.0.1/8 scope global docker0</font></div><div><font size="2"   >&nbsp; &nbsp; inet6 fe80::200:ff:fe00:0/64 scope link&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;valid_lft forever preferred_lft forever</font></div></div><div><font size="2"   ># 重启docker server服务</font></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# service docker start</font></div><div><font size="2"   >Starting docker: &nbsp; &nbsp; &nbsp; &nbsp;[ &nbsp;OK &nbsp;]</font></div></div><div><font size="2"   ># 启动一个container, 查看新分配的IP, 已经正常了.</font></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# docker run --rm -i -t --name digoal centos:centos6 /bin/bash</font></div><div><font size="2"   >bash-4.1# ifconfig</font></div><div><font size="2"   >eth0 &nbsp; &nbsp; &nbsp;Link encap:Ethernet &nbsp;HWaddr 02:F9:8E:61:46:75 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:10.0.0.2 &nbsp;Bcast:0.0.0.0 &nbsp;Mask:255.0.0.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet6 addr: fe80::f9:8eff:fe61:4675/64 Scope:Link</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:4 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:5 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:1000&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:328 (328.0 b) &nbsp;TX bytes:418 (418.0 b)</font></div></div><p></p></pre></div></div><div><br></div><div>如果要让docker使用我们自定义的网桥, 可以使用-b指定网桥来启动.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># 停止服务</font></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# service docker stop</font></div><div><font size="2"   >Stopping docker: [ &nbsp;OK &nbsp;]</font></div></div><div><font size="2"   ># 新增网桥</font></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# brctl addbr br_digoal</font></div><div><font size="2"   ># 为新增的网桥添加地址</font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# ip addr add 172.18.0.1/16 dev br_digoal</font></div><div><font size="2"   ># 启动新增的网桥链路</font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# ip link set dev br_digoal up</font></div></div><div><font size="2"   ># 修改docker服务启动脚本, 新增-b="br_digoal"的启动项</font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# vi /etc/init.d/docker</font></div><div><div><font size="2"   >start() {</font></div><div><font size="2"   >.......................</font></div><div><font size="2"   ># 修改以下, 指定网桥&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; $exec -d -b="br_digoal" -g /data01/docker &amp;&gt;&gt; $logfile &amp;</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   ># 启动docker服务.</font></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# service docker start</font></div><div><font size="2"   >Starting docker: &nbsp; &nbsp; &nbsp; &nbsp;[ &nbsp;OK &nbsp;]</font></div></div><div><font size="2"   ># 启动虚拟机, 已经使用了新的网桥分配的地址</font></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# docker run --rm -i -t --name digoal centos:centos6 /bin/bash</font></div><div><font size="2"   >bash-4.1# ifconfig</font></div><div><font size="2"   >eth0 &nbsp; &nbsp; &nbsp;Link encap:Ethernet &nbsp;HWaddr 9E:48:5B:1D:C2:28 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:172.18.0.2 &nbsp;Bcast:0.0.0.0 &nbsp;Mask:255.255.0.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet6 addr: fe80::9c48:5bff:fe1d:c228/64 Scope:Link</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:3 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:5 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:1000&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:238 (238.0 b) &nbsp;TX bytes:418 (418.0 b)</font></div></div><p></p></pre></div><div><br></div><div>但是如果我们想用openvswitch来管理docker的虚拟网络的话, 使用这个方法可以吗?</div><div>我们来试一试 :&nbsp;</div><div># 使用ovs新增一个网桥&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@150 ~]# ovs-vsctl add-br ovs_digoal</font></div><div><font size="2"   >[root@150 ~]# ovs-vsctl list-br</font></div><div><font size="2"   >ovs_digoal</font></div></div><div><div><font size="2"   >[root@150 ~]# ovs-vsctl show</font></div><div><font size="2"   >fb8f1987-c908-4a8f-bc2c-1f8c19f034fc</font></div><div><font size="2"   >&nbsp; &nbsp; Bridge ovs_digoal</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Port ovs_digoal</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Interface ovs_digoal</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type: internal</font></div><div><font size="2"   >&nbsp; &nbsp; ovs_version: "1.9.3"</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@150 ~]# ip link show ovs_digoal</font></div><div><font size="2"   >81: ovs_digoal: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 4e:60:c1:91:55:44 brd ff:ff:ff:ff:ff:ff</font></div></div><p></p></pre></div><div># 添加IP</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 ~]# ip addr add 10.1.1.1/8 dev ovs_digoal</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   ># 启动链路</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 ~]# ip link set dev ovs_digoal up</font></div><div><font size="2"   >[root@150 ~]# ip link show ovs_digoal</font></div><div><font size="2"   >81: ovs_digoal: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 4e:60:c1:91:55:44 brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >[root@150 ~]# ip addr show ovs_digoal</font></div><div><font size="2"   >81: ovs_digoal: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 4e:60:c1:91:55:44 brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >&nbsp; &nbsp; inet 10.1.1.1/8 scope global ovs_digoal</font></div><div><font size="2"   >&nbsp; &nbsp; inet6 fe80::4c60:c1ff:fe91:5544/64 scope link&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;valid_lft forever preferred_lft forever</font></div><p></p></pre></div></div><div># 在终端启动docker服务, 使用-b指定网桥, -D打开DEBUG</div><div># 启动正常</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@150 ~]# docker -d -b="ovs_digoal" -D</font></div><div><font size="2"   >2014/11/07 15:35:55 WARNING: You are running linux kernel version 2.6.32-431.23.3.el6.x86_64, which might be unstable running docker. Please upgrade your kernel to 3.8.0.</font></div><div><font size="2"   >2014/11/07 15:35:55 docker daemon: 1.1.2 d84a070/1.1.2; execdriver: native; graphdriver:&nbsp;</font></div><div><font size="2"   >[9c7f3256] +job serveapi(unix:///var/run/docker.sock)</font></div><div><font size="2"   >[9c7f3256] +job initserver()</font></div><div><font size="2"   >[9c7f3256.initserver()] Creating server</font></div><div><font size="2"   >2014/11/07 15:35:55 Listening for HTTP on unix (/var/run/docker.sock)</font></div></div><div><font size="2"   >.............</font></div><p></p></pre></div><div><br></div><div># 但是当我们启动container时, 失败了,&nbsp;</div><div># 因为在启动container时, 需要做一些网桥的操作, 如添加接口</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 ~]# docker run --rm -t -i digoal/centos6:6.6 /bin/bash</font></div><div><font size="2"   >2014/11/07 15:36:46 Error response from daemon: Cannot start container ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea: operation not supported</font></div><p></p></pre></div><div><br></div><div># docker server的报错信息如下.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[debug] server.go:1022 Calling POST /containers/create</font></div><div><font size="2"   >2014/11/07 15:36:46 POST /v1.13/containers/create</font></div><div><font size="2"   >[9c7f3256] +job create()</font></div><div><font size="2"   >[debug] deviceset.go:448 libdevmapper(3): ioctl/libdm-iface.c:1742 (-1) device-mapper: message ioctl on docker-8:33-3407874-pool failed: File exists</font></div><div><font size="2"   >[debug] deviceset.go:448 libdevmapper(3): ioctl/libdm-iface.c:1742 (-1) device-mapper: message ioctl on docker-8:33-3407874-pool failed: File exists</font></div><div><font size="2"   >[debug] deviceset.go:448 libdevmapper(3): ioctl/libdm-iface.c:1742 (-1) device-mapper: message ioctl on docker-8:33-3407874-pool failed: File exists</font></div><div><font size="2"   >[debug] deviceset.go:448 libdevmapper(3): ioctl/libdm-iface.c:1742 (-1) device-mapper: message ioctl on docker-8:33-3407874-pool failed: File exists</font></div><div><font size="2"   >[debug] deviceset.go:448 libdevmapper(3): ioctl/libdm-iface.c:1742 (-1) device-mapper: message ioctl on docker-8:33-3407874-pool failed: File exists</font></div><div><font size="2"   >[debug] deviceset.go:448 libdevmapper(3): ioctl/libdm-iface.c:1742 (-1) device-mapper: message ioctl on docker-8:33-3407874-pool failed: File exists</font></div><div><font size="2"   >[debug] deviceset.go:448 libdevmapper(3): ioctl/libdm-iface.c:1742 (-1) device-mapper: message ioctl on docker-8:33-3407874-pool failed: File exists</font></div><div><font size="2"   >[debug] deviceset.go:448 libdevmapper(3): ioctl/libdm-iface.c:1742 (-1) device-mapper: message ioctl on docker-8:33-3407874-pool failed: File exists</font></div><div><font size="2"   >[debug] deviceset.go:252 registerDevice(8, ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea-init)</font></div><div><font size="2"   >[debug] deviceset.go:278 activateDeviceIfNeeded(ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea-init)</font></div><div><font size="2"   >[debug] deviceset.go:252 registerDevice(9, ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea)</font></div><div><font size="2"   >[debug] deviceset.go:992 [devmapper] UnmountDevice(hash=ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea-init)</font></div><div><font size="2"   >[debug] deviceset.go:1015 [devmapper] Unmount(/data03/docker/devicemapper/mnt/ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea-init)</font></div><div><font size="2"   >[debug] deviceset.go:1019 [devmapper] Unmount done</font></div><div><font size="2"   >[debug] deviceset.go:773 [devmapper] deactivateDevice(ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea-init)</font></div><div><font size="2"   >[debug] deviceset.go:867 Waiting for unmount of ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea-init: opencount=0</font></div><div><font size="2"   >[debug] devmapper.go:545 [devmapper] removeDevice START</font></div><div><font size="2"   >[debug] devmapper.go:559 [devmapper] removeDevice END</font></div><div><font size="2"   >[debug] deviceset.go:829 [deviceset docker-8:33-3407874] waitRemove(docker-8:33-3407874-ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea-init)</font></div><div><font size="2"   >[debug] deviceset.go:840 Waiting for removal of docker-8:33-3407874-ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea-init: exists=0</font></div><div><font size="2"   >[debug] deviceset.go:854 [deviceset docker-8:33-3407874] waitRemove(docker-8:33-3407874-ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea-init) END</font></div><div><font size="2"   >[debug] deviceset.go:793 [devmapper] deactivateDevice END</font></div><div><font size="2"   >[debug] deviceset.go:1028 [devmapper] UnmountDevice END</font></div><div><font size="2"   >[9c7f3256] -job create() = OK (0)</font></div><div><font size="2"   >[debug] server.go:1022 Calling POST /containers/{name:.*}/attach</font></div><div><font size="2"   >2014/11/07 15:36:46 POST /v1.13/containers/ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea/attach?stderr=1&amp;stdin=1&amp;stdout=1&amp;stream=1</font></div><div><font size="2"   >[9c7f3256] +job container_inspect(ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea)</font></div><div><font size="2"   >[9c7f3256] -job container_inspect(ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea) = OK (0)</font></div><div><font size="2"   >[9c7f3256] +job attach(ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea)</font></div><div><font size="2"   >[debug] attach.go:22 attach: stdin: begin</font></div><div><font size="2"   >[debug] attach.go:59 attach: stdout: begin</font></div><div><font size="2"   >[debug] server.go:1022 Calling POST /containers/{name:.*}/start</font></div><div><font size="2"   >2014/11/07 15:36:46 POST /v1.13/containers/ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea/start</font></div><div><font size="2"   >[9c7f3256] +job start(ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea)</font></div><div><font size="2"   >[debug] deviceset.go:278 activateDeviceIfNeeded(ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea)</font></div><div><font size="2"   >[debug] attach.go:97 attach: stderr: begin</font></div><div><font size="2"   >[debug] attach.go:143 attach: waiting for job 1/3</font></div><div><font size="2"   >[9c7f3256] +job allocate_interface(ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea)</font></div><div><font size="2"   >[9c7f3256] -job allocate_interface(ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea) = OK (0)</font></div><div><font size="2"   >[error] container.go:475 Error running container: operation not supported</font></div><div><font size="2"   >[9c7f3256] +job release_interface(ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea)</font></div><div><font size="2"   >[9c7f3256] -job release_interface(ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea) = OK (0)</font></div><div><font size="2"   >[error] container.go:522 ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea: Error closing terminal: invalid argument</font></div><div><font size="2"   >[debug] deviceset.go:992 [devmapper] UnmountDevice(hash=ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea)</font></div><div><font size="2"   >[debug] deviceset.go:1015 [devmapper] Unmount(/data03/docker/devicemapper/mnt/ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea)</font></div><div><font size="2"   >[debug] attach.go:76 attach: stdout: end</font></div><div><font size="2"   >[debug] attach.go:114 attach: stderr: end</font></div><div><font size="2"   >[debug] attach.go:148 attach: job 1 completed successfully</font></div><div><font size="2"   >[debug] attach.go:143 attach: waiting for job 2/3</font></div><div><font size="2"   >[debug] attach.go:148 attach: job 2 completed successfully</font></div><div><font size="2"   >[debug] attach.go:143 attach: waiting for job 3/3</font></div><div><font size="2"   >[debug] server.go:2344 Closing buffered stdin pipe</font></div><div><font size="2"   >[debug] attach.go:49 attach: stdin: end</font></div><div><font size="2"   >[debug] attach.go:148 attach: job 3 completed successfully</font></div><div><font size="2"   >[debug] attach.go:150 attach: all jobs completed successfully</font></div><div><font size="2"   >[9c7f3256] -job attach(ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea) = OK (0)</font></div><div><font size="2"   >[debug] deviceset.go:1019 [devmapper] Unmount done</font></div><div><font size="2"   >[debug] deviceset.go:773 [devmapper] deactivateDevice(ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea)</font></div><div><font size="2"   >[debug] deviceset.go:867 Waiting for unmount of ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea: opencount=0</font></div><div><font size="2"   >[debug] devmapper.go:545 [devmapper] removeDevice START</font></div><div><font size="2"   >[debug] devmapper.go:559 [devmapper] removeDevice END</font></div><div><font size="2"   >[debug] deviceset.go:829 [deviceset docker-8:33-3407874] waitRemove(docker-8:33-3407874-ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea)</font></div><div><font size="2"   >[debug] deviceset.go:840 Waiting for removal of docker-8:33-3407874-ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea: exists=0</font></div><div><font size="2"   >[debug] deviceset.go:854 [deviceset docker-8:33-3407874] waitRemove(docker-8:33-3407874-ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea) END</font></div><div><font size="2"   >[debug] deviceset.go:793 [devmapper] deactivateDevice END</font></div><div><font size="2"   >[debug] deviceset.go:1028 [devmapper] UnmountDevice END</font></div><div><font size="2"   >[9c7f3256] +job release_interface(ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea)</font></div><div><font size="2"   >[9c7f3256] -job release_interface(ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea) = OK (0)</font></div><div><font size="2"   >[error] container.go:522 ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea: Error closing terminal: invalid argument</font></div><div><font size="2"   >[debug] deviceset.go:992 [devmapper] UnmountDevice(hash=ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea)</font></div><div><font size="2"   >[debug] deviceset.go:1028 [devmapper] UnmountDevice END</font></div><div><font size="2"   >[error] driver.go:140 Warning: error unmounting device ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea: UnmountDevice: device not-mounted id ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Cannot start container ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea: operation not supported</font></div><div><font size="2"   >[9c7f3256] -job start(ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea) = ERR (1)</font></div><div><font size="2"   >[error] server.go:1048 Error making handler: Cannot start container ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea: operation not supported</font></div><div><font size="2"   >[error] server.go:90 HTTP Error: statusCode=500 Cannot start container ea41cc0b958fb35bb130db076719935085426cdbe9469edb1eafdf8315b583ea: operation not supported</font></div><p></p></pre></div><div><br></div><div>如果要使用ovs来管理虚拟交换的话, 只能在下一层使用, 而不要在上层使用, 如下图.</div><div>docker依旧使用bridge-utils管理的docker0 , 将docker0加入ovs管理的网桥br0. 这样子就可以了.</div><div>脚本如下 :&nbsp;</div><div>例子</div><div><a target="_blank" rel="nofollow" href="https://gist.github.com/noteed/8656989"   >https://gist.github.com/noteed/8656989</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># From http://goldmann.pl/blog/2014/01/21/connecting-docker-containers-on-multiple-hosts/</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   ># Edit this variable: the 'other' host.</font></div><div><font size="2"   >REMOTE_IP=188.226.138.185</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   ># Edit this variable: the bridge address on 'this' host.</font></div><div><font size="2"   >BRIDGE_ADDRESS=172.16.42.1/24</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   ># Name of the bridge (should match /etc/default/docker).</font></div><div><font size="2"   >BRIDGE_NAME=docker0</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   ># bridges</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   ># Deactivate the docker0 bridge</font></div><div><font size="2"   >ip link set $BRIDGE_NAME down</font></div><div><font size="2"   ># Remove the docker0 bridge</font></div><div><font size="2"   >brctl delbr $BRIDGE_NAME</font></div><div><font size="2"   ># Delete the Open vSwitch bridge</font></div><div><font size="2"   >ovs-vsctl del-br br0</font></div><div><font size="2"   ># Add the docker0 bridge</font></div><div><font size="2"   >brctl addbr $BRIDGE_NAME</font></div><div><font size="2"   ># Set up the IP for the docker0 bridge</font></div><div><font size="2"   >ip a add $BRIDGE_ADDRESS dev $BRIDGE_NAME</font></div><div><font size="2"   ># Activate the bridge</font></div><div><font size="2"   >ip link set $BRIDGE_NAME up</font></div><div><font size="2"   ># Add the br0 Open vSwitch bridge</font></div><div><font size="2"   >ovs-vsctl add-br br0</font></div><div><font size="2"   ># Create the tunnel to the other host and attach it to the</font></div><div><font size="2"   ># br0 bridge</font></div><div><font size="2"   >ovs-vsctl add-port br0 gre0 -- set interface gre0 type=gre options:remote_ip=$REMOTE_IP</font></div><div><font size="2"   ># Add the br0 bridge to docker0 bridge</font></div><div><font size="2"   >brctl addif $BRIDGE_NAME br0</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   ># iptables rules</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   ># Enable NAT</font></div><div><font size="2"   >iptables -t nat -A POSTROUTING -s 172.16.42.0/24 ! -d 172.16.42.0/24 -j MASQUERADE</font></div><div><font size="2"   ># Accept incoming packets for existing connections</font></div><div><font size="2"   >iptables -A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</font></div><div><font size="2"   ># Accept all non-intercontainer outgoing packets</font></div><div><font size="2"   >iptables -A FORWARD -i docker0 ! -o docker0 -j ACCEPT</font></div><div><font size="2"   ># By default allow all outgoing traffic</font></div><div><font size="2"   >iptables -A FORWARD -i docker0 -o docker0 -j ACCEPT</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   ># Restart Docker daemon to use the new BRIDGE_NAME</font></div><div><font size="2"   >service docker restart</font></div><p></p></pre></div><div><br></div><div><img title="docker cannt use openvswitch bridge direct, but can use bridge-utils managed bridge in OVS-VSCTL managed bridge - 德哥@Digoal - PostgreSQL research"   alt="docker cannt use openvswitch bridge direct, but can use bridge-utils managed bridge in OVS-VSCTL managed bridge - 德哥@Digoal - PostgreSQL research"   src="http://img1.ph.126.net/vPl48OXYSwVrpFW6ahjYlw==/1149825279880603654.png"   style="line-height: 28px; margin: 0px 10px 0px 0px;"   ></div><div>&nbsp;</div><wbr><div><br></div>[参考]<div>1.&nbsp;<a target="_blank" rel="nofollow" href="https://gist.github.com/noteed/8656989"   >https://gist.github.com/noteed/8656989</a></div><div>2.&nbsp;<a target="_blank" rel="nofollow" href="https://goldmann.pl/blog/2014/01/21/connecting-docker-containers-on-multiple-hosts/"   >https://goldmann.pl/blog/2014/01/21/connecting-docker-containers-on-multiple-hosts/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://docs.docker.com/articles/networking/"   >https://docs.docker.com/articles/networking/</a></div><div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="docker cannt use openvswitch bridge direct, but can use bridge-utils managed bridge in OVS-VSCTL managed bridge - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a><br></div></div>
	</div>
</div>
</body>
</html>