<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Don't Let your Query scan too many child tables</h2>
	<h5 id="">2011-11-15 17:09:12&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201110154337158/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">今天在给项目组实现一个PLPROXY的需求，建立了2级子表。  <DIV>父表</DIV>  <DIV>ta<FONT>bl</FONT>e<BR>  <DIV>第一级子表</DIV>  <DIV>ta<FONT>bl</FONT>e_256_0</DIV>  <DIV>  <DIV><SPAN style="WHITE-SPACE: pre;"  ></SPAN>第二级子表</DIV>  <DIV><SPAN style="WHITE-SPACE: pre;"  ></SPAN>ta<FONT>bl</FONT>e_256_0_201111 check (create_time &gt;='?' and &lt;'?')</DIV>  <DIV><SPAN style="WHITE-SPACE: pre;"  ></SPAN>...</DIV>  <DIV><SPAN style="WHITE-SPACE: pre;"  ></SPAN>ta<FONT>bl</FONT>e_256_0_201212&nbsp;check (create_time &gt;='?' and &lt;'?')</DIV></DIV>  <DIV>...</DIV>  <DIV>ta<FONT>bl</FONT>e_256_255</DIV>  <DIV>  <DIV><SPAN style="WHITE-SPACE: pre;"  ></SPAN>第二级子表</DIV>  <DIV><SPAN style="WHITE-SPACE: pre;"  ></SPAN>ta<FONT>bl</FONT>e_256_255_201111&nbsp;check (create_time &gt;='?' and &lt;'?')</DIV>  <DIV><SPAN style="WHITE-SPACE: pre;"  ></SPAN>...</DIV>  <DIV><SPAN style="WHITE-SPACE: pre;"  ></SPAN>ta<FONT>bl</FONT>e_256_255_201212&nbsp;check (create_time &gt;='?' and &lt;'?')</DIV></DIV>  <DIV><BR></DIV>  <DIV>第一级子表继承ta<FONT>bl</FONT>e, 根据userid的HASH取模分区。</DIV>  <DIV>第二级子表继承第一级子表, 根据create_time按照时间分区。</DIV>  <DIV>因此查询条件如果带上userid=?和日期的话可以直接落到一个表，查询非常快。</DIV>  <DIV>查询条件如果没有日期也没有userid那必须遍历所有子表。子表越多，速度越慢。</DIV>  <DIV>例如:</DIV>  <DIV>遍历897个表, 按照每个表的PK查询。</DIV>  <DIV>大概需要耗费150ms 。</DIV>  <DIV>而落到单表上仅仅需要0.几毫秒。</DIV>  <DIV>  <DIV><BR></DIV></DIV>  <DIV>来看个例子 :&nbsp;</DIV>  <DIV>  <DIV><FONT style="BACKGROUND-COLOR: #ffd700;"  >digoal</FONT>=&gt; select * from t<FONT>bl</FONT>_amc_mp<FONT>b</FONT>ean_tradetail where order_id='a';</DIV>  <DIV>&nbsp;----------+-------------------------+--------+----------+----------+---------+--------+------------+-------------+--------+---------</DIV>  <DIV>+---------------+---------+--------------+-------------------+----------------------------+--------</DIV>  <DIV>&nbsp;a<FONT>b</FONT>c &nbsp; &nbsp; &nbsp;| 20111115155055000000100 | &nbsp; &nbsp; &nbsp;2 | a &nbsp; &nbsp; &nbsp; &nbsp;| a &nbsp; &nbsp; &nbsp; &nbsp;| a &nbsp; &nbsp; &nbsp; | a &nbsp; &nbsp; &nbsp;| a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | a &nbsp; &nbsp; &nbsp;| a &nbsp; &nbsp; &nbsp;&nbsp;</DIV>  <DIV>| a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | a &nbsp; &nbsp; &nbsp; | a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2011-11-15 15:50:55.027624 | a</DIV>  <DIV>(1 row)</DIV>  <DIV><BR></DIV>  <DIV>Time: 155.607 ms</DIV>  <DIV><FONT style="BACKGROUND-COLOR: #ffd700;"  >digoal</FONT>=&gt; select * from t<FONT>bl</FONT>_amc_mp<FONT>b</FONT>ean_tradetail_64_41 where order_id='a';</DIV>  <DIV>&nbsp;----------+-------------------------+--------+----------+----------+---------+--------+------------+-------------+--------+---------</DIV>  <DIV>+---------------+---------+--------------+-------------------+----------------------------+--------</DIV>  <DIV>&nbsp;a<FONT>b</FONT>c &nbsp; &nbsp; &nbsp;| 20111115155055000000100 | &nbsp; &nbsp; &nbsp;2 | a &nbsp; &nbsp; &nbsp; &nbsp;| a &nbsp; &nbsp; &nbsp; &nbsp;| a &nbsp; &nbsp; &nbsp; | a &nbsp; &nbsp; &nbsp;| a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | a &nbsp; &nbsp; &nbsp;| a &nbsp; &nbsp; &nbsp;&nbsp;</DIV>  <DIV>| a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | a &nbsp; &nbsp; &nbsp; | a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2011-11-15 15:50:55.027624 | a</DIV>  <DIV>(1 row)</DIV>  <DIV><BR></DIV>  <DIV>Time: 1.815 ms</DIV>  <DIV>  <DIV><FONT style="BACKGROUND-COLOR: #ffd700;"  >digoal</FONT>=&gt; select * from t<FONT>bl</FONT>_amc_mp<FONT>b</FONT>ean_tradetail_64_41_201111 where order_id='a';</DIV>  <DIV>&nbsp;----------+-------------------------+--------+----------+----------+---------+--------+------------+-------------+--------+---------</DIV>  <DIV>+---------------+---------+--------------+-------------------+----------------------------+--------</DIV>  <DIV>&nbsp;a<FONT>b</FONT>c &nbsp; &nbsp; &nbsp;| 20111115155055000000100 | &nbsp; &nbsp; &nbsp;2 | a &nbsp; &nbsp; &nbsp; &nbsp;| a &nbsp; &nbsp; &nbsp; &nbsp;| a &nbsp; &nbsp; &nbsp; | a &nbsp; &nbsp; &nbsp;| a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | a &nbsp; &nbsp; &nbsp;| a &nbsp; &nbsp; &nbsp;&nbsp;</DIV>  <DIV>| a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | a &nbsp; &nbsp; &nbsp; | a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2011-11-15 15:50:55.027624 | a</DIV>  <DIV>(1 row)</DIV>  <DIV><BR></DIV>  <DIV>Time: 0.396 ms</DIV></DIV>  <DIV><FONT style="BACKGROUND-COLOR: #ffd700;"  >digoal</FONT>=&gt; select 155.607/1.815;</DIV>  <DIV>&nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp;&nbsp;</DIV>  <DIV>---------------------</DIV>  <DIV>&nbsp;85.7338842975206612</DIV>  <DIV>(1 row)</DIV>  <DIV><BR></DIV>  <DIV>Time: 0.210 ms</DIV></DIV>  <DIV>接近表的个数的比例64 .</DIV>  <DIV><BR></DIV>  <DIV>比较容易接受的解决办法：</DIV>  <DIV>1. 分区分布到多个数据库, 减少单库的子表个数, 同时使用并发查询有效的提高了整体响应速度。</DIV>  <DIV>2. 在时间字段上创建约束，查询时带上时间条件，规避查询包含未来日期的子表。</DIV>  <DIV><BR></DIV>  <DIV><BR></DIV>  <DIV><BR></DIV>  <DIV><BR></DIV>  <DIV><BR></DIV>  <DIV><BR></DIV>  <DIV><BR></DIV>  <DIV><BR></DIV>  <DIV><BR></DIV>  <DIV><BR><WBR></DIV></DIV></div>
	</div>
</div>
</body>
</html>