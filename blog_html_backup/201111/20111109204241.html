<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">UPDATE parent TABLE where current of cursor instead Dynamic TABLENAME</h2>
	<h5 id="">2011-11-09 20:42:41&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201110982243362/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">  <p>前几天写的关于帐号的货币到期的案例。业务逻辑可以参考我之前写的相关BLOG(在本文末尾)。</p>  <p>其中消费函数，里面只涉及了单BALANCE表的更新。</p>  <p>今天业务开发人员找到我，可能存在多表更新的情况。而且要按照特定的顺序来更新，来说说背景，用户的账户分赠与的和自己充值的。</p>  <p>赠与的金钱有效期较短，用user_balance_give来表示。</p>  <p>自己充值的金钱有效期较长，用user_balance_charge来表示。</p>  <p>user_balance_give和user_balance_charge都做了分区，按YYYYMM来分，这样对于DBA来说会 比较好维护历史数据，不影响业务。</p>  <p>所以消费的时候更新的其实是按月分区的子表如user_balance_give_201111。但是在消费函数中就可能要使用动态SQL来拼写表名进行更新。</p>  <p>这样一方面是加大了函数的复杂度，动态SQL本身也使得性能极度下降，性能降低多少可以参考我上一篇BLOG(在本文末尾)。</p>  <p>于是想了一个办法，巧妙的使用PostgreSQL继承的功能，达成了业务的需求。</p>  <p>涉及到一个表同时继承多个表（允许表结构不一样，只要有重叠部分）。</p>  <p>一个父表被多个不同表结构的子表继承。</p>  <p>例如 :</p>  <p>以下为充值表的父表，为管理便利而创建。&nbsp;</p>  <p></p><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; create table user_balance_charge (userid bigint,balance numeric check(balance &gt;= 0),expired date,c1 text,c2 text,primary key (userid,expired));<br>NOTICE:&nbsp; CREATE TABLE / PRIMARY KEY will create implicit index "user_balance_charge_pkey" for table "user_balance_charge"<br>CREATE TABLE</font></p></pre>  <p>以下为赠与表的父表，为管理便利而创建。</p>  <p></p><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; create table user_balance_give (userid bigint,balance numeric check(balance &gt;= 0),expired date,g1 int,g2 text,g3 text,primary key (userid,expired));<br>NOTICE:&nbsp; CREATE TABLE / PRIMARY KEY will create implicit index "user_balance_give_pkey" for table "user_balance_give"<br>CREATE TABLE</font></p></pre>以下为用于消费更新的父表，为简化消费函数的逻辑而创建。  <p></p><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; create table user_balance_update (userid bigint,balance numeric,expired date);<br>CREATE TABLE</font></p></pre>  <p>下面创建充值表的子表。</p>  <p></p><pre class="prettyprint"  ><p></p><p><font size="2"  >digoal=&gt; create table user_balance_charge_201111 (like user_balance_charge including all) inherits(user_balance_charge,user_balance_update);<br>NOTICE:&nbsp; merging multiple inherited definitions of column "userid"<br>NOTICE:&nbsp; merging multiple inherited definitions of column "balance"<br>NOTICE:&nbsp; merging multiple inherited definitions of column "expired"<br>NOTICE:&nbsp; merging column "userid" with inherited definition<br>NOTICE:&nbsp; merging column "balance" with inherited definition<br>NOTICE:&nbsp; merging column "expired" with inherited definition<br>NOTICE:&nbsp; merging column "c1" with inherited definition<br>NOTICE:&nbsp; merging column "c2" with inherited definition<br>NOTICE:&nbsp; merging constraint "user_balance_charge_balance_check" with inherited definition<br>NOTICE:&nbsp; CREATE TABLE / PRIMARY KEY will create implicit index "user_balance_charge_201111_pkey" for table "user_balance_charge_201111"<br>CREATE TABLE</font></p>  <p><font size="2"  >digoal=&gt; create table user_balance_charge_201112 (like user_balance_charge including all) inherits(user_balance_charge,user_balance_update);<br>NOTICE:&nbsp; merging multiple inherited definitions of column "userid"<br>NOTICE:&nbsp; merging multiple inherited definitions of column "balance"<br>NOTICE:&nbsp; merging multiple inherited definitions of column "expired"<br>NOTICE:&nbsp; merging column "userid" with inherited definition<br>NOTICE:&nbsp; merging column "balance" with inherited definition<br>NOTICE:&nbsp; merging column "expired" with inherited definition<br>NOTICE:&nbsp; merging column "c1" with inherited definition<br>NOTICE:&nbsp; merging column "c2" with inherited definition<br>NOTICE:&nbsp; merging constraint "user_balance_charge_balance_check" with inherited definition<br>NOTICE:&nbsp; CREATE TABLE / PRIMARY KEY will create implicit index "user_balance_charge_201112_pkey" for table "user_balance_charge_201112"<br>CREATE TABLE</font></p><p></p></pre>  <p>从子表的显示可以看出这个表继承了两个父表。<br></p><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; \d+ user_balance_charge_201111<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Table "digoal.user_balance_charge_201111"<br>&nbsp;Column&nbsp; |&nbsp; Type&nbsp;&nbsp; | Modifiers | Storage&nbsp; | Description <br>---------+---------+-----------+----------+-------------<br>&nbsp;userid&nbsp; | bigint&nbsp; | not null&nbsp; | plain&nbsp;&nbsp;&nbsp; | <br>&nbsp;balance | numeric |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | main&nbsp;&nbsp;&nbsp;&nbsp; | <br>&nbsp;expired | date&nbsp;&nbsp;&nbsp; | not null&nbsp; | plain&nbsp;&nbsp;&nbsp; | <br>&nbsp;c1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | text&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | extended | <br>&nbsp;c2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | text&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | extended | <br>Indexes:<br>&nbsp;&nbsp;&nbsp; "user_balance_charge_201111_pkey" PRIMARY KEY, btree (userid, expired)<br>Check constraints:<br>&nbsp;&nbsp;&nbsp; "user_balance_charge_balance_check" CHECK (balance &gt;= 0::numeric)<br>Inherits: user_balance_charge,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; user_balance_update<br>Has OIDs: no</font></p></pre>  <p>下面创建赠与表的子表。</p>  <p></p><pre class="prettyprint"  ><p></p><p><font size="2"  >digoal=&gt; create table user_balance_give_201111 (like user_balance_give including all) inherits(user_balance_give,user_balance_update);<br>NOTICE:&nbsp; merging multiple inherited definitions of column "userid"<br>NOTICE:&nbsp; merging multiple inherited definitions of column "balance"<br>NOTICE:&nbsp; merging multiple inherited definitions of column "expired"<br>NOTICE:&nbsp; merging column "userid" with inherited definition<br>NOTICE:&nbsp; merging column "balance" with inherited definition<br>NOTICE:&nbsp; merging column "expired" with inherited definition<br>NOTICE:&nbsp; merging column "g1" with inherited definition<br>NOTICE:&nbsp; merging column "g2" with inherited definition<br>NOTICE:&nbsp; merging column "g3" with inherited definition<br>NOTICE:&nbsp; merging constraint "user_balance_give_balance_check" with inherited definition<br>NOTICE:&nbsp; CREATE TABLE / PRIMARY KEY will create implicit index "user_balance_give_201111_pkey" for table "user_balance_give_201111"<br>CREATE TABLE</font></p>  <p><font size="2"  >digoal=&gt; create table user_balance_give_201112 (like user_balance_give including all) inherits(user_balance_give,user_balance_update);<br>NOTICE:&nbsp; merging multiple inherited definitions of column "userid"<br>NOTICE:&nbsp; merging multiple inherited definitions of column "balance"<br>NOTICE:&nbsp; merging multiple inherited definitions of column "expired"<br>NOTICE:&nbsp; merging column "userid" with inherited definition<br>NOTICE:&nbsp; merging column "balance" with inherited definition<br>NOTICE:&nbsp; merging column "expired" with inherited definition<br>NOTICE:&nbsp; merging column "g1" with inherited definition<br>NOTICE:&nbsp; merging column "g2" with inherited definition<br>NOTICE:&nbsp; merging column "g3" with inherited definition<br>NOTICE:&nbsp; merging constraint "user_balance_give_balance_check" with inherited definition<br>NOTICE:&nbsp; CREATE TABLE / PRIMARY KEY will create implicit index "user_balance_give_201112_pkey" for table "user_balance_give_201112"<br>CREATE TABLE</font></p><p></p></pre>  <p>从子表的显示可以看出这个表继承了两个父表。<br></p><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; \d+ user_balance_give_201111<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Table "digoal.user_balance_give_201111"<br>&nbsp;Column&nbsp; |&nbsp; Type&nbsp;&nbsp; | Modifiers | Storage&nbsp; | Description <br>---------+---------+-----------+----------+-------------<br>&nbsp;userid&nbsp; | bigint&nbsp; | not null&nbsp; | plain&nbsp;&nbsp;&nbsp; | <br>&nbsp;balance | numeric |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | main&nbsp;&nbsp;&nbsp;&nbsp; | <br>&nbsp;expired | date&nbsp;&nbsp;&nbsp; | not null&nbsp; | plain&nbsp;&nbsp;&nbsp; | <br>&nbsp;g1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | integer |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | plain&nbsp;&nbsp;&nbsp; | <br>&nbsp;g2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | text&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | extended | <br>&nbsp;g3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | text&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | extended | <br>Indexes:<br>&nbsp;&nbsp;&nbsp; "user_balance_give_201111_pkey" PRIMARY KEY, btree (userid, expired)<br>Check constraints:<br>&nbsp;&nbsp;&nbsp; "user_balance_give_balance_check" CHECK (balance &gt;= 0::numeric)<br>Inherits: user_balance_give,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; user_balance_update<br>Has OIDs: no</font></p></pre>  <p>接下来创建消费函数 ： </p>  <p></p><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; \sf consume<br>CREATE OR REPLACE FUNCTION digoal.consume_father(i_userid bigint, i_balance numeric)<br>&nbsp;RETURNS integer<br>&nbsp;LANGUAGE plpgsql<br>AS $function$<br>declare<br>v_balance1 numeric;<br>v_balance2 numeric;<br>v_userid int8;<br>v_expired date;<br>v_cursor1 refcursor;<br>begin<br>perform sum(balance) from user_balance_update where userid=i_userid and expired &gt;= current_date and balance&gt;0 having sum(balance)&gt;=i_balance;<br>if found then<br>v_balance1 = i_balance;<br>-- raise notice 'v_balance1: %',v_balance1;<br>open v_cursor1 for select userid,balance,expired from user_balance_update where userid=i_userid and expired &gt;= current_date and balance&gt;0 order by expired for update;<br>while v_balance1&gt;0 LOOP<br>fetch from v_cursor1 into v_userid,v_balance2,v_expired;<br>update user_balance_update set balance=(case when balance&lt;=v_balance1 then 0 else balance-v_balance1 end) where current of v_cursor1;<br>v_balance1=v_balance1-v_balance2;<br>-- raise notice 'v_balance1: %',v_balance1;<br>-- raise notice 'v_balance2: %',v_balance2;<br>END LOOP;<br>CLOSE v_cursor1;<br>else<br>return 1;<br>end if;<br>if v_balance1&gt;0 then<br>raise EXCEPTION 'USER: % consume failed.', user_id;<br>return 3;<br>end if;<br>return 0;<br>exception<br>when others then<br>return 2;<br>end;<br>$function$</font></p></pre>  <p><br>然后往4个子表分别插入一些充值和赠与的记录。</p>  <p></p><pre class="prettyprint"  ><p></p><p><font size="2"  >digoal=&gt; select current_date,* from user_balance_charge_201111 order by expired;<br>&nbsp;&nbsp;&nbsp; date&nbsp;&nbsp;&nbsp; | userid | balance |&nbsp; expired&nbsp;&nbsp; |&nbsp;&nbsp; c1&nbsp;&nbsp; |&nbsp; c2&nbsp; <br>------------+--------+---------+------------+--------+------<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-07 | digoal | zhou<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-08 | digoal | zhou<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-09 | digoal | zhou<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-11 | digoal | zhou<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-13 | digoal | zhou<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-14 | digoal | zhou<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-15 | digoal | zhou<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-17 | digoal | zhou<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-19 | digoal | zhou<br>(9 rows)</font></p>  <p><font size="2"  >digoal=&gt; select current_date,* from user_balance_charge_201112 order by expired;<br>&nbsp;&nbsp;&nbsp; date&nbsp;&nbsp;&nbsp; | userid | balance |&nbsp; expired&nbsp;&nbsp; |&nbsp;&nbsp; c1&nbsp;&nbsp; |&nbsp; c2&nbsp; <br>------------+--------+---------+------------+--------+------<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-07 | digoal | zhou<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-08 | digoal | zhou<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-09 | digoal | zhou<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-11 | digoal | zhou<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-12 | digoal | zhou<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-13 | digoal | zhou<br>(6 rows)</font></p>  <p><font size="2"  >digoal=&gt; select current_date,* from user_balance_give_201111 order by expired;<br>&nbsp;&nbsp;&nbsp; date&nbsp;&nbsp;&nbsp; | userid | balance |&nbsp; expired&nbsp;&nbsp; | g1 |&nbsp; g2&nbsp; |&nbsp; g3&nbsp; <br>------------+--------+---------+------------+----+------+------<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-06 |&nbsp; 1 | zhou | test<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-09 |&nbsp; 1 | zhou | test<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-10 |&nbsp; 1 | zhou | test<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-12 |&nbsp; 1 | zhou | test<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-14 |&nbsp; 1 | zhou | test<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-16 |&nbsp; 1 | zhou | test<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-18 |&nbsp; 1 | zhou | test<br>(7 rows)</font></p>  <p><font size="2"  >digoal=&gt; select current_date,* from user_balance_give_201112 order by expired;<br>&nbsp;&nbsp;&nbsp; date&nbsp;&nbsp;&nbsp; | userid | balance |&nbsp; expired&nbsp;&nbsp; | g1 |&nbsp; g2&nbsp; |&nbsp; g3&nbsp; <br>------------+--------+---------+------------+----+------+------<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-05 |&nbsp; 1 | zhou | test<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-09 |&nbsp; 1 | zhou | test<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-10 |&nbsp; 1 | zhou | test<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-12 |&nbsp; 1 | zhou | test<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-13 |&nbsp; 1 | zhou | test<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-18 |&nbsp; 1 | zhou | test<br>(6 rows)</font></p><p></p></pre>  <p><br>通过user_balance_update这个父表来查看这些数据。</p>  <p></p><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; select current_date,* from user_balance_update order by expired;<br>&nbsp;&nbsp;&nbsp; date&nbsp;&nbsp;&nbsp; | userid | balance |&nbsp; expired&nbsp;&nbsp; <br>------------+--------+---------+------------<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-05<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-06<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-07<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-07<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-08<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-08<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-09<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-09<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-09<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-09<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-10<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-10<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-11<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-11<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-12<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-12<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-12<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-13<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-13<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-13<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-14<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-14<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-15<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-16<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-17<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-18<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-18<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-19<br>(28 rows)</font></p></pre>  <p>接下来消费测试一下，看看能不能满足需求。</p>  <p></p><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; select * from consume_father(1,16);<br>&nbsp;consume_father <br>----------------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br>(1 row)</font></p></pre>  <p>看看是不是满足需求，结果满足。</p>  <p></p><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; select current_date,* from user_balance_update order by expired;<br>&nbsp;&nbsp;&nbsp; date&nbsp;&nbsp;&nbsp; | userid | balance |&nbsp; expired&nbsp;&nbsp; <br>------------+--------+---------+------------<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-05<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-06<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-07<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-07<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-08<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-08<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 | 2011-11-09<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 | 2011-11-09<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 | 2011-11-09<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 | 2011-11-09<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 | 2011-11-10<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 | 2011-11-10<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 | 2011-11-11<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 | 2011-11-11<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-12<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-12<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-12<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-13<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-13<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-13<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-14<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-14<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-15<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-16<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-17<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-18<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-18<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-19<br>(28 rows)</font></p></pre>  <p>再消费一笔 : </p>  <p></p><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; select * from consume_father(1,5);<br>&nbsp;consume_father <br>----------------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br>(1 row)</font></p></pre>  <p>得到预期的结果。</p>  <p></p><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; select current_date,* from user_balance_update order by expired;<br>&nbsp;&nbsp;&nbsp; date&nbsp;&nbsp;&nbsp; | userid | balance |&nbsp; expired&nbsp;&nbsp; <br>------------+--------+---------+------------<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-05<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-06<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-07<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-07<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-08<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-08<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 | 2011-11-09<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 | 2011-11-09<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 | 2011-11-09<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 | 2011-11-09<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 | 2011-11-10<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 | 2011-11-10<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 | 2011-11-11<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 | 2011-11-11<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 | 2011-11-12<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 | 2011-11-12<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 | 2011-11-12<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-13<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-13<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-13<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-14<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-14<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-15<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-16<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-17<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-18<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-18<br>&nbsp;2011-11-09 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | 2011-11-19<br>(28 rows)</font></p></pre>  <p>这里巧妙的使用了继承的特性，达成了业务的需求，并且处理逻辑比较简单。</p>  <p>因为游标返回的是个链接，真正更新的是子表，并且使用父表还节约了代码，结合9.1.1的新性能改进处order by child table，无需合并结果再order by ，效率非常高。</p>  <p>【讨论】</p><p></p><p>问题:&nbsp;</p><p>就以你这个应用为例，设计上的事情再问问：</p><p>1、我看了没有oid和timestamp ,实际应用中，加了没有。对于逻辑主键和业务主键取舍能否给点意见。</p><p>2、虽然做了分表，但是随着时间的增长， 子表会越来越多，查询也会越来越慢，，如何处理历史数据：1、过期记录，，3 早期的表。</p><p><br></p><p>回答:&nbsp;</p><p>HI，</p><p>1. 本文内容主要针对的是UPDATE parent TABLE where current of cursor instead execute with Dynamic TABLENAME应用场景。字段方面省掉了实际应用不方便细化，请见谅。</p><p>2. 过期金币子表可以脱离继承(业务逻辑参考我之前写的BLOG<a href="http://blog.163.com/digoal@126/blog/static/163877040201110314133817/"  >http://blog.163.com/digoal@126/blog/static/163877040201110314133817</a>)，实际是不影响的。</p><p><br></p>  <p>[参考]</p>  <p><a href="http://blog.163.com/digoal@126/blog/static/1638770402011109103953350/"  >http://blog.163.com/digoal@126/blog/static/1638770402011109103953350/</a></p>  <p><a href="http://blog.163.com/digoal@126/blog/static/163877040201110314133817/"  >http://blog.163.com/digoal@126/blog/static/163877040201110314133817/</a></p>  <p>&nbsp;</p>  <p>&nbsp;</p>  <p><wbr></p></div>
	</div>
</div>
</body>
</html>