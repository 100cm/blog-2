<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">CIFS VFS: No response to cmd $n mid $m</h2>
	<h5 id="">2011-11-14 13:19:39&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402011101411939867/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">最近一台Linux服务器报了一堆<div><div>&nbsp;CIFS VFS: Unexpected lookup error -20</div><div>&nbsp;CIFS VFS: Unexpected lookup error -20</div><div>&nbsp;CIFS VFS: Unexpected lookup error -20</div><div>&nbsp;CIFS VFS: No response for cmd 50 mid 7244</div><div>&nbsp;CIFS VFS: No response to cmd 4 mid 47810</div><div>&nbsp;CIFS VFS: Send error in Close = -11</div><div>&nbsp;CIFS VFS: No response for cmd 50 mid 47818</div><div>&nbsp;CIFS VFS: No response for cmd 50 mid 47822</div><div>&nbsp;CIFS VFS: No response to cmd 5 mid 15521</div><div>&nbsp;CIFS VFS: Send error in Flush = -11</div><div>&nbsp;CIFS VFS: Write2 ret -11, wrote 0</div><div>&nbsp;CIFS VFS: Send error in Close = -9</div><div>&nbsp;CIFS VFS: No response for cmd 50 mid 15526</div><div>&nbsp;CIFS VFS: No response for cmd 50 mid 15530</div>错误。<wbr></div><div>没有头绪, 查了一下google,&nbsp;</div><div><div>/sbin/modprobe cifs</div><div>/bin/echo 0 &gt; /proc/fs/cifs/OplockEnabled</div></div><div>/bin/echo 0 &gt; /proc/fs/cifs/LookupCacheEnabled</div><div><br></div><div><br></div><div>转载如下 :&nbsp;</div><div><br></div><div><div>On a few systems, I've noticed CIFS mounts have a tendency to lock up the system when transferring large files, or a shitload of small ones in quick succession. When this happens, the system may or may not completely lock up, and lines like these will appear in your syslog:</div><div><br></div><div>Aug 1 22:58:16 dreadnought kernel: CIFS VFS: No response to cmd 46 mid 25661&nbsp;</div><div>Aug 1 22:58:16 dreadnought kernel: CIFS VFS: Send error in read = -11</div><div>Aug 1 22:58:16 dreadnought kernel: CIFS VFS: No response for cmd 50 mid 25664</div><div>Aug 1 22:58:16 dreadnought kernel: CIFS VFS: No response to cmd 47 mid 25663</div><div>Aug 1 22:58:20 dreadnought kernel: CIFS VFS: No response to cmd 47 mid 25662</div><div>Aug 1 22:58:20 dreadnought kernel: CIFS VFS: Write2 ret -11, written = 0</div><div>Aug 1 22:58:20 dreadnought kernel: CIFS VFS: Send error in read = -9</div><div>Aug 1 22:58:20 dreadnought kernel: CIFS VFS: Write2 ret -9, written = 0</div><div>Aug 1 22:59:52 dreadnought kernel: CIFS VFS: No writable handles for inode</div><div>Aug 1 23:00:29 dreadnought kernel: CIFS VFS: close with pending writes</div><div>Aug 1 23:00:36 dreadnought kernel: CIFS VFS: close with pending writes</div><div>Aug 1 23:01:16 dreadnought kernel: CIFS VFS: No writable handles for inode</div><div>Aug 1 23:02:28 dreadnought kernel: CIFS VFS: close with pending writes</div><div>Aug 1 23:03:23 dreadnought kernel: CIFS VFS: close with pending writes</div><div>Aug 1 23:03:44 dreadnought kernel: CIFS VFS: close with pending writes</div><div>Aug 1 23:05:35 dreadnought kernel: CIFS VFS: No writable handles for inode</div><div>Aug 1 23:06:18 dreadnought kernel: CIFS VFS: close with pending writes</div><div>Aug 1 23:06:35 dreadnought kernel: CIFS VFS: close with pending writes</div><div>Aug 1 23:06:46 dreadnought kernel: CIFS VFS: No writable handles for inode</div><div>Aug 1 23:06:46 dreadnought kernel: CIFS VFS: close with pending writes</div><div>Aug 1 23:07:02 dreadnought kernel: CIFS VFS: close with pending writes</div><div>Aug 1 23:07:46 dreadnought kernel: CIFS VFS: server not respondingI found a workaround which involves disabling Opportunistic Locking. This will have a small performance impact, but at least the thing wont hang up and use 100% CPU for no goddamn reason. Yes, this article has an angry tone, because this issue has eaten way too much of my time today.</div><div><br></div><div>To disable Opportunistic Locking, you have to set the contents of the file "/proc/fs/cifs/OplockEnabled" to 0. This file only exists after the cifs module has been loaded, and will be replaced if the module is unloaded and reloaded. Thus, I configured my /etc/rc.local script (use whatever equivalent your distro has to a startup script) to both load the cifs module and set the contents of said file:</div><div><br></div><div># cifs client workaround</div><div>modprobe cifs</div><div>echo 0 &gt; /proc/fs/cifs/OplockEnabledThere you go.</div></div><div><br></div>回复 :&nbsp;<br><div><p>My function use cifs protocol to transfer file and it usually occur “CIFS  VFS: Send error in read = -11<br>” error.<br>I searched the cifs reference and  get a ways to resovle it.</p> <p><a rel="nofollow" href="http://pserver.samba.org/samba/ftp/cifs-cvs/linux-cifs-client-guide.pdf"  >http://pserver.samba.org/samba/ftp/cifs-cvs/linux-cifs-client-guide.pdf</a></p> <p>”<br>Performance Considerations<br>Server speed, server disk speed and  network speed can constrain the overall performance of a cifs<br>mount, but in  some cases, client client configuration settings can be changed to increase  performance:<br>1) size of file write (wsize). The Linux CIFS client usually  sends 56K writes (14 pages) and is<br>limited to 56K maximum unless mounted  forcedirectio.<br>2) size of file read (rsize). The Linux CIFS client usually  sends 16K reads (4 pages). Since CIFS<br>large network buffers are about 16K in  size by default, increasing the rsize would have little<br>effect unless the  setting of module load parameter CIFSMaxBufSize (via insmod) also  is<br>increased.<br>”</p> <p>I just lower the block of data what i want to write.</p> <p>you can use command “modinfo cifs” to get the cifs read or write buffer size  and buffersize scope.</p><p><br></p><p>【参考】</p><p>http://blog.dhampir.no/content/cifs-vfs-no-response-for-cmd-n-mid</p><p>http://cweiske.de/tagebuch/Timed%20permission%20problems%20on%20CIFS.htm</p></div></div>
	</div>
</div>
</body>
</html>