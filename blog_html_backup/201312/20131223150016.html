<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 add logical replication command and parameters</h2>
	<h5 id="">2013-12-23 15:00:16&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201311232536237/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">逻辑复制已经讲了蛮久, 以前拿未提交的补丁测试过一下.<div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201362693010810/"   >http://blog.163.com/digoal@126/blog/static/163877040201362693010810/</a></div><div><span style="line-height: 28px;"   >现在终于看到9.4提交的一些信息了, 从提交的信息来看, 基础基本上打好了. 看样子逻辑复制很快就要实现了.</span></div><div><pre class="prettyprint"   ><p><span style="font-size: small; line-height: normal;"   >Add&nbsp;new&nbsp;wal_level,&nbsp;logical,&nbsp;sufficient&nbsp;for&nbsp;logical&nbsp;decoding.</span><br style="font-size: small; line-height: normal;"   ><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >When&nbsp;wal_level=logical,&nbsp;we'll&nbsp;log&nbsp;columns&nbsp;from&nbsp;the&nbsp;old&nbsp;tuple&nbsp;as</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >configured&nbsp;by&nbsp;the&nbsp;REPLICA&nbsp;IDENTITY&nbsp;facility&nbsp;added&nbsp;in&nbsp;commit</span><br style="font-size: small; line-height: normal;"   ><a style="color: rgb(136, 0, 0); text-decoration: none; font-size: small; line-height: normal;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=object;h=07cacba983ef79be4a84fcd0e0ca3b5fcb85dd65"   >07cacba983ef79be4a84fcd0e0ca3b5fcb85dd65</a><span style="font-size: small; line-height: normal;"   >.&nbsp;&nbsp;This&nbsp;makes&nbsp;it&nbsp;possible</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >a&nbsp;properly-configured&nbsp;logical&nbsp;replication&nbsp;solution&nbsp;to&nbsp;correctly</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >follow&nbsp;table&nbsp;updates&nbsp;even&nbsp;if&nbsp;they&nbsp;change&nbsp;the&nbsp;chosen&nbsp;key&nbsp;columns,</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >or,&nbsp;with&nbsp;REPLICA&nbsp;IDENTITY&nbsp;FULL,&nbsp;even&nbsp;if&nbsp;the&nbsp;table&nbsp;has&nbsp;no&nbsp;key&nbsp;at</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >all.&nbsp;&nbsp;Note&nbsp;that&nbsp;updates&nbsp;which&nbsp;do&nbsp;not&nbsp;modify&nbsp;the&nbsp;replica&nbsp;identity</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >column&nbsp;won't&nbsp;log&nbsp;anything&nbsp;extra,&nbsp;making&nbsp;the&nbsp;choice&nbsp;of&nbsp;a&nbsp;good&nbsp;key</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >(i.e.&nbsp;one&nbsp;that&nbsp;will&nbsp;rarely&nbsp;be&nbsp;changed)&nbsp;important&nbsp;to&nbsp;performance</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >when&nbsp;wal_level=logical&nbsp;is&nbsp;configured.</span><br style="font-size: small; line-height: normal;"   ><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >Each&nbsp;insert,&nbsp;update,&nbsp;or&nbsp;delete&nbsp;to&nbsp;a&nbsp;catalog&nbsp;table&nbsp;will&nbsp;also&nbsp;log</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >the&nbsp;CMIN&nbsp;and/or&nbsp;CMAX&nbsp;values&nbsp;of&nbsp;stamped&nbsp;by&nbsp;the&nbsp;current&nbsp;transaction.</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >This&nbsp;is&nbsp;necessary&nbsp;because&nbsp;logical&nbsp;decoding&nbsp;will&nbsp;require&nbsp;access&nbsp;to</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >historical&nbsp;snapshots&nbsp;of&nbsp;the&nbsp;catalog&nbsp;in&nbsp;order&nbsp;to&nbsp;decode&nbsp;some&nbsp;data</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >types,&nbsp;and&nbsp;the&nbsp;CMIN/CMAX&nbsp;values&nbsp;that&nbsp;we&nbsp;may&nbsp;need&nbsp;in&nbsp;order&nbsp;to&nbsp;judge</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >row&nbsp;visibility&nbsp;may&nbsp;have&nbsp;been&nbsp;overwritten&nbsp;by&nbsp;the&nbsp;time&nbsp;we&nbsp;need&nbsp;them.</span><br style="font-size: small; line-height: normal;"   ><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >Andres&nbsp;Freund,&nbsp;reviewed&nbsp;in&nbsp;various&nbsp;versions&nbsp;by&nbsp;myself,&nbsp;Heikki</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >Linnakangas,&nbsp;KONDO&nbsp;Mitsumasa,&nbsp;and&nbsp;many&nbsp;others.</span></p></pre></div><div><span style="font-family: monospace; font-size: small; line-height: normal;"   ><br></span></div><div><br></div><div><span style="line-height: 28px;"   >其中包含一些变更 &nbsp;:&nbsp;</span></div><div><span style="line-height: 28px;"   >alter table 语法中和逻辑复制相关的部分, REPLICA IDENTITY, 设置如何定位到变更或删除的数据行. 可以设置为主键, FULL(表示所有字段), 或者非空的唯一索引. 例如设置为主键的话, 那么XLOG中记录OLD值就只记录主键的OLD值. FULL的话是记录所有的字段的OLD值. 值影响logical级别的wal.</span></div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-altertable.html"   >http://www.postgresql.org/docs/devel/static/sql-altertable.html</a></div><div><pre style="font-size: 12px; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border: 1px solid rgb(207, 207, 207); padding: 2ex; margin-top: 2ex; margin-bottom: 2ex; margin-left: 2ex; overflow: auto; border-top-left-radius: 8px; border-top-right-radius: 8px; border-bottom-right-radius: 8px; border-bottom-left-radius: 8px; background-color: rgb(247, 247, 247); line-height: normal;"   >    REPLICA IDENTITY {DEFAULT | USING INDEX <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >index_name</tt> | FULL | NOTHING}</pre></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >REPLICA IDENTITY</font></div><div><font size="2"   >This form changes the information which is written to the write-ahead log to identify rows which are updated or deleted. This option has no effect except when logical replication is in use. DEFAULT records the old values of the columns of the primary key, if any. USING INDEX records the old values of the columns covered by the named index, which must be unique, not partial, not deferrable, and include only columns marked NOT NULL. FULL records the old values of all columns in the row. NOTHING records no information about the old row. In all cases, no old values are logged unless at least one of the columns that would be logged differs between the old and new versions of the row.</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >参数和逻辑复制相关的部分, wal_level新增了logical级别, 是目前的最高级别, 包含逻辑复制需要的额外xlog信息.</span></div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/runtime-config-wal.html#RUNTIME-CONFIG-WAL-SETTINGS"   >http://www.postgresql.org/docs/devel/static/runtime-config-wal.html#RUNTIME-CONFIG-WAL-SETTINGS</a></div><div><dt style="font-family: verdana, sans-serif; line-height: normal;"   ><pre class="prettyprint"   ><p style="font-size: 12px;"   ></p><dt style="font-family: verdana, sans-serif; line-height: normal;"   ><font size="2"   ><tt>wal_level</tt>&nbsp;(<tt>enum</tt>)</font></dt><dd style="font-family: verdana, sans-serif; line-height: normal;"   ><p style="line-height: 1.5em; margin: 1.2em 0em;"   ><font size="2"   ><tt>wal_level</tt>&nbsp;determines how much information is written to the WAL. The default value is&nbsp;<tt>minimal</tt>, which writes only the information needed to recover from a crash or immediate shutdown.&nbsp;<tt>archive</tt>&nbsp;adds logging required for WAL archiving;&nbsp;<tt>hot_standby</tt>&nbsp;further adds information required to run read-only queries on a standby server; and, finally&nbsp;<tt>logical</tt>&nbsp;adds information necessary to support logical decoding. Each level includes the information logged at all lower levels. This parameter can only be set at server start.</font></p><p style="line-height: 1.5em; margin: 1.2em 0em;"   ><font size="2"   >In&nbsp;<tt>minimal</tt>&nbsp;level, WAL-logging of some bulk operations can be safely skipped, which can make those operations much faster (see&nbsp;<a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/populate.html#POPULATE-PITR"   >Section 14.4.7</a>). Operations in which this optimization can be applied include:</font></p><table border="0"   style="margin-left: 2ex;"   ><tbody><tr><td><tt><font size="2"   >CREATE TABLE AS</font></tt></td></tr><tr><td><tt><font size="2"   >CREATE INDEX</font></tt></td></tr><tr><td><tt><font size="2"   >CLUSTER</font></tt></td></tr><tr><td><font size="2"   ><tt>COPY</tt>&nbsp;into tables that were created or truncated in the same transaction</font></td></tr></table><font size="2"   >But minimal WAL does not contain enough information to reconstruct the data from a base backup and the WAL logs, so&nbsp;<tt>archive</tt>&nbsp;or higher must be used to enable WAL archiving (<a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/runtime-config-wal.html#GUC-ARCHIVE-MODE"   >archive_mode</a>) and streaming replication.</font><p style="line-height: 1.5em; margin: 1.2em 0em;"   ><font size="2"   >In&nbsp;<tt>hot_standby</tt>&nbsp;level, the same information is logged as with&nbsp;<tt>archive</tt>, plus information needed to reconstruct the status of running transactions from the WAL. To enable read-only queries on a standby server,&nbsp;<tt>wal_level</tt>&nbsp;must be set to&nbsp;<tt>hot_standby</tt>&nbsp;or higher on the primary, and&nbsp;<a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/runtime-config-replication.html#GUC-HOT-STANDBY"   >hot_standby</a>&nbsp;must be enabled in the standby. It is thought that there is little measurable difference in performance between using&nbsp;<tt>hot_standby</tt>&nbsp;and&nbsp;<tt>archive</tt>&nbsp;levels, so feedback is welcome if any production impacts are noticeable.</font></p><p style="line-height: 1.5em; margin: 1.2em 0em;"   ><font size="2"   >In&nbsp;<tt>logical</tt>&nbsp;level, the same information is logged as with&nbsp;<tt>hot_standby</tt>, plus information needed to allow extracting logical changesets from the WAL. Using a level of&nbsp;<tt>logical</tt>&nbsp;will increase the WAL volume, particularly if many tables are configured for&nbsp;<tt>REPLICA IDENTITY FULL</tt>&nbsp;and many&nbsp;<tt>UPDATE</tt>&nbsp;and&nbsp;<tt>DELETE</tt>&nbsp;statements are executed.</font></p></dd><p style="font-size: 12px;"   ></p></pre></dt></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >系统表和逻辑复制相关的部分</span></div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/catalog-pg-class.html"   >http://www.postgresql.org/docs/devel/static/catalog-pg-class.html</a></div><div>pg_class.relreplident</div><div><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; background-color: rgb(224, 236, 239); border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"   ><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>relreplident</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>char</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Columns used to form&nbsp;<span>"replica identity"</span>&nbsp;for rows:&nbsp;<tt>d</tt>&nbsp;= default (primary key, if any),&nbsp;<tt>n</tt>&nbsp;= nothing,&nbsp;<tt>f</tt>&nbsp;= all columns&nbsp;<tt>i</tt>&nbsp;= index with indisreplident set, or default</td></tr></table></div><div><br></div><div>测试部分 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/test/regress/expected/replica_identity.out;h=60b866ad7ed35ec3b34c167c2634b2aa243eba6f;hb=07cacba983ef79be4a84fcd0e0ca3b5fcb85dd65"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/test/regress/expected/replica_identity.out;h=60b866ad7ed35ec3b34c167c2634b2aa243eba6f;hb=07cacba983ef79be4a84fcd0e0ca3b5fcb85dd65</a></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=e55704d8b2fe522fbc9435acbb5bc59033478bd5"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=e55704d8b2fe522fbc9435acbb5bc59033478bd5</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=60dd40bbda92cb1818d5a2651b9d2ba49afd804c"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=60dd40bbda92cb1818d5a2651b9d2ba49afd804c</a></div>3.&nbsp;<a target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=07cacba983ef79be4a84fcd0e0ca3b5fcb85dd65"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=07cacba983ef79be4a84fcd0e0ca3b5fcb85dd65</a></div>
	</div>
</div>
</body>
</html>