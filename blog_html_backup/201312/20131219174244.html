<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">阿里云免费虚拟主机的PostgreSQL性能测试</h2>
	<h5 id="">2013-12-19 17:42:44&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013111954240288/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>上一篇文中我测试了一下阿里云免费虚拟主机的IOPS.</div><div>接下来测试一下阿里云免费虚拟主机中PostgreSQL的性能, 使用的测试模型参考如下 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201221382150858/"   >http://blog.163.com/digoal@126/blog/static/163877040201221382150858/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201221333411196/"   >http://blog.163.com/digoal@126/blog/static/163877040201221333411196/</a></div><div>测试用户数据500万条, 测试单个事务包含了1条insert, 1条update.&nbsp;</div><div>使用4个连接, TPS达到了9054.</div><div><pre class="prettyprint"   ><div><span style="line-height: 28px;"   ><font size="2"   >digoal=&gt; truncate user_info;</font></span></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >digoal=&gt; truncate user_session;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >digoal=&gt; insert into user_info (userid,engname,cnname,occupation,birthday,signname,email,qq,crt_time,mod_time)</font></div><div><font size="2"   >select generate_series(1,5000000),&nbsp;</font></div><div><font size="2"   >'digoal.zhou',</font></div><div><font size="2"   >'德哥',</font></div><div><font size="2"   >'DBA',</font></div><div><font size="2"   >'1970-01-01'</font></div><div><font size="2"   >,E'公益是一辈子的事, I\'m Digoal.Zhou, Just do it!',</font></div><div><font size="2"   >'digoal@126.com',</font></div><div><font size="2"   >276732431,</font></div><div><font size="2"   >clock_timestamp(),</font></div><div><font size="2"   >NULL;</font></div><div><font size="2"   >INSERT 0 5000000</font></div><div><font size="2"   >digoal=&gt; insert into user_session (userid) select generate_series(1,5000000);</font></div><div><font size="2"   >INSERT 0 5000000</font></div><div><font size="2"   >-- 测试函数 : </font></div><div><div style="line-height: 28px;"   ><font size="2"   >digoal=&gt; \sf f_user_logout</font></div><div style="line-height: 28px;"   ><font size="2"   >CREATE OR REPLACE FUNCTION digoal.f_user_logout(i_userid integer, OUT o_result integer)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;RETURNS integer</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;LANGUAGE plpgsql</font></div><div style="line-height: 28px;"   ><font size="2"   >AS $function$</font></div><div style="line-height: 28px;"   ><font size="2"   >declare</font></div><div style="line-height: 28px;"   ><font size="2"   >begin</font></div><div style="line-height: 28px;"   ><font size="2"   >insert into user_logout_rec (userid,logout_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div style="line-height: 28px;"   ><font size="2"   >update user_session set logouttime=now(),online_interval=online_interval+(now()-logintime) where userid=i_userid;</font></div><div style="line-height: 28px;"   ><font size="2"   >o_result := 0;</font></div><div style="line-height: 28px;"   ><font size="2"   >return;</font></div><div style="line-height: 28px;"   ><font size="2"   >exception&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >when others then</font></div><div style="line-height: 28px;"   ><font size="2"   >o_result := 1;</font></div><div style="line-height: 28px;"   ><font size="2"   >return;</font></div><div style="line-height: 28px;"   ><font size="2"   >end;</font></div><div style="line-height: 28px;"   ><font size="2"   >$function$</font></div></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; select pgfadvise_willneed('pk_user_session');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pgfadvise_willneed &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------</font></div><div><font size="2"   >&nbsp;(base/16385/16435,4096,27232,2429)</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; select pgfadvise_willneed('user_session');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pgfadvise_willneed &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------</font></div><div><font size="2"   >&nbsp;(base/16385/16434,4096,73400,2331)</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >性能 :</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@AY131219095142824b87Z-&gt; vi test.sql <br>\setrandom userid 1 5000000<br>SELECT f_user_logout(:userid);</font></div><div><font size="2"   ><span style="line-height: 21px;"   >postgres@AY131219095142824b87Z-&gt; pgbench -M prepared -n -r -f ./test.sql -c 4 -j 2 -T 60 -U digoal digoal<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 4<br>number of threads: 2<br>duration: 60 s<br>number of transactions actually processed: 543426<br>tps = 9054.346573 (including connections establishing)<br>tps = 9055.272495 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        0.002953        \setrandom userid 1 5000000<br>        0.434759        SELECT f_user_logout(:userid);</span></font></div><p></p></pre></div><div>纯INSERT的测试, TPS达到2.2万.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres@AY131219095142824b87Z-&gt; vi test.sql</font></div><div><span style="line-height: 28px;"   ><font size="2"   >\setrandom userid 1 5000000</font></span></div><div><font size="2"   >insert into user_login_rec(userid,login_time,ip) values (:userid, now(), inet_client_addr());</font></div></div><div><div><font size="2"   >postgres@AY131219095142824b87Z-&gt; pgbench -M prepared -n -r -f ./test.sql -c 4 -j 2 -T 60 -U digoal digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 4</font></div><div><font size="2"   >number of threads: 2</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 1335375</font></div><div><font size="2"   >tps = 22254.386566 (including connections establishing)</font></div><div><font size="2"   >tps = 22256.844072 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003117 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.171751 &nbsp; &nbsp; &nbsp; &nbsp;insert into user_login_rec(userid,login_time,ip) values (:userid, now(), inet_client_addr());</font></div></div><p></p></pre></div><div><br></div><div>阿里云给出的RDS-MYSQL的性能图表 :&nbsp;</div><div>插入这块PG远超MYSQL.</div><div><div><img title="阿里云免费虚拟主机的PostgreSQL性能测试 - 德哥@Digoal - PostgreSQL"   alt="阿里云免费虚拟主机的PostgreSQL性能测试 - 德哥@Digoal - PostgreSQL"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/w8PE10m0WLTT4pdrkD9XdQ==/6597919689146663014.png"   ></div>&nbsp;</div><div>MYSQL测试对应的OLTP脚本 :&nbsp;</div><div>http://bazaar.launchpad.net/~wlxiong/sysbench/sysbench/view/head:/sysbench/tests/db/oltp.lua</div><div><br></div><div><div><img title="阿里云免费虚拟主机的PostgreSQL性能测试 - 德哥@Digoal - PostgreSQL"   alt="阿里云免费虚拟主机的PostgreSQL性能测试 - 德哥@Digoal - PostgreSQL"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/0rbVbtnrRr6Q2HcNl_V_uA==/6598176974867480204.png"   ></div>&nbsp;</div><div>oltp.lua</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pathtest = string.match(test, "(.*/)") or ""</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >dofile(pathtest .. "common.lua")</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >function thread_init(thread_id)</font></div><div><font size="2"   >&nbsp; &nbsp;set_vars()</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;if (db_driver == "mysql" and mysql_table_engine == "myisam") then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; begin_query = "LOCK TABLES sbtest WRITE"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; commit_query = "UNLOCK TABLES"</font></div><div><font size="2"   >&nbsp; &nbsp;else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; begin_query = "BEGIN"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; commit_query = "COMMIT"</font></div><div><font size="2"   >&nbsp; &nbsp;end</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >end</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >function event(thread_id)</font></div><div><font size="2"   >&nbsp; &nbsp;local rs</font></div><div><font size="2"   >&nbsp; &nbsp;local i</font></div><div><font size="2"   >&nbsp; &nbsp;local table_name</font></div><div><font size="2"   >&nbsp; &nbsp;local range_start</font></div><div><font size="2"   >&nbsp; &nbsp;local c_val</font></div><div><font size="2"   >&nbsp; &nbsp;local pad_val</font></div><div><font size="2"   >&nbsp; &nbsp;local query</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;table_name = "sbtest".. sb_rand_uniform(1, oltp_tables_count)</font></div><div><font size="2"   >&nbsp; &nbsp;if not oltp_skip_trx then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; db_query(begin_query)</font></div><div><font size="2"   >&nbsp; &nbsp;end</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;for i=1, oltp_point_selects do  -- 匹配单条记录的查询</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; rs = db_query("SELECT c FROM ".. table_name .." WHERE id=" .. sb_rand(1, oltp_table_size))</font></div><div><font size="2"   >&nbsp; &nbsp;end</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;for i=1, oltp_simple_ranges do  -- 范围查询, 输出匹配行</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; range_start = sb_rand(1, oltp_table_size)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; rs = db_query("SELECT c FROM ".. table_name .." WHERE id BETWEEN " .. range_start .. " AND " .. range_start .. "+" .. oltp_range_size - 1)</font></div><div><font size="2"   >&nbsp; &nbsp;end</font></div><div><font size="2"   >&nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;for i=1, oltp_sum_ranges do  -- 范围查询, 输出SUM结果</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; range_start = sb_rand(1, oltp_table_size)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; rs = db_query("SELECT SUM(K) FROM ".. table_name .." WHERE id BETWEEN " .. range_start .. " AND " .. range_start .. "+" .. oltp_range_size - 1)</font></div><div><font size="2"   >&nbsp; &nbsp;end</font></div><div><font size="2"   >&nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;for i=1, oltp_order_ranges do  -- 范围查询, 排序输出.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; range_start = sb_rand(1, oltp_table_size)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; rs = db_query("SELECT c FROM ".. table_name .." WHERE id BETWEEN " .. range_start .. " AND " .. range_start .. "+" .. oltp_range_size - 1 .. " ORDER BY c")</font></div><div><font size="2"   >&nbsp; &nbsp;end</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;for i=1, oltp_distinct_ranges do  -- 范围查询, 输出唯一值.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; range_start = sb_rand(1, oltp_table_size)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; rs = db_query("SELECT DISTINCT c FROM ".. table_name .." WHERE id BETWEEN " .. range_start .. " AND " .. range_start .. "+" .. oltp_range_size - 1 .. " ORDER BY c")</font></div><div><font size="2"   >&nbsp; &nbsp;end</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;for i=1, oltp_limit_ranges do  -- 无条件查询, limit限制输出条数.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; range_start = sb_rand(1, oltp_table_size - oltp_range_size + 1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; rs = db_query("SELECT * FROM ".. table_name .." LIMIT " .. range_start .. ", " .. oltp_range_size)</font></div><div><font size="2"   >&nbsp; &nbsp;end</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;if not oltp_read_only then</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;for i=1, oltp_index_updates do  -- 索引值更新</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; rs = db_query("UPDATE " .. table_name .. " SET k=k+1 WHERE id=" .. sb_rand(1, oltp_table_size))</font></div><div><font size="2"   >&nbsp; &nbsp;end</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;for i=1, oltp_non_index_updates do  -- 非索引值更新</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; c_val = sb_rand_str("###########-###########-###########-###########-###########-###########-###########-###########-###########-###########")</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; query = "UPDATE " .. table_name .. " SET c='" .. c_val .. "' WHERE id=" .. sb_rand(1, oltp_table_size)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; rs = db_query(query)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; if rs then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; print(query)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end</font></div><div><font size="2"   >&nbsp; &nbsp;end</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;i = sb_rand(1, oltp_table_size)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;rs = db_query("DELETE FROM " .. table_name .. " WHERE id=" .. i)    -- 单条匹配, 删除操作.</font></div><div><font size="2"   >&nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;c_val = sb_rand_str([[</font></div><div><font size="2"   >###########-###########-###########-###########-###########-###########-###########-###########-###########-###########]])</font></div><div><font size="2"   >&nbsp; &nbsp;pad_val = sb_rand_str([[</font></div><div><font size="2"   >###########-###########-###########-###########-###########]])</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;rs = db_query("INSERT INTO " .. table_name .. &nbsp;" (id, k, c, pad) VALUES " .. string.format("(%d, %d, '%s', '%s')",i, sb_rand(1, oltp_table_size) , c_val, pad_val))   -- 插入.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;end   -- oltp_read_only</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;if not oltp_skip_trx then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; db_query(commit_query)</font></div><div><font size="2"   >&nbsp; &nbsp;end</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >end</font></div><p></p></pre></div><div>文章开头PostgreSQL的测试模型和这个lua有差别, 结果没有可比性.</div><div>接下来做一下类似模型的测试对比.</div><div><div><pre class="prettyprint"   ><p><font size="2"   >CREATE TABLE sbtest (id SERIAL primary key, k integer &nbsp;DEFAULT '0' NOT NULL, c varchar(120) DEFAULT '' NOT NULL, pad varchar(60) DEFAULT '' NOT NULL );</font></p></pre></div><div>-- 类似的OLTP测试函数.</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >create or replace function oltp_test(i_id int, i_id2 int) returns void as $$&nbsp;</font></span></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp;INSERT INTO sbtest(id, k, c, pad) values(i_id, 1, 'test', 'testpad');</font></div><div><font size="2"   >&nbsp;perform c from sbtest where id=i_id;</font></div><div><font size="2"   >&nbsp;UPDATE sbtest set k=k+1 where id=i_id;</font></div><div><font size="2"   >&nbsp;perform c from sbtest where id between i_id and i_id2 group by c;</font></div><div><font size="2"   >&nbsp;perform c from sbtest where id between i_id and i_id2 order by c;</font></div><div><font size="2"   >&nbsp;perform SUM(K) from sbtest where id between i_id and i_id+10;</font></div><div><font size="2"   >&nbsp;perform c from sbtest where id between i_id and i_id2;</font></div><div><font size="2"   >&nbsp;UPDATE sbtest set c='new' where id=i_id;</font></div><div><font size="2"   >&nbsp;DELETE from sbtest where id=i_id;</font></div><div><font size="2"   >exception when others then</font></div><div><font size="2"   >return;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div><p></p></pre></div></div><div>-- 测试脚本</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >\setrandom id1 1 500000000</font></span></div><div style="line-height: 28px;"   ><font size="2"   >\set id2 :id1 + 10</font></div><div style="line-height: 28px;"   ><font size="2"   >select oltp_test(:id1, :id2);</font></div><p></p></pre></div></div><div>-- 测试结果</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@AY131219095142824b87Z-&gt; pgbench -M prepared -n -r -f ./test.sql -c 4 -j 2 -T 60 -U digoal digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 4</font></div><div><font size="2"   >number of threads: 2</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 368133</font></div><div><font size="2"   >tps = 6135.136799 (including connections establishing)</font></div><div><font size="2"   >tps = 6135.809494 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003715 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id1 1 500000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.000944 &nbsp; &nbsp; &nbsp; &nbsp;\set id2 :id1 + 10</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.642662 &nbsp; &nbsp; &nbsp; &nbsp;select oltp_test(:id1, :id2);</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >现在唯一不知道的是阿里云的RDS用的什么机器配置, 比如CPU是一个非常重要的指标, 不过相信比免费的2核要好吧.</span></div><div><div><div><img title="阿里云免费虚拟主机的PostgreSQL性能测试 - 德哥@Digoal - PostgreSQL"   alt="阿里云免费虚拟主机的PostgreSQL性能测试 - 德哥@Digoal - PostgreSQL"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/YMSmyDDNPhyuWEJBkikkbg==/1866179095691671576.png"   ></div>&nbsp;</div><span style="line-height: 28px;"   >看得出PostgreSQL在本文的测试案例优势非常明显.</span></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="阿里云免费虚拟主机的PostgreSQL性能测试 - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>