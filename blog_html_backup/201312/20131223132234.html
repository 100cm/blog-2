<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 add HEAP_XMIN_FROZEN value in t_infomask</h2>
	<h5 id="">2013-12-23 13:22:34&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020131123112622894/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Instead of changing the tuple xmin to FrozenTransactionId, the combination</font></div><div><font size="2"   >of HEAP_XMIN_COMMITTED and HEAP_XMIN_INVALID, which were previously never</font></div><div><font size="2"   >set together, is now defined as HEAP_XMIN_FROZEN. &nbsp;A variety of previous</font></div><div><font size="2"   >proposals to freeze tuples opportunistically before vacuum_freeze_min_age</font></div><div><font size="2"   >is reached have foundered on the objection that replacing xmin by</font></div><div><font size="2"   >FrozenTransactionId might hinder debugging efforts when things in this</font></div><div><font size="2"   >area go awry; this patch is intended to solve that problem by keeping</font></div><div><font size="2"   >the XID around (but largely ignoring the value to which it is set).</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Third-party code that checks for HEAP_XMIN_INVALID on tuples where</font></div><div><font size="2"   >HEAP_XMIN_COMMITTED might be set will be broken by this change. &nbsp;To fix,</font></div><div><font size="2"   >use the new accessor macros in htup_details.h rather than consulting the</font></div><div><font size="2"   >bits directly. &nbsp;HeapTupleHeaderGetXmin has been modified to return</font></div><div><font size="2"   >FrozenTransactionId when the infomask bits indicate that the tuple is</font></div><div><font size="2"   >frozen; use HeapTupleHeaderGetRawXmin when you already know that the</font></div><div><font size="2"   >tuple isn't marked commited or frozen, or want the raw value anyway.</font></div><div><font size="2"   >We currently do this in routines that display the xmin for user consumption,</font></div><div><font size="2"   >in tqual.c where it's known to be safe and important for the avoidance of</font></div><div><font size="2"   >extra cycles, and in the function-caching code for various procedural</font></div><div><font size="2"   >languages, which shouldn't invalidate the cache just because the tuple</font></div><div><font size="2"   >gets frozen.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Robert Haas and Andres Freund</font></div><p></p></pre></div><div><br></div><div>PostgreSQL 9.4 在对表执行 freeze后, xmin不变了. 而是在tuple head中新增了一个定义, 合并<span style="line-height: 28px;"   >HEAP_XMIN_COMMITTED and HEAP_XMIN_INVALID两个比特位作为</span><span style="line-height: 28px;"   >HEAP_XMIN_FROZEN的含义.</span></div><div><span style="line-height: 28px;"   >例子 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg94@db-172-16-3-150-&gt; psql postgres postgres</font></div><div><font size="2"   >psql (9.4devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# create table t(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><div><font size="2"   >postgres=# create extension pageinspect;</font></div><div><font size="2"   >CREATE EXTENSION</font></div></div></div><div><div><font size="2"   >postgres=# insert into t values (1);</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=# select * from heap_page_items(get_raw_page('t',0));</font></div><div><font size="2"   >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"   >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"   >&nbsp; 1 | &nbsp; 8160 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | &nbsp; 1815 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# vacuum (verbose,freeze) t;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.t"</font></div><div><font size="2"   >INFO: &nbsp;"t": found 0 removable, 1 nonremovable row versions in 1 out of 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><div><font size="2"   >postgres=# select * from heap_page_items(get_raw_page('t',0));</font></div><div><font size="2"   >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"   >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"   >&nbsp; 1 | &nbsp; 8160 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | &nbsp; 1815 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; 2816 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >2816 = 0xB00</font></div><p></p></pre></div><div>freeze后, 虽然t_xmin没有变化, 但是t_infomask发生了变化, 从2048变成2816对应这3个比特位.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >#define HEAP_XMIN_COMMITTED &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0100 &nbsp;/* t_xmin committed */</font></div><div><font size="2"   >#define HEAP_XMIN_INVALID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0200 &nbsp;/* t_xmin invalid/aborted */</font></div></div><div><font size="2"   >#define HEAP_XMAX_INVALID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0800 &nbsp;/* t_xmax invalid/aborted */</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# update t set id=2;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# rollback;</font></div></div><div><div><font size="2"   >postgres=# select * from heap_page_items(get_raw_page('t',0));</font></div><div><font size="2"   >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"   >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"   >&nbsp; 1 | &nbsp; 8160 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | &nbsp; 1815 | &nbsp; 1816 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; 16385 | &nbsp; &nbsp; &nbsp; &nbsp;768 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 2 | &nbsp; 8128 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | &nbsp; 1816 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; 32769 | &nbsp; &nbsp; &nbsp;10240 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(2 rows)</font></div></div><p></p></pre></div><div><div>xmax在vacuum freeze后会被清除.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# vacuum (verbose,freeze) t;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.t"</font></div><div><font size="2"   >INFO: &nbsp;"t": found 1 removable, 1 nonremovable row versions in 1 out of 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 1 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><div><font size="2"   >postgres=# select * from heap_page_items(get_raw_page('t',0));</font></div><div><font size="2"   >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"   >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"   >&nbsp; 1 | &nbsp; 8160 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 28 | &nbsp; 1815 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; 2816 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 2 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div></div><div>对于PostgreSQL 9.4以前的版本, xmin会置为frozenxid = 2;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# drop table t;</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >digoal=# create table t(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into t values (1);</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# select ctid,cmin,cmax,xmin,xmax,* from t;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| cmin | cmax | &nbsp; xmin &nbsp; &nbsp;| xmax | id&nbsp;</font></div><div><font size="2"   >-------+------+------+-----------+------+----</font></div><div><font size="2"   >&nbsp;(0,1) | &nbsp; &nbsp;0 | &nbsp; &nbsp;0 | 316732673 | &nbsp; &nbsp;0 | &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# vacuum (verbose,freeze) t;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "postgres.t"</font></div><div><font size="2"   >INFO: &nbsp;"t": found 0 removable, 1 nonremovable row versions in 1 out of 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><div><font size="2"   >digoal=# select ctid,cmin,cmax,xmin,xmax,* from t;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| cmin | cmax | xmin | xmax | id&nbsp;</font></div><div><font size="2"   >-------+------+------+------+------+----</font></div><div><font size="2"   >&nbsp;(0,1) | &nbsp; &nbsp;0 | &nbsp; &nbsp;0 | &nbsp; &nbsp;2 | &nbsp; &nbsp;0 | &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# update t set id=2;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >digoal=# rollback;</font></div><div><font size="2"   >ROLLBACK</font></div><div><font size="2"   >digoal=# select ctid,cmin,cmax,xmin,xmax,* from t;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| cmin | cmax | xmin | &nbsp; xmax &nbsp; &nbsp;| id&nbsp;</font></div><div><font size="2"   >-------+------+------+------+-----------+----</font></div><div><font size="2"   >&nbsp;(0,1) | &nbsp; &nbsp;0 | &nbsp; &nbsp;0 | &nbsp; &nbsp;2 | 316732674 | &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# vacuum (verbose,freeze) t;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "postgres.t"</font></div><div><font size="2"   >INFO: &nbsp;"t": found 1 removable, 1 nonremovable row versions in 1 out of 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 1 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><div><font size="2"   >digoal=# select ctid,cmin,cmax,xmin,xmax,* from t;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| cmin | cmax | xmin | xmax | id&nbsp;</font></div><div><font size="2"   >-------+------+------+------+------+----</font></div><div><font size="2"   >&nbsp;(0,1) | &nbsp; &nbsp;0 | &nbsp; &nbsp;0 | &nbsp; &nbsp;2 | &nbsp; &nbsp;0 | &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=37484ad2aacef5ec794f4dd3d5cf814475180a78;hp=961bf59fb7a7e4fab751e20e9372de7ab37c5649"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=37484ad2aacef5ec794f4dd3d5cf814475180a78;hp=961bf59fb7a7e4fab751e20e9372de7ab37c5649</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/pageinspect.html"   >http://www.postgresql.org/docs/devel/static/pageinspect.html</a></div><div>3.&nbsp;src/include/access/htup_details.h</div><div><div><pre class="prettyprint"   ><p><font size="2"   >/*
 * information stored in t_infomask:
 */
#define HEAP_HASNULL                    0x0001  /* has null attribute(s) */
#define HEAP_HASVARWIDTH                0x0002  /* has variable-width attribute(s) */
#define HEAP_HASEXTERNAL                0x0004  /* has external stored attribute(s) */
#define HEAP_HASOID                             0x0008  /* has an object-id field */
#define HEAP_XMAX_KEYSHR_LOCK   0x0010  /* xmax is a key-shared locker */
#define HEAP_COMBOCID                   0x0020  /* t_cid is a combo cid */
#define HEAP_XMAX_EXCL_LOCK             0x0040  /* xmax is exclusive locker */
#define HEAP_XMAX_LOCK_ONLY             0x0080  /* xmax, if valid, is only a locker */

 /* xmax is a shared locker */
#define HEAP_XMAX_SHR_LOCK      (HEAP_XMAX_EXCL_LOCK | HEAP_XMAX_KEYSHR_LOCK)

#define HEAP_LOCK_MASK  (HEAP_XMAX_SHR_LOCK | HEAP_XMAX_EXCL_LOCK | \
                                                 HEAP_XMAX_KEYSHR_LOCK)
#define HEAP_XMIN_COMMITTED             0x0100  /* t_xmin committed */
#define HEAP_XMIN_INVALID               0x0200  /* t_xmin invalid/aborted */
#define HEAP_XMIN_FROZEN                (HEAP_XMIN_COMMITTED|HEAP_XMIN_INVALID)
#define HEAP_XMAX_COMMITTED             0x0400  /* t_xmax committed */
#define HEAP_XMAX_INVALID               0x0800  /* t_xmax invalid/aborted */
#define HEAP_XMAX_IS_MULTI              0x1000  /* t_xmax is a MultiXactId */
#define HEAP_UPDATED                    0x2000  /* this is UPDATEd version of row */
#define HEAP_MOVED_OFF                  0x4000  /* moved to another place by pre-9.0
                                                                                 * VACUUM FULL; kept for binary
                                                                                 * upgrade support */
#define HEAP_MOVED_IN                   0x8000  /* moved from another place by pre-9.0
                                                                                 * VACUUM FULL; kept for binary
                                                                                 * upgrade support */
#define HEAP_MOVED (HEAP_MOVED_OFF | HEAP_MOVED_IN)

#define HEAP_XACT_MASK                  0xFFF0  /* visibility-related bits */</font></p></pre></div></div><div><br></div><wbr></div>
	</div>
</div>
</body>
</html>