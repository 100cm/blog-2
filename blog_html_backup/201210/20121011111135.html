<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">openvpn</h2>
	<h5 id="">2012-10-11 11:11:35&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020129119140123/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">一、环境 :&nbsp;<div>Server :&nbsp;<br><div>1. 配置公网IP. 假设这里是 ( 216.xxx.xxx.xxx )</div><div>2. OS : CentOS 5.x&nbsp;</div><div>3.&nbsp;kernel 需要支持 tun 设备, 需要加载 iptables 模块.</div><div>检查tun是否加载</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># modinfo tun</font></div><div><font size="2"   >filename: &nbsp; &nbsp; &nbsp; /lib/modules/2.6.18-308.11.1.el5/kernel/drivers/net/tun.ko</font></div><div><font size="2"   >alias: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;char-major-10-200</font></div><div><font size="2"   >license: &nbsp; &nbsp; &nbsp; &nbsp;GPL</font></div><div><font size="2"   >author: &nbsp; &nbsp; &nbsp; &nbsp; (C) 1999-2004 Max Krasnyansky &lt;maxk@qualcomm.com&gt;</font></div><div><font size="2"   >description: &nbsp; &nbsp;Universal TUN/TAP device driver</font></div><div><font size="2"   >srcversion: &nbsp; &nbsp; 430A127E593C2F7EFE6855C</font></div><div><font size="2"   >depends: &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >vermagic: &nbsp; &nbsp; &nbsp; 2.6.18-308.11.1.el5 SMP mod_unload gcc-4.1</font></div><div><font size="2"   >module_sig: &nbsp; &nbsp; 883f3504ffc2c4f2c55a77e36834d621129d5009d1f9dace07e4bf468b0afb051d85aefcf9efa43609f636e248e97c0c5321461e683832b4e447b0d44e</font></div><p></p></pre></div><div>4. 需要安装iptables, 因为要用到它的NAT支持.</div><div>5. OpenSSL。如果需要启用 SSL 连接，则需要先安装 OpenSSL。安装　OpenSSL 的方法在这里不做介绍，具体可以用 Google 搜索。CentOS 下可以用 yum install:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >yum install openssl</font></div><div><font size="2"   >yum install openssl-devel</font></div><p></p></pre></div><div>6. 安装的 OpenVPN 的版本: 2.0.5. 现在似乎已经有一个更新的版本了. 可在<a target="_blank" rel="nofollow" href="http://openvpn.net"   >http://openvpn.net</a>&nbsp;上下载.</div><div><br></div><div>Client :</div><div>1. Win7</div><div><div>2. OpenVPN GUI For windows 1.0.3 , 可在 openvpn.se 下载&nbsp;</div><div>注意: OpenVPN GUI for windows 的版本要和 OpenVPN Server 的版本配套.&nbsp;</div><div>例如, 服务器装的是 OpenVPN 2.0.5, 那么下载的 OpenVPN GUI fow windows 应该是: openvpn-2.0.5-gui-1.0.3-install.exe&nbsp;</div><div>OpenVPN GUI的所有历史版本:&nbsp;<a target="_blank" rel="nofollow" href="http://openvpn.se/files/install_packages/"   >http://openvpn.se/files/install_packages/</a></div><div><br></div><div>二、 OpenVPN 服务端安装过程</div><div><div>用 SecureCRT 登录到 root@server 代码:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - root</font></div><div><font size="2"   >mkdir /opt/soft_bak/vpn</font></div><div><font size="2"   >cd&nbsp;<span style="line-height: 22px;"   >/opt/soft_bak/vpn</span></font></div><p></p></pre></div><div>下载 LZO，解压到lzo-2.02.</div><div>地址: http://www.oberhumer.com/opensource/lzo/download/ 代码:</div><div><pre class="prettyprint"   ><p><font size="2"   >wget http://www.oberhumer.com/opensource/lzo/download/lzo-2.02.tar.gz</font></p></pre></div><div>下载 OpenVPN, 解压到openvpn-2.0.5</div><div>地址: http://openvpn.net/download.html 代码:</div><div><pre class="prettyprint"   ><p><font size="2"   >wget http://openvpn.net/release/openvpn-2.0.5.tar.gz</font></p></pre></div><div>安装 LZO 代码:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd&nbsp;<span style="line-height: 22px;"   >/opt/soft_bak/vpn</span>/lzo-2.02&nbsp;</font></div><div><font size="2"   >./configure --prefix=/opt<span style="line-height: 22px;"   >/lzo-2.02</span></font></div><div><font size="2"   >make&nbsp;</font></div><div><font size="2"   >make check&nbsp;</font></div><div><font size="2"   >make install&nbsp;</font></div><p></p></pre></div><div>安装 OpenVPN</div><div>代码:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd&nbsp;<span style="line-height: 22px;"   >/opt/soft_bak/vpn</span>/openvpn-2.0.5</font></div><div><div><font size="2"   >./configure&nbsp;<span style="line-height: 22px;"   >--prefix=/opt/op</span></font></div><div><font size="2"   ><span style="line-height: 22px;"   >envpn-2.0.5</span>&nbsp;--with-lzo-headers=/opt/lzo-2.02/include --with-lzo-lib=/opt/lzo-2.02/lib --with-ssl-lib=/usr/local/lib&nbsp;</font></div></div><div><font size="2"   >make&nbsp;</font></div><div><font size="2"   >make install&nbsp;</font></div><p></p></pre></div><div>生成证书Key</div><div>初始化 PKI</div><div>(如果没有 export 命令也可以用 setenv [name] [value] 命令)</div><div>代码:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd&nbsp;<span style="line-height: 22px;"   >/opt/soft_bak/vpn</span>/openvpn-2.0.5/easy-rsa&nbsp;</font></div><div><font size="2"   >export D=`pwd`&nbsp;</font></div><div><font size="2"   >export KEY_CONFIG=$D/openssl.cnf&nbsp;</font></div><div><font size="2"   >export KEY_DIR=$D/keys&nbsp;</font></div><div><font size="2"   >export KEY_SIZE=1024&nbsp;</font></div><div><font size="2"   >export KEY_COUNTRY=CN&nbsp;</font></div><div><font size="2"   >export KEY_PROVINCE=ZJ</font></div><div><font size="2"   >export KEY_CITY=HZ</font></div><div><font size="2"   >export KEY_ORG="digoal.com"&nbsp;</font></div><div><font size="2"   >export KEY_EMAIL="digoal@digoal.com"&nbsp;</font></div><p></p></pre></div><div>Build:</div><div>代码:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >./clean-all&nbsp;</font></div><div><font size="2"   >./build-ca&nbsp;</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >Generating a 1024 bit RSA private key</font></div><div><font size="2"   >........................++++++</font></div><div><font size="2"   >..............................++++++</font></div><div><font size="2"   >writing new private key to 'ca.key'</font></div><div><font size="2"   >-----</font></div><div><font size="2"   >You are about to be asked to enter information that will be incorporated</font></div><div><font size="2"   >into your certificate request.</font></div><div><font size="2"   >What you are about to enter is what is called a Distinguished Name or a DN.</font></div><div><font size="2"   >There are quite a few fields but you can leave some blank</font></div><div><font size="2"   >For some fields there will be a default value,</font></div><div><font size="2"   >If you enter '.', the field will be left blank.</font></div><div><font size="2"   >-----</font></div><div><font size="2"   >Country Name (2 letter code) [CN]:</font></div><div><font size="2"   >State or Province Name (full name) [ZJ]:</font></div><div><font size="2"   >Locality Name (eg, city) [HZ]:</font></div><div><font size="2"   >Organization Name (eg, company) [sky-mobi.com]:</font></div><div><font size="2"   >Organizational Unit Name (eg, section) []:</font></div><div><font size="2"   >Common Name (eg, your name or your server's hostname) []:</font></div><div><font size="2"   >Email Address [digoal.zhou@sky-mobi.com]:</font></div></div><p></p></pre></div><div><br></div><div># 建立 server key 代码: 代码:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >./build-key-server server&nbsp;</font></div><div><div><font size="2"   >Generating a 1024 bit RSA private key</font></div><div><font size="2"   >..........++++++</font></div><div><font size="2"   >.....++++++</font></div><div><font size="2"   >writing new private key to 'server.key'</font></div><div><font size="2"   >-----</font></div><div><font size="2"   >You are about to be asked to enter information that will be incorporated</font></div><div><font size="2"   >into your certificate request.</font></div><div><font size="2"   >What you are about to enter is what is called a Distinguished Name or a DN.</font></div><div><font size="2"   >There are quite a few fields but you can leave some blank</font></div><div><font size="2"   >For some fields there will be a default value,</font></div><div><font size="2"   >If you enter '.', the field will be left blank.</font></div><div><font size="2"   >-----</font></div><div><font size="2"   >Country Name (2 letter code) [CN]:</font></div><div><font size="2"   >State or Province Name (full name) [ZJ]:</font></div><div><font size="2"   >Locality Name (eg, city) [HZ]:</font></div><div><font size="2"   >Organization Name (eg, company) [sky-mobi.com]:</font></div><div><font size="2"   >Organizational Unit Name (eg, section) []:</font></div><div><font size="2"   >Common Name (eg, your name or your server's hostname) []:digoal_server</font></div><div><font size="2"   >Email Address [digoal.zhou@sky-mobi.com]:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Please enter the following 'extra' attributes</font></div><div><font size="2"   >to be sent with your certificate request</font></div><div><font size="2"   >A challenge password []:Digoal.Zhou_20121011</font></div><div><font size="2"   >An optional company name []:</font></div><div><font size="2"   >Using configuration from /opt/soft_bak/vpn/openvpn-2.0.5/easy-rsa/openssl.cnf</font></div><div><font size="2"   >Check that the request matches the signature</font></div><div><font size="2"   >Signature ok</font></div><div><font size="2"   >The Subject's Distinguished Name is as follows</font></div><div><font size="2"   >countryName &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :PRINTABLE:'CN'</font></div><div><font size="2"   >stateOrProvinceName &nbsp; :PRINTABLE:'ZJ'</font></div><div><font size="2"   >localityName &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:PRINTABLE:'HZ'</font></div><div><font size="2"   >organizationName &nbsp; &nbsp; &nbsp;:PRINTABLE:'sky-mobi.com'</font></div><div><font size="2"   >commonName &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:T61STRING:'digoal_server'</font></div><div><font size="2"   >emailAddress &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:IA5STRING:'digoal.zhou@sky-mobi.com'</font></div><div><font size="2"   >Certificate is to be certified until Oct &nbsp;8 23:10:34 2022 GMT (3650 days)</font></div><div><font size="2"   >Sign the certificate? [y/n]:y</font></div><div><font size="2"   >1 out of 1 certificate requests certified, commit? [y/n]y</font></div><div><font size="2"   >Write out database with 1 new entries</font></div><div><font size="2"   >Data Base Updated</font></div></div><p></p></pre></div><div><br></div><div>#生成客户端 key</div><div>代码:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >./build-key client1&nbsp;</font></div><div><div><font size="2"   >Generating a 1024 bit RSA private key</font></div><div><font size="2"   >.........++++++</font></div><div><font size="2"   >....................................++++++</font></div><div><font size="2"   >writing new private key to 'client1.key'</font></div><div><font size="2"   >-----</font></div><div><font size="2"   >You are about to be asked to enter information that will be incorporated</font></div><div><font size="2"   >into your certificate request.</font></div><div><font size="2"   >What you are about to enter is what is called a Distinguished Name or a DN.</font></div><div><font size="2"   >There are quite a few fields but you can leave some blank</font></div><div><font size="2"   >For some fields there will be a default value,</font></div><div><font size="2"   >If you enter '.', the field will be left blank.</font></div><div><font size="2"   >-----</font></div><div><font size="2"   >Country Name (2 letter code) [CN]:</font></div><div><font size="2"   >State or Province Name (full name) [ZJ]:</font></div><div><font size="2"   >Locality Name (eg, city) [HZ]:</font></div><div><font size="2"   >Organization Name (eg, company) [sky-mobi.com]:</font></div><div><font size="2"   >Organizational Unit Name (eg, section) []:</font></div><div><font size="2"   >Common Name (eg, your name or your server's hostname) []:digoal_client1 &nbsp; &nbsp;#重要: 每个不同的 client 生成的证书, 名字必须不同.</font></div><div><font size="2"   >Email Address [digoal.zhou@sky-mobi.com]:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Please enter the following 'extra' attributes</font></div><div><font size="2"   >to be sent with your certificate request</font></div><div><font size="2"   >A challenge password []:Digoal.Zhou_20121011</font></div><div><font size="2"   >An optional company name []:</font></div><div><font size="2"   >Using configuration from /opt/soft_bak/vpn/openvpn-2.0.5/easy-rsa/openssl.cnf</font></div><div><font size="2"   >Check that the request matches the signature</font></div><div><font size="2"   >Signature ok</font></div><div><font size="2"   >The Subject's Distinguished Name is as follows</font></div><div><font size="2"   >countryName &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :PRINTABLE:'CN'</font></div><div><font size="2"   >stateOrProvinceName &nbsp; :PRINTABLE:'ZJ'</font></div><div><font size="2"   >localityName &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:PRINTABLE:'HZ'</font></div><div><font size="2"   >organizationName &nbsp; &nbsp; &nbsp;:PRINTABLE:'sky-mobi.com'</font></div><div><font size="2"   >commonName &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:T61STRING:'digoal_client1'</font></div><div><font size="2"   >emailAddress &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:IA5STRING:'digoal.zhou@sky-mobi.com'</font></div><div><font size="2"   >Certificate is to be certified until Oct &nbsp;8 23:11:36 2022 GMT (3650 days)</font></div><div><font size="2"   >Sign the certificate? [y/n]:y</font></div><div><font size="2"   >1 out of 1 certificate requests certified, commit? [y/n]y</font></div><div><font size="2"   >Write out database with 1 new entries</font></div><div><font size="2"   >Data Base Updated</font></div></div><p></p></pre></div><div><br></div><div>依次类推生成其他客户端证书/key</div><div>代码:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >./build-key client2&nbsp;</font></div><div><font size="2"   >./build-key client3&nbsp;</font></div><div><font size="2"   >注意在进入 Common Name (eg, your name or your server's hostname) []: 的输入时, 每个证书输入的名字必须不同.</font></div><p></p></pre></div><div><br></div><div>生成 Diffie Hellman 参数 。代码:</div><div><pre class="prettyprint"   ><p><font size="2"   >./build-dh&nbsp;</font></p></pre></div><div><br></div><div>看看都创建了哪些文件, 这些文件将被配置文件用到:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@longray keys]# pwd</font></div><div><font size="2"   >/opt/soft_bak/vpn/openvpn-2.0.5/easy-rsa/keys</font></div><div><font size="2"   >[root@longray keys]# ll</font></div><div><font size="2"   >total 68</font></div><div><font size="2"   >-rw-r--r-- 1 root root 3569 Oct 11 07:10 01.pem</font></div><div><font size="2"   >-rw-r--r-- 1 root root 3466 Oct 11 07:11 02.pem</font></div><div><font size="2"   >-rw-r--r-- 1 root root 1135 Oct 11 07:08 ca.crt</font></div><div><font size="2"   >-rw------- 1 root root &nbsp;887 Oct 11 07:08 ca.key</font></div><div><font size="2"   >-rw-r--r-- 1 root root 3466 Oct 11 07:11 client1.crt</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;737 Oct 11 07:11 client1.csr</font></div><div><font size="2"   >-rw------- 1 root root &nbsp;887 Oct 11 07:11 client1.key</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;245 Oct 11 07:11 dh1024.pem</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;221 Oct 11 07:11 index.txt</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; 21 Oct 11 07:11 index.txt.attr</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; 21 Oct 11 07:10 index.txt.attr.old</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;110 Oct 11 07:10 index.txt.old</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; &nbsp;3 Oct 11 07:11 serial</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; &nbsp;3 Oct 11 07:10 serial.old</font></div><div><font size="2"   >-rw-r--r-- 1 root root 3569 Oct 11 07:10 server.crt</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;733 Oct 11 07:10 server.csr</font></div><div><font size="2"   >-rw------- 1 root root &nbsp;887 Oct 11 07:10 server.key</font></div><p></p></pre></div><div><br></div><div>将 keys 下的所有文件打包下载到客户端(Win7)</div><div>代码:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >tar -cf mykeys.tar /opt/soft_bak/vpn/openvpn-2.0.5/easy-rsa/keys&nbsp;</font></div><div><font size="2"   >sz mykeys.tar 或者使用 sftp 将mykeys.tar 传到<span style="line-height: 22px;"   >客户端(Win7)</span>.</font></div><div><font size="2"   >下载到客户端后可以讲服务端的删除 , rm mykeys.tar&nbsp;</font></div><p></p></pre></div><div><br></div><div>创建服务端配置文件</div><div>从样例文件创建:</div><div>代码:</div><div>#创建配置文件目录和日志文件目录</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >mkdir /opt/<span style="line-height: 22px;"   >openvpn-2.0.5/etc</span></font></div><div><font size="2"   ><span style="line-height: 22px;"   >mkdir /opt/</span><span style="line-height: 22px;"   >openvpn-2.0.5/log</span></font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 进入源代码解压目录下的sample-config-files子目录&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd /opt/soft_bak/vpn/<span style="line-height: 22px;"   >openvpn-2.0.5</span>/sample-config-files/ &nbsp;&nbsp;</font></div><div><font size="2"   >cp server.conf&nbsp;<span style="line-height: 22px;"   >/opt/</span><span style="line-height: 22px;"   >openvpn-2.0.5/etc</span>&nbsp; # cp服务器配置文件到<span style="line-height: 22px;"   >/opt/</span><span style="line-height: 22px;"   >openvpn-2.0.5/etc</span></font></div><div><font size="2"   >vi&nbsp;<span style="line-height: 22px;"   >/opt/</span><span style="line-height: 22px;"   >openvpn-2.0.5/etc</span>/server.conf&nbsp;</font></div><p></p></pre></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >local 216.xxx.xxx.xxx</font></div><div><font size="2"   >port 1194</font></div><div><font size="2"   >proto udp</font></div><div><font size="2"   >dev tun</font></div><div><font size="2"   >ca /opt/soft_bak/vpn/openvpn-2.0.5/easy-rsa/keys/ca.crt</font></div><div><font size="2"   >cert /opt/soft_bak/vpn/openvpn-2.0.5/easy-rsa/keys/server.crt</font></div><div><font size="2"   >key /opt/soft_bak/vpn/openvpn-2.0.5/easy-rsa/keys/server.key &nbsp;# This file should be kept secret</font></div><div><font size="2"   >dh /opt/soft_bak/vpn/openvpn-2.0.5/easy-rsa/keys/dh1024.pem</font></div><div><font size="2"   >server 10.8.0.0 255.255.255.0</font></div><div><font size="2"   ># 将网关PUSH到客户端, 其实就是让客户端执行route delete, route add等操作. 这个还有更多可选, 参见openvpn --help</font></div><div><font size="2"   >push "redirect-gateway def1"</font></div><div><font size="2"   >push "dhcp-option DNS 10.8.0.1"</font></div><div><span style="font-size: small; line-height: 19px;"   ># 说明: 因为有些 domain 被封掉了, 这时, 如果要访问这些网站, 应该将 server 上的 DNS push 到 client.</span></div><div><font size="2"   >push "dhcp-option DNS 8.8.8.8" # 这两个取自服务器上的/etc/resolv.conf</font></div><div><font size="2"   >push "dhcp-option DNS 8.8.4.4"&nbsp;<span style="line-height: 22px;"   ># 这两个取自服务器上的/etc/resolv.conf</span></font></div><div><font size="2"   >client-to-client</font></div><div><font size="2"   >keepalive 10 120</font></div><div><font size="2"   >comp-lzo</font></div><div><font size="2"   >persist-key</font></div><div><font size="2"   >persist-tun</font></div><div><font size="2"   >status /opt/openvpn-2.0.5/log/openvpn-status.log</font></div><div><font size="2"   >verb 4</font></div><p></p></pre></div><div><br></div><div>创建客户端配置文件</div><div>代码:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd /<span style="line-height: 22px;"   >opt/soft_bak/vpn/</span><span style="line-height: 22px;"   >openvpn-2.0.5</span>/sample-config-files/ &nbsp;#进入源代码解压目录下的sample-config-files子目录&nbsp;</font></div><div><font size="2"   >cp client.conf /<span style="line-height: 22px;"   >opt/</span><span style="line-height: 22px;"   >openvpn-2.0.5</span>/etc &nbsp;#cp客户端配置文件到<span style="line-height: 22px;"   >opt/soft_bak/vpn/</span><span style="line-height: 22px;"   >openvpn-2.0.5</span>&nbsp;</font></div><div><font size="2"   >vi&nbsp;<span style="line-height: 22px;"   >opt/soft_bak/vpn/</span><span style="line-height: 22px;"   >openvpn-2.0.5/</span>client.conf&nbsp;</font></div><p></p></pre></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >client</font></div><div><font size="2"   >dev tun</font></div><div><font size="2"   >proto udp</font></div><div><font size="2"   >remote 216.xxx.xxx.xxx 1194</font></div><div><font size="2"   >persist-key</font></div><div><font size="2"   >persist-tun</font></div><div><font size="2"   >ca ca.crt</font></div><div><font size="2"   >cert client1.crt</font></div><div><font size="2"   >key client1.key</font></div><div><font size="2"   >ns-cert-type server</font></div><div><font size="2"   >comp-lzo</font></div><div><font size="2"   >verb 3</font></div><p></p></pre></div><div><br></div><div>启动Openvpn: openvpn [server config file] 代码:</div><div><pre class="prettyprint"   ><p><font size="2"   >/opt/openvpn-2.0.5/sbin/openvpn --config /opt/openvpn-2.0.5/etc/server.conf&nbsp;</font></p></pre></div></div><div>启动后监听1194 UDP端口 &nbsp;:&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >udp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 216.xxx.xxx.xxx:1194 &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8489/openvpn</font></p></pre></div><div><br></div><div><div>三、 OpenVPN GUI For Windows 客户端安装过程</div><div>安装 OpenVPN GUI For Windows, 到&nbsp;<a target="_blank" rel="nofollow" href="http://openvpn.se"   >http://openvpn.se</a>&nbsp;下载.&nbsp;</div><div>目前的版本是 1.0.3. 注意: OpenVPN GUI 的版本要和 OpenVPN Server 的版本配套. 详见第一节一. 安装环境中的说明.</div><div>依屏幕指示安装openvpn gui.</div><div>配置 openvpn gui</div><div>安装结束后, 进入安装文件夹下的 config 目录, 然后将上面第 10 步建立的 client.conf 文件从 server 上下载到此文件夹, 并更名为 client.ovpn</div><div>同时, 将第8 步打包的 mykeys.tar 中的下列证书文件解压到此文件夹:</div><div>代码:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ca.crt&nbsp;</font></div><div><font size="2"   >ca.key&nbsp;</font></div><div><font size="2"   >client1.crt&nbsp;</font></div><div><font size="2"   >client1.csr&nbsp;</font></div><div><font size="2"   >client1.key&nbsp;</font></div><p></p></pre></div><div>如果是WIN7系统, 需要配置openvpn-gui程序的兼容性和以管理员运行此程序, 如图 :&nbsp;</div><div><div><img title="openvpn - 德哥@Digoal - The Heart,The World."   alt="openvpn - 德哥@Digoal - The Heart,The World."   style="margin:0 10px 0 0;"   src="http://img4.ph.126.net/FFpB8h3aGuSAeGwFKs8bsA==/6597653607330616604.jpg"   ></div>&nbsp;</div><div>然后双击 client.ovpn 即可启动 openvpn, 或者通过 OpenVPN GUI 的控制启动 VPN.</div><div>如果双击 client.ovpn 没有反应, 则在任务栏点 OpenVPN GUI 的小图标右键, 选择 edit config, 将内容复制过去再保存. 然后再点右键中的 connect即可.</div><div>如果需要第二台机器上使用 vpn , 进行同样的配置, 只需要将 client1.crt, client1.csr, client1.key 换成对应的 client2.xxx 即可, 然后将 client.ovpn 中的对应key文件值改掉.</div></div><div><br></div><div><div>四、 OpenVPN 访问外网的设置</div><div>打开路由 VPN连接成功后, 还需要设置路由, 才能透过VPN访问Internet. 在 linux host 上添加路由: 代码:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j SNAT --to-source 216.xxx.xxx.xxx</font></div><div><font size="2"   >/etc/init.d/iptables save&nbsp;</font></div><div><font size="2"   >/etc/init.d/iptables restart&nbsp;</font></div><p></p></pre></div><div>不同的机器，-o eth0 参数可能不一样，具体可输入 ifconfig 查看，搞清 ip(216.xxx.xxx.xxx)所在的网卡号.</div><div>同时, 需要将 ip forward 打开. 不要用 echo 1 &gt; /proc/sys/net/ipv4/ip_forward 的方式, 这种方式重启后无效. 先查看一下:</div><div>代码:</div><div><br></div><div>sysctl -a | grep for&nbsp;</div><div>#查看结果:&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >net.ipv4.conf.tun0.mc_forwarding = 0&nbsp;</font></div><div><font size="2"   >net.ipv4.conf.tun0.forwarding = 1&nbsp;</font></div><div><font size="2"   >net.ipv4.conf.eth0.mc_forwarding = 0&nbsp;</font></div><div><font size="2"   >net.ipv4.conf.eth0.forwarding = 1&nbsp;</font></div><div><font size="2"   >net.ipv4.conf.lo.mc_forwarding = 0&nbsp;</font></div><div><font size="2"   >net.ipv4.conf.lo.forwarding = 1&nbsp;</font></div><div><font size="2"   >net.ipv4.conf.default.mc_forwarding = 0&nbsp;</font></div><div><font size="2"   >net.ipv4.conf.default.forwarding = 1&nbsp;</font></div><div><font size="2"   >net.ipv4.conf.all.mc_forwarding = 0&nbsp;</font></div><div><font size="2"   >net.ipv4.conf.all.forwarding = 1&nbsp;</font></div><div><font size="2"   >net.ipv4.ip_forward = 1&nbsp;</font></div><p></p></pre></div><div>如果你的主机上列数值不是为1, 则要将其改成1, 例如:</div><div>代码:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi /etc/sysctl.conf</font></div><div><font size="2"   >net.ipv4.ip_forward = 1</font></div><div><font size="2"   >sysctl -p</font></div><p></p></pre></div><div>依此类推.</div><div>开启域名服务器</div><div>如果你需要访问一些已经被封掉了域名的网站, 但你的 OpenVPN 服务器没有被封的话，那么你需要在你的主机上开启 name server, 并将 dns push 给 client。 一般的独立主机, 都带有 private dns server.</div><div>代码:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >rpm -qa | grep bind&nbsp;</font></div><div><font size="2"   >/etc/init.d/named start&nbsp;</font></div><p></p></pre></div><div>另外, 必须保证 server.conf 配置中, 有这三个配置:</div><div>代码:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >push "dhcp-option DNS 10.8.0.1"</font></div><div><font size="2"   >push "dhcp-option DNS 8.8.8.8" # 这两个取自服务器上的/etc/resolv.conf</font></div><div><font size="2"   >push "dhcp-option DNS 8.8.4.4" # 这两个取自服务器上的/etc/resolv.conf</font></div><p></p></pre></div><div><br></div><div>当 client 连接成功后, 在 cmd 下执行 ipconfig /all, 应该有这类似这样的输出:</div><div>代码:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Ethernet adapter Local Area Connection 3:&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Connection-specific DNS Suffix &nbsp;. :&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Description . . . . . . . . . . . : TAP-Win32 Adapter V8&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Physical Address. . . . . . . . . : 00-FF-AA-B0-60-2B&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Dhcp Enabled. . . . . . . . . . . : Yes&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Autoconfiguration Enabled . . . . : Yes&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; IP Address. . . . . . . . . . . . : 10.8.0.6&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Subnet Mask . . . . . . . . . . . : 255.255.255.252&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Default Gateway . . . . . . . . . : 10.8.0.5&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; DHCP Server . . . . . . . . . . . : 10.8.0.5&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; DNS Servers . . . . . . . . . . . : 10.8.0.1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8.8.8.8&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8.8.4.4</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Lease Obtained. . . . . . . . . . : 2006年5月25日 5:13:52&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Lease Expires . . . . . . . . . . : 2007年5月25日 5:13:52&nbsp;</font></div><p></p></pre></div><div><br></div><div>当然如果你看到的不一样, 说明WINDOWS的route delete, route add 没有成功. 查看openvpn gui的status(右键点击openvpn任务栏的图标可以看, 里面会有类似报错如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Thu Oct 11 08:06:34 2012 route ADD 216.xxx.xxx.xxx MASK 255.255.255.255 172.16.18.1 &nbsp;#172.16.18.1是你原来的默认网关</font></div><div><font size="2"   >Thu Oct 11 08:06:34 2012 ROUTE: route addition failed using CreateIpForwardEntry: 至少有一个参数不正确。 &nbsp; [if_index=12]</font></div><div><font size="2"   >Thu Oct 11 08:06:34 2012 Route addition via IPAPI failed</font></div><div><font size="2"   >Thu Oct 11 08:06:34 2012 route DELETE 0.0.0.0 MASK 0.0.0.0 172.16.18.1</font></div><div><font size="2"   >Thu Oct 11 08:06:34 2012 ROUTE: route deletion failed using DeleteIpForwardEntry: 拒绝访问。 &nbsp;</font></div><div><font size="2"   >Thu Oct 11 08:06:34 2012 Route deletion via IPAPI failed</font></div><div><font size="2"   >Thu Oct 11 08:06:34 2012 route ADD 0.0.0.0 MASK 0.0.0.0 10.8.0.5</font></div><div><font size="2"   >Thu Oct 11 08:06:34 2012 ROUTE: route addition failed using CreateIpForwardEntry: 至少有一个参数不正确。 &nbsp; [if_index=29]</font></div><div><font size="2"   >Thu Oct 11 08:06:34 2012 Route addition via IPAPI failed</font></div><div><font size="2"   >Thu Oct 11 08:06:34 2012 route ADD 10.8.0.0 MASK 255.255.255.0 10.8.0.5</font></div><div><font size="2"   >Thu Oct 11 08:06:34 2012 ROUTE: route addition failed using CreateIpForwardEntry: 至少有一个参数不正确。 &nbsp; [if_index=29]</font></div><div><font size="2"   >Thu Oct 11 08:06:34 2012 Route addition via IPAPI failed</font></div><div><font size="2"   >Thu Oct 11 08:06:34 2012 Initialization Sequence Completed</font></div><p></p></pre></div><div>如果遇到这个错误, 有多种解决办法, 最简单的是在client.的配置文件里面加上以下两行, 重新拨号.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >route-method exe</font></div><div><font size="2"   >route-delay 2</font></div><p></p></pre></div><div>如果还是报错, 那么可以通过手工执行这些route命令即可, win7的修正方法, 以管理员打开CMD客户端,执行 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >route ADD 216.xxx.xxx.xxx MASK 255.255.255.255 172.16.18.1</font></div><div><font size="2"   >route DELETE 0.0.0.0 MASK 0.0.0.0 172.16.18.1</font></div><div><font size="2"   >route ADD 0.0.0.0 MASK 0.0.0.0 10.8.0.5</font></div><div><font size="2"   >route ADD 10.8.0.0 MASK 255.255.255.0 10.8.0.5</font></div><p></p></pre></div><div>在openvpn断开后, 路由表不会自己改回去, 你的原来的网关可能就没了, 会上不了网. 所以openvpn断开后这些route命令还要逆向执行一遍.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >route delete 216.xxx.xxx.xxx MASK 255.255.255.255 172.16.18.1</font></div><div><font size="2"   >route add 0.0.0.0 MASK 0.0.0.0 172.16.18.1</font></div><div><font size="2"   >route delete 0.0.0.0 MASK 0.0.0.0 10.8.0.5</font></div><div><font size="2"   >route delete 10.8.0.0 MASK 255.255.255.0 10.8.0.5</font></div><p></p></pre></div><div>我们基本上是不想让所有的出口都走OPENVPN的出口的, 只是那些被墙的网站才走openvpn流量. 所以路由表可以更加精细化的配置一下</div><div>例如亚洲的走本地出口, 其他的走openvpn出口. 这里就不举例了.</div><div><br></div><div>五、 设置 OpenVPN 服务器 reboot后自动启动 openvpn</div><div>执行命令:</div><div>代码:</div><div><pre class="prettyprint"   ><p><font size="2"   >vi /etc/rc.local&nbsp;</font></p></pre></div><div>然后在最后面加入此行:</div><div>代码:</div><div><pre class="prettyprint"   ><p><font size="2"   >/opt/openvpn-2.0.5/sbin/openvpn --config /opt/openvpn-2.0.5/etc/server.conf &gt; /dev/null 2&gt;&amp;1 &amp;</font></p></pre></div><div><br></div><div>六、 OpenVPN 测试</div><div>你可以用 VPN 登录上去之后, 测试 MSN, QQ, IE 等网络应用, 也可以尝试访问一些被 GFW 禁掉的网站, 当然, 前提是你的 VPN 服务器不在境内.</div><div><br></div><div>七、 使用 OpenVPN 的强烈注意事项</div><div>不建议用 VPN 登录 paypal 帐户和 google adsense 帐户. 否则有可能导致帐户受限或带来其他风险.</div><div><br></div></div><div>【参考】</div><div><a rel="nofollow" href="http://www.xiaohui.com/dev/server/20070514-install-openvpn.htm"   >http://www.xiaohui.com/dev/server/20070514-install-openvpn.htm</a></div><div><a rel="nofollow" href="http://www.360doc.com/content/11/0225/20/16546_96120912.shtml"   >http://www.360doc.com/content/11/0225/20/16546_96120912.shtml</a></div><div><a rel="nofollow" href="http://www.linuxfly.org/read.php?86"   >http://www.linuxfly.org/read.php?86</a></div><div><a rel="nofollow" href="http://www.linuxfly.org/post/514/"   >http://www.linuxfly.org/post/514/</a></div><div>gui :&nbsp;</div><div><a rel="nofollow" href="http://openvpn.se/download.html"   >http://openvpn.se/download.html</a></div><div><br></div></div></div><div><br></div><div>[其他]</div><div>1. 如果服务器没有外网, 而是内网服务器的话(例如使用cisco vpn拨号过去的情况).</div><div>假设openvpn dhcp网段<span style="line-height: 28px;"   >12.16.0.0/255.255.255.248</span></div><div>openvpn server ip: 192.168.1.5</div><div>openvpn server 内网网段:&nbsp;<span style="line-height: 28px;"   >192.168.1.0/24</span></div><div><span style="line-height: 28px;"   ><br></span></div><div>vpnserver 配置nat转发 :&nbsp;</div><div><div>iptables -t nat -A POSTROUTING -s 12.16.0.0/255.255.255.248 -d ! 192.168.1.0/255.255.255.0 -j SNAT --to-source&nbsp;<span style="line-height: 28px;"   >192.168.1.5</span></div><div><br></div><div>iptables -I FORWARD -p ip -s 12.16.0.0/255.255.255.248 -d 0.0.0.0 -j ACCEPT</div><div>iptables -I FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT</div><div><br></div><div>sysctl -w net.ipv4.ip_forward=1</div><div><br></div><div>vpnserver 测试tun0 是否可以正常访问外网.</div><div>ping -I tun0 8.8.8.8</div><div><br></div><div>openvpn客户, 测试路由是否正确 :&nbsp;</div><div>tracert 8.8.8.8</div></div><div>需通过tun0出去.</div><div><br></div><div>openvpn 客户端可能需要手动修改路由表. 以确保正确路由.</div></div>
	</div>
</div>
</body>
</html>