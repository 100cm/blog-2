<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Performance tuning case : primary key on uuid or text or int8 type column</h2>
	<h5 id="">2012-10-24 16:16:43&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020129249646421/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">某数据库的IO等待非常高, 基本上iostat 看到的磁盘使用率都是接近100%的.<div>分析这个业务库有如下特征 :&nbsp;<br><div>1. 最大的单表20GB左右, 1.2亿数据, 有插入操作, 无更改无删除, 有少量查询.</div></div><div>2. 这些表的索引较少, 只有PK和时间字段上的索引, 注意这里的PK是text类型, 并且使用的是业务系统生成的UUID。</div><div>分析统计信息如下 :&nbsp;</div><div>1. 从pg_stat_statements分析占用CPU时间最多的SQL中, 多数是涉及大表的INSERT语句.</div><div>2. 从iostat看到的基本上是写入的请求居多. 读请求较少. 写请求的等待队列较大.</div><div>其他分析 :&nbsp;</div><div>1. 在业务系统上线初期并没有暴露出严重的IO等待问题, 跟进后面的分析这个应该是和业务量的增长有关, 增长后暴露出来的问题.</div><div>2. 存储没有异常, 也就是说不是硬件带来的问题. 操作系统层面也没有异常.</div><div>3. 从iostat上分析, IO写请求基本上集中在索引所在的目录.</div><div><br></div><div>那么到底是什么导致了这么高的写IO等待呢?&nbsp;</div><div>就是UUID的索引 , 为什么这么说呢? 来看几个内容取样 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------------</font></div><div><font size="2"   >&nbsp;f649e41701d6469396b6256a52a449d7</font></div><div><font size="2"   >&nbsp;731533dc86ba4a449d43a2cbfdf5c8e0</font></div><div><font size="2"   >&nbsp;f28b6efce57e42ed8526293043482a44</font></div><div><font size="2"   >&nbsp;24e5cb3208874f529cf03e9e114b11f1</font></div><div><font size="2"   >&nbsp;f17da47fa0b34f2888d1e97b36c921f6</font></div><div><font size="2"   >&nbsp;175bbb128d2d49df9950dc34a31dab8e</font></div><div><font size="2"   >&nbsp;6bcc21b43ada42128cc45d1b11c4a05f</font></div><div><font size="2"   >&nbsp;c1e7e50fb5824fc9b934314c820941fa</font></div><div><font size="2"   >&nbsp;9a7e490db3c2409d80e6203e84440234</font></div><div><font size="2"   >&nbsp;bae295da28d944a68ecf79b54672811e</font></div><div><font size="2"   >&nbsp;640ad54a5dc84d29b08b74456b3d002a</font></div><div><font size="2"   >&nbsp;09645443e4344dd183ab2c03d573ca2d</font></div><div><font size="2"   >&nbsp;ddd7122ec0484125aeaf3a7599264f3f</font></div><div><font size="2"   >&nbsp;7e9ae853159c456db5dc3820ad463638</font></div><div><font size="2"   >&nbsp;026148ab2d694de69acb6b04055b418c</font></div><div><font size="2"   >&nbsp;9d89d4c9c74b4d02a37dca934e177277</font></div><div><font size="2"   >&nbsp;676d37cc9c9247328f96b6f8eff0f155</font></div><div><font size="2"   >&nbsp;e9aa8f4b96794b9e85a9b46797d07896</font></div><p></p></pre></div><div>很乱, 每次插入的值和前面的值没有关系, 也没有顺序 .&nbsp;</div><div>因此每次插入的值可能存在索引中的位置也是非常随机的, 所以btree索引的树节点和叶节点需要不断的调整, 产生大量的离散IO .&nbsp;</div><div><br></div><div>下面在测试系统进行验证, &nbsp;分别考虑几种情况.</div><div>1. 测试3中类型的主键, uuid , text , int8&nbsp;</div><div>2. 针对 uuid 和 text 测试4种存储配置(plain, main, external, extended)</div><div>3. 测试数据量不同的情况下对性能的影响.</div><div>4. 测试没有索引的情况.</div><div><br></div><div>测试需求 :&nbsp;</div><div>1. 为了生成uuid, 这里需要用到uuid-ossp模块.</div><div>2. 测试用到PostgreSQL 9.2.0版本.</div><div><br></div><div>安装PostgreSQL</div><div>1. 首先要安装uuid需要的依赖包, 在以下网址下载 :&nbsp;</div><div><a rel="nofollow" href="http://www.ossp.org/pkg/lib/uuid/"   >http://www.ossp.org/pkg/lib/uuid/</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >wget&nbsp;ftp://ftp.ossp.org/pkg/lib/uuid/uuid-1.6.2.tar.gz</font></div><div><font size="2"   >tar -zxvf&nbsp;<span style="line-height: 22px;"   >uuid-1.6.2.tar.gz</span></font></div><div><span style="line-height: 22px;"   ><font size="2"   >cd uuid-1.6.2</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >./configure --prefix=/opt/uuid-1.6.2</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >make</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >make install</font></span></div><p></p></pre></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >2. 安装PostgreSQL</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >wget&nbsp;</span>http://ftp.postgresql.org/pub/source/v9.2.0/postgresql-9.2.0.tar.bz2</font></div><div><font size="2"   >tar -jxvf&nbsp;<span style="line-height: 22px;"   >postgresql-9.2.0.tar.bz2</span></font></div><div><font size="2"   ><span style="line-height: 21px;"   >CPPFLAGS=-I/opt/uuid-1.6.2/include </span>./configure --prefix=/home/pg9.2.0/pgsql9.2.0 --with-pgport=9200 --with-perl --with-python --with-tcl --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=16 --with-ossp-uuid --with-libs=/opt/uuid-1.6.2/lib</font></div><div><font size="2"   >gmake world</font></div><div><font size="2"   >gmake install-world</font></div><p></p></pre></div><div><br></div><div>3. 初始化数据库略</div><div><br></div><div>4. 创建两个表空间, 分布在两个不同的独立物理硬盘上, 目的是将索引和数据文件分开, 容易观察和定位到IO问题的发生. (最好能够完全独立, 和GLOBAL表空间, pg_xlog都分开.)</div><div>我这里使用的表空间如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;tbs_digoal &nbsp; &nbsp; &nbsp; | postgres | /data04/pg9.2.0/tbs_digoal</font></div><div><font size="2"   >&nbsp;tbs_digoal_idx | postgres | /data03/pgdata/pg9.2.0/tbs_digoal_idx</font></div><p></p></pre></div><div>其中索引所在表空间位于/dev/sda3, &nbsp;表所在表空间位于/dev/sdb</div><div><br></div><div>5. 安装uuid-ossp模块</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg9.2.0@db-172-16-3-150-&gt; psql digoal postgres</font></div><div><font size="2"   >psql (9.2.0)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# create extension "uuid-ossp";</font></div><p></p></pre></div><div><br></div><div>6. 创建测试表, 指定索引表空间和表的表空间.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; create table test_uuid_pk (id uuid primary key using index tablespace tbs_digoal_idx) tablespace tbs_digoal;</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "test_uuid_pk_pkey" for table "test_uuid_pk"</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=&gt; create table test_text_pk (id text primary key using index tablespace tbs_digoal_idx) tablespace tbs_digoal;</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "test_text_pk_pkey" for table "test_text_pk"</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=&gt; create table test_int8_pk (id int8 primary key using index tablespace tbs_digoal_idx) tablespace tbs_digoal;</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "test_int8_pk_pkey" for table "test_int8_pk"</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><font size="2"   >digoal=&gt; create sequence test_seq start with 1 cache 100;</font></div><div><font size="2"   >CREATE SEQUENCE</font></div><p></p></pre></div><div><br></div><div>开始测试, 每次测试前手工执行checkpoint, 以免影响测试的结果.</div><div>需要关注几组数据 :&nbsp;</div><div>top里面的%wa, iostat里面的%util, pgbench里面的tps.</div><div><br></div><div>1. 测试uuid字段类型的主键, 使用pgbench测试插入离散uuid数据到测试表.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pgbench script :&nbsp;</font></div><div><font size="2"   >vi pgbench.sql</font></div><div><font size="2"   >insert into test_uuid_pk (id) values (uuid_generate_v4());</font></div><p></p></pre></div><div><div style="line-height: 22px;"   >测试,&nbsp;</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >digoal=# checkpoint;</font></div><div style="line-height: 22px;"   ><font size="2"   >CHECKPOINT</font></div><div style="line-height: 22px;"   ><span style="font-size: small; line-height: 19px;"   >pgbench测试结果 : </span></div><div><div><font size="2"   >pg9.2.0@db-172-16-3-150-&gt; pgbench -M prepared -n -j 8 -c 8 -T 60 -f ./pgbench.sql -U digoal digoal&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 2462748</font></div><div><font size="2"   >tps = 41039.584555 (including connections establishing)</font></div><div><font size="2"   >tps = 41044.669903 (excluding connections establishing)</font></div></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >测试过程中的</span>top截取 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Tasks: 247 total, &nbsp;11 running, 236 sleeping, &nbsp; 0 stopped, &nbsp; 0 zombie</font></div><div><font size="2"   >Cpu(s): 41.1%us, 36.9%sy, &nbsp;0.0%ni, 14.8%id, &nbsp;4.1%wa, &nbsp;0.2%hi, &nbsp;2.8%si, &nbsp;0.0%st</font></div><div><font size="2"   >Mem: &nbsp;98992440k total, 89684600k used, &nbsp;9307840k free, &nbsp;1246100k buffers</font></div><div><font size="2"   >Swap: &nbsp;8385920k total, &nbsp; &nbsp; &nbsp; &nbsp;0k used, &nbsp;8385920k free, 85007228k cached</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;RES &nbsp;SHR S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;6267 pg9.2.0 &nbsp; 15 &nbsp; 0 &nbsp;319m 2100 1524 S 75.0 &nbsp;0.0 &nbsp; 0:32.29 pgbench -M prepared -n -j 8 -c 8 -T 60 -f ./pgbench.sql -U digoal digoa</font></div><div><font size="2"   >&nbsp;6278 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 130m 128m R 68.1 &nbsp;0.1 &nbsp; 0:28.46 postgres: digoal digoal [local] BIND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6277 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 129m 128m R 66.1 &nbsp;0.1 &nbsp; 0:27.94 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6282 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 129m 128m R 66.1 &nbsp;0.1 &nbsp; 0:27.83 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6284 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 129m 127m R 65.2 &nbsp;0.1 &nbsp; 0:27.70 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6280 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 129m 127m R 62.2 &nbsp;0.1 &nbsp; 0:27.95 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6281 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 129m 128m R 62.2 &nbsp;0.1 &nbsp; 0:27.82 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6283 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 129m 128m R 60.2 &nbsp;0.1 &nbsp; 0:28.11 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6276 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 129m 128m R 59.2 &nbsp;0.1 &nbsp; 0:27.73 postgres: digoal digoal [local] INSERT</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >测试过程中的</span><span style="line-height: 22px;"   >iostat截取 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >avg-cpu: &nbsp;%user &nbsp; %nice %system %iowait &nbsp;%steal &nbsp; %idle</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 36.12 &nbsp; &nbsp;0.00 &nbsp; 34.12 &nbsp; &nbsp;5.12 &nbsp; &nbsp;0.00 &nbsp; 24.62</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Device: &nbsp; &nbsp; &nbsp; &nbsp; rrqm/s &nbsp; wrqm/s &nbsp; r/s &nbsp; w/s &nbsp; rsec/s &nbsp; wsec/s avgrq-sz avgqu-sz &nbsp; await &nbsp;svctm &nbsp;%util</font></div><div><font size="2"   >sda &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 27606.00 &nbsp;0.00 4723.00 &nbsp; &nbsp; 0.00 265880.00 &nbsp; &nbsp;56.29 &nbsp; &nbsp;51.15 &nbsp; 11.67 &nbsp; 0.12 &nbsp;57.50</font></div><div><font size="2"   >sda1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div><font size="2"   >sda2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div><font size="2"   >sda3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 27606.00 &nbsp;0.00 4723.00 &nbsp; &nbsp; 0.00 265880.00 &nbsp; &nbsp;56.29 &nbsp; &nbsp;51.15 &nbsp; 11.67 &nbsp; 0.12 &nbsp;57.50</font></div><div><font size="2"   >sdb &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 26533.00 &nbsp;0.00 976.00 &nbsp; &nbsp; 0.00 220064.00 &nbsp; 225.48 &nbsp; &nbsp; 1.43 &nbsp; &nbsp;1.48 &nbsp; 0.76 &nbsp;74.50</font></div><div><font size="2"   >dm-0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 27508.00 &nbsp; &nbsp; 0.00 220064.00 &nbsp; &nbsp; 8.00 &nbsp; &nbsp;71.27 &nbsp; &nbsp;2.59 &nbsp; 0.03 &nbsp;74.50</font></div><div><font size="2"   >dm-1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 32192.00 &nbsp; &nbsp; 0.00 257536.00 &nbsp; &nbsp; 8.00 &nbsp; 352.96 &nbsp; 11.68 &nbsp; 0.02 &nbsp;57.60</font></div><div><font size="2"   >dm-2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 27508.00 &nbsp; &nbsp; 0.00 220064.00 &nbsp; &nbsp; 8.00 &nbsp; &nbsp;71.31 &nbsp; &nbsp;2.59 &nbsp; 0.03 &nbsp;74.50</font></div><p></p></pre></div></div></div><div><br></div><div>2. 测试text字段类型<span style="line-height: 22px;"   >的主键</span><span style="line-height: 22px;"   >, 使用pgbench测试插入离散uuid数据到测试表.</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >pgbench script :&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >vi pgbench.sql</font></div><div style="line-height: 22px;"   ><font size="2"   >insert into test_text_pk (id) values (uuid_generate_v4());</font></div><p></p></pre></div></div><div style="line-height: 22px;"   >测试,&nbsp;</div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >digoal=# checkpoint;</font></div><div style="line-height: 22px;"   ><font size="2"   >CHECKPOINT</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench测试结果 : </font></div></div><div><div><font size="2"   >pg9.2.0@db-172-16-3-150-&gt; pgbench -M prepared -n -j 8 -c 8 -T 60 -f ./pgbench.sql -U digoal digoal&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 2133816</font></div><div><font size="2"   >tps = 34674.325489 (including connections establishing)</font></div><div><font size="2"   >tps = 34677.786574 (excluding connections establishing)</font></div></div><p></p></pre></div></div><div><span style="line-height: 22px;"   >测试过程中的</span><span style="line-height: 22px;"   >top截取 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Tasks: 244 total, &nbsp; 6 running, 238 sleeping, &nbsp; 0 stopped, &nbsp; 0 zombie</font></div><div><font size="2"   >Cpu(s): 32.6%us, 27.4%sy, &nbsp;0.0%ni, 32.0%id, &nbsp;6.0%wa, &nbsp;0.1%hi, &nbsp;1.9%si, &nbsp;0.0%st</font></div><div><font size="2"   >Mem: &nbsp;98992440k total, 89138112k used, &nbsp;9854328k free, &nbsp;1246048k buffers</font></div><div><font size="2"   >Swap: &nbsp;8385920k total, &nbsp; &nbsp; &nbsp; &nbsp;0k used, &nbsp;8385920k free, 84442028k cached</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;RES &nbsp;SHR S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;5580 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m &nbsp;69m &nbsp;68m R 52.5 &nbsp;0.1 &nbsp; 0:07.09 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;5566 pg9.2.0 &nbsp; 15 &nbsp; 0 &nbsp;255m 2096 1524 S 52.1 &nbsp;0.0 &nbsp; 0:07.94 pgbench -M prepared -n -j 8 -c 8 -T 60 -f ./pgbench.sql -U digoal digoa</font></div><div><font size="2"   >&nbsp;5582 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m &nbsp;69m &nbsp;67m S 51.5 &nbsp;0.1 &nbsp; 0:06.96 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;5576 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m &nbsp;69m &nbsp;68m R 50.8 &nbsp;0.1 &nbsp; 0:07.08 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;5581 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m &nbsp;69m &nbsp;67m S 49.5 &nbsp;0.1 &nbsp; 0:06.93 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;5577 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m &nbsp;69m &nbsp;67m S 49.1 &nbsp;0.1 &nbsp; 0:07.01 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;5579 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m &nbsp;69m &nbsp;68m S 49.1 &nbsp;0.1 &nbsp; 0:06.90 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;5575 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m &nbsp;69m &nbsp;67m R 48.5 &nbsp;0.1 &nbsp; 0:07.07 postgres: digoal digoal [local] BIND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;5578 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m &nbsp;69m &nbsp;67m R 46.2 &nbsp;0.1 &nbsp; 0:06.83 postgres: digoal digoal [local] INSERT</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >测试过程中的</span><span style="line-height: 22px;"   >iostat截取 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >avg-cpu: &nbsp;%user &nbsp; %nice %system %iowait &nbsp;%steal &nbsp; %idle</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 37.58 &nbsp; &nbsp;0.00 &nbsp; 32.58 &nbsp; &nbsp;5.37 &nbsp; &nbsp;0.00 &nbsp; 24.47</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Device: &nbsp; &nbsp; &nbsp; &nbsp; rrqm/s &nbsp; wrqm/s &nbsp; r/s &nbsp; w/s &nbsp; rsec/s &nbsp; wsec/s avgrq-sz avgqu-sz &nbsp; await &nbsp;svctm &nbsp;%util</font></div><div><font size="2"   >sda &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 28633.00 &nbsp;0.00 6048.00 &nbsp; &nbsp; 0.00 272856.00 &nbsp; &nbsp;45.12 &nbsp; &nbsp;54.31 &nbsp; &nbsp;8.88 &nbsp; 0.09 &nbsp;56.70</font></div><div><font size="2"   >sda1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div><font size="2"   >sda2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div><font size="2"   >sda3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 28633.00 &nbsp;0.00 6048.00 &nbsp; &nbsp; 0.00 272856.00 &nbsp; &nbsp;45.12 &nbsp; &nbsp;54.31 &nbsp; &nbsp;8.88 &nbsp; 0.09 &nbsp;56.70</font></div><div><font size="2"   >sdb &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 29436.00 &nbsp;0.00 746.00 &nbsp; &nbsp; 0.00 239496.00 &nbsp; 321.04 &nbsp; &nbsp; 1.71 &nbsp; &nbsp;2.29 &nbsp; 0.89 &nbsp;66.60</font></div><div><font size="2"   >dm-0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 30196.00 &nbsp; &nbsp; 0.00 241568.00 &nbsp; &nbsp; 8.00 &nbsp; &nbsp;90.18 &nbsp; &nbsp;2.98 &nbsp; 0.02 &nbsp;66.60</font></div><div><font size="2"   >dm-1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 34804.00 &nbsp; &nbsp; 0.00 278432.00 &nbsp; &nbsp; 8.00 &nbsp; 322.95 &nbsp; &nbsp;9.19 &nbsp; 0.02 &nbsp;56.70</font></div><div><font size="2"   >dm-2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 30196.00 &nbsp; &nbsp; 0.00 241568.00 &nbsp; &nbsp; 8.00 &nbsp; &nbsp;90.23 &nbsp; &nbsp;2.98 &nbsp; 0.02 &nbsp;66.60</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"   >3. 测试text字段类型</span><span style="line-height: 22px;"   >的主键</span><span style="line-height: 22px;"   >, 使用pgbench测试插入顺序的唯一数据到测试表.</span></div><div><span style="line-height: 22px;"   >顺序的UUID例如 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >5a50fad8-81ac-4249-8390-f06e37fb1e9b1</font></div><div><font size="2"   >5a50fad8-81ac-4249-8390-f06e37fb1e9b2</font></div><div><font size="2"   >5a50fad8-81ac-4249-8390-f06e37fb1e9b3</font></div><div><font size="2"   >5a50fad8-81ac-4249-8390-f06e37fb1e9b4</font></div><div><font size="2"   >5a50fad8-81ac-4249-8390-f06e37fb1e9b5</font></div><div><font size="2"   >...</font></div><p></p></pre></div><div><div><pre class="prettyprint"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   >pgbench script :&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >vi pgbench.sql</font></div><div><font size="2"   style="line-height: 22px;"   >insert into test_text_pk (id) values ('</font><font size="2"   ><span style="line-height: 19px;"   >5a50fad8-81ac-4249-8390-f06e37fb1e9b</span></font><span style="line-height: 22px; font-size: small;"   >'||nextval('test_seq'::regclass));</span></div><p style="line-height: 22px;"   ></p></pre></div></div><div><div style="line-height: 22px;"   >测试,&nbsp;</div><div><div><pre class="prettyprint"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   >digoal=# checkpoint;</font></div><div style="line-height: 22px;"   ><font size="2"   >CHECKPOINT</font></div><div style="line-height: 22px;"   ><div><font size="2"   >digoal=&gt; truncate table test_text_pk ;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div></div><div style="line-height: 22px;"   ><span style="line-height: 19px;"   ><font size="2"   >pgbench测试结果 : </font></span></div><div><font size="2"   ><span style="line-height: 19px;"   >pg9.2.0@db-172-16-3-150-&gt; pgbench -M prepared -n -j 8 -c 8 -T 60 -f ./pgbench.sql -U digoal digoal <br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 8<br>number of threads: 8<br>duration: 60 s<br>number of transactions actually processed: 4548223<br>tps = 75802.392652 (including connections establishing)<br>tps = 75811.583066 (excluding connections establishing)</span></font></div><p style="line-height: 22px;"   ></p></pre></div><div><span style="line-height: 22px;"   >测试过程中的</span><span style="line-height: 22px;"   >top截取 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><font size="2"   ><span style="line-height: 19px;"   >Tasks: 247 total,   6 running, 241 sleeping,   0 stopped,   0 zombie<br>Cpu(s): 65.8%us, 26.7%sy,  0.0%ni,  6.3%id,  0.4%wa,  0.1%hi,  0.7%si,  0.0%st<br>Mem:  98992440k total, 89949664k used,  9042776k free,  1246152k buffers<br>Swap:  8385920k total,        0k used,  8385920k free, 85253040k cached<br><br>  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                <br> 7266 pg9.2.0   15   0  320m 2104 1520 S 119.6  0.0   0:29.43 pgbench -M prepared -n -j 8 -c 8 -T 60 -f ./pgbench.sql -U digoal digo<br> 7275 pg9.2.0   16   0 1180m 172m 170m S 80.1  0.2   0:19.20 postgres: digoal digoal [local] idle                                   <br> 7281 pg9.2.0   17   0 1180m 165m 163m R 79.1  0.2   0:18.45 postgres: digoal digoal [local] INSERT                                 <br> 7277 pg9.2.0   17   0 1180m 166m 164m R 77.1  0.2   0:18.62 postgres: digoal digoal [local] INSERT                                 <br> 7276 pg9.2.0   17   0 1180m 167m 165m R 75.1  0.2   0:18.69 postgres: digoal digoal [local] idle                                   <br> 7278 pg9.2.0   18   0 1180m 166m 164m R 75.1  0.2   0:18.57 postgres: digoal digoal [local] BIND                                   <br> 7280 pg9.2.0   17   0 1180m 167m 165m R 75.1  0.2   0:18.59 postgres: digoal digoal [local] INSERT                                 <br> 7279 pg9.2.0   17   0 1180m 167m 165m S 72.1  0.2   0:18.59 postgres: digoal digoal [local] idle                                   <br></span></font><div><font size="2"   ><span style="line-height: 19px;"   > 7282 pg9.2.0   17   0 1180m 164m 162m S 69.2  0.2   0:18.54 postgres: digoal digoal [local] idle </span></font><span style="font-size: small;"   >&nbsp;</span></div><p></p></pre></div><div><span style="line-height: 22px;"   >测试过程中的</span><span style="line-height: 22px;"   >iostat截取 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >avg-cpu:  %user   %nice %system %iowait  %steal   %idle<br>          64.96    0.00   26.56    0.50    0.00    7.98<br><br>Device:         rrqm/s   wrqm/s   r/s   w/s   rsec/s   wsec/s avgrq-sz avgqu-sz   await  svctm  %util<br>sda               0.00  1909.00  0.00 36.00     0.00 15560.00   432.22     0.35    9.75   0.56   2.00<br>sda1              0.00     0.00  0.00  0.00     0.00     0.00     0.00     0.00    0.00   0.00   0.00<br>sda2              0.00     0.00  0.00  0.00     0.00     0.00     0.00     0.00    0.00   0.00   0.00<br>sda3              0.00  1909.00  0.00 36.00     0.00 15560.00   432.22     0.35    9.75   0.56   2.00<br>sdb               0.00 10053.00  0.00 2817.00     0.00 102984.00    36.56     0.56    0.20   0.12  34.90<br>dm-0              0.00     0.00  0.00 12873.00     0.00 102984.00     8.00    10.19    0.79   0.03  35.10<br>dm-1              0.00     0.00  0.00 1945.00     0.00 15560.00     8.00    19.65   10.10   0.01   2.00<br>dm-2              0.00     0.00  0.00 12873.00     0.00 102984.00     8.00    10.80    0.79   0.03  35.40</span></font></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div></div></div><div>4. 测试int8字段类型<span style="line-height: 22px;"   >的主键</span><span style="line-height: 22px;"   >, 使用pgbench测试插入整型数据到测试表.</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >pgbench script :&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >vi pgbench.sql</font></div><div style="line-height: 22px;"   ><font size="2"   >insert into test_int8_pk (id) values (nextval('test_seq'::regclass));</font></div><p></p></pre></div></div><div><div style="line-height: 22px;"   >测试,&nbsp;</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >digoal=# checkpoint;</font></div><div style="line-height: 22px;"   ><font size="2"   >CHECKPOINT</font></div><div style="line-height: 22px;"   ><span style="line-height: 19px;"   ><font size="2"   >pgbench测试结果 : </font></span></div><div><div><font size="2"   >pg9.2.0@db-172-16-3-150-&gt; pgbench -M prepared -n -j 8 -c 8 -T 60 -f ./pgbench.sql -U digoal digoal&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 5088896</font></div><div><font size="2"   >tps = 84813.774212 (including connections establishing)</font></div><div><font size="2"   >tps = 84822.447895 (excluding connections establishing)</font></div></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >测试过程中的</span><span style="line-height: 22px;"   >top截取 :&nbsp;</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Tasks: 247 total, &nbsp; 9 running, 238 sleeping, &nbsp; 0 stopped, &nbsp; 0 zombie</font></div><div><font size="2"   >Cpu(s): 63.0%us, 29.1%sy, &nbsp;0.0%ni, &nbsp;7.0%id, &nbsp;0.2%wa, &nbsp;0.1%hi, &nbsp;0.5%si, &nbsp;0.0%st</font></div><div><font size="2"   >Mem: &nbsp;98992440k total, 89760120k used, &nbsp;9232320k free, &nbsp;1246116k buffers</font></div><div><font size="2"   >Swap: &nbsp;8385920k total, &nbsp; &nbsp; &nbsp; &nbsp;0k used, &nbsp;8385920k free, 85081028k cached</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;RES &nbsp;SHR S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;6865 pg9.2.0 &nbsp; 15 &nbsp; 0 &nbsp;319m 2100 1524 S 126.5 &nbsp;0.0 &nbsp; 0:35.91 pgbench -M prepared -n -j 8 -c 8 -T 60 -f ./pgbench.sql -U digoal digo</font></div><div><font size="2"   >&nbsp;6877 pg9.2.0 &nbsp; 18 &nbsp; 0 1180m 114m 113m R 77.1 &nbsp;0.1 &nbsp; 0:20.89 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6880 pg9.2.0 &nbsp; 18 &nbsp; 0 1180m 115m 113m R 77.1 &nbsp;0.1 &nbsp; 0:20.80 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6876 pg9.2.0 &nbsp; 18 &nbsp; 0 1180m 114m 113m R 76.1 &nbsp;0.1 &nbsp; 0:21.10 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6878 pg9.2.0 &nbsp; 18 &nbsp; 0 1180m 116m 115m R 75.1 &nbsp;0.1 &nbsp; 0:21.11 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6879 pg9.2.0 &nbsp; 18 &nbsp; 0 1180m 115m 114m R 75.1 &nbsp;0.1 &nbsp; 0:20.99 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6874 pg9.2.0 &nbsp; 17 &nbsp; 0 1180m 117m 115m R 74.1 &nbsp;0.1 &nbsp; 0:21.30 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6875 pg9.2.0 &nbsp; 18 &nbsp; 0 1180m 115m 114m R 74.1 &nbsp;0.1 &nbsp; 0:21.36 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;6881 pg9.2.0 &nbsp; 18 &nbsp; 0 1180m 115m 114m R 69.2 &nbsp;0.1 &nbsp; 0:20.85 postgres: digoal digoal [local] INSERT</font></div><p></p></pre></div><div>测试过程中的iostat截取 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >avg-cpu: &nbsp;%user &nbsp; %nice %system %iowait &nbsp;%steal &nbsp; %idle</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 61.92 &nbsp; &nbsp;0.00 &nbsp; 29.96 &nbsp; &nbsp;0.25 &nbsp; &nbsp;0.00 &nbsp; &nbsp;7.87</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Device: &nbsp; &nbsp; &nbsp; &nbsp; rrqm/s &nbsp; wrqm/s &nbsp; r/s &nbsp; w/s &nbsp; rsec/s &nbsp; wsec/s avgrq-sz avgqu-sz &nbsp; await &nbsp;svctm &nbsp;%util</font></div><div><font size="2"   >sda &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 &nbsp;2078.00 &nbsp;0.00 40.00 &nbsp; &nbsp; 0.00 16944.00 &nbsp; 423.60 &nbsp; &nbsp; 0.15 &nbsp; &nbsp;3.65 &nbsp; 0.53 &nbsp; 2.10</font></div><div><font size="2"   >sda1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;11.00 &nbsp;0.00 &nbsp;2.00 &nbsp; &nbsp; 0.00 &nbsp; 104.00 &nbsp; &nbsp;52.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div><font size="2"   >sda2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div><font size="2"   >sda3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp;2067.00 &nbsp;0.00 38.00 &nbsp; &nbsp; 0.00 16840.00 &nbsp; 443.16 &nbsp; &nbsp; 0.15 &nbsp; &nbsp;3.84 &nbsp; 0.55 &nbsp; 2.10</font></div><div><font size="2"   >sdb &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 &nbsp;7377.00 &nbsp;0.00 2112.00 &nbsp; &nbsp; 0.00 75912.00 &nbsp; &nbsp;35.94 &nbsp; &nbsp; 0.40 &nbsp; &nbsp;0.19 &nbsp; 0.12 &nbsp;25.20</font></div><div><font size="2"   >dm-0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 9489.00 &nbsp; &nbsp; 0.00 75912.00 &nbsp; &nbsp; 8.00 &nbsp; &nbsp; 5.81 &nbsp; &nbsp;0.61 &nbsp; 0.03 &nbsp;25.90</font></div><div><font size="2"   >dm-1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 2105.00 &nbsp; &nbsp; 0.00 16840.00 &nbsp; &nbsp; 8.00 &nbsp; &nbsp; 7.83 &nbsp; &nbsp;3.72 &nbsp; 0.01 &nbsp; 2.10</font></div><div><font size="2"   >dm-2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 9489.00 &nbsp; &nbsp; 0.00 75912.00 &nbsp; &nbsp; 8.00 &nbsp; &nbsp; 5.83 &nbsp; &nbsp;0.61 &nbsp; 0.03 &nbsp;26.10</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >其他几种测试数据就不一一列出来了, 简单的进行总结.</span></div></div></div><div><div style="line-height: 22px;"   >1. 针对 uuid 和 text 测试4种存储配置 (plain, main, external, extended) .&nbsp;</div><div style="line-height: 22px;"   >默认是extended存储, 所以以上测试都是在extended下进行的.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >数据量5000W后进行的测试 : 所以比较数据请参看后面的数据.</font></div><div><font size="2"   >digoal=&gt; \d+ test_text_pk</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "digoal.test_text_pk"</font></div><div><font size="2"   >&nbsp;Column | Type | Modifiers | Storage &nbsp;| Stats target | Description&nbsp;</font></div><div><font size="2"   >--------+------+-----------+----------+--------------+-------------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; | text | not null &nbsp;| extended | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "test_text_pk_pkey" PRIMARY KEY, btree (id), tablespace "tbs_digoal_idx"</font></div><div><font size="2"   >Has OIDs: no</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; alter table test_text_pk alter column id set storage plain;</font></div><div><font size="2"   >ALTER TABLE</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >pg9.2.0@db-172-16-3-150-&gt; pgbench -M prepared -n -j 8 -c 8 -T 60 -f ./pgbench.sql -U digoal digoal&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 216127</font></div><div><font size="2"   >tps = 3576.422811 (including connections establishing)</font></div><div><font size="2"   >tps = 3576.800549 (excluding connections establishing)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >Tasks: 249 total, &nbsp; 1 running, 248 sleeping, &nbsp; 0 stopped, &nbsp; 0 zombie</font></div><div><font size="2"   >Cpu(s): &nbsp;3.6%us, &nbsp;3.6%sy, &nbsp;0.0%ni, 79.1%id, 13.5%wa, &nbsp;0.0%hi, &nbsp;0.2%si, &nbsp;0.0%st</font></div><div><font size="2"   >Mem: &nbsp;98992440k total, 92489108k used, &nbsp;6503332k free, &nbsp; 760752k buffers</font></div><div><font size="2"   >Swap: &nbsp;8385920k total, &nbsp; &nbsp; &nbsp; 60k used, &nbsp;8385860k free, 88174496k cached</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;RES &nbsp;SHR S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >10661 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 330m 328m S &nbsp;6.9 &nbsp;0.3 &nbsp; 0:04.10 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >10654 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 326m 324m S &nbsp;5.9 &nbsp;0.3 &nbsp; 0:04.03 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >10655 pg9.2.0 &nbsp; 15 &nbsp; 0 1184m 334m 332m S &nbsp;5.9 &nbsp;0.3 &nbsp; 0:04.14 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >10658 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 322m 320m S &nbsp;5.9 &nbsp;0.3 &nbsp; 0:03.94 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >10659 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 333m 331m S &nbsp;5.9 &nbsp;0.3 &nbsp; 0:04.16 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >10656 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 322m 320m S &nbsp;4.9 &nbsp;0.3 &nbsp; 0:03.96 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >10657 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 333m 331m S &nbsp;4.9 &nbsp;0.3 &nbsp; 0:04.15 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >10660 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 331m 329m S &nbsp;4.9 &nbsp;0.3 &nbsp; 0:04.12 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >10645 pg9.2.0 &nbsp; 15 &nbsp; 0 &nbsp;255m 2092 1524 S &nbsp;3.9 &nbsp;0.0 &nbsp; 0:03.35 pgbench -M prepared -n -j 8 -c 8 -T 60 -f ./pgbench.sql -U digoal digoa</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >avg-cpu: &nbsp;%user &nbsp; %nice %system %iowait &nbsp;%steal &nbsp; %idle</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;0.00 &nbsp; &nbsp;1.50 &nbsp; 14.96 &nbsp; &nbsp;0.00 &nbsp; 83.54</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Device: &nbsp; &nbsp; &nbsp; &nbsp; rrqm/s &nbsp; wrqm/s &nbsp; r/s &nbsp; w/s &nbsp; rsec/s &nbsp; wsec/s avgrq-sz avgqu-sz &nbsp; await &nbsp;svctm &nbsp;%util</font></div><div><font size="2"   >sda &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 &nbsp; 862.00 &nbsp;0.00 654.00 &nbsp; &nbsp; 0.00 11880.00 &nbsp; &nbsp;18.17 &nbsp; 145.69 &nbsp;218.26 &nbsp; 1.53 100.10</font></div><div><font size="2"   >sda1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;13.00 &nbsp;0.00 &nbsp;2.00 &nbsp; &nbsp; 0.00 &nbsp; 120.00 &nbsp; &nbsp;60.00 &nbsp; &nbsp; 0.31 &nbsp;157.00 157.00 &nbsp;31.40</font></div><div><font size="2"   >sda2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div><font size="2"   >sda3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; 849.00 &nbsp;0.00 652.00 &nbsp; &nbsp; 0.00 11760.00 &nbsp; &nbsp;18.04 &nbsp; 145.38 &nbsp;218.45 &nbsp; 1.54 100.10</font></div><div><font size="2"   >sdb &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 &nbsp;5311.00 &nbsp;0.00 84.00 &nbsp; &nbsp; 0.00 39896.00 &nbsp; 474.95 &nbsp; &nbsp;23.67 &nbsp;294.74 &nbsp;11.64 &nbsp;97.80</font></div><div><font size="2"   >dm-0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 5403.00 &nbsp; &nbsp; 0.00 43224.00 &nbsp; &nbsp; 8.00 &nbsp;1436.09 &nbsp;279.59 &nbsp; 0.18 &nbsp;97.80</font></div><div><font size="2"   >dm-1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 1522.00 &nbsp; &nbsp; 0.00 12176.00 &nbsp; &nbsp; 8.00 &nbsp; 330.52 &nbsp;212.65 &nbsp; 0.66 100.10</font></div><div><font size="2"   >dm-2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 5403.00 &nbsp; &nbsp; 0.00 43224.00 &nbsp; &nbsp; 8.00 &nbsp;1436.09 &nbsp;279.59 &nbsp; 0.18 &nbsp;97.80</font></div></div><p></p></pre></div><div><br></div><div style="line-height: 22px;"   >略. 这几种模式影响不明显. 主要压缩和数据存储开销的均衡, 也就是硬件的CPU能力和IO能力的抉择.</div><div style="line-height: 22px;"   >plain和external都不压缩, 一个是存在表的数据文件中一个是存在toast中.</div><div style="line-height: 22px;"   >main和extended都压缩,&nbsp;<span style="line-height: 22px;"   >一个是存在表的数据文件中一个是存在toast中.</span></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >2. 测试数据量不同的情况下对性能的影响.</div><div style="line-height: 22px;"   >数据量越大, 连续插入离散值带来的影响越大, tps越低. &nbsp;而连续插入顺序值则几乎不受影响. 下面是把基础数据加到5000W后进行的测试. 可以看出<span style="line-height: 22px;"   >连续插入离散值到主键的测试</span><span style="line-height: 22px;"   >有明显的性能变化.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >连续插入顺序值的测试结果</span>如下 :&nbsp;</div><div><pre class="prettyprint"   ><div><span style="font-size: small;"   >digoal=&gt; truncate table test_int8_pk ;</span></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >digoal=&gt; \d test_int8_pk</font></div><div><font size="2"   >&nbsp;Table "digoal.test_int8_pk"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp;| Modifiers&nbsp;</font></div><div><font size="2"   >--------+--------+-----------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; | bigint | not null</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "test_int8_pk_pkey" PRIMARY KEY, btree (id), tablespace "tbs_digoal_idx"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; alter table test_int8_pk drop constraint test_int8_pk_pkey;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >插入5000W数据, 为了加快速度, 先删除PK, 数据插入完后再加入进来.</font></div><div><font size="2"   >digoal=&gt; insert into test_int8_pk select generate_series (1,50000000);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >\c digoal digoal</font></div><div><font size="2"   >set work_mem='4096MB';</font></div><div><font size="2"   >set maintenance_work_mem='4096MB';</font></div><div><font size="2"   >alter table test_int8_pk add constraint test_int8_pk_pkey primary key(id) using index tablespace tbs_digoal_idx;</font></div><div><font size="2"   >alter sequence test_seq start with 50000001;</font></div><div><font size="2"   >\c digoal postgres</font></div><div><font size="2"   >checkpoint;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >测试数据 : </font></div><div><font size="2"   >pg9.2.0@db-172-16-3-150-&gt; pgbench -M prepared -n -j 8 -c 8 -T 60 -f ./pgbench.sql -U digoal digoal&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 4557154</font></div><div><font size="2"   >tps = 75951.686893 (including connections establishing)</font></div><div><font size="2"   >tps = 75962.447482 (excluding connections establishing)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >TOP数据 : </font></div><div><font size="2"   >Cpu(s): 65.4%us, 26.3%sy, &nbsp;0.0%ni, &nbsp;6.9%id, &nbsp;0.4%wa, &nbsp;0.1%hi, &nbsp;0.9%si, &nbsp;0.0%st</font></div><div><font size="2"   >Mem: &nbsp;98992440k total, 93250652k used, &nbsp;5741788k free, &nbsp;1246256k buffers</font></div><div><font size="2"   >Swap: &nbsp;8385920k total, &nbsp; &nbsp; &nbsp; &nbsp;0k used, &nbsp;8385920k free, 88484952k cached</font></div><div><font size="2"   >&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;RES &nbsp;SHR S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;8263 pg9.2.0 &nbsp; 15 &nbsp; 0 &nbsp;319m 2108 1520 S 115.6 &nbsp;0.0 &nbsp; 0:25.50 pgbench -M prepared -n -j 8 -c 8 -T 60 -f ./pgbench.sql -U digoal digo</font></div><div><font size="2"   >&nbsp;8274 pg9.2.0 &nbsp; 18 &nbsp; 0 1180m 137m 135m R 78.1 &nbsp;0.1 &nbsp; 0:16.33 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;8276 pg9.2.0 &nbsp; 18 &nbsp; 0 1180m 134m 132m R 78.1 &nbsp;0.1 &nbsp; 0:16.12 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;8273 pg9.2.0 &nbsp; 18 &nbsp; 0 1180m 134m 133m R 77.1 &nbsp;0.1 &nbsp; 0:16.00 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;8277 pg9.2.0 &nbsp; 18 &nbsp; 0 1180m 136m 134m R 75.1 &nbsp;0.1 &nbsp; 0:16.39 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;8272 pg9.2.0 &nbsp; 18 &nbsp; 0 1180m 143m 141m R 74.1 &nbsp;0.1 &nbsp; 0:16.56 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;8275 pg9.2.0 &nbsp; 18 &nbsp; 0 1180m 137m 135m R 74.1 &nbsp;0.1 &nbsp; 0:16.55 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;8278 pg9.2.0 &nbsp; 18 &nbsp; 0 1180m 133m 132m R 74.1 &nbsp;0.1 &nbsp; 0:15.99 postgres: digoal digoal [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;8279 pg9.2.0 &nbsp; 18 &nbsp; 0 1180m 135m 133m R 72.1 &nbsp;0.1 &nbsp; 0:16.14 postgres: digoal digoal [local] INSERT</font></div><div><br></div><div><font size="2"   >IOSTAT 数据 : </font></div><div><font size="2"   >avg-cpu: &nbsp;%user &nbsp; %nice %system %iowait &nbsp;%steal &nbsp; %idle</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 65.04 &nbsp; &nbsp;0.00 &nbsp; 27.59 &nbsp; &nbsp;0.50 &nbsp; &nbsp;0.00 &nbsp; &nbsp;6.87</font></div><div><font size="2"   >Device: &nbsp; &nbsp; &nbsp; &nbsp; rrqm/s &nbsp; wrqm/s &nbsp; r/s &nbsp; w/s &nbsp; rsec/s &nbsp; wsec/s avgrq-sz avgqu-sz &nbsp; await &nbsp;svctm &nbsp;%util</font></div><div><font size="2"   >sda &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 &nbsp;1899.00 &nbsp;0.00 40.00 &nbsp; &nbsp; 0.00 15512.00 &nbsp; 387.80 &nbsp; &nbsp; 0.29 &nbsp; &nbsp;7.17 &nbsp; 0.47 &nbsp; 1.90</font></div><div><font size="2"   >sda1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;11.00 &nbsp;0.00 &nbsp;2.00 &nbsp; &nbsp; 0.00 &nbsp; 104.00 &nbsp; &nbsp;52.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div><font size="2"   >sda2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div><font size="2"   >sda3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp;1888.00 &nbsp;0.00 38.00 &nbsp; &nbsp; 0.00 15408.00 &nbsp; 405.47 &nbsp; &nbsp; 0.29 &nbsp; &nbsp;7.55 &nbsp; 0.50 &nbsp; 1.90</font></div><div><font size="2"   >sdb &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 10063.00 &nbsp;0.00 2843.00 &nbsp; &nbsp; 0.00 103248.00 &nbsp; &nbsp;36.32 &nbsp; &nbsp; 0.58 &nbsp; &nbsp;0.21 &nbsp; 0.12 &nbsp;34.30</font></div><div><font size="2"   >dm-0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 12902.00 &nbsp; &nbsp; 0.00 103216.00 &nbsp; &nbsp; 8.00 &nbsp; &nbsp; 9.76 &nbsp; &nbsp;0.76 &nbsp; 0.03 &nbsp;34.40</font></div><div><font size="2"   >dm-1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 1926.00 &nbsp; &nbsp; 0.00 15408.00 &nbsp; &nbsp; 8.00 &nbsp; &nbsp;14.49 &nbsp; &nbsp;7.52 &nbsp; 0.01 &nbsp; 1.90</font></div><div><font size="2"   >dm-2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 12902.00 &nbsp; &nbsp; 0.00 103216.00 &nbsp; &nbsp; 8.00 &nbsp; &nbsp; 9.78 &nbsp; &nbsp;0.76 &nbsp; 0.03 &nbsp;34.50</font></div><p></p></pre></div><div style="line-height: 22px;"   >持续插入离散值(uuid)的测试结果如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; alter table test_text_pk drop constraint test_text_pk_pkey;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >digoal=&gt; alter table test_uuid_pk drop constraint test_uuid_pk_pkey;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >insert into test_text_pk (id) values (uuid_generate_v4());</font></div></div><div><font size="2"   >插入5000W数据 :&nbsp;</font></div><div><font size="2"   >pgbench -M prepared -n -j 8 -c 8 -t 6250000 -f ./pgbench.sql -U digoal digoal&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >新建PK约束 :&nbsp;</font></div><div><div><font size="2"   >\c digoal digoal</font></div><div><font size="2"   >insert into test_text_pk (id) values (uuid_generate_v4());</font></div><div><font size="2"   >set work_mem='4096MB';</font></div><div><font size="2"   >set maintenance_work_mem='4096MB';</font></div><div><font size="2"   >alter table test_text_pk add constraint test_text_pk_pkey primary key(id) using index tablespace tbs_digoal_idx;</font></div><div><font size="2"   >\c digoal postgres</font></div><div><font size="2"   >checkpoint;</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >测试 :&nbsp;</font></div><div><div><font size="2"   >pg9.2.0@db-172-16-3-150-&gt; pgbench -M prepared -n -j 8 -c 8 -T 60 -f ./pgbench.sql -U digoal digoal&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 212645</font></div><div><font size="2"   >tps = 3528.551941 (including connections establishing)</font></div><div><font size="2"   >tps = 3529.030665 (excluding connections establishing)</font></div></div><div><font size="2"   >TOP数据 : </font></div><div><div><font size="2"   >Tasks: 249 total, &nbsp; 2 running, 247 sleeping, &nbsp; 0 stopped, &nbsp; 0 zombie</font></div><div><font size="2"   >Cpu(s): &nbsp;3.7%us, &nbsp;4.0%sy, &nbsp;0.0%ni, 78.3%id, 13.8%wa, &nbsp;0.0%hi, &nbsp;0.3%si, &nbsp;0.0%st</font></div><div><font size="2"   >Mem: &nbsp;98992440k total, 92512088k used, &nbsp;6480352k free, &nbsp; 760656k buffers</font></div><div><font size="2"   >Swap: &nbsp;8385920k total, &nbsp; &nbsp; &nbsp; 60k used, &nbsp;8385860k free, 88177048k cached</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;RES &nbsp;SHR S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >10378 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 320m 318m S &nbsp;6.5 &nbsp;0.3 &nbsp; 0:04.43 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >10374 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 324m 322m S &nbsp;5.9 &nbsp;0.3 &nbsp; 0:04.54 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >10375 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 321m 319m D &nbsp;5.9 &nbsp;0.3 &nbsp; 0:04.42 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >10376 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 320m 318m S &nbsp;5.9 &nbsp;0.3 &nbsp; 0:04.46 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >10377 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 325m 323m S &nbsp;5.9 &nbsp;0.3 &nbsp; 0:04.50 postgres: digoal digoal [local] INSERT waiting &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >10380 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 324m 322m S &nbsp;5.9 &nbsp;0.3 &nbsp; 0:04.49 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >10379 pg9.2.0 &nbsp; 16 &nbsp; 0 1184m 328m 326m S &nbsp;5.2 &nbsp;0.3 &nbsp; 0:04.58 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >10381 pg9.2.0 &nbsp; 15 &nbsp; 0 1184m 317m 315m S &nbsp;4.6 &nbsp;0.3 &nbsp; 0:04.37 postgres: digoal digoal [local] INSERT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >10365 pg9.2.0 &nbsp; 15 &nbsp; 0 &nbsp;256m 2088 1520 S &nbsp;3.9 &nbsp;0.0 &nbsp; 0:03.61 pgbench -M prepared -n -j 8 -c 8 -T 60 -f ./pgbench.sql -U digoal digoa</font></div></div><div><span style="font-size: small; line-height: 19px;"   >IOSTAT 数据 : </span></div><div><div><font size="2"   >avg-cpu: &nbsp;%user &nbsp; %nice %system %iowait &nbsp;%steal &nbsp; %idle</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3.13 &nbsp; &nbsp;0.00 &nbsp; &nbsp;4.63 &nbsp; 19.90 &nbsp; &nbsp;0.00 &nbsp; 72.34</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Device: &nbsp; &nbsp; &nbsp; &nbsp; rrqm/s &nbsp; wrqm/s &nbsp; r/s &nbsp; w/s &nbsp; rsec/s &nbsp; wsec/s avgrq-sz avgqu-sz &nbsp; await &nbsp;svctm &nbsp;%util</font></div><div><font size="2"   >sda &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 &nbsp;1113.86 &nbsp;0.00 597.03 &nbsp; &nbsp; 0.00 17964.36 &nbsp; &nbsp;30.09 &nbsp; 144.10 &nbsp;236.67 &nbsp; 1.66 &nbsp;99.01</font></div><div><font size="2"   >sda1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div><font size="2"   >sda2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div><font size="2"   >sda3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp;1113.86 &nbsp;0.00 597.03 &nbsp; &nbsp; 0.00 17964.36 &nbsp; &nbsp;30.09 &nbsp; 144.10 &nbsp;236.67 &nbsp; 1.66 &nbsp;99.01</font></div><div><font size="2"   >sdb &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 &nbsp;7987.13 &nbsp;0.00 82.18 &nbsp; &nbsp; 0.00 38114.85 &nbsp; 463.81 &nbsp; &nbsp;35.87 &nbsp;280.34 &nbsp;10.96 &nbsp;90.10</font></div><div><font size="2"   >dm-0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 8123.76 &nbsp; &nbsp; 0.00 64990.10 &nbsp; &nbsp; 8.00 &nbsp;2162.83 &nbsp;166.67 &nbsp; 0.11 &nbsp;90.10</font></div><div><font size="2"   >dm-1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 1700.99 &nbsp; &nbsp; 0.00 13607.92 &nbsp; &nbsp; 8.00 &nbsp; 711.46 &nbsp;415.44 &nbsp; 0.58 &nbsp;99.01</font></div><div><font size="2"   >dm-2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 8123.76 &nbsp; &nbsp; 0.00 64990.10 &nbsp; &nbsp; 8.00 &nbsp;2162.84 &nbsp;166.67 &nbsp; 0.11 &nbsp;90.10</font></div></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >3. 测试没有索引的情况.</span></div><div style="line-height: 22px;"   >在没有索引的情况下, uuid, text, int8的插入速度都很快, 关键是IO等待都在0点几左右. IO不再是问题. 这更加印证了连续插入离散值会带来索引的大量IO开销的事实.</div></div><div style="line-height: 22px;"   ><br></div><div>【小结】</div><div><div style="line-height: 22px;"   >1. 在做主键的类型选择时, 尽量不要使用UUID类型的字段, 如果要使用, 请使用有序生成的UUID, 不要使用无序生成的UUID.</div></div><div>2. 使用离散uuid值和text类型作为主键的IO等待大概是6%, int8作为主键IO等待大概是0.25% , 从这里看使用离散uuid作为主键值带来的IO开销是使用序列插入int8类型字段带来IO开销的24倍. 当表里面的数据越多,&nbsp;<span style="line-height: 22px;"   >使用离散uuid作为主键值带来的IO开销会越来越大, 与INT8的性能相差就更加大了. 几百倍都有可能.</span></div><div>3. checkpoint时, UUID索引所在的硬盘有大量的IO操作, 持续时间较长. 而表数据文件所在的硬盘IO操作很快完成.</div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">284466130 - 2013-01-09 10:59:45</h5>
				<div>德哥的博文一直都是无比有用 刚一群问到一问题 我直接到文章发给他 他就了然了<br><br></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 284466130 - 2013-01-09 10:59:45</h5>
				<div style="width:600px;">能帮兄弟们解决问题,非常高兴.</div>
			</div>
	</div>
</div>
</body>
</html>