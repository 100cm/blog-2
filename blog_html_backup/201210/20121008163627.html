<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 add LATERAL support</h2>
	<h5 id="">2012-10-08 16:36:27&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012984936451/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>LATERAL是SQL:2011的标准(T491 : LATERAL derived table), 在FROM 或者JOIN子句的子查询里面可以关联查询FROM子句或者JOIN子句的另一边的子句或者表.</div><div>例如手册上提到的 :&nbsp;</div><div>SELECT * FROM foo, LATERAL (SELECT * FROM bar WHERE bar.id = foo.bar_id) ss;</div><div>以下将进行简单的测试 :&nbsp;</div><div>首先从github上下载PostgreSQL 9.3 源码,&nbsp;</div><div>wget&nbsp;<a style="line-height: 22px; " rel="nofollow" href="https://github.com/postgres/postgres/downloads"  >https://github.com/postgres/postgres/downloads</a></div><div>安装简单步骤 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >useradd pgdev</font></div><div><font size="2"  >su - pgdev</font></div><div><font size="2"  >vi .bash_profile</font></div><div><font size="2"  ># add by digoal</font></div><div><div><font size="2"  >export PS1="$USER@`/bin/hostname -s`-&gt; "</font></div><div><font size="2"  >export PGPORT=9300</font></div><div><font size="2"  >export PGUSER=postgres</font></div><div><font size="2"  >export PGDATA=/data04/pgdev/pg_root</font></div><div><font size="2"  >export LANG=en_US.utf8</font></div><div><font size="2"  >export PGHOME=/home/pgdev/pgsql9.3</font></div><div><font size="2"  >export PGHOST=$PGDATA</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</font></div><div><font size="2"  >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"  >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"  >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"  >alias rm='rm -i'</font></div><div><font size="2"  >alias ll='ls -lh'</font></div></div><div><font size="2"  >su - root</font></div><div><font size="2"  >mkdir -p&nbsp;<span style="line-height: 22px;"  >/data04/pgdev/pg_root</span></font></div><div><span style="line-height: 22px;"  ><font size="2"  >chown -R pgdev:pgdev /data04/pgdev</font></span></div><div><span style="line-height: 22px;"  ><font size="2"  >. /home/pgdev/.bash_profile</font></span></div><div><font size="2"  >cd /home/pgdev</font></div><div><font size="2"  >unzip pg9.3.zip</font></div><div><font size="2"  >cd&nbsp;postgres-postgres-95d035e</font></div><div><font size="2"  >./configure --prefix=/home/pgdev/pgsql9.3 --with-pgport=9300 --with-perl --with-python --with-tcl --with-openssl --with-pam--without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=16 &amp;&amp; gmake</font></div><div><font size="2"  >gmake install</font></div><div><font size="2"  >su - pgdev</font></div><div><font size="2"  >initdb -D $PGDATA -E UTF8 --locale=C -U postgres -W</font></div><p></p></pre></div><div>启动数据库</div><div><pre class="prettyprint"  ><p><font size="2"  >pg_ctl start</font></p></pre></div><div>测试表 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >CREATE TABLE test (</font></div><div><font size="2"  >&nbsp; &nbsp; username TEXT,</font></div><div><font size="2"  >&nbsp; &nbsp; some_ts timestamptz,</font></div><div><font size="2"  >&nbsp; &nbsp; random_value INT4</font></div><div><font size="2"  >);</font></div><p></p></pre></div><div>-- 测试数据 : &nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >INSERT INTO test (username, some_ts, random_value)</font></div><div><font size="2"  >SELECT</font></div><div><font size="2"  >&nbsp; &nbsp; 'user #' || cast(floor(random() * 10) as int4),</font></div><div><font size="2"  >&nbsp; &nbsp; now() - '1 year'::INTERVAL * random(),</font></div><div><font size="2"  >&nbsp; &nbsp; cast(random() * 100000000 as INT4)</font></div><div><font size="2"  >FROM</font></div><div><font size="2"  >&nbsp; &nbsp; generate_series(1,2000000);</font></div><p></p></pre></div><div>-- 索引 : &nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >CREATE INDEX i on test (username, some_ts);</font></p></pre></div><div>-- 分析表 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >analyze test;</font></p></pre></div><div><br></div><div>-- 使用递归查询模拟index skip scan, 提高查询速度.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >WITH RECURSIVE skip AS (</font></div><div><font size="2"  >&nbsp; &nbsp; ( SELECT t.username FROM test as t ORDER BY t.username limit 1 )</font></div><div><font size="2"  >&nbsp; &nbsp; union all</font></div><div><font size="2"  >&nbsp; &nbsp; ( SELECT (SELECT min( t2.username ) FROM test t2 WHERE t2.username &gt; s.username ) FROM skip s WHERE s.username IS NOT NULL )</font></div><div><font size="2"  >)</font></div><div><font size="2"  >SELECT</font></div><div><font size="2"  >&nbsp; &nbsp; x.*</font></div><div><font size="2"  >FROM</font></div><div><font size="2"  >&nbsp; &nbsp; skip s,</font></div><div><font size="2"  >&nbsp; &nbsp; lateral (</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; SELECT t.*</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; FROM test t</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; WHERE t.username = s.username</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; ORDER BY t.some_ts desc LIMIT 5</font></div><div><font size="2"  >&nbsp; &nbsp; ) as x;</font></div><p></p></pre></div><div>-- 执行计划</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp;Nested Loop &nbsp;(cost=92.44..588.61 rows=505 width=20) (actual time=0.080..0.730 rows=50 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp;CTE skip</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;-&gt; &nbsp;Recursive Union &nbsp;(cost=0.00..92.44 rows=101 width=32) (actual time=0.037..0.327 rows=11 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Limit &nbsp;(cost=0.00..0.83 rows=1 width=8) (actual time=0.034..0.034 rows=1 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Only Scan using i1 on test t_1 &nbsp;(cost=0.00..1667358.25 rows=2000000 width=8) (actual time=0.033..0.033 ro</font></div><div><font size="2"  >ws=1 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Heap Fetches: 1</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;WorkTable Scan on skip s_1 &nbsp;(cost=0.00..8.96 rows=10 width=32) (actual time=0.025..0.025 rows=1 loops=11)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (username IS NOT NULL)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Rows Removed by Filter: 0</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SubPlan 2</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Result &nbsp;(cost=0.87..0.88 rows=1 width=0) (actual time=0.026..0.026 rows=1 loops=10)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;InitPlan 1 (returns $2)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Limit &nbsp;(cost=0.00..0.87 rows=1 width=8) (actual time=0.025..0.025 rows=1 loops=10)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Only Scan using i1 on test t2 &nbsp;(cost=0.00..577241.50 rows=666667 width=8) (actual time=0.</font></div><div><font size="2"  >024..0.024 rows=1 loops=10)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: ((username IS NOT NULL) AND (username &gt; s_1.username))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Heap Fetches: 9</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;CTE Scan on skip s &nbsp;(cost=0.00..2.02 rows=101 width=32) (actual time=0.040..0.337 rows=11 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Limit &nbsp;(cost=0.00..4.79 rows=5 width=20) (actual time=0.024..0.033 rows=5 loops=11)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan Backward using i1 on test t &nbsp;(cost=0.00..191701.23 rows=200000 width=20) (actual time=0.024..0.031 rows=5 lo</font></div><div><font size="2"  >ops=11)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (username = s.username)</font></div><div><font size="2"  >&nbsp;Total runtime: 0.814 ms</font></div><p></p></pre></div><div>-- 执行结果</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp;username | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;some_ts &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| random_value&nbsp;</font></div><div><font size="2"  >----------+-------------------------------+--------------</font></div><div><font size="2"  >&nbsp;user #0 &nbsp;| 2012-10-08 15:48:45.553316+08 | &nbsp; &nbsp; 88033114</font></div><div><font size="2"  >&nbsp;user #0 &nbsp;| 2012-10-08 15:47:47.751716+08 | &nbsp; &nbsp; &nbsp;1162776</font></div><div><font size="2"  >&nbsp;user #0 &nbsp;| 2012-10-08 15:46:32.842916+08 | &nbsp; &nbsp; &nbsp;5801749</font></div><div><font size="2"  >&nbsp;user #0 &nbsp;| 2012-10-08 15:44:55.642916+08 | &nbsp; &nbsp; 94951593</font></div><div><font size="2"  >&nbsp;user #0 &nbsp;| 2012-10-08 15:42:52.522916+08 | &nbsp; &nbsp; 24722119</font></div><div><font size="2"  >&nbsp;user #1 &nbsp;| 2012-10-08 15:44:48.471716+08 | &nbsp; &nbsp; 60946458</font></div><div><font size="2"  >&nbsp;user #1 &nbsp;| 2012-10-08 15:35:37.153316+08 | &nbsp; &nbsp; 12236441</font></div><div><font size="2"  >&nbsp;user #1 &nbsp;| 2012-10-08 15:33:01.460516+08 | &nbsp; &nbsp; 34209317</font></div><div><font size="2"  >&nbsp;user #1 &nbsp;| 2012-10-08 15:32:36.231716+08 | &nbsp; &nbsp; 91423982</font></div><div><font size="2"  >&nbsp;user #1 &nbsp;| 2012-10-08 15:31:57.351716+08 | &nbsp; &nbsp; 46008329</font></div><div><font size="2"  >&nbsp;user #2 &nbsp;| 2012-10-08 15:48:21.188516+08 | &nbsp; &nbsp; 18521498</font></div><div><font size="2"  >&nbsp;user #2 &nbsp;| 2012-10-08 15:48:07.710116+08 | &nbsp; &nbsp; 30330399</font></div><div><font size="2"  >&nbsp;user #2 &nbsp;| 2012-10-08 15:44:47.175716+08 | &nbsp; &nbsp; 20635202</font></div><div><font size="2"  >&nbsp;user #2 &nbsp;| 2012-10-08 15:42:47.166116+08 | &nbsp; &nbsp; 24079275</font></div><div><font size="2"  >&nbsp;user #2 &nbsp;| 2012-10-08 15:41:37.095716+08 | &nbsp; &nbsp; &nbsp;4902864</font></div><div><font size="2"  >&nbsp;user #3 &nbsp;| 2012-10-08 15:42:26.084516+08 | &nbsp; &nbsp; 52659326</font></div><div><font size="2"  >&nbsp;user #3 &nbsp;| 2012-10-08 15:41:35.194916+08 | &nbsp; &nbsp; 69423103</font></div><div><font size="2"  >&nbsp;user #3 &nbsp;| 2012-10-08 15:38:00.145316+08 | &nbsp; &nbsp; 84811251</font></div><div><font size="2"  >&nbsp;user #3 &nbsp;| 2012-10-08 15:35:06.308516+08 | &nbsp; &nbsp; 75104712</font></div><div><font size="2"  >&nbsp;user #3 &nbsp;| 2012-10-08 15:34:55.594916+08 | &nbsp; &nbsp; 73931958</font></div><div><font size="2"  >&nbsp;user #4 &nbsp;| 2012-10-08 15:49:11.732516+08 | &nbsp; &nbsp; 78025638</font></div><div><font size="2"  >&nbsp;user #4 &nbsp;| 2012-10-08 15:47:19.412516+08 | &nbsp; &nbsp; &nbsp;9725755</font></div><div><font size="2"  >&nbsp;user #4 &nbsp;| 2012-10-08 15:45:07.134116+08 | &nbsp; &nbsp; 41955915</font></div><div><font size="2"  >&nbsp;user #4 &nbsp;| 2012-10-08 15:43:32.612516+08 | &nbsp; &nbsp; &nbsp;8423193</font></div><div><font size="2"  >&nbsp;user #4 &nbsp;| 2012-10-08 15:42:14.161316+08 | &nbsp; &nbsp; 76958806</font></div><div><font size="2"  >&nbsp;user #5 &nbsp;| 2012-10-08 15:46:15.649316+08 | &nbsp; &nbsp; 11810519</font></div><div><font size="2"  >&nbsp;user #5 &nbsp;| 2012-10-08 15:43:08.334116+08 | &nbsp; &nbsp; 58534489</font></div><div><font size="2"  >&nbsp;user #5 &nbsp;| 2012-10-08 15:39:19.892516+08 | &nbsp; &nbsp; &nbsp;8442981</font></div><div><font size="2"  >&nbsp;user #5 &nbsp;| 2012-10-08 15:37:09.860516+08 | &nbsp; &nbsp; 70260530</font></div><div><font size="2"  >&nbsp;user #5 &nbsp;| 2012-10-08 15:36:11.626916+08 | &nbsp; &nbsp; 31693867</font></div><div><font size="2"  >&nbsp;user #6 &nbsp;| 2012-10-08 15:35:00.865316+08 | &nbsp; &nbsp; 73969641</font></div><div><font size="2"  >&nbsp;user #6 &nbsp;| 2012-10-08 15:32:59.818916+08 | &nbsp; &nbsp; 93242875</font></div><div><font size="2"  >&nbsp;user #6 &nbsp;| 2012-10-08 15:31:04.474916+08 | &nbsp; &nbsp; 19057377</font></div><div><font size="2"  >&nbsp;user #6 &nbsp;| 2012-10-08 15:28:27.572516+08 | &nbsp; &nbsp; 32746489</font></div><div><font size="2"  >&nbsp;user #6 &nbsp;| 2012-10-08 15:28:15.562916+08 | &nbsp; &nbsp; 53467567</font></div><div><font size="2"  >&nbsp;user #7 &nbsp;| 2012-10-08 15:45:52.753316+08 | &nbsp; &nbsp; 87485440</font></div><div><font size="2"  >&nbsp;user #7 &nbsp;| 2012-10-08 15:44:07.172516+08 | &nbsp; &nbsp; 79248597</font></div><div><font size="2"  >&nbsp;user #7 &nbsp;| 2012-10-08 15:37:00.961316+08 | &nbsp; &nbsp; 42857958</font></div><div><font size="2"  >&nbsp;user #7 &nbsp;| 2012-10-08 15:31:24.519716+08 | &nbsp; &nbsp; 95801165</font></div><div><font size="2"  >&nbsp;user #7 &nbsp;| 2012-10-08 15:24:51.572516+08 | &nbsp; &nbsp; 68538811</font></div><div><font size="2"  >&nbsp;user #8 &nbsp;| 2012-10-08 15:47:58.810916+08 | &nbsp; &nbsp; 72727414</font></div><div><font size="2"  >&nbsp;user #8 &nbsp;| 2012-10-08 15:46:36.903716+08 | &nbsp; &nbsp; 31336421</font></div><div><font size="2"  >&nbsp;user #8 &nbsp;| 2012-10-08 15:46:19.364516+08 | &nbsp; &nbsp; 41223414</font></div><div><font size="2"  >&nbsp;user #8 &nbsp;| 2012-10-08 15:41:28.974116+08 | &nbsp; &nbsp; 65943069</font></div><div><font size="2"  >&nbsp;user #8 &nbsp;| 2012-10-08 15:41:17.223716+08 | &nbsp; &nbsp; 50431652</font></div><div><font size="2"  >&nbsp;user #9 &nbsp;| 2012-10-08 15:49:09.658916+08 | &nbsp; &nbsp; 32979344</font></div><div><font size="2"  >&nbsp;user #9 &nbsp;| 2012-10-08 15:47:22.350116+08 | &nbsp; &nbsp; 78366412</font></div><div><font size="2"  >&nbsp;user #9 &nbsp;| 2012-10-08 15:45:29.511716+08 | &nbsp; &nbsp; 12629410</font></div><div><font size="2"  >&nbsp;user #9 &nbsp;| 2012-10-08 15:43:49.201316+08 | &nbsp; &nbsp; 97705953</font></div><div><font size="2"  >&nbsp;user #9 &nbsp;| 2012-10-08 15:40:07.930916+08 | &nbsp; &nbsp; 30183886</font></div><p></p></pre></div><div><br></div><div>-- 未使用递归查询的话, 不管是seqscan还是indexonlyscan耗时都非常庞大.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >select x.* from ( select t.username</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; from test t</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;group by t.username order by username ) as t1,</font></div><div><font size="2"  ><span> </span> LATERAL(</font></div><div><font size="2"  ><span> </span> select t.* from test t where</font></div><div><font size="2"  ><span> </span> t.username=t1.username order by t.some_ts desc limit 5</font></div><div><font size="2"  ><span> </span> ) as x;</font></div><p></p></pre></div></div><div><div style="line-height: 22px;"  >-- 执行计划</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp;Nested Loop &nbsp;(cost=0.00..1672407.28 rows=50 width=20) (actual time=0.078..2446.767 rows=50 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Group &nbsp;(cost=0.00..1672358.25 rows=10 width=8) (actual time=0.037..2446.275 rows=10 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Only Scan using i1 on test t &nbsp;(cost=0.00..1667358.25 rows=2000000 width=8) (actual time=0.033..2080.098 rows=2000</font></div><div><font size="2"  >000 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Heap Fetches: 2000000</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Limit &nbsp;(cost=0.00..4.79 rows=5 width=20) (actual time=0.035..0.041 rows=5 loops=10)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan Backward using i1 on test t_1 &nbsp;(cost=0.00..191701.23 rows=200000 width=20) (actual time=0.030..0.035 rows=5&nbsp;</font></div><div><font size="2"  >loops=10)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (username = t.username)</font></div><div><font size="2"  >&nbsp;Total runtime: 2446.833 ms</font></div><p></p></pre></div><div style="line-height: 22px;"  >-- 执行结果</div></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp;username | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;some_ts &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| random_value&nbsp;</font></div><div><font size="2"  >----------+-------------------------------+--------------</font></div><div><font size="2"  >&nbsp;user #0 &nbsp;| 2012-10-08 15:48:45.553316+08 | &nbsp; &nbsp; 88033114</font></div><div><font size="2"  >&nbsp;user #0 &nbsp;| 2012-10-08 15:47:47.751716+08 | &nbsp; &nbsp; &nbsp;1162776</font></div><div><font size="2"  >&nbsp;user #0 &nbsp;| 2012-10-08 15:46:32.842916+08 | &nbsp; &nbsp; &nbsp;5801749</font></div><div><font size="2"  >&nbsp;user #0 &nbsp;| 2012-10-08 15:44:55.642916+08 | &nbsp; &nbsp; 94951593</font></div><div><font size="2"  >&nbsp;user #0 &nbsp;| 2012-10-08 15:42:52.522916+08 | &nbsp; &nbsp; 24722119</font></div><div><font size="2"  >&nbsp;user #1 &nbsp;| 2012-10-08 15:44:48.471716+08 | &nbsp; &nbsp; 60946458</font></div><div><font size="2"  >&nbsp;user #1 &nbsp;| 2012-10-08 15:35:37.153316+08 | &nbsp; &nbsp; 12236441</font></div><div><font size="2"  >&nbsp;user #1 &nbsp;| 2012-10-08 15:33:01.460516+08 | &nbsp; &nbsp; 34209317</font></div><div><font size="2"  >&nbsp;user #1 &nbsp;| 2012-10-08 15:32:36.231716+08 | &nbsp; &nbsp; 91423982</font></div><div><font size="2"  >&nbsp;user #1 &nbsp;| 2012-10-08 15:31:57.351716+08 | &nbsp; &nbsp; 46008329</font></div><div><font size="2"  >&nbsp;user #2 &nbsp;| 2012-10-08 15:48:21.188516+08 | &nbsp; &nbsp; 18521498</font></div><div><font size="2"  >&nbsp;user #2 &nbsp;| 2012-10-08 15:48:07.710116+08 | &nbsp; &nbsp; 30330399</font></div><div><font size="2"  >&nbsp;user #2 &nbsp;| 2012-10-08 15:44:47.175716+08 | &nbsp; &nbsp; 20635202</font></div><div><font size="2"  >&nbsp;user #2 &nbsp;| 2012-10-08 15:42:47.166116+08 | &nbsp; &nbsp; 24079275</font></div><div><font size="2"  >&nbsp;user #2 &nbsp;| 2012-10-08 15:41:37.095716+08 | &nbsp; &nbsp; &nbsp;4902864</font></div><div><font size="2"  >&nbsp;user #3 &nbsp;| 2012-10-08 15:42:26.084516+08 | &nbsp; &nbsp; 52659326</font></div><div><font size="2"  >&nbsp;user #3 &nbsp;| 2012-10-08 15:41:35.194916+08 | &nbsp; &nbsp; 69423103</font></div><div><font size="2"  >&nbsp;user #3 &nbsp;| 2012-10-08 15:38:00.145316+08 | &nbsp; &nbsp; 84811251</font></div><div><font size="2"  >&nbsp;user #3 &nbsp;| 2012-10-08 15:35:06.308516+08 | &nbsp; &nbsp; 75104712</font></div><div><font size="2"  >&nbsp;user #3 &nbsp;| 2012-10-08 15:34:55.594916+08 | &nbsp; &nbsp; 73931958</font></div><div><font size="2"  >&nbsp;user #4 &nbsp;| 2012-10-08 15:49:11.732516+08 | &nbsp; &nbsp; 78025638</font></div><div><font size="2"  >&nbsp;user #4 &nbsp;| 2012-10-08 15:47:19.412516+08 | &nbsp; &nbsp; &nbsp;9725755</font></div><div><font size="2"  >&nbsp;user #4 &nbsp;| 2012-10-08 15:45:07.134116+08 | &nbsp; &nbsp; 41955915</font></div><div><font size="2"  >&nbsp;user #4 &nbsp;| 2012-10-08 15:43:32.612516+08 | &nbsp; &nbsp; &nbsp;8423193</font></div><div><font size="2"  >&nbsp;user #4 &nbsp;| 2012-10-08 15:42:14.161316+08 | &nbsp; &nbsp; 76958806</font></div><div><font size="2"  >&nbsp;user #5 &nbsp;| 2012-10-08 15:46:15.649316+08 | &nbsp; &nbsp; 11810519</font></div><div><font size="2"  >&nbsp;user #5 &nbsp;| 2012-10-08 15:43:08.334116+08 | &nbsp; &nbsp; 58534489</font></div><div><font size="2"  >&nbsp;user #5 &nbsp;| 2012-10-08 15:39:19.892516+08 | &nbsp; &nbsp; &nbsp;8442981</font></div><div><font size="2"  >&nbsp;user #5 &nbsp;| 2012-10-08 15:37:09.860516+08 | &nbsp; &nbsp; 70260530</font></div><div><font size="2"  >&nbsp;user #5 &nbsp;| 2012-10-08 15:36:11.626916+08 | &nbsp; &nbsp; 31693867</font></div><div><font size="2"  >&nbsp;user #6 &nbsp;| 2012-10-08 15:35:00.865316+08 | &nbsp; &nbsp; 73969641</font></div><div><font size="2"  >&nbsp;user #6 &nbsp;| 2012-10-08 15:32:59.818916+08 | &nbsp; &nbsp; 93242875</font></div><div><font size="2"  >&nbsp;user #6 &nbsp;| 2012-10-08 15:31:04.474916+08 | &nbsp; &nbsp; 19057377</font></div><div><font size="2"  >&nbsp;user #6 &nbsp;| 2012-10-08 15:28:27.572516+08 | &nbsp; &nbsp; 32746489</font></div><div><font size="2"  >&nbsp;user #6 &nbsp;| 2012-10-08 15:28:15.562916+08 | &nbsp; &nbsp; 53467567</font></div><div><font size="2"  >&nbsp;user #7 &nbsp;| 2012-10-08 15:45:52.753316+08 | &nbsp; &nbsp; 87485440</font></div><div><font size="2"  >&nbsp;user #7 &nbsp;| 2012-10-08 15:44:07.172516+08 | &nbsp; &nbsp; 79248597</font></div><div><font size="2"  >&nbsp;user #7 &nbsp;| 2012-10-08 15:37:00.961316+08 | &nbsp; &nbsp; 42857958</font></div><div><font size="2"  >&nbsp;user #7 &nbsp;| 2012-10-08 15:31:24.519716+08 | &nbsp; &nbsp; 95801165</font></div><div><font size="2"  >&nbsp;user #7 &nbsp;| 2012-10-08 15:24:51.572516+08 | &nbsp; &nbsp; 68538811</font></div><div><font size="2"  >&nbsp;user #8 &nbsp;| 2012-10-08 15:47:58.810916+08 | &nbsp; &nbsp; 72727414</font></div><div><font size="2"  >&nbsp;user #8 &nbsp;| 2012-10-08 15:46:36.903716+08 | &nbsp; &nbsp; 31336421</font></div><div><font size="2"  >&nbsp;user #8 &nbsp;| 2012-10-08 15:46:19.364516+08 | &nbsp; &nbsp; 41223414</font></div><div><font size="2"  >&nbsp;user #8 &nbsp;| 2012-10-08 15:41:28.974116+08 | &nbsp; &nbsp; 65943069</font></div><div><font size="2"  >&nbsp;user #8 &nbsp;| 2012-10-08 15:41:17.223716+08 | &nbsp; &nbsp; 50431652</font></div><div><font size="2"  >&nbsp;user #9 &nbsp;| 2012-10-08 15:49:09.658916+08 | &nbsp; &nbsp; 32979344</font></div><div><font size="2"  >&nbsp;user #9 &nbsp;| 2012-10-08 15:47:22.350116+08 | &nbsp; &nbsp; 78366412</font></div><div><font size="2"  >&nbsp;user #9 &nbsp;| 2012-10-08 15:45:29.511716+08 | &nbsp; &nbsp; 12629410</font></div><div><font size="2"  >&nbsp;user #9 &nbsp;| 2012-10-08 15:43:49.201316+08 | &nbsp; &nbsp; 97705953</font></div><div><font size="2"  >&nbsp;user #9 &nbsp;| 2012-10-08 15:40:07.930916+08 | &nbsp; &nbsp; 30183886</font></div><p></p></pre></div><div><br></div><div>【参考】</div><div><div>1. performance tuning case :use cursor or trigger replace group by and order by</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020128142829610/"  >http://blog.163.com/digoal@126/blog/static/16387704020128142829610/</a></div><div>2. table or row variable :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012989219190/"  >http://blog.163.com/digoal@126/blog/static/1638770402012989219190/</a></div></div><div>3.&nbsp;<a rel="nofollow" href="http://www.depesz.com/2012/10/05/getting-top-n-rows-per-group/"  >http://www.depesz.com/2012/10/05/getting-top-n-rows-per-group/</a></div><div>4.&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/devel/static/queries-table-expressions.html"  >http://www.postgresql.org/docs/devel/static/queries-table-expressions.html</a></div><div>5.&nbsp;<a rel="nofollow" href="https://github.com/postgres/postgres/downloads"  >https://github.com/postgres/postgres/downloads</a></div><div><div style="line-height: 22px;"  >6. 带有LATERAL的SQL的执行步骤 :&nbsp;</div><div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >6.1. for each row of the FROM item providing the cross-referenced column(s), or set of rows of multiple FROM items providing the columns,&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  ><span style="line-height: 22px;"  >6.</span>2. the LATERAL item is evaluated using that row or row set's values of the columns.&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  ><span style="line-height: 22px;"  >6.</span>3. The resulting row(s) are joined as usual with the rows they were computed from.&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  ><span style="line-height: 22px;"  >6.</span>4. This is repeated for each row or set of rows from the column source table(s).</font></div><p></p></pre></div><div style="line-height: 22px;"  >7.&nbsp;<a style="line-height: 22px; " rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=5ebaaa49445eb1ba7b299bbea3a477d4e4c0430b"  >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=5ebaaa49445eb1ba7b299bbea3a477d4e4c0430b</a></div><div style="line-height: 22px;"  >8. SRC :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >doc/src/sgml/keywords.sgml</font></div><div><font size="2"  >doc/src/sgml/queries.sgml</font></div><div><font size="2"  >doc/src/sgml/ref/select.sgml</font></div><div><font size="2"  >doc/src/sgml/xfunc.sgml</font></div><div><font size="2"  >src/backend/catalog/information_schema.sql</font></div><div><font size="2"  >src/backend/catalog/sql_features.txt</font></div><div><font size="2"  >src/backend/nodes/outfuncs.c</font></div><div><font size="2"  >src/backend/optimizer/path/allpaths.c</font></div><div><font size="2"  >src/backend/optimizer/path/costsize.c</font></div><div><font size="2"  >src/backend/optimizer/path/indxpath.c</font></div><div><font size="2"  >src/backend/optimizer/path/joinpath.c</font></div><div><font size="2"  >src/backend/optimizer/path/joinrels.c</font></div><div><font size="2"  >src/backend/optimizer/path/tidpath.c</font></div><div><font size="2"  >src/backend/optimizer/plan/analyzejoins.c</font></div><div><font size="2"  >src/backend/optimizer/plan/createplan.c</font></div><div><font size="2"  >src/backend/optimizer/plan/initsplan.c</font></div><div><font size="2"  >src/backend/optimizer/plan/planagg.c</font></div><div><font size="2"  >src/backend/optimizer/plan/planner.c</font></div><div><font size="2"  >src/backend/optimizer/prep/prepjointree.c</font></div><div><font size="2"  >src/backend/optimizer/README</font></div><div><font size="2"  >src/backend/optimizer/util/placeholder.c</font></div><div><font size="2"  >src/backend/optimizer/util/var.c</font></div><div><font size="2"  >src/backend/parser/analyze.c</font></div><div><font size="2"  >src/backend/parser/gram.c</font></div><div><font size="2"  >src/backend/parser/gram.h</font></div><div><font size="2"  >src/backend/parser/gram.y</font></div><div><font size="2"  >src/backend/parser/parse_agg.c</font></div><div><font size="2"  >src/backend/parser/parse_clause.c</font></div><div><font size="2"  >src/backend/parser/parse_relation.c</font></div><div><font size="2"  >src/backend/utils/adt/ruleutils.c</font></div><div><font size="2"  >src/bin/psql/sql_help.c</font></div><div><font size="2"  >src/include/nodes/parsenodes.h</font></div><div><font size="2"  >src/include/nodes/relation.h</font></div><div><font size="2"  >src/include/parser/gram.h</font></div><div><font size="2"  >src/include/parser/kwlist.h</font></div><div><font size="2"  >src/include/parser/parse_node.h</font></div><div><font size="2"  >src/interfaces/ecpg/preproc/ecpg.addons</font></div><div><font size="2"  >src/interfaces/ecpg/preproc/preproc.c</font></div><div><font size="2"  >src/interfaces/ecpg/preproc/preproc.h</font></div><div><font size="2"  >src/interfaces/ecpg/preproc/preproc.y</font></div><div><font size="2"  >src/test/regress/expected/join.out</font></div><div><font size="2"  >src/test/regress/sql/join.sql</font></div><p></p></pre></div></div></div></div>
	</div>
</div>
</body>
</html>