<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">table or row variable</h2>
	<h5 id="">2012-10-08 9:55:57&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012989219190/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div><div>某些场景中可能会用到行类型或者表类型变量. 例如构造行类型的数组.&nbsp;</div><div>以下是简单的展示 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >$psql</font></div><div><font size="2"  >psql (9.2beta4)</font></div><div><font size="2"  >Type "help" for help.</font></div><p></p></pre></div></div><div>-- 创建测试表</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create table user_info (id int, firstname text, lastname text, crt_time timestamp(0));</font></div><div><font size="2"  >CREATE TABLE</font></div><p></p></pre></div></div><div>-- 插入测试数据</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; insert into user_info select generate_series(1,10000), 'zhou', 'digoal', now();</font></div><div><font size="2"  >INSERT 0 10000</font></div><p></p></pre></div><div>-- 返回行变量, t在这里是user_info 的alias.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select t from user_info t limit 2;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >---------------------------------------</font></div><div><font size="2"  >&nbsp;(1,zhou,digoal,"2012-10-08 09:36:07")</font></div><div><font size="2"  >&nbsp;(2,zhou,digoal,"2012-10-08 09:36:07")</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div></div><div>-- 而非系统中存在的表名对应的type. 此处报错</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select user_info from user_info t limit 2;</font></div><div><font size="2"  >ERROR: &nbsp;column "user_info" does not exist</font></div><div><font size="2"  >LINE 1: select user_info from user_info t limit 2;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div></div><p></p></pre></div><div>-- 这样写就对了, 所以它是在当前QUERY中的table 或 table alias.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select user_info from user_info limit 2;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;user_info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >---------------------------------------</font></div><div><font size="2"  >&nbsp;(1,zhou,digoal,"2012-10-08 09:36:07")</font></div><div><font size="2"  >&nbsp;(2,zhou,digoal,"2012-10-08 09:36:07")</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div></div><div>-- row variable可以使用row-variable.*来转成row对应的composite type的嵌套类型输出.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select user_info.* from user_info limit 2;</font></div><div><font size="2"  >&nbsp;id | firstname | lastname | &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----+-----------+----------+---------------------</font></div><div><font size="2"  >&nbsp; 1 | zhou &nbsp; &nbsp; &nbsp;| digoal &nbsp; | 2012-10-08 09:36:07</font></div><div><font size="2"  >&nbsp; 2 | zhou &nbsp; &nbsp; &nbsp;| digoal &nbsp; | 2012-10-08 09:36:07</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div>-- 这里同样正确.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select t.* from user_info t limit 2;</font></div><div><font size="2"  >&nbsp;id | firstname | lastname | &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----+-----------+----------+---------------------</font></div><div><font size="2"  >&nbsp; 1 | zhou &nbsp; &nbsp; &nbsp;| digoal &nbsp; | 2012-10-08 09:36:07</font></div><div><font size="2"  >&nbsp; 2 | zhou &nbsp; &nbsp; &nbsp;| digoal &nbsp; | 2012-10-08 09:36:07</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div>-- 下面是一个行构造方法实例</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select row(1,2,3);</font></div><div><font size="2"  >&nbsp; &nbsp;row &nbsp;&nbsp;</font></div><div><font size="2"  >---------</font></div><div><font size="2"  >&nbsp;(1,2,3)</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>-- 以下方法构造出来的行没有对应的record type, 所以使用(row-variable).*时会报错.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select (row(1,2,3)).*;</font></div><div><font size="2"  >ERROR: &nbsp;record type has not been registered</font></div><p></p></pre></div><div>-- 要如何将以上方法构造的row-variable转换成对应的record type呢? 手册里有实例, 我这里就不举例了:</div><div><pre class="prettyprint"  ><br></pre><pre class="prettyprint"  ><p></p><div><font size="2"  >CREATE TABLE mytable(f1 int, f2 float, f3 text);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >CREATE FUNCTION getf1(mytable) RETURNS int AS 'SELECT $1.f1' LANGUAGE SQL;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >-- No cast needed since only one getf1() exists</font></div><div><font size="2"  >SELECT getf1(ROW(1,2.5,'this is a test'));</font></div><div><font size="2"  >&nbsp;getf1</font></div><div><font size="2"  >-------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >CREATE TYPE myrowtype AS (f1 int, f2 text, f3 numeric);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >CREATE FUNCTION getf1(myrowtype) RETURNS int AS 'SELECT $1.f1' LANGUAGE SQL;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >-- Now we need a cast to indicate which function to call:</font></div><div><font size="2"  >SELECT getf1(ROW(1,2.5,'this is a test'));</font></div><div><font size="2"  >ERROR: &nbsp;function getf1(record) is not unique</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >SELECT getf1(ROW(1,2.5,'this is a test')::mytable);</font></div><div><font size="2"  >&nbsp;getf1</font></div><div><font size="2"  >-------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >SELECT getf1(CAST(ROW(11,'this is a test',2.5) AS myrowtype));</font></div><div><font size="2"  >&nbsp;getf1</font></div><div><font size="2"  >-------</font></div><div><font size="2"  >&nbsp; &nbsp; 11</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=&gt; select cast(row(1,'a',1.1) as myrowtype);<br>    row    <br>-----------<br> (1,a,1.1)<br>(1 row)</font></div><div><font size="2"  >digoal=&gt; select (cast(row(1,'a',1.1) as myrowtype)).*;<br> f1 | f2 | f3  <br>----+----+-----<br>  1 | a  | 1.1<br>(1 row)</font></div><p></p></pre></div><div><br></div><div>-- 以下是array构造的一种方法. 用来构造row-variable的 array.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select array(select t from user_info t limit 10) ;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;array &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >----------------------------</font></div><div><font size="2"  >&nbsp;{"(1,zhou,digoal,\"2012-10-08 09:36:07\")","(2,zhou,digoal,\"2012-10-08 09:36:07\")","(3,zhou,digoal,\"2012-10-08 09:36:07\")","(4,</font></div><div><font size="2"  >zhou,digoal,\"2012-10-08 09:36:07\")","(5,zhou,digoal,\"2012-10-08 09:36:07\")","(6,zhou,digoal,\"2012-10-08 09:36:07\")","(7,zhou,d</font></div><div><font size="2"  >igoal,\"2012-10-08 09:36:07\")","(8,zhou,digoal,\"2012-10-08 09:36:07\")","(9,zhou,digoal,\"2012-10-08 09:36:07\")","(10,zhou,digoal</font></div><div><font size="2"  >,\"2012-10-08 09:36:07\")"}</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>-- 使用unnest可以将array转换成多行输出.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select unnest(array(select t from user_info t limit 10)) ;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unnest &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----------------------------------------</font></div><div><font size="2"  >&nbsp;(1,zhou,digoal,"2012-10-08 09:36:07")</font></div><div><font size="2"  >&nbsp;(2,zhou,digoal,"2012-10-08 09:36:07")</font></div><div><font size="2"  >&nbsp;(3,zhou,digoal,"2012-10-08 09:36:07")</font></div><div><font size="2"  >&nbsp;(4,zhou,digoal,"2012-10-08 09:36:07")</font></div><div><font size="2"  >&nbsp;(5,zhou,digoal,"2012-10-08 09:36:07")</font></div><div><font size="2"  >&nbsp;(6,zhou,digoal,"2012-10-08 09:36:07")</font></div><div><font size="2"  >&nbsp;(7,zhou,digoal,"2012-10-08 09:36:07")</font></div><div><font size="2"  >&nbsp;(8,zhou,digoal,"2012-10-08 09:36:07")</font></div><div><font size="2"  >&nbsp;(9,zhou,digoal,"2012-10-08 09:36:07")</font></div><div><font size="2"  >&nbsp;(10,zhou,digoal,"2012-10-08 09:36:07")</font></div><div><font size="2"  >(10 rows)</font></div><p></p></pre></div><div>-- 因为是row-variable, 所以这里也可以使用(row-variable).* 输出.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select (unnest(array(select t from user_info t limit 10))).* ;</font></div><div><font size="2"  >&nbsp;id | firstname | lastname | &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----+-----------+----------+---------------------</font></div><div><font size="2"  >&nbsp; 1 | zhou &nbsp; &nbsp; &nbsp;| digoal &nbsp; | 2012-10-08 09:36:07</font></div><div><font size="2"  >&nbsp; 2 | zhou &nbsp; &nbsp; &nbsp;| digoal &nbsp; | 2012-10-08 09:36:07</font></div><div><font size="2"  >&nbsp; 3 | zhou &nbsp; &nbsp; &nbsp;| digoal &nbsp; | 2012-10-08 09:36:07</font></div><div><font size="2"  >&nbsp; 4 | zhou &nbsp; &nbsp; &nbsp;| digoal &nbsp; | 2012-10-08 09:36:07</font></div><div><font size="2"  >&nbsp; 5 | zhou &nbsp; &nbsp; &nbsp;| digoal &nbsp; | 2012-10-08 09:36:07</font></div><div><font size="2"  >&nbsp; 6 | zhou &nbsp; &nbsp; &nbsp;| digoal &nbsp; | 2012-10-08 09:36:07</font></div><div><font size="2"  >&nbsp; 7 | zhou &nbsp; &nbsp; &nbsp;| digoal &nbsp; | 2012-10-08 09:36:07</font></div><div><font size="2"  >&nbsp; 8 | zhou &nbsp; &nbsp; &nbsp;| digoal &nbsp; | 2012-10-08 09:36:07</font></div><div><font size="2"  >&nbsp; 9 | zhou &nbsp; &nbsp; &nbsp;| digoal &nbsp; | 2012-10-08 09:36:07</font></div><div><font size="2"  >&nbsp;10 | zhou &nbsp; &nbsp; &nbsp;| digoal &nbsp; | 2012-10-08 09:36:07</font></div><div><font size="2"  >(10 rows)</font></div><p></p></pre></div><div><br></div><div>【参考】</div><div>1. unnest :&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/functions-array.html"  >http://www.postgresql.org/docs/9.2/static/functions-array.html</a></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; \df unnest</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of functions</font></div><div><font size="2"  >&nbsp; &nbsp;Schema &nbsp; | &nbsp;Name &nbsp;| Result data type | Argument data types | &nbsp;Type &nbsp;</font></div><div><font size="2"  >------------+--------+------------------+---------------------+--------</font></div><div><font size="2"  >&nbsp;pg_catalog | unnest | SETOF anyelement | anyarray &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>2. row and array constructor :&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/sql-expressions.html"  >http://www.postgresql.org/docs/9.2/static/sql-expressions.html</a></div></div>
	</div>
</div>
</body>
</html>