<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Why does Red Hat Enterprise Linux system does not respond to SYN requests intermittently</h2>
	<h5 id="">2010-09-16 22:40:43&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402010816101031624/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><P>最近在跨IDC的访问中遇到一个BUG，</P>  <P>环境描述：</P>  <P>源1：RHEL5.2 x64 </P>  <P>源2：RHEL5.2 x64</P>  <P>中间设备：两个IDC各一台F5</P>  <P>目标：RHEL5.5 x64</P>  <P>两台源设备的出口地址一致，目标机使用F5做的端口NAT。其中源1访问目标服务器端口正常，但是源2访问目标不通。</P>  <P>通过在F5和目标机器上抓包，看到从源2的包已经到达目标机，但是目标机没有回应。</P>  <P>查询REDHAT KBASE得出如下结论,通过修改内核参数net.ipv4.tcp_timestamps = 0之后解决。</P>  <H3>Article ID: 40006 <SPAN>-</SPAN> Created on: Aug 17, 2009 7:48 AM <SPAN>-</SPAN> Last Modified:&nbsp; Sep 13, 2010 6:13 AM </H3>  <DIV>  <DIV>  <DIV>  <H3>Issue</H3>  <UL>  <LI>Server does not answer some specific SYN Packages.   </LI><LI>Webserver does not respond for some sessions (SYN requests).&nbsp; SYN Packets being ignored intermittently by RHEL Apache server   </LI><LI>LDAP server occasionally ignoring SYNs   </LI><LI>Any server, regardless of the application layer, may occasionally ignore TCP SYN packets (i.e. a TCP packet with the SYN flag set).</LI></UL>  <P style="PADDING-BOTTOM: 0px; MIN-HEIGHT: 8pt; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; HEIGHT: 8pt; PADDING-TOP: 0px;"  ></P>  <H3>Environment</H3>  <UL>  <LI>Red Hat Enterprise Linux 4 and 5 (Webserver/application server)   </LI><LI>Red Hat Enterprise Linux 5.4 (openldap-2.3.43-3.el5)</LI></UL>  <P style="PADDING-BOTTOM: 0px; MIN-HEIGHT: 8pt; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; HEIGHT: 8pt; PADDING-TOP: 0px;"  ></P>  <P>This issue has been reported in a environment using NAT (Network Address Translation) like the following:<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <STRONG>Client<SPAN style="COLOR: #ff0000;"  >---&gt;</SPAN>NAT Router<SPAN style="COLOR: #ff0000;"  >---&gt;</SPAN>Server</STRONG></P>  <P style="PADDING-BOTTOM: 0px; MIN-HEIGHT: 8pt; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; HEIGHT: 8pt; PADDING-TOP: 0px;"  ></P>  <H3>Resolution</H3>  <P>Disable TCP time stamps using the following command:</P><PRE><CODE>echo 0 &gt; /proc/sys/net/ipv4/tcp_timestamps</CODE></PRE>  <P style="PADDING-BOTTOM: 0px; MIN-HEIGHT: 8pt; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; HEIGHT: 8pt; PADDING-TOP: 0px;"  ></P>  <P>or by adding the following line to /etc/systcl.conf and rebooting the system:</P><PRE><CODE>net.ipv4.tcp_timestamps = 0</CODE></PRE>  <P style="PADDING-BOTTOM: 0px; MIN-HEIGHT: 8pt; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; HEIGHT: 8pt; PADDING-TOP: 0px;"  ></P>  <P>Disabling TCP time stamps will disable PAWS (Protect Against Wrapped Sequences), checking as defined in <A rel="nofollow" href="http://www.ietf.org/rfc/rfc1323.txt"  >RFC 1323</A>.</P>  <P style="PADDING-BOTTOM: 0px; MIN-HEIGHT: 8pt; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; HEIGHT: 8pt; PADDING-TOP: 0px;"  ></P>  <H3>Root Cause</H3>  <P>In a TCP dump of the affected packets, the TSVal of SYN packet is a lower value than the preceding packet.</P>  <P style="PADDING-BOTTOM: 0px; MIN-HEIGHT: 8pt; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; HEIGHT: 8pt; PADDING-TOP: 0px;"  ></P><PRE><CODE>Packet #30 from x.x.x.x to y.y.y.y has a TSval of 773695118  Packet #33 from x.x.x.x to y.y.y.y has a TSval of 470318331</CODE></PRE>  <P style="PADDING-BOTTOM: 0px; MIN-HEIGHT: 8pt; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; HEIGHT: 8pt; PADDING-TOP: 0px;"  ></P>  <P>In above TCP trace, packet #33 has a TSval of 470318331 which is lower than its preceding one. As PAWS checking is enabled in the TCP stack, it doesn't send an acknowledge (SYN-ACK) back to the peer.</P>  <P style="PADDING-BOTTOM: 0px; MIN-HEIGHT: 8pt; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; HEIGHT: 8pt; PADDING-TOP: 0px;"  ></P>  <P>PAWS assumes that every received TCP segment (including data and ACK segments) contains a timestamp (SEG.TSval) whose values are non-decreasing in time. The basic idea is that a segment can be discarded as an old duplicate if it is received with a timestamp (SEG.TSval) less than some timestamp recently received on this connection.</P>  <P style="PADDING-BOTTOM: 0px; MIN-HEIGHT: 8pt; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; HEIGHT: 8pt; PADDING-TOP: 0px;"  ></P>  <P>Timestamp issues often indicate a problem with firewalls or NAT routers.</P>  <H3>Diagnostic Steps</H3>  <H6>Stage 1</H6>  <P>Since the server is not heavily loaded, you may at first suspect this issue to be an issue with socket exhaustion.&nbsp; However, checking the output of "netstat -paunt" will reveal that there are only a couple of active connections.</P>  <H6>Stage 2</H6>  <P>Increasing the size of syn backlog queue (net.ipv4.tcp_max_syn_backlog) doesn't seem to help.</P>  <H6>Stage 3</H6>  <P>Collecting a TCP dump from the server using a command like the following:</P><PRE><CODE>tcpdump -s0 -w /tmp/tcpdump.pcap -i any host &lt;client ip&gt; and port 80</CODE></PRE>  <P style="PADDING-BOTTOM: 0px; MIN-HEIGHT: 8pt; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; HEIGHT: 8pt; PADDING-TOP: 0px;"  ></P>  <P><SPAN>and generating traffic (HTTP or LDAP) to the server captures evidence of the server not responding to the TCP SYN packets.&nbsp; The output file can be analyzed with a command like</SPAN></P><PRE><CODE>tcpdump -r /&lt;path&gt;/&lt;to&gt;/tcpdump.pcap</CODE></PRE>  <P style="PADDING-BOTTOM: 0px; MIN-HEIGHT: 8pt; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; HEIGHT: 8pt; PADDING-TOP: 0px;"  ></P>  <P><SPAN>or </SPAN><A rel="nofollow" href="http://www.wireshark.org/"  >Wireshark </A><SPAN>can be used to analyze the TCP dump file graphically.&nbsp; Wireshark is a standard package in most Red Hat Enterprise Linux and Fedora distributions.&nbsp; Analysis of the TCP dump should show cases where the client will send several TCP SYN packets to the host, but the host will not respond.&nbsp; Further analysis should show that the TSVal of the SYN packets is less than a preceding TCP packet.</SPAN></P></DIV>  <DIV>  <DIV>  <DIV>Tags: <A rel="nofollow" href="https://access.redhat.com/kb/community/knowledgebase/en?view=tags&amp;tags=webserver"  >webserver</A>, <A rel="nofollow" href="https://access.redhat.com/kb/community/knowledgebase/en?view=tags&amp;tags=tcp_timestamps"  >tcp_timestamps</A>, <A rel="nofollow" href="https://access.redhat.com/kb/community/knowledgebase/en?view=tags&amp;tags=syn"  >syn</A>, <A rel="nofollow" href="https://access.redhat.com/kb/community/knowledgebase/en?view=tags&amp;tags=kcs"  >kcs</A>, <A rel="nofollow" href="https://access.redhat.com/kb/community/knowledgebase/en?view=tags&amp;tags=tcp"  >tcp</A>, <A rel="nofollow" href="https://access.redhat.com/kb/community/knowledgebase/en?view=tags&amp;tags=ldap"  >ldap</A>, <A rel="nofollow" href="https://access.redhat.com/kb/community/knowledgebase/en?view=tags&amp;tags=kcs_published"  >kcs_published</A> </DIV></DIV></DIV></DIV></DIV></div>
	</div>
</div>
</body>
</html>