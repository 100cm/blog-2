<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">[From OpenBSD]PF: Firewall Redundancy with CARP and pfsync</h2>
	<h5 id="">2010-05-11 23:05:06&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020104111156287/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><P style="TEXT-INDENT: 2em;"  >Table of Contents</P>  <P style="TEXT-INDENT: 2em;"  >  </P><UL>  <LI><A rel="nofollow" href="http://www.openbsd.org/faq/pf/carp.html#carpintro"  >Introduction to CARP</A></LI>  <LI><A rel="nofollow" href="http://www.openbsd.org/faq/pf/carp.html#carpop"  >CARP Operation</A></LI>  <LI><A rel="nofollow" href="http://www.openbsd.org/faq/pf/carp.html#carpconfig"  >Configuring CARP</A></LI>  <LI><A rel="nofollow" href="http://www.openbsd.org/faq/pf/carp.html#carpex"  >CARP Example</A></LI>  <LI><A rel="nofollow" href="http://www.openbsd.org/faq/pf/carp.html#pfsyncintro"  >Introduction to pfsync</A></LI>  <LI><A rel="nofollow" href="http://www.openbsd.org/faq/pf/carp.html#pfsyncop"  >pfsync Operation</A></LI>  <LI><A rel="nofollow" href="http://www.openbsd.org/faq/pf/carp.html#pfsyncconfig"  >Configuring pfsync</A></LI>  <LI><A rel="nofollow" href="http://www.openbsd.org/faq/pf/carp.html#pfsyncex"  >pfsync Example</A></LI>  <LI><A rel="nofollow" href="http://www.openbsd.org/faq/pf/carp.html#failover"  >Combining CARP and pfsync for Failover and Redundancy</A></LI>  <LI><A rel="nofollow" href="http://www.openbsd.org/faq/pf/carp.html#ops"  >Operational Issues</A>   <UL>  <LI><A rel="nofollow" href="http://www.openbsd.org/faq/pf/carp.html#bootconfig"  >Configuring CARP and pfsync During Boot</A></LI>  <LI><A rel="nofollow" href="http://www.openbsd.org/faq/pf/carp.html#forcefail"  >Forcing Failover of the Master</A></LI>  <LI><A rel="nofollow" href="http://www.openbsd.org/faq/pf/carp.html#RulesetTips"  >Ruleset Tips</A></LI></UL></LI>  <LI><A rel="nofollow" href="http://www.openbsd.org/faq/pf/carp.html#ref"  >Other References</A></LI></UL>  <HR>  <A rel="nofollow" href="http://www.ietf.org/rfc/rfc3768.txt"  >Virtual Router Redundancy Protocol</A>&nbsp;(VRRP) and the&nbsp;<A rel="nofollow" href="http://www.ietf.org/rfc/rfc2281.txt"  >Hot Standby Router Protocol</A>&nbsp;(HSRP).   <P></P>  <P style="TEXT-INDENT: 2em;"  >CARP works by allowing a group of hosts on the same network segment to share an IP address. This group of hosts is referred to as a “redundancy group”. The redundancy group is assigned an IP address that is shared amongst the group members. Within the group, one host is designated the “master” and the rest as “backups”. The master host is the one that currently “holds” the shared IP; it responds to any traffic or ARP requests directed towards it. Each host may belong to more than one redundancy group at a time.</P>  <P style="TEXT-INDENT: 2em;"  >One common use for CARP is to create a group of redundant firewalls. The virtual IP that is assigned to the redundancy group is configured on client machines as the default gateway. In the event that the master firewall suffers a failure or is taken offline, the IP will move to one of the backup firewalls and service will continue unaffected.</P>  <P style="TEXT-INDENT: 2em;"  >CARP supports IPv4 and IPv6.<A rel="nofollow" href="http://www.openbsd.org/cgi-bin/man.cgi?query=carp&amp;sektion=4&amp;manpath=OpenBSD+4.6"  >carp(4)</A>&nbsp;virtual network interface. As such, CARP is configured using&nbsp;<A rel="nofollow" href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&amp;sektion=8"  >ifconfig(8)</A>.   </P><BLOCKQUOTE>  <P></P>  <P style="TEXT-INDENT: 2em;"  ><TT>ifconfig&nbsp;carpN&nbsp;create</TT><TT></TT></P>  <P style="TEXT-INDENT: 2em;"  ><TT>ifconfig&nbsp;carpN&nbsp;vhid&nbsp;vhid&nbsp;[pass&nbsp;password] [carpdev&nbsp;carpdev] \</TT></P>  <P style="TEXT-INDENT: 2em;"  >[advbase&nbsp;advbase] [advskew&nbsp;advskew] [state&nbsp;state]&nbsp;ipaddress&nbsp;\</P>  <P style="TEXT-INDENT: 2em;"  >netmask&nbsp;mask</P></BLOCKQUOTE>  <DL>  <DT><TT>carpN</TT></DT>  <DD>The name of the carp(4) virtual interface where&nbsp;N&nbsp;is an integer that represents the interface’s number (e.g. carp10).</DD>  <DT><TT>vhid</TT></DT>  <DD>The Virtual Host ID. This is a unique number that is used to identify the redundancy group to other nodes on the network. Acceptable values are from 1 to 255.</DD>  <DT><TT>password</TT></DT>  <DD>The authentication password to use when talking to other CARP-enabled hosts in this redundancy group. This must be the same on all members of the group.</DD>  <DT><TT>carpdev</TT></DT>  <DD>This optional parameter specifies the physical network interface that belongs to this redundancy group. By default, CARP will try to determine which interface to use by looking for a physical interface that is in the same subnet as the&nbsp;ipaddress&nbsp;and&nbsp;mask&nbsp;combination given to the carp(4) interface.</DD>  <DT><TT>advbase</TT></DT>  <DD>This optional parameter specifies how often, in seconds, to advertise that we’re a member of the redundancy group. The default is 1 second. Acceptable values are from 1 to 255.</DD>  <DT><TT>advskew</TT></DT>  <DD>This optional parameter specifies how much to skew the&nbsp;<TT>advbase</TT>&nbsp;when sending CARP advertisements. By manipulating&nbsp;<TT>advskew</TT>, the master CARP host can be chosen. The higher the number, the&nbsp;less&nbsp;preferred the host will be when choosing a master. The default is 0. Acceptable values are from 0 to 254.</DD>  <DT><TT>state</TT></DT>  <DD>Force a carp(4) interface into a certain state. Valid states are&nbsp;<TT>init</TT>,&nbsp;<TT>backup</TT>, and&nbsp;<TT>master</TT>.</DD>  <DT><TT>ipaddress</TT></DT>  <DD>This is the shared IP address assigned to the redundancy group. This address does not have to be in the same subnet as the IP address on the physical interface (if present). This address needs to be the same on all hosts in the group, however.</DD>  <DT><TT>mask</TT></DT>  <DD>The subnet mask of the shared IP.</DD></DL>  <P></P>  <P style="TEXT-INDENT: 2em;"  >Further CARP behavior can be controlled via&nbsp;<A rel="nofollow" href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=8"  >sysctl(8)</A>.   </P><DL>  <DT><TT>net.inet.carp.allow</TT></DT>  <DD>Accept incoming CARP packets or not. Default is 1 (yes).</DD>  <DT><TT>net.inet.carp.preempt</TT></DT>  <DD>Allow hosts within a redundancy group that have a better&nbsp;<TT>advbase</TT>&nbsp;and&nbsp;<TT>advskew</TT>&nbsp;to preempt the master. In addition, this option also enables failing over all interfaces in the event that one interface goes down. If one physical CARP-enabled interface goes down, CARP will change&nbsp;<TT>advskew</TT>&nbsp;to 240 on all other CARP-enabled interfaces, in essence, failing itself over. This option is 0 (disabled) by default.</DD>  <DT><TT>net.inet.carp.log</TT></DT>  <DD>Log bad CARP packets. Default is 0 (disabled).</DD></DL>  <P></P>  <P style="TEXT-INDENT: 2em;"  ><A rel="nofollow" href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfsync&amp;sektion=4&amp;manpath=OpenBSD+4.6"  >pfsync(4)</A>&nbsp;network interface exposes certain changes made to the&nbsp;<A rel="nofollow" href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+4.6"  >pf(4)</A>&nbsp;state table. By monitoring this device using&nbsp;<A rel="nofollow" href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&amp;sektion=8"  >tcpdump(8)</A>, state table changes can be observed in real time. In addition, the pfsync(4) interface can send these state change messages out on the network so that other nodes running PF can merge the changes into their own state tables. Likewise, pfsync(4) can also listen on the network for incoming messages.<A rel="nofollow" href="http://www.openbsd.org/faq/pf/carp.html#pfsyncconfig"  >below</A>).   </P><LI>Use the ifconfig(8)&nbsp;<TT>syncpeer</TT>&nbsp;option (see&nbsp;<A rel="nofollow" href="http://www.openbsd.org/faq/pf/carp.html#pfsyncconfig"  >below</A>) so that updates are unicast directly to the peer, then configure&nbsp;<A rel="nofollow" href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsec&amp;sektion=4"  >ipsec(4)</A>&nbsp;between the hosts to secure the pfsync(4) traffic.</LI>  <OL></OL>  <P></P>  <P style="TEXT-INDENT: 2em;"  >When updates are being sent and received on the network, pfsync packets should be passed in the filter ruleset:   </P><BLOCKQUOTE>  <P></P>  <P style="TEXT-INDENT: 2em;"  ><TT>pass on $sync_if proto pfsync</TT></P></BLOCKQUOTE>  <P></P>  <P style="TEXT-INDENT: 2em;"  ><TT>$sync_if</TT>&nbsp;should be the physical interface that pfsync(4) is communicating over.<A rel="nofollow" href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&amp;sektion=8"  >ifconfig(8)</A>.   </P><BLOCKQUOTE>  <P></P>  <P style="TEXT-INDENT: 2em;"  ><TT>ifconfig&nbsp;pfsyncN&nbsp;syncdev&nbsp;syncdev&nbsp;[syncpeer&nbsp;syncpeer]</TT></P></BLOCKQUOTE>  <DL>  <DT><TT>pfsyncN</TT></DT>  <DD>The name of the pfsync(4) interface.&nbsp;<TT>pfsync0</TT>&nbsp;exists by default when using the&nbsp;<TT>GENERIC</TT>&nbsp;kernel.</DD>  <DT><TT>syncdev</TT></DT>  <DD>The name of the physical interface used to send pfsync updates out.</DD>  <DT><TT>syncpeer</TT></DT>  <DD>This optional parameter specifies the IP address of a host to exchange pfsync updates with. By default pfsync updates are multicast on the local network. This option overrides that behavior and instead unicasts the update to the specified&nbsp;<TT>syncpeer</TT>.</DD></DL>  <P></P>  <P style="TEXT-INDENT: 2em;"  ><A rel="nofollow" href="http://www.openbsd.org/cgi-bin/man.cgi?query=hostname.if&amp;sektion=5"  >hostname.if(5)</A>&nbsp;file. The&nbsp;<A rel="nofollow" href="http://www.openbsd.org/cgi-bin/man.cgi?query=netstart&amp;sektion=8"  >netstart</A>&nbsp;startup script will take care of creating the interface and configuring it.</P>  <P style="TEXT-INDENT: 2em;"  >Examples:   </P><DL>  <DT>/etc/hostname.carp1</DT>  <DD>inet 172.16.0.100 255.255.255.0 172.16.0.255 vhid 1 carpdev em0 \   <P></P>  <P style="TEXT-INDENT: 2em;"  >pass lanpasswd</P></DD></DL>  <DL>  <DT>/etc/hostname.pfsync0</DT>  <DD>up syncdev em1</DD></DL>  <P></P>  <P style="TEXT-INDENT: 2em;"  ><A rel="nofollow" href="http://www.openbsd.org/cgi-bin/man.cgi?query=bgpd&amp;sektion=8"  >OpenBGPD</A>&nbsp;and&nbsp;<A rel="nofollow" href="http://www.openbsd.org/cgi-bin/man.cgi?query=sasyncd&amp;sektion=8"  >sasyncd(8)</A>&nbsp;make use of the demotion counter to ensure that the firewall does not become master until BGP sessions become established and IPsec SAs are synchronized.<A rel="nofollow"></A></P>  <P style="TEXT-INDENT: 2em;"  >Ruleset Tips</P>  <P style="TEXT-INDENT: 2em;"  >Filter the physical interface.&nbsp;As far as PF is concerned, network traffic comes from the physical interface, not the CARP virtual interface (i.e.,&nbsp;<TT>carp0</TT>). So, write your rule sets accordingly. Don’t forget that an interface name in a PF rule can be either the name of a physical interface or an address associated with that interface. For example, this rule could be correct:   </P><BLOCKQUOTE>  <P></P>  <P style="TEXT-INDENT: 2em;"  ><TT>pass in on fxp0 inet proto tcp from any to carp0 port 22</TT></P></BLOCKQUOTE>  <P></P>  <P style="TEXT-INDENT: 2em;"  >but replacing the&nbsp;<TT>fxp0</TT>&nbsp;with&nbsp;<TT>carp0</TT>&nbsp;would not work as you desire.</P>  <P style="TEXT-INDENT: 2em;"  >DON’T forget&nbsp;to pass&nbsp;<TT>proto carp</TT>&nbsp;and&nbsp;<TT>proto pfsync</TT>!</P></div>
	</div>
</div>
</body>
</html>