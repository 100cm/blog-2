<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.5 new feature - allow standby archives all files it receives from the primary.</h2>
	<h5 id="">2015-05-25 16:19:11&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020154254349298/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>有些应用场景，我们可能需要standby角色也执行归档的动作，例如当我们将standby作为备份节点来使用时，备份基础文件的同时还要归档。</div><div>在PostgreSQL 9.5之前，当数据库处于恢复状态时，是不会执行归档的，见代码，如果要让standby调用归档命令，我们可以能需要修改一下以下代码：</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201452004721783/"   >http://blog.163.com/digoal@126/blog/static/163877040201452004721783/</a></div><div><div>1. src/backend/postmaster/postmaster.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (XLogArchivingActive() &amp;&amp; PgArchPID == 0 )</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (XLogArchivingActive() &amp;&amp; PgArchPID == 0 &amp;&amp; pmState == PM_RUN)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PgArchPID = pgarch_start();</font></div><div><font size="2"   >...</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (XLogArchivingActive())</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (XLogArchivingActive() &amp;&amp; pmState == PM_RUN)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PgArchPID = pgarch_start();</font></div><p></p></pre></div></div><div><br></div><div><div>2. src/backend/replication/walreceiver.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Create .done file forcibly to prevent the streamed segment from</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* being archived later.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XLogFileName(xlogfname, recvFileTLI, recvSegNo);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XLogArchiveForceDone(xlogfname);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XLogArchiveNotify(xlogfname);</font></div><div><font size="2"   >....</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Create .done file forcibly to prevent the streamed segment</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* from being archived later.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XLogFileName(xlogfname, recvFileTLI, recvSegNo);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XLogArchiveForceDone(xlogfname);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XLogArchiveNotify(xlogfname);</font></div><p></p></pre></div></div><div>PostgreSQL 9.5允许standby角色调用归档命令，需要配置<span style="line-height: 28px;"   >archive_mode=always.</span></div><wbr><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-#archive_mode = off &nbsp; &nbsp; &nbsp; &nbsp;# allows archiving to be done</font></div><div><font size="2"   >+#archive_mode = off &nbsp; &nbsp; &nbsp; &nbsp;# enables archiving; off, on, or always</font></div><p></p></pre></div><div>代码：</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >index 9c7710f..41e57f2 100644 (file)</font></div><div><font size="2"   >--- a/src/backend/replication/walreceiver.c</font></div><div><font size="2"   >+++ b/src/backend/replication/walreceiver.c</font></div><div><font size="2"   >@@ -540,7 +540,10 @@ WalReceiverMain(void)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* being archived later.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XLogFileName(xlogfname, recvFileTLI, recvSegNo);</font></div><div><font size="2"   >- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XLogArchiveForceDone(xlogfname);</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (XLogArchiveMode != ARCHIVE_MODE_ALWAYS)</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XLogArchiveForceDone(xlogfname);</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XLogArchiveNotify(xlogfname);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; recvFile = -1;</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >@@ -897,7 +900,10 @@ XLogWalRcvWrite(char *buf, Size nbytes, XLogRecPtr recptr)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* from being archived later.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XLogFileName(xlogfname, recvFileTLI, recvSegNo);</font></div><div><font size="2"   >- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XLogArchiveForceDone(xlogfname);</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (XLogArchiveMode != ARCHIVE_MODE_ALWAYS)</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XLogArchiveForceDone(xlogfname);</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XLogArchiveNotify(xlogfname);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >--- a/src/backend/access/transam/xlogarchive.c</font></div><div><font size="2"   >+++ b/src/backend/access/transam/xlogarchive.c</font></div><div><font size="2"   >@@ -480,7 +480,10 @@ KeepFileRestoredFromArchive(char *path, char *xlogfname)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;* Create .done file forcibly to prevent the restored segment from being</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;* archived again later.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >- &nbsp; XLogArchiveForceDone(xlogfname);</font></div><div><font size="2"   >+ &nbsp; if (XLogArchiveMode != ARCHIVE_MODE_ALWAYS)</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; XLogArchiveForceDone(xlogfname);</font></div><div><font size="2"   >+ &nbsp; else</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; XLogArchiveNotify(xlogfname);</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >--- a/doc/src/sgml/high-availability.sgml</font></div><div><font size="2"   >+++ b/doc/src/sgml/high-availability.sgml</font></div><div><font size="2"   >@@ -1220,6 +1220,45 @@ primary_slot_name = 'node_a_slot'</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;/sect3&gt;</font></div><div><font size="2"   >&nbsp; &nbsp;&lt;/sect2&gt;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp;&lt;sect2 id="continuous-archiving-in-standby"&gt;</font></div><div><font size="2"   >+ &nbsp; &lt;title&gt;Continuous archiving in standby&lt;/title&gt;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; &lt;indexterm&gt;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &lt;primary&gt;continuous archiving&lt;/primary&gt;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &lt;secondary&gt;in standby&lt;/secondary&gt;</font></div><div><font size="2"   >+ &nbsp; &lt;/indexterm&gt;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; &lt;para&gt;</font></div><div><font size="2"   >+ &nbsp; &nbsp; When continuous WAL archiving is used in a standby, there are two</font></div><div><font size="2"   >+ &nbsp; &nbsp; different scenarios: the WAL archive can be shared between the primary</font></div><div><font size="2"   >+ &nbsp; &nbsp; and the standby, or the standby can have its own WAL archive. When</font></div><div><font size="2"   >+ &nbsp; &nbsp; the standby has its own WAL archive, set &lt;varname&gt;archive_mode&lt;/varname&gt;</font></div><div><font size="2"   >+ &nbsp; &nbsp; to &lt;literal&gt;always&lt;/literal&gt;, and the standby will call the archive</font></div><div><font size="2"   >+ &nbsp; &nbsp; command for every WAL segment it receives, whether it's by restoring</font></div><div><font size="2"   >+ &nbsp; &nbsp; from the archive or by streaming replication. The shared archive can</font></div><div><font size="2"   >+ &nbsp; &nbsp; be handled similarly, but the archive_command must test if the file</font></div><div><font size="2"   >+ &nbsp; &nbsp; being archived exists already, and if the existing file has identical</font></div><div><font size="2"   >+ &nbsp; &nbsp; contents. This requires more care in the archive_command, as it must</font></div><div><font size="2"   >+ &nbsp; &nbsp; be careful to not overwrite an existing file with different contents,</font></div><div><font size="2"   >+ &nbsp; &nbsp; but return success if the exactly same file is archived twice. And</font></div><div><font size="2"   >+ &nbsp; &nbsp; all that must be done free of race conditions, if two servers attempt</font></div><div><font size="2"   >+ &nbsp; &nbsp; to archive the same file at the same time.</font></div><div><font size="2"   >+ &nbsp; &lt;/para&gt;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; &lt;/para&gt;</font></div><div><font size="2"   >+ &nbsp; &nbsp; If &lt;varname&gt;archive_mode&lt;/varname&gt; is set to &lt;literal&gt;on&lt;/&gt;, the</font></div><div><font size="2"   >+ &nbsp; &nbsp; archiver is not enabled during recovery or standby mode. If the standby</font></div><div><font size="2"   >+ &nbsp; &nbsp; server is promoted, it will start archiving after the promotion, but</font></div><div><font size="2"   >+ &nbsp; &nbsp; will not archive any WAL it did not generate itself. To get a complete</font></div><div><font size="2"   >+ &nbsp; &nbsp; series of WAL files in the archive, you must ensure that all WAL is</font></div><div><font size="2"   >+ &nbsp; &nbsp; archived, before it reaches the standby. This is inherently true with</font></div><div><font size="2"   >+ &nbsp; &nbsp; file-based log shipping, as the standby can only restore files that</font></div><div><font size="2"   >+ &nbsp; &nbsp; are found in the archive, but not if streaming replication is enabled.</font></div><div><font size="2"   >+ &nbsp; &nbsp; When a server is not in recovery mode, there is no difference between</font></div><div><font size="2"   >+ &nbsp; &nbsp; &lt;literal&gt;on&lt;/literal&gt; and &lt;literal&gt;always&lt;/literal&gt; modes.</font></div><div><font size="2"   >+ &nbsp; &lt;/para&gt;</font></div><div><font size="2"   >+ &nbsp;&lt;/sect2&gt;</font></div></div><p></p></pre></div><div>PostgreSQL 9.5 为大家提供了一种更好的归档选择，你可以让standby参与归档，或者让它不参与归档。</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=ffd37740ee6fcd434416ec0c5461f7040e0a11de"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=ffd37740ee6fcd434416ec0c5461f7040e0a11de</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201452004721783/"   >http://blog.163.com/digoal@126/blog/static/163877040201452004721783/<br></a><span style="line-height: 28px;"   >
</span><a style="line-height: 28px;" rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL 9.5 new feature - allow standby archives all files it receives from the primary. - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div></div>
	</div>
</div>
</body>
</html>