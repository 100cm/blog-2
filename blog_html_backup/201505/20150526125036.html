<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.5 new feature - Support REINDEX progress printed as each index reindexed</h2>
	<h5 id="">2015-05-26 12:50:36&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402015426113316865/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.5 新增reindex的重建索引进度输出功能，注意这里指的进度粒度是索引，例如对整个SCHEMA重建索引，会输出每个索引的重建进度，而不是单个索引的进度。</div><div>例如：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# reindex (verbose) schema public;</font></div><div><font size="2"   >INFO: &nbsp;index "idx_test" was reindexed</font></div><div><font size="2"   >DETAIL: &nbsp;CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;table "public.test" was reindexed</font></div><div><font size="2"   >INFO: &nbsp;index "idx_tbl" was reindexed</font></div><div><font size="2"   >DETAIL: &nbsp;CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;index "idx_tbl1" was reindexed</font></div><div><font size="2"   >DETAIL: &nbsp;CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;table "public.tbl" was reindexed</font></div><div><font size="2"   >REINDEX</font></div><p></p></pre></div><div>顺便讲一下reindex和drop index;create index ...;的区别：</div><div>1. REINDEX 时，对正在reindex的索引加排他锁，同时会堵塞对表的写操作，但是不堵塞对表的读操作，另外需要注意，如果读操作的执行计划用到了正在REINDEX的索引，也会被堵塞。</div><div>2. 使用drop index; create index ....;的方法，drop index时需要获取表的排他锁，会堵塞表的读和写操作。</div><div>create index时，堵塞写操作，不堵塞读；注意create index可以使用concurrently选项，不堵塞读。</div><div><br></div><wbr><div>REINDEX支持的参数：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >INDEX</font></div><div><font size="2"   >重建指定索引。</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >TABLE</font></div><div><font size="2"   >重建指定表的所有索引，包括对应的TOAST索引。</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SCHEMA</font></div><div><font size="2"   >重建指定schema中的所有索引，包括TOAST索引。如果指定的schema是共享对象的schema如pg_catalog，那么将对共享对象重建索引。</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >DATABASE</font></div><div><font size="2"   >重建当前连接的数据库的索引，包括system catalog，共享对象。</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SYSTEM</font></div><div><span style="line-height: 28px;"   ><font size="2"   >重建当前数据库的system catalog，共享对象的索引。</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   ><br></font></span></div><div><font size="2"   >name</font></div><div><font size="2"   >The name of the specific index, table, or database to be reindexed.&nbsp;</font></div><div><font size="2"   >Index and table names can be schema-qualified.&nbsp;</font></div><div><font size="2"   >Presently, REINDEX DATABASE and REINDEX SYSTEM can only reindex the current database,&nbsp;</font></div><div><font size="2"   >so their parameter must match the current database's name.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >VERBOSE</font></div><div><font size="2"   >Prints a progress report as each index is reindexed.</font></div><p></p></pre></div><div><br></div><div>如果要修复损坏的系统索引，那么就不能有扫描系统索引的动作，因为扫描到损坏的系统索引会导致数据库crash重启。</div><div>建议以-P选项启动数据库(禁止扫描系统索引)，进入单用户模式进行修复。</div><div>如果不想重启数据库，可以以-P选项启动libpq写的客户端（例如psql），进行修复。</div><div><span style="line-height: 28px;"   >man postgres</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;-P</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Ignore system indexes when reading system tables, but still update the indexes when modifying the tables.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;This is useful when recovering from damaged system indexes.</font></div><p></p></pre></div><div>效果和设置<span style="line-height: 28px;"   >ignore_system_indexes参数一样</span></div><div>src/backend/utils/misc/guc.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {"ignore_system_indexes", PGC_BACKEND, DEVELOPER_OPTIONS,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gettext_noop("Disables reading from system indexes."),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gettext_noop("It does not prevent updating the indexes, so it is safe "</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"to use. &nbsp;The worst consequence is slowness."),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GUC_NOT_IN_SAMPLE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</font></div><p></p></pre></div><div><br></div><div>例子：</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg95@db-172-16-3-150-&gt; export PGOPTIONS='-P'</font></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.5devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# \d pg_class</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; Table "pg_catalog.pg_class"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;Column &nbsp; &nbsp; | &nbsp; Type &nbsp; &nbsp;| Modifiers&nbsp;</font></div><div><font size="2"   >----------------+-----------+-----------</font></div><div><font size="2"   >&nbsp;relname &nbsp; &nbsp; &nbsp; &nbsp;| name &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;relnamespace &nbsp; | oid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;reltype &nbsp; &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;reloftype &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relowner &nbsp; &nbsp; &nbsp; | oid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relam &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relfilenode &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;reltablespace &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relpages &nbsp; &nbsp; &nbsp; | integer &nbsp; | not null</font></div><div><font size="2"   >&nbsp;reltuples &nbsp; &nbsp; &nbsp;| real &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;relallvisible &nbsp;| integer &nbsp; | not null</font></div><div><font size="2"   >&nbsp;reltoastrelid &nbsp;| oid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relhasindex &nbsp; &nbsp;| boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relisshared &nbsp; &nbsp;| boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relpersistence | "char" &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;relkind &nbsp; &nbsp; &nbsp; &nbsp;| "char" &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;relnatts &nbsp; &nbsp; &nbsp; | smallint &nbsp;| not null</font></div><div><font size="2"   >&nbsp;relchecks &nbsp; &nbsp; &nbsp;| smallint &nbsp;| not null</font></div><div><font size="2"   >&nbsp;relhasoids &nbsp; &nbsp; | boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relhaspkey &nbsp; &nbsp; | boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relhasrules &nbsp; &nbsp;| boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relhastriggers | boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relhassubclass | boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relrowsecurity | boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relispopulated | boolean &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relreplident &nbsp; | "char" &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;relfrozenxid &nbsp; | xid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relminmxid &nbsp; &nbsp; | xid &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;relacl &nbsp; &nbsp; &nbsp; &nbsp; | aclitem[] |&nbsp;</font></div><div><font size="2"   >&nbsp;reloptions &nbsp; &nbsp; | text[] &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_class_oid_index" UNIQUE, btree (oid)</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_class_relname_nsp_index" UNIQUE, btree (relname, relnamespace)</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_class_tblspc_relfilenode_index" btree (reltablespace, relfilenode)</font></div><p></p></pre></div><div>现在不会扫描系统索引：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# explain select * from pg_class where oid=1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on pg_class &nbsp;(cost=0.00..7.99 rows=1 width=201)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (oid = '1'::oid)</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div></div><div><br></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg95@db-172-16-3-150-&gt; unset PGOPTIONS</font></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; echo $PGOPTIONS</font></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.5devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><p></p></pre></div><div>恢复扫描系统索引：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# explain select * from pg_class where oid=1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using pg_class_oid_index on pg_class &nbsp;(cost=0.15..4.17 rows=1 width=201)</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: (oid = '1'::oid)</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div></div><div><br></div>[参考]<div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=ecd222e770d352121590363ffdf981147a43e976"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=ecd222e770d352121590363ffdf981147a43e976</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-reindex.html"   >http://www.postgresql.org/docs/devel/static/sql-reindex.html<br></a><span style="line-height: 28px;"   >
</span><a style="line-height: 28px;" rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL 9.5 new feature - Support REINDEX progress printed as each index reindexed - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div></div>
	</div>
</div>
</body>
</html>