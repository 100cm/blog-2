<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.5 new feature - create type transform between pl/lang and PostgreSQL</h2>
	<h5 id="">2015-05-25 16:55:40&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201542544520314/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>当我们使用过程语言时，让过程语言处理PostgreSQL的一些特殊类型可能会遇到一些麻烦，例如plpython过程语言来处理hstore类型，因为python里面没有hstore类型对应的类型，通常情况下，在python中我们可能要把hstore作为字符串来处理。</div><div>为了提高编程效率，PostgreSQL 9.5新增了数据类型转换接口，允许用户自定义数据库和过程语言之间的类型转换方法。</div><div>语法如下：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE [ OR REPLACE ] TRANSFORM FOR type_name LANGUAGE lang_name (</font></div><div><font size="2"   >&nbsp; &nbsp; FROM SQL WITH FUNCTION from_sql_function_name (argument_type [, ...]),</font></div><div><font size="2"   >&nbsp; &nbsp; TO SQL WITH FUNCTION to_sql_function_name (argument_type [, ...])</font></div><div><font size="2"   >);</font></div><p></p></pre></div></div><div><span style="line-height: 28px;"   >type_name 是需要转换的数据库类型，例如hstore</span></div><div><span style="line-height: 28px;"   >lang_name 是过程语言，例如plpythonu</span></div><div><span style="line-height: 28px;"   >from_sql_function_name &nbsp;是将数据库类型转换为过程语言中对应类型的处理函数</span></div><div><span style="line-height: 28px;"   >to_sql_function_name&nbsp;</span><span style="line-height: 28px;"   >&nbsp;</span><span style="line-height: 28px;"   >&nbsp;是将过程语言类型转换为数据库类型的处理函数</span></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >目前PostgreSQL contrib中自带了hstore类型在过程语言perl和python中的转换方法。</span></div><div>对应perl的&nbsp;HV Hash Value以及python的dict。</div><div><span style="line-height: 28px;"   >我们可以参考一下：</span></div><div>contrib/hstore_plpython/<span style="line-height: 28px;"   >hstore_plpython.c</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#include "postgres.h"</font></div><div><font size="2"   >#include "fmgr.h"</font></div><div><font size="2"   >#include "plpython.h"</font></div><div><font size="2"   >#include "plpy_typeio.h"</font></div><div><font size="2"   >#include "hstore.h"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >PG_MODULE_MAGIC;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >PG_FUNCTION_INFO_V1(hstore_to_plpython);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Datum</font></div><div><font size="2"   >hstore_to_plpython(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; HStore &nbsp; &nbsp; *in = PG_GETARG_HS(0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; count = HS_COUNT(in);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *base = STRPTR(in);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; HEntry &nbsp; &nbsp; *entries = ARRPTR(in);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PyObject &nbsp; *dict;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; dict = PyDict_New();</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; for (i = 0; i &lt; count; i++)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PyObject &nbsp; *key;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; key = PyString_FromStringAndSize(HS_KEY(entries, base, i), HS_KEYLEN(entries, i));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (HS_VALISNULL(entries, i))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PyDict_SetItem(dict, key, Py_None);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PyObject &nbsp; *value;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; value = PyString_FromStringAndSize(HS_VAL(entries, base, i), HS_VALLEN(entries, i));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PyDict_SetItem(dict, key, value);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Py_XDECREF(value);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Py_XDECREF(key);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return PointerGetDatum(dict);</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >PG_FUNCTION_INFO_V1(plpython_to_hstore);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Datum</font></div><div><font size="2"   >plpython_to_hstore(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PyObject &nbsp; *dict;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; volatile PyObject *items_v = NULL;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pcount;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; HStore &nbsp; &nbsp; *out;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; dict = (PyObject *) PG_GETARG_POINTER(0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!PyMapping_Check(dict))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_WRONG_OBJECT_TYPE),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("not a Python mapping")));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; pcount = PyMapping_Size(dict);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; items_v = PyMapping_Items(dict);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PG_TRY();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buflen;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Pairs &nbsp; &nbsp; &nbsp;*pairs;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PyObject &nbsp; *items = (PyObject *) items_v;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pairs = palloc(pcount * sizeof(*pairs));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for (i = 0; i &lt; pcount; i++)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PyObject &nbsp; *tuple;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PyObject &nbsp; *key;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PyObject &nbsp; *value;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tuple = PyList_GetItem(items, i);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; key = PyTuple_GetItem(tuple, 0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; value = PyTuple_GetItem(tuple, 1);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pairs[i].key = PLyObject_AsString(key);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pairs[i].keylen = hstoreCheckKeyLen(strlen(pairs[i].key));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pairs[i].needfree = true;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (value == Py_None)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pairs[i].val = NULL;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pairs[i].vallen = 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pairs[i].isnull = true;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pairs[i].val = PLyObject_AsString(value);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pairs[i].vallen = hstoreCheckValLen(strlen(pairs[i].val));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pairs[i].isnull = false;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Py_DECREF(items_v);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pcount = hstoreUniquePairs(pairs, pcount, &amp;buflen);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out = hstorePairs(pairs, pcount, buflen);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PG_CATCH();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Py_DECREF(items_v);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RE_THROW();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PG_END_TRY();</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_POINTER(out);</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>hstore_plpythonu--1.0.sql</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE FUNCTION hstore_to_plpython(val internal) RETURNS internal</font></div><div><font size="2"   >LANGUAGE C STRICT IMMUTABLE</font></div><div><font size="2"   >AS 'MODULE_PATHNAME';</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION plpython_to_hstore(val internal) RETURNS hstore</font></div><div><font size="2"   >LANGUAGE C STRICT IMMUTABLE</font></div><div><font size="2"   >AS 'MODULE_PATHNAME';</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE TRANSFORM FOR hstore LANGUAGE plpythonu (</font></div><div><font size="2"   >&nbsp; &nbsp; FROM SQL WITH FUNCTION hstore_to_plpython(internal),</font></div><div><font size="2"   >&nbsp; &nbsp; TO SQL WITH FUNCTION plpython_to_hstore(internal)</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >COMMENT ON TRANSFORM FOR hstore LANGUAGE plpythonu IS 'transform between hstore and Python dict';</font></div><p></p></pre></div><div>这个transform实现了hstore类型和python dict类型的相互转换。</div><div><br></div><div>例子：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE EXTENSION plpython2u;</font></div><div><font size="2"   >CREATE EXTENSION hstore_plpython2u;</font></div><div><font size="2"   >-- test hstore -&gt; python</font></div><div><font size="2"   >CREATE FUNCTION test1(val hstore) RETURNS int</font></div><div><font size="2"   >LANGUAGE plpythonu</font></div><div><font size="2"   >TRANSFORM FOR TYPE hstore</font></div><div><font size="2"   >AS $$</font></div><div><font size="2"   >assert isinstance(val, dict)</font></div><div><font size="2"   >i = list(val.items())</font></div><div><font size="2"   >i.sort()</font></div><div><font size="2"   >plpy.info(i)</font></div><div><font size="2"   >return len(val)</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >SELECT test1('aa=&gt;bb, cc=&gt;NULL'::hstore);</font></div><div><font size="2"   >INFO: &nbsp;[('aa', 'bb'), ('cc', None)]</font></div><div><font size="2"   >CONTEXT: &nbsp;PL/Python function "test1"</font></div><div><font size="2"   >&nbsp;test1&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- the same with the versioned language name</font></div><div><font size="2"   >CREATE FUNCTION test1n(val hstore) RETURNS int</font></div><div><font size="2"   >LANGUAGE plpython2u</font></div><div><font size="2"   >TRANSFORM FOR TYPE hstore</font></div><div><font size="2"   >AS $$</font></div><div><font size="2"   >assert isinstance(val, dict)</font></div><div><font size="2"   >i = list(val.items())</font></div><div><font size="2"   >i.sort()</font></div><div><font size="2"   >plpy.info(i)</font></div><div><font size="2"   >return len(val)</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >SELECT test1n('aa=&gt;bb, cc=&gt;NULL'::hstore);</font></div><div><font size="2"   >INFO: &nbsp;[('aa', 'bb'), ('cc', None)]</font></div><div><font size="2"   >CONTEXT: &nbsp;PL/Python function "test1n"</font></div><div><font size="2"   >&nbsp;test1n&nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 2</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- test hstore[] -&gt; python</font></div><div><font size="2"   >CREATE FUNCTION test1arr(val hstore[]) RETURNS int</font></div><div><font size="2"   >LANGUAGE plpythonu</font></div><div><font size="2"   >TRANSFORM FOR TYPE hstore</font></div><div><font size="2"   >AS $$</font></div><div><font size="2"   >plpy.info(repr(val))</font></div><div><font size="2"   >return len(val)</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >SELECT test1arr(array['aa=&gt;bb, cc=&gt;NULL'::hstore, 'dd=&gt;ee']);</font></div><div><font size="2"   >INFO: &nbsp;[{'aa': 'bb', 'cc': None}, {'dd': 'ee'}]</font></div><div><font size="2"   >CONTEXT: &nbsp;PL/Python function "test1arr"</font></div><div><font size="2"   >&nbsp;test1arr&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- test python -&gt; hstore</font></div><div><font size="2"   >CREATE FUNCTION test2() RETURNS hstore</font></div><div><font size="2"   >LANGUAGE plpythonu</font></div><div><font size="2"   >TRANSFORM FOR TYPE hstore</font></div><div><font size="2"   >AS $$</font></div><div><font size="2"   >val = {'a': 1, 'b': 'boo', 'c': None}</font></div><div><font size="2"   >return val</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >SELECT test2();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; test2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------------------</font></div><div><font size="2"   >&nbsp;"a"=&gt;"1", "b"=&gt;"boo", "c"=&gt;NULL</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- test python -&gt; hstore[]</font></div><div><font size="2"   >CREATE FUNCTION test2arr() RETURNS hstore[]</font></div><div><font size="2"   >LANGUAGE plpythonu</font></div><div><font size="2"   >TRANSFORM FOR TYPE hstore</font></div><div><font size="2"   >AS $$</font></div><div><font size="2"   >val = [{'a': 1, 'b': 'boo', 'c': None}, {'d': 2}]</font></div><div><font size="2"   >return val</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >&nbsp;SELECT test2arr();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;test2arr &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;{"\"a\"=&gt;\"1\", \"b\"=&gt;\"boo\", \"c\"=&gt;NULL","\"d\"=&gt;\"2\""}</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- test as part of prepare/execute</font></div><div><font size="2"   >CREATE FUNCTION test3() RETURNS void</font></div><div><font size="2"   >LANGUAGE plpythonu</font></div><div><font size="2"   >TRANSFORM FOR TYPE hstore</font></div><div><font size="2"   >AS $$</font></div><div><font size="2"   >rv = plpy.execute("SELECT 'aa=&gt;bb, cc=&gt;NULL'::hstore AS col1")</font></div><div><font size="2"   >plpy.info(repr(rv[0]["col1"]))</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >val = {'a': 1, 'b': 'boo', 'c': None}</font></div><div><font size="2"   >plan = plpy.prepare("SELECT $1::text AS col1", ["hstore"])</font></div><div><font size="2"   >rv = plpy.execute(plan, [val])</font></div><div><font size="2"   >plpy.info(repr(rv[0]["col1"]))</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >SELECT test3();</font></div><div><font size="2"   >INFO: &nbsp;{'aa': 'bb', 'cc': None}</font></div><div><font size="2"   >CONTEXT: &nbsp;PL/Python function "test3"</font></div><div><font size="2"   >INFO: &nbsp;'"a"=&gt;"1", "b"=&gt;"boo", "c"=&gt;NULL'</font></div><div><font size="2"   >CONTEXT: &nbsp;PL/Python function "test3"</font></div><div><font size="2"   >&nbsp;test3&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- test trigger</font></div><div><font size="2"   >CREATE TABLE test1 (a int, b hstore);</font></div><div><font size="2"   >INSERT INTO test1 VALUES (1, 'aa=&gt;bb, cc=&gt;NULL');</font></div><div><font size="2"   >SELECT * FROM test1;</font></div><div><font size="2"   >&nbsp;a | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---+------------------------</font></div><div><font size="2"   >&nbsp;1 | "aa"=&gt;"bb", "cc"=&gt;NULL</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION test4() RETURNS trigger</font></div><div><font size="2"   >LANGUAGE plpythonu</font></div><div><font size="2"   >TRANSFORM FOR TYPE hstore</font></div><div><font size="2"   >AS $$</font></div><div><font size="2"   >plpy.info("Trigger row: {'a': %r, 'b': %r}" % (TD["new"]["a"], TD["new"]["b"]))</font></div><div><font size="2"   >if TD["new"]["a"] == 1:</font></div><div><font size="2"   >&nbsp; &nbsp; TD["new"]["b"] = {'a': 1, 'b': 'boo', 'c': None}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >return "MODIFY"</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >CREATE TRIGGER test4 BEFORE UPDATE ON test1 FOR EACH ROW EXECUTE PROCEDURE test4();</font></div><div><font size="2"   >UPDATE test1 SET a = a;</font></div><div><font size="2"   >INFO: &nbsp;Trigger row: {'a': 1, 'b': {'aa': 'bb', 'cc': None}}</font></div><div><font size="2"   >CONTEXT: &nbsp;PL/Python function "test4"</font></div><div><font size="2"   >SELECT * FROM test1;</font></div><div><font size="2"   >&nbsp;a | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;b &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---+---------------------------------</font></div><div><font size="2"   >&nbsp;1 | "a"=&gt;"1", "b"=&gt;"boo", "c"=&gt;NULL</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-createtransform.html"   >http://www.postgresql.org/docs/devel/static/sql-createtransform.html</a></div><div>2.&nbsp;contrib/hstore_plpython</div><div>3.&nbsp;<span style="line-height: 28px;"   >contrib/</span><span style="line-height: 28px;"   >hstore_plperl</span></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL 9.5 new feature - create type transform between pl/lang and PostgreSQL - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>