<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL partial/sub commit within function</h2>
	<h5 id="">2015-05-14 15:44:39&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201541424916744/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL的函数是原子操作，所以不能像Oracle那样在函数中实现分段提交。</div><div>但是如果你要从Oracle迁移到PostgreSQL的话，必然会面临这样的问题，那么怎么办呢？</div><div>有几种方法可以来实现，下面是例子：</div><div>1. 通过exception来实现分段提交。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create table tbl (id int primary key, info text);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create or replace function func1() returns void as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_stat int := 0;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; insert into tbl values(1);</font></div><div><font size="2"   >&nbsp; v_stat := 1;</font></div><div><font size="2"   >&nbsp; insert into tbl values(2);</font></div><div><font size="2"   >&nbsp; v_stat := 2;</font></div><div><font size="2"   >&nbsp; insert into tbl values(3);</font></div><div><font size="2"   >&nbsp; v_stat := 3;</font></div><div><font size="2"   >&nbsp; insert into tbl values(3);</font></div><div><font size="2"   >&nbsp; v_stat := 4;</font></div><div><font size="2"   >&nbsp; return;</font></div><div><font size="2"   >&nbsp; exception when others then</font></div><div><font size="2"   >&nbsp; &nbsp; case&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; when v_stat = 1 then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; insert into tbl values(1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; when v_stat = 2 then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; insert into tbl values(1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; insert into tbl values(2);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; when v_stat = 3 then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; insert into tbl values(1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; insert into tbl values(2);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; insert into tbl values(3);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; when v_stat = 4 then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; insert into tbl values(1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; insert into tbl values(2);</font></div><div><font size="2"   ><span>	</span>insert into tbl values(3);</font></div><div><font size="2"   ><span>	</span>insert into tbl values(3);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end case;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select func1();</font></div><div><font size="2"   >&nbsp;func1&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select ctid,* from tbl;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| id | info&nbsp;</font></div><div><font size="2"   >-------+----+------</font></div><div><font size="2"   >&nbsp;(0,5) | &nbsp;1 |&nbsp;</font></div><div><font size="2"   >&nbsp;(0,6) | &nbsp;2 |&nbsp;</font></div><div><font size="2"   >&nbsp;(0,7) | &nbsp;3 |&nbsp;</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div><div>这样做的弊端很明显，需要重新插入，相当于前面的操作全部回滚，产生了双份数据，其中前面插入的一份是垃圾。</div><div>另外，代码会变的很繁琐。</div><div>所以我们可以略微改进一下。</div><div><br></div><div><span style="line-height: 28px;"   >2. 把每个分段作为一个子函数，正常返回true，异常返回false，在函数中调用这些子函数来实现分段来规避上面的问题。</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace function subf1() returns boolean as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp;&nbsp;<span style="line-height: 28px;"   >insert into tbl values(1);</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   >&nbsp; --&nbsp;</span><span style="line-height: 28px;"   >以及其他需要放一起提交的SQL</span><span style="line-height: 28px;"   >和逻辑</span></font></div><div><span style="line-height: 28px;"   ><font size="2"   >&nbsp; return true;</font></span></div><div><font size="2"   >exception when others then</font></div><div><font size="2"   >&nbsp; return false;</font></div><div><font size="2"   >end;&nbsp;</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div><div><font size="2"   ><br></font></div><div><div style="line-height: 28px;"   ><font size="2"   >create or replace function subf2() returns boolean as $$</font></div><div style="line-height: 28px;"   ><font size="2"   >declare</font></div><div style="line-height: 28px;"   ><font size="2"   >begin</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;&nbsp;<span style="line-height: 28px;"   >insert into tbl values(2);</span></font></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >&nbsp; -- 以及其他需要放一起提交的SQL和逻辑</font></span></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >&nbsp; return true;</font></span></div><div style="line-height: 28px;"   ><font size="2"   >exception when others then</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; return false;</font></div><div style="line-height: 28px;"   ><font size="2"   >end;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >$$ language plpgsql strict;</font></div></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >create or replace function subf3() returns boolean as $$</font></div><div style="line-height: 28px;"   ><font size="2"   >declare</font></div><div style="line-height: 28px;"   ><font size="2"   >begin</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;&nbsp;<span style="line-height: 28px;"   >insert into tbl values(3);</span></font></div><div style="line-height: 28px;"   ><font size="2"   ><span style="line-height: 28px;"   >&nbsp; -- 以及其他需要放一起提交的SQL</span><span style="line-height: 28px;"   >和逻辑</span></font></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >&nbsp; return true;</font></span></div><div style="line-height: 28px;"   ><font size="2"   >exception when others then</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; return false;</font></div><div style="line-height: 28px;"   ><font size="2"   >end;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >$$ language plpgsql strict;</font></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >create or replace function subf4() returns boolean as $$</font></div><div style="line-height: 28px;"   ><font size="2"   >declare</font></div><div style="line-height: 28px;"   ><font size="2"   >begin</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;&nbsp;<span style="line-height: 28px;"   >insert into tbl values(3);</span></font></div><div style="line-height: 28px;"   ><font size="2"   ><span style="line-height: 28px;"   >&nbsp; -- 以及其他需要放一起提交的SQL</span><span style="line-height: 28px;"   >和逻辑</span></font></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >&nbsp; return true;</font></span></div><div style="line-height: 28px;"   ><font size="2"   >exception when others then</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; return false;</font></div><div style="line-height: 28px;"   ><font size="2"   >end;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >$$ language plpgsql strict;</font></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >create or replace function func1() returns void as $$</font></div><div style="line-height: 28px;"   ><font size="2"   >declare</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; v_stat boolean;</font></div><div style="line-height: 28px;"   ><font size="2"   >begin</font></div><div style="line-height: 28px;"   ><font size="2"   >-- &nbsp;模拟分段1</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; select subf1() into v_stat;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; if not v_stat then&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; return;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; end if;</font></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >-- &nbsp;模拟分段2</font></span></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >&nbsp; select subf2() into v_stat;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; if not v_stat then&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; return;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; end if;</font></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >-- &nbsp;模拟分段3</font></span></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >&nbsp; select subf3() into v_stat;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; if not v_stat then&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; return;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; end if;</font></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >-- &nbsp;模拟分段4</font></span></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >&nbsp; select subf4() into v_stat;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; if not v_stat then&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; return;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; end if;</font></div><div style="line-height: 28px;"   ><font size="2"   >return;</font></div></div></div></div><div style="line-height: 28px;"   ><font size="2"   >end;</font></div><div style="line-height: 28px;"   ><font size="2"   >$$ language plpgsql;</font></div></div></div></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# truncate tbl;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >postgres=# select func1();</font></div><div><font size="2"   >&nbsp;func1&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select ctid,* from tbl;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| id | info&nbsp;</font></div><div><font size="2"   >-------+----+------</font></div><div><font size="2"   >&nbsp;(0,1) | &nbsp;1 |&nbsp;</font></div><div><font size="2"   >&nbsp;(0,2) | &nbsp;2 |&nbsp;</font></div><div><font size="2"   >&nbsp;(0,3) | &nbsp;3 |&nbsp;</font></div><div><font size="2"   >(3 rows)</font></div></div><p></p></pre></div><div>现在正常了，不会产生双份垃圾。</div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL partial/sub commit within function - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>