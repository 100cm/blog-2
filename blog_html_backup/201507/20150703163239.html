<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">useful function & operator & custom operator for Row and Array Comparisons</h2>
	<h5 id="">2015-07-03 16:32:39&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402015634612152/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>社区里一位同学的需求：</div><div><div>请问 &nbsp; 有什么办法可以判断 ，一个数组里面至少一个元素在一个范围之间？</div><pre class="prettyprint"   ><p></p><div><font size="2"   >select 1 &lt;= any(ARRAY[0.8,3.2]) and 3 &gt;= any(ARRAY[0.8,3.2])</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >例如，这个，我喜欢的结果是f</span></div></div><div><br></div><div>我们注意一下，这个SQL实际上返回的是TRUE，因为分开来看<span style="line-height: 28px;"   >1 &lt;= any(ARRAY[0.8,3.2])返回的是true,&nbsp;</span><span style="line-height: 28px;"   >3 &gt;= any(ARRAY[0.8,3.2])返回的也是ture, 所以这个SQL返回的意思TRUE。</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select 1 &lt;= any(ARRAY[0.8,3.2]) and 3 &gt;= any(ARRAY[0.8,3.2]);</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;t</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>所以这个SQL不能满足用户的需求，而需要使用这个数组中的每个对象和1,3对比，然后再使用bool_or聚合结果。</div><div>例如：</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select 1 &lt;= i and 3&gt;=i from unnest(ARRAY[0.8,3.2]) t(i);</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;f</font></div><div><font size="2"   >&nbsp;f</font></div><div><font size="2"   >(2 rows)</font></div></div><div><div><font size="2"   >postgres=# select bool_or(1 &lt;= i and 3&gt;=i) from unnest(ARRAY[0.8,3.2]) t(i);</font></div><div><font size="2"   >&nbsp;bool_or&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;f</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>当然还有更好的方法，那就是用范围类型和ANY构造。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select '[1,3]'::numrange @&gt; any(array[0.8,3.1]);</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;f</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>如果你的系统不支持范围类型，则可以自定义一个函数来实现它，输入为数组以及两个数字，返回值为布尔逻辑值。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create or replace function f_cmp(a _numeric,b numeric,c numeric) returns boolean as $$</font></div><div><font size="2"   >declare&nbsp;</font></div><div><font size="2"   >&nbsp; res boolean := false;&nbsp;</font></div><div><font size="2"   >&nbsp; i numeric;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; FOREACH i in ARRAY a LOOP</font></div><div><font size="2"   >&nbsp; &nbsp; res := (i between b and c) or (i between c and b) or res;&nbsp;</font></div><div><font size="2"   >&nbsp; END LOOP;</font></div><div><font size="2"   >&nbsp; return res;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select f_cmp(array[0.8,3.1],1,3);</font></div><div><font size="2"   >&nbsp;f_cmp&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;f</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>我之前写过一个类似的例子, 模糊匹配数组中的元素。</div><wbr><div><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014311115528330/"   >http://blog.163.com/digoal@126/blog/static/1638770402014311115528330/</a></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014311115528330/"   >http://blog.163.com/digoal@126/blog/static/1638770402014311115528330/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/functions-range.html"   >http://www.postgresql.org/docs/9.4/static/functions-range.html</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/functions-comparisons.html"   >http://www.postgresql.org/docs/9.4/static/functions-comparisons.html</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="useful function  operator  custom operator for Row and Array Comparisons - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>