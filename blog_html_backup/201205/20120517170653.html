<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.2 NEW Type, range</h2>
	<h5 id="">2012-05-17 17:06:53&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020124174238681/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">PostgreSQL 9.2 新增了一种类型, range, 也就是范围。<div>注意range类型必须包含subtype, 例如int4的range类型叫int4range.</div><div>例如1,2,3,4,5作为int4range类型可以写成'(0,6)'::int4range 或&nbsp;<span style="line-height: 22px;"  >'[1,6)'::int4range 或&nbsp;</span><span style="line-height: 22px;"  >'[1,5]'::int4range 或&nbsp;</span><span style="line-height: 22px;"  >'(0,5]'::int4range</span></div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select '(0,6)'::int4range;</font></div><div><font size="2"  >&nbsp;int4range&nbsp;</font></div><div><font size="2"  >-----------</font></div><div><font size="2"  >&nbsp;[1,6)</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# select '[1,6)'::int4range;</font></div><div><font size="2"  >&nbsp;int4range&nbsp;</font></div><div><font size="2"  >-----------</font></div><div><font size="2"  >&nbsp;[1,6)</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# select '[1,5]'::int4range;</font></div><div><font size="2"  >&nbsp;int4range&nbsp;</font></div><div><font size="2"  >-----------</font></div><div><font size="2"  >&nbsp;[1,6)</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# select '(0,5]'::int4range;</font></div><div><font size="2"  >&nbsp;int4range&nbsp;</font></div><div><font size="2"  >-----------</font></div><div><font size="2"  >&nbsp;[1,6)</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>&nbsp;注意到稀疏类型的range类型, 内部存储的都是[).</div></div><div>中括号表示包含, 大括号表示不包含.</div><div>稀疏类型的range类型必须定义CANONICAL函数, 用来转换成[)格式的存储.</div><div>稀疏类型可以理解为知道一个值的前一个值和后一个值是多少，例如INT类型的1的后面是2，前面是0.</div><div>但是如果numeric的话,1的前面就不知道是多少了(0.9999999999..无穷...)，后面也不知道(1.00000000....无穷.1) 。</div><div>但是对于连续类型的range类型, 内部存储则是精确存储的， 例如.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select '(0,5]'::numrange;</font></div><div><font size="2"  >&nbsp;numrange&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;(0,5]</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# select '[0,5]'::numrange;</font></div><div><font size="2"  >&nbsp;numrange&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;[0,5]</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# select '[0,5)'::numrange;</font></div><div><font size="2"  >&nbsp;numrange&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;[0,5)</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# select '(0,5)'::numrange;</font></div><div><font size="2"  >&nbsp;numrange&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;(0,5)</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>PostgreSQL range类型提供了几个很好的功能, 例如包含，不包含，交叉等等。</div><div>系统自定义的range类型有</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >INT4RANGE ― Range of INTEGER</font></div><div><font size="2"  >INT8RANGE ― Range of BIGINT</font></div><div><font size="2"  >NUMRANGE ― Range of NUMERIC</font></div><div><font size="2"  >TSRANGE ― Range of TIMESTAMP WITHOUT TIME ZONE</font></div><div><font size="2"  >TSTZRANGE ― Range of TIMESTAMP WITH TIME ZONE</font></div><div><font size="2"  >DATERANGE ― Range of DATE</font></div><p></p></pre></div><div>系统表里面能查到的如下 :</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select oid ,typname from pg_type where typname ~ 'range';</font></div><div><font size="2"  >&nbsp; oid &nbsp;| &nbsp;typname &nbsp;&nbsp;</font></div><div><font size="2"  >-------+------------</font></div><div><font size="2"  >&nbsp; 3904 | int4range</font></div><div><font size="2"  >&nbsp; 3905 | _int4range</font></div><div><font size="2"  >&nbsp; 3906 | numrange</font></div><div><font size="2"  >&nbsp; 3907 | _numrange</font></div><div><font size="2"  >&nbsp; 3908 | tsrange</font></div><div><font size="2"  >&nbsp; 3909 | _tsrange</font></div><div><font size="2"  >&nbsp; 3910 | tstzrange</font></div><div><font size="2"  >&nbsp; 3911 | _tstzrange</font></div><div><font size="2"  >&nbsp; 3912 | daterange</font></div><div><font size="2"  >&nbsp; 3913 | _daterange</font></div><div><font size="2"  >&nbsp; 3926 | int8range</font></div><div><font size="2"  >&nbsp; 3927 | _int8range</font></div><div><font size="2"  >&nbsp; 3831 | anyrange</font></div><div><font size="2"  >&nbsp;11026 | pg_range</font></div><p></p></pre></div><div>再来看一下有哪些函数和anyrange类型相关, 简单的介绍一下.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select proname,proargtypes from pg_proc where proargtypes::text ~ '3831';</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;proname &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; proargtypes &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >-------------------------+----------------------</font></div><div><font size="2"  >&nbsp;anyrange_out &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3831</font></div><div><font size="2"  >&nbsp;range_out &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 3831</font></div><div><font size="2"  >&nbsp;range_send &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3831</font></div><div><font size="2"  >&nbsp;lower &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 3831 &nbsp; -- 这个range的底部的值,&nbsp;<span style="line-height: 22px;"  >稀疏和连续类型有区别. 见例子</span></font></div><div><font size="2"  >&nbsp;upper &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 3831 &nbsp;-- 这个range的顶部的值, 稀疏和连续类型有区别. 见例子</font></div><div><font size="2"  >&nbsp;isempty &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 3831 &nbsp;-- 这个range里面是否不包含任何元素</font></div><div><font size="2"  >&nbsp;lower_inc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 3831 &nbsp;-- 低位是否是包含的.&nbsp;<span style="line-height: 22px;"  >,&nbsp;</span><span style="line-height: 22px;"  >稀疏和连续类型有区别. 见例子</span></font></div><div><font size="2"  >&nbsp;upper_inc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 3831 &nbsp;-- 高位是否是包含的.&nbsp;<span style="line-height: 22px;"  >,&nbsp;</span><span style="line-height: 22px;"  >稀疏和连续类型有区别. 见例子</span></font></div><div><font size="2"  >&nbsp;lower_inf &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 3831 &nbsp;-- 低位是否是无穷小. (注意这里指的不是subtype的无穷类型, 而是未定义低位的意思. 见例子)</font></div><div><font size="2"  >&nbsp;upper_inf &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 3831 &nbsp;-- 高位是否是无穷大.<span style="line-height: 22px;"  >&nbsp;</span><span style="line-height: 22px;"  >(注意这里指的不是subtype的无穷类型, 而是未定义高位的意思. 见例子)</span></font></div><div><font size="2"  >&nbsp;range_eq &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3831 3831</font></div><div><font size="2"  >&nbsp;range_ne &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3831 3831</font></div><div><font size="2"  >&nbsp;range_overlaps &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3831 3831</font></div><div><font size="2"  >&nbsp;range_contains_elem &nbsp; &nbsp; | 3831 2283</font></div><div><font size="2"  >&nbsp;range_contains &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3831 3831</font></div><div><font size="2"  >&nbsp;elem_contained_by_range | 2283 3831</font></div><div><font size="2"  >&nbsp;range_contained_by &nbsp; &nbsp; &nbsp;| 3831 3831</font></div><div><font size="2"  >&nbsp;range_adjacent &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3831 3831</font></div><div><font size="2"  >&nbsp;range_before &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3831 3831</font></div><div><font size="2"  >&nbsp;range_after &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 3831 3831</font></div><div><font size="2"  >&nbsp;range_overleft &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3831 3831</font></div><div><font size="2"  >&nbsp;range_overright &nbsp; &nbsp; &nbsp; &nbsp; | 3831 3831</font></div><div><font size="2"  >&nbsp;range_union &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 3831 3831</font></div><div><font size="2"  >&nbsp;range_intersect &nbsp; &nbsp; &nbsp; &nbsp; | 3831 3831</font></div><div><font size="2"  >&nbsp;range_minus &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 3831 3831</font></div><div><font size="2"  >&nbsp;range_cmp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 3831 3831</font></div><div><font size="2"  >&nbsp;range_lt &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3831 3831</font></div><div><font size="2"  >&nbsp;range_le &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3831 3831</font></div><div><font size="2"  >&nbsp;range_ge &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3831 3831</font></div><div><font size="2"  >&nbsp;range_gt &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3831 3831</font></div><div><font size="2"  >&nbsp;range_gist_consistent &nbsp; | 2281 3831 23 26 2281</font></div><div><font size="2"  >&nbsp;range_gist_same &nbsp; &nbsp; &nbsp; &nbsp; | 3831 3831 2281</font></div><div><font size="2"  >&nbsp;hash_range &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3831</font></div><p></p></pre></div><div>相关的操作符如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select oprname from pg_operator where oprleft=3831 or oprright=3831;</font></div><div><font size="2"  >&nbsp;oprname&nbsp;</font></div><div><font size="2"  >---------</font></div><div><font size="2"  >&nbsp;=</font></div><div><font size="2"  >&nbsp;&lt;&gt;</font></div><div><font size="2"  >&nbsp;&lt;</font></div><div><font size="2"  >&nbsp;&lt;=</font></div><div><font size="2"  >&nbsp;&gt;=</font></div><div><font size="2"  >&nbsp;&gt;</font></div><div><font size="2"  >&nbsp;&amp;&amp;</font></div><div><font size="2"  >&nbsp;@&gt;</font></div><div><font size="2"  >&nbsp;@&gt;</font></div><div><font size="2"  >&nbsp;&lt;@</font></div><div><font size="2"  >&nbsp;&lt;@</font></div><div><font size="2"  >&nbsp;&lt;&lt;</font></div><div><font size="2"  >&nbsp;&gt;&gt;</font></div><div><font size="2"  >&nbsp;&amp;&lt;</font></div><div><font size="2"  >&nbsp;&amp;&gt;</font></div><div><font size="2"  >&nbsp;-|-</font></div><div><font size="2"  >&nbsp;+</font></div><div><font size="2"  >&nbsp;-</font></div><div><font size="2"  >&nbsp;*</font></div><p></p></pre></div><div>接下来看个内置range类型的使用例子 :</div><div>创建测试表</div><div><pre class="prettyprint"  ><p><font size="2"  >digoal=# CREATE TABLE reservation ( room int, during TSRANGE );</font></p></pre></div><div>插入以timestamp为subtype的range类型的测试数据</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# INSERT INTO reservation VALUES</font></div><div><font size="2"  >digoal-# &nbsp; ( 1108, '[2010-01-01 14:30, 2010-01-01 15:30)' );</font></div><div><font size="2"  >INSERT 0 1</font></div><p></p></pre></div><div>@&gt;判断是否包含</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# SELECT int4range(10, 20) @&gt; 3;</font></div><div><font size="2"  >&nbsp;?column?&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;f</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>&amp;&amp; 判断两个range是否有交叉</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# SELECT numrange(11.1, 22.2) &amp;&amp; numrange(20.0, 30.0);</font></div><div><font size="2"  >&nbsp;?column?&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;t</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>upper查出顶端, int8range也是个稀疏range</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# SELECT upper(int8range(15, 25));</font></div><div><font size="2"  >&nbsp;upper&nbsp;</font></div><div><font size="2"  >-------</font></div><div><font size="2"  >&nbsp; &nbsp; 25</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>使用numrange, 连续range查顶端, 与它一致.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# SELECT upper(numrange(15, 25));</font></div><div><font size="2"  >&nbsp;upper&nbsp;</font></div><div><font size="2"  >-------</font></div><div><font size="2"  >&nbsp; &nbsp; 25</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>换种写法可能更好理解, 稀疏输出的是不包含的顶端.换句话说是转换成 [) 后的里面的顶端和底部对应的值.</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# SELECT upper('(15,25)'::int8range);</font></div><div><font size="2"  >&nbsp;upper&nbsp;</font></div><div><font size="2"  >-------</font></div><div><font size="2"  >&nbsp; &nbsp; 25</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=# SELECT upper('(15,25]'::int8range);</font></div><div><font size="2"  >&nbsp;upper&nbsp;</font></div><div><font size="2"  >-------</font></div><div><font size="2"  >&nbsp; &nbsp; 26</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>连续range, 输入是什么样子的就是什么样子的.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# SELECT upper('(15,25]'::numrange);</font></div><div><font size="2"  >&nbsp;upper&nbsp;</font></div><div><font size="2"  >-------</font></div><div><font size="2"  >&nbsp; &nbsp; 25</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=# SELECT upper('(15,25)'::numrange);</font></div><div><font size="2"  >&nbsp;upper&nbsp;</font></div><div><font size="2"  >-------</font></div><div><font size="2"  >&nbsp; &nbsp; 25</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div></div><div>*符号输出两个range的交叉部分.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# SELECT int4range(10, 20) * int4range(15, 25);</font></div><div><font size="2"  >&nbsp;?column?&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;[15,20)</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>isempty函数输出range是否为空</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# SELECT isempty(numrange(1, 5));</font></div><div><font size="2"  >&nbsp;isempty&nbsp;</font></div><div><font size="2"  >---------</font></div><div><font size="2"  >&nbsp;f</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >isempty函数输出range是否为空</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# SELECT isempty(numrange(1, 1));</font></div><div><font size="2"  >&nbsp;isempty&nbsp;</font></div><div><font size="2"  >---------</font></div><div><font size="2"  >&nbsp;t</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>接下来介绍一下无穷大.</div><div>以下为例子</div><div>表示从now到无穷大的时间范围。</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# SELECT '(now,)'::tsrange;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tsrange &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >---------------------------------</font></div><div><font size="2"  >&nbsp;("2012-05-17 16:32:43.055233",)</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>表示从无穷小到无穷大的时间范围。</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# SELECT '(,)'::tsrange;</font></div><div><font size="2"  >&nbsp;tsrange&nbsp;</font></div><div><font size="2"  >---------</font></div><div><font size="2"  >&nbsp;(,)</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>从无穷小到now的时间范围.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# SELECT '(,now)'::tsrange;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tsrange &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >---------------------------------</font></div><div><font size="2"  >&nbsp;(,"2012-05-17 16:32:55.800172")</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div></div><div><br></div><div><br></div><div>接下来介绍一下range类型的输入格式:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >(lower-bound,upper-bound)</font></div><div><font size="2"  >(lower-bound,upper-bound]</font></div><div><font size="2"  >[lower-bound,upper-bound)</font></div><div><font size="2"  >[lower-bound,upper-bound]</font></div><div><font size="2"  >empty</font></div><p></p></pre></div><div>举个例子, 以下表示这个range为空.没有任何元素.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# SELECT 'empty'::tsrange;</font></div><div><font size="2"  >&nbsp;tsrange&nbsp;</font></div><div><font size="2"  >---------</font></div><div><font size="2"  >&nbsp;empty</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>接下来讲讲range类型的构造器函数, 这个函数的名字和range类型的名字一致, 带3个参数, 分别是底部值，顶部值，边界格式如( [], (], (), [) ).</div><div>例如int4range的构造器函数也叫int4range.</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=# select int4range(1,2,'()');</font></div><div><font size="2"  >&nbsp;int4range&nbsp;</font></div><div><font size="2"  >-----------</font></div><div><font size="2"  >&nbsp;empty</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=# select int4range(1,2,'(]');</font></div><div><font size="2"  >&nbsp;int4range&nbsp;</font></div><div><font size="2"  >-----------</font></div><div><font size="2"  >&nbsp;[2,3)</font></div><div><font size="2"  >(1 row)</font></div></div><div><font size="2"  ><br></font></div><div><div><font size="2"  >digoal=# select int4range(null,2,'(]');</font></div><div><font size="2"  >&nbsp;int4range&nbsp;</font></div><div><font size="2"  >-----------</font></div><div><font size="2"  >&nbsp;(,3)</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div>自建range类型也会自动创建同名的构造器函数 ， 如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# create type iprange as range (subtype=inet);</font></div><div><font size="2"  >CREATE TYPE</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=# select iprange('1.1.1.1'::inet,null);</font></div><div><font size="2"  >&nbsp; iprange &nbsp;&nbsp;</font></div><div><font size="2"  >------------</font></div><div><font size="2"  >&nbsp;[1.1.1.1,)</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>我们来看看创建range类型的语法:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >CREATE TYPE name AS RANGE (</font></div><div><font size="2"  >&nbsp; &nbsp; SUBTYPE = subtype</font></div><div><font size="2"  >&nbsp; &nbsp; [ , SUBTYPE_OPCLASS = subtype_operator_class ]</font></div><div><font size="2"  >&nbsp; &nbsp; [ , COLLATION = collation ]</font></div><div><font size="2"  >&nbsp; &nbsp; [ , CANONICAL = canonical_function ]</font></div><div><font size="2"  >&nbsp; &nbsp; [ , SUBTYPE_DIFF = subtype_diff_function ]</font></div><div><font size="2"  >)</font></div><p></p></pre></div><div>这里不多解释,&nbsp;<span style="line-height: 22px;"  >subtype_diff_function是用来提高gist索引的查询性能的,&nbsp;</span><span style="line-height: 22px;"  >canonical_function是用来定义稀疏range类型的.</span></div><div><span style="line-height: 22px;"  ><br></span></div><div><span style="line-height: 22px;"  >接下来我们在range类型上使用gist索引加速查询和某些特殊场景.</span></div><div><pre class="prettyprint"  ><p><font size="2"  ><span style="font-family: verdana, sans-serif; line-height: 18px;"  >A GiST index can accelerate queries involving these range operators:&nbsp;</span><tt style="line-height: 18px;"  >=</tt><span style="font-family: verdana, sans-serif; line-height: 18px;"  >,&nbsp;</span><tt style="line-height: 18px;"  >&amp;&amp;</tt><span style="font-family: verdana, sans-serif; line-height: 18px;"  >,&nbsp;</span><tt style="line-height: 18px;"  >&lt;@</tt><span style="font-family: verdana, sans-serif; line-height: 18px;"  >,&nbsp;</span><tt style="line-height: 18px;"  >@&gt;</tt><span style="font-family: verdana, sans-serif; line-height: 18px;"  >,&nbsp;</span><tt style="line-height: 18px;"  >&lt;&lt;</tt><span style="font-family: verdana, sans-serif; line-height: 18px;"  >,&nbsp;</span><tt style="line-height: 18px;"  >&gt;&gt;</tt><span style="font-family: verdana, sans-serif; line-height: 18px;"  >,&nbsp;</span><tt style="line-height: 18px;"  >-|-</tt><span style="font-family: verdana, sans-serif; line-height: 18px;"  >,&nbsp;</span><tt style="line-height: 18px;"  >&amp;&lt;</tt><span style="font-family: verdana, sans-serif; line-height: 18px;"  >, and&nbsp;</span><tt style="line-height: 18px;"  >&amp;&gt;</tt></font></p></pre></div><div>注意range类型不适合使用btree索引和hash索引.&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=# CREATE INDEX reservation_idx ON reservation USING gist (during);</font></div><div><font size="2"  >CREATE INDEX</font></div><div><font size="2"  >digoal=# \d reservation</font></div><div><font size="2"  >&nbsp; Table "public.reservation"</font></div><div><font size="2"  >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"  >--------+---------+-----------</font></div><div><font size="2"  >&nbsp;room &nbsp; | integer |&nbsp;</font></div><div><font size="2"  >&nbsp;during | tsrange |&nbsp;</font></div><div><font size="2"  >Indexes:</font></div><div><font size="2"  >&nbsp; &nbsp; "reservation_idx" gist (during)</font></div></div><div><div><font size="2"  >digoal=# insert into reservation values (1,'(,now)'::tsrange);</font></div><div><font size="2"  >INSERT 0 1</font></div></div><div><font size="2"  ><br></font></div><div><div><font size="2"  >digoal=# select * from reservation ;</font></div><div><font size="2"  >&nbsp;room | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;during &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >------+-----------------------------------------------</font></div><div><font size="2"  >&nbsp;1108 | ["2010-01-01 14:30:00","2010-01-01 15:30:00")</font></div><div><font size="2"  >&nbsp; &nbsp; 1 | (,"2012-05-17 16:49:13.40783")</font></div><div><font size="2"  >(2 rows)</font></div></div><div><font size="2"  ><br></font></div><div><div><font size="2"  >digoal=# explain select * from reservation where during @&gt; '[now,now]'::tsrange;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Seq Scan on reservation &nbsp;(cost=0.00..1.01 rows=1 width=36)</font></div><div><font size="2"  >&nbsp; &nbsp;Filter: (during @&gt; '["2012-05-17 16:50:18.794268","2012-05-17 16:50:18.794268"]'::tsrange)</font></div><div><font size="2"  >(2 rows)</font></div></div><p></p></pre></div><div>&nbsp;记录数太少，没走索引，接下来我们强制让它走索引.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# set enable_seqscan=off;</font></div><div><font size="2"  >SET</font></div><div><font size="2"  >digoal=# explain select * from reservation where during @&gt; '[now,now]'::tsrange;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >--------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Index Scan using reservation_idx on reservation &nbsp;(cost=0.00..8.27 rows=1 width=36)</font></div><div><font size="2"  >&nbsp; &nbsp;Index Cond: (during @&gt; '["2012-05-17 16:50:59.716661","2012-05-17 16:50:59.716661"]'::tsrange)</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div><br></div><div>除此之外，还可以使用exclude约束, 这个在PG DBA2000培训中也讲过，</div><div>可以参考</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020124793313702/"  >http://blog.163.com/digoal@126/blog/static/16387704020124793313702/</a> </div><div><br></div><div>接下来举个range中使用exclude约束的例子:</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# delete from reservation ;</font></div><div><font size="2"  >DELETE 2</font></div><p></p></pre></div><div>-- 以下约束表示, 不允许during 存储的时间上有交叉</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=# ALTER TABLE reservation</font></div><div><font size="2"  >digoal-# &nbsp; ADD EXCLUDE USING gist (during WITH &amp;&amp;);</font></div><div><font size="2"  >NOTICE: &nbsp;ALTER TABLE / ADD EXCLUDE will create implicit index "reservation_during_excl" for table "reservation"</font></div><div><font size="2"  >ALTER TABLE</font></div></div><div><font size="2"  ><br></font></div><div><div><font size="2"  >digoal=# INSERT INTO reservation VALUES</font></div><div><font size="2"  >&nbsp; ( 1108, '[2010-01-01 11:30, 2010-01-01 13:00)' );</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  ><span style="line-height: 19px;"  >-- 因为时间上有交叉, 所以插入不成功.</span></font></div><div><font size="2"  >digoal=# INSERT INTO reservation VALUES</font></div><div><font size="2"  >&nbsp; ( 1108, '[2010-01-01 11:45, 2010-01-01 15:45)' );</font></div><div><font size="2"  >ERROR: &nbsp;conflicting key value violates exclusion constraint "reservation_during_excl"</font></div><div><font size="2"  >DETAIL: &nbsp;Key (during)=(["2010-01-01 11:45:00","2010-01-01 15:45:00")) conflicts with existing key (during)=(["2010-01-01 11:30:00","2010-01-01 13:00:00")).</font></div><div><font size="2"  >STATEMENT: &nbsp;INSERT INTO reservation VALUES</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ( 1108, '[2010-01-01 11:45, 2010-01-01 15:45)' );</font></div><div><font size="2"  >ERROR: &nbsp;conflicting key value violates exclusion constraint "reservation_during_excl"</font></div><div><font size="2"  >DETAIL: &nbsp;Key (during)=(["2010-01-01 11:45:00","2010-01-01 15:45:00")) conflicts with existing key (during)=(["2010-01-01 11:30:00","2010-01-01 13:00:00")).</font></div></div><p></p></pre></div></div><div><br></div><div>还可以安装btree_gist 模块, 加强exclude约束的功能.</div><div>例如，我现在没有安装btree_gist模块, 在int类型的列上使用gist索引则不成功.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >-- 没有安装btree_gist模块时, int列上不允许创建gist索引, 所以以下SQL返回错误.</font></div><div><font size="2"  >digoal=# ALTER TABLE reservation &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp; ADD EXCLUDE USING gist (room WITH =, during WITH &amp;&amp;);</font></div><div><font size="2"  >ERROR: &nbsp;data type integer has no default operator class for access method "gist"</font></div><div><font size="2"  >HINT: &nbsp;You must specify an operator class for the index or define a default operator class for the data type.</font></div><div><font size="2"  >STATEMENT: &nbsp;ALTER TABLE reservation</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ADD EXCLUDE USING gist (room WITH =, during WITH &amp;&amp;);</font></div><div><font size="2"  >ERROR: &nbsp;data type integer has no default operator class for access method "gist"</font></div><div><font size="2"  >HINT: &nbsp;You must specify an operator class for the index or define a default operator class for the data type.</font></div><p></p></pre></div><div>加载btree_gist模块重试上面的SQL.成功。</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# create extension btree_gist;</font></div><div><font size="2"  >CREATE EXTENSION</font></div><div><font size="2"  >digoal=# ALTER TABLE reservation &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp; ADD EXCLUDE USING gist (room WITH =, during WITH &amp;&amp;);</font></div><div><font size="2"  >NOTICE: &nbsp;ALTER TABLE / ADD EXCLUDE will create implicit index "reservation_room_during_excl" for table "reservation"</font></div><div><font size="2"  >ALTER TABLE</font></div><p></p></pre></div><div>这个时候排除了room相等并且during字段上存在交叉的记录插入.</div><div>例如,</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# CREATE TABLE room_reservation</font></div><div><font size="2"  >digoal-# (</font></div><div><font size="2"  >digoal(# &nbsp; room TEXT,</font></div><div><font size="2"  >digoal(# &nbsp; during TSRANGE,</font></div><div><font size="2"  >digoal(# &nbsp; EXCLUDE USING gist (room WITH =, during WITH &amp;&amp;)</font></div><div><font size="2"  >digoal(# );</font></div><div><font size="2"  >NOTICE: &nbsp;CREATE TABLE / EXCLUDE will create implicit index "room_reservation_room_during_excl" for table "room_reservation"</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >digoal=# INSERT INTO room_reservation VALUES</font></div><div><font size="2"  >digoal-# &nbsp; ( '123A', '[2010-01-01 14:00, 2010-01-01 15:00)' );</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=# INSERT INTO room_reservation VALUES</font></div><div><font size="2"  >digoal-# &nbsp; ( '123A', '[2010-01-01 14:30, 2010-01-01 15:30)' );</font></div><div><font size="2"  >ERROR: &nbsp;conflicting key value violates exclusion constraint "room_reservation_room_during_excl"</font></div><div><font size="2"  >DETAIL: &nbsp;Key (room, during)=(123A, ["2010-01-01 14:30:00","2010-01-01 15:30:00")) conflicts with existing key (room, during)=(123A, ["2010-01-01 14:00:00","2010-01-01 15:00:00")).</font></div><div><font size="2"  >STATEMENT: &nbsp;INSERT INTO room_reservation VALUES</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ( '123A', '[2010-01-01 14:30, 2010-01-01 15:30)' );</font></div><div><font size="2"  >ERROR: &nbsp;conflicting key value violates exclusion constraint "room_reservation_room_during_excl"</font></div><div><font size="2"  >DETAIL: &nbsp;Key (room, during)=(123A, ["2010-01-01 14:30:00","2010-01-01 15:30:00")) conflicts with existing key (room, during)=(123A, ["2010-01-01 14:00:00","2010-01-01 15:00:00")).</font></div><div><font size="2"  >digoal=# INSERT INTO room_reservation VALUES</font></div><div><font size="2"  >digoal-# &nbsp; ( '123B', '[2010-01-01 14:30, 2010-01-01 15:30)' );</font></div><div><font size="2"  >INSERT 0 1</font></div><p></p></pre></div><div>btree_gist类型支持的类型如下 :&nbsp;</div><div>下次介绍btree_gist索引, 它是一个很有趣的索引.</div><div>int2, int4, int8, float4, float8, numeric, timestamp with time zone, timestamp without time zone, time with time zone, time without time zone, date, interval, oid, money, char, varchar, text, bytea, bit, varbit, macaddr, inet, and cidr.</div><div><br></div><div>【参考】</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/rangetypes.html"  >http://www.postgresql.org/docs/9.2/static/rangetypes.html</a> </div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/btree-gist.html"  >http://www.postgresql.org/docs/9.2/static/btree-gist.html</a> </div><br><div>【其他】</div><div>9.1以前有个temporal模块, 可以实现和tsrange类似的功能, 如下</div><div><a rel="nofollow" href="https://www.pgcon.org/2009/schedule/events/151.en.html"  >https://www.pgcon.org/2009/schedule/events/151.en.html</a> </div><div><a rel="nofollow" href="https://github.com/jeff-davis/PostgreSQL-Temporal"  >https://github.com/jeff-davis/PostgreSQL-Temporal</a> </div><div><a rel="nofollow" href="http://www.pgxn.org/dist/temporal/"  >http://www.pgxn.org/dist/temporal/</a> </div></div>
	</div>
</div>
</body>
</html>