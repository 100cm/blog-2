<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL distinct on and window function row_number() usage</h2>
	<h5 id="">2012-05-23 10:20:01&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020124239390354/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前段时间的PGDBA2000培训中讲过的一个例子, 取一个班级中各门学科成绩的第一名的信息.</div><div>很多场景适用, 因此摘录出来.</div><div>例子 :&nbsp;</div><div>测试表</div><div><pre class="prettyprint"  ><p><font size="2"  >create table std_score (username text,subject text,score numeric);</font></p></pre></div><div><br></div><div>测试数据</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >insert into std_score values('刘德华','数学',95.5);</font></div><div><font size="2"  >insert into std_score values('刘德华','语文',85.5);</font></div><div><font size="2"  >insert into std_score values('刘德华','英语',99.5);</font></div><div><font size="2"  >insert into std_score values('刘德华','物理',79.5);</font></div><div><font size="2"  >insert into std_score values('刘德华','化学',79.5);</font></div><div><font size="2"  >insert into std_score values('张学友','数学',94.5);</font></div><div><font size="2"  >insert into std_score values('张学友','语文',84.5);</font></div><div><font size="2"  >insert into std_score values('张学友','英语',94.5);</font></div><div><font size="2"  >insert into std_score values('张学友','物理',74.5);</font></div><div><font size="2"  >insert into std_score values('张学友','化学',74.5);</font></div><div><font size="2"  >insert into std_score values('黎明','数学',96.5);</font></div><div><font size="2"  >insert into std_score values('黎明','语文',85.5);</font></div><div><font size="2"  >insert into std_score values('黎明','英语',98.5);</font></div><div><font size="2"  >insert into std_score values('黎明','物理',89.5);</font></div><div><font size="2"  >insert into std_score values('黎明','化学',69.5);</font></div><div><font size="2"  >insert into std_score values('李连杰','数学',75.5);</font></div><div><font size="2"  >insert into std_score values('李连杰','语文',95.5);</font></div><div><font size="2"  >insert into std_score values('李连杰','英语',79.5);</font></div><div><font size="2"  >insert into std_score values('李连杰','物理',89.5);</font></div><div><font size="2"  >insert into std_score values('李连杰','化学',99.5);</font></div><div><font size="2"  >insert into std_score values('郭富城','数学',91.5);</font></div><div><font size="2"  >insert into std_score values('郭富城','语文',82.5);</font></div><div><font size="2"  >insert into std_score values('郭富城','英语',93.5);</font></div><div><font size="2"  >insert into std_score values('郭富城','物理',69.5);</font></div><div><font size="2"  >insert into std_score values('郭富城','化学',69.5);</font></div><div><font size="2"  >insert into std_score values('叶孤城','数学',99.5);</font></div><div><font size="2"  >insert into std_score values('叶孤城','语文',82.5);</font></div><div><font size="2"  >insert into std_score values('叶孤城','英语',69.5);</font></div><div><font size="2"  >insert into std_score values('叶孤城','物理',89.5);</font></div><div><font size="2"  >insert into std_score values('叶孤城','化学',99.5);</font></div><div><font size="2"  >insert into std_score values('digoal','数学',89.5);</font></div><div><font size="2"  >insert into std_score values('digoal','语文',89.5);</font></div><div><font size="2"  >insert into std_score values('digoal','英语',89.5);</font></div><div><font size="2"  >insert into std_score values('digoal','物理',89.5);</font></div><div><font size="2"  >insert into std_score values('digoal','化学',89.5);</font></div><p></p></pre></div><div><br></div><div>取出各门学科第一名的同学.</div><div>方法一, 使用窗口函数</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >test=&gt; select username,subject,score from (select *,row_number() over (partition by subject order by score desc) rn from std_score) t where rn=1;</font></div><div><font size="2"  >&nbsp;username | subject | score&nbsp;</font></div><div><font size="2"  >----------+---------+-------</font></div><div><font size="2"  >&nbsp;叶孤城 &nbsp; | 化学 &nbsp; &nbsp;| &nbsp;99.5</font></div><div><font size="2"  >&nbsp;叶孤城 &nbsp; | 数学 &nbsp; &nbsp;| &nbsp;99.5</font></div><div><font size="2"  >&nbsp;黎明 &nbsp; &nbsp; | 物理 &nbsp; &nbsp;| &nbsp;89.5</font></div><div><font size="2"  >&nbsp;刘德华 &nbsp; | 英语 &nbsp; &nbsp;| &nbsp;99.5</font></div><div><font size="2"  >&nbsp;李连杰 &nbsp; | 语文 &nbsp; &nbsp;| &nbsp;95.5</font></div><div><font size="2"  >(5 rows)</font></div><div><font size="2"  >Time: 0.405 ms</font></div><p></p></pre></div><div><br></div><div>方法二, 使用distinct on 语法</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >test=&gt; select distinct on (subject) username,subject,score from std_score order by subject,score desc;</font></div><div><font size="2"  >&nbsp;username | subject | score&nbsp;</font></div><div><font size="2"  >----------+---------+-------</font></div><div><font size="2"  >&nbsp;叶孤城 &nbsp; | 化学 &nbsp; &nbsp;| &nbsp;99.5</font></div><div><font size="2"  >&nbsp;叶孤城 &nbsp; | 数学 &nbsp; &nbsp;| &nbsp;99.5</font></div><div><font size="2"  >&nbsp;黎明 &nbsp; &nbsp; | 物理 &nbsp; &nbsp;| &nbsp;89.5</font></div><div><font size="2"  >&nbsp;刘德华 &nbsp; | 英语 &nbsp; &nbsp;| &nbsp;99.5</font></div><div><font size="2"  >&nbsp;李连杰 &nbsp; | 语文 &nbsp; &nbsp;| &nbsp;95.5</font></div><div><font size="2"  >(5 rows)</font></div><div><font size="2"  >Time: 0.232 ms</font></div><p></p></pre></div><div><br></div><div>方法三, 使用in子句</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >test=&gt; select * from std_score where (subject,score) in (select subject,max(score) score from std_score group by subject) order by subject;</font></div><div><font size="2"  >&nbsp;username | subject | score&nbsp;</font></div><div><font size="2"  >----------+---------+-------</font></div><div><font size="2"  >&nbsp;李连杰 &nbsp; | 化学 &nbsp; &nbsp;| &nbsp;99.5</font></div><div><font size="2"  >&nbsp;叶孤城 &nbsp; | 化学 &nbsp; &nbsp;| &nbsp;99.5</font></div><div><font size="2"  >&nbsp;叶孤城 &nbsp; | 数学 &nbsp; &nbsp;| &nbsp;99.5</font></div><div><font size="2"  >&nbsp;叶孤城 &nbsp; | 物理 &nbsp; &nbsp;| &nbsp;89.5</font></div><div><font size="2"  >&nbsp;digoal &nbsp; | 物理 &nbsp; &nbsp;| &nbsp;89.5</font></div><div><font size="2"  >&nbsp;黎明 &nbsp; &nbsp; | 物理 &nbsp; &nbsp;| &nbsp;89.5</font></div><div><font size="2"  >&nbsp;李连杰 &nbsp; | 物理 &nbsp; &nbsp;| &nbsp;89.5</font></div><div><font size="2"  >&nbsp;刘德华 &nbsp; | 英语 &nbsp; &nbsp;| &nbsp;99.5</font></div><div><font size="2"  >&nbsp;李连杰 &nbsp; | 语文 &nbsp; &nbsp;| &nbsp;95.5</font></div><div><font size="2"  >(9 rows)</font></div><div><font size="2"  >Time: 0.603 ms</font></div><p></p></pre></div><div><br></div><div>取最后一名也很容易, 刚好相反 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >test=&gt; select username,subject,score from (select *,row_number() over (partition by subject order by score) rn from std_score) t where rn=1;</font></div><div><font size="2"  >&nbsp;username | subject | score&nbsp;</font></div><div><font size="2"  >----------+---------+-------</font></div><div><font size="2"  >&nbsp;郭富城 &nbsp; | 化学 &nbsp; &nbsp;| &nbsp;69.5</font></div><div><font size="2"  >&nbsp;李连杰 &nbsp; | 数学 &nbsp; &nbsp;| &nbsp;75.5</font></div><div><font size="2"  >&nbsp;郭富城 &nbsp; | 物理 &nbsp; &nbsp;| &nbsp;69.5</font></div><div><font size="2"  >&nbsp;叶孤城 &nbsp; | 英语 &nbsp; &nbsp;| &nbsp;69.5</font></div><div><font size="2"  >&nbsp;叶孤城 &nbsp; | 语文 &nbsp; &nbsp;| &nbsp;82.5</font></div><div><font size="2"  >(5 rows)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Time: 0.546 ms</font></div><div><font size="2"  >test=&gt; select distinct on (subject) username,subject,score from std_score order by subject,score;</font></div><div><font size="2"  >&nbsp;username | subject | score&nbsp;</font></div><div><font size="2"  >----------+---------+-------</font></div><div><font size="2"  >&nbsp;郭富城 &nbsp; | 化学 &nbsp; &nbsp;| &nbsp;69.5</font></div><div><font size="2"  >&nbsp;李连杰 &nbsp; | 数学 &nbsp; &nbsp;| &nbsp;75.5</font></div><div><font size="2"  >&nbsp;郭富城 &nbsp; | 物理 &nbsp; &nbsp;| &nbsp;69.5</font></div><div><font size="2"  >&nbsp;叶孤城 &nbsp; | 英语 &nbsp; &nbsp;| &nbsp;69.5</font></div><div><font size="2"  >&nbsp;叶孤城 &nbsp; | 语文 &nbsp; &nbsp;| &nbsp;82.5</font></div><div><font size="2"  >(5 rows)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Time: 0.245 ms</font></div><div><font size="2"  >test=&gt; select * from std_score where (subject,score) in (select subject,min(score) score from std_score group by subject) order by subject;</font></div><div><font size="2"  >&nbsp;username | subject | score&nbsp;</font></div><div><font size="2"  >----------+---------+-------</font></div><div><font size="2"  >&nbsp;黎明 &nbsp; &nbsp; | 化学 &nbsp; &nbsp;| &nbsp;69.5</font></div><div><font size="2"  >&nbsp;郭富城 &nbsp; | 化学 &nbsp; &nbsp;| &nbsp;69.5</font></div><div><font size="2"  >&nbsp;李连杰 &nbsp; | 数学 &nbsp; &nbsp;| &nbsp;75.5</font></div><div><font size="2"  >&nbsp;郭富城 &nbsp; | 物理 &nbsp; &nbsp;| &nbsp;69.5</font></div><div><font size="2"  >&nbsp;叶孤城 &nbsp; | 英语 &nbsp; &nbsp;| &nbsp;69.5</font></div><div><font size="2"  >&nbsp;郭富城 &nbsp; | 语文 &nbsp; &nbsp;| &nbsp;82.5</font></div><div><font size="2"  >&nbsp;叶孤城 &nbsp; | 语文 &nbsp; &nbsp;| &nbsp;82.5</font></div><div><font size="2"  >(7 rows)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Time: 0.649 ms</font></div><p></p></pre></div><div>除了使用group by子句, distinct on和窗口函数也可以作为子句如,</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=# explain select * from std_score where (subject,score) in (select distinct on (subject) subject,score from std_score order by subject,score desc);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >-----------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Merge Semi Join &nbsp;(cost=7.96..14.96 rows=12 width=23)</font></div><div><font size="2"  >&nbsp; &nbsp;Merge Cond: ((public.std_score.subject = public.std_score.subject) AND (public.std_score.score = public.std_score.score))</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Index Scan using idx_test on std_score &nbsp;(cost=0.00..6.78 rows=35 width=23)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=7.96..7.97 rows=5 width=14)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: public.std_score.subject, public.std_score.score</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Unique &nbsp;(cost=7.67..7.85 rows=5 width=14)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=7.67..7.76 rows=35 width=14)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: public.std_score.subject, public.std_score.score</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Only Scan using idx_test on std_score &nbsp;(cost=0.00..6.78 rows=35 width=14)</font></div><div><font size="2"  >(9 rows)</font></div></div><div><font size="2"  >digoal=# select * from std_score where (subject,score) in (select distinct on (subject) subject,score from std_score order by subject,score desc) order by subject;<br> username | subject | score <br>----------+---------+-------<br> 李连杰   | 化学    |  99.5<br> 叶孤城   | 化学    |  99.5<br> 叶孤城   | 数学    |  99.5<br> 黎明     | 物理    |  89.5<br> 李连杰   | 物理    |  89.5<br> 叶孤城   | 物理    |  89.5<br> digoal   | 物理    |  89.5<br> 刘德华   | 英语    |  99.5<br> 李连杰   | 语文    |  95.5<br>(9 rows)</font></div><p></p></pre></div><div><br></div><div>【注意】</div><div>使用窗口函数和distinct on 的语法取排名, 并列排名没有取到.</div><div><br></div><div>【参考】</div><div><a style="line-height: 22px; " href="http://blog.163.com/digoal@126/blog/static/16387704020124793313702/?suggestedreading&amp;wumii"  >http://blog.163.com/digoal@126/blog/static/16387704020124793313702</a></div></div>
	</div>
</div>
</body>
</html>