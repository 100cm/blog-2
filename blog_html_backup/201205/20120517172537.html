<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.2 range type usage case</h2>
	<h5 id="">2012-05-17 17:25:37&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201241752537254/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>上一篇BLOG介绍了PostgreSQL 9.2引入的新类型range.&nbsp;</div><div>接下来讲讲实际的应用场景, 例如通过IP地址定位这个IP是什么地方的.&nbsp;</div><div>假设我用iprange存储一段IP对应一个地名, 根据用户提交上来的IP可以去检索出这个IP属于什么地名的.</div><div>首先要创建iprange类型.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# create type iprange as range (subtype=inet);</font></div><div><font size="2"  >CREATE TYPE</font></div><p></p></pre></div><div>创建测试表</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# create table ip_info (id serial primary key,iprange iprange,location text);</font></div><div><font size="2"  >NOTICE: &nbsp;CREATE TABLE will create implicit sequence "ip_info_id_seq" for serial column "ip_info.id"</font></div><div><font size="2"  >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "ip_info_pkey" for table "ip_info"</font></div><div><font size="2"  >CREATE TABLE</font></div><p></p></pre></div><div>创建exclude约束, 注意我这里使用了text类型的gist索引, 所以需要先加载btree_gist模块, 否则会创建不成功.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# alter table ip_info add constraint ck_exclude_iprange exclude using gist(location with =, iprange with &amp;&amp;);</font></div><div><font size="2"  >NOTICE: &nbsp;ALTER TABLE / ADD EXCLUDE will create implicit index "ck_exclude_iprange" for table "ip_info"</font></div><div><font size="2"  >ALTER TABLE</font></div><p></p></pre></div><div>插入测试数据</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# insert into ip_info (iprange,location) values (iprange('192.168.1.0'::inet,'192.168.1.10'::inet,'[]'),'北京');</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=# insert into ip_info (iprange,location) values (iprange('192.168.1.11'::inet,'192.168.1.20'::inet,'[]'),'上海');</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=# insert into ip_info (iprange,location) values (iprange('192.168.1.21'::inet,'192.168.1.30'::inet,'[]'),'南京');</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=# insert into ip_info (iprange,location) values (iprange('192.168.1.31'::inet,'192.168.1.40'::inet,'[]'),'杭州');</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=# insert into ip_info (iprange,location) values (iprange('192.168.1.41'::inet,'192.168.1.50'::inet,'[]'),'南昌');</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=# insert into ip_info (iprange,location) values (iprange('192.168.1.51'::inet,'192.168.1.60'::inet,'[]'),'广州');</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=# insert into ip_info (iprange,location) values (iprange('192.168.1.61'::inet,'192.168.1.70'::inet,'[]'),'重庆');</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=# insert into ip_info (iprange,location) values (iprange('192.168.1.71'::inet,'192.168.1.80'::inet,'[]'),'香港');</font></div><div><font size="2"  >INSERT 0 1</font></div><p></p></pre></div><div>查看当前的表结构</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# \d ip_info</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "public.ip_info"</font></div><div><font size="2"  >&nbsp; Column &nbsp;| &nbsp;Type &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Modifiers &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----------+---------+------------------------------------------------------</font></div><div><font size="2"  >&nbsp;id &nbsp; &nbsp; &nbsp; | integer | not null default nextval('ip_info_id_seq'::regclass)</font></div><div><font size="2"  >&nbsp;iprange &nbsp;| iprange |&nbsp;</font></div><div><font size="2"  >&nbsp;location | text &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >Indexes:</font></div><div><font size="2"  >&nbsp; &nbsp; "ip_info_pkey" PRIMARY KEY, btree (id)</font></div><div><font size="2"  >&nbsp; &nbsp; "ck_exclude_iprange" EXCLUDE USING gist (location WITH =, iprange WITH &amp;&amp;)</font></div><p></p></pre></div><div>测试查询</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select * from ip_info where iprange @&gt; '192.168.1.1'::inet;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;iprange &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | location&nbsp;</font></div><div><font size="2"  >----+----------------------------+----------</font></div><div><font size="2"  >&nbsp; 1 | [192.168.1.0,192.168.1.10] | 北京</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>查看执行计划.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# explain select * from ip_info where iprange @&gt; '192.168.1.1'::inet;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >-----------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Index Scan using ck_exclude_iprange on ip_info &nbsp;(cost=0.00..8.27 rows=1 width=68)</font></div><div><font size="2"  >&nbsp; &nbsp;Index Cond: (iprange @&gt; '192.168.1.1'::inet)</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><wbr></div>
	</div>
</div>
</body>
</html>