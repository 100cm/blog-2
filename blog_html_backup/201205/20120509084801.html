<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">OS CACHE and PostgreSQL Performance</h2>
	<h5 id="">2012-05-09 8:48:01&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012498475288/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">转载一篇关于OS CACHE的explain BLOG. Bruce Momjian写的.<div><a rel="nofollow" href="http://momjian.us/main/blogs/pgblog/2012.html#May_2_2012"  >http://momjian.us/main/blogs/pgblog/2012.html#May_2_2012</a>&nbsp;</div><div><div>Measuring Linux free memory and kernel cache size can be somewhat tricky. You might look at /proc/meminfo for the answer (commas added):</div><div><br></div><div># cat /proc/meminfo</div><div>MemTotal: &nbsp; &nbsp; &nbsp; 24,736,604 kB</div><div>MemFree: &nbsp; &nbsp; &nbsp; &nbsp; 3,805,392 kB</div><div>Buffers: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 743,016 kB</div><div>Cached: &nbsp; &nbsp; &nbsp; &nbsp; 18,188,208 kB</div><div>...</div><div>Unfortunately, this brings up two more questions: Why is "MemFree" so small on this idle system, and what is the difference between "Buffers" and "Cached"? Another way of displaying this information is using the Linux free command:</div><div><br></div><div># free -m</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;total &nbsp; &nbsp; &nbsp; used &nbsp; &nbsp; &nbsp; free &nbsp; &nbsp; shared &nbsp; &nbsp;buffers &nbsp; &nbsp; cached</div><div>Mem: &nbsp; &nbsp; &nbsp; &nbsp; 24156 &nbsp; &nbsp; &nbsp;20351 &nbsp; &nbsp; &nbsp; 3805 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp;743 &nbsp; &nbsp; &nbsp;18188</div><div>-/+ buffers/cache: &nbsp; &nbsp; &nbsp; 1419 &nbsp; &nbsp; &nbsp; 22737</div><div>Swap: &nbsp; &nbsp; &nbsp; &nbsp; 6219 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; 6219</div><div>Addressing the first question, we see the same 3.8GB for free memory displayed on the first line under "free". This display is so often misinterpreted that it necessitated the creation of an explanatory website.</div><div><br></div><div>The Mem line output by free shows memory from the kernel perspective. The free value of 3.8GB represents kernel memory not allocated for any purpose, i.e. free, from the kernel's perspective. The bulk of the memory, 18GB, is shown as used for caching ("cached"). The second line, confusingly labeled "-/+ buffers/cache", represents memory from the process perspective. It is labeled that way because the "buffers" and "cached" have been removed from the "used" column and added to the "free" column, i.e. -/+. From the process perspective that memory is immediately available because it represents read cache that can be discarded as soon as memory is needed by processes. This labeled output summarizes the columns (details):</div><div><br></div><div># free -m</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;total &nbsp; &nbsp; &nbsp; used &nbsp; &nbsp; &nbsp; free &nbsp; &nbsp; shared &nbsp; &nbsp;buffers &nbsp; &nbsp; cached</div><div>Mem: &nbsp; &nbsp; &nbsp; &nbsp;A+B+C+D &nbsp; &nbsp; B+C+D &nbsp; &nbsp; &nbsp; &nbsp; A &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; B &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; C &nbsp;</div><div>-/+ buffers/cache: &nbsp; &nbsp; &nbsp; &nbsp;D &nbsp; &nbsp; &nbsp; &nbsp; A+B+C &nbsp;</div><div>(The "Swap" line has been removed from this and later free outputs.)</div><div><br></div><div>"A" represents kernel free memory, and "D" represents memory used by processes. You can see that "B+C" is added to the "used" column in line 1, and added to the "free" column in line 2. "total" represents all memory, less memory used for basic kernel operation. In fact, "total" always equals "used" + "free" for each line:</div><div><br></div><div># free -m</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;total &nbsp; &nbsp; &nbsp; used &nbsp; &nbsp; &nbsp; free &nbsp; &nbsp; shared &nbsp; &nbsp;buffers &nbsp; &nbsp; cached</div><div>Mem: &nbsp; &nbsp; &nbsp; &nbsp;A+B,C+D &nbsp; &nbsp; &nbsp; A &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; B&nbsp;</div><div>-/+ buffers/cache: &nbsp; &nbsp; &nbsp; &nbsp;C &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; D &nbsp; &nbsp;</div><div>Here is actual free output:</div><div><br></div><div># free -m</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;total &nbsp; &nbsp; &nbsp; used &nbsp; &nbsp; &nbsp; free &nbsp; &nbsp; shared &nbsp; &nbsp;buffers &nbsp; &nbsp; cached</div><div>Mem: &nbsp; &nbsp; &nbsp; &nbsp; 24156 &nbsp; &nbsp; &nbsp;20351 &nbsp; &nbsp; &nbsp; 3805 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp;743 &nbsp; &nbsp; &nbsp;18188</div><div>-/+ buffers/cache: &nbsp; &nbsp; &nbsp; 1419 &nbsp; &nbsp; &nbsp; 22737</div><div>Notice that the italicized values on line 1 equal the bold value on line 2. Similarly, these italicized value equal the bold value:</div><div><br></div><div># free -m</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;total &nbsp; &nbsp; &nbsp; used &nbsp; &nbsp; &nbsp; free &nbsp; &nbsp; shared &nbsp; &nbsp;buffers &nbsp; &nbsp; cached</div><div>Mem: &nbsp; &nbsp; &nbsp; &nbsp; 24156 &nbsp; &nbsp; &nbsp;20351 &nbsp; &nbsp; &nbsp; 3805 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp;743 &nbsp; &nbsp; &nbsp;18188</div><div>-/+ buffers/cache: &nbsp; &nbsp; &nbsp; 1419 &nbsp; &nbsp; &nbsp; 22737</div><div>While free is confusing, its layout does suggest the meaning of various columns. Open source has often debated what "free software" means, and it seem the Linux kernel also has multiple definitions of the word "free". &nbsp;</div><div><br></div><div>The second question regards the difference between "buffers" and "cache". (Josh Berkus recently blogged about a kernel bug that prevented most available ram from being used as cache.) The definitive answer for modern kernels comes from this source code comment:</div><div><br></div><div>Buffers: Relatively temporary storage for raw disk blocks</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;shouldn't get tremendously large (20MB or so)</div><div>&nbsp;Cached: in-memory cache for files read from the disk (the</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pagecache). &nbsp;Doesn't include SwapCached</div><div>The buffers and caches can be cleared using these commands (at least in Linux 2.6.16 and later kernels):</div><div><br></div><div>To free pagecache:</div><div>&nbsp;</div><div>&nbsp; &nbsp; echo 1 &gt; /proc/sys/vm/drop_caches</div><div>&nbsp;</div><div>To free dentries and inodes:</div><div>&nbsp;</div><div>&nbsp; &nbsp; echo 2 &gt; /proc/sys/vm/drop_caches</div><div>&nbsp;</div><div>To free pagecache, dentries and inodes:</div><div>&nbsp;</div><div>&nbsp; &nbsp; echo 3 &gt; /proc/sys/vm/drop_caches</div><div>With the last command run, the free command shows almost nothing cached, and the first two entries in the "free" column are almost identical, as expected:</div><div><br></div><div># free -m</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;total &nbsp; &nbsp; &nbsp; used &nbsp; &nbsp; &nbsp; free &nbsp; &nbsp; shared &nbsp; &nbsp;buffers &nbsp; &nbsp; cached</div><div>Mem: &nbsp; &nbsp; &nbsp; &nbsp; 24156 &nbsp; &nbsp; &nbsp; &nbsp;899 &nbsp; &nbsp; &nbsp;23257 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; 91</div><div>-/+ buffers/cache: &nbsp; &nbsp; &nbsp; &nbsp;807 &nbsp; &nbsp; &nbsp;23349</div><div>Swap: &nbsp; &nbsp; &nbsp; &nbsp; 6219 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 &nbsp; &nbsp; &nbsp; 6218</div><div>Hopefully this explanation helps people understand the various perspectives of "free" reported by the Linux kernel and an easy way to find the size of the Linux kernel cache.</div></div><div><br><wbr><div>再转载一篇Josh Berkus写的关于Linux Cache BUG的BLOG, 个人认为可能是这个版本的内核参数默认值调整过导致的. 或者是新加了控制内存使用behavior相关的内核参数导致的. 不够我手头上没有相关的环境, 没办法验证.</div><div><a rel="nofollow" href="http://www.databasesoup.com/2012/04/red-hat-kernel-cache-clearing-issue.html"  >http://www.databasesoup.com/2012/04/red-hat-kernel-cache-clearing-issue.html</a> </div><div><div>Recently, mega-real-estate sales site Tigerlead called us with a very strange problem. &nbsp;One of their dedicated PostgreSQL servers refused to use most of its available RAM, forcing the system to read from disk. &nbsp;Given that the database was 60GB in size and the server had 96GB of RAM, this was a painful performance degradation.</div><div><br></div><div>Output of free -m:</div><div><br></div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;total &nbsp; &nbsp; &nbsp; used &nbsp; &nbsp; &nbsp; free &nbsp; &nbsp; shared &nbsp; &nbsp;buffers &nbsp; &nbsp; cached</div><div>Mem: &nbsp; &nbsp; &nbsp; &nbsp; 96741 &nbsp; &nbsp; &nbsp;50318 &nbsp; &nbsp; &nbsp;46422 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; 21 &nbsp; &nbsp; &nbsp;44160</div><div>-/+ buffers/cache: &nbsp; &nbsp; &nbsp; 6136 &nbsp; &nbsp; &nbsp;90605</div><div>Swap: &nbsp; &nbsp; &nbsp; &nbsp;90111 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3 &nbsp; &nbsp; &nbsp;90107</div><div>&nbsp;</div><div>As you can see here, the system is only using half the free memory for cache, and leaving the other half free. &nbsp;This would be normal behavior if only half the cache were needed, but IOstat also showed &nbsp;numerous and frequent reads from disk, resulting in IOwaits for user queries. &nbsp;Still, there could be other explanations for that.</div><div><br></div><div>So, I tried forcing a cache fill by doing a pgdump. &nbsp;This caused the cache to mostly fill free memory -- but then Linux aggressively cleared the cache, again getting it down to around 40GB of cache within a few minutes. &nbsp;This seemed to be the case no matter what we did, including tinkering with the vm parameters, increasing the size of the swap file, and changing shared_buffers. &nbsp;This was highly peculiar; it was as if Linux was convinced that we had half as much RAM as we did.</div><div><br></div><div>What fixed the problem was changing the kernel version. &nbsp;It turns out that kernel</div><div>2.6.32-71.29.1.el6.x86_64, released by Red Hat during a routine update, has some kind of cache management issue which can't be fixed in user space. &nbsp;Fortunately, they now have a later kernel version out as an update.</div><div><br></div><div>Before:</div><div><br></div><div>[root ~]# free -g</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;total &nbsp; &nbsp; &nbsp; used &nbsp; &nbsp; &nbsp; free &nbsp; &nbsp; shared &nbsp; &nbsp;buffers &nbsp; &nbsp; cached</div><div>Mem: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;94 &nbsp; &nbsp; &nbsp; &nbsp; 24 &nbsp; &nbsp; &nbsp; &nbsp; 70 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; 19</div><div>[root ~]# uname -a</div><div>Linux server1.company.com 2.6.32-71.29.1.el6.x86_64 #1 SMP Mon</div><div>Jun 27 19:49:27 BST 2011 x86_64 x86_64 x86_64 GNU/Linux</div><div><br></div><div>After:</div><div><br></div><div>[root ~]# free -g</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;total &nbsp; &nbsp; &nbsp; used &nbsp; &nbsp; &nbsp; free &nbsp; &nbsp; shared &nbsp; &nbsp;buffers &nbsp; &nbsp; cached</div><div>Mem: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;94 &nbsp; &nbsp; &nbsp; &nbsp; 87 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; 83</div><div>[root ~]# uname -a</div><div>Linux server1.company.com 2.6.32-220.4.2.el6.x86_64 #1 SMP Tue</div><div>Feb 14 04:00:16 GMT 2012 x86_64 x86_64 x86_64 GNU/Linux</div><div><br></div><div>That's more like it! &nbsp; Thanks to Andrew Kerr of Tigerlead for helping figure this issue out.</div><div><br></div><div>I don't know if other Linux distributors released the same kernel with any routine update. &nbsp;I haven't seen this behavior (yet) with Ubuntu, Debian, or SuSE. &nbsp;If you see it, please report it in the comments, or better to the appropriate mailing list.</div></div><div><br></div><div><br></div></div></div>
	</div>
</div>
</body>
</html>