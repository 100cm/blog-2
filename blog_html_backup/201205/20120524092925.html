<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.2 reduce need to rewrite tables and indexes for various alter table operations</h2>
	<h5 id="">2012-05-24 9:29:25&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201242485627235/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.2 beta1 release notes 里面提到如下</div>Reduce need to rebuild tables and indexes for various ALTER TABLE operations (Noah Misch) DUPLICATE?<wbr><div>在以前的版本中ALTER TABLE的操作大部分需要rewrite table. 具体测试可用参考如下BLOG :&nbsp;</div><div><div>Which ALTER TABLE Operation will rewrite the whole tables</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201111644133716/"  >http://blog.163.com/digoal@126/blog/static/163877040201111644133716/</a></div></div><div>9.2 beta1做了哪些修改呢?</div><div>创建测试表, 插入测试数据. 通过查看pg_class的relfilenode分辨是否有rewrite操作, 并能清晰的看到rewrite全表还是toast表还是index.还是heap表.</div><div>测试过程中注意relfilenode的变化.</div><div><pre class="prettyprint"  ><div><font size="2"  >test=&gt; create table rewrite_test(id int primary key,info text unique,c1 numeric(10));</font></div><div><font size="2"  >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "rewrite_test_pkey" for table "rewrite_test"</font></div><div><font size="2"  >NOTICE: &nbsp;CREATE TABLE / UNIQUE will create implicit index "rewrite_test_info_key" for table "rewrite_test"</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >test=&gt; insert into rewrite_test select generate_series(1,100000),repeat('digoal',200)||generate_series(1,100000),generate_series(1,100000);</font></div><div><font size="2"  >INSERT 0 100000</font></div><p></p></pre></div><div><br></div><div>一、9.1 的测试结果 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >test=&gt; select relname from pg_class where oid=(select reltoastrelid from pg_class where relname='rewrite_test');</font></div><div><font size="2"  >&nbsp; &nbsp; relname &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----------------</font></div><div><font size="2"  >&nbsp;pg_toast_24672</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >test=&gt; select relname,relfilenode from pg_class where relname in ('rewrite_test','rewrite_test_pkey','rewrite_test_info_key','pg_toast_24672');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp; &nbsp;| relfilenode&nbsp;</font></div><div><font size="2"  >-----------------------+-------------</font></div><div><font size="2"  >&nbsp;rewrite_test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 24682</font></div><div><font size="2"  >&nbsp;pg_toast_24672 &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 24683</font></div><div><font size="2"  >&nbsp;rewrite_test_pkey &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 24684</font></div><div><font size="2"  >&nbsp;rewrite_test_info_key | &nbsp; &nbsp; &nbsp; 24685</font></div><div><font size="2"  >(4 rows)</font></div><p></p></pre></div><div>-- 从int4到int8(注意这不是扩字段长度, 而是变更字段类型.) 需要rewrite heap,toast,index.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >test=&gt; alter table rewrite_test alter column id type int8;</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >test=&gt; select relname,relfilenode from pg_class where relname in ('rewrite_test','rewrite_test_pkey','rewrite_test_info_key','pg_toast_24672');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp; &nbsp;| relfilenode&nbsp;</font></div><div><font size="2"  >-----------------------+-------------</font></div><div><font size="2"  >&nbsp;rewrite_test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 24689</font></div><div><font size="2"  >&nbsp;rewrite_test_info_key | &nbsp; &nbsp; &nbsp; 24695</font></div><div><font size="2"  >&nbsp;rewrite_test_pkey &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 24696</font></div><div><font size="2"  >&nbsp;pg_toast_24672 &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 24692</font></div><div><font size="2"  >(4 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- 从text到</span><span style="line-height: 22px;"  >varchar(4096)</span>&nbsp;<span style="line-height: 22px;"  >&nbsp;需要rewrite heap,toast,index.</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >test=&gt; alter table rewrite_test alter column info type varchar(4096);</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >test=&gt; select relname,relfilenode from pg_class where relname in ('rewrite_test','rewrite_test_pkey','rewrite_test_info_key','pg_toast_24672');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp; &nbsp;| relfilenode&nbsp;</font></div><div><font size="2"  >-----------------------+-------------</font></div><div><font size="2"  >&nbsp;rewrite_test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 24707</font></div><div><font size="2"  >&nbsp;rewrite_test_pkey &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 24713</font></div><div><font size="2"  >&nbsp;rewrite_test_info_key | &nbsp; &nbsp; &nbsp; 24714</font></div><div><font size="2"  >&nbsp;pg_toast_24672 &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 24710</font></div><div><font size="2"  >(4 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- 从</span><span style="line-height: 22px;"  >varchar(4096)到varchar(8192)</span><span style="line-height: 22px;"  >&nbsp;</span><span style="line-height: 22px;"  >&nbsp;需要rewrite heap,toast,index.</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >test=&gt; alter table rewrite_test alter column info type varchar(8192);</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >test=&gt; select relname,relfilenode from pg_class where relname in ('rewrite_test','rewrite_test_pkey','rewrite_test_info_key','pg_toast_24672');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp; &nbsp;| relfilenode&nbsp;</font></div><div><font size="2"  >-----------------------+-------------</font></div><div><font size="2"  >&nbsp;rewrite_test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 24717</font></div><div><font size="2"  >&nbsp;rewrite_test_pkey &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 24723</font></div><div><font size="2"  >&nbsp;rewrite_test_info_key | &nbsp; &nbsp; &nbsp; 24724</font></div><div><font size="2"  >&nbsp;pg_toast_24672 &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 24720</font></div><div><font size="2"  >(4 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- 从</span><span style="line-height: 22px;"  >varchar(8192)到text</span><span style="line-height: 22px;"  >(注意这不是扩字段长度, 而是变更字段类型.但是显然PG里面varchar和text底层存储结构是一样的, 所以没有rewrite heap和toast)</span><span style="line-height: 22px;"  >&nbsp;</span><span style="line-height: 22px;"  >&nbsp;需要rewrite 扩充长度的字段上的index.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >test=&gt; alter table rewrite_test alter column info type text;</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >test=&gt; select relname,relfilenode from pg_class where relname in ('rewrite_test','rewrite_test_pkey','rewrite_test_info_key','pg_toast_24672');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp; &nbsp;| relfilenode&nbsp;</font></div><div><font size="2"  >-----------------------+-------------</font></div><div><font size="2"  >&nbsp;rewrite_test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 24717</font></div><div><font size="2"  >&nbsp;rewrite_test_pkey &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 24723</font></div><div><font size="2"  >&nbsp;pg_toast_24672 &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 24720</font></div><div><font size="2"  >&nbsp;rewrite_test_info_key | &nbsp; &nbsp; &nbsp; 24725</font></div><div><font size="2"  >(4 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- 从text</span><span style="line-height: 22px;"  >到text</span><span style="line-height: 22px;"  >&nbsp;</span><span style="line-height: 22px;"  >&nbsp;需要rewrite alter column的字段上的index.</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >test=&gt; alter table rewrite_test alter column info type text;</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >test=&gt; select relname,relfilenode from pg_class where relname in ('rewrite_test','rewrite_test_pkey','rewrite_test_info_key','pg_toast_24672');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp; &nbsp;| relfilenode&nbsp;</font></div><div><font size="2"  >-----------------------+-------------</font></div><div><font size="2"  >&nbsp;rewrite_test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 24717</font></div><div><font size="2"  >&nbsp;rewrite_test_pkey &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 24723</font></div><div><font size="2"  >&nbsp;pg_toast_24672 &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 24720</font></div><div><font size="2"  >&nbsp;rewrite_test_info_key | &nbsp; &nbsp; &nbsp; 24727</font></div><div><font size="2"  >(4 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- 从</span><span style="line-height: 22px;"  >numeric(10)到</span><span style="line-height: 22px;"  >numeric(11)</span>&nbsp;<span style="line-height: 22px;"  >&nbsp;</span><span style="line-height: 22px;"  >&nbsp;需要rewrite&nbsp;</span><span style="line-height: 22px;"  >heap,toast,index</span><span style="line-height: 22px;"  >.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >test=&gt; alter table rewrite_test alter column c1 type numeric(11);</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >test=&gt; select relname,relfilenode from pg_class where relname in ('rewrite_test','rewrite_test_pkey','rewrite_test_info_key','pg_toast_24672');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp; &nbsp;| relfilenode&nbsp;</font></div><div><font size="2"  >-----------------------+-------------</font></div><div><font size="2"  >&nbsp;rewrite_test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 24729</font></div><div><font size="2"  >&nbsp;rewrite_test_pkey &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 24735</font></div><div><font size="2"  >&nbsp;rewrite_test_info_key | &nbsp; &nbsp; &nbsp; 24736</font></div><div><font size="2"  >&nbsp;pg_toast_24672 &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 24732</font></div><div><font size="2"  >(4 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- 从</span><span style="line-height: 22px;"  >numeric(11)到</span><span style="line-height: 22px;"  >numeric(11)</span><span style="line-height: 22px;"  >&nbsp;</span><span style="line-height: 22px;"  >&nbsp;</span><span style="line-height: 22px;"  >&nbsp;不需要rewrite</span><span style="line-height: 22px;"  >.</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >test=&gt; alter table rewrite_test alter column c1 type numeric(11);</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >test=&gt; select relname,relfilenode from pg_class where relname in ('rewrite_test','rewrite_test_pkey','rewrite_test_info_key','pg_toast_24672');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp; &nbsp;| relfilenode&nbsp;</font></div><div><font size="2"  >-----------------------+-------------</font></div><div><font size="2"  >&nbsp;rewrite_test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 24729</font></div><div><font size="2"  >&nbsp;rewrite_test_pkey &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 24735</font></div><div><font size="2"  >&nbsp;rewrite_test_info_key | &nbsp; &nbsp; &nbsp; 24736</font></div><div><font size="2"  >&nbsp;pg_toast_24672 &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 24732</font></div><div><font size="2"  >(4 rows)</font></div><p></p></pre></div><div>-- 删除text字段上的索引后,&nbsp;<span style="line-height: 22px;"  >从text</span><span style="line-height: 22px;"  >到text</span><span style="line-height: 22px;"  >&nbsp;</span><span style="line-height: 22px;"  >&nbsp; 不需要rewrite.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >test=&gt; alter table rewrite_test drop constraint rewrite_test_info_key;</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >test=&gt; alter table rewrite_test alter column info type text;</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >test=&gt; select relname,relfilenode from pg_class where relname in ('rewrite_test','rewrite_test_pkey','rewrite_test_info_key','pg_toast_24672');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp;| relfilenode&nbsp;</font></div><div><font size="2"  >-------------------+-------------</font></div><div><font size="2"  >&nbsp;rewrite_test &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 24729</font></div><div><font size="2"  >&nbsp;rewrite_test_pkey | &nbsp; &nbsp; &nbsp; 24735</font></div><div><font size="2"  >&nbsp;pg_toast_24672 &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 24732</font></div><div><font size="2"  >(3 rows)</font></div><p></p></pre></div></div><div><br></div><div>二、PostgreSQL 9.2 beta1 测试 结果 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select relname from pg_class where oid=(select reltoastrelid from pg_class where relname='rewrite_test');</font></div><div><font size="2"  >&nbsp; &nbsp; relname &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----------------</font></div><div><font size="2"  >&nbsp;pg_toast_17142</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=# select relname,relfilenode from pg_class where relname in ('rewrite_test','rewrite_test_pkey','rewrite_test_info_key','pg_toast_17142');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp; &nbsp;| relfilenode&nbsp;</font></div><div><font size="2"  >-----------------------+-------------</font></div><div><font size="2"  >&nbsp;rewrite_test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 17142</font></div><div><font size="2"  >&nbsp;pg_toast_17142 &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 17145</font></div><div><font size="2"  >&nbsp;rewrite_test_pkey &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 17148</font></div><div><font size="2"  >&nbsp;rewrite_test_info_key | &nbsp; &nbsp; &nbsp; 17150</font></div><div><font size="2"  >(4 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- 从int4到int8</span><span style="line-height: 22px;"  >(注意这不是扩字段长度, 而是变更字段类型.)</span><span style="line-height: 22px;"  >&nbsp;需要rewrite heap,toast,index.</span></div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# alter table rewrite_test alter column id type int8;</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >digoal=# select relname,relfilenode from pg_class where relname in ('rewrite_test','rewrite_test_pkey','rewrite_test_info_key','pg_toast_17142');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp; &nbsp;| relfilenode&nbsp;</font></div><div><font size="2"  >-----------------------+-------------</font></div><div><font size="2"  >&nbsp;pg_toast_17142 &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 17157</font></div><div><font size="2"  >&nbsp;rewrite_test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 17154</font></div><div><font size="2"  >&nbsp;rewrite_test_info_key | &nbsp; &nbsp; &nbsp; 17160</font></div><div><font size="2"  >&nbsp;rewrite_test_pkey &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 17161</font></div><div><font size="2"  >(4 rows)</font></div><p></p></pre></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >-- 从text到varchar(4096) 需要rewrite heap,toast,index.</span> </div></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# alter table rewrite_test alter column info type varchar(4096);</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >digoal=# select relname,relfilenode from pg_class where relname in ('rewrite_test','rewrite_test_pkey','rewrite_test_info_key','pg_toast_17142');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp; &nbsp;| relfilenode&nbsp;</font></div><div><font size="2"  >-----------------------+-------------</font></div><div><font size="2"  >&nbsp;rewrite_test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 17164</font></div><div><font size="2"  >&nbsp;rewrite_test_info_key | &nbsp; &nbsp; &nbsp; 17171</font></div><div><font size="2"  >&nbsp;rewrite_test_pkey &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 17170</font></div><div><font size="2"  >&nbsp;pg_toast_17142 &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 17167</font></div><div><font size="2"  >(4 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- 从varchar(4096)到varchar(8192) 不需要rewrite.</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# alter table rewrite_test alter column info type varchar(8192);</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >digoal=# select relname,relfilenode from pg_class where relname in ('rewrite_test','rewrite_test_pkey','rewrite_test_info_key','pg_toast_17142');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp; &nbsp;| relfilenode&nbsp;</font></div><div><font size="2"  >-----------------------+-------------</font></div><div><font size="2"  >&nbsp;rewrite_test_info_key | &nbsp; &nbsp; &nbsp; 17171</font></div><div><font size="2"  >&nbsp;rewrite_test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 17164</font></div><div><font size="2"  >&nbsp;rewrite_test_pkey &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 17170</font></div><div><font size="2"  >&nbsp;pg_toast_17142 &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 17167</font></div><div><font size="2"  >(4 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- 从varchar(8192)到text</span><span style="line-height: 22px;"  >(注意这不是扩字段长度, 而是变更字段类型.</span><span style="line-height: 22px;"  >但是显然PG里面varchar和text底层存储结构是一样的, 所以没有rewrite heap和toast)</span><span style="line-height: 22px;"  >&nbsp;不需要rewrite.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# alter table rewrite_test alter column info type text;</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >digoal=# select relname,relfilenode from pg_class where relname in ('rewrite_test','rewrite_test_pkey','rewrite_test_info_key','pg_toast_17142');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp; &nbsp;| relfilenode&nbsp;</font></div><div><font size="2"  >-----------------------+-------------</font></div><div><font size="2"  >&nbsp;rewrite_test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 17164</font></div><div><font size="2"  >&nbsp;rewrite_test_pkey &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 17170</font></div><div><font size="2"  >&nbsp;pg_toast_17142 &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 17167</font></div><div><font size="2"  >&nbsp;rewrite_test_info_key | &nbsp; &nbsp; &nbsp; 17171</font></div><div><font size="2"  >(4 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- 从text到text 不需要rewrite.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# alter table rewrite_test alter column info type text;</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >digoal=# select relname,relfilenode from pg_class where relname in ('rewrite_test','rewrite_test_pkey','rewrite_test_info_key','pg_toast_17142');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp; &nbsp;| relfilenode&nbsp;</font></div><div><font size="2"  >-----------------------+-------------</font></div><div><font size="2"  >&nbsp;rewrite_test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 17164</font></div><div><font size="2"  >&nbsp;rewrite_test_pkey &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 17170</font></div><div><font size="2"  >&nbsp;pg_toast_17142 &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 17167</font></div><div><font size="2"  >&nbsp;rewrite_test_info_key | &nbsp; &nbsp; &nbsp; 17171</font></div><div><font size="2"  >(4 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- 从numeric(10)到numeric(11) 不需要rewrite.</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# alter table rewrite_test alter column c1 type numeric(11);</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >digoal=# select relname,relfilenode from pg_class where relname in ('rewrite_test','rewrite_test_pkey','rewrite_test_info_key','pg_toast_17142');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp; &nbsp;| relfilenode&nbsp;</font></div><div><font size="2"  >-----------------------+-------------</font></div><div><font size="2"  >&nbsp;rewrite_test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 17164</font></div><div><font size="2"  >&nbsp;rewrite_test_pkey &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 17170</font></div><div><font size="2"  >&nbsp;pg_toast_17142 &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 17167</font></div><div><font size="2"  >&nbsp;rewrite_test_info_key | &nbsp; &nbsp; &nbsp; 17171</font></div><div><font size="2"  >(4 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- 从numeric(11)到numeric(11) 不需要rewrite.</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# alter table rewrite_test alter column c1 type numeric(11);</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >digoal=# select relname,relfilenode from pg_class where relname in ('rewrite_test','rewrite_test_pkey','rewrite_test_info_key','pg_toast_17142');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp; &nbsp;| relfilenode&nbsp;</font></div><div><font size="2"  >-----------------------+-------------</font></div><div><font size="2"  >&nbsp;rewrite_test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 17164</font></div><div><font size="2"  >&nbsp;rewrite_test_pkey &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 17170</font></div><div><font size="2"  >&nbsp;pg_toast_17142 &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 17167</font></div><div><font size="2"  >&nbsp;rewrite_test_info_key | &nbsp; &nbsp; &nbsp; 17171</font></div><div><font size="2"  >(4 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- 删除text字段上的索引后,&nbsp;</span><span style="line-height: 22px;"  >从text</span><span style="line-height: 22px;"  >到text</span><span style="line-height: 22px;"  >&nbsp;</span><span style="line-height: 22px;"  >&nbsp; 不需要rewrite.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# alter table rewrite_test drop constraint rewrite_test_info_key;</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >digoal=# alter table rewrite_test alter column info type text;</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >digoal=# select relname,relfilenode from pg_class where relname in ('rewrite_test','rewrite_test_pkey','rewrite_test_info_key','pg_toast_17142');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp;| relfilenode&nbsp;</font></div><div><font size="2"  >-------------------+-------------</font></div><div><font size="2"  >&nbsp;rewrite_test &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 17164</font></div><div><font size="2"  >&nbsp;rewrite_test_pkey | &nbsp; &nbsp; &nbsp; 17170</font></div><div><font size="2"  >&nbsp;pg_toast_17142 &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 17167</font></div><div><font size="2"  >(3 rows)</font></div><p></p></pre></div><div><br></div></div><div>【小结】</div><div>1. PostgreSQL 9.1 并不是每次alter table .. alter column type都会rewrite所有的对象(heap,index,toast). 某些操作只会rewrite 相应对象, 如索引.</div><div>2. PostgreSQL 9.2 扩字段长度 ( varchar-&gt;text, numeric(小)-&gt;numeric(大) ) 不需要rewrite heap,toast,index.</div><div>3.&nbsp;<span style="line-height: 22px;"  >PostgreSQL 9.2 alter column type 不改变字段类型及长度的情况下不需要rewrite heap,toast,index. PostgreSQL 9.1则可能需要reindex 对应的索引.</span></div><div><span style="line-height: 22px;"  >4. 变更字段类型会不会重写表, 和底层的存储结构由关系, 如int4和int8底层存储结构不一致(分别占用4字节和8字节). 因此需要rewrite.</span></div><div>而varchar和text底层存储结构应该是一致的, 所以扩字段长度不需要rewrite heap和toast.</div><div><br></div><div>【参考】</div><div>src/backend/commands/tablecmds.c</div><div>9.2 很多注释并没有修改掉, 保留和和以前版本一样的注释, 不完全可信.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case AT_AddColumn: &nbsp; &nbsp; &nbsp;/* may rewrite heap, in some cases and visible</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* to SELECT */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case AT_DropColumn: &nbsp; &nbsp; /* change visible to SELECT */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case AT_AddColumnToView: &nbsp; &nbsp; &nbsp; &nbsp;/* CREATE VIEW */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case AT_AlterColumnType: &nbsp; &nbsp; &nbsp; &nbsp;/* must rewrite heap */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case AT_DropConstraint: &nbsp; &nbsp; &nbsp; &nbsp; /* as DROP INDEX */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case AT_AddOids: &nbsp; &nbsp; &nbsp; &nbsp;/* must rewrite heap */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case AT_DropOids: &nbsp; &nbsp; &nbsp; /* calls AT_DropColumn */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case AT_EnableAlwaysRule: &nbsp; &nbsp; &nbsp; /* may change SELECT rules */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case AT_EnableReplicaRule: &nbsp; &nbsp; &nbsp;/* may change SELECT rules */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case AT_EnableRule: &nbsp; &nbsp; /* may change SELECT rules */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case AT_DisableRule: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* may change SELECT rules */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case AT_ChangeOwner: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* change visible to SELECT */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case AT_SetTableSpace: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* must rewrite heap */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case AT_DropNotNull: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* may change some SQL plans */</font></div><p></p></pre></div><div>ALTER TABLE 分三个阶段, rewrite表在第三个阶段完成 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >/*</font></div><div><font size="2"  >&nbsp;* AlterTable</font></div><div><font size="2"  >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Execute ALTER TABLE, which can be a list of subcommands</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* ALTER TABLE is performed in three phases:</font></div><div><font size="2"  >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1. Examine subcommands and perform pre-transformation checking.</font></div><div><font size="2"  >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2. Update system catalogs.</font></div><div><font size="2"  >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3. Scan table(s) to check new constraints, and optionally recopy</font></div><div><font size="2"  >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; the data into new table(s).</font></div><div><font size="2"  >&nbsp;* Phase 3 is not performed unless one or more of the subcommands requires</font></div><div><font size="2"  >&nbsp;* it. &nbsp;The intention of this design is to allow multiple independent</font></div><div><font size="2"  >&nbsp;* updates of the table schema to be performed with only one pass over the</font></div><div><font size="2"  >&nbsp;* data.</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* ATPrepCmd performs phase 1. &nbsp;A "work queue" entry is created for</font></div><div><font size="2"  >&nbsp;* each table to be affected (there may be multiple affected tables if the</font></div><div><font size="2"  >&nbsp;* commands traverse a table inheritance hierarchy). &nbsp;Also we do preliminary</font></div><div><font size="2"  >&nbsp;* validation of the subcommands, including parse transformation of those</font></div><div><font size="2"  >&nbsp;* expressions that need to be evaluated with respect to the old table</font></div><div><font size="2"  >&nbsp;* schema.</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* ATRewriteCatalogs performs phase 2 for each affected table. &nbsp;(Note that</font></div><div><font size="2"  >&nbsp;* phases 2 and 3 normally do no explicit recursion, since phase 1 already</font></div><div><font size="2"  >&nbsp;* did it --- although some subcommands have to recurse in phase 2 instead.)</font></div><div><font size="2"  >&nbsp;* Certain subcommands need to be performed before others to avoid</font></div><div><font size="2"  >&nbsp;* unnecessary conflicts; for example, DROP COLUMN should come before</font></div><div><font size="2"  >&nbsp;* ADD COLUMN. &nbsp;Therefore phase 1 divides the subcommands into multiple</font></div><div><font size="2"  >&nbsp;* lists, one for each logical "pass" of phase 2.</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* ATRewriteTables performs phase 3 for those tables that need it.</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* Thanks to the magic of MVCC, an error anywhere along the way rolls back</font></div><div><font size="2"  >&nbsp;* the whole operation; we don't have to do anything special to clean up.</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* The caller must lock the relation, with an appropriate lock level&nbsp;</font></div><div><font size="2"  >&nbsp;* for the subcommands requested. Any subcommand that needs to rewrite</font></div><div><font size="2"  >&nbsp;* tuples in the table forces the whole command to be executed with</font></div><div><font size="2"  >&nbsp;* AccessExclusiveLock (actually, that is currently required always, but</font></div><div><font size="2"  >&nbsp;* we hope to relax it at some point). &nbsp;We pass the lock level down</font></div></div><div><div><font size="2"  >&nbsp;* so that we can apply it recursively to inherited tables. Note that the</font></div><div><font size="2"  >&nbsp;* lock level we want as we recurse might well be higher than required for</font></div><div><font size="2"  >&nbsp;* that specific subcommand. So we pass down the overall lock requirement,</font></div><div><font size="2"  >&nbsp;* rather than reassess it at lower levels.</font></div><div><font size="2"  >&nbsp;*/</font></div></div><p></p></pre></div><div>ATRewriteTables和ATRewriteTable这两个函数在9.1.3和9.2 beta1中完全一致.</div></div>
	</div>
</div>
</body>
</html>