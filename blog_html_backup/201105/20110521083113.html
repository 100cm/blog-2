<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">a mongodb 1.8.1 unauthorized BUG when I change replicaSet config in Primary</h2>
	<h5 id="">2011-05-21 8:31:13&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201142182055337/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">今天在给一组mongoDB replicaSet修改配置的时候，遇到一个BUG。<div>环境是这样的：</div><div>3台服务器组成的3 full nodes replicaSet.</div><div>由于其中一台服务器配置比较差，准备调整"priority" : 0</div><div>让这台节点不会自动转会为primary.</div><div>引起BUG的是开启了keyFile(1.8.1使用keyFile来实现member之间的认证),也就是replicaSet的authorization.(看样子目前replicaSet的authorization还是不稳定啊。)</div><div>修改配置如下：</div><div>首先在primary修改配置</div><div><div>digoal:PRIMARY&gt; conf=rs.conf()</div><div>{</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "_id" : "digoal",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "version" : 1,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "members" : [</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 0,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "host" : "192.168.xxx.xxx:5281"</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 1,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "host" : "192.168.xxx.xxx:5281"</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 2,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "host" : "192.168.xxx.xxx:5281"</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; ]</div><div>}</div></div><div><br></div><div><div>digoal:PRIMARY&gt; conf.members[1].priority=0</div><div>0</div><div>digoal:PRIMARY&gt; conf</div><div>{</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "_id" : "digoal",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "version" : 1,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "members" : [</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 0,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "host" : "192.168.xxx.xxx:5281"</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 1,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "host" : "192.168.xxx.xxx:5281",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "priority" : 0</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 2,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "host" : "192.168.xxx.xxx:5281"</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; ]</div><div>}</div><div>digoal:PRIMARY&gt; rs.reconfig(conf)</div></div><div><div>digoal:PRIMARY&gt; db.auth("digoal","digoalpwd")</div><div>1</div><div>digoal:PRIMARY&gt; rs.conf()</div><div>{</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "_id" : "digoal",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "version" : 2,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "members" : [</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 0,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "host" : "192.168.xxx.xxx:5281"</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 1,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "host" : "192.168.xxx.xxx:5281",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "priority" : 0</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 2,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "host" : "192.168.xxx.xxx:5281"</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; ]</div><div>}</div></div><div>从主节点来看，配置已经生效了。</div><div>但是在任何一个SLAVE节点，都没有生效</div><div><div style="line-height: 22px;">digoal:SECONDARY&gt; rs.conf()</div><div style="line-height: 22px;">{</div><div style="line-height: 22px;">&nbsp; &nbsp; &nbsp; &nbsp; "_id" : "digoal",</div><div style="line-height: 22px;">&nbsp; &nbsp; &nbsp; &nbsp; "version" : 1,</div><div style="line-height: 22px;">&nbsp; &nbsp; &nbsp; &nbsp; "members" : [</div><div style="line-height: 22px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div style="line-height: 22px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 0,</div><div style="line-height: 22px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "host" : "192.168.xxx.xxx:5281"</div><div style="line-height: 22px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div style="line-height: 22px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div style="line-height: 22px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 1,</div><div style="line-height: 22px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "host" : "192.168.xxx.xxx:5281"</div><div style="line-height: 22px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div style="line-height: 22px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div style="line-height: 22px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 2,</div><div style="line-height: 22px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "host" : "192.168.xxx.xxx:5281"</div><div style="line-height: 22px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div style="line-height: 22px;">&nbsp; &nbsp; &nbsp; &nbsp; ]</div><div style="line-height: 22px;">}</div></div><div>从SLAVE节点的日志来看，</div><div><div>Sat May 21 07:44:48 [rs Manager] replset msgReceivedNewConfig version: version: 3</div><div>Sat May 21 07:44:48 [rs Manager] replSet info saving a newer config version to local.system.replset</div><div>Sat May 21 07:44:48 [rs Manager] Server::doWork task:rs Manager exception:unauthorized db:local lock type:2 client:(NONE)</div><div>Sat May 21 07:44:49 [conn3] run command admin.$cmd { replSetHeartbeat: "digoal", v: 1, pv: 1, checkEmpty: false, from: "192.168.175.71:5281" }</div><div>Sat May 21 07:44:49 [conn3] query admin.$cmd ntoreturn:1 command: { replSetHeartbeat: "digoal", v: 1, pv: 1, checkEmpty: false, from: "192.168.175.71:5281" } reslen:132 0ms</div><div>Sat May 21 07:44:49 [conn4] run command admin.$cmd { replSetHeartbeat: "digoal", v: 3, pv: 1, checkEmpty: false, from: "192.168.175.67:5281" }</div><div>Sat May 21 07:44:49 [conn4] query admin.$cmd ntoreturn:1 command: { replSetHeartbeat: "digoal", v: 3, pv: 1, checkEmpty: false, from: "192.168.175.67:5281" } reslen:132 0ms</div></div><div>从这上面来看，replicaSet的节点之间已经失去认证了。</div><div>不修改配置的话不会这样，一切正常。</div><div>后来查到，mongodb告知这是一个BUG。修复办法是升级到1.8.2,1.9.0</div><div>于是就找来1.8.2的版本，但是问题更蹊跷。</div><div>在起1.8.2的时候连库都起不来</div><div><div>mmongo@db-digoal-&gt; mongod -h</div><div>Sat May 21 08:07:52 Invalid access at address: 0x1</div><div><br></div><div>Sat May 21 08:07:52 Got signal: 11 (Segmentation fault).</div><div><br></div><div>Sat May 21 08:07:52 Backtrace:</div><div>0x8a66b9 0x8a6c90 0x314600eb10 0x3145879b60 0x56d3d3 0x8a5149 0x8ad2a3 0x314581d994 0x4e1009&nbsp;</div><div>&nbsp;mongod(_ZN5mongo10abruptQuitEi+0x399) [0x8a66b9]</div><div>&nbsp;mongod(_ZN5mongo24abruptQuitWithAddrSignalEiP7siginfoPv+0x220) [0x8a6c90]</div><div>&nbsp;/lib64/libpthread.so.0 [0x314600eb10]</div><div>&nbsp;/lib64/libc.so.6(strlen+0x10) [0x3145879b60]</div><div>&nbsp;mongod(_ZN5mongo13show_warningsEv+0x363) [0x56d3d3]</div><div>&nbsp;mongod(_Z14show_help_textN5boost15program_options19options_descriptionE+0x9) [0x8a5149]</div><div>&nbsp;mongod(main+0x10d3) [0x8ad2a3]</div><div>&nbsp;/lib64/libc.so.6(__libc_start_main+0xf4) [0x314581d994]</div><div>&nbsp;mongod(__gxx_personality_v0+0x3a1) [0x4e1009]</div><div><br></div><div>Sat May 21 08:07:52 dbexit:&nbsp;</div><div>Sat May 21 08:07:52 File I/O errno:29 Illegal seek</div><div>shutdown: going to close listening sockets...</div><div>Sat May 21 08:07:52 shutdown: going to flush diaglog...</div><div>Sat May 21 08:07:52 shutdown: going to close sockets...</div><div>Sat May 21 08:07:52 shutdown: waiting for fs preallocator...</div><div>Sat May 21 08:07:52 shutdown: closing all files...</div><div>Sat May 21 08:07:52 closeAllFiles() finished</div><div>Sat May 21 08:07:52 dbexit: really exiting now</div></div><div><br></div><div>于是只能放弃升级到1.8.2,暂时将keyFile的参数去掉，用1.8.1来起，配置得以同步到SLAVE节点。恢复正常。<wbr></div><div>再在服务器的iptables里面配置安全选项。</div></div>
	</div>
</div>
</body>
</html>