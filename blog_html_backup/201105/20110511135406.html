<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">a foolish sync method about sync data from PostgreSQL to Oracle</h2>
	<h5 id="">2011-05-11 13:54:06&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201141102221978/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">使用以下脚步从PostgreSQL同步到Oracle的数据不一致。<div>&nbsp;原因分析在后面</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >#!/bin/bash</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >. /home/enterprisedb/.bash_profile</font></div><div><font size="2"  >EMAIL="noc@xxx.com dba@xxx.com"</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># check running mark</font></div><div><font size="2"  >test -f /home/enterprisedb/script/run/tbl_charge_xxxx.run</font></div><div><font size="2"  >if [ $? -eq 0 ]; then</font></div><div><font size="2"  >SYNC_TIME_CHECK="'`ls -1 -l --time-style=+%F\ %T /home/enterprisedb/script/run/tbl_charge_xxxx.run|awk '{print $6" "$7}'`'"&nbsp;</font></div><div><font size="2"  >psql -t -h /tmp -p 1921 -U enterprisedb -d edb &lt;&lt;EOF 1&gt;/home/enterprisedb/script/tbl_charge_xxxx.timeoutstats 2&gt;&amp;1</font></div><div><font size="2"  >select 'sync_time_out' where now()-$SYNC_TIME_CHECK::timestamp without time zone&gt;interval '1 hour';</font></div><div><font size="2"  >EOF</font></div><div><font size="2"  >TIME_OUT_ERROR=0</font></div><div><font size="2"  >TIME_OUT_ERROR=`grep -c "sync_time_out" /home/enterprisedb/script/tbl_charge_xxxx.timeoutstats`</font></div><div><font size="2"  >if [ $TIME_OUT_ERROR -ne 0 ]; then</font></div><div><font size="2"  >echo -e "`cat /home/enterprisedb/script/tbl_charge_xxxx.timeoutstats`\n\n`date +%F%T`\n sync xxxx xltj.msss.sa_sales_info_xxxx timeout!\n\nPlease Call Digoal!\n"|mutt -s "Sync xxxx XLTJ timeout!" $EMAIL</font></div><div><font size="2"  >echo -e "sync timeout"</font></div><div><font size="2"  >fi</font></div><div><font size="2"  >exit 3</font></div><div><font size="2"  >fi</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># create running mark</font></div><div><font size="2"  >touch /home/enterprisedb/script/run/tbl_charge_xxxx.run</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >MAX_T="'`psql -t -h /tmp -p 1921 -U enterprisedb -d edb -c "select max(id) from msss.tbl_charge_xxxx_recent@edb.xl_local"|sed -e 's/ //g'`'"</font></div><div><font size="2"  >echo $MAX_T</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >psql -t -h /tmp -p 1921 -U enterprisedb -d edb &lt;&lt;EOF 1&gt;/home/enterprisedb/script/tbl_charge_xxxx.stats 2&gt;&amp;1</font></div><div><font size="2"  >begin;</font></div><div><font size="2"  >select 'start sync: '||now();</font></div><div><font size="2"  >delete from msss.tbl_charge_xxxx_recent@edb.xl_local&nbsp;</font></div><div><font size="2"  >where&nbsp;</font></div><div><font size="2"  >id &lt; $MAX_T ;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >insert into msss.tbl_charge_xxxx_recent@edb.xl_local&nbsp;</font></div><div><font size="2"  >(id,mobile,xxxxxx,xxxx,mobi_factory,mobi_mode,hsv,org_id,ver,send_date,create_date,MODEVER,BUILDTIME)&nbsp;</font></div><div><font size="2"  >select id,trim(coalesce(phonenum,'nvl')),trim(xxxxxx),trim(xxxx),trim(coalesce(hsman,'nvl')),trim(coalesce(hstype,'nvl')),to_number(hsversion,'99999999999999999999'),trim(hsman),to_number(appversion,'99999999999999999999'),to_char(motime,'yyyymmddhh24miss'),to_char(createtime,'yyyymmddhh24miss'),trim(coalesce(SOFTVERSION,'nvl')),trim(coalesce(SOFTCOMPILETIME,'nvl'))</font></div><div><font size="2"  >from xxxx.tbl_charge_xxxx@edb.xxxx_pg&nbsp;</font></div><div><font size="2"  >where</font></div><div><font size="2"  >id &gt; ${MAX_T}</font></div><div><font size="2"  >and appid=810007</font></div><div><font size="2"  >;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >insert into msss.SA_SALES_INFO_xxxx@edb.xl_local&nbsp;</font></div><div><font size="2"  >(id,mobile,xxxxxx,xxxx,mobi_factory,mobi_mode,hsv,org_id,ver,mccid,MODEVER,BUILDTIME)</font></div><div><font size="2"  >select</font></div><div><font size="2"  >id,coalesce(mobile,'nvl'),xxxxxx,xxxx,coalesce(mobi_factory,'nvl'),coalesce(mobi_mode,'nvl'),hsv,org_id,ver,case substring(xxxx,1,3) when ('234','235') then '234' when ('310','311','312','313','314','315','316') then '310' when ('430','431') then '430' when ('440','441') then '440' when ('460','461') then '460' else substring(xxxx,1,3) end,MODEVER,BUILDTIME</font></div><div><font size="2"  >from msss.tbl_charge_xxxx_recent@edb.xl_local</font></div><div><font size="2"  >where&nbsp;</font></div><div><font size="2"  >id &gt; ${MAX_T} ;</font></div><div><font size="2"  >commit;</font></div><div><font size="2"  >EOF</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># logging</font></div><div><font size="2"  >cat /home/enterprisedb/script/tbl_charge_xxxx.stats &gt;&gt; /home/enterprisedb/script/tbl_charge_xxxx.log</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># delete running mark</font></div><div><font size="2"  >sleep 10</font></div><div><font size="2"  >rm -f /home/enterprisedb/script/run/tbl_charge_xxxx.run</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >ERROR=0</font></div><div><font size="2"  >ERROR=`grep -c "ROLLBACK" /home/enterprisedb/script/tbl_charge_xxxx.stats`</font></div><div><font size="2"  >if [ $ERROR -ne 0 ]; then</font></div><div><font size="2"  >echo -e "`cat /home/enterprisedb/script/tbl_charge_xxxx.stats`\n\n`date +%F%T`\n sync xxxx xltj error!\n\nPlease Call Digoal!\n"|mutt -s "Sync xxxx XLTJ error!" $EMAIL</font></div><div><font size="2"  >echo -e "sync error"</font></div><div><font size="2"  >fi</font></div><p></p></pre></div><div><br>逻辑大概是这样的:<wbr></div></div><div>根据PostgreSQL里面需要同步的表的PK，增量同步数据到Oracle。</div><div>看起来很美好，增量的，健康的。</div><div>问题就出在增量这里。如果系统中只有一个SESSION对这个表操作时，ID确实是随着时间递增的。</div><div>但是当有多个SESSION同时操作一个表时，SEQUENCE分配给多个SESSION，但是SESSION的COMMIT顺序可能与SEQUENCE的分配顺序不一致。从而抽取数据时会出现空隙的现象。</div><div>例如，有两个SESSION</div><div>session 1 获取到得SEQID是1-10</div><div>session 2&nbsp;获取到得SEQID是11-20</div><div>session 2先提交，在session 1提交之前，数据同步到ORACLE了。</div><div>接下来同步取id&gt;20的数据，因此1-10的数据就漏掉了。</div><div><br></div><div>另外，使用记录创建时间来抽取也存在类似问题，因为记录创建时间是事务的启动时间，不是提交时间。</div></div>
	</div>
</div>
</body>
</html>