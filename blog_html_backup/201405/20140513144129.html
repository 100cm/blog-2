<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">pgpool-II load balance with stream replication</h2>
	<h5 id="">2014-05-13 14:41:29&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014413104753331/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前面测试过pgpool带来的性能损失, 请参考<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014316448141/"   >http://blog.163.com/digoal@126/blog/static/1638770402014316448141/</a></div><div>pgpool虽然对QPS的性能损失较大, 但是它的其他功能还是值得推荐的.</div><div>例如load balance. parallel, HA.</div><div>本文将介绍一下load balance.</div><div>pgpool 的 load balance可以基于三种模式来实现.</div><div>1. replication</div><div>2. stream</div><div>3. slony-I</div><div>这三种模式最不推荐的是replication模式 , 它是由pgpool来控制的前端数据分发的复制功能, 例如一个插入语句, 将会在所有的backend database执行, 如果backend database的返回消息不一致, 则会选择degenerate少的部分backend(少数服从多数的意思), 或者是整个事务失败(由参数replication_stop_on_mismatch, failover_if_affected_tuples_mismatch 控制). 这其实是个坑, 因为pgpool未提及差异数据的修复. 所以极度不推荐使用. 类似产品有&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.continuent.com/"   >http://www.continuent.com/</a></div><div><br></div><div>stream模式使用了PostgreSQL自身提供的流复制特性. 相对来说是最完善的. 所以推荐使用.</div><div>不管哪种模式, load balance都要考虑哪些SQL可以被分发到standby节点, 目前只有只读查询可以被分发到standby节点, 并且还需要考虑函数的影响, 因为有些函数是会修改数据库的, 例如nextval, 或者自定义的函数里面包含了select以外的查询.</div><div>还需要考虑SELECT在事务中的情况, 对于事务中的查询不建议在standby错开节点.</div><div>另外还有基于游标的更新也是需要注意的.</div><div>pgpool的处理意见是, 包含函数的查询都只分发给master, 除非配置了white_function_list&nbsp;.</div><div>好了, 接下来是简单的配置过程.</div><div>1. 配置流复制环境, 一主一备, 端口分别为1999,2000.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-39-&gt; pg_ctl stop -m fast</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >g93@db-172-16-3-39-&gt; cd $PGDATA</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; ll</font></div><div><font size="2"   >total 4.0K</font></div><div><font size="2"   >drwx------ 16 pg93 pg93 4.0K May 13 11:16 pg_root</font></div><div><font size="2"   >cd pg_root</font></div><div><font size="2"   >vi pg_hba.conf</font></div><div><font size="2"   >host all all 0.0.0.0/0 md5</font></div><div><font size="2"   >host replication postgres 172.16.3.39/32 md5</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; cp -r pg_root pg_root_2000</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; mv pg_root pg_root_1999</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; ll</font></div><div><font size="2"   >total 8.0K</font></div><div><font size="2"   >drwx------ 16 pg93 pg93 4.0K May 13 11:16 pg_root_1999</font></div><div><font size="2"   >drwx------ 16 pg93 pg93 4.0K May 13 11:17 pg_root_2000</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >pg93@db-172-16-3-39-&gt; cd pg_root_2000</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; vi postgresql.conf&nbsp;</font></div></div><div><font size="2"   >port = 2000</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >pg93@db-172-16-3-39-&gt; grep "^[a-z]" postgresql.conf&nbsp;</font></div><div><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"   >port = 2000 &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >max_connections = 500 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_directories = '.' &nbsp; # comma-separated list of directories</font></div><div><font size="2"   >unix_socket_permissions = 0700 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# begin with 0 to use octal notation</font></div><div><font size="2"   >password_encryption = on</font></div><div><font size="2"   >tcp_keepalives_idle = 60 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPIDLE, in seconds;</font></div><div><font size="2"   >tcp_keepalives_interval = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPINTVL, in seconds;</font></div><div><font size="2"   >tcp_keepalives_count = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # TCP_KEEPCNT;</font></div><div><font size="2"   >shared_buffers = 2048MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div><font size="2"   >max_stack_depth = 8MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 100kB</font></div><div><font size="2"   >shared_preload_libraries = 'pg_stat_statements' &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >vacuum_cost_delay = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 0-100 milliseconds</font></div><div><font size="2"   >vacuum_cost_limit = 10000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 credits</font></div><div><font size="2"   >bgwriter_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 10-10000ms between rounds</font></div><div><font size="2"   >wal_level = hot_standby &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, or hot_standby</font></div><div><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level;</font></div><div><font size="2"   >wal_sync_method = fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # the default is the first option</font></div><div><font size="2"   >wal_buffers = 16384kB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 32kB, -1 sets based on shared_buffers</font></div><div><font size="2"   >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"   >checkpoint_segments = 256 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # in logfile segments, min 1, 16MB each</font></div><div><font size="2"   >archive_mode = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # allows archiving to be done</font></div><div><font size="2"   >archive_command = '/bin/date' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # command to use to archive a logfile segment</font></div><div><font size="2"   >max_wal_senders = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of walsender processes</font></div><div><font size="2"   >wal_keep_segments = 512 &nbsp; &nbsp; &nbsp; &nbsp; # in logfile segments, 16MB each; 0 disables</font></div><div><font size="2"   >hot_standby = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# "on" allows queries during recovery</font></div><div><font size="2"   >max_standby_archive_delay = 300s &nbsp; &nbsp; &nbsp; &nbsp;# max delay before canceling queries</font></div><div><font size="2"   >max_standby_streaming_delay = 300s &nbsp; &nbsp; &nbsp;# max delay before canceling queries</font></div><div><font size="2"   >wal_receiver_status_interval = 1s &nbsp; &nbsp; &nbsp; # send replies at least this often</font></div><div><font size="2"   >hot_standby_feedback = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # send info from standby to prevent</font></div><div><font size="2"   >random_page_cost = 1.5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# same scale as above</font></div><div><font size="2"   >effective_cache_size = 8192MB</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_directory = 'pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,</font></div><div><font size="2"   >log_file_mode = 0600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# creation mode for log files,</font></div><div><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div><font size="2"   >log_rotation_age = 1d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Automatic rotation of logfiles will</font></div><div><font size="2"   >log_rotation_size = 10MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Automatic rotation of logfiles will</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_disconnections = on</font></div><div><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div><font size="2"   >log_lock_waits = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # log lock waits &gt;= deadlock_timeout</font></div><div><font size="2"   >log_statement = 'ddl' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # none, ddl, mod, all</font></div><div><font size="2"   >log_timezone = 'PRC'</font></div><div><font size="2"   >track_activity_query_size = 4096 &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >autovacuum = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Enable autovacuum subprocess? &nbsp;'on'</font></div><div><font size="2"   >log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</font></div><div><font size="2"   >autovacuum_freeze_max_age = 1500000000 &nbsp;# maximum XID age before forced vacuum</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >timezone = 'PRC'</font></div><div><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><div><font size="2"   >deadlock_timeout = 1s</font></div><div><font size="2"   >pg_stat_statements.max = 1000</font></div><div><font size="2"   >pg_stat_statements.track = all</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; cp $PGHOME/share/recovery.conf.sample ./</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; mv recovery.conf.sample recovery.conf</font></div><div><font size="2"   >vi recovery.conf</font></div><div><div><font size="2"   >recovery_target_timeline = 'latest'</font></div><div><font size="2"   >standby_mode = on</font></div><div><font size="2"   >primary_conninfo = 'host=172.16.3.39 port=1999 user=postgres keepalives_idle=60'</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; cp recovery.conf ../pg_root_1999/recovery.done</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; vi ../pg_root_1999/recovery.done</font></div><div><div style="line-height: 28px;"   ><font size="2"   >recovery_target_timeline = 'latest'</font></div><div style="line-height: 28px;"   ><font size="2"   >standby_mode = on</font></div></div><div><font size="2"   >primary_conninfo = 'host=172.16.3.39 port=2000 user=postgres keepalives_idle=60'</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >vi ~/.pgpass</font></div><div><div><font size="2"   >172.16.3.39:1999:*:postgres:postgres</font></div><div><font size="2"   >172.16.3.39:2000:*:postgres:postgres</font></div></div><div><font size="2"   >chmod 400 ~/.pgpass</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; pg_ctl start -D /pgdata/digoal/1921/data03/pg93/pg_root_1999</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; pg_ctl start -D /pgdata/digoal/1921/data03/pg93/pg_root_2000</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >pg93@db-172-16-3-39-&gt; psql -h 127.0.0.1 -p 1999</font></div><div><font size="2"   >Password:&nbsp;</font></div><div><font size="2"   >psql (9.3.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \du</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of roles</font></div><div><font size="2"   >&nbsp;Role name | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Attributes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Member of&nbsp;</font></div><div><font size="2"   >-----------+------------------------------------------------+-----------</font></div><div><font size="2"   >&nbsp;digoal &nbsp; &nbsp;| Superuser &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {}</font></div><div><font size="2"   >&nbsp;postgres &nbsp;| Superuser, Create role, Create DB, Replication | {}</font></div><div><font size="2"   >digoal=# \q</font></div><div><font size="2"   ><br></font></div><div><span style="line-height: 28px;"   ><font size="2"   >pg93@db-172-16-3-39-&gt; psql -h 127.0.0.1 -p 2000</font></span></div><div><font size="2"   >Password:&nbsp;</font></div><div><font size="2"   >psql (9.3.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select pg_is_in_recovery();</font></div><div><font size="2"   >&nbsp;pg_is_in_recovery&nbsp;</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp;t</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >ps -ewf|grep stream</font></div><div><font size="2"   >postgres: wal sender process postgres 172.16.3.39(21679) streaming 2/E4</font></div><p></p></pre></div><div><br></div><div>2. 安装pgpool</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 soft_bak]# wget http://www.pgpool.net/download.php?f=pgpool-II-3.3.3.tar.gz</font></div><div><font size="2"   >[root@db-172-16-3-150 soft_bak]# mv download.php\?f\=pgpool-II-3.3.3.tar.gz pgpool.tar.gz</font></div><div><font size="2"   >[root@db-172-16-3-150 soft_bak]# tar -zxvf pgpool.tar.gz</font></div><div><div><font size="2"   >[root@db-172-16-3-150 soft_bak]# cd pgpool-II-3.3.3/</font></div><div><font size="2"   >[root@db-172-16-3-150 pgpool-II-3.3.3]#&nbsp;</font></div></div><div><font size="2"   >这一步需要注意, 最好pgpool依赖的postgresql版本和backend database的数据库版本一致. 例如都是9.3.1</font></div><div><font size="2"   >[root@db-172-16-3-150 pgpool-II-3.3.3]# ./configure --prefix=/opt/pgpool3.3.3 --with-pgsql=/home/pg93/pgsql9.3.1</font></div><div><font size="2"   >[root@db-172-16-3-150 pgpool-II-3.3.3]# gmake &amp;&amp; gmake install</font></div><p></p></pre></div><div><br></div><div>3. 配置pgpool</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 etc]# cd /opt/pgpool3.3.3/etc/</font></div><div><font size="2"   >[root@db-172-16-3-150 etc]# cp pool_hba.conf.sample pool_hba.conf</font></div><div><font size="2"   >[root@db-172-16-3-150 etc]# cp pgpool.conf.sample-stream pgpool.conf</font></div><div><font size="2"   >[root@db-172-16-3-150 etc]# cp pcp.conf.sample pcp.conf</font></div></div><div><font size="2"   >[root@db-172-16-3-150 etc]# vi pgpool.conf</font></div><div><div><font size="2"   >listen_addresses = '0.0.0.0'</font></div><div><font size="2"   >port = 9999</font></div><div><font size="2"   >socket_dir = '/tmp'</font></div><div><font size="2"   >pcp_port = 9898</font></div><div><font size="2"   >pcp_socket_dir = '/tmp'</font></div><div><font size="2"   >backend_hostname0 = '172.16.3.39'</font></div><div><font size="2"   >backend_port0 = 1999&nbsp;</font></div><div><font size="2"   >backend_weight0 = 1</font></div><div><font size="2"   >backend_flag0 = 'ALLOW_TO_FAILOVER'</font></div><div><font size="2"   >backend_hostname1 = '172.16.3.39'</font></div><div><font size="2"   >backend_port1 = 2000</font></div><div><font size="2"   >backend_weight1 = 1</font></div><div><font size="2"   >backend_flag1 = 'ALLOW_TO_FAILOVER'</font></div><div><font size="2"   >enable_pool_hba = on</font></div><div><font size="2"   >pool_passwd = 'pool_passwd'</font></div><div><font size="2"   >authentication_timeout = 60</font></div><div><font size="2"   >ssl = off</font></div><div><font size="2"   >num_init_children = 32</font></div><div><font size="2"   >max_pool = 4</font></div><div><font size="2"   >child_life_time = 300</font></div><div><font size="2"   >child_max_connections = 0</font></div><div><font size="2"   >connection_life_time = 0</font></div><div><font size="2"   >client_idle_limit = 0</font></div><div><font size="2"   >log_destination = 'syslog'</font></div><div><font size="2"   >print_timestamp = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_hostname = off</font></div><div><font size="2"   ># 以下两个参数用于调试, 能看到sql balance的情况.</font></div><div><font size="2"   >log_statement = on</font></div><div><font size="2"   >log_per_node_statement = on</font></div><div><font size="2"   >log_standby_delay = 'always'</font></div><div><font size="2"   >syslog_facility = 'LOCAL0'</font></div><div><font size="2"   >syslog_ident = 'pgpool'</font></div><div><font size="2"   >debug_level = 0</font></div><div><font size="2"   >pid_file_name = '/var/run/pgpool/pgpool.pid'</font></div><div><font size="2"   >logdir = '/tmp'</font></div><div><font size="2"   >connection_cache = on</font></div><div><font size="2"   >reset_query_list = 'ABORT; DISCARD ALL'</font></div><div><font size="2"   >replication_mode = off</font></div><div><font size="2"   >replicate_select = off</font></div><div><font size="2"   >insert_lock = off</font></div><div><font size="2"   >lobj_lock_table = ''</font></div><div><font size="2"   >replication_stop_on_mismatch = off</font></div><div><font size="2"   >failover_if_affected_tuples_mismatch = off</font></div><div><font size="2"   >load_balance_mode = on</font></div><div><font size="2"   >ignore_leading_white_space = on</font></div><div><font size="2"   >white_function_list = ''</font></div><div><font size="2"   >black_function_list = 'currval,lastval,nextval,setval'</font></div><div><font size="2"   >master_slave_mode = on</font></div><div><font size="2"   >master_slave_sub_mode = 'stream'</font></div><div><font size="2"   >sr_check_period = 2</font></div><div><font size="2"   >sr_check_user = 'srcheck'</font></div><div><font size="2"   >sr_check_password = 'SRCHECK'</font></div><div><font size="2"   >delay_threshold = 1024000</font></div><div><font size="2"   >follow_master_command = ''</font></div><div><font size="2"   >parallel_mode = off</font></div><div><font size="2"   >pgpool2_hostname = ''</font></div><div><font size="2"   >health_check_period = 0</font></div><div><font size="2"   >health_check_timeout = 20</font></div><div><font size="2"   >health_check_user = 'nobody'</font></div><div><font size="2"   >health_check_password = ''</font></div><div><font size="2"   >health_check_max_retries = 0</font></div><div><font size="2"   >health_check_retry_delay = 1</font></div><div><font size="2"   >failover_command = ''</font></div><div><font size="2"   >failback_command = ''</font></div><div><font size="2"   >fail_over_on_backend_error = on</font></div><div><font size="2"   >search_primary_node_timeout = 10</font></div><div><font size="2"   >recovery_user = 'nobody'</font></div><div><font size="2"   >recovery_password = ''</font></div><div><font size="2"   >recovery_1st_stage_command = ''</font></div><div><font size="2"   >recovery_2nd_stage_command = ''</font></div><div><font size="2"   >recovery_timeout = 90</font></div><div><font size="2"   >client_idle_limit_in_recovery = 0</font></div><div><font size="2"   >use_watchdog = off</font></div><div><font size="2"   >trusted_servers = ''</font></div><div><font size="2"   >ping_path = '/bin'</font></div><div><font size="2"   >wd_hostname = ''</font></div><div><font size="2"   >wd_port = 9000</font></div><div><font size="2"   >wd_authkey = ''</font></div><div><font size="2"   >delegate_IP = ''</font></div><div><font size="2"   >ifconfig_path = '/sbin'</font></div><div><font size="2"   >if_up_cmd = 'ifconfig eth0:0 inet $_IP_$ netmask 255.255.255.0'</font></div><div><font size="2"   >if_down_cmd = 'ifconfig eth0:0 down'</font></div><div><font size="2"   >arping_path = '/usr/sbin' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # arping command path</font></div><div><font size="2"   >arping_cmd = 'arping -U $_IP_$ -w 1'</font></div><div><font size="2"   >clear_memqcache_on_escalation = on</font></div><div><font size="2"   >wd_escalation_command = ''</font></div><div><font size="2"   >wd_lifecheck_method = 'heartbeat'</font></div><div><font size="2"   >wd_interval = 10</font></div><div><font size="2"   >wd_heartbeat_port = 9694</font></div><div><font size="2"   >wd_heartbeat_keepalive = 2</font></div><div><font size="2"   >wd_heartbeat_deadtime = 30</font></div><div><font size="2"   >heartbeat_destination0 = 'host0_ip1'</font></div><div><font size="2"   >heartbeat_destination_port0 = 9694&nbsp;</font></div><div><font size="2"   >heartbeat_device0 = ''</font></div><div><font size="2"   >wd_life_point = 3</font></div><div><font size="2"   >wd_lifecheck_query = 'SELECT 1'</font></div><div><font size="2"   >wd_lifecheck_dbname = 'template1'</font></div><div><font size="2"   >wd_lifecheck_user = 'nobody'</font></div><div><font size="2"   >wd_lifecheck_password = ''</font></div><div><font size="2"   >relcache_expire = 0</font></div><div><font size="2"   >relcache_size = 256</font></div><div><font size="2"   >check_temp_table = on</font></div><div><font size="2"   >memory_cache_enabled = off</font></div><div><font size="2"   >memqcache_method = 'shmem'</font></div><div><font size="2"   >memqcache_memcached_host = 'localhost'</font></div><div><font size="2"   >memqcache_memcached_port = 11211</font></div><div><font size="2"   >memqcache_total_size = 67108864</font></div><div><font size="2"   >memqcache_max_num_cache = 1000000</font></div><div><font size="2"   >memqcache_expire = 0</font></div><div><font size="2"   >memqcache_auto_cache_invalidation = on</font></div><div><font size="2"   >memqcache_maxcache = 409600</font></div><div><font size="2"   >memqcache_cache_block_size = 1048576</font></div><div><font size="2"   >memqcache_oiddir = '/var/log/pgpool/oiddir'</font></div><div><font size="2"   >white_memqcache_table_list = ''</font></div><div><font size="2"   >black_memqcache_table_list = ''</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-150 etc]# /opt/pgpool3.3.3/bin/pg_md5 -u sup_pool sup_pool_pwd</font></div><div><font size="2"   >c21777db255631573e4233403773bb3b</font></div></div><div><font size="2"   >[root@db-172-16-3-150 etc]# vi pcp.conf</font></div><div><font size="2"   >sup_pool:c21777db255631573e4233403773bb3b</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-150 etc]# vi pool_hba.conf</font></div><div><font size="2"   ># trust会导致错误</font></div><div><div><font size="2"   >local &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trust</font></div><div><font size="2"   >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div></div><div><font size="2"   >host all all 0.0.0.0/0 md5</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >配置密码文件</font></div><div><div><font size="2"   >digoal=# select rolname,rolpassword from pg_authid;</font></div><div><font size="2"   >&nbsp;rolname &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rolpassword &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----------+-------------------------------------</font></div><div><font size="2"   >&nbsp;postgres | md53175bce1d3201d16594cebf9d7eb3f9d</font></div><div><font size="2"   >&nbsp;digoal &nbsp; | md5462f71c79368ccf422f8a773ef40074d</font></div><div><font size="2"   >&nbsp;srcheck &nbsp;| md5662c10f61b27a9ab38ce69157186b25f</font></div><div><font size="2"   >(3 rows)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span style="line-height: 28px;"   >[root@db-172-16-3-150 etc]#</span><span style="line-height: 28px;"   >&nbsp;</span>vi&nbsp;pool_passwd</font></div><div><font size="2"   >postgres:md53175bce1d3201d16594cebf9d7eb3f9d</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >4. 创建check用户</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-39-&gt; psql -h 127.0.0.1 -p 1999</font></div><div><font size="2"   >Password:&nbsp;</font></div><div><font size="2"   >psql (9.3.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# create role srcheck nosuperuser login encrypted password 'SRCHECK';</font></div><div><font size="2"   >CREATE ROLE</font></div><p></p></pre></div><div><br></div><div>5. 启动pgpool</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 etc]# /opt/pgpool3.3.3/bin/pgpool -f /opt/pgpool3.3.3/etc/pgpool.conf</font></span></div><div><font size="2"   ><br></font></div><div><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 etc]# tail -f -n 2 /var/log/messages</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >May 13 11:56:45 db-172-16-3-150 pgpool[28153]: pgpool-II successfully started. version 3.3.3 (tokakiboshi)</font></div><div style="line-height: 28px;"   ><font size="2"   >May 13 11:56:45 db-172-16-3-150 pgpool[28153]: find_primary_node: primary node id is 0</font></div></div></div><p></p></pre></div><div><br></div><div>6. 常见连接错误</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 etc]# su - pg93</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 9999 -U postgres digoal</font></div><div><font size="2"   >psql: ERROR: &nbsp;MD5 authentication is unsupported in replication, master-slave and parallel modes.</font></div><div><font size="2"   >HINT: &nbsp;check pg_hba.conf</font></div></div><div><font size="2"   >这个错误的原因已经很清楚了, 需要修改pool_hba.conf, 对应的trust改成md5 . 对应的错误代码 :&nbsp;</font></div><div><font size="2"   >pool_auth.c</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* md5 authentication? */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; else if (authkind == 5)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* If MD5 auth is not active in pool_hba.conf, it cannot be</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* used with other than raw mode.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (frontend-&gt;auth_method != uaMD5 &amp;&amp; !RAW_MODE &amp;&amp; NUM_BACKENDS &gt; 1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pool_send_error_message(frontend, protoMajor, AUTHFAIL_ERRORCODE,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "MD5 authentication is unsupported in replication, master-slave and parallel modes.",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "check pg_hba.conf",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __FILE__, __LINE__);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return -1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div></div><div><font size="2"   >错误修复</font></div><div><div><font size="2"   >[root@db-172-16-3-150 pgpool-II-3.3.3]# cd /opt/pgpool3.3.3/etc/</font></div><div><font size="2"   >[root@db-172-16-3-150 etc]# vi pool_hba.conf</font></div></div><div><font size="2"   >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;md5</font></div><div><font size="2"   >[root@db-172-16-3-150 etc]# /opt/pgpool3.3.3/bin/pgpool -f /opt/pgpool3.3.3/etc/pgpool.conf reload</font></div><div><font size="2"   >这里存在BUG, 从trust改成md5后, 报错是没了, 但是密码也不提示就直接进了(这显然是有问题的).</font></div><div><div><font size="2"   >pg93@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 9999 -U postgres digoal</font></div><div><font size="2"   >psql (9.3.3, server 9.3.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \q</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >连接已配置为md5验证的条目. 已有的<span style="line-height: 28px;"   >172.16.3.150. 正常&nbsp;</span></font></div><div><div><font size="2"   >pg93@db-172-16-3-150-&gt; psql -h 172.16.3.150 -p 9999 -U postgres digoal</font></div><div><font size="2"   >Password for user postgres:&nbsp;</font></div><div><font size="2"   >psql (9.3.3, server 9.3.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \q</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >使用在pool_passwd中么有配置的用户连接.</font></div><div><span style="line-height: 28px;"   ><font size="2"   >pg93@db-172-16-3-150-&gt; psql -h 172.16.3.150 -p 9999 -U digoal digoal</font></span></div><div><font size="2"   >psql: ERROR: &nbsp;"MD5" authentication with pgpool failed for user "digoal"</font></div></div><div><font size="2"   >这个错误并没有提示输入密码就出错, 原因是在pool_passwd文件中没有加入digoal的密码.</font></div><div><font size="2"   >修复错误, 在pool_passwd中添加条目</font></div><div><div><font size="2"   >[root@db-172-16-3-150 etc]# vi pool_passwd&nbsp;</font></div><div><font size="2"   >digoal:md5462f71c79368ccf422f8a773ef40074d</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-150 etc]# /opt/pgpool3.3.3/bin/pgpool -f /opt/pgpool3.3.3/etc/pgpool.conf reload</font></div><div><font size="2"   >[root@db-172-16-3-150 etc]# su - pg93</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 9999 -U digoal digoal</font></div><div><font size="2"   >Password for user digoal:&nbsp;</font></div><div><font size="2"   >psql (9.3.3, server 9.3.1)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><font size="2"   >digoal=#&nbsp;</font></div><p></p></pre></div><div><br></div><div>7. 测试load balance</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# /*REPLICATION*/ SELECT 1;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# SELECT 1;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >May 13 14:00:24 db-172-16-3-150 pgpool[30046]: statement: /*REPLICATION*/ SELECT 1;</font></div><div><font size="2"   >May 13 14:00:24 db-172-16-3-150 pgpool[30046]: DB node id: 0 backend pid: 19371 statement: /*REPLICATION*/ SELECT 1;</font></div><div><font size="2"   >May 13 14:00:33 db-172-16-3-150 pgpool[30046]: statement: SELECT 1;</font></div><div><font size="2"   >May 13 14:00:33 db-172-16-3-150 pgpool[30046]: DB node id: 1 backend pid: 19372 statement: SELECT 1;</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >do默认分发到master节点, 因为pgpool不能确认do里面是否有修改数据库的动作.</font></div><div><div><font size="2"   >digoal=# do language plpgsql $$</font></div><div><font size="2"   >digoal$# declare&nbsp;</font></div><div><font size="2"   >digoal$# begin</font></div><div><font size="2"   >digoal$# &nbsp; raise notice 'test';</font></div><div><font size="2"   >digoal$# end;</font></div><div><font size="2"   >digoal$# $$;</font></div><div><font size="2"   >NOTICE: &nbsp;test</font></div><div><font size="2"   >DO</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >May 13 14:16:06 db-172-16-3-150 pgpool[30072]: statement: do language plpgsql $$#012declare #012begin#012 &nbsp;raise notice 'test';#012end;#012$$;</font></div><div><font size="2"   >May 13 14:16:06 db-172-16-3-150 pgpool[30072]: DB node id: 0 backend pid: 20575 statement: do language plpgsql $$#012declare #012begin#012 &nbsp;raise notice 'test';#012end;#012$$;</font></div><div><font size="2"   >May 13 14:16:06 db-172-16-3-150 pgpool[30072]: pool_send_and_wait: Error or notice message from backend: : DB node id: 0 backend pid: 20575 statement: do language plpgsql $$#012declare #012begin#012 &nbsp;raise notice 'test';#012end;#012$$; message: test</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >在仅仅设置了黑名单的情况下, 所有状态的函数(volatile, stable, immutable)都分发到standby节点.</font></div><div><div><font size="2"   >May 13 14:18:07 db-172-16-3-150 pgpool[30072]: statement: select now();</font></div><div><font size="2"   >May 13 14:18:07 db-172-16-3-150 pgpool[30072]: DB node id: 1 backend pid: 20576 statement: select now();</font></div><div><font size="2"   >May 13 14:18:28 db-172-16-3-150 pgpool[30072]: statement: select pg_is_in_recovery();</font></div><div><font size="2"   >May 13 14:18:28 db-172-16-3-150 pgpool[30072]: DB node id: 1 backend pid: 20576 statement: select pg_is_in_recovery();</font></div><div><font size="2"   >May 13 14:22:46 db-172-16-3-150 pgpool[30072]: statement: select clock_timestamp();</font></div><div><font size="2"   >May 13 14:22:46 db-172-16-3-150 pgpool[30072]: DB node id: 1 backend pid: 20576 statement: select clock_timestamp();</font></div></div><div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# create or replace function ft1(v_id int) returns int as</font></div><div><font size="2"   >$$</font></div><div><font size="2"   >declare &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; update t set info='new' where id=v_id;&nbsp;</font></div><div><font size="2"   >&nbsp; return 0;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >digoal=# select ft1(1);</font></div><div><font size="2"   >ERROR: &nbsp;cannot execute UPDATE in a read-only transaction</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "update t set info='new' where id=v_id"</font></div><div><font size="2"   >PL/pgSQL function ft1(integer) line 4 at SQL statement</font></div></div><div><font size="2"   >使用hint强行在master节点执行 :&nbsp;</font></div><div><div><font size="2"   >digoal=# /*REPLICATION*/ select ft1(1);</font></div><div><font size="2"   >&nbsp;ft1&nbsp;</font></div><div><font size="2"   >-----</font></div><div><font size="2"   >&nbsp; &nbsp;0</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >如果同时配置了黑名单和白名单, 那么以白名单为准, 不在白名单的都会发到master节点.</font></div><div><font size="2"   >[root@db-172-16-3-150 etc]# vi pgpool.conf</font></div><div><font size="2"   >white_function_list = 'ft'</font></div><div><font size="2"   >[root@db-172-16-3-150 etc]# /opt/pgpool3.3.3/bin/pgpool -f /opt/pgpool3.3.3/etc/pgpool.conf reload</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >May 13 14:36:08 db-172-16-3-150 pgpool[30056]: statement: select ft(1);</font></div><div><font size="2"   >May 13 14:36:08 db-172-16-3-150 pgpool[30056]: DB node id: 1 backend pid: 22331 statement: select ft(1);</font></div><div><font size="2"   >May 13 14:36:14 db-172-16-3-150 pgpool[30056]: statement: select ft1(1);</font></div><div><font size="2"   >May 13 14:36:14 db-172-16-3-150 pgpool[30056]: DB node id: 0 backend pid: 22330 statement: select ft1(1);</font></div><div><font size="2"   >May 13 14:36:18 db-172-16-3-150 pgpool[30056]: statement: select now();</font></div><div><font size="2"   >May 13 14:36:18 db-172-16-3-150 pgpool[30056]: DB node id: 0 backend pid: 22330 statement: select now();</font></div><div><font size="2"   >May 13 14:36:35 db-172-16-3-150 pgpool[30056]: statement: select clock_timestamp();</font></div><div><font size="2"   >May 13 14:36:35 db-172-16-3-150 pgpool[30056]: DB node id: 0 backend pid: 22330 statement: select clock_timestamp();</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >update正常分发到master节点</font></div><div><div><font size="2"   >May 13 14:31:02 db-172-16-3-150 pgpool[30072]: statement: update t set info='new' where id=1;</font></div><div><font size="2"   >May 13 14:31:02 db-172-16-3-150 pgpool[30072]: DB node id: 0 backend pid: 20575 statement: update t set info='new' where id=1;</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >事务中包含游标, 游标强制在master节点执行</font></div><div><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# select 1;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# declare cur cursor for select * from t;</font></div><div><font size="2"   >DECLARE CURSOR</font></div><div><font size="2"   >digoal=# fetch next from cur;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp; 3 | 37c8aae0733801d116e1c83ab60f183c | 2013-10-12 17:33:14.654526</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# update t set info='new' where current of cur;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >digoal=# end;</font></div><div><font size="2"   >COMMIT</font></div></div><div><font size="2"   >这里我们看到, begin, end是在所有节点执行的, 但是事务中的select是在standby中执行的, 游标是在master执行的.</font></div><div><div><font size="2"   >May 13 14:38:24 db-172-16-3-150 pgpool[30056]: statement: begin;</font></div><div><font size="2"   >May 13 14:38:24 db-172-16-3-150 pgpool[30056]: DB node id: 0 backend pid: 22330 statement: begin;</font></div><div><font size="2"   >May 13 14:38:24 db-172-16-3-150 pgpool[30056]: DB node id: 1 backend pid: 22331 statement: begin;</font></div><div><font size="2"   >May 13 14:38:25 db-172-16-3-150 pgpool[30056]: statement: select 1;</font></div><div><font size="2"   >May 13 14:38:25 db-172-16-3-150 pgpool[30056]: DB node id: 1 backend pid: 22331 statement: select 1;</font></div><div><font size="2"   >May 13 14:38:32 db-172-16-3-150 pgpool[30056]: statement: declare cur cursor for select * from t;</font></div><div><font size="2"   >May 13 14:38:32 db-172-16-3-150 pgpool[30056]: DB node id: 0 backend pid: 22330 statement: declare cur cursor for select * from t;</font></div><div><font size="2"   >May 13 14:38:44 db-172-16-3-150 pgpool[30056]: statement: fetch next from cur;</font></div><div><font size="2"   >May 13 14:38:44 db-172-16-3-150 pgpool[30056]: DB node id: 0 backend pid: 22330 statement: fetch next from cur;</font></div><div><font size="2"   >May 13 14:38:46 db-172-16-3-150 pgpool[30079]: Replication of node:1 is behind 1840 bytes from the primary server (node:0)</font></div><div><font size="2"   >May 13 14:38:47 db-172-16-3-150 pgpool[30056]: statement: update t set info='new' where current of cur;</font></div><div><font size="2"   >May 13 14:38:47 db-172-16-3-150 pgpool[30056]: DB node id: 0 backend pid: 22330 statement: update t set info='new' where current of cur;</font></div><div><font size="2"   >May 13 14:38:48 db-172-16-3-150 pgpool[30079]: Replication of node:1 is behind 1840 bytes from the primary server (node:0)</font></div><div><font size="2"   >May 13 14:38:49 db-172-16-3-150 pgpool[30056]: statement: end;</font></div><div><font size="2"   >May 13 14:38:49 db-172-16-3-150 pgpool[30056]: DB node id: 1 backend pid: 22331 statement: end;</font></div><div><font size="2"   >May 13 14:38:49 db-172-16-3-150 pgpool[30056]: DB node id: 0 backend pid: 22330 statement: end;</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >对于先执行更新的事务, 那么后期的查询都会在master节点执行.</font></div><div><font size="2"   >May 13 15:33:11 db-172-16-3-150 pgpool[30056]: statement: begin;<br>May 13 15:33:11 db-172-16-3-150 pgpool[30056]: DB node id: 0 backend pid: 22330 statement: begin;<br>May 13 15:33:11 db-172-16-3-150 pgpool[30056]: DB node id: 1 backend pid: 22331 statement: begin;<br>May 13 15:33:13 db-172-16-3-150 pgpool[30056]: statement: declare cur cursor for select * from t;<br>May 13 15:33:13 db-172-16-3-150 pgpool[30056]: DB node id: 0 backend pid: 22330 statement: declare cur cursor for select * from t;<br>May 13 15:33:15 db-172-16-3-150 pgpool[30056]: statement: fetch next from cur;<br>May 13 15:33:15 db-172-16-3-150 pgpool[30056]: DB node id: 0 backend pid: 22330 statement: fetch next from cur;<br>May 13 15:33:16 db-172-16-3-150 pgpool[30056]: statement: update t set info='new' where current of cur;<br>May 13 15:33:16 db-172-16-3-150 pgpool[30056]: DB node id: 0 backend pid: 22330 statement: update t set info='new' where current of cur;<br>May 13 15:33:17 db-172-16-3-150 pgpool[30056]: statement: select * from t limit 1;<br>May 13 15:33:17 db-172-16-3-150 pgpool[30056]: DB node id: 0 backend pid: 22330 statement: select * from t limit 1;<br>May 13 15:33:19 db-172-16-3-150 pgpool[30056]: statement: select 1;<br>May 13 15:33:19 db-172-16-3-150 pgpool[30056]: DB node id: 0 backend pid: 22330 statement: select 1;</font></div><p></p></pre></div><div><br></div><div>8. 性能就不测试了, 留给有兴趣的朋友吧.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.pgpool.net/docs/latest/pgpool-en.html"   >http://www.pgpool.net/docs/latest/pgpool-en.html</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014316448141/"   >http://blog.163.com/digoal@126/blog/static/1638770402014316448141/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.continuent.com/"   >http://www.continuent.com/</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="pgpool-II load balance with stream replication - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">zhaolinzzu - 2014-08-16 18:23:30</h5>
				<div>你好，请教一个问题：<br>我在配置pgpool的并行模式时，pg_hba.conf 使用了trust 认证，当使用select count(*) 查询 9999 端口的数据库时，报：<br>ERROR:&nbsp; password is required<br>DETAIL:&nbsp; Non-superuser cannot connect if the server does not request a password.<br><br>而把pg_hba.conf 改为MD5 认证方式，又会报错：<br>ERROR:&nbsp; MD5 authentication is unsupported in replication, master-slave and parallel modes.<br>两种方式都是使用postgres用户，密码postgres 已经加到pcp.conf中。<br>以上这两种错误的方式应该如何解决，谢谢了</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 zhaolinzzu - 2014-08-16 18:23:30</h5>
				<div style="width:600px;">见本文<div><span style=""  >6. 常见连接错误</span></div></div>
			</div>
			<div id="">
				<h5 id="">www - 2014-05-21 15:04:26</h5>
				<div>sss</div>
			</div>
	</div>
</div>
</body>
</html>