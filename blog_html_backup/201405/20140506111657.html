<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 New Feature - Only WAL-log the modified portion in an UPDATE, if possible.</h2>
	<h5 id="">2014-05-06 11:16:57&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201446102956782/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL的update会产生被更新的行的一条新版本的行信息, 新产生的行需要被写入wal中.</div><div>显然对于更新频繁的场景, 写入WAL的信息也是比较大的, 对于更新值在整行来说只占部分的场景, 并且新版本的行在当前heap page的话, 那么wal中可以只记录被变更的字段. 以此来减少wal的写入量.</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >Only WAL-log the modified portion in an UPDATE, if possible.</font></span></div><div><div><font size="2"   >author<span>	</span>Heikki Linnakangas &lt;heikki.linnakangas@iki.fi&gt;<span>	</span></font></div><div><font size="2"   >Wed, 12 Mar 2014 20:46:04 +0000 (22:46 +0200)</font></div><div><font size="2"   >committer<span>	</span>Heikki Linnakangas &lt;heikki.linnakangas@iki.fi&gt;<span>	</span></font></div><div><font size="2"   >Wed, 12 Mar 2014 21:28:36 +0000 (23:28 +0200)</font></div><div><font size="2"   >commit<span>	</span>a3115f0d9ec1ac93b82156535dc00b10172a4fe7</font></div><div><font size="2"   >tree<span>	</span>675870269d119e1632d9345539efd11ac16d044e<span>	</span>tree | snapshot</font></div><div><font size="2"   >parent<span>	</span>17d787a3b160eefb2ff4a3fdf12ca1fedc02cbc1<span>	</span>commit | diff</font></div><div><font size="2"   >Only WAL-log the modified portion in an UPDATE, if possible.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >When a row is updated, and the new tuple version is put on the same page as</font></div><div><font size="2"   >the old one, only WAL-log the part of the new tuple that's not identical to</font></div><div><font size="2"   >the old. This saves significantly on the amount of WAL that needs to be</font></div><div><font size="2"   >written, in the common case that most fields are not modified.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Amit Kapila, with a lot of back and forth with me, Robert Haas, and others.</font></div></div><p></p></pre></div><div>测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table test(id int primary key, info text, crt_time timestamp, bigdata text) with (fillfactor =70);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into test select generate_series(1,5000000), 'test', clock_timestamp(), repeat(md5(random()::text),20);</font></div><div><font size="2"   >INSERT 0 5000000</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;16/6FAD7AF0</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg94@db-172-16-3-150-&gt; vi test.sql</font></div><div><font size="2"   >\setrandom id 1 5000000</font></div><div><font size="2"   >update test set info='new' where id=:id;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg94@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 8 -j 4 -t 200000</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >number of transactions per client: 200000</font></div><div><font size="2"   >number of transactions actually processed: 1600000/1600000</font></div><div><font size="2"   >latency average: 0.000 ms</font></div><div><font size="2"   >tps = 7835.878926 (including connections establishing)</font></div><div><font size="2"   >tps = 7836.145262 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003165 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.014506 &nbsp; &nbsp; &nbsp; &nbsp;update test set info='new' where id=:id;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;18/1B7790C8</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select pg_xlog_location_diff('18/1B7790C8','16/6FAD7AF0');</font></div><div><font size="2"   >&nbsp;pg_xlog_location_diff&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 7177115096</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>同样测试环境以及配置(block size, wal block size, wal_level)下9.1.3的测试结果 :&nbsp;</div><div>8863512919</div><div>减少19%.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=a3115f0d9ec1ac93b82156535dc00b10172a4fe7"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=a3115f0d9ec1ac93b82156535dc00b10172a4fe7</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL 9.4 New Feature - Only WAL-log the modified portion in an UPDATE, if possible. - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">freya - 2014-05-06 11:20:40</h5>
				<div><IMG src="http://b.bst.126.net/common/portrait/face/preview/face30.gif"  ></div>
			</div>
	</div>
</div>
</body>
</html>