<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">zpool use vdevs distribute</h2>
	<h5 id="">2014-05-27 15:33:57&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201442731413803/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">zpool并不限制根vdev的数量, 并且也不限制他们的属性(如mirror or raidz), 但是属性不同会有提示.<wbr><div>例如</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# zpool create zpp mirror /ssd1/zfs.1 /ssd1/zfs.2</font></div><div><div><font size="2"   >[root@db-172-16-3-150 ~]# zpool status zpp</font></div><div><font size="2"   >&nbsp; pool: zpp</font></div><div><font size="2"   >&nbsp;state: ONLINE</font></div><div><font size="2"   >&nbsp; scan: none requested</font></div><div><font size="2"   >config:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; NAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; STATE &nbsp; &nbsp; READ WRITE CKSUM</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; zpp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mirror-0 &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /ssd1/zfs.1 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /ssd1/zfs.2 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div></div><p></p></pre></div><div>继续添加同属性的vdev很顺利.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# zpool add zpp mirror /ssd1/zfs.3 /ssd1/zfs.4</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# zpool status zpp</font></div><div><font size="2"   >&nbsp; pool: zpp</font></div><div><font size="2"   >&nbsp;state: ONLINE</font></div><div><font size="2"   >&nbsp; scan: none requested</font></div><div><font size="2"   >config:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; NAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; STATE &nbsp; &nbsp; READ WRITE CKSUM</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; zpp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mirror-0 &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /ssd1/zfs.1 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /ssd1/zfs.2 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mirror-1 &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /ssd1/zfs.3 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /ssd1/zfs.4 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><p></p></pre></div><div>这两个vdev mirror-0和mirror-1对这个zpool来说, 是分布使用的.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# zfs create zpp/test</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# cd /zpp/test</font></div><div><font size="2"   >[root@db-172-16-3-150 test]# dd if=/dev/zero of=./test bs=1k count=10230</font></div><div><font size="2"   >10230+0 records in</font></div><div><font size="2"   >10230+0 records out</font></div><div><font size="2"   >10475520 bytes (10 MB) copied, 0.233064 s, 44.9 MB/s</font></div><div><font size="2"   >[root@db-172-16-3-150 test]# ll</font></div><div><font size="2"   >total 7812</font></div><div><font size="2"   >-rw-r--r-- 1 root root 10475520 May 27 15:15 test</font></div><div><font size="2"   >[root@db-172-16-3-150 test]# zpool list -v zpp</font></div><div><font size="2"   >NAME &nbsp; SIZE &nbsp;ALLOC &nbsp; FREE &nbsp; &nbsp;CAP &nbsp;DEDUP &nbsp;HEALTH &nbsp;ALTROOT</font></div><div><font size="2"   >zpp &nbsp; 191M &nbsp;10.4M &nbsp; 181M &nbsp; &nbsp; 5% &nbsp;1.00x &nbsp;ONLINE &nbsp;-</font></div><div><font size="2"   >&nbsp; mirror &nbsp;95.5M &nbsp;5.41M &nbsp;90.1M &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >&nbsp; &nbsp; /ssd1/zfs.1 &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >&nbsp; &nbsp; /ssd1/zfs.2 &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >&nbsp; mirror &nbsp;95.5M &nbsp;4.98M &nbsp;90.5M &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >&nbsp; &nbsp; /ssd1/zfs.3 &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >&nbsp; &nbsp; /ssd1/zfs.4 &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><p></p></pre></div><div>如果添加的vdev和原来的vdev属性不一致, 那么会提示有问题, 现实中当然也是不建议这么来使用的.</div><div>使用-f强制添加.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 test]# zpool add zpp raidz1 /ssd1/zfs.5 /ssd1/zfs.6 /ssd1/zfs.7</font></div><div><font size="2"   >invalid vdev specification</font></div><div><font size="2"   >use '-f' to override the following errors:</font></div><div><font size="2"   >mismatched replication level: pool uses mirror and new vdev is raidz</font></div></div><div><font size="2"   >[root@db-172-16-3-150 test]# zpool add -f zpp raidz1 /ssd1/zfs.5 /ssd1/zfs.6 /ssd1/zfs.7</font></div><p></p></pre></div><div>已经存在的数据不会重分布, 但是新增的数据会重分布到新的vdev上面</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 test]# cp test ./test.1</font></div><div><div><font size="2"   >[root@db-172-16-3-150 test]# zpool list -v zpp</font></div><div><font size="2"   >NAME &nbsp; SIZE &nbsp;ALLOC &nbsp; FREE &nbsp; &nbsp;CAP &nbsp;DEDUP &nbsp;HEALTH &nbsp;ALTROOT</font></div><div><font size="2"   >zpp &nbsp; 477M &nbsp;22.0M &nbsp; 455M &nbsp; &nbsp; 4% &nbsp;1.00x &nbsp;ONLINE &nbsp;-</font></div><div><font size="2"   >&nbsp; mirror &nbsp;95.5M &nbsp;8.66M &nbsp;86.8M &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >&nbsp; &nbsp; /ssd1/zfs.1 &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >&nbsp; &nbsp; /ssd1/zfs.2 &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >&nbsp; mirror &nbsp;95.5M &nbsp;8.24M &nbsp;87.3M &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >&nbsp; &nbsp; /ssd1/zfs.3 &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >&nbsp; &nbsp; /ssd1/zfs.4 &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >&nbsp; raidz1 &nbsp; 286M &nbsp;5.15M &nbsp; 281M &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >&nbsp; &nbsp; /ssd1/zfs.5 &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >&nbsp; &nbsp; /ssd1/zfs.6 &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >&nbsp; &nbsp; /ssd1/zfs.7 &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; -</font></div></div><p></p></pre></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="zpool use udevs distribute - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>