<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use export and import move ZPOOL's underdev from one machine to another OR upgrade a zfs version OR recover destroyed pools</h2>
	<h5 id="">2014-05-18 20:42:02&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020144188233240/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前面我们介绍了zfs的pool, 类似LVM. 由多个块设备组成.</div><div>如果这些块设备要从一个机器转移到另一台机器的话, 怎么实现呢?</div><div>zfs通过export和import来实现底层块设备的转移.</div><div>在已有POOL的主机上, 先将会读写POOL或dataset的正在运行的程序停止掉, 然后执行export.</div><div>执行export会把cache flush到底层的块设备, 同时卸载dataset和pool.</div><div>import时, 可能需要指定块设备的目录, 但是并不需要指定顺序.</div><div>例如 :&nbsp;<br><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@spark01 ~]# zpool status</font></div><div><font size="2"   >&nbsp; pool: zp</font></div><div><font size="2"   >&nbsp;state: ONLINE</font></div><div><font size="2"   >&nbsp; scan: none requested</font></div><div><font size="2"   >config:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; NAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; STATE &nbsp; &nbsp; READ WRITE CKSUM</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; zp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk1 &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk2 &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk3 &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk4 &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; logs</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mirror-4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.log1 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.log2 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >errors: No known data errors</font></div><div><font size="2"   >导出 : </font></div><div><font size="2"   >[root@spark01 ~]# zpool export zp</font></div><div><font size="2"   >[root@spark01 ~]# zpool status</font></div><div><font size="2"   >no pools available</font></div><p></p></pre></div></div><div>因为我这里用的是文件, 所以把文件拷贝到对应的其他主机, 然后指定文件所在目录,</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >zpool</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; import [-d dir] [-D]</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; import [-d dir | -c cachefile] [-F [-n]] &lt;pool | id&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; import [-o mntopts] [-o property=value] ...&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [-d dir | -c cachefile] [-D] [-f] [-m] [-N] [-R root] [-F [-n]] -a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; import [-o mntopts] [-o property=value] ...&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [-d dir | -c cachefile] [-D] [-f] [-m] [-N] [-R root] [-F [-n]]</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;pool | id&gt; [newpool]</font></div></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@spark01 ~]# zpool import -d /home/digoal/</font></div><div><font size="2"   >&nbsp; &nbsp;pool: zp</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;id: 2426254839125485600</font></div><div><font size="2"   >&nbsp; state: ONLINE</font></div><div><font size="2"   >&nbsp;action: The pool can be imported using its name or numeric identifier. &nbsp;#<span style="line-height: 28px;"   >此时并没有真正的导入, 提示你可以使用name或id导入.</span></font></div><div><font size="2"   >&nbsp;config:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; zp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk1 &nbsp; ONLINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk2 &nbsp; ONLINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk3 &nbsp; ONLINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk4 &nbsp; ONLINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; logs</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mirror-4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.log1 &nbsp;ONLINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.log2 &nbsp;ONLINE</font></div><p></p></pre></div><div>如果是块设备的话, 不需要指定目录.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@spark01 ~]# zpool status</font></div><div><font size="2"   >no pools available</font></div><p></p></pre></div><div>使用name 导入.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@spark01 ~]# zpool import -d /home/digoal/ &nbsp;zp</font></div><div><font size="2"   >[root@spark01 ~]# zpool status</font></div><div><font size="2"   >&nbsp; pool: zp</font></div><div><font size="2"   >&nbsp;state: ONLINE</font></div><div><font size="2"   >&nbsp; scan: none requested</font></div><div><font size="2"   >config:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; NAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; STATE &nbsp; &nbsp; READ WRITE CKSUM</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; zp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk1 &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk2 &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk3 &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk4 &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; logs</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mirror-4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.log1 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.log2 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >errors: No known data errors</font></div></div><div><div><font size="2"   >[root@spark01 ~]# df -h</font></div><div><font size="2"   >Filesystem &nbsp; &nbsp; &nbsp;Size &nbsp;Used Avail Use% Mounted on</font></div><div><font size="2"   >/dev/sda1 &nbsp; &nbsp; &nbsp; &nbsp;31G &nbsp;1.2G &nbsp; 29G &nbsp; 5% /</font></div><div><font size="2"   >tmpfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;12G &nbsp; &nbsp; 0 &nbsp; 12G &nbsp; 0% /dev/shm</font></div><div><font size="2"   >/dev/sda3 &nbsp; &nbsp; &nbsp; &nbsp;89G &nbsp; 11G &nbsp; 74G &nbsp;13% /home</font></div><div><font size="2"   >zp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;7.9G &nbsp; &nbsp; 0 &nbsp;7.9G &nbsp; 0% /zp</font></div></div><p></p></pre></div></div><div>接下来我export后修改一下目录和文件名, 并且拷贝到另一台主机.</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >SERVER B :&nbsp;</font></span></div><div><font size="2"   >[root@db-172-16-3-150 ~]# mkdir /ssd4/import</font></div><div><font size="2"   >SERVER A :&nbsp;</font></div><div><div style="line-height: 28px;"   ><font size="2"   >[root@spark01 ~]# zpool export zp</font></div></div><div><font size="2"   >[root@spark01 digoal]# scp zfs.disk* zfs.log* 172.16.3.150:/ssd4/import</font></div><div><font size="2"   >SERVER B :&nbsp;</font></div><div><span style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 ~]# mkdir /ssd4/import/zfslog</font></span></div><div><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 ~]# cd /ssd4/import</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 import]# mv zfs.log* zfslog/</font></div><div><div><font size="2"   >[root@db-172-16-3-150 import]# mv zfs.disk1 zfs.disk01</font></div><div><font size="2"   >[root@db-172-16-3-150 import]# zpool import -d /ssd4/import -d /ssd4/import/zfslog/</font></div><div><font size="2"   >&nbsp; &nbsp;pool: zp</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;id: 2426254839125485600</font></div><div><font size="2"   >&nbsp; state: ONLINE</font></div><div><font size="2"   >&nbsp;action: The pool can be imported using its name or numeric identifier.</font></div><div><font size="2"   >&nbsp;config:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; zp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ONLINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /ssd4/import/zfs.disk01 &nbsp; &nbsp; &nbsp; &nbsp; ONLINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /ssd4/import/zfs.disk2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ONLINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /ssd4/import/zfs.disk3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ONLINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /ssd4/import/zfs.disk4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ONLINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; logs</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mirror-4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ONLINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /ssd4/import/zfslog/zfs.log1 &nbsp;ONLINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /ssd4/import/zfslog/zfs.log2 &nbsp;ONLINE</font></div></div></div><div><font size="2"   >甚至可以使用新的pool名字.</font></div><div><div><font size="2"   >[root@db-172-16-3-150 import]# zpool import -d /ssd4/import -d /ssd4/import/zfslog/ zp newzp</font></div><div><font size="2"   >[root@db-172-16-3-150 import]# zpool status</font></div><div><font size="2"   >&nbsp; pool: newzp</font></div><div><font size="2"   >&nbsp;state: ONLINE</font></div><div><font size="2"   >&nbsp; scan: none requested</font></div><div><font size="2"   >config:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; NAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;STATE &nbsp; &nbsp; READ WRITE CKSUM</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; newzp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /ssd4/import/zfs.disk01 &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /ssd4/import/zfs.disk2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /ssd4/import/zfs.disk3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /ssd4/import/zfs.disk4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; logs</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mirror-4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /ssd4/import/zfslog/zfs.log1 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /ssd4/import/zfslog/zfs.log2 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >errors: No known data errors</font></div></div><p></p></pre></div><div><br></div><div>恢复destroy的zpool, 当pool被destroy后, 还可以恢复, 因为数据都还在, 只是pool删掉了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@spark01 digoal]# zpool status</font></div><div><font size="2"   >&nbsp; pool: zp</font></div><div><font size="2"   >&nbsp;state: ONLINE</font></div><div><font size="2"   >&nbsp; scan: none requested</font></div><div><font size="2"   >config:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; NAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; STATE &nbsp; &nbsp; READ WRITE CKSUM</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; zp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk1 &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk2 &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk3 &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk4 &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; logs</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mirror-4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.log1 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.log2 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >errors: No known data errors</font></div><div><font size="2"   >[root@spark01 digoal]# zpool destroy zp</font></div><div><font size="2"   >[root@spark01 digoal]# zpool status</font></div><div><font size="2"   >no pools available</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >必须加-D参数才可以恢复destroy的pool</font></div><div><font size="2"   >[root@spark01 digoal]# zpool import -d /home/digoal/</font></div><div><font size="2"   >no pools available to import</font></div><div><font size="2"   >[root@spark01 digoal]# zpool import -d /home/digoal/ -D</font></div><div><font size="2"   >&nbsp; &nbsp;pool: zp</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;id: 2426254839125485600</font></div><div><font size="2"   >&nbsp; state: ONLINE (DESTROYED)</font></div><div><font size="2"   >&nbsp;action: The pool can be imported using its name or numeric identifier.</font></div><div><font size="2"   >&nbsp;config:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; zp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk1 &nbsp; ONLINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk2 &nbsp; ONLINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk3 &nbsp; ONLINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk4 &nbsp; ONLINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; logs</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mirror-4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.log1 &nbsp;ONLINE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.log2 &nbsp;ONLINE</font></div><div><font size="2"   >[root@spark01 digoal]# zpool import -d /home/digoal/ -D zp</font></div><div><font size="2"   >[root@spark01 digoal]# zpool status</font></div><div><font size="2"   >&nbsp; pool: zp</font></div><div><font size="2"   >&nbsp;state: ONLINE</font></div><div><font size="2"   >&nbsp; scan: none requested</font></div><div><font size="2"   >config:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; NAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; STATE &nbsp; &nbsp; READ WRITE CKSUM</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; zp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk1 &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk2 &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk3 &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.disk4 &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; logs</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mirror-4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.log1 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /home/digoal/zfs.log2 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >errors: No known data errors</font></div><p></p></pre></div><div><br></div><div>zpool版本升级, 比如一个pool从版本20的机器迁移到版本28的机器, 那么可以升级到28, 但是这样的话, 这个pool就不能再回到版本20的机器上使用了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >zpool&nbsp;</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; upgrade</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; upgrade -v</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; upgrade [-V version] &lt;-a | pool ...&gt;</font></div></div><p></p></pre></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@spark01 digoal]# zpool upgrade zp</font></div><div><font size="2"   >This system supports ZFS pool feature flags.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Pool 'zp' already has all supported features enabled.</font></div><div><font size="2"   >查看当前zfs版本信息</font></div><div><div><font size="2"   >[root@spark01 digoal]# zpool upgrade -v</font></div><div><font size="2"   >This system supports ZFS pool feature flags.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The following features are supported:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >FEAT DESCRIPTION</font></div><div><font size="2"   >-------------------------------------------------------------</font></div><div><font size="2"   >async_destroy &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (read-only compatible)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;Destroy filesystems asynchronously.</font></div><div><font size="2"   >empty_bpobj &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (read-only compatible)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;Snapshots use less space.</font></div><div><font size="2"   >lz4_compress &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LZ4 compression algorithm support.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The following legacy versions are also supported:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >VER &nbsp;DESCRIPTION</font></div><div><font size="2"   >--- &nbsp;--------------------------------------------------------</font></div><div><font size="2"   >&nbsp;1 &nbsp; Initial ZFS version</font></div><div><font size="2"   >&nbsp;2 &nbsp; Ditto blocks (replicated metadata)</font></div><div><font size="2"   >&nbsp;3 &nbsp; Hot spares and double parity RAID-Z</font></div><div><font size="2"   >&nbsp;4 &nbsp; zpool history</font></div><div><font size="2"   >&nbsp;5 &nbsp; Compression using the gzip algorithm</font></div><div><font size="2"   >&nbsp;6 &nbsp; bootfs pool property</font></div><div><font size="2"   >&nbsp;7 &nbsp; Separate intent log devices</font></div><div><font size="2"   >&nbsp;8 &nbsp; Delegated administration</font></div><div><font size="2"   >&nbsp;9 &nbsp; refquota and refreservation properties</font></div><div><font size="2"   >&nbsp;10 &nbsp;Cache devices</font></div><div><font size="2"   >&nbsp;11 &nbsp;Improved scrub performance</font></div><div><font size="2"   >&nbsp;12 &nbsp;Snapshot properties</font></div><div><font size="2"   >&nbsp;13 &nbsp;snapused property</font></div><div><font size="2"   >&nbsp;14 &nbsp;passthrough-x aclinherit</font></div><div><font size="2"   >&nbsp;15 &nbsp;user/group space accounting</font></div><div><font size="2"   >&nbsp;16 &nbsp;stmf property support</font></div><div><font size="2"   >&nbsp;17 &nbsp;Triple-parity RAID-Z</font></div><div><font size="2"   >&nbsp;18 &nbsp;Snapshot user holds</font></div><div><font size="2"   >&nbsp;19 &nbsp;Log device removal</font></div><div><font size="2"   >&nbsp;20 &nbsp;Compression using zle (zero-length encoding)</font></div><div><font size="2"   >&nbsp;21 &nbsp;Deduplication</font></div><div><font size="2"   >&nbsp;22 &nbsp;Received properties</font></div><div><font size="2"   >&nbsp;23 &nbsp;Slim ZIL</font></div><div><font size="2"   >&nbsp;24 &nbsp;System attributes</font></div><div><font size="2"   >&nbsp;25 &nbsp;Improved scrub stats</font></div><div><font size="2"   >&nbsp;26 &nbsp;Improved snapshot deletion performance</font></div><div><font size="2"   >&nbsp;27 &nbsp;Improved snapshot creation performance</font></div><div><font size="2"   >&nbsp;28 &nbsp;Multiple vdev replacements</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >For more information on a particular version, including supported releases,</font></div><div><font size="2"   >see the ZFS Administration Guide.</font></div></div><div><font size="2"   >不能降级</font></div><div><font size="2"   >[root@spark01 digoal]# zpool upgrade -V 20 zp</font></div><div><font size="2"   >This system supports ZFS pool feature flags.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Pool 'zp' is already formatted using more current version '5000'.</font></div><p></p></pre></div><div><br></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://pthree.org/2012/12/10/zfs-administration-part-v-exporting-and-importing-zpools/"   >https://pthree.org/2012/12/10/zfs-administration-part-v-exporting-and-importing-zpools/</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="move ZPOOLs underdev from one machine to another OR upgrade a zfs version - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>