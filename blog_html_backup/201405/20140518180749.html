<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">send and receive ZFS snapshot between machines</h2>
	<h5 id="">2014-05-18 18:07:49&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020144184134749/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>zfs的另一个强大的功能, 将snapshot导出到文件, 再将文件恢复成dataset.</div><div>导出时支持管道传输, 所以可以很方便的实现跨主机传输.</div><div>例子 :&nbsp;</div><div>查看A主机的snapshot.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 mnt]# zfs list -t snapshot</font></div><div><font size="2"   >NAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;USED &nbsp;AVAIL &nbsp;REFER &nbsp;MOUNTPOINT</font></div><div><font size="2"   >zptest/disk1@2014-05-1815:43:51 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;- &nbsp;48.6M &nbsp;-</font></div><div><font size="2"   >zptest/disk1@2014-05-1815:43:54 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;- &nbsp;48.6M &nbsp;-</font></div><div><font size="2"   >zptest/pg93@2014-05-1721:54:55 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;143M &nbsp; &nbsp; &nbsp;- &nbsp; 185M &nbsp;-</font></div><div><font size="2"   >zptest/pg93@2014-05-1723:17:23 &nbsp; &nbsp; &nbsp; &nbsp; 99.0M &nbsp; &nbsp; &nbsp;- &nbsp;3.65G &nbsp;-</font></div><div><font size="2"   >zptest/pg93@2014-05-1723:18:11 &nbsp; &nbsp; &nbsp; &nbsp; 5.10M &nbsp; &nbsp; &nbsp;- &nbsp;3.65G &nbsp;-</font></div><div><font size="2"   >zptest/pg93@2014-05-1723:35:32 &nbsp; &nbsp; &nbsp; &nbsp; 2.49G &nbsp; &nbsp; &nbsp;- &nbsp;3.65G &nbsp;-</font></div><div><font size="2"   >zptest/pg93_clone1@2014-05-1800:31:03 &nbsp; &nbsp;21K &nbsp; &nbsp; &nbsp;- &nbsp;3.62G &nbsp;-</font></div><p></p></pre></div><div>将snapshot导出到一个文件.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 mnt]# zfs send zptest/pg93@2014-05-1723:18:11 &gt; /ssd4/pg93.img</font></div><div><font size="2"   >[root@db-172-16-3-150 mnt]# ll /ssd4/pg93.img</font></div><div><font size="2"   >-rw-r--r-- 1 root root 3926704168 May 18 16:42 /ssd4/pg93.img</font></div><p></p></pre></div><div>将snapshot导出到管道, 传送给一个压缩软件, 直接压缩成压缩文件.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 mnt]# zfs send zptest/pg93@2014-05-1723:18:11 | xz &gt; /ssd4/pg93.img.xz</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >将snapshot导出到管道, 传送给压缩软件, 再通过管道传送给加密软件, 输出压缩后的加密文件.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 mnt]# zfs send zptest/pg93@2014-05-1723:18:11 | xz | openssl enc -aes-256-cbc -a -salt &gt; /ssd4/pg93.img.xz.asc</font></div><div></div><p></p></pre></div><div>反过来, 使用压缩过的加密文件, 先解密, 然后解压, 然后管道传送给zfs receive, 使用导出的snapshot创建一个新的dataset.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# openssl enc -d -aes-256-cbc -a -in /ssd4/pg93.img.xz.asc | unxz | zfs receive zptest/test3</font></div><div></div><p></p></pre></div><div>或者直接使用导出的snapshot文件, 导入到zpool并新建一个dataset.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# zfs receive zptest/test2 &lt; /ssd4/pg93.img</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# zfs list</font></div><div><font size="2"   >NAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; USED &nbsp;AVAIL &nbsp;REFER &nbsp;MOUNTPOINT</font></div><div><font size="2"   >zptest &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;15.3G &nbsp;23.8G &nbsp; &nbsp;34K &nbsp;/zptest</font></div><div><font size="2"   >zptest/disk1 &nbsp; &nbsp; &nbsp; &nbsp;1.08G &nbsp;24.8G &nbsp;48.6M &nbsp;-</font></div><div><font size="2"   >zptest/pg93 &nbsp; &nbsp; &nbsp; &nbsp; 9.89G &nbsp;23.8G &nbsp;3.63G &nbsp;/zptest/pg93</font></div><div><font size="2"   >zptest/pg93_clone1 &nbsp; 662M &nbsp;23.8G &nbsp;3.62G &nbsp;/zptest/pg93_clone1</font></div><div><font size="2"   >zptest/test2 &nbsp; &nbsp; &nbsp; &nbsp;3.65G &nbsp;23.8G &nbsp;3.65G &nbsp;/zptest/test2</font></div><p></p></pre></div><div><br></div><div>send和receive可以直接通过管道对接, 不用产生临时文件.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# zfs send zptest/pg93@2014-05-1723:18:11 | zfs receive zptest/test3</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# zfs list</font></div><div><font size="2"   >NAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; USED &nbsp;AVAIL &nbsp;REFER &nbsp;MOUNTPOINT</font></div><div><font size="2"   >zptest &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;18.9G &nbsp;20.2G &nbsp; &nbsp;35K &nbsp;/zptest</font></div><div><font size="2"   >zptest/disk1 &nbsp; &nbsp; &nbsp; &nbsp;1.08G &nbsp;21.2G &nbsp;48.6M &nbsp;-</font></div><div><font size="2"   >zptest/pg93 &nbsp; &nbsp; &nbsp; &nbsp; 9.89G &nbsp;20.2G &nbsp;3.63G &nbsp;/zptest/pg93</font></div><div><font size="2"   >zptest/pg93_clone1 &nbsp; 662M &nbsp;20.2G &nbsp;3.62G &nbsp;/zptest/pg93_clone1</font></div><div><font size="2"   >zptest/test2 &nbsp; &nbsp; &nbsp; &nbsp;3.65G &nbsp;20.2G &nbsp;3.65G &nbsp;/zptest/test2</font></div><div><font size="2"   >zptest/test3 &nbsp; &nbsp; &nbsp; &nbsp;3.65G &nbsp;20.2G &nbsp;3.65G &nbsp;/zptest/test3</font></div><p></p></pre></div><div><br></div><div>接下来的这个例子是通过管道传输给另一台主机.</div><div>在B主机创建zpool.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@spark01 digoal]# dd if=/dev/zero of=./zfs.log1 bs=1k count=1024000</font></div><div><font size="2"   >1024000+0 records in</font></div><div><font size="2"   >1024000+0 records out</font></div><div><font size="2"   >1048576000 bytes (1.0 GB) copied, 2.00667 s, 523 MB/s</font></div><div><font size="2"   >[root@spark01 digoal]# dd if=/dev/zero of=./zfs.log bs=1k count=1024000</font></div><div><font size="2"   >1024000+0 records in</font></div><div><font size="2"   >1024000+0 records out</font></div><div><font size="2"   >1048576000 bytes (1.0 GB) copied, 2.04975 s, 512 MB/s</font></div><div><font size="2"   >[root@spark01 digoal]# mv zfs.log zfs.log2</font></div><div><font size="2"   >[root@spark01 digoal]# dd if=/dev/zero of=./zfs.disk1 bs=1024k count=2048</font></div><div><font size="2"   >2048+0 records in</font></div><div><font size="2"   >2048+0 records out</font></div><div><font size="2"   >2147483648 bytes (2.1 GB) copied, 1.27549 s, 1.7 GB/s</font></div><div><font size="2"   >[root@spark01 digoal]# dd if=/dev/zero of=./zfs.disk2 bs=1024k count=2048</font></div><div><font size="2"   >2048+0 records in</font></div><div><font size="2"   >2048+0 records out</font></div><div><font size="2"   >2147483648 bytes (2.1 GB) copied, 28.575 s, 75.2 MB/s</font></div><div><font size="2"   >[root@spark01 digoal]# cp zfs.disk2 zfs.disk3</font></div><div><font size="2"   >[root@spark01 digoal]# cp zfs.disk2 zfs.disk4</font></div><div><font size="2"   >[root@spark01 digoal]# zpool create zp /home/digoal/zfs.disk1 /home/digoal/zfs.disk2 /home/digoal/zfs.disk3 /home/digoal/zfs.disk4 log mirror /home/digoal/zfs.log1 /home/digoal/zfs.log2</font></div><p></p></pre></div><div><br></div><div>使用ssh连接B主机接受A主机的管道信息, 在B主机直接使用zfs receive接收snapshot, 并创建一个新的dataset.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# zfs send zptest/pg93@2014-05-1723:18:11 | ssh root@172.16.3.220 "/opt/zfs0.6.2/sbin/zfs receive zp/test1"</font></div><div><font size="2"   >root@172.16.3.220's password:&nbsp;</font></div><p></p></pre></div><div><br></div><div>如果要防止密码传输的话, 可以使用ssh key认证.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 /]# ssh-keygen -t rsa</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# cat ~/.ssh/id_rsa.pub&nbsp;</font></div><div><font size="2"   >ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEApn/LgD98MRFTHTW9Unt3fOHmY2k7g/2vVF7KeuRlAu7IpCNpTg+FrdCcICUmsQBIyfC6YaSagWvmuPD+ZRO3poazwtt+3xi+mV8KDEWUPnSRMsqJ9atKzNOmZQhZo0P5yOMwC6gVtObM7bi9JKEgumHkiwvdTxgQVprwvkYTRtPvT84VvXSdADuiBxd/yZlnL4eoPeXODNBuCb5wNRmWcAnkH+mIyspFDWiT0f+ygoSOqZ+Zdy8MFmXIYqSPw9YpHZjUJgpvIH04jsHWASYAJNS4iL8vYVRlzmKZE8GFmXym/OZ9k7xJfFrhzOAVrEiXxYy5mbnTiBVAm+drKmqZDQ== root@db-172-16-3-150.sky-mobi.com</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@spark01 ~]# cd ~</font></div><div><font size="2"   >[root@spark01 ~]# mkdir .ssh</font></div><div><font size="2"   >[root@spark01 ~]# vi .ssh/authorized_keys</font></div><div><font size="2"   >ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEApn/LgD98MRFTHTW9Unt3fOHmY2k7g/2vVF7KeuRlAu7IpCNpTg+FrdCcICUmsQBIyfC6YaSagWvmuPD+ZRO3poazwtt+3xi+mV8KDEWUPnSRMsqJ9atKzNOmZQhZo0P5yOMwC6gVtObM7bi9JKEgumHkiwvdTxgQVprwvkYTRtPvT84VvXSdADuiBxd/yZlnL4eoPeXODNBuCb5wNRmWcAnkH+mIyspFDWiT0f+ygoSOqZ+Zdy8MFmXIYqSPw9YpHZjUJgpvIH04jsHWASYAJNS4iL8vYVRlzmKZE8GFmXym/OZ9k7xJfFrhzOAVrEiXxYy5mbnTiBVAm+drKmqZDQ== root@db-172-16-3-150.sky-mobi.com</font></div><div><font size="2"   >[root@spark01 ~]# setenforce 0</font></div><div><font size="2"   >[root@spark01 ~]# vi /etc/selinux/config&nbsp;</font></div><div><font size="2"   >SELINUX=disabled</font></div><div><font size="2"   >SELINUXTYPE=targeted</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# ssh root@172.16.3.220 date</font></div><div><font size="2"   >Mon May 19 02:01:40 CST 2014</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# zfs send zptest/pg93@2014-05-1723:18:11 | ssh root@172.16.3.220 "/opt/zfs0.6.2/sbin/zfs receive zp/test"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@spark01 ~]# zfs list</font></div><div><font size="2"   >NAME &nbsp; &nbsp; &nbsp;USED &nbsp;AVAIL &nbsp;REFER &nbsp;MOUNTPOINT</font></div><div><font size="2"   >zp &nbsp; &nbsp; &nbsp; 3.65G &nbsp;4.16G &nbsp; &nbsp;31K &nbsp;/zp</font></div><div><font size="2"   >zp/test &nbsp;3.65G &nbsp;4.16G &nbsp;3.65G &nbsp;/zp/test</font></div><div><font size="2"   >[root@spark01 ~]# df -h</font></div><div><font size="2"   >Filesystem &nbsp; &nbsp; &nbsp;Size &nbsp;Used Avail Use% Mounted on</font></div><div><font size="2"   >/dev/sda1 &nbsp; &nbsp; &nbsp; &nbsp;31G &nbsp;1.2G &nbsp; 29G &nbsp; 5% /</font></div><div><font size="2"   >tmpfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;12G &nbsp; &nbsp; 0 &nbsp; 12G &nbsp; 0% /dev/shm</font></div><div><font size="2"   >/dev/sda3 &nbsp; &nbsp; &nbsp; &nbsp;89G &nbsp; 11G &nbsp; 74G &nbsp;13% /home</font></div><div><font size="2"   >zp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4.2G &nbsp; &nbsp; 0 &nbsp;4.2G &nbsp; 0% /zp</font></div><div><font size="2"   >zp/test &nbsp; &nbsp; &nbsp; &nbsp; 7.9G &nbsp;3.7G &nbsp;4.2G &nbsp;47% /zp/test</font></div><div><font size="2"   >[root@spark01 ~]# cd /zp/test</font></div><div><font size="2"   >[root@spark01 test]# ll</font></div><div><font size="2"   >total 2</font></div><div><font size="2"   >drwx------. 16 digoal digoal 28 May 17 23:15 pg_root</font></div><p></p></pre></div><div>因为zfs的snapshot是一致性镜像, 通过这种方法导出镜像到文件, 可以起到额外备份snapshot到其他主机或文件系统的作用.</div></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://pthree.org/2012/12/20/zfs-administration-part-xiii-sending-and-receiving-filesystems/"   >https://pthree.org/2012/12/20/zfs-administration-part-xiii-sending-and-receiving-filesystems/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201441694022110/"   >http://blog.163.com/digoal@126/blog/static/163877040201441694022110/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201441723450443/"   >http://blog.163.com/digoal@126/blog/static/163877040201441723450443/</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020144183320807/"   >http://blog.163.com/digoal@126/blog/static/16387704020144183320807/</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="send and receive zfs snapshot between machines - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>