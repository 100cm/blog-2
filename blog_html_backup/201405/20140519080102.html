<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">ZFS compression algorithm lzjb, gzip, gzip-[0-9], zle, lz4 compare</h2>
	<h5 id="">2014-05-19 8:01:02&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020144197501438/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>zfs提供几种压缩算法,&nbsp;</div><div>lzjb, gzip, gzip-[0-9], zle, lz4</div><div>其中默认的压缩算法为lzjb, 这个是ZFS的作者Jeff Bonwick提供的, gzip默认的压缩级别为6, 或者指定压缩级别.</div><div>这里主要测试一下压缩时间和压缩比.</div><div>注意, 压缩选项默认是关闭的, 压缩选项针对dataset来设置, 同一个pool中不同的dataset可以设置不同的压缩算法, 也可以开关混用. 对于未使用压缩的dataset, 如果已经存在数据的话, 开启压缩后, 之后的数据会压缩, 但是之前存储的数据不会变动.&nbsp;</div><div>首先测试的是lzjb.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@spark01 digoal]# rm -rf /zp/test/*</font></div><div><font size="2"   >[root@spark01 digoal]# zfs set compression=lzjb zp/test</font></div><div><font size="2"   >[root@spark01 digoal]# date +%F%T; cp -r hadoop-2.4.0* spl-0.6.2* zfs-0.6.2* /zp/test/ ; date +%F%T;</font></div><div><font size="2"   >2014-05-1916:00:45</font></div><div><font size="2"   >2014-05-1916:01:00 &nbsp;15秒</font></div><div><font size="2"   >[root@spark01 digoal]# zfs get all zp/test|grep compress</font></div><div><font size="2"   >zp/test &nbsp;compressratio &nbsp; &nbsp; &nbsp; &nbsp; 1.49x &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp/test &nbsp;compression &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lzjb &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; local</font></div><div><font size="2"   >zp/test &nbsp;refcompressratio &nbsp; &nbsp; &nbsp;1.49x &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><p></p></pre></div><div>测试gzip</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@spark01 digoal]# rm -rf /zp/test/*</font></div><div><font size="2"   >[root@spark01 digoal]# zfs set compression=gzip zp/test</font></div><div><font size="2"   >[root@spark01 digoal]# date +%F%T; cp -r hadoop-2.4.0* spl-0.6.2* zfs-0.6.2* /zp/test/ ; date +%F%T;</font></div><div><font size="2"   >2014-05-1916:01:47</font></div><div><font size="2"   >2014-05-1916:02:02 &nbsp;15秒</font></div><div><font size="2"   >[root@spark01 digoal]# zfs get all zp/test|grep compress</font></div><div><font size="2"   >zp/test &nbsp;compressratio &nbsp; &nbsp; &nbsp; &nbsp; 1.77x &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp/test &nbsp;compression &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gzip &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; local</font></div><div><font size="2"   >zp/test &nbsp;refcompressratio &nbsp; &nbsp; &nbsp;1.77x &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >测试gzip-9</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@spark01 digoal]# rm -rf /zp/test/*</font></div><div><font size="2"   >[root@spark01 digoal]# zfs set compression=gzip-9 zp/test</font></div><div><font size="2"   >[root@spark01 digoal]# date +%F%T; cp -r hadoop-2.4.0* spl-0.6.2* zfs-0.6.2* /zp/test/ ; date +%F%T;</font></div><div><font size="2"   >2014-05-1916:03:01</font></div><div><font size="2"   >2014-05-1916:03:18 &nbsp;17秒</font></div><div><font size="2"   >[root@spark01 digoal]# zfs get all zp/test|grep compress</font></div><div><font size="2"   >zp/test &nbsp;compressratio &nbsp; &nbsp; &nbsp; &nbsp; 1.59x &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp/test &nbsp;compression &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gzip-9 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; local</font></div><div><font size="2"   >zp/test &nbsp;refcompressratio &nbsp; &nbsp; &nbsp;1.59x &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >测试zle</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@spark01 digoal]# rm -rf /zp/test/*</font></div><div><font size="2"   >[root@spark01 digoal]# zfs set compression=zle zp/test</font></div><div><font size="2"   >[root@spark01 digoal]# date +%F%T; cp -r hadoop-2.4.0* spl-0.6.2* zfs-0.6.2* /zp/test/ ; date +%F%T;</font></div><div><font size="2"   >2014-05-1916:03:47</font></div><div><font size="2"   >2014-05-1916:04:04 &nbsp;17秒</font></div><div><font size="2"   >[root@spark01 digoal]# zfs get all zp/test|grep compress</font></div><div><font size="2"   >zp/test &nbsp;compressratio &nbsp; &nbsp; &nbsp; &nbsp; 1.09x &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp/test &nbsp;compression &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; zle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;local</font></div><div><font size="2"   >zp/test &nbsp;refcompressratio &nbsp; &nbsp; &nbsp;1.09x &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >测试lz4</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@spark01 digoal]# rm -rf /zp/test/*</font></div><div><font size="2"   >[root@spark01 digoal]# zfs set compression=lz4 zp/test</font></div><div><font size="2"   >[root@spark01 digoal]# date +%F%T; cp -r hadoop-2.4.0* spl-0.6.2* zfs-0.6.2* /zp/test/ ; date +%F%T;</font></div><div><font size="2"   >2014-05-1916:04:25</font></div><div><font size="2"   >2014-05-1916:04:39 &nbsp;14秒</font></div><div><font size="2"   >[root@spark01 digoal]# zfs get all zp/test|grep compress</font></div><div><font size="2"   >zp/test &nbsp;compressratio &nbsp; &nbsp; &nbsp; &nbsp; 1.43x &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp/test &nbsp;compression &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lz4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;local</font></div><div><font size="2"   >zp/test &nbsp;refcompressratio &nbsp; &nbsp; &nbsp;1.43x &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><p></p></pre></div><div>不压缩的情况测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@spark01 digoal]# zfs set compression=off zp/test</font></div><div><font size="2"   >[root@spark01 digoal]# rm -rf /zp/test/*</font></div><div><font size="2"   >[root@spark01 digoal]# date +%F%T; cp -r hadoop-2.4.0* spl-0.6.2* zfs-0.6.2* /zp/test/ ; date +%F%T;</font></div><div><font size="2"   >2014-05-1916:09:19</font></div><div><font size="2"   >2014-05-1916:09:38 &nbsp;19秒</font></div><p></p></pre></div><div><br></div><div>从测试结果来看, gzip6的压缩比最高, 同时时间也比较折中, 推荐使用.</div><div>另外作者的算法lzjb也是被大多数人推荐使用的.</div><div>建议所有的dataset都开启压缩, 从测试数据来看, 显然CPU不是问题, IO是大问题. 因为未开启压缩的情况下, 耗时是最长的.</div><div><br></div><div>[参考]</div><div><span style="line-height: 28px;"   >1.&nbsp;</span><a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://pthree.org/2012/12/18/zfs-administration-part-xi-compression-and-deduplication/"   >https://pthree.org/2012/12/18/zfs-administration-part-xi-compression-and-deduplication/</a></div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="ZFS compression method lzjb, gzip, gzip-[0-9], zle, lz4 compare - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">Janyu - 2014-07-23 2:54:04</h5>
				<div>gzip-6比gzip-9还高？？？<br><br></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 Janyu - 2014-07-23 2:54:04</h5>
				<div style="width:600px;">测试结果是这样的, 而且GZIP-9 CPU相当高.<div>现在生产都选择GZIP-6. 压缩比和CPU比较均衡, lz4压缩比略低, 如果CPU吃紧的话可以改成lz4.</div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">Janyu 回复 德哥@Digoal - 2014-07-23 2:54:04</h5>
				<div style="width:600px;">生产环境最终还是选择了GZIP-9，双路八核16G内存的机子，全速存取读取时CPU占14%左右，仅作存储服务器和PostgreSQL数据库服务器，感觉没太大问题...<br><br></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 Janyu - 2014-07-23 2:54:04</h5>
				<div style="width:600px;">恩, 只要适合就好了.</div>
			</div>
	</div>
</div>
</body>
</html>