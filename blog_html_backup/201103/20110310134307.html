<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL partition table's arithmetic tuning example</h2>
	<h5 id="">2011-03-10 13:43:07&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402011210114036419/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">在PostgreSQL中，针对数据量较大的表，建议采用分区表的模式。<br>分区算法可以通过触发器来实现，一个合适的算法可以降低对数据库CPU的开销。尤其在对分区表并发量大的操作时效果明显。<br>分区环境示例：<br><pre class="prettyprint"  ><p><font size="2"  >parent table : <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Table "digoal.tbl_user_info"<br>&nbsp; Column&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Modifiers | Storage&nbsp; | Description <br>-----------+-----------------------+-----------+----------+-------------<br>&nbsp;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | bigint&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | not null&nbsp; | plain&nbsp;&nbsp;&nbsp; | <br>&nbsp;firstname | character varying(32) |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | extended | <br>&nbsp;lastname&nbsp; | character varying(32) |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | extended | <br>&nbsp;corp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | character varying(64) |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | extended | <br>&nbsp;age&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | integer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | plain&nbsp;&nbsp;&nbsp; | <br>Indexes:<br>&nbsp;&nbsp;&nbsp; "tbl_user_info_pkey" PRIMARY KEY, btree (id)<br>Child tables: tbl_user_info_0,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tbl_user_info_1,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tbl_user_info_10,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tbl_user_info_11,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tbl_user_info_12,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tbl_user_info_13,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tbl_user_info_14,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tbl_user_info_15,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tbl_user_info_2,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tbl_user_info_3,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tbl_user_info_4,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tbl_user_info_5,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tbl_user_info_6,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tbl_user_info_7,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tbl_user_info_8,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tbl_user_info_9<br>Has OIDs: no</font></p></pre><br>建表函数 : <br><pre class="prettyprint"  ><p><font size="2"  >CREATE OR REPLACE FUNCTION digoal.f_create_table(i_min integer, i_max integer)<br>&nbsp;RETURNS void<br>&nbsp;LANGUAGE plpgsql<br>AS $function$<br>declare<br>begin<br>for i in i_min..i_max loop<br>execute 'create table tbl_user_info_'||i||' (like tbl_user_info including constraints including defaults including indexes) inherits (tbl_user_info);';<br>end loop;<br>return;<br>end;<br>$function$</font></p></pre><br>添加CHECK函数：<br><pre class="prettyprint"  ><p><font size="2"  >CREATE OR REPLACE FUNCTION digoal.f_ck_table(i_min integer, i_max integer)<br>&nbsp;RETURNS void<br>&nbsp;LANGUAGE plpgsql<br>AS $function$<br>declare<br>begin<br>for i in i_min..i_max loop<br>execute 'alter table tbl_user_info_'||i||' add constraint ck_user_info_'||i||' check (mod(id,16)='||i||');';<br>end loop;<br>return;<br>end;<br>$function$</font></p></pre><br>触发器函数使用4种组合,分别测试性能差别。<br><br>示例图 :<br><div><div><img title="PostgreSQL partition tables arithmetic tuning example - 德哥@Digoal - The Heart,The World."  alt="PostgreSQL partition tables arithmetic tuning example - 德哥@Digoal - The Heart,The World."  style="margin: 0pt 10px 0pt 0pt;"  src="http://img849.ph.126.net/9zP768trnq_rJmiKUnhkOA==/563512903375764013.jpg"  ></div>&nbsp;</div>&nbsp;<div><div><img title="PostgreSQL partition tables arithmetic tuning example - 德哥@Digoal - The Heart,The World."  alt="PostgreSQL partition tables arithmetic tuning example - 德哥@Digoal - The Heart,The World."  style="margin: 0pt 10px 0pt 0pt;"  src="http://img165.ph.126.net/mgHoGJStVITaHPS2QDDOSQ==/2257992263174584123.jpg"  ></div>&nbsp;</div>&nbsp;<div><div><img title="PostgreSQL partition tables arithmetic tuning example - 德哥@Digoal - The Heart,The World."  alt="PostgreSQL partition tables arithmetic tuning example - 德哥@Digoal - The Heart,The World."  style="margin: 0pt 10px 0pt 0pt;"  src="http://img154.ph.126.net/_qtGTkNah3gUU7qaH6Meog==/1480839852476209920.jpg"  ></div>&nbsp;</div>&nbsp;<div><div><img title="PostgreSQL partition tables arithmetic tuning example - 德哥@Digoal - The Heart,The World."  alt="PostgreSQL partition tables arithmetic tuning example - 德哥@Digoal - The Heart,The World."  style="margin: 0pt 10px 0pt 0pt;"  src="http://img853.ph.126.net/NGK32bkwWJpOh_4m1ZG3RA==/2741003323209487724.jpg"  ></div>&nbsp;</div>&nbsp;<div><div><img title="PostgreSQL partition tables arithmetic tuning example - 德哥@Digoal - The Heart,The World."  alt="PostgreSQL partition tables arithmetic tuning example - 德哥@Digoal - The Heart,The World."  style="margin: 0pt 10px 0pt 0pt;"  src="http://img612.ph.126.net/fEt_8I8oubillx0xxjwPcw==/1971169261906459932.jpg"  ></div>&nbsp;</div>&nbsp;<br>一、不分组的范例 : <br>新建触发器函数和触发器<br><pre class="prettyprint"  ><p><font size="2"  >CREATE OR REPLACE FUNCTION tbl_user_info_insert_trigger()<br>RETURNS TRIGGER AS $$<br>BEGIN<br>&nbsp;&nbsp;&nbsp; IF&nbsp;&nbsp;&nbsp; ( mod(NEW.id,16) = 0 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_0 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,16) = 1 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_1 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,16) = 2 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_2 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,16) = 3 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_3 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,16) = 4 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_4 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,16) = 5 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_5 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,16) = 6 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_6 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,16) = 7 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_7 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,16) = 8 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_8 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,16) = 9 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_9 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,16) = 10 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_10 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,16) = 11 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_11 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,16) = 12 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_12 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,16) = 13 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_13 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,16) = 14 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_14 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,16) = 15 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_15 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp; ELSE<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RAISE EXCEPTION 'ID out of range.&nbsp; Please fix the tbl_user_info_insert_trigger() function!';<br>&nbsp;&nbsp;&nbsp; END IF;<br>&nbsp;&nbsp;&nbsp; RETURN NULL;<br>END;<br>$$<br>LANGUAGE plpgsql;<br><br>CREATE OR REPLACE FUNCTION tbl_user_info_delete_trigger()<br>RETURNS TRIGGER AS $$<br>BEGIN<br>&nbsp;&nbsp;&nbsp; IF&nbsp;&nbsp;&nbsp; ( mod(OLD.id,16) = 0 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_0 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 1 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_1 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 2 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_2 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 3 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_3 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 4 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_4 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 5 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_5 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 6 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_6 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 7 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_7 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 8 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_8 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 9 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_9 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 10 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_10 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 11 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_11 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 12 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_12 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 13 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_13 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 14 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_14 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 15 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_15 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp; ELSE<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RAISE EXCEPTION 'ID out of range.&nbsp; Please fix the tbl_user_info_delete_trigger() function!';<br>&nbsp;&nbsp;&nbsp; END IF;<br>&nbsp;&nbsp;&nbsp; RETURN NULL;<br>END;<br>$$<br>LANGUAGE plpgsql;<br><br><br><br>CREATE TRIGGER insert_tbl_user_info_trigger<br>&nbsp;&nbsp;&nbsp; BEFORE INSERT ON tbl_user_info<br>&nbsp;&nbsp;&nbsp; FOR EACH ROW EXECUTE PROCEDURE tbl_user_info_insert_trigger();<br><br>CREATE TRIGGER delete_tbl_user_info_trigger<br>&nbsp;&nbsp;&nbsp; BEFORE DELETE ON tbl_user_info<br>&nbsp;&nbsp;&nbsp; FOR EACH ROW EXECUTE PROCEDURE tbl_user_info_delete_trigger();</font></p></pre><br>极端性能测试:<br><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; insert into tbl_user_info select generate_series(0,16000000,16),'zhou','digoal','sky-mobi',27;<br>INSERT 0 0<br>Time: 34749.758 ms<br>digoal=&gt; truncate table tbl_user_info ;<br>TRUNCATE TABLE<br>Time: 495.907 ms<br>digoal=&gt; insert into tbl_user_info select generate_series(15,16000000,16),'zhou','digoal','sky-mobi',27;<br>INSERT 0 0<br>Time: 43517.893 ms<br>digoal=&gt; select count(*) from tbl_user_info;<br>&nbsp; count&nbsp; <br>---------<br>&nbsp;1000000<br>（准确抵达目标表）<br>digoal=&gt; select count(*) from tbl_user_info_15;<br>&nbsp; count&nbsp; <br>---------<br>&nbsp;1000000</font></p></pre>单个操作下第一个判断和最后一个判断时间相差 (43517.893-34749.758)/100w = 0.008768135 ms<br><br>不使用触发器的情况下，<br><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; insert into tbl_user_info_single select generate_series(0,16000000,16),'zhou','digoal','sky-mobi',27;<br>INSERT 0 1000001<br>Time: 3959.861 ms</font></p></pre><br>单个判断至少消耗 = (34749.758-3959.861)/1000000 = 0.030789897 ms<br>至多消耗 = 0.039558032 ms<br><br>二、分两个组的情况<br>更新触发器函数:<br><pre class="prettyprint"  ><p><font size="2"  >CREATE OR REPLACE FUNCTION tbl_user_info_insert_trigger()<br>RETURNS TRIGGER AS $$<br>BEGIN<br>&nbsp;&nbsp;&nbsp; IF&nbsp;&nbsp;&nbsp; ( mod(NEW.id,2) = 0 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IF&nbsp;&nbsp;&nbsp; ( mod(NEW.id,16) = 0 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_0 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,16) = 2 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_2 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,16) = 4 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_4 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,16) = 6 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_6 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,16) = 8 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_8 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,16) = 10 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_10 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,16) = 12 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_12 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSE <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_14 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; END IF;<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(NEW.id,2) = 1 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IF&nbsp;&nbsp;&nbsp; ( mod(NEW.id,16) = 1 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_1 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF&nbsp;&nbsp;&nbsp; ( mod(NEW.id,16) = 3 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_3 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF&nbsp;&nbsp;&nbsp; ( mod(NEW.id,16) = 5 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_5 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF&nbsp;&nbsp;&nbsp; ( mod(NEW.id,16) = 7 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_7 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF&nbsp;&nbsp;&nbsp; ( mod(NEW.id,16) = 9 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_9 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF&nbsp;&nbsp;&nbsp; ( mod(NEW.id,16) = 11 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_11 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF&nbsp;&nbsp;&nbsp; ( mod(NEW.id,16) = 13 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_13 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSE<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INSERT INTO tbl_user_info_15 VALUES (NEW.*);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; END IF;<br>&nbsp;&nbsp;&nbsp; ELSE<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RAISE EXCEPTION 'ID out of range.&nbsp; Please fix the tbl_user_info_insert_trigger() function!';<br>&nbsp;&nbsp;&nbsp; END IF;<br>&nbsp;&nbsp;&nbsp; RETURN NULL;<br>END;<br>$$<br>LANGUAGE plpgsql;<br><br><br><br><br>CREATE OR REPLACE FUNCTION tbl_user_info_delete_trigger()<br>RETURNS TRIGGER AS $$<br>BEGIN<br>&nbsp;&nbsp;&nbsp; IF&nbsp;&nbsp;&nbsp; ( mod(OLD.id,2) = 0 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IF&nbsp;&nbsp;&nbsp; ( mod(OLD.id,16) = 0 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_0 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 2 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_2 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 4 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_4 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 6 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_6 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 8 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_8 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 10 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_10 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 12 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_12 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSE<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_14 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; END IF;<br>&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,2) = 1 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IF&nbsp;&nbsp;&nbsp; ( mod(OLD.id,16) = 1 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_1 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 3 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_3 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 5 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_5 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 7 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_7 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 9 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_9 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 11 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_11 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSIF ( mod(OLD.id,16) = 13 ) THEN<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_13 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSE<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DELETE FROM tbl_user_info_15 where id=OLD.id;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; END IF;<br>&nbsp;&nbsp;&nbsp; ELSE<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RAISE EXCEPTION 'ID out of range.&nbsp; Please fix the tbl_user_info_delete_trigger() function!';<br>&nbsp;&nbsp;&nbsp; END IF;<br>&nbsp;&nbsp;&nbsp; RETURN NULL;<br>END;<br>$$<br>LANGUAGE plpgsql;</font></p></pre><br>极端测试:<br><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; insert into tbl_user_info select generate_series(0,16000000,16),'zhou','digoal','sky-mobi',27;<br>INSERT 0 0<br>Time: 35437.456 ms<br>digoal=&gt; select count(*) from tbl_user_info_0;<br>&nbsp; count&nbsp; <br>---------<br>&nbsp;1000001<br>(1 row)<br><br>Time: 105.315 ms<br>digoal=&gt; truncate table tbl_user_info;<br>TRUNCATE TABLE<br>Time: 489.776 ms<br>digoal=&gt; insert into tbl_user_info select generate_series(15,16000000,16),'zhou','digoal','sky-mobi',27;<br>INSERT 0 0<br>Time: 39364.435 ms<br>digoal=&gt; select count(*) from tbl_user_info_15;<br>&nbsp; count&nbsp; <br>---------<br>&nbsp;1000000<br>(1 row)<br><br>Time: 105.203 ms</font></p></pre><br>最低消耗 = 35437.456 ms<br>最高消耗 = 39364.435 ms<br><br>很明显最高消耗下降了，最低消耗略有上升。符合算法的特性。<br><br>当然如果不使用触发器，将会降低10倍左右的开销。<br><br>所以一般不推荐在数据库端作分区的判断 , 对CPU的开销是比较大的。<br><br>后面两种算法就不再测试了，大家知道一下就好了。</div>
	</div>
</div>
</body>
</html>