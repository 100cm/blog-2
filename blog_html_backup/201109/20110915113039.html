<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Success use oracle_fdw create oracle foreign table in PostgreSQL</h2>
	<h5 id="">2011-09-15 11:30:39&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020118151162340/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前几天拿0.9的版本测试的，测试没有成功，记录在BLOG<a style="line-height: 22px; " href="http://blog.163.com/digoal@126/blog/static/16387704020118951953408/"  >http://blog.163.com/digoal@126/blog/static/16387704020118951953408/</a>&nbsp;里面。</div><div>9月14号，作者上传了新版本0.9.1。测试成功。</div><div>下面是详细的测试过程。</div><div>测试环境：</div><div>操作系统：</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  > RHEL 5.2 64 bit</font></div><div><font size="2"  > 2.6.18-92.el5 #1 SMP Tue Jun 10 18:51:06 EDT 2008 x86_64 x86_64 x86_64 GNU/Linux</font></div><p></p></pre></div><div>PG数据库：</div><div><span style="white-space:pre;"  > </span>PostgreSQL 9.1.0 正式版.</div><div>字符集：UTF-8</div><div>PG数据库服务器所需ORACLE软件：</div><div><pre class="prettyprint"  ><p><font size="2"  > Oracle 10.2.0.4 software</font></p></pre></div><div><br></div><div>被访问的Oracle数据库版本：</div><div><span style="white-space:pre;"  > </span>10.2.0.4</div><div>数据库字符集：</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >NLS_CHARACTERSET &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UTF8</font></div><div><font size="2"  >NLS_NCHAR_CHARACTERSET &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UTF8</font></div><p></p></pre></div><div><br></div><div>PostgreSQL 9.1.0 编译参数:</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >./configure --prefix=/opt/pgsql --with-pgport=1921 --with-wal-segsize=64 --with-perl --with-python --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety &amp;&amp; gmake world</font></div></div><div><font size="2"  >gmake install-world</font></div><p></p></pre></div><div># 这里使用了--without-ldap</div><div><br></div><div>Oracle10.2.0.4 安装目录：</div><div><pre class="prettyprint"  ><p><font size="2"  >/app/oracle/product/10.2.0/db_1</font></p></pre></div><div># 这里省去了我上一篇BLOG写的下载和安装<span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  >oracle sdk,oracle instant client.的步骤，只使用oracle 10.2.0.4这个企业版软件.</span></div><div><pre class="prettyprint"  ><p><font size="2"  >chown -R postgres:postgres /app/oracle</font></p></pre></div><div><br></div><div>postgres操作系统用户环境变量：</div><div>.bash_profile</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ># .bash_profile</font></div><div><font size="2"  ># Get the aliases and functions</font></div><div><font size="2"  >if [ -f ~/.bashrc ]; then</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; . ~/.bashrc</font></div><div><font size="2"  >fi</font></div><div><font size="2"  ># User specific environment and startup programs</font></div><div><font size="2"  >PATH=$PATH:$HOME/bin</font></div><div><font size="2"  >export PATH</font></div><div><font size="2"  >export PS1="$USER@`/bin/hostname -s`-&gt; "</font></div><div><font size="2"  >export PGPORT=1921</font></div><div><font size="2"  >export PGDATA=/home/pgdata/pg_root</font></div><div><font size="2"  >export PGARCHIVE=/home/pgdata/pg_arch</font></div><div><font size="2"  >export ORACLE_HOME=/app/oracle/product/10.2.0/db_1</font></div><div><font size="2"  >export LANG=en_US.utf8</font></div><div><font size="2"  >export PGHOME=/opt/pgsql</font></div><div><font size="2"  >export LD_LIBRARY_PATH=$ORACLE_HOME/lib:$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</font></div><div><font size="2"  >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"  >export PATH=$ORACLE_HOME/bin:$PGHOME/bin:$PATH:.</font></div><div><font size="2"  >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"  >alias rm='rm -i'</font></div><div><font size="2"  >alias ll='ls -lh'</font></div><p></p></pre></div><div>#　新加了环境变量ORACLE_HOME</div><div># &nbsp; 修改环境变量 PATH 和&nbsp;LD_LIBRARY_PATH</div><div>所以需要重启postgresql让他认到oracle的LIB目录。</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg_ctl stop -D $PGDATA</font></div><div><font size="2"  >pg_ctl start -D $PGDATA</font></div><p></p></pre></div><div><br></div><div>接下来下载oracle_fdw-0.9.1.tar.gz</div><div>解压缩到postgresql源码的contrib目录下面.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >chown -R postgres:postgres&nbsp;</font></div><div><font size="2"  >su - root</font></div><p></p></pre></div><div># 需要用到pg_config和ORACLE_HOME目录，因此直接执行postgres用户的环境变量。</div><div>. /home/postgres/.bash_profile</div><div>cd pg9.1源码/contrib/oracle_fdw-0.9.1</div><div># 终于没有0.9的报错了。</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >root@digoal -# make install</font></div><div><div><font size="2"  >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wformat-security -fno-strict-aliasing -fwrapv -fpic -I/app/oracle/product/10.2.0/db_1/sdk/include -I/app/oracle/product/10.2.0/db_1/oci/include -I/app/oracle/product/10.2.0/db_1/rdbms/public -I. -I. -I/opt/pgsql/include/server -I/opt/pgsql/include/internal -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o oracle_fdw.o oracle_fdw.c</font></div><div><font size="2"  >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wformat-security -fno-strict-aliasing -fwrapv -fpic -I/app/oracle/product/10.2.0/db_1/sdk/include -I/app/oracle/product/10.2.0/db_1/oci/include -I/app/oracle/product/10.2.0/db_1/rdbms/public -I. -I. -I/opt/pgsql/include/server -I/opt/pgsql/include/internal -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o oracle_utils.o oracle_utils.c</font></div><div><font size="2"  >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wformat-security -fno-strict-aliasing -fwrapv -fpic -shared -o oracle_fdw.so oracle_fdw.o oracle_utils.o -L/opt/pgsql/lib &nbsp;-Wl,-rpath,'/opt/pgsql/lib',--enable-new-dtags &nbsp;-L/app/oracle/product/10.2.0/db_1 -L/app/oracle/product/10.2.0/db_1/bin -L/app/oracle/product/10.2.0/db_1/lib -lclntsh&nbsp;</font></div><div><font size="2"  >/bin/mkdir -p '/opt/pgsql/lib'</font></div><div><font size="2"  >/bin/mkdir -p '/opt/pgsql/share/extension'</font></div><div><font size="2"  >/bin/mkdir -p '/opt/pgsql/share/doc/extension'</font></div><div><font size="2"  >/bin/sh /opt/pgsql/lib/pgxs/src/makefiles/../../config/install-sh -c -m 755 &nbsp;oracle_fdw.so '/opt/pgsql/lib/oracle_fdw.so'</font></div><div><font size="2"  >/bin/sh /opt/pgsql/lib/pgxs/src/makefiles/../../config/install-sh -c -m 644 ./oracle_fdw.control '/opt/pgsql/share/extension/'</font></div><div><font size="2"  >/bin/sh /opt/pgsql/lib/pgxs/src/makefiles/../../config/install-sh -c -m 644 ./oracle_fdw--1.0.sql &nbsp;'/opt/pgsql/share/extension/'</font></div><div><font size="2"  >/bin/sh /opt/pgsql/lib/pgxs/src/makefiles/../../config/install-sh -c -m 644 ./README.oracle_fdw '/opt/pgsql/share/doc/extension/'</font></div></div><p></p></pre></div><div><br></div><div>然后使用超级用户进入postgresql的目标数据库加载extension.</div><div>su - postgres</div><div>psql -h 127.0.0.1 digoal postgres</div><div>digoal=# create extension oracle_fdw;</div><div><br></div><div>接下来去需要被访问的ORACLE数据库创建测试表：</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >sqlplus /nolog</font></div><div><font size="2"  >conn digoal/digoal_123</font></div><div><font size="2"  >create table tbl_oracle_fdw (id int,firstname varchar2(32),lastname varchar2(32),crt_time date);</font></div><div><font size="2"  ># 插入测试数据</font></div><div><font size="2"  >insert into tbl_oracle_fdw values(1,'zhou','digoal',sysdate);</font></div><div><font size="2"  >insert into tbl_oracle_fdw values(2,'周','德哥',sysdate);</font></div><div><font size="2"  >commit;</font></div><p></p></pre></div><div><br></div><div>接下来使用超级用户进入postgresql数据库的需要访问到oracle的库下面.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >psql -h 127.0.0.1 digoal postgres</font></div><div><font size="2"  >digoal=# create server ora foreign data wrapper oracle_fdw options (dbserver '//172.16.x.xxx:1521/digoal');</font></div><div><font size="2"  ># 下面options使用的是oracle数据库的用户名和密码。</font></div><div><font size="2"  >digoal=# create user mapping for digoal server ora options (user 'digoal',password 'digoal_123');</font></div><div><font size="2"  ># 下面options使用的是oracle的信息，plan_costs如果为true，需要ORACLE用户有查询v$SQL的权限，后面会有解释。</font></div><div><font size="2"  >digoal=#&nbsp;create FOREIGN table tbl_oracle_fdw (id int,firstname varchar(32),lastname varchar(32),crt_time timestamp without time zone) server ora options (table 'tbl_oracle_fdw',schema 'digoal',plan_costs 'true');</font></div><div><div><font size="2"  ># 把这个FOREIGN表赋予给digoal的ALL权限。</font></div><div><font size="2"  >digoal=# grant all on tbl_oracle_fdw to digoal;</font></div></div><div><font size="2"  ># 进入digoal用户查询。</font></div><div><font size="2"  >digoal=&gt; \c digoal digoal</font></div><div><font size="2"  ># 这里报错了，原因是用于连接ORACLE的ORACLE用户digoal没有读取v$sql的权限。</font></div><div><font size="2"  >digoal=&gt; select * from tbl_oracle_fdw ;</font></div><div><div><font size="2"  >ERROR: &nbsp;no SELECT privilege on V$SQL in the remote database</font></div><div><font size="2"  >DETAIL: &nbsp;ORA-00942: table or view does not exist</font></div></div><div><font size="2"  ># 到ORACLE给予digoal用户读取v$SQL的权限</font></div><div><font size="2"  >sqlplus "/ as sysdba"</font></div><div><font size="2"  >grant select_catalog_role to digoal;</font></div><p></p></pre></div><div><br></div><div># 再次到POSTGRESQL查询这个foreign table.还是报错，原因是刚才的从pg到oracle的数据库连接没有断开，oracle用户权限生效需要重新登陆。因此我们需要断开postgresql到oracle的连接再次尝试。</div><div><div><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >digoal=&gt; select * from tbl_oracle_fdw ;</font></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  >ERROR: &nbsp;no SELECT privilege on V$SQL in the remote database</font></div><div style="line-height: 22px;"  ><font size="2"  >DETAIL: &nbsp;ORA-00942: table or view does not exist</font></div></div><p></p></pre></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><br></div><div style="line-height: 22px;"  ># 进入超级用户断开连接。</div></div></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >\c digoal postgres</font></div><div><font size="2"  >digoal=# select oracle_close_connections();</font></div><p></p></pre></div><div><br></div><div># 再次到POSTGRESQL查询这个foreign table.正常。中午显示正常。</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >\c digoal digoal</font></div><div><div><font size="2"  >digoal=&gt; select * FROM tbl_oracle_fdw;</font></div><div><font size="2"  >&nbsp;id | firstname | lastname | &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----+-----------+----------+---------------------</font></div><div><font size="2"  >&nbsp; 1 | zhou &nbsp; &nbsp; &nbsp;| digoal &nbsp; | 2011-09-15 10:55:32</font></div><div><font size="2"  >&nbsp; 2 | 周 &nbsp; &nbsp; &nbsp; &nbsp;| 德哥 &nbsp; &nbsp; | 2011-09-15 11:18:41</font></div><div><font size="2"  >(2 rows)</font></div></div><p></p></pre></div><div><br></div><div># 由于foreign表是只读的，所以删除记录报错。</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; delete FROM tbl_oracle_fdw;</font></div><div><font size="2"  >WARNING: &nbsp;column number 0 of foreign table "tbl_oracle_fdw" does not exist in foreign Oracle table, will be replaced by NULL</font></div><div><font size="2"  >ERROR: &nbsp;cannot change foreign table "tbl_oracle_fdw"</font></div><p></p></pre></div><div><br></div>【参考】<div><a href="http://blog.163.com/digoal@126/blog/static/16387704020118951953408/"  >http://blog.163.com/digoal@126/blog/static/16387704020118951953408/</a><br><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ><a style="line-height: 22px; text-decoration: none; color: rgb(85, 108, 136); " rel="nofollow" href="http://pgfoundry.org/docman/view.php/1000600/13802/README.txt"  >http://pgfoundry.org/docman/view.php/1000600/13802/README.txt</a><br style="line-height: 22px;"  >http://www.oracle.com/technetwork/topics/linuxx86-64soft-092277.html</span><wbr></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">PeRcy - 2011-10-12 16:10:15</h5>
				<div><P>有mysql的教程吗？谢谢</P></div>
			</div>
	</div>
</div>
</body>
</html>