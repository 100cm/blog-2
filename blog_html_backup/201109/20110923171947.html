<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL operator case</h2>
	<h5 id="">2011-09-23 17:19:47&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020118235519963/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">今天一位群里的朋友问了一个问题 , 如下 :&nbsp;<div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select now()::timestamp-'10 min';</font></div><div><font size="2"   >ERROR: &nbsp;invalid input syntax for type timestamp: "10 min"</font></div><div><font size="2"   >LINE 1: select now()::timestamp-'10 min';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><p></p></pre></div><div>但是加法是可以的。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select now()::timestamp+'10 min';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------</font></div><div><font size="2"   >&nbsp;2011-09-23 17:13:16.767569</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div><br></div><div>解决办法是使用标准写法 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select now()::timestamp+ interval '10 min';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------</font></div><div><font size="2"   >&nbsp;2011-09-23 17:13:51.697632</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; select now()::timestamp- interval '10 min';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------</font></div><div><font size="2"   >&nbsp;2011-09-23 16:53:54.793088</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>接下来分析一下原因 :&nbsp;</div><div>首先来看这条报错的SQL &nbsp;：&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >digoal=&gt; select now()::timestamp-'10 min';</font></p></pre></div><div>操作符为 " - "</div><div>左边的类型是 timestamp</div><div>右边的类型是字符串&nbsp;</div><div><br></div><div>那么来看看有没有对应的操作符 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select oid,typname from pg_type where typname ~'timestamp' or typname ~ 'interval';</font></div><div><font size="2"   >&nbsp;oid &nbsp;| &nbsp; typname &nbsp; &nbsp;</font></div><div><font size="2"   >------+--------------</font></div><div><font size="2"   >&nbsp; 704 | tinterval</font></div><div><font size="2"   >&nbsp;1025 | _tinterval</font></div><div><font size="2"   >&nbsp;1114 | timestamp</font></div><div><font size="2"   >&nbsp;1115 | _timestamp</font></div><div><font size="2"   >&nbsp;1184 | timestamptz</font></div><div><font size="2"   >&nbsp;1185 | _timestamptz</font></div><div><font size="2"   >&nbsp;1186 | interval</font></div><div><font size="2"   >&nbsp;1187 | _interval</font></div><div><font size="2"   >(8 rows)</font></div><p></p></pre></div><div><br></div><div>左边可以确定是1114了.接下来看看操作符</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select oid,oprname,oprleft,oprright,oprresult from pg_operator where oprleft =1114 &nbsp;order by oprname;</font></div><div><font size="2"   >&nbsp; oid &nbsp;| oprname | oprleft | oprright | oprresult&nbsp;</font></div><div><font size="2"   >-------+---------+---------+----------+-----------</font></div><div><font size="2"   >&nbsp; 2066 | + &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp;1114 | &nbsp; &nbsp; 1186 | &nbsp; &nbsp; &nbsp;1114</font></div><div><font size="2"   >&nbsp;24672 | - &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp;1114 | &nbsp; &nbsp; 1114 | &nbsp; &nbsp; &nbsp;1186</font></div><div><font size="2"   >&nbsp; 2068 | - &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp;1114 | &nbsp; &nbsp; 1186 | &nbsp; &nbsp; &nbsp;1114</font></div><p></p></pre></div><div>其他的操作符后面略.</div><div>从这里可以看出，左边是timestamp类型的时候，” - “操作符的右边可以是timestamp类型或者interval类型。</div><div>如果是 "+"操作符，左边是timestamp类型的时候，右边只能是interval。</div><div>因此系统在做类型转换的时候，使用" + "操作符，毫无疑问，右边会尝试转成interval类型。由于可以转换，则执行成功。</div><div>然而" - "操作符，从报错上来看，显然系统先尝试把'10 min' 转换为timestamp类型失败。</div><div>转换规则参考 pg_cast 系统表。</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select oid,* from pg_cast where casttarget in (1114,1186) order by oid;</font></div><div><font size="2"   >&nbsp; oid &nbsp;| castsource | casttarget | castfunc | castcontext | castmethod&nbsp;</font></div><div><font size="2"   >-------+------------+------------+----------+-------------+------------</font></div><div><font size="2"   >&nbsp;10866 | &nbsp; &nbsp; &nbsp; &nbsp;702 | &nbsp; &nbsp; &nbsp; 1114 | &nbsp; &nbsp; 2023 | i &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >&nbsp;10868 | &nbsp; &nbsp; &nbsp; &nbsp;703 | &nbsp; &nbsp; &nbsp; 1186 | &nbsp; &nbsp; 1177 | i &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >&nbsp;10869 | &nbsp; &nbsp; &nbsp; 1082 | &nbsp; &nbsp; &nbsp; 1114 | &nbsp; &nbsp; 2024 | i &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >&nbsp;10871 | &nbsp; &nbsp; &nbsp; 1083 | &nbsp; &nbsp; &nbsp; 1186 | &nbsp; &nbsp; 1370 | i &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >&nbsp;10880 | &nbsp; &nbsp; &nbsp; 1184 | &nbsp; &nbsp; &nbsp; 1114 | &nbsp; &nbsp; 2027 | a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >&nbsp;10929 | &nbsp; &nbsp; &nbsp; 1114 | &nbsp; &nbsp; &nbsp; 1114 | &nbsp; &nbsp; 1961 | i &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >&nbsp;10931 | &nbsp; &nbsp; &nbsp; 1186 | &nbsp; &nbsp; &nbsp; 1186 | &nbsp; &nbsp; 1200 | i &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >(7 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select typname from pg_type where oid in (select castsource from pg_cast where casttarget in (1114,1186));</font></div><div><font size="2"   >&nbsp; &nbsp;typname &nbsp;&nbsp;</font></div><div><font size="2"   >-------------</font></div><div><font size="2"   >&nbsp;abstime</font></div><div><font size="2"   >&nbsp;date</font></div><div><font size="2"   >&nbsp;timestamp</font></div><div><font size="2"   >&nbsp;reltime</font></div><div><font size="2"   >&nbsp;time</font></div><div><font size="2"   >&nbsp;timestamptz</font></div><div><font size="2"   >&nbsp;interval</font></div><div><font size="2"   >(7 rows)</font></div><p></p></pre></div><div><br></div><div>接下来我们把其中的一个 " - "操作符(&nbsp;- &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp;1114 | &nbsp; &nbsp; 1114 | &nbsp; &nbsp; &nbsp;1186)删除,来验证一下 :&nbsp;</div><div>先备份 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >create table oper_24672 as select * from&nbsp;pg_operator where oid=24672;</font></p></pre></div><div>然后删除这个OPER</div><div><pre class="prettyprint"   ><p><font size="2"   >delete from&nbsp;pg_operator where oid=24672;</font></p></pre></div><div>然后再次尝试前面报错的SQL ：&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select now()::timestamp-'10 min';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------</font></div><div><font size="2"   >&nbsp;2011-09-23 17:08:34.933015</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>正常。</div><div><br></div><div>记得把这个OPER还原回去:</div><div><pre class="prettyprint"   ><p><font size="2"   >insert into pg_operator select * from oper_24672;</font></p></pre></div><div><br></div><div>另外，删除operator也可以使用drop operator的SQL</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Command: &nbsp; &nbsp; DROP OPERATOR</font></div><div><font size="2"   >Description: remove an operator</font></div><div><font size="2"   >Syntax:</font></div><div><font size="2"   >DROP OPERATOR [ IF EXISTS ] name ( { left_type | NONE } , { right_type | NONE } ) [ CASCADE | RESTRICT ]</font></div><p></p></pre></div><div><br></div><div>【警告】</div><div>1. 一般不建议直接修改系统表, 通过SQL命令比较靠谱.</div><div>2. 建议不要在生产中尝试。</div><div><br></div><div>【参考】</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/catalog-pg-cast.html"   >http://www.postgresql.org/docs/9.1/static/catalog-pg-cast.html</a></div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/catalog-pg-type.html"   >http://www.postgresql.org/docs/9.1/static/catalog-pg-type.html</a></div></div>
	</div>
</div>
</body>
</html>