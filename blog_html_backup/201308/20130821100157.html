<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL use pgbench and mongo_fdw test mongoDB & PostgreSQL performance</h2>
	<h5 id="">2013-08-21 10:01:57&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201372011056128/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>2015-02-08更新</div><div>实际测试建议自行编写测试程序, 不要使用pgbench加PostgreSQL外部表来测试对比, 没有意义.</div><div>例如使用python可以很方便快速的进行测试.</div><div><br></div><div>最近写过两篇使用pgbench以及PostgreSQL fdw测试对比PostgreSQL性能以及MySQL, Oracle的性能对比.</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201362355123969/"   >http://blog.163.com/digoal@126/blog/static/163877040201362355123969/</a></div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020137834025753/"   >http://blog.163.com/digoal@126/blog/static/16387704020137834025753/</a></div><div>最近公司某些mongoDB的服务经常因为锁问题导致堵塞(当然,这可能是数据库选型带来的问题,当时只考虑要用mongodb的javascript.), 所以想借此机会将mongoDB上的业务迁移到PostgreSQL, PostgreSQL支持json类型同时也可以通过plv8 language支持javascript语言.&nbsp;</div><div>在功能上来说从mongoDB迁移到PostgreSQL是完全没有问题的.</div><div>包括capped collection也是可以通过其他手段来实现的 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201293051423810/"   >http://blog.163.com/digoal@126/blog/static/163877040201293051423810/</a></div><div>当然, 本文主要还是想用pgbench来测试一下mongoDB的查询性能.</div><div>测试环境 :&nbsp;</div><div>服务器 DELL R610 8核E5504 &nbsp;@ 2.00GHz 内存 24G</div><div>操作系统版本 CentOS 5.7 x64</div><div>mongodb版本 2.4.5</div><div>mongo_fdw所在数据库版本PostgreSQL 9.2.4</div><div>对比mongoDB性能的PostgreSQL版本 9.4 devel</div><div>plv8 版本 1.4.1</div><div>v8 版本 3.14.5</div><div><br></div><div>mongoDB配置文件 :&nbsp;</div><div>vi mongod.conf</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >logpath=/dev/null</font></div><div><font size="2"   >logappend=true</font></div><div><font size="2"   >fork = true</font></div><div><font size="2"   >port = 5281</font></div><div><font size="2"   >dbpath=/pgdata/digoal/1921/data02/mongodata/data</font></div><div><font size="2"   >pidfilepath = /pgdata/digoal/1921/data02/mongodata/run/mongod.pid</font></div><div><font size="2"   >nojournal = true</font></div><div><font size="2"   >noauth = true</font></div><div><font size="2"   >diaglog = 0</font></div><div><font size="2"   >nohttpinterface = true</font></div><div><font size="2"   >noprealloc = false</font></div><div><font size="2"   >nssize = 1000</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >启动mongodb :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >[mongo@db-172-16-3-39 data]$ numactl --interleave=all mongod -f /pgdata/digoal/1921/data02/mongodata/etc/mongod.conf</font></span></div><div><div><font size="2"   >[mongo@db-172-16-3-39 data]$ mongo 127.0.0.1:5281/admin</font></div><div><font size="2"   >MongoDB shell version: 2.4.5</font></div><div><font size="2"   >connecting to: 127.0.0.1:5281/admin</font></div><div><font size="2"   >&gt; show dbs</font></div><div><font size="2"   >local &nbsp; 1.0390625GB</font></div></div><p></p></pre></div><div><br></div><div>在PostgreSQL数据库中生成测试数据500W条.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg94@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.4devel)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><div><font size="2"   >digoal=# create table mongo_test(id serial primary key, info text, crt_time timestamp(0));</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into mongo_test (info,crt_time) select md5(random()::text), clock_timestamp() from generate_series(1,5000000);</font></div></div><div><font size="2"   >INSERT 0 5000000</font></div><p></p></pre></div><div>导出为JSON格式 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select case when id is null then '{"id" : null,' else '{"id" : '||id||',' end || case when info is null then '"info" : null,' else '"info" : "'||info||'",' end || case when crt_time is null then '"crt_time" : null,' else '"crt_time" : {"$date": '||1000*extract(epoch from crt_time)||'}}' end from mongo_test limit 1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;?column? &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;{"id" : 712193,"info" : "dcf472682b9322c56bcdc04b1f508fed","crt_time" : {"$date": 1377007405000}}</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >copy (select case when id is null then '{"id" : null,' else '{"id" : '||id||',' end || case when info is null then '"info" : null,' else '"info" : "'||info||'",' end || case when crt_time is null then '"crt_time" : null,' else '"crt_time" : {"$date": '||1000*extract(epoch from crt_time)||'}}' end from mongo_test) to '/home/pg94/to_mongo.json';</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg94@db-172-16-3-33-&gt; ll</font></div><div><font size="2"   >-rw-r--r-- 1 pg94 pg94 472M Aug 20 14:34 to_mongo.json</font></div><p></p></pre></div><div>导入到mongodb :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >mongoimport -h 127.0.0.1:5281 -d test -c mongo_test --type json --file ./to_mongo.json&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[mongo@db-172-16-3-39 ~]$ mongo 127.0.0.1:5281/test</font></div><div><font size="2"   >MongoDB shell version: 2.4.5</font></div><div><font size="2"   >connecting to: 127.0.0.1:5281/test</font></div><div><font size="2"   >&gt; db.mongo_test.findOne()</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "_id" : ObjectId("52130da5956db0c777ff0c0e"),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "id" : 712193,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "info" : "dcf472682b9322c56bcdc04b1f508fed",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "crt_time" : ISODate("2013-08-20T14:03:25Z")</font></div><div><font size="2"   >}</font></div><div><font size="2"   >&gt; db.mongo_test.count()</font></div><div><font size="2"   >5000000</font></div><p></p></pre></div><div>在另一台测试服务器(配置与mongodb所在的服务器一致)中安装postgresql 9.2.4以及mongo_fdw :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg92@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.2.4)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# CREATE FOREIGN TABLE f_mongo_test(_id name, id int, info text, crt_time timestamp ) server mongo_server options (database 'test', collection 'mongo_test');</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# select * from f_mongo_test limit 1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;_id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; id &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------+--------+----------------------------------+---------------------</font></div><div><font size="2"   >&nbsp;52130e1c956db0c777ff0c0f | 712193 | dcf472682b9322c56bcdc04b1f508fed | 2013-08-20 14:03:25</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>收集外部表的统计信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# analyze verbose f_mongo_test ;</font></div><div><font size="2"   >INFO: &nbsp;analyzing "public.f_mongo_test"</font></div><div><font size="2"   >INFO: &nbsp;"f_mongo_test": collection contains 5000000 rows; 30000 rows &nbsp; &nbsp; in sample</font></div><div><font size="2"   >ANALYZE</font></div><p></p></pre></div><div>查询外部表耗时 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# explain (verbose, analyze, buffers, costs, timing) select * from f_mongo_test where id=1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on public.f_mongo_test &nbsp;(cost=5.00..78172.50 rows=25000 width=44) (actual time=2084.008..2084.010 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (f_mongo_test.id = 1)</font></div><div><font size="2"   >&nbsp; &nbsp;Foreign Namespace: test.mongo_test</font></div><div><font size="2"   >&nbsp;Total runtime: 2084.591 ms</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div><div>由于目前mongodb中未使用索引, 所以影响查询性能, 加上索引 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&gt; db.mongo_test.ensureIndex({"id":1})</font></div></div><div></div><p></p></pre></div></div><div>加上索引后, 性能显著提升 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# explain (verbose, analyze, buffers, costs, timing) select * from f_mongo_test where id=1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on public.f_mongo_test &nbsp;(cost=5.00..78172.50 rows=25000 width=44) (actual time=0.324..0.325 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (f_mongo_test.id = 1)</font></div><div><font size="2"   >&nbsp; &nbsp;Foreign Namespace: test.mongo_test</font></div><div><font size="2"   >&nbsp;Total runtime: 0.942 ms</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div><div>接下来要对比一下mongoDB和PostgreSQL的查询性能 :&nbsp;</div><div>PostgreSQL本地表的primary key的单条查询性能如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-33-&gt; cat test.sql&nbsp;</font></div><div><font size="2"   >\setrandom id 1 5000000</font></div><div><font size="2"   >select * from mongo_test where id=:id;</font></div><div><font size="2"   >pg92@db-172-16-3-33-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -T 10 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 1094219</font></div><div><font size="2"   >tps = 108939.841203 (including connections establishing)</font></div><div><font size="2"   >tps = 109216.834472 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001316 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.143290 &nbsp; &nbsp; &nbsp; &nbsp;select * from mongo_test where id=:id;</font></div><p></p></pre></div><div>mongodb的查询性能通过外部表来查 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >pg94@db-172-16-3-33-&gt; pgbench -M simple -n -r -f ./test.sql -h 127.0.0.1 -p 1919 -U postgres -c 24 -j 24 -T 10 postgres<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: simple<br>number of clients: 24<br>number of threads: 24<br>duration: 10 s<br>number of transactions actually processed: 38974<br>tps = 3894.009486 (including connections establishing)<br>tps = 3902.631852 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        0.002327        \setrandom id 1 5000000<br>        6.141765        select 1 from f_mongo_test where id=:id;</span></font></div><p></p></pre></div><div><div>此时mongod进程的CPU开销约368.8%, 接近所有cpu(8核)资源的一半.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Cpu(s): 26.3%us, 11.1%sy,  0.0%ni, 48.8%id,  0.0%wa,  0.5%hi, 13.3%si,  0.0%st</font></div><div><font size="2"   ><span style="line-height: 19px;"   >  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                <br>12660 mongo     25   0 3263m 812m 781m R 368.8 10.2   6:36.94 mongod -f ./mongod.conf</span></font></div><p></p></pre></div></div><div>通过mongodb自身的opcounters查看query数和pgbench统计的query数是否吻合.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&gt; db.serverStatus().opcounters</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "insert" : 1,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query" : 296845,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "update" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "delete" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "getmore" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "command" : 1474354</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   >-- pgbench测试完后, 查看opcounters</font></div><div><font size="2"   >&gt;&nbsp;<span style="line-height: 22px;"   >db.serverStatus().opcounters</span></font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "insert" : 1,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query" : 335821,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "update" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "delete" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "getmore" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "command" : 1669226</font></div><div><font size="2"   >}</font></div><div><font size="2"   >query :&nbsp;<span style="line-height: 22px;"   >335821-</span><span style="line-height: 22px;"   >296845 =&nbsp;</span><span style="line-height: 22px;"   >38976</span></font></div><div><font size="2"   >command :&nbsp;1669226-1474354 =&nbsp;194872</font></div><p></p></pre></div><div>mongo_fdw不仅仅对mongodb有查询操作, 还有其他的command请求. 所以这里我们在计算时使用command的累计.</div><div>command 每秒达到了19487. 除去建立连接的开销, mongodb本身的cpu使用率选择26.3%.</div><div>因此当系统资源耗尽时, mongodb应该可以处理达到74095每秒的请求.</div><div><br></div><div>执行<span style="line-height: 22px;"   >db.serverStatus().opcounters本身会增加2个command计数. 不会增加query计数. 如下 :&nbsp;</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&gt; db.serverStatus().opcounters</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "insert" : 1,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query" : 412033,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "update" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "delete" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "getmore" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "command" : 2050263</font></div><div><font size="2"   >}</font></div><div><font size="2"   >&gt; db.serverStatus().opcounters</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "insert" : 1,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query" : 412033,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "update" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "delete" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "getmore" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "command" : 2050265</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div><br></div><div>一次查询会增加一次query计数, 同时增加1次command计数, 如下 .</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&gt; use test</font></div><div><font size="2"   >&gt; db.serverStatus().opcounters</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "insert" : 1,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query" : 412039,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "update" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "delete" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "getmore" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "command" : 2050277</font></div><div><font size="2"   >}</font></div><div><font size="2"   >&gt; db.mongo_test.find({"id" : 1})</font></div><div><font size="2"   >{ "_id" : ObjectId("52130e83956db0c77740794f"), "id" : 1, "info" : "47e77a34c50df1a84b2e08c17c3d2942", "crt_time" : ISODate("2013-08-20T14:03:17Z") }</font></div><div><font size="2"   >&gt; db.serverStatus().opcounters</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "insert" : 1,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query" : 412040,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "update" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "delete" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "getmore" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "command" : 2050280</font></div><div><font size="2"   >}</font></div><p></p></pre></div></div><div><br></div><div>使用unix-sock测试 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201372011056128/"   >http://blog.163.com/digoal@126/blog/static/163877040201372011056128/</a></div><div>测试结果如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg94@db-172-16-3-33-&gt; pgbench -M simple -n -r -f ./test.sql -h 127.0.0.1 -p 1919 -U postgres -c 24 -j 12 -T 60 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: simple</font></div><div><font size="2"   >number of clients: 24</font></div><div><font size="2"   >number of threads: 12</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 179244</font></div><div><font size="2"   >tps = 2986.862315 (including connections establishing)</font></div><div><font size="2"   >tps = 2987.768753 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002353 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 8.027660 &nbsp; &nbsp; &nbsp; &nbsp;select 1 from f_mongo_test where id=:id;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&gt; db.serverStatus().opcounters</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "insert" : 1,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query" : 980795,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "update" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "delete" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "getmore" : 327,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "command" : 4896557</font></div><div><font size="2"   >}</font></div><div><font size="2"   >&gt; db.serverStatus().opcounters</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "insert" : 1,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query" : 1160048,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "update" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "delete" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "getmore" : 327,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "command" : 5792779</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;RES &nbsp;SHR S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1615 pg94 &nbsp; &nbsp; &nbsp;15 &nbsp; 0 &nbsp;296m 2412 1572 S &nbsp;9.3 &nbsp;0.0 &nbsp; 0:02.22 pgbench -M simple -n -r -f ./test.sql -h 127.0.0.1 -p 1919 -U postgres</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;RES &nbsp;SHR S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1643 pg92 &nbsp; &nbsp; &nbsp;15 &nbsp; 0 1222m 5416 3644 S &nbsp;4.6 &nbsp;0.0 &nbsp; 0:00.95 postgres: postgres postgres 127.0.0.1(22593) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1629 pg92 &nbsp; &nbsp; &nbsp;15 &nbsp; 0 1222m 5416 3644 S &nbsp;4.3 &nbsp;0.0 &nbsp; 0:00.98 postgres: postgres postgres 127.0.0.1(22579) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1630 pg92 &nbsp; &nbsp; &nbsp;16 &nbsp; 0 1222m 5428 3656 S &nbsp;4.3 &nbsp;0.0 &nbsp; 0:00.95 postgres: postgres postgres 127.0.0.1(22580) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1633 pg92 &nbsp; &nbsp; &nbsp;15 &nbsp; 0 1222m 5420 3648 S &nbsp;4.3 &nbsp;0.0 &nbsp; 0:00.97 postgres: postgres postgres 127.0.0.1(22583) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1635 pg92 &nbsp; &nbsp; &nbsp;16 &nbsp; 0 1222m 5420 3648 S &nbsp;4.3 &nbsp;0.0 &nbsp; 0:00.97 postgres: postgres postgres 127.0.0.1(22585) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1637 pg92 &nbsp; &nbsp; &nbsp;16 &nbsp; 0 1222m 5412 3640 S &nbsp;4.3 &nbsp;0.0 &nbsp; 0:00.98 postgres: postgres postgres 127.0.0.1(22587) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1642 pg92 &nbsp; &nbsp; &nbsp;15 &nbsp; 0 1222m 5412 3640 S &nbsp;4.3 &nbsp;0.0 &nbsp; 0:00.98 postgres: postgres postgres 127.0.0.1(22592) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1645 pg92 &nbsp; &nbsp; &nbsp;15 &nbsp; 0 1222m 5416 3644 R &nbsp;4.3 &nbsp;0.0 &nbsp; 0:00.99 postgres: postgres postgres 127.0.0.1(22595) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1652 pg92 &nbsp; &nbsp; &nbsp;15 &nbsp; 0 1222m 5420 3648 S &nbsp;4.3 &nbsp;0.0 &nbsp; 0:00.92 postgres: postgres postgres 127.0.0.1(22599) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1632 pg92 &nbsp; &nbsp; &nbsp;16 &nbsp; 0 1222m 5420 3648 S &nbsp;4.0 &nbsp;0.0 &nbsp; 0:00.94 postgres: postgres postgres 127.0.0.1(22582) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1634 pg92 &nbsp; &nbsp; &nbsp;15 &nbsp; 0 1222m 5412 3640 R &nbsp;4.0 &nbsp;0.0 &nbsp; 0:00.92 postgres: postgres postgres 127.0.0.1(22584) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1639 pg92 &nbsp; &nbsp; &nbsp;16 &nbsp; 0 1222m 5412 3640 S &nbsp;4.0 &nbsp;0.0 &nbsp; 0:00.95 postgres: postgres postgres 127.0.0.1(22589) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1647 pg92 &nbsp; &nbsp; &nbsp;16 &nbsp; 0 1222m 5416 3644 R &nbsp;4.0 &nbsp;0.0 &nbsp; 0:00.96 postgres: postgres postgres 127.0.0.1(22597) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1628 pg92 &nbsp; &nbsp; &nbsp;15 &nbsp; 0 1222m 5416 3644 S &nbsp;3.7 &nbsp;0.0 &nbsp; 0:00.94 postgres: postgres postgres 127.0.0.1(22578) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1638 pg92 &nbsp; &nbsp; &nbsp;16 &nbsp; 0 1222m 5424 3652 S &nbsp;3.7 &nbsp;0.0 &nbsp; 0:00.98 postgres: postgres postgres 127.0.0.1(22588) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1640 pg92 &nbsp; &nbsp; &nbsp;16 &nbsp; 0 1222m 5420 3648 S &nbsp;3.7 &nbsp;0.0 &nbsp; 0:00.95 postgres: postgres postgres 127.0.0.1(22590) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1641 pg92 &nbsp; &nbsp; &nbsp;15 &nbsp; 0 1222m 5420 3648 R &nbsp;3.7 &nbsp;0.0 &nbsp; 0:01.00 postgres: postgres postgres 127.0.0.1(22591) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1648 pg92 &nbsp; &nbsp; &nbsp;15 &nbsp; 0 1222m 5416 3644 S &nbsp;3.7 &nbsp;0.0 &nbsp; 0:00.99 postgres: postgres postgres 127.0.0.1(22598) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1653 pg92 &nbsp; &nbsp; &nbsp;15 &nbsp; 0 1222m 5412 3640 R &nbsp;3.7 &nbsp;0.0 &nbsp; 0:00.96 postgres: postgres postgres 127.0.0.1(22600) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1657 pg92 &nbsp; &nbsp; &nbsp;15 &nbsp; 0 1222m 5420 3648 S &nbsp;3.7 &nbsp;0.0 &nbsp; 0:01.00 postgres: postgres postgres 127.0.0.1(22601) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1631 pg92 &nbsp; &nbsp; &nbsp;16 &nbsp; 0 1222m 5416 3644 S &nbsp;3.3 &nbsp;0.0 &nbsp; 0:00.91 postgres: postgres postgres 127.0.0.1(22581) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1636 pg92 &nbsp; &nbsp; &nbsp;16 &nbsp; 0 1222m 5416 3644 S &nbsp;3.3 &nbsp;0.0 &nbsp; 0:00.91 postgres: postgres postgres 127.0.0.1(22586) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1644 pg92 &nbsp; &nbsp; &nbsp;15 &nbsp; 0 1222m 5412 3640 S &nbsp;3.3 &nbsp;0.0 &nbsp; 0:00.90 postgres: postgres postgres 127.0.0.1(22594) SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1646 pg92 &nbsp; &nbsp; &nbsp;15 &nbsp; 0 1222m 5424 3652 S &nbsp;3.3 &nbsp;0.0 &nbsp; 0:00.94 postgres: postgres postgres 127.0.0.1(22596) SELECT&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Cpu(s): 28.8%us, 15.4%sy, &nbsp;0.0%ni, 55.0%id, &nbsp;0.1%wa, &nbsp;0.0%hi, &nbsp;0.7%si, &nbsp;0.0%st</font></div><div><font size="2"   >&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;RES &nbsp;SHR S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;3389 mongo &nbsp; &nbsp; 20 &nbsp; 0 3269m 839m 808m R 252.9 &nbsp;6.0 &nbsp;15:39.01 mongod -f ./mongod.conf</font></div></div><div><font size="2"   >计算command/s</font></div><div><div><font size="2"   >digoal=# select 4.6+4.3+4.3+4.3+4.3+4.3+4.3+4.3+4.3+4.0+4.0+4.0+4.0+3.7+3.7+3.7+3.7+3.7+3.7+3.7+3.3+3.3+3.3+3.3+9.3+252.9;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; 356.3</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select (252.9/356.3)*28.8;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;?column? &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;20.442099354476564692800</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=# select (5792779-4896557-2)/0.20442/60;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------------</font></div><div><font size="2"   >&nbsp;73070.149691810977</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>和前面pgbench(postgresql fdw)和mongodb分开测试计算得到的值74095差不多.</div><div><br></div><div><span style="line-height: 22px;"   >[小结]</span></div><div><span style="line-height: 22px;"   >1. 使用pgbench测试的mongoDB qps性能为什么这么低?</span></div><div><span style="line-height: 22px;"   >一方面的原因是mongo_fdw未使用长连接, 大部分的开销在建立连接上面了.</span></div><div>另一方面mongo_fdw除了query, 还在mongodb中执行了其他command, 并不是纯粹的query. 所以最后mongodb性能引用的是command/s</div><div>约<span style="line-height: 22px;"   >74095. 不及PostgreSQL的</span>108939.</div><div><span style="line-height: 22px;"   >因此, 使用pgbench测试mongodb的性能并不可取. 还是用mongodb推荐的测试工具比较靠谱.</span></div><div><span style="line-height: 22px;"   >2. 本文测试使用的是mongo-c-driver-0.6的版本, 连接mongodb使用的是tcp连接. 如果改成unix-sock连接的话, 性能会略有提高.</span></div><div>有兴趣的朋友可参考 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201372011056128/"   >http://blog.163.com/digoal@126/blog/static/163877040201372011056128/</a></div><div>3. 下一篇blog将介绍mongo_fdw到底对数据库执行了啥?</div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402013721103316334/"   >http://blog.163.com/digoal@126/blog/static/1638770402013721103316334/</a></div><div>以及如何优化mongo_fdw :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020137211111138/"   >http://blog.163.com/digoal@126/blog/static/16387704020137211111138/</a></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201362355123969/"   >http://blog.163.com/digoal@126/blog/static/163877040201362355123969/</a></div><div>2.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020137834025753/"   >http://blog.163.com/digoal@126/blog/static/16387704020137834025753/</a></div><div>3.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/1638770402013045395446/"   >http://blog.163.com/digoal@126/blog/static/1638770402013045395446/</a></div><div>4.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/1638770402011076252545/"   >http://blog.163.com/digoal@126/blog/static/1638770402011076252545/</a></div><div>5.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="https://github.com/citusdata/mongo_fdw"   >https://github.com/citusdata/mongo_fdw</a></div><div>6.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020137204136657/"   >http://blog.163.com/digoal@126/blog/static/16387704020137204136657/</a></div><div>7.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201293051423810/"   >http://blog.163.com/digoal@126/blog/static/163877040201293051423810/</a></div>8.&nbsp;<a rel="nofollow" href="http://api.mongodb.org/c/current/#"   >http://api.mongodb.org/c/current/#</a><div>9.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://algernon.github.io/libmongo-client/"   >http://algernon.github.io/libmongo-client/</a></div><div>10.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="https://github.com/algernon/libmongo-client"   >https://github.com/algernon/libmongo-client</a></div><div>11.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201372011056128/"   >http://blog.163.com/digoal@126/blog/static/163877040201372011056128/</a></div></div>
	</div>
</div>
</body>
</html>