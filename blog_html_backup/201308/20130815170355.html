<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL window function applied in frame enviroment</h2>
	<h5 id="">2013-08-15 17:03:55&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020137154137930/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在数据分析场景中, 可能会有对前后数据做处理的需求.</div><div>例如</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create table t(usr_id int, apk_id int[], crt_time timestamp(0));</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into t values (1,array[1,2,3,4],now()</font></div><div><font size="2"   >digoal(# );</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# insert into t values (1,array[1,2,3,4,5],now());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# insert into t values (1,array[1,2,3,5],now());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# insert into t values (2,array[1,2,3,5],now());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# insert into t values (2,array[1,3,5],now());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# insert into t values (2,array[1,3,5,7],now());</font></div><div><font size="2"   >INSERT 0 1</font></div></div><div><div><font size="2"   >digoal=# select * from t;</font></div><div><font size="2"   >&nbsp;usr_id | &nbsp; apk_id &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------+-------------+---------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 1 | {1,2,3,4} &nbsp; | 2013-08-15 14:52:32</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 1 | {1,2,3,4,5} | 2013-08-15 14:52:41</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 1 | {1,2,3,5} &nbsp; | 2013-08-15 14:52:45</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 2 | {1,2,3,5} &nbsp; | 2013-08-15 14:52:49</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 2 | {1,3,5} &nbsp; &nbsp; | 2013-08-15 14:52:52</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 2 | {1,3,5,7} &nbsp; | 2013-08-15 14:52:55</font></div><div><font size="2"   >(6 rows)</font></div></div><p></p></pre></div><div>数据处理需求是这样的, 根据usr_id分组, 并且按照crt_time排序, 比较相邻的两条记录中apk_id数组的差异(取出在上1条记录的apk_id中存在, 但是在当前apk_id中不存在的元素).</div><div>以上数据表记录要输出的数据如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >null</font></div><div><font size="2"   >{4}</font></div><div><font size="2"   >null</font></div><div><font size="2"   >null</font></div><div><font size="2"   >{2}</font></div><div><font size="2"   >null</font></div><p></p></pre></div><div>PostgreSQL支持窗口函数, 聚合函数. 同时PostgreSQL 9.4聚合函数还支持filter过滤.</div><div>显然以上场景使用聚合函数不太合适, 但是可以使用窗口函数.</div><div>窗口函数的语法中支持帧的用法, 如下 :&nbsp;</div><div><p style="font-size: 12px; line-height: 1.5em; margin: 1.2em 0em; font-family: verdana, sans-serif;"   >A&nbsp;<i>window function call</i>&nbsp;represents the application of an aggregate-like function over some portion of the rows selected by a query. Unlike regular aggregate function calls, this is not tied to grouping of the selected rows into a single output row ― each row remains separate in the query output. However the window function is able to scan all the rows that would be part of the current row's group according to the grouping specification (<tt>PARTITION BY</tt>&nbsp;list) of the window function call. The syntax of a window function call is one of the following:</p><pre style="font-size: 12px; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border: 1px solid rgb(207, 207, 207); padding: 2ex; margin-top: 2ex; margin-bottom: 2ex; margin-left: 2ex; overflow: auto; border-top-left-radius: 8px; border-top-right-radius: 8px; border-bottom-right-radius: 8px; border-bottom-left-radius: 8px; background-color: rgb(247, 247, 247); line-height: normal;"   ><tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >function_name</tt> ([<span><tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >expression</tt> [<span>, <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >expression</tt> ... </span>]</span>]) OVER ( <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >window_definition</tt> )
<tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >function_name</tt> ([<span><tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >expression</tt> [<span>, <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >expression</tt> ... </span>]</span>]) OVER <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >window_name</tt>
<tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >function_name</tt> ( * ) OVER ( <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >window_definition</tt> )
<tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >function_name</tt> ( * ) OVER <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >window_name</tt>
</pre><p style="font-size: 12px; line-height: 1.5em; margin: 1.2em 0em; font-family: verdana, sans-serif;"   >where&nbsp;<tt style="font-weight: bold; font-style: italic;"   >window_definition</tt>&nbsp;has the syntax</p><pre style="font-size: 12px; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border: 1px solid rgb(207, 207, 207); padding: 2ex; margin-top: 2ex; margin-bottom: 2ex; margin-left: 2ex; overflow: auto; border-top-left-radius: 8px; border-top-right-radius: 8px; border-bottom-right-radius: 8px; border-bottom-left-radius: 8px; background-color: rgb(247, 247, 247); line-height: normal;"   >[ <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >existing_window_name</tt> ]
[ PARTITION BY <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >expression</tt> [, ...] ]
[ ORDER BY <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >expression</tt> [ ASC | DESC | USING <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >operator</tt> ] [ NULLS { FIRST | LAST } ] [, ...] ]
[ <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >frame_clause</tt> ]
</pre><p style="font-size: 12px; line-height: 1.5em; margin: 1.2em 0em; font-family: verdana, sans-serif;"   >and the optional&nbsp;<tt style="font-weight: bold; font-style: italic;"   >frame_clause</tt>&nbsp;can be one of</p><pre style="font-size: 12px; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border: 1px solid rgb(207, 207, 207); padding: 2ex; margin-top: 2ex; margin-bottom: 2ex; margin-left: 2ex; overflow: auto; border-top-left-radius: 8px; border-top-right-radius: 8px; border-bottom-right-radius: 8px; border-bottom-left-radius: 8px; background-color: rgb(247, 247, 247); line-height: normal;"   >[ RANGE | ROWS ] <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >frame_start</tt>
[ RANGE | ROWS ] BETWEEN <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >frame_start</tt> AND <tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >frame_end</tt>
</pre><p style="font-size: 12px; line-height: 1.5em; margin: 1.2em 0em; font-family: verdana, sans-serif;"   >where&nbsp;<tt style="font-weight: bold; font-style: italic;"   >frame_start</tt>&nbsp;and&nbsp;<tt style="font-weight: bold; font-style: italic;"   >frame_end</tt>&nbsp;can be one of</p><pre style="font-size: 12px; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border: 1px solid rgb(207, 207, 207); padding: 2ex; margin-top: 2ex; margin-bottom: 2ex; margin-left: 2ex; overflow: auto; border-top-left-radius: 8px; border-top-right-radius: 8px; border-bottom-right-radius: 8px; border-bottom-left-radius: 8px; background-color: rgb(247, 247, 247); line-height: normal;"   >UNBOUNDED PRECEDING
<tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >value</tt> PRECEDING
CURRENT ROW
<tt style="font-weight: bold; font-style: italic; font-size: 1em;"   >value</tt> FOLLOWING
UNBOUNDED FOLLOWING</pre></div><div>要把帧的范围锁定在当前行和前一行, 使用ROWS BETWEEN 1 preceding and current row</div><div>窗口函数帧的用法可以参考我以前写过的一篇blog :&nbsp;</div><div><a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020121024102312302/"   >http://blog.163.com/digoal@126/blog/static/16387704020121024102312302/</a></div><div><br></div><div>使用以下SQL则可以查询到当前行的前一行的apk_id值 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select usr_id,apk_id,first_value(apk_id) over(partition by usr_id order by crt_time rows between 1 preceding and current row) from t;</font></div><div><font size="2"   >&nbsp;usr_id | &nbsp; apk_id &nbsp; &nbsp;| first_value&nbsp;</font></div><div><font size="2"   >--------+-------------+-------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 1 | {1,2,3,4} &nbsp; | {1,2,3,4}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 1 | {1,2,3,4,5} | {1,2,3,4}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 1 | {1,2,3,5} &nbsp; | {1,2,3,4,5}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 2 | {1,2,3,5} &nbsp; | {1,2,3,5}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 2 | {1,3,5} &nbsp; &nbsp; | {1,2,3,5}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 2 | {1,3,5,7} &nbsp; | {1,3,5}</font></div><div><font size="2"   >(6 rows)</font></div><p></p></pre></div><div>将当前apk_id值与前一行的apk_id值作为参数输入, 进行处理.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create or replace function array_minus(v1 int[], v2 int[]) returns int[] as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; res1 int[];</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select array_agg(r) into res1 from (select unnest(v1) except select unnest(v2)) t(r);</font></div><div><font size="2"   >&nbsp; return res1;&nbsp;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><p></p></pre></div><div>通过以下SQL可以得到本例开头时需要的结果.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select usr_id,apk_id,array_minus(first_value, apk_id) from (select usr_id,apk_id,first_value(apk_id) over(partition by usr_id order by crt_time rows between 1 preceding and current row) from t) t;</font></div><div><font size="2"   >&nbsp;usr_id | &nbsp; apk_id &nbsp; &nbsp;| array_minus&nbsp;</font></div><div><font size="2"   >--------+-------------+-------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 1 | {1,2,3,4} &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 1 | {1,2,3,4,5} |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 1 | {1,2,3,5} &nbsp; | {4}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 2 | {1,2,3,5} &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 2 | {1,3,5} &nbsp; &nbsp; | {2}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 2 | {1,3,5,7} &nbsp; |&nbsp;</font></div><div><font size="2"   >(6 rows)</font></div><p></p></pre></div><div><br></div><div>窗口函数如果需要自定义的话, 需要写C函数进行处理. plpgsql不支持窗口函数的处理.</div><div><dt style="font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"   ><tt>WINDOW</tt></dt><dd style="font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"   ><p style="font-size: 1em; line-height: 1.5em; margin: 1.2em 0em;"   ><tt>WINDOW</tt>&nbsp;indicates that the function is a&nbsp;<i>window function</i>&nbsp;rather than a plain function. This is currently only useful for functions written in C. The&nbsp;<tt>WINDOW</tt>&nbsp;attribute cannot be changed when replacing an existing function definition.</p></dd></div><div>自定义的plpgsql窗口函数没有实际的使用功效.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create or replace function array_minus(v1 int[]) returns int[] as $$ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; declare &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; res1 int[];</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; raise notice '%', v1;&nbsp;</font></div><div><font size="2"   >&nbsp; return v1; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql window strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><p></p></pre></div><div>查询时, 无法获得输入参数的值.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select usr_id,apk_id,array_minus(apk_id) over(partition by usr_id order by crt_time rows between 1 preceding and current row) from t;</font></div><div><font size="2"   >NOTICE: &nbsp;&lt;NULL&gt;</font></div><div><font size="2"   >NOTICE: &nbsp;&lt;NULL&gt;</font></div><div><font size="2"   >NOTICE: &nbsp;&lt;NULL&gt;</font></div><div><font size="2"   >NOTICE: &nbsp;&lt;NULL&gt;</font></div><div><font size="2"   >NOTICE: &nbsp;&lt;NULL&gt;</font></div><div><font size="2"   >NOTICE: &nbsp;&lt;NULL&gt;</font></div><div><font size="2"   >&nbsp;usr_id | &nbsp; apk_id &nbsp; &nbsp;| array_minus&nbsp;</font></div><div><font size="2"   >--------+-------------+-------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 1 | {1,2,3,4} &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 1 | {1,2,3,4,5} |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 1 | {1,2,3,5} &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 2 | {1,2,3,5} &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 2 | {1,3,5} &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 2 | {1,3,5,7} &nbsp; |&nbsp;</font></div><div><font size="2"   >(6 rows)</font></div><p></p></pre></div><div><br></div><div>以下截取一个first_value的代码 :&nbsp;</div><div>src/backend/utils/adt/windowfuncs.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* first_value</font></div><div><font size="2"   >&nbsp;* return the value of VE evaluated on the first row of the</font></div><div><font size="2"   >&nbsp;* window frame, per spec.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >Datum</font></div><div><font size="2"   >window_first_value(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; WindowObject winobj = PG_WINDOW_OBJECT();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Datum &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bool &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;isnull;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; result = WinGetFuncArgInFrame(winobj, 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0, WINDOW_SEEK_HEAD, true,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;isnull, NULL);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (isnull)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_DATUM(result);</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div><br></div><div>[说明]</div><div>1. 本文用到的例子的应用场景说明 :&nbsp;</div><div>例如每条记录存储了用户的启动应用的数组, 要比较查出上次启动, 但是本次未启动的应用.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020121024102312302/"   >http://blog.163.com/digoal@126/blog/static/16387704020121024102312302/</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/sql-expressions.html#SYNTAX-WINDOW-FUNCTIONS"   >http://www.postgresql.org/docs/9.3/static/sql-expressions.html#SYNTAX-WINDOW-FUNCTIONS</a></div><div>3.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/1638770402013618293678/"   >http://blog.163.com/digoal@126/blog/static/1638770402013618293678/</a></div></div>
	</div>
</div>
</body>
</html>