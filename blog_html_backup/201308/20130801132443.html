<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 patch : DISCARD SEQUENCES</h2>
	<h5 id="">2013-08-01 13:24:43&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020137111254816/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><span style="line-height: 22px;"   >PostgreSQL当前版本(9.3以及9.3以下版本)DISCARD没有discard sequence的功能. 即使DISCARD ALL也不会.&nbsp;</span></div><div>9.4会不会加入这个补丁, 现在还不确定, 要看committer是否能同意将之提交.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create sequence seq_test;</font></div><div><font size="2"   >CREATE SEQUENCE</font></div><div><font size="2"   >digoal=# select currval('seq_test');</font></div><div><font size="2"   >ERROR: &nbsp;currval of sequence "seq_test" is not yet defined in this session</font></div><div><font size="2"   >digoal=# select nextval('seq_test');</font></div><div><font size="2"   >&nbsp;nextval&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select currval('seq_test');</font></div><div><font size="2"   >&nbsp;currval&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# discard all;</font></div><div><font size="2"   >DISCARD ALL</font></div><div><font size="2"   >-- discard all后, sequence cache还在, 没有被释放掉.</font></div><div><font size="2"   >digoal=# select currval('seq_test');</font></div><div><font size="2"   >&nbsp;currval&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >在某些情况下你可能会遇到麻烦. 例如在使用连接池时, 是否一个连接给其他客户端使用前, 首先要将这个连接回到初始状态. 那么可以通过执行DISCARD ALL;来实现.</span></div><div><span style="line-height: 22px;"   >例如pgbouncer的</span>server_reset_query配置选项.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >==== server_reset_query ====</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Query sent to server on connection release, before making it</font></div><div><font size="2"   >available to other clients. &nbsp;At that moment no transaction is in</font></div><div><font size="2"   >progress so it should not include `ABORT` or `ROLLBACK`.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >A good choice for Postgres 8.2 and below is:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; server_reset_query = RESET ALL; SET SESSION AUTHORIZATION DEFAULT;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >for 8.3 and above its enough to do:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; server_reset_query = DISCARD ALL;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >When transaction pooling is used, the `server_reset_query` should be empty,</font></div><div><font size="2"   >as clients should not use any session features.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Default: DISCARD ALL</font></div><p></p></pre></div><div>当我们在使用这个连接池时, 如果用到了序列, 那么这个连接在释放后, 其他会话如果连上来使用到了刚才释放的连接, 那么这个新的会话将可以直接获取已经使用过的序列值. 测试如下 :&nbsp;</div><div><div>postgres@db-172-16-3-39-&gt; cat config1999.ini&nbsp;</div><div>使用事务模式, 每次server connection在被释放前都执行DISCARD ALL;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[databases]</font></div><div><font size="2"   >digoal = host=172.16.3.33 dbname=digoal port=1919 pool_size=8</font></div><div><font size="2"   >[pgbouncer]</font></div><div><font size="2"   >pool_mode = transaction</font></div><div><font size="2"   >listen_port = 1999</font></div><div><font size="2"   >unix_socket_dir = /opt/pgbouncer/etc</font></div><div><font size="2"   >listen_addr = *</font></div><div><font size="2"   >auth_type = md5</font></div><div><font size="2"   >auth_file = /opt/pgbouncer/etc/users1999.txt</font></div><div><font size="2"   >logfile = /dev/null</font></div><div><font size="2"   >pidfile = /opt/pgbouncer/etc/pgbouncer1999.pid</font></div><div><font size="2"   >max_client_conn = 10000</font></div><div><font size="2"   >reserve_pool_timeout = 0</font></div><div><font size="2"   >server_reset_query = DISCARD ALL;</font></div><div><font size="2"   >admin_users = pgbouncer_admin</font></div><div><font size="2"   >stats_users = pgbouncer_guest</font></div><div><font size="2"   >ignore_startup_parameters = extra_float_digits</font></div><p></p></pre></div><div>postgres@db-172-16-3-39-&gt; cat users1999.txt&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >"digoal" "md5462f71c79368ccf422f8a773ef40074d"</font></div><div><font size="2"   >"pgbouncer_admin" "pgbouncer_admin3321"</font></div><div><font size="2"   >"postgres" "postgres"</font></div><p></p></pre></div></div><div>启动pgbouncer</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/opt/pgbouncer/bin/pgbouncer -d /opt/pgbouncer/etc/config1999.ini</font></div><div></div><p></p></pre></div><div>SESSION A :&nbsp;</div><div>postgres@db-172-16-3-39-&gt; psql -h 127.0.0.1 -p 1999 -U postgres -d digoal</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# prepare a(int) as select $1;</font></div><div><font size="2"   >PREPARE</font></div><div><font size="2"   >digoal=# execute a(1);</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# end;</font></div><div><font size="2"   >COMMIT</font></div><p></p></pre></div><div>-- 因为事务模式, 连接会被回收, 执行了DISCARD ALL; 所以接下来a(int)不可用.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# execute a(1);</font></div><div><font size="2"   >ERROR: &nbsp;prepared statement "a" does not exist</font></div><p></p></pre></div></div><div>同时我们也看到sequence cache未释放.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create sequence seq_test;</font></div><div><font size="2"   >CREATE SEQUENCE</font></div><div><font size="2"   >digoal=# select currval('seq_test');</font></div><div><font size="2"   >ERROR: &nbsp;currval of sequence "seq_test" is not yet defined in this session</font></div><div><font size="2"   >digoal=# select nextval('seq_test');</font></div><div><font size="2"   >&nbsp;nextval&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select currval('seq_test');</font></div><div><font size="2"   >&nbsp;currval&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select pg_backend_pid();</font></div><div><font size="2"   >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1633</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>SESSION B :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-39-&gt; psql -h 127.0.0.1 -p 1999 -U postgres -d digoal</font></div><div><font size="2"   >Password for user postgres:&nbsp;</font></div><div><font size="2"   >psql (9.1.3, server 9.2.4)</font></div><div><font size="2"   >WARNING: psql version 9.1, server version 9.2.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Some psql features might not work.</font></div><div><font size="2"   >Type "help" for help.</font></div><p></p></pre></div><div>-- 会话B在连接池中拿到了同一个server connection.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select pg_backend_pid();</font></div><div><font size="2"   >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1633</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>-- 所以会话B能看到这个sequence cache.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select currval('seq_test');</font></div><div><font size="2"   >&nbsp;currval&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div><br></div><div><span style="line-height: 22px;"   >打补丁</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-33 postgresql-9.2.4]# wget http://www.postgresql.org/message-id/attachment/28820/discard_sequences.patch</font></span></div><div><div><font size="2"   >--2013-08-01 13:13:26-- &nbsp;http://www.postgresql.org/message-id/attachment/28820/discard_sequences.patch</font></div><div><font size="2"   >Resolving www.postgresql.org... 217.196.149.50, 87.238.57.232, 98.129.198.126, ...</font></div><div><font size="2"   >Connecting to www.postgresql.org|217.196.149.50|:80... connected.</font></div><div><font size="2"   >HTTP request sent, awaiting response... 200 OK</font></div><div><font size="2"   >Length: 4117 (4.0K) [application/octet-stream]</font></div><div><font size="2"   >Saving to: `discard_sequences.patch'</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >100%[==========================================================================================&gt;] 4,117 &nbsp; &nbsp; &nbsp; --.-K/s &nbsp; in 0s &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >2013-08-01 13:13:27 (46.2 MB/s) - `discard_sequences.patch' saved [4117/4117]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-33 postgresql-9.2.4]# patch -p1 &lt; ./discard_sequences.patch&nbsp;</font></div><div><font size="2"   >patching file doc/src/sgml/ref/discard.sgml</font></div><div><font size="2"   >patching file src/backend/commands/discard.c</font></div><div><font size="2"   >patching file src/backend/commands/sequence.c</font></div><div><font size="2"   >Hunk #1 succeeded at 1612 with fuzz 2 (offset 11 lines).</font></div><div><font size="2"   >patching file src/backend/parser/gram.y</font></div><div><font size="2"   >Hunk #1 succeeded at 1592 (offset -80 lines).</font></div><div><font size="2"   >patching file src/bin/psql/tab-complete.c</font></div><div><font size="2"   >Hunk #1 succeeded at 2106 (offset -268 lines).</font></div><div><font size="2"   >patching file src/include/commands/sequence.h</font></div><div><font size="2"   >patching file src/include/nodes/parsenodes.h</font></div><div><font size="2"   >Hunk #1 succeeded at 2438 (offset -56 lines).</font></div></div><p></p></pre></div><div>重新编译</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >gmake</font></div><div><font size="2"   >gmake install</font></div><p></p></pre></div><div>重启数据库</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-33 postgresql-9.2.4]# su - pg92</font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >pg92@db-172-16-3-33-&gt; pg_ctl restart -m fast</font></div><div style="line-height: 22px;"   ><font size="2"   >waiting for server to shut down.... done</font></div><div style="line-height: 22px;"   ><font size="2"   >server stopped</font></div><div style="line-height: 22px;"   ><font size="2"   >server starting</font></div></div><p></p></pre></div></div><div>我们看到discard的语法变化, 新增了SEQUENCES.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.2.4)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# \h discard</font></div><div><font size="2"   >Command: &nbsp; &nbsp; DISCARD</font></div><div><font size="2"   >Description: discard session state</font></div><div><font size="2"   >Syntax:</font></div><div><font size="2"   >DISCARD { ALL | PLANS | SEQUENCES | TEMPORARY | TEMP }</font></div><p></p></pre></div><div>再次测试时, 序列cache也可以被释放了.</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >postgres@db-172-16-3-39-&gt; psql -h 127.0.0.1 -p 1999 -U postgres -d digoal</font></span></div><div><div><font size="2"   >Password for user postgres:&nbsp;</font></div><div><font size="2"   >psql (9.1.3, server 9.2.4)</font></div><div><font size="2"   >WARNING: psql version 9.1, server version 9.2.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Some psql features might not work.</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select pg_backend_pid();</font></div><div><font size="2"   >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3639</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select currval('seq_test');</font></div><div><font size="2"   >ERROR: &nbsp;currval of sequence "seq_test" is not yet defined in this session</font></div><div><font size="2"   >digoal=# select nextval('seq_test');</font></div><div><font size="2"   >&nbsp;nextval&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select currval('seq_test');</font></div><div><font size="2"   >ERROR: &nbsp;currval of sequence "seq_test" is not yet defined in this session</font></div></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/message-id/flat/CAFcNs+pEOb4oteyVX_mxxtcQfKOPnK2swaOGT=Lo-4yY3kCEog@mail.gmail.com#CAFcNs+pEOb4oteyVX_mxxtcQfKOPnK2swaOGT=Lo-4yY3kCEog@mail.gmail.com"   >http://www.postgresql.org/message-id/flat/CAFcNs+pEOb4oteyVX_mxxtcQfKOPnK2swaOGT=Lo-4yY3kCEog@mail.gmail.com#CAFcNs+pEOb4oteyVX_mxxtcQfKOPnK2swaOGT=Lo-4yY3kCEog@mail.gmail.com</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-discard.html"   >http://www.postgresql.org/docs/devel/static/sql-discard.html</a></div><div>3. 新增释放sequence cache的代码</div><div>src/backend/commands/sequence.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >+void</font></div><div><font size="2"   >+ReleaseSequenceCaches()</font></div><div><font size="2"   >+{</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; SeqTableData *ptr = seqtab;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; SeqTableData *tmp = NULL;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; while (ptr != NULL)</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmp = ptr;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ptr = ptr-&gt;next;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; free(tmp);</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; seqtab = NULL;</font></div><div><font size="2"   >+}</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >src/backend/commands/discard.c</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >+#include "commands/sequence.h"</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case DISCARD_SEQUENCES:</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ReleaseSequenceCaches();</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >+</font></div></div><div><font size="2"   ><span style="line-height: 19px;"   >// 同时在DISCARD_ALL末尾添加了</span></font></div><div><font size="2"   >+       ReleaseSequenceCaches();</font></div><p></p></pre></div><div>4. 原始<span style="line-height: 22px;"   >DISCARD的代码 :&nbsp;</span></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >/*-------------------------------------------------------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;*</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;* discard.c</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;The implementation of the DISCARD command</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;*</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;* Copyright (c) 1996-2013, PostgreSQL Global Development Group</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;*</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;*</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;* IDENTIFICATION</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;src/backend/commands/discard.c</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;*</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;*-------------------------------------------------------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;*/</font></div><div style="line-height: 22px;"   ><font size="2"   >#include "postgres.h"</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >#include "access/xact.h"</font></div><div style="line-height: 22px;"   ><font size="2"   >#include "catalog/namespace.h"</font></div><div style="line-height: 22px;"   ><font size="2"   >#include "commands/async.h"</font></div><div style="line-height: 22px;"   ><font size="2"   >#include "commands/discard.h"</font></div><div style="line-height: 22px;"   ><font size="2"   >#include "commands/prepare.h"</font></div><div style="line-height: 22px;"   ><font size="2"   >#include "utils/guc.h"</font></div><div style="line-height: 22px;"   ><font size="2"   >#include "utils/portal.h"</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >static void DiscardAll(bool isTopLevel);</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >/*</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;* DISCARD { ALL | TEMP | PLANS }</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;*/</font></div><div style="line-height: 22px;"   ><font size="2"   >void</font></div><div style="line-height: 22px;"   ><font size="2"   >DiscardCommand(DiscardStmt *stmt, bool isTopLevel)</font></div><div style="line-height: 22px;"   ><font size="2"   >{</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; switch (stmt-&gt;target)</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case DISCARD_ALL:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DiscardAll(isTopLevel);</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case DISCARD_PLANS:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ResetPlanCache();</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case DISCARD_TEMP:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ResetTempTableNamespace();</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, "unrecognized DISCARD target: %d", stmt-&gt;target);</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div style="line-height: 22px;"   ><font size="2"   >}</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >static void</font></div><div style="line-height: 22px;"   ><font size="2"   >DiscardAll(bool isTopLevel)</font></div><div style="line-height: 22px;"   ><font size="2"   >{</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Disallow DISCARD ALL in a transaction block. This is arguably</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* inconsistent (we don't make a similar check in the command sequence</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* that DISCARD ALL is equivalent to), but the idea is to catch mistakes:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* DISCARD ALL inside a transaction block would leave the transaction</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* still uncommitted.</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PreventTransactionChain(isTopLevel, "DISCARD ALL");</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Closing portals might run user-defined code, so do that first. */</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PortalHashTableDeleteAll();</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SetPGVariable("session_authorization", NIL, false);</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ResetAllOptions();</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; DropAllPreparedStatements();</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Async_UnlistenAll();</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LockReleaseAll(USER_LOCKMETHOD, true);</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ResetPlanCache();</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ResetTempTableNamespace();</font></div><div style="line-height: 22px;"   ><font size="2"   >}</font></div></div><p></p></pre></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><br></div></div></div>
	</div>
</div>
</body>
</html>