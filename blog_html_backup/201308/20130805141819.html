<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL primary-standby failback tools : pg_rewind(have bug)</h2>
	<h5 id="">2013-08-05 14:18:19&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013758511857/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>将要加入PostgreSQL 9.5了</div><div><a target="_blank" rel="nofollow" href="http://hlinnaka.iki.fi/2015/03/23/pg_rewind-in-postgresql-9-5/"   >http://hlinnaka.iki.fi/2015/03/23/pg_rewind-in-postgresql-9-5/</a></div><div><a target="_blank" rel="nofollow" href="https://github.com/vmware/pg_rewind"   >https://github.com/vmware/pg_rewind</a></div><div><br></div><div>在数据库变得比较大时, 例如上TB, 如果部署了PostgreSQL primary-standby 流复制或者log shipping HA.</div><div>当发生了failover, old primary节点可能因为某些原因需要重新同步数据.&nbsp;</div><div>在广域网上, 由于网络异常也可能造成standby节点落后主节点, 导致需要重新同步数据.</div><div>小数据库重新同步数据很方便, 全量或者使用rsync增量同步都可以.&nbsp;</div><div>但是数据库很大的情况下, rsync也会变得非常慢, 而且大量消耗主机IO资源.&nbsp;</div><div>PostgreSQL 社区有提议在核心中加入通过wal文件解析, 达到增量同步到目的. 目前还在开发阶段.</div><div><a rel="nofollow" href="http://www.postgresql.org/message-id/flat/CAF8Q-Gy7xa60HwXc0MKajjkWFEbFDWTG=gGyu1KmT+s2xcQ-bw@mail.gmail.com#CAF8Q-Gy7xa60HwXc0MKajjkWFEbFDWTG=gGyu1KmT+s2xcQ-bw@mail.gmail.com"   >http://www.postgresql.org/message-id/flat/CAF8Q-Gy7xa60HwXc0MKajjkWFEbFDWTG=gGyu1KmT+s2xcQ-bw@mail.gmail.com#CAF8Q-Gy7xa60HwXc0MKajjkWFEbFDWTG=gGyu1KmT+s2xcQ-bw@mail.gmail.com</a></div><div><a rel="nofollow" href="http://www.postgresql.org/message-id/flat/CAF8Q-Gxg3PQTf71NVECe-6OzRaew5pWhk7yQtbJgWrFu513s+Q@mail.gmail.com#CAF8Q-Gxg3PQTf71NVECe-6OzRaew5pWhk7yQtbJgWrFu513s+Q@mail.gmail.com"   >http://www.postgresql.org/message-id/flat/CAF8Q-Gxg3PQTf71NVECe-6OzRaew5pWhk7yQtbJgWrFu513s+Q@mail.gmail.com#CAF8Q-Gxg3PQTf71NVECe-6OzRaew5pWhk7yQtbJgWrFu513s+Q@mail.gmail.com</a></div><div>目前已经有一个工具名为pg_rewind, 也是一个增量同步工具, 具体的做法是通过解析wal, 同步变更过的数据块. 仅仅支持9.3及以上版本. 因为需要data page checksum的支持.</div><div>原理如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Theory of operation</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The basic idea is to copy everything from the new cluster to old, except&nbsp;</font></div><div><font size="2"   >for the blocks that we know to be the same.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >1. Scan the WAL log of the old cluster, starting from the point where</font></div><div><font size="2"   >the new cluster's timeline history forked off from the old cluster. For&nbsp;</font></div><div><font size="2"   >each WAL record, make a note of the data blocks that are touched. This&nbsp;</font></div><div><font size="2"   >yields a list of all the data blocks that were changed in the old&nbsp;</font></div><div><font size="2"   >cluster, after the new cluster forked off.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >2. Copy all those changed blocks from the new master to the old master.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >3. Copy all other files like clog, conf files etc. from the new cluster</font></div><div><font size="2"   >to old. Everything except the relation files.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >4. Apply the WAL from the new master, starting from the checkpoint</font></div><div><font size="2"   >created at failover. (pg_rewind doesn't actually apply the WAL, it just&nbsp;</font></div><div><font size="2"   >creates a backup label file indicating that when PostgreSQL is started,&nbsp;</font></div><div><font size="2"   >it will start replay from that checkpoint and apply all the required WAL)</font></div><p></p></pre></div><div>详细介绍参考此文 :&nbsp;</div><div><a rel="nofollow" href="http://www.postgresql.org/message-id/flat/519DF910.4020609@vmware.com#519DF910.4020609@vmware.com"   >http://www.postgresql.org/message-id/flat/519DF910.4020609@vmware.com#519DF910.4020609@vmware.com</a></div><div><a rel="nofollow" href="https://github.com/vmware/pg_rewind"   >https://github.com/vmware/pg_rewind</a></div><div><br></div><div>下面测试一下pg_rewind的强大功能. 测试中包含了standby节点promote后, 主节点和备节点都发生了变更的情况, 当然发生变更产生的wal必须存在. 如果<span style="line-height: 22px;"   >old primary发生的变更</span><span style="line-height: 22px;"   >已经在归档目录, 需要先手工将这些变更拷贝到pg_xlog目录. 备节点发生的变更无所谓, 因为可以通过recovery.conf来解决.</span></div><div><br></div><div>下载postgresql 9.3 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><a rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=shortlog;h=refs/heads/REL9_3_STABLE"   ><font size="2"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=shortlog;h=refs/heads/REL9_3_STABLE</font></a></div><div><font size="2"   >wget&nbsp;http://git.postgresql.org/gitweb/?p=postgresql.git;a=snapshot;h=b5a20ab3e0310103ff11337faeed3c521f5eb917;sf=tgz</font></div><p></p></pre></div><div><br></div><div>安装PostgreSQL 9.3</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >tar -zxvf postgresql-b5a20ab.tar.gz</font></div><div><font size="2"   >cd postgresql-b5a20ab</font></div><div><div><font size="2"   >./configure --prefix=/opt/pgsql9.3beta2 --with-pgport=1999 --with-perl --with-tcl --with-python --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=16 &amp;&amp; gmake &amp;&amp; gmake install</font></div><div><font size="2"   >cd contrib/</font></div><div><font size="2"   >gmake &amp;&amp; gmake install</font></div></div><p></p></pre></div><div><br></div><div><div style="line-height: 22px;"   >下载pg_rewind :&nbsp;</div><div style="line-height: 22px;"   ><a style="line-height: 22px;" target="_blank" rel="nofollow" href="https://github.com/vmware/pg_rewind/archive/master.zip"   >https://github.com/vmware/pg_rewind/archive/master.zip</a></div></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >安装pg_rewind</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >unzip&nbsp;pg_rewind-master.zip</font></div><div style="line-height: 22px;"   ><font size="2"   >mv pg_rewind-master&nbsp;<span style="line-height: 22px;"   >postgresql-b5a20ab/contrib/</span></font></div><div style="line-height: 22px;"   ><font size="2"   >cd&nbsp;<span style="line-height: 22px;"   >postgresql-b5a20ab/contrib/</span><span style="line-height: 22px;"   >pg_rewind-master</span></font></div><div><div><font size="2"   >[root@db-172-16-3-33 pg_rewind-master]# export PATH=/opt/pgsql9.3beta2/bin:$PATH</font></div><div><font size="2"   >[root@db-172-16-3-33 pg_rewind-master]# which pg_config</font></div><div><font size="2"   >/opt/pgsql9.3beta2/bin/pg_config</font></div></div><div><font size="2"   >[root@db-172-16-3-33 pg_rewind-master]# gmake clean</font></div><div><font size="2"   >[root@db-172-16-3-33 pg_rewind-master]# gmake</font></div><div><font size="2"   >[root@db-172-16-3-33 pg_rewind-master]# gmake install</font></div><div><div><font size="2"   >[root@db-172-16-3-33 pg_rewind-master]# which pg_rewind</font></div><div><font size="2"   >/opt/pgsql9.3beta2/bin/pg_rewind</font></div></div><div><div><font size="2"   >[root@db-172-16-3-33 pg_rewind-master]# pg_rewind --help</font></div><div><font size="2"   >pg_rewind resynchronizes a cluster with another copy of the cluster.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Usage:</font></div><div><font size="2"   >&nbsp; pg_rewind [OPTION]...</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Options:</font></div><div><font size="2"   >&nbsp; -D, --target-pgdata=DIRECTORY</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;existing data directory to modify</font></div><div><font size="2"   >&nbsp; --source-pgdata=DIRECTORY</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;source data directory to sync with</font></div><div><font size="2"   >&nbsp; --source-server=CONNSTR</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;source server to sync with</font></div><div><font size="2"   >&nbsp; -v &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; write a lot of progress messages</font></div><div><font size="2"   >&nbsp; -n, --dry-run &nbsp;stop before modifying anything</font></div><div><font size="2"   >&nbsp; -V, --version &nbsp;output version information, then exit</font></div><div><font size="2"   >&nbsp; -?, --help &nbsp; &nbsp; show this help, then exit</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Report bugs to &lt;xxx&gt;.</font></div></div><p></p></pre></div><div><br></div><div>初始化数据库, 使用data page checksums</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; initdb -D $PGDATA -E UTF8 --locale=C -W -U postgres -k</font></div><div></div><p></p></pre></div><div>配置主节点</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi pg_hba.conf</font></div><div><div><font size="2"   >host replication postgres 172.16.3.0/24 md5</font></div><div><font size="2"   >host all all 0.0.0.0/0 md5</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >vi postgresql.conf</font></div><div><div><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"   >port = 1999 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >max_connections = 100 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >superuser_reserved_connections = 3 &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >unix_socket_directories = '.' &nbsp; # comma-separated list of directories</font></div><div><font size="2"   >unix_socket_permissions = 0700 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# begin with 0 to use octal notation</font></div><div><font size="2"   >shared_buffers = 1024MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div><font size="2"   >shared_preload_libraries = 'pg_stat_statements' &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >vacuum_cost_delay = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 0-100 milliseconds</font></div><div><font size="2"   >vacuum_cost_limit = 10000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 credits</font></div><div><font size="2"   >bgwriter_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 10-10000ms between rounds</font></div><div><font size="2"   >wal_level = hot_standby &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, or hot_standby</font></div><div><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level;</font></div><div><font size="2"   >wal_sync_method = fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # the default is the first option</font></div><div><font size="2"   >wal_buffers = 16384kB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 32kB, -1 sets based on shared_buffers</font></div><div><font size="2"   >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"   >checkpoint_segments = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# in logfile segments, min 1, 16MB each</font></div><div><font size="2"   >archive_mode = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # allows archiving to be done</font></div><div><font size="2"   >archive_command = 'test ! -f /pgdata/digoal/1921/data03/pg93/pg_arch/%f &amp;&amp; cp %p /pgdata/digoal/1921/data03/pg93/pg_arch/%f'# command to use to archive a logfile segment</font></div><div><font size="2"   >max_wal_senders = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of walsender processes</font></div><div><font size="2"   >wal_keep_segments = 128 &nbsp; &nbsp; &nbsp; &nbsp; # in logfile segments, 16MB each; 0 disables</font></div><div><font size="2"   >hot_standby = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# "on" allows queries during recovery</font></div><div><font size="2"   >max_standby_archive_delay = 300s &nbsp; &nbsp; &nbsp; &nbsp;# max delay before canceling queries</font></div><div><font size="2"   >max_standby_streaming_delay = 300s &nbsp; &nbsp; &nbsp;# max delay before canceling queries</font></div><div><font size="2"   >wal_receiver_status_interval = 1s &nbsp; &nbsp; &nbsp; # send replies at least this often</font></div><div><font size="2"   >hot_standby_feedback = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # send info from standby to prevent</font></div><div><font size="2"   >random_page_cost = 1.5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# same scale as above</font></div><div><font size="2"   >effective_cache_size = 128000MB</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_directory = 'pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,</font></div><div><font size="2"   >log_file_mode = 0600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# creation mode for log files,</font></div><div><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div><font size="2"   >log_rotation_age = 1d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Automatic rotation of logfiles will</font></div><div><font size="2"   >log_rotation_size = 10MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Automatic rotation of logfiles will</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_disconnections = on</font></div><div><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div><font size="2"   >log_lock_waits = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # log lock waits &gt;= deadlock_timeout</font></div><div><font size="2"   >log_statement = 'ddl' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # none, ddl, mod, all</font></div><div><font size="2"   >log_timezone = 'PRC'</font></div><div><font size="2"   >autovacuum = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Enable autovacuum subprocess? &nbsp;'on'</font></div><div><font size="2"   >log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >timezone = 'PRC'</font></div><div><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><div><font size="2"   >pg_stat_statements.max = 1000</font></div><div><font size="2"   >pg_stat_statements.track = all</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cp $PGHOME/share/recovery.conf.sample $PGDATA/</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; mv $PGDATA/recovery.conf.sample $PGDATA/recovery.done</font></div><div><font size="2"   >vi recovery.done</font></div><div><div><font size="2"   >recovery_target_timeline = 'latest'</font></div><div><font size="2"   >standby_mode = on</font></div><div><font size="2"   >primary_conninfo = 'host=172.16.3.39 port=1999 user=postgres keepalives_idle=60'</font></div></div><p></p></pre></div><div><br></div><div>启动主节点数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_ctl start</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; LOG: &nbsp;00000: loaded library "pg_stat_statements"</font></div><div><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1296</font></div><p></p></pre></div><div><br></div><div>创建standby(172.16.3.39)</div><div>安装postgresql</div><div>略, 同主节点</div><div><span style="line-height: 22px;"   >安装pg_rewind</span></div><div><span style="line-height: 22px;"   >略, 同主节点</span></div><div>创建$PGDATA目录</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >mkdir -p $PGDATA</font></div><div><font size="2"   >chown pg93<span style="line-height: 22px;"   >:pg93 $PGDATA</span></font></div><div><span style="line-height: 22px;"   ><font size="2"   >chmod 700 $PGDATA</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >su - pg93</font></span></div><p></p></pre></div><div><span style="line-height: 22px;"   >复制主节点数据库</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >root@db-172-16-3-39-&gt; su - pg93</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; vi ~/.pgpass</font></div><div><font size="2"   >172.16.3.33:1999:*:postgres:postgres</font></div></div><div><div><font size="2"   >pg93@db-172-16-3-39-&gt; chmod 400 ~/.pgpass&nbsp;</font></div></div><div><div><font size="2"   >pg93@db-172-16-3-39-&gt; pg_basebackup -D $PGDATA -F p -x -P -v -h 172.16.3.33 -p 1999 -U postgres</font></div><div><font size="2"   >WARNING: &nbsp;skipping special file "./.s.PGSQL.1999"</font></div><div><font size="2"   >transaction log start point: 0/2000028 on timeline 1</font></div><div><font size="2"   >WARNING: &nbsp;skipping special file "./.s.PGSQL.1999"g_root/pg_subtrans/0000)</font></div><div><font size="2"   >36575/36575 kB (100%), 1/1 tablespace &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >transaction log end point: 0/20000F0</font></div><div><font size="2"   >pg_basebackup: base backup completed</font></div></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; cd $PGDATA</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; mv recovery.done recovery.conf</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; vi recovery.conf</font></div><div><div><font size="2"   >recovery_target_timeline = 'latest'</font></div><div><font size="2"   >standby_mode = on</font></div><div><font size="2"   >primary_conninfo = 'host=172.16.3.33 port=1999 user=postgres keepalives_idle=60' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# e.g. 'host=localhost port=5432'</font></div></div><p></p></pre></div><div>启动standby数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-39-&gt; pg_ctl start</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; LOG: &nbsp;00000: loaded library "pg_stat_statements"</font></div><div><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1296</font></div><p></p></pre></div><div><br></div><div>主节点控制文件信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_controldata&nbsp;</font></div><div><font size="2"   >pg_control version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;937</font></div><div><font size="2"   >Catalog version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 201306121</font></div><div><font size="2"   >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5908450106616519131</font></div><div><font size="2"   >Database cluster state: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in production</font></div><div><font size="2"   >pg_control last modified: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mon 05 Aug 2013 10:31:56 AM CST</font></div><div><font size="2"   >Latest checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0/30007E8</font></div><div><font size="2"   >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/3000710</font></div><div><font size="2"   >Latest checkpoint's REDO location: &nbsp; &nbsp;0/30007A8</font></div><div><font size="2"   >Latest checkpoint's REDO WAL file: &nbsp; &nbsp;000000010000000000000003</font></div><div><font size="2"   >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >Latest checkpoint's PrevTimeLineID: &nbsp; 1</font></div><div><font size="2"   >Latest checkpoint's full_page_writes: on</font></div><div><font size="2"   >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/1685</font></div><div><font size="2"   >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;24576</font></div><div><font size="2"   >Latest checkpoint's NextMultiXactId: &nbsp;1</font></div><div><font size="2"   >Latest checkpoint's NextMultiOffset: &nbsp;0</font></div><div><font size="2"   >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;1674</font></div><div><font size="2"   >Latest checkpoint's oldestXID's DB: &nbsp; 1</font></div><div><font size="2"   >Latest checkpoint's oldestActiveXID: &nbsp;1684</font></div><div><font size="2"   >Latest checkpoint's oldestMultiXid: &nbsp; 1</font></div><div><font size="2"   >Latest checkpoint's oldestMulti's DB: 1</font></div><div><font size="2"   >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Mon 05 Aug 2013 10:31:56 AM CST</font></div><div><font size="2"   >Fake LSN counter for unlogged rels: &nbsp; 0/1</font></div><div><font size="2"   >Minimum recovery ending location: &nbsp; &nbsp; 0/0</font></div><div><font size="2"   >Min recovery ending loc's timeline: &nbsp; 0</font></div><div><font size="2"   >Backup start location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"   >Backup end location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"   >End-of-backup record required: &nbsp; &nbsp; &nbsp; &nbsp;no</font></div><div><font size="2"   >Current wal_level setting: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hot_standby</font></div><div><font size="2"   >Current max_connections setting: &nbsp; &nbsp; &nbsp;100</font></div><div><font size="2"   >Current max_prepared_xacts setting: &nbsp; 0</font></div><div><font size="2"   >Current max_locks_per_xact setting: &nbsp; 64</font></div><div><font size="2"   >Maximum data alignment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8</font></div><div><font size="2"   >Database block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8192</font></div><div><font size="2"   >Blocks per segment of large relation: 131072</font></div><div><font size="2"   >WAL block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 16384</font></div><div><font size="2"   >Bytes per WAL segment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16777216</font></div><div><font size="2"   >Maximum length of identifiers: &nbsp; &nbsp; &nbsp; &nbsp;64</font></div><div><font size="2"   >Maximum columns in an index: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;32</font></div><div><font size="2"   >Maximum size of a TOAST chunk: &nbsp; &nbsp; &nbsp; &nbsp;1996</font></div><div><font size="2"   >Date/time type storage: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64-bit integers</font></div><div><font size="2"   >Float4 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><div><font size="2"   >Float8 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><div><font size="2"   >Data page checksum version: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><p></p></pre></div><div><br></div><div>备节点控制文件信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-39-&gt; pg_controldata&nbsp;</font></div><div><font size="2"   >pg_control version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;937</font></div><div><font size="2"   >Catalog version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 201306121</font></div><div><font size="2"   >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5908450106616519131</font></div><div><font size="2"   >Database cluster state: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in archive recovery</font></div><div><font size="2"   >pg_control last modified: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mon 05 Aug 2013 10:31:39 AM CST</font></div><div><font size="2"   >Latest checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0/2000060</font></div><div><font size="2"   >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/2000060</font></div><div><font size="2"   >Latest checkpoint's REDO location: &nbsp; &nbsp;0/2000028</font></div><div><font size="2"   >Latest checkpoint's REDO WAL file: &nbsp; &nbsp;000000010000000000000002</font></div><div><font size="2"   >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >Latest checkpoint's PrevTimeLineID: &nbsp; 1</font></div><div><font size="2"   >Latest checkpoint's full_page_writes: on</font></div><div><font size="2"   >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/1684</font></div><div><font size="2"   >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;12815</font></div><div><font size="2"   >Latest checkpoint's NextMultiXactId: &nbsp;1</font></div><div><font size="2"   >Latest checkpoint's NextMultiOffset: &nbsp;0</font></div><div><font size="2"   >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;1674</font></div><div><font size="2"   >Latest checkpoint's oldestXID's DB: &nbsp; 1</font></div><div><font size="2"   >Latest checkpoint's oldestActiveXID: &nbsp;1684</font></div><div><font size="2"   >Latest checkpoint's oldestMultiXid: &nbsp; 1</font></div><div><font size="2"   >Latest checkpoint's oldestMulti's DB: 1</font></div><div><font size="2"   >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Mon 05 Aug 2013 10:28:59 AM CST</font></div><div><font size="2"   >Fake LSN counter for unlogged rels: &nbsp; 0/1</font></div><div><font size="2"   >Minimum recovery ending location: &nbsp; &nbsp; 0/20000F0</font></div><div><font size="2"   >Min recovery ending loc's timeline: &nbsp; 1</font></div><div><font size="2"   >Backup start location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"   >Backup end location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"   >End-of-backup record required: &nbsp; &nbsp; &nbsp; &nbsp;no</font></div><div><font size="2"   >Current wal_level setting: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hot_standby</font></div><div><font size="2"   >Current max_connections setting: &nbsp; &nbsp; &nbsp;100</font></div><div><font size="2"   >Current max_prepared_xacts setting: &nbsp; 0</font></div><div><font size="2"   >Current max_locks_per_xact setting: &nbsp; 64</font></div><div><font size="2"   >Maximum data alignment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8</font></div><div><font size="2"   >Database block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8192</font></div><div><font size="2"   >Blocks per segment of large relation: 131072</font></div><div><font size="2"   >WAL block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 16384</font></div><div><font size="2"   >Bytes per WAL segment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16777216</font></div><div><font size="2"   >Maximum length of identifiers: &nbsp; &nbsp; &nbsp; &nbsp;64</font></div><div><font size="2"   >Maximum columns in an index: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;32</font></div><div><font size="2"   >Maximum size of a TOAST chunk: &nbsp; &nbsp; &nbsp; &nbsp;1996</font></div><div><font size="2"   >Date/time type storage: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64-bit integers</font></div><div><font size="2"   >Float4 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><div><font size="2"   >Float8 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><div><font size="2"   >Data page checksum version: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><p></p></pre></div><div><br></div><div>测试 :&nbsp;</div><div>1. 主节点</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3beta2)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# create table test (id int primary key, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# create or replace function func() returns void as $$</font></div><div><font size="2"   >digoal$# declare&nbsp;</font></div><div><font size="2"   >digoal$# &nbsp; v_id int;</font></div><div><font size="2"   >digoal$# begin</font></div><div><font size="2"   >digoal$# &nbsp; v_id := round(5000000*random());</font></div><div><font size="2"   >digoal$# &nbsp; update test set info=md5(random()::text),crt_time=clock_timestamp() where id=v_id;</font></div><div><font size="2"   >digoal$# &nbsp; if found then</font></div><div><font size="2"   >digoal$# &nbsp; &nbsp; return;</font></div><div><font size="2"   >digoal$# &nbsp; else</font></div><div><font size="2"   >digoal$# &nbsp; &nbsp; insert into test values (v_id,md5(random()::text),clock_timestamp());</font></div><div><font size="2"   >digoal$# &nbsp; end if;</font></div><div><font size="2"   >digoal$# &nbsp; return;</font></div><div><font size="2"   >digoal$# end;</font></div><div><font size="2"   >digoal$# $$ language plpgsql strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >digoal=# select func();</font></div><div><font size="2"   >&nbsp;func&nbsp;</font></div><div><font size="2"   >------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from test ;</font></div><div><font size="2"   >&nbsp; &nbsp;id &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------+----------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp;3554644 | c5aabfa68774a7bd9a623819537475c6 | 2013-08-05 10:39:49.304063</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select func();</font></div><div><font size="2"   >&nbsp;func&nbsp;</font></div><div><font size="2"   >------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from test ;</font></div><div><font size="2"   >&nbsp; &nbsp;id &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------+----------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp;3554644 | c5aabfa68774a7bd9a623819537475c6 | 2013-08-05 10:39:49.304063</font></div><div><font size="2"   >&nbsp;2856072 | ec17bc98163a1ac0cbcdeadd0b151607 | 2013-08-05 10:39:54.324455</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div><br></div><div>数据变更测试&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi test.sql</font></div><div><font size="2"   >select func();</font></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -f ./test.sql -r -n -h $PGDATA -p 1999 -U postgres -c 16 -j 4 -T 10 digoal</font></div><div><font size="2"   >Client 13 aborted in state 0: ERROR: &nbsp;duplicate key value violates unique constraint "test_pkey"</font></div><div><font size="2"   >DETAIL: &nbsp;Key (id)=(3717357) already exists.</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "insert into test values (v_id,md5(random()::text),clock_timestamp())"</font></div><div><font size="2"   >PL/pgSQL function func() line 10 at SQL statement</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 419517</font></div><div><font size="2"   >tps = 41926.489602 (including connections establishing)</font></div><div><font size="2"   >tps = 42031.118850 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.376348 &nbsp; &nbsp; &nbsp; &nbsp;select func();</font></div></div><p></p></pre></div><div><br></div><div>数据一致性验证</div><div>主节点</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3beta2)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select sum(hashtext(test.*::text)) from test;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; sum &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp;-215513112678</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select count(*) from test ;</font></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;402434</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>备节点</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-39-&gt; psql</font></div><div><font size="2"   >psql (9.3beta2)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select sum(hashtext(test.*::text)) from test;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; sum &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp;-215513112678</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select count(*) from test ;</font></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;402434</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>2. 备节点</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >promote</font></div><div><div><font size="2"   >pg93@db-172-16-3-39-&gt; pg_ctl promote</font></div><div><font size="2"   >server promoting</font></div></div><p></p></pre></div><div>数据变更测试</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 22px;"   ><font size="2"   >vi test.sql</font></div><div style="line-height: 22px;"   ><font size="2"   >select func();</font></div></div><div><div><font size="2"   >pg93@db-172-16-3-39-&gt; pgbench -M prepared -f ./test.sql -r -n -h $PGDATA -p 1999 -U postgres -c 16 -j 4 -T 10 digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 378395</font></div><div><font size="2"   >tps = 37814.175846 (including connections establishing)</font></div><div><font size="2"   >tps = 37866.507340 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.419977 &nbsp; &nbsp; &nbsp; &nbsp;select func();</font></div></div><p></p></pre></div></div><div><br></div><div>备节点数据 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-39-&gt; psql</font></div><div><font size="2"   >psql (9.3beta2)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select sum(hashtext(test.*::text)) from test;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;sum &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp;380706298298</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select count(*) from test ;</font></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;737925</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>3. 主节点</div><div>主节点继续变更数据</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -f ./test.sql -r -n -h $PGDATA -p 1999 -U postgres -c 16 -j 4 -T 10 digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 399093</font></div><div><font size="2"   >tps = 39862.553184 (including connections establishing)</font></div><div><font size="2"   >tps = 39960.089273 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.398488 &nbsp; &nbsp; &nbsp; &nbsp;select func();</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >主节点数据 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3beta2)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select sum(hashtext(test.*::text)) from test;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;sum &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp;127807805610</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select count(*) from test ;</font></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;755238</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>4. 主节点变更为备节点, 一般可以通过rsync从新的主节点(172.16.3.39)来同步$PGDATA, 或者全新的pg_basebackup一次.</div><div>本文使用pg_rewind来实现.</div><div>停原主库(172.16.3.33)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_ctl stop -m fast</font></div><div><font size="2"   >waiting for server to shut down..... done</font></div><div><font size="2"   >server stopped</font></div><p></p></pre></div><div>配置.pgpass</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - pg93</font></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; vi .pgpass</font></div><div><font size="2"   >172.16.3.39:1999:*:postgres:postgres</font></div></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; chmod 400 .pgpass</font></div><p></p></pre></div><div>重新同步</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >pg93@db-172-16-3-33-&gt; pg_rewind -D $PGDATA --source-server='host=172.16.3.39 port=1999 dbname=digoal' -v</font></span></div><div><div><font size="2"   >connected to remote server</font></div><div><font size="2"   >unexpected control file size 0, expected 8192</font></div></div><p></p></pre></div><div>多次切换时间线后, 出现如下错误</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_rewind -D $PGDATA --source-server='host=172.16.3.39 port=1999 dbname=digoal' -v</font></div><div><font size="2"   >connected to remote server</font></div><div><font size="2"   >fetched file "global/pg_control", length 8192</font></div><div><font size="2"   >fetched file "pg_xlog/00000006.history", length 213</font></div><div><font size="2"   >could not find common ancestor of the source and target cluster's timelines</font></div><p></p></pre></div><div>在pg_rewind.c中加了一个打印tli信息的代码</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Trace the history backwards, until we hit the target timeline.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* TODO: This assumes that there are no timeline switches on the target</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* cluster after the fork.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; for (i = nentries - 1; i &gt;= 0; i--)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TimeLineHistoryEntry *entry = &amp;sourceHistory[i];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stdout, "nen:%d,srctli:%d,targettli:%d\n", i, entry-&gt;tli, targettli);</font></div><p></p></pre></div><div>重新编译pg_rewind,&nbsp;<span style="line-height: 22px;"   >timeline.c代码有问题, 历史文件解析不正确. 如下 :&nbsp;</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >pg93@db-172-16-3-39-&gt; pg_rewind -D $PGDATA --source-server='host=172.16.3.33 port=1999 dbname=digoal' -v</font></div><div style="line-height: 22px;"   ><font size="2"   >connected to remote server</font></div><div style="line-height: 22px;"   ><font size="2"   >fetched file "global/pg_control", length 8192</font></div><div style="line-height: 22px;"   ><font size="2"   >fetched file "pg_xlog/0000000B.history", length 419</font></div><div style="line-height: 22px;"   ><font size="2"   >nen:1,srctli:11,targettli:10</font></div><div style="line-height: 22px;"   ><font size="2"   >nen:0,srctli:1,targettli:10</font></div><div style="line-height: 22px;"   ><font size="2"   >could not find common ancestor of the source and target cluster's timelines</font></div><p></p></pre></div></div><div style="line-height: 22px;"   >使用如下方法修复以上问题.</div><div>修改新的主库history文件, 把最后一行放上来即可. 但是紧接着又是前面的错误.<span style="line-height: 22px;"   >unexpected control file size 0, expected 8192, 如下</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA/pg_xlog</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; vi 0000000B.history</font></div><div><div><font size="2"   >10 &nbsp; &nbsp; &nbsp;1/6000000 &nbsp; &nbsp; &nbsp; no recovery target specified</font></div><div><font size="2"   >1 &nbsp; &nbsp; &nbsp; 0/92DCDD8 &nbsp; &nbsp; &nbsp; no recovery target specified</font></div><div><font size="2"   >2 &nbsp; &nbsp; &nbsp; 0/1CB86338 &nbsp; &nbsp; &nbsp;no recovery target specified</font></div><div><font size="2"   >3 &nbsp; &nbsp; &nbsp; 0/36E68A20 &nbsp; &nbsp; &nbsp;no recovery target specified</font></div><div><font size="2"   >4 &nbsp; &nbsp; &nbsp; 0/569ADB88 &nbsp; &nbsp; &nbsp;no recovery target specified</font></div><div><font size="2"   >5 &nbsp; &nbsp; &nbsp; 0/762CF5D8 &nbsp; &nbsp; &nbsp;no recovery target specified</font></div><div><font size="2"   >6 &nbsp; &nbsp; &nbsp; 0/9F67C920 &nbsp; &nbsp; &nbsp;no recovery target specified</font></div><div><font size="2"   >7 &nbsp; &nbsp; &nbsp; 0/A0000090 &nbsp; &nbsp; &nbsp;no recovery target specified</font></div><div><font size="2"   >8 &nbsp; &nbsp; &nbsp; 1/3F535A0 &nbsp; &nbsp; &nbsp; no recovery target specified</font></div><div><font size="2"   >9 &nbsp; &nbsp; &nbsp; 1/4000090 &nbsp; &nbsp; &nbsp; no recovery target specified</font></div></div><p></p></pre></div><div>重新执行pg_rewind</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-39-&gt; pg_rewind -D $PGDATA --source-server='host=172.16.3.33 port=1999 dbname=digoal' -v</font></div><div><font size="2"   >connected to remote server</font></div><div><font size="2"   >fetched file "global/pg_control", length 8192</font></div><div><font size="2"   >fetched file "pg_xlog/0000000B.history", length 419</font></div><div><font size="2"   >nen:1,srctli:11,targettli:10</font></div><div><font size="2"   >nen:0,srctli:10,targettli:10</font></div><div><font size="2"   >Last common WAL position: 1/6000000 on timeline 10</font></div><div><font size="2"   >Last common checkpoint at 1/6000000 on timeline 10</font></div><div><font size="2"   >error reading xlog record: record with zero length at 1/6000090</font></div><div><font size="2"   >.s.PGSQL.1999 (COPY)</font></div><div><font size="2"   >backup_label.old (COPY)</font></div><div><font size="2"   >recovery.done (COPY)</font></div><div><font size="2"   >pg_ident.conf (COPY)</font></div><div><font size="2"   >postmaster.opts (COPY)</font></div><div><font size="2"   >postgresql.conf (COPY)</font></div><div><font size="2"   >pg_hba.conf (COPY)</font></div><div><font size="2"   >.s.PGSQL.1999.lock (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_112157.csv (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_123414.csv (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_101818.log (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_134452.log (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_112001.csv (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_134452.csv (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_111642.csv (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_110518.csv (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_134655.csv (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_131517.csv (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_103139.csv (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_110518.log (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_112902.csv (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_112001.log (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_134523.csv (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_134523.log (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_104358.csv (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_112902.log (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_131517.log (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_130021.csv (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_104358.log (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_103139.log (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_101818.csv (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_113036.csv (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_123414.log (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_123855.csv (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_112157.log (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_134655.log (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_130021.log (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_113036.log (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_131316.csv (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_111642.log (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_131316.log (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_123855.log (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_134444.csv (COPY)</font></div><div><font size="2"   >pg_log/postgresql-2013-08-05_134444.log (COPY)</font></div><div><font size="2"   >pg_subtrans/0047 (COPY)</font></div><div><font size="2"   >pg_notify/0000 (COPY)</font></div><div><font size="2"   >global/12696_vm (COPY)</font></div><div><font size="2"   >global/12700_vm (COPY)</font></div><div><font size="2"   >global/12707_fsm (COPY)</font></div><div><font size="2"   >global/12557_fsm (COPY)</font></div><div><font size="2"   >global/pg_internal.init (COPY)</font></div><div><font size="2"   >global/12700_fsm (COPY)</font></div><div><font size="2"   >global/pg_control (COPY)</font></div><div><font size="2"   >global/12711_fsm (COPY)</font></div><div><font size="2"   >global/12696_fsm (COPY)</font></div><div><font size="2"   >global/12557_vm (COPY)</font></div><div><font size="2"   >global/pg_filenode.map (COPY)</font></div><div><font size="2"   >global/12707_vm (COPY)</font></div><div><font size="2"   >global/12711_vm (COPY)</font></div><div><font size="2"   >pg_xlog/00000008.history (COPY)</font></div><div><font size="2"   >pg_xlog/0000000B0000000100000006 (COPY)</font></div><div><font size="2"   >pg_xlog/00000009.history (COPY)</font></div><div><font size="2"   >pg_xlog/0000000A.history (COPY)</font></div><div><font size="2"   >pg_xlog/0000000B0000000100000005 (COPY)</font></div><div><font size="2"   >pg_xlog/0000000A0000000100000005 (COPY)</font></div><div><font size="2"   >pg_xlog/0000000B.history (COPY)</font></div><div><font size="2"   >pg_clog/0001 (COPY)</font></div><div><font size="2"   >pg_clog/0000 (COPY)</font></div><div><font size="2"   >pg_clog/0002 (COPY)</font></div><div><font size="2"   >pg_clog/0003 (COPY)</font></div><div><font size="2"   >pg_clog/0004 (COPY)</font></div><div><font size="2"   >pg_stat_tmp/db_16384.stat (COPY)</font></div><div><font size="2"   >pg_stat_tmp/global.stat (COPY)</font></div><div><font size="2"   >pg_stat_tmp/db_0.stat (COPY)</font></div><div><font size="2"   >pg_multixact/members/0000 (COPY)</font></div><div><font size="2"   >pg_multixact/offsets/0000 (COPY)</font></div><div><font size="2"   >base/12814/12641_vm (COPY)</font></div><div><font size="2"   >base/12814/12639_fsm (COPY)</font></div><div><font size="2"   >base/12814/12547_fsm (COPY)</font></div><div><font size="2"   >base/12814/12620_fsm (COPY)</font></div><div><font size="2"   >..........省略</font></div><div><font size="2"   >base/12809/12625_fsm (COPY)</font></div><div><font size="2"   >base/12809/12569_fsm (COPY)</font></div><div><font size="2"   >base/12809/12639_vm (COPY)</font></div><div><font size="2"   >base/12809/12779_vm (COPY)</font></div><div><font size="2"   >base/12809/12717_fsm (COPY)</font></div><div><font size="2"   >base/12809/12799_vm (COPY)</font></div><div><font size="2"   >base/12809/12600_vm (COPY)</font></div><div><font size="2"   >base/12809/12612_fsm (COPY)</font></div><div><font size="2"   >base/12809/12616_fsm (COPY)</font></div><div><font size="2"   >base/12809/12553_fsm (COPY)</font></div><div><font size="2"   >base/12809/12608_vm (COPY)</font></div><div><font size="2"   >base/12809/12784_fsm (COPY)</font></div><div><font size="2"   >base/12809/12784_vm (COPY)</font></div><div><font size="2"   >base/12809/12768_vm (COPY)</font></div><div><font size="2"   >base/12809/12549_vm (COPY)</font></div><div><font size="2"   >base/12809/12673_fsm (COPY)</font></div><div><font size="2"   >base/12809/12732_fsm (COPY)</font></div><div><font size="2"   >base/12809/12794_fsm (COPY)</font></div><div><font size="2"   >base/12809/12547_vm (COPY)</font></div><div><font size="2"   >base/12809/12682_vm (COPY)</font></div><div><font size="2"   >base/12809/12673_vm (COPY)</font></div><div><font size="2"   >base/12809/12774_vm (COPY)</font></div><div><font size="2"   >base/12809/12721_fsm (COPY)</font></div><div><font size="2"   >base/12809/12587_fsm (COPY)</font></div><div><font size="2"   >base/12809/12608_fsm (COPY)</font></div><div><font size="2"   >base/12809/12717_vm (COPY)</font></div><div><font size="2"   >base/12809/12636_fsm (COPY)</font></div><div><font size="2"   >base/12809/12553_vm (COPY)</font></div><div><font size="2"   >base/12809/12604_vm (COPY)</font></div><div><font size="2"   >base/12809/12728_vm (COPY)</font></div><div><font size="2"   >base/12809/12629_vm (COPY)</font></div><div><font size="2"   >base/12809/12587_vm (COPY)</font></div><div><font size="2"   >base/12809/12569_vm (COPY)</font></div><div><font size="2"   >base/12809/12724_fsm (COPY)</font></div><div><font size="2"   >base/12809/12768_fsm (COPY)</font></div><div><font size="2"   >base/12809/12612_vm (COPY)</font></div><div><font size="2"   >base/12809/12616_vm (COPY)</font></div><div><font size="2"   >base/12809/12799_fsm (COPY)</font></div><div><font size="2"   >base/12809/12629_fsm (COPY)</font></div><div><font size="2"   >base/12809/12732_vm (COPY)</font></div><div><font size="2"   >base/12809/12641_fsm (COPY)</font></div><div><font size="2"   >base/12809/12764_fsm (COPY)</font></div><div><font size="2"   >base/12809/12736_vm (COPY)</font></div><div><font size="2"   >base/12809/12664_fsm (COPY)</font></div><div><font size="2"   >base/12809/12658_fsm (COPY)</font></div><div><font size="2"   >base/12809/12625_vm (COPY)</font></div><div><font size="2"   >base/12809/12620_vm (COPY)</font></div><div><font size="2"   >base/12809/12794_vm (COPY)</font></div><div><font size="2"   >base/12809/pg_filenode.map (COPY)</font></div><div><font size="2"   >base/12809/12604_fsm (COPY)</font></div><div><font size="2"   >base/12809/12600_fsm (COPY)</font></div><div><font size="2"   >base/12809/12774_fsm (COPY)</font></div><div><font size="2"   >base/12809/12779_fsm (COPY)</font></div><div><font size="2"   >base/12809/12789_fsm (COPY)</font></div><div><font size="2"   >base/12809/12576_fsm (COPY)</font></div><div><font size="2"   >base/12809/12789_vm (COPY)</font></div><div><font size="2"   >base/12809/12736_fsm (COPY)</font></div><div><font size="2"   >base/12809/12664_vm (COPY)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000A0000000100000005.done (COPY)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000B.history.done (COPY)</font></div><div><font size="2"   >pg_stat/db_16384.stat (REMOVE)</font></div><div><font size="2"   >pg_stat/global.stat (REMOVE)</font></div><div><font size="2"   >pg_stat/db_0.stat (REMOVE)</font></div><div><font size="2"   >global/pg_stat_statements.stat (REMOVE)</font></div><div><font size="2"   >pg_xlog/0000000800000000000000F6 (REMOVE)</font></div><div><font size="2"   >pg_xlog/000000080000000100000003 (REMOVE)</font></div><div><font size="2"   >pg_xlog/0000000800000000000000F7 (REMOVE)</font></div><div><font size="2"   >pg_xlog/0000000800000000000000F8 (REMOVE)</font></div><div><font size="2"   >pg_xlog/0000000A0000000100000006 (REMOVE)</font></div><div><font size="2"   >pg_xlog/0000000800000000000000F4 (REMOVE)</font></div><div><font size="2"   >pg_xlog/0000000800000000000000FA (REMOVE)</font></div><div><font size="2"   >pg_xlog/0000000800000000000000F2 (REMOVE)</font></div><div><font size="2"   >pg_xlog/000000080000000100000002 (REMOVE)</font></div><div><font size="2"   >pg_xlog/000000090000000100000003 (REMOVE)</font></div><div><font size="2"   >pg_xlog/0000000800000000000000EF (REMOVE)</font></div><div><font size="2"   >pg_xlog/0000000A0000000100000005.00000028.backup (REMOVE)</font></div><div><font size="2"   >pg_xlog/0000000800000000000000F9 (REMOVE)</font></div><div><font size="2"   >pg_xlog/0000000800000000000000FD (REMOVE)</font></div><div><font size="2"   >pg_xlog/0000000A0000000100000004 (REMOVE)</font></div><div><font size="2"   >pg_xlog/0000000800000000000000FC (REMOVE)</font></div><div><font size="2"   >pg_xlog/0000000800000000000000EE (REMOVE)</font></div><div><font size="2"   >pg_xlog/000000080000000100000000 (REMOVE)</font></div><div><font size="2"   >pg_xlog/0000000800000000000000FB (REMOVE)</font></div><div><font size="2"   >pg_xlog/0000000800000000000000F0 (REMOVE)</font></div><div><font size="2"   >pg_xlog/000000090000000100000004 (REMOVE)</font></div><div><font size="2"   >pg_xlog/000000080000000100000001 (REMOVE)</font></div><div><font size="2"   >pg_xlog/0000000800000000000000F3 (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000800000000000000EE.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000800000000000000FF.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000800000000000000F4.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000800000000000000FA.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000800000000000000FD.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000800000000000000F1.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/00000009.history.ready (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/000000090000000100000004.ready (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000800000000000000F2.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000800000000000000EF.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000A0000000100000005.ready (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000A0000000100000004.ready (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000800000000000000FB.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000800000000000000F3.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000A.history.ready (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000800000000000000FE.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/000000080000000100000002.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/000000090000000100000003.ready (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000A0000000100000005.00000028.backup.ready (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000800000000000000F6.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000800000000000000F9.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000800000000000000F5.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/000000080000000100000000.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000800000000000000FC.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/000000080000000100000003.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000800000000000000F8.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000800000000000000F7.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/000000080000000100000001.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/archive_status/0000000800000000000000F0.done (REMOVE)</font></div><div><font size="2"   >pg_xlog/0000000800000000000000F1 (REMOVE)</font></div><div><font size="2"   >pg_xlog/0000000800000000000000FE (REMOVE)</font></div><div><font size="2"   >pg_xlog/0000000800000000000000FF (REMOVE)</font></div><div><font size="2"   >pg_xlog/0000000800000000000000F5 (REMOVE)</font></div><div><font size="2"   >getting chunks: -- fetch all the blocks listed in the temp table.</font></div><div><font size="2"   >select path, begin,&nbsp;</font></div><div><font size="2"   >&nbsp; pg_read_binary_file(path, begin, len) as chunk</font></div><div><font size="2"   >from fetchchunks</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >sent query</font></div><div><font size="2"   >received chunk for file "backup_label.old", off 0, len 206</font></div><div><font size="2"   >received chunk for file "recovery.done", off 0, len 4759</font></div><div><font size="2"   >received chunk for file "pg_ident.conf", off 0, len 1636</font></div><div><font size="2"   >received chunk for file "postmaster.opts", off 0, len 32</font></div><div><font size="2"   >received chunk for file "postgresql.conf", off 0, len 20431</font></div><div><font size="2"   >received chunk for file "pg_hba.conf", off 0, len 4547</font></div><div><font size="2"   >received chunk for file ".s.PGSQL.1999.lock", off 0, len 64</font></div><div><font size="2"   >received chunk for file "pg_log/postgresql-2013-08-05_112157.csv", off 0, len 48110</font></div><div><font size="2"   >received chunk for file "pg_log/postgresql-2013-08-05_123414.csv", off 0, len 10613</font></div><div><font size="2"   >received chunk for file "pg_log/postgresql-2013-08-05_112001.csv", off 0, len 8450</font></div><div><font size="2"   >received chunk for file "pg_log/postgresql-2013-08-05_134452.csv", off 0, len 968</font></div><div><font size="2"   >received chunk for file "pg_log/postgresql-2013-08-05_111642.csv", off 0, len 22888</font></div><div><font size="2"   >received chunk for file "pg_log/postgresql-2013-08-05_110518.csv", off 0, len 34844</font></div><div><font size="2"   >received chunk for file "pg_log/postgresql-2013-08-05_134655.csv", off 0, len 4932</font></div><div><font size="2"   >received chunk for file "pg_log/postgresql-2013-08-05_131517.csv", off 0, len 70200</font></div><div><font size="2"   >received chunk for file "pg_log/postgresql-2013-08-05_103139.csv", off 0, len 52611</font></div><div><font size="2"   >received chunk for file "pg_log/postgresql-2013-08-05_112902.csv", off 0, len 2009</font></div><div><font size="2"   >received chunk for file "pg_log/postgresql-2013-08-05_134523.csv", off 0, len 12060</font></div><div><font size="2"   >received chunk for file "pg_log/postgresql-2013-08-05_104358.csv", off 0, len 61220</font></div><div><font size="2"   >received chunk for file "pg_log/postgresql-2013-08-05_130021.csv", off 0, len 13541</font></div><div><font size="2"   >received chunk for file "pg_log/postgresql-2013-08-05_104358.log", off 0, len 7125</font></div><div><font size="2"   >received chunk for file "pg_log/postgresql-2013-08-05_101818.csv", off 0, len 2719</font></div><div><font size="2"   >received chunk for file "pg_log/postgresql-2013-08-05_113036.csv", off 0, len 15990</font></div><div><font size="2"   >received chunk for file "pg_log/postgresql-2013-08-05_123855.csv", off 0, len 36541</font></div><div><font size="2"   >received chunk for file "pg_log/postgresql-2013-08-05_131316.csv", off 0, len 3686</font></div><div><font size="2"   >received chunk for file "pg_log/postgresql-2013-08-05_134444.csv", off 0, len 968</font></div><div><font size="2"   >received chunk for file "pg_subtrans/0047", off 0, len 114688</font></div><div><font size="2"   >received chunk for file "pg_notify/0000", off 0, len 8192</font></div><div><font size="2"   >received chunk for file "global/12696_vm", off 0, len 8192</font></div><div><font size="2"   >received chunk for file "global/12700_vm", off 0, len 8192</font></div><div><font size="2"   >received chunk for file "global/12707_fsm", off 0, len 24576</font></div><div><font size="2"   >received chunk for file "global/12557_fsm", off 0, len 24576</font></div><div><font size="2"   >received chunk for file "global/pg_internal.init", off 0, len 12784</font></div><div><font size="2"   >received chunk for file "global/12700_fsm", off 0, len 24576</font></div><div><font size="2"   >received chunk for file "global/pg_control", off 0, len 8192</font></div><div><font size="2"   >received chunk for file "global/12711_fsm", off 0, len 24576</font></div><div><font size="2"   >received chunk for file "global/12696_fsm", off 0, len 24576</font></div><div><font size="2"   >received chunk for file "global/12557_vm", off 0, len 8192</font></div><div><font size="2"   >received chunk for file "global/pg_filenode.map", off 0, len 512</font></div><div><font size="2"   >received chunk for file "global/12707_vm", off 0, len 8192</font></div><div><font size="2"   >received chunk for file "global/12711_vm", off 0, len 8192</font></div><div><font size="2"   >received chunk for file "pg_xlog/00000008.history", off 0, len 299</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000006", off 0, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000006", off 1000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000006", off 2000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000006", off 3000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000006", off 4000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000006", off 5000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000006", off 6000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000006", off 7000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000006", off 8000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000006", off 9000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000006", off 10000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000006", off 11000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000006", off 12000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000006", off 13000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000006", off 14000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000006", off 15000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000006", off 16000000, len 777216</font></div><div><font size="2"   >received chunk for file "pg_xlog/00000009.history", off 0, len 334</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000A.history", off 0, len 376</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000005", off 0, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000005", off 1000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000005", off 2000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000005", off 3000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000005", off 4000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000005", off 5000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000005", off 6000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000005", off 7000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000005", off 8000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000005", off 9000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000005", off 10000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000005", off 11000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000005", off 12000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000005", off 13000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000005", off 14000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000005", off 15000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B0000000100000005", off 16000000, len 777216</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000A0000000100000005", off 0, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000A0000000100000005", off 1000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000A0000000100000005", off 2000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000A0000000100000005", off 3000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000A0000000100000005", off 4000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000A0000000100000005", off 5000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000A0000000100000005", off 6000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000A0000000100000005", off 7000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000A0000000100000005", off 8000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000A0000000100000005", off 9000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000A0000000100000005", off 10000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000A0000000100000005", off 11000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000A0000000100000005", off 12000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000A0000000100000005", off 13000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000A0000000100000005", off 14000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000A0000000100000005", off 15000000, len 1000000</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000A0000000100000005", off 16000000, len 777216</font></div><div><font size="2"   >received chunk for file "pg_xlog/0000000B.history", off 0, len 419</font></div><div><font size="2"   >received chunk for file "pg_clog/0001", off 0, len 262144</font></div><div><font size="2"   >received chunk for file "pg_clog/0000", off 0, len 262144</font></div><div><font size="2"   >received chunk for file "pg_clog/0002", off 0, len 262144</font></div><div><font size="2"   >received chunk for file "pg_clog/0003", off 0, len 262144</font></div><div><font size="2"   >received chunk for file "pg_clog/0004", off 0, len 122880</font></div><div><font size="2"   >received chunk for file "pg_stat_tmp/db_16384.stat", off 0, len 3216</font></div><div><font size="2"   >received chunk for file "pg_stat_tmp/global.stat", off 0, len 471</font></div><div><font size="2"   >received chunk for file "pg_stat_tmp/db_0.stat", off 0, len 1188</font></div><div><font size="2"   >received chunk for file "pg_multixact/members/0000", off 0, len 8192</font></div><div><font size="2"   >received chunk for file "pg_multixact/offsets/0000", off 0, len 8192</font></div><div><font size="2"   >received chunk for file "base/12814/12641_vm", off 0, len 8192</font></div><div><font size="2"   >received chunk for file "base/12814/12639_fsm", off 0, len 24576</font></div><div><font size="2"   >received chunk for file "base/12814/12547_fsm", off 0, len 24576</font></div><div><font size="2"   >received chunk for file "base/12814/12620_fsm", off 0, len 24576</font></div><div><font size="2"   >received chunk for file "base/12814/12549_fsm", off 0, len 24576</font></div><div><font size="2"   >................省略</font></div><div><font size="2"   >received chunk for file "base/12809/12576_fsm", off 0, len 24576</font></div><div><font size="2"   >received chunk for file "base/12809/12789_vm", off 0, len 8192</font></div><div><font size="2"   >received chunk for file "base/12809/12736_fsm", off 0, len 24576</font></div><div><font size="2"   >received chunk for file "base/12809/12664_vm", off 0, len 8192</font></div><div><font size="2"   >Done!</font></div><p></p></pre></div><div><br></div><div>启动数据库, 无法启动 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2013-08-05 13:52:04.424 CST,,,29312,,51ff3d84.7280,1,,2013-08-05 13:52:04 CST,,0,LOG,00000,"database system was interrupted; last known up at 2013-08-05 13:47:00 CST",,,,,,,,"StartupXLOG, xlog.c:4915",""</font></div><div><font size="2"   >2013-08-05 13:52:04.424 CST,,,29312,,51ff3d84.7280,2,,2013-08-05 13:52:04 CST,,0,LOG,00000,"entering standby mode",,,,,,,,"StartupXLOG, xlog.c:4968",""</font></div><div><font size="2"   >2013-08-05 13:52:04.424 CST,,,29312,,51ff3d84.7280,3,,2013-08-05 13:52:04 CST,,0,LOG,00000,"invalid checkpoint link in backup_label file",,,,,,,,"ReadCheckpointRecord, xlog.c:6364",""</font></div><div><font size="2"   >2013-08-05 13:52:04.424 CST,,,29312,,51ff3d84.7280,4,,2013-08-05 13:52:04 CST,,0,FATAL,XX000,"could not locate required checkpoint record",,"If you are not restoring from a backup, try removing the file ""/pgdata/digoal/1921/data03/pg93/pg_root/backup_label"".",,,,,,"StartupXLOG, xlog.c:5047",""</font></div><div><font size="2"   >2013-08-05 13:52:04.425 CST,,,29310,,51ff3d84.727e,1,,2013-08-05 13:52:04 CST,,0,LOG,00000,"startup process (PID 29312) exited with exit code 1",,,,,,,,"LogChildExit, postmaster.c:3211",""</font></div><div><font size="2"   >2013-08-05 13:52:04.425 CST,,,29310,,51ff3d84.727e,2,,2013-08-05 13:52:04 CST,,0,LOG,00000,"aborting startup due to startup process failure",,,,,,,,"reaper, postmaster.c:2536",""</font></div><p></p></pre></div><div>这个错误, 需要删除新的standby(老的primary)的backup_label文件.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >rm -f $PGDATA/backup_label*</font></div><div></div><p></p></pre></div><div>启动数据库, 无法启动 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >pg93@db-172-16-3-39-&gt; cat postgresql-2013-08-05_135236.csv</font></span></div><div><font size="2"   >2013-08-05 13:52:36.846 CST,,,29333,,51ff3da4.7295,1,,2013-08-05 13:52:36 CST,,0,LOG,00000,"database system was interrupted; last known up at 2013-08-05 13:47:00 CST",,,,,,,,"StartupXLOG, xlog.c:4915",""</font></div><div><font size="2"   >2013-08-05 13:52:36.846 CST,,,29333,,51ff3da4.7295,2,,2013-08-05 13:52:36 CST,,0,LOG,00000,"entering standby mode",,,,,,,,"StartupXLOG, xlog.c:4968",""</font></div><div><font size="2"   >2013-08-05 13:52:36.846 CST,,,29333,,51ff3da4.7295,3,,2013-08-05 13:52:36 CST,,0,FATAL,XX000,"invalid data in history file: 1 &nbsp; 0/92DCDD8 &nbsp; no recovery target specified</font></div><div><font size="2"   >",,"Timeline IDs must be in increasing sequence.",,,,,,"readTimeLineHistory, timeline.c:158",""</font></div><div><font size="2"   >2013-08-05 13:52:36.846 CST,,,29331,,51ff3da4.7293,1,,2013-08-05 13:52:36 CST,,0,LOG,00000,"startup process (PID 29333) exited with exit code 1",,,,,,,,"LogChildExit, postmaster.c:3211",""</font></div><div><font size="2"   >2013-08-05 13:52:36.846 CST,,,29331,,51ff3da4.7293,2,,2013-08-05 13:52:36 CST,,0,LOG,00000,"aborting startup due to startup process failure",,,,,,,,"reaper, postmaster.c:2536",""</font></div><p></p></pre></div></div><div>因为前面修改了history文件, 改回来即可. (两台主机都需要修改, 以免后面再出问题)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; vi 0000000B.history&nbsp;</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; vi 0000000B.history&nbsp;</font></div><div><div><font size="2"   >1 &nbsp; &nbsp; &nbsp; 0/92DCDD8 &nbsp; &nbsp; &nbsp; no recovery target specified</font></div><div><font size="2"   >2 &nbsp; &nbsp; &nbsp; 0/1CB86338 &nbsp; &nbsp; &nbsp;no recovery target specified</font></div><div><font size="2"   >3 &nbsp; &nbsp; &nbsp; 0/36E68A20 &nbsp; &nbsp; &nbsp;no recovery target specified</font></div><div><font size="2"   >4 &nbsp; &nbsp; &nbsp; 0/569ADB88 &nbsp; &nbsp; &nbsp;no recovery target specified</font></div><div><font size="2"   >5 &nbsp; &nbsp; &nbsp; 0/762CF5D8 &nbsp; &nbsp; &nbsp;no recovery target specified</font></div><div><font size="2"   >6 &nbsp; &nbsp; &nbsp; 0/9F67C920 &nbsp; &nbsp; &nbsp;no recovery target specified</font></div><div><font size="2"   >7 &nbsp; &nbsp; &nbsp; 0/A0000090 &nbsp; &nbsp; &nbsp;no recovery target specified</font></div><div><font size="2"   >8 &nbsp; &nbsp; &nbsp; 1/3F535A0 &nbsp; &nbsp; &nbsp; no recovery target specified</font></div><div><font size="2"   >9 &nbsp; &nbsp; &nbsp; 1/4000090 &nbsp; &nbsp; &nbsp; no recovery target specified</font></div><div><font size="2"   >10 &nbsp; &nbsp; &nbsp;1/6000000 &nbsp; &nbsp; &nbsp; no recovery target specified</font></div></div><p></p></pre></div><div>启动数据库, 复制正常.</div><div><br></div><div>[其他问题]</div><div>1. 还有可能遇到值溢出的问题.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg_xlog/0000000B000000010000001E (REMOVE)</font></div><div><font size="2"   >unexpected result while sending file list: ERROR: &nbsp;value "2148254528" is out of range for type integer</font></div><div><font size="2"   >CONTEXT: &nbsp;COPY fetchchunks, line 28557, column begin: "2148254528"</font></div><p></p></pre></div><div>来自以下函数 :&nbsp;</div><div>pg_rewind_master/libpq_fetch.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* Fetch all changed blocks from remote source data directory.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >void</font></div><div><font size="2"   >libpq_executeFileMap(filemap_t *map)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; file_entry_t *entry;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; const char *sql;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PGresult &nbsp; *res;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* First create a temporary table, and load it with the blocks that</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* we need to fetch.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sql = "create temporary table fetchchunks(path text, begin int4, len int4);";</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; res = PQexec(conn, sql);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (PQresultStatus(res) != PGRES_COMMAND_OK)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr, "error creating temporary table: %s\n",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PQresultErrorMessage(res));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exit(1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sql = "copy fetchchunks from stdin";</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; res = PQexec(conn, sql);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (PQresultStatus(res) != PGRES_COPY_IN)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr, "unexpected result while sending file list: %s\n",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PQresultErrorMessage(res));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exit(1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/message-id/flat/519DF910.4020609@vmware.com#519DF910.4020609@vmware.com"   >http://www.postgresql.org/message-id/flat/519DF910.4020609@vmware.com#519DF910.4020609@vmware.com</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="https://github.com/vmware/pg_rewind"   >https://github.com/vmware/pg_rewind</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL primary-standby failback tools : pg_rewind(have bug) - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">Guo_guo - 2014-03-12 10:13:53</h5>
				<div>牛啊，德哥</div>
			</div>
	</div>
</div>
</body>
</html>