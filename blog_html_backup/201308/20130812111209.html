<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 patch: Expose the estimation of number of changed tuples since last analyze</h2>
	<h5 id="">2013-08-12 11:12:09&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020137114270376/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>PostgreSQL 9.4新增的统计相关的patch, 用于记录最后一次analyze以来变更的tuples计数.&nbsp;</div><div>本文以9.4为例子测试一下这个补丁带来的变更.</div><div><br></div><div>如下为pg_stat_all_tables系统视图, 其中n_mod_since_analyze列为新增的统计计数.</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >pg94@db-172-16-3-39-&gt; psql</font></div><div style="line-height: 22px;"   ><font size="2"   >psql (9.4devel)</font></div><div style="line-height: 22px;"   ><font size="2"   >Type "help" for help.</font></div><div style="line-height: 22px;"   ><font size="2"   >digoal=# \d pg_stat_all_tables&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; View "pg_catalog.pg_stat_all_tables"</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Column &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Modifiers&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >---------------------+--------------------------+-----------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;relid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;schemaname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;seq_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;seq_tup_read &nbsp; &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;idx_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;idx_tup_fetch &nbsp; &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;n_tup_ins &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;n_tup_upd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;n_tup_del &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;n_tup_hot_upd &nbsp; &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;n_live_tup &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;n_dead_tup &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;n_mod_since_analyze | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | -- 新增的统计项</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;last_vacuum &nbsp; &nbsp; &nbsp; &nbsp; | timestamp with time zone |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;last_autovacuum &nbsp; &nbsp; | timestamp with time zone |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;last_analyze &nbsp; &nbsp; &nbsp; &nbsp;| timestamp with time zone |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;last_autoanalyze &nbsp; &nbsp;| timestamp with time zone |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;vacuum_count &nbsp; &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;autovacuum_count &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;analyze_count &nbsp; &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;autoanalyze_count &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >对应函数 :&nbsp;</div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >digoal=# \df pg_stat_get_mod_since_analyze</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of functions</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp;Schema &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Result data type | Argument data types | &nbsp;Type &nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >------------+-------------------------------+------------------+---------------------+--------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;pg_catalog | pg_stat_get_mod_since_analyze | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | normal</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div><p></p></pre></div></div></div><div><br></div><div>测试, 创建测试表 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table test(id int, info text, crt_time timestamp(0));</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div>分析这个表</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# analyze test ;</font></div><div><font size="2"   >ANALYZE</font></div><p></p></pre></div><div>分析后n_od_since_analyze归零.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select relname,n_mod_since_analyze,last_analyze,last_autoanalyze from pg_stat_all_tables where relname='test';</font></div><div><font size="2"   >-[ RECORD 1 ]-------+------------------------------</font></div><div><font size="2"   >relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | test</font></div><div><font size="2"   >n_mod_since_analyze | 0</font></div><div><font size="2"   >last_analyze &nbsp; &nbsp; &nbsp; &nbsp;| 2013-08-12 10:56:33.709702+08</font></div><div><font size="2"   >last_autoanalyze &nbsp; &nbsp;|&nbsp;</font></div><p></p></pre></div></div><div>插入1000条记录</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into test select generate_series(1,1000),md5(random()::text),now();</font></div><div><font size="2"   >INSERT 0 1000</font></div><p></p></pre></div></div><div>n_mod_since_analyze变更为1000.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select relname,n_mod_since_analyze,last_analyze,last_autoanalyze from pg_stat_all_tables where relname='test';</font></div><div><font size="2"   >-[ RECORD 1 ]-------+------------------------------</font></div><div><font size="2"   >relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | test</font></div><div><font size="2"   >n_mod_since_analyze | 1000</font></div><div><font size="2"   >last_analyze &nbsp; &nbsp; &nbsp; &nbsp;| 2013-08-12 10:56:33.709702+08</font></div><div><font size="2"   >last_autoanalyze &nbsp; &nbsp;|&nbsp;</font></div><p></p></pre></div><div>更新9条记录,</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# update test set id=id where id&lt;10;</font></div><div><font size="2"   >UPDATE 9</font></div><p></p></pre></div><div>期间没有触发auto analyze, 也没有手工执行analyze , 所以n_mod_since_analyze计数加9, 变为1009.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select relname,n_mod_since_analyze,last_analyze,last_autoanalyze from pg_stat_all_tables where relname='test';</font></div><div><font size="2"   >-[ RECORD 1 ]-------+------------------------------</font></div><div><font size="2"   >relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | test</font></div><div><font size="2"   >n_mod_since_analyze | 1009</font></div><div><font size="2"   >last_analyze &nbsp; &nbsp; &nbsp; &nbsp;| 2013-08-12 10:56:33.709702+08</font></div><div><font size="2"   >last_autoanalyze &nbsp; &nbsp;|&nbsp;</font></div><p></p></pre></div></div><div>更新99行,&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# update test set id=id where id&lt;100;</font></div><div><font size="2"   >UPDATE 99</font></div><p></p></pre></div><div>从以下结果99可以知道更新前, 已经触发了auto analyze. 所以计数先归0, 重新计数.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select relname,n_mod_since_analyze,last_analyze,last_autoanalyze from pg_stat_all_tables where relname='test';</font></div><div><font size="2"   >-[ RECORD 1 ]-------+------------------------------</font></div><div><font size="2"   >relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | test</font></div><div><font size="2"   >n_mod_since_analyze | 99</font></div><div><font size="2"   >last_analyze &nbsp; &nbsp; &nbsp; &nbsp;| 2013-08-12 10:56:33.709702+08</font></div><div><font size="2"   >last_autoanalyze &nbsp; &nbsp;| 2013-08-12 10:57:20.036548+08</font></div><p></p></pre></div></div><div>删除15条记录, 计数累加至114.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# delete from test where id&lt;16;</font></div><div><font size="2"   >DELETE 15</font></div><div><font size="2"   >digoal=# select relname,n_mod_since_analyze,last_analyze,last_autoanalyze from pg_stat_all_tables where relname='test';</font></div><div><font size="2"   >-[ RECORD 1 ]-------+------------------------------</font></div><div><font size="2"   >relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | test</font></div><div><font size="2"   >n_mod_since_analyze | 114</font></div><div><font size="2"   >last_analyze &nbsp; &nbsp; &nbsp; &nbsp;| 2013-08-12 10:56:33.709702+08</font></div><div><font size="2"   >last_autoanalyze &nbsp; &nbsp;| 2013-08-12 10:57:20.036548+08</font></div><p></p></pre></div><div>如果要在9.3以及以下版本中使用这个功能, 可以通过mods_since_analyze插件来实现.</div></div><div>下载 :&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://pgxn.org/dist/mods_since_analyze/1.0.0/"   >http://pgxn.org/dist/mods_since_analyze/1.0.0/</a></div><div>安装和使用方法如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 soft_bak]# cd postgresql-9.3beta2</font></div><div><font size="2"   >[root@db-172-16-3-39 postgresql-9.3beta2]# wget http://api.pgxn.org/dist/mods_since_analyze/1.0.0/mods_since_analyze-1.0.0.zip</font></div><div><font size="2"   >[root@db-172-16-3-39 postgresql-9.3beta2]# unzip mods_since_analyze-1.0.0.zip&nbsp;</font></div><div><font size="2"   >[root@db-172-16-3-39 postgresql-9.3beta2]# mv mods_since_analyze-1.0.0 contrib/</font></div><div><div><font size="2"   >[root@db-172-16-3-39 postgresql-9.3beta2]# cd contrib/mods_since_analyze-1.0.0/</font></div><div><font size="2"   >You have new mail in /var/spool/mail/root</font></div><div><font size="2"   >[root@db-172-16-3-39 mods_since_analyze-1.0.0]# export PATH=/opt/pgsql9.3beta2/bin:$PATH</font></div><div><font size="2"   >[root@db-172-16-3-39 mods_since_analyze-1.0.0]# which pg_config</font></div><div><font size="2"   >/opt/pgsql9.3beta2/bin/pg_config</font></div></div><div><font size="2"   >[root@db-172-16-3-39 mods_since_analyze-1.0.0]# gmake clean</font></div><div><font size="2"   >[root@db-172-16-3-39 mods_since_analyze-1.0.0]# gmake</font></div><div><font size="2"   >[root@db-172-16-3-39 mods_since_analyze-1.0.0]# gmake install</font></div><div><font size="2"   >[root@db-172-16-3-39 mods_since_analyze-1.0.0]# su - pg93</font></div><div><div><font size="2"   >pg93@db-172-16-3-39-&gt; psql</font></div><div><font size="2"   >psql (9.3beta2)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# create extension mods_since_analyze;</font></div><div><font size="2"   >CREATE EXTENSION</font></div></div><div><font size="2"   >-- 使用以下函数取计数</font></div><div><div><font size="2"   >digoal=# \df *.*since*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of functions</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Result data type | Argument data types | &nbsp;Type &nbsp;</font></div><div><font size="2"   >--------+-------------------------------+------------------+---------------------+--------</font></div><div><font size="2"   >&nbsp;public | pg_stat_get_mod_since_analyze | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | normal</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=# create table test(id int, info text, crt_time timestamp(0));</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into test select generate_series(1,100),'test',now();</font></div><div><font size="2"   >INSERT 0 100</font></div><div><font size="2"   >digoal=# select * from pg_stat_get_mod_since_analyze('test'::regclass);</font></div><div><font size="2"   >&nbsp;pg_stat_get_mod_since_analyze&nbsp;</font></div><div><font size="2"   >-------------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;100</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >-- 分析后归0</font></div><div><div><font size="2"   >digoal=# analyze test;</font></div><div><font size="2"   >ANALYZE</font></div><div><font size="2"   >digoal=# select * from pg_stat_get_mod_since_analyze('test'::regclass);</font></div><div><font size="2"   >&nbsp;pg_stat_get_mod_since_analyze&nbsp;</font></div><div><font size="2"   >-------------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://pgxn.org/dist/mods_since_analyze/1.0.0/"   >http://pgxn.org/dist/mods_since_analyze/1.0.0/</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=c87ff71f374652936a6089215a30998492b14d52"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=c87ff71f374652936a6089215a30998492b14d52</a></div><div>3. stat相关函数</div><div><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; background-color: rgb(224, 236, 239); border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"   ><colgroup><col><col><col><thead><tr><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Function</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Return Type</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Description</th></tr></thead><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   ><tt>pg_backend_pid()</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   ><tt>integer</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   >Process ID of the server process handling the current session</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><code style="font-size: 1em;"   >pg_stat_get_activity</code>(<tt style="font-size: 1em;"   >integer</tt>)</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>setof record</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Returns a record of information about the backend with the specified PID, or one record for each active backend in the system if&nbsp;<tt>NULL</tt>&nbsp;is specified. The fields returned are a subset of those in the&nbsp;<tt>pg_stat_activity</tt>&nbsp;view.</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>pg_stat_clear_snapshot()</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>void</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Discard the current statistics snapshot</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>pg_stat_reset()</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>void</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Reset all statistics counters for the current database to zero (requires superuser privileges)</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><code style="font-size: 1em;"   >pg_stat_reset_shared</code>(text)</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>void</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Reset some cluster-wide statistics counters to zero, depending on the argument (requires superuser privileges). Calling<tt>pg_stat_reset_shared('bgwriter')</tt>&nbsp;will zero all the counters shown in the&nbsp;<tt>pg_stat_bgwriter</tt>&nbsp;view.</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><code style="font-size: 1em;"   >pg_stat_reset_single_table_counters</code>(oid)</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>void</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Reset statistics for a single table or index in the current database to zero (requires superuser privileges)</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><code style="font-size: 1em;"   >pg_stat_reset_single_function_counters</code>(oid)</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>void</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Reset statistics for a single function in the current database to zero (requires superuser privileges)</td></tr></table></div><div>目前pg_stat_reset_shared只支持bgwriter的重置. 代码如下 :&nbsp;</div><div>src/backend/utils/adt/pgstatfuncs.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/* Reset some shared cluster-wide counters */</font></div><div><font size="2"   >Datum</font></div><div><font size="2"   >pg_stat_reset_shared(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *target = text_to_cstring(PG_GETARG_TEXT_PP(0));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; pgstat_reset_shared_counters(target);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_VOID();</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >src/backend/postmaster/pgstat.c</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/* ----------</font></div><div><font size="2"   >&nbsp;* pgstat_reset_shared_counters() -</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;Tell the statistics collector to reset cluster-wide shared counters.</font></div><div><font size="2"   >&nbsp;* ----------</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >void</font></div><div><font size="2"   >pgstat_reset_shared_counters(const char *target)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PgStat_MsgResetsharedcounter msg;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (pgStatSock == PGINVALID_SOCKET)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!superuser())</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_INSUFFICIENT_PRIVILEGE),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("must be superuser to reset statistics counters")));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (strcmp(target, "bgwriter") == 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; msg.m_resettarget = RESET_BGWRITER;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_INVALID_PARAMETER_VALUE),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("unrecognized reset target: \"%s\"", target),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errhint("Target must be \"bgwriter\".")));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; pgstat_setheader(&amp;msg.m_hdr, PGSTAT_MTYPE_RESETSHAREDCOUNTER);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; pgstat_send(&amp;msg, sizeof(msg));</font></div><div><font size="2"   >}</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>