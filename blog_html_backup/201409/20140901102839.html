<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">zabbix proxy configure (optional)</h2>
	<h5 id="">2014-09-01 10:28:39&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020148110173574/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>zabbix proxy的部署分3个部分.</div><div>1. 安装proxy</div><div>2. 配置proxy配置文件, 启动proxy</div><div>3. 在zabbix WEB接口中添加proxy.</div><wbr><div><br></div>1. zabbix的安装, web接口的配置以及zabbix server 的配置请参考 :&nbsp;<wbr><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014731111811804/"   >http://blog.163.com/digoal@126/blog/static/1638770402014731111811804/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014811040957/"   >http://blog.163.com/digoal@126/blog/static/1638770402014811040957/</a></div><div>在zabbix web配置好后, 我们配置并启动了server.</div><div>本文要讲一下proxy的配置, 如果你的环境比较大的话, 为了降低server的访问压力, 可以配置一些proxy.</div><div>或者被监控的agent无法直接和server建立连接, 我们可以在网络边界放一台proxy, 来实现分布式监控.</div><div><div><img title="zabbix proxy configure (optional) - 德哥@Digoal - PostgreSQL research"   alt="zabbix proxy configure (optional) - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/dbbUaxyGBCrGkzKCyrISLw==/6619209532793081385.png"   ></div></div><div><br></div><div>proxy 负责sender从agent receive的请求到server.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-rwxr-xr-x 1 root root 256830 Aug 31 12:10 zabbix_get</font></div><div><font size="2"   >-rwxr-xr-x 1 root root 314325 Aug 31 12:10 zabbix_sender</font></div><p></p></pre></div><div><br></div><div>2. proxy 的配置, 因为proxy需要database 壳, 还需要连接到server, 所以主要的配置如下 :&nbsp;</div><div>特别注意, zabbix proxy的数据库不要和zabbix server混用, 因为zabbix proxy的配置也要存储在数据库中, 混用的话会搞乱配置.</div><div><br></div><div>注意如果zabbix server和zabbix proxy在同一台主机允许, 需要使用不同的监听端口.</div><div><p></p><div><pre class="prettyprint"   ><p></p><div><div><div><span style="line-height: 28px;"   ><font size="2"   ># vi /opt/zabbix/etc/zabbix_proxy.conf</font></span></div></div></div><div><div><font size="2"   >ProxyMode=0</font></div><div><font size="2"   >Server=172.16.3.150</font></div><div><font size="2"   >ServerPort=10051</font></div><div><font size="2"   >Hostname=proxy150</font></div><div><font size="2"   >ListenPort=10052</font></div><div><font size="2"   >LogFile=/tmp/zabbix_proxy.log</font></div><div><font size="2"   >LogFileSize=10</font></div><div><font size="2"   >PidFile=/tmp/zabbix_proxy.pid</font></div><div><font size="2"   >DBHost=172.16.3.150</font></div><div><font size="2"   >DBName=zabbix_proxy</font></div><div><font size="2"   >DBUser=zabbix</font></div><div><font size="2"   >DBPassword=digoal</font></div><div><font size="2"   >DBPort=5432</font></div></div><p></p></pre></div></div><div>另外需要配置schema.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 etc]# su - postgres</font></div><div><font size="2"   >postgres@150-&gt; psql</font></div><div><font size="2"   >psql (9.3.5)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# create database zabbix_proxy with template template0 encoding 'UTF8';</font></div><div><font size="2"   >CREATE DATABASE</font></div><div><font size="2"   >postgres=# grant all on database zabbix_proxy to zabbix;</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >postgres=# \q</font></div><div><font size="2"   >postgres@150-&gt; psql zabbix_proxy zabbix -f /opt/soft_bak/zabbix-2.2.6/database/postgresql/schema.sql</font></div><p></p></pre></div><div><br></div><div>开启数据库访问权限</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi pg_hba.conf</font></div><div><font size="2"   >host all all 0.0.0.0/0 md5</font></div><div><font size="2"   >vi postgresql.conf</font></div><div><font size="2"   >listen_addresses = '0.0.0.0'</font></div><div><font size="2"   >port = 5432</font></div><div><font size="2"   >pg_ctl reload</font></div><p></p></pre></div><div><br></div><div>如果server和proxy在同一台主机运行, 建议使用zabbix以外的用户启动proxy, 同时注意监听端口要区分开.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 etc]# useradd zabbix_proxy</font></div><div><div><font size="2"   >[root@150 etc]# su - zabbix_proxy -c "zabbix_proxy -c /opt/zabbix/etc/zabbix_proxy.conf"</font></div><div><font size="2"   >[root@150 etc]# ps -ewf|grep zabbix_proxy</font></div><div><font size="2"   >503 &nbsp; &nbsp; &nbsp;19363 &nbsp; &nbsp; 1 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy -c /opt/zabbix/etc/zabbix_proxy.conf</font></div><div><font size="2"   >503 &nbsp; &nbsp; &nbsp;19366 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: configuration syncer [synced config 67 bytes in 0.011459 sec, idle 3600 sec]</font></div><div><font size="2"   >503 &nbsp; &nbsp; &nbsp;19367 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: heartbeat sender [sending heartbeat message failed in 0.004483 sec, idle 60 sec]</font></div><div><font size="2"   >503 &nbsp; &nbsp; &nbsp;19368 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: data sender [sent 0 values in 0.002888 sec, idle 1 sec]</font></div><div><font size="2"   >503 &nbsp; &nbsp; &nbsp;19369 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: poller #1 [got 0 values in 0.000037 sec, idle 5 sec]</font></div><div><span style="line-height: 28px;"   ><font size="2"   >503 &nbsp; &nbsp; &nbsp;19371 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: poller #2 [got 0 values in 0.000034 sec, idle 5 sec]</font></span></div><div><font size="2"   >503 &nbsp; &nbsp; &nbsp;19372 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: poller #3 [got 0 values in 0.000030 sec, idle 5 sec]</font></div><div><span style="line-height: 28px;"   ><font size="2"   >503 &nbsp; &nbsp; &nbsp;19374 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: poller #4 [got 0 values in 0.000021 sec, idle 5 sec]</font></span></div><div><font size="2"   >503 &nbsp; &nbsp; &nbsp;19375 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: poller #5 [got 0 values in 0.000031 sec, idle 5 sec]</font></div><div><font size="2"   >503 &nbsp; &nbsp; &nbsp;19376 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: unreachable poller #1 [got 0 values in 0.000028 sec, idle 5 sec]</font></div><div><font size="2"   >503 &nbsp; &nbsp; &nbsp;19377 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: trapper #1 [processed data in 0.000000 sec, waiting for connection]</font></div><div><font size="2"   >503 &nbsp; &nbsp; &nbsp;19378 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: trapper #2 [processed data in 0.000000 sec, waiting for connection]</font></div><div><font size="2"   >503 &nbsp; &nbsp; &nbsp;19379 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: trapper #3 [processed data in 0.000000 sec, waiting for connection]</font></div><div><font size="2"   >503 &nbsp; &nbsp; &nbsp;19380 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: trapper #4 [processed data in 0.000000 sec, waiting for connection]</font></div><div><font size="2"   >503 &nbsp; &nbsp; &nbsp;19381 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: trapper #5 [processed data in 0.000000 sec, waiting for connection]</font></div><div><font size="2"   >503 &nbsp; &nbsp; &nbsp;19382 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: icmp pinger #1 [got 0 values in 0.000031 sec, idle 5 sec]</font></div><div><font size="2"   >503 &nbsp; &nbsp; &nbsp;19383 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: housekeeper [deleted 0 records in 0.002591 sec, idle 3600 sec]</font></div><div><font size="2"   >503 &nbsp; &nbsp; &nbsp;19384 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: http poller #1 [got 0 values in 0.002798 sec, idle 5 sec]</font></div><div><font size="2"   >503 &nbsp; &nbsp; &nbsp;19385 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: discoverer #1 [processed 0 rules in 0.002625 sec, idle 60 sec]</font></div><div><font size="2"   >503 &nbsp; &nbsp; &nbsp;19386 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: history syncer #1 [synced 0 items in 0.000015 sec, idle 5 sec]</font></div><div><span style="line-height: 28px;"   ><font size="2"   >503 &nbsp; &nbsp; &nbsp;19388 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: history syncer #2 [synced 0 items in 0.000015 sec, idle 5 sec]</font></span></div><div><font size="2"   >503 &nbsp; &nbsp; &nbsp;19389 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: history syncer #3 [synced 0 items in 0.000016 sec, idle 5 sec]</font></div><div><font size="2"   >503 &nbsp; &nbsp; &nbsp;19390 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: history syncer #4 [synced 0 items in 0.000020 sec, idle 5 sec]</font></div><div><span style="line-height: 28px;"   ><font size="2"   >503 &nbsp; &nbsp; &nbsp;19392 19363 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 zabbix_proxy: self-monitoring [processed data in 0.000004 sec, idle 1 sec]</font></span></div></div><div><font size="2"   >监听</font></div><div><div><font size="2"   >[root@150 etc]# netstat -anp|grep 10052</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:10052 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;19363/zabbix_proxy &nbsp;</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 :::10052 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:::* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LISTEN &nbsp; &nbsp; &nbsp;19363/zabbix_proxy &nbsp;</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@150 etc]# netstat -anp|grep 10051<br>tcp        0      0 0.0.0.0:10051               0.0.0.0:*                   LISTEN      17605/zabbix_server </font></div><p></p></pre></div><div><br></div><div>3. 在zabbix WEB添加proxy</div><div><div><img title="zabbix proxy configure (optional) - 德哥@Digoal - PostgreSQL research"   alt="zabbix proxy configure (optional) - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/WMxe3ONTdWqSzorKVrlUiw==/6608215516028411048.png"   ></div>Porxy name 指为proxy取的名字, 必须和proxy配置文件的Hostname=proxy150 一致.</div><div>Proxy mode和配置文件ProxyMode=0表示的意思一致.</div><div><div># &nbsp; &nbsp; &nbsp; 0 - proxy in the active mode</div><div># &nbsp; &nbsp; &nbsp; 1 - proxy in the passive mode</div></div><div>Hosts 指被Proxy监控的主机列表. 如果zabbix中已经添加了主机的话, 这里都能看到.</div><div><br></div><div>[其他]</div><div>1. proxy在将监控数据发送给server之前, 是会先缓存在本地的, 所以proxy和server发生短暂的离线问题也不大.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >### Option: ProxyLocalBuffer</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; Proxy will keep data locally for N hours, even if the data have already been synced with the server.</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; This parameter may be used if local data will be used by third party applications.</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># Mandatory: no</font></div><div><font size="2"   ># Range: 0-720</font></div><div><font size="2"   ># Default:</font></div><div><font size="2"   ># ProxyLocalBuffer=0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >### Option: ProxyOfflineBuffer</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; Proxy will keep data for N hours in case if no connectivity with Zabbix Server.</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; Older data will be lost.</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># Mandatory: no</font></div><div><font size="2"   ># Range: 1-720</font></div><div><font size="2"   ># Default:</font></div><div><font size="2"   ># ProxyOfflineBuffer=1</font></div><p></p></pre></div><div><br></div><div>[参考]</div><div><div style="line-height: 28px;"   >1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014731111811804/"   >http://blog.163.com/digoal@126/blog/static/1638770402014731111811804/</a></div><div style="line-height: 28px;"   >2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014811040957/"   >http://blog.163.com/digoal@126/blog/static/1638770402014811040957/</a></div></div><div style="line-height: 28px;"   >3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://www.zabbix.com/documentation/2.2/manual/distributed_monitoring/proxies"   >https://www.zabbix.com/documentation/2.2/manual/distributed_monitoring/proxies</a></div><div style="line-height: 28px;"   >4.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://www.zabbix.com/documentation/2.2/manual/appendix/config/zabbix_proxy"   >https://www.zabbix.com/documentation/2.2/manual/appendix/config/zabbix_proxy</a></div><div style="line-height: 28px;"   ><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="zabbix proxy configure (optional) - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>