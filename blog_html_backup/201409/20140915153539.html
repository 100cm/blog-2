<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">ganglia gweb events or "user defined markers"</h2>
	<h5 id="">2014-09-15 15:35:39&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020148153121300/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在说gweb的event 前, 我先举个例子 :&nbsp;</div><div>在办公室有时会听到NOC的同事大喊, 流量飙升了, 怎么回事?</div><div>然后一般会有同事回应可能是在跨机房拷贝一些文件或者数据什么的, 又或者是在做跨机房的数据备份什么的.</div><div>如果在流量图上有标记的话, 那么NOC的同事对待这种流量突变的情况也不会一惊一乍.</div><div>gweb支持配置event, 这里指的event就是用户定义的时间段标签.</div><div><br></div><div>例如 :&nbsp;</div><div>配置文件目录和customize view的目录一样</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014815105622529/"   >http://blog.163.com/digoal@126/blog/static/1638770402014815105622529/</a></div><div>/data01/web/ganglia-web/conf/events.json</div><div>包含的内容举例 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[</font></div><div><font size="2"   >&nbsp; { "event_id":"1234",   # 事件 ID</font></div><div><font size="2"   >&nbsp; &nbsp; "start_time":1308496361,  # 开始时间</font></div><div><font size="2"   >&nbsp; &nbsp; "end_time":1308496961,　　# 结束时间</font></div><div><font size="2"   >&nbsp; &nbsp; "summary":"DB Backup",    # summary</font></div><div><font size="2"   >&nbsp; &nbsp; "description":"Prod daily db backup",  # 事件描述</font></div><div><font size="2"   >&nbsp; &nbsp; "grid":"*",</font></div><div><font size="2"   >&nbsp; &nbsp; "cluster":"*",</font></div><div><font size="2"   >&nbsp; &nbsp; "host_regex":"centos1"  # 主机名规则表达式</font></div><div><font size="2"   >&nbsp; },</font></div><div><font size="2"   >&nbsp; { "event_id":"2345",  # 第二个事件的内容</font></div><div><font size="2"   >&nbsp; &nbsp; "start_time":1308497211,</font></div><div><font size="2"   >&nbsp; &nbsp; "summary":"FS cleanup",</font></div><div><font size="2"   >&nbsp; &nbsp; "grid":"*",</font></div><div><font size="2"   >&nbsp; &nbsp; "cluster":"*",</font></div><div><font size="2"   >&nbsp; &nbsp; "host_regex":"centos1"</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >]</font></div><p></p></pre></div><div>当events很多时, 解析JSON可能会增加CPU负载, 可以考虑使用mdb2格式, 即将event存入MYSQL数据库. 需要修改conf.php</div><div>默认的conf.php中event相关的配置如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># What is the provider use to provide events.</font></div><div><font size="2"   ># Examples: "json", "mdb2"</font></div><div><font size="2"   >$conf['overlay_events_provider'] = "json";</font></div><div><font size="2"   ># Where is the Overlay events file stored</font></div><div><font size="2"   >$conf['overlay_events_file'] = $conf['conf_dir'] . "/events.json";</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># If using MDB2, connection string:</font></div><div><font size="2"   >$conf['overlay_events_dsn'] = "mysql://dbuser:dbpassword@localhost/ganglia";</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >$conf['overlay_events_color_map_file'] = $conf['conf_dir'] . "/event_color.json";</font></div><p></p></pre></div><wbr><div><br></div><div><div>例子, 使用events.json添加event.</div><div>获得一个时间, 用于start_time</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# SELECT EXTRACT(EPOCH FROM now()),now();</font></div><div><font size="2"   >&nbsp; &nbsp; date_part &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;now &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------+-------------------------------</font></div><div><font size="2"   >&nbsp;1410765863.10149 | 2014-09-15 15:24:23.101488+08</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div>编辑events.json</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 conf]# vi events.json</font></div><div><div><font size="2"   >[</font></div><div><font size="2"   >&nbsp; { "event_id":"digoal",</font></div><div><font size="2"   >&nbsp; &nbsp; "start_time":1410765863,</font></div><div><font size="2"   >&nbsp; &nbsp; "end_time":1410765999,</font></div><div><font size="2"   >&nbsp; &nbsp; "summary":"DB Backup",</font></div><div><font size="2"   >&nbsp; &nbsp; "description":"Prod daily db backup",</font></div><div><font size="2"   >&nbsp; &nbsp; "grid":"*",</font></div><div><font size="2"   >&nbsp; &nbsp; "cluster":"*",</font></div><div><font size="2"   >&nbsp; &nbsp; "host_regex":".*"</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >]</font></div></div><p></p></pre></div><div>现在在图中就可以看到这个事件了. summary会显示在图中 :&nbsp;</div><div><div><img title="ganglia gweb events or user defined markers - 德哥@Digoal - PostgreSQL research"   alt="ganglia gweb events or user defined markers - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/r3AvjTabWN21RYzgLhda9w==/6619521794095438583.png"   ></div><div>通过这个图我们就知道这个时候正在做数据库备份, 如果流量上升的话可以得到合理的解释.</div><div>(当然不排除恰巧同时也发生了其他事件到在图形的异常)</div><br></div><div>除了使用events.json来编辑创建event, 还可以使用web界面或者API来创建event.</div><div>使用WEB<span style="white-space:pre;"   >	</span>界面来创建event.</div><div><div><img title="ganglia gweb events or user defined markers - 德哥@Digoal - PostgreSQL research"   alt="ganglia gweb events or user defined markers - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/m5sU-VOkkPx4vNA6TDOK6g==/6619417340490798972.png"   ></div><div><br></div>也可以使用API来创建event :&nbsp;</div><div>通过HTTP GET或POST请求来创建event.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >An easy way to manipulate events is through the Ganglia Events API, which is available</font></div><div><font size="2"   >from your gweb interface at &nbsp;/ganglia/api/events.php. To use it, invoke the URL along</font></div><div><font size="2"   >with key/value pairs that define events. Key/value pairs can be supplied as either GET</font></div><div><font size="2"   >or POST arguments. The full list of key/value pairs is provided in :&nbsp;</font></div></div><div><font size="2"   ><br></font></div><div><div style="line-height: 28px;"   ><font size="2"   >Key: Value</font></div><div style="line-height: 28px;"   ><font size="2"   >action: addto add a new event, editto edit, removeor deleteto remove an event.</font></div><div style="line-height: 28px;"   ><font size="2"   >start_time: Start time of an event. Allowed options are now(uses current system time), UNIX&nbsp;<span style="line-height: 28px;"   >timestamp, or any other well formed date, as supported by PHP’s strtotime&nbsp;</span><span style="line-height: 28px;"   >function.</span></font></div><div style="line-height: 28px;"   ><font size="2"   >end_time: Optional. Same format as start_time.</font></div><div style="line-height: 28px;"   ><font size="2"   >summary: Summary of an event. It will be shown in the graph legend.</font></div><div style="line-height: 28px;"   ><font size="2"   >host_regex: Host regular expression, such as web-|app-.</font></div></div><p></p></pre></div><div style="line-height: 28px;"   >例子 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >curl "http://mygangliahost.com/ganglia/api/events.php?\</font></div><div><font size="2"   >action=add&amp;start_time=now&amp;\</font></div><div><font size="2"   >summary=Prod DB Backup&amp;host_regex=db02"</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >OR</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >curl -X POST --data " action=add&amp;start_time=now\</font></div><div><font size="2"   >&amp;summary=Prod DB Backup&amp;host_regex=db02" \</font></div><div><font size="2"   >http://mygangliahost.com/ganglia/api/events.php</font></div></div><p></p></pre></div><div><div>返回值 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >API will return a JSON-encoded status message with either status = ok or status =&nbsp;<span style="line-height: 28px;"   >error.</span></font></div><div><font size="2"   >If you are adding an event, you will also get the &nbsp;event_idof the event that was just</font></div><div><font size="2"   >added in case you want to edit it later, such as to add an end_time.</font></div><p></p></pre></div></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014810227936/"   >http://blog.163.com/digoal@126/blog/static/1638770402014810227936/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014815105622529/"   >http://blog.163.com/digoal@126/blog/static/1638770402014815105622529/<br></a><span style="line-height: 28px;"   >
</span><a style="line-height: 28px;" rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="ganglia gweb events or user defined markers - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div></div>
	</div>
</div>
</body>
</html>