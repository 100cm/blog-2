<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL fork_process.c write process's oom_adj and oom_score_adj BUG?</h2>
	<h5 id="">2012-09-11 10:49:08&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012811103039776/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">PostgreSQL 9.2.0 在教师节那天发布了. 非常高兴.<wbr><div>看到PostgreSQL 9.2.0的release notes里面有一条消息如下 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >Support Linux's /proc/self/oom_score_adj API (Tom Lane)</font></p></pre></div><div>这个的用意是防止Linux的out of memory kill机制把postmaster进程杀掉(因为Postmaster进程下挂了一堆的子进程, linux 会认为它占用了太多资源, 优先干掉他.)</div><div>那么DBA怎么防止postmaster进程被干掉的呢?</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >su - root</font></div><div><font size="2"  >echo -17 &gt; /proc/self/oom_adj</font></div><div><font size="2"  >su - postgres -c "pg_ctl start"</font></div><p></p></pre></div><div>通过以上命令启动postgreSQL数据库的话, postmaster以及它的子进程都将会继承oom_adj值, 也就是root shell的-17.</div><div>所以postmaster和它的子进程都不会被优先oom kill掉.</div><div>但是我们并不想看到这样的结果,&nbsp;</div><div>我们应该是希望postmaster进程是安全的, 但是postmaster的子进程(如与client进行通讯的server backend)允许被oom kill掉.&nbsp;</div><div>但同时也应该保护另外一些子进程, (除主进程外的一些系统子进程) 例如 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres: writer process</font></div><div><font size="2"  >postgres: wal writer process</font></div><div><font size="2"  >postgres: autovacuum launcher process</font></div><div><font size="2"  >postgres: stats collector process</font></div><p></p></pre></div><div>那么PostgreSQL 怎么与Linux oom结合的呢？</div><div>来看看它的源码 :</div><div>postgresql-9.2.0/src/backend/postmaster/fork_process.c</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* By default, Linux tends to kill the postmaster in out-of-memory</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* situations, because it blames the postmaster for the sum of child</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* process sizes *including shared memory*. &nbsp;(This is unbelievably</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* stupid, but the kernel hackers seem uninterested in improving it.)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Therefore it's often a good idea to protect the postmaster by</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* setting its oom_score_adj value negative (which has to be done in a</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* root-owned startup script). If you just do that much, all child</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* processes will also be protected against OOM kill, which might not</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* be desirable. &nbsp;You can then choose to build with</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* LINUX_OOM_SCORE_ADJ #defined to 0, or to some other value that you</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* want child processes to adopt here.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"  >#ifdef LINUX_OOM_SCORE_ADJ</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Use open() not stdio, to ensure we control the open flags. Some</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Linux security environments reject anything but O_WRONLY.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fd = open("/proc/self/oom_score_adj", O_WRONLY, 0);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* We ignore all errors */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (fd &gt;= 0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;buf[16];</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(buf, sizeof(buf), "%d\n", LINUX_OOM_SCORE_ADJ);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = write(fd, buf, strlen(buf));</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (void) rc;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; close(fd);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >#endif &nbsp; /* LINUX_OOM_SCORE_ADJ */</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Older Linux kernels have oom_adj not oom_score_adj. &nbsp;This works</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* similarly except with a different scale of adjustment values.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* If it's necessary to build Postgres to work with either API,</font></div></div><div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* you can define both LINUX_OOM_SCORE_ADJ and LINUX_OOM_ADJ.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"  >#ifdef LINUX_OOM_ADJ</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Use open() not stdio, to ensure we control the open flags. Some</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Linux security environments reject anything but O_WRONLY.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fd = open("/proc/self/oom_adj", O_WRONLY, 0);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* We ignore all errors */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (fd &gt;= 0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;buf[16];</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(buf, sizeof(buf), "%d\n", LINUX_OOM_ADJ);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = write(fd, buf, strlen(buf));</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (void) rc;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; close(fd);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >#endif &nbsp; /* LINUX_OOM_ADJ */</font></div></div><p></p></pre></div><div>用意是postgres在fork子进程时, 去设置子进程自己的/proc/self/oom_adj或者/proc/self/oom_score_adj的值.</div><div>具体的操作是需要在编译的时候设置CPPFLAGS或者CFLAGS</div><div>如 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >CPPFLAGS="-DLINUX_OOM_SCORE_ADJ=0 -DLINUX_OOM_ADJ=0" ./configure --prefix=/opt/pgsql9.2.0 --with-pgport=9200 --with-perl --with-tcl&nbsp;</font></div><div><font size="2"  >--with-python --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=16 &amp;</font></div><div><font size="2"  >&amp; gmake world</font></div><p></p></pre></div><div>那么这样做行不行得通呢? 显然是有点问题的, 因为PostgreSQL 进程是在普通用户下启动的. 例如postgres用户, 而普通用户在Linux下面不允许修改<span style="line-height: 22px;"  >/proc/self/oom_adj或者/proc/self/oom_score_adj的值. 也就是说上面的代码没有效果.</span></div><div><span style="line-height: 22px;"  >例如我们修改一下上面的代码来track一下 :&nbsp;</span></div><div><span style="line-height: 22px;"  >添加如下 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 22px;"  >// 在</span>#include &lt;unistd.h&gt;下面添加</font></div><div><span style="line-height: 22px;"  ><font size="2"  ><div>#include &lt;string.h&gt;</div><div>#include &lt;errno.h&gt;</div><div>// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;在 rc = write(fd, buf, strlen(buf)); 下面添加</div></font></span></div><div><span style="line-height: 22px;"  ><font size="2"  ><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (rc == -1)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr, "modify oom error:%s\n", strerror(errno));</div></font></span></div><p></p></pre></div><div>重新编译后, 启动数据库就会报如下信息 :&nbsp;</div><div><div>root@db-172-16-3-150-&gt; modify oom error:Operation not permitted</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >LOG: &nbsp;database system was shut down at 2012-09-11 10:14:54 CST</font></div><div><font size="2"  >modify oom error:Operation not permitted</font></div><div><font size="2"  >modify oom error:Operation not permitted</font></div><div><font size="2"  >modify oom error:Operation not permitted</font></div><div><font size="2"  >modify oom error:Operation not permitted</font></div><div><font size="2"  >LOG: &nbsp;autovacuum launcher started</font></div><div><font size="2"  >LOG: &nbsp;database system is ready to accept connections</font></div><p></p></pre></div></div><div>这是数据库在fork以下几个进程造成的 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg9.2.0 &nbsp;20241 20239 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp;&nbsp;</font></div><div><font size="2"  >pg9.2.0 &nbsp;20242 20239 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp; &nbsp;</font></div><div><font size="2"  >pg9.2.0 &nbsp;20243 20239 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal writer process &nbsp;&nbsp;</font></div><div><font size="2"  >pg9.2.0 &nbsp;20244 20239 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum launcher process &nbsp;&nbsp;</font></div><div><font size="2"  >pg9.2.0 &nbsp;20245 20239 &nbsp;0 10:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process</font></div><p></p></pre></div><div>好了, 知道原因后, 应该怎么解决呢? 一下列举两种方法.</div><div>1. 让root用户启动PostgreSQL, 参考《use Linux root user start PostgreSQL cluster》</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201281111553769/"  >http://blog.163.com/digoal@126/blog/static/163877040201281111553769/</a> </div><div><br></div><div>2. 按如下方法启动数据库</div><div><div><pre class="prettyprint"  ><p></p><div><div style="line-height: 22px;"  ><font size="2"  >su - root</font></div><div style="line-height: 22px;"  ><font size="2"  >echo 0 &gt; /proc/self/oom_adj</font></div><div style="line-height: 22px;"  ><font size="2"  >su - postgres -c "pg_ctl start"</font></div></div><div style="line-height: 22px;"  ><font size="2"  >然后找到postgres的进程和几个它的系统子进程. 分别执行</font></div><div style="line-height: 22px;"  ><font size="2"  ><span style="line-height: 22px;"  >echo -17 &gt; /proc/$postmaster/oom_adj</span> </font></div><div><font size="2"  ><span style="line-height: 22px;"  >echo -17 &gt; /proc/$checkpointer/oom_adj</span> </font></div><div><font size="2"  ><span style="line-height: 22px;"  >echo -17 &gt; /proc/$</span><span style="line-height: 22px;"  >writerprocess</span><span style="line-height: 22px;"  >/oom_adj</span></font></div><div><font size="2"  ><span style="line-height: 22px;"  >echo -17 &gt; /proc/$</span><span style="line-height: 22px;"  >walwriterprocess</span><span style="line-height: 22px;"  >/oom_adj</span></font></div><div><font size="2"  ><span style="line-height: 22px;"  >echo -17 &gt; /proc/$</span><span style="line-height: 22px;"  >autovacuum launcher process</span><span style="line-height: 22px;"  >/oom_adj</span></font></div><div><font size="2"  ><span style="line-height: 22px;"  >echo -17 &gt; /proc/$</span><span style="line-height: 22px;"  >stats collector process</span><span style="line-height: 22px;"  >/oom_adj</span></font></div><div><font size="2"  >后面产生的子进程都会以<span style="line-height: 22px;"  >oom_adj=0的值启动, 在发生oom kill时这些子进程将可能被kill掉, 而postmaster等进程则不会被kill掉.</span></font></div><p></p></pre></div></div><div><span style="line-height: 22px;"  ><br></span></div></div>
	</div>
</div>
</body>
</html>