<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use Linux root user start PostgreSQL cluster</h2>
	<h5 id="">2012-09-11 13:22:50&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201281111553769/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在上一篇BLOG中介绍了为什么PostgreSQL的oom_adj修改策略没有生效, 因为PostgreSQL进程是普通用户启动的, 没有权限修改/proc/$pid/oom_adj.</div><div>所以有一种办法是让root可以启动数据库集群.</div><div>正常情况下, 用root启动数据库会报错, 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@db-172-16-3-150-&gt; pg_ctl start</font></div><div><font size="2"   >pg_ctl: cannot be run as root</font></div><div><font size="2"   >Please log in (using, e.g., "su") as the (unprivileged) user that will</font></div><div><font size="2"   >own the server process.</font></div><p></p></pre></div><div>原因是pg_ctl在启动数据库时, 要判断一下用户的uid, 如果等于0, 那么将报错, 并退出. 源代码如下 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >#ifndef WIN32</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (geteuid() == 0)</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; write_stderr(_("%s: cannot be run as root\n"</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"Please log in (using, e.g., \"su\") as the "</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"(unprivileged) user that will\n"</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"own the server process.\n"),</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;progname);</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exit(1);</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div style="line-height: 22px;"   ><font size="2"   >#endif</font></div><p></p></pre></div></div><div>其中geteuid是用来获取用户的uid的系统函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >GETUID(2) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Linux Programmer’s Manual &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GETUID(2)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >NAME</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;getuid, geteuid - get user identity</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SYNOPSIS</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;#include &lt;unistd.h&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;#include &lt;sys/types.h&gt;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;uid_t getuid(void);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;uid_t geteuid(void);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >DESCRIPTION</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;getuid() returns the real user ID of the current process.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;geteuid() returns the effective user ID of the current process.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >ERRORS</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;These functions are always successful.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CONFORMING TO</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;POSIX.1-2001, 4.3BSD.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >HISTORY</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;In &nbsp;Unix &nbsp;V6 &nbsp;the &nbsp;getuid() &nbsp;call &nbsp;returned &nbsp;(euid &lt;&lt; 8) + uid. &nbsp;Unix V7 introduced separate calls getuid() and</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;geteuid().</font></div><p></p></pre></div><div>那么如果要让数据库能够使用root启动, 就非常简单了, 稍微修改一下源码, 重新编译.</div><div>接下来将exit(1)都注释掉, 保持错误输出, 但是不退出.&nbsp;</div><div>重新编译即可.</div><div>[root@db-172-16-3-150 postgresql-9.2.0]# grep -r geteuid *</div><div>src/bin/pg_resetxlog/pg_resetxlog.c: &nbsp;&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#ifndef WIN32</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (geteuid() == 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr, _("%s: cannot be executed by \"root\"\n"),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; progname);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr, _("You must run %s as the PostgreSQL superuser.\n"),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; progname);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // exit(1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >#endif</font></div><p></p></pre></div><div><br></div><div>src/bin/pg_ctl/pg_ctl.c: &nbsp; &nbsp; &nbsp;&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#ifndef WIN32</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (geteuid() == 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; write_stderr(_("%s: cannot be run as root\n"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"Please log in (using, e.g., \"su\") as the "</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"(unprivileged) user that will\n"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"own the server process.\n"),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;progname);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // exit(1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >#endif</font></div><p></p></pre></div><div><br></div><div>src/bin/initdb/initdb.c: &nbsp; &nbsp; &nbsp;&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (geteuid() == 0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* 0 is root's uid */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _("%s: cannot be run as root\n"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Please log in (using, e.g., \"su\") as the "</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "(unprivileged) user that will\n"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "own the server process.\n"),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; progname);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //exit(1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; pw = getpwuid(geteuid());</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!pw)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _("%s: could not obtain information about current user: %s\n"),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; progname, strerror(errno));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //exit(1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div><div><br></div><div>src/backend/main/main.c: &nbsp; &nbsp; &nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#ifndef WIN32</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (geteuid() == 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; write_stderr("\"root\" execution of the PostgreSQL server is not permitted.\n"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"The server must be started under an unprivileged user ID to prevent\n"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "possible system security compromise. &nbsp;See the documentation for\n"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "more information on how to properly start the server.\n");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //exit(1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div><div><br></div><div>重新编译后, 原来的数据目录需要修改为root权限的, 因为先要去判断是否启动用户的权限, 这里就不再修改源码了.&nbsp;</div><div>因为可以简单的解决.</div><div><pre class="prettyprint"   ><p><font size="2"   >chown -R root:root $PGDATA</font></p></pre></div><div>接下来使用新编译的bin文件启动数据库.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@db-172-16-3-150-&gt; whoami</font></div><div><font size="2"   >root</font></div><p></p></pre></div><div>调整当前shell进程的oom_adj的值, 这样的话, postgres将会继承这个值, 然后看看子进程是否会正常的调用如下oom_adj write.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >#ifdef LINUX_OOM_ADJ</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Use open() not stdio, to ensure we control the open flags. Some</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Linux security environments reject anything but O_WRONLY.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fd = open("/proc/self/oom_adj", O_WRONLY, 0);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* We ignore all errors */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (fd &gt;= 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;buf[16];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(buf, sizeof(buf), "%d\n", LINUX_OOM_ADJ);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = write(fd, buf, strlen(buf));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (void) rc;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; close(fd);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div></div><div><font size="2"   >#endif &nbsp; /* LINUX_OOM_ADJ */</font></div><p></p></pre></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@db-172-16-3-150-&gt; echo -17 &gt; /proc/self/oom_adj&nbsp;</font></div><div><font size="2"   >root@db-172-16-3-150-&gt; cat /proc/self/oom_adj&nbsp;</font></div><div><font size="2"   >-17</font></div><div><font size="2"   >root@db-172-16-3-150-&gt; pg_ctl start</font></div><div><font size="2"   >pg_ctl: cannot be run as root</font></div><div><font size="2"   >Please log in (using, e.g., "su") as the (unprivileged) user that will</font></div><div><font size="2"   >own the server process.</font></div><div><font size="2"   >server starting</font></div><p></p></pre></div><div>使用root用户启动正常 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@db-172-16-3-150-&gt; "root" execution of the PostgreSQL server is not permitted.</font></div><div><font size="2"   >The server must be started under an unprivileged user ID to prevent</font></div><div><font size="2"   >possible system security compromise. &nbsp;See the documentation for</font></div><div><font size="2"   >more information on how to properly start the server.</font></div><div><font size="2"   >LOG: &nbsp;database system was shut down at 2012-09-11 13:08:47 CST</font></div><div><font size="2"   >LOG: &nbsp;autovacuum launcher started</font></div><div><font size="2"   >LOG: &nbsp;database system is ready to accept connections</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >root@db-172-16-3-150-&gt; ps -ewf|grep root|grep postgres</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp;4325 &nbsp; &nbsp; 1 &nbsp;0 13:09 pts/4 &nbsp; &nbsp;00:00:00 /opt/pgsql9.2.0/bin/postgres</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp;4327 &nbsp;4325 &nbsp;0 13:09 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp;&nbsp;</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp;4328 &nbsp;4325 &nbsp;0 13:09 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp; &nbsp;</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp;4329 &nbsp;4325 &nbsp;0 13:09 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal writer process &nbsp;&nbsp;</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp;4330 &nbsp;4325 &nbsp;0 13:09 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum launcher process &nbsp;&nbsp;</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp;4331 &nbsp;4325 &nbsp;0 13:09 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process &nbsp;&nbsp;</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp;4339 23963 &nbsp;0 13:09 pts/4 &nbsp; &nbsp;00:00:00 grep postgres</font></div><p></p></pre></div><div>显然, oom_adj已经正常了. 子进程正常调用了src/backend/postmaster/fork_process.c里面的write(fd, buf, strlen(buf));</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@db-172-16-3-150-&gt; cat /proc/4325/oom_adj&nbsp;</font></div><div><font size="2"   >-17</font></div><div><font size="2"   >root@db-172-16-3-150-&gt; cat /proc/4327/oom_adj&nbsp;</font></div><div><font size="2"   >0</font></div><div><font size="2"   >root@db-172-16-3-150-&gt; cat /proc/4328/oom_adj&nbsp;</font></div><div><font size="2"   >0</font></div><div><font size="2"   >root@db-172-16-3-150-&gt; cat /proc/4329/oom_adj&nbsp;</font></div><div><font size="2"   >0</font></div><div><font size="2"   >root@db-172-16-3-150-&gt; cat /proc/4330/oom_adj&nbsp;</font></div><div><font size="2"   >0</font></div><div><font size="2"   >root@db-172-16-3-150-&gt; cat /proc/4331/oom_adj&nbsp;</font></div><div><font size="2"   >0</font></div><p></p></pre></div><div>使用psql新建一个连接, 检查backend pid的oom_adj值是否修改为0 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@db-172-16-3-150-&gt; psql -h 127.0.0.1</font></div><div><font size="2"   >psql (9.2.0)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select pg_backend_pid();</font></div><div><font size="2"   >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4357</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# \!</font></div><div><font size="2"   >[root@db-172-16-3-150 pg9.2.0]# cat /proc/4357/oom_adj&nbsp;</font></div><div><font size="2"   >0</font></div><p></p></pre></div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="use Linux root user start PostgreSQL cluster - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>