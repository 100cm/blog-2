<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL as a data service application case</h2>
	<h5 id="">2013-02-21 16:35:10&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201312142437246/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">场景描述 :&nbsp;<div>客户端定期上传安装和卸载APK的列表消息到服务端供数据分析.</div><div>数据结构如下 :&nbsp;<br><div><pre class="prettyprint"  ><p></p><div><font size="2"  >-- apk name 字典</font></div><div><font size="2"  >create table apk (id int8 primary key, apk_name text unique);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >-- 测试数据, 生成10W个应用.</font></div><div><font size="2"  >insert into apk select generate_series(1,100000), md5(clock_timestamp()::text);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >-- 消息数据类型</font></div><div><font size="2"  >create type msg as&nbsp;</font></div><div><font size="2"  >(apk_id int8, -- 应用ID</font></div><div><font size="2"  >apk_ver int, -- 应用版本</font></div><div><font size="2"  >apk_system boolean, -- 是否为预装应用</font></div><div><font size="2"  >act_time timestamp without time zone -- 时间</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >-- 消息表</font></div><div><font size="2"  >create table apk_info&nbsp;</font></div><div><font size="2"  >(dev_id int8, -- 设备ID</font></div><div><font size="2"  >install_msg msg[], -- 应用安装信息列表</font></div><div><font size="2"  >uninstall_msg msg[], -- 应用卸载信息列表</font></div><div><font size="2"  >upload_time timestamp without time zone, -- 消息上传时间</font></div><div><font size="2"  >other_info text -- 其他信息</font></div><div><font size="2"  >);</font></div><div><font size="2"  >create index idx_apk_info_time on apk_info(upload_time);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >-- 合成消息表</font></div><div><font size="2"  >create table apk_info_agg&nbsp;</font></div><div><font size="2"  >(dev_id int8 primary key,&nbsp;</font></div><div><font size="2"  >install_msg msg[],&nbsp;</font></div><div><font size="2"  >uninstall_msg msg[],&nbsp;</font></div><div><font size="2"  >upload_time timestamp without time zone[],&nbsp;</font></div><div><font size="2"  >other_info text[]);</font></div><p></p></pre></div><div><br></div><div>-- 测试数据,&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >do language plpgsql $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >&nbsp; v_dev_id int8;&nbsp;</font></div><div><font size="2"  >&nbsp; v_apk_id int8;&nbsp;</font></div><div><font size="2"  >&nbsp; v_install_msg msg[];</font></div><div><font size="2"  >&nbsp; v_uninstall_msg msg[];</font></div><div><font size="2"  >&nbsp; v_other_info text;</font></div><div><font size="2"  >&nbsp; i int;</font></div><div><font size="2"  >&nbsp; x int;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >i := 0;</font></div><div><font size="2"  >v_other_info := 'test';</font></div><div><font size="2"  >loop</font></div><div><font size="2"  >&nbsp; x := 0;</font></div><div><font size="2"  >&nbsp; -- 假设有10亿个设备ID</font></div><div><font size="2"  >&nbsp; v_dev_id := round(random()*100000000);</font></div><div><font size="2"  >&nbsp; -- 生成500000条上传消息</font></div><div><font size="2"  >&nbsp; if i&gt;500000 then</font></div><div><font size="2"  >&nbsp; &nbsp; exit;</font></div><div><font size="2"  >&nbsp; end if;</font></div><div><font size="2"  >&nbsp; loop</font></div><div><font size="2"  >&nbsp; &nbsp; -- 假设每个消息包含的消息数组元素为20个.</font></div><div><font size="2"  >&nbsp; &nbsp; -- 也就是20条安装信息和20条卸载信息</font></div><div><font size="2"  >&nbsp; &nbsp; if x&gt;20 then</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; exit;</font></div><div><font size="2"  >&nbsp; &nbsp; end if;</font></div><div><font size="2"  >&nbsp; &nbsp; -- 假设有10W个应用ID, 随机生成安装的应用ID</font></div><div><font size="2"  >&nbsp; &nbsp; v_apk_id := round(random()*100000);</font></div><div><font size="2"  >&nbsp; &nbsp; if x=0 then</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; v_install_msg := array[(v_apk_id, 0, false, clock_timestamp())]::msg[];</font></div><div><font size="2"  >&nbsp; &nbsp; else</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; v_install_msg := array_cat(v_install_msg, array[(v_apk_id, 0, false, clock_timestamp())]::msg[]);</font></div><div><font size="2"  >&nbsp; &nbsp; end if;</font></div><div><font size="2"  >&nbsp; &nbsp; -- 假设有10W个应用ID, 随机生成卸载的应用ID</font></div><div><font size="2"  >&nbsp; &nbsp; v_apk_id := round(random()*100000);</font></div><div><font size="2"  >&nbsp; &nbsp; if x=0 then</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; v_uninstall_msg := array[(v_apk_id, 0, false, clock_timestamp())]::msg[];</font></div><div><font size="2"  >&nbsp; &nbsp; else&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; v_uninstall_msg := array_cat(v_uninstall_msg, array[(v_apk_id, 0, false, clock_timestamp())]::msg[]);</font></div><div><font size="2"  >&nbsp; &nbsp; end if;</font></div><div><font size="2"  >&nbsp; &nbsp; x := x+1;</font></div><div><font size="2"  >&nbsp; end loop;</font></div><div><font size="2"  >&nbsp; insert into apk_info(dev_id, install_msg, uninstall_msg, upload_time, other_info)</font></div><div><font size="2"  >&nbsp; &nbsp; values (v_dev_id, v_install_msg, v_uninstall_msg, clock_timestamp(), v_other_info);</font></div><div><font size="2"  >&nbsp; i := i+1;</font></div><div><font size="2"  >end loop;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$;</font></div><p></p></pre></div><div><br></div><div>-- 数据样本</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select count(*) from apk;</font></div><div><font size="2"  >&nbsp;count &nbsp;</font></div><div><font size="2"  >--------</font></div><div><font size="2"  >&nbsp;100000</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Time: 21.544 ms</font></div><div><font size="2"  >digoal=# select count(*) from apk_info;</font></div><div><font size="2"  >&nbsp;count &nbsp;</font></div><div><font size="2"  >--------</font></div><div><font size="2"  >&nbsp;500001</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Time: 105.652 ms</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=# select * from apk_info limit 1;</font></div><div><font size="2"  >-[ RECORD 1 ]-</font></div><div><font size="2"  >dev_id &nbsp; &nbsp; &nbsp; &nbsp;| 53866103</font></div><div><font size="2"  >install_msg &nbsp; | {"(441356,0,f,\"2013-02-21 15:06:20.050831\")","(960322,0,f,\"2013-02-21 15:06:20.051149\")","(926606,0,f,\"2013-02-21 15:06:20.051268\")","(787820,0,f,\"2013-02-21 15:06:20.051286\")","(963924,0,f,\"2013-02-21 15:06:20.051302\")","(117365,0,f,\"2013-02-21 15:06:20.05132\")","(987175,0,f,\"2013-02-21 15:06:20.051335\")","(354263,0,f,\"2013-02-21 15:06:20.051351\")","(473302,0,f,\"2013-02-21 15:06:20.051368\")","(236770,0,f,\"2013-02-21 15:06:20.051384\")","(849336,0,f,\"2013-02-21 15:06:20.0514\")","(903571,0,f,\"2013-02-21 15:06:20.051416\")","(995056,0,f,\"2013-02-21 15:06:20.051432\")","(251080,0,f,\"2013-02-21 15:06:20.051449\")","(403374,0,f,\"2013-02-21 15:06:20.051465\")","(489233,0,f,\"2013-02-21 15:06:20.051481\")","(1125,0,f,\"2013-02-21 15:06:20.051497\")","(487261,0,f,\"2013-02-21 15:06:20.051514\")","(686854,0,f,\"2013-02-21 15:06:20.05153\")","(887800,0,f,\"2013-02-21 15:06:20.051546\")","(300390,0,f,\"2013-02-21 15:06:20.051562\")"}</font></div><div><font size="2"  >uninstall_msg | {"(31827,0,f,\"2013-02-21 15:06:20.051009\")","(642531,0,f,\"2013-02-21 15:06:20.051252\")","(237298,0,f,\"2013-02-21 15:06:20.051277\")","(960070,0,f,\"2013-02-21 15:06:20.051294\")","(25309,0,f,\"2013-02-21 15:06:20.05131\")","(942065,0,f,\"2013-02-21 15:06:20.051327\")","(777628,0,f,\"2013-02-21 15:06:20.051343\")","(684844,0,f,\"2013-02-21 15:06:20.051359\")","(918857,0,f,\"2013-02-21 15:06:20.051375\")","(34467,0,f,\"2013-02-21 15:06:20.051391\")","(173178,0,f,\"2013-02-21 15:06:20.051407\")","(358861,0,f,\"2013-02-21 15:06:20.051423\")","(244461,0,f,\"2013-02-21 15:06:20.05144\")","(950572,0,f,\"2013-02-21 15:06:20.051456\")","(969297,0,f,\"2013-02-21 15:06:20.051473\")","(844730,0,f,\"2013-02-21 15:06:20.051489\")","(449556,0,f,\"2013-02-21 15:06:20.051505\")","(927730,0,f,\"2013-02-21 15:06:20.051521\")","(275081,0,f,\"2013-02-21 15:06:20.051537\")","(650777,0,f,\"2013-02-21 15:06:20.051554\")","(5165,0,f,\"2013-02-21 15:06:20.05157\")"}</font></div><div><font size="2"  >upload_time &nbsp; | 2013-02-21 15:06:20.051775</font></div><div><font size="2"  >other_info &nbsp; &nbsp;| test</font></div><div><font size="2"  >Time: 0.664 ms</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"  >-- 将数据按照dev_id合成. 便于查询和分析 :&nbsp;</span></div><div><span style="line-height: 22px;"  >-- 合成时需要排序, 因为所有字段的元素必须一一对应.</span></div><div><span style="line-height: 22px;"  >-- 合成举例 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >begin;</font></div><div><font size="2"  >-- 创建聚合表的临时表</font></div><div><font size="2"  >drop table if exists tmp_apk_info_agg;</font></div><div><font size="2"  >create table tmp_apk_info_agg (like apk_info_agg);</font></div><div><font size="2"  >-- 聚合表的数据插入临时表</font></div><div><font size="2"  >insert into tmp_apk_info_agg select * from apk_info_agg;</font></div><div><font size="2"  >-- 清除聚合表的数据</font></div><div><font size="2"  >truncate table apk_info_agg;</font></div><div><font size="2"  >-- 整合信息表和聚合表的数据, 假设每天整合1次.</font></div><div><font size="2"  >-- 当然粒度可以更细</font></div><div><font size="2"  >insert into apk_info_agg (dev_id, install_msg, uninstall_msg, upload_time, other_info)</font></div><div><font size="2"  >select&nbsp;</font></div><div><font size="2"  >dev_id,&nbsp;</font></div><div><font size="2"  >array_agg(ins order by upload_time),&nbsp;</font></div><div><font size="2"  >array_agg(unins order by upload_time),&nbsp;</font></div><div><font size="2"  >array_agg(upload_time order by upload_time),&nbsp;</font></div><div><font size="2"  >array_agg(other_info order by upload_time)&nbsp;</font></div><div><font size="2"  >from&nbsp;</font></div><div><font size="2"  >&nbsp; (select&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp;dev_id,</font></div><div><font size="2"  >&nbsp; &nbsp;unnest(install_msg) as ins,</font></div><div><font size="2"  >&nbsp; &nbsp;unnest(uninstall_msg) as unins ,&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp;upload_time,&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp;other_info from apk_info</font></div><div><font size="2"  >&nbsp; &nbsp;where upload_time &lt;= current_date</font></div><div><font size="2"  >&nbsp; &nbsp;union all</font></div><div><font size="2"  >&nbsp; &nbsp;select</font></div><div><font size="2"  >&nbsp; &nbsp;dev_id,</font></div><div><font size="2"  >&nbsp; &nbsp;unnest(install_msg) as ins,</font></div><div><font size="2"  >&nbsp; &nbsp;unnest(uninstall_msg) as unins,</font></div><div><font size="2"  >&nbsp; &nbsp;unnest(upload_time) as upload_time,</font></div><div><font size="2"  >&nbsp; &nbsp;unnest(other_info) as other_info</font></div><div><font size="2"  >&nbsp; &nbsp;from tmp_apk_info_agg</font></div><div><font size="2"  >&nbsp; &nbsp;) as t&nbsp;</font></div><div><font size="2"  >group by dev_id;</font></div><div><font size="2"  >-- 删除已整合的信息表的数据</font></div><div><font size="2"  >delete from apk_info where upload_time &lt;= current_date;</font></div><div><font size="2"  >end;</font></div><p></p></pre></div><div><br></div><div>-- 整合后记录数如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select count(*) from apk_info_agg ;</font></div><div><font size="2"  >&nbsp;count &nbsp;</font></div><div><font size="2"  >--------</font></div><div><font size="2"  >&nbsp;498788</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >Time: 112.713 ms</font></div><p></p></pre></div><div><br></div><div>-- 分析举例</div><div>1. 先安装a应用后安装b应用的用户有多少.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function install_time_comp (i_msg msg[], i_apk_id1 int8, i_apk_id2 int8) returns boolean as $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >&nbsp; v_msg msg;</font></div><div><font size="2"  >&nbsp; v_apk_id1_mintime timestamp without time zone;</font></div><div><font size="2"  >&nbsp; v_apk_id2_mintime timestamp without time zone;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >&nbsp; foreach v_msg in array i_msg loop</font></div><div><font size="2"  >&nbsp; &nbsp; if v_msg.apk_id=i_apk_id1 then</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; v_apk_id1_mintime := least(v_apk_id1_mintime, v_msg.act_time);</font></div><div><font size="2"  >&nbsp; &nbsp; elsif v_msg.apk_id=i_apk_id2 then</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; v_apk_id2_mintime := least(v_apk_id2_mintime, v_msg.act_time);</font></div><div><font size="2"  >&nbsp; &nbsp; end if;</font></div><div><font size="2"  >&nbsp; end loop;</font></div><div><font size="2"  >&nbsp; return v_apk_id1_mintime &gt; v_apk_id2_mintime;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$ language plpgsql;</font></div><p></p></pre></div><div>-- 查询速度 :&nbsp;</div><div>-- 50W用户, 每条用户的数组长度为20. 响应速度如下.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select dev_id from apk_info_agg where install_time_comp(install_msg, 94466, 84721) is true;</font></div><div><font size="2"  >&nbsp;dev_id&nbsp;</font></div><div><font size="2"  >--------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;98</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >Time: 33435.329 ms</font></div><p></p></pre></div><div>简单的推算出1亿用户, 平均每个用户的数组长度为2000的情况下该运算速度应该是660000秒约183小时.</div><div>测试机的CPU :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></p></pre></div><div><br></div><div>【瓶颈分析】</div><div>由于分析过程中, 每次都需要遍历整个msg数组, 当数组越来越大后, 性能还会下降.</div><div>可以考虑将分析移到程序端并行执行. 数据库只当数据存储用.</div><div>或者将数据转换成JSON存储到mongoDB中, 借助mongoDB来分析.</div><div><br></div><div>【参考】</div><div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/functions-array.html"  >http://www.postgresql.org/docs/devel/static/functions-array.html</a></div><div>2.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201201275922529/"  >http://blog.163.com/digoal@126/blog/static/163877040201201275922529/</a></div><div>3.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201201272718196/"  >http://blog.163.com/digoal@126/blog/static/163877040201201272718196/</a></div><div>4.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013030104627983/"  >http://blog.163.com/digoal@126/blog/static/1638770402013030104627983/</a></div><div>5.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020130682522480/"  >http://blog.163.com/digoal@126/blog/static/16387704020130682522480/</a></div><div>6.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201302410511382/"  >http://blog.163.com/digoal@126/blog/static/163877040201302410511382/</a></div><div>7.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020124180182088/"  >http://blog.163.com/digoal@126/blog/static/16387704020124180182088/</a></div><div>8.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020128594046594/"  >http://blog.163.com/digoal@126/blog/static/16387704020128594046594/</a></div><div>9.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/functions-conditional.html#FUNCTIONS-GREATEST-LEAST"  >http://www.postgresql.org/docs/devel/static/functions-conditional.html#FUNCTIONS-GREATEST-LEAST</a></div><div><br></div><wbr></div></div>
	</div>
</div>
</body>
</html>