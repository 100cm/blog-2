<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL recovery from timeline history file lost case</h2>
	<h5 id="">2013-02-01 12:32:10&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020131111262609/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>群里的一位兄弟问到的一个问题 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[广州]土豆饼-pg &nbsp;10:34:08</font></div><div><font size="2"  >流复制的问题</font></div><div><font size="2"  >[广州]土豆饼-pg &nbsp;10:34:20</font></div><div><font size="2"  >我今天在主库导入了150多个数据库</font></div><div><font size="2"  >[广州]土豆饼-pg &nbsp;10:34:28</font></div><div><font size="2"  >然后对主库做基线备份</font></div><div><font size="2"  >[广州]土豆饼-pg &nbsp;10:34:46</font></div><div><font size="2"  >拷贝到备库启动时 流复制一直起不来</font></div><div><font size="2"  >[广州]土豆饼-pg &nbsp;10:34:51</font></div><div><font size="2"  >报错</font></div><div><font size="2"  >cp: 无法 stat “/opt/PostgreSQL/9.1/archive/0000000100000000000000FD”: 没有那个文件或目录</font></div><div><font size="2"  >cp: 无法 stat “/opt/PostgreSQL/9.1/archive/00000002.history”: 没有那个文件或目录</font></div><div><font size="2"  >[广州]土豆饼-pg &nbsp;10:35:08</font></div><div><font size="2"  >主备库都照了没有这个文件00000002.history</font></div><div><font size="2"  >[广州]土豆饼-pg &nbsp;10:35:20</font></div><div><font size="2"  >请问我的流复制怎么起起来</font></div><p></p></pre></div><div>从现象上来看是时间线历史文件丢失了, 具体是什么原因丢失的先不管.&nbsp;</div><div>如果不想重做基线备份重做standby, 首先要保证standby需要的xlog信息在主库还没有被rotate掉.</div><div>下面假设xlog信息未rotate掉, 那么解决问题的关键就在如何自建时间线历史文件中的内容.</div><div>时间线历史文件的格式如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp;* Each line in the file represents a timeline switch:</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* &lt;parentTLI&gt; &lt;switchpoint&gt; &lt;reason&gt;</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* &nbsp; &nbsp; &nbsp;parentTLI &nbsp; &nbsp; &nbsp; ID of the parent timeline</font></div><div><font size="2"  >&nbsp;* &nbsp; &nbsp; &nbsp;switchpoint &nbsp; &nbsp; XLogRecPtr of the WAL position where the switch happened</font></div><div><font size="2"  >&nbsp;* &nbsp; &nbsp; &nbsp;reason &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;human-readable explanation of why the timeline was changed</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* The fields are separated by tabs. Lines beginning with # are comments, and</font></div><div><font size="2"  >&nbsp;* are ignored. Empty lines are also ignored.</font></div><p></p></pre></div><div>1. parentTLI指从那个timeline切换而来, 如当前timeline=1如果发生切换的话那么新的timeline=2, 这个时间线文件的parentTLI=1.</div><div>2. switchpoint指发生切换时的xlog文件名.</div><div>3. 可以理解为comment.</div><div>以上三个分段的内容用TAB分隔.</div><div>空行和#开头的行代表注释. timeline.c略过处理这些行.</div><div><br></div><div>接下来模拟一下丢失时间线文件的恢复.</div><div>测试环境 :&nbsp;</div><div>PostgreSQL 9.1.3</div><div><br></div><div>node A(primary) :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal@db-172-16-3-33-&gt; psql</font></div><div><font size="2"  >psql (9.1.3)</font></div><div><font size="2"  >Type "help" for help.</font></div></div><div><div><div><font size="2"  >digoal=&gt; drop table test;</font></div><div><font size="2"  >DROP TABLE</font></div><div><font size="2"  >digoal=&gt; create table test(id int,crt_time timestamp default clock_timestamp());</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >digoal=&gt; insert into test (id) select generate_series(1,1000000);</font></div><div><font size="2"  >INSERT 0 1000000</font></div><div><font size="2"  >digoal=&gt; delete from test ;</font></div><div><font size="2"  >DELETE 1000000</font></div><div><font size="2"  >digoal=&gt; insert into test values (1,now());</font></div><div><font size="2"  >INSERT 0 1</font></div></div></div><div><div><font size="2"  >digoal=&gt; select * from test;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-01 12:10:19.299484</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>node B(standby) :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoalstd@db-172-16-3-33-&gt; psql</font></div><div><font size="2"  >psql (9.1.3)</font></div><div><font size="2"  >Type "help" for help.</font></div></div><div><div><font size="2"  >digoal=&gt; select * from test ;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-01 12:10:19.299484</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>node A(primary) :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >-- 关闭节点A</font></div><div><div><font size="2"  >digoal@db-172-16-3-33-&gt; pg_ctl stop -m fast</font></div><div><font size="2"  >waiting for server to shut down..... done</font></div><div><font size="2"  >server stopped</font></div></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"  >node B(primary) :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><span style="line-height: 22px;"  ><font size="2"  >-- promote 节点B</font></span></div><div><div style="line-height: 22px;"  ><font size="2"  >digoalstd@db-172-16-3-33-&gt; pg_ctl promote</font></div><div style="line-height: 22px;"  ><font size="2"  >server promoting</font></div><div><div><font size="2"  >digoalstd@db-172-16-3-33-&gt; psql</font></div><div><font size="2"  >psql (9.1.3)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  >digoal=&gt; insert into test (id) select generate_series(1,100000);</font></div><div><font size="2"  >INSERT 0 100000</font></div><div><font size="2"  >digoal=&gt; insert into test (id) select generate_series(1,100000);</font></div><div><font size="2"  >INSERT 0 100000</font></div><div><font size="2"  >digoal=&gt; insert into test (id) select generate_series(1,100000);</font></div><div><font size="2"  >INSERT 0 100000</font></div></div></div><div><font size="2"  >digoal=&gt; \c digoal postgres</font></div><div><div><font size="2"  >digoal=# checkpoint;</font></div><div><font size="2"  >CHECKPOINT</font></div></div><div><div><font size="2"  >digoal=# select pg_switch_xlog();</font></div><div><font size="2"  >&nbsp;pg_switch_xlog&nbsp;</font></div><div><font size="2"  >----------------</font></div><div><font size="2"  >&nbsp;0/146A6CC8</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=# select pg_switch_xlog();</font></div><div><font size="2"  >&nbsp;pg_switch_xlog&nbsp;</font></div><div><font size="2"  >----------------</font></div><div><font size="2"  >&nbsp;0/15000000</font></div><div><font size="2"  >(1 row)</font></div></div><div><font size="2"  >-- 查看新生成的history文件, 并删除</font></div><div><div><font size="2"  >digoalstd@db-172-16-3-33-&gt; cat 00000004.history</font></div><div><font size="2"  >2 &nbsp; &nbsp; &nbsp; 000000020000000000000009 &nbsp; &nbsp; &nbsp; &nbsp;no recovery target specified</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >3 &nbsp; &nbsp; &nbsp; 000000030000000000000012 &nbsp; &nbsp; &nbsp; &nbsp;no recovery target specified</font></div><div><font size="2"  >digoalstd@db-172-16-3-33-&gt; rm -f 00000004.history</font></div></div><p></p></pre></div><div><br></div><div>node A(standby) :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >-- 转换成standby节点, 配置recovery.conf略.</font></div><div><div><font size="2"  >digoal@db-172-16-3-33-&gt; pg_ctl stop -m fast</font></div><div><font size="2"  >waiting for server to shut down.... done</font></div><div><font size="2"  >server stopped</font></div><div><font size="2"  >digoal@db-172-16-3-33-&gt; cd $PGDATA</font></div><div><font size="2"  >digoal@db-172-16-3-33-&gt; mv recovery.done recovery.conf</font></div></div><div><font size="2"  >-- 启动</font></div><div><div><font size="2"  >digoal@db-172-16-3-33-&gt; pg_ctl start</font></div><div><font size="2"  >server starting</font></div></div><div><font size="2"  >-- 查看日志</font></div><div><div><font size="2"  >digoal@db-172-16-3-33-&gt; less postgresql-2013-02-01_121939.csv</font></div><div><font size="2"  >2013-02-01 12:19:39.812 CST,,,20015,,510b425b.4e2f,1,,2013-02-01 12:19:39 CST,,0,LOG,00000,"database system was shut down in recovery at 2013-02-01 12:17:50 CST",,,,,,,,,""</font></div><div><font size="2"  >2013-02-01 12:19:39.812 CST,,,20015,,510b425b.4e2f,2,,2013-02-01 12:19:39 CST,,0,LOG,00000,"entering standby mode",,,,,,,,,""</font></div><div><font size="2"  >2013-02-01 12:19:39.840 CST,,,20015,,510b425b.4e2f,4,,2013-02-01 12:19:39 CST,1/0,0,LOG,00000,"record with zero length at 0/12EAE578",,,,,,,,,""</font></div><div><font size="2"  >2013-02-01 12:19:39.840 CST,,,20009,,510b425b.4e29,1,,2013-02-01 12:19:39 CST,,0,LOG,00000,"database system is ready to accept read only connections",,,,,,,,,""</font></div><div><font size="2"  >2013-02-01 12:19:39.843 CST,,,20018,,510b425b.4e32,1,,2013-02-01 12:19:39 CST,,0,FATAL,XX000,"timeline 4 of the primary does not match recovery target timeline 3",,,,,,,,,""</font></div></div><div><font size="2"  >创建时间线文件名取自日志中的 :&nbsp;</font></div><div><span style="line-height: 22px;"  ><font size="2"  >timeline 4 of the primary does not match recovery target timeline 3</font></span></div><div><font size="2"  ><span style="line-height: 22px;"  >所以文件名应该为 :&nbsp;</span>00000004.history</font></div><div><font size="2"  >时间线文件的内容来自<span style="line-height: 22px;"  >timeline 4 of the primary does not match recovery target timeline 3以及它的前一条输出</span><span style="line-height: 22px;"  >record with zero length at 0/12EAE578.</span></font></div><div><font size="2"  >1. parentTLI = 3</font></div><div><font size="2"  >2. switchpoint 由3部分组成 :&nbsp;</font></div><div><div><font size="2"  >snprintf(fname, MAXFNAMELEN, "%08X%08X%08X", tli, &nbsp; &nbsp; &nbsp; \</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(uint32) ((logSegNo) / XLogSegmentsPerXLogId), \</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(uint32) ((logSegNo) % XLogSegmentsPerXLogId))</font></div></div><div><font size="2"  >tli = 3</font></div><div><font size="2"  ><span style="line-height: 22px;"  >(uint32) ((logSegNo) / XLogSegmentsPerXLogId)</span><span style="line-height: 22px;"  >&nbsp;= 0</span></font></div><div><font size="2"  ><span style="line-height: 22px;"  >(uint32) ((logSegNo) % XLogSegmentsPerXLogId)</span><span style="line-height: 22px;"  >&nbsp;= 12</span></font></div><div><font size="2"  >最后得出<span style="line-height: 22px;"  >switchpoint =&nbsp;</span><span style="line-height: 22px;"  >000000030000000000000012</span></font></div><div><span style="line-height: 22px;"  ><font size="2"  >具体怎么算来的可参考 :&nbsp;</font></span></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/"  ><font size="2"  >http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/</font></a></div><div><font size="2"  >3.&nbsp;reason 随便填一串字符</font></div><div><font size="2"  >所以时间线文件的内容为 :&nbsp;</font></div><div><span style="line-height: 22px;"  ><font size="2"  >3 &nbsp; &nbsp; &nbsp; 000000030000000000000012 &nbsp; &nbsp; &nbsp; &nbsp;recovery by digoal</font></span></div><div><span style="line-height: 22px;"  ><font size="2"  >在node A(standby)创建这个文件 :&nbsp;</font></span></div><div><font size="2"  >digoal@db-172-16-3-33-&gt; cd $PGDATA/pg_xlog</font></div><div><font size="2"  >digoal@db-172-16-3-33-&gt; vi 00000004.history</font></div><div><font size="2"  >再次查看日志 :&nbsp;</font></div><div><div><font size="2"  >2013-02-01 12:29:54.865 CST,,,20015,,510b425b.4e2f,5,,2013-02-01 12:19:39 CST,1/0,0,LOG,00000,"new target timeline is 4",,,,,,,,,""</font></div><div><font size="2"  >2013-02-01 12:29:54.867 CST,,,20435,,510b44c2.4fd3,1,,2013-02-01 12:29:54 CST,,0,LOG,00000,"streaming replication successfully connected to primary",,,,,,,,,""</font></div><div><font size="2"  >2013-02-01 12:29:55.345 CST,,,20015,,510b425b.4e2f,6,,2013-02-01 12:19:39 CST,1/0,0,LOG,00000,"redo starts at 0/12EAE578",,,,,,,,,""</font></div><div><font size="2"  >digoal@db-172-16-3-33-&gt;&nbsp;</font></div></div><div><font size="2"  >现在正常的连接到主节点了.</font></div><div><font size="2"  >数据正常 : </font></div><div><font size="2"  >digoal@db-172-16-3-33-&gt; psql<br>psql (9.1.3)<br>Type "help" for help.<br><br>digoal=&gt; select count(*) from test ;<br> count  <br>--------<br> 300001<br>(1 row)</font></div><p></p></pre></div><div><br></div>【参考】<wbr><div>1.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/"  >http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/</a></div><div>2.&nbsp;<span style="line-height: 22px;"  >src/include/access/timeline.h</span></div><div>3. src/backend/access/transam/timeline.c</div></div>
	</div>
</div>
</body>
</html>