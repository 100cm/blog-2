<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL PITR THREE recovery target MODE: name,xid,time USE CASE - 1</h2>
	<h5 id="">2013-02-04 23:00:48&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020131410250983/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前面一篇BLOG分析了PostgreSQL PITR的停止点recoveryStopsHere,&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201303082942271/"  >http://blog.163.com/digoal@126/blog/static/163877040201303082942271/</a></div><div>我们知道停止点的判断首先要满足xl_info是以下值之一 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><span style="line-height: 22px;"  ><font size="2"  >XLOG_XACT_COMMIT</font></span></div><div><span style="line-height: 22px;"  ><font size="2"  >XLOG_XACT_ABORT</font></span></div><div><span style="line-height: 22px;"  ><font size="2"  >XLOG_XACT_COMMIT_COMPACT</font></span></div><p></p></pre></div><div><span style="line-height: 22px;"  >也就是事务结束(提交或者回滚)的位置.</span></div><div><div style="line-height: 22px;"  >src/include/access/xact.h</div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >/*</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp;* XLOG allows to store some information in high 4 bits of log</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp;* record xl_info field</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp;*/</font></div><div style="line-height: 22px;"  ><font size="2"  >#define XLOG_XACT_COMMIT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x00</font></div><div style="line-height: 22px;"  ><font size="2"  >#define XLOG_XACT_PREPARE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x10</font></div><div style="line-height: 22px;"  ><font size="2"  >#define XLOG_XACT_ABORT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x20</font></div><div style="line-height: 22px;"  ><font size="2"  >#define XLOG_XACT_COMMIT_PREPARED &nbsp; &nbsp; &nbsp; 0x30</font></div><div style="line-height: 22px;"  ><font size="2"  >#define XLOG_XACT_ABORT_PREPARED &nbsp; &nbsp; &nbsp; &nbsp;0x40</font></div><div style="line-height: 22px;"  ><font size="2"  >#define XLOG_XACT_ASSIGNMENT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x50</font></div><div style="line-height: 22px;"  ><font size="2"  >#define XLOG_XACT_COMMIT_COMPACT &nbsp; &nbsp; &nbsp; &nbsp;0x60</font></div><p></p></pre></div></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >或者是一个还原点 :&nbsp;</span></div><div><pre class="prettyprint"  ><p><font size="2"  >XLOG_RESTORE_POINT</font></p></pre></div><div>也就是使用pg_create_restore_point创建的还原点.</div><div>src/include/catalog/pg_control.h</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >/* XLOG info values for XLOG rmgr */</font></div><div><font size="2"  >#define XLOG_CHECKPOINT_SHUTDOWN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x00</font></div><div><font size="2"  >#define XLOG_CHECKPOINT_ONLINE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x10</font></div><div><font size="2"  >#define XLOG_NOOP &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x20</font></div><div><font size="2"  >#define XLOG_NEXTOID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x30</font></div><div><font size="2"  >#define XLOG_SWITCH &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x40</font></div><div><font size="2"  >#define XLOG_BACKUP_END &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x50</font></div><div><font size="2"  >#define XLOG_PARAMETER_CHANGE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x60</font></div><div><font size="2"  >#define XLOG_RESTORE_POINT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x70</font></div><div><font size="2"  >#define XLOG_FPW_CHANGE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x80</font></div><p></p></pre></div><div><br></div></div><div>【注意】恢复PAUSE 的处理在判断recovery_target_inclusive前, 所以如果recovery.conf中使用了pause_at_recovery_target, 那么<span style="line-height: 22px;"  >recovery_target_inclusive将不起作用.</span></div><div>src/backend/access/transam/xlog.c</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Have we reached our recovery target?</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (recoveryStopsHere(record, &amp;recoveryApply))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (recoveryPauseAtTarget)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SetRecoveryPause(true);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; recoveryPausesHere();</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reachedStopPoint = true; &nbsp; &nbsp; &nbsp; &nbsp;/* see below */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; recoveryContinue = false;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Exit loop if we reached non-inclusive recovery target */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!recoveryApply)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div><div>下面以PostgreSQL 9.2.1为例, 来解释一下停止点的含义.</div><div><br></div><div>测试环境 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >$PGDATA=/data05/ocz/pg_root</font></div><div><font size="2"  >backupdir=/data05/ocz/pgbak</font></div><div><font size="2"  >archdir=/data05/ocz/pgbak/arch</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgresql.conf</font></div><div><font size="2"  >wal_level = hot_standby</font></div><div><font size="2"  >archive_mode = on</font></div><div><font size="2"  >archive_command = 'cp %p /data05/ocz/pgbak/arch/%f'</font></div><div><font size="2"  >hot_standby = on</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >recovery.conf</font></div><div><font size="2"  >restore_command = 'cp /data05/ocz/pgbak/arch/%f %p'</font></div><div><font size="2"  >#recovery_target_name = ''</font></div><div><font size="2"  >#recovery_target_time = '' &nbsp; &nbsp; &nbsp;# e.g. '2004-07-14 22:39:00 EST'</font></div><div><font size="2"  >#recovery_target_xid = '1687'</font></div><div><font size="2"  >#recovery_target_inclusive = true  # 默认true</font></div><div><font size="2"  >recovery_target_timeline = 'latest'</font></div><div><font size="2"  >pause_at_recovery_target = true</font></div><div><font size="2"  >standby_mode = on</font></div><p></p></pre></div><div><br></div><div>1.&nbsp;</div><div>基础备份, 将$PGDATA拷贝到<span style="line-height: 22px;"  >/data05/ocz/pgbak/pg_root</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >select pg_start_backup(now()::text);</font></div><div><font size="2"  >cp -r $PGDATA&nbsp;<span style="line-height: 22px;"  >/data05/ocz/pgbak/pg_root</span></font></div><div><font size="2"  >select&nbsp;pg_stop_backup();</font></div><p></p></pre></div><div><br></div><div>2.&nbsp;</div><div>创建测试表 :&nbsp;</div><div><div>测试表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create table a(id int, crt_time timestamp);</font></div><div><font size="2"  >create table b(id int, crt_time timestamp);</font></div><div><font size="2"  >create table c(id int, crt_time timestamp);</font></div><p></p></pre></div></div><div><br></div><div>3.&nbsp;</div><div>请按顺序执行以下SQL, 注意每一个PITR恢复停止点.&nbsp;</div><div>一个长事务在执行过程中, 可能已经有几个新的事务执行并提交了.&nbsp;</div><div>根据恢复停止点的概念, 恢复到一个小的XID, 数据库打开的时候, 可能已经到了大的xid. 原因就是如此.</div><div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# begin;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >postgres=# insert into a (id, crt_time) values (1, clock_timestamp()) returning id,crt_time;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:30:44.091741</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >INSERT 0 1</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >SESSION B :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# begin;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >postgres=# insert into b (id, crt_time) values (1, clock_timestamp()) returning id,crt_time;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+---------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:31:05.93215</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >INSERT 0 1</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >SESSION A :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# insert into a (id, crt_time) values (2, clock_timestamp()) returning id,crt_time;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+---------------------------</font></div><div><font size="2"  >&nbsp; 2 | 2013-02-04 15:31:19.57222</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >INSERT 0 1</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >SESSION C :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# begin;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >postgres=# insert into c (id, crt_time) values (1, clock_timestamp()) returning id,crt_time;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:31:34.491555</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >INSERT 0 1</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >SESSION D :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select pg_create_restore_point('test1');</font></div><div><font size="2"  >&nbsp;pg_create_restore_point&nbsp;</font></div><div><font size="2"  >-------------------------</font></div><div><font size="2"  >&nbsp;0/50026C8</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >-- 本例的第1个还原点</font><span style="line-height: 19px; font-size: small; font-family: Arial, Helvetica, sans-serif;"  >. (</span><font face="Arial, Helvetica, sans-serif"  size="2"  ><span style="line-height: 19px;"  >recovery_target_name='test1'</span></font><span style="line-height: 19px; font-family: Arial, Helvetica, sans-serif; font-size: small;"  >)</span></div><div><font size="2"  >select * from a;</font></div><div><font size="2"  >select * from b;</font></div><div><font size="2"  >select * from c;</font></div><div><font size="2"  >-- 无数据.</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >SESSION A :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# insert into a (id, crt_time) values (3, clock_timestamp()) returning id,crt_time;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 3 | 2013-02-04 15:32:00.226317</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >INSERT 0 1</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >SESSION C :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# insert into c (id, crt_time) values (2, clock_timestamp()) returning id,crt_time;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 2 | 2013-02-04 15:32:19.168515</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >postgres=# select txid_current();</font></div><div><font size="2"  >&nbsp;txid_current&nbsp;</font></div><div><font size="2"  >--------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1696</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# commit;</font></div><div><font size="2"  >COMMIT</font></div><div><span style="font-size: small; line-height: 19px;"  >-- 本例的第2个还原点.(</span><font size="2"  ><span style="line-height: 19px;"  >recovery_target_xid='1696'</span></font><span style="line-height: 19px; font-size: small; font-family: Arial, Helvetica, sans-serif;"  >)</span></div><div><font size="2"  >postgres=# select * from a;</font></div><div><font size="2"  >&nbsp;id | crt_time&nbsp;</font></div><div><font size="2"  >----+----------</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  >postgres=# select * from b;</font></div><div><font size="2"  >&nbsp;id | crt_time&nbsp;</font></div><div><font size="2"  >----+----------</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  >postgres=# select * from c;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:31:34.491555</font></div><div><font size="2"  >&nbsp; 2 | 2013-02-04 15:32:19.168515</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >SESSION D :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><span style="line-height: 22px;"  ><font size="2"  >postgres=# select pg_create_restore_point('test2');</font></span></div><div><font size="2"  >&nbsp;pg_create_restore_point&nbsp;</font></div><div><font size="2"  >-------------------------</font></div><div><font size="2"  >&nbsp;0/5002910</font></div><div><font size="2"  >(1 row)</font></div><div><span style="font-size: small; line-height: 19px;"  >-- 本例的第3个还原点.(</span><font size="2"  ><span style="line-height: 19px;"  >recovery_target_name='test2'</span></font><span style="line-height: 19px; font-size: small; font-family: Arial, Helvetica, sans-serif;"  >)</span></div><div><font size="2"  >postgres=# select * from a;</font></div><div><font size="2"  >&nbsp;id | crt_time&nbsp;</font></div><div><font size="2"  >----+----------</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  >postgres=# select * from b;</font></div><div><font size="2"  >&nbsp;id | crt_time&nbsp;</font></div><div><font size="2"  >----+----------</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  >postgres=# select * from c;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:31:34.491555</font></div><div><font size="2"  >&nbsp; 2 | 2013-02-04 15:32:19.168515</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >SESSION B :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select txid_current();</font></div><div><font size="2"  >&nbsp;txid_current&nbsp;</font></div><div><font size="2"  >--------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1695</font></div><div><font size="2"  >(1 row)</font></div><div><span style="line-height: 22px;"  ><font size="2"  >postgres=# commit;</font></span></div><div><font size="2"  >COMMIT</font></div><div><span style="font-size: small; line-height: 19px;"  >-- 本例的第4个还原点.(</span><font size="2"  ><span style="line-height: 19px;"  >recovery_target_xid='1695'</span></font><span style="line-height: 19px; font-size: small; font-family: Arial, Helvetica, sans-serif;"  >)</span></div><div><font size="2"  >postgres=# select * from a;</font></div><div><font size="2"  >&nbsp;id | crt_time&nbsp;</font></div><div><font size="2"  >----+----------</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  >postgres=# select * from b;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+---------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:31:05.93215</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select * from c;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:31:34.491555</font></div><div><font size="2"  >&nbsp; 2 | 2013-02-04 15:32:19.168515</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >SESSION A :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# insert into a (id, crt_time) values (4, clock_timestamp()) returning id,crt_time;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 4 | 2013-02-04 15:34:35.589298</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >postgres=# select txid_current();</font></div><div><font size="2"  >&nbsp;txid_current&nbsp;</font></div><div><font size="2"  >--------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1694</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# commit;</font></div><div><font size="2"  >COMMIT</font></div><div><span style="font-size: small; line-height: 19px;"  >-- 本例的第5个还原点.(</span><font size="2"  ><span style="line-height: 19px;"  >recovery_target_xid='1694'</span></font><span style="line-height: 19px; font-size: small; font-family: Arial, Helvetica, sans-serif;"  >)</span></div><div><font size="2"  >postgres=# select * from a;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:30:44.091741</font></div><div><font size="2"  >&nbsp; 2 | 2013-02-04 15:31:19.57222</font></div><div><font size="2"  >&nbsp; 3 | 2013-02-04 15:32:00.226317</font></div><div><font size="2"  >&nbsp; 4 | 2013-02-04 15:34:35.589298</font></div><div><font size="2"  >(4 rows)</font></div><div><font size="2"  >postgres=# select * from b;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+---------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:31:05.93215</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select * from c;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:31:34.491555</font></div><div><font size="2"  >&nbsp; 2 | 2013-02-04 15:32:19.168515</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >SESSION B :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# begin;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >postgres=# insert into b (id, crt_time) values (2, clock_timestamp()) returning id,crt_time;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 2 | 2013-02-04 15:35:02.348599</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >INSERT 0 1</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >SESSION C :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# begin;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >postgres=# insert into c (id, crt_time) values (3, clock_timestamp()) returning id,crt_time;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 3 | 2013-02-04 15:35:18.284565</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >postgres=# select txid_current();</font></div><div><font size="2"  >&nbsp;txid_current&nbsp;</font></div><div><font size="2"  >--------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1698</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# commit;</font></div><div><font size="2"  >COMMIT</font></div><div><span style="font-size: small; line-height: 19px;"  >-- 本例的第6个还原点.(</span><font size="2"  ><span style="line-height: 19px;"  >recovery_target_xid='1698'</span></font><span style="line-height: 19px; font-size: small; font-family: Arial, Helvetica, sans-serif;"  >)</span></div><div><font size="2"  >postgres=# select * from a;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:30:44.091741</font></div><div><font size="2"  >&nbsp; 2 | 2013-02-04 15:31:19.57222</font></div><div><font size="2"  >&nbsp; 3 | 2013-02-04 15:32:00.226317</font></div><div><font size="2"  >&nbsp; 4 | 2013-02-04 15:34:35.589298</font></div><div><font size="2"  >(4 rows)</font></div><div><font size="2"  >postgres=# select * from b;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+---------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:31:05.93215</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select * from c;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:31:34.491555</font></div><div><font size="2"  >&nbsp; 2 | 2013-02-04 15:32:19.168515</font></div><div><font size="2"  >&nbsp; 3 | 2013-02-04 15:35:18.284565</font></div><div><font size="2"  >(3 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >SESSION B :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select txid_current();</font></div><div><font size="2"  >&nbsp;txid_current&nbsp;</font></div><div><font size="2"  >--------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1697</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# rollback;</font></div><div><font size="2"  >ROLLBACK</font></div><div><span style="font-size: small; line-height: 19px;"  >-- 本例的第7个还原点.(</span><font size="2"  ><span style="line-height: 19px;"  >recovery_target_xid='1697'</span></font><span style="line-height: 19px; font-size: small; font-family: Arial, Helvetica, sans-serif;"  >)</span></div><div><font size="2"  >postgres=# select * from a;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:30:44.091741</font></div><div><font size="2"  >&nbsp; 2 | 2013-02-04 15:31:19.57222</font></div><div><font size="2"  >&nbsp; 3 | 2013-02-04 15:32:00.226317</font></div><div><font size="2"  >&nbsp; 4 | 2013-02-04 15:34:35.589298</font></div><div><font size="2"  >(4 rows)</font></div><div><font size="2"  >postgres=# select * from b;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+---------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:31:05.93215</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select * from c;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:31:34.491555</font></div><div><font size="2"  >&nbsp; 2 | 2013-02-04 15:32:19.168515</font></div><div><font size="2"  >&nbsp; 3 | 2013-02-04 15:35:18.284565</font></div><div><font size="2"  >(3 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >SESSION E :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# checkpoint;</font></div><div><font size="2"  >select pg_switch_xlog();</font></div><div><font size="2"  >checkpoint;</font></div><div><font size="2"  >select pg_switch_xlog();CHECKPOINT</font></div><div><font size="2"  >postgres=# select pg_switch_xlog();</font></div><div><font size="2"  >&nbsp;pg_switch_xlog&nbsp;</font></div><div><font size="2"  >----------------</font></div><div><font size="2"  >&nbsp;0/5002CB0</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# checkpoint;</font></div><div><font size="2"  >CHECKPOINT</font></div><div><font size="2"  >postgres=# select pg_switch_xlog();</font></div><div><font size="2"  >&nbsp;pg_switch_xlog&nbsp;</font></div><div><font size="2"  >----------------</font></div><div><font size="2"  >&nbsp;0/60000D8</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div></div><div><br></div><div><div>4.&nbsp;</div><div>关闭数据库 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; pg_ctl stop -m fast</font></div><div><font size="2"  >waiting for server to shut down.... done</font></div><div><font size="2"  >server stopped</font></div><p></p></pre></div></div><div><br></div><div>5.&nbsp;</div><div>【还原测试】 :&nbsp;</div><div>【注意】</div><div>1. 每测试1个还原点后, 测试下一个还原点时重新从基础备份开始.&nbsp;</div><div>2. 还原前修改postgresql.conf的<span style="line-height: 22px;"  >archive_command. 以免启动数据库后覆盖以前的arch.</span></div><div><pre class="prettyprint"  ><p><font size="2"  >archive_command = 'cp %p /data05/ocz/pgbak/archnew/%f'</font></p></pre></div><div><br></div><div>【1】</div><div>还原到第1个还原点,&nbsp;<span style="line-height: 22px;"  >recovery_target_name='test1',</span></div><div><span style="line-height: 22px;"  >recovery_target_inclusive对于还原目标是restore name的无效, 这个在上一篇BLOG中已经讲过了.</span></div><div><pre class="prettyprint"  ><p></p><div><span style="line-height: 22px;"  ><font size="2"  >recovery.conf</font></span></div><div><div><font size="2"  >restore_command = 'cp /data05/ocz/pgbak/arch/%f %p'</font></div><div><font size="2"  >recovery_target_name = 'test1'</font></div><div><font size="2"  >recovery_target_timeline = 'latest'</font></div><div><font size="2"  >pause_at_recovery_target = false</font></div></div><div><span style="line-height: 22px;"  ><font size="2"  >启动后</font></span></div><div><div><span style="line-height: 22px;"  ><font size="2"  >postgres=# create extension pageinspect;</font></span></div><div><font size="2"  >CREATE EXTENSION</font></div><div><font size="2"  >能看到么?<br>postgres=# select * from a;<br> id | crt_time <br>----+----------<br>(0 rows)<br>postgres=# select * from b;<br> id | crt_time <br>----+----------<br>(0 rows)<br>postgres=# select * from c;<br> id | crt_time <br>----+----------<br>(0 rows)</font></div><div><font size="2"  >-- 使用pageinspect可以看到tuple哦!</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('a',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(2 rows)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('b',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1695 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('c',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(1 row)</font></div></div><div><span style="line-height: 19px; font-size: small; font-family: Arial, Helvetica, sans-serif;"  >为什么查看不到呢?</span></div><div><font size="2"  >解释t_infomask :&nbsp;</font></div><div><font size="2"  >2560 = 0x0A00 由如下mask组成 :&nbsp;</font></div><div><p></p><div><font size="2"  >#define HEAP_XMIN_INVALID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0200 &nbsp;/* t_xmin invalid/aborted */</font></div><div><font size="2"  >#define HEAP_XMAX_INVALID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0800 &nbsp;/* t_xmax invalid/aborted */</font></div><p></p></div><div><font size="2"  >因为xmin 和xmax invalid的掩码都被设置了, 所以处理这些记录的事务还未提交或者已经abort. 当然是看不到的.</font></div><div><font size="2"  >解释t_xmin :&nbsp;</font></div><div><font size="2"  >就是插入这些记录的事务号. 在本例中已经使用txid_current显示出来, 大家可以对照去理解。</font></div><div><font size="2"  ><span style="line-height: 19px;"  >如果是已提交的事务, 应该有这两个标记之一 : </span></font></div><div><font size="2"  >#define HEAP_XMIN_COMMITTED             0x0100  /* t_xmin committed */<br>#define HEAP_XMAX_COMMITTED             0x0400  /* t_xmax committed */</font></div><p></p></pre></div><div><br></div><div>【2】</div><div><span style="line-height: 22px;"  >还原到第2个还原点,&nbsp;</span><span style="line-height: 22px;"  >recovery_target_inclusive = false</span></div><div><div><pre class="prettyprint"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  >recovery.conf</font></div><div style="line-height: 22px;"  ><font size="2"  >restore_command = 'cp /data05/ocz/pgbak/arch/%f %p'</font></div><div style="line-height: 22px;"  ><font size="2"  >recovery_target_xid = '1696'</font></div><div style="line-height: 22px;"  ><font size="2"  >recovery_target_inclusive = false</font></div><div style="line-height: 22px;"  ><font size="2"  >recovery_target_timeline = 'latest'</font></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  >pause_at_recovery_target = false</font></span></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  >启动后</font></span></div><div><div style="line-height: 22px;"  ><font size="2"  >postgres=# create extension pageinspect;</font></div><div style="line-height: 22px;"  ><font size="2"  >CREATE EXTENSION</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('a',0));<br> lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid <br>----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------<br>  1 |   8152 |        1 |     40 |   1694 |      0 |        0 | (0,1)  |           2 |       2048 |     24 |        |      <br>  2 |   8112 |        1 |     40 |   1694 |      0 |        0 | (0,2)  |           2 |       2048 |     24 |        |      <br>  3 |   8072 |        1 |     40 |   1694 |      0 |        0 | (0,3)  |           2 |       2048 |     24 |        |      <br>(3 rows)<br>postgres=# select * from heap_page_items(get_raw_page('b',0));<br> lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid <br>----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------<br>  1 |   8152 |        1 |     40 |   1695 |      0 |        0 | (0,1)  |           2 |       2048 |     24 |        |      <br>(1 row)<br>postgres=# select * from heap_page_items(get_raw_page('c',0));<br> lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid <br>----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------<br>  1 |   8152 |        1 |     40 |   1696 |      0 |        0 | (0,1)  |           2 |       2048 |     24 |        |      <br>  2 |   8112 |        1 |     40 |   1696 |      0 |        1 | (0,2)  |           2 |       2048 |     24 |        |      <br>(2 rows)</font></div><div><font size="2"  >-- 注意这里的t_infomask是, 2048 = 0x0800</font></div><div><font size="2"  >-- 也就是标记了<span style="line-height: 19px;"  >HEAP_XMAX_INVALID, 但是未标记HEAP_XMIN_INVALID以及HEAP_XMIN_COMMITTED, 所以还是不可见的.</span></font></div><div><font size="2"  >postgres=# select * from a;<br> id | crt_time <br>----+----------<br>(0 rows)<br>postgres=# select * from b;<br> id | crt_time <br>----+----------<br>(0 rows)<br>postgres=# select * from c;<br> id | crt_time <br>----+----------<br>(0 rows)</font></div><div><font size="2"  >-- 查询数据后, 再通过pageinspect检索, t_infomask信息已经变更成2560了.</font></div><div><font size="2"  >-- 具体原因可参考<span style="line-height: 19px;"  >tqual.c</span></font></div><div style="line-height: 22px;"  ><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('a',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 3 | &nbsp; 8072 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,3) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(3 rows)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('b',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1695 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('c',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;1 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(2 rows)</font></div></div><div style="line-height: 22px;"  ><font size="2"  >与还原点1相比, 多了几条记录, t_infomask=2560.&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  >虽然第二个还原点是在commit后的, 但是因为<span style="line-height: 22px;"  >recovery_target_inclusive = false, 所以apply xlogrecdata时, 将忽略这个data.&nbsp;</span></font></div></div><p style="line-height: 22px;"  ></p></pre></div><div>【3】</div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >还原到第2个还原点,&nbsp;</span><span style="line-height: 22px;"  >recovery_target_inclusive = true</span></div></div><div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div><div style="line-height: 22px;"  ><font size="2"  >recovery.conf</font></div><div style="line-height: 22px;"  ><font size="2"  >restore_command = 'cp /data05/ocz/pgbak/arch/%f %p'</font></div><div style="line-height: 22px;"  ><font size="2"  >recovery_target_xid = '1696'</font></div><div style="line-height: 22px;"  ><font size="2"  >recovery_target_inclusive = true</font></div><div style="line-height: 22px;"  ><font size="2"  >recovery_target_timeline = 'latest'</font></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  >pause_at_recovery_target = false</font></span></div></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  >启动后,</font></span></div><div><div><font size="2"  >postgres=# create extension pageinspect;</font></div><div><font size="2"  >CREATE EXTENSION</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('a',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 3 | &nbsp; 8072 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,3) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(3 rows)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('b',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1695 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('c',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;1 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(2 rows)</font></div><div><font size="2"  >postgres=# select * from a;</font></div><div><font size="2"  >&nbsp;id | crt_time&nbsp;</font></div><div><font size="2"  >----+----------</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  >postgres=# select * from b;</font></div><div><font size="2"  >&nbsp;id | crt_time&nbsp;</font></div><div><font size="2"  >----+----------</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  >postgres=# select * from c;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:31:34.491555</font></div><div><font size="2"  >&nbsp; 2 | 2013-02-04 15:32:19.168515</font></div><div><font size="2"  >(2 rows)</font></div><div><font size="2"  >-- 包含该XLogRecord. C已提交. 所以记录可以看到.</font></div><div><font size="2"  >-- 同样, tuple head的信息被更新, 具体查看tqual.c</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('a',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 3 | &nbsp; 8072 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,3) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(3 rows)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('b',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1695 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('c',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2304 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;1 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2304 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(2 rows)</font></div></div><p></p></pre></div></div><div style="line-height: 22px;"  >【4】</div><div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >还原到第3个还原点,&nbsp;</span><span style="line-height: 22px;"  >recovery_target_name='test2'</span></div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >recovery.conf</font></div><div><font size="2"  >restore_command = 'cp /data05/ocz/pgbak/arch/%f %p'</font></div><div><font size="2"  >recovery_target_name='test2'</font></div><div><font size="2"  >recovery_target_timeline = 'latest'</font></div><div><span style="line-height: 22px;"  ><font size="2"  >pause_at_recovery_target = false</font></span></div></div><div><span style="line-height: 22px;"  ><font size="2"  >启动后,</font></span></div><div><div><font size="2"  >postgres=# create extension pageinspect;</font></div><div><font size="2"  >CREATE EXTENSION</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('a',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 3 | &nbsp; 8072 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,3) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(3 rows)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('b',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1695 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('c',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;1 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(2 rows)</font></div><div><font size="2"  >postgres=# select * from a;</font></div><div><font size="2"  >&nbsp;id | crt_time&nbsp;</font></div><div><font size="2"  >----+----------</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  >postgres=# select * from b;</font></div><div><font size="2"  >&nbsp;id | crt_time&nbsp;</font></div><div><font size="2"  >----+----------</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  >postgres=# select * from c;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:31:34.491555</font></div><div><font size="2"  >&nbsp; 2 | 2013-02-04 15:32:19.168515</font></div><div><font size="2"  >(2 rows)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('a',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 3 | &nbsp; 8072 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,3) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(3 rows)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('b',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1695 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('c',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2304 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;1 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2304 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(2 rows)</font></div></div><p></p></pre></div><div>【5】</div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >还原到第4个还原点,&nbsp;</span><span style="line-height: 22px;"  >recovery_target_inclusive = false</span></div></div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >recovery.conf</font></div><div><font size="2"  >restore_command = 'cp /data05/ocz/pgbak/arch/%f %p'</font></div><div><font size="2"  >recovery_target_xid = '1695'</font></div><div><font size="2"  >recovery_target_inclusive = false</font></div><div><font size="2"  >recovery_target_timeline = 'latest'</font></div><div><span style="line-height: 22px;"  ><font size="2"  >pause_at_recovery_target = false</font></span></div></div><div><span style="line-height: 22px;"  ><font size="2"  >启动后,</font></span></div><div><div><font size="2"  >postgres=# create extension pageinspect;</font></div><div><font size="2"  >CREATE EXTENSION</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('a',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 3 | &nbsp; 8072 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,3) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(3 rows)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('b',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1695 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('c',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;1 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(2 rows)</font></div><div><font size="2"  >postgres=# select * from a;</font></div><div><font size="2"  >&nbsp;id | crt_time&nbsp;</font></div><div><font size="2"  >----+----------</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  >postgres=# select * from b;</font></div><div><font size="2"  >&nbsp;id | crt_time&nbsp;</font></div><div><font size="2"  >----+----------</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  >postgres=# select * from c;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:31:34.491555</font></div><div><font size="2"  >&nbsp; 2 | 2013-02-04 15:32:19.168515</font></div><div><font size="2"  >(2 rows)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('a',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 3 | &nbsp; 8072 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,3) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(3 rows)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('b',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1695 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('c',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2304 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;1 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2304 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(2 rows)</font></div></div><p></p></pre></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><br></span></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >【6】</span></div><div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >还原到第4个还原点,&nbsp;</span><span style="line-height: 22px;"  >recovery_target_inclusive = true</span></div><div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >recovery.conf</font></div><div style="line-height: 22px;"  ><font size="2"  >restore_command = 'cp /data05/ocz/pgbak/arch/%f %p'</font></div><div style="line-height: 22px;"  ><font size="2"  >recovery_target_xid = '1695'</font></div><div style="line-height: 22px;"  ><font size="2"  >recovery_target_inclusive = true</font></div><div style="line-height: 22px;"  ><font size="2"  >recovery_target_timeline = 'latest'</font></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  >pause_at_recovery_target = false</font></span></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  >启动后,</font></span></div><div><div><font size="2"  >postgres=# create extension pageinspect;</font></div><div><font size="2"  >CREATE EXTENSION</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('a',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 3 | &nbsp; 8072 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,3) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(3 rows)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('b',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1695 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('c',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;1 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(2 rows)</font></div><div><font size="2"  >postgres=# select * from a;</font></div><div><font size="2"  >&nbsp;id | crt_time&nbsp;</font></div><div><font size="2"  >----+----------</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  >postgres=# select * from b;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+---------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:31:05.93215</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select * from c;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:31:34.491555</font></div><div><font size="2"  >&nbsp; 2 | 2013-02-04 15:32:19.168515</font></div><div><font size="2"  >(2 rows)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('a',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 3 | &nbsp; 8072 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,3) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(3 rows)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('b',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1695 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2304 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('c',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2304 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;1 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2304 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(2 rows)</font></div></div><p></p></pre></div><div style="line-height: 22px;"  ><br></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >【7】</span></div></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >还原到第5个还原点,</span><span style="line-height: 22px;"  >&nbsp;</span><span style="line-height: 22px;"  >recovery_target_inclusive = false</span></div></div><div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >recovery.conf</font></div><div style="line-height: 22px;"  ><font size="2"  >restore_command = 'cp /data05/ocz/pgbak/arch/%f %p'</font></div><div style="line-height: 22px;"  ><font size="2"  >recovery_target_xid = '1694'</font></div><div style="line-height: 22px;"  ><font size="2"  >recovery_target_inclusive = false</font></div><div style="line-height: 22px;"  ><font size="2"  >recovery_target_timeline = 'latest'</font></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  >pause_at_recovery_target = false</font></span></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  >启动后,</font></span></div><div><div><font size="2"  >postgres=# create extension pageinspect;</font></div><div><font size="2"  >CREATE EXTENSION</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('a',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;1 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 3 | &nbsp; 8072 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;2 | (0,3) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 4 | &nbsp; 8032 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;3 | (0,4) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(4 rows)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('b',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1695 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('c',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;1 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(2 rows)</font></div><div><font size="2"  >postgres=# select * from a;</font></div><div><font size="2"  >&nbsp;id | crt_time&nbsp;</font></div><div><font size="2"  >----+----------</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  >postgres=# select * from b;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+---------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:31:05.93215</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select * from c;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:31:34.491555</font></div><div><font size="2"  >&nbsp; 2 | 2013-02-04 15:32:19.168515</font></div><div><font size="2"  >(2 rows)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('a',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;1 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 3 | &nbsp; 8072 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;2 | (0,3) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 4 | &nbsp; 8032 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;3 | (0,4) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2560 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(4 rows)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('b',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1695 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2304 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('c',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2304 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;1 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2304 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(2 rows)</font></div></div><p></p></pre></div></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><br></span></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >【8】</span></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >还原到第5个还原点,&nbsp;</span><span style="line-height: 22px;"  >recovery_target_inclusive = true</span></div><div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >recovery.conf</font></div><div style="line-height: 22px;"  ><font size="2"  >restore_command = 'cp /data05/ocz/pgbak/arch/%f %p'</font></div><div style="line-height: 22px;"  ><font size="2"  >recovery_target_xid = '1694'</font></div><div style="line-height: 22px;"  ><font size="2"  >recovery_target_inclusive = true</font></div><div style="line-height: 22px;"  ><font size="2"  >recovery_target_timeline = 'latest'</font></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  >pause_at_recovery_target = false</font></span></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  >启动后,</font></span></div><div><div><font size="2"  >postgres=# create extension pageinspect;</font></div><div><font size="2"  >CREATE EXTENSION</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('a',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;1 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 3 | &nbsp; 8072 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;2 | (0,3) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 4 | &nbsp; 8032 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;3 | (0,4) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(4 rows)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('b',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1695 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('c',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;1 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2048 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(2 rows)</font></div><div><font size="2"  >postgres=# select * from a;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:30:44.091741</font></div><div><font size="2"  >&nbsp; 2 | 2013-02-04 15:31:19.57222</font></div><div><font size="2"  >&nbsp; 3 | 2013-02-04 15:32:00.226317</font></div><div><font size="2"  >&nbsp; 4 | 2013-02-04 15:34:35.589298</font></div><div><font size="2"  >(4 rows)</font></div><div><font size="2"  >postgres=# select * from b;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+---------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:31:05.93215</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select * from c;</font></div><div><font size="2"  >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+----------------------------</font></div><div><font size="2"  >&nbsp; 1 | 2013-02-04 15:31:34.491555</font></div><div><font size="2"  >&nbsp; 2 | 2013-02-04 15:32:19.168515</font></div><div><font size="2"  >(2 rows)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('a',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2304 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;1 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2304 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 3 | &nbsp; 8072 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;2 | (0,3) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2304 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 4 | &nbsp; 8032 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1694 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;3 | (0,4) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2304 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(4 rows)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('b',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1695 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2304 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select * from heap_page_items(get_raw_page('c',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2304 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 40 | &nbsp; 1696 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;1 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2304 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(2 rows)</font></div></div><p></p></pre></div></div><div style="line-height: 22px;"  >【未完 - 见下一篇】</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013141100160/"  >http://blog.163.com/digoal@126/blog/static/1638770402013141100160/</a></div><div style="line-height: 22px;"  ><br></div>【参考】<div>1.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201303082942271/"  >http://blog.163.com/digoal@126/blog/static/163877040201303082942271/</a></div><div><span style="line-height: 22px;"  >2. src/include/access/xact.h</span></div><div><span style="line-height: 22px;"  >3. src/backend/access/transam/xlog.c</span></div><div><span style="line-height: 22px;"  >4. src/include/catalog/pg_control.h</span><br>5. src/backend/utils/time/tqual.c<wbr></div></div>
	</div>
</div>
</body>
</html>