<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL hll (HyperLogLog) extension for "State of The Art Cardinality Estimation Algorithm" - 1</h2>
	<h5 id="">2013-02-26 17:33:39&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020131264480325/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>【安装】</div><div>1. 下载 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="https://github.com/aggregateknowledge/postgresql-hll/archive/master.zip"   >https://github.com/aggregateknowledge/postgresql-hll/archive/master.zip</a></div><div><br></div><div>2. 修改Makefile, 指定PG_CONFIG路径</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi Makefile</font></div><div><font size="2"   >PG_CONFIG = /home/ocz/pgsql9.2.1/bin/pg_config</font></div><p></p></pre></div><div><br></div><div>3. 编译. (测试数据库版本PostgreSQL 9.2.1)</div><div>安装时有个BUG, 少包含了1个头文件. 可以通过修改hll.c来修复建后面. 已经发邮件给作者了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@db-172-16-3-150-&gt; make clean</font></div><div><font size="2"   >rm -f hll.so &nbsp; libhll.a&nbsp;</font></div><div><font size="2"   >rm -f hll.o MurmurHash3.o&nbsp;</font></div><div><font size="2"   >rm -rf -r&nbsp;</font></div><div><font size="2"   >root@db-172-16-3-150-&gt; make</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -g -fpic -fPIC -std=c99 -I. -I. -I/home/ocz/pgsql9.2.1/include/server -I/home/ocz/pgsql9.2.1/include/internal -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o hll.o hll.c</font></div><div><font size="2"   >hll.c: In function ‘hll_hashval_in’:</font></div><div><font size="2"   >hll.c:1532: error: ‘int8in’ undeclared (first use in this function)</font></div><div><font size="2"   >hll.c:1532: error: (Each undeclared identifier is reported only once</font></div><div><font size="2"   >hll.c:1532: error: for each function it appears in.)</font></div><div><font size="2"   >hll.c: In function ‘hll_hashval_out’:</font></div><div><font size="2"   >hll.c:1541: error: ‘int8out’ undeclared (first use in this function)</font></div><div><font size="2"   >make: *** [hll.o] Error 1</font></div><p></p></pre></div><div>原因是int8in和int8out未定义. 把头文件放进来就可以了.</div><div>修复如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@db-172-16-3-150-&gt; vi hll.c</font></div><div><font size="2"   >增加以下头文件信息.</font></div><div><font size="2"   >#include "utils/int8.h"</font></div><div><font size="2"   >重新编译通过 :&nbsp;</font></div><div><font size="2"   >su - root</font></div><div><font size="2"   >. /home/ocz/.bash_profile</font></div><div><font size="2"   >gmake clean</font></div><div><font size="2"   >gmake</font></div><div><font size="2"   >gmake install</font></div><p></p></pre></div><div><br></div><div>【使用】</div><div>1. 创建extension</div><div><div>ocz@db-172-16-3-150-&gt; psql digoal postgres</div><div>psql (9.2.1)</div><div>Type "help" for help.</div><div>digoal=# create extension hll;</div><div>CREATE EXTENSION</div></div><div><br></div><div>2. 新增类型, 函数, &nbsp;操作符如下.</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >CREATE TYPE hll;</font></span></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION hll_in(cstring, oid, integer)</font></div><div><font size="2"   >RETURNS hll</font></div><div><font size="2"   >AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION hll_out(hll)</font></div><div><font size="2"   >RETURNS cstring</font></div><div><font size="2"   >AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION hll_typmod_in(cstring[])</font></div><div><font size="2"   >RETURNS integer</font></div><div><font size="2"   >AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION hll_typmod_out(integer)</font></div><div><font size="2"   >RETURNS cstring</font></div><div><font size="2"   >AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION hll(hll, integer, boolean)</font></div><div><font size="2"   >RETURNS hll</font></div><div><font size="2"   >AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE TYPE hll (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; INTERNALLENGTH = variable,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; INPUT = hll_in,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; OUTPUT = hll_out,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TYPMOD_IN = hll_typmod_in,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TYPMOD_OUT = hll_typmod_out,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; STORAGE = external</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE CAST (hll AS hll) WITH FUNCTION hll(hll, integer, boolean) AS IMPLICIT;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE CAST (bytea AS hll) WITHOUT FUNCTION;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- ----------------------------------------------------------------</font></div><div><font size="2"   >-- Hashed value type</font></div><div><font size="2"   >-- ----------------------------------------------------------------</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE TYPE hll_hashval;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION hll_hashval_in(cstring, oid, integer)</font></div><div><font size="2"   >RETURNS hll_hashval</font></div><div><font size="2"   >AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION hll_hashval_out(hll_hashval)</font></div><div><font size="2"   >RETURNS cstring</font></div><div><font size="2"   >AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE TYPE hll_hashval (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; INTERNALLENGTH = 8,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PASSEDBYVALUE,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ALIGNMENT = double,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; INPUT = hll_hashval_in,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; OUTPUT = hll_hashval_out</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION hll_hashval_eq(hll_hashval, hll_hashval)</font></div><div><font size="2"   >RETURNS bool</font></div><div><font size="2"   >AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION hll_hashval_ne(hll_hashval, hll_hashval)</font></div><div><font size="2"   >RETURNS bool</font></div><div><font size="2"   >AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION hll_hashval(bigint)</font></div><div><font size="2"   >RETURNS hll_hashval</font></div><div><font size="2"   >AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION hll_hashval_int4(integer)</font></div><div><font size="2"   >RETURNS hll_hashval</font></div><div><font size="2"   >AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OPERATOR = (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LEFTARG = hll_hashval, RIGHTARG = hll_hashval,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PROCEDURE = hll_hashval_eq,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; COMMUTATOR = '=', NEGATOR = '&lt;&gt;',</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; RESTRICT = eqsel, JOIN = eqjoinsel,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; MERGES</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OPERATOR &lt;&gt; (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LEFTARG = hll_hashval, RIGHTARG = hll_hashval,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PROCEDURE = hll_hashval_ne,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; COMMUTATOR = '&lt;&gt;', NEGATOR = '=',</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; RESTRICT = neqsel, JOIN = neqjoinsel</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Only allow explicit casts.</font></div><div><font size="2"   >CREATE CAST (bigint AS hll_hashval) WITHOUT FUNCTION;</font></div><div><font size="2"   >CREATE CAST (integer AS hll_hashval) WITH FUNCTION hll_hashval_int4(integer);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- ----------------------------------------------------------------</font></div><div><font size="2"   >-- Functions</font></div><div><font size="2"   >-- ----------------------------------------------------------------</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Equality of multisets.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_eq(hll, hll)</font></div><div><font size="2"   >RETURNS bool</font></div><div><font size="2"   >AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Inequality of multisets.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_ne(hll, hll)</font></div><div><font size="2"   >RETURNS bool</font></div><div><font size="2"   >AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Cardinality of a multiset.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_cardinality(hll)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS double precision</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Union of a pair of multisets.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_union(hll, hll)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS hll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Adds an integer hash to a multiset.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_add(hll, hll_hashval)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS hll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Adds a multiset to an integer hash.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_add_rev(hll_hashval, hll)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS hll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Pretty-print a multiset.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_print(hll)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS cstring</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Create an empty multiset with parameters.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >-- NOTE - we create multiple signatures to avoid coding the defaults</font></div><div><font size="2"   >-- in this sql file. &nbsp;This allows the defaults to changed at runtime.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_empty()</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS hll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME', 'hll_empty0'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION hll_empty(integer)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS hll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME', 'hll_empty1'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION hll_empty(integer, integer)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS hll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME', 'hll_empty2'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION hll_empty(integer, integer, bigint)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS hll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME', 'hll_empty3'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION hll_empty(integer, integer, bigint, integer)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS hll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME', 'hll_empty4'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Returns the schema version of an hll.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_schema_version(hll)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS integer</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Returns the type of an hll.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_type(hll)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS integer</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Returns the log2m value of an hll.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_log2m(hll)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS integer</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Returns the register width of an hll.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_regwidth(hll)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS integer</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Returns the maximum explicit threshold of an hll.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_expthresh(hll, OUT specified bigint, OUT effective bigint)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Returns the sparse enabled value of an hll.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_sparseon(hll)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS integer</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Set output version.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_set_output_version(integer)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS integer</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Set sparse to full compressed threshold to fixed value.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_set_max_sparse(integer)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS integer</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Change the default type modifier, empty and add aggregate defaults.</font></div><div><font size="2"   >CREATE FUNCTION hll_set_defaults(IN i_log2m integer,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IN i_regwidth integer,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IN i_expthresh bigint,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IN i_sparseon integer,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;OUT o_log2m integer,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;OUT o_regwidth integer,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;OUT o_expthresh bigint,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;OUT o_sparseon integer)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- ----------------------------------------------------------------</font></div><div><font size="2"   >-- Murmur Hashing</font></div><div><font size="2"   >-- ----------------------------------------------------------------</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Hash a boolean.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_hash_boolean(boolean, integer default 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS hll_hashval</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME', 'hll_hash_1byte'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Hash a smallint.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_hash_smallint(smallint, integer default 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS hll_hashval</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME', 'hll_hash_2byte'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Hash an integer.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_hash_integer(integer, integer default 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS hll_hashval</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME', 'hll_hash_4byte'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Hash a bigint.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_hash_bigint(bigint, integer default 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS hll_hashval</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME', 'hll_hash_8byte'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Hash a byte array.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_hash_bytea(bytea, integer default 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS hll_hashval</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME', 'hll_hash_varlena'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Hash a text.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_hash_text(text, integer default 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS hll_hashval</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME', 'hll_hash_varlena'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- ----------------------------------------------------------------</font></div><div><font size="2"   >-- Operators</font></div><div><font size="2"   >-- ----------------------------------------------------------------</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OPERATOR = (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LEFTARG = hll, RIGHTARG = hll, PROCEDURE = hll_eq,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; COMMUTATOR = '=', NEGATOR = '&lt;&gt;',</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; RESTRICT = eqsel, JOIN = eqjoinsel,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; MERGES</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OPERATOR &lt;&gt; (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LEFTARG = hll, RIGHTARG = hll, PROCEDURE = hll_ne,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; COMMUTATOR = '&lt;&gt;', NEGATOR = '=',</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; RESTRICT = neqsel, JOIN = neqjoinsel</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OPERATOR || (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;LEFTARG = hll, RIGHTARG = hll, PROCEDURE = hll_union</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OPERATOR || (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;LEFTARG = hll, RIGHTARG = hll_hashval, PROCEDURE = hll_add</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OPERATOR || (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;LEFTARG = hll_hashval, RIGHTARG = hll, PROCEDURE = hll_add_rev</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OPERATOR # (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;RIGHTARG = hll, PROCEDURE = hll_cardinality</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- ----------------------------------------------------------------</font></div><div><font size="2"   >-- Aggregates</font></div><div><font size="2"   >-- ----------------------------------------------------------------</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Union aggregate transition function, first arg internal data</font></div><div><font size="2"   >-- structure, second arg is a packed multiset.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_union_trans(internal, hll)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS internal</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- NOTE - unfortunately aggregate functions don't support default</font></div><div><font size="2"   >-- arguments so we need to declare 5 signatures.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Add aggregate transition function, first arg internal data</font></div><div><font size="2"   >-- structure, second arg is a hashed value. &nbsp;Remaining args are log2n,</font></div><div><font size="2"   >-- regwidth, expthresh, sparseon.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_add_trans4(internal,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hll_hashval,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;integer,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;integer,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bigint,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;integer)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS internal</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION hll_add_trans3(internal,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hll_hashval,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;integer,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;integer,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bigint)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS internal</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION hll_add_trans2(internal,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hll_hashval,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;integer,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;integer)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS internal</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION hll_add_trans1(internal,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hll_hashval,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;integer)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS internal</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION hll_add_trans0(internal,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hll_hashval)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS internal</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Converts internal data structure into packed multiset.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_pack(internal)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS hll</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Computes cardinality of internal data structure.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_card_unpacked(internal)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS double precision</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Computes floor(cardinality) of internal data structure.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_floor_card_unpacked(internal)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS int8</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Computes ceil(cardinality) of internal data structure.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_ceil_card_unpacked(internal)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS int8</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Union aggregate function, returns hll.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE AGGREGATE hll_union_agg (hll) (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;SFUNC = hll_union_trans,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;STYPE = internal,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;FINALFUNC = hll_pack</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- NOTE - unfortunately aggregate functions don't support default</font></div><div><font size="2"   >-- arguments so we need to declare 5 signatures.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Add aggregate function, returns hll.</font></div><div><font size="2"   >CREATE AGGREGATE hll_add_agg (hll_hashval) (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;SFUNC = hll_add_trans0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;STYPE = internal,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;FINALFUNC = hll_pack</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Add aggregate function, returns hll.</font></div><div><font size="2"   >CREATE AGGREGATE hll_add_agg (hll_hashval, integer) (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;SFUNC = hll_add_trans1,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;STYPE = internal,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;FINALFUNC = hll_pack</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Add aggregate function, returns hll.</font></div><div><font size="2"   >CREATE AGGREGATE hll_add_agg (hll_hashval, integer, integer) (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;SFUNC = hll_add_trans2,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;STYPE = internal,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;FINALFUNC = hll_pack</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Add aggregate function, returns hll.</font></div><div><font size="2"   >CREATE AGGREGATE hll_add_agg (hll_hashval, integer, integer, bigint) (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;SFUNC = hll_add_trans3,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;STYPE = internal,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;FINALFUNC = hll_pack</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Add aggregate function, returns hll.</font></div><div><font size="2"   >CREATE AGGREGATE hll_add_agg (hll_hashval, integer, integer, bigint, integer) (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;SFUNC = hll_add_trans4,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;STYPE = internal,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;FINALFUNC = hll_pack</font></div><div><font size="2"   >);</font></div><p></p></pre></div><div>-- 未完待续</div><div>续1 -&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013127917876/"   >http://blog.163.com/digoal@126/blog/static/1638770402013127917876/</a></div><div>续2 -&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020131288553810/"   >http://blog.163.com/digoal@126/blog/static/16387704020131288553810/</a></div><div><br></div>【参考】<div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://tapoueh.org/blog/2013/02/25-postgresql-hyperloglog.html"   >http://tapoueh.org/blog/2013/02/25-postgresql-hyperloglog.html</a></div><div>2.&nbsp;<a target="_blank" rel="nofollow" href="http://blog.aggregateknowledge.com/2013/02/04/open-source-release-postgresql-hll/"   >http://blog.aggregateknowledge.com/2013/02/04/open-source-release-postgresql-hll/</a></div><div>3.&nbsp;<a target="_blank" rel="nofollow" href="https://github.com/aggregateknowledge/postgresql-hll"   >https://github.com/aggregateknowledge/postgresql-hll</a></div><div>4.&nbsp;<a target="_blank" rel="nofollow" href="http://blog.aggregateknowledge.com/author/wwkae/"   >http://blog.aggregateknowledge.com/author/wwkae/</a><br>5.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://algo.inria.fr/flajolet/Publications/FlFuGaMe07.pdf"   >http://algo.inria.fr/flajolet/Publications/FlFuGaMe07.pdf</a></div></div>
	</div>
</div>
</body>
</html>