<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 add postgres_fdw extension for accessing remote tables</h2>
	<h5 id="">2013-02-26 15:07:40&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201312544919858/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><a target="_blank" rel="nofollow" href="https://wiki.postgresql.org/wiki/Foreign_data_wrappers"   >https://wiki.postgresql.org/wiki/Foreign_data_wrappers</a></div><div><br></div><div>PostgreSQL 9.3新增了一个postgres_fdw模块, 已经整合在源码包中. 用于创建postgres外部表.</div><div>此前名为pgsql_fdw, pgsql_fdw未整合到contrib中, 使用方法如下.</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201231514057303/"   >http://blog.163.com/digoal@126/blog/static/163877040201231514057303/</a></div><div><br></div><div>【测试环境】</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >远程数据库 :&nbsp;</font></div><div><font size="2"   >IP : 172.16.3.150</font></div><div><font size="2"   >PORT : 9201</font></div><div><font size="2"   >version : 9.2.1</font></div><div><font size="2"   >DBNAME : digoal</font></div><div><font size="2"   >ROLE : digoal</font></div><div><font size="2"   >PASSWORD : digoal</font></div><div><font size="2"   >ENCODE : UTF8</font></div><div><font size="2"   >LOCALE = C</font></div><div><font size="2"   >-- 如下 :&nbsp;</font></div><div><div><font size="2"   >ocz@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.2.1)</font></div></div><div><div><font size="2"   >digoal=&gt; \l</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of databases</font></div><div><font size="2"   >&nbsp; &nbsp;Name &nbsp; &nbsp;| &nbsp;Owner &nbsp; | Encoding | Collate | Ctype | &nbsp; Access privileges &nbsp;&nbsp;</font></div><div><font size="2"   >-----------+----------+----------+---------+-------+-----------------------</font></div><div><font size="2"   >&nbsp;digoal &nbsp; &nbsp;| digoal &nbsp; | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; |&nbsp;</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >本地数据库 :&nbsp;</font></div><div><div style="line-height: 22px;"   ><font size="2"   >IP : 172.16.3.150</font></div><div style="line-height: 22px;"   ><font size="2"   >PORT : 9300</font></div><div style="line-height: 22px;"   ><font size="2"   >version : 9.3devel</font></div><div style="line-height: 22px;"   ><font size="2"   >DBNAME : digoal</font></div><div style="line-height: 22px;"   ><font size="2"   >ROLE : digoal</font></div></div><div><div style="line-height: 22px;"   ><font size="2"   >ENCODE : UTF8</font></div><div style="line-height: 22px;"   ><font size="2"   >LOCALE = C</font></div><div style="line-height: 22px;"   ><font size="2"   >-- 如下 :&nbsp;</font></div><div><div><font size="2"   >pgdev@db-172-16-3-150-&gt; psql digoal digoal</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >digoal=&gt; \l</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of databases</font></div><div><font size="2"   >&nbsp; &nbsp;Name &nbsp; &nbsp;| &nbsp;Owner &nbsp; | Encoding | Collate | Ctype | &nbsp; Access privileges &nbsp;&nbsp;</font></div><div><font size="2"   >-----------+----------+----------+---------+-------+-----------------------</font></div><div><font size="2"   >&nbsp;digoal &nbsp; &nbsp;| digoal &nbsp; | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; |&nbsp;</font></div></div></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >【使用举例】</span></div><div style="line-height: 22px;"   >1. 在本地数据库中创建postgres_fdw extension.</div><div><pre class="prettyprint"   ><font size="2"   ><span style="line-height: 19px;"   >digoal=&gt; \c digoal postgres<br>You are now connected to database "digoal" as user "postgres".<br></span></font><p><font size="2"   ><span style="line-height: 19px;"   >digoal=# </span>CREATE EXTENSION postgres_fdw;</font></p></pre></div><div style="line-height: 22px;"   >2. 在远程数据库上生成测试数据 :&nbsp;</div><div><pre class="prettyprint"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   >-- 自建枚举类型 :&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >CREATE TYPE user_enum AS ENUM ('foo', 'bar', 'buz');</font></div><div style="line-height: 22px;"   ><font size="2"   >-- 注意是创建在public下面的.</font></div><div><font size="2"   >digoal=&gt; \dT<br>        List of data types<br> Schema |   Name    | Description <br>--------+-----------+-------------<br> public | user_enum | <br>(1 row)</font></div><div><font size="2"   >-- 注意oid</font></div><div><font size="2"   >digoal=&gt; select oid from pg_type where typname='user_enum';<br>   oid   <br>---------<br> 3425980<br>(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   >-- schema :&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >CREATE SCHEMA digoal;</font></div><div style="line-height: 22px;"   ><font size="2"   >-- 表 :&nbsp;</font></div><div style="line-height: 22px;"   ><div><font size="2"   >CREATE TABLE digoal.test1 (</font></div><div><font size="2"   ><span>	</span>c1 int NOT NULL,</font></div><div><font size="2"   ><span>	</span>c2 int NOT NULL,</font></div><div><font size="2"   ><span>	</span>c3 text,</font></div><div><font size="2"   ><span>	</span>c4 timestamptz,</font></div><div><font size="2"   ><span>	</span>c5 timestamp,</font></div><div><font size="2"   ><span>	</span>c6 varchar(10),</font></div><div><font size="2"   ><span>	</span>c7 char(10),</font></div><div><font size="2"   ><span>	</span>c8 user_enum,</font></div><div><font size="2"   ><span>	</span>CONSTRAINT t1_pkey PRIMARY KEY (c1)</font></div><div><font size="2"   >);</font></div><div><font size="2"   >CREATE TABLE digoal.test2 (</font></div><div><font size="2"   ><span>	</span>c1 int NOT NULL,</font></div><div><font size="2"   ><span>	</span>c2 text,</font></div><div><font size="2"   ><span>	</span>CONSTRAINT t2_pkey PRIMARY KEY (c1)</font></div><div><font size="2"   >);</font></div></div><div style="line-height: 22px;"   ><font size="2"   >-- 测试数据 :&nbsp;</font></div><div style="line-height: 22px;"   ><div><font size="2"   >INSERT INTO digoal.test1</font></div><div><font size="2"   ><span>	</span>SELECT id,</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp; &nbsp; id % 10,</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp; &nbsp; to_char(id, 'FM00000'),</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp; &nbsp; '1970-01-01'::timestamptz + ((id % 100) || ' days')::interval,</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp; &nbsp; '1970-01-01'::timestamp + ((id % 100) || ' days')::interval,</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp; &nbsp; id % 10,</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp; &nbsp; id % 10,</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp; &nbsp; 'foo'::user_enum</font></div><div><font size="2"   ><span>	</span>FROM generate_series(1, 1000) id;</font></div><div><font size="2"   >INSERT INTO digoal.test2</font></div><div><font size="2"   ><span>	</span>SELECT id,</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp; &nbsp; 'AAA' || to_char(id, 'FM000')</font></div><div><font size="2"   ><span>	</span>FROM generate_series(1, 100) id;</font></div></div><div style="line-height: 22px;"   ><font size="2"   >-- 分析 :&nbsp;</font></div><div style="line-height: 22px;"   ><div><font size="2"   >ANALYZE digoal.test1;</font></div><div><font size="2"   >ANALYZE digoal.test2;</font></div></div><p style="line-height: 22px;"   ></p></pre></div><div><span style="line-height: 22px;"   >3. 在本地数据库中创建server</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-- 语法 :&nbsp;</font></div><div><div><font size="2"   >CREATE SERVER server_name [ TYPE 'server_type' ] [ VERSION 'server_version' ]</font></div><div><font size="2"   >&nbsp; &nbsp; FOREIGN DATA WRAPPER fdw_name</font></div><div><font size="2"   >&nbsp; &nbsp; [ OPTIONS ( option 'value' [, ... ] ) ]</font></div></div><div><font size="2"   >-- 创建 :&nbsp;</font></div><div><div><font size="2"   >digoal=# CREATE SERVER s1 FOREIGN DATA WRAPPER postgres_fdw;</font></div><div><font size="2"   >CREATE SERVER</font></div><div><font size="2"   >digoal=# select * from pg_foreign_server ;</font></div><div><font size="2"   >&nbsp;srvname | srvowner | srvfdw | srvtype | srvversion | srvacl | srvoptions&nbsp;</font></div><div><font size="2"   >---------+----------+--------+---------+------------+--------+------------</font></div><div><font size="2"   >&nbsp;s1 &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 10 | &nbsp;16425 | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><div><span style="line-height: 22px;"   ><font size="2"   >-- 设置SERVER 参数语法 :&nbsp;</font></span></div><div><div style="line-height: 22px;"   ><font size="2"   >Command: &nbsp; &nbsp; ALTER SERVER</font></div><div style="line-height: 22px;"   ><font size="2"   >Description: change the definition of a foreign server</font></div><div style="line-height: 22px;"   ><font size="2"   >Syntax:</font></div><div style="line-height: 22px;"   ><font size="2"   >ALTER SERVER name [ VERSION 'new_version' ]</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; [ OPTIONS ( [ ADD | SET | DROP ] option ['value'] [, ... ] ) ]</font></div><div style="line-height: 22px;"   ><font size="2"   >ALTER SERVER name OWNER TO new_owner</font></div><div style="line-height: 22px;"   ><font size="2"   >ALTER SERVER name RENAME TO new_name</font></div><div style="line-height: 22px;"   ><font size="2"   >-- 可用的server参数, 请参考 :&nbsp;</font></div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/libpq-connect.html#LIBPQ-PARAMKEYWORDS"   ><font size="2"   >http://www.postgresql.org/docs/devel/static/libpq-connect.html#LIBPQ-PARAMKEYWORDS</font></a></div></div><div><font size="2"   >-- 但是以下参数不能使用在server options中 :&nbsp;</font></div><div><div><font size="2"   >user and password (specify these for a user mapping, instead)</font></div><div><font size="2"   >client_encoding (this is automatically set from the local server encoding)</font></div><div><font size="2"   >fallback_application_name (always set to postgres_fdw)</font></div></div><div><span style="line-height: 22px;"   ><font size="2"   >-- 设置SERVER 参数(常用的是地址,端口,库名) :&nbsp;</font></span></div><div><span style="line-height: 22px;"   ><div><font size="2"   >digoal=# alter server s1 options ( add hostaddr '172.16.3.150', add port '9201', add dbname 'digoal');</font></div><div><font size="2"   >ALTER SERVER</font></div></span></div><p></p></pre></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >4. SERVER赋权 :&nbsp;</span></div><div><pre class="prettyprint"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><div><font size="2"   >digoal=# grant usage on foreign server s1 to digoal;</font></div><div><font size="2"   >GRANT</font></div></div><div><div style="line-height: 22px;"   ><font size="2"   >digoal=# select * from pg_foreign_server ;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;srvname | srvowner | srvfdw | srvtype | srvversion | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; srvacl &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;srvoptions &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >---------+----------+--------+---------+------------+-----------------------------------------+-----------------------------------</font></div><div><font size="2"   style="line-height: 22px;"   >&nbsp;s1 &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 10 | &nbsp;16425 | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {postgres=U/postgres,digoal=U/postgres} | {hostaddr=172.16.3.150,port=9201,</font><font size="2"   ><span style="line-height: 19px;"   >dbn</span></font></div><div><font size="2"   ><span style="line-height: 19px;"   >ame=digoal</span></font><font size="2"   style="line-height: 22px;"   >}</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div></div><p style="line-height: 22px;"   ></p></pre></div></div><div><span style="line-height: 22px;"   >5.&nbsp;</span><span style="line-height: 22px;"   >在本地数据库中创建</span><span style="line-height: 22px;"   >user mapping :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-- 可用options: user, password</font></div><div><font size="2"   >digoal=# CREATE USER MAPPING FOR digoal server s1 options (user 'digoal', password 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.&nbsp;</span><span style="line-height: 22px;"   >在本地数据库中创建</span><span style="line-height: 22px;"   >foreign table</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >-- 首先要创建一致的枚举类型.</font></div><div><div><font size="2"   >digoal=&gt; CREATE TYPE user_enum AS ENUM ('foo', 'bar', 'buz');</font></div><div><font size="2"   >CREATE TYPE</font></div><div><font size="2"   >digoal=&gt; \dT</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; List of data types</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; Name &nbsp; &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+-----------+-------------</font></div><div><font size="2"   >&nbsp;digoal | user_enum |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=&gt; select oid from pg_type where typname='user_enum';</font></div><div><font size="2"   >&nbsp; oid &nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;16439</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >-- 创建外部表ft1</font></div><div><font size="2"   >-- 可用的options: schema_name, table_name</font></div><div><div><font size="2"   >digoal=&gt; CREATE FOREIGN TABLE ft1 (</font></div><div><font size="2"   >digoal(&gt; c0 int,</font></div><div><font size="2"   >digoal(&gt; c1 int NOT NULL,</font></div><div><font size="2"   >digoal(&gt; c2 int NOT NULL,</font></div><div><font size="2"   >digoal(&gt; c3 text,</font></div><div><font size="2"   >digoal(&gt; c4 timestamptz,</font></div><div><font size="2"   >digoal(&gt; c5 timestamp,</font></div><div><font size="2"   >digoal(&gt; c6 varchar(10),</font></div><div><font size="2"   >digoal(&gt; c7 char(10),</font></div><div><font size="2"   >digoal(&gt; c8 user_enum</font></div><div><font size="2"   >digoal(&gt; ) SERVER s1 options(schema_name 'digoal', table_name 'test1');</font></div><div><font size="2"   >CREATE FOREIGN TABLE</font></div><div><font size="2"   >-- 注意远程表没有c0列, 所以报错</font></div><div><font size="2"   >digoal=&gt; select * from ft1 limit 1;</font></div><div><font size="2"   >ERROR: &nbsp;column "c0" does not exist</font></div><div><font size="2"   >CONTEXT: &nbsp;Remote SQL command: SELECT c0, c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1</font></div><div><font size="2"   >-- 删除ft1表的c0列.</font></div><div><font size="2"   >digoal=&gt; ALTER FOREIGN TABLE ft1 DROP COLUMN c0;</font></div><div><font size="2"   >ALTER FOREIGN TABLE</font></div><div><font size="2"   >-- 查询正常.</font></div><div><font size="2"   >digoal=&gt; select * from ft1 limit 1;</font></div><div><font size="2"   >&nbsp;c1 | c2 | &nbsp;c3 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; c5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| c6 | &nbsp; &nbsp; c7 &nbsp; &nbsp; | c8 &nbsp;</font></div><div><font size="2"   >----+----+-------+------------------------+---------------------+----+------------+-----</font></div><div><font size="2"   >&nbsp; 1 | &nbsp;1 | 00001 | 1970-01-02 00:00:00+08 | 1970-01-02 00:00:00 | 1 &nbsp;| 1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| foo</font></div><div><font size="2"   >(1 row)</font></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >-- 创建外部表ft2, 注意外部表的列顺序无所谓, 但是列名必须在远程表中已经存在.</font></span></div><div><div><font size="2"   >digoal=&gt; CREATE FOREIGN TABLE ft2 (c2 text, c1 int not null) SERVER s1 options(schema_name 'digoal', table_name 'test2');</font></div><div><font size="2"   >CREATE FOREIGN TABLE</font></div><div><font size="2"   >digoal=&gt; select * from ft2 limit 1;</font></div><div><font size="2"   >&nbsp; &nbsp;c2 &nbsp; | c1&nbsp;</font></div><div><font size="2"   >--------+----</font></div><div><font size="2"   >&nbsp;AAA001 | &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div style="line-height: 22px;"   >-- 注意上面创建外部表时, 可用的options为schema_name, table_name, use_remote_estimate(后面会测试到). 那万一列名不一致怎么处理呢?</div><div style="line-height: 22px;"   >-- 可用使用alter来修改. 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; CREATE FOREIGN TABLE ft3 (c2 text, c3 int not null) SERVER s1 options(schema_name 'digoal', table_name 'test2');</font></div><div><font size="2"   >CREATE FOREIGN TABLE</font></div><div><font size="2"   >digoal=&gt; select * from ft3 limit 1;</font></div><div><font size="2"   >ERROR: &nbsp;column "c3" does not exist</font></div><div><font size="2"   >CONTEXT: &nbsp;Remote SQL command: SELECT c2, c3 FROM digoal.test2</font></div><div><font size="2"   >由于c3列在远程表中不存在, 所以报错. 修改后正常 :&nbsp;</font></div><div><font size="2"   >digoal=&gt; alter foreign table ft3 alter column c3 options (column_name 'c1');</font></div><div><font size="2"   >ALTER FOREIGN TABLE</font></div><div><font size="2"   >digoal=&gt; select * from ft3 limit 1;</font></div><div><font size="2"   >&nbsp; &nbsp;c2 &nbsp; | c3&nbsp;</font></div><div><font size="2"   >--------+----</font></div><div><font size="2"   >&nbsp;AAA001 | &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="line-height: 22px;"   >-- 也可以在创建外部表时指定远程表的列名和本地列名映射关系, 本地表的列类型等 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; CREATE FOREIGN TABLE ft3 (c2 text, c3 int OPTIONS (column_name 'c1') not null) SERVER s1 options(schema_name 'digoal', table_name 'test2');</font></div><div><font size="2"   >CREATE FOREIGN TABLE</font></div><div><font size="2"   >digoal=&gt; select * from ft3 limit 1;</font></div><div><font size="2"   >&nbsp; &nbsp;c2 &nbsp; | c3&nbsp;</font></div><div><font size="2"   >--------+----</font></div><div><font size="2"   >&nbsp;AAA001 | &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >【其他测试】</div><div style="line-height: 22px;"   >1. 远程表中存在bytea类型</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >-- 远程表 :&nbsp;</font></div><div><div><font size="2"   >digoal=&gt; create table test3(id int,info bytea);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=&gt; insert into test3 values (1, decode(repeat(md5(clock_timestamp()::text), 3), 'base64'));</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=&gt; set bytea_output='escape';</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=&gt; select * from test3 limit 1;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----+-------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp; 1 | \327\2767\353n&lt;\337\226\236\347w\337\333\1774sn_\325\355\272s\327\035\327\2767\353n&lt;\337\226\236\347w\337\333\1774sn_\325\355\</font></div><div><font size="2"   >272s\327\035\327\2767\353n&lt;\337\226\236\347w\337\333\1774sn_\325\355\272s\327\035</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=&gt; set bytea_output='hex';</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=&gt; select * from test3 limit 1;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+-------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp; 1 | \xd7be37eb6e3cdf969ee777dfdb7f34736e5fd5edba73d71dd7be37eb6e3cdf969ee777dfdb7f34736e5fd5edba73d71dd7be37eb6e3cdf969ee777dfdb7f</font></div><div><font size="2"   >34736e5fd5edba73d71d</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >-- 外部表测试 :&nbsp;</font></div><div><div><font size="2"   >digoal=&gt; CREATE FOREIGN TABLE ft3 (id int, info bytea not null) SERVER s1 options(schema_name 'digoal', table_name 'test3');</font></div><div><font size="2"   >CREATE FOREIGN TABLE</font></div><div><font size="2"   >digoal=&gt; select * from ft3;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+-------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp; 1 | \xd7be37eb6e3cdf969ee777dfdb7f34736e5fd5edba73d71dd7be37eb6e3cdf969ee777dfdb7f34736e5fd5edba73d71dd7be37eb6e3cdf969ee777dfdb7f</font></div><div><font size="2"   >34736e5fd5edba73d71d</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=&gt; set bytea_output='escape';</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=&gt; select * from ft3;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----+-------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp; 1 | \327\2767\353n&lt;\337\226\236\347w\337\333\1774sn_\325\355\272s\327\035\327\2767\353n&lt;\337\226\236\347w\337\333\1774sn_\325\355\</font></div><div><font size="2"   >272s\327\035\327\2767\353n&lt;\337\226\236\347w\337\333\1774sn_\325\355\272s\327\035</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >2. 远程表中存在大对象large object类型.</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >-- 大对象的使用可参见 :&nbsp;</font></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020130931040444/"   ><font size="2"   >http://blog.163.com/digoal@126/blog/static/16387704020130931040444/</font></a></div><div style="line-height: 22px;"   ><font size="2"   >-- 远程表 :&nbsp;</font></div><div><div><font size="2"   >digoal=&gt; drop table test3;</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >digoal=&gt; create table test3(id int,info oid);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><font size="2"   >-- 创建插入大对象的函数.</font></div><div><div><font size="2"   >create or replace function write_lo (i_bytea bytea) returns oid as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; oid_new_lo oid;</font></div><div><font size="2"   >&nbsp; fd_new_lo int;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select lo_creat(-1) into oid_new_lo;</font></div><div><font size="2"   >&nbsp; select lo_open(oid_new_lo, 131072) into fd_new_lo;</font></div><div><font size="2"   >&nbsp; perform lowrite(fd_new_lo, i_bytea);</font></div><div><font size="2"   >&nbsp; perform lo_close(fd_new_lo);</font></div><div><font size="2"   >&nbsp; return oid_new_lo;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql;</font></div></div><div><font size="2"   >-- 创建读大对象的函数</font></div><div><div><font size="2"   >create or replace function read_lo (i_lo_oid oid, i_size int4) returns bytea as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; result bytea;</font></div><div><font size="2"   >&nbsp; fd_lo int;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select lo_open(i_lo_oid, 262144) into fd_lo;</font></div><div><font size="2"   >&nbsp; select loread(fd_lo, i_size) into result;</font></div><div><font size="2"   >&nbsp; perform lo_close(fd_lo);</font></div><div><font size="2"   >&nbsp; return result;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql;</font></div></div><div><font size="2"   >-- 插入测试数据 :&nbsp;</font></div><div><div><font size="2"   >digoal=&gt; insert into test3 values (1, write_lo(decode(repeat(md5(clock_timestamp()::text), 3), 'base64')));</font></div><div><font size="2"   >INSERT 0 1</font></div></div><div><font size="2"   >-- 读取 :&nbsp;</font></div><div><div><font size="2"   >digoal=&gt; select id,info,read_lo(info,100) from test3;</font></div><div><font size="2"   >&nbsp;id | &nbsp;info &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;read_lo &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+---------+---------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >-------------------------------</font></div><div><font size="2"   >&nbsp; 1 | 3426035 | \xf5ef767bd79d71cdb67df6b96bae5bd1eeb8dfa73de3be3af5ef767bd79d71cdb67df6b96bae5bd1eeb8dfa73de3be3af5ef767bd79d71cdb6</font></div><div><font size="2"   >7df6b96bae5bd1eeb8dfa73de3be3a</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >-- 大对象数据实际存储在pg_largeobject中</font></div><div><div><font size="2"   >digoal=&gt; \d pg_largeobject</font></div><div><font size="2"   >Table "pg_catalog.pg_largeobject"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >--------+---------+-----------</font></div><div><font size="2"   >&nbsp;loid &nbsp; | oid &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;pageno | integer | not null</font></div><div><font size="2"   >&nbsp;data &nbsp; | bytea &nbsp; |&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_largeobject_loid_pn_index" UNIQUE, btree (loid, pageno)</font></div></div><div><font size="2"   >-- 但是直接读取pg_largeobject是不允许的 :&nbsp;</font></div><div><div><font size="2"   >digoal=&gt; select * from pg_largeobject limit 1;</font></div><div><font size="2"   >ERROR: &nbsp;permission denied for relation pg_largeobject</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- 外部表测试 :&nbsp;</font></div><div><div><font size="2"   >digoal=&gt; drop foreign table ft3;</font></div><div><font size="2"   >DROP FOREIGN TABLE</font></div><div><font size="2"   >digoal=&gt; CREATE FOREIGN TABLE ft3 (id int, info oid) SERVER s1 options(schema_name 'digoal', table_name 'test3');</font></div><div><font size="2"   >CREATE FOREIGN TABLE</font></div><div><font size="2"   >digoal=&gt; select * from ft3 limit 1;</font></div><div><font size="2"   >&nbsp;id | &nbsp;info &nbsp;&nbsp;</font></div><div><font size="2"   >----+---------</font></div><div><font size="2"   >&nbsp; 1 | 3426035</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >-- 如何能读到大数据呢?</font></div><div><font size="2"   >-- 在本地数据库中创建read_lo函数, 看看能不能传递给远程数据库</font></div><div><div><font size="2"   >digoal=&gt; create or replace function read_lo (i_lo_oid oid, i_size int4) returns bytea as $$</font></div><div><font size="2"   >digoal$&gt; declare</font></div><div><font size="2"   >digoal$&gt; &nbsp; result bytea;</font></div><div><font size="2"   >digoal$&gt; &nbsp; fd_lo int;</font></div><div><font size="2"   >digoal$&gt; begin</font></div><div><font size="2"   >digoal$&gt; &nbsp; select lo_open(i_lo_oid, 262144) into fd_lo;</font></div><div><font size="2"   >digoal$&gt; &nbsp; select loread(fd_lo, i_size) into result;</font></div><div><font size="2"   >digoal$&gt; &nbsp; perform lo_close(fd_lo);</font></div><div><font size="2"   >digoal$&gt; &nbsp; return result;</font></div><div><font size="2"   >digoal$&gt; end;</font></div><div><font size="2"   >digoal$&gt; $$ language plpgsql strict immutable;</font></div><div><font size="2"   >CREATE FUNCTION</font></div></div><div><font size="2"   >-- 当然不可以, 原因是能传递给远程的只能是内建函数, 并且是immutable的. 后面会有测试.</font></div><div><div><font size="2"   >digoal=&gt; select id,info,read_lo(info,100) from ft3;</font></div><div><font size="2"   >ERROR: &nbsp;large object 3426035 does not exist</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "select lo_open(i_lo_oid, 262144)"</font></div></div><div><font size="2"   >-- 查看远程SQL, 函数read_lo没有传递给远程数据库.</font></div><div><div><font size="2"   >digoal=&gt; explain verbose select id,info,read_lo(info,100) from ft3;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on digoal.ft3 &nbsp;(cost=100.00..826.80 rows=2560 width=8)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, read_lo(info, 100)</font></div><div><font size="2"   >&nbsp; &nbsp;Remote SQL: SELECT id, info FROM digoal.test3</font></div><div><font size="2"   >(3 rows)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- 有没有其他办法呢?</font></div><div><font size="2"   >-- 一种方法是基于视图的外部表</font></div><div><font size="2"   >-- 远程视图</font></div><div><div><font size="2"   >digoal=&gt; create view v_test3 as select id,read_lo(info,100) as info from test3;</font></div><div><font size="2"   >CREATE VIEW</font></div></div><div><div><font size="2"   >digoal=&gt; \d v_test3</font></div><div><font size="2"   >&nbsp; &nbsp; View "digoal.v_test3"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >--------+---------+-----------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; | integer |&nbsp;</font></div><div><font size="2"   >&nbsp;info &nbsp; | bytea &nbsp; |&nbsp;</font></div></div><div><font size="2"   >-- 外部表 :&nbsp;</font></div><div><div><font size="2"   >digoal=&gt; CREATE FOREIGN TABLE ft3 (id int, info bytea) SERVER s1 options(schema_name 'digoal', table_name 'v_test3');</font></div><div><font size="2"   >CREATE FOREIGN TABLE</font></div><div><font size="2"   >digoal=&gt; select * from ft3 limit 1;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+-------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >-------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp; 1 | \365\357v{\327\235q\315\266}\366\271k\256[\321\356\270\337\247=\343\276:\365\357v{\327\235q\315\266}\366\271k\256[\321\356\270</font></div><div><font size="2"   >\337\247=\343\276:\365\357v{\327\235q\315\266}\366\271k\256[\321\356\270\337\247=\343\276:</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div style="line-height: 22px;"   >3. 成本评估 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >-- 外部表的统计信息需手工执行analyze进行收集. 因为autovacuum无法被触发.</font></div><div><div><font size="2"   >digoal=# select count(*) from pg_statistic where starelid='digoal.ft1'::regclass;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >-- 收集后再查看统计信息表, 已经有了统计信息.</font></div><div><div><font size="2"   >digoal=# analyze verbose digoal.ft1;</font></div><div><font size="2"   >INFO: &nbsp;analyzing "digoal.ft1"</font></div><div><font size="2"   >INFO: &nbsp;"ft1": table contains 1000 rows, 1000 rows in sample</font></div><div><font size="2"   >ANALYZE</font></div><div><font size="2"   >digoal=# select count(*) from pg_statistic where starelid='digoal.ft1'::regclass;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;8</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >-- postgres_fdw的外部表成本估算分成本地和远程两种.</font></div><div><div><font size="2"   >digoal=&gt; alter foreign table digoal.ft1 options (set use_remote_estimate 'true');</font></div><div><font size="2"   >ALTER FOREIGN TABLE</font></div><div><font size="2"   >digoal=&gt; explain analyze verbose select * from digoal.ft1 where c1=1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on digoal.ft1 &nbsp;(cost=100.00..108.29 rows=1 width=47) (actual time=0.418..0.419 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp;Remote SQL: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1 WHERE ((c1 = 1))</font></div><div><font size="2"   >&nbsp;Total runtime: 0.550 ms</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   >-- 把上面看到的Remote SQL: 放到远程数据库中执行看看成本是多少 :&nbsp;</font></div><div><div style="line-height: 22px;"   ><font size="2"   >-- 远程数据库上的analyze结果 :&nbsp;</font></div><div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; explain analyze verbose select * from digoal.test1 where c1=1;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >-----------------------------------------------------------------------------------------------------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;Index Scan using t1_pkey on digoal.test1 &nbsp;(cost=0.00..8.27 rows=1 width=47) (actual time=0.009..0.010 rows=1 loops=1)</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp;Index Cond: (test1.c1 = 1)</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;Total runtime: 0.033 ms</font></div><div style="line-height: 22px;"   ><font size="2"   >(4 rows)</font></div><div style="line-height: 22px;"   ><font size="2"   >-- 当外部表的选项<span style="line-height: 22px;"   >use_remote_estimate 为 'true'时, COST用到了远程的COST, 具体的算法如下 :&nbsp;</span></font></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >-- 外部表的成本</font></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >cost=100.00..108.29</font></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >-- 远程成本</font></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >cost=0.00..8.27</font></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >100为外部表对应的SERVER的基本成本, 不同的基数可以用来体现不同SERVER的网络好坏.</font></span></div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >远程成本是</span><span style="line-height: 22px;"   >8.27</span></font></div><div style="line-height: 22px;"   ><font size="2"   >还有0.02是什么呢?</font></div><div style="line-height: 22px;"   ><font size="2"   >其中1个是fdw_tuple_cost*rows, 另一个是cpu_tuple_cost*rows</font></div><div><span style="line-height: 22px;"   ><font size="2"   >计算公式 : total_cost =&nbsp;fdw_startup_cost + remote_total_cost + fdw_tuple_cost*rows + cpu_tuple_cost*rows</font></span></div><div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; show cpu_tuple_cost;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;cpu_tuple_cost&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >----------------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;0.01</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div></div><div style="line-height: 22px;"   ><font size="2"   >计算结果 = 100 + 8.27 + 0.01*1 + 0.01*1 = 108.29</font></div><div style="line-height: 22px;"   ><font size="2"   >fdw_tuple_cost指的是<span style="line-height: 22px;"   >外部表对应的SERVER的</span><span style="line-height: 22px;"   >获取</span><span style="line-height: 22px;"   >单条TUPLE的成本.&nbsp;</span><span style="line-height: 22px;"   >不同的数字可以用来体现不同SERVER的网络好坏.</span></font></div><div style="line-height: 22px;"   ><font size="2"   >参考 :&nbsp;</font></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >fdw_startup_cost</font></div><div><font size="2"   >This option, which can be specified for a foreign server, is a numeric value that is added to the estimated startup cost of any foreign-table scan on that server. This represents the additional overhead of establishing a connection, parsing and planning the query on the remote side, etc. The default value is 100.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >fdw_tuple_cost</font></div><div><font size="2"   >This option, which can be specified for a foreign server, is a numeric value that is used as extra cost per-tuple for foreign-table scans on that server. This represents the additional overhead of data transfer between servers. You might increase or decrease this number to reflect higher or lower network delay to the remote server. The default value is 0.01.</font></div><p></p></pre></div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >-- 修改</span><span style="line-height: 22px;"   >fdw_tuple_cost后</span></font></div><div><font size="2"   >digoal=&gt; \c digoal postgres</font></div><div><div><font size="2"   >digoal=# alter server s1 options (add fdw_tuple_cost '0.2');</font></div><div><font size="2"   >ALTER SERVER</font></div></div><div><div><font size="2"   >digoal=&gt; explain analyze verbose select * from digoal.ft1 where c1=1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on digoal.ft1 &nbsp;(cost=100.00..108.48 rows=1 width=47) (actual time=0.760..0.761 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp;Remote SQL: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1 WHERE ((c1 = 1))</font></div><div><font size="2"   >&nbsp;Total runtime: 1.051 ms</font></div><div><font size="2"   >(4 rows)</font></div></div><div><font size="2"   >-- 计算108.48 = 100 + 8.27 + 0.2*1 + 0.01*1</font></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   ><br></font></span></div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >-- 将</span><span style="line-height: 22px;"   >use_remote_estimate 改成 'false'</span></font></div></div></div><div><font size="2"   >digoal=&gt; alter foreign table digoal.ft1 options (set use_remote_estimate 'false');</font></div><div><font size="2"   >ALTER FOREIGN TABLE</font></div><div><font size="2"   >digoal=&gt; explain analyze verbose select * from digoal.ft1 where c1=1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on digoal.ft1 &nbsp;(cost=100.00..123.52 rows=1 width=47) (actual time=0.556..0.557 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp;Remote SQL: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1 WHERE ((c1 = 1))</font></div><div><font size="2"   >&nbsp;Total runtime: 0.855 ms</font></div><div><font size="2"   >(4 rows)</font></div></div><div><font size="2"   >-- 这里的成本估算用的是本地的pg_statistics中的数据.</font></div><p></p></pre></div><div><div style="line-height: 22px;"   >4. 什么操作符, 函数, 表达式可以传递给远程. 看REMOTE SQL :&nbsp;</div></div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >4.1 order by不传, OFFSET 不传, LIMIT 不传.</font></div><div><div><font size="2"   >EXPLAIN (VERBOSE, COSTS false) SELECT * FROM ft1 t1 ORDER BY t1.c3, t1.c1 OFFSET 100 LIMIT 10;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Limit</font></div><div><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Sort</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: t1.c3, t1.c1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Foreign Scan on public.ft1 t1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Remote SQL: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1</font></div><div><font size="2"   >(8 rows)</font></div></div><div><font size="2"   >4.2 操作符(对应的函数)为immutable并且为内建操作符时可以传递给远程.</font></div><div><div><font size="2"   >EXPLAIN (VERBOSE, COSTS false) SELECT * FROM ft1 t1 WHERE t1.c1 = 101 AND t1.c6 = '1' AND t1.c7 &gt;= '1';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on public.ft1 t1</font></div><div><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp;Remote SQL: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1 WHERE ((c7 &gt;= '1'::bpchar)) AND ((c1 = 101)) AND ((c6 = '1'::text))</font></div><div><font size="2"   >(3 rows)</font></div></div><div><font size="2"   >-- 详见</font></div><div><font size="2"   >WHERE clauses are not sent to the remote server unless they use only built-in data types, operators, and functions. Operators and functions in the clauses must be IMMUTABLE as well.</font></div><div><font size="2"   >-- pg_proc.provolatile</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >4.3 聚合函数, 不传递.</font></div><div><font size="2"   >-- count(*) 远程实际上查询的是select null,null,... from table;</font></div><div><div><font size="2"   >digoal=&gt; explain verbose SELECT COUNT(*) FROM ft1 t1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Aggregate &nbsp;(cost=333.50..333.51 rows=1 width=0)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: count(*)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Foreign Scan on digoal.ft1 t1 &nbsp;(cost=100.00..331.00 rows=1000 width=0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Remote SQL: SELECT NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL FROM digoal.test1</font></div><div><font size="2"   >(4 rows)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >4.4 支持自建函数, 但是函数也需要是内建并且immutable的才可以传递给远程执行.</font></div><div><div><font size="2"   >-- user-defined operator/function</font></div><div><font size="2"   >CREATE FUNCTION postgres_fdw_abs(int) RETURNS int AS $$</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >RETURN abs($1);</font></div><div><font size="2"   >END</font></div><div><font size="2"   >$$ LANGUAGE plpgsql IMMUTABLE;</font></div><div><font size="2"   >CREATE OPERATOR === (</font></div><div><font size="2"   >&nbsp; &nbsp; LEFTARG = int,</font></div><div><font size="2"   >&nbsp; &nbsp; RIGHTARG = int,</font></div><div><font size="2"   >&nbsp; &nbsp; PROCEDURE = int4eq,</font></div><div><font size="2"   >&nbsp; &nbsp; COMMUTATOR = ===,</font></div><div><font size="2"   >&nbsp; &nbsp; NEGATOR = !==</font></div><div><font size="2"   >);</font></div><div><font size="2"   >EXPLAIN (VERBOSE, COSTS false) SELECT * FROM ft1 t1 WHERE t1.c1 = postgres_fdw_abs(t1.c2);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on public.ft1 t1</font></div><div><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (t1.c1 = postgres_fdw_abs(t1.c2))</font></div><div><font size="2"   >&nbsp; &nbsp;Remote SQL: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1</font></div><div><font size="2"   >(4 rows)</font></div></div><div><div><font size="2"   >EXPLAIN (VERBOSE, COSTS false) SELECT * FROM ft1 t1 WHERE t1.c1 === t1.c2;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on public.ft1 t1</font></div><div><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (t1.c1 === t1.c2)</font></div><div><font size="2"   >&nbsp; &nbsp;Remote SQL: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >EXPLAIN (VERBOSE, COSTS false) SELECT * FROM ft1 t1 WHERE t1.c1 = abs(t1.c2);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on public.ft1 t1</font></div><div><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp;Remote SQL: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1 WHERE ((c1 = abs(c2)))</font></div><div><font size="2"   >(3 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >EXPLAIN (VERBOSE, COSTS false) SELECT * FROM ft1 t1 WHERE t1.c1 = t1.c2;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on public.ft1 t1</font></div><div><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp;Remote SQL: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1 WHERE ((c1 = c2))</font></div><div><font size="2"   >(3 rows)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >4.5 is null和is not null可以传递给远程</font></div><div><div><font size="2"   >EXPLAIN (VERBOSE, COSTS false) SELECT * FROM ft1 t1 WHERE c1 IS NULL; &nbsp; &nbsp; &nbsp; &nbsp;-- NullTest</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on public.ft1 t1</font></div><div><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp;Remote SQL: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1 WHERE ((c1 IS NULL))</font></div><div><font size="2"   >(3 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >EXPLAIN (VERBOSE, COSTS false) SELECT * FROM ft1 t1 WHERE c1 IS NOT NULL; &nbsp; &nbsp;-- NullTest</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on public.ft1 t1</font></div><div><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp;Remote SQL: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1 WHERE ((c1 IS NOT NULL))</font></div><div><font size="2"   >(3 rows)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >4.6 distinct from 可以传递给远程</font></div><div><div><font size="2"   >EXPLAIN (VERBOSE, COSTS false) SELECT * FROM ft1 t1 WHERE (c1 IS NOT NULL) IS DISTINCT FROM (c1 IS NOT NULL); -- DistinctExpr</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on public.ft1 t1</font></div><div><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp;Remote SQL: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1 WHERE (((c1 IS NOT NULL) IS DISTINCT FROM (c1 IS NOT NULL)))</font></div><div><font size="2"   >(3 rows)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >4.7 array any表达式可以传递给远程, 但是需要远程数据库支持.</font></div><div><div><font size="2"   >digoal=&gt; EXPLAIN (VERBOSE, COSTS false) SELECT * FROM ft1 t1 WHERE c1 = ANY(ARRAY[c2, 1, c1 + 0]);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on digoal.ft1 t1</font></div><div><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp;Remote SQL: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1 WHERE ((c1 = ANY (ARRAY[c2, 1, (c1 + 0)])))</font></div><div><font size="2"   >(3 rows)</font></div></div><div><div><font size="2"   >EXPLAIN (VERBOSE, COSTS false) SELECT * FROM ft1 t1 WHERE c1 = (ARRAY[c1,c2,3])[1]; -- ArrayRef</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on public.ft1 t1</font></div><div><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp;Remote SQL: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1 WHERE ((c1 = ((ARRAY[c1, c2, 3])[1])))</font></div><div><font size="2"   >(3 rows)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >4.8 自建的数据类型不可传递给远程.</font></div><div><div><font size="2"   >EXPLAIN (VERBOSE, COSTS false) SELECT * FROM ft1 t1 WHERE c8 = 'foo'; &nbsp;-- can't be sent to remote</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on public.ft1 t1</font></div><div><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (t1.c8 = 'foo'::user_enum)</font></div><div><font size="2"   >&nbsp; &nbsp;Remote SQL: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1</font></div><div><font size="2"   >(4 rows)</font></div></div><p></p></pre></div><div>5. 绑定变量,&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >generic和custom plan请参考 :&nbsp;</font></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012112452432251/"   ><font size="2"   >http://blog.163.com/digoal@126/blog/static/1638770402012112452432251/</font></a></div><div><span style="line-height: 22px;"   ><font size="2"   >-- custom plan should be chosen initially</font></span></div><div><div><font size="2"   >PREPARE st4(int) AS SELECT * FROM ft1 t1 WHERE t1.c1 = $1;</font></div><div><font size="2"   >EXPLAIN (VERBOSE, COSTS false) EXECUTE st4(1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on public.ft1 t1</font></div><div><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp;Remote SQL: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1 WHERE ((c1 = 1))</font></div><div><font size="2"   >(3 rows)</font></div><div><font size="2"   >EXPLAIN (VERBOSE, COSTS false) EXECUTE st4(1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on public.ft1 t1</font></div><div><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp;Remote SQL: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1 WHERE ((c1 = 1))</font></div><div><font size="2"   >(3 rows)</font></div><div><font size="2"   >EXPLAIN (VERBOSE, COSTS false) EXECUTE st4(1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on public.ft1 t1</font></div><div><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp;Remote SQL: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1 WHERE ((c1 = 1))</font></div><div><font size="2"   >(3 rows)</font></div><div><font size="2"   >EXPLAIN (VERBOSE, COSTS false) EXECUTE st4(1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on public.ft1 t1</font></div><div><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp;Remote SQL: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1 WHERE ((c1 = 1))</font></div><div><font size="2"   >(3 rows)</font></div><div><font size="2"   >EXPLAIN (VERBOSE, COSTS false) EXECUTE st4(1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on public.ft1 t1</font></div><div><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp;Remote SQL: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1 WHERE ((c1 = 1))</font></div><div><font size="2"   >(3 rows)</font></div><div><font size="2"   >-- once we try it enough times, should switch to generic plan</font></div><div><font size="2"   >EXPLAIN (VERBOSE, COSTS false) EXECUTE st4(1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Foreign Scan on public.ft1 t1</font></div><div><font size="2"   >&nbsp; &nbsp;Output: c1, c2, c3, c4, c5, c6, c7, c8</font></div><div><font size="2"   >&nbsp; &nbsp;Remote SQL: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1 WHERE ((c1 = $1::integer))</font></div><div><font size="2"   >(3 rows)</font></div></div><p></p></pre></div><div>6. 外部表游标的使用, 本地和远程错误不会中断外部表游标.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-- ===================================================================</font></div><div><font size="2"   >-- subtransaction</font></div><div><font size="2"   >-- &nbsp;+ local/remote error doesn't break cursor</font></div><div><font size="2"   >-- ===================================================================</font></div><div><font size="2"   >BEGIN;</font></div><div><font size="2"   >DECLARE c CURSOR FOR SELECT * FROM ft1 ORDER BY c1;</font></div><div><font size="2"   >FETCH c;</font></div><div><font size="2"   >&nbsp;c1 | c2 | &nbsp;c3 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| c6 | &nbsp; &nbsp; c7 &nbsp; &nbsp; | c8 &nbsp;</font></div><div><font size="2"   >----+----+-------+------------------------------+--------------------------+----+------------+-----</font></div><div><font size="2"   >&nbsp; 1 | &nbsp;1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1 &nbsp;| 1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| foo</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SAVEPOINT s;</font></div><div><font size="2"   >ERROR OUT; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-- ERROR</font></div><div><font size="2"   >ERROR: &nbsp;syntax error at or near "ERROR"</font></div><div><font size="2"   >LINE 1: ERROR OUT;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   >ROLLBACK TO s;</font></div><div><font size="2"   >FETCH c;</font></div><div><font size="2"   >&nbsp;c1 | c2 | &nbsp;c3 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| c6 | &nbsp; &nbsp; c7 &nbsp; &nbsp; | c8 &nbsp;</font></div><div><font size="2"   >----+----+-------+------------------------------+--------------------------+----+------------+-----</font></div><div><font size="2"   >&nbsp; 2 | &nbsp;2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2 &nbsp;| 2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| foo</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SAVEPOINT s;</font></div><div><font size="2"   >SELECT * FROM ft1 WHERE 1 / (c1 - 1) &gt; 0; &nbsp;-- ERROR</font></div><div><font size="2"   >ERROR: &nbsp;division by zero</font></div><div><font size="2"   >CONTEXT: &nbsp;Remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7, c8 FROM digoal.test1 WHERE (((1 / (c1 - 1)) &gt; 0))</font></div><div><font size="2"   >ROLLBACK TO s;</font></div><div><font size="2"   >FETCH c;</font></div><div><font size="2"   >&nbsp;c1 | c2 | &nbsp;c3 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| c6 | &nbsp; &nbsp; c7 &nbsp; &nbsp; | c8 &nbsp;</font></div><div><font size="2"   >----+----+-------+------------------------------+--------------------------+----+------------+-----</font></div><div><font size="2"   >&nbsp; 3 | &nbsp;3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3 &nbsp;| 3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| foo</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SELECT * FROM ft1 ORDER BY c1 LIMIT 1;</font></div><div><font size="2"   >&nbsp;c1 | c2 | &nbsp;c3 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| c6 | &nbsp; &nbsp; c7 &nbsp; &nbsp; | c8 &nbsp;</font></div><div><font size="2"   >----+----+-------+------------------------------+--------------------------+----+------------+-----</font></div><div><font size="2"   >&nbsp; 1 | &nbsp;1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1 &nbsp;| 1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| foo</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >COMMIT;</font></div><p></p></pre></div><div><br></div><div>【其他】</div><div>1. 本地库和远程库尽量使用一致的encoding.</div><div>2. 远程查询默认使用repeatable read隔离级别, 当本地是SERIALIZABLE事务时, 则远程也是SERIALIZABLE隔离级别. 目前不支持远程为read committed隔离级别.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >During a query that references any remote tables on a foreign server, postgres_fdw opens a transaction on the remote server if one is not already open corresponding to the current local transaction. The remote transaction is committed or aborted when the local transaction commits or aborts. Savepoints are similarly managed by creating corresponding remote savepoints.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The remote transaction uses SERIALIZABLE isolation level when the local transaction has SERIALIZABLE isolation level; otherwise it uses REPEATABLE READ isolation level. This choice ensures that if a query performs multiple table scans on the remote server, it will get snapshot-consistent results for all the scans. A consequence is that successive queries within a single transaction will see the same data from the remote server, even if concurrent updates are occurring on the remote server due to other activities. That behavior would be expected anyway if the local transaction uses SERIALIZABLE or REPEATABLE READ isolation level, but it might be surprising for a READ COMMITTED local transaction. A future PostgreSQL release might modify these rules.</font></div><p></p></pre></div><div><br></div><div>9. 连接重用, 同一个会话中, 如果再次有使用同样的user mapping和server的需求, 则不需要重建远程连接.</div><div><pre class="prettyprint"   ><p><font size="2"   >postgres_fdw establishes a connection to a foreign server during the first query that uses a foreign table associated with the foreign server. This connection is kept and re-used for subsequent queries in the same session. However, if multiple user identities (user mappings) are used to access the foreign server, a connection is established for each user mapping.</font></p></pre></div><div>参见 :&nbsp;</div><div>contrib/postgres_fdw/connection.c</div><div><br></div><div><span style="line-height: 22px;"   >【参考】</span></div><div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/libpq-connect.html#LIBPQ-PARAMKEYWORDS"   >http://www.postgresql.org/docs/devel/static/libpq-connect.html#LIBPQ-PARAMKEYWORDS</a></div><div>2.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/postgres-fdw.html"   >http://www.postgresql.org/docs/devel/static/postgres-fdw.html</a></div><div>3.&nbsp;<span style="line-height: 22px;"   >contrib/postgres_fdw/postgres_fdw.c</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Adjust costs with factors of the corresponding foreign server:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; - add cost to establish connection to both startup and total</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; - add cost to manipulate on remote, and transfer result to total</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; - add cost to manipulate tuples on local side to total</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; startup_cost += fdw_startup_cost;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; total_cost += fdw_startup_cost;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; total_cost += fdw_tuple_cost * baserel-&gt;rows;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; total_cost += cpu_tuple_cost * baserel-&gt;rows;</font></div><p></p></pre></div><div>4.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201231514057303/"   >http://blog.163.com/digoal@126/blog/static/163877040201231514057303/</a></div><div>5.&nbsp;contrib/postgres_fdw/expected/postgres_fdw.out</div>6.&nbsp;<wbr><a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012112452432251/"   >http://blog.163.com/digoal@126/blog/static/1638770402012112452432251/</a></div><div>7.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-createforeigntable.html"   >http://www.postgresql.org/docs/devel/static/sql-createforeigntable.html</a></div><div>8.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-createserver.html"   >http://www.postgresql.org/docs/devel/static/sql-createserver.html</a></div><div>9.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-createusermapping.html"   >http://www.postgresql.org/docs/devel/static/sql-createusermapping.html</a></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">jxfwinter - 2014-03-11 3:07:36</h5>
				<div>太NB了，方方面面都考虑到了，<div>用C++写与数据库打交道的逻辑实在是写烦了，不知道那些与数据库打交道的逻辑全部用plpgsql写是否可行，</div><div>像什么负载均衡算法，根据逻辑进行的数据同步都扔到数据库里去。</div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 jxfwinter - 2014-03-11 3:07:36</h5>
				<div style="width:600px;">数据库可用实现负载均衡例如plproxy, 数据同步例如londiste3 或者直接使用触发器.</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">jxfwinter 回复 德哥@Digoal - 2014-03-11 3:07:36</h5>
				<div style="width:600px;">我用的postgres_fdw实现了，<div>补充一个postgres_fdw要注意的地方，如果对外部表进程表操作，远程数据库对应的表，如果有触发器，触发器函数里的表必须带有schema，在网上搜到的。</div><div>http://www.postgresql.org/message-id/7589.1384549380@sss.pgh.pa.us</div><div><div><br></div><div>另外，您说的<span style=""  >plproxy，</span><span style=""  >londiste3</span><span style=""  >&nbsp;这些灵活吗？</span></div><div><span style=""  >比如我有一个表记录了一堆不同类型的server的信息，有图片存储服务器等等，里面有当前消耗带宽，总带宽，当前cpu占用率，</span><span style=""  >当前内存占用率，要分配各项值占用比都比较低的服务器上去，这些逻辑怎么说我也要自己写吧，</span></div><div><span style=""  >plproxy难道提供了写这些逻辑的接口？</span></div><div><span style=""  ><br></span></div><div><span style=""  >目前有</span>postgres_fdw已经感到pgsql简化了很多任务，不用我使用c++把数据倒来倒去了。</div></div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 jxfwinter - 2014-03-11 3:07:36</h5>
				<div style="width:600px;">plproxy提供了RUN接口, run到什么地方, 这个逻辑可以写在函数里面.</div>
			</div>
	</div>
</div>
</body>
</html>