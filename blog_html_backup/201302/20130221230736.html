<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL LOCK WAITING monitor script for nagios</h2>
	<h5 id="">2013-02-21 23:07:36&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013121102459107/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">数据库锁等待监控脚本.<div>提供给nagios使用 :&nbsp;</div><div>本例环境 :&nbsp;</div><div>被监控的数据库DATABASEs</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >1. 192.168.2.2 : 1921</font></div><div><font size="2"   >2. 192.168.21.3 : 1921</font></div><p></p></pre></div><div><br></div><div>监控服务器monitor server</div><div><pre class="prettyprint"   ><p><font size="2"   >192.168.100.2</font></p></pre></div><div><br></div><div>nagios 服务器</div><div><pre class="prettyprint"   ><p><font size="2"   >192.168.10.2</font></p></pre></div><div><br></div><div>首先要在被监控的数据库中创建1个超级用户, 用于查询pg_stat_activity表. 此例该用户名为digoal.</div><div><pre class="prettyprint"   ><p><font size="2"   >create role digoal superuser login connection limit 32 encrypted password 'DIGOAL';</font></p></pre></div><div><br></div><div>接下来需要配置被监控的数据库的pg_hba.conf, 允许192.168.100.2通过digoal用户访问postgres数据库.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi pg_hba.conf</font></div><div><font size="2"   >host postgres digoal 192.168.100.2/32 md5</font></div><div><font size="2"   >pg_ctl reload</font></div><p></p></pre></div><div><br></div><div>然后需要在monitor server新建<span style="line-height: 22px;"   >PGPASSFILE</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >vi /etc/.pgpass</font></span></div><div><div style="line-height: 22px;"   ><font size="2"   >*:*:postgres:digoal:DIGOAL</font></div></div><div style="line-height: 22px;"   ><font size="2"   >chmod 400 /etc/.pgpass</font></div><p></p></pre></div><div>.pgpass的owner必须改成调用nagios脚本的用户. 该用户配置在/etc/xinetd.d/nrpe.</div><div>在监控服务器上新建检测脚本 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi&nbsp;/usr/local/nagios/libexec/check_pg_lock.sh</font></div><div><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   ># 环境变量</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/opt/pgsql</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"   >export&nbsp;<span style="line-height: 22px;"   >PGPASSFILE=/etc/.pgpass</span></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create_func() {</font></div><div><font size="2"   >VER=`psql -q -t $CONN_INFO -c "select '9' from (select substr(version(),12,1) as ver) t where ver::int&gt;=9"|grep -c 9`<br>if [ $VER -ge 1 ]; then</font></div><div><font size="2"   >  IS_STDBY=`psql -q -t $CONN_INFO -c "select 'this_is_standby' as a where pg_is_in_recovery();"|grep -c this_is_standby`<br>  if [ $IS_STDBY -ge 1 ]; then<br>    return 0<br>  fi<br>fi<br><br></font></div><div><font size="2"   >echo $CONN_INFO</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >psql -q -t $CONN_INFO &lt;&lt;EOF</font></div><div><font size="2"   >create or replace function lock_wait (i_lockwait interval) returns void as \$\$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_dbip inet;</font></div><div><font size="2"   >&nbsp; v_dbport int;</font></div><div><font size="2"   >&nbsp; v_datname name;</font></div><div><font size="2"   >&nbsp; v_usename name;</font></div><div><font size="2"   >&nbsp; v_client_addr inet;</font></div><div><font size="2"   >&nbsp; v_client_port int;</font></div><div><font size="2"   >&nbsp; v_query_start timestamp with time zone;</font></div><div><font size="2"   >&nbsp; v_current_query text;</font></div><div><font size="2"   >&nbsp; v_ver text;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; set client_min_messages = notice;</font></div><div><font size="2"   >&nbsp; select substr(version(),12,3) into v_ver;</font></div><div><font size="2"   >&nbsp; select inet_server_addr() into v_dbip;</font></div><div><font size="2"   >&nbsp; select inet_server_port() into v_dbport;</font></div><div><font size="2"   >&nbsp; if v_ver &gt;= '9.2' then</font></div><div><font size="2"   >&nbsp; &nbsp; for v_datname,v_usename,v_client_addr,v_client_port,v_query_start,v_current_query in&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; select datname,usename,client_addr,client_port,query_start,query from pg_stat_activity where waiting and now()-query_start &gt; i_lockwait</font></div><div><font size="2"   >&nbsp; &nbsp; loop</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice 'dbip:%, dbport:%, datname:%, usename:%, client_addr:%, client_port:%, query_start:%, current_query:%'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; ,v_dbip,v_dbport,v_datname,v_usename,v_client_addr,v_client_port,v_query_start,v_current_query;</font></div><div><font size="2"   >&nbsp; &nbsp; end loop;</font></div><div><font size="2"   >&nbsp; &nbsp; return;</font></div><div><font size="2"   >&nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; for v_datname,v_usename,v_client_addr,v_client_port,v_query_start,v_current_query in&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; select datname,usename,client_addr,client_port,query_start,current_query from pg_stat_activity where waiting and now()-query_start &gt; i_lockwait</font></div><div><font size="2"   >&nbsp; &nbsp; loop</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice 'dbip:%, dbport:%, datname:%, usename:%, client_addr:%, client_port:%, query_start:%, current_query:%'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; ,v_dbip,v_dbport,v_datname,v_usename,v_client_addr,v_client_port,v_query_start,v_current_query;</font></div><div><font size="2"   >&nbsp; &nbsp; end loop;</font></div><div><font size="2"   >&nbsp; &nbsp; return;</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; return;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >\$\$ language plpgsql;</font></div><div><font size="2"   >EOF</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >mon() {</font></div><div><font size="2"   >VER=`psql -q -t $CONN_INFO -c "select '9' from (select substr(version(),12,1) as ver) t where ver::int&gt;=9"|grep -c 9`<br>if [ $VER -ge 1 ]; then</font></div><div><font size="2"   >  IS_STDBY=`psql -q -t $CONN_INFO -c "select 'this_is_standby' as a where pg_is_in_recovery();"|grep -c this_is_standby`<br>  if [ $IS_STDBY -ge 1 ]; then<br>    return 0<br>  fi<br>fi<br><br></font></div><div><font size="2"   >echo $CONN_INFO</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >psql -q -t $CONN_INFO -c "$SQL"</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># global result</font></div><div><font size="2"   >result=0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># set env<br>. /usr/local/nagios/etc/check_pg_env.sh</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span style="line-height: 19px;"   ># monitor<br>LOG="/tmp/check_pg_lock.log"<br>SQL="select lock_wait(interval '5 second')"<br>for i in "HZ1_CHECK_PG_LOCK_DIGOAL" "HZ2_CHECK_PG_LOCK_DIGOAL"<br>do<br>  eval CONN_INFO="$"$i<br>  create_func<br>  cnt=`mon 2&gt;&amp;1|grep -c -E "NOTICE|ERROR"`<br>  if [ $cnt -ge 1 ]; then<br>    result=2<br>    mon 2&gt;&amp;1|tee $LOG<br>  fi<br>done</span></font></div><div><br></div><div><font size="2"   ># exit global proc</font></div><div><font size="2"   >exit $result</font></div></div><p></p></pre></div><div><div><span style="line-height: 22px;"   >配置脚本权限 :&nbsp;</span></div><div><pre class="prettyprint"   ><p><font size="2"   >chmod 555&nbsp;/usr/local/nagios/libexec/check_pg_lock.sh</font></p></pre></div><div>配置连接文件 :</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi /usr/local/nagios/etc/check_pg_env.sh</font></div><div><div><font size="2"   ># CHECK_PG_LOCK env</font></div><div><font size="2"   ># 杭州某IDC</font></div><div><font size="2"   >HZ1_CHECK_PG_LOCK_DIGOAL="-h 10.1.110.40 -p 1921 -U digoal postgres"</font></div><div><font size="2"   >HZ2_CHECK_PG_LOCK_DIGOAL="-h 10.1.123.212 -p 1921 -U digoal postgres"</font></div></div><p></p></pre></div><div>修改权限:</div><div><pre class="prettyprint"   ><p><font size="2"   >chmod 444<span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >/usr/local/nagios/etc/check_pg_env.sh</span></font></p></pre></div><div><span style="line-height: 22px;"   >修改监控服务器的nagios客户端配置文件 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi /usr/local/nagios/etc/nrpe.cfg&nbsp;</font></div><div><font size="2"   >command[check_pg_lock]=/usr/local/nagios/libexec/check_pg_lock.sh</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >重启xinetd服务</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >service xinetd restart</font></div><div><font size="2"   >Stopping xinetd: [ &nbsp;OK &nbsp;]</font></div><div><font size="2"   >Starting xinetd: [ &nbsp;OK &nbsp;]</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >配置nagios服务端, 增加check_pg_lock的检测.</span></div><div><br></div><div>如果发现锁等待超时, 可以使用如下3个视图进行分析 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE VIEW lockview AS</font></div><div><font size="2"   >SELECT pid,virtualtransaction AS vxid, locktype AS lock_type,</font></div><div><font size="2"   >mode AS lock_mode,granted,</font></div><div><font size="2"   >CASE</font></div><div><font size="2"   >WHEN virtualxid IS NOT NULL AND transactionid IS NOT NULL</font></div><div><font size="2"   >THEN virtualxid||' ' || transactionid</font></div><div><font size="2"   >WHEN virtualxid::text IS NOT NULL</font></div><div><font size="2"   >THEN virtualxid</font></div><div><font size="2"   >ELSE transactionid::text</font></div><div><font size="2"   >END AS xid_lock, relname,</font></div><div><font size="2"   >page, tuple,classid,objid,objsubid</font></div><div><font size="2"   >FROM pg_locks LEFT OUTER JOIN pg_class ON (pg_locks.relation= pg_class.oid)</font></div><div><font size="2"   >WHERE -- donot showour view'slocks</font></div><div><font size="2"   >pid != pg_backend_pid()AND</font></div><div><font size="2"   >--no needtoshowself-vxid locks</font></div><div><font size="2"   >virtualtransaction IS DISTINCT FROM virtualxid</font></div><div><font size="2"   >--granted isordered earlier</font></div><div><font size="2"   >ORDER BY 1, 2,5 DESC, 6, 3,4, 7;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE VIEW lockview1 AS</font></div><div><font size="2"   >SELECT pid,vxid, lock_type,lock_mode,granted,xid_lock, relname</font></div><div><font size="2"   >FROM lockview</font></div><div><font size="2"   >--granted isordered earlier</font></div><div><font size="2"   >ORDER BY 1,2,5 DESC, 6,3,4,7;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE VIEW lockview2 AS</font></div><div><font size="2"   >SELECT pid,vxid, lock_type,page, tuple,classid,objid,objsubid</font></div><div><font size="2"   >FROM lockview</font></div><div><font size="2"   >--granted isfirst</font></div><div><font size="2"   >--add non-display columns tomatch orderingoflockview</font></div><div><font size="2"   >ORDER BY 1,2,granted DESC, vxid, xid_lock::text, 3,4,5,6,7,8;</font></div><p></p></pre></div><div><br></div><div>例如 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-digoal ~]# /usr/local/nagios/libexec/check_pg_lock.sh</font></div><div><font size="2"   >NOTICE: &nbsp;dbip:10.1.173.212, dbport:1921, datname:postgres, usename:postgres, client_addr:&lt;NULL&gt;, client_port:-1, query_start:2013-02-21 21:35:23.245022+08, current_query:update test set id=1;</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >NOTICE: &nbsp;dbip:10.1.100.40, dbport:1921, datname:android_market, usename:postgres, client_addr:&lt;NULL&gt;, client_port:-1, query_start:2013-02-21 21:30:47.899411+08, current_query:update test set id=3;</font></div><div><font size="2"   >NOTICE: &nbsp;dbip:10.1.100.40, dbport:1921, datname:android_market, usename:postgres, client_addr:&lt;NULL&gt;, client_port:-1, query_start:2013-02-21 21:31:22.157254+08, current_query:update test set id=3;</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >返回值, nagios要用到这个值判断检查状态.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-digoal ~]# echo $?</font></div><div><font size="2"   >2</font></div><p></p></pre></div></div><div><span style="line-height: 22px;"   >分析</span><span style="line-height: 22px;"   >10.1.100.40的NOTICE :&nbsp;</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >select * from lockview1 where relname='test';</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; pid &nbsp;| &nbsp; &nbsp;vxid &nbsp; &nbsp;| lock_type | &nbsp; &nbsp;lock_mode &nbsp; &nbsp; | granted | xid_lock | relname&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >-------+------------+-----------+------------------+---------+----------+---------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;12396 | 219/122462 | relation &nbsp;| RowExclusiveLock | t &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| test</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;12396 | 219/122462 | tuple &nbsp; &nbsp; | ExclusiveLock &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| test</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;21011 | 234/100082 | relation &nbsp;| RowExclusiveLock | t &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| test</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;21011 | 234/100082 | tuple &nbsp; &nbsp; | ExclusiveLock &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| test</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;27207 | 236/256259 | relation &nbsp;| RowExclusiveLock | t &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| test</font></div><div style="line-height: 22px;"   ><font size="2"   >(5 rows)</font></div><p></p></pre></div><div style="line-height: 22px;"   >从以上锁信息分析,</div><div style="line-height: 22px;"   >12396正是21011和27207等待的会话.</div><div style="line-height: 22px;"   >KILL掉即可.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select pg_terminate_backend(12396);</font></div><div><font size="2"   >&nbsp;pg_terminate_backend&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;t</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from lockview1 where relname='test';</font></div><div><font size="2"   >&nbsp; pid &nbsp;| &nbsp; &nbsp;vxid &nbsp; &nbsp;| lock_type | &nbsp; &nbsp;lock_mode &nbsp; &nbsp; | granted | xid_lock | relname&nbsp;</font></div><div><font size="2"   >-------+------------+-----------+------------------+---------+----------+---------</font></div><div><font size="2"   >&nbsp;21011 | 234/100082 | relation &nbsp;| RowExclusiveLock | t &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| test</font></div><div><font size="2"   >&nbsp;21011 | 234/100082 | tuple &nbsp; &nbsp; | ExclusiveLock &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| test</font></div><div><font size="2"   >&nbsp;27207 | 236/256259 | relation &nbsp;| RowExclusiveLock | t &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| test</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div></div><div><span style="line-height: 22px;"   >此时21011获得了tuple exclusivelock, 而27207还未获得, 它在等21011释放.</span></div><div>KILL 21011即可.</div><div><pre class="prettyprint"   ><p><font size="2"   >digoal=# select pg_terminate_backend(21011);</font></p></pre></div><div>【小结】</div><div>1. 程序BUG可能带来持有锁, 但是不释放的问题. 例如持有锁后啥都不干, 也不结束事务, 也就是pg_stat_activity.current_query看到的IDLE in transaction.</div><div>&nbsp; &nbsp; 所以数据库的锁等待超时监控显得尤为重要.</div><div>2. 由于集中监控, 可能因为网络的延时导致执行时间过长, nagios有超时机制, 容易导致不稳定.</div><div>可以考虑将监控放到crontab中, nagios调用的脚本通过检测输出日志. 分出如下两部分 :&nbsp;</div><div>crontab执行脚本 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   ># 环境变量</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/opt/pgsql</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"   >export PGPASSFILE=/etc/.pgpass</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create_func() {</font></div><div><font size="2"   >VER=`psql -q -t $CONN_INFO -c "select '9' from (select substr(version(),12,1) as ver) t where ver::int&gt;=9"|grep -c 9`</font></div><div><font size="2"   >if [ $VER -ge 1 ]; then</font></div><div><font size="2"   >&nbsp; IS_STDBY=`psql -q -t $CONN_INFO -c "select 'this_is_standby' as a where pg_is_in_recovery();"|grep -c this_is_standby`</font></div><div><font size="2"   >&nbsp; if [ $IS_STDBY -ge 1 ]; then</font></div><div><font size="2"   >&nbsp; &nbsp; return 0</font></div><div><font size="2"   >&nbsp; fi</font></div><div><font size="2"   >fi</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#DEBUG switch</font></div><div><font size="2"   >#echo $CONN_INFO</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >psql -q -t $CONN_INFO &lt;&lt;EOF</font></div><div><font size="2"   >create or replace function lock_wait (i_lockwait interval) returns void as \$\$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_dbip inet;</font></div><div><font size="2"   >&nbsp; v_dbport int;</font></div><div><font size="2"   >&nbsp; v_datname name;</font></div><div><font size="2"   >&nbsp; v_usename name;</font></div><div><font size="2"   >&nbsp; v_client_addr inet;</font></div><div><font size="2"   >&nbsp; v_client_port int;</font></div><div><font size="2"   >&nbsp; v_query_start timestamp with time zone;</font></div><div><font size="2"   >&nbsp; v_current_query text;</font></div><div><font size="2"   >&nbsp; v_ver text;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; set client_min_messages = notice;</font></div><div><font size="2"   >&nbsp; select substr(version(),12,3) into v_ver;</font></div><div><font size="2"   >&nbsp; select inet_server_addr() into v_dbip;</font></div><div><font size="2"   >&nbsp; select inet_server_port() into v_dbport;</font></div><div><font size="2"   >&nbsp; if v_ver &gt;= '9.2' then</font></div><div><font size="2"   >&nbsp; &nbsp; for v_datname,v_usename,v_client_addr,v_client_port,v_query_start,v_current_query in&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; select datname,usename,client_addr,client_port,query_start,query from pg_stat_activity where waiting and now()-query_start &gt; i_lockwait</font></div><div><font size="2"   >&nbsp; &nbsp; loop</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice 'dbip:%, dbport:%, datname:%, usename:%, client_addr:%, client_port:%, query_start:%, current_query:%'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; ,v_dbip,v_dbport,v_datname,v_usename,v_client_addr,v_client_port,v_query_start,v_current_query;</font></div><div><font size="2"   >&nbsp; &nbsp; end loop;</font></div><div><font size="2"   >&nbsp; &nbsp; return;</font></div><div><font size="2"   >&nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; for v_datname,v_usename,v_client_addr,v_client_port,v_query_start,v_current_query in&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; select datname,usename,client_addr,client_port,query_start,current_query from pg_stat_activity where waiting and now()-query_start &gt; i_lockwait</font></div><div><font size="2"   >&nbsp; &nbsp; loop</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice 'dbip:%, dbport:%, datname:%, usename:%, client_addr:%, client_port:%, query_start:%, current_query:%'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; ,v_dbip,v_dbport,v_datname,v_usename,v_client_addr,v_client_port,v_query_start,v_current_query;</font></div><div><font size="2"   >&nbsp; &nbsp; end loop;</font></div><div><font size="2"   >&nbsp; &nbsp; return;</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; return;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >\$\$ language plpgsql;</font></div><div><font size="2"   >EOF</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >mon() {</font></div><div><font size="2"   >VER=`psql -q -t $CONN_INFO -c "select '9' from (select substr(version(),12,1) as ver) t where ver::int&gt;=9"|grep -c 9`</font></div><div><font size="2"   >if [ $VER -ge 1 ]; then</font></div><div><font size="2"   >&nbsp; IS_STDBY=`psql -q -t $CONN_INFO -c "select 'this_is_standby' as a where pg_is_in_recovery();"|grep -c this_is_standby`</font></div><div><font size="2"   >&nbsp; if [ $IS_STDBY -ge 1 ]; then</font></div><div><font size="2"   >&nbsp; &nbsp; return 0</font></div><div><font size="2"   >&nbsp; fi</font></div><div><font size="2"   >fi</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#DEBUG switch</font></div><div><font size="2"   >#echo $CONN_INFO</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >psql -q -t $CONN_INFO -c "$SQL"</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># global result</font></div><div><font size="2"   >result=0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># set env</font></div><div><font size="2"   >. /usr/local/nagios/etc/check_pg_env.sh</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># monitor</font></div><div><font size="2"   >LOGFILE="/tmp/check_pg_lock.log"</font></div><div><font size="2"   >TMPLOGFILE="/tmp/check_pg_lock.log.tmp"</font></div><div><font size="2"   >SQL="select lock_wait(interval '5 second')"</font></div><div><font size="2"   ># 清除临时日志数据</font></div><div><font size="2"   >echo "" &gt;$TMPLOGFILE</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >for i in "HZ1_CHECK_PG_LOCK_DIGOAL" "HZ2_CHECK_PG_LOCK_DIGOAL"</font></div><div><font size="2"   >do</font></div><div><font size="2"   >&nbsp; eval CONN_INFO="$"$i</font></div><div><font size="2"   >&nbsp; create_func</font></div><div><font size="2"   >&nbsp; cnt=`mon 2&gt;&amp;1|grep -c -E "NOTICE|ERROR"`</font></div><div><font size="2"   >&nbsp; if [ $cnt -ge 1 ]; then</font></div><div><font size="2"   >&nbsp; &nbsp; result=2</font></div><div><font size="2"   >&nbsp; &nbsp; mon &gt;&gt;$TMPLOGFILE 2&gt;&amp;1</font></div><div><font size="2"   >&nbsp; fi</font></div><div><font size="2"   >done</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >echo -e "return 2" &gt;&gt;$TMPLOGFILE 2&gt;&amp;1</font></div><div><font size="2"   ># 替换数据</font></div><div><font size="2"   >cat $TMPLOGFILE &gt;$LOGFILE</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># exit global proc</font></div><div><font size="2"   >exit $result</font></div><p></p></pre></div><div><br></div><div>nagios脚本 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >#!/bin/bash<br># 环境变量<br>export LANG=en_US.utf8<br>export PGHOME=/opt/pgsql<br>export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib<br>export DATE=`date +"%Y%m%d%H%M"`<br>export PATH=$PGHOME/bin:$PATH:.<br>export MANPATH=$PGHOME/share/man:$MANPATH<br><br>LOGFILE=/tmp/check_pg_lock.log<br><br>CNT=`cat $LOGFILE|grep -c -E "NOTICE|ERROR"`<br>if [ $CNT -ge 1 ]; then<br>    # summary<br>    echo -e "ERROR: SQL lock timeout."<br>    cat $LOGFILE|grep -v "^\$"|awk '{print $2}'|uniq -c<br>    # detail<br>    echo -e "\nDETAIL:"<br>    cat $LOGFILE|grep -v "^\$"<br>    exit 2<br>fi<br>exit 0</span></font></div><p></p></pre></div><wbr></div><br><div>【其他】</div><div>1. 现成的监控脚本可以参考bucardo的check_postgres.pl</div><div>支持nagios, mrtg, cacti等</div><div><a target="_blank" rel="nofollow" href="http://bucardo.org/wiki/Check_postgres"   >http://bucardo.org/wiki/Check_postgres</a></div>2. csvlog监控<div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201312241028667/"   >http://blog.163.com/digoal@126/blog/static/163877040201312241028667/</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL LOCK WAITING monitor script for nagios - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>