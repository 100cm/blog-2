<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL How to deal TUPLE LOCK : 1 - "One transaction lock single or multiple tuples | rows"</h2>
	<h5 id="">2013-02-01 7:55:15&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020130312271679/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>注意, 本文基于2013-01-08到2013-01-31之间的postgresql9.3 devel分支进行的讲解.</div><div>也就是以下这个行锁补丁后的版本. 其他版本目前没有这个特性.</div><div><a target="_blank" rel="nofollow" href="https://github.com/postgres/postgres/commit/0ac5ad5134f2769ccbaefec73844f8504c4d6182"   >https://github.com/postgres/postgres/commit/0ac5ad5134f2769ccbaefec73844f8504c4d6182</a></div><div>同时昨天在写这篇BLOG的时候发现了几个BUG, 已经提交了BUG报告, 今天早上得到了修复. 如下 &nbsp;:&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=77a3082fc546774808b76f58173caec3852ebf62"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=77a3082fc546774808b76f58173caec3852ebf62</a></div><div><a target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=b78647a0e6f7b110273e98601f26d3d1db0ad931"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=b78647a0e6f7b110273e98601f26d3d1db0ad931</a></div><div>在此非常感谢 Alvaro Herrera .</div><div>所以如果你看到的是2013-01-31后修复了BUG的版本则与下面的讲解会有一些出入。</div><div>这两个BUG分别是pgrowlocks 的锁显示不正确问题以及multixact锁升级问题.</div><div>接下来就开始吧.</div><div>我们知道PostgreSQL中有一个系统视图pg_locks.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \d+ pg_locks</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;View "pg_catalog.pg_locks"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Column &nbsp; &nbsp; &nbsp; | &nbsp; Type &nbsp; | Modifiers | Storage &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------------------+----------+-----------+----------+-------------</font></div><div><font size="2"   >&nbsp;locktype &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | text &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended |&nbsp;</font></div><div><font size="2"   >&nbsp;database &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | oid &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;relation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | oid &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;page &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | integer &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;tuple &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| smallint | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;virtualxid &nbsp; &nbsp; &nbsp; &nbsp; | text &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended |&nbsp;</font></div><div><font size="2"   >&nbsp;transactionid &nbsp; &nbsp; &nbsp;| xid &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;classid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;objid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;objsubid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | smallint | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;virtualtransaction | text &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended |&nbsp;</font></div><div><font size="2"   >&nbsp;pid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| integer &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;mode &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | text &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended |&nbsp;</font></div><div><font size="2"   >&nbsp;granted &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| boolean &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;fastpath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | boolean &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >View definition:</font></div><div><font size="2"   >&nbsp;SELECT l.locktype, l.database, l.relation, l.page, l.tuple, l.virtualxid,&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; l.transactionid, l.classid, l.objid, l.objsubid, l.virtualtransaction,&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; l.pid, l.mode, l.granted, l.fastpath</font></div><div><font size="2"   >&nbsp; &nbsp;FROM pg_lock_status() l(locktype, database, relation, page, tuple, virtualxid, transactionid, classid, objid, objsubid, virtualtransaction, pid, mode, granted, fastpath);</font></div><p></p></pre></div><div>用来获取当前数据库集群中的锁信息. 详见&nbsp;<span style="line-height: 22px;"   >src/backend/utils/adt/lockfuncs.c</span></div><div>对用户级函数展现的数据结构 :&nbsp;</div><div>src/include/storage/lock.h</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* These structures hold information passed from lmgr internals to the lock</font></div><div><font size="2"   >&nbsp;* listing user-level functions (in lockfuncs.c).</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >typedef struct LockInstanceData</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LOCKTAG &nbsp; &nbsp; &nbsp; &nbsp; locktag; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* locked object */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LOCKMASK &nbsp; &nbsp; &nbsp; &nbsp;holdMask; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* locks held by this PGPROC */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LOCKMODE &nbsp; &nbsp; &nbsp; &nbsp;waitLockMode; &nbsp; /* lock awaited by this PGPROC, if any */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; BackendId &nbsp; &nbsp; &nbsp; backend; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* backend ID of this PGPROC */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LocalTransactionId lxid; &nbsp; &nbsp; &nbsp; &nbsp;/* local transaction ID of this PGPROC */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pid; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* pid of this PGPROC */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bool &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fastpath; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* taken via fastpath? */</font></div><div><font size="2"   >} LockInstanceData;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >typedef struct LockData</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nelements; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* The length of the array */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LockInstanceData *locks;</font></div><div><font size="2"   >} LockData;</font></div><p></p></pre></div><div>注意行级别的锁并不存在这些结构中, 因为一个事务可能对很多行加锁. 如果都存在内存中, 耗费非常巨大.&nbsp;</div><div>这点在以前的一篇BLOG中已经分析过, 有兴趣的朋友可以阅读 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201210134586363/"   >http://blog.163.com/digoal@126/blog/static/163877040201210134586363/</a></div><div><br></div><div>【一】、</div><div>第一个问题 : PostgreSQL How to deal TUPLE LOCK - "One transaction lock single or multiple tuples | rows"</div><div>由于PostgreSQL 9.3最近增加了2种行锁模式, 也就是说有4种行锁模式. 所以简单的提一下.&nbsp;</div><div>对于行只被1个事务加锁的情形来说, 不管是锁单行还是多行, 信息都是存储在tuple head上的.&nbsp;</div><div>PostgreSQL 9.3 对tuple的头数据中的t_infomask以及t_infomask2做了调整. 如下 :&nbsp;</div><div>src/include/access/htup_details.h</div><div>1. t_infomask :&nbsp;</div><div>老版本的t_infomask中锁信息占用了2个比特位如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#define HEAP_XMAX_EXCL_LOCK &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0040 &nbsp;/* xmax is exclusive locker */</font></div><div><font size="2"   >#define HEAP_XMAX_SHARED_LOCK &nbsp; 0x0080 &nbsp;/* xmax is shared locker */</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >注意老版本的t_infomask中0x0010未使用;</span></div><div><span style="line-height: 22px;"   >0x0010在新版本中被启用了, 用来定义key shared lock.</span></div><div><pre class="prettyprint"   ><p><span style="line-height: 19px; font-size: small;"   >#define HEAP_XMAX_KEYSHR_LOCK &nbsp; 0x0010 &nbsp;/* xmax is a key-shared locker */</span></p></pre></div><div>同时新版本对的0x0080比特位的含义重新定义如下 :&nbsp;</div><div><pre class="prettyprint"   style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMAX_EXCL_LOCK &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0040 &nbsp;/* xmax is exclusive locker */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMAX_LOCK_ONLY &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0080 &nbsp;/* xmax, if valid, is only a locker */</font></div></pre></div><div><span style="line-height: 22px;"   >由于新版本有4种行锁模式, 仅使用0x0010是不够的. 怎么办呢?&nbsp;</span></div><div><span style="line-height: 22px;"   >新版本用到了t_infomask2中的1个比特来存储key update的锁信息. 表示该记录已经被更改并且key值也被更改了, 或者该记录被删除.</span></div><div><pre class="prettyprint"   style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_KEYS_UPDATED &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x2000 &nbsp;/* tuple was updated and key cols </font><span style="line-height: 19px; font-size: small; font-family: Arial, Helvetica, sans-serif;"   >modified, or tuple deleted */</span></div></pre></div><div><span style="line-height: 22px;"   >综上所述, 新版本的shared locker和no key update信息在tuple头信息中没地方存了. 去哪了呢?&nbsp;</span></div><div><span style="line-height: 22px;"   >shared locker如下 : 如果同时定义了</span><span style="line-height: 19px; font-family: monospace; font-size: small; white-space: pre;"   >HEAP_XMAX_EXCL_LOCK | HEAP_XMAX_KEYSHR_LOCK则代表shared locker.</span></div><div><pre class="prettyprint"   ><p><font size="2"   >#define HEAP_XMAX_SHR_LOCK &nbsp; &nbsp; &nbsp;(HEAP_XMAX_EXCL_LOCK | HEAP_XMAX_KEYSHR_LOCK)</font></p></pre></div><div><span style="line-height: 22px;"   >从以上XMAX掩码注释来看, no key update在tuple头的infomask中真的找不到地方存储了.&nbsp;</span></div><div>但实际上并不是这样. 必须从掩码的设置函数来介绍 :&nbsp;</div><div><div style="line-height: 22px;"   >从函数compute_new_xmax_infomask中截取单事务设置xmax t_infomask 与 t_infomask2标记的部分代码如下.</div><div style="line-height: 22px;"   >4种行锁模式都能在TUPLE头信息中合适的设置 :</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_infomask |= HEAP_XMAX_LOCK_ONLY;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; switch (mode)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case LockTupleKeyShare:</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_xmax = add_to_xmax;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_infomask |= HEAP_XMAX_KEYSHR_LOCK;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case LockTupleShare:</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_xmax = add_to_xmax;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_infomask |= HEAP_XMAX_SHR_LOCK;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case LockTupleNoKeyExclusive:</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_xmax = add_to_xmax;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_infomask |= HEAP_XMAX_EXCL_LOCK;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case LockTupleExclusive:</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_xmax = add_to_xmax;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_infomask |= HEAP_XMAX_EXCL_LOCK;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_infomask2 |= HEAP_KEYS_UPDATED;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default:</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_xmax = InvalidTransactionId; &nbsp; &nbsp; &nbsp; &nbsp;/* silence compiler */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, "invalid lock mode");</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >单个事务对TUPLE加锁时, 首先设置<span style="line-height: 19px; font-family: monospace; white-space: pre;"   ><font size="2"   style="line-height: 19px;"   >HEAP_XMAX_LOCK_ONLY,</font></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   style="line-height: 20px;"   >no key update</font>实际上是标记的</span><span style="line-height: 19px; font-family: monospace; font-size: small; white-space: pre;"   >HEAP_XMAX_EXCL_LOCK.所以这里就能解释本文下面测试的第一个场景了.</span></div></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >获取tuple上是否加了什么锁的宏定义在</span>src/backend/access/heap/heapam.c中<span style="line-height: 22px;"   >, 其中</span><span style="line-height: 19px; font-family: monospace; font-size: small; white-space: pre;"   >HEAP_XMAX_IS_EXCL_LOCKED</span><span style="line-height: 22px;"   >&nbsp;判据不足,因为如果设置了</span><span style="line-height: 19px; font-family: monospace; font-size: small; white-space: pre;"   >HEAP_XMAX_IS_EXCL_LOCKED</span><span style="line-height: 22px;"   >&nbsp;那么</span><span style="line-height: 22px;"   >t_infomask2的</span><span style="line-height: 19px; font-family: monospace; font-size: small; white-space: pre;"   >HEAP_KEYS_UPDATED</span><span style="line-height: 22px;"   >&nbsp;也需要判断才能分出是key update还是no key update.</span></div><div><span style="line-height: 22px;"   >宏如下 :&nbsp;</span></div><div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMAX_IS_SHR_LOCKED(infomask) \</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; (((infomask) &amp; HEAP_LOCK_MASK) == HEAP_XMAX_SHR_LOCK)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMAX_IS_EXCL_LOCKED(infomask) \</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; (((infomask) &amp; HEAP_LOCK_MASK) == HEAP_XMAX_EXCL_LOCK)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMAX_IS_KEYSHR_LOCKED(infomask) \</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; (((infomask) &amp; HEAP_LOCK_MASK) == HEAP_XMAX_KEYSHR_LOCK)</font></div></pre></div></div><div style="line-height: 22px;"   >HEAP_LOCK_MASK的定义如下 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_LOCK_MASK &nbsp;(HEAP_XMAX_SHR_LOCK | HEAP_XMAX_EXCL_LOCK | \</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HEAP_XMAX_KEYSHR_LOCK)</font></div><p style="line-height: 22px;"   ></p></pre></div></div><div><span style="line-height: 22px;"   >同时pgrowlocks扩展包在单事务锁行的场景也用到了的以上这些宏来获取锁信息. 如下 :&nbsp;</span></div><div><span style="line-height: 22px;"   >显然由于判据不足, 以下代码目前存在BUG :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (infomask &amp; HEAP_XMAX_LOCK_ONLY)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (HEAP_XMAX_IS_SHR_LOCKED(infomask))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(values[Atnum_modes], NCHARS, "{For Share}");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (HEAP_XMAX_IS_KEYSHR_LOCKED(infomask))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(values[Atnum_modes], NCHARS, "{For Key Share}");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (HEAP_XMAX_IS_EXCL_LOCKED(infomask))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(values[Atnum_modes], NCHARS, "{For Update}");&nbsp;</font></div><div><font size="2"   >                                                 # 这里应该再加个infomask2的判断, </font><span style="line-height: 19px; font-size: small; font-family: Arial, Helvetica, sans-serif;"   >因为还不能定到底是key update或者no key update;&nbsp;</span></div><div><font size="2"   >                                                 # 或改成"For [no] key update"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* neither keyshare nor exclusive bit it set */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(values[Atnum_modes], NCHARS,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"{transient upgrade status}");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (tuple-&gt;t_data-&gt;t_infomask2 &amp; HEAP_KEYS_UPDATED)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(values[Atnum_modes], NCHARS, "{Key Update}");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(values[Atnum_modes], NCHARS, "{Update}");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >正因为这个BUG, 我们能看到以下第一个测试select for no key update, 使用pgrowlocks输出的确是For Update.</span></div></div><div><br></div><div>【测试】</div><div><span style="line-height: 22px;"   >1. 测试单个事务对TUPLE加for no key update锁. 并使用pgrowlocks和pageinspect查看锁信息以及t_infomask信息.</span></div><div><span style="line-height: 22px;"   ><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><div><font size="2"   >digoal=# create table test (id int, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into test values (1,'abc'),(2,'digoal');</font></div><div><font size="2"   >INSERT 0 2</font></div></span></div><div><span style="line-height: 22px;"   ><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# select * from test where id=1 for no key update;</font></div><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | abc</font></div><div><font size="2"   >(1 row)</font></div></span></div><p></p></pre></div></span></div><div><span style="line-height: 22px;"   ><div><span style="line-height: 22px;"   >SESSION B :&nbsp;</span></div><div>-- 使用pgrowlocks看到的锁模式是for update,&nbsp;<span style="line-height: 22px;"   >HEAP_XMAX_IS_MULTI未设置, 所以multi=false. 根据前面的介绍,locker就是xmax的值.</span></div></span><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pgrowlocks('test');</font></div><div><font size="2"   >&nbsp;locked_row | locker | multi | &nbsp;xids &nbsp;| &nbsp; &nbsp; modes &nbsp; &nbsp; &nbsp;| &nbsp;pids &nbsp;</font></div><div><font size="2"   >------------+--------+-------+--------+----------------+--------</font></div><div><font size="2"   >&nbsp;(0,1) &nbsp; &nbsp; &nbsp;| &nbsp; 1752 | f &nbsp; &nbsp; | {1752} | {"For Update"} | {6096}</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="line-height: 22px;"   >-- 使用pageinspect看到的信息如下.</div><div style="line-height: 22px;"   >-- xmax invalid 掩码未设置并且multixact掩码未设置时, t_xmax的内容表示锁该行事务号.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from heap_page_items(get_raw_page('test', 0));</font></div><div><font size="2"   >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"   >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"   >&nbsp; 1 | &nbsp; 8160 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 32 | &nbsp; 1751 | &nbsp; 1752 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp;450 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 2 | &nbsp; 8120 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 35 | &nbsp; 1751 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2306 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div style="line-height: 22px;"   >加锁的行lp=1 的t_infomask=450, 16进制 0x01C2 , 因此包含如下MASK :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#define HEAP_XMIN_COMMITTED &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0100 &nbsp;/* t_xmin committed */</font></div><div><div><font size="2"   >#define HEAP_XMAX_EXCL_LOCK &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0040 &nbsp;/* xmax is exclusive locker */</font></div><div><font size="2"   >#define HEAP_XMAX_LOCK_ONLY &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0080 &nbsp;/* xmax, if valid, is only a locker */</font></div></div><div><font size="2"   >#define HEAP_HASVARWIDTH &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x0002 &nbsp;/* has variable-width attribute(s) */</font></div><p></p></pre></div><div>xmax掩码信息与<span style="line-height: 22px;"   >compute_new_xmax_infomask函数的处理逻辑一致.</span></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >2. 测试单个事务对TUPLE加for key share锁. 并使用pgrowlocks和pageinspect查看锁信息以及t_infomask信息.</span></div><div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >SESSION A :&nbsp;</div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >digoal=# begin;</font></div><div style="line-height: 22px;"   ><font size="2"   >BEGIN</font></div><div style="line-height: 22px;"   ><font size="2"   >digoal=# select * from test where id=1 for key share;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;id | info&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >----+------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; 1 | abc</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >SESSION B :&nbsp;</span></div></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >digoal=# select * from pgrowlocks('test');</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;locked_row | locker | multi | &nbsp;xids &nbsp;| &nbsp; &nbsp; &nbsp; modes &nbsp; &nbsp; &nbsp; | &nbsp;pids &nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >------------+--------+-------+--------+-------------------+--------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;(0,1) &nbsp; &nbsp; &nbsp;| &nbsp; 1755 | f &nbsp; &nbsp; | {1755} | {"For Key Share"} | {6096}</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >digoal=# select * from heap_page_items(get_raw_page('test', 0));</font></span></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; 1 | &nbsp; 8160 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 32 | &nbsp; 1751 | &nbsp; 1755 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp;402 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; 2 | &nbsp; 8120 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 35 | &nbsp; 1751 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2306 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >(2 rows)</font></div><p></p></pre></div><div><div style="line-height: 22px;"   >加锁的行lp=1 的t_infomask=402, 16进制 0x0192 , 因此包含如下MASK :&nbsp;</div><div><pre class="prettyprint"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMIN_COMMITTED &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0100 &nbsp;/* t_xmin committed */</font></div><div><div><font size="2"   ><span style="line-height: 19px;"   >#define HEAP_XMAX_KEYSHR_LOCK           0x0010  /* xmax is a key-shared locker */</span></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMAX_LOCK_ONLY &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0080 &nbsp;/* xmax, if valid, is only a locker */</font></div></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_HASVARWIDTH &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x0002 &nbsp;/* has variable-width attribute(s) */</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >xmax掩码信息与<span style="line-height: 22px;"   >compute_new_xmax_infomask函数的处理逻辑一致.</span></div></div></div></div><div><br></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >3. 测试单个事务对TUPLE加for share锁. 并使用pgrowlocks和pageinspect查看锁信息以及t_infomask信息.</span></div></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >SESSION A :&nbsp;</span></div></div><div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >digoal=# begin;</font></div><div style="line-height: 22px;"   ><font size="2"   >BEGIN</font></div><div style="line-height: 22px;"   ><font size="2"   >digoal=# select * from test where id=1 for share;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;id | info&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >----+------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; 1 | abc</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >SESSION B :&nbsp;</span></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >digoal=# select * from pgrowlocks('test');</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;locked_row | locker | multi | &nbsp;xids &nbsp;| &nbsp; &nbsp; modes &nbsp; &nbsp; | &nbsp;pids &nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >------------+--------+-------+--------+---------------+--------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;(0,1) &nbsp; &nbsp; &nbsp;| &nbsp; 1754 | f &nbsp; &nbsp; | {1754} | {"For Share"} | {6096}</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div></div><div><div style="line-height: 22px;"   ><font size="2"   >digoal=# select * from heap_page_items(get_raw_page('test', 0));</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; 1 | &nbsp; 8160 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 32 | &nbsp; 1751 | &nbsp; 1754 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp;466 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; 2 | &nbsp; 8120 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 35 | &nbsp; 1751 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2306 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >(2 rows)</font></div></div><p></p></pre></div></div><div><div><div style="line-height: 22px;"   >加锁的行lp=1 的t_infomask=466, 16进制 0x01D2 , 因此包含如下MASK :&nbsp;</div><div><pre class="prettyprint"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMIN_COMMITTED &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0100 &nbsp;/* t_xmin committed */</font></div><div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMAX_KEYSHR_LOCK           0x0010  /* xmax is a key-shared locker */</font></div><div><font size="2"   >#define HEAP_XMAX_EXCL_LOCK             0x0040  /* xmax is exclusive locker */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMAX_LOCK_ONLY &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0080 &nbsp;/* xmax, if valid, is only a locker */</font></div></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_HASVARWIDTH &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x0002 &nbsp;/* has variable-width attribute(s) */</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >xmax掩码信息与<span style="line-height: 22px;"   >compute_new_xmax_infomask函数的处理逻辑一致.</span></div></div></div></div><div style="line-height: 22px;"   ><span style="font-family: monospace; font-size: small; line-height: 19px; white-space: pre;"   >htup_detail.h头文件中设置了: HEAP_XMAX_EXCL_LOCK和</span><span style="line-height: 19px; font-family: monospace; font-size: small; white-space: pre;"   >HEAP_XMAX_KEYSHR_LOCK掩码同时设置表示shared lock.</span></div><div><span style="line-height: 22px;"   ><br></span></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >4. 测试单个事务对TUPLE加for update锁. 并使用pgrowlocks和pageinspect查看锁信息以及t_infomask信息.</span></div></div><div><div style="line-height: 22px;"   >SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# select * from test where id=1 for update;</font></div><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | abc</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >SESSION B :&nbsp;</span></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pgrowlocks('test');</font></div><div><font size="2"   >&nbsp;locked_row | locker | multi | &nbsp;xids &nbsp;| &nbsp; &nbsp; modes &nbsp; &nbsp; &nbsp;| &nbsp;pids &nbsp;</font></div><div><font size="2"   >------------+--------+-------+--------+----------------+--------</font></div><div><font size="2"   >&nbsp;(0,1) &nbsp; &nbsp; &nbsp;| &nbsp; 1756 | f &nbsp; &nbsp; | {1756} | {"For Update"} | {6096}</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select * from heap_page_items(get_raw_page('test', 0));</font></div><div><font size="2"   >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"   >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"   >&nbsp; 1 | &nbsp; 8160 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 32 | &nbsp; 1751 | &nbsp; 1756 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;8194 | &nbsp; &nbsp; &nbsp; &nbsp;450 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 2 | &nbsp; 8120 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 35 | &nbsp; 1751 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2306 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div><div><div style="line-height: 22px;"   >加锁的行lp=1 的t_infomask=450, 16进制 0x01C2 , 因此包含如下MASK :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMIN_COMMITTED &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0100 &nbsp;/* t_xmin committed */</font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMAX_EXCL_LOCK             0x0040  /* xmax is exclusive locker */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMAX_LOCK_ONLY &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0080 &nbsp;/* xmax, if valid, is only a locker */</font></div></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_HASVARWIDTH &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x0002 &nbsp;/* has variable-width attribute(s) */</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >t_infomask2=8194, 16进制 0x2002 , 因此包含如下MASK :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#define HEAP_KEYS_UPDATED &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x2000 &nbsp;/* tuple was updated and key cols</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* modified, or tuple deleted */</font></div><p></p></pre></div><div style="line-height: 22px;"   >xmax掩码信息与<span style="line-height: 22px;"   >compute_new_xmax_infomask函数的处理逻辑一致.</span></div></div></div></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >【小结】</div><div>1. &nbsp;单事务锁行时, 4种行锁模式和infomask的关系 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >1.1 select ... for key share</font></div><div><font size="2"   >&nbsp; &nbsp; t_infomask 设置 HEAP_XMAX_LOCK_ONLY &nbsp;以及&nbsp;HEAP_XMAX_KEYSHR_LOCK</font></div><div><font size="2"   ><span style="line-height: 22px;"   >1.2 select ... for</span><span style="line-height: 22px;"   >&nbsp;</span>share</font></div><div><font size="2"   ><span style="line-height: 22px;"   >&nbsp; &nbsp;&nbsp;</span><span style="line-height: 22px;"   >t_infomask</span><span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >设置 HEAP_XMAX_LOCK_ONLY &nbsp;以及&nbsp;</span><span style="line-height: 22px;"   >HEAP_XMAX_SHR_LOCK [也就是</span><span style="line-height: 19px;"   >HEAP_XMAX_KEYSHR_LOCK和HEAP_XMAX_EXCL_LOCK</span></font><span style="line-height: 22px; font-family: Arial, Helvetica, sans-serif; font-size: small;"   >]</span></div><div><font size="2"   ><span style="line-height: 22px;"   >1.3 select ... for</span><span style="line-height: 22px;"   >&nbsp;</span>no key update</font></div><div><font size="2"   ><span style="line-height: 22px;"   >&nbsp; &nbsp;&nbsp;</span><span style="line-height: 22px;"   >t_infomask</span><span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >设置 HEAP_XMAX_LOCK_ONLY &nbsp;以及&nbsp;</span><span style="line-height: 22px;"   >HEAP_XMAX_EXCL_LOCK</span></font></div><div><font size="2"   ><span style="line-height: 22px;"   >1.4 select ... for</span>&nbsp;update [也就是key update]</font></div><div><font size="2"   ><span style="line-height: 22px;"   >&nbsp; &nbsp;&nbsp;</span><span style="line-height: 22px;"   >t_infomask</span><span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >设置 HEAP_XMAX_LOCK_ONLY &nbsp;以及&nbsp;</span><span style="line-height: 22px;"   >HEAP_XMAX_EXCL_LOCK&nbsp;</span></font></div><div><span style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; 同时 t_infomask2 设置 HEAP_KEYS_UPDATED</font></span></div><p></p></pre></div><div>2. 有兴趣的朋友可以用gdb跟踪一下pgrowlocks的函数调用.</div><div>3. 下一篇将讲解一下多个事务对同一条TUPLE请求锁的情况, 因为infomask的信息量有限, 所以xmax不再存储xid而是存储MultiXactId.</div><div>&nbsp; &nbsp; 有兴趣的朋友可以关注下一篇BLOG.</div><div>《PostgreSQL How to deal TUPLE LOCK : 2 - "one|more transactions waiting one|more transactions release tuple lock" 》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020131172754749/"   >http://blog.163.com/digoal@126/blog/static/16387704020131172754749/</a></div><div><br></div>【参考】<div><div>1. src/backend/access/heap/README.tuplock</div><div>2. src/include/access/htup_details.h</div><div>3. src/include/access/multixact.h</div><div>4. src/backend/access/transam/multixact.c</div><div>5. src/include/access/heapam.h</div><div>6. src/backend/access/heap/heapam.c</div><div><span style="line-height: 22px;"   >7. src/backend/utils/adt/lockfuncs.c</span></div><div>8. src/backend/storage/lmgr/lock.c</div><div>9. src/backend/storage/lmgr/lmgr.c</div><div>10.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/pgrowlocks.html"   >http://www.postgresql.org/docs/devel/static/pgrowlocks.html</a></div><div>11.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/pageinspect.html"   >http://www.postgresql.org/docs/devel/static/pageinspect.html</a></div><div><span style="line-height: 22px;"   >12.&nbsp;</span><a style="line-height: 22px;" target="_blank" rel="nofollow" href="https://github.com/postgres/postgres/commit/0ac5ad5134f2769ccbaefec73844f8504c4d6182"   >https://github.com/postgres/postgres/commit/0ac5ad5134f2769ccbaefec73844f8504c4d6182</a></div><div>13.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020130249109133/"   >http://blog.163.com/digoal@126/blog/static/16387704020130249109133/</a></div><div>14.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020130305109687/"   >http://blog.163.com/digoal@126/blog/static/16387704020130305109687/</a></div><div>15.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201210134586363/"   >http://blog.163.com/digoal@126/blog/static/163877040201210134586363/</a></div><div>16.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402011515105557166/"   >http://blog.163.com/digoal@126/blog/static/1638770402011515105557166/</a></div><div>17.&nbsp;<span style="line-height: 22px;"   >新版本t_infomask信息如下 :&nbsp;</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >/*</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;* information stored in t_infomask:</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;*/</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_HASNULL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x0001 &nbsp;/* has null attribute(s) */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_HASVARWIDTH &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x0002 &nbsp;/* has variable-width attribute(s) */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_HASEXTERNAL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x0004 &nbsp;/* has external stored attribute(s) */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_HASOID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0008 &nbsp;/* has an object-id field */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMAX_KEYSHR_LOCK &nbsp; 0x0010 &nbsp;/* xmax is a key-shared locker */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_COMBOCID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0020 &nbsp;/* t_cid is a combo cid */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMAX_EXCL_LOCK &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0040 &nbsp;/* xmax is exclusive locker */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMAX_LOCK_ONLY &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0080 &nbsp;/* xmax, if valid, is only a locker */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* xmax is a shared locker */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMAX_SHR_LOCK &nbsp; &nbsp; &nbsp;(HEAP_XMAX_EXCL_LOCK | HEAP_XMAX_KEYSHR_LOCK)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_LOCK_MASK &nbsp;(HEAP_XMAX_SHR_LOCK | HEAP_XMAX_EXCL_LOCK | \</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HEAP_XMAX_KEYSHR_LOCK)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMIN_COMMITTED &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0100 &nbsp;/* t_xmin committed */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMIN_INVALID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0200 &nbsp;/* t_xmin invalid/aborted */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMAX_COMMITTED &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0400 &nbsp;/* t_xmax committed */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMAX_INVALID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0800 &nbsp;/* t_xmax invalid/aborted */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XMAX_IS_MULTI &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x1000 &nbsp;/* t_xmax is a MultiXactId */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_UPDATED &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x2000 &nbsp;/* this is UPDATEd version of row */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_MOVED_OFF &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x4000 &nbsp;/* moved to another place by pre-9.0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* VACUUM FULL; kept for binary</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* upgrade support */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_MOVED_IN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x8000 &nbsp;/* moved from another place by pre-9.0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* VACUUM FULL; kept for binary</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* upgrade support */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_MOVED (HEAP_MOVED_OFF | HEAP_MOVED_IN)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_XACT_MASK &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0xFFF0 &nbsp;/* visibility-related bits */</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >18. t_infomask2 :&nbsp;</span></div><div style="line-height: 22px;"   >新增了<span style="line-height: 19px; font-family: monospace; font-size: small; white-space: pre;"   >#define HEAP_KEYS_UPDATED &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x2000 &nbsp;/* tuple was updated and key cols </span><span style="line-height: 19px; font-family: monospace; font-size: small; white-space: pre;"   >modified, or tuple deleted */</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >/*</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;* information stored in t_infomask2:</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;*/</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_NATTS_MASK &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x07FF &nbsp;/* 11 bits for number of attributes */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >/* bits 0x1800 are available */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_KEYS_UPDATED &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x2000 &nbsp;/* tuple was updated and key cols</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* modified, or tuple deleted */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_HOT_UPDATED &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x4000 &nbsp;/* tuple was HOT-updated */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP_ONLY_TUPLE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x8000 &nbsp;/* this is heap-only tuple */</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#define HEAP2_XACT_MASK &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0xE000 &nbsp;/* visibility-related bits */</font></div><p style="line-height: 22px;"   ></p></pre></div><wbr></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL How to deal TUPLE LOCK : 1 - One transaction lock single or multiple tuples | rows - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>