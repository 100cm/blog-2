## 时空之门 - 时间、空间、业务数据的融合 - 数据库嵌入式编程、流式计算、科学计算、软硬一体
                                      
### 作者  
digoal  
   
### 日期  
2017-05-26   
         
### 标签  
PostgreSQL , PostGIS , 点云 , GPU , FPGA , CPU , TPU , PL/language , 科研 , 嵌入式计算 , UDF , CUDA , 数据库嵌入式编程 , 流式计算 , 科学计算 , 软硬一体  
  
----  
     
## 背景  
随着技术的普及，越来越多以前需要很高的成本才能获取的数据，现在触手可及。  

1\. 点云（点的位置坐标+RGB+其他属性），以前只有军用领域在使用，比如《普罗米修斯》这部电影，通过一些小的飞行器（点云传感器设备）飞入未知的通道后，传回获取的点云数据，从而构建通道的全系影像。   

![pic](20170526_01_pic_001.jpg)   

现在民用领域，也有很多点云的类似应用。例如：扫地机器人，无人车，消防（探测房屋结构），VR（通过点云数据构建全息影像）等等。    

![pic](20170526_01_pic_005.jpg)   

2\. 气象数据 （位置、日照、温度、雨量、风量等），气象数据往往是栅格类型的数据，一个栅格包含了一片区域的日照、温度、雨量、风量等数据，栅格可以切分和聚合。

气象数据的有非常多的用途，例如：

光伏电厂的选址，需要分析某区域某个时间段，日照数据统计。

多个栅格的数据聚合，或者一个栅格数据的部分截取等。比如一个包含了浙江省的栅格数据，如果只需要杭州市区的数据，那么可以在读取时将杭州的区域切分出来。

在时间维度上分析，在地理位置维度上分析，在其他属性维度分析，多个维度的分析。

生成时序动态图等。

历史栅格数据不断的积累，不停的上传新的数据使得历史数据越来越多。

![pic](20170526_01_pic_002.jpg)   

3\. 地震数据（高频波，傅立叶变换），地震数据是一些包含了地理位置属性的XYZ三个方向的高频波形数据，收到数据后，需要对其进行快速的数据转换，预测和告警。

同时还需要对历史的数据进行挖掘。

![pic](20170526_01_pic_003.jpg)    

4\. 天文数据（寻天，星系，轨迹比对），从古至今，人类一直没有停止对外太空的探索，天文台就是一个最为直接的探索外太空的设备。

有一个项目叫“寻天”，每天这些望远镜需要对天球坐标进行全方位的拍摄，拍摄的数据以栅格类型存入数据库，以备后续的分析。比如寻址超新星，寻找类太阳系等。其中寻找类太阳系就需要对单个栅格的多个历史数据进行比对，通过行星运行轨迹对光线造成的细微影响找出类太阳系的星体。

涉及到大量的时间、空间维度的运算。

![pic](20170526_01_pic_004.png)    

5\. 室内定位（孤立坐标系、相对坐标系），实际上现在室内定位也非常的成熟了，例如你站在某个商场中，商场有若干个WIFI热点，只要你的手机开启了WIFI，那么通过3个WIFI热点与你的手机之间的信号强弱，就可以定位到你的位置。除了通过WIFI进行定位，还有磁场、声波、视觉等定位方法。定位后，数据以坐标+误差范围的形式存入数据库，这个坐标是相对坐标。

室内定位有什么商业用途呢？例如可以获取某个时间点的人群分布，哪个商场或者站台附近聚集了人群，进行营销效果的挖掘。

又比如，在时间+空间维度上，统计分析人流量，平均的驻留时间等。

![pic](20170526_01_pic_006.png)   

6\. 室外定位（定位方法：GPS、基站信号强弱等），人群踩踏事件预测，非法聚众预测，事件预测，某个位置的人群驻足时间（广告效应报告）等。

![pic](20170526_01_pic_007.jpg)   

7\. 其他，民用，军用

还有那些喜闻乐见的应用，o2o, 地图, 导航, 位置交友, 都带有很强的时间、空间、业务数据属性。

面向这么多的军用转民用技术，民用的软件技术有没有准备好？数据库有没有准备好接招呢？

## 时间、空间、业务数据融合的挑战

1\. 数据类型越来越丰富，例如大多数业务基本上都会包含空间数据。

2\. 大多数的数据具备时序属性，例如金融数据、物联网传感数据、气象数据、天文数据、地震监测数据等。

3\. 数据查询维度（筛选条件）越来越多，（时间、空间、UID等），例如

在2017-01-01 ~ 2017-02-01这个月，某个点附近方圆30公里发生的事件。

在某个时间段，所有区域发生的事件。

在某个时间段，某个区域，某些用户发生的事件。

4\. 数据的计算需求越来越复杂，参与计算的数据量越来越庞大，计算离数据太远导致传输效率浪费。

越来越多计算下推的需求。

5\. 业务对数据计算的时效性越来越高，越来越多的计算被前置（如流计算，数据清洗等）。

6\. 业务对数据深度学习的需求越来越多，而计算与数据的距离使得效率低下。

传统的存储与计算分离，使得整体的计算效率低下。越来越多的计算前置、计算下推需求，来提升存储计算分离这种架构下的效率。

## 计算前置与下推 - 对接行业积累的开源Lib库
每个行业都有各自的特点，每个行业都有对行业理解深厚的ISV（地头蛇），每个行业都有各自的积累（开发框架、Lib库等）。

例如

在科学计算这个领域，有很多的python, R, go, julia语言相关的第三方库。这些行业第三方库是开发人员对行业的理解与积累。（这些科学计算Lib库可能被广泛应用于气象预测、地震预测、金融等。）

如果这些Lib库可以与数据紧密的结合，开发人员一定会很高兴，而且大大的提升了计算的效率。

[<Python常用科学计算相关外部库>](http://gohom.win/2015/08/10/python-good-lib/)

以往是这样算（数据从数据库拉取到应用程序，应用程序再对其进行计算）：

![pic](20170526_01_pic_008.jpg)   

现在是这样算（使用科学计算相关的Lib库，就在数据库里面算）：

![pic](20170526_01_pic_009.jpg)   

所以如果数据库能与程序开发语言、以及对应的LIB库打通，那么是一件很美妙的事情。

PostgreSQL的PL框架实现了这一点，已支持plpython, plr, pljava, plperl, pltcl, C等非常多的内置编程语言，（通过接口，还可以支持更多的编程语言）。

## 数据库如何抓住 - 硬件发展的红利
通常我们理解的计算单元就是CPU，然而随着技术的发展，越来越多专业的硬件，例如显卡计算单元GPU，例如可烧录，可编程的FPGA，还有随着AI火起来的面向机器学习的定制芯片TPU。

[谷歌硬件工程师揭秘，TPU为何会比CPU、GPU快30倍？](https://www.leiphone.com/news/201704/55UjF0lafhIZVGJR.html)

[老黄呕心之作，英伟达能凭借Tesla V100技压群雄吗？](https://www.leiphone.com/news/201705/ZTztMk9I6t8lVP2U.html?ulu-rcmd=0_5021df_art_0_a3ba8a6ccd22402199137fed4a3f604a)

[深入理解 CPU 和异构计算芯片 GPU/FPGA/ASIC 1](https://www.qcloud.com/community/article/323436001490098149)

[深入理解 CPU 和异构计算芯片 GPU/FPGA/ASIC 2](https://www.qcloud.com/community/article/35505001490098107)

那么数据库能否跟上这波浪潮呢，或者说如何抓住硬件发展的红利呢？

1\. CPU

多核并行，一条SQL可以充分利用多个CPU核，缩短单条SQL的响应时间，特别适合OLAP业务。

2\. GPU

GPU与CPU的对比如下，GPU在核心数、FFLOPS、内存带宽方面，相比CPU有非常明显的优势。

![pic](20170526_01_pic_010.jpg)   

通过pl/cuda语言，用户可以在数据库中直接使用到GPU的计算能力。

![pic](20170526_01_pic_011.jpg)   

pl/cuda用法参考：

https://github.com/pg-strom/devel

3\. FPGA

FPGA作为一种高性能、低功耗的可编程芯片，可以根据客户定制来做针对性的算法设计。所以在处理海量数据的时候，FPGA 相比于CPU 和GPU，优势在于：FPGA计算效率更高，FPGA更接近IO。

FPGA不采用指令和软件，是软硬件合一的器件。对FPGA进行编程要使用硬件描述语言，硬件描述语言描述的逻辑可以直接被编译为晶体管电路的组合。所以FPGA实际上直接用晶体管电路实现用户的算法，没有通过指令系统的翻译。

FPGA的英文缩写名翻译过来，全称是现场可编程逻辑门阵列，这个名称已经揭示了FPGA的功能，它就是一堆逻辑门电路的组合，可以编程，还可以重复编程。

PostgreSQL 社区，xilinx都有这方面的结合产品。

https://www.pgcon.org/2015/schedule/track/Hacking/799.en.html

4\. TPU

在Google I/O 2016的主题演讲进入尾声时，Google的CEO皮采提到了一项他们这段时间在AI和机器学习上取得的成果，一款叫做Tensor Processing Unit（张量处理单元）的处理器，简称TPU。在大会上皮采只是介绍了这款TPU的一些性能指标，并在随后的博客中公布了一些使用场景：

Google一直坚信伟大的软件将在伟大的硬件的帮助下更加大放异彩，所以Google便在想，我们可不可以做出一款专用机机器学习算法的专用芯片，TPU便诞生了。 

TPU的灵感来源于Google开源深度学习框架TensorFlow，所以目前TPU还是只在Google内部使用的一种芯片。

https://www.leiphone.com/news/201605/xAiOZEWgoTn7MxEx.html

PostgreSQL以其扩展接口(pl/language, customscan, operator, type, index扩展)，可以非常方便的对接以上各种计算单元，让数据和计算紧密的结合，提高能效比。

## 数据库的发展

GIS

CPU 多核

内置函数

扩展接口（类型、索引、PL语言、UDF、解析器、执行器）

PIC（PGSTROM）

未来

FPGA\TPU


### 1 行业积累融合 - move code

数据平台，代码接近数据

软硬件结合

GPU, FPGA, TPU, pl?   

### 2 行业积累融合 - 流计算

对比流计算框架

使用便捷，开发成本低，启动成本低，扩展能力强，效率高。


### 3 数据库计算能力扩展 - 横向

MPP


科学计算（plpython）+ 流式计算 + GPU pl cuda

  
[《PostgreSQL数据库CUDA嵌入式编程pl/cuda》](20170526_01_pdf_001.pdf)

[《PostgreSQL点云应用》](20170526_01_pdf_002.pdf)

## 小结


计算为王

效率为王

计算前置

计算下推

算法

PG是数据平台，融合了


## 未来的展望

大图

![pic](20170526_01_pic_012.jpg)   

打通数据和计算的任督二脉。

通过PL对接行业生态，让开发者积累的Lib得以传承。

通过扩展接口对接硬件生态，让CPU,GPU,FPGA,TPU,ASIC等参与垂直的专业计算，提升效率，打破传统的CPU ONLY的模式。

通过流实现计算前置。

通过FDW接口存储接口将计算下推。

通过sharding技术实现水平扩展。

通过MPP提升大规模计算协作能力。


  
## 参考  
http://postgis.net/docs/manual-dev/

https://2016.foss4g-na.org/sites/default/files/slides/gbroccolo_FOSS4GNA2016_pointcloud_0.pdf

https://www.slideshare.net/kaigai/pgconfsv2016-plcuda/

https://github.com/pg-strom/devel

http://www.pgconfsv.com/program/schedule

http://kaigai.hatenablog.com/entry/2016/11/17/070708

http://www.pgconfsv.com/plcuda-fusion-hpc-grade-power-database-analytics-0

http://www.pgconf.asia/JP/wp-content/uploads/2016/12/20161203_PGconf.ASIA_PLCUDA.pdf

http://gohom.win/2015/08/10/python-good-lib/

[《PostgreSQL 数据库扩展语言编程 之 plpgsql - 1》](../201701/20170110_01.md) 

http://it.sohu.com/20170525/n494441009.shtml

https://www.leiphone.com/news/201704/55UjF0lafhIZVGJR.html

