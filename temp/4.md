

## PostgreSQL 三十六计 - 上
### 1. GIN复合倒排索引。

前端人机交互，任意字段组合查询需求，根本不知道用户会对哪些字段进行检索，直击开发痛点。

PostgreSQL GIN复合倒排索引，一个索引，解救开发人员。

### 2. range类型。

范围类型+GIST索引，传感器多条记录压缩为单条记录范围表述；支持智能DNS、金融、气象、传感器数据等高效范围匹配。

例如1个传感器5分钟产生了10000条记录，在1.1-1.4之间波动，可以存储为[1.1, 1.4]一条记录，而不是1万条记录。

匹配时支持 $? @< 字段 高效率索引检索。

### 3. PostGIS。

不仅有经纬度、点面判断、距离判断。还有栅格、路径规划、图层、拓扑、地址与经纬度MAPPING、空间类型索引与操作符。不仅有二维数据。还有多维数据。不仅支持串行。还有多核并行。PostGIS服务于军用、民用、科研几十年，覆盖面广、开发框架支持丰富，值得信赖。

### 4. 异步消息。

在物联网中，结合PostgreSQL的流式计算，当传感器上报的数据达到触发事件的条件时，往异步消息通道发送一则消息，应用程序实时的接收异步消息，发现异常。    
    
即节省了空间（结合流式处理，完全可以轻量化部署），又能提高传播的效率（一对多的传播），程序设计也可以简单化。     

例如zabbix监控系统，如果每秒产生千万级的新值(new values per second)，传统的zabbix处理会非常吃力，除了插入吃力(实际上大部分插入是无用功，正常的值完全可以适应范围类型压缩插入，异常的值才是有效值)，主动查询询问式的方式也很吃力。

使用PostgreSQL流式计算功能，仅仅当值有问题（根据流规则判断）时，向异步消息通道发送异常消息，WEB服务仅需监控通道即可，无需频繁的查询数据库来获取是否有异常。PostgreSQL单机就可以支持更高的NVPS，例如百万级/s是非常轻松的。 

### 5. 流式实时数据处理。

解决监控、物联网、金融 等业务场景实时计算和事件响应需求。

定义stream(流)，然后基于stream定义对应的transform(事件触发模块)，以及Continuous Views(实时统计模块)            
          
数据往流里面插入，transform和Continuous Views就在后面实时的对流里的数据进行处理，对开发人员来说很友好，很高效。        
         
值得庆祝的还有，所有的接口都是SQL操作，非常的方便，大大降低了开发难度。     

### 6. PostGIS、图像特征值存储和处理(imgsmlr插件)。 

互联网、AR红包、虚拟现实与GIS结合、广告营销 等业务场景。既有地理位置数据，又有图像处理需求。    

例如AR红包是GIS与图像、社交、广告等业务碰撞产生的一个全新业务场景。    
    
需要做广告投放的公司，可以对着广告牌，或者店铺中的某个商品拍照，然后藏AR红包。    
    
要找红包的人，需要找到这家店，并且也对准藏红包的物体拍摄，比较藏红包和找红包的两张图片，就可以实现抢红包的流程。    

PostGIS处理地理信息，imgsmlr处理图像，完美支持以上场景。

### 7. 火眼金睛，实时辨别相似数据。

在搜索引擎、数据公司、互联网中都会有网络爬虫的产品，或者有人机交互的产品。    
    
有人的地方就有江湖，盗文、盗图的现象屡见不鲜，而更惨的是，盗图和盗文还会加一些水印。    
    
也就是说，你在判断盗图、盗文的时候，不能光看完全一致，可能要看的是相似度。    
    
这给内容去重带来了很大的麻烦。

PostgreSQL数据库整合了相似度去重的算法和索引接口，可以方便、高效的处理相似数据。    
    
如相似的数组、相似的文本、相似的分词、相似的图像的搜索和去重，根据图片鉴黄等等。    
    
### 8. 任意字段模糊查询杀手锏，GIN, GiST索引。

PostgreSQL可以针对整条记录、指定字段、多个字段，建立全文索引。

支持高效的全文检索；支持%x%的前后全模糊查询；支持正则表达式查询；

以上查询全部支持索引，亿级数据，毫秒级响应速度。

### 9. 云端高招，冷热分离、多实例数据共享。

助力分析师，快速建模与试错。

对传统企业来说，OLTP系统大多数使用的是Oracle等商业数据库，使用PostgreSQL可以与Oracle的功能、性能、SQL语法等做到高度兼容。    
    
而对于分析场景，使用MPP产品HybridDB(基于GPDB)，则可以很好的解决PB级以上的AP需求。    

OLTP与OLAP的数据，通过OSS_EXT共享，多个实例可以同一份数据，分析师在分析时，不影响生产实例。

### 10. OLAP大补丸。多核并行、向量计算、JIT、列式存储、聚合算子复用。

OLAP系统，单个任务需要对大量的数据进行运算。

多核并行，解决大数据运算时的CPU瓶颈。

向量计算，使用CPU缓存，批量进行向量化计算，不借助外力的情况下，提升10倍以上性能。

JIT，大幅降低记录数庞大运算时，频繁函数式调用引入的切换开销。大幅提升性能。

列存储，大幅降低行存储deform引入的开销。大幅降低扫描的数据量，大幅降低缓存的使用量。

聚合算子复用，大幅降低多个聚合函数，CPU的计算开销。例如(sum,avg,count,min,max)

### 11. 实时用户画像与圈人。

助力广告主实时营销。

推荐系统的三个核心问题    
    
精准，属于数据挖掘系统的事情，使用PostgreSQL MADlib机器学习库可以实现。         
      
实时，实时的更新标签，在数据库中进行流式处理，相比外部流处理的方案，节约资源，减少开发成本，提高开发效率，提高时效性。         
      
高效，使用PostgreSQL以及数组的GIN索引功能，实现在万亿USER_TAGS的情况下的毫秒级别的圈人功能。     

### 12. 危化品管理行业痛点和解决之道。

危化品的监管，包括位置信息处理、点面判断、按距离搜索、化学数据处理。

危化品种类繁多。包括如常见的易爆、易燃、放射、腐蚀、剧毒、等等。    
    
由于危化品的危害极大，所以监管显得尤为重要，    
    
1\. 生产环节      
      
将各个原来人工监控的环节数字化，使用 传感器、流计算、规则（可以设置为动态的规则） 代替人的监管和经验。      
      
2\. 销售环节      
      
利用社会关系分析，在销售环节挖掘不法分子，挖掘骗贷、骗保的虚假交易。利用地理位置跟踪，掌控整个交易的货物运输过程。      
      
3\. 仓储环节      
      
仓储环节依旧使用传感器、流计算、应急机制对仓管的产品进行实时的监管，而对于危化品本身，我们已经不能使用普通的数据类型来存储，很幸运的是在PostgreSQL的生态圈中，有专门支持化学行业的RDKit支持，支持存储化合物类型，以及基于化合物类型的数据处理    
（包括化学反应，分解等等）。      
      
4\. 运输环节      
      
在危化品的运输环节，使用传感器对货车、集装箱内的危化品的指标进行实时的监控，使用流式数据库pipelineDB流式的处理传感器实时上报的数据；使用PostgreSQL+PostGIS+pgrouting 对于货车的形式路径进行管理，绕开禁行路段、拥堵路段。      
      
当出现事故时，使用PostgreSQL的GIS索引，快速的找出附近的应急救助资源（如交警、消防中队、医院、120）。      
      
同时对危化品的货物存储，使用化学物类型存储，可以对这些类型进行更多的约束和模拟的合成，例如可以发现化学反应，防止出现类似天津爆炸事件。      
            
5\. 消耗环节      
      
增加剩余量的监控，在闭环中起到很好的作用，达到供需平衡，避免供不应求，或者供过于求的事情发生。         
      
6\. 动态指挥中心      
      
在给生产、仓库、物流配送、消耗环节添加了终端、传感器后，就建立了一个全面的危化品监管数据平台。 构建实时的监管全图。           
        
7\. 缉毒、发现不法分子等      
      
通过社会关系学分析，结合RDKit插件，在数据库中存储了人的信息，存储了人与化学物的关系（比如购买过），然后，根据社会关系学分析，将一堆的化合物（原材料）结合起来，看看会不会发生反应，生成毒品或危化品。从而发现不法分子。 
  
## PostgreSQL 三十六计 - 中
### 13. 金融风控、公安刑侦、社会关系、人脉分析 等业务场景，高效实现图式数据搜索。

利用PostgreSQL函数编程，异步消息，复杂JOIN等手段，解决高效的图式数据查询需求。 
    
1\. 猎头挖人   

作为IT人士或者猎头、HR，对Linkedin一定不陌生，领英网实际上就是一个维护人际关系的网站。        
       
通过搜索你的一度人脉，可以找到与你直接相关的人，搜索2度人脉，可以搜索到与你间接相关的人。       
        
当然你还可以继续搜索N度人脉，不过那些和你可能就不那么相关了。        
       
如果你知道和美女范冰冰隔了几度人脉，是不是有点心动了呢？        
       
其实在古代，就有这种社会关系学，还有这种专门的职业，买官卖官什么的，其实都是人脉关系网。看过红楼梦的话，你会发现那家子人怎么那么多亲戚呢？         
       
2\. 公安破案       
       
公安刑侦学也是一类人脉相关的应用，只是现在的关系和行为越来越复杂，这种关系也越来越复杂，原来的人能接触的范围基本上就靠2条腿，顶多加匹马。      
      
现在，手机，电脑，ATM机，超时，摄像头，汽车等等，都通过公路网、互联网连接在一起。      
        
一个人的行为，产生的关系会更加的复杂，单靠人肉的关系分析，刑侦难度变得越来越复杂。       
            
3\. 金融风控        
       
比如银行在审核贷款资格时，通常需要审核申请人是否有偿还能力，是否有虚假消息，行为习惯，资产，朋友圈等等。  同样涉及到复杂的人物关系，人的行为关系分析等等。       
      
此类围绕人为中心，事件为关系牵连的业务催生了图数据库的诞生。       
        
目前比较流行的图数据库比如neo4j，某些图数据库在数据量超过内存大小时，性能下降会非常严重。      
        
PostgreSQL是一个功能全面的数据库，其中就有一些图数据库产品的后台是使用PostgreSQL的，例如OpenCog， Cayley等。          
       
除了这些图数据库产品，PostgreSQL本身在关系查询，关系管理方面也非常的成熟，十亿量级的关系网数据，3层关系运算仅需毫秒。     
    
还可以用于运算人与人之间的最短关系，穷举关系等。    
    
主要用到的技术plpgsql服务端编程、异步消息、数组、游标、pgrouting路由算法等。    

### 14. with recursive递归查询有妙用。

大量数据的求差集、最新数据搜索, 最新日志数据与全量数据的差异比对, 递归收敛扫描，提升数百倍性能。

### 15. 数据一致性分享、数据泵

在IoT的场景中，有流式分析的需求，也有存储历史数据的需求，同时还有数据挖掘的需求，搜索引擎可能也需要同一份数据，还有一些业务可能也要用到同一份数据。       
      
但是如果把数据统统放到一个地方，这么多的业务，它们有的要求实时处理，有的要求批量处理，有的可能需要实时的更新数据，有的可能要对大数据进行分析。   

10万级别左右的机器，PostgreSQL 的数据吞吐量可以达到100万条/s以上，同时数据库本身具备了严格的可靠性和一致性保证。    
    
PostgreSQL为分享数据提供了插槽的概念，每个插槽对应一个目标端，支持断点续传，支持多个目标端。用于流式的分享数据是非常好的选择。    

### 16. ad lock解决高并发更新少量记录的秒杀问题
秒杀在商品交易中是一个永恒的话题，从双十一，到一票难求，比的仅仅是手快吗？       
        
其实对于交易平台来说，面对的不仅仅是人肉，还有很多脚本，外挂自动化的抢购系统，压力可想而知。       
        
秒杀的优化手段很多，就拿数据库来说，有用排队机制的，有用异步消息的，有用交易合并的。       
        
PostgreSQL提供了一种更极端的秒杀应对方法，裸秒。可以让用户尽情的释放激情，以一台32核64线程的机器为例，每秒可以获取、探测约130万次的ad lock。        
        
试想一下，对单条记录的秒杀操作，达到了单机100万/s的处理能力后，秒杀算什么？100台机器就能处理1亿/s的秒杀请求。    

### 17. PostgreSQL 使用bitpack支持实时用户画像
用户画像在市场营销的应用重建中非常常见，已经不是什么新鲜的东西，比较流行的解决方案是给用户贴标签，根据标签的组合，圈出需要的用户。      
      
通常画像系统会用到宽表，以及分布式的系统。      
      
宽表的作用是存储标签，例如每列代表一个标签，但是通常数据库到2000个列基本就是极限了，上万TAG的话，只能使用多表JOIN来实现，效率较差。    
    
另一方面，使用宽表(甚至列存储)，标签的筛选性能也比较差（无法达到实时级别）。    
      
以PostgreSQL数据库为基础，以BIT来存储用户，每行一个TAG的方式，单机支持十万亿user tags体量，毫秒级实时圈人。     
    
### 18. 路径动态规划，助力物流配送、打车软件、导航软件、出行软件、高速、高铁等业务场景    
物流行业是被电子商务催生的产业之一。      
        
快件的配送和揽件的调度算法是物流行业一个非常重要的课题，直接关系到配送或揽件的时效，以及物流公司的运作成本。        
       
好的算法，可以提高时效，降低成本，甚至可以更好的调动社会资源，就像滴滴打车一样，也许能全民参与哦。        
       
以后也许上班路途还能顺路提供快递服务呢。        
       
以物流行业为例，PostgreSQL为物流行业应用提供了包括机器学习(madlib)、路径规划(pgrouting)、地理位置信息存储和处理等基础服务。    
    
### 19. 金融级可靠性，事务级可控多副本。   
传统的金融行业高度依赖共享存储来解决数据库的高可用，数据0丢失以及异地容灾的场景。      
    
共享存储的解决方案价格昂贵，对厂商的依赖较大。    
      
PostgreSQL基于同步流复制的任意副本解决方案，在解决0丢失，高可用以及容灾的问题的同时，还可以提供只读的功能。相比传统的存储解决方案，优势更加明显。 

允许用户根据事务的可靠性要求，设置事务所需的副本数。

### 20. 块级瘦索引，解决物联网、金融、日志、行为轨迹类数据快速导入与高效查询的矛盾

在物联网、金融、日志类型场景中，数据持续不断的产生，对于堆存储来说，有线性相关的特点。    
    
例如，时间字段往往和物理存储的顺序具有线性相关性。    
    
例如，有一些自增字段，也和堆存储的物理顺序线性相关。    
    
对与物理存储线性相关的字段（时间，自增字段），PostgreSQL提供了一种BRIN块级范围索引，索引中存储了对应数据块中的字段统计信息（例如最大值，最小值，平均值，记录数、SUM，空值个数等）    
    
这种索引很小，因为索引的粒度是连续的块，而不是每条记录。    
    
通常比BTREE索引小几百倍。    
    
如果字段的线性相关性很好，进行范围查询或者精确检索时，效率非常高。    
    
对于统计查询，也可以使用BRIN索引，提高分析统计的效率。    

### 21. 时序数据有损压缩    
在物联网、金融、FEED等场景中，往往有大批量的指标数据产生并进入数据库，通常包含 时间、值 两个字段。    
    
这些数据由于量非常庞大，而且就像音频一样，实际上是可以对其进行有损的压缩存储的。    
    
最为流行的是旋转门的压缩算法，在PostgreSQL中可以使用UDF，方便的实现这个功能。    
    
从而实现流式\时序数据的有损压缩，例如在UDF中使用旋转门压缩算法，压缩时序数据。

### 22. 准确诠释数据类型，基因工程    
PostgreSQL凭借良好的扩展性，不仅仅是一个数据库，同时也是具备非常强大的数据处理能力的数据平台。    
    
很多垂直行业的用户拿它来做各种和业务贴合非常紧密的事情。     
         
例如PostgreSQL在生命科学领域的应用案例 - 基因工程。        
      
通常的思维可能是这样的，把数据存在数据库，需要运算的时候，再把数据取出进行运算（例如配对），需要花费非常多的网络传输时间。 

PostgreSQL提供了基因工程相关的数据类型，操作类型，索引。满足基因工程业务的需求。      
    
用户可以直接在数据库中对基因数据进行处理。

### 23. 准确诠释数据类型，化学分子
RDKit是PostgreSQL的化学插件，支持化学数据类型的高效率存取，检索，索引。以及操作符，例如化学成分的分解，合成。

对于一个数据库来说，支持一个数据类型，首先需要支持数据类型的INPUT和OUTPUT，然后还要支持索引高效率的检索这种类型的数据，需要支持足够多的OP满足业务的需求，支持UDF处理对应的数据类型。

如果没有准确的诠释，只能存储为二进制字节流，或者字符串，运算、检索、操作、函数处理都不可能。

### 24. 数据预测、挖掘  
PostgreSQL、以及ApsaraDB HybridDB(基于GPDB)，等PostgreSQL相关的数据库，都支持MADlib机器学习库，这个库支持机器学习领域常见的算法（例如聚类、线性回归、贝叶斯、文本处理等等）    
    
其中在数据领域用得较多的数据预测，可以使用MADLib的多元回归库，进行对数据的预测。    
    
结合plR语言 或者R + pivotalR 、 python + pythonR插件，可以自动将R\python语言的命令转换为MADlib库函数，对数据进行分析。    
    
非常适合使用R或者python对数据进行分析的数据科学家使用。    
    
其特点是高效（数据与运算一体，可以使用LLVM\向量计算等技术优化，同时不需要传播数据，节约了传播的开销）、易用（支持常见的SQL、r, python等编程）。    

## PostgreSQL 三十六计 - 下
### 25. 数据库端编程，处理复杂业务逻辑。    
在传统企业、电商、运营商等涉及用户交互、或者多个系统交互的业务场景中，通常一个事务涉及到很复杂的业务逻辑，需要保证数据的一致性，同时还需要与数据库多次交互。    
    
比如银行开户，涉及的业务系统多，逻辑复杂。在传统企业中，通常也使用商业数据库的过程函数，实现此类复杂的逻辑。    
    
PostgreSQL的数据库过程函数支持的语言非常丰富，比如plpgsql（可与Oracle pl/sql功能比肩)，另外还支持语言的扩展，编程语言可以热插拔，例如支持python,perl,java,c,r 等等作为数据库的过程函数语言。    
    
对于开发人员来说，几乎可以在PostgreSQL数据库中处理任何业务逻辑。使用数据库端编程，可以在保证一致性的前提下，处理复杂的业务逻辑，减少数据库与程序的交互次数，降低整个事务的RT。

### 26. 善用ECPG，C嵌入式开发
在一些对性能要求非常高的场景，同时考虑开发效率，C嵌入式开发是一个非常好的选择。

比如在很多金融行业的开发商，ECPG和Oracle Pro*C一样具有同等地位。

### 27. 数据库水平拆分、跨平台数据融合   
PostgreSQL 从 2011年的9.1版本引入FDW开始，发展到现在已经支持几乎所有的外部数据源读写操作，例如mysql,oracle,pgsql,redis,mongo,hive,jdbc,odbc,file,sqlserver,es,S3,......。      
      
https://wiki.postgresql.org/wiki/Fdw      
      
开放的接口，允许用户自己添加外部数据源的支持。      
      
9.6针对postgres_fdw（即PostgreSQL外部数据源）再次增强，开始支持对sort, where, join的下推，支持remote cancel query, 用户使用FDW可以对应用透明的实现数据库的sharding，单元化需求。      
      
内核层支持sharding，这种分片技术相比中间件分片技术的好处：     
    
1\. 支持跨库JOIN        
    
2\. 支持绑定变量        
    
3\. 支持master(coordinator)节点水平扩展      
    
4\. 支持segment(datanode)节点水平扩展      
    
5\. 支持函数和存储过程       
    
6\. 支持sort, where, join的下推，支持remote cancel query，10.x支持聚合算子的下推。    

7\. 支持单一SQL，在shard节点并行RUN QUERY。
      
ps: 目前还不支持分布式事务（需要用户干预2PC） ，10.x的版本会增加内核层面的分布式事务控制。   

### 28. 开发规约 - 命名 
长度不要超过63个字符，不要使用关键字作为对象名，不要使用小写字母、数字和下划线以外的字符作为对象名，不要使用多字节字符作为注释。

### 29. 开发规约 - 设计 
同类属性，务必对齐数据类型。

BTREE索引字段，不建议超过2000字节，否则请使用哈希索引。

频繁更新的表，建议设置足够大的fillfactor。

全球化业务，建议使用UTF-8字符集。

使用能描述清楚数据的类型。能不用字符串的时候，尽量不要用字符串。

根据不同的数据类型，数据的查询需求，使用合适的索引方法（Btree, GiST, GIN, SP-GiST, HASH, rum, BRIN, bloom）。

建议不需要的大对象，要清理，否则容易造成泄露。

### 30. 开发规约 - QUERY

### 31. 管理规约 - 诊断与优化

### 32. 管理规约 - 备份与恢复

### 33. 管理规约 - 日常维护

### 34. 管理规约 - 


### 35. 管理规约 - 



### 36. 开箱即用


