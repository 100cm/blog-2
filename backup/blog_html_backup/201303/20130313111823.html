<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL deploy advise</h2>
	<h5 id="">2013-03-13 11:18:23&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013213111823938/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>【未完待续】</div><div><br></div><div>数据库服务器硬件配置建议</div><div>1. 内存 &gt; 活跃数据量</div><div>2. CPU &gt;= 4核</div><div>3. 硬盘 &gt; 总数据量</div><div>4. RAID : RAID 1 或 RAID 10</div><div>5. 网卡 : OLTP业务 &gt;= 100MB; OLAP业务 &gt;= 1000MB;</div><div><br></div><div>数据库操作系统配置建议</div><div>1. OS</div><div>&nbsp; 建议CentOS 5.x 64bit</div><div>2. 文件系统</div><div>&nbsp; ext4 或 xfs</div><div>3. 内核</div><div>net.ipv4.ip_forward = 0</div><div>net.ipv4.conf.default.rp_filter = 1</div><div>net.ipv4.conf.default.accept_source_route = 0</div><div>kernel.sysrq = 0</div><div>kernel.core_uses_pid = 1</div><div>net.ipv4.tcp_syncookies = 1</div><div>kernel.msgmnb = 65536</div><div>kernel.msgmax = 65536</div><div>kernel.shmmax = 68719476736</div><div>kernel.shmall = 4294967296</div><div>kernel.shmmni = 4096</div><div>kernel.sem = 50100 64128000 50100 1280</div><div>fs.file-max = 7672460</div><div>net.ipv4.ip_local_port_range = 9000 65000</div><div>net.core.rmem_default = 1048576</div><div>net.core.rmem_max = 4194304</div><div>net.core.wmem_default = 262144</div><div>net.core.wmem_max = 1048576</div><div>net.ipv4.tcp_tw_recycle = 1</div><div>net.ipv4.tcp_max_syn_backlog = 4096</div><div>net.core.netdev_max_backlog = 10000</div><div>net.ipv4.netfilter.ip_conntrack_max = 655360</div><div>fs.aio-max-nr = 1048576</div><div>net.ipv4.tcp_timestamps = 0</div><div>vm.overcommit_memory = 0</div><div><br></div><div>4. 资源限制</div><div>* soft &nbsp; &nbsp;nofile &nbsp;131072</div><div>* hard &nbsp; &nbsp;nofile &nbsp;131072</div><div>* soft &nbsp; &nbsp;nproc &nbsp; 131072</div><div>* hard &nbsp; &nbsp;nproc &nbsp; 131072</div><div>* soft &nbsp; &nbsp;core &nbsp; &nbsp;unlimited</div><div>* hard &nbsp; &nbsp;core &nbsp; &nbsp;unlimited</div><div>* soft &nbsp; &nbsp;memlock 50000000</div><div>* hard &nbsp; &nbsp;memlock 50000000</div><div><br></div><div>5. 防火墙</div><div>&nbsp; 开启防火墙, 1. 仅允许必要IP访问管理端口; 2. 仅允许业务服务器访问数据库监听端口</div><div><br></div><div>6. 服务</div><div>&nbsp; 关闭不必要的服务</div><div><br></div><div><br></div><div>数据库版本建议</div><div>1. PostgreSQL 9.2.3 或 最新stable版本.</div><div>&nbsp; 下载地址 :&nbsp;</div><div>&nbsp; http://www.postgresql.org/ftp/source/v9.2.3/</div><div><br></div><div>数据库编译选项建议</div><div>1. 数据库编译选项</div><div>&nbsp; --prefix=/opt/pgsql9.2.3 --with-pgport=5432 --with-perl --with-python --with-tcl --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=16 &amp;&amp; gmake world</div><div>&nbsp; gmake install-world</div><div><br></div><div>扩展模块建议</div><div>1. pgfincore</div><div>2. pg_stat_statements</div><div>3. postgis -- 存储地理位置信息建议加装此模块</div><div><br></div><div>数据库配置建议</div><div>1. postgresql.conf</div><div>listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</div><div>max_connections = &gt;=连接池连接需求 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</div><div>unix_socket_directory = '.' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</div><div>unix_socket_permissions = 0700 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# begin with 0 to use octal notation</div><div>tcp_keepalives_idle = 60 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPIDLE, in seconds;</div><div>tcp_keepalives_interval = 30 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPINTVL, in seconds;</div><div>tcp_keepalives_count = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # TCP_KEEPCNT;</div><div>shared_buffers = &gt;=1/4总内存且&lt;=4096MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</div><div>maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</div><div>max_stack_depth = 8MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 100kB</div><div>shared_preload_libraries = 'pg_stat_statements' &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</div><div>vacuum_cost_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 0-100 milliseconds</div><div>vacuum_cost_limit = 5000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 1-10000 credits</div><div>bgwriter_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 10-10000ms between rounds</div><div>wal_level = hot_standby &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, or hot_standby</div><div>synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level;</div><div>wal_sync_method = fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # the default is the first option</div><div>wal_buffers = 16384kB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 32kB, -1 sets based on shared_buffers</div><div>wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</div><div>checkpoint_segments = 128 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # in logfile segments, min 1, 16MB each</div><div>archive_mode = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # allows archiving to be done</div><div>archive_command = '/bin/date' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # command to use to archive a logfile segment</div><div>max_wal_senders = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of walsender processes</div><div>wal_keep_segments = 3000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# in logfile segments, 16MB each; 0 disables</div><div>hot_standby = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# "on" allows queries during recovery</div><div>max_standby_archive_delay = 300s &nbsp; &nbsp; &nbsp; &nbsp;# max delay before canceling queries</div><div>max_standby_streaming_delay = 300s &nbsp; &nbsp; &nbsp;# max delay before canceling queries</div><div>wal_receiver_status_interval = 1s &nbsp; &nbsp; &nbsp; # send replies at least this often</div><div>hot_standby_feedback = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # send info from standby to prevent</div><div>random_page_cost = 1.5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# same scale as above</div><div>effective_cache_size = 20480MB</div><div>log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</div><div>logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</div><div>log_directory = '建议数据目录以外的目录' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # directory where log files are written,</div><div>log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,</div><div>log_file_mode = 0600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# creation mode for log files,</div><div>log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</div><div>log_rotation_age = 1d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Automatic rotation of logfiles will</div><div>log_rotation_size = 10MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Automatic rotation of logfiles will</div><div>log_min_duration_statement = 1000ms &nbsp; &nbsp; # -1 is disabled, 0 logs all statements</div><div>log_checkpoints = on</div><div>log_connections = on</div><div>log_disconnections = on</div><div>log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</div><div>log_lock_waits = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # log lock waits &gt;= deadlock_timeout</div><div>log_statement = 'ddl' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # none, ddl, mod, all</div><div>log_timezone = 'PRC'</div><div>track_activity_query_size = 4096 &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</div><div>autovacuum = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Enable autovacuum subprocess? &nbsp;'on'</div><div>log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</div><div>autovacuum_vacuum_scale_factor = 0.1 &nbsp; &nbsp;# fraction of table size before vacuum</div><div>autovacuum_analyze_scale_factor = 0.05 &nbsp;# fraction of table size before analyze</div><div>autovacuum_vacuum_cost_delay = 10ms &nbsp; &nbsp; # default vacuum cost delay for</div><div>datestyle = 'iso, mdy'</div><div>timezone = 'PRC'</div><div>lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</div><div>lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</div><div>lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</div><div>lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</div><div>default_text_search_config = 'pg_catalog.english'</div><div>deadlock_timeout = 1s</div><div>pg_stat_statements.max = 1000</div><div>pg_stat_statements.track = all</div><div><br></div><div>数据库安全建议</div><div>1. 密码复杂度</div><div>2. 连接权限</div><div>3. 用户权限</div><div>数据库权限</div><div>SCHEMA权限</div><div>对象权限</div><div>4. 补丁</div><div>5. SQL注入攻击预防</div><div>&nbsp; &nbsp;建议使用绑定变量预防SQL注入攻击.</div><div><br></div><div>数据库备份建议</div><div>1. 逻辑备份, 可以恢复到备份时间点. 确保数据一致性.</div><div>2. 增量备份, 支持恢复到任意时间点, 用于精准恢复.</div><div>(不建议使用不支持一致性逻辑备份以及增量备份的数据库系统)</div><div><br></div><div>数据库恢复演练建议</div><div>1. 每季度对备份文件进行可恢复测试</div><div><br></div><div>数据库性能调优建议</div><div>1. 绑定变量</div><div>2. 连接池</div><div>3. 服务端函数</div><div>4. 复杂计算前移</div><div>5. 合理利用物化</div><div>7. 合理利用master-slave架构</div><div>6. 合理利用分布式架构(plproxy, pg-xc)</div><div><br></div><div>数据库日常维护建议</div><div>1. 数据库膨胀检查</div><div>2. 数据库索引使用率检查</div><div>3. 日志检查</div><div>4. 性能趋势检查</div><div>5. TOTAL TIME SQL性能检查</div><div>6. 备份恢复检查</div><div><br></div><div>数据库监控建议</div><div>1. 磁盘空间监控</div><div>2. 锁监控</div><div>3. 膨胀系数监控</div><div>4. 日志监控</div><div>5. 备份监控</div><div>6. 性能趋势监控</div><div><br></div><div><br></div><div><br></div><div><br></div><wbr></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">francs - 2015-06-26 8:52:46</h5>
				<div><img src="http://b.bst.126.net/common/portrait/face/preview/face55.gif"  ></div>
			</div>
	</div>
</div>
</body>
</html>