<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Ubuntu KVM virtualize use libvirt</h2>
	<h5 id="">2013-03-24 21:19:16&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201322462042878/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>安装必要的包 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal@digoal-desktop:~$ sudo apt-get install kvm libvirt-bin virt-manager virt-viewer virtinst</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal@digoal-desktop:~$</span><span style="line-height: 22px;"   >&nbsp;</span>sudo apt-get install bridge-utils</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"   >将需要运行libvirt的用户添加到libvirtd组.</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal@digoal-desktop:~$ sudo adduser digoal libvirtd</font></div><div><font size="2"   >Adding user `digoal' to group `libvirtd' ...</font></div><div><font size="2"   >Adding user digoal to group libvirtd</font></div><div><font size="2"   >Done.</font></div></div><div><div><font size="2"   >root@digoal-desktop:~# id digoal</font></div><div><font size="2"   >uid=1000(digoal) gid=1000(digoal) groups=1000(digoal),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),109(lpadmin),124(sambashare),125(libvirtd)</font></div></div><p></p></pre></div></div><div><br></div><div><span style="line-height: 22px;"   >检查硬件是否支持KVM硬件加速.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal@digoal-desktop:~/script$ sudo kvm-ok</font></div><div><font size="2"   >[sudo] password for digoal:&nbsp;</font></div><div><font size="2"   >INFO: /dev/kvm exists</font></div><div><font size="2"   >KVM acceleration can be used</font></div><p></p></pre></div><div>如果硬件支持, 但是以上命令返回的结果不支持, 那么可能你需要调整主板的BIOS.</div><div><br></div><div>配置网桥 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal@digoal-desktop:~$ sudo vi /etc/network/interfaces</font></div><div><div><font size="2"   >auto lo</font></div><div><font size="2"   >iface lo inet loopback</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >auto br0</font></div><div><font size="2"   >iface br0 inet static</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; address 192.168.2.8</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; network 192.168.2.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; netmask 255.255.255.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; broadcast 192.168.2.255</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; gateway 192.168.2.1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;dns-nameservers 202.101.172.35 192.168.2.1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bridge_ports eth0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bridge_fd 9</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bridge_hello 2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bridge_maxage 12</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bridge_stp off</font></div></div><p></p></pre></div><div><br></div><div>重启网络</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal@digoal-desktop:~$ sudo /etc/init.d/networking restart</font></div><div><font size="2"   >&nbsp;* Running /etc/init.d/networking restart is deprecated because it may not enable again some interfaces</font></div><div><font size="2"   >&nbsp;* Reconfiguring network interfaces...</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Waiting for br0 to get ready (MAXWAIT is 20 seconds).</font></div><div><font size="2"   >ssh stop/waiting</font></div><div><font size="2"   >ssh start/running, process 16717</font></div><div><font size="2"   >&nbsp; &nbsp;...done.</font></div><p></p></pre></div><div><br></div><div>检查网络接口</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal@digoal-desktop:~$ sudo ifconfig</font></div><div><font size="2"   >br0 &nbsp; &nbsp; &nbsp; Link encap:Ethernet &nbsp;HWaddr 00:19:66:4c:58:74 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:192.168.2.8 &nbsp;Bcast:192.168.2.255 &nbsp;Mask:255.255.255.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet6 addr: fe80::219:66ff:fe4c:5874/64 Scope:Link</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:66 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:101 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:5452 (5.4 KB) &nbsp;TX bytes:16547 (16.5 KB)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >eth0 &nbsp; &nbsp; &nbsp;Link encap:Ethernet &nbsp;HWaddr 00:19:66:4c:58:74 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:84818 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:102800 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:1000&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:5843700 (5.8 MB) &nbsp;TX bytes:78089818 (78.0 MB)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >lo &nbsp; &nbsp; &nbsp; &nbsp;Link encap:Local Loopback &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:127.0.0.1 &nbsp;Mask:255.0.0.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet6 addr: ::1/128 Scope:Host</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP LOOPBACK RUNNING &nbsp;MTU:16436 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:203 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:203 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:16772 (16.7 KB) &nbsp;TX bytes:16772 (16.7 KB)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >virbr0 &nbsp; &nbsp;Link encap:Ethernet &nbsp;HWaddr ee:ae:d8:32:a0:cf &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:192.168.122.1 &nbsp;Bcast:192.168.122.255 &nbsp;Mask:255.255.255.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:0 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:0 (0.0 B) &nbsp;TX bytes:0 (0.0 B)</font></div><p></p></pre></div><div><br></div><div>创建虚拟机目录, 修改权限.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >root@digoal-desktop:~# df -h</font></div><div><font size="2"   >Filesystem &nbsp; &nbsp; &nbsp;Size &nbsp;Used Avail Use% Mounted on</font></div><div><font size="2"   >/dev/sdb1 &nbsp; &nbsp; &nbsp; &nbsp;41G &nbsp;3.2G &nbsp; 36G &nbsp; 9% /</font></div><div><font size="2"   >udev &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1.8G &nbsp;4.0K &nbsp;1.8G &nbsp; 1% /dev</font></div><div><font size="2"   >tmpfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 741M &nbsp;748K &nbsp;740M &nbsp; 1% /run</font></div><div><font size="2"   >none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5.0M &nbsp; &nbsp; 0 &nbsp;5.0M &nbsp; 0% /run/lock</font></div><div><font size="2"   >none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1.9G &nbsp; &nbsp; 0 &nbsp;1.9G &nbsp; 0% /run/shm</font></div><div><font size="2"   >cgroup &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1.9G &nbsp; &nbsp; 0 &nbsp;1.9G &nbsp; 0% /sys/fs/cgroup</font></div><div><font size="2"   >/dev/sdb3 &nbsp; &nbsp; &nbsp; 367G &nbsp;195M &nbsp;348G &nbsp; 1% /data01</font></div><div><font size="2"   >/dev/sdb4 &nbsp; &nbsp; &nbsp; &nbsp;49G &nbsp;9.2G &nbsp; 37G &nbsp;20% /data02</font></div></div><div><div><font size="2"   >root@digoal-desktop:~# mkdir /data01/vm</font></div><div><font size="2"   >root@digoal-desktop:~# chown digoal:digoal /data01/vm</font></div></div><p></p></pre></div><div><br></div><div>创建虚拟机磁盘镜像文件 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >root@digoal-desktop:~# su - digoal</font></div><div><font size="2"   >digoal@digoal-desktop:~$ qemu-img create -f qcow2 -o encryption=off,cluster_size=2M,preallocation=off /data01/vm/centos5.9_64_01.img 16G</font></div><div><font size="2"   >Formatting '/data01/vm/centos5.9_64_01.img', fmt=qcow2 size=17179869184 encryption=off cluster_size=2097152 preallocation='off'&nbsp;</font></div></div><div><div><font size="2"   >digoal@digoal-desktop:~$ qemu-img info /data01/vm/centos5.9_64_01.img&nbsp;</font></div><div><font size="2"   >image: /data01/vm/centos5.9_64_01.img</font></div><div><font size="2"   >file format: qcow2</font></div><div><font size="2"   >virtual size: 16G (17179869184 bytes)</font></div><div><font size="2"   >disk size: 4.0M</font></div><div><font size="2"   >cluster_size: 2097152</font></div></div><p></p></pre></div><div><br></div><div>使用digoal用户创建虚拟机, (注意前面将digoal用户加入libvirtd组就是这个目的)</div><div>1. 使用vnc连接到服务器(参考<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020132245276398/"   >http://blog.163.com/digoal@126/blog/static/16387704020132245276398/</a>), 使用virt-manager管理虚拟机.</div><div>2. 启动virt-manager</div><div>3. 选择kvm虚拟化.</div><div>4. 选择CentOS5.9镜像文件.</div><div>5. 磁盘选择前面创建好的虚拟机磁盘镜像文件.</div><div>6. 网络选择共享的网桥, 名称为前面建好的br0.</div><div>7. 最后一个配置页面勾上启动时配置(custom config), 配置网卡和磁盘使用virtIO, 性能会好很多.</div><div><span style="line-height: 22px;"   >8. 开始安装操作系统, 安装过程中网络选择DHCP.</span></div><div>开始安装后, 由virt-manager生成的kvm命令如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/usr/bin/kvm&nbsp;</font></div><div><font size="2"   >-S&nbsp;</font></div><div><font size="2"   >-M pc-1.0&nbsp;</font></div><div><font size="2"   >-enable-kvm&nbsp;</font></div><div><font size="2"   >-m 512&nbsp;</font></div><div><font size="2"   >-smp 1,sockets=1,cores=1,threads=1&nbsp;</font></div><div><font size="2"   >-name centos5.9_64&nbsp;</font></div><div><font size="2"   >-uuid 4501a3c3-a267-4889-891f-186136cc9654&nbsp;</font></div><div><font size="2"   >-nodefconfig&nbsp;</font></div><div><font size="2"   >-nodefaults&nbsp;</font></div><div><font size="2"   >-chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/centos5.9_64.monitor,server,nowait&nbsp;</font></div><div><font size="2"   >-mon chardev=charmonitor,id=monitor,mode=control&nbsp;</font></div><div><font size="2"   >-rtc base=utc&nbsp;</font></div><div><font size="2"   >-no-reboot&nbsp;</font></div><div><font size="2"   >-no-shutdown&nbsp;</font></div><div><font size="2"   >-drive file=/data01/vm/centos5.9_64_01.img,if=none,id=drive-virtio-disk0,format=qcow2&nbsp;</font></div><div><font size="2"   >-device virtio-blk-pci,bus=pci.0,addr=0x5,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=2&nbsp;</font></div><div><font size="2"   >-drive file=/data02/iso/CentOS-5.7-x86_64.iso,if=none,media=cdrom,id=drive-ide0-1-0,readonly=on,format=raw&nbsp;</font></div><div><font size="2"   >-device ide-drive,bus=ide.1,unit=0,drive=drive-ide0-1-0,id=ide0-1-0,bootindex=1&nbsp;</font></div><div><font size="2"   >-netdev tap,fd=18,id=hostnet0,vhost=on,vhostfd=19&nbsp;</font></div><div><font size="2"   >-device virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:a2:65:1e,bus=pci.0,addr=0x3&nbsp;</font></div><div><font size="2"   >-chardev pty,id=charserial0&nbsp;</font></div><div><font size="2"   >-device isa-serial,chardev=charserial0,id=serial0&nbsp;</font></div><div><font size="2"   >-usb&nbsp;</font></div><div><font size="2"   >-vnc 127.0.0.1:0&nbsp;</font></div><div><font size="2"   >-vga cirrus&nbsp;</font></div><div><font size="2"   >-device intel-hda,id=sound0,bus=pci.0,addr=0x4 -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0&nbsp;</font></div><div><font size="2"   >-device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x6</font></div><p></p></pre></div><div>安装完后最好把IP地址配成静态的, 省得地址变动<span style="line-height: 22px;"   >.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >[root@localhost /]#</span><span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >vi&nbsp;</span>/etc/sysconfig/network</font></div><div><div style="line-height: 22px;"   ><font size="2"   >NETWORKING=yes</font></div><div style="line-height: 22px;"   ><font size="2"   >NETWORKING_IPV6=no</font></div><div style="line-height: 22px;"   ><font size="2"   >HOSTNAME=digoal.192.168.2.5.home</font></div><div><font size="2"   >[root@localhost /]# vi /etc/sysconfig/network-scripts/ifcfg-eth0</font></div><div><div><font size="2"   ># Virtio Network Device</font></div><div><font size="2"   >DEVICE=eth0</font></div><div><font size="2"   >BOOTPROTO=static</font></div><div><font size="2"   >HWADDR=52:54:00:A2:65:1E</font></div><div><font size="2"   >IPADDR=192.168.2.5</font></div><div><font size="2"   >NETMASK=255.255.255.0</font></div><div><font size="2"   >ONBOOT=yes</font></div></div><div><span style="line-height: 22px;"   ><font size="2"   >[root@localhost /]# vi /etc/hosts</font></span></div><div><div><font size="2"   >127.0.0.1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; localhost.localdomain localhost</font></div><div><font size="2"   >192.168.2.5 digoal.192.168.2.5.home</font></div></div></div><div><font size="2"   >[root@localhost ~]# hostname digoal.192.168.2.5.home</font></div><p></p></pre></div><div><br></div><div>启动虚拟机</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal@digoal-desktop:/data02/iso$ virsh list --all</font></div><div><font size="2"   >&nbsp;Id Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; State</font></div><div><font size="2"   >----------------------------------</font></div><div><font size="2"   >&nbsp; - centos5.9_64 &nbsp; &nbsp; &nbsp; &nbsp; shut off</font></div></div><div><div><font size="2"   >digoal@digoal-desktop:/data02/iso$ virsh start centos5.9_64</font></div><div><font size="2"   >Domain centos5.9_64 started</font></div></div><p></p></pre></div><div><br></div><div>连接虚拟机</div><div>可以使用virt-manager 或者 virt-viewer, 也可以使用vnc.</div><div><br></div><div><span style="line-height: 22px;"   >停止虚拟机</span></div><div><span style="line-height: 22px;"   >直接在虚拟机中shutdown,</span></div><div><span style="line-height: 22px;"   >或者直接使用virsh关闭.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal@digoal-desktop:/data02/iso$&nbsp;<span style="line-height: 22px;"   >virsh</span></font></div><div><span style="line-height: 22px;"   ><font size="2"   ><div>virsh # shutdown 3</div><div>Domain 3 is being shutdown</div><div><span style="line-height: 22px;"   >virsh # list</span></div></font></span><div><font size="2"   >&nbsp;Id Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; State</font></div><div><font size="2"   >----------------------------------</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   ><br></span></div><div>克隆虚拟机</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal@digoal-desktop:/data02/iso$ virsh list --all</font></div><div><font size="2"   >&nbsp;Id Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; State</font></div><div><font size="2"   >----------------------------------</font></div><div><font size="2"   >&nbsp; - centos5.9_64 &nbsp; &nbsp; &nbsp; &nbsp; shut off</font></div><div><font size="2"   >digoal@digoal-desktop:/data02/iso$ sudo virt-clone -o centos5.9_64 -n centos5.9_64_02 -f /data01/vm/centos5.9_64_02.img --connect=qemu:///system</font></div><div><font size="2"   >[sudo] password for digoal:&nbsp;</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal@digoal-desktop:/data01/vm$ virsh list --all</font></div><div><font size="2"   >&nbsp;Id Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; State</font></div><div><font size="2"   >----------------------------------</font></div><div><font size="2"   >&nbsp; - centos5.9_64 &nbsp; &nbsp; &nbsp; &nbsp; shut off</font></div><div><font size="2"   >&nbsp; - centos5.9_64_02 &nbsp; &nbsp; &nbsp;shut off</font></div></div><p></p></pre></div><div>使用virt-clone克隆的好处是可以缩减原始虚拟机膨胀的空间.</div><div>但是克隆的虚拟机磁盘镜像和原始的不一样, 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal@digoal-desktop:/data01/vm$ qemu-img info /data01/vm/centos5.9_64_02.img&nbsp;</font></div><div><font size="2"   >image: /data01/vm/centos5.9_64_02.img</font></div><div><font size="2"   >file format: qcow2</font></div><div><font size="2"   >virtual size: 16G (17179869184 bytes)</font></div><div><font size="2"   >disk size: 2.6G</font></div><div><font size="2"   >cluster_size: 65536</font></div><div><font size="2"   >digoal@digoal-desktop:/data01/vm$ qemu-img info /data01/vm/centos5.9_64_01.img&nbsp;</font></div><div><font size="2"   >image: /data01/vm/centos5.9_64_01.img</font></div><div><font size="2"   >file format: qcow2</font></div><div><font size="2"   >virtual size: 16G (17179869184 bytes)</font></div><div><font size="2"   >disk size: 3.4G</font></div><div><font size="2"   >cluster_size: 2097152</font></div><p></p></pre></div><div>如果要镜像格式一致, 其实直接拷贝镜像文件就好了.</div><div>1. 关闭要拷贝的虚拟机</div><div>2. 拷贝镜像文件</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - digoal</font></div><div><font size="2"   >cp&nbsp;/data01/vm/centos5.9_64_01.img&nbsp;/data01/vm/centos5.9_64_02.img</font></div><p></p></pre></div><div>3. 新建配置文件, 注意修改.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - root</font></div><div><font size="2"   >cd /etc/libvirt/qemu/</font></div><div><font size="2"   >cp&nbsp;centos-5.9-x64-01.xml&nbsp;centos-5.9-x64-02.xml</font></div><p></p></pre></div><div>4. 修改配置文件</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >生成uuid :&nbsp;</font></div><div><div><font size="2"   >uuidgen&nbsp;</font></div><div><font size="2"   >a459d82d-59d6-4493-ad13-f6406ef1817c</font></div></div><div><font size="2"   >修改配置(需修改name, uuid, diskfile, macaddr, 确保这些值在所有虚拟机全局唯一) :&nbsp;</font></div><div><font size="2"   >vi&nbsp;<span style="line-height: 22px;"   >centos-5.9-x64-02.xml</span></font></div><div><div><font size="2"   >&lt;domain type='kvm'&gt;</font></div><div><font size="2"   >&nbsp; &lt;name&gt;centos-5.9-x64-02&lt;/name&gt;</font></div><div><font size="2"   >&nbsp; &lt;uuid&gt;ea81f77a-d179-4488-a0b3-a8346dad443b&lt;/uuid&gt;</font></div></div><div><font size="2"   >............</font></div><div><div><font size="2"   >&nbsp; &nbsp; &lt;disk type='file' device='disk'&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;driver name='qemu' type='qcow2'/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;source file='/data02/vm/centos-5.9-x64_02.img'/&gt;</font></div></div><div><font size="2"   >.............</font></div><div><div><font size="2"   >&nbsp; &nbsp; &lt;interface type='network'&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;mac address='52:54:00:fa:be:c4'/&gt;</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >5. 将虚拟机文件定义到管理软件中.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >sudo virsh</font></div><div><font size="2"   >virsh # define&nbsp;/etc/libvirt/qemu/centos-5.9-x64-02.xml</font></div><p></p></pre></div><div><br></div><div># 克隆的虚拟机在启动后需要修改一下IP地址, 主机名.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal@digoal-desktop:/data01/vm$ virsh start centos5.9_64_02</font></div><div><font size="2"   >Domain centos5.9_64_02 started</font></div><p></p></pre></div><div>修改主机名, IP, (MAC新生成的与原始的不同, &nbsp;不需要修改).</div><div><div><pre class="prettyprint"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >[root@localhost /]#</span><span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >vi&nbsp;</span>/etc/sysconfig/network</font></div><div><div style="line-height: 22px;"   ><font size="2"   >NETWORKING=yes</font></div><div style="line-height: 22px;"   ><font size="2"   >NETWORKING_IPV6=no</font></div><div style="line-height: 22px;"   ><font size="2"   >HOSTNAME=digoal.192.168.2.6.home</font></div><div><font size="2"   >GATEWAY=192.168.2.1</font></div><div style="line-height: 22px;"   ><font size="2"   ><br></font></div><div style="line-height: 22px;"   ><font size="2"   >[root@localhost /]# vi /etc/sysconfig/network-scripts/ifcfg-eth0</font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   ># Virtio Network Device</font></div><div style="line-height: 22px;"   ><font size="2"   >DEVICE=eth0</font></div><div style="line-height: 22px;"   ><font size="2"   >BOOTPROTO=static</font></div><div style="line-height: 22px;"   ><font size="2"   >HWADDR=52:54:00:b0:8b:bc</font></div><div style="line-height: 22px;"   ><font size="2"   >IPADDR=192.168.2.6</font></div><div style="line-height: 22px;"   ><font size="2"   >NETMASK=255.255.255.0</font></div><div style="line-height: 22px;"   ><font size="2"   >ONBOOT=yes</font></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   ><br></font></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >[root@localhost /]# vi /etc/hosts</font></span></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >127.0.0.1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; localhost.localdomain localhost</font></div><div style="line-height: 22px;"   ><font size="2"   >192.168.2.6 digoal.192.168.2.6.home</font></div></div></div><div style="line-height: 22px;"   ><font size="2"   >[root@localhost ~]# hostname digoal.192.168.2.6.home</font></div><div><font size="2"   >[root@digoal data02]# vi /etc/resolv.conf</font></div><div><font size="2"   >nameserver 202.101.172.35</font></div><div><font size="2"   >nameserver 192.168.2.1</font></div><p style="line-height: 22px;"   ></p></pre></div></div><div><br></div><div># 删除虚拟机</div><div>1. 关闭虚拟机</div><div><pre class="prettyprint"   ><p><font size="2"   >virsh destroy&nbsp;centos5.9_64</font></p></pre></div><div>2. 删除域</div><div><pre class="prettyprint"   ><p><font size="2"   >virsh undefine&nbsp;centos5.9_64</font></p></pre></div><div>3. 如果配置文件还在等话, 删除之.</div><div><pre class="prettyprint"   ><p><font size="2"   >cd /etc/libvirt/qemu/</font></p></pre></div><div><br></div><div><br></div><div># 虚拟机服务端配置</div><div>在virt-manager中点击连接的hypervisor, 右键点击details.</div><div>在弹出的窗口中可以配置虚拟网络, 存储, 等.</div><div>配置存储的目的是让远程管理更方便, 例如把iso以及img的目录加进去, 那么通过远程的virt-manger管理时也可以安装虚拟机.</div><div>否则无法选择Iso是比较痛苦的.</div><div><br></div><div>【其他】</div><div>1. 如果遇到kvm kernel module 访问权限的报错, 可以把用户添加到kvm组</div><div><pre class="prettyprint"   ><p><font size="2"   >sudo adduser digoal kvm</font></p></pre></div><div>如果还是报错, 试试把kvm以及kvm_intel模块重载一下.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >sudo rmmod kvm_intel</font></div><div><font size="2"   >sudo rmmod kvm</font></div><div><font size="2"   >sudo modprobe kvm</font></div><div><font size="2"   >sudo modprobe kvm_intel</font></div><p></p></pre></div><div>2. 远程连接qemu的格式</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >virt-manager -c qemu+ssh://digoal@192.168.2.8/system</font></div></div><div><div><font size="2"   >virt-viewer -c qemu+ssh://digoal@<span style="line-height: 22px;"   >192.168.2.8</span>/system centos-5.9-x64-01</font></div></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"   >【参考】</span></div><div>1.&nbsp;man brctl</div><div>2.&nbsp;man resolvconf</div><div>3. man qemu-img</div><div>4. man kvm</div><div>5. man virsh</div><div>6. man virt-clone</div><div>7.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020132245276398/"   >http://blog.163.com/digoal@126/blog/static/16387704020132245276398/</a></div><div>8.&nbsp;<span style="line-height: 22px;"   >相关配置文件</span></div><div style="line-height: 22px;"   >/etc/libvirt</div><div style="line-height: 22px;"   >配置文件修改后重启libvirtd服务.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p><font size="2"   >sudo&nbsp;/etc/init.d/libvirt-bin restart</font></p></pre></div><div>9. 虚拟机配置的修改, 例如修改VCPU, 内存大小等. 可以通过virt-manager进行修改.</div><div>修改后重启虚拟机可生效, 无需重启libvirtd.</div><wbr></div>
	</div>
</div>
</body>
</html>