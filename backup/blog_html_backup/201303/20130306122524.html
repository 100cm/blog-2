<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL multi-column concate query condition performance tuning</h2>
	<h5 id="">2013-03-06 12:25:24&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013261167576/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>某系统中的一个查询语句如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >SELECT t1.id, t1.app_id, t1.app_ver, t1.cn_name, t1.app_show_ver, t1.package,&nbsp;</font></div><div><font size="2"   >&nbsp; t1.digoal_size, t1.developer_id, t1.description, t1.create_time, t1.authentic, t1.app_class_id&nbsp;</font></div><div><font size="2"   >FROM tbl_app_digoal t1&nbsp;</font></div><div><font size="2"   >WHERE t1.app_id||':'||t1.app_ver in ('418:288','156885:9','45110:28','31447:28','210386:43','122981:46','124:78','415:234','65516:30','53142:3405',</font></div><div><font size="2"   >&nbsp; '31494:6','107873:11','532:16780560','116309:3240','282:92','47318:23','65515:154','175299:61','185800:153','72105:4330')&nbsp;</font></div><div><font size="2"   >and t1.deleted = 0;</font></div><p></p></pre></div><div>注意这个条件 :&nbsp;</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >&nbsp;t1.app_id||':'||t1.app_ver in ('418:288','156885:9','45110:28','31447:28','210386:43','122981:46','124:78','415:234','65516:30','53142:3405',</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; '31494:6','107873:11','532:16780560','116309:3240','282:92','47318:23','65515:154','175299:61','185800:153','72105:4330')&nbsp;</font></div><p></p></pre></div></div><div style="line-height: 22px;"   >没有办法走索引, 且deleted=0的选择性较差, 所以这个SQL走全表扫描.</div><div style="line-height: 22px;"   >执行计划和执行时间如下 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; \timing</font></div><div><font size="2"   >Timing is on.</font></div><div><font size="2"   >digoal=&gt; explain analyze SELECT t1.id, t1.app_id, t1.app_ver, t1.cn_name, t1.app_show_ver, t1.package,&nbsp;</font></div><div><font size="2"   >digoal-&gt; &nbsp; t1.digoal_size, t1.developer_id, t1.description, t1.create_time, t1.authentic, t1.app_class_id&nbsp;</font></div><div><font size="2"   >digoal-&gt; FROM tbl_app_digoal t1&nbsp;</font></div><div><font size="2"   >digoal-&gt; WHERE t1.app_id||':'||t1.app_ver in ('418:288','156885:9','45110:28','31447:28','210386:43','122981:46','124:78','415:234','65516:30','53142:3405',</font></div><div><font size="2"   >digoal(&gt; &nbsp; '31494:6','107873:11','532:16780560','116309:3240','282:92','47318:23','65515:154','175299:61','185800:153','72105:4330')&nbsp;</font></div><div><font size="2"   >digoal-&gt; and t1.deleted = 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----------------------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on tbl_app_digoal t1 &nbsp;(cost=0.00..54528.19 rows=25699 width=625) (actual time=55.781..626.913 rows=20 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: ((deleted = 0::numeric) AND ((((app_id)::text || ':'::text) || (app_ver)::text) = ANY ('{418:288,156885:9,45110:28,31447:</font></div><div><font size="2"   >28,210386:43,122981:46,124:78,415:234,65516:30,53142:3405,31494:6,107873:11,532:16780560,116309:3240,282:92,47318:23,65515:154,17529</font></div><div><font size="2"   >9:61,185800:153,72105:4330}'::text[])))</font></div><div><font size="2"   >&nbsp;Total runtime: 626.988 ms</font></div><div><font size="2"   >(3 rows)</font></div><div><font size="2"   >Time: 642.089 ms</font></div><p></p></pre></div><div style="line-height: 22px;"   >表结构 :&nbsp;</div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; \d tbl_app_digoal</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Table "digoal.tbl_app_digoal"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; Column &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; Modifiers &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------+-----------------------------+------------------------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | numeric(19,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;app_id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | numeric(19,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;app_ver &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| numeric(19,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null</font></div><div>-- 其他字段略</div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "pk_app_digoal" PRIMARY KEY, btree (id)</font></div><div><font size="2"   >&nbsp; &nbsp; "idx_tbl_app_digoal_1" btree (id) WHERE deleted = 0::numeric AND on_off = 1::numeric AND promotion = 1::numeric, tablespace "tbs_an</font></div><div><font size="2"   >droid_market_idx"</font></div><div><font size="2"   >&nbsp; &nbsp; "idx_tbl_app_digoal_package_app_ver" btree (package, app_ver), tablespace "tbs_digoal_idx"</font></div><div><font size="2"   >&nbsp; &nbsp; "tbl_app_digoal_app_id_index" btree (app_id), tablespace "tbs_digoal_idx"</font></div><div><font size="2"   >Tablespace: "tbs_digoal_idx"</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >【优化方法一 : 】</div><div style="line-height: 22px;"   >将||连接符拆开, 使用多列的in来查询, 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; explain analyze SELECT t1.id, t1.app_id, t1.app_ver, t1.cn_name, t1.app_show_ver, t1.package,&nbsp;</font></div><div><font size="2"   >digoal-&gt; &nbsp; t1.digoal_size, t1.developer_id, t1.description, t1.create_time, t1.authentic, t1.app_class_id&nbsp;</font></div><div><font size="2"   >digoal-&gt; FROM tbl_app_digoal t1&nbsp;</font></div><div><font size="2"   >digoal-&gt; WHERE (t1.app_id, t1.app_ver) in ((418,288),(156885,9),(45110,28),(31447,28),(210386,43),(122981,46),(124,78),(415,234),(65516,30),(53142,3405),</font></div><div><font size="2"   >digoal(&gt; &nbsp; (31494,6),(107873,11),(532,16780560),(116309,3240),(282,92),(47318,23),(65515,154),(175299,61),(185800,153),(72105,4330))&nbsp;</font></div><div><font size="2"   >digoal-&gt; and t1.deleted = 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------</font></div><div><font size="2"   >&nbsp;Bitmap Heap Scan on tbl_app_digoal t1 &nbsp;(cost=26.23..157.51 rows=1 width=625) (actual time=0.340..1.347 rows=20 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Recheck Cond: ((app_id = 418::numeric) OR (app_id = 156885::numeric) OR (app_id = 45110::numeric) OR (app_id = 31447::numeric) OR</font></div><div><font size="2"   >&nbsp;(app_id = 210386::numeric) OR (app_id = 122981::numeric) OR (app_id = 124::numeric) OR (app_id = 415::numeric) OR (app_id = 65516::</font></div><div><font size="2"   >numeric) OR (app_id = 53142::numeric) OR (app_id = 31494::numeric) OR (app_id = 107873::numeric) OR (app_id = 532::numeric) OR (app_</font></div><div><font size="2"   >id = 116309::numeric) OR (app_id = 282::numeric) OR (app_id = 47318::numeric) OR (app_id = 65515::numeric) OR (app_id = 175299::nume</font></div><div><font size="2"   >ric) OR (app_id = 185800::numeric) OR (app_id = 72105::numeric))</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: ((deleted = 0::numeric) AND (((app_id = 418::numeric) AND (app_ver = 288::numeric)) OR ((app_id = 156885::numeric) AND (a</font></div><div><font size="2"   >pp_ver = 9::numeric)) OR ((app_id = 45110::numeric) AND (app_ver = 28::numeric)) OR ((app_id = 31447::numeric) AND (app_ver = 28::nu</font></div><div><font size="2"   >meric)) OR ((app_id = 210386::numeric) AND (app_ver = 43::numeric)) OR ((app_id = 122981::numeric) AND (app_ver = 46::numeric)) OR (</font></div><div><font size="2"   >(app_id = 124::numeric) AND (app_ver = 78::numeric)) OR ((app_id = 415::numeric) AND (app_ver = 234::numeric)) OR ((app_id = 65516::</font></div><div><font size="2"   >numeric) AND (app_ver = 30::numeric)) OR ((app_id = 53142::numeric) AND (app_ver = 3405::numeric)) OR ((app_id = 31494::numeric) AND</font></div><div><font size="2"   >&nbsp;(app_ver = 6::numeric)) OR ((app_id = 107873::numeric) AND (app_ver = 11::numeric)) OR ((app_id = 532::numeric) AND (app_ver = 1678</font></div><div><font size="2"   >0560::numeric)) OR ((app_id = 116309::numeric) AND (app_ver = 3240::numeric)) OR ((app_id = 282::numeric) AND (app_ver = 92::numeric</font></div><div><font size="2"   >)) OR ((app_id = 47318::numeric) AND (app_ver = 23::numeric)) OR ((app_id = 65515::numeric) AND (app_ver = 154::numeric)) OR ((app_i</font></div><div><font size="2"   >d = 175299::numeric) AND (app_ver = 61::numeric)) OR ((app_id = 185800::numeric) AND (app_ver = 153::numeric)) OR ((app_id = 72105::</font></div><div><font size="2"   >numeric) AND (app_ver = 4330::numeric))))</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;BitmapOr &nbsp;(cost=26.23..26.23 rows=118 width=0) (actual time=0.280..0.280 rows=0 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on tbl_app_digoal_app_id_index &nbsp;(cost=0.00..1.29 rows=2 width=0) (actual time=0.044..0.044 rows=27 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = 418::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on tbl_app_digoal_app_id_index &nbsp;(cost=0.00..1.29 rows=2 width=0) (actual time=0.013..0.013 rows=4 loops=</font></div><div><font size="2"   >1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = 156885::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on tbl_app_digoal_app_id_index &nbsp;(cost=0.00..1.29 rows=2 width=0) (actual time=0.020..0.020 rows=8 loops=</font></div><div><font size="2"   >1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = 45110::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on tbl_app_digoal_app_id_index &nbsp;(cost=0.00..1.29 rows=2 width=0) (actual time=0.012..0.012 rows=10 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = 31447::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on tbl_app_digoal_app_id_index &nbsp;(cost=0.00..1.29 rows=2 width=0) (actual time=0.012..0.012 rows=1 loops=</font></div><div><font size="2"   >1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = 210386::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on tbl_app_digoal_app_id_index &nbsp;(cost=0.00..1.29 rows=2 width=0) (actual time=0.017..0.017 rows=14 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = 122981::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on tbl_app_digoal_app_id_index &nbsp;(cost=0.00..1.29 rows=2 width=0) (actual time=0.011..0.011 rows=8 loops=</font></div><div><font size="2"   >1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = 124::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on tbl_app_digoal_app_id_index &nbsp;(cost=0.00..1.55 rows=37 width=0) (actual time=0.007..0.007 rows=18 loop</font></div><div><font size="2"   >s=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = 415::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on tbl_app_digoal_app_id_index &nbsp;(cost=0.00..1.29 rows=2 width=0) (actual time=0.014..0.014 rows=14 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = 65516::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on tbl_app_digoal_app_id_index &nbsp;(cost=0.00..1.29 rows=2 width=0) (actual time=0.012..0.012 rows=9 loops=</font></div><div><font size="2"   >1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = 53142::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on tbl_app_digoal_app_id_index &nbsp;(cost=0.00..1.29 rows=2 width=0) (actual time=0.011..0.011 rows=5 loops=</font></div><div><font size="2"   >1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = 31494::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on tbl_app_digoal_app_id_index &nbsp;(cost=0.00..1.29 rows=2 width=0) (actual time=0.007..0.007 rows=7 loops=</font></div><div><font size="2"   >1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = 107873::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on tbl_app_digoal_app_id_index &nbsp;(cost=0.00..1.29 rows=2 width=0) (actual time=0.012..0.012 rows=16 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = 532::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on tbl_app_digoal_app_id_index &nbsp;(cost=0.00..1.29 rows=2 width=0) (actual time=0.011..0.011 rows=11 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = 116309::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on tbl_app_digoal_app_id_index &nbsp;(cost=0.00..1.55 rows=37 width=0) (actual time=0.014..0.014 rows=16 loop</font></div><div><font size="2"   >s=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = 282::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on tbl_app_digoal_app_id_index &nbsp;(cost=0.00..1.29 rows=2 width=0) (actual time=0.014..0.014 rows=13 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = 47318::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on tbl_app_digoal_app_id_index &nbsp;(cost=0.00..1.29 rows=2 width=0) (actual time=0.006..0.006 rows=11 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = 65515::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on tbl_app_digoal_app_id_index &nbsp;(cost=0.00..1.29 rows=2 width=0) (actual time=0.011..0.011 rows=9 loops=</font></div><div><font size="2"   >1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = 175299::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on tbl_app_digoal_app_id_index &nbsp;(cost=0.00..1.29 rows=2 width=0) (actual time=0.013..0.013 rows=4 loops=</font></div><div><font size="2"   >1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = 185800::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on tbl_app_digoal_app_id_index &nbsp;(cost=0.00..1.29 rows=2 width=0) (actual time=0.017..0.017 rows=30 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = 72105::numeric)</font></div><div><font size="2"   >&nbsp;Total runtime: 1.524 ms</font></div><div><font size="2"   >(45 rows)</font></div><div><font size="2"   >Time: 3.356 ms</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >优化后性能明显.</span></div><div>优化前后的HASH结果值一致,包括出现null的情况 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; select 1 where (1,null) in ((1,null));</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >(0 rows)</font></div></div><div><div><font size="2"   >digoal=&gt; select 1||null;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=&gt; select 1 where (null) in (null);</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >(0 rows)</font></div></div><p></p></pre></div><div>HASH结果一致 :&nbsp;</div><div>优化后的SQL HASH sum :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; SELECT sum(hashtext(t1.*::text))</font></div><div><font size="2"   >digoal-&gt; FROM tbl_app_digoal t1&nbsp;</font></div><div><font size="2"   >digoal-&gt; WHERE (t1.app_id, t1.app_ver) in ((418,288),(156885,9),(45110,28),(31447,28),(210386,43),(122981,46),(124,78),(415,234),(65516,30),(53142,3405),</font></div><div><font size="2"   >digoal(&gt; &nbsp; (31494,6),(107873,11),(532,16780560),(116309,3240),(282,92),(47318,23),(65515,154),(175299,61),(185800,153),(72105,4330))&nbsp;</font></div><div><font size="2"   >digoal-&gt; and t1.deleted = 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;sum &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------------</font></div><div><font size="2"   >&nbsp;-1956567408</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 8.587 ms</font></div><p></p></pre></div><div>优化前的SQL HASH sum :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; SELECT sum(hashtext(t1.*::text))&nbsp;</font></div><div><font size="2"   >digoal-&gt; FROM tbl_app_digoal t1&nbsp;</font></div><div><font size="2"   >digoal-&gt; WHERE t1.app_id||':'||t1.app_ver in ('418:288','156885:9','45110:28','31447:28','210386:43','122981:46','124:78','415:234','65516:30','53142:3405',</font></div><div><font size="2"   >digoal(&gt; &nbsp; '31494:6','107873:11','532:16780560','116309:3240','282:92','47318:23','65515:154','175299:61','185800:153','72105:4330')&nbsp;</font></div><div><font size="2"   >digoal-&gt; and t1.deleted = 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;sum &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------------</font></div><div><font size="2"   >&nbsp;-1956567408</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 583.360 ms</font></div><p></p></pre></div><div><br></div><div>【优化方法二 : 】</div></div><div>使用函数索引, 把连接符改成函数. 注意函数必须是immutable的.&nbsp;</div><div>原因请参考 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201211241434248/"   >http://blog.163.com/digoal@126/blog/static/163877040201211241434248/</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create index idx_app_digoal_3 on tbl_app_digoal(concat(app_id,':',app_ver)) tablespace tbs_digoal_idx where deleted=0;</font></div><div><font size="2"   >ERROR: &nbsp;functions in index expression must be marked IMMUTABLE</font></div><p></p></pre></div><div>新建连接函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create function im_concate(numeric, numeric) returns text as $$</font></div><div><font size="2"   >&nbsp; SELECT $1||':'||$2;</font></div><div><font size="2"   >$$ language sql strict immutable;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><p></p></pre></div><div>新建索引 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create index idx_app_digoal_4 on tbl_app_digoal (im_concate(app_id,app_ver)) tablespace tbs_digoal_idx where deleted=0;</font></div><div><font size="2"   >CREATE INDEX</font></div><div><font size="2"   >-- 执行计划及查询时间</font></div><div><div><font size="2"   >digoal=&gt; explain analyze SELECT t1.id, t1.app_id, t1.app_ver, t1.cn_name, t1.app_show_ver, t1.package,&nbsp;</font></div><div><font size="2"   >&nbsp; t1.digoal_size, t1.developer_id, t1.description, t1.create_time, t1.authentic, t1.app_class_id</font></div><div><font size="2"   >FROM tbl_app_digoal t1&nbsp;</font></div><div><font size="2"   >WHERE im_concate(t1.app_id,t1.app_ver) in ('418:288','156885:9','45110:28','31447:28','210386:43','122981:46','124:78','415:234','65516:30','53142:3405',</font></div><div><font size="2"   >&nbsp; '31494:6','107873:11','532:16780560','116309:3240','282:92','47318:23','65515:154','175299:61','185800:153','72105:4330')&nbsp;</font></div><div><font size="2"   >and t1.deleted = 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;Bitmap Heap Scan on tbl_app_digoal t1 &nbsp;(cost=306.47..27176.14 rows=25738 width=625) (actual time=0.135..0.179 rows=20 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Recheck Cond: ((im_concate(app_id, app_ver) = ANY ('{418:288,156885:9,45110:28,31447:28,210386:43,122981:46,124:78,415:234,65516:</font></div><div><font size="2"   >30,53142:3405,31494:6,107873:11,532:16780560,116309:3240,282:92,47318:23,65515:154,175299:61,185800:153,72105:4330}'::text[])) AND (</font></div><div><font size="2"   >deleted = 0::numeric))</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on idx_app_digoal_4 &nbsp;(cost=0.00..300.03 rows=25738 width=0) (actual time=0.126..0.126 rows=20 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (im_concate(app_id, app_ver) = ANY ('{418:288,156885:9,45110:28,31447:28,210386:43,122981:46,124:78,415:234,655</font></div><div><font size="2"   >16:30,53142:3405,31494:6,107873:11,532:16780560,116309:3240,282:92,47318:23,65515:154,175299:61,185800:153,72105:4330}'::text[]))</font></div><div><font size="2"   >&nbsp;Total runtime: 0.211 ms</font></div><div><font size="2"   >(5 rows)</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >hash sum :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >SELECT sum(hashtext(t1.*::text))&nbsp;</font></div><div><font size="2"   >FROM tbl_app_digoal t1&nbsp;</font></div><div><font size="2"   >WHERE im_concate(t1.app_id,t1.app_ver) in ('418:288','156885:9','45110:28','31447:28','210386:43','122981:46','124:78','415:234','65516:30','53142:3405',</font></div><div><font size="2"   >&nbsp; &nbsp;'31494:6','107873:11','532:16780560','116309:3240','282:92','47318:23','65515:154','175299:61','185800:153','72105:4330')&nbsp;</font></div><div><font size="2"   >&nbsp;and t1.deleted = 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;sum &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------------</font></div><div><font size="2"   >&nbsp;-1956567408</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 583.360 ms</font></div><p></p></pre></div><div>优化方法三 :&nbsp;</div><div>如果不想自建函数, 那么使用textcat 也是可以的, textcat是immutable的 &nbsp;:&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select proname,provolatile from pg_proc where proname ~ 'cat$';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;proname &nbsp; &nbsp; | provolatile&nbsp;</font></div><div><font size="2"   >-----------------+-------------</font></div><div><font size="2"   >&nbsp;textcat &nbsp; &nbsp; &nbsp; &nbsp; | i</font></div><div><font size="2"   >&nbsp;array_cat &nbsp; &nbsp; &nbsp; | i</font></div><div><font size="2"   >&nbsp;bitcat &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| i</font></div><div><font size="2"   >&nbsp;concat &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| s</font></div><div><font size="2"   >&nbsp;textanycat &nbsp; &nbsp; &nbsp;| v</font></div><div><font size="2"   >&nbsp;anytextcat &nbsp; &nbsp; &nbsp;| v</font></div><div><font size="2"   >&nbsp;byteacat &nbsp; &nbsp; &nbsp; &nbsp;| i</font></div><div><font size="2"   >&nbsp;tsvector_concat | i</font></div><div><font size="2"   >(8 rows)</font></div><p></p></pre></div><div>新建索引 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create index idx_app_digoal_5 on tbl_app_digoal(textcat(app_id::text,textcat(':',app_ver::text))) tablespace tbs_digoal_idx where deleted=0;</font></div><div><font size="2"   >CREATE INDEX</font></div><p></p></pre></div><div>执行计划及时间 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; explain analyze SELECT t1.id, t1.app_id, t1.app_ver, t1.cn_name, t1.app_show_ver, t1.package,&nbsp;</font></div><div><font size="2"   >&nbsp; t1.digoal_size, t1.developer_id, t1.description, t1.create_time, t1.authentic, t1.app_class_id</font></div><div><font size="2"   >FROM tbl_app_digoal t1&nbsp;</font></div><div><font size="2"   >WHERE textcat(app_id::text,textcat(':',app_ver::text)) in ('418:288','156885:9','45110:28','31447:28','210386:43','122981:46','124:78','415:234','65516:30','53142:3405',</font></div><div><font size="2"   >&nbsp; '31494:6','107873:11','532:16780560','116309:3240','282:92','47318:23','65515:154','175299:61','185800:153','72105:4330')&nbsp;</font></div><div><font size="2"   >and t1.deleted = 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >--------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Bitmap Heap Scan on tbl_app_digoal t1 &nbsp;(cost=306.23..21128.58 rows=25740 width=625) (actual time=0.170..0.222 rows=20 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Recheck Cond: ((textcat((app_id)::text, textcat(':'::text, (app_ver)::text)) = ANY ('{418:288,156885:9,45110:28,31447:28,210386:4</font></div><div><font size="2"   >3,122981:46,124:78,415:234,65516:30,53142:3405,31494:6,107873:11,532:16780560,116309:3240,282:92,47318:23,65515:154,175299:61,185800</font></div><div><font size="2"   >:153,72105:4330}'::text[])) AND (deleted = 0::numeric))</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on idx_app_digoal_5 &nbsp;(cost=0.00..299.80 rows=25740 width=0) (actual time=0.163..0.163 rows=20 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (textcat((app_id)::text, textcat(':'::text, (app_ver)::text)) = ANY ('{418:288,156885:9,45110:28,31447:28,21038</font></div><div><font size="2"   >6:43,122981:46,124:78,415:234,65516:30,53142:3405,31494:6,107873:11,532:16780560,116309:3240,282:92,47318:23,65515:154,175299:61,185</font></div><div><font size="2"   >800:153,72105:4330}'::text[]))</font></div><div><font size="2"   >&nbsp;Total runtime: 0.262 ms</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div><div>HASH一致 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; SELECT sum(hashtext(t1.*::text))</font></div><div><font size="2"   >FROM tbl_app_digoal t1&nbsp;</font></div><div><font size="2"   >WHERE textcat(app_id::text,textcat(':',app_ver::text)) in ('418:288','156885:9','45110:28','31447:28','210386:43','122981:46','124:78','415:234','65516:30','53142:3405', &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; '31494:6','107873:11','532:16780560','116309:3240','282:92','47318:23','65515:154','175299:61','185800:153','72105:4330')&nbsp;</font></div><div><font size="2"   >and t1.deleted = 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;sum &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------------</font></div><div><font size="2"   >&nbsp;-1956567408</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div></div><div>【参考】</div><div>1.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012111894618801/"   >http://blog.163.com/digoal@126/blog/static/1638770402012111894618801/</a></div><div>2.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201211241434248/"   >http://blog.163.com/digoal@126/blog/static/163877040201211241434248/</a></div><wbr></div>
	</div>
</div>
</body>
</html>