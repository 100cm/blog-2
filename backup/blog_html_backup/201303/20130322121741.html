<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">CitusDB, PostgreSQLs Use Hadoop Distribute Query - 4 : Query Data IN HDFS</h2>
	<h5 id="">2013-03-22 12:17:41&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013221475935/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>前面几篇文章分别介绍了CitusDB在单台服务器上的安装和配置, file_fdw的安装和使用, 以及hadoop_sync的安装.</div><div>接下来的这篇文章将要搭建CitusDB+HDFS的环境, 利用file_fdw, hadoop_sync以及CitusDB的SQL引擎并行查询HDFS中的结构化数据.</div><div>本文的测试环境 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >OS : CentOS 5.x x64</font></div><div><span style="line-height: 22px;"   ><font size="2"   >Hadoop : 1.1.2</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >CitusDB : 2.0</font></span></div><p></p></pre></div><div>4台主机 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Hadoop namenode, CitusDB master</font></div><div><font size="2"   >172.16.3.150</font></div><div><font size="2"   >Hadoop datanode, CitusDB worker</font></div><div><font size="2"   >172.16.3.33</font></div><div><font size="2"   >172.16.3.39</font></div><div><font size="2"   >172.16.3.40</font></div><p></p></pre></div><div><br></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >首先在所有节点新建hadoop的运行以及管理用户.</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p><font size="2"   >[root@db-172-16-3-150 data06]# useradd digoal</font></p></pre></div><div style="line-height: 22px;"   >其他节点操作同上</div></div><div><br></div><div>所有节点,&nbsp;<span style="line-height: 22px;"   >下载hadoop软件包 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 opt]#&nbsp;cd /opt</font></div><div><font size="2"   >[root@db-172-16-3-150 opt]#&nbsp;wget http://ftp.cuhk.edu.hk/pub/packages/apache.org/hadoop/common/hadoop-1.1.2/hadoop-1.1.2.tar.gz</font></div><div><font size="2"   >[root@db-172-16-3-150 opt]# tar -zxvf hadoop-1.1.2.tar.gz</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# chown -R digoal:digoal /opt/hadoop-1.1.2</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >其他节点操作同上.</span></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >hadoop 安装前提要素 :&nbsp;</span></div><div><span style="line-height: 22px;"   >所有节点, 安装rsync, ssh, sshd包:&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >yum install&nbsp;</span>openssh-server</font></div><div><font size="2"   >yum install&nbsp;openssh-clients</font></div><div><font size="2"   >yum install rsync</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"   >所有节点, 配置允许使用公钥连接, 这是hadoop namenode节点远程调用datanode节点脚本的方法, 与Greenplum的管理方式类似 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/etc/ssh/sshd_config</font></div><div><font size="2"   >PubkeyAuthentication yes</font></div><p></p></pre></div></div><div><br></div><div>namenode节点, 在hadoop的管理用户下生成公钥 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - digoal</font></div><div><font size="2"   >digoal@db-172-16-3-150-&gt; ssh-keygen -t dsa -P '' -f ~/.ssh/id_dsa</font></div><div><font size="2"   >digoal@db-172-16-3-150-&gt; cat ~/.ssh/id_dsa.pub &gt;&gt; ~/.ssh/authorized_keys</font></div><div><div><font size="2"   >digoal@db-172-16-3-150-&gt; chmod 700 ~</font></div><div><font size="2"   >digoal@db-172-16-3-150-&gt; chmod 700 ~/.ssh</font></div><div><font size="2"   >digoal@db-172-16-3-150-&gt; chmod 600 ~/.ssh/authorized_keys</font></div></div><div><div><font size="2"   >digoal@db-172-16-3-150-&gt; cd .ssh</font></div><div><font size="2"   >digoal@db-172-16-3-150-&gt; cat id_dsa.pub&nbsp;</font></div><div><font size="2"   >ssh-dss AAAAB3NzaC1kc3MAAACBANBTKT4G4PZ5PC8SWrScHaB1PpVQ38BRQU2TiqeAZLU2Du2c8gP1h4XhO703R1v7K1r5isSyaVt14MIMBX5FKRUfwC7FNFMzr9VpjeprJRbDByYhsyXiMj5ziDamXq8VwUiaexfqPXbnE1n43od3M03bI1vOvXr7u8uG2BXKZXddAAAAFQCsSXXqmnwr9zlSp5Bc56WH98B67wAAAIEAoXahSqPMCpedHO5gEQcrZ00JGrnXVRx1HL7XHqNg+00ZvgqCmWr8WzYQJS5SzZ1E7PgPDLLJ/ym1AIrirYUfCttry8/YJBUO1B1jTWIvsHDblnKQPNeS4opuTcaJdklyfdeFS/sQrUU+EQfcmwpCVIY6gOduKm5PCE7xlaSZMm8AAACAEvWgs402kRZhWgvXCqOoOZhdFHLJ7h+53gmEpHa+Rhu4i7ag1RsK15q/aTt3eGFt3xbZS4GYT6LnBYM0TOB0yO3cmKoohNx1A7SZIYxnA1x48G3HFddwJdATP4xnK0VURI5JbMjkgoY2F91r5xwKdwf+Ypk7CBDVm3kjcJ+UCrU= digoal@db-172-16-3-150.sky-mobi.com</font></div></div><p></p></pre></div><div><br></div><div>datanode节点,&nbsp;<span style="line-height: 22px;"   >拷贝namenode节点的公钥id_dsa.pub的内容到本地的</span><span style="line-height: 22px;"   >~/.ssh/authorized_keys</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal@db-172-16-3-33-&gt; vi ~/.ssh/authorized_keys</font></div><div><font size="2"   >ssh-dss AAAAB3NzaC1kc3MAAACBAItGIu3Uf+vg9DatqoJt35J3cOSTJnlt8uqoRF9InRH7tWN5g4j9WE+Ol5pLjCSlpIysTxolmbZBj9muhcH4qmpLnI5Y4COVv975woHdgCUeXPeWUJ8J56cNEHLQS0KdEtd6eqQrIRpNnHEiLyv/75ID6HjOIld+JueSEQQCDxl/AAAAFQDyBVg8sB+e5zhRixuiSSEJzkiTqwAAAIBN+tkwON6kH26bNZWLK287GiZi6ymr1AdGTNVLW3cdrliFN8ENI3XQ5T7APz8bS+sgteg+Hwyz1gIfuaCw4srCInh1a3MTb2Mk4KvHK7DdplgaMWmQUjvSeoQoV6qeDJPeUoaIR5JnX4HZQLEqYO+NjPeLc4/uUKGSNycXZIqQqwAAAIBqAMd3YP6Pvu1BFyRZGslRu0us+xhEE375mpxLX1Csj4/WHWZvPHVYm3jiJVKS9s5So9a/7uKYKwTJCPZ6bBONtKEUEgu0oPMDwBlFbqj0VIf3zVaiWo34h+w2UQE6bb/pYstScqmWSn5A+mQ7uJY3HCgdKxGhm6B8k3kgc7faKw== root@db-172-16-3-150.sky-mobi.com</font></div><div><div><font size="2"   >digoal@db-172-16-3-33-&gt;&nbsp;chmod 700 ~</font></div><div><font size="2"   >digoal@db-172-16-3-33-&gt;&nbsp;chmod 700 ~/.ssh</font></div><div><font size="2"   >digoal@db-172-16-3-33-&gt;&nbsp;chmod 600 ~/.ssh/authorized_keys</font></div></div><div><font size="2"   >另外两个datanode的操作同上.</font></div><p></p></pre></div><div><br></div><div>所有节点, 在没有DNS的环境中, 需要配置namenode和datanode的主机名信息(与GreenPlum类似) :&nbsp;</div><div>不要使用1个IP对应多个主机名, 否则会带来不必要的麻烦, 见本文末尾部分.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]#&nbsp;vi /etc/hosts</font></div><div><div><font size="2"   >172.16.3.150 db-172-16-3-150.sky-mobi.com</font></div><div><font size="2"   >172.16.3.33 db-172-16-3-33.sky-mobi.com</font></div><div><font size="2"   >172.16.3.39 db-172-16-3-39.sky-mobi.com</font></div><div><font size="2"   >172.16.3.40 db-172-16-3-40.sky-mobi.com</font></div></div><p></p></pre></div><div><div><br></div><div>在namenode节点的hadoop管理用户下, 连接datanode主机的管理用户无密码认证验证 :&nbsp;</div><div><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal@db-172-16-3-150-&gt; ssh db-172-16-3-150.sky-mobi.com date</font></div><div><font size="2"   >Thu Mar 21 16:21:58 CST 2013</font></div><div><font size="2"   >digoal@db-172-16-3-150-&gt; ssh db-172-16-3-33.sky-mobi.com date</font></div><div><font size="2"   >Thu Mar 21 16:21:59 CST 2013</font></div><div><font size="2"   >digoal@db-172-16-3-150-&gt; ssh db-172-16-3-39.sky-mobi.com date</font></div><div><font size="2"   >Thu Mar 21 16:22:00 CST 2013</font></div><div><font size="2"   >digoal@db-172-16-3-150-&gt; ssh db-172-16-3-40.sky-mobi.com date</font></div><div><font size="2"   >Thu Mar 21 15:49:33 CST 2013</font></div><p></p></pre></div></div></div><div><span style="line-height: 22px;"   >所有节点,&nbsp;</span>安装java环境. 注意这里JAVA_HOME=/usr :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 opt]# yum install java</font></div><div><div><font size="2"   >[root@db-172-16-3-150 conf]# java -version</font></div><div><font size="2"   >java version "1.6.0_24"</font></div><div><font size="2"   >OpenJDK Runtime Environment (IcedTea6 1.11.9) (rhel-1.36.1.11.9.el5_9-x86_64)</font></div><div><font size="2"   >OpenJDK 64-Bit Server VM (build 20.0-b12, mixed mode)</font></div><div><font size="2"   >[root@db-172-16-3-150 conf]# which java</font></div><div><font size="2"   >/usr/bin/java</font></div></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"   >所有节点, 配置hadoop目录信息 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >hadoop 运行日志目录 :&nbsp;</font></div><div><font size="2"   >mkdir /var/log/hadoop</font></div><div><font size="2"   >chown -R digoal:digoal /var/log/hadoop</font></div><div><font size="2"   >namenode 事物日志目录 :&nbsp;</font></div><div><font size="2"   >mkdir /hadoop/tdata</font></div><div><font size="2"   ><span style="line-height: 22px;"   >chown -R digoal:digoal&nbsp;</span><span style="line-height: 22px;"   >/hadoop</span></font></div><div><font size="2"   >datanode 数据块目录 :&nbsp;</font></div><div><font size="2"   >mkdir /hadoop/data</font></div><div><font size="2"   ><span style="line-height: 22px;"   >chown -R digoal:digoal&nbsp;</span><span style="line-height: 22px;"   >/hadoop</span></font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"   >namenode节点, 配置hadoop core-site.xml, 0.0.0.0指监听所有接口</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 opt]# vi /opt/hadoop-1.1.2/conf/core-site.xml</font></div><div><div><font size="2"   >&lt;?xml version="1.0"?&gt;</font></div><div><font size="2"   >&lt;?xml-stylesheet type="text/xsl" href="configuration.xsl"?&gt;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&lt;!-- Put site-specific property overrides in this file. --&gt;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&lt;configuration&gt;</font></div><div><font size="2"   >&nbsp; &lt;property&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;name&gt;fs.default.name&lt;/name&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;value&gt;hdfs://0.0.0.0:9000&lt;/value&gt;</font></div><div><font size="2"   >&nbsp; &lt;/property&gt;</font></div><div><font size="2"   >&lt;/configuration&gt;</font></div></div><p></p></pre></div><div># namenode节点确保9000端口未被使用.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 conf]# netstat -anp|grep 9000</font></div><div><font size="2"   >[root@db-172-16-3-150 conf]#&nbsp;</font></div><p></p></pre></div><div><br></div><div>datanode 节点配置<span style="line-height: 22px;"   >hadoop core-site.xml, 注意这里配置的不是0.0.0.0, 而是namenode节点的主机名(或DNS中的名称)</span></div><div><p style="line-height: 22px;"   ></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 opt]# vi /opt/hadoop-1.1.2/conf/core-site.xml</font></div><div><font size="2"   >&lt;?xml version="1.0"?&gt;</font></div><div><font size="2"   >&lt;?xml-stylesheet type="text/xsl" href="configuration.xsl"?&gt;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&lt;!-- Put site-specific property overrides in this file. --&gt;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&lt;configuration&gt;</font></div><div><font size="2"   >&nbsp; &lt;property&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;name&gt;fs.default.name&lt;/name&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;value&gt;hdfs://db-172-16-3-150.sky-mobi.com:9000&lt;/value&gt;</font></div><div><font size="2"   >&nbsp; &lt;/property&gt;</font></div><div><font size="2"   >&lt;/configuration&gt;</font></div><div><font size="2"   ># 其他节点配置同上</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><br></div><div># 所有节点配置hadoop hdfs-site.xml</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 conf]# vi /opt/hadoop-1.1.2/conf/hdfs-site.xml</font></div><div><div><font size="2"   >&lt;?xml version="1.0"?&gt;</font></div><div><font size="2"   >&lt;?xml-stylesheet type="text/xsl" href="configuration.xsl"?&gt;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&lt;!-- Put site-specific property overrides in this file. --&gt;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&lt;configuration&gt;</font></div><div><font size="2"   >&nbsp; &lt;property&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;name&gt;dfs.name.dir&lt;/name&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;value&gt;/hadoop/tdata&lt;/value&gt;</font></div><div><font size="2"   >&nbsp; &lt;/property&gt;</font></div><div><font size="2"   >&nbsp; &lt;property&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;name&gt;dfs.data.dir&lt;/name&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;value&gt;/hadoop/data&lt;/value&gt;</font></div><div><font size="2"   >&nbsp; &lt;/property&gt;</font></div><div><font size="2"   >&nbsp; &lt;property&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;name&gt;dfs.block.local-path-access.user&lt;/name&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;value&gt;digoal&lt;/value&gt;</font></div><div><font size="2"   >&nbsp; &lt;/property&gt;</font></div><div><font size="2"   >&lt;/configuration&gt;</font></div></div><p></p></pre></div><div><br></div><div># 在<span style="line-height: 22px;"   >name node节点</span><span style="line-height: 22px;"   >配置datanode的主机信息.</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 ~]# su - digoal&nbsp;</font></div><div><font size="2"   >digoal@db-172-16-3-150-&gt; vi /opt/hadoop-1.1.2/conf/slaves</font></div></div><div><div><font size="2"   >db-172-16-3-33.sky-mobi.com</font></div><div><font size="2"   >db-172-16-3-39.sky-mobi.com</font></div><div><font size="2"   >db-172-16-3-40.sky-mobi.com</font></div></div><p></p></pre></div><div><br></div><div># 在所有节点配置hadoop运行环境配置文件.</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 22px;"   ><font size="2"   >digoal@db-172-16-3-150-&gt; which java</font></div><div style="line-height: 22px;"   ><font size="2"   >/usr/bin/java</font></div></div><div><font size="2"   >digoal@db-172-16-3-150-&gt; vi /opt/hadoop-1.1.2/conf/hadoop-env.sh</font></div><div><div><font size="2"   >export JAVA_HOME=/usr</font></div></div><div><font size="2"   >export HADOOP_LOG_DIR=/var/log/hadoop</font></div><p></p></pre></div></div><div># 确认调用hadoop-env.sh后环境变量生效.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal@db-172-16-3-150-&gt; .&nbsp;<span style="line-height: 22px;"   >/opt/hadoop-1.1.2/conf/hadoop-env.sh</span></font></div><div><font size="2"   >digoal@db-172-16-3-150-&gt; echo $JAVA_HOME</font></div><div><font size="2"   >/usr</font></div><p></p></pre></div><div><br></div><div># 在namenode节点初始化namespace信息.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal@db-172-16-3-150-&gt; /opt/hadoop-1.1.2/bin/hadoop namenode -format</font></div><div><font size="2"   >13/03/21 17:27:49 INFO namenode.NameNode: STARTUP_MSG:&nbsp;</font></div><div><font size="2"   >/************************************************************</font></div><div><font size="2"   >STARTUP_MSG: Starting NameNode</font></div><div><font size="2"   >STARTUP_MSG: &nbsp; host = db-172-16-3-150.sky-mobi.com/172.16.3.150</font></div><div><font size="2"   >STARTUP_MSG: &nbsp; args = [-format]</font></div><div><font size="2"   >STARTUP_MSG: &nbsp; version = 1.1.2</font></div><div><font size="2"   >STARTUP_MSG: &nbsp; build = https://svn.apache.org/repos/asf/hadoop/common/branches/branch-1.1 -r 1440782; compiled by 'hortonfo' on Thu Jan 31 02:03:24 UTC 2013</font></div><div><font size="2"   >************************************************************/</font></div><div><font size="2"   >Re-format filesystem in /hadoop/tdata ? (Y or N) y</font></div><div><font size="2"   >Format aborted in /hadoop/tdata</font></div><div><font size="2"   >13/03/21 17:28:07 INFO namenode.NameNode: SHUTDOWN_MSG:&nbsp;</font></div><div><font size="2"   >/************************************************************</font></div><div><font size="2"   >SHUTDOWN_MSG: Shutting down NameNode at db-172-16-3-150.sky-mobi.com/172.16.3.150</font></div><div><font size="2"   >************************************************************/</font></div><p></p></pre></div><div><div><br></div><div># 在namenode节点启动HDFS, 这里调用了start-all.sh, 实际上调用start-dfs.sh就可以了, 因为CitusDB不需要用Hadoop提供的mapreduce.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal@db-172-16-3-150-&gt; /opt/hadoop-1.1.2/bin/start-all.sh</font></div><div><font size="2"   >starting namenode, logging to /var/log/hadoop/hadoop-digoal-namenode-db-172-16-3-150.sky-mobi.com.out</font></div><div><font size="2"   >db-172-16-3-40: starting datanode, logging to /var/log/hadoop/hadoop-digoal-datanode-db-172-16-3-40.sky-mobi.com.out</font></div><div><font size="2"   >db-172-16-3-39: starting datanode, logging to /var/log/hadoop/hadoop-digoal-datanode-db-172-16-3-39.sky-mobi.com.out</font></div><div><font size="2"   >db-172-16-3-33: starting datanode, logging to /var/log/hadoop/hadoop-digoal-datanode-db-172-16-3-33.sky-mobi.com.out</font></div><div><font size="2"   >localhost: starting secondarynamenode, logging to /var/log/hadoop/hadoop-digoal-secondarynamenode-db-172-16-3-150.sky-mobi.com.out</font></div><div><font size="2"   >starting jobtracker, logging to /var/log/hadoop/hadoop-digoal-jobtracker-db-172-16-3-150.sky-mobi.com.out</font></div><div><font size="2"   >db-172-16-3-39: starting tasktracker, logging to /var/log/hadoop/hadoop-digoal-tasktracker-db-172-16-3-39.sky-mobi.com.out</font></div><div><font size="2"   >db-172-16-3-40: starting tasktracker, logging to /var/log/hadoop/hadoop-digoal-tasktracker-db-172-16-3-40.sky-mobi.com.out</font></div><div><font size="2"   >db-172-16-3-33: starting tasktracker, logging to /var/log/hadoop/hadoop-digoal-tasktracker-db-172-16-3-33.sky-mobi.com.out</font></div><p></p></pre></div></div><div><div># 启动后查看9000端口是否监听.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal@db-172-16-3-150-&gt; netstat -anp|grep 9000</font></div><div><font size="2"   >(Not all processes could be identified, non-owned process info</font></div><div><font size="2"   >&nbsp;will not be shown, you would have to be root to see it all.)</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:9000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;18985/java &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 172.16.3.150:13243 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;172.16.3.150:9000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESTABLISHED 18985/java &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 172.16.3.150:13246 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;172.16.3.150:9000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESTABLISHED 19195/java &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 172.16.3.150:9000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 172.16.3.40:22747 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESTABLISHED 18985/java &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 172.16.3.150:9000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 172.16.3.150:13243 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ESTABLISHED 18985/java &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 172.16.3.150:9000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 172.16.3.150:13246 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ESTABLISHED 18985/java &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 172.16.3.150:9000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 172.16.3.33:60047 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESTABLISHED 18985/java &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 172.16.3.150:9000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 172.16.3.39:17978 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESTABLISHED 18985/java &nbsp;</font></div><p></p></pre></div></div><div><br></div><div># 在namenode节点下载后面要用到的测试文本文件.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >[root@db-172-16-3-150 data06]#</span>&nbsp;wget http://examples.citusdata.com/customer_reviews_1998.csv.gz</font></div><div><font size="2"   ><span style="line-height: 22px;"   >[root@db-172-16-3-150&nbsp;</span><span style="line-height: 22px;"   >data06</span><span style="line-height: 22px;"   >]#</span>&nbsp;wget http://examples.citusdata.com/customer_reviews_1999.csv.gz</font></div><div><font size="2"   ><span style="line-height: 22px;"   >[root@db-172-16-3-150&nbsp;</span><span style="line-height: 22px;"   >data06</span><span style="line-height: 22px;"   >]#</span>&nbsp;gzip -d customer_reviews_1998.csv.gz</font></div><div><font size="2"   ><span style="line-height: 22px;"   >[root@db-172-16-3-150&nbsp;</span><span style="line-height: 22px;"   >data06</span><span style="line-height: 22px;"   >]#&nbsp;</span>gzip -d customer_reviews_1999.csv.gz</font></div><p></p></pre></div><div><br></div><div># 在namenode节点, 新建一个HDFS文件夹</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-150 citusdb]# su - digoal</font></span></div><div><font size="2"   >digoal@db-172-16-3-150-&gt; ./hadoop fs -mkdir /user/data/reviews</font></div><p></p></pre></div><div><br></div><div># 在namenode节点将下载好的数据导入到hdfs中.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 citusdb]# su - digoal</font></div><div><font size="2"   >digoal@db-172-16-3-150-&gt; /opt/hadoop-1.1.2/bin/hadoop fs -put /data06/customer_reviews_1998.csv /user/data/reviews</font></div><div><font size="2"   >digoal@db-172-16-3-150-&gt; /opt/hadoop-1.1.2/bin/hadoop fs -put /data06/customer_reviews_1999.csv /user/data/reviews</font></div><div><font size="2"   >digoal@db-172-16-3-150-&gt; /opt/hadoop-1.1.2/bin/hadoop fs -ls /user/data/reviews</font></div><div><font size="2"   >Found 2 items</font></div><div><font size="2"   >-rw-r--r-- &nbsp; 3 digoal supergroup &nbsp;101299118 2013-03-21 17:57 /user/data/reviews/customer_reviews_1998.csv</font></div><div><font size="2"   >-rw-r--r-- &nbsp; 3 digoal supergroup &nbsp;198247156 2013-03-21 17:57 /user/data/reviews/customer_reviews_1999.csv</font></div><p></p></pre></div><div><br></div><div># 在各个datanode节点上查看datanode 监听端口</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 hadoop]# netstat -anp|grep 50020</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:50020 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;10948/java &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >[root@db-172-16-3-33 hadoop]# ps -ewf|grep 10948</font></div><div><font size="2"   >digoal &nbsp; 10948 &nbsp; &nbsp; 1 &nbsp;2 17:53 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:05 /usr/bin/java -Dproc_datanode -Xmx1000m -server -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote -Dhadoop.log.dir=/var/log/hadoop -Dhadoop.log.file=hadoop-digoal-datanode-db-172-16-3-33.sky-mobi.com.log -Dhadoop.home.dir=/opt/hadoop-1.1.2/libexec/.. -Dhadoop.id.str=digoal -Dhadoop.root.logger=INFO,DRFA -Dhadoop.security.logger=INFO,NullAppender -Djava.library.path=/opt/hadoop-1.1.2/libexec/../lib/native/Linux-amd64-64 -Dhadoop.policy.file=hadoop-policy.xml -classpath /opt/hadoop-1.1.2/libexec/../conf:/usr/lib/tools.jar:/opt/hadoop-1.1.2/libexec/..:/opt/hadoop-1.1.2/libexec/../hadoop-core-1.1.2.jar:/opt/hadoop-1.1.2/libexec/../lib/asm-3.2.jar:/opt/hadoop-1.1.2/libexec/../lib/aspectjrt-1.6.11.jar:/opt/hadoop-1.1.2/libexec/../lib/aspectjtools-1.6.11.jar:/opt/hadoop-1.1.2/libexec/../lib/commons-beanutils-1.7.0.jar:/opt/hadoop-1.1.2/libexec/../lib/commons-beanutils-core-1.8.0.jar:/opt/hadoop-1.1.2/libexec/../lib/commons-cli-1.2.jar:/opt/hadoop-1.1.2/libexec/../lib/commons-codec-1.4.jar:/opt/hadoop-1.1.2/libexec/../lib/commons-collections-3.2.1.jar:/opt/hadoop-1.1.2/libexec/../lib/commons-configuration-1.6.jar:/opt/hadoop-1.1.2/libexec/../lib/commons-daemon-1.0.1.jar:/opt/hadoop-1.1.2/libexec/../lib/commons-digester-1.8.jar:/opt/hadoop-1.1.2/libexec/../lib/commons-el-1.0.jar:/opt/hadoop-1.1.2/libexec/../lib/commons-httpclient-3.0.1.jar:/opt/hadoop-1.1.2/libexec/../lib/commons-io-2.1.jar:/opt/hadoop-1.1.2/libexec/../lib/commons-lang-2.4.jar:/opt/hadoop-1.1.2/libexec/../lib/commons-logging-1.1.1.jar:/opt/hadoop-1.1.2/libexec/../lib/commons-logging-api-1.0.4.jar:/opt/hadoop-1.1.2/libexec/../lib/commons-math-2.1.jar:/opt/hadoop-1.1.2/libexec/../lib/commons-net-3.1.jar:/opt/hadoop-1.1.2/libexec/../lib/core-3.1.1.jar:/opt/hadoop-1.1.2/libexec/../lib/hadoop-capacity-scheduler-1.1.2.jar:/opt/hadoop-1.1.2/libexec/../lib/hadoop-fairscheduler-1.1.2.jar:/opt/hadoop-1.1.2/libexec/../lib/hadoop-thriftfs-1.1.2.jar:/opt/hadoop-1.1.2/libexec/../lib/hsqldb-1.8.0.10.jar:/opt/hadoop-1.1.2/libexec/../lib/jackson-core-asl-1.8.8.jar:/opt/hadoop-1.1.2/libexec/../lib/jackson-mapper-asl-1.8.8.jar:/opt/hadoop-1.1.2/libexec/../lib/jasper-compiler-5.5.12.jar:/opt/hadoop-1.1.2/libexec/../lib/jasper-runtime-5.5.12.jar:/opt/hadoop-1.1.2/libexec/../lib/jdeb-0.8.jar:/opt/hadoop-1.1.2/libexec/../lib/jersey-core-1.8.jar:/opt/hadoop-1.1.2/libexec/../lib/jersey-json-1.8.jar:/opt/hadoop-1.1.2/libexec/../lib/jersey-server-1.8.jar:/opt/hadoop-1.1.2/libexec/../lib/jets3t-0.6.1.jar:/opt/hadoop-1.1.2/libexec/../lib/jetty-6.1.26.jar:/opt/hadoop-1.1.2/libexec/../lib/jetty-util-6.1.26.jar:/opt/hadoop-1.1.2/libexec/../lib/jsch-0.1.42.jar:/opt/hadoop-1.1.2/libexec/../lib/junit-4.5.jar:/opt/hadoop-1.1.2/libexec/../lib/kfs-0.2.2.jar:/opt/hadoop-1.1.2/libexec/../lib/log4j-1.2.15.jar:/opt/hadoop-1.1.2/libexec/../lib/mockito-all-1.8.5.jar:/opt/hadoop-1.1.2/libexec/../lib/oro-2.0.8.jar:/opt/hadoop-1.1.2/libexec/../lib/servlet-api-2.5-20081211.jar:/opt/hadoop-1.1.2/libexec/../lib/slf4j-api-1.4.3.jar:/opt/hadoop-1.1.2/libexec/../lib/slf4j-log4j12-1.4.3.jar:/opt/hadoop-1.1.2/libexec/../lib/xmlenc-0.52.jar:/opt/hadoop-1.1.2/libexec/../lib/jsp-2.1/jsp-2.1.jar:/opt/hadoop-1.1.2/libexec/../lib/jsp-2.1/jsp-api-2.1.jar org.apache.hadoop.hdfs.server.datanode.DataNode</font></div><p></p></pre></div><div><br></div><div># 在namenode节点上可以看到HDFS的报告</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal@db-172-16-3-150-&gt; /opt/hadoop-1.1.2/bin/hadoop dfsadmin -report</font></div><div><font size="2"   >Configured Capacity: 229023145984 (213.29 GB)</font></div><div><font size="2"   >Present Capacity: 126058467328 (117.4 GB)</font></div><div><font size="2"   >DFS Remaining: 125152571392 (116.56 GB)</font></div><div><font size="2"   >DFS Used: 905895936 (863.93 MB)</font></div><div><font size="2"   >DFS Used%: 0.72%</font></div><div><font size="2"   >Under replicated blocks: 0</font></div><div><font size="2"   >Blocks with corrupt replicas: 0</font></div><div><font size="2"   >Missing blocks: 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-------------------------------------------------</font></div><div><font size="2"   >Datanodes available: 3 (3 total, 0 dead)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Name: 172.16.3.33:50010</font></div><div><font size="2"   >Decommission Status : Normal</font></div><div><font size="2"   >Configured Capacity: 144471613440 (134.55 GB)</font></div><div><font size="2"   >DFS Used: 301965312 (287.98 MB)</font></div><div><font size="2"   >Non DFS Used: 96595206144 (89.96 GB)</font></div><div><font size="2"   >DFS Remaining: 47574441984(44.31 GB)</font></div><div><font size="2"   >DFS Used%: 0.21%</font></div><div><font size="2"   >DFS Remaining%: 32.93%</font></div><div><font size="2"   >Last contact: Thu Mar 21 20:41:48 CST 2013</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Name: 172.16.3.39:50010</font></div><div><font size="2"   >Decommission Status : Normal</font></div><div><font size="2"   >Configured Capacity: 42275766272 (39.37 GB)</font></div><div><font size="2"   >DFS Used: 301965312 (287.98 MB)</font></div><div><font size="2"   >Non DFS Used: 2332004352 (2.17 GB)</font></div><div><font size="2"   >DFS Remaining: 39641796608(36.92 GB)</font></div><div><font size="2"   >DFS Used%: 0.71%</font></div><div><font size="2"   >DFS Remaining%: 93.77%</font></div><div><font size="2"   >Last contact: Thu Mar 21 20:41:48 CST 2013</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Name: 172.16.3.40:50010</font></div><div><font size="2"   >Decommission Status : Normal</font></div><div><font size="2"   >Configured Capacity: 42275766272 (39.37 GB)</font></div><div><font size="2"   >DFS Used: 301965312 (287.98 MB)</font></div><div><font size="2"   >Non DFS Used: 4037468160 (3.76 GB)</font></div><div><font size="2"   >DFS Remaining: 37936332800(35.33 GB)</font></div><div><font size="2"   >DFS Used%: 0.71%</font></div><div><font size="2"   >DFS Remaining%: 89.74%</font></div><div><font size="2"   >Last contact: Thu Mar 21 20:41:48 CST 2013</font></div><p></p></pre></div><div><br></div><div># 接下来需要配置CitusDB</div><div>CitusDB master节点与Hadoop namenode放在一台主机上.</div><div>CitusDB worker节点与<span style="line-height: 22px;"   >Hadoop datanode放在一起.</span></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   ># 所有节点, 创建citusdb运行用户</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# useradd citusdb</font></div><div><font size="2"   >#其他节点操作同上</font></div></pre></div><div># 所有节点, 下载citusdb</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 ~]# su - citusdb</font></div><div><font size="2"   >[citusdb@db-172-16-3-150 ~]$ wget http://packages.citusdata.com/readline-5.0/citusdb-2.0.0-1.x86_64.rpm</font></div></div><div><font size="2"   ># 将安装包拷贝到其他节点</font></div><div><font size="2"   >[root@db-172-16-3-150 citusdb]# scp citusdb-2.0.0-1.x86_64.rpm 172.16.3.33:/home/citusdb/</font></div><div><font size="2"   >[root@db-172-16-3-150 citusdb]# scp citusdb-2.0.0-1.x86_64.rpm 172.16.3.39:/home/citusdb/</font></div><div><font size="2"   >[root@db-172-16-3-150 citusdb]# scp citusdb-2.0.0-1.x86_64.rpm 172.16.3.40:/home/citusdb/</font></div></pre></div><div># 所有节点, 安装citusdb</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# rpm -ivh /home/citusdb/citusdb-2.0.0-1.x86_64.rpm&nbsp;</font></div><div><font size="2"   >[root@db-172-16-3-33 ~]# rpm -ivh /home/citusdb/citusdb-2.0.0-1.x86_64.rpm&nbsp;</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# rpm -ivh /home/citusdb/citusdb-2.0.0-1.x86_64.rpm&nbsp;</font></div><div><font size="2"   >[root@db-172-16-3-40 ~]# rpm -ivh /home/citusdb/citusdb-2.0.0-1.x86_64.rpm&nbsp;</font></div><p></p></pre></div><div>PostgreSQL9.2.1将安装在/opt/citusdb/2,0目录,&nbsp;<span style="line-height: 22px;"   >数据目录在/opt/citusdb/2.0/data</span></div><div><br></div><div># 所有节点, 修改citusdb权限</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 opt]# chown -R citusdb:citusdb /opt/citusdb</font></div><div><font size="2"   >其他节点操作同上</font></div></pre></div><div># 以下两步略, 因为citusdb-2.0.0-1.x86_64.rpm安装过程中自动初始化了数据库, 如果没有初始化则需要手工初始化一下.</div><div>所有节点, 创建数据目录, 建议目录一致</div><div>所有节点, 初始化数据库</div><div><br></div><div># 主节点配置work list</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 opt]# vi /opt/citusdb/2.0/data/pg_worker_list.conf</font></div><div><div><font size="2"   >db-172-16-3-33.sky-mobi.com 9900</font></div><div><font size="2"   >db-172-16-3-39.sky-mobi.com 9900</font></div><div><font size="2"   >db-172-16-3-40.sky-mobi.com 9900</font></div></div><div><font size="2"   ># 后面配置postgresql.conf中, worker节点数据库监听9900端口.</font></div></pre></div><div># 主节点配置postgresql.conf, pg_hba.conf</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 opt]# vi /opt/citusdb/2.0/data/postgresql.conf</font></div><div><div><font size="2"   >listen_addresses = '0.0.0.0'</font></div><div><font size="2"   >port = 9900</font></div><div><font size="2"   >unix_socket_directory = '.'</font></div><div><font size="2"   >unix_socket_permissions = 0700</font></div><div><font size="2"   >tcp_keepalives_idle = 60</font></div><div><font size="2"   >tcp_keepalives_interval = 10</font></div><div><font size="2"   >tcp_keepalives_count = 10</font></div><div><font size="2"   >shared_buffers = 2048MB</font></div><div><font size="2"   >maintenance_work_mem = 1024MB</font></div><div><font size="2"   >max_stack_depth = 8MB</font></div><div><font size="2"   >synchronous_commit = off</font></div><div><font size="2"   >wal_buffers = 16384kB</font></div><div><font size="2"   >wal_writer_delay = 10ms</font></div><div><font size="2"   >checkpoint_segments = 32</font></div><div><font size="2"   >random_page_cost = 1.0</font></div><div><font size="2"   >effective_cache_size = 81920MB</font></div><div><font size="2"   >log_destination = 'csvlog'</font></div><div><font size="2"   >logging_collector = on</font></div><div><font size="2"   >log_directory = 'pg_log'</font></div><div><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'</font></div><div><font size="2"   >log_file_mode = 0600</font></div><div><font size="2"   >log_truncate_on_rotation = on</font></div><div><font size="2"   >log_rotation_age = 1d</font></div><div><font size="2"   >log_rotation_size = 10MB</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_disconnections = on</font></div><div><font size="2"   >log_error_verbosity = verbose</font></div><div><font size="2"   >autovacuum = on</font></div><div><font size="2"   >log_autovacuum_min_duration = 0</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-150 data]# vi /opt/citusdb/2.0/data/pg_hba.conf</font></div><div><div><font size="2"   >host all all 127.0.0.1/32 trust</font></div><div><font size="2"   >host all all 172.16.3.150/32 trust</font></div><div><font size="2"   >host all all 172.16.3.33/32 trust</font></div><div><font size="2"   >host all all 172.16.3.39/32 trust</font></div><div><font size="2"   >host all all 172.16.3.40/32 trust</font></div><div><font size="2"   >host all all 0.0.0.0/0 md5</font></div></div><div><font size="2"   ># 允许127.0.0.1 trust认证, 主要用于hadoop-sync进程使用</font></div></pre></div><div># worker节点配置postgresql.conf, pg_hba.conf</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-33 opt]# vi /opt/citusdb/2.0/data/postgresql.conf</font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >listen_addresses = '0.0.0.0'</font></div><div style="line-height: 22px;"   ><font size="2"   >port = 9900</font></div><div style="line-height: 22px;"   ><font size="2"   >unix_socket_directory = '.'</font></div><div style="line-height: 22px;"   ><font size="2"   >unix_socket_permissions = 0700</font></div><div style="line-height: 22px;"   ><font size="2"   >tcp_keepalives_idle = 60</font></div><div style="line-height: 22px;"   ><font size="2"   >tcp_keepalives_interval = 10</font></div><div style="line-height: 22px;"   ><font size="2"   >tcp_keepalives_count = 10</font></div><div style="line-height: 22px;"   ><font size="2"   >shared_buffers = 2048MB</font></div><div style="line-height: 22px;"   ><font size="2"   >maintenance_work_mem = 1024MB</font></div><div style="line-height: 22px;"   ><font size="2"   >max_stack_depth = 8MB</font></div><div style="line-height: 22px;"   ><font size="2"   >synchronous_commit = off</font></div><div style="line-height: 22px;"   ><font size="2"   >wal_buffers = 16384kB</font></div><div style="line-height: 22px;"   ><font size="2"   >wal_writer_delay = 10ms</font></div><div style="line-height: 22px;"   ><font size="2"   >checkpoint_segments = 32</font></div><div style="line-height: 22px;"   ><font size="2"   >random_page_cost = 1.0</font></div><div style="line-height: 22px;"   ><font size="2"   >effective_cache_size = 81920MB</font></div><div style="line-height: 22px;"   ><font size="2"   >log_destination = 'csvlog'</font></div><div style="line-height: 22px;"   ><font size="2"   >logging_collector = on</font></div><div style="line-height: 22px;"   ><font size="2"   >log_directory = 'pg_log'</font></div><div style="line-height: 22px;"   ><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'</font></div><div style="line-height: 22px;"   ><font size="2"   >log_file_mode = 0600</font></div><div style="line-height: 22px;"   ><font size="2"   >log_truncate_on_rotation = on</font></div><div style="line-height: 22px;"   ><font size="2"   >log_rotation_age = 1d</font></div><div style="line-height: 22px;"   ><font size="2"   >log_rotation_size = 10MB</font></div><div style="line-height: 22px;"   ><font size="2"   >log_checkpoints = on</font></div><div style="line-height: 22px;"   ><font size="2"   >log_connections = on</font></div><div style="line-height: 22px;"   ><font size="2"   >log_disconnections = on</font></div><div style="line-height: 22px;"   ><font size="2"   >log_error_verbosity = verbose</font></div><div style="line-height: 22px;"   ><font size="2"   >autovacuum = on</font></div><div style="line-height: 22px;"   ><font size="2"   >log_autovacuum_min_duration = 0</font></div></div></div><div><font size="2"   ><br></font></div><div><div style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-33 data]# vi /opt/citusdb/2.0/data/pg_hba.conf</font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >host all all 172.16.3.150/32 trust</font></div><div style="line-height: 22px;"   ><font size="2"   >host all all 172.16.3.33/32 trust</font></div><div style="line-height: 22px;"   ><font size="2"   >host all all 172.16.3.39/32 trust</font></div><div style="line-height: 22px;"   ><font size="2"   >host all all 172.16.3.40/32 trust</font></div><div style="line-height: 22px;"   ><font size="2"   >host all all 0.0.0.0/0 md5</font></div><div style="line-height: 22px;"   ><font size="2"   ># 其他节点操作同上</font></div></div></div></pre></div></div><div><div style="line-height: 22px;"   ># 所有节点配置citusdb用户环境变量</div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 data]# vi /home/citusdb/.bash_profile</font></div><div><div><font size="2"   >export PS1="$USER@`/bin/hostname -s`-&gt; "</font></div><div><font size="2"   >export PGPORT=9900</font></div><div><font size="2"   >export PGUSER=postgres</font></div><div><font size="2"   >export PGDATA=/opt/citusdb/2.0/data</font></div><div><font size="2"   >export PGHOST=$PGDATA</font></div><div><font size="2"   >export PGDATABASE=digoal</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/opt/citusdb/2.0</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:$PGHOME/lib/postgresql:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >#export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"   >export LD_PRELOAD=/usr/lib64/libncurses.so</font></div><div><font size="2"   >alias rm='rm -i'</font></div><div><font size="2"   >alias ll='ls -lh'</font></div></div></pre></div><div># 启动citusdb集群</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 data]# su - citusdb</font></div><div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; pg_ctl start -D $PGDATA</font></div><div><font size="2"   >server starting</font></div></div><div><div><font size="2"   >[root@db-172-16-3-33 data]# su - citusdb</font></div><div><font size="2"   >citusdb@db-172-16-3-33-&gt; pg_ctl start -D $PGDATA</font></div><div><font size="2"   >server starting</font></div></div><div><div><font size="2"   >[root@db-172-16-3-39 data]# su - citusdb</font></div><div><font size="2"   >citusdb@db-172-16-3-39-&gt; pg_ctl start -D $PGDATA</font></div><div><font size="2"   >server starting</font></div></div><div><div><font size="2"   >[root@db-172-16-3-40 data]# su - citusdb</font></div><div><font size="2"   >citusdb@db-172-16-3-40-&gt; pg_ctl start -D $PGDATA</font></div><div><font size="2"   >server starting</font></div></div></pre></div><div># 所有节点在postgres数据库下面安装file_fdw (目前hadoop_sync不支持配置数据库名以及schema)</div><div>细节参考 :&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020132192011747/"   >http://blog.163.com/digoal@126/blog/static/16387704020132192011747/</a></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   ># 下载</font></div><div><font size="2"   >[root@db-172-16-3-150 soft_bak]# su - citusdb</font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; wget --no-check-certificate https://github.com/citusdata/file_fdw/archive/master.zip</font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; unzip master</font></div><div><font size="2"   >Archive: &nbsp;master</font></div><div><font size="2"   ># 编译安装</font></div><div><font size="2"   >su - root</font></div><div><font size="2"   >[root@db-172-16-3-150 data05]# . /home/citusdb/.bash_profile&nbsp;</font></div><div><font size="2"   >root@db-172-16-3-150-&gt; which pg_config</font></div><div><font size="2"   >/opt/citusdb/2.0/bin/pg_config</font></div><div><font size="2"   >root@db-172-16-3-150-&gt; cd /home/citusdb/file_fdw-master/</font></div><div><font size="2"   >root@db-172-16-3-150-&gt; gmake USE_PGXS=1 clean</font></div><div><font size="2"   >root@db-172-16-3-150-&gt; gmake USE_PGXS=1</font></div><div><font size="2"   >root@db-172-16-3-150-&gt; gmake USE_PGXS=1 install</font></div></div><div><font size="2"   >其他节点操作同上</font></div></pre></div><div># 主节点<span style="line-height: 22px;"   >在postgres数据库下面</span><span style="line-height: 22px;"   >创建外部表</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >root@db-172-16-3-150-&gt; psql postgres postgres</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><div><font size="2"   >postgres=# create extension file_fdw;</font></div><div><font size="2"   >CREATE EXTENSION</font></div></div></div><div><div><font size="2"   >postgres=# CREATE SERVER file_server FOREIGN DATA WRAPPER file_fdw;</font></div><div><font size="2"   >CREATE SERVER</font></div></div><div><div><font size="2"   >postgres=# CREATE FOREIGN TABLE customer_reviews</font></div><div><font size="2"   >(</font></div><div><font size="2"   >&nbsp; &nbsp; customer_id TEXT not null,</font></div><div><font size="2"   >&nbsp; &nbsp; review_date DATE not null,</font></div><div><font size="2"   >&nbsp; &nbsp; review_rating INTEGER not null,</font></div><div><font size="2"   >&nbsp; &nbsp; review_votes INTEGER,</font></div><div><font size="2"   >&nbsp; &nbsp; review_helpful_votes INTEGER,</font></div><div><font size="2"   >&nbsp; &nbsp; product_id CHAR(10) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; product_title TEXT not null,</font></div><div><font size="2"   >&nbsp; &nbsp; product_sales_rank BIGINT,</font></div><div><font size="2"   >&nbsp; &nbsp; product_group TEXT,</font></div><div><font size="2"   >&nbsp; &nbsp; product_category TEXT,</font></div><div><font size="2"   >&nbsp; &nbsp; product_subcategory TEXT,</font></div><div><font size="2"   >&nbsp; &nbsp; similar_product_ids CHAR(10)[]</font></div><div><font size="2"   >)</font></div><div><font size="2"   >DISTRIBUTE BY APPEND (review_date)</font></div><div><font size="2"   >SERVER file_server</font></div><div><font size="2"   >OPTIONS (filename '', hdfs_directory_path '/user/data/reviews', format 'csv');</font></div><div><font size="2"   >CREATE FOREIGN TABLE</font></div></div><div><font size="2"   ># 注意这个目录<span style="line-height: 22px;"   >/user/data/reviews是HDFS中的目录.</span></font></div></pre></div><div><span style="line-height: 22px;"   ># 主节点安装hadoop_sync</span></div><div><span style="line-height: 22px;"   >细节参考 :&nbsp;</span><a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020132189835346/"   >http://blog.163.com/digoal@126/blog/static/16387704020132189835346/</a></div><div><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >wget http://mirror.bjtu.edu.cn/apache/maven/maven-3/3.0.5/binaries/apache-maven-3.0.5-bin.tar.gz</font></div><div><font size="2"   >tar -zxvf apache-maven-3.0.5-bin.tar.gz</font></div><div><font size="2"   >mv apache-maven-3.0.5 /opt/</font></div><div><font size="2"   >yum install java</font></div><div><font size="2"   >java -version</font></div><div><font size="2"   >which java</font></div><div><font size="2"   >yum install java-devel</font></div><div><font size="2"   >javac -version</font></div><div><font size="2"   >which javac</font></div><div><font size="2"   >vi ~/.bash_profile</font></div><div><font size="2"   >export M2_HOME=/opt/apache-maven-3.0.5</font></div><div><font size="2"   >export M2=$M2_HOME/bin</font></div><div><font size="2"   >export MAVEN_OPTS="-Xms256m -Xmx512m"</font></div><div><font size="2"   >export JAVA_HOME=/usr</font></div><div><font size="2"   >export PATH=$M2:$JAVA_HOME/bin:$PATH:.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >. ~/.bash_profile</font></div><div><font size="2"   >mvn --version</font></div><div><font size="2"   >cd /home/citusdb/</font></div><div><font size="2"   >wget --no-check-certificate https://github.com/citusdata/hadoop-sync/archive/master.zip -O hadoop-sync.zip</font></div><div><font size="2"   >unzip hadoop-sync.zip</font></div><div><font size="2"   >cd hadoop-sync-master</font></div><div><font size="2"   >mvn install</font></div><div><font size="2"   >[root@db-172-16-3-150 hadoop-sync-master]# ll</font></div><div><font size="2"   >total 16</font></div><div><font size="2"   >-rw-r--r-- 1 root root 2533 Feb 16 04:56 pom.xml</font></div><div><font size="2"   >-rw-r--r-- 1 root root 3047 Feb 16 04:56 README.md</font></div><div><font size="2"   >drwxr-xr-x 3 root root 4096 Feb 16 04:56 src</font></div><div><font size="2"   >drwxr-xr-x 7 root root 4096 Mar 22 09:15 target</font></div></pre></div></div><div>#&nbsp;<span style="line-height: 22px;"   >主节点</span><span style="line-height: 22px;"   >配置hadoop-sync, 一定要配置为hadoop的启动用户, 否则会有hadoop block get权限问题.</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-150 hadoop-sync-master]# mkdir /opt/hadoop-sync</font></div><div style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-150 hadoop-sync-master]# mv /home/citusdb/hadoop-sync-master/target /opt/hadoop-sync/</font></div><div><font size="2"   >[root@db-172-16-3-150 hadoop-sync-master]# chown -R digoal:digoal /opt/hadoop-sync</font></div></div><div><div><font size="2"   >[root@db-172-16-3-150 hadoop-sync-master]# su - digoal</font></div><div><font size="2"   >digoal@db-172-16-3-150-&gt;&nbsp;cd /opt/hadoop-sync/</font></div></div><div><font size="2"   >digoal@db-172-16-3-150-&gt; cp target/classes/sync.properties .</font></div><div><font size="2"   >digoal@db-172-16-3-150-&gt; vi /opt/hadoop-sync/sync.properties</font></div><div><div><font size="2"   ># HDFS related cluster configuration settings</font></div><div><font size="2"   >HdfsMasterNodeName =&nbsp;127.0.0.1</font></div><div><font size="2"   >HdfsMasterNodePort = 9000</font></div><div><font size="2"   >HdfsWorkerNodePort = 50020</font></div><div><font size="2"   ># CitusDB related cluster configuration settings</font></div><div><font size="2"   >CitusMasterNodeName = 127.0.0.1</font></div><div><font size="2"   >CitusMasterNodePort = 9900</font></div><div><font size="2"   >CitusWorkerNodePort = 9900</font></div></div></pre></div></div><div><span style="line-height: 22px;"   ># 主节点运行hadoop_sync同步namenode中的元数据.</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-150 hadoop-sync-master]# su - digoal</font></span></div><div><font size="2"   >digoal@db-172-16-3-150-&gt; java -jar /opt/hadoop-sync/target/hadoop-sync-0.1.jar customer_reviews --fetch-min-max</font></div></pre></div><div><span style="line-height: 22px;"   ># SQL查询</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-150 hdfs]# su - citusdb</font></span></div><div><div style="line-height: 22px;"   ><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 9900 -U digoal postgres</font></div><div style="line-height: 22px;"   ><font size="2"   >psql (9.2.1)</font></div><div style="line-height: 22px;"   ><font size="2"   >Type "help" for help.</font></div><div><div><font size="2"   >postgres=# select count(*) from customer_reviews ;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1762499</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 3101.759 ms</font></div></div></div></div><div><div><font size="2"   >postgres=# select * from customer_reviews limit 1;</font></div><div><font size="2"   >&nbsp; customer_id &nbsp;| review_date | review_rating | review_votes | review_helpful_votes | product_id | &nbsp; &nbsp; &nbsp;product_title &nbsp; &nbsp; &nbsp;| product_</font></div><div><font size="2"   >sales_rank | product_group | product_category | product_subcategory | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; similar_product_ids &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------+-------------+---------------+--------------+----------------------+------------+-------------------------+---------</font></div><div><font size="2"   >-----------+---------------+------------------+---------------------+----------------------------------------------------------</font></div><div><font size="2"   >&nbsp;AQV87I9Y4CIQF | 1998-09-06 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 56 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 55 | 1561580368 | Building for a Lifetime | &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; 215662 | Book &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Home &amp; Garden &nbsp; &nbsp;| Home Design &nbsp; &nbsp; &nbsp; &nbsp; | {1589230612,1881955656,0140258094,1931498113,0070171513}</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 604.151 ms</font></div></div><div><div><font size="2"   >postgres=# select * from pg_dist_partition ;</font></div><div><font size="2"   >&nbsp;logicalrelid | partmethod | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;partkey &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------+------------+--------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16403 | a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {VAR :varno 1 :varattno 2 :vartype 1082 :vartypmod -1 :varcollid 0 :varlevelsup 0 :varnoold 1 :varoattn</font></div><div><font size="2"   >o 2 :location 436}</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 0.386 ms</font></div><div><font size="2"   >postgres=# select * from pg_dist_shard;</font></div><div><font size="2"   >&nbsp;logicalrelid | &nbsp; &nbsp; &nbsp; shardid &nbsp; &nbsp; &nbsp; &nbsp;| shardstorage | shardalias | shardminvalue | shardmaxvalue&nbsp;</font></div><div><font size="2"   >--------------+----------------------+--------------+------------+---------------+---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16403 | -1221512698612183530 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1999-01-01 &nbsp; &nbsp;| 1999-05-13</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16403 | &nbsp;2698407172708592541 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1999-05-13 &nbsp; &nbsp;| 1999-09-11</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16403 | &nbsp; 631600631725577683 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1998-09-06 &nbsp; &nbsp;| 1998-12-31</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16403 | -2048097437225231483 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1999-09-11 &nbsp; &nbsp;| 1999-12-31</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16403 | &nbsp;3598423008504059948 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1970-12-30 &nbsp; &nbsp;| 1998-09-06</font></div><div><font size="2"   >(5 rows)</font></div><div><font size="2"   >Time: 0.502 ms</font></div><div><font size="2"   >postgres=# select * from pg_dist_shard_placement ;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;shardid &nbsp; &nbsp; &nbsp; &nbsp;| shardstate | shardlength | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nodename &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | nodeport&nbsp;</font></div><div><font size="2"   >----------------------+------------+-------------+-----------------------------+----------</font></div><div><font size="2"   >&nbsp;-2048097437225231483 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;64029428 | db-172-16-3-33.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp;-2048097437225231483 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;64029428 | db-172-16-3-39.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp;-2048097437225231483 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;64029428 | db-172-16-3-40.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp;-1221512698612183530 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;67108864 | db-172-16-3-33.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp;-1221512698612183530 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;67108864 | db-172-16-3-39.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp;-1221512698612183530 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;67108864 | db-172-16-3-40.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp; &nbsp;631600631725577683 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;34190254 | db-172-16-3-33.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp; &nbsp;631600631725577683 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;34190254 | db-172-16-3-39.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp; &nbsp;631600631725577683 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;34190254 | db-172-16-3-40.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp; 2698407172708592541 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;67108864 | db-172-16-3-33.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp; 2698407172708592541 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;67108864 | db-172-16-3-39.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp; 2698407172708592541 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;67108864 | db-172-16-3-40.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp; 3598423008504059948 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;67108864 | db-172-16-3-33.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp; 3598423008504059948 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;67108864 | db-172-16-3-39.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp; 3598423008504059948 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;67108864 | db-172-16-3-40.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >(15 rows)</font></div><div><font size="2"   >Time: 0.541 ms</font></div></div><p></p></pre></div></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# SELECT</font></div><div><font size="2"   >&nbsp; &nbsp; customer_id, review_date, review_rating, product_id, product_title</font></div><div><font size="2"   >FROM</font></div><div><font size="2"   >&nbsp; &nbsp; customer_reviews</font></div><div><font size="2"   >WHERE</font></div><div><font size="2"   >&nbsp; &nbsp; customer_id ='A27T7HVDXA3K2A' AND</font></div><div><font size="2"   >&nbsp; &nbsp; product_title LIKE '%Dune%' AND</font></div><div><font size="2"   >&nbsp; &nbsp; review_date &gt;= '1998-01-01' AND</font></div><div><font size="2"   >&nbsp; &nbsp; review_date &lt;= '1998-12-31';</font></div><div><font size="2"   >&nbsp; customer_id &nbsp; | review_date | review_rating | product_id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; product_title &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----------------+-------------+---------------+------------+-----------------------------------------------</font></div><div><font size="2"   >&nbsp;A27T7HVDXA3K2A | 1998-04-10 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 | 0399128964 | Dune (Dune Chronicles (Econo-Clad Hardcover))</font></div><div><font size="2"   >&nbsp;A27T7HVDXA3K2A | 1998-04-10 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 | 044100590X | Dune</font></div><div><font size="2"   >&nbsp;A27T7HVDXA3K2A | 1998-04-10 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 | 0441172717 | Dune (Dune Chronicles, Book 1)</font></div><div><font size="2"   >&nbsp;A27T7HVDXA3K2A | 1998-04-10 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 | 0881036366 | Dune (Dune Chronicles (Econo-Clad Hardcover))</font></div><div><font size="2"   >&nbsp;A27T7HVDXA3K2A | 1998-04-10 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 | 1559949570 | Dune Audio Collection</font></div><div><font size="2"   >(5 rows)</font></div><div><font size="2"   >Time: 3102.624 ms</font></div></div><div><div><font size="2"   >postgres=# SELECT</font></div><div><font size="2"   >&nbsp; &nbsp; width_bucket(length(product_title), 1, 50, 5) title_length_bucket,</font></div><div><font size="2"   >&nbsp; &nbsp; round(avg(review_rating), 2) AS review_average,</font></div><div><font size="2"   >&nbsp; &nbsp; count(*)</font></div><div><font size="2"   >FROM</font></div><div><font size="2"   >&nbsp; &nbsp;customer_reviews</font></div><div><font size="2"   >WHERE</font></div><div><font size="2"   >&nbsp; &nbsp; product_group = 'Book'</font></div><div><font size="2"   >GROUP BY</font></div><div><font size="2"   >&nbsp; &nbsp; title_length_bucket</font></div><div><font size="2"   >ORDER BY</font></div><div><font size="2"   >&nbsp; &nbsp; title_length_bucket;</font></div><div><font size="2"   >&nbsp;title_length_bucket | review_average | count &nbsp;</font></div><div><font size="2"   >---------------------+----------------+--------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4.26 | 139034</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4.24 | 411317</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4.34 | 245670</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4.32 | 167361</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4.30 | 118421</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4.40 | 116411</font></div><div><font size="2"   >(6 rows)</font></div><div><font size="2"   >Time: 3403.387 ms</font></div></div><p></p></pre></div><div><br></div><div><br></div><div>[注意]</div><div>1. namenode的事物日志目录建议不要使用软链接. 否则namenode format 的时候可能会有问题.</div><div>2.&nbsp;<span style="line-height: 22px;"   >目前hadoop_sync不支持配置数据库角色,数据库名以及schema</span></div><div>因为CitusWorkerNode.java中链接worker节点的URL被固定了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* connection string format used in connecting to worker node */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; private static final String CONNECTION_STRING_FORMAT =</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "jdbc:postgresql://%s:%d/postgres";</font></div><p></p></pre></div><div>连接数据库的角色无法指定 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; java -jar /opt/hadoop-sync/target/hadoop-sync-0.1.jar customer_reviews --fetch-min-max</font></div><div><font size="2"   >2013-03-22 09:35:29,626 [main] ERROR hdfs.HdfsSynchronizer - could not synchronize table metadata</font></div><div><font size="2"   >org.postgresql.util.PSQLException: FATAL: role "citusdb" does not exist</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at org.postgresql.core.v3.ConnectionFactoryImpl.readStartupMessages(ConnectionFactoryImpl.java:469)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at org.postgresql.core.v3.ConnectionFactoryImpl.openConnectionImpl(ConnectionFactoryImpl.java:112)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at org.postgresql.core.ConnectionFactory.openConnection(ConnectionFactory.java:66)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at org.postgresql.jdbc2.AbstractJdbc2Connection.&lt;init&gt;(AbstractJdbc2Connection.java:125)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at org.postgresql.jdbc3.AbstractJdbc3Connection.&lt;init&gt;(AbstractJdbc3Connection.java:30)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at org.postgresql.jdbc3g.AbstractJdbc3gConnection.&lt;init&gt;(AbstractJdbc3gConnection.java:22)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at org.postgresql.jdbc4.AbstractJdbc4Connection.&lt;init&gt;(AbstractJdbc4Connection.java:30)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at org.postgresql.jdbc4.Jdbc4Connection.&lt;init&gt;(Jdbc4Connection.java:24)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at org.postgresql.Driver.makeConnection(Driver.java:393)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at org.postgresql.Driver.connect(Driver.java:267)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at java.sql.DriverManager.getConnection(DriverManager.java:620)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at java.sql.DriverManager.getConnection(DriverManager.java:222)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at com.citusdata.sync.hdfs.CitusMasterNode.&lt;init&gt;(CitusMasterNode.java:81)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at com.citusdata.sync.hdfs.HdfsSynchronizer.calculateMetadataDifference(HdfsSynchronizer.java:152)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at com.citusdata.sync.hdfs.HdfsSynchronizer.main(HdfsSynchronizer.java:69)</font></div></div><div><font size="2"   >解决办法, master和worker节点新建调用<span style="line-height: 22px;"   >hadoop-sync脚本的操作系统</span><span style="line-height: 22px;"   >角色.(本例为digoal用户)</span></font></div><div><div><font size="2"   >[root@db-172-16-3-150 hadoop]# su - citusdb</font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql postgres postgres</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# create role digoal superuser login encrypted password 'DigoAL';</font></div><div><font size="2"   >CREATE ROLE</font></div></div><div><font size="2"   ># 其他worker节点操作同上</font></div></pre></div><div>3. hadoop 的getBlockLocalPathInfo只能使用启用Hadoop的用户调用. 如果使用其他用户, 如citusdb则会报错如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2013-03-22 10:45:00,859 ERROR org.apache.hadoop.security.UserGroupInformation: PriviledgedActionException as:citusdb cause:org.apache.hadoop.security.AccessControlException: Can't continue with getBlockLocalPathInfo() authorization. The user citusdb is not allowed to call getBlockLocalPathInfo</font></div><div><font size="2"   >解决办法, 使用hadoop用户执行hadoop-sync脚本.</font></div><div><font size="2"   >[root@db-172-16-3-150 opt]# chown -R digoal:digoal hadoop-sync</font></div><div><font size="2"   >[root@db-172-16-3-150 opt]# su - digoal</font></div><div><div><font size="2"   >digoal@db-172-16-3-150-&gt; java -jar /opt/hadoop-sync/target/hadoop-sync-0.1.jar customer_reviews --fetch-min-max</font></div><div><font size="2"   >2013-03-22 10:54:18,453 [main] INFO &nbsp;hdfs.HdfsSynchronizer - synchronized metadata for table: customer_reviews</font></div></div></pre></div><div>4. 如果/etc/hosts中一个IP对应了多个主机名, 可能会造成问题, 例如 :&nbsp;</div><div>如果主机名配置</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cat /etc/hosts</font></div><div><div><font size="2"   >172.16.3.150 db-172-16-3-150.sky-mobi.com db-172-16-3-150</font></div><div><font size="2"   >172.16.3.33 db-172-16-3-33.sky-mobi.com db-172-16-3-33</font></div><div><font size="2"   >172.16.3.39 db-172-16-3-39.sky-mobi.com db-172-16-3-39</font></div><div><font size="2"   >172.16.3.40 db-172-16-3-40.sky-mobi.com db-172-16-3-40</font></div></div><p></p></pre></div><div>而 worker_list 配置了短名称</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 opt]# vi /opt/citusdb/2.0/data/pg_worker_list.conf</font></div><div><font size="2"   >db-172-16-3-33 9900</font></div><div><font size="2"   >db-172-16-3-39 9900</font></div><div><font size="2"   >db-172-16-3-40 9900</font></div><p></p></pre></div><div>查询时可能报如下错误</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from customer_reviews limit 1;</font></div><div><font size="2"   >ERROR: &nbsp;failed to assign 5 task(s) to worker nodes</font></div><p></p></pre></div><div>原因是nodename和pg_worker_list.conf中的配置不一致.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from pg_dist_shard_placement ;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;shardid &nbsp; &nbsp; &nbsp; &nbsp;| shardstate | shardlength | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nodename &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | nodeport&nbsp;</font></div><div><font size="2"   >----------------------+------------+-------------+-----------------------------+----------</font></div><div><font size="2"   >&nbsp;-2048097437225231483 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;64029428 | db-172-16-3-33.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp;-2048097437225231483 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;64029428 | db-172-16-3-39.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp;-2048097437225231483 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;64029428 | db-172-16-3-40.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp;-1221512698612183530 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;67108864 | db-172-16-3-33.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp;-1221512698612183530 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;67108864 | db-172-16-3-39.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp;-1221512698612183530 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;67108864 | db-172-16-3-40.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp; &nbsp;631600631725577683 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;34190254 | db-172-16-3-33.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp; &nbsp;631600631725577683 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;34190254 | db-172-16-3-39.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp; &nbsp;631600631725577683 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;34190254 | db-172-16-3-40.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp; 2698407172708592541 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;67108864 | db-172-16-3-33.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp; 2698407172708592541 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;67108864 | db-172-16-3-39.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp; 2698407172708592541 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;67108864 | db-172-16-3-40.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp; 3598423008504059948 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;67108864 | db-172-16-3-33.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp; 3598423008504059948 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;67108864 | db-172-16-3-39.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >&nbsp; 3598423008504059948 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;67108864 | db-172-16-3-40.sky-mobi.com | &nbsp; &nbsp; 9900</font></div><div><font size="2"   >(15 rows)</font></div><p></p></pre></div><div>解决办法是修改<span style="line-height: 22px;"   >修改/etc/hosts,&nbsp;</span><span style="line-height: 22px;"   >同时修改</span><span style="line-height: 22px;"   >pg_worker_list.conf,</span><span style="line-height: 22px;"   >&nbsp;以及</span><span style="line-height: 22px;"   >hadoop的配置中设计主机名的部分.&nbsp;</span></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.citusdata.com/docs/sql-on-hadoop"   >http://www.citusdata.com/docs/sql-on-hadoop</a></div><div>2.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://hadoop.apache.org/docs/r1.1.2/cluster_setup.html"   >http://hadoop.apache.org/docs/r1.1.2/cluster_setup.html</a></div><div>3.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013219840831/"   >http://blog.163.com/digoal@126/blog/static/1638770402013219840831/</a></div><div>4.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020132192011747/"   >http://blog.163.com/digoal@126/blog/static/16387704020132192011747/<br></a><wbr style="line-height: 22px;"   ><span style="line-height: 22px;"   >5.&nbsp;</span><a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020132189835346/"   >http://blog.163.com/digoal@126/blog/static/16387704020132189835346/</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="CitusDB, PostgreSQLs Use Hadoop Distribute Query - 4 : Query Data IN HDFS - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>