<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL remove duplicated data in Table</h2>
	<h5 id="">2013-03-12 10:18:56&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201321154532598/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>昨天一位兄弟遇到创建唯一索引失败的问题, 原因是有重复数据.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create table test (uk1 int, uk2 text, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=&gt; insert into test select generate_series(1,100),'digoal','test',clock_timestamp();</font></div><div><font size="2"   >INSERT 0 100</font></div><div><font size="2"   >digoal=&gt; insert into test select generate_series(1,100),'digoal','test',clock_timestamp();</font></div><div><font size="2"   >INSERT 0 100</font></div><div><font size="2"   >digoal=&gt; create unique index uk_test on test(uk1,uk2);</font></div><div><font size="2"   >ERROR: &nbsp;23505: could not create unique index "uk_test"</font></div><div><font size="2"   >DETAIL: &nbsp;Key (uk1, uk2)=(26, digoal) is duplicated.</font></div><div><font size="2"   >SCHEMA NAME: &nbsp;digoal</font></div><div><font size="2"   >TABLE NAME: &nbsp;test</font></div><div><font size="2"   >CONSTRAINT NAME: &nbsp;uk_test</font></div><div><font size="2"   >LOCATION: &nbsp;comparetup_index_btree, tuplesort.c:3181</font></div><p></p></pre></div><div>上面的例子要创建的是uk1和uk2的联合唯一索引, 显然有重复数据无法创建下去.</div><div>要去除uk1和uk2联合重复的数据, 如果遇到重复只保留1条.</div><div>[方法一] :&nbsp;</div><div>如果这个表有PK的话, 可以通过PK来区分该删除哪些, 该保留哪些?</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-- 给上面的表添加PK, 如下 :&nbsp;</font></div><div><div><font size="2"   >digoal=&gt; create sequence seq_test ;</font></div><div><font size="2"   >CREATE SEQUENCE</font></div><div><font size="2"   >digoal=&gt; alter table test add column pk int default nextval('seq_test'::regclass);</font></div><div><font size="2"   >ALTER TABLE</font></div></div><div><div><font size="2"   >digoal=&gt; alter table test add constraint pk_test primary key (pk);</font></div><div><font size="2"   >ALTER TABLE</font></div></div><div><font size="2"   >-- 删除uk1+uk2的重复数据, 保留PK值最小的那条.</font></div><div><div><font size="2"   >digoal=&gt; delete from test where pk in (select pk from (select row_number() over (partition by uk1,uk2 order by pk) rn,pk from test)AS t where rn&gt;1);</font></div><div><font size="2"   >DELETE 100</font></div></div><div><font size="2"   >-- 删除重复数据后的记录如下 :&nbsp;</font></div><div><div><font size="2"   >digoal=&gt; select * from test;</font></div><div><font size="2"   >&nbsp;uk1 | &nbsp;uk2 &nbsp; | info | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| pk &nbsp;</font></div><div><font size="2"   >-----+--------+------+----------------------------+-----</font></div><div><font size="2"   >&nbsp; &nbsp;1 | digoal | test | 2013-03-12 08:38:42.028668 | &nbsp; 1</font></div><div><font size="2"   >&nbsp; &nbsp;2 | digoal | test | 2013-03-12 08:38:42.028852 | &nbsp; 2</font></div><div><font size="2"   >&nbsp; &nbsp;3 | digoal | test | 2013-03-12 08:38:42.02886 &nbsp;| &nbsp; 3</font></div><div><font size="2"   >&nbsp; &nbsp;4 | digoal | test | 2013-03-12 08:38:42.028864 | &nbsp; 4</font></div><div><font size="2"   >&nbsp; &nbsp;5 | digoal | test | 2013-03-12 08:38:42.028866 | &nbsp; 5</font></div><div><font size="2"   >&nbsp; &nbsp;6 | digoal | test | 2013-03-12 08:38:42.028869 | &nbsp; 6</font></div><div><font size="2"   >&nbsp; &nbsp;7 | digoal | test | 2013-03-12 08:38:42.028872 | &nbsp; 7</font></div><div><font size="2"   >&nbsp; &nbsp;8 | digoal | test | 2013-03-12 08:38:42.028875 | &nbsp; 8</font></div><div><font size="2"   >&nbsp; &nbsp;9 | digoal | test | 2013-03-12 08:38:42.028877 | &nbsp; 9</font></div><div><font size="2"   >&nbsp; 10 | digoal | test | 2013-03-12 08:38:42.02888 &nbsp;| &nbsp;10</font></div><div><font size="2"   >&nbsp; 11 | digoal | test | 2013-03-12 08:38:42.028883 | &nbsp;11</font></div><div><font size="2"   >&nbsp; 12 | digoal | test | 2013-03-12 08:38:42.028886 | &nbsp;12</font></div><div><font size="2"   >&nbsp; 13 | digoal | test | 2013-03-12 08:38:42.028888 | &nbsp;13</font></div><div><font size="2"   >&nbsp; 14 | digoal | test | 2013-03-12 08:38:42.028891 | &nbsp;14</font></div><div><font size="2"   >&nbsp; 15 | digoal | test | 2013-03-12 08:38:42.028893 | &nbsp;15</font></div><div><font size="2"   >&nbsp; 16 | digoal | test | 2013-03-12 08:38:42.028896 | &nbsp;16</font></div><div><font size="2"   >&nbsp; 17 | digoal | test | 2013-03-12 08:38:42.028899 | &nbsp;17</font></div><div><font size="2"   >&nbsp; 18 | digoal | test | 2013-03-12 08:38:42.028901 | &nbsp;18</font></div><div><font size="2"   >&nbsp; 19 | digoal | test | 2013-03-12 08:38:42.028904 | &nbsp;19</font></div><div><font size="2"   >&nbsp; 20 | digoal | test | 2013-03-12 08:38:42.028907 | &nbsp;20</font></div><div><font size="2"   >&nbsp; 21 | digoal | test | 2013-03-12 08:38:42.028909 | &nbsp;21</font></div><div><font size="2"   >&nbsp; 22 | digoal | test | 2013-03-12 08:38:42.028912 | &nbsp;22</font></div><div><font size="2"   >&nbsp; 23 | digoal | test | 2013-03-12 08:38:42.028914 | &nbsp;23</font></div><div><font size="2"   >&nbsp; 24 | digoal | test | 2013-03-12 08:38:42.028917 | &nbsp;24</font></div><div><font size="2"   >&nbsp; 25 | digoal | test | 2013-03-12 08:38:42.02892 &nbsp;| &nbsp;25</font></div><div><font size="2"   >&nbsp; 26 | digoal | test | 2013-03-12 08:38:42.028922 | &nbsp;26</font></div><div><font size="2"   >&nbsp; 27 | digoal | test | 2013-03-12 08:38:42.028925 | &nbsp;27</font></div><div><font size="2"   >&nbsp; 28 | digoal | test | 2013-03-12 08:38:42.028927 | &nbsp;28</font></div><div><font size="2"   >&nbsp; 29 | digoal | test | 2013-03-12 08:38:42.02893 &nbsp;| &nbsp;29</font></div><div><font size="2"   >&nbsp; 30 | digoal | test | 2013-03-12 08:38:42.028933 | &nbsp;30</font></div><div><font size="2"   >&nbsp; 31 | digoal | test | 2013-03-12 08:38:42.028935 | &nbsp;31</font></div><div><font size="2"   >&nbsp; 32 | digoal | test | 2013-03-12 08:38:42.028938 | &nbsp;32</font></div><div><font size="2"   >&nbsp; 33 | digoal | test | 2013-03-12 08:38:42.028941 | &nbsp;33</font></div><div><font size="2"   >&nbsp; 34 | digoal | test | 2013-03-12 08:38:42.028944 | &nbsp;34</font></div><div><font size="2"   >&nbsp; 35 | digoal | test | 2013-03-12 08:38:42.028946 | &nbsp;35</font></div><div><font size="2"   >&nbsp; 36 | digoal | test | 2013-03-12 08:38:42.028949 | &nbsp;36</font></div><div><font size="2"   >&nbsp; 37 | digoal | test | 2013-03-12 08:38:42.028952 | &nbsp;37</font></div><div><font size="2"   >&nbsp; 38 | digoal | test | 2013-03-12 08:38:42.028955 | &nbsp;38</font></div><div><font size="2"   >&nbsp; 39 | digoal | test | 2013-03-12 08:38:42.028957 | &nbsp;39</font></div><div><font size="2"   >&nbsp; 40 | digoal | test | 2013-03-12 08:38:42.02896 &nbsp;| &nbsp;40</font></div><div><font size="2"   >&nbsp; 41 | digoal | test | 2013-03-12 08:38:42.028963 | &nbsp;41</font></div><div><font size="2"   >&nbsp; 42 | digoal | test | 2013-03-12 08:38:42.028965 | &nbsp;42</font></div><div><font size="2"   >&nbsp; 43 | digoal | test | 2013-03-12 08:38:42.028968 | &nbsp;43</font></div><div><font size="2"   >&nbsp; 44 | digoal | test | 2013-03-12 08:38:42.02897 &nbsp;| &nbsp;44</font></div><div><font size="2"   >&nbsp; 45 | digoal | test | 2013-03-12 08:38:42.028973 | &nbsp;45</font></div><div><font size="2"   >&nbsp; 46 | digoal | test | 2013-03-12 08:38:42.028975 | &nbsp;46</font></div><div><font size="2"   >&nbsp; 47 | digoal | test | 2013-03-12 08:38:42.028978 | &nbsp;47</font></div><div><font size="2"   >&nbsp; 48 | digoal | test | 2013-03-12 08:38:42.028981 | &nbsp;48</font></div><div><font size="2"   >&nbsp; 49 | digoal | test | 2013-03-12 08:38:42.028983 | &nbsp;49</font></div><div><font size="2"   >&nbsp; 50 | digoal | test | 2013-03-12 08:38:42.028994 | &nbsp;50</font></div><div><font size="2"   >&nbsp; 51 | digoal | test | 2013-03-12 08:38:42.028997 | &nbsp;51</font></div><div><font size="2"   >&nbsp; 52 | digoal | test | 2013-03-12 08:38:42.028999 | &nbsp;52</font></div><div><font size="2"   >&nbsp; 53 | digoal | test | 2013-03-12 08:38:42.029002 | &nbsp;53</font></div><div><font size="2"   >&nbsp; 54 | digoal | test | 2013-03-12 08:38:42.029004 | &nbsp;54</font></div><div><font size="2"   >&nbsp; 55 | digoal | test | 2013-03-12 08:38:42.029007 | &nbsp;55</font></div><div><font size="2"   >&nbsp; 56 | digoal | test | 2013-03-12 08:38:42.02901 &nbsp;| &nbsp;56</font></div><div><font size="2"   >&nbsp; 57 | digoal | test | 2013-03-12 08:38:42.029012 | &nbsp;57</font></div><div><font size="2"   >&nbsp; 58 | digoal | test | 2013-03-12 08:38:42.029015 | &nbsp;58</font></div><div><font size="2"   >&nbsp; 59 | digoal | test | 2013-03-12 08:38:42.029017 | &nbsp;59</font></div><div><font size="2"   >&nbsp; 60 | digoal | test | 2013-03-12 08:38:42.02902 &nbsp;| &nbsp;60</font></div><div><font size="2"   >&nbsp; 61 | digoal | test | 2013-03-12 08:38:42.029022 | &nbsp;61</font></div><div><font size="2"   >&nbsp; 62 | digoal | test | 2013-03-12 08:38:42.029025 | &nbsp;62</font></div><div><font size="2"   >&nbsp; 63 | digoal | test | 2013-03-12 08:38:42.029028 | &nbsp;63</font></div><div><font size="2"   >&nbsp; 64 | digoal | test | 2013-03-12 08:38:42.02903 &nbsp;| &nbsp;64</font></div><div><font size="2"   >&nbsp; 65 | digoal | test | 2013-03-12 08:38:42.029033 | &nbsp;65</font></div><div><font size="2"   >&nbsp; 66 | digoal | test | 2013-03-12 08:38:42.029035 | &nbsp;66</font></div><div><font size="2"   >&nbsp; 67 | digoal | test | 2013-03-12 08:38:42.029038 | &nbsp;67</font></div><div><font size="2"   >&nbsp; 68 | digoal | test | 2013-03-12 08:38:42.029041 | &nbsp;68</font></div><div><font size="2"   >&nbsp; 69 | digoal | test | 2013-03-12 08:38:42.029043 | &nbsp;69</font></div><div><font size="2"   >&nbsp; 70 | digoal | test | 2013-03-12 08:38:42.029046 | &nbsp;70</font></div><div><font size="2"   >&nbsp; 71 | digoal | test | 2013-03-12 08:38:42.029048 | &nbsp;71</font></div><div><font size="2"   >&nbsp; 72 | digoal | test | 2013-03-12 08:38:42.029051 | &nbsp;72</font></div><div><font size="2"   >&nbsp; 73 | digoal | test | 2013-03-12 08:38:42.029053 | &nbsp;73</font></div><div><font size="2"   >&nbsp; 74 | digoal | test | 2013-03-12 08:38:42.029056 | &nbsp;74</font></div><div><font size="2"   >&nbsp; 75 | digoal | test | 2013-03-12 08:38:42.029059 | &nbsp;75</font></div><div><font size="2"   >&nbsp; 76 | digoal | test | 2013-03-12 08:38:42.029061 | &nbsp;76</font></div><div><font size="2"   >&nbsp; 77 | digoal | test | 2013-03-12 08:38:42.029064 | &nbsp;77</font></div><div><font size="2"   >&nbsp; 78 | digoal | test | 2013-03-12 08:38:42.029066 | &nbsp;78</font></div><div><font size="2"   >&nbsp; 79 | digoal | test | 2013-03-12 08:38:42.029085 | &nbsp;79</font></div><div><font size="2"   >&nbsp; 80 | digoal | test | 2013-03-12 08:38:42.029089 | &nbsp;80</font></div><div><font size="2"   >&nbsp; 81 | digoal | test | 2013-03-12 08:38:42.029091 | &nbsp;81</font></div><div><font size="2"   >&nbsp; 82 | digoal | test | 2013-03-12 08:38:42.029094 | &nbsp;82</font></div><div><font size="2"   >&nbsp; 83 | digoal | test | 2013-03-12 08:38:42.029097 | &nbsp;83</font></div><div><font size="2"   >&nbsp; 84 | digoal | test | 2013-03-12 08:38:42.029099 | &nbsp;84</font></div><div><font size="2"   >&nbsp; 85 | digoal | test | 2013-03-12 08:38:42.029102 | &nbsp;85</font></div><div><font size="2"   >&nbsp; 86 | digoal | test | 2013-03-12 08:38:42.029104 | &nbsp;86</font></div><div><font size="2"   >&nbsp; 87 | digoal | test | 2013-03-12 08:38:42.029107 | &nbsp;87</font></div><div><font size="2"   >&nbsp; 88 | digoal | test | 2013-03-12 08:38:42.02911 &nbsp;| &nbsp;88</font></div><div><font size="2"   >&nbsp; 89 | digoal | test | 2013-03-12 08:38:42.029112 | &nbsp;89</font></div><div><font size="2"   >&nbsp; 90 | digoal | test | 2013-03-12 08:38:42.029115 | &nbsp;90</font></div><div><font size="2"   >&nbsp; 91 | digoal | test | 2013-03-12 08:38:42.029118 | &nbsp;91</font></div><div><font size="2"   >&nbsp; 92 | digoal | test | 2013-03-12 08:38:42.02912 &nbsp;| &nbsp;92</font></div><div><font size="2"   >&nbsp; 93 | digoal | test | 2013-03-12 08:38:42.029123 | &nbsp;93</font></div><div><font size="2"   >&nbsp; 94 | digoal | test | 2013-03-12 08:38:42.029125 | &nbsp;94</font></div><div><font size="2"   >&nbsp; 95 | digoal | test | 2013-03-12 08:38:42.029128 | &nbsp;95</font></div><div><font size="2"   >&nbsp; 96 | digoal | test | 2013-03-12 08:38:42.029131 | &nbsp;96</font></div><div><font size="2"   >&nbsp; 97 | digoal | test | 2013-03-12 08:38:42.029133 | &nbsp;97</font></div><div><font size="2"   >&nbsp; 98 | digoal | test | 2013-03-12 08:38:42.029136 | &nbsp;98</font></div><div><font size="2"   >&nbsp; 99 | digoal | test | 2013-03-12 08:38:42.029138 | &nbsp;99</font></div><div><font size="2"   >&nbsp;100 | digoal | test | 2013-03-12 08:38:42.029141 | 100</font></div><div><font size="2"   >(100 rows)</font></div></div><div><font size="2"   >-- 现在可以创建uk1+uk2的唯一约束了.</font></div><div><div><font size="2"   >digoal=&gt; create unique index uk_test on test(uk1,uk2);</font></div><div><font size="2"   >CREATE INDEX</font></div></div><p></p></pre></div><div><br></div><div>[方法二] :&nbsp;</div><div>如果这个表没有PK, 也没关系, PostgreSQL 定位每一行使用的是ctid字段, 包含了这行记录所在的数据块以及数据块内的itemid信息.&nbsp;</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; drop table test;</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >digoal=&gt; create table test (uk1 int, uk2 text, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=&gt; insert into test select generate_series(1,10),'digoal','test',clock_timestamp();</font></div><div><font size="2"   >INSERT 0 10</font></div><div><font size="2"   >digoal=&gt; insert into test select generate_series(1,10),'digoal','test',clock_timestamp();</font></div><div><font size="2"   >INSERT 0 10</font></div></div><div><font size="2"   >-- 删除uk1+uk2重复的数据, 保留ctid最小的那条. (如果要保留时间最早的那条, 改成order by crt_time即可)</font></div><div><div><font size="2"   >digoal=&gt; delete from test where ctid in (select ctid from (select row_number() over (partition by uk1,uk2 order by ctid) rn,ctid from test)AS t where rn&gt;1) returning *;</font></div><div><font size="2"   >&nbsp;uk1 | &nbsp;uk2 &nbsp; | info | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----+--------+------+----------------------------</font></div><div><font size="2"   >&nbsp; &nbsp;1 | digoal | test | 2013-03-12 08:55:06.478993</font></div><div><font size="2"   >&nbsp; &nbsp;2 | digoal | test | 2013-03-12 08:55:06.479017</font></div><div><font size="2"   >&nbsp; &nbsp;3 | digoal | test | 2013-03-12 08:55:06.479022</font></div><div><font size="2"   >&nbsp; &nbsp;4 | digoal | test | 2013-03-12 08:55:06.479025</font></div><div><font size="2"   >&nbsp; &nbsp;5 | digoal | test | 2013-03-12 08:55:06.479028</font></div><div><font size="2"   >&nbsp; &nbsp;6 | digoal | test | 2013-03-12 08:55:06.47903</font></div><div><font size="2"   >&nbsp; &nbsp;7 | digoal | test | 2013-03-12 08:55:06.479033</font></div><div><font size="2"   >&nbsp; &nbsp;8 | digoal | test | 2013-03-12 08:55:06.479036</font></div><div><font size="2"   >&nbsp; &nbsp;9 | digoal | test | 2013-03-12 08:55:06.479038</font></div><div><font size="2"   >&nbsp; 10 | digoal | test | 2013-03-12 08:55:06.479041</font></div><div><font size="2"   >(10 rows)</font></div><div><font size="2"   >DELETE 10</font></div></div><div><font size="2"   >-- 保留的数据如下,ctid是最小的数据 :&nbsp;</font></div><div><div><font size="2"   >digoal=&gt; select ctid,* from test;</font></div><div><font size="2"   >&nbsp; ctid &nbsp;| uk1 | &nbsp;uk2 &nbsp; | info | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------+-----+--------+------+----------------------------</font></div><div><font size="2"   >&nbsp;(0,1) &nbsp;| &nbsp; 1 | digoal | test | 2013-03-12 08:55:05.232498</font></div><div><font size="2"   >&nbsp;(0,2) &nbsp;| &nbsp; 2 | digoal | test | 2013-03-12 08:55:05.235077</font></div><div><font size="2"   >&nbsp;(0,3) &nbsp;| &nbsp; 3 | digoal | test | 2013-03-12 08:55:05.235086</font></div><div><font size="2"   >&nbsp;(0,4) &nbsp;| &nbsp; 4 | digoal | test | 2013-03-12 08:55:05.235089</font></div><div><font size="2"   >&nbsp;(0,5) &nbsp;| &nbsp; 5 | digoal | test | 2013-03-12 08:55:05.235092</font></div><div><font size="2"   >&nbsp;(0,6) &nbsp;| &nbsp; 6 | digoal | test | 2013-03-12 08:55:05.235095</font></div><div><font size="2"   >&nbsp;(0,7) &nbsp;| &nbsp; 7 | digoal | test | 2013-03-12 08:55:05.235098</font></div><div><font size="2"   >&nbsp;(0,8) &nbsp;| &nbsp; 8 | digoal | test | 2013-03-12 08:55:05.235101</font></div><div><font size="2"   >&nbsp;(0,9) &nbsp;| &nbsp; 9 | digoal | test | 2013-03-12 08:55:05.235103</font></div><div><font size="2"   >&nbsp;(0,10) | &nbsp;10 | digoal | test | 2013-03-12 08:55:05.235106</font></div><div><font size="2"   >(10 rows)</font></div></div><p></p></pre></div><div><br></div><div>[方法三] :&nbsp;</div><div><div style="line-height: 22px;"   >不需要PK或者ctid唯一定位到1行记录的值, 通过中间表来做. 在一个事务中完成.&nbsp;</div></div><div style="line-height: 22px;"   >如果test表在去除重复记录期间有DML操作, 应该先锁表, 禁止DML. 否则又可能有重复记录插入.</div><div><div><pre class="prettyprint"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; drop table test;</font></div><div style="line-height: 22px;"   ><font size="2"   >DROP TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; create table test (uk1 int, uk2 text, info text, crt_time timestamp);</font></div><div style="line-height: 22px;"   ><font size="2"   >CREATE TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; insert into test select generate_series(1,10),'digoal','test',clock_timestamp();</font></div><div style="line-height: 22px;"   ><font size="2"   >INSERT 0 10</font></div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; insert into test select generate_series(1,10),'digoal','test',clock_timestamp();</font></div><div style="line-height: 22px;"   ><font size="2"   >INSERT 0 10</font></div></div><div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; begin;</font></div><div style="line-height: 22px;"   ><font size="2"   >BEGIN</font></div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; create local temp table tmp_test (like test);</font></div><div style="line-height: 22px;"   ><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=&gt; lock table test in exclusive mode;<br>LOCK TABLE</font></div><div><font size="2"   >-- uk1,uk2重复的情况下, 只保留crt_time最小的一条</font></div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; insert into tmp_test select uk1,uk2,info,crt_time from&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >digoal-&gt; &nbsp; (select row_number() over (partition by uk1,uk2 order by crt_time) rn,* from test) AS t&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >digoal-&gt; where rn=1;</font></div><div style="line-height: 22px;"   ><font size="2"   >INSERT 0 10</font></div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; truncate table test;</font></div><div style="line-height: 22px;"   ><font size="2"   >TRUNCATE TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; insert into test select * from tmp_test;</font></div><div style="line-height: 22px;"   ><font size="2"   >INSERT 0 10</font></div><div><font size="2"   >digoal=&gt; create unique index uk_test on test(uk1,uk2);<br>CREATE INDEX</font></div><div style="line-height: 22px;"   ><div><font size="2"   >digoal=&gt; drop table tmp_test;</font></div><div><font size="2"   >DROP TABLE</font></div></div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; end;</font></div><div style="line-height: 22px;"   ><font size="2"   >COMMIT</font></div></div><p style="line-height: 22px;"   ></p></pre></div></div><div><br></div><div><div style="line-height: 22px;"   >[方法四] :&nbsp;</div><div style="line-height: 22px;"   >不支持窗口函数的话, 还是有办法的, 例如使用游标.</div><div style="line-height: 22px;"   >函数处理 :&nbsp;</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; drop table test;</font></div><div style="line-height: 22px;"   ><font size="2"   >DROP TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; create table test (uk1 int, uk2 text, info text, crt_time timestamp);</font></div><div style="line-height: 22px;"   ><font size="2"   >CREATE TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; insert into test select generate_series(1,10),'digoal','test',clock_timestamp();</font></div><div style="line-height: 22px;"   ><font size="2"   >INSERT 0 10</font></div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; insert into test select generate_series(1,10),'digoal','test',clock_timestamp();</font></div><div style="line-height: 22px;"   ><font size="2"   >INSERT 0 10</font></div><div><div><font size="2"   >digoal=&gt; insert into test values (1,null,'digoal',clock_timestamp());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=&gt; insert into test values (1,null,'digoal',clock_timestamp());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=&gt; insert into test values (1,null,'digoal',clock_timestamp());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=&gt; insert into test values (null,null,'digoal',clock_timestamp());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=&gt; insert into test values (null,null,'digoal',clock_timestamp());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=&gt; insert into test values (null,null,'digoal',clock_timestamp());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=&gt; insert into test values (null,'test','digoal',clock_timestamp());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=&gt; insert into test values (null,'test','digoal',clock_timestamp());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=&gt; insert into test values (null,'test','digoal',clock_timestamp());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >-- uk1和uk2重复的数据, 只保留crt_time最小的一条.</font></div><div><font size="2"   >do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; ref cursor for select * from test;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; lock table test in exclusive mode;</font></div><div><font size="2"   >&nbsp; create temp table tmp_test(like test);</font></div><div><font size="2"   >&nbsp; create index idx1 on tmp_test(uk1);</font></div><div><font size="2"   >&nbsp; create index idx2 on tmp_test(uk2);</font></div><div><font size="2"   >&nbsp; for rec in ref loop</font></div><div><font size="2"   >&nbsp; &nbsp; perform 1 from tmp_test t where rec.uk1=t.uk1 and rec.uk2=t.uk2;</font></div><div><font size="2"   >&nbsp; &nbsp; if found then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; perform 1 from tmp_test t where rec.uk1=t.uk1 and rec.uk2=t.uk2 and rec.crt_time&lt;t.crt_time;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; if found then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; delete from tmp_test where rec.uk1=t.uk1 and rec.uk2=t.uk2;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; insert into tmp_test values(rec.uk1, rec.uk2, rec.info, rec.crt_time);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; insert into tmp_test values(rec.uk1, rec.uk2, rec.info, rec.crt_time);</font></div><div><font size="2"   >&nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; end loop;</font></div><div><font size="2"   >&nbsp; truncate table test;</font></div><div><font size="2"   >&nbsp; insert into test select * from tmp_test;</font></div><div><font size="2"   >&nbsp; drop table tmp_test;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; select * from test;</font></div><div><font size="2"   >&nbsp;uk1 | &nbsp;uk2 &nbsp; | &nbsp;info &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----+--------+--------+----------------------------</font></div><div><font size="2"   >&nbsp; &nbsp;1 | digoal | test &nbsp; | 2013-03-12 10:10:07.0416</font></div><div><font size="2"   >&nbsp; &nbsp;2 | digoal | test &nbsp; | 2013-03-12 10:10:07.041726</font></div><div><font size="2"   >&nbsp; &nbsp;3 | digoal | test &nbsp; | 2013-03-12 10:10:07.041733</font></div><div><font size="2"   >&nbsp; &nbsp;4 | digoal | test &nbsp; | 2013-03-12 10:10:07.041737</font></div><div><font size="2"   >&nbsp; &nbsp;5 | digoal | test &nbsp; | 2013-03-12 10:10:07.04174</font></div><div><font size="2"   >&nbsp; &nbsp;6 | digoal | test &nbsp; | 2013-03-12 10:10:07.041742</font></div><div><font size="2"   >&nbsp; &nbsp;7 | digoal | test &nbsp; | 2013-03-12 10:10:07.041745</font></div><div><font size="2"   >&nbsp; &nbsp;8 | digoal | test &nbsp; | 2013-03-12 10:10:07.041748</font></div><div><font size="2"   >&nbsp; &nbsp;9 | digoal | test &nbsp; | 2013-03-12 10:10:07.041751</font></div><div><font size="2"   >&nbsp; 10 | digoal | test &nbsp; | 2013-03-12 10:10:07.041753</font></div><div><font size="2"   >&nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp;| digoal | 2013-03-12 10:10:22.217691</font></div><div><font size="2"   >&nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp;| digoal | 2013-03-12 10:10:22.741411</font></div><div><font size="2"   >&nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp;| digoal | 2013-03-12 10:10:23.138676</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| digoal | 2013-03-12 10:10:28.359152</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| digoal | 2013-03-12 10:10:28.893596</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;| digoal | 2013-03-12 10:10:29.304329</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| test &nbsp; | digoal | 2013-03-12 10:10:36.24248</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| test &nbsp; | digoal | 2013-03-12 10:10:36.916402</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| test &nbsp; | digoal | 2013-03-12 10:10:37.318659</font></div><div><font size="2"   >(19 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; create unique index uk_test on test(uk1,uk2);</font></div><div><font size="2"   >CREATE INDEX</font></div></div><p></p></pre></div></div></div><div>【小结】</div><div>1. 根据数据表的大小以及重复数据的占比, 选择合适的方法.</div><div>delete大量数据后建议马上执行analyze.</div><div>如果重复数据占比较大, 并且是使用delete的方法删除重复数据的, 那么9.0以上的系统建议vacuum full. 老的系统建议使用pg_reorg来删除碎片.</div><div>重复数据占比较小的表建议使用delete的方法删除重复数据.</div><div>重复数据占比较大的表, 建议使用重组表的方法删除重复数据.&nbsp;</div><div>当然还要考虑未来这个表是否会有DML操作, 如果未来会有大量的DML, 新增数据等操作, 那么即使重复数据较多的表也没必要使用重组的方法去除重复数据, 因为vacuum后这些空间还是可用的。</div></div>
	</div>
</div>
</body>
</html>