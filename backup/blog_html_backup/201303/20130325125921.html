<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 parallel pg_dump</h2>
	<h5 id="">2013-03-25 12:59:21&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201322510519547/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL pg_dump并行备份的功能已经提交到最新的代码中, 9.3中应该会包含此功能. 导出速度提升非常明显.</div><div>前段时间写过一篇并行导出的BLOG, 与pg_dump的并行导出一样都用到了9.2开始引入的export snapshot功能.</div><div>感兴趣的朋友可以看如下文章 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201326829943/"   >http://blog.163.com/digoal@126/blog/static/163877040201326829943/</a></div><div>接下来将测试一下pg_dump的并行导出功能.</div><div><br></div><div>1. 下载</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - pgdev</font></div><div><font size="2"   >pgdev@db-172-16-3-150-&gt; wget --no-check-certificate https://github.com/postgres/postgres/archive/master.zip -O postgresql9.3.zip</font></div></pre></div><div>2. 安装</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pgdev@db-172-16-3-150-&gt; unzip postgresql9.3.zip</font></div><div><font size="2"   >pgdev@db-172-16-3-150-&gt; less .bash_profile</font></div><div><div><font size="2"   >export PS1="$USER@`/bin/hostname -s`-&gt; "</font></div><div><font size="2"   >export PGPORT=9300</font></div><div><font size="2"   >export PGUSER=postgres</font></div><div><font size="2"   >export PGDATA=/data06/pgdev/pg_root</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/home/pgdev/pgsql9.3</font></div><div><font size="2"   >export PGHOST=127.0.0.1</font></div><div><font size="2"   >export PGDATABASE=digoal</font></div><div><font size="2"   >export LD_LIBRARY_PATH=/opt/uuid-1.6.2/lib:$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"   >alias rm='rm -i'</font></div><div><font size="2"   >alias ll='ls -lh'</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >su - root</font></div><div><div><font size="2"   >[root@db-172-16-3-150 ~]# . /home/pgdev/.bash_profile&nbsp;</font></div><div><font size="2"   >root@db-172-16-3-150-&gt;&nbsp;<span style="line-height: 22px;"   >cd postgres-master/</span></font></div></div><div><font size="2"   ><span style="line-height: 22px;"   >root@db-172-16-3-150-&gt;</span><span style="line-height: 22px;"   >&nbsp;</span>./configure --prefix=/home/pgdev/pgsql9.3 --with-pgport=9300 --with-perl --with-python --with-tcl --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --enable-cassert --with-wal-blocksize=16 --enable-debug &amp;&amp; gmake</font></div><div><font size="2"   >root@db-172-16-3-150-&gt; gmake install</font></div><div><div><font size="2"   >root@db-172-16-3-150-&gt; cd contrib/</font></div><div><font size="2"   >root@db-172-16-3-150-&gt; gmake install</font></div></div><div><font size="2"   >root@db-172-16-3-150-&gt; su - pgdev</font></div><div><font size="2"   >pgdev@db-172-16-3-150-&gt; initdb -D $PGDATA --locale=C -E UTF8 -U postgres</font></div><div><div><font size="2"   >pgdev@db-172-16-3-150-&gt; pg_ctl start</font></div><div><font size="2"   >server starting</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# create table t1(id int, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table t2(id int, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table t3(id int, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table t4(id int, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table t5(id int, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table t6(id int, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table t7(id int, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table t8(id int, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><font size="2"   >postgres=# insert into t1 select generate_series(1,2000000),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >postgres=# insert into t2 select generate_series(1,1500000),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >postgres=# insert into t3 select generate_series(1,1000000),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >postgres=# insert into t4 select generate_series(1,3000000),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >postgres=# insert into t5 select generate_series(1,4000000),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >postgres=# insert into t6 select generate_series(1,1000000),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >postgres=# insert into t7 select generate_series(1,1000000),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >postgres=# insert into t8 select generate_series(1,5000000),md5(random()::text),clock_timestamp();</font></div></pre></div><div>3. 并行导出测试 :&nbsp;</div><div>并行度为8, 导出耗时36秒 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pgdev@db-172-16-3-150-&gt; date;pg_dump -f ./postgres.dmp -F d -E UTF8 -j 8 -h $PGDATA -p 9300 -U postgres postgres;date</font></div><div><font size="2"   >Mon Mar 25 10:51:18 CST 2013</font></div><div><font size="2"   >Mon Mar 25 10:51:54 CST 2013</font></div><p></p></pre></div><div>pg_dump fork了8个进程来处理dump.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pgdev@db-172-16-3-150-&gt; ps -ewf|grep pg_dump</font></div><div><font size="2"   >pgdev &nbsp; &nbsp;17136 16544 &nbsp;1 10:56 pts/1 &nbsp; &nbsp;00:00:00 pg_dump -f ./postgres.dmp -F d -E UTF8 -j 8 -h /data06/pgdev/pg_root -p 9300 -U postgres postgres</font></div><div><font size="2"   >pgdev &nbsp; &nbsp;17138 17136 68 10:56 pts/1 &nbsp; &nbsp;00:00:01 pg_dump -f ./postgres.dmp -F d -E UTF8 -j 8 -h /data06/pgdev/pg_root -p 9300 -U postgres postgres</font></div><div><font size="2"   >pgdev &nbsp; &nbsp;17140 17136 66 10:56 pts/1 &nbsp; &nbsp;00:00:01 pg_dump -f ./postgres.dmp -F d -E UTF8 -j 8 -h /data06/pgdev/pg_root -p 9300 -U postgres postgres</font></div><div><font size="2"   >pgdev &nbsp; &nbsp;17141 17136 67 10:56 pts/1 &nbsp; &nbsp;00:00:01 pg_dump -f ./postgres.dmp -F d -E UTF8 -j 8 -h /data06/pgdev/pg_root -p 9300 -U postgres postgres</font></div><div><font size="2"   >pgdev &nbsp; &nbsp;17142 17136 66 10:56 pts/1 &nbsp; &nbsp;00:00:01 pg_dump -f ./postgres.dmp -F d -E UTF8 -j 8 -h /data06/pgdev/pg_root -p 9300 -U postgres postgres</font></div><div><font size="2"   >pgdev &nbsp; &nbsp;17144 17136 68 10:56 pts/1 &nbsp; &nbsp;00:00:01 pg_dump -f ./postgres.dmp -F d -E UTF8 -j 8 -h /data06/pgdev/pg_root -p 9300 -U postgres postgres</font></div><div><font size="2"   >pgdev &nbsp; &nbsp;17145 17136 60 10:56 pts/1 &nbsp; &nbsp;00:00:01 pg_dump -f ./postgres.dmp -F d -E UTF8 -j 8 -h /data06/pgdev/pg_root -p 9300 -U postgres postgres</font></div><div><font size="2"   >pgdev &nbsp; &nbsp;17146 17136 67 10:56 pts/1 &nbsp; &nbsp;00:00:01 pg_dump -f ./postgres.dmp -F d -E UTF8 -j 8 -h /data06/pgdev/pg_root -p 9300 -U postgres postgres</font></div><div><font size="2"   >pgdev &nbsp; &nbsp;17147 17136 56 10:56 pts/1 &nbsp; &nbsp;00:00:01 pg_dump -f ./postgres.dmp -F d -E UTF8 -j 8 -h /data06/pgdev/pg_root -p 9300 -U postgres postgres</font></div></pre></div><div>4. 普通导出, 导出耗时129秒 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pgdev@db-172-16-3-150-&gt; date;pg_dump -f ./postgres.dmp -F d -E UTF8 -h $PGDATA -p 9300 -U postgres postgres;date</font></div><div><div><font size="2"   >Mon Mar 25 10:52:32 CST 2013</font></div><div><font size="2"   >Mon Mar 25 10:54:41 CST 2013</font></div></div><div><div><font size="2"   >pgdev@db-172-16-3-150-&gt; ps -ewf|grep pg_dump</font></div><div><font size="2"   >pgdev &nbsp; &nbsp;17173 16544 89 10:58 pts/1 &nbsp; &nbsp;00:00:01 pg_dump -f ./postgres.dmp -F d -E UTF8 -h /data06/pgdev/pg_root -p 9300 -U postgres postgres</font></div></div></pre></div><div>5. 并行导出对9.1以及更老的版本也适用, 但是请注意以下.</div><div><br></div><div>[注意]</div><div>1. 并行导出利用了PostgreSQL引入的事务状态导出特性.&nbsp;<span style="line-height: 22px;"   >对于不支持并行导出的数据库版本, 9.2以前的版本. 如果使用并行导出, 可能导出不一致的数据, 那么为了在9.1以及以前的版本并行导出一致的数据, 办法是导出时禁止被导出表的一切DML操作, 并且加上pg_dump</span>&nbsp;的 --no-synchronized-snapshots 选项.</div><div>导出事务状态的文章可参考如下 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402012416105232835/"   >htt</a><a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/1638770402012416105232835/"   >p://blog.163.com/digoal@126/blog/static/1638770402012416105232835/</a></div><div>2. 目前pg_dump的并行导出需要注意, pg_dump子进程获取锁不是一步到位的, 而是随着备份进行去单个获取的(并且使用了nowait), 所以<span style="line-height: 22px;"   >如果在导出过程中,</span><span style="line-height: 22px;"   >&nbsp;子进程获取锁可能会遇到用户操作的冲突. 获取失败, 导致整个备份失败. 如下.</span></div><div>SESSION A :&nbsp;</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >pgdev@db-172-16-3-150-&gt; date;pg_dump -f ./postgres.dmp -F d -E UTF8 -j 2 -h $PGDATA -p 9300 -U postgres postgres;date</font></div><div style="line-height: 22px;"   ><font size="2"   >Mon Mar 25 11:28:46 CST 2013</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >SESSION B :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# truncate table t7;</font></div></div><div><font size="2"   >waiting...</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >SESSION C :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select pid,query from pg_stat_activity;</font></div><div><font size="2"   >&nbsp; pid &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------+---------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;17326 | truncate table t7;</font></div><div><font size="2"   >&nbsp;18585 | SELECT attname, attacl FROM pg_catalog.pg_attribute WHERE attrelid = '16449' AND NOT attisdropped AND attacl IS NOT&nbsp;</font></div><div><font size="2"   >NULL ORDER BY attnum</font></div><div><font size="2"   >&nbsp;18588 | COPY public.t8 (id, info, crt_time) TO stdout;</font></div><div><font size="2"   >&nbsp;18589 | COPY public.t5 (id, info, crt_time) TO stdout;</font></div><div><font size="2"   >&nbsp;17583 | select pid,query from pg_stat_activity;</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div><div>-- 并行备份的主pg_dump进程需要获取所有表包括系统表的AccessShareLock, 然后fork的pg_dump进程则依次根据备份的需要获取相应对象的AccessShareLock. 从以下查询可以得知两个pg_dump的子进程获得了t8和t5的<span style="line-height: 22px;"   >AccessShareLock.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select pid,database,relation,locktype,mode,granted,relname from pg_locks t1,pg_class t2 where t1.relation=t2.oid &nbsp;and pid in (18585,18588,18589,17326) order by pid,relation;</font></div><div><font size="2"   >&nbsp; pid &nbsp;| database | relation | locktype | &nbsp; &nbsp; &nbsp;mode &nbsp; &nbsp; &nbsp; | granted | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------+----------+----------+----------+-----------------+---------+-----------------------------------------</font></div><div><font size="2"   >&nbsp;17326 | &nbsp; &nbsp;12816 | &nbsp; &nbsp;16420 | relation | AccessExclusiveLock | f &nbsp; &nbsp; &nbsp; | t7</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; &nbsp;112 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_foreign_data_wrapper_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; &nbsp;113 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_foreign_server_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; &nbsp;548 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_foreign_data_wrapper_name_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; &nbsp;549 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_foreign_server_name_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; &nbsp;826 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_default_acl</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; &nbsp;827 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_default_acl_role_nsp_obj_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; &nbsp;828 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_default_acl_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; 1213 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_tablespace</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 1247 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_type</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 1249 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_attribute</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 1255 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_proc</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 1259 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_class</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; 1260 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_authid</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; 1262 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_database</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 1417 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_foreign_server</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2187 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_inherits_parent_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2328 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_foreign_data_wrapper</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; 2396 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_shdescription</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; 2397 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_shdescription_o_c_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2605 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_cast</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2607 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_conversion</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2608 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_depend</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2609 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_description</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2611 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_inherits</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2612 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_language</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2615 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_namespace</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2616 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_opclass</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2617 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_operator</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2618 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_rewrite</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2658 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_attribute_relid_attnam_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2659 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_attribute_relid_attnum_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2660 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_cast_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2661 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_cast_source_target_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2662 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_class_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2663 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_class_relname_nsp_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2668 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_conversion_default_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2669 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_conversion_name_nsp_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2670 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_conversion_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; 2671 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_database_datname_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; 2672 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_database_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2673 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_depend_depender_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2674 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_depend_reference_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2675 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_description_o_c_o_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; 2676 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_authid_rolname_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; 2677 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_authid_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2680 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_inherits_relid_seqno_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2681 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_language_name_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2682 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_language_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2684 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_namespace_nspname_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2685 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_namespace_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2686 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_opclass_am_name_nsp_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2687 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_opclass_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2688 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_operator_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2689 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_operator_oprname_l_r_n_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2690 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_proc_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2691 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_proc_proname_args_nsp_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2692 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_rewrite_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2693 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_rewrite_rel_rulename_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; 2697 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_tablespace_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; 2698 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_tablespace_spcname_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2703 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_type_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2704 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_type_typname_nsp_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2753 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_opfamily</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2754 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_opfamily_am_name_nsp_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2755 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_opfamily_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; 2964 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_db_role_setting</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; 2965 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_db_role_setting_databaseid_rol_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2995 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_largeobject_metadata</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2996 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_largeobject_metadata_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3079 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_extension</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3080 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_extension_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3081 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_extension_name_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3085 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_collation_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3164 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_collation_name_enc_nsp_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3456 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_collation</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3466 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_event_trigger</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3467 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_event_trigger_evtname_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3468 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_event_trigger_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; 3592 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_shseclabel</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; 3593 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_shseclabel_object_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3596 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_seclabel</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3597 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_seclabel_object_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3600 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_ts_dict</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3601 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_ts_parser</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3602 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_ts_config</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3604 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_ts_dict_dictname_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3605 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_ts_dict_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3606 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_ts_parser_prsname_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3607 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_ts_parser_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3608 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_ts_config_cfgname_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3712 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_ts_config_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3764 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_ts_template</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3766 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_ts_template_tmplname_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 3767 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_ts_template_oid_index</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp;11054 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_roles</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp;16384 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | t1</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp;16390 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | t2</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp;16396 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | t3</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp;16402 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | t4</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp;16408 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | t5</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp;16414 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | t6</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp;16420 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | t7</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp;16426 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | t8</font></div><div><font size="2"   >&nbsp;18585 | &nbsp; &nbsp;12816 | &nbsp; &nbsp;16449 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | t9</font></div><div><font size="2"   >&nbsp;18588 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 1259 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_class</font></div><div><font size="2"   >&nbsp;18588 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2615 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_namespace</font></div><div><font size="2"   >&nbsp;18588 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2662 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_class_oid_index</font></div><div><font size="2"   >&nbsp;18588 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2663 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_class_relname_nsp_index</font></div><div><font size="2"   >&nbsp;18588 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2684 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_namespace_nspname_index</font></div><div><font size="2"   >&nbsp;18588 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2685 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_namespace_oid_index</font></div><div><font size="2"   >&nbsp;18588 | &nbsp; &nbsp;12816 | &nbsp; &nbsp;16426 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | t8</font></div><div><font size="2"   >&nbsp;18589 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 1259 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_class</font></div><div><font size="2"   >&nbsp;18589 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2615 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_namespace</font></div><div><font size="2"   >&nbsp;18589 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2662 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_class_oid_index</font></div><div><font size="2"   >&nbsp;18589 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2663 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_class_relname_nsp_index</font></div><div><font size="2"   >&nbsp;18589 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2684 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_namespace_nspname_index</font></div><div><font size="2"   >&nbsp;18589 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2685 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | pg_namespace_oid_index</font></div><div><font size="2"   >&nbsp;18589 | &nbsp; &nbsp;12816 | &nbsp; &nbsp;16408 | relation | AccessShareLock | t &nbsp; &nbsp; &nbsp; | t5</font></div><div><font size="2"   >(118 rows)</font></div><p></p></pre></div><div>....., 随着备份的进行, 继续查询.... pg_dump的子进程需要继续获取t1,t3,t2,t4的AccessShareLock锁.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;18588 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 1259 | relation | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | pg_class</font></div><div><font size="2"   >&nbsp;18588 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2615 | relation | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | pg_namespace</font></div><div><font size="2"   >&nbsp;18588 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2662 | relation | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | pg_class_oid_index</font></div><div><font size="2"   >&nbsp;18588 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2663 | relation | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | pg_class_relname_nsp_index</font></div><div><font size="2"   >&nbsp;18588 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2684 | relation | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | pg_namespace_nspname_index</font></div><div><font size="2"   >&nbsp;18588 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2685 | relation | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | pg_namespace_oid_index</font></div><div><font size="2"   >&nbsp;18588 | &nbsp; &nbsp;12816 | &nbsp; &nbsp;16384 | relation | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | t1</font></div><div><font size="2"   >&nbsp;18588 | &nbsp; &nbsp;12816 | &nbsp; &nbsp;16396 | relation | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | t3</font></div><div><font size="2"   >&nbsp;18588 | &nbsp; &nbsp;12816 | &nbsp; &nbsp;16426 | relation | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | t8</font></div><div><font size="2"   >&nbsp;18589 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 1259 | relation | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | pg_class</font></div><div><font size="2"   >&nbsp;18589 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2615 | relation | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | pg_namespace</font></div><div><font size="2"   >&nbsp;18589 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2662 | relation | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | pg_class_oid_index</font></div><div><font size="2"   >&nbsp;18589 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2663 | relation | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | pg_class_relname_nsp_index</font></div><div><font size="2"   >&nbsp;18589 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2684 | relation | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | pg_namespace_nspname_index</font></div><div><font size="2"   >&nbsp;18589 | &nbsp; &nbsp;12816 | &nbsp; &nbsp; 2685 | relation | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | pg_namespace_oid_index</font></div><div><font size="2"   >&nbsp;18589 | &nbsp; &nbsp;12816 | &nbsp; &nbsp;16390 | relation | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | t2</font></div><div><font size="2"   >&nbsp;18589 | &nbsp; &nbsp;12816 | &nbsp; &nbsp;16402 | relation | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | t4</font></div><div><font size="2"   >&nbsp;18589 | &nbsp; &nbsp;12816 | &nbsp; &nbsp;16408 | relation | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | t5</font></div></pre></div><div>SESSION A :&nbsp;</div><div>当pg_dump的子进程获取t7的AccessShareLock锁时会失败. 因为SESSION B在等待与之冲突的Exclusive Lock. 而pg_dump使用的是nowait进行锁请求, 当pg_dump获取锁失败后马上退出, pg_dump主进程虽然已经获取了t7的AccessShareLock, 但是为了保证整个备份的一致性, 也会退出.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg_dump: [parallel archiver] could not obtain lock on relation "public.t7". This usually means that someone requested an ACCESS EXCLUSIVE lock on the table after the pg_dump parent process has gotten the initial ACCESS SHARE lock on the table.</font></div><div><font size="2"   >Mon Mar 25 11:29:43 CST 2013</font></div></pre></div><div><div style="line-height: 22px;"   >SESSION B :</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >TRUNCATE TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   >complete</font></div><p></p></pre></div></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="https://github.com/postgres/postgres/commit/9e257a181cc1dc5e19eb5d770ce09cc98f470f5f"   >https://github.com/postgres/postgres/commit/9e257a181cc1dc5e19eb5d770ce09cc98f470f5f</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/message-id/CACw0+11NeCcdv2dp4OsEYRoG8rEhKuVui7A8HwbOkBWCSygPXQ@mail.gmail.com"   >http://www.postgresql.org/message-id/CACw0+11NeCcdv2dp4OsEYRoG8rEhKuVui7A8HwbOkBWCSygPXQ@mail.gmail.com</a></div><div>3.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/app-pgdump.html"   >http://www.postgresql.org/docs/devel/static/app-pgdump.html</a></div><div>4.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201222112937900/"   >http://blog.163.com/digoal@126/blog/static/163877040201222112937900/</a></div><div>5.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201326829943/"   >http://blog.163.com/digoal@126/blog/static/163877040201326829943/</a></div><div>6.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/1638770402012416105232835/"   >http://blog.163.com/digoal@126/blog/static/1638770402012416105232835/</a></div><div>7. pg_dump --help</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg_dump dumps a database as a text file or to other formats.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Usage:</font></div><div><font size="2"   >&nbsp; pg_dump [OPTION]... [DBNAME]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >General options:</font></div><div><font size="2"   >&nbsp; -f, --file=FILENAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;output file or directory name</font></div><div><font size="2"   >&nbsp; -F, --format=c|d|t|p &nbsp; &nbsp; &nbsp; &nbsp; output file format (custom, directory, tar,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;plain text (default))</font></div><div><font size="2"   >&nbsp; -j, --jobs=NUM &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; use this many parallel jobs to dump</font></div><div><font size="2"   >&nbsp; -v, --verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;verbose mode</font></div><div><font size="2"   >&nbsp; -V, --version &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;output version information, then exit</font></div><div><font size="2"   >&nbsp; -Z, --compress=0-9 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; compression level for compressed formats</font></div><div><font size="2"   >&nbsp; --lock-wait-timeout=TIMEOUT &nbsp;fail after waiting TIMEOUT for a table lock</font></div><div><font size="2"   >&nbsp; -?, --help &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; show this help, then exit</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Options controlling the output content:</font></div><div><font size="2"   >&nbsp; -a, --data-only &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dump only the data, not the schema</font></div><div><font size="2"   >&nbsp; -b, --blobs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;include large objects in dump</font></div><div><font size="2"   >&nbsp; -c, --clean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;clean (drop) database objects before recreating</font></div><div><font size="2"   >&nbsp; -C, --create &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; include commands to create database in dump</font></div><div><font size="2"   >&nbsp; -E, --encoding=ENCODING &nbsp; &nbsp; &nbsp;dump the data in encoding ENCODING</font></div><div><font size="2"   >&nbsp; -n, --schema=SCHEMA &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dump the named schema(s) only</font></div><div><font size="2"   >&nbsp; -N, --exclude-schema=SCHEMA &nbsp;do NOT dump the named schema(s)</font></div><div><font size="2"   >&nbsp; -o, --oids &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; include OIDs in dump</font></div><div><font size="2"   >&nbsp; -O, --no-owner &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; skip restoration of object ownership in</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;plain-text format</font></div><div><font size="2"   >&nbsp; -s, --schema-only &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dump only the schema, no data</font></div><div><font size="2"   >&nbsp; -S, --superuser=NAME &nbsp; &nbsp; &nbsp; &nbsp; superuser user name to use in plain-text format</font></div><div><font size="2"   >&nbsp; -t, --table=TABLE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dump the named table(s) only</font></div><div><font size="2"   >&nbsp; -T, --exclude-table=TABLE &nbsp; &nbsp;do NOT dump the named table(s)</font></div><div><font size="2"   >&nbsp; -x, --no-privileges &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;do not dump privileges (grant/revoke)</font></div><div><font size="2"   >&nbsp; --binary-upgrade &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for use by upgrade utilities only</font></div><div><font size="2"   >&nbsp; --column-inserts &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dump data as INSERT commands with column names</font></div><div><font size="2"   >&nbsp; --disable-dollar-quoting &nbsp; &nbsp; disable dollar quoting, use SQL standard quoting</font></div><div><font size="2"   >&nbsp; --disable-triggers &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; disable triggers during data-only restore</font></div><div><font size="2"   >&nbsp; --exclude-table-data=TABLE &nbsp; do NOT dump data for the named table(s)</font></div><div><font size="2"   >&nbsp; --inserts &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dump data as INSERT commands, rather than COPY</font></div><div><font size="2"   >&nbsp; --no-security-labels &nbsp; &nbsp; &nbsp; &nbsp; do not dump security label assignments</font></div><div><font size="2"   >&nbsp; --no-synchronized-snapshots parallel processes should not use synchronized snapshots</font></div><div><font size="2"   >&nbsp; --no-tablespaces &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; do not dump tablespace assignments</font></div><div><font size="2"   >&nbsp; --no-unlogged-table-data &nbsp; &nbsp; do not dump unlogged table data</font></div><div><font size="2"   >&nbsp; --quote-all-identifiers &nbsp; &nbsp; &nbsp;quote all identifiers, even if not key words</font></div><div><font size="2"   >&nbsp; --section=SECTION &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dump named section (pre-data, data, or post-data)</font></div><div><font size="2"   >&nbsp; --serializable-deferrable &nbsp; &nbsp;wait until the dump can run without anomalies</font></div><div><font size="2"   >&nbsp; --use-set-session-authorization</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;use SET SESSION AUTHORIZATION commands instead of</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ALTER OWNER commands to set ownership</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Connection options:</font></div><div><font size="2"   >&nbsp; -d, --dbname=DBNAME &nbsp; &nbsp; &nbsp;database to dump</font></div><div><font size="2"   >&nbsp; -h, --host=HOSTNAME &nbsp; &nbsp; &nbsp;database server host or socket directory</font></div><div><font size="2"   >&nbsp; -p, --port=PORT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;database server port number</font></div><div><font size="2"   >&nbsp; -U, --username=NAME &nbsp; &nbsp; &nbsp;connect as specified database user</font></div><div><font size="2"   >&nbsp; -w, --no-password &nbsp; &nbsp; &nbsp; &nbsp;never prompt for password</font></div><div><font size="2"   >&nbsp; -W, --password &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; force password prompt (should happen automatically)</font></div><div><font size="2"   >&nbsp; --role=ROLENAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;do SET ROLE before dump</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >If no database name is supplied, then the PGDATABASE environment</font></div><div><font size="2"   >variable value is used.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Report bugs to &lt;pgsql-bugs@postgresql.org&gt;.</font></div><p></p></pre></div><div>8.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-j njobs</font></div><div><font size="2"   >--jobs=njobs</font></div><div><font size="2"   >Run the dump in parallel by dumping njobs tables simultaneously. This option reduces the time of the dump but it also increases the load on the database server. You can only use this option with the directory output format because this is the only output format where multiple processes can write their data at the same time.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg_dump will open njobs + 1 connections to the database, so make sure your max_connections setting is high enough to accommodate all connections.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Requesting exclusive locks on database objects while running a parallel dump could cause the dump to fail. The reason is that the pg_dump master process requests shared locks on the objects that the worker processes are going to dump later in order to make sure that nobody deletes them and makes them go away while the dump is running. If another client then requests an exclusive lock on a table, that lock will not be granted but will be queued waiting for the shared lock of the master process to be released.. Consequently any other access to the table will not be granted either and will queue after the exclusive lock request. This includes the worker process trying to dump the table. Without any precautions this would be a classic deadlock situation. To detect this conflict, the pg_dump worker process requests another shared lock using the NOWAIT option. If the worker process is not granted this shared lock, somebody else must have requested an exclusive lock in the meantime and there is no way to continue with the dump, so pg_dump has no choice but to abort the dump.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >For a consistent backup, the database server needs to support synchronized snapshots, a feature that was introduced in PostgreSQL 9.2. With this feature, database clients can ensure they see the same dataset even though they use different connections. pg_dump -j uses multiple database connections; it connects to the database once with the master process and once again for each worker job. Without the sychronized snapshot feature, the different worker jobs wouldn't be guaranteed to see the same data in each connection, which could lead to an inconsistent backup.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >If you want to run a parallel dump of a pre-9.2 server, you need to make sure that the database content doesn't change from between the time the master connects to the database until the last worker job has connected to the database. The easiest way to do this is to halt any data modifying processes (DDL and DML) accessing the database before starting the backup. You also need to specify the --no-synchronized-snapshots parameter when running pg_dump -j against a pre-9.2 PostgreSQL server.</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>