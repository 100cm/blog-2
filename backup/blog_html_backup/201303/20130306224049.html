<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL row , record , composite , table type used in array and prepared statement case</h2>
	<h5 id="">2013-03-06 22:40:49&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020132695425525/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">最近一位兄弟在使用复合类型的数组的绑定变量中遇到了一些问题, 无法做绑定变量.<div>下面就复合类型的数组做一些简单的介绍, 主要包括复合类型和行类型,表类型以及记录类型的关系. 数组的使用, 绑定变量等举例.</div><div>row构造器产生的实际上就是匿名的record类型. &nbsp;&nbsp;</div><div>composite, table 类型可以认为是有名字并且已经定义好了结构的record类型. &nbsp;</div><div>在创建表时, 默认会创建1个与表同名的复合类型, 如下 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create table users(id int, info text, vip boolean, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><div><font size="2"   >digoal=&gt; select * from pg_type where typname='users';</font></div><div><font size="2"   >-[ RECORD 1 ]--+------------</font></div><div><font size="2"   >typname &nbsp; &nbsp; &nbsp; &nbsp;| users</font></div><div><font size="2"   >typnamespace &nbsp; | 3425987</font></div><div><font size="2"   >typowner &nbsp; &nbsp; &nbsp; | 3425936</font></div><div><font size="2"   >typlen &nbsp; &nbsp; &nbsp; &nbsp; | -1</font></div><div><font size="2"   >typbyval &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >typtype &nbsp; &nbsp; &nbsp; &nbsp;| c</font></div><div><font size="2"   >typcategory &nbsp; &nbsp;| C</font></div><div><font size="2"   >typispreferred | f</font></div><div><font size="2"   >typisdefined &nbsp; | t</font></div><div><font size="2"   >typdelim &nbsp; &nbsp; &nbsp; | ,</font></div><div><font size="2"   >typrelid &nbsp; &nbsp; &nbsp; | 3475837</font></div><div><font size="2"   >typelem &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"   >typarray &nbsp; &nbsp; &nbsp; | 3475838</font></div><div><font size="2"   >typinput &nbsp; &nbsp; &nbsp; | record_in</font></div><div><font size="2"   >typoutput &nbsp; &nbsp; &nbsp;| record_out</font></div><div><font size="2"   >typreceive &nbsp; &nbsp; | record_recv</font></div><div><font size="2"   >typsend &nbsp; &nbsp; &nbsp; &nbsp;| record_send</font></div><div><font size="2"   >typmodin &nbsp; &nbsp; &nbsp; | -</font></div><div><font size="2"   >typmodout &nbsp; &nbsp; &nbsp;| -</font></div><div><font size="2"   >typanalyze &nbsp; &nbsp; | -</font></div><div><font size="2"   >typalign &nbsp; &nbsp; &nbsp; | d</font></div><div><font size="2"   >typstorage &nbsp; &nbsp; | x</font></div><div><font size="2"   >typnotnull &nbsp; &nbsp; | f</font></div><div><font size="2"   >typbasetype &nbsp; &nbsp;| 0</font></div><div><font size="2"   >typtypmod &nbsp; &nbsp; &nbsp;| -1</font></div><div><font size="2"   >typndims &nbsp; &nbsp; &nbsp; | 0</font></div><div><font size="2"   >typcollation &nbsp; | 0</font></div><div><font size="2"   >typdefaultbin &nbsp;|&nbsp;</font></div><div><font size="2"   >typdefault &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >typacl &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >使用行构造器构造的值其实是匿名record类型的.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select row(1,2,'abc',now());</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;row &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----------------------------------------</font></div><div><font size="2"   >&nbsp;(1,2,abc,"2013-03-07 08:24:30.8791+08")</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=&gt; select row();</font></div><div><font size="2"   >&nbsp;row&nbsp;</font></div><div><font size="2"   >-----</font></div><div><font size="2"   >&nbsp;()</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>当构造的匿名record至少包含1列时, row关键字可以省略.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; select ();</font></div><div><font size="2"   >ERROR: &nbsp;syntax error at or near ")"</font></div><div><font size="2"   >LINE 1: select ();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   >digoal=&gt; select (1);</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=&gt; select (1,2,'abc',now());</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; row &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------------------------------------</font></div><div><font size="2"   >&nbsp;(1,2,abc,"2013-03-07 08:25:42.028076+08")</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >由于匿名record类型行描述符未定义, 所以无法使用.*或者.列名来引用, 将匿名record类型或者行类型转换成复合类型就可以了 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select (row(1,'digoal', true, now())).*;</font></div><div><font size="2"   >ERROR: &nbsp;42809: record type has not been registered</font></div><div><font size="2"   >LOCATION: &nbsp;lookup_rowtype_tupdesc_internal, typcache.c:711</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >如下将row类型转换成建表时默认建立的复合类型users后, 使用.*可以了 .</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select (row(1,'digoal', true, now())::users).*;</font></div><div><font size="2"   >-[ RECORD 1 ]------------------------</font></div><div><font size="2"   >id &nbsp; &nbsp; &nbsp; | 1</font></div><div><font size="2"   >info &nbsp; &nbsp; | digoal</font></div><div><font size="2"   >vip &nbsp; &nbsp; &nbsp;| t</font></div><div><font size="2"   >crt_time | 2013-03-06 22:11:47.452729</font></div><p></p></pre></div><div>同样建表时默认创建的复合类型users还可以用作建其他表的复合类型 , 与显示创建的效果一样.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create table users_array(c1 users[]);</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div>显示创建的复合类型用在表字段的类型中 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create type cu_users as (c1 int, c2 text, c3 boolean, c4 timestamp);</font></div><div><font size="2"   >CREATE TYPE</font></div><div><font size="2"   >digoal=&gt; create table users_array_cu(c1 cu_users[]);</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div><br></div><div>使用构造行的方法构造复合类型, 其实就是多了一步转换的过程.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select row(1,'digoal',true,now());</font></div><div><font size="2"   >-[ RECORD 1 ]-------------------------------------</font></div><div><font size="2"   >row | (1,digoal,t,"2013-03-06 22:20:29.106369+08")</font></div><div><font size="2"   >digoal=&gt; select row(1,'digoal',true,now())::users;</font></div><div><font size="2"   >-[ RECORD 1 ]----------------------------------</font></div><div><font size="2"   >row | (1,digoal,t,"2013-03-06 22:20:37.966585")</font></div><div><font size="2"   >digoal=&gt; select row(1,'digoal',true,now())::cu_users;</font></div><div><font size="2"   >-[ RECORD 1 ]----------------------------------</font></div><div><font size="2"   >row | (1,digoal,t,"2013-03-06 22:20:47.988029")</font></div><p></p></pre></div><div><br></div><div>当然除了使用row构造器, 还可以使用传统的直接指定类型的输入方法, 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; select users '(1, abc, true, 2012-10-10)';</font></div><div><font size="2"   >-[ RECORD 1 ]-----------------------------</font></div><div><font size="2"   >users | (1," abc",t,"2012-10-10 00:00:00")</font></div></div><div><div><font size="2"   >digoal=&gt; select '(1, abc, true, 2012-10-10)'::users;</font></div><div><font size="2"   >-[ RECORD 1 ]-----------------------------</font></div><div><font size="2"   >users | (1," abc",t,"2012-10-10 00:00:00")</font></div></div><div><div><font size="2"   >digoal=&gt; select cast ('(1, abc, true, 2012-10-10)' as users);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;users &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------</font></div><div><font size="2"   >&nbsp;(1," abc",t,"2012-10-10 00:00:00")</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>构造复合类型的数组, 只要元素的输入方法与上面的构造方法一致即可 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; select array[row(1,'digoal',true,now())::users, row(1,'digoal',true,now())::users];</font></div><div><font size="2"   >-[ RECORD 1 ]----------------------------------------------------------------------------------------</font></div><div><font size="2"   >array | {"(1,digoal,t,\"2013-03-06 22:21:38.327608\")","(1,digoal,t,\"2013-03-06 22:21:38.327608\")"}</font></div></div><div><div><font size="2"   >digoal=&gt; select array['(1, abc, true, 2012-10-10)'::users];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;array &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------------------------------------</font></div><div><font size="2"   >&nbsp;{"(1,\" abc\",t,\"2012-10-10 00:00:00\")"}</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=&gt; select array[cast('(1, abc, true, 2012-10-10)' as users)];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;array &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------------------------------------</font></div><div><font size="2"   >&nbsp;{"(1,\" abc\",t,\"2012-10-10 00:00:00\")"}</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=&gt; select array[users '(1, abc, true, 2012-10-10)'];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;array &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------------------------------------</font></div><div><font size="2"   >&nbsp;{"(1,\" abc\",t,\"2012-10-10 00:00:00\")"}</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>绑定变量 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; create table users_info (c1 users[]);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >digoal=&gt; prepare x (users[]) as insert into users_info values($1);</font></div><div><font size="2"   >PREPARE</font></div></div><p></p></pre></div><div>-- 使用array[]构造数组.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; execute x(array[row(1,'digoal',true,now())::users, row(2,'DIGOAL',false,clock_timestamp())::users]);</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=&gt; select * from users_info ;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;{"(1,digoal,t,\"2013-03-06 22:30:27.088816\")","(2,DIGOAL,f,\"2013-03-06 22:30:27.089117\")"}</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=&gt; select c1[1].id from users_info ;</font></div><div><font size="2"   >&nbsp;id&nbsp;</font></div><div><font size="2"   >----</font></div><div><font size="2"   >&nbsp; 1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=&gt; select c1[1].* from users_info ;</font></div><div><font size="2"   >&nbsp;id | &nbsp;info &nbsp;| vip | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+--------+-----+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | digoal | t &nbsp; | 2013-03-06 22:30:27.088816</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>-- 所有构造复合类型的方法都适用.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; execute x(array[users '(1,digoal,true,2013-03-05)', row(2,'DIGOAL',false,clock_timestamp())::users]);</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div><br></div><div>程序中的使用 :&nbsp;</div><div>在程序中使用绑定变量, 同样需要遵从以上的构造规则, 否则可能造成语法上的错误或者类型不匹配.</div><div>如果觉得在数组中每个元素都要写构造复合类型的语法太繁琐, 或者程序不支持如上拼写方法或者是不支持bind使用这种写法的话, 可以考虑将构造复合类型交给函数来完成, 那么绑定变量的参数将使用普通的数据类型.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; create or replace function con_users(int,text,boolean,timestamp) returns users as $$</font></div><div><font size="2"   >digoal$&gt; &nbsp; select row($1,$2,$3,$4)::users;</font></div><div><font size="2"   >digoal$&gt; $$ language sql;</font></div><div><font size="2"   >CREATE FUNCTION</font></div></div><div><div><font size="2"   >digoal=&gt; select con_users(1,'digoal',true,now()::timestamp);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;con_users &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------------------------------------------</font></div><div><font size="2"   >&nbsp;(1,digoal,t,"2013-03-06 22:45:55.227019")</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=&gt; select con_users(1,'digoal',true,'2012-03-01');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;con_users &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------</font></div><div><font size="2"   >&nbsp;(1,digoal,t,"2012-03-01 00:00:00")</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>带时区的类型 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; create or replace function con_users(int,text,boolean,timestamp with time zone) returns users as $$</font></div><div><font size="2"   >&nbsp; select row($1,$2,$3,$4)::users;</font></div><div><font size="2"   >$$ language sql;</font></div><div><font size="2"   >CREATE FUNCTION</font></div></div><div><div><font size="2"   >digoal=&gt; select con_users(1,'digoal'::text,true,now());</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;con_users &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------------------------------------------</font></div><div><font size="2"   >&nbsp;(1,digoal,t,"2013-03-06 22:46:54.414916")</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>使用以上函数插入数组 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; execute x(array[con_users(1,'digoal',true,'2013-03-05'), con_users(2,'DIGOAL',false,clock_timestamp())]);</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div><br></div><div><br></div><div>【参考】<wbr><div>1.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012989219190/"   >http://blog.163.com/digoal@126/blog/static/1638770402012989219190/</a></div><div>2.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/sql-expressions.html"   >http://www.postgresql.org/docs/9.2/static/sql-expressions.html</a></div><div>3.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/functions-comparisons.html"   >http://www.postgresql.org/docs/9.2/static/functions-comparisons.html</a></div><div>4.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/functions-subquery.html"   >http://www.postgresql.org/docs/9.2/static/functions-subquery.html</a></div><div>5.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/catalog-pg-type.html"   >http://www.postgresql.org/docs/9.2/static/catalog-pg-type.html</a></div><div><br></div></div><div><br></div></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL row , record , composite , table type used in array and prepared statement case - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>