<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">CitusDB TPC-H Data Warehouse Benchmark Test</h2>
	<h5 id="">2013-03-19 13:47:28&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201321903146876/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>上一篇介绍了CitusDB的安装, 本文将介绍一下TPC-H的测试.</div><div>安装CitusDB请参考 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013219840831/"   >http://blog.163.com/digoal@126/blog/static/1638770402013219840831/</a></div><div><br></div><div>1. 首先创建生成测试数据的目录.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# cd /data05</font></div><div><font size="2"   >[root@db-172-16-3-150 data05]# mkdir citusdb</font></div><div><font size="2"   >[root@db-172-16-3-150 data05]# chown citusdb:citusdb citusdb</font></div><div><font size="2"   >[root@db-172-16-3-150 data05]# su - citusdb</font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; cd /data05/citusdb</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >2. 下载测试脚本. 这个脚本由CitusDB提供.</span></div><div><pre class="prettyprint"   ><p><font size="2"   >citusdb@db-172-16-3-150-&gt; wget http://examples.citusdata.com/tpch_2_13_0.tar.gz</font></p></pre></div><div>3. 生成测试数据</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >citusdb@db-172-16-3-150-&gt; tar -zxvf tpch_2_13_0.tar.gz</font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; cd tpch_2_13_0</font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; gmake</font></div><p></p></pre></div><div># 使用dbgen生成测试数据, 数据量多少根据-s来设置. 命令行帮助如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >citusdb@db-172-16-3-150-&gt; ./dbgen -h</font></div><div><font size="2"   >TPC-H Population Generator (Version 2.13.0 build 4)</font></div><div><font size="2"   >Copyright Transaction Processing Performance Council 1994 - 2010</font></div><div><font size="2"   >USAGE:</font></div><div><font size="2"   >dbgen [-{vf}][-T {pcsoPSOL}]</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; [-s &lt;scale&gt;][-C &lt;procs&gt;][-S &lt;step&gt;]</font></div><div><font size="2"   >dbgen [-v] [-O m] [-s &lt;scale&gt;] [-U &lt;updates&gt;]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Basic Options</font></div><div><font size="2"   >===========================</font></div><div><font size="2"   >-C &lt;n&gt; -- separate data set into &lt;n&gt; chunks (requires -S, default: 1)</font></div><div><font size="2"   >-f &nbsp; &nbsp; -- force. Overwrite existing files</font></div><div><font size="2"   >-h &nbsp; &nbsp; -- display this message</font></div><div><font size="2"   >-q &nbsp; &nbsp; -- enable QUIET mode</font></div><div><font size="2"   >-s &lt;n&gt; -- set Scale Factor (SF) to &nbsp;&lt;n&gt; (default: 1)&nbsp;</font></div><div><font size="2"   >-S &lt;n&gt; -- build the &lt;n&gt;th step of the data/update set (used with -C or -U)</font></div><div><font size="2"   >-U &lt;n&gt; -- generate &lt;n&gt; update sets</font></div><div><font size="2"   >-v &nbsp; &nbsp; -- enable VERBOSE mode</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Advanced Options</font></div><div><font size="2"   >===========================</font></div><div><font size="2"   >-b &lt;s&gt; -- load distributions for &lt;s&gt; (default: dists.dss)</font></div><div><font size="2"   >-d &lt;n&gt; -- split deletes between &lt;n&gt; files (requires -U)</font></div><div><font size="2"   >-i &lt;n&gt; -- split inserts between &lt;n&gt; files (requires -U)</font></div><div><font size="2"   >-T c &nbsp; -- generate cutomers ONLY</font></div><div><font size="2"   >-T l &nbsp; -- generate nation/region ONLY</font></div><div><font size="2"   >-T L &nbsp; -- generate lineitem ONLY</font></div><div><font size="2"   >-T n &nbsp; -- generate nation ONLY</font></div><div><font size="2"   >-T o &nbsp; -- generate orders/lineitem ONLY</font></div><div><font size="2"   >-T O &nbsp; -- generate orders ONLY</font></div><div><font size="2"   >-T p &nbsp; -- generate parts/partsupp ONLY</font></div><div><font size="2"   >-T P &nbsp; -- generate parts ONLY</font></div><div><font size="2"   >-T r &nbsp; -- generate region ONLY</font></div><div><font size="2"   >-T s &nbsp; -- generate suppliers ONLY</font></div><div><font size="2"   >-T S &nbsp; -- generate partsupp ONLY</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >To generate the SF=1 (1GB), validation database population, use:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; dbgen -vf -s 1</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >To generate updates for a SF=1 (1GB), use:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; dbgen -v -U 1 -s 1</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 生成测试数据 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >citusdb@db-172-16-3-150-&gt; ./dbgen -f -s 1</font></div><div><font size="2"   >TPC-H Population Generator (Version 2.13.0)</font></div><div><font size="2"   >Copyright Transaction Processing Performance Council 1994 - 2010</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 执行完后, 在当前目录下会生成以下数据文件 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >citusdb@db-172-16-3-150-&gt; ll *.tbl</font></div><div><font size="2"   >-rw-rw-r-- 1 citusdb citusdb &nbsp;24M Mar 19 12:26 customer.tbl</font></div><div><font size="2"   >-rw-rw-r-- 1 citusdb citusdb 719M Mar 19 12:26 lineitem.tbl</font></div><div><font size="2"   >-rw-rw-r-- 1 citusdb citusdb 2.2K Mar 19 12:26 nation.tbl</font></div><div><font size="2"   >-rw-rw-r-- 1 citusdb citusdb 163M Mar 19 12:26 orders.tbl</font></div><div><font size="2"   >-rw-rw-r-- 1 citusdb citusdb 113M Mar 19 12:26 partsupp.tbl</font></div><div><font size="2"   >-rw-rw-r-- 1 citusdb citusdb &nbsp;23M Mar 19 12:26 part.tbl</font></div><div><font size="2"   >-rw-rw-r-- 1 citusdb citusdb &nbsp;384 Mar 19 12:26 region.tbl</font></div><div><font size="2"   >-rw-rw-r-- 1 citusdb citusdb 1.4M Mar 19 12:26 supplier.tbl</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 测试表的建表DDL如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >citusdb@db-172-16-3-150-&gt; cat dss_distributed.ddl&nbsp;</font></div><div><font size="2"   >-- Sccsid: &nbsp; &nbsp; @(#)dss.ddl &nbsp; &nbsp; &nbsp;2.1.8.1</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE TABLE nation</font></div><div><font size="2"   >(</font></div><div><font size="2"   >&nbsp; &nbsp; n_nationkey &nbsp;INTEGER not null,</font></div><div><font size="2"   >&nbsp; &nbsp; n_name &nbsp; &nbsp; &nbsp; CHAR(25) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; n_regionkey &nbsp;INTEGER not null,</font></div><div><font size="2"   >&nbsp; &nbsp; n_comment &nbsp; &nbsp;VARCHAR(152)</font></div><div><font size="2"   >)</font></div><div><font size="2"   >DISTRIBUTE BY APPEND (n_nationkey);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE TABLE region</font></div><div><font size="2"   >(</font></div><div><font size="2"   >&nbsp; &nbsp; r_regionkey &nbsp;INTEGER not null,</font></div><div><font size="2"   >&nbsp; &nbsp; r_name &nbsp; &nbsp; &nbsp; CHAR(25) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; r_comment &nbsp; &nbsp;VARCHAR(152)</font></div><div><font size="2"   >)</font></div><div><font size="2"   >DISTRIBUTE BY APPEND (r_regionkey);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE TABLE part</font></div><div><font size="2"   >(</font></div><div><font size="2"   >&nbsp; &nbsp; p_partkey &nbsp; &nbsp; INTEGER not null,</font></div><div><font size="2"   >&nbsp; &nbsp; p_name &nbsp; &nbsp; &nbsp; &nbsp;VARCHAR(55) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; p_mfgr &nbsp; &nbsp; &nbsp; &nbsp;CHAR(25) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; p_brand &nbsp; &nbsp; &nbsp; CHAR(10) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; p_type &nbsp; &nbsp; &nbsp; &nbsp;VARCHAR(25) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; p_size &nbsp; &nbsp; &nbsp; &nbsp;INTEGER not null,</font></div><div><font size="2"   >&nbsp; &nbsp; p_container &nbsp; CHAR(10) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; p_retailprice DECIMAL(15,2) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; p_comment &nbsp; &nbsp; VARCHAR(23) not null</font></div><div><font size="2"   >)</font></div><div><font size="2"   >DISTRIBUTE BY APPEND (p_partkey);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE TABLE supplier</font></div><div><font size="2"   >(</font></div><div><font size="2"   >&nbsp; &nbsp; s_suppkey &nbsp; &nbsp; INTEGER not null,</font></div><div><font size="2"   >&nbsp; &nbsp; s_name &nbsp; &nbsp; &nbsp; &nbsp;CHAR(25) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; s_address &nbsp; &nbsp; VARCHAR(40) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; s_nationkey &nbsp; INTEGER not null,</font></div><div><font size="2"   >&nbsp; &nbsp; s_phone &nbsp; &nbsp; &nbsp; CHAR(15) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; s_acctbal &nbsp; &nbsp; DECIMAL(15,2) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; s_comment &nbsp; &nbsp; VARCHAR(101) not null</font></div><div><font size="2"   >)</font></div><div><font size="2"   >DISTRIBUTE BY APPEND (s_suppkey);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE TABLE partsupp</font></div><div><font size="2"   >(</font></div><div><font size="2"   >&nbsp; &nbsp; ps_partkey &nbsp; &nbsp; INTEGER not null,</font></div><div><font size="2"   >&nbsp; &nbsp; ps_suppkey &nbsp; &nbsp; INTEGER not null,</font></div><div><font size="2"   >&nbsp; &nbsp; ps_availqty &nbsp; &nbsp;INTEGER not null,</font></div><div><font size="2"   >&nbsp; &nbsp; ps_supplycost &nbsp;DECIMAL(15,2) &nbsp;not null,</font></div><div><font size="2"   >&nbsp; &nbsp; ps_comment &nbsp; &nbsp; VARCHAR(199) not null</font></div><div><font size="2"   >)</font></div><div><font size="2"   >DISTRIBUTE BY APPEND (ps_partkey);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE TABLE customer</font></div><div><font size="2"   >(</font></div><div><font size="2"   >&nbsp; &nbsp; c_custkey &nbsp; &nbsp; INTEGER not null,</font></div><div><font size="2"   >&nbsp; &nbsp; c_name &nbsp; &nbsp; &nbsp; &nbsp;VARCHAR(25) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; c_address &nbsp; &nbsp; VARCHAR(40) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; c_nationkey &nbsp; INTEGER not null,</font></div><div><font size="2"   >&nbsp; &nbsp; c_phone &nbsp; &nbsp; &nbsp; CHAR(15) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; c_acctbal &nbsp; &nbsp; DECIMAL(15,2) &nbsp; not null,</font></div><div><font size="2"   >&nbsp; &nbsp; c_mktsegment &nbsp;CHAR(10) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; c_comment &nbsp; &nbsp; VARCHAR(117) not null</font></div><div><font size="2"   >)</font></div><div><font size="2"   >DISTRIBUTE BY APPEND (c_custkey);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE TABLE ORDERS</font></div><div><font size="2"   >(</font></div><div><font size="2"   >&nbsp; &nbsp; o_orderkey &nbsp; &nbsp; &nbsp; BIGINT not null,</font></div><div><font size="2"   >&nbsp; &nbsp; o_custkey &nbsp; &nbsp; &nbsp; &nbsp;INTEGER not null,</font></div><div><font size="2"   >&nbsp; &nbsp; o_orderstatus &nbsp; &nbsp;CHAR(1) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; o_totalprice &nbsp; &nbsp; DECIMAL(15,2) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; o_orderdate &nbsp; &nbsp; &nbsp;DATE not null,</font></div><div><font size="2"   >&nbsp; &nbsp; o_orderpriority &nbsp;CHAR(15) not null, &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; o_clerk &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CHAR(15) not null,&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; o_shippriority &nbsp; INTEGER not null,</font></div><div><font size="2"   >&nbsp; &nbsp; o_comment &nbsp; &nbsp; &nbsp; &nbsp;VARCHAR(79) not null</font></div><div><font size="2"   >)</font></div><div><font size="2"   >DISTRIBUTE BY APPEND (o_orderkey);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE TABLE LINEITEM</font></div><div><font size="2"   >(</font></div><div><font size="2"   >&nbsp; &nbsp; l_orderkey &nbsp; &nbsp;BIGINT not null,</font></div><div><font size="2"   >&nbsp; &nbsp; l_partkey &nbsp; &nbsp; INTEGER not null,</font></div><div><font size="2"   >&nbsp; &nbsp; l_suppkey &nbsp; &nbsp; INTEGER not null,</font></div><div><font size="2"   >&nbsp; &nbsp; l_linenumber &nbsp;INTEGER not null,</font></div><div><font size="2"   >&nbsp; &nbsp; l_quantity &nbsp; &nbsp;DECIMAL(15,2) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; l_extendedprice &nbsp;DECIMAL(15,2) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; l_discount &nbsp; &nbsp;DECIMAL(15,2) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; l_tax &nbsp; &nbsp; &nbsp; &nbsp; DECIMAL(15,2) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; l_returnflag &nbsp;CHAR(1) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; l_linestatus &nbsp;CHAR(1) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; l_shipdate &nbsp; &nbsp;DATE not null,</font></div><div><font size="2"   >&nbsp; &nbsp; l_commitdate &nbsp;DATE not null,</font></div><div><font size="2"   >&nbsp; &nbsp; l_receiptdate DATE not null,</font></div><div><font size="2"   >&nbsp; &nbsp; l_shipinstruct CHAR(25) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; l_shipmode &nbsp; &nbsp; CHAR(10) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; l_comment &nbsp; &nbsp; &nbsp;VARCHAR(44) not null</font></div><div><font size="2"   >)</font></div><div><font size="2"   >DISTRIBUTE BY APPEND (l_orderkey);</font></div><p></p></pre></div><div><br></div><div>4. 在主节点执行<span style="line-height: 22px;"   >dss_distributed.ddl , 创建表.</span></div><div>创建DISTRIBUTE表需要超级用户, 调用几个CitusDB的C函数.&nbsp;</div><div># 将digoal改为超级用户权限</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 9900 -U postgres digoal</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# alter role digoal superuser;</font></div><div><font size="2"   >ALTER ROLE</font></div><p></p></pre></div><div># 所有worker节点digoal用户权限调整 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.1 -p 9901 -U postgres digoal -c "alter role digoal superuser;"</font></div><div><font size="2"   >ALTER ROLE</font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.1 -p 9902 -U postgres digoal -c "alter role digoal superuser;"</font></div><div><font size="2"   >ALTER ROLE</font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.1 -p 9903 -U postgres digoal -c "alter role digoal superuser;"</font></div><div><font size="2"   >ALTER ROLE</font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.1 -p 9904 -U postgres digoal -c "alter role digoal superuser;"</font></div><div><font size="2"   >ALTER ROLE</font></div><p></p></pre></div><div><br></div><div># 主节点创建表, 调用<span style="line-height: 22px;"   >dss_distributed.ddl&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 9900 -U digoal digoal -f ./dss_distributed.ddl&nbsp;</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div><br></div><div>5. 在主节点查看当前数据库中的表</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.1 -p 9900 -U digoal digoal</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp; Name &nbsp; &nbsp; &nbsp; | Type &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >--------+------------------+-------+----------</font></div><div><font size="2"   >&nbsp;public | customer &nbsp; &nbsp; &nbsp; &nbsp; | table | digoal</font></div><div><font size="2"   >&nbsp;public | customer_reviews | table | postgres</font></div><div><font size="2"   >&nbsp;public | lineitem &nbsp; &nbsp; &nbsp; &nbsp; | table | digoal</font></div><div><font size="2"   >&nbsp;public | nation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | table | digoal</font></div><div><font size="2"   >&nbsp;public | orders &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | table | digoal</font></div><div><font size="2"   >&nbsp;public | part &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | table | digoal</font></div><div><font size="2"   >&nbsp;public | partsupp &nbsp; &nbsp; &nbsp; &nbsp; | table | digoal</font></div><div><font size="2"   >&nbsp;public | region &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | table | digoal</font></div><div><font size="2"   >&nbsp;public | supplier &nbsp; &nbsp; &nbsp; &nbsp; | table | digoal</font></div><div><font size="2"   >(9 rows)</font></div><div><font size="2"   >digoal=# select oid,relname,relkind from pg_class where relnamespace = (select oid from pg_namespace where nspname='public');</font></div><div><font size="2"   >&nbsp; oid &nbsp;| &nbsp; &nbsp; &nbsp;relname &nbsp; &nbsp; &nbsp;| relkind&nbsp;</font></div><div><font size="2"   >-------+-------------------+---------</font></div><div><font size="2"   >&nbsp;16515 | customer_reviews &nbsp;| r</font></div><div><font size="2"   >&nbsp;16521 | customer_id_index | i</font></div><div><font size="2"   >&nbsp;16551 | nation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| r</font></div><div><font size="2"   >&nbsp;16554 | region &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| r</font></div><div><font size="2"   >&nbsp;16557 | part &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| r</font></div><div><font size="2"   >&nbsp;16560 | supplier &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| r</font></div><div><font size="2"   >&nbsp;16563 | partsupp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| r</font></div><div><font size="2"   >&nbsp;16566 | customer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| r</font></div><div><font size="2"   >&nbsp;16569 | orders &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| r</font></div><div><font size="2"   >&nbsp;16572 | lineitem &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| r</font></div><div><font size="2"   >(10 rows)</font></div><p></p></pre></div><div><br></div><div>6. 从worker节点使用psql 连接主节点, 导入数据.</div><div># 修改shard的阈值, 表的大小超过128MB则分割成多个shard.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# SET shard_max_size TO '128MB';</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# \STAGE lineitem FROM '/data05/citusdb/tpch_2_13_0/lineitem.tbl' WITH DELIMITER '|';</font></div><div><font size="2"   >digoal=# \STAGE orders FROM '/data05/citusdb/tpch_2_13_0/orders.tbl' WITH DELIMITER '|';</font></div><p></p></pre></div><div># 分区信息如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_dist_partition;</font></div><div><font size="2"   >&nbsp;logicalrelid | partmethod | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;partkey &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------+------------+--------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16515 | a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {VAR :varno 1 :varattno 2 :vartype 1082 :vartypmod -1 :varcollid 0 :varlevelsup 0 :varnoold 1 :varoattn</font></div><div><font size="2"   >o 2 :location 464}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16551 | a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {VAR :varno 1 :varattno 1 :vartype 23 :vartypmod -1 :varcollid 0 :varlevelsup 0 :varnoold 1 :varoattno&nbsp;</font></div><div><font size="2"   >1 :location 182}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16554 | a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {VAR :varno 1 :varattno 1 :vartype 23 :vartypmod -1 :varcollid 0 :varlevelsup 0 :varnoold 1 :varoattno&nbsp;</font></div><div><font size="2"   >1 :location 147}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16557 | a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {VAR :varno 1 :varattno 1 :vartype 23 :vartypmod -1 :varcollid 0 :varlevelsup 0 :varnoold 1 :varoattno&nbsp;</font></div><div><font size="2"   >1 :location 388}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16560 | a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {VAR :varno 1 :varattno 1 :vartype 23 :vartypmod -1 :varcollid 0 :varlevelsup 0 :varnoold 1 :varoattno&nbsp;</font></div><div><font size="2"   >1 :location 316}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16563 | a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {VAR :varno 1 :varattno 1 :vartype 23 :vartypmod -1 :varcollid 0 :varlevelsup 0 :varnoold 1 :varoattno&nbsp;</font></div><div><font size="2"   >1 :location 244}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16566 | a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {VAR :varno 1 :varattno 1 :vartype 23 :vartypmod -1 :varcollid 0 :varlevelsup 0 :varnoold 1 :varoattno&nbsp;</font></div><div><font size="2"   >1 :location 358}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16569 | a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {VAR :varno 1 :varattno 1 :vartype 20 :vartypmod -1 :varcollid 0 :varlevelsup 0 :varnoold 1 :varoattno&nbsp;</font></div><div><font size="2"   >1 :location 407}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16572 | a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {VAR :varno 1 :varattno 1 :vartype 20 :vartypmod -1 :varcollid 0 :varlevelsup 0 :varnoold 1 :varoattno&nbsp;</font></div><div><font size="2"   >1 :location 649}</font></div><div><font size="2"   >(9 rows)</font></div><p></p></pre></div><div># shard信息如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_dist_shard;</font></div><div><font size="2"   >&nbsp;logicalrelid | shardid | shardstorage | shardalias | shardminvalue | shardmaxvalue&nbsp;</font></div><div><font size="2"   >--------------+---------+--------------+------------+---------------+---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16467 | &nbsp;102010 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1970-12-30 &nbsp; &nbsp;| 1998-12-31</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16467 | &nbsp;102014 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1999-01-01 &nbsp; &nbsp;| 1999-12-31</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16478 | &nbsp;102016 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1970-12-30 &nbsp; &nbsp;| 1998-12-31</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16467 | &nbsp;102017 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1999-01-01 &nbsp; &nbsp;| 1999-12-31</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16467 | &nbsp;102018 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1970-12-30 &nbsp; &nbsp;| 1998-12-31</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16515 | &nbsp;102020 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1970-12-30 &nbsp; &nbsp;| 1998-12-31</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16515 | &nbsp;102021 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1999-01-01 &nbsp; &nbsp;| 1999-12-31</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16572 | &nbsp;102022 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 1075520</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16572 | &nbsp;102023 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1075520 &nbsp; &nbsp; &nbsp; | 2142211</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16572 | &nbsp;102024 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2142211 &nbsp; &nbsp; &nbsp; | 3209632</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16572 | &nbsp;102025 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3209632 &nbsp; &nbsp; &nbsp; | 4275712</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16572 | &nbsp;102026 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 4275713 &nbsp; &nbsp; &nbsp; | 5342467</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16572 | &nbsp;102027 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 5342468 &nbsp; &nbsp; &nbsp; | 6000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16569 | &nbsp;102028 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 4725991</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16569 | &nbsp;102029 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 4726016 &nbsp; &nbsp; &nbsp; | 6000000</font></div><div><font size="2"   >(15 rows)</font></div><p></p></pre></div><div># shard的物理位置如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_dist_shard_placement;</font></div><div><font size="2"   >&nbsp;shardid | shardstate | shardlength | nodename | nodeport&nbsp;</font></div><div><font size="2"   >---------+------------+-------------+----------+----------</font></div><div><font size="2"   >&nbsp; 102010 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 145932288 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102010 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 145932288 | work04 &nbsp; | &nbsp; &nbsp; 9904</font></div><div><font size="2"   >&nbsp; 102014 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 286695424 | work02 &nbsp; | &nbsp; &nbsp; 9902</font></div><div><font size="2"   >&nbsp; 102014 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 286695424 | work03 &nbsp; | &nbsp; &nbsp; 9903</font></div><div><font size="2"   >&nbsp; 102016 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 145932288 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102016 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 145932288 | work02 &nbsp; | &nbsp; &nbsp; 9902</font></div><div><font size="2"   >&nbsp; 102017 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 286695424 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102017 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 286695424 | work02 &nbsp; | &nbsp; &nbsp; 9902</font></div><div><font size="2"   >&nbsp; 102018 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 145932288 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102018 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 145932288 | work04 &nbsp; | &nbsp; &nbsp; 9904</font></div><div><font size="2"   >&nbsp; 102020 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 145932288 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102020 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 145932288 | work02 &nbsp; | &nbsp; &nbsp; 9902</font></div><div><font size="2"   >&nbsp; 102021 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 286695424 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102021 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 286695424 | work03 &nbsp; | &nbsp; &nbsp; 9903</font></div><div><font size="2"   >&nbsp; 102022 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 169689088 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102022 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 169689088 | work04 &nbsp; | &nbsp; &nbsp; 9904</font></div><div><font size="2"   >&nbsp; 102023 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 168288256 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102023 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 168288256 | work02 &nbsp; | &nbsp; &nbsp; 9902</font></div><div><font size="2"   >&nbsp; 102024 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 168280064 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102024 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 168280064 | work04 &nbsp; | &nbsp; &nbsp; 9904</font></div><div><font size="2"   >&nbsp; 102025 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 168280064 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102025 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 168280064 | work02 &nbsp; | &nbsp; &nbsp; 9902</font></div><div><font size="2"   >&nbsp; 102026 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 168296448 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102026 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 168296448 | work03 &nbsp; | &nbsp; &nbsp; 9903</font></div><div><font size="2"   >&nbsp; 102027 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 103792640 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102027 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 103792640 | work03 &nbsp; | &nbsp; &nbsp; 9903</font></div><div><font size="2"   >&nbsp; 102028 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 173293568 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102028 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 173293568 | work04 &nbsp; | &nbsp; &nbsp; 9904</font></div><div><font size="2"   >&nbsp; 102029 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;46702592 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102029 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;46702592 | work04 &nbsp; | &nbsp; &nbsp; 9904</font></div><div><font size="2"   >(30 rows)</font></div><p></p></pre></div><div><br></div><div># 配置shard_replication_factor=1, 则以下数据将只会导入1个worker节点. 换句话说就是只有1份数据.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# SET shard_replication_factor TO '1';</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# \STAGE nation FROM '/data05/citusdb/tpch_2_13_0/nation.tbl' WITH DELIMITER '|';</font></div><div><font size="2"   >digoal=# \STAGE part FROM '/data05/citusdb/tpch_2_13_0/part.tbl' WITH DELIMITER '|';</font></div><div><font size="2"   >digoal=# \STAGE partsupp FROM '/data05/citusdb/tpch_2_13_0/partsupp.tbl' WITH DELIMITER '|';</font></div><div><font size="2"   >digoal=# \STAGE region FROM '/data05/citusdb/tpch_2_13_0/region.tbl' WITH DELIMITER '|';</font></div><div><font size="2"   >digoal=# \STAGE supplier FROM '/data05/citusdb/tpch_2_13_0/supplier.tbl' WITH DELIMITER '|';</font></div><p></p></pre></div><div><br></div><div>7. 查询导入的数据量.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select count(*) from customer;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select count(*) from lineitem;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;6001215</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select count(*) from nation;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp; 25</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select count(*) from orders;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1500000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select count(*) from part;</font></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;200000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select count(*) from partsupp;</font></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;800000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select count(*) from region;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;5</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select count(*) from supplier;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;10000</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div># 从shard的物理位置信息可以看出, 后面导入的5个表只有1份数据 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_dist_shard_placement;</font></div><div><font size="2"   >&nbsp;shardid | shardstate | shardlength | nodename | nodeport&nbsp;</font></div><div><font size="2"   >---------+------------+-------------+----------+----------</font></div><div><font size="2"   >&nbsp; 102010 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 145932288 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102010 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 145932288 | work04 &nbsp; | &nbsp; &nbsp; 9904</font></div><div><font size="2"   >&nbsp; 102014 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 286695424 | work02 &nbsp; | &nbsp; &nbsp; 9902</font></div><div><font size="2"   >&nbsp; 102014 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 286695424 | work03 &nbsp; | &nbsp; &nbsp; 9903</font></div><div><font size="2"   >&nbsp; 102016 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 145932288 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102016 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 145932288 | work02 &nbsp; | &nbsp; &nbsp; 9902</font></div><div><font size="2"   >&nbsp; 102017 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 286695424 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102017 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 286695424 | work02 &nbsp; | &nbsp; &nbsp; 9902</font></div><div><font size="2"   >&nbsp; 102018 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 145932288 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102018 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 145932288 | work04 &nbsp; | &nbsp; &nbsp; 9904</font></div><div><font size="2"   >&nbsp; 102020 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 145932288 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102020 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 145932288 | work02 &nbsp; | &nbsp; &nbsp; 9902</font></div><div><font size="2"   >&nbsp; 102021 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 286695424 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102021 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 286695424 | work03 &nbsp; | &nbsp; &nbsp; 9903</font></div><div><font size="2"   >&nbsp; 102022 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 169689088 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102022 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 169689088 | work04 &nbsp; | &nbsp; &nbsp; 9904</font></div><div><font size="2"   >&nbsp; 102023 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 168288256 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102023 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 168288256 | work02 &nbsp; | &nbsp; &nbsp; 9902</font></div><div><font size="2"   >&nbsp; 102024 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 168280064 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102024 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 168280064 | work04 &nbsp; | &nbsp; &nbsp; 9904</font></div><div><font size="2"   >&nbsp; 102025 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 168280064 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102025 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 168280064 | work02 &nbsp; | &nbsp; &nbsp; 9902</font></div><div><font size="2"   >&nbsp; 102026 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 168296448 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102026 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 168296448 | work03 &nbsp; | &nbsp; &nbsp; 9903</font></div><div><font size="2"   >&nbsp; 102027 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 103792640 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102027 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 103792640 | work03 &nbsp; | &nbsp; &nbsp; 9903</font></div><div><font size="2"   >&nbsp; 102028 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 173293568 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102028 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 173293568 | work04 &nbsp; | &nbsp; &nbsp; 9904</font></div><div><font size="2"   >&nbsp; 102029 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;46702592 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102029 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;46702592 | work04 &nbsp; | &nbsp; &nbsp; 9904</font></div><div><font size="2"   >&nbsp; 102030 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp;8192 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102031 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;33579008 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102032 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 143638528 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102033 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp;8192 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102034 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 1826816 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >(35 rows)</font></div><p></p></pre></div><div># 导入数据时调整了2个参数, 介绍如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Note that you changed two run-time configuration parameters in this example.&nbsp;</font></div><div><font size="2"   >First, you reduced the shard maximum size;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; this change breaks up staged data into multiple shards and enables parallel execution of analytics queries across these shards.&nbsp;</font></div><div><font size="2"   >Second, you set the replication factor to 1 for the part table;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; this ensures that only one worker node has this table's shard(s) and helps us demonstrate how shards are moved around during joins.</font></div><p></p></pre></div><div><br></div><div>8. 测试查询 - 1</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >This simple query computes an aggregate across one year's worth of data.&nbsp;</font></div><div><font size="2"   >The query still needs to scan through the entire table though, as the table is distributed on the order key and doesn't yet have any indexes defined on the shipment date.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# \timing</font></div><div><font size="2"   >Timing is on.</font></div><div><font size="2"   >digoal=# SELECT&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; sum(l_extendedprice * l_discount) as revenue</font></div><div><font size="2"   >FROM</font></div><div><font size="2"   >&nbsp; &nbsp; lineitem</font></div><div><font size="2"   >WHERE</font></div><div><font size="2"   >&nbsp; &nbsp; l_shipdate &gt;= date '1994-01-01' AND</font></div><div><font size="2"   >&nbsp; &nbsp; l_shipdate &lt; date '1994-01-01' + interval '1' year AND</font></div><div><font size="2"   >&nbsp; &nbsp; l_discount between 0.06 - 0.01 AND 0.06 + 0.01 AND</font></div><div><font size="2"   >&nbsp; &nbsp; l_quantity &lt; 24;</font></div><div><font size="2"   >&nbsp; &nbsp; revenue &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;123141078.2283</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 1204.323 ms</font></div><p></p></pre></div><div>中间结果用到了临时表 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp; Schema &nbsp; | &nbsp; &nbsp; &nbsp; Name &nbsp; &nbsp; &nbsp; &nbsp;| Type &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >-----------+-------------------+-------+----------</font></div><div><font size="2"   >&nbsp;pg_temp_2 | pg_merge_job_0076 | table | postgres</font></div></div><div><div><font size="2"   >digoal=# select * from pg_merge_job_0076 ;</font></div><div><font size="2"   >&nbsp;intermediate_column_0&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;22338213.4033</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;21776107.6843</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;21903335.4661</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;22187630.0276</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;21421253.2093</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;13514538.4377</font></div><div><font size="2"   >(6 rows)</font></div></div><p></p></pre></div><div><br></div><div>9. 测试查询 - 2</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >This query includes a join between a large lineitem table and a small part table.&nbsp;</font></div><div><font size="2"   >The distinction between large and small tables is determined by the configuration entry large_table_shard_count;&nbsp;</font></div><div><font size="2"   >and tables whose shard count exceed this value are considered as large.</font></div><div><div style="line-height: 22px;"   ><font size="2"   >In this example, the part table's shard(s) are cached on all worker nodes the very first time the user issues a query.&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >Subsequent queries that involve the part table then use these cached shards.</font></div></div><p></p></pre></div><div>目前CitusDB支持大表和小表的JOIN. 大表和大表的JOIN有使用限制, 后面会提到.</div><div><div style="line-height: 22px;"   >CitusDB在处理JOIN时, 大小表的处理方式不一样, 其中小表的数据会拷贝到各个需要用到的Worder节点. 然后JOIN时使用这些拷贝.</div><div style="line-height: 22px;"   >CitusDB通过<span style="line-height: 22px;"   >large_table_shard_count来区分大小表, 当表的shard数量&gt;=</span><span style="line-height: 22px;"   >large_table_shard_count时为大表.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >注意大表和大表的JOIN必须在partition key上join, 否则会报错.</span></div></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >digoal=# SELECT</font></span></div><div><font size="2"   >&nbsp; &nbsp; 100.00 *</font></div><div><font size="2"   >&nbsp; &nbsp; sum(case when p_type like 'PROMO%'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;then l_extendedprice * (1 - l_discount)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;else 0 end) /</font></div><div><font size="2"   >&nbsp; &nbsp; sum(l_extendedprice * (1 - l_discount)) AS promo_revenue</font></div><div><font size="2"   >FROM</font></div><div><font size="2"   >&nbsp; &nbsp; lineitem,</font></div><div><font size="2"   >&nbsp; &nbsp; part</font></div><div><font size="2"   >WHERE</font></div><div><font size="2"   >&nbsp; &nbsp; l_partkey = p_partkey AND</font></div><div><font size="2"   >&nbsp; &nbsp; l_shipdate &gt;= date '1995-09-01' AND</font></div><div><font size="2"   >&nbsp; &nbsp; l_shipdate &lt; date '1995-09-01' + interval '1' month;</font></div><div><font size="2"   >&nbsp; &nbsp; promo_revenue &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;16.3807786263955401</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 2005.314 ms</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 中间结果用到临时表 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp; Schema &nbsp; | &nbsp; &nbsp; &nbsp; Name &nbsp; &nbsp; &nbsp; &nbsp;| Type &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >-----------+-------------------+-------+----------</font></div><div><font size="2"   >&nbsp;pg_temp_2 | pg_merge_job_0077 | table | postgres</font></div></div><div><div><font size="2"   >digoal=# select * from pg_merge_job_0077 ;</font></div><div><font size="2"   >&nbsp;intermediate_column_0 | intermediate_column_1&nbsp;</font></div><div><font size="2"   >-----------------------+-----------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;79757784.8406 | &nbsp; &nbsp; &nbsp; &nbsp;492691187.1877</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;80940684.2199 | &nbsp; &nbsp; &nbsp; &nbsp;499015015.2883</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;79958247.6519 | &nbsp; &nbsp; &nbsp; &nbsp;488094732.3602</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;79837944.8834 | &nbsp; &nbsp; &nbsp; &nbsp;486724756.3067</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;82862404.5559 | &nbsp; &nbsp; &nbsp; &nbsp;494397809.0203</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;49071739.0784 | &nbsp; &nbsp; &nbsp; &nbsp;301025828.0639</font></div><div><font size="2"   >(6 rows)</font></div></div><p></p></pre></div><div># 中间结果每次调用SQL会重新生成</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# SELECT</font></div><div><font size="2"   >&nbsp; &nbsp; 100.00 *</font></div><div><font size="2"   >&nbsp; &nbsp; sum(case when p_type like 'PROMO%'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;then l_extendedprice * (1 - l_discount)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;else 0 end) /</font></div><div><font size="2"   >&nbsp; &nbsp; sum(l_extendedprice * (1 - l_discount)) AS promo_revenue</font></div><div><font size="2"   >FROM</font></div><div><font size="2"   >&nbsp; &nbsp; lineitem,</font></div><div><font size="2"   >&nbsp; &nbsp; part</font></div><div><font size="2"   >WHERE</font></div><div><font size="2"   >&nbsp; &nbsp; l_partkey = p_partkey AND</font></div><div><font size="2"   >&nbsp; &nbsp; l_shipdate &gt;= date '1995-09-01' AND</font></div><div><font size="2"   >&nbsp; &nbsp; l_shipdate &lt; date '1995-09-01' + interval '1' month;</font></div><div><font size="2"   >&nbsp; &nbsp; promo_revenue &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;16.3807786263955401</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp; Schema &nbsp; | &nbsp; &nbsp; &nbsp; Name &nbsp; &nbsp; &nbsp; &nbsp;| Type &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >-----------+-------------------+-------+----------</font></div><div><font size="2"   >&nbsp;pg_temp_2 | pg_merge_job_0077 | table | postgres</font></div><div><font size="2"   >&nbsp;pg_temp_2 | pg_merge_job_0078 | table | postgres</font></div><p></p></pre></div><div><br></div><div># 上面提到<span style="line-height: 22px;"   >大表和大表的JOIN必须在partition key上join, 否则会报错.</span></div><div><span style="line-height: 22px;"   ># 以上SQL中关联的两个表是part和lineitem, 分别有1个和6个shard.</span></div><div><span style="line-height: 22px;"   ># 当前的</span>large_table_shard_count=4; 所以以上SQL是小表和大表的JOIN.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_dist_shard where logicalrelid='part'::regclass;</font></div><div><font size="2"   >&nbsp;logicalrelid | shardid | shardstorage | shardalias | shardminvalue | shardmaxvalue&nbsp;</font></div><div><font size="2"   >--------------+---------+--------------+------------+---------------+---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16557 | &nbsp;102031 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 200000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select * from pg_dist_shard where logicalrelid='lineitem'::regclass;</font></div><div><font size="2"   >&nbsp;logicalrelid | shardid | shardstorage | shardalias | shardminvalue | shardmaxvalue&nbsp;</font></div><div><font size="2"   >--------------+---------+--------------+------------+---------------+---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16572 | &nbsp;102027 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 5342468 &nbsp; &nbsp; &nbsp; | 6000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16572 | &nbsp;102026 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 4275713 &nbsp; &nbsp; &nbsp; | 5342467</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16572 | &nbsp;102025 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3209632 &nbsp; &nbsp; &nbsp; | 4275712</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16572 | &nbsp;102024 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2142211 &nbsp; &nbsp; &nbsp; | 3209632</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16572 | &nbsp;102023 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1075520 &nbsp; &nbsp; &nbsp; | 2142211</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16572 | &nbsp;102022 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 1075520</font></div><div><font size="2"   >(6 rows)</font></div><p></p></pre></div><div><div style="line-height: 22px;"   ># CitusDB在处理JOIN时, 大小表的处理方式不一样, 其中小表的数据会拷贝到各个需要用到的Worder节点. 然后JOIN时使用这些拷贝.</div><div style="line-height: 22px;"   >CitusDB通过<span style="line-height: 22px;"   >large_table_shard_count来区分大小表, 当表的shard数量&gt;=</span><span style="line-height: 22px;"   >large_table_shard_count时为大表.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >注意大表和大表的JOIN必须在partition key上join, 否则会报错.</span></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Citus DB treats large and small tables differently, and replicates a small table's shards to where the large table's shards are in order to perform the query.&nbsp;</font></div><div><font size="2"   >In this example, the part table's shard(s) are cached on all worker nodes the very first time the user issues a query.&nbsp;</font></div><div><font size="2"   >Subsequent queries that involve the part table then use these cached shards.</font></div><div><font size="2"   >This model works nicely for queries that join one large and multiple small tables together.&nbsp;</font></div><div><font size="2"   >The model also supports joins between large tables, provided that the tables are already partitioned on the join key.&nbsp;</font></div><div><font size="2"   >For other types of large table joins, Citus DB doesn't yet have any support.</font></div><p></p></pre></div><div><div style="line-height: 22px;"   ><br></div></div><div>10. 大表与大表的JOIN测试</div><div># 目前不支持两个large table的非partition key 的 join.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# set large_table_shard_count=1;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# \set VERBOSITY verbose</font></div><div><font size="2"   >digoal=# SELECT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; 100.00 *</font></div><div><font size="2"   >&nbsp; &nbsp; sum(case when p_type like 'PROMO%'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;then l_extendedprice * (1 - l_discount)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;else 0 end) /</font></div><div><font size="2"   >&nbsp; &nbsp; sum(l_extendedprice * (1 - l_discount)) AS promo_revenue</font></div><div><font size="2"   >FROM</font></div><div><font size="2"   >&nbsp; &nbsp; lineitem,</font></div><div><font size="2"   >&nbsp; &nbsp; part</font></div><div><font size="2"   >WHERE</font></div><div><font size="2"   >&nbsp; &nbsp; l_partkey = p_partkey AND</font></div><div><font size="2"   >&nbsp; &nbsp; l_shipdate &gt;= date '1995-09-01' AND</font></div><div><font size="2"   >&nbsp; &nbsp; l_shipdate &lt; date '1995-09-01' + interval '1' month;</font></div><div><font size="2"   >ERROR: &nbsp;0A000: cannot perform distributed execution on this query</font></div><div><font size="2"   >DETAIL: &nbsp;Large table joins are currently unsupported</font></div><div><font size="2"   >LOCATION: &nbsp;MultiPhysicalPlanCreate, multi_physical_planner.c:150</font></div><p></p></pre></div><div><br></div><div># 将以上SQL改成partition key的join (<span style="line-height: 22px;"   >l_orderkey = p_partkey</span><span style="line-height: 22px;"   >) 就可以了.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# SELECT &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; 100.00 *</font></div><div><font size="2"   >&nbsp; &nbsp; sum(case when p_type like 'PROMO%'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;then l_extendedprice * (1 - l_discount)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;else 0 end) /</font></div><div><font size="2"   >&nbsp; &nbsp; sum(l_extendedprice * (1 - l_discount)) AS promo_revenue</font></div><div><font size="2"   >FROM</font></div><div><font size="2"   >&nbsp; &nbsp; lineitem,</font></div><div><font size="2"   >&nbsp; &nbsp; part</font></div><div><font size="2"   >WHERE</font></div><div><font size="2"   >&nbsp; &nbsp; l_orderkey = p_partkey AND</font></div><div><font size="2"   >&nbsp; &nbsp; l_shipdate &gt;= date '1995-09-01' AND</font></div><div><font size="2"   >&nbsp; &nbsp; l_shipdate &lt; date '1995-09-01' + interval '1' month;</font></div><div><font size="2"   >&nbsp; &nbsp; promo_revenue &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;16.8469836269420616</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 1905.719 ms</font></div><p></p></pre></div><div><br></div><div>【其他】</div><div>1.&nbsp;<span style="line-height: 22px;"   >worker 节点的表名命名规则, 原始表名加shardid后缀.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.1 -p 9901&nbsp;</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Type &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >--------+-------------------------+-------+----------</font></div><div><font size="2"   >&nbsp;public | customer_reviews_102016 | table | postgres</font></div><div><font size="2"   >&nbsp;public | customer_reviews_102017 | table | postgres</font></div><div><font size="2"   >&nbsp;public | customer_reviews_102018 | table | postgres</font></div><div><font size="2"   >&nbsp;public | customer_reviews_102020 | table | postgres</font></div><div><font size="2"   >&nbsp;public | customer_reviews_102021 | table | postgres</font></div><div><font size="2"   >&nbsp;public | lineitem_102022 &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | lineitem_102023 &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | lineitem_102024 &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | lineitem_102025 &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | lineitem_102026 &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | lineitem_102027 &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | nation_102030 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | orders_102028 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | orders_102029 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | part_102031 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | partsupp_102032 &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | region_102033 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | supplier_102034 &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >(18 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.2 -p 9902</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Type &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >--------+-------------------------+-------+----------</font></div><div><font size="2"   >&nbsp;public | customer_reviews_102016 | table | postgres</font></div><div><font size="2"   >&nbsp;public | customer_reviews_102017 | table | postgres</font></div><div><font size="2"   >&nbsp;public | customer_reviews_102020 | table | postgres</font></div><div><font size="2"   >&nbsp;public | lineitem_102023 &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | lineitem_102025 &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >(5 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.3 -p 9903</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Type &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >--------+-------------------------+-------+----------</font></div><div><font size="2"   >&nbsp;public | customer_reviews_102021 | table | postgres</font></div><div><font size="2"   >&nbsp;public | lineitem_102026 &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | lineitem_102027 &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >(3 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# \q</font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.4 -p 9904</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Type &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >--------+-------------------------+-------+----------</font></div><div><font size="2"   >&nbsp;public | customer_reviews_102018 | table | postgres</font></div><div><font size="2"   >&nbsp;public | lineitem_102022 &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | lineitem_102024 &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | orders_102028 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | orders_102029 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div><div><br></div><div><br></div><div>2. queries_distributed所有的查询SQL结果如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 127.0.0.1 -U digoal digoal -f ./queries_distributed&nbsp;</font></div><div><font size="2"   >&nbsp;l_returnflag | l_linestatus | &nbsp; sum_qty &nbsp; | sum_base_price &nbsp;| &nbsp;sum_disc_price &nbsp; | &nbsp; &nbsp; sum_charge &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; avg_qty &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; a</font></div><div><font size="2"   >vg_price &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;avg_disc &nbsp; &nbsp; &nbsp; &nbsp;| count_order&nbsp;</font></div><div><font size="2"   >--------------+--------------+-------------+-----------------+-------------------+---------------------+---------------------+------</font></div><div><font size="2"   >--------------+------------------------+-------------</font></div><div><font size="2"   >&nbsp;A &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| F &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 37734107.00 | &nbsp;56586554400.73 | &nbsp;53758257134.8700 | &nbsp;55909065222.827692 | 25.5220058532573370 | 38273</font></div><div><font size="2"   >.129734621672 | 0.04998529583839761162 | &nbsp; &nbsp; 1478493</font></div><div><font size="2"   >&nbsp;N &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| F &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; 991417.00 | &nbsp; 1487504710.38 | &nbsp; 1413082168.0541 | &nbsp; 1469649223.194375 | 25.5164719205229835 | 38284</font></div><div><font size="2"   >.467760848304 | 0.05009342667421629691 | &nbsp; &nbsp; &nbsp; 38854</font></div><div><font size="2"   >&nbsp;N &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| O &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 74476040.00 | 111701729697.74 | 106118230307.6056 | 110367043872.497010 | 25.5022267695849915 | 38249</font></div><div><font size="2"   >.117988908270 | 0.04999658605370408037 | &nbsp; &nbsp; 2920374</font></div><div><font size="2"   >&nbsp;R &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| F &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 37719753.00 | &nbsp;56568041380.90 | &nbsp;53741292684.6040 | &nbsp;55889619119.831932 | 25.5057936126907707 | 38250</font></div><div><font size="2"   >.854626099657 | 0.05000940583012705647 | &nbsp; &nbsp; 1478870</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp;l_orderkey | revenue | o_orderdate | o_shippriority&nbsp;</font></div><div><font size="2"   >------------+---------+-------------+----------------</font></div><div><font size="2"   >(0 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp;n_name | revenue&nbsp;</font></div><div><font size="2"   >--------+---------</font></div><div><font size="2"   >(0 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; revenue &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;123141078.2283</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp;c_custkey | c_name | revenue | c_acctbal | n_name | c_address | c_phone | c_comment&nbsp;</font></div><div><font size="2"   >-----------+--------+---------+-----------+--------+-----------+---------+-----------</font></div><div><font size="2"   >(0 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp;l_shipmode | high_line_count | low_line_count&nbsp;</font></div><div><font size="2"   >------------+-----------------+----------------</font></div><div><font size="2"   >&nbsp;MAIL &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6202 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 9324</font></div><div><font size="2"   >&nbsp;SHIP &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6200 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 9262</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; promo_revenue &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;16.3807786263955401</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;revenue &nbsp; &nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp;3083843.0578</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div><br></div><div><br></div>【参考】<div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://www.citusdata.com/docs/examples"   >http://www.citusdata.com/docs/examples</a></div><div>2.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013219840831/"   >http://blog.163.com/digoal@126/blog/static/1638770402013219840831/</a></div><div><br><br></div></div>
	</div>
</div>
</body>
</html>