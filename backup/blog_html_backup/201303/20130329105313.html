<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Install PostgreSQL on Ubuntu 12.04 x64</h2>
	<h5 id="">2013-03-29 10:53:13&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201322910435027/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>昨天在测试KVM虚拟机环境下的PostgreSQL性能的时候, 为了对比主机和虚拟机的性能在ubuntu的主机上也装了一个PostgreSQL进行测试.</div><div>下面记录一下ubuntu 12.04 desktop x64安装PostgreSQL的步骤.&nbsp;</div><div>1. 安装必要的包 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >apt-get install flex</font></div><div><font size="2"   >flex -V</font></div><div><font size="2"   >flex 2.5.35</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >apt-get install coreutils</font></div><div><font size="2"   >apt-get install libreadline-dev</font></div><div><font size="2"   >apt-get install zlibc</font></div><div><font size="2"   >apt-get install zlib1g-dev</font></div><div><font size="2"   >apt-get install libssl-dev</font></div><div><font size="2"   >apt-get install libpam-dev</font></div><div><font size="2"   >apt-get install libxml2-dev</font></div><div><font size="2"   >apt-get install libxslt-dev</font></div><div><font size="2"   >apt-get install tcl perl python</font></div><div><font size="2"   >apt-get install tcl-dev</font></div><div><font size="2"   >apt-get install python-dev</font></div><div><font size="2"   >apt-get install libperl-dev</font></div><p></p></pre></div><div>2. 添加用户, 修改环境变量</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >useradd postgres</font></div><div><font size="2"   >vi /home/postgres/.bashrc</font></div><div><font size="2"   ># add by digoal</font></div><div><font size="2"   >export PGPORT=1921</font></div><div><font size="2"   >export PGDATA=/data01/pgdata/pg_root</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/opt/pgsql</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"   >export PGUSER=postgres</font></div><div><font size="2"   >export PGHOST=$PGDATA</font></div><div><font size="2"   >export PGDATABASE=postgres</font></div><div><font size="2"   >alias rm='rm -i'</font></div><div><font size="2"   >alias ll='ls -lh'</font></div><p></p></pre></div><div>3. 下载postgresql.conf</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >wget http://ftp.postgresql.org/pub/source/v9.2.3/postgresql-9.2.3.tar.bz2</font></div><div><font size="2"   >tar -jxvf postgresql-9.2.3.tar.bz2</font></div><p></p></pre></div><div>4. 安装</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd postgresql-9.2.3</font></div><div><font size="2"   >. /home/postgres/.bashrc</font></div><div><font size="2"   >./configure --prefix=/opt/pgsql9.2.3 --with-pgport=1921 --with-perl --with-tcl --with-python --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=16 --enable-debug &amp;&amp; make world</font></div><div><font size="2"   >make install-world</font></div><div><font size="2"   >ln -s /opt/pgsql9.2.3 /opt/pgsql</font></div><p></p></pre></div><div>5. 修改内核参数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/etc/sysctl.conf</font></div><div><div><font size="2"   ># Controls the maximum size of a message, in bytes</font></div><div><font size="2"   >kernel.msgmnb = 65536</font></div><div><font size="2"   ># Controls the default maxmimum size of a mesage queue</font></div><div><font size="2"   >kernel.msgmax = 65536</font></div><div><font size="2"   ># Controls the maximum shared segment size, in bytes</font></div><div><font size="2"   >kernel.shmmax = 68719476736</font></div><div><font size="2"   ># Controls the maximum number of shared memory segments, in pages</font></div><div><font size="2"   >kernel.shmall = 4294967296</font></div><div><font size="2"   >kernel.shmmni = 4096</font></div><div><font size="2"   >kernel.sem = 50100 64128000 50100 1280</font></div><div><font size="2"   >fs.file-max = 7672460</font></div><div><font size="2"   >net.ipv4.ip_local_port_range = 9000 65000</font></div><div><font size="2"   >net.core.rmem_default = 1048576</font></div><div><font size="2"   >net.core.rmem_max = 4194304</font></div><div><font size="2"   >net.core.wmem_default = 262144</font></div><div><font size="2"   >net.core.wmem_max = 1048576</font></div><div><font size="2"   >net.ipv4.tcp_tw_recycle = 1</font></div><div><font size="2"   >net.ipv4.tcp_max_syn_backlog = 4096</font></div><div><font size="2"   >net.core.netdev_max_backlog = 10000</font></div><div><font size="2"   >vm.overcommit_memory = 0</font></div><div><font size="2"   >net.ipv4.ip_conntrack_max = 655360</font></div><div><font size="2"   >fs.aio-max-nr = 1048576</font></div><div><font size="2"   >net.ipv4.tcp_timestamps = 0</font></div></div><div><font size="2"   ># sysctl -p</font></div><div><font size="2"   >/etc/security/limits.conf</font></div><div><div><font size="2"   >* soft &nbsp; &nbsp;nofile &nbsp;131072</font></div><div><font size="2"   >* hard &nbsp; &nbsp;nofile &nbsp;131072</font></div><div><font size="2"   >* soft &nbsp; &nbsp;nproc &nbsp; 131072</font></div><div><font size="2"   >* hard &nbsp; &nbsp;nproc &nbsp; 131072</font></div><div><font size="2"   >* soft &nbsp; &nbsp;core &nbsp; &nbsp;unlimited</font></div><div><font size="2"   >* hard &nbsp; &nbsp;core &nbsp; &nbsp;unlimited</font></div><div><font size="2"   >* soft &nbsp; &nbsp;memlock 50000000</font></div><div><font size="2"   >* hard &nbsp; &nbsp;memlock 50000000</font></div></div><p></p></pre></div><div><br></div><div>6. 初始化数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - postgres</font></div><div><font size="2"   >sudo mkdir -p $PGDATA</font></div><div><font size="2"   >sudo chown -R postgres:postgres $PGDATA</font></div><div><font size="2"   >initdb -D $PGDATA -E UTF8 --locale=C -U postgres -W</font></div><p></p></pre></div><div><br></div><div>7. 配置数据库参数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi $PGDATA/postgresql.conf</font></div><div><div><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"   >port = 1921 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >max_connections = 500 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >superuser_reserved_connections = 13 &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_directory = '.' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_permissions = 0700 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# begin with 0 to use octal notation</font></div><div><font size="2"   >tcp_keepalives_idle = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPIDLE, in seconds;</font></div><div><font size="2"   >tcp_keepalives_interval = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPINTVL, in seconds;</font></div><div><font size="2"   >tcp_keepalives_count = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # TCP_KEEPCNT;</font></div><div><font size="2"   >shared_buffers = 1024MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div><font size="2"   >wal_level = hot_standby &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, or hot_standby</font></div><div><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level;</font></div><div><font size="2"   >wal_buffers = 16384kB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 32kB, -1 sets based on shared_buffers</font></div><div><font size="2"   >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"   >checkpoint_segments = 16 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# in logfile segments, min 1, 16MB each</font></div><div><font size="2"   >archive_mode = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # allows archiving to be done</font></div><div><font size="2"   >archive_command = '/bin/date' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # command to use to archive a logfile segment</font></div><div><font size="2"   >archive_timeout = 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # force a logfile segment switch after this</font></div><div><font size="2"   >max_wal_senders = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of walsender processes</font></div><div><font size="2"   >wal_keep_segments = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# in logfile segments, 16MB each; 0 disables</font></div><div><font size="2"   >hot_standby = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# "on" allows queries during recovery</font></div><div><font size="2"   >wal_receiver_status_interval = 1s &nbsp; &nbsp; &nbsp; # send replies at least this often</font></div><div><font size="2"   >hot_standby_feedback = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # send info from standby to prevent</font></div><div><font size="2"   >random_page_cost = 1.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# same scale as above</font></div><div><font size="2"   >effective_cache_size = 8192MB</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_directory = 'pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,</font></div><div><font size="2"   >log_file_mode = 0600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# creation mode for log files,</font></div><div><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div><font size="2"   >log_rotation_age = 1d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Automatic rotation of logfiles will</font></div><div><font size="2"   >log_rotation_size = 10MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Automatic rotation of logfiles will</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_disconnections = on</font></div><div><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div><font size="2"   >log_timezone = 'PRC'</font></div><div><font size="2"   >log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >timezone = 'PRC'</font></div><div><font size="2"   >lc_messages = 'en_US.utf8' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for system error message</font></div><div><font size="2"   >lc_monetary = 'en_US.utf8' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'en_US.utf8' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for number formatting</font></div><div><font size="2"   >lc_time = 'en_US.utf8' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div></div><p></p></pre></div><div><br></div><div>8. 启动数据库</div><div><pre class="prettyprint"   ><p><font size="2"   >pg_ctl start</font></p></pre></div><div>【其他】</div><div>1.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201322815029796/"   >http://blog.163.com/digoal@126/blog/static/163877040201322815029796/</a></div><wbr></div>
	</div>
</div>
</body>
</html>