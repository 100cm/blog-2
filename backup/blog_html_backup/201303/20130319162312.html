<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">CitusDB, PostgreSQLs Use Hadoop Distribute Query - 2 : CitusDB file_fdw usage</h2>
	<h5 id="">2013-03-19 16:23:12&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020132192011747/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><span style="line-height: 22px;"   >本文的安装以及测试基于上一篇BLOG《</span>CitusDB, PostgreSQLs Use Hadoop Distribute Query - 1 : Single HOST CitusDB Cluster install<span style="line-height: 22px;"   >》的环境.</span></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013219840831/"   >http://blog.163.com/digoal@126/blog/static/1638770402013219840831/</a></div><div><span style="line-height: 22px;"   >CitusDB安装完后, 并没有附带file_fdw. 这里所说的file_fdw并不是PostgreSQL自带的那个file_fdw, 而是经过CitusDB修改的, 目的是要配合CitusDB来使用.</span></div><div><br></div><div><span style="line-height: 22px;"   >1. 下载(master节点和worker节点都需要)</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >wget --no-check-certificate https://github.com/citusdata/file_fdw/archive/master.zip</font></div><div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; unzip master&nbsp;</font></div><div><font size="2"   >Archive: &nbsp;master</font></div><div><font size="2"   >0256d5176163b6698444c45c03a94307ef21da2f</font></div><div><font size="2"   >&nbsp; &nbsp;creating: file_fdw-master/</font></div><div><font size="2"   >&nbsp; inflating: file_fdw-master/Makefile &nbsp;</font></div><div><font size="2"   >&nbsp; inflating: file_fdw-master/README.md &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;creating: file_fdw-master/data/</font></div><div><font size="2"   >&nbsp; inflating: file_fdw-master/data/agg.bad &nbsp;</font></div><div><font size="2"   >&nbsp; inflating: file_fdw-master/data/agg.csv &nbsp;</font></div><div><font size="2"   >&nbsp;extracting: file_fdw-master/data/agg.data &nbsp;</font></div><div><font size="2"   >&nbsp; inflating: file_fdw-master/data/text.csv &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;creating: file_fdw-master/expected/</font></div><div><font size="2"   >&nbsp;extracting: file_fdw-master/expected/.gitignore &nbsp;</font></div><div><font size="2"   >&nbsp; inflating: file_fdw-master/file_fdw--1.0.sql &nbsp;</font></div><div><font size="2"   >&nbsp; inflating: file_fdw-master/file_fdw.c &nbsp;</font></div><div><font size="2"   >&nbsp; inflating: file_fdw-master/file_fdw.control &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;creating: file_fdw-master/input/</font></div><div><font size="2"   >&nbsp; inflating: file_fdw-master/input/file_fdw.source &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;creating: file_fdw-master/output/</font></div><div><font size="2"   >&nbsp; inflating: file_fdw-master/output/file_fdw.source &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;creating: file_fdw-master/sql/</font></div><div><font size="2"   >&nbsp;extracting: file_fdw-master/sql/.gitignore&nbsp;</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >2. 安装</span><span style="line-height: 22px;"   >(master节点和worker节点都需要)</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >su - root</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >. /home/citusdb/.bash_profile</font></span></div><div><div style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-150 data05]# . /home/citusdb/.bash_profile&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >root@db-172-16-3-150-&gt; which pg_config</font></div><div style="line-height: 22px;"   ><font size="2"   >/opt/citusdb/2.0/bin/pg_config</font></div><div style="line-height: 22px;"   ><div><font size="2"   >root@db-172-16-3-150-&gt; cd /home/citusdb/file_fdw-master/</font></div><div><font size="2"   >root@db-172-16-3-150-&gt; gmake USE_PGXS=1</font></div></div><div><font size="2"   >root@db-172-16-3-150-&gt; gmake USE_PGXS=1 install</font></div></div><p></p></pre></div><div><div style="line-height: 22px;"   ><br></div></div><div style="line-height: 22px;"   >3. 创建extension</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 ~]# su - citusdb</font></div><div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 9900 -U digoal digoal</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \dx</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of installed extensions</font></div><div><font size="2"   >&nbsp; Name &nbsp; | Version | &nbsp; Schema &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; Description &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------+---------+------------+------------------------------</font></div><div><font size="2"   >&nbsp;plpgsql | 1.0 &nbsp; &nbsp; | pg_catalog | PL/pgSQL procedural language</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# create extension file_fdw;</font></div><div><font size="2"   >CREATE EXTENSION</font></div></div><div style="line-height: 22px;"   ><font size="2"   ><br></font></div></div><div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.1 -p 9901</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \dx</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of installed extensions</font></div><div><font size="2"   >&nbsp; Name &nbsp; | Version | &nbsp; Schema &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; Description &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------+---------+------------+------------------------------</font></div><div><font size="2"   >&nbsp;plpgsql | 1.0 &nbsp; &nbsp; | pg_catalog | PL/pgSQL procedural language</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 以下步骤可以省略, 执行</span><span style="line-height: 22px;"   >\STAGE时</span><span style="line-height: 22px;"   >会自动在对应的worker节点创建file_fdw extension.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.1 -p 9901 -U postgres digoal -c "create extension file_fdw;"</font></div><div><font size="2"   >CREATE EXTENSION</font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.1 -p 9902 -U postgres digoal -c "create extension file_fdw;"</font></div><div><font size="2"   >CREATE EXTENSION</font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.1 -p 9903 -U postgres digoal -c "create extension file_fdw;"</font></div><div><font size="2"   >CREATE EXTENSION</font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.1 -p 9904 -U postgres digoal -c "create extension file_fdw;"</font></div><div><font size="2"   >CREATE EXTENSION</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >4. 在主节点创建server, distributed外部表.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 9900 -U digoal digoal</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# CREATE SERVER file_server FOREIGN DATA WRAPPER file_fdw;</font></div><div><font size="2"   >digoal=# CREATE FOREIGN TABLE ft_customer_reviews</font></div><div><font size="2"   >(</font></div><div><font size="2"   >&nbsp; &nbsp; customer_id TEXT not null,</font></div><div><font size="2"   >&nbsp; &nbsp; review_date DATE not null,</font></div><div><font size="2"   >&nbsp; &nbsp; review_rating INTEGER not null,</font></div><div><font size="2"   >&nbsp; &nbsp; review_votes INTEGER,</font></div><div><font size="2"   >&nbsp; &nbsp; review_helpful_votes INTEGER,</font></div><div><font size="2"   >&nbsp; &nbsp; product_id CHAR(10) not null,</font></div><div><font size="2"   >&nbsp; &nbsp; product_title TEXT not null,</font></div><div><font size="2"   >&nbsp; &nbsp; product_sales_rank BIGINT,</font></div><div><font size="2"   >&nbsp; &nbsp; product_group TEXT,</font></div><div><font size="2"   >&nbsp; &nbsp; product_category TEXT,</font></div><div><font size="2"   >&nbsp; &nbsp; product_subcategory TEXT,</font></div><div><font size="2"   >&nbsp; &nbsp; similar_product_ids CHAR(10)[]</font></div><div><font size="2"   >)</font></div><div><font size="2"   >DISTRIBUTE BY APPEND (review_date)</font></div><div><font size="2"   >SERVER file_server</font></div><div><font size="2"   >OPTIONS (filename '', format 'csv');</font></div><p></p></pre></div><div># 注意这里的filename为空.</div><div># 不需要在worker节点执行.</div><div><div><br></div><div>5. "导入数据", 实际上并没有真正的导入数据到数据库中, 而是生成shard元数据.&nbsp;</div><div>但是可能涉及worker节点间的数据拷贝.</div><div>从worker01节点连接master节点, 并且只需\STAGE导入数据.</div><div>从worker01节点去连master, 只需\STAGE的意思是worker01节点有数据要载入CitusDB, 因此原始数据必须在worker01节点上.</div><div>这里的shard_replication_factor取默认的2, 所以会产生一份数据拷贝. 这份数据拷贝会放到另一个worker节点的$PGDATA/pg_foreign_file目录下面. 后面会看到这个信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.1 -p 9900 -U digoal digoal</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >\STAGE ft_customer_reviews FROM '/home/citusdb/customer_reviews_1998.csv'</font></div><div><font size="2"   >NOTICE: &nbsp;extension "file_fdw" already exists, skipping</font></div><div><font size="2"   >NOTICE: &nbsp;extension "file_fdw" already exists, skipping</font></div><p></p></pre></div><div># 导入数据时会在worker节点创建file_fdw, 因为前面已经创建了, 所以跳过这个步骤, NOTICE信息可以看出这一点.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \set VERBOSITY verbose</font></div><div><font size="2"   >digoal=# \STAGE ft_customer_reviews FROM '/home/citusdb/customer_reviews_1999.csv'</font></div><div><font size="2"   >NOTICE: &nbsp;extension "file_fdw" already exists, skipping</font></div><div><font size="2"   >NOTICE: &nbsp;extension "file_fdw" already exists, skipping</font></div><p></p></pre></div><div><br></div><div># 查看外部表的oid</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_foreign_table ;</font></div><div><font size="2"   >&nbsp;ftrelid | ftserver | &nbsp; &nbsp; &nbsp; ftoptions &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------+----------+------------------------</font></div><div><font size="2"   >&nbsp; &nbsp;16845 | &nbsp; &nbsp;16844 | {filename=,format=csv}</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from pg_class where oid=16845;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;relname &nbsp; &nbsp; &nbsp; | relnamespace | reltype | reloftype | relowner | relam | relfilenode | reltablespace | relpages | reltuples |&nbsp;</font></div><div><font size="2"   >relallvisible | reltoastrelid | reltoastidxid | relhasindex | relisshared | relpersistence | relkind | relnatts | relchecks | relhas</font></div><div><font size="2"   >oids | relhaspkey | relhasrules | relhastriggers | relhassubclass | relfrozenxid | relacl | reloptions&nbsp;</font></div><div><font size="2"   >---------------------+--------------+---------+-----------+----------+-------+-------------+---------------+----------+-----------+-</font></div><div><font size="2"   >--------------+---------------+---------------+-------------+-------------+----------------+---------+----------+-----------+-------</font></div><div><font size="2"   >-----+------------+-------------+----------------+----------------+--------------+--------+------------</font></div><div><font size="2"   >&nbsp;ft_customer_reviews | &nbsp; &nbsp; &nbsp; &nbsp; 2200 | &nbsp; 16847 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp;16395 | &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; 16845 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; 0 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | p &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 12 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | f &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 查看导入的数据和实际的数据是否一致.</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >digoal=# select count(*) from ft_customer_reviews ;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; count &nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >---------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;1762502</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   >citusdb@db-172-16-3-150-&gt; wc -l customer_reviews_199*.csv</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp;589859 customer_reviews_1998.csv</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; 1172645 customer_reviews_1999.csv</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; 1762504 total</font></div><div style="line-height: 22px;"   ><font size="2"   ># 差2行因为COPY时去除了头行. 如果文件中不包含列名, 则可以加HEADER false.</font></div><p></p></pre></div></div><div><br></div><div>6. 查看外部表的shard信息 :&nbsp;</div><div>默认的<span style="line-height: 22px;"   >shard_replication_factor=2, 所以导入时会有1份拷贝.1份原版.</span></div><div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >digoal=# select * from pg_dist_shard where logicalrelid='ft_customer_reviews'::regclass;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;logicalrelid | shardid | shardstorage | shardalias | shardminvalue | shardmaxvalue&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >--------------+---------+--------------+------------+---------------+---------------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16845 | &nbsp;102037 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1999-01-01 &nbsp; &nbsp;| 1999-12-31</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16845 | &nbsp;102036 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1970-12-30 &nbsp; &nbsp;| 1998-12-31</font></div><div style="line-height: 22px;"   ><font size="2"   >(2 rows)</font></div></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div><div style="line-height: 22px;"   ><font size="2"   >digoal=# select * from pg_dist_shard_placement where shardid in (select shardid from pg_dist_shard where logicalrelid='ft_customer_reviews'::regclass);</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;shardid | shardstate | shardlength | nodename | nodeport&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >---------+------------+-------------+----------+----------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; 102037 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 198247156 | work02 &nbsp; | &nbsp; &nbsp; 9902</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; 102037 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 198247156 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; 102036 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 101299118 | work04 &nbsp; | &nbsp; &nbsp; 9904</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; 102036 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 101299118 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div style="line-height: 22px;"   ><font size="2"   >(4 rows)</font></div></div><p></p></pre></div></div><div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   ># 查看拷贝, 前面提到了,&nbsp;shard_replication_factor=2, 所以导入数据时会产生一份拷贝, 这份拷贝在上面的shard信息中已经体现了.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.1 -p 9902 -U digoal digoal</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><div><font size="2"   >digoal=# \det+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of foreign tables</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; Server &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FDW Options &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+----------------------------+--------------------+-------------------------------------------------------------------------</font></div><div><font size="2"   >-----+-------------</font></div><div><font size="2"   >&nbsp;public | ft_customer_reviews_102037 | file_server_102037 | (filename 'pg_foreign_file/cached/ft_customer_reviews_102037', format 'c</font></div><div><font size="2"   >sv') |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div></div></div><div># 这个拷贝是从work01节点拷贝来的, 放在<span style="line-height: 22px;"   >pg_foreign_file/cached/ft_customer_reviews_102037</span></div><div><br></div><div># 查看原版信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \det+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of foreign tables</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; Server &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FDW Options &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Des</font></div><div><font size="2"   >cription&nbsp;</font></div><div><font size="2"   >--------+----------------------------+--------------------+--------------------------------------------------------------------+----</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;public | ft_customer_reviews_102036 | file_server_102036 | (filename '/home/citusdb/customer_reviews_1998.csv', format 'csv') |&nbsp;</font></div><div><font size="2"   >&nbsp;public | ft_customer_reviews_102037 | file_server_102037 | (filename '/home/citusdb/customer_reviews_1999.csv', format 'csv') |&nbsp;</font></div><div><font size="2"   >&nbsp;public | ft_customer_reviews_102038 | file_server_102038 | (filename '/home/citusdb/customer_reviews_1999.csv', format 'csv') |&nbsp;</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div><div># 因为导入的时候是从worker01节点连接到master节点进行的操作, 所以原版信息在work01节点.</div><div><br></div><div>7. 测试SQL :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# SELECT</font></div><div><font size="2"   >&nbsp; &nbsp; width_bucket(length(product_title), 1, 50, 5) title_length_bucket,</font></div><div><font size="2"   >&nbsp; &nbsp; round(avg(review_rating), 2) AS review_average,</font></div><div><font size="2"   >&nbsp; &nbsp; count(*)</font></div><div><font size="2"   >FROM</font></div><div><font size="2"   >&nbsp; &nbsp;customer_reviews</font></div><div><font size="2"   >WHERE</font></div><div><font size="2"   >&nbsp; &nbsp; product_group = 'Book'</font></div><div><font size="2"   >GROUP BY</font></div><div><font size="2"   >&nbsp; &nbsp; title_length_bucket</font></div><div><font size="2"   >ORDER BY</font></div><div><font size="2"   >&nbsp; &nbsp; title_length_bucket;</font></div><div><font size="2"   >&nbsp;title_length_bucket | review_average | count &nbsp;</font></div><div><font size="2"   >---------------------+----------------+--------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4.26 | 139034</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4.24 | 411318</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4.34 | 245671</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4.32 | 167361</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4.30 | 118422</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4.40 | 116412</font></div><div><font size="2"   >(6 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# SELECT</font></div><div><font size="2"   >&nbsp; &nbsp; customer_id, review_date, review_rating, product_id, product_title</font></div><div><font size="2"   >FROM &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; customer_reviews</font></div><div><font size="2"   >WHERE</font></div><div><font size="2"   >&nbsp; &nbsp; product_title LIKE '%Dune%' AND</font></div><div><font size="2"   >&nbsp; &nbsp; review_votes &gt;= 10 AND</font></div><div><font size="2"   >&nbsp; &nbsp; review_date &gt;= '1998-03-01' AND</font></div><div><font size="2"   >&nbsp; &nbsp; review_date &lt; date '1998-03-01' + interval '3' month;</font></div><div><font size="2"   >&nbsp; customer_id &nbsp; | review_date | review_rating | product_id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; product_title &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----------------+-------------+---------------+------------+-----------------------------------------------</font></div><div><font size="2"   >&nbsp;A34HP4SZ0PQVHN | 1998-05-03 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | 0399128964 | Dune (Dune Chronicles (Econo-Clad Hardcover))</font></div><div><font size="2"   >&nbsp;A34HP4SZ0PQVHN | 1998-05-03 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | 044100590X | Dune</font></div><div><font size="2"   >&nbsp;A34HP4SZ0PQVHN | 1998-05-03 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | 0441172717 | Dune (Dune Chronicles, Book 1)</font></div><div><font size="2"   >&nbsp;A34HP4SZ0PQVHN | 1998-05-03 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | 0881036366 | Dune (Dune Chronicles (Econo-Clad Hardcover))</font></div><div><font size="2"   >&nbsp;A34HP4SZ0PQVHN | 1998-05-03 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | 1559949570 | Dune Audio Collection</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><br></div><div>8. 将<span style="line-height: 22px;"   >shard_replication_factor设置为1, "导入数据". 那么数据只有1份拷贝.</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# set shard_replication_factor=1;</font></div><div><font size="2"   >SET</font></div></div><div><div><font size="2"   >digoal=# \STAGE ft_customer_reviews FROM '/home/citusdb/customer_reviews_1999.csv'</font></div><div><font size="2"   >NOTICE: &nbsp;extension "file_fdw" already exists, skipping</font></div></div><div><div><font size="2"   >digoal=# select * from pg_dist_shard where logicalrelid='ft_customer_reviews'::regclass;</font></div><div><font size="2"   >&nbsp;logicalrelid | shardid | shardstorage | shardalias | shardminvalue | shardmaxvalue&nbsp;</font></div><div><font size="2"   >--------------+---------+--------------+------------+---------------+---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16845 | &nbsp;102038 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1999-01-01 &nbsp; &nbsp;| 1999-12-31</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16845 | &nbsp;102037 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1999-01-01 &nbsp; &nbsp;| 1999-12-31</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16845 | &nbsp;102036 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1970-12-30 &nbsp; &nbsp;| 1998-12-31</font></div><div><font size="2"   >(3 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from pg_dist_shard_placement where shardid in (select shardid from pg_dist_shard where logicalrelid='ft_customer_reviews'::regclass);</font></div><div><font size="2"   >&nbsp;shardid | shardstate | shardlength | nodename | nodeport&nbsp;</font></div><div><font size="2"   >---------+------------+-------------+----------+----------</font></div><div><font size="2"   >&nbsp; 102038 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 198247156 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102037 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 198247156 | work02 &nbsp; | &nbsp; &nbsp; 9902</font></div><div><font size="2"   >&nbsp; 102037 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 198247156 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >&nbsp; 102036 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 101299118 | work04 &nbsp; | &nbsp; &nbsp; 9904</font></div><div><font size="2"   >&nbsp; 102036 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 101299118 | work01 &nbsp; | &nbsp; &nbsp; 9901</font></div><div><font size="2"   >(5 rows)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# select count(*) from ft_customer_reviews ;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;2935146</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div># 从worker02连到master节点, 重新导入 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.2 -p 9900 -U digoal digoal</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# \STAGE ft_customer_reviews FROM '/home/citusdb/customer_reviews_1999.csv'</font></div><div><font size="2"   >NOTICE: &nbsp;extension "file_fdw" already exists, skipping</font></div><div><font size="2"   >NOTICE: &nbsp;extension "file_fdw" already exists, skipping</font></div><p></p></pre></div><div># 查看原版和拷贝的信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.2 -p 9900 -U digoal digoal</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select * from pg_dist_shard_placement where shardid in (select shardid from pg_dist_shard where logicalrelid='ft_customer_reviews'::regclass);</font></div><div><font size="2"   >&nbsp;shardid | shardstate | shardlength | nodename | nodeport&nbsp;</font></div><div><font size="2"   >---------+------------+-------------+----------+----------</font></div><div><font size="2"   >&nbsp; 102039 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 198247156 | work03 &nbsp; | &nbsp; &nbsp; 9903</font></div><div><font size="2"   >&nbsp; 102039 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; 198247156 | work02 &nbsp; | &nbsp; &nbsp; 9902</font></div></div><div><div><font size="2"   >digoal=# select count(*) from ft_customer_reviews ;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;4107790</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.2 -p 9902 -U digoal digoal</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><p></p></pre></div><div><div><br></div><div># 此时原版数据就在worker02节点了,&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \det+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of foreign tables</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; Server &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FDW Options &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+----------------------------+--------------------+-------------------------------------------------------------------------</font></div><div><font size="2"   >-----+-------------</font></div><div><font size="2"   >&nbsp;public | ft_customer_reviews_102037 | file_server_102037 | (filename 'pg_foreign_file/cached/ft_customer_reviews_102037', format 'c</font></div><div><font size="2"   >sv') |&nbsp;</font></div><div><font size="2"   >&nbsp;public | ft_customer_reviews_102039 | file_server_102039 | (filename '/home/citusdb/customer_reviews_1999.csv', format 'csv') &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div><br></div><div># 查看拷贝信息, 在worker03节点'<span style="line-height: 22px;"   >pg_foreign_file/cached/ft_customer_reviews_102039'</span><span style="line-height: 22px;"   >.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \q</font></div><div><font size="2"   >citusdb@db-172-16-3-150-&gt; psql -h 1.1.1.2 -p 9903 -U digoal digoal</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# \det+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of foreign tables</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; Server &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FDW Options &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+----------------------------+--------------------+-------------------------------------------------------------------------</font></div><div><font size="2"   >-----+-------------</font></div><div><font size="2"   >&nbsp;public | ft_customer_reviews_102039 | file_server_102039 | (filename 'pg_foreign_file/cached/ft_customer_reviews_102039', format 'c</font></div><div><font size="2"   >sv') |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div><br></div><div>【小结】</div><div>1. 为什么CitusDB的\STAGE导入数据需要从worker节点连接到master节点来操作, 这个操作的意思就是此时的导入正是这个worker节点的数据.</div><div>2. \STAGE的图例如下 :&nbsp;</div><div><div><img title="CitusDB, PostgreSQLs Use Hadoop Distribute Query - 2 : CitusDB file_fdw install - 德哥@Digoal - The Heart,The World."   alt="CitusDB, PostgreSQLs Use Hadoop Distribute Query - 2 : CitusDB file_fdw install - 德哥@Digoal - The Heart,The World."   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/n7YTsMwD4k28oN99zak_Ww==/6597280872889464276.png"   ></div>3. 目前CitusDB file_fdw版本为beta版本, 相比原始的file_fdw有几个需要注意的地方 :&nbsp;</div><div><div>This module makes three changes to the original file_fdw that are still in Beta form.&nbsp;</div><div>First, we add another option to file_fdw to accept hdfs_directory_path as an argument. Users creating the distributed foreign table on the master node use this option to associate the table with an HDFS directory path.</div><div>新增了1个option,&nbsp;<span style="line-height: 22px;"   >hdfs_directory_path, 用来配置HDFS的目录.</span></div><div>Second, file_fdw skips a malformed line and emits a debug message instead of erroring out on it. This is similar to Apache Hive's behavior, but isn't safe. In the future, we may error out if the number of malformed lines exceeds a certain threshold.</div><div>目前如果遇到非法的行信息, 目前不会中断数据读取, 而是发出DEBUG信息. 以后可能会修改为非法数据达到一定阈值则中断读取.</div><div>Third, CitusDB currently associates one HDFS block with one foreign table, and executes the entire SQL query locally on that block. If bytes for the last record in an HDFS block spill over to the next one, we currently don't fetch those bytes and instead skip the last record. This is a limitation we intend to fix in CitusDB 2.1.</div></div><div>最后需要注意的是, 如果使用HDFS的话, 每个BLOCK对应1个外部表, 如果1条记录跨BLOCK存储了, 那么这条记录将会被忽略掉, 需要在下一个版本改进.</div><div><br></div>【参考】<div>1.&nbsp;<a target="_blank" rel="nofollow" href="https://github.com/citusdata/file_fdw"   >https://github.com/citusdata/file_fdw</a></div><div>2.&nbsp;<a target="_blank" rel="nofollow" href="http://www.citusdata.com/docs/sql-on-hadoop"   >http://www.citusdata.com/docs/sql-on-hadoop</a></div><div>3.&nbsp;<a target="_blank" rel="nofollow" href="http://citusdata.com/docs/foreign-data"   >http://citusdata.com/docs/foreign-data</a></div><div>4.&nbsp;<a target="_blank" rel="nofollow" href="http://citusdata.com/blog/50-postgresql-foreign-file-performance"   >http://citusdata.com/blog/50-postgresql-foreign-file-performance</a><br>5.&nbsp;<wbr><a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://homepages.cwi.nl/~idreos/NoDBsigmod2012.pdf"   >http://homepages.cwi.nl/~idreos/NoDBsigmod2012.pdf</a></div></div>
	</div>
</div>
</body>
</html>