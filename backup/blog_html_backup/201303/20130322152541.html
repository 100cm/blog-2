<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">CitusDB, PostgreSQLs Use Hadoop Distribute Query - 4 : Query Trace 2</h2>
	<h5 id="">2013-03-22 15:25:41&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201322232541166/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >接上一篇 :&nbsp;</span></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201322205436514/"   >http://blog.163.com/digoal@126/blog/static/163877040201322205436514/</a></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >4. # 大表和小表的关联查询</span></div><div style="line-height: 22px;"   >大表指的是shard数目大于等于large_table_shard_count的表</div><div style="line-height: 22px;"   >CitusDB 2.0还不允许大表和大表的关联查询.</div><div style="line-height: 22px;"   >小表指的是<span style="line-height: 22px;"   >shard数目小于large_table_shard_count的表, 小表和大表JOIN时, 小表的数据会先通过</span><span style="line-height: 19px; font-family: monospace; font-size: small; white-space: pre;"   >worker_fetch_regular_table</span><span style="line-height: 22px;"   >拷贝到各个相关的worker节点.&nbsp;</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >然后在worker本地进行JOIN, 完了把结果COPY到master节点, master节点再对COPY过来的临时表进行结果合并.</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >postgres=# show large_table_shard_count;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;large_table_shard_count&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;4</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >postgres=# select * from pg_dist_shard;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;logicalrelid | &nbsp; &nbsp; &nbsp; shardid &nbsp; &nbsp; &nbsp; &nbsp;| shardstorage | shardalias | shardminvalue | shardmaxvalue&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >--------------+----------------------+--------------+------------+---------------+---------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 16403 | -1221512698612183530 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1999-01-01 &nbsp; &nbsp;| 1999-05-13</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 16403 | &nbsp;2698407172708592541 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1999-05-13 &nbsp; &nbsp;| 1999-09-11</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 16403 | &nbsp; 631600631725577683 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1998-09-06 &nbsp; &nbsp;| 1998-12-31</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 16403 | -2048097437225231483 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1999-09-11 &nbsp; &nbsp;| 1999-12-31</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 16403 | &nbsp;3598423008504059948 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1970-12-30 &nbsp; &nbsp;| 1998-09-06</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(5 rows)</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ># 新建一个小表</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >postgres=# CREATE TABLE customer_reviews_small &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; customer_id TEXT not null,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; review_date DATE not null,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; review_rating INTEGER not null,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; review_votes INTEGER,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; review_helpful_votes INTEGER,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; product_id CHAR(10) not null,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; product_title TEXT not null,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; product_sales_rank BIGINT,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; product_group TEXT,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; product_category TEXT,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; product_subcategory TEXT,</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; similar_product_ids CHAR(10)[]</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DISTRIBUTE BY APPEND (review_date);</font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >postgres=# CREATE INDEX customer_id_index ON customer_reviews_small (customer_id);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CREATE INDEX</font></div></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ># 从任一worker节点连到master节点, 导入数据. (注意文件要放在worker节点, 这个和COPY是不一样的, COPY要求文件是和数据库服务器在一起的, 以为它调用的是服务端的file接口)</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >[root@db-172-16-3-150 Documentation]# scp /data06/customer_reviews_1998.csv 172.16.3.33:/home/citusdb/<span style="line-height: 22px;"   >&nbsp;&nbsp;</span></font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >citusdb@db-172-16-3-33-&gt; psql -h 172.16.3.150 -p 9900 -U digoal postgres</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >psql (9.2.1)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Type "help" for help.</font></div></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >postgres=# \STAGE customer_reviews_small FROM '/home/citusdb/customer_reviews_1998.csv' (FORMAT CSV)</font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >postgres=# select * from pg_dist_shard;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;logicalrelid | &nbsp; &nbsp; &nbsp; shardid &nbsp; &nbsp; &nbsp; &nbsp;| shardstorage | shardalias | shardminvalue | shardmaxvalue&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >--------------+----------------------+--------------+------------+---------------+---------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 16403 | -1221512698612183530 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1999-01-01 &nbsp; &nbsp;| 1999-05-13</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 16403 | &nbsp;2698407172708592541 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1999-05-13 &nbsp; &nbsp;| 1999-09-11</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 16403 | &nbsp; 631600631725577683 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1998-09-06 &nbsp; &nbsp;| 1998-12-31</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 16403 | -2048097437225231483 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1999-09-11 &nbsp; &nbsp;| 1999-12-31</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 16403 | &nbsp;3598423008504059948 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1970-12-30 &nbsp; &nbsp;| 1998-09-06</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 16604 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 102017 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1970-12-30 &nbsp; &nbsp;| 1998-12-31</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(6 rows)</font></div></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >现在有两个distributed表了, 一个有5个shard, 另一个只有1个shard.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >postgres=# select * from customer_reviews t1, customer_reviews_small t2 where t1.customer_id=t2.customer_id limit 1;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; customer_id &nbsp;| review_date | review_rating | review_votes | review_helpful_votes | product_id | &nbsp; &nbsp; &nbsp;product_title &nbsp; &nbsp; &nbsp;| product_</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >sales_rank | product_group | product_category | product_subcategory | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; similar_product_ids &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;cu</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >stomer_id &nbsp;| review_date | review_rating | review_votes | review_helpful_votes | product_id | &nbsp; &nbsp; &nbsp;product_title &nbsp; &nbsp; &nbsp;| product_sale</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >s_rank | product_group | product_category | product_subcategory | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; similar_product_ids &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >---------------+-------------+---------------+--------------+----------------------+------------+-------------------------+---------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-----------+---------------+------------------+---------------------+----------------------------------------------------------+----</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-----------+-------------+---------------+--------------+----------------------+------------+-------------------------+-------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-------+---------------+------------------+---------------------+----------------------------------------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;AQV87I9Y4CIQF | 1998-09-06 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 56 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 55 | 1561580368 | Building for a Lifetime | &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; 215662 | Book &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Home &amp; Garden &nbsp; &nbsp;| Home Design &nbsp; &nbsp; &nbsp; &nbsp; | {1589230612,1881955656,0140258094,1931498113,0070171513} | AQV</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >87I9Y4CIQF | 1998-09-06 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 56 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 55 | 1561580368 | Building for a Lifetime | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >215662 | Book &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Home &amp; Garden &nbsp; &nbsp;| Home Design &nbsp; &nbsp; &nbsp; &nbsp; | {1589230612,1881955656,0140258094,1931498113,0070171513}</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >主节点日志</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >2013-03-22 15:09:19.538 CST,"digoal","postgres",18621,"172.16.3.33:41011",514c0239.48bd,24,"idle",2013-03-22 15:03:21 CST,3/401,0,LOG,00000,"statement: select * from customer_reviews t1, customer_reviews_small t2 where t1.customer_id=t2.customer_id limit 1;",,,,,,,,"exec_simple_query, postgres.c:969","psql"</font></p></pre></div><div style="line-height: 22px;"   ># 33节点日志, 其中3个hdfs中的外部表通过worker_fetch_foreign_file取到数据库中, 小表customer_reviews_small_102017这通过worker_fetch_regular_table获取到数据库中, 注意日志中记录了3个会话的信息, hdfs是三个表, 获取三次是可以理解的. 但是小表其实是在worker节点里面的, 从pg_dist_shard_placement是能够验证的, 为什么也fetch了3次呢? 原因是3个会话, 并行操作. 从执行时间来看分别消耗了300毫秒.</div><div style="line-height: 22px;"   >不过函数的源码看不到, 不知道有没有判断不需要COPY的情况. 否则小表的处理开销还是非常大的.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >2013-03-22 15:13:42.079 CST,"postgres","postgres",18245,"172.16.3.150:62163",514c04a5.4745,3,"idle",2013-03-22 15:13:41 CST,2/701,0,LOG,00000,"statement: SELECT worker_fetch_foreign_file('customer_reviews_631600631725577683', 34190254, '{db-172-16-3-40.sky-mobi.com,db-172-16-3-39.sky-mobi.com,db-172-16-3-33.sky-mobi.com}', '{9900,9900,9900}')",,,,,,,,"exec_simple_query, postgres.c:969",""<br style="line-height: 19px;"   >2013-03-22 15:13:42.080 CST,"postgres","postgres",18246,"172.16.3.150:62165",514c04a5.4746,3,"idle",2013-03-22 15:13:41 CST,3/162,0,LOG,00000,"statement: SELECT worker_fetch_foreign_file('customer_reviews_3598423008504059948', 67108864, '{db-172-16-3-40.sky-mobi.com,db-172-16-3-39.sky-mobi.com,db-172-16-3-33.sky-mobi.com}', '{9900,9900,9900}')",,,,,,,,"exec_simple_query, postgres.c:969",""<br style="line-height: 19px;"   >2013-03-22 15:13:42.080 CST,"postgres","postgres",18247,"172.16.3.150:62167",514c04a5.4747,3,"idle",2013-03-22 15:13:41 CST,4/74,0,LOG,00000,"statement: SELECT worker_fetch_foreign_file('customer_reviews_17225231375097368086', 67108864, '{db-172-16-3-40.sky-mobi.com,db-172-16-3-39.sky-mobi.com,db-172-16-3-33.sky-mobi.com}', '{9900,9900,9900}')",,,,,,,,"exec_simple_query, postgres.c:969",""<br style="line-height: 19px;"   >2013-03-22 15:13:42.379 CST,"postgres","postgres",18245,"172.16.3.150:62163",514c04a5.4745,4,"idle",2013-03-22 15:13:41 CST,2/702,0,LOG,00000,"statement: SELECT worker_fetch_regular_table('customer_reviews_small_102017', 145932288, '{db-172-16-3-39.sky-mobi.com,db-172-16-3-33.sky-mobi.com}', '{9900,9900}')",,,,,,,,"exec_simple_query, postgres.c:969",""<br style="line-height: 19px;"   >2013-03-22 15:13:42.379 CST,"postgres","postgres",18246,"172.16.3.150:62165",514c04a5.4746,4,"idle",2013-03-22 15:13:41 CST,3/163,0,LOG,00000,"statement: SELECT worker_fetch_regular_table('customer_reviews_small_102017', 145932288, '{db-172-16-3-39.sky-mobi.com,db-172-16-3-33.sky-mobi.com}', '{9900,9900}')",,,,,,,,"exec_simple_query, postgres.c:969",""<br style="line-height: 19px;"   >2013-03-22 15:13:42.379 CST,"postgres","postgres",18247,"172.16.3.150:62167",514c04a5.4747,4,"idle",2013-03-22 15:13:41 CST,4/75,0,LOG,00000,"statement: SELECT worker_fetch_regular_table('customer_reviews_small_102017', 145932288, '{db-172-16-3-39.sky-mobi.com,db-172-16-3-33.sky-mobi.com}', '{9900,9900}')",,,,,,,,"exec_simple_query, postgres.c:969",""<br style="line-height: 19px;"   >2013-03-22 15:13:42.679 CST,"postgres","postgres",18245,"172.16.3.150:62163",514c04a5.4745,5,"idle",2013-03-22 15:13:41 CST,2/703,0,LOG,00000,"statement: COPY (SELECT t1.customer_id, t1.review_date, t1.review_rating, t1.review_votes, t1.review_helpful_votes, t1.product_id, t1.product_title, t1.product_sales_rank, t1.product_group, t1.product_category, t1.product_subcategory, t1.similar_product_ids, t2.customer_id, t2.review_date, t2.review_rating, t2.review_votes, t2.review_helpful_votes, t2.product_id, t2.product_title, t2.product_sales_rank, t2.product_group, t2.product_category, t2.product_subcategory, t2.similar_product_ids FROM customer_reviews_631600631725577683 t1, customer_reviews_small_102017 t2 WHERE (t1.customer_id = t2.customer_id) LIMIT 1::bigint) TO STDOUT",,,,,,,,"exec_simple_query, postgres.c:969",""<br style="line-height: 19px;"   >2013-03-22 15:13:42.679 CST,"postgres","postgres",18247,"172.16.3.150:62167",514c04a5.4747,5,"idle",2013-03-22 15:13:41 CST,4/76,0,LOG,00000,"statement: COPY (SELECT t1.customer_id, t1.review_date, t1.review_rating, t1.review_votes, t1.review_helpful_votes, t1.product_id, t1.product_title, t1.product_sales_rank, t1.product_group, t1.product_category, t1.product_subcategory, t1.similar_product_ids, t2.customer_id, t2.review_date, t2.review_rating, t2.review_votes, t2.review_helpful_votes, t2.product_id, t2.product_title, t2.product_sales_rank, t2.product_group, t2.product_category, t2.product_subcategory, t2.similar_product_ids FROM customer_reviews_17225231375097368086 t1, customer_reviews_small_102017 t2 WHERE (t1.customer_id = t2.customer_id) LIMIT 1::bigint) TO STDOUT",,,,,,,,"exec_simple_query, postgres.c:969",""<br style="line-height: 19px;"   >2013-03-22 15:13:42.680 CST,"postgres","postgres",18246,"172.16.3.150:62165",514c04a5.4746,5,"idle",2013-03-22 15:13:41 CST,3/164,0,LOG,00000,"statement: COPY (SELECT t1.customer_id, t1.review_date, t1.review_rating, t1.review_votes, t1.review_helpful_votes, t1.product_id, t1.product_title, t1.product_sales_rank, t1.product_group, t1.product_category, t1.product_subcategory, t1.similar_product_ids, t2.customer_id, t2.review_date, t2.review_rating, t2.review_votes, t2.review_helpful_votes, t2.product_id, t2.product_title, t2.product_sales_rank, t2.product_group, t2.product_category, t2.product_subcategory, t2.similar_product_ids FROM customer_reviews_3598423008504059948 t1, customer_reviews_small_102017 t2 WHERE (t1.customer_id = t2.customer_id) LIMIT 1::bigint) TO STDOUT",,,,,,,,"exec_simple_query, postgres.c:969",""</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ># 39节点日志</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >2013-03-22 15:13:42.175 CST,"postgres","postgres",9582,"172.16.3.150:61134",514c04a5.256e,3,"idle",2013-03-22 15:13:41 CST,2/751,0,LOG,00000,"statement: SELECT worker_fetch_foreign_file('customer_reviews_16398646636484320133', 64029428, '{db-172-16-3-40.sky-mobi.com,db-172-16-3-39.sky-mobi.com,db-172-16-3-33.sky-mobi.com}', '{9900,9900,9900}')",,,,,,,,"exec_simple_query, postgres.c:969",""<br style="line-height: 19px;"   >2013-03-22 15:13:42.175 CST,"postgres","postgres",9581,"172.16.3.150:61132",514c04a5.256d,3,"idle",2013-03-22 15:13:41 CST,3/92,0,LOG,00000,"statement: SELECT worker_fetch_foreign_file('customer_reviews_2698407172708592541', 67108864, '{db-172-16-3-40.sky-mobi.com,db-172-16-3-39.sky-mobi.com,db-172-16-3-33.sky-mobi.com}', '{9900,9900,9900}')",,,,,,,,"exec_simple_query, postgres.c:969",""<br style="line-height: 19px;"   >2013-03-22 15:13:42.475 CST,"postgres","postgres",9581,"172.16.3.150:61132",514c04a5.256d,4,"idle",2013-03-22 15:13:41 CST,3/93,0,LOG,00000,"statement: SELECT worker_fetch_regular_table('customer_reviews_small_102017', 145932288, '{db-172-16-3-39.sky-mobi.com,db-172-16-3-33.sky-mobi.com}', '{9900,9900}')",,,,,,,,"exec_simple_query, postgres.c:969",""<br style="line-height: 19px;"   >2013-03-22 15:13:42.475 CST,"postgres","postgres",9582,"172.16.3.150:61134",514c04a5.256e,4,"idle",2013-03-22 15:13:41 CST,2/752,0,LOG,00000,"statement: SELECT worker_fetch_regular_table('customer_reviews_small_102017', 145932288, '{db-172-16-3-39.sky-mobi.com,db-172-16-3-33.sky-mobi.com}', '{9900,9900}')",,,,,,,,"exec_simple_query, postgres.c:969",""<br style="line-height: 19px;"   >2013-03-22 15:13:42.775 CST,"postgres","postgres",9581,"172.16.3.150:61132",514c04a5.256d,5,"idle",2013-03-22 15:13:41 CST,3/94,0,LOG,00000,"statement: COPY (SELECT t1.customer_id, t1.review_date, t1.review_rating, t1.review_votes, t1.review_helpful_votes, t1.product_id, t1.product_title, t1.product_sales_rank, t1.product_group, t1.product_category, t1.product_subcategory, t1.similar_product_ids, t2.customer_id, t2.review_date, t2.review_rating, t2.review_votes, t2.review_helpful_votes, t2.product_id, t2.product_title, t2.product_sales_rank, t2.product_group, t2.product_category, t2.product_subcategory, t2.similar_product_ids FROM customer_reviews_2698407172708592541 t1, customer_reviews_small_102017 t2 WHERE (t1.customer_id = t2.customer_id) LIMIT 1::bigint) TO STDOUT",,,,,,,,"exec_simple_query, postgres.c:969",""<br style="line-height: 19px;"   >2013-03-22 15:13:42.775 CST,"postgres","postgres",9582,"172.16.3.150:61134",514c04a5.256e,5,"idle",2013-03-22 15:13:41 CST,2/753,0,LOG,00000,"statement: COPY (SELECT t1.customer_id, t1.review_date, t1.review_rating, t1.review_votes, t1.review_helpful_votes, t1.product_id, t1.product_title, t1.product_sales_rank, t1.product_group, t1.product_category, t1.product_subcategory, t1.similar_product_ids, t2.customer_id, t2.review_date, t2.review_rating, t2.review_votes, t2.review_helpful_votes, t2.product_id, t2.product_title, t2.product_sales_rank, t2.product_group, t2.product_category, t2.product_subcategory, t2.similar_product_ids FROM customer_reviews_16398646636484320133 t1, customer_reviews_small_102017 t2 WHERE (t1.customer_id = t2.customer_id) LIMIT 1::bigint) TO STDOUT",,,,,,,,"exec_simple_query, postgres.c:969",""</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ># 40节点日志</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >无</font></p></pre></div><div style="line-height: 22px;"   ># 拷贝数据的函数</div><div><pre class="prettyprint"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >postgres=# \df+ worker_fetch_regular_table</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of functions</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp;Schema &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Result data type | &nbsp; &nbsp; &nbsp; Argument data types &nbsp; &nbsp; &nbsp; | &nbsp;Type &nbsp;| Volatility | &nbsp;Owner &nbsp; | Lan</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >guage | &nbsp; &nbsp; &nbsp; &nbsp;Source code &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Description &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------+----------------------------+------------------+---------------------------------+--------+------------+----------+----</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------+----------------------------+-----------------------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;pg_catalog | worker_fetch_regular_table | void &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | text, bigint, text[], integer[] | normal | volatile &nbsp; | postgres | int</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ernal | worker_fetch_regular_table | fetch PostgreSQL table from remote node</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div><font size="2"   >postgres=# \df+ worker_fetch_foreign_file<br>                                                                                                    List of functions<br>   Schema   |           Name            | Result data type |       Argument data types       |  Type  | Volatility |  Owner   | Lang<br>uage |        Source code        |                    Description                     <br>------------+---------------------------+------------------+---------------------------------+--------+------------+----------+-----<br>-----+---------------------------+----------------------------------------------------<br> pg_catalog | worker_fetch_foreign_file | void             | text, bigint, text[], integer[] | normal | volatile   | postgres | inte<br>rnal | worker_fetch_foreign_file | fetch foreign file from remote node and apply file<br>(1 row)</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >5. # 小表和小表的关联查询</span></div><div style="line-height: 22px;"   >每次查询时将表的信息通过fetch拷贝到worker本地的临时表, 然后JOIN. 注意是每次查询, 单事物多次查询也会多次调用fetch.</div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >postgres=# set large_table_shard_count=6;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >SET</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >postgres=# select * from customer_reviews t1, customer_reviews_small t2 where t1.customer_id=t2.customer_id limit 1;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; customer_id &nbsp;| review_date | review_rating | review_votes | review_helpful_votes | product_id | &nbsp; &nbsp; &nbsp;product_title &nbsp; &nbsp; &nbsp;| product_</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >sales_rank | product_group | product_category | product_subcategory | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; similar_product_ids &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;cu</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >stomer_id &nbsp;| review_date | review_rating | review_votes | review_helpful_votes | product_id | &nbsp; &nbsp; &nbsp;product_title &nbsp; &nbsp; &nbsp;| product_sale</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >s_rank | product_group | product_category | product_subcategory | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; similar_product_ids &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >---------------+-------------+---------------+--------------+----------------------+------------+-------------------------+---------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-----------+---------------+------------------+---------------------+----------------------------------------------------------+----</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-----------+-------------+---------------+--------------+----------------------+------------+-------------------------+-------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-------+---------------+------------------+---------------------+----------------------------------------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;AQV87I9Y4CIQF | 1998-09-06 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 56 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 55 | 1561580368 | Building for a Lifetime | &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; 215662 | Book &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Home &amp; Garden &nbsp; &nbsp;| Home Design &nbsp; &nbsp; &nbsp; &nbsp; | {1589230612,1881955656,0140258094,1931498113,0070171513} | AQV</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >87I9Y4CIQF | 1998-09-06 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 56 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 55 | 1561580368 | Building for a Lifetime | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >215662 | Book &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Home &amp; Garden &nbsp; &nbsp;| Home Design &nbsp; &nbsp; &nbsp; &nbsp; | {1589230612,1881955656,0140258094,1931498113,0070171513}</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >33 日志</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >2013-03-22 15:18:36.843 CST,"postgres","postgres",18271,"172.16.3.150:33076",514c05cc.475f,3,"idle",2013-03-22 15:18:36 CST,2/719,0,LOG,00000,"statement: SELECT worker_fetch_foreign_file('customer_reviews_631600631725577683', 34190254, '{db-172-16-3-40.sky-mobi.com,db-172-16-3-39.sky-mobi.com,db-172-16-3-33.sky-mobi.com}', '{9900,9900,9900}')",,,,,,,,"exec_simple_query, postgres.c:969",""</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >2013-03-22 15:18:36.843 CST,"postgres","postgres",18272,"172.16.3.150:33078",514c05cc.4760,3,"idle",2013-03-22 15:18:36 CST,3/170,0,LOG,00000,"statement: SELECT worker_fetch_foreign_file('customer_reviews_3598423008504059948', 67108864, '{db-172-16-3-40.sky-mobi.com,db-172-16-3-39.sky-mobi.com,db-172-16-3-33.sky-mobi.com}', '{9900,9900,9900}')",,,,,,,,"exec_simple_query, postgres.c:969",""</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >2013-03-22 15:18:36.843 CST,"postgres","postgres",18273,"172.16.3.150:33080",514c05cc.4761,3,"idle",2013-03-22 15:18:36 CST,4/82,0,LOG,00000,"statement: SELECT worker_fetch_foreign_file('customer_reviews_17225231375097368086', 67108864, '{db-172-16-3-40.sky-mobi.com,db-172-16-3-39.sky-mobi.com,db-172-16-3-33.sky-mobi.com}', '{9900,9900,9900}')",,,,,,,,"exec_simple_query, postgres.c:969",""</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >2013-03-22 15:18:37.142 CST,"postgres","postgres",18271,"172.16.3.150:33076",514c05cc.475f,4,"idle",2013-03-22 15:18:36 CST,2/720,0,LOG,00000,"statement: SELECT worker_fetch_regular_table('customer_reviews_small_102017', 145932288, '{db-172-16-3-39.sky-mobi.com,db-172-16-3-33.sky-mobi.com}', '{9900,9900}')",,,,,,,,"exec_simple_query, postgres.c:969",""</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >2013-03-22 15:18:37.142 CST,"postgres","postgres",18273,"172.16.3.150:33080",514c05cc.4761,4,"idle",2013-03-22 15:18:36 CST,4/83,0,LOG,00000,"statement: SELECT worker_fetch_regular_table('customer_reviews_small_102017', 145932288, '{db-172-16-3-39.sky-mobi.com,db-172-16-3-33.sky-mobi.com}', '{9900,9900}')",,,,,,,,"exec_simple_query, postgres.c:969",""</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >2013-03-22 15:18:37.143 CST,"postgres","postgres",18272,"172.16.3.150:33078",514c05cc.4760,4,"idle",2013-03-22 15:18:36 CST,3/171,0,LOG,00000,"statement: SELECT worker_fetch_regular_table('customer_reviews_small_102017', 145932288, '{db-172-16-3-39.sky-mobi.com,db-172-16-3-33.sky-mobi.com}', '{9900,9900}')",,,,,,,,"exec_simple_query, postgres.c:969",""</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >40 日志</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >2013-03-22 15:18:36.926 CST,"postgres","postgres",9601,"172.16.3.150:59324",514c05cc.2581,3,"idle",2013-03-22 15:18:36 CST,2/769,0,LOG,00000,"statement: SELECT worker_fetch_foreign_file('customer_reviews_2698407172708592541', 67108864, '{db-172-16-3-40.sky-mobi.com,db-172-16-3-39.sky-mobi.com,db-172-16-3-33.sky-mobi.com}', '{9900,9900,9900}')",,,,,,,,"exec_simple_query, postgres.c:969",""</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >2013-03-22 15:18:36.926 CST,"postgres","postgres",9602,"172.16.3.150:59326",514c05cc.2582,3,"idle",2013-03-22 15:18:36 CST,3/100,0,LOG,00000,"statement: SELECT worker_fetch_foreign_file('customer_reviews_16398646636484320133', 64029428, '{db-172-16-3-40.sky-mobi.com,db-172-16-3-39.sky-mobi.com,db-172-16-3-33.sky-mobi.com}', '{9900,9900,9900}')",,,,,,,,"exec_simple_query, postgres.c:969",""</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >2013-03-22 15:18:37.226 CST,"postgres","postgres",9601,"172.16.3.150:59324",514c05cc.2581,4,"idle",2013-03-22 15:18:36 CST,2/770,0,LOG,00000,"statement: SELECT worker_fetch_regular_table('customer_reviews_small_102017', 145932288, '{db-172-16-3-39.sky-mobi.com,db-172-16-3-33.sky-mobi.com}', '{9900,9900}')",,,,,,,,"exec_simple_query, postgres.c:969",""</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >2013-03-22 15:18:37.226 CST,"postgres","postgres",9602,"172.16.3.150:59326",514c05cc.2582,4,"idle",2013-03-22 15:18:36 CST,3/101,0,LOG,00000,"statement: SELECT worker_fetch_regular_table('customer_reviews_small_102017', 145932288, '{db-172-16-3-39.sky-mobi.com,db-172-16-3-33.sky-mobi.com}', '{9900,9900}')",,,,,,,,"exec_simple_query, postgres.c:969",""</font></div><p style="line-height: 22px;"   ></p></pre></div></span></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >6. # 查询中使用自定义函数</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >postgres=# create or replace function my_lower(i text) returns text as $$</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; return lower(i);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >$$ language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CREATE FUNCTION</font></div></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >postgres=# select avg(review_rating),my_lower(product_group) from customer_reviews group by my_lower(product_group);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; avg &nbsp; &nbsp; &nbsp; &nbsp; | my_lower&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >--------------------+----------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;2.0000000000000000 | ce</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;4.4846521282116104 | music</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;4.3278330075790599 | video</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;5.0000000000000000 | toy</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;4.0000000000000000 | software</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;4.2944774472673496 | book</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;4.2773476749740566 | dvd</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(7 rows)</font></div></div></pre></div><div style="line-height: 22px;"   >worker节点日志截取 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >2013-03-22 14:43:30.102 CST,"postgres","postgres",18082,"172.16.3.150:28810",514bfd91.46a2,3,"idle",2013-03-22 14:43:29 CST,2/625,0,LOG,00000,"statement: COPY (SELECT sum(review_rating) AS avg, count(*) AS avg, my_lower(product_group) AS my_lower FROM customer_reviews_631600631725577683 customer_reviews WHERE true GROUP BY my_lower(product_group)) TO STDOUT",,,,,,,,"exec_simple_query, postgres.c:969",""</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >2013-03-22 14:43:30.104 CST,"postgres","postgres",18084,"172.16.3.150:28814",514bfd91.46a4,3,"idle",2013-03-22 14:43:29 CST,4/64,0,LOG,00000,"statement: COPY (SELECT sum(review_rating) AS avg, count(*) AS avg, my_lower(product_group) AS my_lower FROM customer_reviews_17225231375097368086 customer_reviews WHERE true GROUP BY my_lower(product_group)) TO STDOUT",,,,,,,,"exec_simple_query, postgres.c:969",""</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >2013-03-22 14:43:30.104 CST,"postgres","postgres",18083,"172.16.3.150:28812",514bfd91.46a3,3,"idle",2013-03-22 14:43:29 CST,3/152,0,LOG,00000,"statement: COPY (SELECT sum(review_rating) AS avg, count(*) AS avg, my_lower(product_group) AS my_lower FROM customer_reviews_3598423008504059948 customer_reviews WHERE true GROUP BY my_lower(product_group)) TO STDOUT",,,,,,,,"exec_simple_query, postgres.c:969",""</font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >2013-03-22 14:43:30.084 CST,"postgres","postgres",9463,"172.16.3.150:55253",514bfd91.24f7,3,"idle",2013-03-22 14:43:29 CST,2/677,0,LOG,00000,"statement: COPY (SELECT sum(review_rating) AS avg, count(*) AS avg, my_lower(product_group) AS my_lower FROM customer_reviews_2698407172708592541 customer_reviews WHERE true GROUP BY my_lower(product_group)) TO STDOUT",,,,,,,,"exec_simple_query, postgres.c:969",""</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >2013-03-22 14:43:30.084 CST,"postgres","postgres",9464,"172.16.3.150:55255",514bfd91.24f8,3,"idle",2013-03-22 14:43:29 CST,3/82,0,LOG,00000,"statement: COPY (SELECT sum(review_rating) AS avg, count(*) AS avg, my_lower(product_group) AS my_lower FROM customer_reviews_16398646636484320133 customer_reviews WHERE true GROUP BY my_lower(product_group)) TO STDOUT",,,,,,,,"exec_simple_query, postgres.c:969",""</font></div></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br style="line-height: 22px;"   ></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >7. # 统计信息</span></div><div style="line-height: 22px;"   ># 外部表的统计信息收集需要在worker节点进行, 主节点执行会报错.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >postgres=# analyze verbose customer_reviews;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ERROR: &nbsp;58P01: could not stat file "": No such file or directory</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >LOCATION: &nbsp;fileAnalyzeForeignTable, file_fdw.c:781</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ># worker节点</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >postgres=# analyze verbose customer_reviews_16398646636484320133;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;analyzing "public.customer_reviews_16398646636484320133"</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;"customer_reviews_16398646636484320133": file contains 377161 rows; 30000 rows in sample</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ANALYZE</font></div></pre></div><div style="line-height: 22px;"   ><br></div><span style="line-height: 22px;"   >[参考]</span><div style="line-height: 22px;"   ><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >1.&nbsp;<a style="line-height: 22px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013219840831/"   >http://blog.163.com/digoal@126/blog/static/1638770402013219840831/</a></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >2.&nbsp;<a style="line-height: 22px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020132192011747/"   >http://blog.163.com/digoal@126/blog/static/16387704020132192011747/<br style="line-height: 25px;"   ></a><wbr style="line-height: 22px;"   ><span style="line-height: 22px;"   >3.&nbsp;</span><a style="line-height: 22px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020132189835346/"   >http://blog.163.com/digoal@126/blog/static/16387704020132189835346/</a></div><wbr style="line-height: 22px;"   ><div style="line-height: 22px;"   >4.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013221475935/"   >http://blog.163.com/digoal@126/blog/static/1638770402013221475935/</a></div></div><div style="line-height: 22px;"   >5. DISTRIBUTED参数详细介绍 :&nbsp;</div><div><pre class="prettyprint"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >postgres=# select * from pg_settings where name ='task_assignment_policy';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-[ RECORD 1 ]---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >name &nbsp; &nbsp; &nbsp; | task_assignment_policy</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >setting &nbsp; &nbsp;| greedy</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >unit &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >category &nbsp; | Distributed Database</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >short_desc | Sets the policy to use when assigning tasks to worker nodes.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >extra_desc | The master node assigns tasks to worker nodes based on shard locations. This configuration value specifies the policy to use when making these assignments. The greedy policy aims to evenly distribute tasks across worker nodes; and the round-robin policy assigns tasks to worker nodes in a round-robin fashion.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >context &nbsp; &nbsp;| user</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >vartype &nbsp; &nbsp;| enum</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >source &nbsp; &nbsp; | default</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >min_val &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >max_val &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >enumvals &nbsp; | {greedy,round-robin}</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >boot_val &nbsp; | greedy</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >reset_val &nbsp;| greedy</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >sourcefile |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >sourceline |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >postgres=# select * from pg_settings where category = 'Distributed Database';</font></div><div><font size="2"   ><span style="line-height: 19px;"   >-[ RECORD 1 ]-----------------------------------------------------------------------------------------------------------------------<br>------------------------------------------------------------------------------------------------------------------------------------<br>-------------------------------------------------------------------------<br>name       | large_table_shard_count<br>setting    | 4<br>unit       | <br>category   | Distributed Database<br>short_desc | The shard count threshold over which a table is considered large.<br>extra_desc | A distributed table is considered to be large if it has more shards than the value specified here. This largeness crite<br>ria is then used in picking a table join order during distributed query planning.<br>context    | user<br>vartype    | integer<br>source     | default<br>min_val    | 1<br>max_val    | 10000<br>enumvals   | <br>boot_val   | 4<br>reset_val  | 4<br>sourcefile | <br>sourceline | <br>-[ RECORD 2 ]-----------------------------------------------------------------------------------------------------------------------<br>------------------------------------------------------------------------------------------------------------------------------------<br>-------------------------------------------------------------------------<br>name       | limit_clause_row_fetch_count<br>setting    | -1<br>unit       | <br>category   | Distributed Database<br>short_desc | Number of rows to fetch per task for limit clause optimization<br>extra_desc | Select queries get partitioned and executed as smaller tasks. In some cases, select queries with limit clauses may need<br> to fetch all rows from each task to generate results. In those cases, and where an approximation would produce meaningful results, <br>this configuration value sets the number of rows to fetch from each task.<br>context    | user<br>vartype    | integer<br>source     | default<br>min_val    | -1<br>max_val    | 2147483647<br>enumvals   | <br>boot_val   | -1<br>reset_val  | -1<br>sourcefile | <br>sourceline | <br>-[ RECORD 3 ]-----------------------------------------------------------------------------------------------------------------------<br>------------------------------------------------------------------------------------------------------------------------------------<br>-------------------------------------------------------------------------<br>name       | max_running_tasks_per_node<br>setting    | 8<br>unit       | <br>category   | Distributed Database<br>short_desc | Sets the maximum number of tasks to run concurrently per node.<br>extra_desc | The task tracker process schedules and executes the tasks assigned to it as appropriate. This configuration value sets <br>the maximum number of tasks to execute concurrently on one node at any given time.<br>context    | sighup<br>vartype    | integer<br>source     | default<br>min_val    | 1<br>max_val    | 2147483647<br>enumvals   | <br>boot_val   | 8<br>reset_val  | 8<br>sourcefile | <br>sourceline | <br>-[ RECORD 4 ]-----------------------------------------------------------------------------------------------------------------------<br>------------------------------------------------------------------------------------------------------------------------------------<br>-------------------------------------------------------------------------<br>name       | max_tracked_tasks_per_node<br>setting    | 256<br>unit       | <br>category   | Distributed Database<br>short_desc | Sets the maximum number of tracked tasks per node.<br>extra_desc | The task tracker processes keeps all assigned tasks in a shared hash table, and schedules and executes these tasks as a<br>ppropriate. This configuration value limits the size of the hash table, and therefore the maximum number of tasks that can be tracke<br>d at any given time.<br>context    | postmaster<br>vartype    | integer<br>source     | default<br>min_val    | 8<br>max_val    | 2147483647<br>enumvals   | <br>boot_val   | 256<br>reset_val  | 256<br>sourcefile | <br>sourceline | <br>-[ RECORD 5 ]-----------------------------------------------------------------------------------------------------------------------<br>------------------------------------------------------------------------------------------------------------------------------------<br>-------------------------------------------------------------------------<br>name       | max_worker_nodes_tracked<br>setting    | 2048<br>unit       | <br>category   | Distributed Database<br>short_desc | Sets the maximum number of worker nodes that are tracked.<br>extra_desc | Worker nodes' network locations, their membership and health status are tracked in a shared hash table on the master no<br>de. This configuration value limits the size of the hash table, and consequently the maximum number of worker nodes that can be trac<br>ked.<br>context    | postmaster<br>vartype    | integer<br>source     | default<br>min_val    | 8<br>max_val    | 2147483647<br>enumvals   | <br>boot_val   | 2048<br>reset_val  | 2048<br>sourcefile | <br>sourceline | <br>-[ RECORD 6 ]-----------------------------------------------------------------------------------------------------------------------<br>------------------------------------------------------------------------------------------------------------------------------------<br>-------------------------------------------------------------------------<br>name       | partition_buffer_size<br>setting    | 8192<br>unit       | kB<br>category   | Distributed Database<br>short_desc | Sets the buffer size to use for partition operations.<br>extra_desc | Worker nodes allow for table data to be repartitioned into multiple text files, much like Hadoop's Map command. This co<br>nfiguration value sets the buffer size to use per partition operation. After the buffer fills up, we flush the repartitioned data in<br>to text files.<br>context    | user<br>vartype    | integer<br>source     | default<br>min_val    | 0<br>max_val    | 2147483647<br>enumvals   | <br>boot_val   | 8192<br>reset_val  | 8192<br>sourcefile | <br>sourceline | <br>-[ RECORD 7 ]-----------------------------------------------------------------------------------------------------------------------<br>------------------------------------------------------------------------------------------------------------------------------------<br>-------------------------------------------------------------------------<br>name       | remote_task_check_interval<br>setting    | 100<br>unit       | ms<br>category   | Distributed Database<br>short_desc | Sets the frequency at which we check job statuses.<br>extra_desc | The master node assigns tasks to workers nodes, and then regularly checks with them about each task's progress. This co<br>nfiguration value sets the time interval between two consequent checks.<br>context    | sighup<br>vartype    | integer<br>source     | default<br>min_val    | 10<br>max_val    | 100000<br>enumvals   | <br>boot_val   | 100<br>reset_val  | 100<br>sourcefile | <br>sourceline | <br>-[ RECORD 8 ]-----------------------------------------------------------------------------------------------------------------------<br>------------------------------------------------------------------------------------------------------------------------------------<br>-------------------------------------------------------------------------<br>name       | shard_max_size<br>setting    | 2097152<br>unit       | kB<br>category   | Distributed Database<br>short_desc | Sets the maximum size a shard will grow before it gets split.<br>extra_desc | Shards store table and file data. When the source file's size for one shard exceeds this configuration value, the datab<br>ase ensures that either a new shard gets created, or the current one gets split. Note that shards read this configuration value at s<br>harded table creation time, and later reuse the initially read value.<br>context    | user<br>vartype    | integer<br>source     | default<br>min_val    | 256<br>max_val    | 2147483647<br>enumvals   | <br>boot_val   | 2097152<br>reset_val  | 2097152<br>sourcefile | <br>sourceline | <br>-[ RECORD 9 ]-----------------------------------------------------------------------------------------------------------------------<br>------------------------------------------------------------------------------------------------------------------------------------<br>-------------------------------------------------------------------------<br>name       | shard_replication_factor<br>setting    | 2<br>unit       | <br>category   | Distributed Database<br>short_desc | Sets the replication factor for shards.<br>extra_desc | Shards are replicated across nodes according to this replication factor. Note that shards read this configuration value<br> at sharded table creation time, and later reuse the initially read value.<br>context    | user<br>vartype    | integer<br>source     | default<br>min_val    | 1<br>max_val    | 100<br>enumvals   | <br>boot_val   | 2<br>reset_val  | 2<br>sourcefile | <br>sourceline | <br>-[ RECORD 10 ]----------------------------------------------------------------------------------------------------------------------<br>------------------------------------------------------------------------------------------------------------------------------------<br>-------------------------------------------------------------------------<br>name       | task_assignment_policy<br>setting    | greedy<br>unit       | <br>category   | Distributed Database<br>short_desc | Sets the policy to use when assigning tasks to worker nodes.<br>extra_desc | The master node assigns tasks to worker nodes based on shard locations. This configuration value specifies the policy t<br>o use when making these assignments. The greedy policy aims to evenly distribute tasks across worker nodes; and the round-robin poli<br>cy assigns tasks to worker nodes in a round-robin fashion.<br>context    | user<br>vartype    | enum<br>source     | default<br>min_val    | <br>max_val    | <br>enumvals   | {greedy,round-robin}<br>boot_val   | greedy<br>reset_val  | greedy<br>sourcefile | <br>sourceline | <br>-[ RECORD 11 ]----------------------------------------------------------------------------------------------------------------------<br>------------------------------------------------------------------------------------------------------------------------------------<br>-------------------------------------------------------------------------<br>name       | task_tracker_active<br>setting    | off<br>unit       | <br>category   | Distributed Database<br>short_desc | Starts up the task tracker process.<br>extra_desc | The task tracker background process runs on every worker node, and manages the execution of tasks assigned to it. This <br>configuration entry activates the task tracker.<br>context    | postmaster<br>vartype    | bool<br>source     | default<br>min_val    | <br>max_val    | <br>enumvals   | <br>boot_val   | off<br>reset_val  | off<br>sourcefile | <br>sourceline | <br>-[ RECORD 12 ]----------------------------------------------------------------------------------------------------------------------<br>------------------------------------------------------------------------------------------------------------------------------------<br>-------------------------------------------------------------------------<br>name       | task_tracker_delay<br>setting    | 200<br>unit       | ms<br>category   | Distributed Database<br>short_desc | Task tracker sleep time between task management rounds.<br>extra_desc | The task tracker process wakes up regularly, walks over all tasks assigned to it, and schedules and executes these task<br>s. Then, the task tracker sleeps for a time period before walking over these tasks again. This configuration value determines the le<br>ngth of that sleeping period.<br>context    | sighup<br>vartype    | integer<br>source     | default<br>min_val    | 10<br>max_val    | 100000<br>enumvals   | <br>boot_val   | 200<br>reset_val  | 200<br>sourcefile | <br>sourceline | </span></font></div></pre></div><wbr></div>
	</div>
</div>
</body>
</html>