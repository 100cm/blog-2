<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">SQL tuning example(max speedup 2400 times) : use function index and use window function prevent subquery</h2>
	<h5 id="">2012-07-05 22:08:49&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012651054869/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>最近在一个业务系统上发现的慢查询 ， 虽然调用不频繁，但是还是忍不住优化了一下。</div><div>主要突出两点 ：&nbsp;</div><div>1. to_char 函数由于不是immutable的, 所以无法建立函数索引.&nbsp;</div><div>新建一个函数功能与to_char一致, 并设置为immutable, 因此调整SQL中的to_char部分改为新建的这个函数.</div><div>使用函数索引提升查询性能.</div><div><br></div><div>2. 在一个查询语句中使用了select distinct phonenum,cost,transactionid,spcode from tbl_digoal_201207 这样的子查询, 进行JOIN关联.</div><div>注意子查询是否可以被提升, 和from_collapse_limit 的参数配置有关, 提升后的关联表小于这个配置时, 可以提升.</div><div>详见</div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/runtime-config-query.html#RUNTIME-CONFIG-QUERY-OTHER"   >http://www.postgresql.org/docs/9.4/static/runtime-config-query.html#RUNTIME-CONFIG-QUERY-OTHER</a></div><div>在外层使用窗口函数把这个子查询消除掉, 这样就可以使用索引关联了. 提升2400倍.</div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION ts_to_char_immutable(i_time timestamp,i_format text)&nbsp;</font></div><div><font size="2"   >&nbsp; RETURNS text</font></div><div><font size="2"   >AS</font></div><div><font size="2"   >$BODY$</font></div><div><font size="2"   >&nbsp; &nbsp; select to_char($1, $2);</font></div><div><font size="2"   >$BODY$</font></div><div><font size="2"   >LANGUAGE sql</font></div><div><font size="2"   >IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create index CONCURRENTLY idx_app_digoal_201207_ts on tbl_digoal_201207 (substr(ts_to_char_immutable(motime,'yyyymmddhh24mi'),1,11)) tablespace tbs_digoal_idx;</font></div><div><font size="2"   >create index CONCURRENTLY idx_app_digoal_mr_201207_ts on tbl_digoal_mr_201207 (substr(ts_to_char_immutable(mrtime,'yyyymmddhh24mi'),1,11)) tablespace tbs_digoal_idx where status='DELIVRD';</font></div><p></p></pre></div><div><br></div><div>慢查询1优化 : 7513 毫秒 -&gt; 589 毫秒</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select t1.spcode,sum(t1.cost::numeric) as mosum,t2.provider,t2.provincecode,t2.city,max(substr(to_char(t1.motime,'yyyymmddhh24mi'),1,11)) as stattime &nbsp;</font></div><div><font size="2"   >from tbl_digoal_201207 t1</font></div><div><font size="2"   >left join tbl_mobile t2 &nbsp;</font></div><div><font size="2"   >on (substr(t1.phonenum,1,7)=t2.phonenum) &nbsp;</font></div><div><font size="2"   >where substr(to_char(t1.motime,'yyyymmddhh24mi'),1,11)='20120705182' &nbsp;</font></div><div><font size="2"   >group by t2.provider,t1.spcode,t2.provincecode,t2.city;</font></div><div><font size="2"   >7513 毫秒</font></div><div><font size="2"   >执行计划 :&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;HashAggregate &nbsp;(cost=136676.81..136719.75 rows=4294 width=25)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Hash Left Join &nbsp;(cost=8531.84..136203.23 rows=18943 width=25)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Hash Cond: (substr((t1.phonenum)::text, 1, 7) = (t2.phonenum)::text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on tbl_digoal_201207 t1 &nbsp;(cost=0.00..125445.11 rows=18943 width=26)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (substr(to_char(motime, 'yyyymmddhh24mi'::text), 1, 11) = '20120705182'::text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Hash &nbsp;(cost=4152.26..4152.26 rows=238526 width=19)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on tbl_mobile t2 &nbsp;(cost=0.00..4152.26 rows=238526 width=19)</font></div><div><font size="2"   >(7 rows)</font></div><p></p></pre></div><div><br></div><div>改为 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select t1.spcode,sum(t1.cost::numeric) as mosum,t2.provider,t2.provincecode,t2.city,max(substr(to_char(t1.motime,'yyyymmddhh24mi'),1,11)) as stattime &nbsp;</font></div><div><font size="2"   >from tbl_digoal_201207 t1&nbsp;</font></div><div><font size="2"   >left join tbl_mobile t2 &nbsp;</font></div><div><font size="2"   >on (substr(t1.phonenum,1,7)=t2.phonenum) &nbsp;</font></div><div><font size="2"   >where substr(ts_to_char_immutable(motime,'yyyymmddhh24mi'),1,11)='20120705182' &nbsp;</font></div><div><font size="2"   >group by t2.provider,t1.spcode,t2.provincecode,t2.city;</font></div><div><font size="2"   >589 毫秒</font></div><div><font size="2"   >执行计划 :&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;HashAggregate &nbsp;(cost=40631.74..40674.68 rows=4294 width=25)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Hash Left Join &nbsp;(cost=8830.10..40158.09 rows=18946 width=25)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Hash Cond: (substr((t1.phonenum)::text, 1, 7) = (t2.phonenum)::text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Heap Scan on tbl_digoal_201207 t1 &nbsp;(cost=298.26..29399.87 rows=18946 width=26)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Recheck Cond: (substr(ts_to_char_immutable(motime, 'yyyymmddhh24mi'::text), 1, 11) = '20120705182'::text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on idx_app_digoal_201207_ts &nbsp;(cost=0.00..293.52 rows=18946 width=0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (substr(ts_to_char_immutable(motime, 'yyyymmddhh24mi'::text), 1, 11) = '20120705182'::text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Hash &nbsp;(cost=4152.26..4152.26 rows=238526 width=19)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on tbl_mobile t2 &nbsp;(cost=0.00..4152.26 rows=238526 width=19)</font></div><div><font size="2"   >(9 rows)</font></div><p></p></pre></div><div><br></div><div><br></div><div>慢查询2优化 : 8305 毫秒 -&gt; 680 毫秒</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select t1.newreserve as reserve, t1.newtype as type, t1.spcode,count(t1.id) as mosum,t2.provider,t2.provincecode,t2.city, &nbsp;max(substr(to_char(t1.motime,'yyyymmddhh24mi'),1,11)) as stattime &nbsp;</font></div><div><font size="2"   >from&nbsp;</font></div><div><font size="2"   >(select (case when reserve='0' then '0' else '-1' &nbsp;end) &nbsp;newreserve, (case when type in('30','31') then 'wap' else 'sms' end) newtype, spcode,phonenum,id,motime from tbl_digoal_201207 where &nbsp;substr(to_char(motime,'yyyymmddhh24mi'),1,11)='20120705182') t1&nbsp;</font></div><div><font size="2"   >left join tbl_mobile t2 &nbsp;</font></div><div><font size="2"   >on (substr(t1.phonenum,1,7)=t2.phonenum) &nbsp;</font></div><div><font size="2"   >group by t2.provider,t2.provincecode,t1.spcode,newreserve,t2.city,newtype;</font></div><div><font size="2"   >8305 毫秒</font></div><div><font size="2"   >执行计划 :&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >-------------------------------------</font></div><div><font size="2"   >&nbsp;GroupAggregate &nbsp;(cost=138078.08..138978.06 rows=18947 width=34)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=138078.08..138125.45 rows=18947 width=34)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: t2.provider, t2.provincecode, tbl_digoal_201207.spcode, (CASE WHEN ((tbl_digoal_201207.reserve)::text = '</font></div><div><font size="2"   >0'::text) THEN '0'::text ELSE '-1'::text END), t2.city, (CASE WHEN ((tbl_digoal_201207.type)::text = ANY ('{30,31}'::text[])) TH</font></div><div><font size="2"   >EN 'wap'::text ELSE 'sms'::text END)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Hash Left Join &nbsp;(cost=8531.84..136359.43 rows=18947 width=34)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Hash Cond: (substr((tbl_digoal_201207.phonenum)::text, 1, 7) = (t2.phonenum)::text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on tbl_digoal_201207 &nbsp;(cost=0.00..125468.45 rows=18947 width=35)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (substr(to_char(motime, 'yyyymmddhh24mi'::text), 1, 11) = '20120705182'::text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Hash &nbsp;(cost=4152.26..4152.26 rows=238526 width=19)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on tbl_mobile t2 &nbsp;(cost=0.00..4152.26 rows=238526 width=19)</font></div><div><font size="2"   >(9 rows)</font></div><p></p></pre></div><div><br></div><div>改为 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select t1.newreserve as reserve, t1.newtype as type, t1.spcode,count(t1.id) as mosum,t2.provider,t2.provincecode,t2.city, &nbsp;max(substr(to_char(t1.motime,'yyyymmddhh24mi'),1,11)) as stattime &nbsp;</font></div><div><font size="2"   >from&nbsp;</font></div><div><font size="2"   >(select (case when reserve='0' then '0' else '-1' &nbsp;end) &nbsp;newreserve, (case when type in('30','31') then 'wap' else 'sms' end) newtype, spcode,phonenum,id,motime from tbl_digoal_201207 where &nbsp;substr(ts_to_char_immutable(motime,'yyyymmddhh24mi'),1,11)='20120705182') t1&nbsp;</font></div><div><font size="2"   >left join tbl_mobile t2</font></div><div><font size="2"   >on (substr(t1.phonenum,1,7)=t2.phonenum) &nbsp;</font></div><div><font size="2"   >group by t2.provider,t2.provincecode,t1.spcode,newreserve,t2.city,newtype;</font></div><div><font size="2"   >680 毫秒</font></div><div><font size="2"   >执行计划 :&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >-------------------------------------</font></div><div><font size="2"   >&nbsp;GroupAggregate &nbsp;(cost=42013.10..42913.13 rows=18948 width=34)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=42013.10..42060.47 rows=18948 width=34)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: t2.provider, t2.provincecode, tbl_digoal_201207.spcode, (CASE WHEN ((tbl_digoal_201207.reserve)::text = '</font></div><div><font size="2"   >0'::text) THEN '0'::text ELSE '-1'::text END), t2.city, (CASE WHEN ((tbl_digoal_201207.type)::text = ANY ('{30,31}'::text[])) TH</font></div><div><font size="2"   >EN 'wap'::text ELSE 'sms'::text END)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Hash Left Join &nbsp;(cost=8830.11..40294.37 rows=18948 width=34)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Hash Cond: (substr((tbl_digoal_201207.phonenum)::text, 1, 7) = (t2.phonenum)::text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Heap Scan on tbl_digoal_201207 &nbsp;(cost=298.28..29403.35 rows=18948 width=35)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Recheck Cond: (substr(ts_to_char_immutable(motime, 'yyyymmddhh24mi'::text), 1, 11) = '20120705182'::text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on idx_app_digoal_201207_ts &nbsp;(cost=0.00..293.54 rows=18948 width=0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (substr(ts_to_char_immutable(motime, 'yyyymmddhh24mi'::text), 1, 11) = '20120705182'::text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Hash &nbsp;(cost=4152.26..4152.26 rows=238526 width=19)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on tbl_mobile t2 &nbsp;(cost=0.00..4152.26 rows=238526 width=19)</font></div><div><font size="2"   >(11 rows)</font></div><p></p></pre></div><div><br></div><div><br></div><div>慢查询3优化 : 48453 毫秒 -&gt; 21 毫秒</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select a1.spcode,sum(a1.cost::numeric) as income,count(0) as itemcount,a2.provincecode,a2.city,a2.provider &nbsp;from &nbsp;</font></div><div><font size="2"   >( select t1.spcode,t1.phonenum,t2.cost from tbl_digoal_mr_201207 t1, &nbsp;</font></div><div><font size="2"   >&nbsp; (select distinct phonenum,cost,transactionid,spcode from tbl_digoal_201207) &nbsp;t2 &nbsp;</font></div><div><font size="2"   >&nbsp; where t1.status='DELIVRD' and &nbsp;</font></div><div><font size="2"   >&nbsp; substr(to_char(t1.mrtime,'yyyymmddhh24mi'),1,11)='20120705182' &nbsp;</font></div><div><font size="2"   >&nbsp; and t1.transactionid=t2.transactionid&nbsp;</font></div><div><font size="2"   >&nbsp; and t1.spcode=t2.spcode &nbsp;</font></div><div><font size="2"   >&nbsp; and t1.phonenum=t2.phonenum</font></div><div><font size="2"   >) a1&nbsp;</font></div><div><font size="2"   >left join tbl_mobile a2 &nbsp;</font></div><div><font size="2"   >on (substr(a1.phonenum,1,7)=a2.phonenum) &nbsp;</font></div><div><font size="2"   >group by a1.spcode,a2.provincecode,a2.city,a2.provider;</font></div><div><font size="2"   >48453 毫秒</font></div><div><font size="2"   >执行计划 :&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----------------------------------</font></div><div><font size="2"   >&nbsp;HashAggregate &nbsp;(cost=948791.42..948791.43 rows=1 width=17)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Nested Loop Left Join &nbsp;(cost=851962.34..948791.40 rows=1 width=17)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Merge Join &nbsp;(cost=851962.33..948790.60 rows=1 width=18)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Merge Cond: ((tbl_digoal_201207.phonenum)::text = (t1.phonenum)::text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Join Filter: (((t1.spcode)::text = (tbl_digoal_201207.spcode)::text) AND ((t1.transactionid)::text = (tbl_app_cha</font></div><div><font size="2"   >rge_201207.transactionid)::text))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Unique &nbsp;(cost=733221.17..780593.44 rows=3745199 width=37)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=733221.17..742695.63 rows=3789781 width=37)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: tbl_digoal_201207.phonenum, tbl_digoal_201207.cost, tbl_digoal_201207.transactionid</font></div><div><font size="2"   >, tbl_digoal_201207.spcode</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on tbl_digoal_201207 &nbsp;(cost=0.00..97057.81 rows=3789781 width=37)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=118741.16..118778.52 rows=14945 width=34)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: t1.phonenum</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on tbl_digoal_mr_201207 t1 &nbsp;(cost=0.00..117704.92 rows=14945 width=34)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (((status)::text = 'DELIVRD'::text) AND (substr(to_char(mrtime, 'yyyymmddhh24mi'::text), 1, 11) =</font></div><div><font size="2"   >&nbsp;'20120705182'::text))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using tbl_mobile_pkey on tbl_mobile a2 &nbsp;(cost=0.00..0.79 rows=1 width=19)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (substr((t1.phonenum)::text, 1, 7) = (phonenum)::text)</font></div><div><font size="2"   >(15 rows)</font></div><p></p></pre></div><div><br></div><div>改为 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select t3.spcode,sum(t3.cost::numeric) as income,count(0) as itemcount,a2.provincecode,a2.city,a2.provider from (</font></div><div><font size="2"   >select row_number() over (partition by t2.phonenum,t2.cost,t2.transactionid,t2.spcode) as rn,t1.spcode,t2.cost,t2.phonenum from &nbsp;</font></div><div><font size="2"   >&nbsp; tbl_digoal_mr_201207 t1 join&nbsp;</font></div><div><font size="2"   >&nbsp; tbl_digoal_201207 t2 &nbsp;</font></div><div><font size="2"   >&nbsp; on( t1.status='DELIVRD' and</font></div><div><font size="2"   >&nbsp; substr(ts_to_char_immutable(t1.mrtime,'yyyymmddhh24mi'),1,11)='20120705182' &nbsp;</font></div><div><font size="2"   >&nbsp; and t1.transactionid=t2.transactionid</font></div><div><font size="2"   >&nbsp; and t1.spcode=t2.spcode</font></div><div><font size="2"   >&nbsp; and t1.phonenum=t2.phonenum)</font></div><div><font size="2"   >&nbsp; ) as t3</font></div><div><font size="2"   >left join tbl_mobile a2</font></div><div><font size="2"   >on (substr(t3.phonenum,1,7)=a2.phonenum)&nbsp;</font></div><div><font size="2"   >where t3.rn=1    -- rn过滤需放在join 条件外面. 否则left join后不会过滤rn&lt;&gt;1的记录.</font></div><div><font size="2"   >group by t3.spcode,a2.provincecode,a2.city,a2.provider;</font></div><div><font size="2"   >21 毫秒</font></div><div><font size="2"   >执行计划 :&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------</font></div><div><font size="2"   > HashAggregate  (cost=1498171.75..1498171.76 rows=1 width=18)<br>   -&gt;  Nested Loop Left Join  (cost=1498168.28..1498171.73 rows=1 width=18)<br>         -&gt;  Subquery Scan on t3  (cost=1498168.28..1498168.32 rows=1 width=19)<br>               Filter: (t3.rn = 1)<br>               -&gt;  WindowAgg  (cost=1498168.28..1498168.31 rows=1 width=41)<br>                     -&gt;  Sort  (cost=1498168.28..1498168.28 rows=1 width=41)<br>                           Sort Key: t2.phonenum, t2.cost, t2.transactionid, t1.spcode<br>                           -&gt;  Nested Loop  (cost=0.25..1498168.27 rows=1 width=41)<br>                                 -&gt;  Index Scan using idx_digoal_mr_201206_ts on tbl_digoal_mr_201206 t1  (cost=0.25..3619.1<br>6 rows=84151 width=34)<br>                                       Index Cond: (substr(ts_to_char_immutable(mrtime, 'yyyymmddhh24mi'::text), 1, 11) = '201206010<br>00'::text)<br>                                 -&gt;  Index Scan using idx_mo_transactionid_201206 on tbl_digoal_201206 t2  (cost=0.00..17.75 row<br>s=1 width=38)<br>                                       Index Cond: ((transactionid)::text = (t1.transactionid)::text)<br>                                       Filter: (((t1.phonenum)::text = (phonenum)::text) AND ((t1.spcode)::text = (spcode)::text))<br>         -&gt;  Index Scan using tbl_mobile_pkey on tbl_mobile a2  (cost=0.00..3.40 rows=1 width=19)<br>               Index Cond: (substr((t3.phonenum)::text, 1, 7) = (phonenum)::text)</font></div><div><font size="2"   >(16 rows)</font></div><p></p></pre></div><div><br></div><div>慢查询4优化 : 1376 毫秒 -&gt; 2 毫秒</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select t1.spcode,t2.provider,t1.cost,t2.province,t2.city,t1.motime &nbsp;</font></div><div><font size="2"   >from tbl_digoal_201207 t1&nbsp;</font></div><div><font size="2"   >left join tbl_mobile t2 &nbsp;</font></div><div><font size="2"   >on (substr(t1.phonenum,1,7)=t2.phonenum) &nbsp;</font></div><div><font size="2"   >where t1.spcode = '500'</font></div><div><font size="2"   >and substr(to_char(t1.motime,'yyyymmddhh24mi'),1,11)='20120705182';</font></div><div><font size="2"   >1376 毫秒</font></div><div><font size="2"   >执行计划 :&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >-</font></div><div><font size="2"   >&nbsp;Nested Loop Left Join &nbsp;(cost=0.00..135167.58 rows=45 width=30)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on tbl_digoal_201207 t1 &nbsp;(cost=0.00..134969.30 rows=45 width=26)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (((spcode)::text = '500'::text) AND (substr(to_char(motime, 'yyyymmddhh24mi'::text), 1, 11) = '20120705182'::text))</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Index Scan using tbl_mobile_pkey on tbl_mobile t2 &nbsp;(cost=0.00..4.40 rows=1 width=24)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (substr((t1.phonenum)::text, 1, 7) = (phonenum)::text)</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div><div><br></div><div>改为 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select t1.spcode,t2.provider,t1.cost,t2.province,t2.city,t1.motime &nbsp;</font></div><div><font size="2"   >from tbl_digoal_201207 t1&nbsp;</font></div><div><font size="2"   >left join tbl_mobile t2 &nbsp;</font></div><div><font size="2"   >on (substr(t1.phonenum,1,7)=t2.phonenum) &nbsp;</font></div><div><font size="2"   >where t1.spcode = '500'</font></div><div><font size="2"   >and substr(ts_to_char_immutable(t1.motime,'yyyymmddhh24mi'),1,11)='20120705182';</font></div><div><font size="2"   >2 毫秒</font></div><div><font size="2"   >执行计划 :&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Nested Loop Left Join &nbsp;(cost=293.58..29649.95 rows=45 width=30)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Bitmap Heap Scan on tbl_digoal_201207 t1 &nbsp;(cost=293.58..29451.67 rows=45 width=26)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Recheck Cond: (substr(ts_to_char_immutable(motime, 'yyyymmddhh24mi'::text), 1, 11) = '20120705182'::text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: ((spcode)::text = '500'::text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on idx_app_digoal_201207_ts &nbsp;(cost=0.00..293.57 rows=18952 width=0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (substr(ts_to_char_immutable(motime, 'yyyymmddhh24mi'::text), 1, 11) = '20120705182'::text)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Index Scan using tbl_mobile_pkey on tbl_mobile t2 &nbsp;(cost=0.00..4.40 rows=1 width=24)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (substr((t1.phonenum)::text, 1, 7) = (phonenum)::text)</font></div><div><font size="2"   >(8 rows)</font></div><p></p></pre></div></div><div>【注意】</div><div>1. 添加完索引并修改SQL语句后如果执行计划还不对的, 需要使用强制计划. 如set enable_hashjoin=off; set enable_mergejoin=off;</div><div>但是这样将会影响所有新建的SESSION的默认参数.</div><div>有几种办法.&nbsp;</div><div>1. 在应用程序数据库驱动连接参数里面配置这两个选项。</div><div>2. 对于以上SQL关联的应用, 使用独立的用户, 设置这个用户的search_path以及以上两个参数.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >alter role test set&nbsp;<span style="line-height: 22px;"   >enable_hashjoin=off;</span></font></div><div><font size="2"   ><span style="line-height: 22px;"   >alter role test set&nbsp;</span><span style="line-height: 22px;"   >enable_mergejoin=off;</span></font></div><div><font size="2"   ><span style="line-height: 22px;"   >alter role test set&nbsp;</span>search_path="指定schema, public"<span style="line-height: 22px;"   >;</span></font></div><font size="2"   ><wbr>使用以下SQL可以查看到角色的特定配置.</font><div><font size="2"   >postgres=# select rolname,rolconfig from pg_roles;</font></div><p></p></pre></div><div>3. 配置数据库的默认选项. 语法如下.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ALTER DATABASE name SET configuration_parameter { TO | = } { value | DEFAULT }</font></div><div><font size="2"   >ALTER DATABASE name SET configuration_parameter FROM CURRENT</font></div><div><font size="2"   >ALTER DATABASE name RESET configuration_parameter</font></div><div><font size="2"   >ALTER DATABASE name RESET ALL;</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>