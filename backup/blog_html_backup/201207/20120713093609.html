<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 will allocate shared memory use mmap(), and reduce amount usage of System V shared memory</h2>
	<h5 id="">2012-07-13 9:36:09&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201261385927488/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL master 分支6月28号提交的commit中， 有一个是关于修改内存指派的，在其他分支中没有这个commit，也就是说这个特性要等到9.3了。</div><div>在以往的版本中，数据库参数文件postgresql.conf里面有一个配置shared_buffers，是指分配的共享内存大小，配置它如果超出了内核现在，数据库将无法启动，也就是说这个参数的配置还需要同时配置内核限制(kernel.shmmax)，否则将会报错。</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 zzz]# sysctl -w kernel.shmmax=128000000</font></div><div><font size="2"  >kernel.shmmax = 128000000</font></div><p></p></pre></div><div>-- 将kernel.shmmax 设置为128MB .</div><div>-- 启动PostgreSQL 9.2, 如果shared_buffers大于128MB将报错. 启动失败.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg92@db-172-16-3-150-&gt; FATAL: &nbsp;could not create shared memory segment: Invalid argument</font></div><div><font size="2"  >DETAIL: &nbsp;Failed system call was shmget(key=1920001, size=297934848, 03600).</font></div><div><font size="2"  >HINT: &nbsp;This error usually means that PostgreSQL's request for a shared memory segment exceeded your kernel's SHMMAX parameter. &nbsp;You can either reduce the request size or reconfigure the kernel with larger SHMMAX. &nbsp;To reduce the request size (currently 297934848 bytes), reduce PostgreSQL's shared memory usage, perhaps by reducing shared_buffers or max_connections.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; If the request size is already small, it's possible that it is less than your kernel's SHMMIN parameter, in which case raising the request size or reconfiguring SHMMIN is called for.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; The PostgreSQL documentation contains more information about shared memory configuration.</font></div><p></p></pre></div><div><br></div><div>启动PostgreSQL 9.3 (注意需要6月28号以后的源码)<span style="line-height: 22px;"  >, 如果shared_buffers大于128MB不会报错. 启动成功.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg93@db-172-16-3-150-&gt; pg_ctl start -o '-c shared_buffers=256MB'</font></div><div><font size="2"  >server starting</font></div><div><font size="2"  >pg93@db-172-16-3-150-&gt; LOG: &nbsp;database system was shut down at 2012-07-13 09:25:04 CST</font></div><div><font size="2"  >LOG: &nbsp;autovacuum launcher started</font></div><div><font size="2"  >LOG: &nbsp;database system is ready to accept connections</font></div><p></p></pre></div><div>甚至可以使用更大的shared_buffers</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >pg93@db-172-16-3-150-&gt; pg_ctl start -o '-c shared_buffers=10240MB'</font></div><div><font size="2"  >server starting</font></div><div><font size="2"  >pg93@db-172-16-3-150-&gt; LOG: &nbsp;database system was shut down at 2012-07-13 09:35:04 CST</font></div><div><font size="2"  >LOG: &nbsp;autovacuum launcher started</font></div><div><font size="2"  >LOG: &nbsp;database system is ready to accept connections</font></div></div><div><div><font size="2"  >pg93@db-172-16-3-150-&gt; psql -h 127.0.0.1 postgres postgres</font></div><div><font size="2"  >Password for user postgres:&nbsp;</font></div><div><font size="2"  >psql (9.3devel)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# show shared_buffers;</font></div><div><font size="2"  >&nbsp;shared_buffers&nbsp;</font></div><div><font size="2"  >----------------</font></div><div><font size="2"  >&nbsp;10GB</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>代码部分的更新详见 :&nbsp;</div><div><a rel="nofollow" href="https://github.com/postgres/postgres/commit/b0fc0df9364d2d2d17c0162cf3b8b59f6cb09f67"  >https://github.com/postgres/postgres/commit/b0fc0df9364d2d2d17c0162cf3b8b59f6cb09f67</a> </div><div><br></div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >/*</font></div><div><font size="2"  >&nbsp;* PGSharedMemoryCreate</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* Create a shared memory segment of the given size and initialize its</font></div><div><font size="2"  >&nbsp;* standard header. &nbsp;Also, register an on_shmem_exit callback to release</font></div><div><font size="2"  >&nbsp;* the storage.</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* Dead Postgres segments are recycled if found, but we do not fail upon</font></div><div><font size="2"  >&nbsp;* collision with non-Postgres shmem segments. &nbsp;The idea here is to detect and</font></div><div><font size="2"  >&nbsp;* re-use keys that may have been assigned by a crashed postmaster or backend.</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* makePrivate means to always create a new segment, rather than attach to</font></div><div><font size="2"  >&nbsp;* or recycle any existing segment.</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* The port number is passed for possible use as a key (for SysV, we use</font></div><div><font size="2"  >&nbsp;* it to generate the starting shmem key). &nbsp; &nbsp; &nbsp;In a standalone backend,</font></div><div><font size="2"  >&nbsp;* zero will be passed.</font></div><div><font size="2"  >&nbsp;*/</font></div></div><div><font size="2"  >.....略</font></div><div><div><font size="2"  >/*<span> </span></font></div><div><font size="2"  >&nbsp;* As of PostgreSQL 9.3, we normally allocate only a very small amount of</font></div><div><font size="2"  >&nbsp;* System V shared memory, and only for the purposes of providing an</font></div><div><font size="2"  >&nbsp;* interlock to protect the data directory. &nbsp;The real shared memory block</font></div><div><font size="2"  >&nbsp;* is allocated using mmap(). &nbsp;This works around the problem that many</font></div><div><font size="2"  >&nbsp;* systems have very low limits on the amount of System V shared memory</font></div><div><font size="2"  >&nbsp;* that can be allocated. &nbsp;Even a limit of a few megabytes will be enough</font></div><div><font size="2"  >&nbsp;* to run many copies of PostgreSQL without needing to adjust system</font></div><div><font size="2"  >&nbsp;* settings.</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* However, we disable this logic in the EXEC_BACKEND case, and fall back</font></div><div><font size="2"  >&nbsp;* to the old method of allocating the entire segment using System V shared</font></div><div><font size="2"  >&nbsp;* memory, because there's no way to attach an mmap'd segment to a process</font></div><div><font size="2"  >&nbsp;* after exec(). &nbsp;Since EXEC_BACKEND is intended only for developer use,</font></div><div><font size="2"  >&nbsp;* this shouldn't be a big problem.</font></div><div><font size="2"  >&nbsp;*/</font></div></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>