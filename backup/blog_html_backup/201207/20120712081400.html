<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 ADD atomic array_replace and array_remove element value(s) from ARRAY</h2>
	<h5 id="">2012-07-12 8:14:00&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201261273149437/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">前段时间一位开发的同事问我，ARRAY类型有没有原子的替换和删除ARRAY元素的操作，用于好友列表(array类型)的更新，删除好友用得比较多。替换操作可能用得比较少。添加好友的话现在的PostgreSQL就已经支持原子操作了。&nbsp;<div>例如 ：&nbsp;<div>ARRAY[1,2,3,4,5]</div><div>要去掉一个或几个元素, 2,3</div><div>变成ARRAY[1,4,5]</div><div>在几小时以前，要实现这个原子的操作, 所有并发的进程必须使用for update的方式取数据, 可以用以下方法。&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >begin;</font></div><div><font size="2"   >select column_array from table where pk_id=?&nbsp;for update;  -- 这一步是防止其他进程对这条记录进行读取和修改。(这也是用BEGIN;COMMIT;的原因)</font></div><div><font size="2"   >-- 程序对column_array字段进行修改后, 修改pk_id记录的值.锁时间长短和程序处理时间和网络交互时间有关.</font></div><div><font size="2"   >update table set column_array=ARRAY[1,4,5] where pk_id=?</font></div><div><font size="2"   >commit;</font></div><p></p></pre></div><div>了解PostgreSQL的朋友一定知道, BEGIN;COMMIT; 比autocommit的开销大一些, 能不用就尽量不用。(具体为什么可以去参考一下src/backend/access/transam)</div><div>对于这种操作如果能有ARRAY类型的原子操作，就不需要锁记录了，autocommit即可。</div><div>就在几个小时前,TOM LANE提交了这个功能 .&nbsp;</div><div>允许对ARRAY类型进行元素的替换和移除操作，在此之前，ARRAY类型加元素是有函数和操作符的原子操作。但是没有替换元素和删除元素的原子操作。</div><div>添加这两个函数后，ARRAY的功能又更加强大了。</div><div>下面来试一下这个新功能 :&nbsp;</div><div><span style="line-height: 22px;"   >安装详细步骤略，有兴趣的朋友参考我以前的BLOG，有很多关于安装和配置的过程。</span> </div><div><span style="line-height: 22px;"   >简要安装步骤 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >1. 下载源码</font></div><div><font size="2"   >https://github.com/postgres/postgres/tarball/master</font></div><div><font size="2"   >2. 编译安装</font></div><div><font size="2"   >useradd pg</font></div><div><font size="2"   >./configure --prefix=/home/pg/pgsql --with-pgport=5433 --with-perl --with-python --with-tcl --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --enable-debug&nbsp;--with-wal-blocksize=16 &amp;&amp; gmake world</font></div><div><font size="2"   >sudo gmake install-world</font></div><div><font size="2"   >3. 初始化数据库</font></div><div><font size="2"   >initdb -A md5 -D $PGDATA -E UTF8 --locale=C -W -U postgres</font></div><div><font size="2"   >4. 修改配置pg_hba.conf, postgresql.conf</font></div><div><font size="2"   >略</font></div><div><font size="2"   >5. 启动数据库</font></div><div><font size="2"   >pg_ctl start</font></div><p></p></pre></div><div>6. 测试</div><div>在一台PostgreSQL 9.1.3的数据库中输出array相关的函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select proname from pg_proc where proname ~ 'array' order by proname;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; proname &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;_pg_expandarray</font></div><div><font size="2"   >&nbsp;anyarray_in</font></div><div><font size="2"   >&nbsp;anyarray_out</font></div><div><font size="2"   >&nbsp;anyarray_recv</font></div><div><font size="2"   >&nbsp;anyarray_send</font></div><div><font size="2"   >&nbsp;anynonarray_in</font></div><div><font size="2"   >&nbsp;anynonarray_out</font></div><div><font size="2"   >&nbsp;array_agg</font></div><div><font size="2"   >&nbsp;array_agg_finalfn</font></div><div><font size="2"   >&nbsp;array_agg_transfn</font></div><div><font size="2"   >&nbsp;array_append</font></div><div><font size="2"   >&nbsp;array_cat</font></div><div><font size="2"   >&nbsp;array_dims</font></div><div><font size="2"   >&nbsp;array_eq</font></div><div><font size="2"   >&nbsp;array_fill</font></div><div><font size="2"   >&nbsp;array_fill</font></div><div><font size="2"   >&nbsp;array_ge</font></div><div><font size="2"   >&nbsp;array_gt</font></div><div><font size="2"   >&nbsp;array_in</font></div><div><font size="2"   >&nbsp;array_larger</font></div><div><font size="2"   >&nbsp;array_le</font></div><div><font size="2"   >&nbsp;array_length</font></div><div><font size="2"   >&nbsp;array_lower</font></div><div><font size="2"   >&nbsp;array_lt</font></div><div><font size="2"   >&nbsp;array_ndims</font></div><div><font size="2"   >&nbsp;array_ne</font></div><div><font size="2"   >&nbsp;array_out</font></div><div><font size="2"   >&nbsp;array_prepend</font></div><div><font size="2"   >&nbsp;array_recv</font></div><div><font size="2"   >&nbsp;array_send</font></div><div><font size="2"   >&nbsp;array_smaller</font></div><div><font size="2"   >&nbsp;array_to_string</font></div><div><font size="2"   >&nbsp;array_to_string</font></div><div><font size="2"   >&nbsp;array_upper</font></div><div><font size="2"   >&nbsp;arraycontained</font></div><div><font size="2"   >&nbsp;arraycontains</font></div><div><font size="2"   >&nbsp;arrayoverlap</font></div><div><font size="2"   >&nbsp;btarraycmp</font></div><div><font size="2"   >&nbsp;ginarrayconsistent</font></div><div><font size="2"   >&nbsp;ginarrayextract</font></div><div><font size="2"   >&nbsp;ginarrayextract</font></div><div><font size="2"   >&nbsp;ginqueryarrayextract</font></div><div><font size="2"   >&nbsp;hash_array</font></div><div><font size="2"   >&nbsp;regexp_split_to_array</font></div><div><font size="2"   >&nbsp;regexp_split_to_array</font></div><div><font size="2"   >&nbsp;string_to_array</font></div><div><font size="2"   >&nbsp;string_to_array</font></div><div><font size="2"   >(47 rows)</font></div><p></p></pre></div><div><br></div><div>将这些函数导入刚安装的PostgreSQL 9.3 devel中 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# &nbsp;create table pg91_array_funcs(proname text);</font></div><div><font size="2"   >postgres=# copy pg91_array_funcs from stdin;</font></div><div><div><font size="2"   >Enter data to be copied followed by a newline.</font></div><div><font size="2"   >End with a backslash and a period on a line by itself.</font></div><div><font size="2"   >&gt;&gt; &nbsp;_pg_expandarray</font></div><div><font size="2"   >&gt;&gt; &nbsp;anyarray_in</font></div><div><font size="2"   >&gt;&gt; &nbsp;anyarray_out</font></div><div><font size="2"   >&gt;&gt; &nbsp;anyarray_recv</font></div><div><font size="2"   >&gt;&gt; &nbsp;anyarray_send</font></div><div><font size="2"   >&gt;&gt; &nbsp;anynonarray_in</font></div><div><font size="2"   >&gt;&gt; &nbsp;anynonarray_out</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_agg</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_agg_finalfn</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_agg_transfn</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_append</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_cat</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_dims</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_eq</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_fill</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_fill</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_ge</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_gt</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_in</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_larger</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_le</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_length</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_lower</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_lt</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_ndims</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_ne</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_out</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_prepend</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_recv</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_send</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_smaller</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_to_string</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_to_string</font></div><div><font size="2"   >&gt;&gt; &nbsp;array_upper</font></div><div><font size="2"   >&gt;&gt; &nbsp;arraycontained</font></div><div><font size="2"   >&gt;&gt; &nbsp;arraycontains</font></div><div><font size="2"   >&gt;&gt; &nbsp;arrayoverlap</font></div><div><font size="2"   >&gt;&gt; &nbsp;btarraycmp</font></div><div><font size="2"   >&gt;&gt; &nbsp;ginarrayconsistent</font></div><div><font size="2"   >&gt;&gt; &nbsp;ginarrayextract</font></div><div><font size="2"   >&gt;&gt; &nbsp;ginarrayextract</font></div><div><font size="2"   >&gt;&gt; &nbsp;ginqueryarrayextract</font></div><div><font size="2"   >&gt;&gt; &nbsp;hash_array</font></div><div><font size="2"   >&gt;&gt; &nbsp;regexp_split_to_array</font></div><div><font size="2"   >&gt;&gt; &nbsp;regexp_split_to_array</font></div><div><font size="2"   >&gt;&gt; &nbsp;string_to_array</font></div><div><font size="2"   >&gt;&gt; &nbsp;string_to_array</font></div><div><font size="2"   >&gt;&gt; \.</font></div></div><p></p></pre></div><div><br></div><div>查看9.3比9.1.3多了哪些array相关的函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select proname from pg_proc where proname ~ 'array' and proname not in (select trim(proname) from pg91_array_funcs);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;proname &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp;array_remove</font></div><div><font size="2"   >&nbsp;array_replace</font></div><div><font size="2"   >&nbsp;array_typanalyze</font></div><div><font size="2"   >&nbsp;arraycontsel</font></div><div><font size="2"   >&nbsp;arraycontjoinsel</font></div><div><font size="2"   >&nbsp;array_to_json</font></div><div><font size="2"   >&nbsp;array_to_json</font></div><div><font size="2"   >(7 rows)</font></div><p></p></pre></div><div><br></div><div>今天要测试的是array_remove和array_replace这两个函数.</div><div>这两个函数的详细描述如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \df+ *.*array_replace*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of functions</font></div><div><font size="2"   >&nbsp; &nbsp;Schema &nbsp; | &nbsp; &nbsp; Name &nbsp; &nbsp; &nbsp;| Result data type | &nbsp; &nbsp; &nbsp; Argument data types &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;Type &nbsp;| Volatility | &nbsp;Owner &nbsp; | Language | &nbsp;Sou</font></div><div><font size="2"   >rce code &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Description &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------+---------------+------------------+----------------------------------+--------+------------+----------+----------+-----</font></div><div><font size="2"   >----------+---------------------------------------------------</font></div><div><font size="2"   >&nbsp;pg_catalog | array_replace | anyarray &nbsp; &nbsp; &nbsp; &nbsp; | anyarray, anyelement, anyelement | normal | immutable &nbsp;| postgres | internal | arra</font></div><div><font size="2"   >y_replace | replace any occurrences of an element in an array</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# \df+ *.*array_remove*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of functions</font></div><div><font size="2"   >&nbsp; &nbsp;Schema &nbsp; | &nbsp; &nbsp; Name &nbsp; &nbsp; | Result data type | Argument data types &nbsp;| &nbsp;Type &nbsp;| Volatility | &nbsp;Owner &nbsp; | Language | Source code &nbsp;| &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Description &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------+--------------+------------------+----------------------+--------+------------+----------+----------+--------------+---</font></div><div><font size="2"   >-------------------------------------------------</font></div><div><font size="2"   >&nbsp;pg_catalog | array_remove | anyarray &nbsp; &nbsp; &nbsp; &nbsp; | anyarray, anyelement | normal | immutable &nbsp;| postgres | internal | array_remove | re</font></div><div><font size="2"   >move any occurrences of an element from an array</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>测试表 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create table user_contact_info(id serial primary key, username text unique, phonenum text, contacts text[]);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# insert into user_contact_info (username,phonenum,contacts) values ('digoal','18657125281',ARRAY['13988888888','13588888888','18699999999','13881818181']);</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=# select * from user_contact_info;</font></div><div><font size="2"   >&nbsp;id | username | &nbsp;phonenum &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; contacts &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----------+-------------+---------------------------------------------------</font></div><div><font size="2"   >&nbsp; 1 | digoal &nbsp; | 18657125281 | {13988888888,13588888888,18699999999,13881818181}</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>测试replace元素 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# update user_contact_info set contacts = array_replace(contacts, '13988888888', '123456') where username='digoal';</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# select * from user_contact_info;</font></div><div><font size="2"   >&nbsp;id | username | &nbsp;phonenum &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; contacts &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----+----------+-------------+----------------------------------------------</font></div><div><font size="2"   >&nbsp; 1 | digoal &nbsp; | 18657125281 | {123456,13588888888,18699999999,13881818181}</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"   >测试remove元素 :&nbsp;</span> </div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# update user_contact_info set contacts = array_remove(contacts, '123456') where username='digoal';</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# select * from user_contact_info;</font></div><div><font size="2"   >&nbsp;id | username | &nbsp;phonenum &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; contacts &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----------+-------------+---------------------------------------</font></div><div><font size="2"   >&nbsp; 1 | digoal &nbsp; | 18657125281 | {13588888888,18699999999,13881818181}</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>【小结】</div><div>1. 以上利用array_remove, array_contact 进行的操作属于原子操作，不需要担心并发操作的问题。</div><div>2. 目前不能通过一次array_remove移除多个不等的元素, 只能一次移除多个相等的元素, 如果要一次移除多个不等的元素，需要在外面再包一层.例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select array[1,1,2,3,4],array_remove(array[1,1,2,3,4],1),array_remove(array_remove(array[1,1,2,3,4],1),2);</font></div><div><font size="2"   >&nbsp; &nbsp; array &nbsp; &nbsp;| array_remove | array_remove&nbsp;</font></div><div><font size="2"   >-------------+--------------+--------------</font></div><div><font size="2"   >&nbsp;{1,1,2,3,4} | {2,3,4} &nbsp; &nbsp; &nbsp;| {3,4}</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><wbr></div></div><div>如果觉得嵌套比较麻烦, 可以写个对应的plpgsql函数来实现一次删除多个元素的场景, 例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create or replace function multi_text_array_remove(i_src text[],i_remove text[]) returns text[] as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >v_text text; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >v_result text[]; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >begin &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >v_result := i_src; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >foreach v_text in ARRAY i_remove&nbsp;</font></div><div><font size="2"   >loop &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; select array_remove(v_result,v_text) into v_result;</font></div><div><font size="2"   >end loop; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >return v_result;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >postgres=# select multi_text_array_remove(ARRAY['abc','a','c','d'], ARRAY['a','c','d']);</font></div><div><font size="2"   >&nbsp;multi_text_array_remove&nbsp;</font></div><div><font size="2"   >-------------------------</font></div><div><font size="2"   >&nbsp;{abc}</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div>3. 其他版本通过补丁的方式可以实现这个功能.<div><a rel="nofollow" href="https://commitfest.postgresql.org/action/patch_view?id=872"   >https://commitfest.postgresql.org/action/patch_view?id=872</a> </div><div>怎么打补丁可参考 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201252885331153/"   >http://blog.163.com/digoal@126/blog/static/163877040201252885331153/</a> </div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201252884053930/"   >http://blog.163.com/digoal@126/blog/static/163877040201252884053930/</a> </div></div>
	</div>
</div>
</body>
</html>