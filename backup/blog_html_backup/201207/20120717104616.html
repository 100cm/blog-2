<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">ipmitool power reset command shutdown server has a little delay</h2>
	<h5 id="">2012-07-17 10:46:16&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201261710254982/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">昨天在调试sky_postgresql_cluster(一个shell写的PostgreSQL集群管理工具)时, 发现了failover函数的一个BUG. 已经修正, 现将原因和修正方法记录如下.<div>sky_postgresql_cluster当发生failover时, 需要fence 异常的primary 主机, 然后使用ifup 启动VIP.&nbsp;<div>在此之前VIP是启在primary 主机上的, 使用ifup启动接口, 有一个判断这个IP是否已经在网络的其他主机上. 如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >/etc/sysconfig/network-scripts/ifup-eth</font></div><div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if ! arping -q -c 2 -w 3 -D -I ${REALDEVICE} ${IPADDR} ; then</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo $"Error, some other host already uses address ${IPADDR}."</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exit 1</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fi</font></div></div><p></p></pre></div><div><br></div><div>注意到, ifup这个操作在pg_failover() 函数中是在fence成功之后执行的. 正常情况下, 关机后这个IP应该就不在存在了, arping这个IP应该返回正常. 但是却报异常了, 原因后面会详细指出.</div><div><span style="line-height: 22px;"  >sky_postgresql_cluster</span>修正前, 所有操作都执行一次, 没有重试操作, 修正后函数如下, 重试60次 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >pg_failover() {</font></div><div><font size="2"  >FENCE_STATUS=1</font></div><div><font size="2"  >PROMOTE_STATUS=1</font></div><div><font size="2"  >IFUP_STATUS=1</font></div><div><font size="2"  >echo -e "`date +%F%T` pg_failover fired."</font></div><div><font size="2"  ># 1. fence primary host</font></div><div><font size="2"  >echo -e "`date +%F%T` fence primary host fired."</font></div><div><font size="2"  >for ((k=0;k&lt;60;k++))</font></div><div><font size="2"  >do</font></div><div><font size="2"  >&nbsp; # fence命令, 设备不同的话, fence命令可能不一样.</font></div><div><font size="2"  >&nbsp; ipmitool -L OPERATOR -H $FENCE_IP -U $FENCE_USER -P $FENCE_PWD power reset</font></div><div><font size="2"  >&nbsp; if [ $? -eq 0 ]; then</font></div><div><font size="2"  >&nbsp; &nbsp; echo -e "`date +%F%T` fence primary db host success."</font></div><div><font size="2"  >&nbsp; &nbsp; FENCE_STATUS=0</font></div><div><font size="2"  >&nbsp; &nbsp; break</font></div><div><font size="2"  >&nbsp; fi</font></div><div><font size="2"  >&nbsp; sleep 1</font></div><div><font size="2"  >done</font></div><div><font size="2"  >if [ $FENCE_STATUS -ne 0 ]; then</font></div><div><font size="2"  >&nbsp; echo -e "`date +%F%T` fence failed. Standby will not promote, please fix it manual."</font></div><div><font size="2"  >&nbsp; return $FENCE_STATUS</font></div><div><font size="2"  >fi</font></div><div><font size="2"  ># 2. 激活standby</font></div><div><font size="2"  >echo -e "`date +%F%T` promote standby fired."</font></div><div><font size="2"  >for ((l=0;l&lt;60;l++))</font></div><div><font size="2"  >do</font></div><div><font size="2"  >&nbsp; pg_ctl promote -D $PGDATA</font></div><div><font size="2"  >&nbsp; if [ $? -eq 0 ]; then</font></div><div><font size="2"  >&nbsp; &nbsp; echo -e "`date +%F%T` promote standby success."</font></div><div><font size="2"  >&nbsp; &nbsp; PROMOTE_STATUS=0</font></div><div><font size="2"  >&nbsp; &nbsp; break</font></div><div><font size="2"  >&nbsp; fi</font></div><div><font size="2"  >&nbsp; sleep 1</font></div><div><font size="2"  >done</font></div><div><font size="2"  >if [ $PROMOTE_STATUS -ne 0 ]; then</font></div><div><font size="2"  >&nbsp; echo -e "`date +%F%T` promote standby failed."</font></div><div><font size="2"  >&nbsp; return $PROMOTE_STATUS</font></div></div><div><div><font size="2"  >fi</font></div><div><font size="2"  ># 3. 起vip接口, 需要配置/etc/sudoers, 注释Defaults &nbsp; &nbsp;requiretty</font></div><div><font size="2"  >echo -e "`date +%F%T` ifup vip fired."</font></div><div><font size="2"  >for ((m=0;m&lt;60;m++))</font></div><div><font size="2"  >do</font></div><div><font size="2"  >&nbsp; sudo /sbin/ifup $VIP_IF</font></div><div><font size="2"  >&nbsp; if [ $? -eq 0 ]; then</font></div><div><font size="2"  >&nbsp; &nbsp; echo -e "`date +%F%T` vip upped success."</font></div><div><font size="2"  >&nbsp; &nbsp; IFUP_STATUS=0</font></div><div><font size="2"  >&nbsp; &nbsp; break</font></div><div><font size="2"  >&nbsp; fi</font></div><div><font size="2"  >&nbsp; sleep 1</font></div><div><font size="2"  >done</font></div><div><font size="2"  >if [ $IFUP_STATUS -ne 0 ]; then</font></div><div><font size="2"  >&nbsp; echo -e "`date +%F%T` standby host ifup vip failed."</font></div><div><font size="2"  >&nbsp; return $IFUP_STATUS</font></div><div><font size="2"  >fi</font></div><div><font size="2"  >echo -e "`date +%F%T` pg_failover() function call success."</font></div><div><font size="2"  >return 0</font></div><div><font size="2"  >}</font></div></div><p></p></pre></div><div><br></div><div>调试过程 :&nbsp;</div><div>1. 在主库和备库上启动tcpdump监测arp包 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >tcpdump -n -e |grep arp</font></p></pre></div><div>2. tail 备库sky_postgresql_cluster日志.</div><div><pre class="prettyprint"  ><p><font size="2"  >tail -f -n 1 /tmp/sky_pg_clusterd.log</font></p></pre></div><div>3. 关闭主库,</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >su - postgres</font></div><div><font size="2"  >pg_ctl stop -m fast</font></div><p></p></pre></div><div>4.&nbsp;</div><div><span style="line-height: 22px;"  >/tmp/sky_pg_clusterd.log&nbsp;</span>切换日志如下, 注意时间点 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >2012-07-1710:10:40 STD_TO_MASTER_STATUS is 2 , master is not health count 9 .</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >2012-07-1710:10:40 VOTE_TO_MASTER_STATUS is 2 , master is not health count 9 .</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >2012-07-1710:10:40 VOTEHOST_STATUS is 0 , master is not health count 9 .</font></div><div><font size="2"  >2012-07-1710:10:40 pg_failover fired.</font></div><div><font size="2"  >2012-07-1710:10:40 fence primary host fired.</font></div><div><font size="2"  >Chassis Power Control: Reset</font></div><div><font size="2"  >2012-07-1710:10:41 fence primary db host success.</font></div><div><font size="2"  >2012-07-1710:10:41 promote standby fired.</font></div><div><font size="2"  >server promoting</font></div><div><font size="2"  >2012-07-1710:10:41 promote standby success.</font></div><div><font size="2"  >2012-07-1710:10:41 ifup vip fired.</font></div><div><font size="2"  >Error, some other host already uses address 192.168.169.116.</font></div><div><font size="2"  >2012-07-1710:10:46 vip upped success.</font></div><div><font size="2"  >2012-07-1710:10:46 pg_failover() function call success.</font></div><p></p></pre></div><div>看到<span style="line-height: 22px;"  >2012-07-1710:10:41的时候 &nbsp;</span><span style="line-height: 22px;"  >Error, some other host already uses address 192.168.169.116.</span></div><div><br></div><div>5.&nbsp;</div><div>同时观察到主库在被关机(ipmitool power reset)前&nbsp;<span style="line-height: 22px;"  >10:10:40 接收到</span>的来自<span style="line-height: 22px;"  >d4:be:d9:ad:9a:b6的</span>arp请求包 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >10:10:40.837809 d4:be:d9:ad:9a:b6 &gt; Broadcast, ethertype ARP (0x0806), length 60: arp who-has 192.168.169.116 (Broadcast) tell 0.0.0.0</font></div><div><font size="2"  >Last login: Tue Jul 17 10:10:17 2012 from 10.96.0.139</font></div><p></p></pre></div><div><br></div><div>6.&nbsp;<span style="line-height: 22px;"  >同时观察到备库</span><span style="line-height: 22px;"  >10:10:41 发送的ARP广播请求, 以及接收到</span><span style="line-height: 22px;"  >的来自主库的arp响应包(从MAC地址可以看出) :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >10:10:41.138675 d4:be:d9:ad:9a:b6 &gt; Broadcast, ethertype ARP (0x0806), length 42: arp who-has 192.168.169.116 (Broadcast) tell 0.0.0.0</font></div><div><font size="2"  >10:10:41.138848 d4:be:d9:ad:97:7a &gt; d4:be:d9:ad:9a:b6, ethertype ARP (0x0806), length 60: arp reply 192.168.169.116 is-at d4:be:d9:ad:97:7a</font></div><p></p></pre></div><div>时间对不上是两主机存在一定的时间差.</div><div><br></div><div>那么报错的原因就很明朗了, ipmitool power reset （This command will perform a hard reset ）这个操作返回成功后网卡还可以在很短的时间内响应ARP请求. 或者说这个时候系统还没有真正SHUTDOWN.&nbsp;</div><div><br></div><div>在使用时需注意.</div><div><br></div><div>【参考】</div><div>/etc/sysconfig/network-scripts/ifup-eth</div><div><a rel="nofollow" href="https://github.com/digoal/sky_postgresql_cluster"  >https://github.com/digoal/sky_postgresql_cluster</a>&nbsp;<br><br><wbr></div></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">francs - 2012-07-18 17:27:25</h5>
				<div><P>good !</P></div>
			</div>
	</div>
</div>
</body>
</html>