<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Using mongoDB's Profiler analyze the performance of database operations</h2>
	<h5 id="">2011-01-09 9:13:40&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020110985221372/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">慢查询在数据库分析中是一个非常重要的参考。<br>我记得在PostgreSQL Conference 2009 中曾经就有人专门讲解了Hit the mole.（90%的数据库性能问题往往出现在10%的SQL上面.）<br>在MySQL,PostgreSQL数据库中，用日志来记录慢查询。（比如为数据库设置一下阀值100MS,运行时间超过100MS的SQL将记录到日志中.）<br>在mongoDB中也比较类似，使用profile 来配置慢查询的阀值.已经是否开启记录慢查询的功能。mongoDB的慢查询被记录到system.profile collection中。<br>在mongoDB&nbsp; 1.7.x 以下版本中使用<tt>getProfilingLevel()查看当前配置的数据库profile.1.7.x以后改为getProfilingStatus().<br>配置profile可以通过参数文件,或在mongo shell中执行命令来配置.<br>1. 参数文件<br>&nbsp; --profile arg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0=off 1=slow, 2=all&nbsp; (0表示关闭profile,1表示只记录执行时间超过slowms配置的值的执行内容,2表示记录所有执行内容)<br>&nbsp; --slowms arg (=100)&nbsp;&nbsp; value of slow for profile and console log (如果profile配置为1并且没有配置slowms的话默认是100毫秒)<br>2. mongo shell<br>&nbsp; </tt>db.setProfilingLevel( level , slowms )
<br><tt>3. 查看profile<br>&gt; db.getProfilingLevel()<br>1<br><br>配置举例:<br># 配置slowms=1,profile=1<br>&gt; db.setProfilingLevel(1,1) <br>{ "was" : 0, "slowms" : 100, "ok" : 1 }<br><br># 注意这里返回的slowms : 100,实际上已经配置为1了，估计是个BUG。在1.7.x里面可以通过以下命令查看:<br></tt><pre>&gt; db.getProfilingStatus()<br>{ <span>"was"</span> : 1, <span>"slowms"</span> : 1 }<br><br># 插入测试数据<br>&gt; for (var i=0;i&lt;10000;i++) {<br>... db.userinfo.insert({"firstname" : "zhou","lastname" : "digoal" + i,"age" : i})<br>... }<br><br># 在1.6.5的环境下,没有办法通过db.getProfilingLevel()查看slowms的具体配置,不过通过以下测试可以知道,前面配置的slowms=1已经生效.<br>&gt; db.userinfo.find({"firstname" : "zhou"}).explain()<br>{<br>        "cursor" : "BasicCursor",<br>        "nscanned" : 10000,<br>        "nscannedObjects" : 10000,<br>        "n" : 10000,<br>        "millis" : 5,<br>        "indexBounds" : {<br><br>        }<br>}<br>&gt; db.system.profile.find()                          <br>{ "ts" : "Sun Jan 09 2011 09:02:56 GMT+0800 (CST)", "info" : "insert admin.userinfo", "millis" : 1 }<br>{ "ts" : "Sun Jan 09 2011 09:07:21 GMT+0800 (CST)", "info" : "query admin.userinfo reslen:202 nscanned:10000  \nquery: { query: { firstname: \"zhou\" }, $explain: true }  nreturned:1 5ms", "millis" : 5 }<br><br># 使用以下方式查看效果也是一样的<br>&gt; db.system.profile.find( function() { return this.info.indexOf('$cmd')&lt;0; } )<br>{ "ts" : "Sun Jan 09 2011 09:02:56 GMT+0800 (CST)", "info" : "insert admin.userinfo", "millis" : 1 }<br>{ "ts" : "Sun Jan 09 2011 09:07:21 GMT+0800 (CST)", "info" : "query admin.userinfo reslen:202 nscanned:10000  \nquery: { query: { firstname: \"zhou\" }, $explain: true }  nreturned:1 5ms", "millis" : 5 }<br></pre><tt># 也可以使用规则表达式过滤出你关心的collection,如下.<br>&gt; db.system.profile.find({"info" : /userinfo/})&nbsp; <br>{ "ts" : "Sun Jan 09 2011 09:02:56 GMT+0800 (CST)", "info" : "insert admin.userinfo", "millis" : 1 }<br>{ "ts" : "Sun Jan 09 2011 09:07:21 GMT+0800 (CST)", "info" : "query admin.userinfo reslen:202 nscanned:10000&nbsp; \nquery: { query: { firstname: \"zhou\" }, $explain: true }&nbsp; nreturned:1 5ms", "millis" : 5 }<br><br># 或者按millis排个序<br>&gt; db.system.profile.find().sort({"millis" : -1})<br>{ "ts" : "Sun Jan 09 2011 09:07:21 GMT+0800 (CST)", "info" : "query admin.userinfo reslen:202 nscanned:10000&nbsp; \nquery: { query: { firstname: \"zhou\" }, $explain: true }&nbsp; nreturned:1 5ms", "millis" : 5 }<br>{ "ts" : "Sun Jan 09 2011 09:02:56 GMT+0800 (CST)", "info" : "insert admin.userinfo", "millis" : 1 }<br><br># 由于system.profile是capped collection,使用$natural&nbsp; 可以按照记录插入的插入顺序查看结果.<br>&gt; db.system.profile.find().sort({"$natural" : -1})&nbsp; <br>{ "ts" : "Sun Jan 09 2011 09:07:21 GMT+0800 (CST)", "info" : "query admin.userinfo reslen:202 nscanned:10000&nbsp; \nquery: { query: { firstname: \"zhou\" }, $explain: true }&nbsp; nreturned:1 5ms", "millis" : 5 }<br>{ "ts" : "Sun Jan 09 2011 09:02:56 GMT+0800 (CST)", "info" : "insert admin.userinfo", "millis" : 1 }<br><br># 使用show profile 查看最近5%的超过1ms执行时间的事件<br>&gt; show profile<br><br>5ms Sun Jan 09 2011 09:07:21<br>query admin.userinfo reslen:202 nscanned:10000&nbsp; <br>query: { query: { firstname: "zhou" }, $explain: true }&nbsp; nreturned:1 5ms<br><br><br>1ms Sun Jan 09 2011 09:02:56<br>insert admin.userinfo<br><br>输出格式:<br>1. ts : 记录下捕获的时间戳,(SQL执行结束时间,如下)<br>&gt; Date()<br>Sun Jan 09 2011 09:42:31 GMT+0800 (CST)<br>&gt; db.userinfo.ensureIndex({"lastname" : 1,"detail.city" : 1})<br>&gt; db.system.profile.find().sort({"$natural" : -1}).limit(1)<br>{ "ts" : "Sun Jan 09 2011 09:42:46 GMT+0800 (CST)", "info" : "insert admin.system.indexes 14374ms", "millis" : 14374 }<br># 从时间上看是执行结束时间.<br>2. </tt><tt>millis : 执行时间,注意不包含lock请求时间和network传输时间，只包含了server处理这条请求的时间.<br><font size="2">3. info : 执行详细信息,包含(query,update,insert,getmore)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; query : 数据库查询操作,包含以下信息:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ntoreturn : Number of objects the client requested for return from a query. For example, &lt;code&gt;findOne()&lt;/code&gt; sets ntoreturn to 1.&lt;code&gt;limit()&lt;/code&gt; sets the appropriate limit. Zero indicates no limit.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; query : Details of the query spec.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nscanned : Number of objects scanned in executing the operation.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; reslen : Query result length in bytes.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nreturned : Number of objects returned from query.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; update : A database update operation. &lt;code&gt;save()&lt;/code&gt; calls generate either an update or insert operation.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fastmod : Indicates a fast modify operation. See Updates. These operations are normally quite fast.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fastmodinsert : indicates a fast modify operation that performed an upsert.<br>&nbsp;&nbsp;&nbsp;&nbsp;</font></tt><tt><font size="2"></font></tt><tt><font size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; upsert : Indicates on upsert performed.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; moved : Indicates the update moved the object on disk (not updated in place). This is slower than an in place update, and normally occurs when an object grows.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; insert : A database insert.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; getmore : For large queries, the database initially returns partial information. getmore indicates a call to retrieve further information.<br></font># 例:<br>&gt; db.userinfo.find().sort({"age" : -1}).limit(1)&nbsp;&nbsp;&nbsp;&nbsp; <br>{ "_id" : ObjectId("4d2910734f7371f2497bd6ad"), "firstname" : "zhou", "lastname" : "digoal999998", "age" : 999998, "detail" : { "city" : "HangZhou", "corp" : "sky-mobi" } }<br>&gt; db.system.profile.find().sort({"$natural" : -1}).limit(1)<br>{ "ts" : "Sun Jan 09 2011 09:53:42 GMT+0800 (CST)", "info" : "query admin.userinfo ntoreturn:1 scanAndOrder&nbsp; reslen:169 nscanned:2009998&nbsp; \nquery: { query: {}, orderby: { age: -1.0 } }&nbsp; nreturned:1 3140ms", "millis" : 3140 }<br></tt><tt># 性能优化相关<br>从上面的profile结果看出</tt><tt>ntoreturn = 1,</tt><tt>nscanned = 2009998</tt>，也就是说返回结果是1条，但是扫描了200多W条记录。如果这种查询非常多的话建议在"age"上建立索引。对于update操作同样适用.（当然，还要考虑索引对写入带来的overhead）<br>如果<tt>reslen这个值比较大,表示返回结果非常多,建议调整find()限制输出结果.</tt><br><tt><br>调整profileSIZE:<br>1. 关闭profile<br>&gt; db.setProfilingLevel(0)<br>{ "was" : 1, "slowms" : 1, "ok" : 1 }<br>2. 调整profile size<br></tt><tt>&gt; db.system.profile.renameCollection("system.oldprofile")<br>
{ "ok" : 1 }<br>
&gt; show collections&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>
system.indexes<br>
system.oldprofile<br>
system.users<br>
userinfo<br>
version<br># 调整为100MB<br>
&gt; db.createCollection("system.profile",{"capped" : true, "size" : 102400000})<br>
{ "ok" : 1 }<br>
&gt; db.system.profile.stats()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>
{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ns" : "admin.system.profile",<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "count" : 0,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "size" : 0,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "avgObjSize" : NaN,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "storageSize" : 102400256,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "numExtents" : 1,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "nindexes" : 0,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "lastExtentSize" : 102400256,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "paddingFactor" : 1,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "flags" : 0,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "totalIndexSize" : 0,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "indexSizes" : {<br>
  <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "capped" : 1,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "max" : 2147483647,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ok" : 1<br>
}<br>3. 重新开启profile<br>
&gt; db.setProfilingLevel(1,1)<br>
{ "was" : 0, "slowms" : 1, "ok" : 1 }<br>4. oldprofile中的数据无法插入到profile<br>测试:<br>&gt; for (var c = db.system.oldprofile.find(); c.hasNext();) {<br>... b = c.next();<br>... db.system.profile.insert({"ts" : c.ts,"info" : c.info,"millis" : c.millis}); <br>... }<br>&gt; db.system.profile.count()<br>0<br># 没有插进去<br># 非常抱歉,插入到test是OK的.</tt>system.profile 不可以手工插入记录<br><tt>&gt; for (var c = db.system.oldprofile.find(); c.hasNext();) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>... b = c.next();<br>... db.test.insert({"ts" : c.ts,"info" : c.info,"millis" : c.millis});&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>... }<br>&gt; db.test.count()<br>6<br><br>5. 删除oldprofile<br>&gt; db.system.oldprofile.drop()<br>Sun Jan&nbsp; 9 10:38:57 uncaught exception: drop failed: {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ns" : "admin.system.oldprofile",<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "errmsg" : "exception: can't drop system ns",<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "code" : 12502,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ok" : 0<br>}<br># system下面的collection不允许删除,所以要先rename一下.<br>&gt; db.system.oldprofile.renameCollection("oldprofile")<br>{ "ok" : 1 }<br>&gt; db.oldprofile.drop()<br>true<br></tt><tt><br>注意事项:<br>1. system.profile 是capped collection,默认配置比较小,所以如果需要放更多的内容需要调整size和max (具体的话可以参考我以前写过的capped collection topic)<br>如:<br>&gt; db.system.profile.stats() <br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ns" : "admin.system.profile",<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "count" : 1,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "size" : 68,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "avgObjSize" : 68,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "storageSize" : 131328,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "numExtents" : 1,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "nindexes" : 0,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "lastExtentSize" : 131328,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "paddingFactor" : 1,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "flags" : 0,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "totalIndexSize" : 0,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "indexSizes" : {<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "capped" : 1,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "max" : 2147483647,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ok" : 1<br>}<br>&gt; db.system.profile.totalSize()<br>131328<br><br>2. 开启profile对性能略有影响.<br></tt><br>3. 通过命令行开启profile只对当前数据库生效,并且重启数据库后失效.<br># 例如在admin库中使用mongo shell开启了profile，转到test库后是没有开启的.<br>&gt; use test<br>switched to db test<br>&gt; show collections<br>system.indexes<br>system.users<br>userinfo<br>&gt; db.getProfilingLevel()<br>0<br>&gt; db.setProfilingLevel(1,1)<br>{ "was" : 0, "slowms" : 1, "ok" : 1 }<br>&gt; db.getProfilingLevel()&nbsp;&nbsp; <br>1<br># 使用mongo shell开启的profile重启后失效,如下<br># 重启mongoDB<br>[root@db5 ~]# /opt/mongodb/bin/mongo 127.0.0.1:5281/admin<br>MongoDB shell version: 1.6.5<br>connecting to: 127.0.0.1:5281/admin<br>&gt; db.auth("digoal","DIGOAL")<br>1<br>&gt; db.getProfilingLevel()<br>0<br># 显然system.profile是还在的.<br>&gt; show collections<br>system.indexes<br>system.profile<br>system.users<br>userinfo<br>version<br>&gt; db.system.profile.find()<br>{ "ts" : "Sun Jan 09 2011 09:02:56 GMT+0800 (CST)", "info" : "insert admin.userinfo", "millis" : 1 }<br>{ "ts" : "Sun Jan 09 2011 09:07:21 GMT+0800 (CST)", "info" : "query admin.userinfo reslen:202 nscanned:10000&nbsp; \nquery: { query: { firstname: \"zhou\" }, $explain: true }&nbsp; nreturned:1 5ms", "millis" : 5 }<br><br>4. system.profile 不可以手工插入记录</div>
	</div>
</div>
</body>
</html>