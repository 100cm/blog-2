<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL nodes's estimate bug? when alter column set statistics 0</h2>
	<h5 id="">2014-04-15 14:56:59&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201431514422283/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>群里的一位兄弟提到的一个问题, 当列的统计信息开关关闭时, 为什么还会走索引?</div><div>有些数据库产品在创建索引时, 会自动给对应的列加上统计信息. 为什么PostgreSQL不可以这样呢?</div><div>首先我们来看一下第一个问题, 当列的统计信息开关关闭后, 会发生什么?</div><div>创建一个普通表, 不关闭列统计信息.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table t(id int, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into t select 1,'test' from generate_series(1,1000000);</font></div><div><font size="2"   >INSERT 0 1000000</font></div><div><font size="2"   >digoal=# analyze t;</font></div><div><font size="2"   >ANALYZE</font></div><div><font size="2"   >digoal=# select * from pg_stats where tablename ='t';</font></div><div><font size="2"   >&nbsp;schemaname | tablename | attname | inherited | null_frac | avg_width | n_distinct | most_common_vals | most_common_freqs | histogra</font></div><div><font size="2"   >m_bounds | correlation | most_common_elems | most_common_elem_freqs | elem_count_histogram&nbsp;</font></div><div><font size="2"   >------------+-----------+---------+-----------+-----------+-----------+------------+------------------+-------------------+---------</font></div><div><font size="2"   >---------+-------------+-------------------+------------------------+----------------------</font></div><div><font size="2"   >&nbsp;public &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; | id &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | {1} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {1} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; | info &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; 5 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | {test} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | {1} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div><br></div><div>创建另一个表, 关闭列的统计信息.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create table t1(id int, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# alter table t1 alter column id set statistics 0;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >digoal=# alter table t1 alter column info set statistics 0;</font></div><div><font size="2"   >ALTER TABLE</font></div></div><div><div><font size="2"   >digoal=# insert into t1 select 1,'test' from generate_series(1,1000000);</font></div><div><font size="2"   >INSERT 0 1000000</font></div><div><font size="2"   >digoal=# analyze t1;</font></div><div><font size="2"   >ANALYZE</font></div><div><font size="2"   >digoal=# select * from pg_stats where tablename ='t1';</font></div><div><font size="2"   >&nbsp;schemaname | tablename | attname | inherited | null_frac | avg_width | n_distinct | most_common_vals | most_common_freqs | histogra</font></div><div><font size="2"   >m_bounds | correlation | most_common_elems | most_common_elem_freqs | elem_count_histogram&nbsp;</font></div><div><font size="2"   >------------+-----------+---------+-----------+-----------+-----------+------------+------------------+-------------------+---------</font></div><div><font size="2"   >---------+-------------+-------------------+------------------------+----------------------</font></div><div><font size="2"   >(0 rows)</font></div></div><p></p></pre></div><div>关闭统计信息后, 在pg_stats中查不到列的统计信息.</div><div>给这两个表创建ID列的索引.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create index idx_t_id on t(id);</font></div><div><font size="2"   >digoal=# create index idx_t1_id on t1(id);</font></div><div><div><font size="2"   >digoal=# select * from pg_stats where tablename ='t1';</font></div><div><font size="2"   >&nbsp;schemaname | tablename | attname | inherited | null_frac | avg_width | n_distinct | most_common_vals | most_common_freqs | histogra</font></div><div><font size="2"   >m_bounds | correlation | most_common_elems | most_common_elem_freqs | elem_count_histogram&nbsp;</font></div><div><font size="2"   >------------+-----------+---------+-----------+-----------+-----------+------------+------------------+-------------------+---------</font></div><div><font size="2"   >---------+-------------+-------------------+------------------------+----------------------</font></div><div><font size="2"   >(0 rows)</font></div></div><p></p></pre></div><div>创建索引后, t1表仍然没有统计信息, 这个是当然的, 因为PostgreSQL创建索引时不会主动生成统计信息. 即使要生成统计信息, 因为关闭了列统计, 所以也不可能会有统计信息.</div><div>那么在pg_class表查看对应的数据块和行, 两个表得到的结果也不一样. t表的数据比较精确, t1表不精确. 但是也比较接近.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select relname,reltuples,relpages from pg_class where relname in ('t','t1');</font></div><div><font size="2"   >&nbsp;relname | reltuples | relpages&nbsp;</font></div><div><font size="2"   >---------+-----------+----------</font></div><div><font size="2"   >&nbsp;t &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; 1e+06 | &nbsp; &nbsp; 1345</font></div><div><font size="2"   >&nbsp;t1 &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;999468 | &nbsp; &nbsp; 1345</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div><br></div><div>查询ID等于1的记录, 查看对应的执行计划, t1表走了索引, 但是评估出来的行是4997.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain select * from t1 where id=1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using idx_t1_id on t1 &nbsp;(cost=0.30..1436.75 rows=4997 width=36)</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: (id = 1)</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>t表未走索引, 评估出来的行是1000000. 两者怎么会差别这么大呢?</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain select * from t where id=1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on t &nbsp;(cost=0.00..13845.00 rows=1000000 width=9)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (id = 1)</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div></div><div>理论上t1表应该没有列统计信息, 应该评估不出任何行, 但是却被评估到了4997行.</div><div>这个评估的算法在costsize.c里面可以找到, 在这种情况下显然不合理. 但是这可能是一种折中的做法, 因为在没有统计信息的前提下, 根本不知道该不该走索引, 所以这个选择性也是一个胡乱猜测做出的.&nbsp;</div><div>一般情况下, 作为查询条件的列, 都不建议关闭统计信息.</div><div><br></div><div>下面我们看看其他查询, 如范围查询, 不等于的查询, 或者换一个ID进行查询.</div><div>从t1表执行计划评估到的行数, 显然和实际相差甚远.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain select * from t1 where id&gt;1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using idx_t1_id on t1 &nbsp;(cost=0.30..7403.53 rows=333156 width=36)</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: (id &gt; 1)</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# explain select * from t1 where id&gt;0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using idx_t1_id on t1 &nbsp;(cost=0.30..7403.53 rows=333156 width=36)</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: (id &gt; 0)</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# explain select * from t1 where id&gt;100000;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using idx_t1_id on t1 &nbsp;(cost=0.30..7403.53 rows=333156 width=36)</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: (id &gt; 100000)</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# explain select * from t1 where id=100000;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using idx_t1_id on t1 &nbsp;(cost=0.30..1436.75 rows=4997 width=36)</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: (id = 100000)</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# explain select * from t1 where id&lt;&gt;100000;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on t1 &nbsp;(cost=0.00..13838.35 rows=994471 width=36)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (id &lt;&gt; 100000)</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div><br></div><div>开启了列统计信息的T表, 统计到的行数和实际相符.</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >digoal=# explain select * from t where id&gt;1;</font></span></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using idx_t_id on t &nbsp;(cost=0.30..1.32 rows=1 width=9)</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: (id &gt; 1)</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# explain select * from t where id&gt;0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on t &nbsp;(cost=0.00..13845.00 rows=1000000 width=9)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (id &gt; 0)</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# explain select * from t where id&gt;100000;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using idx_t_id on t &nbsp;(cost=0.30..1.32 rows=1 width=9)</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: (id &gt; 100000)</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# explain select * from t where id=100000;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using idx_t_id on t &nbsp;(cost=0.30..1.32 rows=1 width=9)</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: (id = 100000)</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# explain select * from t where id&lt;&gt;100000;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on t &nbsp;(cost=0.00..13845.00 rows=1000000 width=9)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (id &lt;&gt; 100000)</font></div><div><font size="2"   >(2 rows)</font></div></div><p></p></pre></div><div>开启plan的跟踪可以看到更详细的情况 :&nbsp;</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# set debug_print_plan=on;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# set client_min_messages=log;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# \set VERBOSITY verbose</font></div><div><font size="2"   >digoal=# explain select * from t1 where id&lt;&gt;100000;</font></div><div><font size="2"   >LOG: &nbsp;00000: plan:</font></div><div><font size="2"   >DETAIL: &nbsp; &nbsp; {PLANNEDSTMT&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:commandType 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:queryId 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:hasReturning false&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:hasModifyingCTE false&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:canSetTag true&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:transientPlan false&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:planTree&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; {SEQSCAN&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :startup_cost 0.00&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :total_cost 13838.35&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :plan_rows 994471&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :plan_width 36&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :targetlist (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{TARGETENTRY&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:expr&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {VAR&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varno 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varattno 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :vartype 23&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :vartypmod -1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varcollid 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varlevelsup 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varnoold 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varoattno 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :location 15</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:resno 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:resname id&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:ressortgroupref 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:resorigtbl 17194&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:resorigcol 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:resjunk false</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{TARGETENTRY&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:expr&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {VAR&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varno 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varattno 2&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :vartype 25&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :vartypmod -1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varcollid 100&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varlevelsup 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varnoold 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varoattno 2&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :location 15</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:resno 2&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:resname info&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:ressortgroupref 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:resorigtbl 17194&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:resorigcol 2&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:resjunk false</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; )</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :qual (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{OPEXPR&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:opno 518&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:opfuncid 144&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:opresulttype 16&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:opretset false&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:opcollid 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:inputcollid 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:args (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {VAR&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varno 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varattno 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :vartype 23&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :vartypmod -1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varcollid 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varlevelsup 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varnoold 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varoattno 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :location 31</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {CONST&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :consttype 23&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :consttypmod -1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :constcollid 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :constlen 4&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :constbyval true&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :constisnull false&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :location 35&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :constvalue 4 [ -96 -122 1 0 0 0 0 0 ]</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:location 33</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; )</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :lefttree &lt;&gt;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :righttree &lt;&gt;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :initPlan &lt;&gt;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :extParam (b)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :allParam (b)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :scanrelid 1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp;:rtable (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; {RTE&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :alias &lt;&gt;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :eref&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{ALIAS&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:aliasname t1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:colnames ("id" "info")</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :rtekind 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :relid 17194&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :relkind r&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :lateral false&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :inh false&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :inFromCl true&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :requiredPerms 2&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :checkAsUser 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :selectedCols (b 9 10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :modifiedCols (b)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp;)</font></div><div><font size="2"   >&nbsp; &nbsp;:resultRelations &lt;&gt;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:utilityStmt &lt;&gt;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:subplans &lt;&gt;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:rewindPlanIDs (b)</font></div><div><font size="2"   >&nbsp; &nbsp;:rowMarks &lt;&gt;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:relationOids (o 17194)</font></div><div><font size="2"   >&nbsp; &nbsp;:invalItems &lt;&gt;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:nParamExec 0</font></div><div><font size="2"   >&nbsp; &nbsp;}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >LOCATION: &nbsp;elog_node_display, print.c:84</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on t1 &nbsp;(cost=0.00..13838.35 rows=994471 width=36)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (id &lt;&gt; 100000)</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >[参考]</span></div><wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/sql-altertable.html"   >http://www.postgresql.org/docs/9.3/static/sql-altertable.html</a></div><div>2. cost_index@src/backend/optimizer/path/costsize.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Call index-access-method-specific code to estimate the processing cost</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* for scanning the index, as well as the selectivity of the index (ie,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* the fraction of main-table tuples we will have to retrieve) and its</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* correlation to the main-table tuple order.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; OidFunctionCall7(index-&gt;amcostestimate,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PointerGetDatum(root),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PointerGetDatum(path),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Float8GetDatum(loop_count),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PointerGetDatum(&amp;indexStartupCost),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PointerGetDatum(&amp;indexTotalCost),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PointerGetDatum(&amp;indexSelectivity),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PointerGetDatum(&amp;indexCorrelation));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Save amcostestimate's results for possible use in bitmap scan planning.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* We don't bother to save indexStartupCost or indexCorrelation, because a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* bitmap scan doesn't care about either.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; path-&gt;indextotalcost = indexTotalCost;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; path-&gt;indexselectivity = indexSelectivity;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* all costs for touching index itself included here */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; startup_cost += indexStartupCost;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; run_cost += indexTotalCost - indexStartupCost;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* estimate number of main-table tuples fetched */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; tuples_fetched = clamp_row_est(indexSelectivity * baserel-&gt;tuples);</font></div><p></p></pre></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL nodess estimate bug? when alter column set statistics 0 - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>