<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">pgpool-II performance lossy</h2>
	<h5 id="">2014-04-16 17:06:47&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014316448141/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>具体pgpool-II性能损耗计算和分析请参考:&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402015380712956/"   >http://blog.163.com/digoal@126/blog/static/1638770402015380712956/</a></div><wbr><div><br></div>经常有人问我pgpool-II做连接池合不合适. 这个要结合业务需求来看, 除了PGPOOL-II本身的性能损失, 它的功能还是很强大的.<wbr><div>因为我以前在某项目上用过这个产品, 对性能有一定的损耗, 不知道现在的版本怎么样了?</div><div>所以接下来测试一下最新的pgpool-II3.3.3的性能. 对比不使用连接池的性能.</div><div>测试方法很简单, 连接到数据库, 执行 select 1;</div><div>测试环境 :&nbsp;</div><div>pgpool, pgbench所在服务器硬件, 志强8核1.6G.&nbsp;</div><div>postgresql 9.3.3所在服务器硬件,&nbsp;<span style="line-height: 28px;"   >志强8核2.0G.</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >vi ~/.pgpass</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   ><div>127.0.0.1:9999:digoal:postgres:postgres</div><div>172.16.3.39:1999:digoal:postgres:postgres</div></font></span></div><p></p></pre></div><div><br></div><div>测试结果如下 :&nbsp;</div><div><table width="80%"   border="1"   cellpadding="1"   cellspacing="1"   ><tbody><tr><td>&nbsp;测试连接数</td><td>&nbsp;使用pgpool-II(tps)</td><td>&nbsp;直连数据库(tps)</td><td>&nbsp;性能损失(%)</td></tr><tr><td>&nbsp;8</td><td>&nbsp;8850</td><td>&nbsp;44526</td><td>&nbsp;80%</td></tr><tr><td>&nbsp;16</td><td>&nbsp;16896</td><td>&nbsp;98001</td><td>&nbsp;82.7%</td></tr><tr><td>&nbsp;32</td><td>&nbsp;26780</td><td>&nbsp;139980</td><td>&nbsp;80.9%</td></tr><tr><td>&nbsp;64</td><td>&nbsp;28151</td><td>&nbsp;138575</td><td>&nbsp;79.7%</td></tr></table>说明pgpool-II本身处理SQL的TPS极限大概在2.8万左右(CPU耗尽). (我后来加大num_init_children=256, 使用pgbench开启256个连接测试, 性能下降到23232.)</div><div>如果你的架构中只有1个pgpool-II, 那么这个架构的瓶颈很大可能就在pgpool这里. 当然, 如果你的业务不会达到这么大的tps, 又另当别论了, 因为pgpool-II的其他特性还是很不错的, 比如load balance, failover, shared nothing, query cache等.</div><div><br></div><div>详细测试数据如下 :&nbsp;</div><div>直连数据库</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -h 172.16.3.39 -p 1999 -U postgres -f ./test.sql -c 8 -j 8 -T 10 digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 445294</font></div><div><font size="2"   >tps = 44526.661610 (including connections establishing)</font></div><div><font size="2"   >tps = 44574.757044 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.177982 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div></div><div><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -h 172.16.3.39 -p 1999 -U postgres -f ./test.sql -c 16 -j 16 -T 10 digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 16</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 980250</font></div><div><font size="2"   >tps = 98001.949941 (including connections establishing)</font></div><div><font size="2"   >tps = 98102.005783 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.161363 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div></div><div><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -h 172.16.3.39 -p 1999 -U postgres -f ./test.sql -c 32 -j 32 -T 10 digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 32</font></div><div><font size="2"   >number of threads: 32</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 1399989</font></div><div><font size="2"   >tps = 139980.268626 (including connections establishing)</font></div><div><font size="2"   >tps = 140246.063527 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.226628 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -h 172.16.3.39 -p 1999 -U postgres -f ./test.sql -c 64 -j 64 -T 10 digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 64</font></div><div><font size="2"   >number of threads: 64</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 1386700</font></div><div><font size="2"   >tps = 138575.283794 (including connections establishing)</font></div><div><font size="2"   >tps = 139064.044053 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.458081 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div></div><p></p></pre></div><div><br></div><div>通过pgpool-II连接数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -h 127.0.0.1 -p 9999 -U postgres -f ./test.sql -c 8 -j 8 -T 10 digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 88520</font></div><div><font size="2"   >tps = 8850.806911 (including connections establishing)</font></div><div><font size="2"   >tps = 8859.269474 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.696641 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -h 127.0.0.1 -p 9999 -U postgres -f ./test.sql -c 16 -j 16 -T 10 digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 16</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 168990</font></div><div><font size="2"   >tps = 16896.036435 (including connections establishing)</font></div><div><font size="2"   >tps = 16914.751122 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.728099 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -h 127.0.0.1 -p 9999 -U postgres -f ./test.sql -c 32 -j 32 -T 10 digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 32</font></div><div><font size="2"   >number of threads: 32</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 267883</font></div><div><font size="2"   >tps = 26780.814762 (including connections establishing)</font></div><div><font size="2"   >tps = 26807.235961 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.920283 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -h 127.0.0.1 -p 9999 -U postgres -f ./test.sql -c 64 -j 64 -T 10 digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 64</font></div><div><font size="2"   >number of threads: 64</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 281642</font></div><div><font size="2"   >tps = 28151.773807 (including connections establishing)</font></div><div><font size="2"   >tps = 28231.503065 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.676748 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><p></p></pre></div><div><br></div><div>pgpool-II配置 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >listen_addresses = 'localhost'</font></div><div><font size="2"   >port = 9999</font></div><div><font size="2"   >socket_dir = '/tmp'</font></div><div><font size="2"   >pcp_port = 9898</font></div><div><font size="2"   >pcp_socket_dir = '/tmp'</font></div><div><font size="2"   >backend_hostname0 = '172.16.3.39'</font></div><div><font size="2"   >backend_port0 = 1999</font></div><div><font size="2"   >backend_weight0 = 1</font></div><div><font size="2"   >enable_pool_hba = off</font></div><div><font size="2"   >pool_passwd = 'pool_passwd'</font></div><div><font size="2"   >authentication_timeout = 60</font></div><div><font size="2"   >ssl = off</font></div><div><font size="2"   >num_init_children = 256&nbsp;</font></div><div><font size="2"   >max_pool = 4</font></div><div><font size="2"   >child_life_time = 300</font></div><div><font size="2"   >child_max_connections = 0</font></div><div><font size="2"   >connection_life_time = 0</font></div><div><font size="2"   >client_idle_limit = 0</font></div><div><font size="2"   >log_destination = 'stderr'</font></div><div><font size="2"   >print_timestamp = on</font></div><div><font size="2"   >log_connections = off</font></div><div><font size="2"   >log_hostname = off</font></div><div><font size="2"   >log_statement = off</font></div><div><font size="2"   >log_per_node_statement = off</font></div><div><font size="2"   >log_standby_delay = 'none'</font></div><div><font size="2"   >syslog_facility = 'LOCAL0'</font></div><div><font size="2"   >syslog_ident = 'pgpool'</font></div><div><font size="2"   >debug_level = 0</font></div><div><font size="2"   >pid_file_name = '/var/run/pgpool/pgpool.pid'</font></div><div><font size="2"   >logdir = '/tmp'</font></div><div><font size="2"   >connection_cache = on</font></div><div><font size="2"   >reset_query_list = 'ABORT; DISCARD ALL'</font></div><div><font size="2"   >replication_mode = off</font></div><div><font size="2"   >replicate_select = off</font></div><div><font size="2"   >insert_lock = on</font></div><div><font size="2"   >lobj_lock_table = ''</font></div><div><font size="2"   >replication_stop_on_mismatch = off</font></div><div><font size="2"   >failover_if_affected_tuples_mismatch = off</font></div><div><font size="2"   >load_balance_mode = off</font></div><div><font size="2"   >ignore_leading_white_space = on</font></div><div><font size="2"   >white_function_list = ''</font></div><div><font size="2"   >black_function_list = 'nextval,setval'</font></div><div><font size="2"   >master_slave_mode = off</font></div><div><font size="2"   >master_slave_sub_mode = 'stream'</font></div><div><font size="2"   >sr_check_period = 0&nbsp;</font></div><div><font size="2"   >sr_check_user = 'postgres'</font></div><div><font size="2"   >sr_check_password = 'postgres'</font></div><div><font size="2"   >delay_threshold = 0</font></div><div><font size="2"   >follow_master_command = ''</font></div><div><font size="2"   >parallel_mode = off</font></div><div><font size="2"   >pgpool2_hostname = ''</font></div><div><font size="2"   >system_db_hostname &nbsp;= 'localhost'</font></div><div><font size="2"   >system_db_port = 5432</font></div><div><font size="2"   >system_db_dbname = 'pgpool'</font></div><div><font size="2"   >system_db_schema = 'pgpool_catalog'</font></div><div><font size="2"   >system_db_user = 'pgpool'</font></div><div><font size="2"   >system_db_password = ''</font></div><div><font size="2"   >health_check_period = 0</font></div><div><font size="2"   >health_check_timeout = 20</font></div><div><font size="2"   >health_check_user = 'nobody'</font></div><div><font size="2"   >health_check_password = ''</font></div><div><font size="2"   >health_check_max_retries = 0</font></div><div><font size="2"   >health_check_retry_delay = 1</font></div><div><font size="2"   >failover_command = ''</font></div><div><font size="2"   >failback_command = ''</font></div><div><font size="2"   >fail_over_on_backend_error = on</font></div><div><font size="2"   >search_primary_node_timeout = 10</font></div><div><font size="2"   >recovery_user = 'nobody'</font></div><div><font size="2"   >recovery_password = ''</font></div><div><font size="2"   >recovery_1st_stage_command = ''</font></div><div><font size="2"   >recovery_2nd_stage_command = ''</font></div><div><font size="2"   >recovery_timeout = 90</font></div><div><font size="2"   >client_idle_limit_in_recovery = 0</font></div><div><font size="2"   >use_watchdog = off</font></div><div><font size="2"   >trusted_servers = ''</font></div><div><font size="2"   >ping_path = '/bin'</font></div><div><font size="2"   >wd_hostname = ''</font></div><div><font size="2"   >wd_port = 9000</font></div><div><font size="2"   >wd_authkey = ''</font></div><div><font size="2"   >delegate_IP = ''</font></div><div><font size="2"   >ifconfig_path = '/sbin'</font></div><div><font size="2"   >if_up_cmd = 'ifconfig eth0:0 inet $_IP_$ netmask 255.255.255.0'</font></div><div><font size="2"   >if_down_cmd = 'ifconfig eth0:0 down'</font></div><div><font size="2"   >arping_path = '/usr/sbin' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # arping command path</font></div><div><font size="2"   >arping_cmd = 'arping -U $_IP_$ -w 1'</font></div><div><font size="2"   >clear_memqcache_on_escalation = on</font></div><div><font size="2"   >wd_escalation_command = ''</font></div><div><font size="2"   >wd_lifecheck_method = 'heartbeat'</font></div><div><font size="2"   >wd_interval = 10</font></div><div><font size="2"   >wd_heartbeat_port = 9694</font></div><div><font size="2"   >wd_heartbeat_keepalive = 2</font></div><div><font size="2"   >wd_heartbeat_deadtime = 30</font></div><div><font size="2"   >heartbeat_destination0 = 'host0_ip1'</font></div><div><font size="2"   >heartbeat_destination_port0 = 9694&nbsp;</font></div><div><font size="2"   >heartbeat_device0 = ''</font></div><div><font size="2"   >wd_life_point = 3</font></div><div><font size="2"   >wd_lifecheck_query = 'SELECT 1'</font></div><div><font size="2"   >wd_lifecheck_dbname = 'template1'</font></div><div><font size="2"   >wd_lifecheck_user = 'nobody'</font></div><div><font size="2"   >wd_lifecheck_password = ''</font></div><div><font size="2"   >relcache_expire = 0</font></div><div><font size="2"   >relcache_size = 256</font></div><div><font size="2"   >check_temp_table = on</font></div><div><font size="2"   >memory_cache_enabled = off</font></div><div><font size="2"   >memqcache_method = 'shmem'</font></div><div><font size="2"   >memqcache_memcached_host = 'localhost'</font></div><div><font size="2"   >memqcache_memcached_port = 11211</font></div><div><font size="2"   >memqcache_total_size = 67108864</font></div><div><font size="2"   >memqcache_max_num_cache = 1000000</font></div><div><font size="2"   >memqcache_expire = 0</font></div><div><font size="2"   >memqcache_auto_cache_invalidation = on</font></div><div><font size="2"   >memqcache_maxcache = 409600</font></div><div><font size="2"   >memqcache_cache_block_size = 1048576</font></div><div><font size="2"   >memqcache_oiddir = '/var/log/pgpool/oiddir'</font></div><div><font size="2"   >white_memqcache_table_list = ''</font></div><div><font size="2"   >black_memqcache_table_list = ''</font></div><p></p></pre></div><div><br></div><div>其他</div><div><span style="line-height: 28px;"   >将pgbench和pgpool再分开到2台主机, 得到的结果比现在更烂.有兴趣的朋友可以使用3台主机测试一下.</span></div><div><span style="line-height: 28px;"   >我这里附上pgbench, pgpool, postgresql分别在3台主机的一个测试结果.</span></div><div><span style="line-height: 28px;"   >连pgpool-ii测试的结果 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -n -r -h 172.16.3.150 -p 9999 -U postgres -f ./test.sql -c 64 -j 64 -T 10 digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 64</font></div><div><font size="2"   >number of threads: 64</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 227504</font></div><div><font size="2"   >tps = 22738.371402 (including connections establishing)</font></div><div><font size="2"   >tps = 22819.463248 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2.161423 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -n -r -h 172.16.3.150 -p 9999 -U postgres -f ./test.sql -c 128 -j 128 -T 10 digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 128</font></div><div><font size="2"   >number of threads: 128</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 227544</font></div><div><font size="2"   >tps = 22733.673710 (including connections establishing)</font></div><div><font size="2"   >tps = 22844.669605 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 4.857240 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.pgpool.net/docs/latest/pgpool-en.html"   >http://www.pgpool.net/docs/latest/pgpool-en.html</a></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">819183801 - 2015-01-14 9:57:54</h5>
				<div>德哥，pgpool做链接池性能如何？</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 819183801 - 2015-01-14 9:57:54</h5>
				<div style="width:600px;">比pgpool好点</div>
			</div>
			<div id="">
				<h5 id="">819183801 - 2015-01-14 9:59:07</h5>
				<div><P>写错了，我问的是pgbouncer做连接池性能如何<BR><BR></P></div>
			</div>
			<div id="">
				<h5 id="">819183801 - 2015-01-14 9:39:53</h5>
				<div>pgpool做连接池，怎么这么烂</div>
			</div>
			<div id="">
				<h5 id="">Neil - 2014-05-09 0:19:38</h5>
				<div><img src="http://b.bst.126.net/common/portrait/face/preview/face1.gif"  >好文章！非常感谢博主的分享！！</div>
			</div>
	</div>
</div>
</body>
</html>