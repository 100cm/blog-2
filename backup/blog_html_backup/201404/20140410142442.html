<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">nilfs (a continuent snapshot file system) used with PostgreSQL</h2>
	<h5 id="">2014-04-10 14:24:42&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201431022311709/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">NILFS 是NTT开发的一个文件系统, 持续的提供快照, 为误操作提供回滚可能.&nbsp;<div>相比lvm的快照, nilfs更有利于SSD环境. 因为在写频繁的环境中不需要大量的cow.&nbsp;<br><div>简介 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://nilfs.sourceforge.net/en/"   >http://nilfs.sourceforge.net/en/</a><br><wbr><div><div>NILFS is a log-structured file system supporting versioning of the entire file system and continuous snapshotting which allows users to even restore files mistakenly overwritten or destroyed just a few seconds ago.</div><div><br></div><div>NILFS was developed by NTT Laboratories and published as an open-source software under GPL license, and now available as a part of Linux kernel.</div><div><br></div><div>This site provides information and source code of programs related to the NILFS filesystem.</div></div><div>2.6.30以后的内核, 已经包含了nilfs, 用户只需要下载对应的管理包即可.</div><div><p style="margin-top: 1.5em; margin-bottom: 1.5em; line-height: 19.200000762939453px; font-family: 'Ubuntu Beta', Ubuntubeta, Ubuntu, 'ヒラギノ角ゴ Pro W3', 'Hiragino Kaku Gothic Pro', Osaka, 'Meiryo UI', メイリオ, Meiryo, 'Bitstream Vera Sans', 'DejaVu Sans', Tahoma, sans-serif; font-size: medium; background-color: rgb(218, 218, 218);"   ><b style="margin: 0px; padding: 0px;"   >NILFS was merged into the Linux kernel 2.6.30. For the 2.6.30 kernel or later, you only need to download the utility package.</b></p><p style="margin-top: 1.5em; margin-bottom: 1.5em; line-height: 19.200000762939453px; font-family: 'Ubuntu Beta', Ubuntubeta, Ubuntu, 'ヒラギノ角ゴ Pro W3', 'Hiragino Kaku Gothic Pro', Osaka, 'Meiryo UI', メイリオ, Meiryo, 'Bitstream Vera Sans', 'DejaVu Sans', Tahoma, sans-serif; font-size: medium; background-color: rgb(218, 218, 218);"   >Userland utilities&nbsp;&nbsp;<a style="margin: 0px; padding: 0px;" rel="nofollow" href="http://nilfs.sourceforge.net/download/nilfs-utils-2.2.0.tar.bz2"   >nilfs-utils-2.2.0.tar.bz2</a>&nbsp; Apr 8, 2014 JST.<br style="margin: 0px; padding: 0px;"   ><br style="margin: 0px; padding: 0px;"   >Include SET_SUINFO ioctl support which helps to reduce unfruitful segment cleaning, and lssu command is enhanced to help analysys of the ratio of in-used blocks for every segment.<br style="margin: 0px; padding: 0px;"   >For changes from past versions, see&nbsp;<a style="margin: 0px; padding: 0px;" rel="nofollow" href="http://nilfs.sourceforge.net/download/ChangeLog-utils-v2"   >ChangeLog</a>.</p><p style="margin-top: 1.5em; margin-bottom: 1.5em; line-height: 19.200000762939453px; font-family: 'Ubuntu Beta', Ubuntubeta, Ubuntu, 'ヒラギノ角ゴ Pro W3', 'Hiragino Kaku Gothic Pro', Osaka, 'Meiryo UI', メイリオ, Meiryo, 'Bitstream Vera Sans', 'DejaVu Sans', Tahoma, sans-serif; font-size: medium; background-color: rgb(218, 218, 218);"   >The latest version of nilfs-utils 2.0 series is as follows:</p><ul style="margin-top: 1.5em; margin-bottom: 1.5em; margin-left: 0px; font-family: 'Ubuntu Beta', Ubuntubeta, Ubuntu, 'ヒラギノ角ゴ Pro W3', 'Hiragino Kaku Gothic Pro', Osaka, 'Meiryo UI', メイリオ, Meiryo, 'Bitstream Vera Sans', 'DejaVu Sans', Tahoma, sans-serif; font-size: medium; line-height: normal; background-color: rgb(218, 218, 218);"   ><li style="margin: 0.3em 0px 0.3em 25px; padding: 0px;"   ><a style="margin: 0px; padding: 0px;" rel="nofollow" href="http://nilfs.sourceforge.net/download/nilfs-utils-2.0.24.tar.bz2"   >nilfs-utils-2.0.24.tar.bz2</a>&nbsp;Dec 5, 2011 JST.</li></ul></div><div><br></div><div>结合PostgreSQL使用的话, 可以实现异步流复制主备切换后, 老的主库因为XLOG相异导致无法直接切换为备库的场景.</div></div></div><div>老唐写了一篇文章, 详细的介绍这块功能, 请参考.</div><div><a target="_blank" rel="nofollow" href="http://blog.osdba.net/518.html"   >http://blog.osdba.net/518.html</a></div><div>以下内容转载自老唐的blog.</div><div><h2 style="border: 0px; margin: 20px 0px 6px; padding: 0px; vertical-align: baseline; clear: both; font-weight: 400; line-height: 1.5em; font-size: 22px; font-family: Georgia, 'Bitstream Charter', serif;"   >引言：</h2><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >我们知道在使用PostgreSQL的流复制做的高可用方案，即使使用同步的流复制，当主库由于操作系统或硬盘故障宕机时，当我们把备机提升为主库后，原主库通常无法转成备库。这是因为，在流复制的同步过程中，当有大量更新时，主库总是比备库超前一点，当切换后，备库提升为主库后，原主库就无法变成与新主库的Standby，如下图所示：</p><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   ><img title="nilfs (a continuent snapshot file system) used with PostgreSQL - 德哥@Digoal - PostgreSQL"   src="http://blog.osdba.net/pic/old_master_can_not_connect_promoted_slave.png"   alt="old_master_can_not_connect_promoted_slave.png"   style="background-color: transparent; margin: 0px; padding: 0px; vertical-align: baseline;"   ></p><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >如果我们能把原主库回滚一段时间，让其与备库在同一个时间序列上，这时我们就可以把原主库变成新主库的备库了,如下图所示：</p><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   ><img title="nilfs (a continuent snapshot file system) used with PostgreSQL - 德哥@Digoal - PostgreSQL"   src="http://blog.osdba.net/pic/rollback_old_master_can_connect_promoted_slave.png"   alt="rollback_old_master_can_connect_promoted_slave.png"   style="background-color: transparent; margin: 0px; padding: 0px; vertical-align: baseline;"   ></p><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >那么如何把原先的主库回滚到前一阶段呢？这就用到了本文讲的nilfs文件系统。有人说，不用nilfs文件系统，使用Linux下的LVM的快照功能也能实现这个回滚的功能，如每5分钟建一个快照，始终保持两个快照，这样我总是能把主库回滚到5分钟前的状态，这样也能实现这个回滚的功能。但LVM的快照功能会对性能有较大的影响。LVM的快照功能是通过COW（copy on write)来实现的，也就是当打开快照功能后，当写一个数据时，需要把旧数据拷贝到快照的空间中，这时相当于把写放大的一倍。于是有人就想如果每次写入新数据时，都不要覆盖旧数据，写到新的地方去，就象PostgreSQL表本身实现的多版本一样，这样就不能有这么大的性能损耗了。nilfs文件系统就是这样的一种文件系统。nilfs原本是为flash或SSD来设计的文件系统，对于SSD来说，重写代价比较大，所以每次写都写到新的地方，这样就能提高写的性能。这刚好能满足我们的这个需要。</p><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >本文后面就详细讲解如何使用nilfs实现如上的功能。</p><h2 style="border: 0px; margin: 20px 0px 6px; padding: 0px; vertical-align: baseline; clear: both; font-weight: 400; line-height: 1.5em; font-size: 22px; font-family: Georgia, 'Bitstream Charter', serif;"   >1. 本文所使用的测试环境</h2><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   >主库：192.168.56.11，db01
主库：192.168.56.12，db02
</code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >操作系统都是ubuntu12.04 server 数据库都安装在操作系统用户osdba下。</p><h2 style="border: 0px; margin: 20px 0px 6px; padding: 0px; vertical-align: baseline; clear: both; font-weight: 400; line-height: 1.5em; font-size: 22px; font-family: Georgia, 'Bitstream Charter', serif;"   >2. 初始化环境</h2><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >在192.168.56.11和192.168.56.12上都做以下的操作。</p><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >为了使用nilfs，先安装nilfs的相关软件包：</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   >sudo aptitude install nilfs-tools
</code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >我们的数据库数据目录在/home/osdba/pgdata下，我们格式化一个nilfs的文件系统，挂载到/home/osdba/pgdata下：</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   >sudo mkfs -t nilfs2 -L pgdata  /dev/sdb1
sudo mount /dev/sdb1 /home/osdba/pgdata
sudo chown -R osdba:osdba pgdata
sudo chmod 700 pgdata
sudo rm /home/osdba/pgdata/.nilfs
</code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >编译安装PostgreSQL，具体可见：<a style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(116, 51, 153); background-position: initial initial; background-repeat: initial initial;" rel="nofollow" href="http://blog.osdba.net/67.html"   >Linux下的PostgreSQL简单安装手册</a></p><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >安装完后，在.bashrc后面设置了：</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   >export LD_LIBRARY_PATH=/home/osdba/pgsql/lib:<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 128, 128); background-position: initial initial; background-repeat: initial initial;"   >$LD_LIBRARY_PATH</span>
export PATH=/home/osdba/pgsql/bin:<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 128, 128); background-position: initial initial; background-repeat: initial initial;"   >$PATH</span>
export PGDATA=/home/osdba/pgdata
alias pgstart=<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(221, 17, 68); background-position: initial initial; background-repeat: initial initial;"   >'pg_ctl -D $PGDATA start'</span>
alias pgstop=<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(221, 17, 68); background-position: initial initial; background-repeat: initial initial;"   >'pg_ctl -D $PGDATA stop -m fast'</span>
</code></pre><h2 style="border: 0px; margin: 20px 0px 6px; padding: 0px; vertical-align: baseline; clear: both; font-weight: 400; line-height: 1.5em; font-size: 22px; font-family: Georgia, 'Bitstream Charter', serif;"   >3. 建主库</h2><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >执行下面的命令,把数据库建起来：</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   >initdb -k 
</code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >改动/home/osdba/pgdata/postgresql.conf的配置如下：</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   >listen_addresses = <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   >'*'</span></span>
<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   >wal_level = <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   >hot_standby</span></span>
<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   >max_wal_senders = <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   ><span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >5</span></span></span>
<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   >hot_standby = <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   ><span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); font-weight: bold; background-position: initial initial; background-repeat: initial initial;"   >on</span></span></span>
<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   >logging_collector = <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   ><span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); font-weight: bold; background-position: initial initial; background-repeat: initial initial;"   >on</span></span></span>
</code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >改动/home/osdba/pgdata/pg_hba.conf的配置如下：</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   >host    all             all          192.168.56.0/24         md5
host    replication     osdba        192.168.56.0/24         md5
</code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >启动数据库：</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   >pgstart
</code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >在主库上把数据库超级用户osdba，设置一个密码，以便于后面建备库时使用密码连接主库：</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   >osdba@db01:~$ psql postgres
psql (9.3.3)
Type <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(221, 17, 68); background-position: initial initial; background-repeat: initial initial;"   >"help"</span> <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); font-weight: bold; background-position: initial initial; background-repeat: initial initial;"   >for</span> help.

postgres=<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 128, 0); background-position: initial initial; background-repeat: initial initial;"   ># alter user osdba password '123456';</span>
ALTER ROLE
postgres=<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 128, 0); background-position: initial initial; background-repeat: initial initial;"   ># </span>
</code></pre><h2 style="border: 0px; margin: 20px 0px 6px; padding: 0px; vertical-align: baseline; clear: both; font-weight: 400; line-height: 1.5em; font-size: 22px; font-family: Georgia, 'Bitstream Charter', serif;"   >4. 建备库</h2><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >使用pg_basebackup建备库，执行如下命令：</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   >pg_basebackup -h 192.168.56.11 -U osdba -F p -P -x -R -D /home/osdba/pgdata -l osdbabackup
</code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >实际执行过程如下：</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   >osdba@db02:~$ pg_basebackup -h 192.168.56.11 -U osdba -F p -P -x -R -D /home/osdba/pgdata -l osdbabackup
Password: 
36002/36002 kB (100%), 1/1 tablespace
</code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >这样备库就建好了，后面我们配置备库，新建备库的/home/osdba/pgdata/recovery.conf文件，其内容如下：</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   >recovery_target_timeline = <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   >'latest'</span></span>
<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   >standby_mode = <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   >'<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); font-weight: bold; background-position: initial initial; background-repeat: initial initial;"   >on</span>'</span></span>
<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   >primary_conninfo = <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   >'application_name=standby01 user=osdba password=<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >123456</span> host=<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >192.168</span>.<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >56.11</span> port=<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >5432</span> sslmode=disable sslcompression=<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >1</span>'</span></span>
</code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >启动备库：</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   >osdba@db02:~$ pgstart
server starting
osdba@db02:~$ LOG:  redirecting log output to logging collector process
HINT:  Future log output will appear <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); font-weight: bold; background-position: initial initial; background-repeat: initial initial;"   >in</span> directory <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(221, 17, 68); background-position: initial initial; background-repeat: initial initial;"   >"pg_log"</span>.
osdba@db02:~$ psql postgres
psql (9.3.3)
Type <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(221, 17, 68); background-position: initial initial; background-repeat: initial initial;"   >"help"</span> <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); font-weight: bold; background-position: initial initial; background-repeat: initial initial;"   >for</span> help.

postgres=<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 128, 0); background-position: initial initial; background-repeat: initial initial;"   ># select pg_is_in_recovery();</span>
 pg_is_in_recovery 
-------------------
 t
(1 row)
</code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >这样环境就完全搭建好了。</p><h2 style="border: 0px; margin: 20px 0px 6px; padding: 0px; vertical-align: baseline; clear: both; font-weight: 400; line-height: 1.5em; font-size: 22px; font-family: Georgia, 'Bitstream Charter', serif;"   >5. 做测试</h2><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >为了让测试更真实，我们运行pgbench不断的产生一些读写，然后做切换。 先初始化pgbench:</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   >pgbench -i -h 192.168.56.11 postgres
</code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >启动pgbench的压力测试：</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   >pgbench -h 192.168.56.11 -c 10 -T 1800 postgres
</code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >这时我们按192.168.56.11的电源，让其关机，模拟这台机器出故障的情况。同时记录时间。我们关机的时间为：</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   >osdba@osdba-laptop:~$ date
2014年 03月 03日 星期一 23:28:46 CST
</code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >我们然后把备库192.168.56.12提升为主库：</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   >osdba@db02:~$ pg_ctl promote
server promoting
osdba@db02:~$ psql postgres
psql (9.3.3)
Type <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(221, 17, 68); background-position: initial initial; background-repeat: initial initial;"   >"help"</span> <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); font-weight: bold; background-position: initial initial; background-repeat: initial initial;"   >for</span> help.

postgres=<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 128, 0); background-position: initial initial; background-repeat: initial initial;"   ># select pg_is_in_recovery();</span>
 pg_is_in_recovery 
-------------------
 f
(1 row)
</code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >可以看到192.168.56.12已变成主库了。</p><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >这时我们需要把原先的主库192.168.56.11变成192.168.56.12的备库。把192.168.56.11重新开机，并把nilfs再mount上来:</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   >sudo mount /dev/sdb1 /home/osdba/pgdata
</code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >这时我们只需要把192.168.56.11上的文件系统回滚到刚才关机前的一个时间,这个时间的WAL日志已同步到192.168.56.12上就可以了,我们先看nilfs的checkpoint点,nilfs会自动产生很多个checkpoint点,每个checkpoint点都可以转换成快照,然后就可以把快照mount上来。因为nilfs没有提供直接把文件系统回滚到一个快照点的功能，把nilfs回滚到快照点的方法是把快照点mount上来，然后使用rsync把快照的数据同步到当前的文件系统中。</p><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >下面的操作在192.168.56.11机器上： 我们先查看一下我们要回滚到文件系统的哪个checkpoint点，使用nilfs的lscp命令，如下所示：</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   >osdba@db01:~$ lscp
                 CNO        DATE     TIME  MODE  FLG     NBLKINC       ICNT
                   1  2014-03-03 23:06:21   cp    -           11          2
                   2  2014-03-03 23:06:55   cp    -            8          2
......................
......................
                9935  2014-03-03 23:28:40   cp    -           19        806
                9936  2014-03-03 23:28:41   cp    -           19        806
                9937  2014-03-03 23:28:41   cp    -           19        806
.....................
</code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >估计回滚到9935这个checkpoint应该是可以的，执行下面命令把这个checkpoint转换到snapshot</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   >sudo chcp ss /dev/sdb1 9935
</code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >然后挂载上来：</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   >mkdir /home/osdba/snap
sudo mount -t nilfs2 -o ro,cp=9935 /dev/sdb1 /home/osdba/snap
</code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >注意挂载snapshot的方法是"-o ro,cp=9935"，“ro”表示只读，“cp=9935”表示挂载哪个snapshot。</p><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >把快照的数据同步到当前的文件系统中：</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   >rsync -axv --delete /home/osdba/snap/ /home/osdba/pgdata/ 
</code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >把192.168.56.11上的数据库转成备库，建/home/osdba/pgdata/recovery.conf，内容如下：</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   >recovery_target_timeline = <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   >'latest'</span></span>
<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   >standby_mode = <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   >'<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); font-weight: bold; background-position: initial initial; background-repeat: initial initial;"   >on</span>'</span></span>
<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   >primary_conninfo = <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   >'application_name=standby01 user=osdba password=<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >123456</span> host=<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >192.168</span>.<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >56.12</span> port=<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >5432</span> sslmode=disable sslcompression=<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >1</span>'</span></span>
</code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >启动192.168.56.11上的数据库，这样就完成了切换。这时192.168.56.11转换成了192.168.56.12的备库了。我们可以到192.168.56.12上看同步的情况 ：</p><pre style="background-color: rgb(247, 247, 247); border: 1px solid rgb(221, 221, 221); margin-top: 0px; margin-bottom: 24px; padding: 0px 4px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; color: rgb(34, 34, 34); line-height: 1.5; overflow: auto; font-size: 13px; max-width: 800px; white-space: pre-wrap; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   ><code style="border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; font-family: Consolas, Monaco, 'Andale Mono', monospace; line-height: 1.5; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"   >postgres=# <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   ><span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); font-weight: bold; background-position: initial initial; background-repeat: initial initial;"   >select</span> * <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); font-weight: bold; background-position: initial initial; background-repeat: initial initial;"   >from</span> pg_stat_replication;</span>
 pid  | usesysid | usename | application_name |  client_addr  | client_hostname | client_port |         backend_<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; background-position: initial initial; background-repeat: initial initial;"   ><span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); font-weight: bold; background-position: initial initial; background-repeat: initial initial;"   >start</span>         |   state   | sent_
location | write_location | flush_location | replay_location | sync_priority | sync_state 
------+----------+---------+------------------+---------------+-----------------+-------------+-------------------------------+-----------+------
---------+----------------+----------------+-----------------+---------------+------------
 <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >1267</span> |       <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >10</span> | osdba   | standby01        | <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >192.168</span><span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >.56</span><span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >.11</span> |                 |       <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >40594</span> | <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >2014</span>-<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >03</span>-<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >03</span> <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >23</span>:<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >47</span>:<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >59.920158</span>+<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >08</span> | streaming | <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >0</span>/<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >51</span>D
<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >1E70</span>     | <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >0</span>/<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >51</span>D1E70      | <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >0</span>/<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >51</span>D1E70      | <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >0</span>/<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >51</span>D1E70       |             <span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >0</span> | async
(<span style="background-color: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(0, 0, 255); background-position: initial initial; background-repeat: initial initial;"   >1</span> row)
</span></code></pre><p style="border: 0px; margin-top: 3px; margin-bottom: 24px; vertical-align: baseline; font-size: 14px; line-height: 20px; max-width: 540px; color: rgb(51, 51, 51); font-family: Georgia, 'Bitstream Charter', serif;"   >上面的信息可以看出192.168.56.11上的备库已经连接到192.168.56.12上，同步也正常。</p></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="nilfs (a continuent snapshot file system) used with PostgreSQL - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>