<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL custome collect cluster's statstics and analyze for Trend info</h2>
	<h5 id="">2014-04-25 10:48:33&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201432593129778/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><span style="line-height: 28px;"   >为了方便统计数据库的运行状态, 我们可以把数据库的统计信息视图定时做snapshot, 大多数的数据库报告分析工具都是这么做的, 例如oracle 的statspack, PostgreSQL的pg_statsinfo, pg_top等.</span></div><div>其实如果用户不想安装过多的插件, 也可以自定义一些snapshot脚本.</div><div>例如, 下面是一个定时收集数据库状态的脚本, 把pg_stat_database的信息每隔一段时间收集到stat_pg_stat_database表里面.</div><div>用户可以从stat_pg_stat_database取出某时间段的数据库状态, 例如数据库的平均事务响应.</div><div>每120秒收集一次. 如果240秒内日志文件没有变更则从crontab重启脚本.</div><div>注意pg_stat_database中, 只统计了分配事务号的事务, 并未统计未分配事务号的事务. 例如查询事务不分配事务号.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select xact_commit,xact_rollback from pg_stat_database where datname='digoal';</font></div><div><font size="2"   >&nbsp;xact_commit | xact_rollback&nbsp;</font></div><div><font size="2"   >-------------+---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 6874 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;20</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# select 1;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# end;</font></div><div><font size="2"   >COMMIT</font></div><div><font size="2"   >digoal=# select xact_commit,xact_rollback from pg_stat_database where datname='digoal';</font></div><div><font size="2"   >&nbsp;xact_commit | xact_rollback&nbsp;</font></div><div><font size="2"   >-------------+---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 6874 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;20</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>所以, 对于读多, 写少的数据库, 不能真实的反映数据库的tps情况.</div><div><br></div><div>统计脚本如下 :&nbsp;</div><div>$ vi ~/script/stat_db.sh&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#!/bin/bash<br># .bash_profile<br># Get the aliases and functions<br>if [ -f ~/.bashrc ]; then<br>        . ~/.bashrc<br>fi<br># User specific environment and startup programs<br>PATH=$PATH:$HOME/bin<br>export PATH<br><br>export LANG=en_US.utf8<br>export PGHOME=/home/pg93/pgsql<br>export PATH=$PGHOME/bin:$PATH:.<br>export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH<br><br>export PGDATA=/ssd4/pg93/pg_root<br>export PGHOST=$PGDATA<br>export PGPORT=1921<br>export PGUSER=postgres<br>export PGDATABASE=digoal<br><br>LOGFILE=/tmp/stat_db.log<br>SLEEPTIME=120<br>MMIN=$((($SLEEPTIME+120)/60))<br><br>sql="<br>do language plpgsql \$\$<br>declare<br>begin<br>  if (not pg_is_in_recovery()) then<br>    perform 1 from pg_class where relname='stat_pg_stat_database' and relkind='r';<br>    if not found then<br>      create table stat_pg_stat_database as select *,now() as crt_time from pg_stat_database where false;<br>    end if;<br>    insert into stat_pg_stat_database select *,now() from pg_stat_database;<br>  end if;<br>end;<br>\$\$;<br>"<br><br>FILE=`find $LOGFILE -type f -mmin -$MMIN`<br><br>if [ "$FILE" == "$LOGFILE" ]; then<br>  echo -e "this script executed already?"<br>  exit 0<br>fi<br><br><br>echo "execute now."<br><br>for ((i=1;i&gt;0;i=1)) do<br>  date +%F%T &gt;&gt;$LOGFILE 2&gt;&amp;1 <br>  echo "$sql"|psql -f - &gt;&gt;$LOGFILE 2&gt;&amp;1<br>  sleep $SLEEPTIME <br>done</font></div><p></p></pre></div><div><div>更改权限.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >chmod 500 stat_db.sh</font></div><div></div><p></p></pre></div><div>测试一下是否运行正常, 例如是否需要输入密码, 如果需要输入密码的话, 可以调整pg_hba.conf把unix sock连接的认证改为trust.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >$ ./stat_db.sh&nbsp;</font></div><div><font size="2"   >2014-04-2509:20:32</font></div><div><font size="2"   >DO</font></div><p></p></pre></div></div><div>把这个脚本放到定时任务, 如果因某种原因脚本关闭了会自动起来.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >$ crontab -e</font></div><div><font size="2"   >* * * * * /home/lsd_report/script/stat_db.sh &gt;&gt;/tmp/stat_db.log 2&gt;&amp;1</font></div><p></p></pre></div><div>或者可以效仿这篇收集SAR报告的思想, 把数据库的统计信息都收集到一个集中的环境.</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201211354145701"   >http://blog.163.com/digoal@126/blog/static/163877040201211354145701</a></div><div><br></div><div>建议将此类统计信息存放到$PGDATA以外的其他表空间, 假设一个集群有30个数据库, 每2分钟采集一次的话, 一年以后也有几百万条记录, 加上其他的统计信息表的snapshot, 数据增长也是很快的.&nbsp;</div><div><br></div><div>报告的输出举例 :&nbsp;</div><div>1. 根据时间范围, 输出整个集群在这个时间段内的每个采集点的tps.</div><div>PostgreSQL支持窗口函数, 很方便实现类似的统计.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select crt_time,(xact-xact1)/extract(epoch from (crt_time-crt_time1)) as tps from (</font></div><div><font size="2"   >&nbsp; select crt_time,crt_time1,xact,xact1 from (</font></div><div><font size="2"   >&nbsp; &nbsp; select crt_time,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;xact,</font></div><div><font size="2"   ><span>	</span> &nbsp; lag(xact,1) over(order by crt_time) as xact1,&nbsp;</font></div><div><font size="2"   ><span>	</span> &nbsp; lag(crt_time,1) over(order by crt_time) as crt_time1,&nbsp;</font></div><div><font size="2"   ><span>	</span> &nbsp; row_number() over(order by crt_time) as rn from (</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp; select sum(xact_commit+xact_rollback) xact,</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time from stat_pg_stat_database&nbsp;</font></div><div><font size="2"   ><span>		</span> &nbsp; &nbsp;where crt_time between '2014-04-25 09:20:32.922151' and '2014-04-25 10:29:01.192273' group by 2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;) t</font></div><div><font size="2"   >&nbsp; ) t where rn&lt;&gt;1</font></div><div><font size="2"   >) t;</font></div><p></p></pre></div><div>输出举例 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; tps &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------+------------------</font></div><div><font size="2"   >&nbsp;2014-04-25 09:30:01.598892 | 13.8760730500845</font></div><div><font size="2"   >&nbsp;2014-04-25 09:40:01.240861 | 12.8259868348208</font></div><div><font size="2"   >&nbsp;2014-04-25 09:50:01.630746 | 13.0115449896362</font></div><div><font size="2"   >&nbsp;2014-04-25 10:00:01.742404 | 11.6861585781758</font></div><div><font size="2"   >&nbsp;2014-04-25 10:10:01.309044 | 12.3489192127167</font></div><div><font size="2"   >&nbsp;2014-04-25 10:20:01.286129 | &nbsp;13.927198569592</font></div><div><font size="2"   >&nbsp;2014-04-25 10:25:01.482055 | 12.0021615483216</font></div><div><font size="2"   >&nbsp;2014-04-25 10:26:01.674895 | 13.5564296351526</font></div><div><font size="2"   >&nbsp;2014-04-25 10:27:01.662968 | 12.8358848933187</font></div><div><font size="2"   >&nbsp;2014-04-25 10:28:01.818626 | 14.7284566316272</font></div><div><font size="2"   >&nbsp;2014-04-25 10:29:01.192273 | 11.3181526477563</font></div><div><font size="2"   >(11 rows)</font></div><p></p></pre></div><div><br></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201211354145701"   >http://blog.163.com/digoal@126/blog/static/163877040201211354145701</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/functions-window.html"   >http://www.postgresql.org/docs/9.3/static/functions-window.html</a></div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL custome collect clusters statstics and analyze - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>