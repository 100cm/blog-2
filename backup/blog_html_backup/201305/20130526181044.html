<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL backup and recovery - cold backup & recovery</h2>
	<h5 id="">2013-05-26 18:10:44&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201342611530408/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">PostgreSQL 冷备份, 指在数据库关机状态下对数据库的数据文件进行的备份.&nbsp;<div><div>这种备份在生产中并不实用, 一般生产环境都需要保证数据库7*24小时不间断运行.<div>冷备份需要备份的是数据库集群主目录($PGDATA), 表空间目录, 事务日志(pg_xlog)目录. 如果在参数文件中指定了其他目录或文件, 某些也需要备份下来.</div><div>一、在备份前我们先要搞清楚需要备份哪些东西 :&nbsp;</div><div>1. 数据库目录 :&nbsp;</div></div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >主目录所在位置.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pwd</font></div><div><font size="2"   >/pgdata1999</font></div><p></p></pre></div><div>主目录中的文件和文件夹</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; ll</font></div><div><font size="2"   >total 140K</font></div><div><font size="2"   >drwx------ 9 pg93 pg93 4.0K May 25 16:33 base</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 4.0K May 26 11:07 global</font></div><div><font size="2"   >drwxr-xr-x 2 pg93 pg93 4.0K May 26 11:16 pgbak</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 4.0K May 24 14:52 pg_clog</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 4.6K May 25 17:59 pg_hba.conf</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 1.7K May 24 14:30 pg_ident.conf</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 &nbsp;12K May 26 11:06 pg_log</font></div><div><font size="2"   >drwx------ 4 pg93 pg93 4.0K May &nbsp;5 20:26 pg_multixact</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 4.0K May 26 11:06 pg_notify</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 4.0K May &nbsp;5 20:26 pg_serial</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 4.0K May &nbsp;5 20:26 pg_snapshots</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 4.0K May 26 11:06 pg_stat</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 4.0K May 26 11:16 pg_stat_tmp</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 &nbsp;16K May 16 15:30 pg_subtrans</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 4.0K May 26 11:15 pg_tblspc</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 4.0K May &nbsp;5 20:26 pg_twophase</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 &nbsp; &nbsp;4 May &nbsp;5 20:26 PG_VERSION</font></div><div><font size="2"   >lrwxrwxrwx 1 pg93 pg93 &nbsp; 44 May 26 11:15 pg_xlog -&gt; /pgdata/digoal/1921/data03/pg93/1999/pg_xlog</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 &nbsp;20K May 24 09:36 postgresql.conf</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 &nbsp; 27 May 26 11:06 postmaster.opts</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 &nbsp; 64 May 26 11:06 postmaster.pid</font></div><div><font size="2"   >-rw-r--r-- 1 root root 4.7K May &nbsp;8 15:37 recovery.done</font></div><div><font size="2"   >-rw-r--r-- 1 pg93 pg93 2.5K May 24 13:46 root.crt</font></div><div><font size="2"   >-rw-r--r-- 1 pg93 pg93 1.3K May 24 13:37 server.crt</font></div><div><font size="2"   >-r-------- 1 pg93 pg93 1.7K May 24 13:32 server.key</font></div><p></p></pre></div><div>2. 事务日志目录</div><div>本例为$PGDATA/pg_xlog</div><div>3. 表空间目录</div><div>进入表空间目录查看表空间 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd pg_tblspc/</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; ll</font></div><div><font size="2"   >total 0</font></div><div><font size="2"   >lrwxrwxrwx 1 pg93 pg93 47 May 26 11:15 26417 -&gt; /pgdata/digoal/1921/data03/pg93/1999/tbs_digoal</font></div><p></p></pre></div><div>4. 配置文件中指定的在主目录以外的文件或目录</div><div>回到$PGDATA, 查看postgresql.conf中是否配置了$PGDATA以外的其他文件</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; grep -E -i "dir|file" postgresql.conf&nbsp;</font></div><div><div><font size="2"   >#data_directory = 'ConfigDir' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # use data in another directory</font></div><div><font size="2"   >#hba_file = 'ConfigDir/pg_hba.conf' &nbsp; &nbsp; # host-based authentication file</font></div><div><font size="2"   >#ident_file = 'ConfigDir/pg_ident.conf' # ident configuration file</font></div></div><div><div><font size="2"   >ssl_cert_file = 'server.crt' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >ssl_key_file = 'server.key' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >ssl_ca_file = 'root.crt' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >#ssl_crl_file = '' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >#krb_server_keyfile = ''</font></div></div><div><div><font size="2"   >#include_dir = 'conf.d' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # include files ending in '.conf' from</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # directory 'conf.d'</font></div><div><font size="2"   >#include_if_exists = 'exists.conf' &nbsp; &nbsp; &nbsp;# include file only if it exists</font></div><div><font size="2"   >#include = 'special.conf' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # include file</font></div></div><p></p></pre></div><div>以上配置文件中指定的目录或者文件同样需要备份下来.</div><div><br></div><div>二、检查哪些是不需要备份的</div><div>1. pg_xlog中的文件是不是需要全部备份呢?</div><div>在数据库关闭后, 通过控制文件的信息可以知道需要备份哪些文件.</div><div>注意是要在数据库关闭后查看哦, 否则是不准确的.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_controldata&nbsp;</font></div><div><font size="2"   >pg_control version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;937</font></div><div><font size="2"   >Catalog version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 201304271</font></div><div><font size="2"   >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5874470726249995168</font></div><div><font size="2"   >Database cluster state: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shut down</font></div><div><font size="2"   >pg_control last modified: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Sun 26 May 2013 11:28:29 AM CST</font></div><div><font size="2"   >Latest checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E/E9000028</font></div><div><font size="2"   >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;E/E8000028</font></div><div><font size="2"   >Latest checkpoint's REDO location: &nbsp; &nbsp;E/E9000028</font></div><div><font size="2"   >Latest checkpoint's REDO WAL file: &nbsp; &nbsp;000000030000000E000000E9</font></div><div><font size="2"   >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 3</font></div><div><font size="2"   >Latest checkpoint's PrevTimeLineID: &nbsp; 3</font></div><div><font size="2"   >Latest checkpoint's full_page_writes: on</font></div><div><font size="2"   >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/221848459</font></div><div><font size="2"   >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;26418</font></div><div><font size="2"   >Latest checkpoint's NextMultiXactId: &nbsp;1</font></div><div><font size="2"   >Latest checkpoint's NextMultiOffset: &nbsp;0</font></div><div><font size="2"   >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;150439034</font></div><div><font size="2"   >Latest checkpoint's oldestXID's DB: &nbsp; 12815</font></div><div><font size="2"   >Latest checkpoint's oldestActiveXID: &nbsp;0</font></div><div><font size="2"   >Latest checkpoint's oldestMultiXid: &nbsp; 1</font></div><div><font size="2"   >Latest checkpoint's oldestMulti's DB: 1</font></div><div><font size="2"   >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sun 26 May 2013 11:28:29 AM CST</font></div><div><font size="2"   >Fake LSN counter for unlogged rels: &nbsp; 0/1</font></div><div><font size="2"   >Minimum recovery ending location: &nbsp; &nbsp; 0/0</font></div><div><font size="2"   >Min recovery ending loc's timeline: &nbsp; 0</font></div><div><font size="2"   >Backup start location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"   >Backup end location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"   >End-of-backup record required: &nbsp; &nbsp; &nbsp; &nbsp;no</font></div><div><font size="2"   >Current wal_level setting: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hot_standby</font></div><div><font size="2"   >Current max_connections setting: &nbsp; &nbsp; &nbsp;100</font></div><div><font size="2"   >Current max_prepared_xacts setting: &nbsp; 0</font></div><div><font size="2"   >Current max_locks_per_xact setting: &nbsp; 64</font></div><div><font size="2"   >Maximum data alignment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8</font></div><div><font size="2"   >Database block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8192</font></div><div><font size="2"   >Blocks per segment of large relation: 131072</font></div><div><font size="2"   >WAL block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 16384</font></div><div><font size="2"   >Bytes per WAL segment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16777216</font></div><div><font size="2"   >Maximum length of identifiers: &nbsp; &nbsp; &nbsp; &nbsp;64</font></div><div><font size="2"   >Maximum columns in an index: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;32</font></div><div><font size="2"   >Maximum size of a TOAST chunk: &nbsp; &nbsp; &nbsp; &nbsp;1996</font></div><div><font size="2"   >Date/time type storage: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64-bit integers</font></div><div><font size="2"   >Float4 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><div><font size="2"   >Float8 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><div><font size="2"   >Data page checksum version: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><p></p></pre></div><div>我们需要的信息是</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Latest checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E/E9000028&nbsp;</font></div><div><font size="2"   >Latest checkpoint's REDO location: &nbsp; &nbsp;E/E9000028</font></div><div><font size="2"   >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 3</font></div><p></p></pre></div><div>从这3个信息都可以得到1个pg_xlog文件名, 表示这个数据库最后一次成功的checkpoint完成的xlog位置.</div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >000000030000000E000000E9</font></span></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >对于PostgreSQL 9.3直接看这个就要可以了.</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >Latest checkpoint's REDO WAL file: &nbsp; &nbsp;000000030000000E000000E9</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >因此需要备份的pg_xlog内容是从这个文件开始在内以及后面产生的一系列xlog文件.</span></div><div>本例中就只有这个文件, 如下.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd pg_xlog</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; ll -rt</font></div><div><div><font size="2"   >-rw------- 1 pg93 pg93 16M May 26 11:28 000000030000000E000000E9</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 32K May 26 11:28 archive_status</font></div></div><p></p></pre></div><div>2. 不属于数据库系统的文件时不需要的.</div><div>例如在$PGDATA中,&nbsp;</div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >drwxr-xr-x 2 pg93 pg93 4.0K May 26 11:16 pgbak</font></span></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >这个目录不是数据库集群的目录, 所以不需要备份.</span></div><div>另外要提一下, 尽量不要在$PGDATA或者其他数据库目录中放其他文件, 这样会使备份过程变得复杂, 因为还要去<span style="line-height: 22px;"   >过滤这些文件</span><span style="line-height: 22px;"   >.&nbsp;</span></div><div>3. 数据库日志也是不需要备份的, 例如本例中的$PGDATA/pg_log目录.</div><div><br></div><div>三、备份</div><div>1. 准备好备份需要的空间. 可以是本地的也可以是异地的存储.</div><div>查看数据库的大小 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select round(sum(pg_database_size(oid))/1024/1024.0,2)||'MB' from pg_database;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;73.59MB</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>准备好可以放下整个备份的目录</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-33 1999]# df -h</font></div><div><font size="2"   >Filesystem &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Size &nbsp;Used Avail Use% Mounted on</font></div><div><font size="2"   >/dev/cciss/c0d0p1 &nbsp; &nbsp; &nbsp;29G &nbsp; 16G &nbsp; 12G &nbsp;56% /</font></div><div><font size="2"   >tmpfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 6.9G &nbsp; &nbsp; 0 &nbsp;6.9G &nbsp; 0% /dev/shm</font></div><div><font size="2"   >/dev/mapper/vgdata01-lv03</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 135G &nbsp; 25G &nbsp;104G &nbsp;20% /pgdata/digoal/1921/data03</font></div><div><font size="2"   >/dev/mapper/vgdata01-lv04</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 135G &nbsp; 69G &nbsp; 59G &nbsp;54% /pgdata/digoal/1921/data04</font></div><div><font size="2"   >/dev/mapper/vgdata01-lv05</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 135G &nbsp; 85G &nbsp; 44G &nbsp;66% /pgdata/digoal/1921/data05</font></div><div><font size="2"   >/dev/mapper/vgdata01-lv06</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;98G &nbsp;189M &nbsp; 93G &nbsp; 1% /mnt</font></div><div><font size="2"   >/mnt/enc_dir &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 98G &nbsp;189M &nbsp; 93G &nbsp; 1% /mnt/enc_dir</font></div></div><div><div><font size="2"   >[root@db-172-16-3-33 1999]# mkdir -p /pgdata/digoal/1921/data04/pg93backup</font></div><div><font size="2"   >[root@db-172-16-3-33 1999]# chown pg93:pg93 /pgdata/digoal/1921/data04/pg93backup</font></div></div><p></p></pre></div><div>2. 停库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_ctl stop -m fast</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div><p></p></pre></div><div>3. 备份$PGDATA, 排除pg_xlog, pg_log以及不需要备份的目录pgbak.</div><div><pre class="prettyprint"   ><p><font size="2"   >pg93@db-172-16-3-33-&gt; rsync -acvz -L --exclude "pg_xlog" --exclude "pgbak" --exclude "pg_log" $PGDATA /pgdata/digoal/1921/data04/pg93backup/</font></p></pre></div><div>4. 备份pg_xlog</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_controldata |grep checkpoint</font></div><div><font size="2"   >Latest checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E/EB000028</font></div><div><font size="2"   >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;E/EA000028</font></div><div><font size="2"   >Latest checkpoint's REDO location: &nbsp; &nbsp;E/EB000028</font></div><div><font size="2"   >Latest checkpoint's REDO WAL file: &nbsp; &nbsp;000000030000000E000000EB</font></div><div><font size="2"   >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 3</font></div><div><font size="2"   >Latest checkpoint's PrevTimeLineID: &nbsp; 3</font></div><div><font size="2"   >Latest checkpoint's full_page_writes: on</font></div><div><font size="2"   >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/221848464</font></div><div><font size="2"   >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;26421</font></div><div><font size="2"   >Latest checkpoint's NextMultiXactId: &nbsp;1</font></div><div><font size="2"   >Latest checkpoint's NextMultiOffset: &nbsp;0</font></div><div><font size="2"   >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;150439034</font></div><div><font size="2"   >Latest checkpoint's oldestXID's DB: &nbsp; 12815</font></div><div><font size="2"   >Latest checkpoint's oldestActiveXID: &nbsp;0</font></div><div><font size="2"   >Latest checkpoint's oldestMultiXid: &nbsp; 1</font></div><div><font size="2"   >Latest checkpoint's oldestMulti's DB: 1</font></div><div><font size="2"   >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sun 26 May 2013 12:24:37 PM CST</font></div><p></p></pre></div><div>在备份目录中创建pg_xlog目录</div><div><div><pre class="prettyprint"   ><p><font size="2"   >pg93@db-172-16-3-33-&gt; mkdir -p /pgdata/digoal/1921/data04/pg93backup/pgdata1999/pg_xlog</font></p></pre></div><div>修改目录权限</div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; chmod 700 /pgdata/digoal/1921/data04/pg93backup/pgdata1999/pg_xlog</font></div></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >查找需要的pg_xlog文件</span></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; ll -rt $PGDATA/pg_xlog/000000030000000E000000E*</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 16M May 26 12:24 /pgdata1999/pg_xlog/000000030000000E000000EA</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 16M May 26 12:24 /pgdata1999/pg_xlog/000000030000000E000000EB</font></div><p></p></pre></div><div>拷贝需要的pg_xlog文件</div><div><pre class="prettyprint"   ><p><font size="2"   >pg93@db-172-16-3-33-&gt; cp $PGDATA/pg_xlog/000000030000000E000000EB /pgdata/digoal/1921/data04/pg93backup/pgdata1999/pg_xlog/</font></p></pre></div><div>5. 检查备份目录, 是否备份正常</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; ll</font></div><div><font size="2"   >total 112K</font></div><div><font size="2"   >drwx------ 9 pg93 pg93 4.0K May 25 16:33 base</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 4.0K May 26 11:49 global</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 4.0K May 24 14:52 pg_clog</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 4.6K May 25 17:59 pg_hba.conf</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 1.7K May 24 14:30 pg_ident.conf</font></div><div><font size="2"   >drwx------ 4 pg93 pg93 4.0K May &nbsp;5 20:26 pg_multixact</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 4.0K May 26 11:45 pg_notify</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 4.0K May &nbsp;5 20:26 pg_serial</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 4.0K May &nbsp;5 20:26 pg_snapshots</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 4.0K May 26 11:49 pg_stat</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 4.0K May 26 11:49 pg_stat_tmp</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 4.0K May 16 15:30 pg_subtrans</font></div><div><font size="2"   >drwx------ 3 pg93 pg93 4.0K May 26 11:15 pg_tblspc</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 4.0K May &nbsp;5 20:26 pg_twophase</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 &nbsp; &nbsp;4 May &nbsp;5 20:26 PG_VERSION</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 4.0K May 26 12:13 pg_xlog</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 &nbsp;20K May 24 09:36 postgresql.conf</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 &nbsp; 27 May 26 11:45 postmaster.opts</font></div><div><font size="2"   >-rw-r--r-- 1 pg93 pg93 4.7K May &nbsp;8 15:37 recovery.done</font></div><div><font size="2"   >-rw-r--r-- 1 pg93 pg93 2.5K May 24 13:46 root.crt</font></div><div><font size="2"   >-rw-r--r-- 1 pg93 pg93 1.3K May 24 13:37 server.crt</font></div><div><font size="2"   >-r-------- 1 pg93 pg93 1.7K May 24 13:32 server.key</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd pg_tblspc/</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; ll</font></div><div><font size="2"   >total 4.0K</font></div><div><font size="2"   >drwx------ 3 pg93 pg93 4.0K May 26 11:15 26417</font></div><p></p></pre></div><div>6. 其他</div><div>如果表空间目录非常大, 也可以分开进行备份. 在备份$PGDATA时排除pg_tblspc目录即可.</div><div><br></div><div>四, 还原</div><div>还原冷备份前需要注意几个问题 :&nbsp;</div><div>还原环境中的数据库软件需与备份时的版本一致(例如9.0的备份不能还原到9.1上),&nbsp;</div><div>还原环境中的数据库软件的小版本尽量与原始环境一致(例如备份的版本为9.0.4, 还原的版本也尽量使用9.0.4, 版本升级请参考release说明.)</div><div>还原环境中的数据库用到的lib库应该与原始环境一致, 例如原始环境中用到了postgis, 那么还原环境也必须编译同版本的postgis.</div><div>还原环境的数据库软件编译项应该与原始环境保持一致, 可以在原始环境的config.log中找到 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >./configure --prefix=/opt/pgsql9.3beta1 --with-pgport=2099 --with-segsize=8 --with-wal-segsize=64 --with-wal-blocksize=64 --with-perl --with-python --with-openssl --with-pam --with-ldap --with-libxml --with-libxslt --enable-thread-safety</font></p></pre></div><div>或者使用pg_config也可以得到</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_config --configure</font></div><div><font size="2"   >'--prefix=/opt/pgsql9.3' '--with-pgport=1999' '--with-perl' '--with-tcl' '--with-python' '--with-openssl' '--with-pam' '--without-ldap' '--with-libxml' '--with-libxslt' '--enable-thread-safety' '--with-wal-blocksize=16' '--enable-debug'</font></div><p></p></pre></div><div>操作系统平台一致(例如linux的备份不能还原到windows上),&nbsp;</div><div>硬件架构一致(例如x86的备份不能还原到小型机上)</div><div>如果是在本地环境恢复, 那么不需要考虑以上问题, 如果是在其他服务器上恢复, 请按以上要求配置好还原环境后, 再开始恢复.</div><div>1. 把数据库目录, 表空间目录, pg_xlog全部删掉.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; rm -rf *</font></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd /pgdata/digoal/1921/data03/pg93/1999/pg_xlog</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; rm -rf *</font></div></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd /pgdata/digoal/1921/data03/pg93/1999/tbs_digoal</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; rm -rf *</font></div></div><p></p></pre></div><div><br></div><div>2. 还原备份</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cp -r /pgdata/digoal/1921/data04/pg93backup/pgdata1999/* /pgdata1999/</font></div><div></div><p></p></pre></div><div>3. 创建日志目录</div><div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; mkdir pg_log</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; chmod 700 pg_log</font></div></div><div></div><p></p></pre></div></div><div>4. 如果pg_xlog, pg_tblspc使用了软链接.</div><div>也恢复一下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; mv /pgdata1999/pg_tblspc/26425/* /pgdata/digoal/1921/data03/pg93/1999/tbs_digoal/</font></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; rm -rf /pgdata1999/pg_tblspc/26425</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; ln -s /pgdata/digoal/1921/data03/pg93/1999/tbs_digoal /pgdata1999/pg_tblspc/26425</font></div></div><p></p></pre></div><div><br></div><div>5. 启动数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_ctl start</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; LOG: &nbsp;00000: loaded library "pg_stat_statements"</font></div><div><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1296</font></div><p></p></pre></div><div><br></div><div>6. 验证, 抽查几条数据看看.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# \db</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of tablespaces</font></div><div><font size="2"   >&nbsp; &nbsp; Name &nbsp; &nbsp;| &nbsp;Owner &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Location &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------+----------+-------------------------------------------------</font></div><div><font size="2"   >&nbsp;pg_default | postgres |&nbsp;</font></div><div><font size="2"   >&nbsp;pg_global &nbsp;| postgres |&nbsp;</font></div><div><font size="2"   >&nbsp;tbs_digoal | postgres | /pgdata/digoal/1921/data03/pg93/1999/tbs_digoal</font></div><div><font size="2"   >(3 rows)</font></div></div><div><div><font size="2"   >digoal=# select count(*) from test;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;10000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# \d test</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;Table "public.test"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >--------+---------+-----------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; | integer |&nbsp;</font></div><div><font size="2"   >Tablespace: "tbs_digoal"</font></div></div><p></p></pre></div><br></div></div>
	</div>
</div>
</body>
</html>