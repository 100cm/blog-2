<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL backup and recovery - online logical backup & recovery</h2>
	<h5 id="">2013-05-27 9:42:27&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201342661242624/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">PostgreSQL 逻辑备份, 指在线备份数据库数据, DDL以SQL语句形式输出, 数据则可以以SQL语句或者固定分隔符的形式输出.&nbsp;<div>备份时不影响其他用户对备份对象的DML操作.&nbsp;<div>本文主要介绍一下PostgreSQL提供的逻辑备份工具pg_dump, pg_dumpall, 以及数据库的COPY命令.<br><div><div><br></div><div>pg_dump :&nbsp;</div><div>使用pg_dump进行备份时, 其他用户可以同时进行DML(SELECT, UPDATE, DELETE, INSERT)操作, 相互之间没有干扰.&nbsp;<div>一、pg_dump备份程序的逻辑.&nbsp;</div><div>1. pg_dump的一次完整的备份是在一个事务中完成的, 事务隔离级别为serializable 或者 repeatable read. 代码如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ExecuteSqlStatement(fout, "BEGIN");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (fout-&gt;remoteVersion &gt;= 90100)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (serializable_deferrable)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ExecuteSqlStatement(fout,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "SET TRANSACTION ISOLATION LEVEL "</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "SERIALIZABLE, READ ONLY, DEFERRABLE");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ExecuteSqlStatement(fout,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "SET TRANSACTION ISOLATION LEVEL "</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "REPEATABLE READ");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ExecuteSqlStatement(fout,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "SET TRANSACTION ISOLATION LEVEL SERIALIZABLE");</font></div><p></p></pre></div><div>2. pg_dump在备份数据开始前, 需要对进行备份的对象加ACCESS SHARE锁,&nbsp;<span style="line-height: 22px;"   >代码如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >if (tblinfo[i].dobj.dump &amp;&amp; tblinfo[i].relkind == RELKIND_RELATION)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; resetPQExpBuffer(query);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendPQExpBuffer(query,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "LOCK TABLE %s IN ACCESS SHARE MODE",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fmtQualifiedId(fout,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tblinfo[i].dobj.namespace-&gt;dobj.name,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tblinfo[i].dobj.name));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ExecuteSqlStatement(fout, query-&gt;data);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div><div>pg_dump加的锁与DDL冲突, 例如TRUNCATE, DROP, ALTER,&nbsp;VACUUM FULL, 以及以及unqualified LOCK TABLE冲突, 所以备份开始后是不能进行这些操作的. 可以<span style="line-height: 22px;"   >防止备份过程中数据结构改变, 或者数据被物理的删除掉了.&nbsp;</span></div><div><span style="line-height: 22px;"   >正因为pg_dump在备份数据前要对备份对象加锁, 所以为了防止pg_dump无休止的的锁等待, pg_dump支持锁超时.</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (lockWaitTimeout &amp;&amp; fout-&gt;remoteVersion &gt;= 70300)</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Arrange to fail instead of waiting forever for a table lock.</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* NB: this coding assumes that the only queries issued within the</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* following loop are LOCK TABLEs; else the timeout may be undesirably</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* applied to other things too.</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; resetPQExpBuffer(query);</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendPQExpBuffer(query, "SET statement_timeout = ");</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendStringLiteralConn(query, lockWaitTimeout, GetConnection(fout));</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ExecuteSqlStatement(fout, query-&gt;data);</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div><div style="line-height: 22px;"   >例如 :&nbsp;</div><div style="line-height: 22px;"   >SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div></div><div><div><font size="2"   >digoal=# truncate table test;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div></div><div><font size="2"   >-- 不结束事务.</font></div><p></p></pre></div><div style="line-height: 22px;"   >SESSION B :&nbsp;</div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_dump -f ./test.dmp</font></div></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >会一直等SESSION A是否test的锁.</span></div></div><div>从第三个会话可以看出这个等待.</div><div>SESSION C :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select query,waiting from pg_stat_activity;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| waiting&nbsp;</font></div><div><font size="2"   >---------------------------------------------+---------</font></div><div><font size="2"   >&nbsp;LOCK TABLE public.test IN ACCESS SHARE MODE | t &nbsp;-- 这条就是pg_dump发起的.</font></div><div><font size="2"   >&nbsp;truncate table test; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f</font></div><div><font size="2"   >&nbsp;select query,waiting from pg_stat_activity; | f</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div><div>如果不像让pg_dump一直等待下去, 那么可以使用--lock-wait-timeout参数. 例如以下命令, 等待5秒未成功获得锁则退出pg_dump.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_dump -f ./test.dmp --lock-wait-timeout=5s</font></div><div><font size="2"   >pg_dump: [archiver (db)] query failed: ERROR: &nbsp;canceling statement due to statement timeout</font></div><div><font size="2"   >pg_dump: [archiver (db)] query was: LOCK TABLE public.test IN ACCESS SHARE MODE</font></div><p></p></pre></div><div><br></div><div>3. 一切准备就绪后, pg_dump将开始备份数据.</div><div><br></div><div><span style="line-height: 22px;"   >二、备份的内容格式 :&nbsp;</span></div><div>以PostgreSQL 9.3 为例, pg_dump 支持4种格式 :&nbsp;</div><div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;p, plain</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;默认格式, 备份输出为可读的text文本. 还原时在数据库中直接执行备份文本的SQL即可.</div><div><br></div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c, custom</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;可自定义的归档格式, 同时默认开启了数据压缩, 还原时可以调整备份对象的还原顺序, 同时支持选择还原的对象.&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;备份写入到一个文件中. 需要注意文件系统支持的单个文件大小.</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;这个格式必须使用pg_restore命令进行还原.&nbsp;</div><div><br></div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;d, directory</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;目录归档格式, 与custom格式类似, 需要使用pg_restore还原. 但是目录归档格式下会创建一个目录, 然后每个表或者每个大对象对应一个备份输出文件.</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;加上TOC文件名描述备份的详细信息, 这个格式默认支持压缩, 同时支持并行导出.</div><div><br></div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;t, tar</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tar归档格式, 不支持压缩, 同时限制每个表最大不能超过8GB, 同样需要使用pg_restore还原.&nbsp;</div></div><div><br></div><div>三、全库一致性备份举例 :&nbsp;</div><div>注意全库一致性不是集群一致性, 一个PostgreSQL 集群中可以创建多个数据库. pg_dump的全库一致性备份指的是集群中的单个数据库的一致性备份.</div><div>排他选项 :&nbsp;</div><div>使用多次 --exclude-table-data=TABLE 排除不需要备份的表.</div><div>使用多次&nbsp;--exclude-schema=SCHEMA 排除不需要备份的schema.</div><div><div>备份前查看一下备份数据的hash值. 方便还原后对照 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp;| Type &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >--------+----------------+-------+----------</font></div><div><font size="2"   >&nbsp;public | pwd_dictionary | table | postgres</font></div><div><font size="2"   >&nbsp;public | tbl_user &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >(3 rows)</font></div></div><div><div><font size="2"   >digoal=# select sum(hashtext(t.*::text)) from pwd_dictionary t;</font></div><div><font size="2"   >&nbsp; &nbsp; sum &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------</font></div><div><font size="2"   >&nbsp;-719496483</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select sum(hashtext(t.*::text)) from tbl_user t;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; sum &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp;-131178135551</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select sum(hashtext(t.*::text)) from test t;</font></div><div><font size="2"   >&nbsp;sum&nbsp;</font></div><div><font size="2"   >-----</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div></div><div><div style="line-height: 22px;"   >备份命令 :&nbsp;</div><div style="line-height: 22px;"   >备份digoal库, DDL中不包含表空间. 所以恢复时不需要提前创建对应的表空间.</div><pre class="prettyprint"   ><p></p><div><div style="line-height: 22px;"   ><font size="2"   >pg93@db-172-16-3-33-&gt; pg_dump -f ./digoal.dmp -F p -C -E UTF8 --no-tablespaces -h 127.0.0.1 -p 1999 -U postgres digoal</font></div></div><div style="line-height: 22px;"   ></div><p></p></pre><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >删除digoal库.</span></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \c postgres</font></div><div><font size="2"   >You are now connected to database "postgres" as user "postgres".</font></div><div><font size="2"   >postgres=# drop database digoal;</font></div><div><font size="2"   >DROP DATABASE</font></div><p></p></pre></div><div>还原, 直接执行备份SQL即可 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql postgres postgres -f ./digoal.dmp&nbsp;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >CREATE DATABASE</font></div><div><font size="2"   >ALTER DATABASE</font></div><div><font size="2"   >You are now connected to database "digoal" as user "postgres".</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >CREATE SCHEMA</font></div><div><font size="2"   >ALTER SCHEMA</font></div><div><font size="2"   >CREATE EXTENSION</font></div><div><font size="2"   >COMMENT</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >ALTER FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >ALTER FUNCTION</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >CREATE SEQUENCE</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >ALTER SEQUENCE</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >&nbsp;setval&nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SET</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >REVOKE</font></div><div><font size="2"   >REVOKE</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >REVOKE</font></div><div><font size="2"   >REVOKE</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >GRANT</font></div><p></p></pre></div><div>检查还原后的hash值, 与备份前一致.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select sum(hashtext(t.*::text)) from pwd_dictionary t;</font></div><div><font size="2"   >&nbsp; &nbsp; sum &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------</font></div><div><font size="2"   >&nbsp;-719496483</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select sum(hashtext(t.*::text)) from tbl_user t;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; sum &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp;-131178135551</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select sum(hashtext(t.*::text)) from test t;</font></div><div><font size="2"   >&nbsp;sum&nbsp;</font></div><div><font size="2"   >-----</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>四、非全库一致性备份举例 :&nbsp;</div><div>知道pg_dump备份流程后, 可以想象如果数据库庞大, pg_dump备份的时间就会越长, 持锁就会越久. 这对有DDL需求的数据库来说, 可能是无法忍受的.</div><div>因此您可能需要将pg_dump的粒度弄小一点, 不要一次备份整库, 例如同时备份有一致性需求或者依赖关系的数据表.</div><div>举个例子 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   ># 环境变量</font></div><div><font size="2"   >PATH=$PATH:$HOME/bin</font></div><div><font size="2"   >export PATH</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/opt/pgsql</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># 程序变量</font></div><div><font size="2"   >TODAY=`date +%Y%m%d`</font></div><div><font size="2"   >EMAIL="digoal@126.com"</font></div><div><font size="2"   >BAKBASEDIR="/database/pgbak"</font></div><div><font size="2"   >RESERVE_DAY=4</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >HOST="10.10.10.10"</font></div><div><font size="2"   >PORT="1921"</font></div><div><font size="2"   >ROLE="postgres"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># 不一致备份, 按单表进行.</font></div><div><font size="2"   >for DB in `psql -A -q -t -h $HOST -p $PORT -U $ROLE postgres -c "select datname from pg_database where datname not in ('postgres','template0','template1')"`</font></div><div><font size="2"   >do</font></div><div><font size="2"   >echo -e "------`date +%F\ %T`----Start Backup----IP:$HOST PORT:$PORT DBNAME:$DB TYPE:$BAKTYPE TO:$BAKBASEDIR------"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >for TABLE in `psql -A -q -t -h $HOST -p $PORT -U $ROLE $DB -c "select schemaname||'.'||tablename from pg_tables where schemaname !~ '^pg_' and schemaname &lt;&gt;'information_schema'"`</font></div><div><font size="2"   >do</font></div><div><font size="2"   >pg_dump -f ${BAKBASEDIR}/${DB}-${TABLE}-${TODAY}.dmp.ing -F c -t $TABLE --lock-wait-timeout=6000 -E UTF8 -h ${HOST} -p ${PORT} -U ${ROLE} -w ${DB}</font></div><div><font size="2"   >if [ $? -ne 0 ]; then</font></div><div><font size="2"   >echo -e "backup $HOST $PORT $DB $BAKBASEDIR error \n `date +%F%T` \n"|mutt -s "ERROR : PostgreSQL_backup " ${EMAIL}</font></div><div><font size="2"   >echo -e "------`date +%F\ %T`----Error Backup----IP:$HOST PORT:$PORT DBNAME:$DB TABLE:$TABLE TO:$BAKBASEDIR------"</font></div><div><font size="2"   >rm -f ${BAKBASEDIR}/${DB}-${TABLE}-${TODAY}.dmp.ing</font></div><div><font size="2"   >break</font></div><div><font size="2"   >fi</font></div><div><font size="2"   >mv ${BAKBASEDIR}/${DB}-${TABLE}-${TODAY}.dmp.ing ${BAKBASEDIR}/${DB}-${TABLE}-${TODAY}.dmp</font></div><div><font size="2"   >echo -e "------`date +%F\ %T`----Success Backup----IP:$HOST PORT:$PORT DBNAME:$DB TABLE:$TABLE TO:$BAKBASEDIR------"</font></div><div><font size="2"   >done</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >done</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >echo -e "find ${BAKBASEDIR}/${DB}_${TABLE}_${TODAY}.dmp* -daystart -mtime +${RESERVE_DAY} -delete"</font></div><div><font size="2"   >find ${BAKBASEDIR}/${DB}_${TABLE}_${TODAY}.dmp* -daystart -mtime +${RESERVE_DAY} -delete</font></div><p></p></pre></div><div># 这只是个简单的例子, 每次只备份1张表. 多次调用pg_dump.&nbsp;</div><div># 实际使用时需要考虑业务逻辑, 确保业务数据一致性. 例如某一些有关联的表确保放在同一个pg_dump中导出.</div><div>多个-t talbename参数即可.</div><div># 同时需要注意在设计时需要考虑到单表数据量不要太大, 应该考虑分区表. 否则该单表的DDL操作也会加大和pg_dump发生冲突的概率.</div><div># 对于较大的数据库还是建议使用PITR物理增量备份方式. 这个后面会讲到.</div></div><div><br></div><div>五、并行备份举例 :&nbsp;</div><div>并行备份首先需要9.3的pg_dump, 服务端需要9.2以及以上支持pg_export_snapshot的版本.&nbsp;<span style="line-height: 22px;"   >因此并行备份也是一致性备份.&nbsp;</span></div><div>使用并行备份需要n+1个连接, n指-j n指定的并行度, 1 是主连接也就是到处事务状态的连接, 其他连接导入这个事务状态, 进行到处.</div><div>对于9.2以前的版本, 如果要并行备份来提高备份速度, 同时又要数据库一致性, 那么请在备份期间不要对备份对象执行dml操作.</div><div>首先创建1000个测试表, 插入测试数据 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# do language plpgsql $$</font></div><div><font size="2"   >digoal$# declare</font></div><div><font size="2"   >digoal$# &nbsp; v_sql text;</font></div><div><font size="2"   >digoal$# begin</font></div><div><font size="2"   >digoal$# &nbsp; for i in 1..1000 loop</font></div><div><font size="2"   >digoal$# &nbsp; &nbsp; v_sql := 'create table test_'||i||'(id int, info text)';</font></div><div><font size="2"   >digoal$# &nbsp; &nbsp; execute v_sql;</font></div><div><font size="2"   >digoal$# &nbsp; &nbsp; v_sql := 'insert into test_'||i||'(id,info) select generate_series(1,1000),''test''';</font></div><div><font size="2"   >digoal$# &nbsp; &nbsp; execute v_sql;</font></div><div><font size="2"   >digoal$# &nbsp; end loop;</font></div><div><font size="2"   >digoal$# end;</font></div><div><font size="2"   >digoal$# $$;</font></div><p></p></pre></div><div>备份, 并行度为10, 备份到./paralleldmp目录, 这个目录会自动创建 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_dump -f ./paralleldmp -F d -C -E UTF8 --no-tablespaces -j 10 -h 127.0.0.1 -p 1999 -U postgres digoal</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >输出每个表一个文件, 加上一个toc文件.</span></div><div>还原测试 :&nbsp;</div><div>首先删除digoal库.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \c postgres postgres</font></div><div><font size="2"   >You are now connected to database "postgres" as user "postgres".</font></div><div><font size="2"   >postgres=# drop database digoal;</font></div><div><font size="2"   >DROP DATABASE</font></div><p></p></pre></div><div>还原 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_restore -C -h 127.0.0.1 -p 1999 -U postgres -d postgres -j 10 ~/paralleldmp&nbsp;</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >检查是否还原 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp;| Type &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >--------+----------------+-------+----------</font></div><div><font size="2"   >&nbsp;public | pwd_dictionary | table | postgres</font></div><div><font size="2"   >&nbsp;public | tbl_user &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_1 &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_10 &nbsp; &nbsp; &nbsp; &nbsp;| table | postgres</font></div><div><font size="2"   >&nbsp;public | test_100 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_1000 &nbsp; &nbsp; &nbsp;| table | postgres</font></div><div><font size="2"   >&nbsp;public | test_101 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_102 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_103 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_104 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_105 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_106 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_107 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_108 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_109 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_11 &nbsp; &nbsp; &nbsp; &nbsp;| table | postgres</font></div><div><font size="2"   >&nbsp;public | test_110 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_111 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_112 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_113 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_114 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_115 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_116 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_117 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_118 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_119 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_12 &nbsp; &nbsp; &nbsp; &nbsp;| table | postgres</font></div><div><font size="2"   >&nbsp;public | test_120 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_121 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_122 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_123 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_124 &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public | test_125 &nbsp; &nbsp; &nbsp; | table | postgres</font></div></div><div><font size="2"   >... 略</font></div><p></p></pre></div><div><br></div><div>六、TOC文件定制举例 :&nbsp;</div><div>定制TOC文件可以达到调整还原顺序, 开关还原对象的目的.</div><div>首先要创建list. 使用pg_restore的 -l 参数. 从directory或dmp文件中创建list. 下面以目录归档为例, 创建list文件 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_restore ~/paralleldmp -l &gt;./toc.list</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >以下为部分list文件截取 :&nbsp;</span></div><div>分号为注释;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; less toc.list&nbsp;</font></div><div><font size="2"   >;</font></div><div><font size="2"   >; Archive created at Mon May 27 08:58:40 2013</font></div><div><font size="2"   >; &nbsp; &nbsp; dbname: digoal</font></div><div><font size="2"   >; &nbsp; &nbsp; TOC Entries: 2026</font></div><div><font size="2"   >; &nbsp; &nbsp; Compression: -1</font></div><div><font size="2"   >; &nbsp; &nbsp; Dump Version: 1.12-0</font></div><div><font size="2"   >; &nbsp; &nbsp; Format: UNKNOWN</font></div><div><font size="2"   >; &nbsp; &nbsp; Integer: 4 bytes</font></div><div><font size="2"   >; &nbsp; &nbsp; Offset: 8 bytes</font></div><div><font size="2"   >; &nbsp; &nbsp; Dumped from database version: 9.3devel</font></div><div><font size="2"   >; &nbsp; &nbsp; Dumped by pg_dump version: 9.3devel</font></div><div><font size="2"   >;</font></div><div><font size="2"   >;</font></div><div><font size="2"   >; Selected TOC Entries:</font></div><div><font size="2"   >;</font></div><div><font size="2"   >8744; 1262 26431 DATABASE - digoal postgres</font></div><div><font size="2"   >6; 2615 2200 SCHEMA - public postgres</font></div><div><font size="2"   >8745; 0 0 COMMENT - SCHEMA public postgres</font></div><div><font size="2"   >8746; 0 0 ACL - public postgres</font></div><div><font size="2"   >7; 2615 26432 SCHEMA - test postgres</font></div><div><font size="2"   >8747; 0 0 ACL - test postgres</font></div><div><font size="2"   >1176; 3079 12536 EXTENSION - plpgsql&nbsp;</font></div><div><font size="2"   >8748; 0 0 COMMENT - EXTENSION plpgsql&nbsp;</font></div><div><font size="2"   >1189; 1255 26433 FUNCTION public alter_role_pwd(name, text) postgres</font></div><div><font size="2"   >1190; 1255 26434 FUNCTION public create_role(name, text) postgres</font></div><div><font size="2"   >171; 1259 26435 TABLE public pwd_dictionary postgres</font></div><div><font size="2"   >172; 1259 26441 TABLE public tbl_user postgres</font></div><div><font size="2"   >173; 1259 26444 SEQUENCE public tbl_user_id_seq postgres</font></div><div><font size="2"   >8749; 0 0 SEQUENCE OWNED BY public tbl_user_id_seq postgres</font></div><div><font size="2"   >174; 1259 26446 TABLE public test postgres</font></div><div><font size="2"   >176; 1259 26457 TABLE public test_1 postgres</font></div><div><font size="2"   >185; 1259 26511 TABLE public test_10 postgres</font></div><div><font size="2"   >275; 1259 27051 TABLE public test_100 postgres</font></div><div><font size="2"   >1175; 1259 32451 TABLE public test_1000 postgres</font></div><div><font size="2"   >276; 1259 27057 TABLE public test_101 postgres</font></div><div><font size="2"   >277; 1259 27063 TABLE public test_102 postgres</font></div><div><font size="2"   >278; 1259 27069 TABLE public test_103 postgres</font></div><p></p></pre></div><div>截取一行解释一下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >8744; 1262 26431 DATABASE - digoal postgres</font></span></div><div><font size="2"   ><span style="line-height: 22px;"   >8744</span><span style="line-height: 22px;"   >&nbsp;</span>对应 dumpId</font></div><div><font size="2"   ><span style="line-height: 22px;"   >1262&nbsp;</span>对应 catalogId.tableoid</font></div><div><font size="2"   ><span style="line-height: 22px;"   >26431</span>&nbsp;对应 catalogId.oid</font></div><div><font size="2"   >DATABASE 对应 desc</font></div><div><font size="2"   >- 对应 te-&gt;namespace ? te-&gt;namespace : "-"</font></div><div><font size="2"   >digoal 对应 tag</font></div><div><font size="2"   >postgres 对应 owner</font></div><p></p></pre></div><div>以上TOC文件中entry的意思<span style="line-height: 22px;"   >截取自 &nbsp;:&nbsp;</span></div><div>src/bin/pg_dump/pg_backup_archiver.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >void</font></div><div><font size="2"   >PrintTOCSummary(Archive *AHX, RestoreOptions *ropt)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ArchiveHandle *AH = (ArchiveHandle *) AHX;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TocEntry &nbsp; *te;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; OutputContext sav;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *fmtName;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sav = SaveOutput(AH);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (ropt-&gt;filename)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SetOutput(AH, ropt-&gt;filename, 0 /* no compression */ );</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, ";\n; Archive created at %s", ctime(&amp;AH-&gt;createDate));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, "; &nbsp; &nbsp; dbname: %s\n; &nbsp; &nbsp; TOC Entries: %d\n; &nbsp; &nbsp; Compression: %d\n",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;AH-&gt;archdbname, AH-&gt;tocCount, AH-&gt;compression);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; switch (AH-&gt;format)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case archFiles:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fmtName = "FILES";</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case archCustom:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fmtName = "CUSTOM";</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case archTar:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fmtName = "TAR";</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fmtName = "UNKNOWN";</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, "; &nbsp; &nbsp; Dump Version: %d.%d-%d\n", AH-&gt;vmaj, AH-&gt;vmin, AH-&gt;vrev);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, "; &nbsp; &nbsp; Format: %s\n", fmtName);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, "; &nbsp; &nbsp; Integer: %d bytes\n", (int) AH-&gt;intSize);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, "; &nbsp; &nbsp; Offset: %d bytes\n", (int) AH-&gt;offSize);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (AH-&gt;archiveRemoteVersion)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, "; &nbsp; &nbsp; Dumped from database version: %s\n",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;AH-&gt;archiveRemoteVersion);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (AH-&gt;archiveDumpVersion)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, "; &nbsp; &nbsp; Dumped by pg_dump version: %s\n",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;AH-&gt;archiveDumpVersion);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, ";\n;\n; Selected TOC Entries:\n;\n");</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* We should print DATABASE entries whether or not -C was specified */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ropt-&gt;createDB = 1;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; for (te = AH-&gt;toc-&gt;next; te != AH-&gt;toc; te = te-&gt;next)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (ropt-&gt;verbose || _tocEntryRequired(te, ropt, true) != 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, "%d; %u %u %s %s %s %s\n", te-&gt;dumpId,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;te-&gt;catalogId.tableoid, te-&gt;catalogId.oid,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;te-&gt;desc, te-&gt;namespace ? te-&gt;namespace : "-",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;te-&gt;tag, te-&gt;owner);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (ropt-&gt;verbose &amp;&amp; te-&gt;nDeps &gt; 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, ";\tdepends on:");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for (i = 0; i &lt; te-&gt;nDeps; i++)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, " %d", te-&gt;dependencies[i]);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, "\n");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (ropt-&gt;filename)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RestoreOutput(AH, sav);</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>下面调整一下list文件, 根据list文件还原 :&nbsp;</div><div>例如注释test_1的表创建和数据还原.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >;176; 1259 26457 TABLE public test_1 postgres</font></div><div><font size="2"   >;7740; 0 26457 TABLE DATA public test_1 postgres</font></div><p></p></pre></div><div>然后调整顺序</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >275; 1259 27051 TABLE public test_100 postgres</font></div><div><font size="2"   >1175; 1259 32451 TABLE public test_1000 postgres</font></div><p></p></pre></div><div>调整为</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >1175; 1259 32451 TABLE public test_1000 postgres</font></div></div><div><span style="line-height: 22px;"   ><font size="2"   >275; 1259 27051 TABLE public test_100 postgres</font></span></div><p></p></pre></div><div><span style="line-height: 22px;"   >保存toc.list</span></div><div><span style="line-height: 22px;"   >删除数据库digoal:</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >digoal=# \c postgres</font></div><div style="line-height: 22px;"   ><font size="2"   >You are now connected to database "postgres" as user "postgres".</font></div><div style="line-height: 22px;"   ><font size="2"   >postgres=# drop database digoal;</font></div><div style="line-height: 22px;"   ><font size="2"   >DROP DATABASE</font></div><p></p></pre></div><div style="line-height: 22px;"   >还原 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_restore -h 127.0.0.1 -p 1999 -U postgres -C -d postgres -j 10 -L ./toc.list -v ~/paralleldmp &gt;./restore.log 2&gt;&amp;1</font></div><div style="line-height: 22px;"   ></div><p></p></pre><div><span style="line-height: 22px;"   >查看restore.log日志, 注意到顺序调整生效 :&nbsp;</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><font size="2"   >pg_restore: processing item 1175 TABLE test_1000</font></div><div><font size="2"   >pg_restore: creating TABLE test_1000</font></div><div><font size="2"   >pg_restore: processing item 275 TABLE test_100</font></div><div><font size="2"   >pg_restore: creating TABLE test_100</font></div><p></p></pre></div><div style="line-height: 22px;"   >同时进入数据库查看test_1表没有被还原.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \d test_1</font></div><div><font size="2"   >Did not find any relation named "test_1".</font></div><p></p></pre></div></div><div><br></div><div>pg_dumpall :&nbsp;</div><div>pg_dumpall最主要的是用于备份全局数据, 例如表空间的DDL, 创建用户的DDL.</div><div>导出创建用户, 创建表空间的脚本 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_dumpall -g -h 127.0.0.1 -p 1999 -U postgres -f ./global.dmp</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >内容如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cat global.dmp&nbsp;</font></div><div><font size="2"   >--</font></div><div><font size="2"   >-- PostgreSQL database cluster dump</font></div><div><font size="2"   >--</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SET client_encoding = 'UTF8';</font></div><div><font size="2"   >SET standard_conforming_strings = on;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >--</font></div><div><font size="2"   >-- Roles</font></div><div><font size="2"   >--</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE ROLE client1;</font></div><div><font size="2"   >ALTER ROLE client1 WITH NOSUPERUSER INHERIT NOCREATEROLE NOCREATEDB LOGIN NOREPLICATION PASSWORD 'md596bdd340a56d9ab240581edede7a13c6';</font></div><div><font size="2"   >CREATE ROLE digoal;</font></div><div><font size="2"   >ALTER ROLE digoal WITH NOSUPERUSER INHERIT NOCREATEROLE NOCREATEDB LOGIN NOREPLICATION PASSWORD 'md5c08bdd942d14da5ede9d9cef2b17ef9c';</font></div><div><font size="2"   >CREATE ROLE gp1;</font></div><div><font size="2"   >ALTER ROLE gp1 WITH NOSUPERUSER INHERIT NOCREATEROLE NOCREATEDB NOLOGIN NOREPLICATION;</font></div><div><font size="2"   >CREATE ROLE new;</font></div><div><font size="2"   >ALTER ROLE new WITH NOSUPERUSER INHERIT NOCREATEROLE NOCREATEDB NOLOGIN NOREPLICATION PASSWORD 'md54a5ca2a5e9aaed4c781e7d72d7fe945f';</font></div><div><font size="2"   >CREATE ROLE postgres;</font></div><div><font size="2"   >ALTER ROLE postgres WITH SUPERUSER INHERIT CREATEROLE CREATEDB LOGIN REPLICATION PASSWORD 'md53175bce1d3201d16594cebf9d7eb3f9d';</font></div><div><font size="2"   >CREATE ROLE sslcertgroup;</font></div><div><font size="2"   >ALTER ROLE sslcertgroup WITH NOSUPERUSER INHERIT NOCREATEROLE NOCREATEDB NOLOGIN NOREPLICATION;</font></div><div><font size="2"   >CREATE ROLE u4;</font></div><div><font size="2"   >ALTER ROLE u4 WITH NOSUPERUSER INHERIT NOCREATEROLE NOCREATEDB NOLOGIN NOREPLICATION PASSWORD 'md5bbc9d1a9f9e201c9c9d3c153f85771cc';</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >--</font></div><div><font size="2"   >-- Role memberships</font></div><div><font size="2"   >--</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >GRANT gp1 TO client1 GRANTED BY postgres;</font></div><div><font size="2"   >GRANT sslcertgroup TO client1 GRANTED BY postgres;</font></div><div><font size="2"   >GRANT sslcertgroup TO digoal GRANTED BY postgres;</font></div><div><font size="2"   >GRANT sslcertgroup TO postgres GRANTED BY postgres;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >--</font></div><div><font size="2"   >-- Tablespaces</font></div><div><font size="2"   >--</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE TABLESPACE tbs_digoal OWNER postgres LOCATION '/pgdata/digoal/1921/data03/pg93/1999/tbs_digoal';</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >--</font></div><div><font size="2"   >-- Per-Database Role Settings&nbsp;</font></div><div><font size="2"   >--</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >ALTER ROLE postgres IN DATABASE postgres SET work_mem TO '10240MB';</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >--</font></div><div><font size="2"   >-- PostgreSQL database cluster dump complete</font></div><div><font size="2"   >--</font></div><p></p></pre></div><div><br></div><div>COPY :&nbsp;</div><div>除了使用以上命令导出数据库之外, 还可以使用SQL语句导出数据, 亦可结合管道使用.</div><div>例如 :&nbsp;</div><div>导出 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# copy test_10 to '/home/pg93/test_10.dmp' with csv header;</font></div><div><font size="2"   >COPY 1000</font></div><div><font size="2"   >digoal=# select sum(hashtext(t.*::text)) from test_10 t;</font></div><div><font size="2"   >&nbsp; &nbsp; sum &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------</font></div><div><font size="2"   >&nbsp;-432745392</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=# truncate test_10;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div></div><p></p></pre></div><div><div>导入 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# copy test_10 from '/home/pg93/test_10.dmp' with csv header;</font></div><div><font size="2"   >COPY 1000</font></div><div><font size="2"   >digoal=# select sum(hashtext(t.*::text)) from test_10 t;</font></div><div><font size="2"   >&nbsp; &nbsp; sum &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------</font></div><div><font size="2"   >&nbsp;-432745392</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div><br></div><div>[小结]</div><div><div>1. 如果数据库非常庞大, 在做pg_dump备份时, 与ACCESS SHARE锁冲突的SQL将会处于等待状态.</div><div>&nbsp; &nbsp; 等待直到pg_dump结束(锁的释放需要等待顶级事务块结束).&nbsp;</div></div><div>&nbsp; &nbsp; 这个是需要特别注意的.</div><div>2. pg_dump, pg_dumpall, pg_restore命令详解参考 man 文档.</div><div><br></div><div><div><div><div>【参考】</div><div>1.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201241134721101/"   >http://blog.163.com/digoal@126/blog/static/163877040201241134721101/</a></div><div>2.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020123129649342/"   >http://blog.163.com/digoal@126/blog/static/16387704020123129649342/</a></div><div>3.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201337104355272/"   >http://blog.163.com/digoal@126/blog/static/163877040201337104355272/</a></div><div>4.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201322510519547/"   >http://blog.163.com/digoal@126/blog/static/163877040201322510519547/</a></div></div><div><br></div></div></div></div></div></div></div></div>
	</div>
</div>
</body>
</html>