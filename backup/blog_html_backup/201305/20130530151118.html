<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL Daily Maintenance - vacuum</h2>
	<h5 id="">2013-05-30 15:11:18&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201343031118890/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div style="line-height: 22px;"   >PostgreSQL数据库日常维护需要维护哪些东西, 和数据库中的业务类型有莫大的关系.</div><div style="line-height: 22px;"   >PostgreSQL的并发控制简单来说是通过多tuple版本, tuple infomask信息, 事务提交状态以及事务snapshot来实现的.</div><div style="line-height: 22px;"   >当删除一条记录时, 并不是马上回收被删除的空间, 因为有可能其他事务还会用到它, 当更新一条记录是, 老的记录会保留, 然后插入新的记录.</div><div style="line-height: 22px;"   >例如 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# create table tbl(id int, info text);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CREATE TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# insert into tbl values (1, 'test');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INSERT 0 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# delete from tbl;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DELETE 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# insert into tbl values (1, 'test');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INSERT 0 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# delete from tbl;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DELETE 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# insert into tbl values (1, 'test');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INSERT 0 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select ctid,* from tbl;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;ctid &nbsp;| id | info&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-------+----+------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(0,3) | &nbsp;1 | test</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >多次删除插入后, ctid以及变成3了, 因为前面的两条并为删除.&nbsp;</div><div style="line-height: 22px;"   >update也是如此 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# update tbl set info='new';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >UPDATE 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select ctid,* from tbl;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;ctid &nbsp;| id | info&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-------+----+------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(0,4) | &nbsp;1 | new</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >老的tuple在0号block的itemid=3的位置, 新的tuple是后面插入的在0号block的4号槽.</div><div style="line-height: 22px;"   >那么这些垃圾数据是怎么回收的呢, PostgreSQL的vacuum进程就是干这个事情的.</div><div style="line-height: 22px;"   >1. vacuum 数据清理.</div><div style="line-height: 22px;"   >以上测试表在执行vacuum后的输出如下 :&nbsp;</div><div style="line-height: 22px;"   >移除了3个版本.&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# vacuum verbose tbl;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;vacuuming "public.tbl"</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;"tbl": removed 3 row versions in 1 pages</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;"tbl": found 3 removable, 1 nonremovable row versions in 1 out of 1 pages</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >There were 0 unused item pointers.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >0 pages are entirely empty.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;vacuuming "pg_toast.pg_toast_32771"</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;index "pg_toast_32771_index" now contains 0 row versions in 1 pages</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DETAIL: &nbsp;0 index row versions were removed.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >0 index pages have been deleted, 0 are currently reusable.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INFO: &nbsp;"pg_toast_32771": found 0 removable, 0 nonremovable row versions in 0 out of 0 pages</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >There were 0 unused item pointers.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >0 pages are entirely empty.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >VACUUM</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >重新插入数据, 此时那些被垃圾占用的槽位就可以被利用了.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# insert into tbl values (1, 'test');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INSERT 0 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select ctid,* from tbl;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;ctid &nbsp;| id | info&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-------+----+------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(0,1) | &nbsp;1 | test</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(0,4) | &nbsp;1 | new</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(2 rows)</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >一个表有多少条垃圾数据, 多少条活跃数据在系统表<span style="line-height: 22px;"   >pg_stat_all_tables</span><span style="line-height: 22px;"   >中可以查询.</span></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select * from pg_stat_all_tables where relid='tbl'::regclass;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-[ RECORD 1 ]-----+------------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >relid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 32771</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >schemaname &nbsp; &nbsp; &nbsp; &nbsp;| public</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | tbl</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >seq_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 6</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >seq_tup_read &nbsp; &nbsp; &nbsp;| 7</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >idx_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >idx_tup_fetch &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_ins &nbsp; &nbsp; &nbsp; &nbsp; | 4</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_upd &nbsp; &nbsp; &nbsp; &nbsp; | 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_del &nbsp; &nbsp; &nbsp; &nbsp; | 2</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_hot_upd &nbsp; &nbsp; | 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_live_tup &nbsp; &nbsp; &nbsp; &nbsp;| 2</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_dead_tup &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_vacuum &nbsp; &nbsp; &nbsp; | 2013-05-27 17:00:17.094391+08</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_autovacuum &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_analyze &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_autoanalyze &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >vacuum_count &nbsp; &nbsp; &nbsp;| 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autovacuum_count &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >analyze_count &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autoanalyze_count | 0</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >n_live_tup &nbsp; &nbsp; &nbsp; &nbsp;| 2表示有2条活跃数据,&nbsp;</div><div style="line-height: 22px;"   >n_dead_tup &nbsp; &nbsp; &nbsp; &nbsp;| 0表示有0条垃圾数据.</div></div><div style="line-height: 22px;"   >执行以下删除后, 会发生变化 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# delete from tbl;;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DELETE 2</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select * from pg_stat_all_tables where relid='tbl'::regclass;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-[ RECORD 1 ]-----+------------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >relid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 32771</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >schemaname &nbsp; &nbsp; &nbsp; &nbsp;| public</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | tbl</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >seq_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 7</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >seq_tup_read &nbsp; &nbsp; &nbsp;| 9</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >idx_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >idx_tup_fetch &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_ins &nbsp; &nbsp; &nbsp; &nbsp; | 4</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_upd &nbsp; &nbsp; &nbsp; &nbsp; | 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_del &nbsp; &nbsp; &nbsp; &nbsp; | 4</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_hot_upd &nbsp; &nbsp; | 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_live_tup &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_dead_tup &nbsp; &nbsp; &nbsp; &nbsp;| 2</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_vacuum &nbsp; &nbsp; &nbsp; | 2013-05-27 17:00:17.094391+08</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_autovacuum &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_analyze &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_autoanalyze &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >vacuum_count &nbsp; &nbsp; &nbsp;| 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autovacuum_count &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >analyze_count &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autoanalyze_count | 0</font></div><p style="line-height: 22px;"   ></p></pre></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >n_live_tup &nbsp; &nbsp; &nbsp; &nbsp;| 0表示有0条活跃数据,&nbsp;</div><div style="line-height: 22px;"   >n_dead_tup &nbsp; &nbsp; &nbsp; &nbsp;| 2表示有2条垃圾数据.</div></div><div style="line-height: 22px;"   >vacuum 后活跃数据和垃圾数据都会变成0</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# vacuum tbl;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >VACUUM</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select * from pg_stat_all_tables where relid='tbl'::regclass;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-[ RECORD 1 ]-----+------------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >relid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 32771</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >schemaname &nbsp; &nbsp; &nbsp; &nbsp;| public</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | tbl</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >seq_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 7</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >seq_tup_read &nbsp; &nbsp; &nbsp;| 9</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >idx_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >idx_tup_fetch &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_ins &nbsp; &nbsp; &nbsp; &nbsp; | 4</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_upd &nbsp; &nbsp; &nbsp; &nbsp; | 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_del &nbsp; &nbsp; &nbsp; &nbsp; | 4</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_hot_upd &nbsp; &nbsp; | 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_live_tup &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_dead_tup &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_vacuum &nbsp; &nbsp; &nbsp; | 2013-05-27 17:05:17.664564+08</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_autovacuum &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_analyze &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_autoanalyze &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >vacuum_count &nbsp; &nbsp; &nbsp;| 2</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autovacuum_count &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >analyze_count &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autoanalyze_count | 0</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >2. 自动垃圾回收的配置.</div><div style="line-height: 22px;"   >对于一个DML频繁的数据库, 如果靠手动来回收垃圾是不太靠谱的事情, PostgreSQL提供了自动的垃圾回收配置.</div><div style="line-height: 22px;"   >相关参数如下 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#------------------------------------------------------------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ># AUTOVACUUM PARAMETERS</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#------------------------------------------------------------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#autovacuum = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable autovacuum subprocess? &nbsp;'on'</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # requires track_counts to also be on.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#log_autovacuum_min_duration = -1 &nbsp; &nbsp; &nbsp; # -1 disables, 0 logs all actions and</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # their durations, &gt; 0 logs only</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # actions running at least this number</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # of milliseconds.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#autovacuum_max_workers = 3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # max number of autovacuum subprocesses</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#autovacuum_naptime = 1min &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# time between autovacuum runs</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#autovacuum_vacuum_threshold = 50 &nbsp; &nbsp; &nbsp; # min number of row updates before</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # vacuum</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#autovacuum_analyze_threshold = 50 &nbsp; &nbsp; &nbsp;# min number of row updates before</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # analyze</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#autovacuum_vacuum_scale_factor = 0.2 &nbsp; # fraction of table size before vacuum</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#autovacuum_analyze_scale_factor = 0.1 &nbsp;# fraction of table size before analyze</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#autovacuum_freeze_max_age = 200000000 &nbsp;# maximum XID age before forced vacuum</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#autovacuum_vacuum_cost_delay = 20ms &nbsp; &nbsp;# default vacuum cost delay for</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # autovacuum, in milliseconds;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # -1 means use vacuum_cost_delay</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >#autovacuum_vacuum_cost_limit = -1 &nbsp; &nbsp; &nbsp;# default vacuum cost limit for</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # autovacuum, -1 means use</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # vacuum_cost_limit</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ># - Cost-Based Vacuum Delay -<br style="line-height: 19px;"   ><br style="line-height: 19px;"   >#vacuum_cost_delay = 0                  # 0-100 milliseconds<br style="line-height: 19px;"   >#vacuum_cost_page_hit = 1               # 0-10000 credits<br style="line-height: 19px;"   >#vacuum_cost_page_miss = 10             # 0-10000 credits<br style="line-height: 19px;"   >#vacuum_cost_page_dirty = 20            # 0-10000 credits<br style="line-height: 19px;"   >#vacuum_cost_limit = 200                # 1-10000 credits</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >简单介绍一下参数的含义 :&nbsp;</div><div style="line-height: 22px;"   >autovacuum, 自动垃圾回收的开关</div><div style="line-height: 22px;"   >log_autovacuum_min_duration, 在什么情况下记录autovacuum日志输出. 0表示记录所有的autovacuum, -1表示不记录, 其他为时间阈值, 大于或等于这个时长的autovacuum才记录.</div><div style="line-height: 22px;"   >autovacuum_max_workers, 指最大允许多少个autovacuum子进程同时工作. 因为vacuum会带来IO上的开销, 还会消耗内存. 这个就不要配太大了.&nbsp;</div><div style="line-height: 22px;"   >autovacuum_vacuum_threshold表示autovacuum的vacuum操作所需的最小变更数, 如果这个表的update/delete的tuple总数小于这个数字则不会触发autovacuum的vacuum操作.</div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >和autovacuum_analyze_threshold</span><span style="line-height: 22px;"   >表示autovacuum的analyze操作所需的最小变更数, 如果这个表的insert/update/delete的tuple总数小于这个数字则不会触发autovacuum的analyze操作.</span></div><div style="line-height: 22px;"   >autovacuum_vacuum_scale_factor,&nbsp;<span style="line-height: 22px;"   >表示autovacuum的vacuum操作所需的变更量阈值,当</span><span style="line-height: 22px;"   >这个表的update/delete的tuple总数</span><span style="line-height: 22px;"   >大于(pg_class.reltuples*</span><span style="line-height: 22px;"   >autovacuum_vacuum_scale_factor+</span><span style="line-height: 22px;"   >autovacuum_vacuum_threshold)时, 触发vacuum操作.</span></div><div style="line-height: 22px;"   >autovacuum_analyze_scale_factor,&nbsp;<span style="line-height: 22px;"   >表示autovacuum的analyze操作所需的变更量阈值,当</span><span style="line-height: 22px;"   >这个表的INSERT/update/delete的tuple总数</span><span style="line-height: 22px;"   >大于(pg_class.reltuples*</span><span style="line-height: 22px;"   >autovacuum_analyze_scale_factor+</span><span style="line-height: 22px;"   >autovacuum_analyze_threshold)时, 触发analyze操作.</span></div><div style="line-height: 22px;"   >autovacuum_freeze_max_age, 即使autovacuum未开启, 为了防止wrapped xid导致数据不可见, 也会自动触发的vacuum操作. 表示一个表中存在的最早的事务信息到现在为止经历的事务数. 超出则强制vacuum. 防止xid wrapped.</div><div style="line-height: 22px;"   >autovacuum_vacuum_cost_delay, 因为vacuum会带来一定的IO开销, 所以PostgreSQL允许管理员指定当vacuum达到一定的阈值后进入随眠状态, 然后再唤醒继续vacuum. 具体的计算需要配置项Cost-Based Vacuum Delay决定.</div><div style="line-height: 22px;"   >接下来主要举例说明几个<span style="line-height: 22px;"   >threshold参数的作用 :&nbsp;</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >查看当前的阈值 :&nbsp;</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# show autovacuum_analyze_scale_factor;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;autovacuum_analyze_scale_factor&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >---------------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;0.1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# show autovacuum_vacuum_scale_factor;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;autovacuum_vacuum_scale_factor&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >--------------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;0.2</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# show autovacuum_analyze_threshold;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;autovacuum_analyze_threshold&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;50</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# show autovacuum_vacuum_threshold;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;autovacuum_vacuum_threshold&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-----------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;50</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >修改naptime, 以及</span>log_autovacuum_min_duration&nbsp;<span style="line-height: 22px;"   >便于从日志中或者统计表中观察结果 :&nbsp;</span></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pg93@db-172-16-3-33-&gt; vi postgresql.conf&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autovacuum_naptime = 1s</font></div></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >log_autovacuum_min_duration = 0</font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pg93@db-172-16-3-33-&gt; pg_ctl reload</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >server signaled</font></div></div><p style="line-height: 22px;"   ></p></pre></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >创建测试表 :&nbsp;</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# create table tbl(id int, info text);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CREATE TABLE</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >计算插入多少条数据后会触发analyze :&nbsp;</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><div style="line-height: 19px;"   >digoal=# select reltuples from pg_class where relname='tbl';</div><div style="line-height: 19px;"   >&nbsp;reltuples&nbsp;</div><div style="line-height: 19px;"   >-----------</div><div style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</div><div style="line-height: 19px;"   >(1 row)</div></font></span></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autovacuum_analyze_scale_factor*0+autovacuum_analyze_threshold=50;</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >因此插入51条数据后会发生analyze.</div><div style="line-height: 22px;"   >记录pg_stat_all_tables的tbl信息, 注意<span style="line-height: 22px;"   >last_autovacuum , 和</span><span style="line-height: 22px;"   >last_autoanalyze 的值.</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select * from pg_stat_all_tables where relname ='tbl';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-[ RECORD 1 ]-----+-------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >relid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 32798</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >schemaname &nbsp; &nbsp; &nbsp; &nbsp;| public</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | tbl</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >seq_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >seq_tup_read &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >idx_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >idx_tup_fetch &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_ins &nbsp; &nbsp; &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_upd &nbsp; &nbsp; &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_del &nbsp; &nbsp; &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_hot_upd &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_live_tup &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_dead_tup &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_vacuum &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_autovacuum &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_analyze &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_autoanalyze &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >vacuum_count &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autovacuum_count &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >analyze_count &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autoanalyze_count | 0</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >插入50条测试数据 :&nbsp;</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# insert into tbl select generate_series(1,50),'test';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INSERT 0 50</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >stat信息, 未触发analyze.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select * from pg_stat_all_tables where relname ='tbl';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-[ RECORD 1 ]-----+-------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >relid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 32798</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >schemaname &nbsp; &nbsp; &nbsp; &nbsp;| public</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | tbl</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >seq_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >seq_tup_read &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >idx_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >idx_tup_fetch &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_ins &nbsp; &nbsp; &nbsp; &nbsp; | 50</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_upd &nbsp; &nbsp; &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_del &nbsp; &nbsp; &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_hot_upd &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_live_tup &nbsp; &nbsp; &nbsp; &nbsp;| 50</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_dead_tup &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_vacuum &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_autovacuum &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_analyze &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_autoanalyze &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >vacuum_count &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autovacuum_count &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >analyze_count &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autoanalyze_count | 0</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >再插入1条记录.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# insert into tbl select 51,'test';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INSERT 0 1</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >触发analyze :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select * from pg_stat_all_tables where relname ='tbl';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-[ RECORD 1 ]-----+------------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >relid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 32798</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >schemaname &nbsp; &nbsp; &nbsp; &nbsp;| public</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | tbl</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >seq_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >seq_tup_read &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >idx_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >idx_tup_fetch &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_ins &nbsp; &nbsp; &nbsp; &nbsp; | 51</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_upd &nbsp; &nbsp; &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_del &nbsp; &nbsp; &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_hot_upd &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_live_tup &nbsp; &nbsp; &nbsp; &nbsp;| 51</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_dead_tup &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_vacuum &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_autovacuum &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_analyze &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_autoanalyze &nbsp;| 2013-05-27 21:23:49.144829+08</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >vacuum_count &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autovacuum_count &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >analyze_count &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autoanalyze_count | 1</font></div><p style="line-height: 22px;"   ></p></pre></div></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br style="line-height: 22px;"   ></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >计算插入多少条数据后会触发analyze :&nbsp;</span></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select reltuples from pg_class where relname='tbl';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-[ RECORD 1 ]-</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >reltuples | 51</font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autovacuum_analyze_scale_factor*51+autovacuum_analyze_threshold=55.1;</font></div></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >因此插入56条数据后会触发analyze.</div></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# insert into tbl select generate_series(1,55),'test';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INSERT 0 55</font></div></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select * from pg_stat_all_tables where relname ='tbl';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-[ RECORD 1 ]-----+------------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >relid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 32798</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >schemaname &nbsp; &nbsp; &nbsp; &nbsp;| public</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | tbl</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >seq_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >seq_tup_read &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >idx_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >idx_tup_fetch &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_ins &nbsp; &nbsp; &nbsp; &nbsp; | 106</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_upd &nbsp; &nbsp; &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_del &nbsp; &nbsp; &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_hot_upd &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_live_tup &nbsp; &nbsp; &nbsp; &nbsp;| 106</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_dead_tup &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_vacuum &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_autovacuum &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_analyze &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_autoanalyze &nbsp;| 2013-05-27 21:23:49.144829+08</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >vacuum_count &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autovacuum_count &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >analyze_count &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autoanalyze_count | 1</font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select reltuples from pg_class where relname='tbl';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-[ RECORD 1 ]-</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >reltuples | 51</font></div></div><p style="line-height: 22px;"   ></p></pre></div></div><div style="line-height: 22px;"   >再插入1条即可触发analyze.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# insert into tbl select 1,'test';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INSERT 0 1</font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select * from pg_stat_all_tables where relname ='tbl';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-[ RECORD 1 ]-----+-----------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >relid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 32798</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >schemaname &nbsp; &nbsp; &nbsp; &nbsp;| public</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | tbl</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >seq_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >seq_tup_read &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >idx_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >idx_tup_fetch &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_ins &nbsp; &nbsp; &nbsp; &nbsp; | 107</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_upd &nbsp; &nbsp; &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_del &nbsp; &nbsp; &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_hot_upd &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_live_tup &nbsp; &nbsp; &nbsp; &nbsp;| 107</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_dead_tup &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_vacuum &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_autovacuum &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_analyze &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_autoanalyze &nbsp;| 2013-05-27 21:26:25.57402+08</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >vacuum_count &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autovacuum_count &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >analyze_count &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autoanalyze_count | 2</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select reltuples from pg_class where relname='tbl';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-[ RECORD 1 ]--</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >reltuples | 107</font></div></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >计算UPDATE/DELETE多少条数据后会触发vacuum :&nbsp;</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autovacuum_vacuum_scale_factor*107+autovacuum_vacuum_threshold=71.4;</font></div><div style="line-height: 22px;"   ></div><p style="line-height: 22px;"   ></p></pre><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >因此更新或删除共计72条数据后会触发vacuum, 如果中间发生了analyze, 导致pg_class.reltuples发生变化, 这个值也会变化.</span></div></div><div style="line-height: 22px;"   >发生62次insert,update,delete后会触发analyze.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# update tbl set info='new' where id&lt;18;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >UPDATE 35</font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# update tbl set info='new' where id&lt;10;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >UPDATE 19</font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# delete from tbl where id&lt;9;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >DELETE 17</font></div></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >总共发生了35+19+17=71超出62次dml, 发生analyze,&nbsp;</div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >analyze后, pg_class.reltuples变成90,&nbsp;</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select reltuples from pg_class where relname='tbl';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-[ RECORD 1 ]-</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >reltuples | 90</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >所以触发vacuum的值变成了多少呢?</div></span><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autovacuum_vacuum_scale_factor*90+autovacuum_vacuum_threshold=68;</font></span></div><div style="line-height: 22px;"   ></div><p style="line-height: 22px;"   ></p></pre><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >因此只需要69次update/delete即可触发vacuum, 而上一次vacuum到现在已经发生了71次update/delete, 因此会触发vacuum.</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select * from pg_stat_all_tables where relname ='tbl';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-[ RECORD 1 ]-----+------------------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >relid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 32798</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >schemaname &nbsp; &nbsp; &nbsp; &nbsp;| public</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | tbl</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >seq_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 8</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >seq_tup_read &nbsp; &nbsp; &nbsp;| 856</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >idx_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >idx_tup_fetch &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_ins &nbsp; &nbsp; &nbsp; &nbsp; | 107</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_upd &nbsp; &nbsp; &nbsp; &nbsp; | 54</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_del &nbsp; &nbsp; &nbsp; &nbsp; | 17</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_tup_hot_upd &nbsp; &nbsp; | 54</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_live_tup &nbsp; &nbsp; &nbsp; &nbsp;| 90</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >n_dead_tup &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_vacuum &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_autovacuum &nbsp; | 2013-05-27 21:31:23.560703+08</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_analyze &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >last_autoanalyze &nbsp;| 2013-05-27 21:31:22.474655+08</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >vacuum_count &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autovacuum_count &nbsp;| 1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >analyze_count &nbsp; &nbsp; | 0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >autoanalyze_count | 3</font></div><p style="line-height: 22px;"   ></p></pre></div></div><wbr></div>
	</div>
</div>
</body>
</html>