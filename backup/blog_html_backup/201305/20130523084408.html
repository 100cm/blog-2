<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL performance test use ssh tunnel</h2>
	<h5 id="">2013-05-23 8:44:08&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201342383123592/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前面一篇BLOG介绍了PostgreSQL ssl数据加密的性能, 相比未加密性能下降得比较厉害.</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020134229431304/"   >http://blog.163.com/digoal@126/blog/static/16387704020134229431304/</a></div><div>本文将测试一下ssh tunnel加密的性能情况.</div><div>测试机与前面测试一致.</div><div><br></div><div>首先在测试机生成key.</div><div><pre class="prettyprint"   ><p><font size="2"   >pg92@db-172-16-3-39-&gt; ssh-keygen -t rsa</font></p></pre></div><div>一路回车</div><div>生成私钥和公钥.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; cd .ssh</font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; ll</font></div><div><font size="2"   >total 8.0K</font></div><div><font size="2"   >-rw------- 1 postgres postgres 887 May 23 07:32 id_rsa</font></div><div><font size="2"   >-rw-r--r-- 1 postgres postgres 246 May 23 07:32 id_rsa.pub</font></div><p></p></pre></div><div>查看公钥内容, 将要拷贝到数据库服务器上.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; cat id_rsa.pub&nbsp;</font></div><div><font size="2"   >ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAzRL55hHqAqW8HVQ54fpmZ76QEU6NP/dSdu56bNf61+bVDHl/VHEAlQOAdYI3eCsxCv3BmWDiCFR++LjmnRDU7DvTbWZlKk6xmxlWr9uWgHyXbNLrLSqXm8SapS86ATxTxOvT2w5kEgszFtsgoomrCJhQaVLQFU8geL6IXFNr5/g4nK1R2GbQH4eoBFE1a0eh61OhY6+Jq0eaKhZqaLI+Ed8Q5Ce5JjyG8DGhzY2S63OFpncCN2qTjjh8Vhl4SlwF/XZmCZILEfKHUVCi/jKnC068yfcvNl5QmSw2FlELpWFkoxNiCGarSpgXTC3CigBuKmcjR+z7gbHrhbSgnpM4fQ== pg92@db-172-16-3-39.sky-mobi.com</font></div><p></p></pre></div><div>在数据库服务器上写入公钥.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 ~]# su - pg93</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd .ssh</font></div><div><font size="2"   >-bash: cd: .ssh: No such file or directory</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; mkdir .ssh</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd .ssh</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; vi authorized_keys</font></div><p></p></pre></div><div>将172.16.3.39的id_rsa.pub复制过来.</div><div>配置各目录权限 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd ~</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; chmod 700 ~</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; chmod 700 .ssh</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; chmod 400 .ssh/authorized_keys</font></div><p></p></pre></div><div>验证公钥是否生效, 不需要输入密码则正常.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; ssh pg93@172.16.3.33 date</font></div><div><font size="2"   >Thu May 23 07:37:14 CST 2013</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >在测试机上创建连接到数据库服务器的ssh隧道,</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; ssh -o CompressionLevel=9 -p 22 -CqTfnN -L *:17100:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; netstat -anp|grep 17100</font></div><div><font size="2"   >(Not all processes could be identified, non-owned process info</font></div><div><font size="2"   >&nbsp;will not be shown, you would have to be root to see it all.)</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:17100 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;12954/ssh</font></div><p></p></pre></div><div># 测试通过隧道连接数据库是否正常.</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >pg92@db-172-16-3-39-&gt; psql -h 127.0.0.1 -p 17100 -U postgres -d digoal</font></span></div><div><font size="2"   >psql (9.2beta1, server 9.3devel)</font></div><div><font size="2"   >WARNING: psql version 9.2, server version 9.3.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Some psql features might not work.</font></div><div><font size="2"   >SSL connection (cipher: RC4-SHA, bits: 128)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=#&nbsp;</font></div><p></p></pre></div><div>此时数据库服务端开了hostssl认证, 因为用了ssh加密, 所以ssl加密可以关掉.</div><div>修改pg_hba.conf, 强制nossl认证.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; vi pg_hba.conf&nbsp;</font></div><div><font size="2"   >hostnossl &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg_ctl reload</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >再次连接, 无加密.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; psql -h 127.0.0.1 -p 17100 -U postgres -d digoal</font></div><div><font size="2"   >psql (9.2beta1, server 9.3devel)</font></div><div><font size="2"   >WARNING: psql version 9.2, server version 9.3.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Some psql features might not work.</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=#&nbsp;</font></div><p></p></pre></div><div><br></div><div>测试性能,</div><div>与上一篇blog测试openssl配置的环境一致, 好有个对比.</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020134229431304/"   >http://blog.163.com/digoal@126/blog/static/16387704020134229431304/</a></div><div>测试结果 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17100 -U postgres -T 60 -c 16 -j 4 digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 1008287</font></div><div><font size="2"   >tps = 16804.427360 (including connections establishing)</font></div><div><font size="2"   >tps = 16818.105936 (excluding connections establishing)</font></div><p></p></pre></div><div><br></div><div>关闭隧道压缩, 再次测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; ps -ewf|grep ssh</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp; 949 &nbsp; &nbsp; 1 &nbsp;0 Mar21 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 /usr/sbin/sshd</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp;7681 &nbsp; 949 &nbsp;0 May22 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 sshd: root@pts/0&nbsp;</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp;9022 &nbsp; 949 &nbsp;0 May22 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 sshd: root@pts/2&nbsp;</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 12954 &nbsp; &nbsp; 1 18 07:57 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:47 ssh -o CompressionLevel=9 -p 22 -CqTfnN -L *:17100:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 12984 12904 &nbsp;0 08:01 pts/0 &nbsp; &nbsp;00:00:00 grep ssh</font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; kill 12954</font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; ssh -p 22 -o "Compression no" -qTfnN -L *:17100:127.0.0.1:1999 pg93@172.16.3.33</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >测试结果 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17100 -U postgres -T 60 -c 16 -j 4 digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 434617</font></div><div><font size="2"   >tps = 7241.081323 (including connections establishing)</font></div><div><font size="2"   >tps = 7247.051105 (excluding connections establishing)</font></div><p></p></pre></div><div><br></div><div>开启压缩, 并更改加密暗语为blowfish:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; ps -ewf|grep ssh</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp; 949 &nbsp; &nbsp; 1 &nbsp;0 Mar21 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 /usr/sbin/sshd</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp;7681 &nbsp; 949 &nbsp;0 May22 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 sshd: root@pts/0&nbsp;</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp;9022 &nbsp; 949 &nbsp;0 May22 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 sshd: root@pts/2&nbsp;</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 13051 &nbsp; &nbsp; 1 11 08:04 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:18 ssh -p 22 -o Compression=no -qTfnN -L *:17100:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 13067 12904 &nbsp;0 08:06 pts/0 &nbsp; &nbsp;00:00:00 grep ssh</font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; kill 13051</font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; ssh -o CompressionLevel=9 -c blowfish -p 22 -CqTfnN -L *:17100:127.0.0.1:1999 pg93@172.16.3.33</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >测试结果 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17100 -U postgres -T 60 -c 16 -j 4 digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 1039471</font></div><div><font size="2"   >tps = 17323.172100 (including connections establishing)</font></div><div><font size="2"   >tps = 17338.330403 (excluding connections establishing)</font></div><p></p></pre></div><div><br></div><div>[小结]</div><div>1. 使用ssh 隧道比直接在数据库上配置ssl加密要慢, 因为只使用了1个隧道.</div><div>如果建立多个隧道会不会更好一点呢?</div><div><div>建立8个隧道.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ssh -o CompressionLevel=9 -c blowfish -p 22 -CqTfnN -L *:17100:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >ssh -o CompressionLevel=9 -c blowfish -p 22 -CqTfnN -L *:17101:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >ssh -o CompressionLevel=9 -c blowfish -p 22 -CqTfnN -L *:17102:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >ssh -o CompressionLevel=9 -c blowfish -p 22 -CqTfnN -L *:17103:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >ssh -o CompressionLevel=9 -c blowfish -p 22 -CqTfnN -L *:17104:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >ssh -o CompressionLevel=9 -c blowfish -p 22 -CqTfnN -L *:17105:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >ssh -o CompressionLevel=9 -c blowfish -p 22 -CqTfnN -L *:17106:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >ssh -o CompressionLevel=9 -c blowfish -p 22 -CqTfnN -L *:17107:127.0.0.1:1999 pg93@172.16.3.33</font></div><p></p></pre></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >pg92@db-172-16-3-39-&gt; ps -ewf|grep ssh|grep -v grep</font></span></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp; 949 &nbsp; &nbsp; 1 &nbsp;0 Mar21 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 /usr/sbin/sshd</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp;7681 &nbsp; 949 &nbsp;0 May22 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 sshd: root@pts/0&nbsp;</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp;9022 &nbsp; 949 &nbsp;0 May22 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 sshd: root@pts/2&nbsp;</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 13204 &nbsp; &nbsp; 1 &nbsp;0 08:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 ssh -o CompressionLevel=9 -c blowfish -p 22 -CqTfnN -L *:17100:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 13210 &nbsp; &nbsp; 1 &nbsp;0 08:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 ssh -o CompressionLevel=9 -c blowfish -p 22 -CqTfnN -L *:17101:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 13216 &nbsp; &nbsp; 1 &nbsp;0 08:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 ssh -o CompressionLevel=9 -c blowfish -p 22 -CqTfnN -L *:17102:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 13222 &nbsp; &nbsp; 1 &nbsp;0 08:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 ssh -o CompressionLevel=9 -c blowfish -p 22 -CqTfnN -L *:17103:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 13228 &nbsp; &nbsp; 1 &nbsp;0 08:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 ssh -o CompressionLevel=9 -c blowfish -p 22 -CqTfnN -L *:17104:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 13234 &nbsp; &nbsp; 1 &nbsp;0 08:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 ssh -o CompressionLevel=9 -c blowfish -p 22 -CqTfnN -L *:17105:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 13240 &nbsp; &nbsp; 1 &nbsp;0 08:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 ssh -o CompressionLevel=9 -c blowfish -p 22 -CqTfnN -L *:17106:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 13246 &nbsp; &nbsp; 1 &nbsp;0 08:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 ssh -o CompressionLevel=9 -c blowfish -p 22 -CqTfnN -L *:17107:127.0.0.1:1999 pg93@172.16.3.33</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >测试 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17100 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></span></div><div><font size="2"   >pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17101 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17102 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17103 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17104 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17105 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17106 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17107 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; jobs</font></div><div><font size="2"   >[1] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17100 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >[2] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17101 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >[3] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17102 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >[4] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17103 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >[5] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17104 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >[6] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17105 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >[7]- &nbsp;Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17106 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >[8]+ &nbsp;Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17107 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >测试结果 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >pg92@db-172-16-3-39-&gt; transaction type: Custom query</font></span></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 2</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 221246</font></div><div><font size="2"   >tps = 3687.366100 (including connections establishing)</font></div><div><font size="2"   >tps = 3693.281275 (excluding connections establishing)</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 2</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 224540</font></div><div><font size="2"   >tps = 3742.294039 (including connections establishing)</font></div><div><font size="2"   >tps = 3745.909116 (excluding connections establishing)</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 2</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 222014</font></div><div><font size="2"   >tps = 3700.200155 (including connections establishing)</font></div><div><font size="2"   >tps = 3703.833274 (excluding connections establishing)</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 2</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 225675</font></div><div><font size="2"   >tps = 3761.186749 (including connections establishing)</font></div><div><font size="2"   >tps = 3765.324960 (excluding connections establishing)</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 2</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 226583</font></div><div><font size="2"   >tps = 3776.300569 (including connections establishing)</font></div><div><font size="2"   >tps = 3782.679035 (excluding connections establishing)</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 2</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 230229</font></div><div><font size="2"   >tps = 3837.095577 (including connections establishing)</font></div><div><font size="2"   >tps = 3841.695622 (excluding connections establishing)</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 2</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 226564</font></div><div><font size="2"   >tps = 3775.985231 (including connections establishing)</font></div><div><font size="2"   >tps = 3782.328437 (excluding connections establishing)</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 2</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 218551</font></div><div><font size="2"   >tps = 3642.426638 (including connections establishing)</font></div><div><font size="2"   >tps = 3648.666129 (excluding connections establishing)</font></div><p></p></pre></div><div>合计比单个端口代理要高, 但是比直接使用ssl加密要低.</div><div><br></div><div><span style="line-height: 22px;"   >关闭压缩测试, 比以上测试tps略高 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ssh -o "Compression no" -c blowfish -p 22 -qTfnN -L *:17100:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >ssh -o "Compression no" -c blowfish -p 22 -qTfnN -L *:17101:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >ssh -o "Compression no" -c blowfish -p 22 -qTfnN -L *:17102:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >ssh -o "Compression no" -c blowfish -p 22 -qTfnN -L *:17103:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >ssh -o "Compression no" -c blowfish -p 22 -qTfnN -L *:17104:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >ssh -o "Compression no" -c blowfish -p 22 -qTfnN -L *:17105:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >ssh -o "Compression no" -c blowfish -p 22 -qTfnN -L *:17106:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >ssh -o "Compression no" -c blowfish -p 22 -qTfnN -L *:17107:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; &nbsp;ps -ewf|grep ssh|grep -v grep</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp; 949 &nbsp; &nbsp; 1 &nbsp;0 Mar21 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 /usr/sbin/sshd</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp;7681 &nbsp; 949 &nbsp;0 May22 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 sshd: root@pts/0&nbsp;</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp;9022 &nbsp; 949 &nbsp;0 May22 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 sshd: root@pts/2&nbsp;</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 13294 &nbsp; &nbsp; 1 &nbsp;0 08:38 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 ssh -o Compression no -c blowfish -p 22 -qTfnN -L *:17100:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 13300 &nbsp; &nbsp; 1 &nbsp;0 08:38 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 ssh -o Compression no -c blowfish -p 22 -qTfnN -L *:17101:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 13306 &nbsp; &nbsp; 1 &nbsp;0 08:38 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 ssh -o Compression no -c blowfish -p 22 -qTfnN -L *:17102:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 13312 &nbsp; &nbsp; 1 &nbsp;0 08:38 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 ssh -o Compression no -c blowfish -p 22 -qTfnN -L *:17103:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 13318 &nbsp; &nbsp; 1 &nbsp;0 08:38 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 ssh -o Compression no -c blowfish -p 22 -qTfnN -L *:17104:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 13324 &nbsp; &nbsp; 1 &nbsp;0 08:38 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 ssh -o Compression no -c blowfish -p 22 -qTfnN -L *:17105:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 13330 &nbsp; &nbsp; 1 &nbsp;0 08:38 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 ssh -o Compression no -c blowfish -p 22 -qTfnN -L *:17106:127.0.0.1:1999 pg93@172.16.3.33</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 13336 &nbsp; &nbsp; 1 &nbsp;0 08:38 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 ssh -o Compression no -c blowfish -p 22 -qTfnN -L *:17107:127.0.0.1:1999 pg93@172.16.3.33</font></div><p></p></pre></div><div>测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17100 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17101 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17102 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17103 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17104 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17105 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17106 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17107 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; jobs</font></div><div><font size="2"   >[1] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17100 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >[2] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17101 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >[3] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17102 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >[4] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17103 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >[5] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17104 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >[6] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17105 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >[7]- &nbsp;Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17106 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><div><font size="2"   >[8]+ &nbsp;Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -p 17107 -U postgres -T 60 -c 2 -j 1 digoal &amp;</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >测试结果 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 2</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 231898</font></div><div><font size="2"   >tps = 3864.904506 (including connections establishing)</font></div><div><font size="2"   >tps = 3871.202723 (excluding connections establishing)</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 2</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 234955</font></div><div><font size="2"   >tps = 3915.837110 (including connections establishing)</font></div><div><font size="2"   >tps = 3924.836512 (excluding connections establishing)</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 2</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 241359</font></div><div><font size="2"   >tps = 4022.581549 (including connections establishing)</font></div><div><font size="2"   >tps = 4032.042374 (excluding connections establishing)</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 2</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 237272</font></div><div><font size="2"   >tps = 3954.495436 (including connections establishing)</font></div><div><font size="2"   >tps = 3960.789268 (excluding connections establishing)</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 2</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 235486</font></div><div><font size="2"   >tps = 3924.681501 (including connections establishing)</font></div><div><font size="2"   >tps = 3933.783948 (excluding connections establishing)</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 2</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 245445</font></div><div><font size="2"   >tps = 4090.663073 (including connections establishing)</font></div><div><font size="2"   >tps = 4097.263762 (excluding connections establishing)</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 2</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 233128</font></div><div><font size="2"   >tps = 3885.425157 (including connections establishing)</font></div><div><font size="2"   >tps = 3889.080854 (excluding connections establishing)</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 2</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 238585</font></div><div><font size="2"   >tps = 3976.336212 (including connections establishing)</font></div><div><font size="2"   >tps = 3982.943184 (excluding connections establishing)</font></div><p></p></pre></div><div>合计比单个端口代理要高, 但是比直接使用ssl加密要低.</div></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013324103828603/"   >http://blog.163.com/digoal@126/blog/static/1638770402013324103828603/</a></div><div>2.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020134229431304/"   >http://blog.163.com/digoal@126/blog/static/16387704020134229431304/</a></div><div>3.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201342233131835/"   >http://blog.163.com/digoal@126/blog/static/163877040201342233131835/</a></div><div>4. man ssh</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp;-c cipher_spec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Selects the cipher specification for encrypting the session.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Protocol version 1 allows specification of a single cipher. &nbsp;The supported values are “3des”, “blowfish”,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;and “des”. &nbsp;3des (triple-des) is an encrypt-decrypt-encrypt triple with three different keys. &nbsp;It is</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;believed to be secure. &nbsp;blowfish is a fast block cipher; it appears very secure and is much faster than</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3des. &nbsp;des is only supported in the ssh client for interoperability with legacy protocol 1 implementa-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tions that do not support the 3des cipher. &nbsp;Its use is strongly discouraged due to cryptographic weak-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nesses. &nbsp;The default is “3des”.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;For protocol version 2, cipher_spec is a comma-separated list of ciphers listed in order of preference.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;The supported ciphers are: 3des-cbc, aes128-cbc, aes192-cbc, aes256-cbc, aes128-ctr, aes192-ctr,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;aes256-ctr, arcfour128, arcfour256, arcfour, blowfish-cbc, and cast128-cbc. &nbsp;The default is:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;aes128-cbc,3des-cbc,blowfish-cbc,cast128-cbc,arcfour128,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;arcfour256,arcfour,aes192-cbc,aes256-cbc,aes128-ctr,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;aes192-ctr,aes256-ctr</font></div><p></p></pre></div><div><br></div><wbr></div>
	</div>
</div>
</body>
</html>