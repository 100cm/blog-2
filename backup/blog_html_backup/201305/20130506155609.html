<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 add lock_timeout parameter</h2>
	<h5 id="">2013-05-06 15:56:09&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013463425483/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>Add configuration variable lock_timeout to limit lock wait duration</div><div><br></div><div>[测试]</div><div>1. 隐锁</div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >digoal=# begin;</font></span></div><div><div><font size="2"   >BEGIN</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# insert into test values (1, 'info');</font></div><div><font size="2"   >INSERT 0 1</font></div></div><p></p></pre></div><div><br></div><div>SESSION B :&nbsp;</div><div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# set client_min_messages='notice';</font></div><div style="line-height: 22px;"   ><font size="2"   >SET</font></div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# set lock_timeout='1s';</font></div><div style="line-height: 22px;"   ><font size="2"   >SET</font></div></div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# \set VERBOSITY verbose</font></div></div><div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# truncate test;</font></div><div><font size="2"   >-- 1秒后</font></div><div><font size="2"   >ERROR: &nbsp;57014: canceling statement due to lock timeout</font></div><div><font size="2"   >LOCATION: &nbsp;ProcessInterrupts, postgres.c:2899</font></div></div><p></p></pre></div></div></div><div><br></div><div>2. 显锁</div><div>接上例,&nbsp;</div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# lock table test in exclusive mode;</font></div><div><font size="2"   >-- 1秒后</font></div><div><font size="2"   >ERROR: &nbsp;57014: canceling statement due to lock timeout</font></div><div><font size="2"   >LOCATION: &nbsp;ProcessInterrupts, postgres.c:2899</font></div><p></p></pre></div><div><br></div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# update test set info='test' where id=1;</font></div><div><font size="2"   >UPDATE 1</font></div><p></p></pre></div><div><br></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# select * from test where id=1 for update;</font></div><div><font size="2"   >ERROR: &nbsp;57014: canceling statement due to lock timeout</font></div><div><font size="2"   >LOCATION: &nbsp;ProcessInterrupts, postgres.c:2899</font></div><div><font size="2"   >-- nowait不会等1秒.</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# select * from test where id=1 for update nowait;</font></div><div><font size="2"   >ERROR: &nbsp;55P03: could not obtain lock on row in relation "test"</font></div><div><font size="2"   >LOCATION: &nbsp;heap_lock_tuple, heapam.c:4269</font></div><p></p></pre></div><div><br></div><div>[其他]</div><div>1. statement_timeout会比lock_timeout先触发, 所以配置lock_timeout大于等于statement_timeout是没有意义的.</div><div>2. 不建议将lock_timeout配置在postgresql.conf中, 因为这样会对所有会话生效. 例如备份也很有可能失败.</div><div>3. lock_timeout对隐锁和显锁都会生效.</div><div>4. 行锁级别信息</div><div>src/include/access/heapam.h</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* Possible lock modes for a tuple.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >typedef enum LockTupleMode</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* SELECT FOR KEY SHARE */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LockTupleKeyShare,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* SELECT FOR SHARE */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LockTupleShare,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* SELECT FOR NO KEY UPDATE, and UPDATEs that don't modify key columns */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LockTupleNoKeyExclusive,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* SELECT FOR UPDATE, UPDATEs that modify key columns, and DELETE */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LockTupleExclusive</font></div><div><font size="2"   >} LockTupleMode;</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=d43837d03067487560af481474ae985df894f786"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=d43837d03067487560af481474ae985df894f786</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/runtime-config-client.html#GUC-LOCK-TIMEOUT"   >http://www.postgresql.org/docs/devel/static/runtime-config-client.html#GUC-LOCK-TIMEOUT</a></div><div>lock_timeout (integer)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Abort any statement that waits longer than the specified number of milliseconds while attempting to acquire a lock on a table, index, row, or other database object. The time limit applies separately to each lock acquisition attempt. The limit applies both to explicit locking requests (such as LOCK TABLE, or SELECT FOR UPDATE without NOWAIT) and to implicitly-acquired locks. If log_min_error_statement is set to ERROR or lower, the statement that timed out will be logged. A value of zero (the default) turns this off.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Unlike statement_timeout, this timeout can only occur while waiting for locks. Note that if statement_timeout is nonzero, it is rather pointless to set lock_timeout to the same or larger value, since the statement timeout would always trigger first.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Setting lock_timeout in postgresql.conf is not recommended because it would affect all sessions.</font></div><p></p></pre></div><div>3.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020131172754749/"   >http://blog.163.com/digoal@126/blog/static/16387704020131172754749/</a></div><div>4.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020130312271679/"   >http://blog.163.com/digoal@126/blog/static/16387704020130312271679/</a></div><div>5.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201291575523922/"   >http://blog.163.com/digoal@126/blog/static/163877040201291575523922/</a></div><div>6.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201210134586363/"   >http://blog.163.com/digoal@126/blog/static/163877040201210134586363/</a></div></div>
	</div>
</div>
</body>
</html>