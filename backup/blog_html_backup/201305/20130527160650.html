<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL backup and recovery - online backup & Point-In-Time-Recovery</h2>
	<h5 id="">2013-05-27 16:06:50&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201342795113116/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">前面介绍的冷备份, 以及逻辑备份都是一个时间点的全量备份, 没有增量的概念.&nbsp;<div>如果数据库在运行过程中发生故障, 使用逻辑备份只能将数据库还原到备份时刻, 无法恢复到故障发生前的那个时刻.</div><div>又或者在使用过程中由于误操作修改或删除了重要数据, 需要还原到误操作前的那个时刻怎么办呢?<wbr></div><div><span style="line-height: 22px;"   >使用冷备份加上有效的归档文件可以实现任意时间点的恢复. 但是冷备份需要停库操作, 所以实用性不大.</span></div><div><span style="line-height: 22px;"   >本文要介绍的是在线的数据库文件备份, 弥补了冷备份的缺陷, 同时又支持基于时间点的恢复.</span></div><div><span style="line-height: 22px;"   >postgresql.conf</span><span style="line-height: 22px;"   >参数配置 :&nbsp;</span></div><div>1. wal日志级别 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >wal_level=archive 或 hot_standby</font></p></pre></div><div>查看当前数据库的wal level :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_controldata |grep wal_level</font></div><div><font size="2"   >Current wal_level setting: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hot_standby</font></div><p></p></pre></div><div>如果结果不为hot_standby或者archive, 那么需要调整一下postgresql.conf. 并重启数据库.</div><div>2. 归档模式 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; archive_mode = on</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >&nbsp; &nbsp; 如果原来是off的, 调整成on, 那么需要重启数据库.</span></div><div>3. 归档命令 :&nbsp;</div><div>首先要创建用于存放wal归档文件目录, 数据库启动用户需要写权限.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-33 postgresql-9.3beta1]# mkdir -p /pgdata/digoal/1921/data04/pg93archdir</font></div><div><font size="2"   >[root@db-172-16-3-33 postgresql-9.3beta1]# chown pg93:pg93 /pgdata/digoal/1921/data04/pg93archdir</font></div></div><div><font size="2"   >[root@db-172-16-3-33 postgresql-9.3beta1]# chmod 700 /pgdata/digoal/1921/data04/pg93archdir</font></div><p></p></pre></div><div>然后在$PGDATA中创建归档脚本</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-33 postgresql-9.3beta1]# su - pg93</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cat archive.sh&nbsp;</font></div><div><font size="2"   ><span style="line-height: 19px;"   >#!/bin/bash<br><br>export LANG=en_US.utf8<br>export PGHOME=/opt/pgsql9.3<br>export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH<br>export DATE=`date +"%Y%m%d"`<br>export PATH=$PGHOME/bin:$PATH:.<br><br>BASEDIR="/pgdata/digoal/1921/data04/pg93archdir"<br><br>if [ ! -d $BASEDIR/$DATE ]; then<br>  mkdir -p $BASEDIR/$DATE<br>  if [ ! -d $BASEDIR/$DATE ]; then<br>    echo "error mkdir -p $BASEDIR/$DATE"<br>    exit 1<br>  fi<br>fi<br><br>cp $1 $BASEDIR/$DATE/$2<br>if [ $? -eq 0 ]; then<br>  exit 0<br>else<br>  echo -e "cp $1 $BASEDIR/$DATE/$2 error"<br>  exit 1<br>fi<br><br>echo -e "backup failed"<br>exit 1</span></font></div></div><p></p></pre></div><div>给archive.sh添加可执行权限 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >chmod 700 archive.sh</font></p></pre></div><div>配置postgresql.conf中的归档命令 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >archive_command = 'archive.sh %p %f'</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >修改完后reload配置文件即可</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg_ctl reload</font></div><div></div><p></p></pre></div><div><span style="line-height: 22px;"   >配置完后检查一下归档是否正常 :&nbsp;</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_switch_xlog();</font></div><div><font size="2"   >&nbsp;pg_switch_xlog&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;F/2095D8</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select pg_switch_xlog();</font></div><div><font size="2"   >&nbsp;pg_switch_xlog&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;F/1000000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_switch_xlog();</font></div><div><font size="2"   >&nbsp;pg_switch_xlog&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;F/10000E8</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >^[[ACHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_switch_xlog();</font></div><div><font size="2"   >&nbsp;pg_switch_xlog&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;F/20000E8</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="line-height: 22px;"   >查看归档文件 :&nbsp;</div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd /pgdata/digoal/1921/data04/pg93archdir</font></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; ll</font></div><div><font size="2"   >total 4.0K</font></div><div><font size="2"   >drwx------ 2 pg93 pg93 4.0K May 27 10:56 20130527</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd 20130527/</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; ll</font></div><div><font size="2"   >total 48M</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 16M May 27 10:56 000000030000000F00000000</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 16M May 27 10:56 000000030000000F00000001</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 16M May 27 10:56 000000030000000F00000002</font></div></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"   >具备了这些前提条件之后, 就可以进行在线备份了.</span></div><div><span style="line-height: 22px;"   >在线备份可以使用拷贝, rsync, 或者pg_basebackup命令进行.</span></div><div><span style="line-height: 22px;"   >方法一, 拷贝</span></div><div><span style="line-height: 22px;"   >首先在数据库中以超级用户执行如下命令 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select pg_start_backup(now()::text);</font></div><div><font size="2"   >&nbsp;pg_start_backup&nbsp;</font></div><div><font size="2"   >-----------------</font></div><div><font size="2"   >&nbsp;F/3000028</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>这个命令执行的目的是在$PGDATA中记录一个标签文件, 包含标签名now()::text, 以及执行这条指令的启动时间和WAL位置.</div><div>标签文件信息如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-33 postgresql-9.3beta1]# su - pg93</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cat backup_label&nbsp;</font></div><div><font size="2"   >START WAL LOCATION: F/3000028 (file 000000030000000F00000003)</font></div><div><font size="2"   >CHECKPOINT LOCATION: F/3000060</font></div><div><font size="2"   >BACKUP METHOD: pg_start_backup</font></div><div><font size="2"   >BACKUP FROM: master</font></div><div><font size="2"   >START TIME: 2013-05-27 11:02:58 CST</font></div><div><font size="2"   >LABEL: 2013-05-27 11:02:58.578713+08</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >接下来就可以拷贝数据文件了.</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cp -r -L $PGDATA /pgdata/digoal/1921/data04/pg93backup/20130527_onlinebackup</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >拷贝完后清除备份文件中pg_xlog和pg_log中的内容, 因为这些是不需要的.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd&nbsp;<span style="line-height: 22px;"   >/pgdata/digoal/1921/data04/pg93backup/20130527_onlinebackup/pg_xlog</span></font></div><div><span style="line-height: 22px;"   ><font size="2"   >rm -rf *</font></span></div><div><font size="2"   ><span style="line-height: 22px;"   >cd&nbsp;</span><span style="line-height: 22px;"   >/pgdata/digoal/1921/data04/pg93backup/20130527_onlinebackup/pg_log</span></font></div><div><span style="line-height: 22px;"   ><font size="2"   >rm -rf *</font></span></div><p></p></pre></div><div><span style="line-height: 22px;"   >接下来使用超级用户在数据库中执行如下命令 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select pg_stop_backup();</font></div><div><font size="2"   >NOTICE: &nbsp;pg_stop_backup complete, all required WAL segments have been archived</font></div><div><font size="2"   >&nbsp;pg_stop_backup&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;F/3001A20</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>然后要备份这段时间产生的归档文件 :&nbsp;</div><div>需要的归档文件是哪些呢?</div><div>备份开始是的XLOG文件在backup_label中已经指出了000000030000000F00000003, 结束时的XLOG文件也可以从pg_stop_backup()的输出中得到 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# &nbsp;select pg_xlogfile_name('F/3001A20');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;pg_xlogfile_name &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;000000030000000F00000003</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>如果你的PostgreSQL版本没有这个函数, 那么就自己计算一下文件名 :&nbsp;</div><div>参考 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/"   >http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/</a></div><div>因此本例中需要的文件只有1个就是<span style="line-height: 22px;"   >000000030000000F00000003</span></div><div>如果归档文件本来就不是放在本地文件系统中, 那么也不需要二次备份归档文件. 只要别删掉需要的归档文件就行了.</div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >方法二, rsync</span></div><div>方法与拷贝类似, 也需要先执行pg_start_backup, 然后调用rsync, 最后调用pg_stop_backup.</div><div>命令举例 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >pg93@db-172-16-3-33-&gt; rsync -acvz -L --exclude "pg_xlog" --exclude "pg_log" $PGDATA /pgdata/digoal/1921/data04/pg93backup/20130527_backup</font></p></pre></div><div><br></div><div><span style="line-height: 22px;"   >方法三, pg_basebackup</span></div><div><span style="line-height: 22px;"   >pg_basebackup是PostgreSQL 9.1 引入的一个数据库备份命令, pg_basebackup利用流复制协议传输数据库文件.</span></div><div>使用pg_basebackup备份数据库需要用到超级用户或者replication角色用户.</div><div><span style="line-height: 22px;"   >另外就是pg_basebackup不需要执行pg_start_backup和pg_stop_backup, 因为命令中已经封装了这些操作.</span></div><div><span style="line-height: 22px;"   >并且支持多个pg_basebackup并行备份同一个数据库集群.</span></div><div><span style="line-height: 22px;"   >例如 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   ><div>pg93@db-172-16-3-33-&gt; psql</div><div>psql (9.3devel)</div><div>Type "help" for help.</div></font></span></div><div><span style="line-height: 22px;"   ><div><font size="2"   >digoal=# create role replica login replication encrypted password 'replica';</font></div><div><font size="2"   >CREATE ROLE</font></div></span></div><p></p></pre></div><div><span style="line-height: 22px;"   ><div>配置pg_hba.conf , 允许连接.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >host &nbsp; &nbsp;replication &nbsp; &nbsp; replica &nbsp; &nbsp; &nbsp; &nbsp;172.16.3.40/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;md5</font></div></div><div><font size="2"   >pg_ctl reload</font></div><p></p></pre></div><div>在另一台主机备份 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-40-&gt; pg_basebackup -D ./basebackup_20130527 -F p -X stream -h 172.16.3.33 -p 1999 -U replica</font></div><div><font size="2"   >Password:&nbsp;</font></div><div><font size="2"   >WARNING: &nbsp;skipping special file "./.s.PGSQL.1999"</font></div><p></p></pre></div><div>需要注意, 以pg_basebackup备份, 如果表空间使用了软链接, 那么备份时在目标端也会创建软链接, 因此需要先保证目录存在并有写权限.</div></span></div><div>例如本例 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-40-&gt; cd basebackup_20130527/</font></div><div><div><font size="2"   >pg93@db-172-16-3-40-&gt; cd pg_tblspc/</font></div><div><font size="2"   >pg93@db-172-16-3-40-&gt; ll</font></div><div><font size="2"   >total 0</font></div><div><font size="2"   >lrwxrwxrwx 1 pg93 pg93 47 May 27 12:28 26425 -&gt; /pgdata/digoal/1921/data03/pg93/1999/tbs_digoal</font></div></div><p></p></pre></div><div>那么目标端的<span style="line-height: 22px;"   >/pgdata/digoal/1921/data03/pg93/1999 这个目录要先创建好, 并提供写权限.</span></div><div><br></div><div><span style="line-height: 22px;"   >PITR还原举例 :&nbsp;</span></div><div>PostgreSQL 支持指定还原点的位置, 即数据库恢复到什么位置停下来.&nbsp;</div><div>4个recovery.conf参数恢复停止在哪个位置.&nbsp;</div><div>1. recovery_target_name, 指pg_create_restore_point(text)创建的还原点, 如果有重名的还原点, 那么在recovery过程中第一个遇到的还原点即停止.</div><div>2. recovery_target_time, 指XLOG中记录的recordXtime(<span style="line-height: 22px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >xl_xact_commit_compact-&gt;</span><span style="line-height: 22px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >xact_time</span><span style="line-height: 22px;"   >), 配合</span><span style="line-height: 22px;"   >recovery_target_inclusive使用,&nbsp;</span></div><div><span style="line-height: 22px;"   >&nbsp; &nbsp; 如果在同一个时间点有多个事务回滚或提交, 那么</span><span style="line-height: 22px;"   >recovery_target_inclusive=false则恢复到这个时间点第一个回滚或提交的事务(含),&nbsp;</span><span style="line-height: 22px;"   >recovery_target_inclusive=true则恢复到这个时间点最后一个回滚或提交的事务(含).&nbsp;</span></div><div><span style="line-height: 22px;"   >&nbsp; &nbsp; 如果时间点上刚好只有1个事务回滚或提交, 那么</span><span style="line-height: 22px;"   >recovery_target_inclusive=true和false一样, 恢复将处理到这个事务包含的xlog信息(含).&nbsp;</span></div><div><span style="line-height: 22px;"   >&nbsp; &nbsp; 如果时间点没有匹配的事务提交或回滚信息, 那么</span><span style="line-height: 22px;"   >recovery_target_inclusive=true</span><span style="line-height: 22px;"   >和false一样, 恢复将处理到这个时间后的下一个事务回滚或提交的xlog信息(含).</span></div><div>3. recovery_target_xid, 指<span style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >XLogRecord-&gt;xl_xid, 可以配合</span><span style="line-height: 22px;"   >recovery_target_inclusive使用, 但是</span><span style="line-height: 22px;"   >recovery_target_inclusive只影响日志的输出, 并不影响恢复进程截至点的选择, 截至都截止于这个xid的xlog位置. 也就是说无论如何都包含了这个事务的xlog信息的recovery.&nbsp;</span></div><div><span style="line-height: 22px;"   >&nbsp; &nbsp; 这里需要特别注意xid的信息体现在结束时, 而不是分配xid时. 所以恢复到xid=100提交|回滚点, 可能xid=102已经先提交了. 那么包含xid=102的xlog信息会被recovery.</span></div><div>4. recovery_target_inclusive</div><div>还原点的详细介绍可参考 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201303082942271/"   >http://blog.163.com/digoal@126/blog/static/163877040201303082942271/</a></div><div><br></div><div>在还原前, 对数据库做一些DML操作, 配合这些DML操作来讲解一下这几个参数的含义.</div><div>1.&nbsp;</div><div>begin1;query1;commit1; begin2; query2_1;&nbsp;<span style="line-height: 22px;"   >pg_create_restore_point(text); query2_2; commit2;</span></div><div><span style="line-height: 22px;"   >按照以上描述, 使用</span><span style="line-height: 22px;"   >recovery_target_name</span><span style="line-height: 22px;"   >恢复数据库恢复后应该包含query1的变更, 但是不包含query2_1和query2_2的变更.</span></div><div><span style="line-height: 22px;"   >begin1;</span><span style="line-height: 22px;"   >query1;commit1;</span><span style="line-height: 22px;"   >&nbsp;-- SESSION A :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   ><div>digoal=# create table pitr_test(id int, info text);</div><div>CREATE TABLE</div><div><div>digoal=# insert into pitr_test values (1,'test');</div><div>INSERT 0 1</div></div></font></span></div><div><font size="2"   ><span style="line-height: 22px;"   >begin2; query2_1;&nbsp;</span><span style="line-height: 22px;"   >-- SESSION A :&nbsp;</span></font></div><div><span style="line-height: 22px;"   ><font size="2"   ><div>digoal=# begin;</div><div>BEGIN</div><div>digoal=# insert into pitr_test values (2,'test');</div><div>INSERT 0 1</div></font></span></div><p></p></pre></div><div><span style="line-height: 22px;"   >pg_create_restore_point(text); -- SESSION B :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select pg_create_restore_point('pitr_test');</font></div><div><font size="2"   >&nbsp;pg_create_restore_point&nbsp;</font></div><div><font size="2"   >-------------------------</font></div><div><font size="2"   >&nbsp;F/B01F8C8</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >query2_2; commit2; --&nbsp;</span><span style="line-height: 22px;"   >SESSION B :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into pitr_test values (3,'test');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# commit;</font></div><div><font size="2"   >COMMIT</font></div><p></p></pre></div><div>切换日志, 归档 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div></div><div><div><font size="2"   >digoal=# select pg_xlogfile_name(pg_switch_xlog());</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;pg_xlogfile_name &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;000000030000000F0000000C</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_xlogfile_name(pg_switch_xlog());</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;pg_xlogfile_name &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;000000030000000F0000000D</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>使用拷贝的备份以及归档日志还原 :&nbsp;</div><div>关闭数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_ctl stop -m fast</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div><p></p></pre></div><div>删除数据库目录以及表空间目录</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd pg_tblspc/</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; ll</font></div><div><font size="2"   >total 0</font></div><div><font size="2"   >lrwxrwxrwx 1 pg93 pg93 47 May 26 18:04 26425 -&gt; /pgdata/digoal/1921/data03/pg93/1999/tbs_digoal</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; rm -rf /pgdata/digoal/1921/data03/pg93/1999/tbs_digoal/*</font></div></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; rm -rf *</font></div></div><p></p></pre></div><div>还原备份以及表空间软链接</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cp -r /pgdata/digoal/1921/data04/pg93backup/20130527_onlinebackup/* $PGDATA/</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd pg_tblspc/</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; ll</font></div><div><font size="2"   >total 4.0K</font></div><div><font size="2"   >drwx------ 3 pg93 pg93 4.0K May 27 14:32 26425</font></div></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; mv 26425/* /pgdata/digoal/1921/data03/pg93/1999/tbs_digoal/</font></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; rm -rf 26425</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; ln -s /pgdata/digoal/1921/data03/pg93/1999/tbs_digoal ./26425</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; ll</font></div><div><font size="2"   >total 0</font></div><div><font size="2"   >lrwxrwxrwx 1 pg93 pg93 47 May 27 14:34 26425 -&gt; /pgdata/digoal/1921/data03/pg93/1999/tbs_digoal</font></div></div><p></p></pre></div><div>创建pg_log目录, 存放日志 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; mkdir -p pg_log</font></div><p></p></pre></div><div>配置$PGDATA/recovery.conf</div><div><p></p><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cp $PGHOME/share/recovery.conf.sample ./recovery.conf</font></div><div><font size="2"   >vi&nbsp;<span style="line-height: 20px;"   >recovery.conf</span></font></div><p></p></div><div><div style="line-height: 22px;"   ><font size="2"   >restore_command = 'recovery.sh /pgdata/digoal/1921/data04/pg93archdir %f %p' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# e.g. 'cp /mnt/server/archivedir/%f %p'</font></div><div style="line-height: 22px;"   ><font size="2"   >recovery_target_name = 'pitr_test' &nbsp; &nbsp; &nbsp;# e.g. 'daily backup 2011-01-26'</font></div><div style="line-height: 22px;"   ><font size="2"   >recovery_target_timeline = 'latest'</font></div></div><p></p></pre></div></div><div><div style="line-height: 22px;"   >创建恢复脚本 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cat recovery.sh</font></div><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/opt/pgsql9.3</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >BASEDIR=$1</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >find $BASEDIR -name $2 -exec cp {} $3 \;</font></div><p></p></pre></div><div>添加可执行权限 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; chmod 700 recovery.sh</font></div><div style="line-height: 22px;"   ></div><p></p></pre></div></div><div><span style="line-height: 22px;"   >启动数据库</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_ctl start</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; LOG: &nbsp;00000: loaded library "pg_stat_statements"</font></div><div><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1296</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >查看还原点是否与预计匹配 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select ctid,* from pitr_test ;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| id | info&nbsp;</font></div><div><font size="2"   >-------+----+------</font></div><div><font size="2"   >&nbsp;(0,1) | &nbsp;1 | test</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# insert into pitr_test values(2,'new');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# select ctid,* from pitr_test ;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| id | info&nbsp;</font></div><div><font size="2"   >-------+----+------</font></div><div><font size="2"   >&nbsp;(0,1) | &nbsp;1 | test</font></div><div><font size="2"   >&nbsp;(0,3) | &nbsp;2 | new</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>新插入的数据ctid=3, 说明query2_1的xlog信息被恢复了, 但是回滚了. 如果没有执行info=new的ctid应该=2.</div><div><br></div><div><span style="line-height: 22px;"   >2.&nbsp;</span></div><div>commit_xact1; time1; rollback_xact2; time2;&nbsp;<span style="line-height: 22px;"   >commit_xact3;&nbsp;</span><span style="line-height: 22px;"   >commit_xact4;</span></div><div><span style="line-height: 22px;"   >按照以上描述,</span><span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >使用</span><span style="line-height: 22px;"   >recovery_target_time恢复,&nbsp;</span></div><div><span style="line-height: 22px;"   >&nbsp; &nbsp; 如果recovery_target_time=time1, 不管</span><span style="line-height: 22px;"   >recovery_target_inclusive=true|false, 恢复后应该都只能看到</span><span style="line-height: 22px;"   >commit_xact1;的数据变更. 因为rollback_xact2回滚了, 不过使用ctid也能看出回滚的影响, 因为</span><span style="line-height: 22px;"   >rollback_xact2;的xlog是需要处理的.</span></div><div><span style="line-height: 22px;"   >&nbsp; &nbsp;&nbsp;</span><span style="line-height: 22px;"   >如果recovery_target_time=time2, 不管</span><span style="line-height: 22px;"   >recovery_target_inclusive=true|false, 恢复后应该都只能看到</span><span style="line-height: 22px;"   >commit_xact3;的数据变更. 但是绝对看不到</span><span style="line-height: 22px;"   >commit_xact4的变更, 即使</span><span style="line-height: 22px;"   >ctid也不会有影响, 因为</span><span style="line-height: 22px;"   >commit_xact4;的xlog不会被处理.</span></div><div><span style="line-height: 22px;"   >commit_xact1; -- SESSION A :&nbsp;</span></div><div><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# truncate pitr_test ;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >digoal=# insert into pitr_test values (1,'test');</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><p></p></div><div><span style="line-height: 22px;"   >time1;</span><span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >-- SESSION A :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >digoal=# select now();<br>              now              <br>-------------------------------<br> 2013-05-27 15:39:57.033134+08<br>(1 row)</span></font></div><p></p></pre></div><div><span style="line-height: 22px;"   >rollback_xact2;</span><span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >-- SESSION A :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# insert into pitr_test values (2,'rollback');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# insert into pitr_test values (3,'rollback');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# rollback;</font></div><div><font size="2"   >ROLLBACK</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >time2;</span><span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >-- SESSION A :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >digoal=# select now();<br>              now              <br>-------------------------------<br> 2013-05-27 15:40:24.055161+08<br>(1 row)</span></font></div><p></p></pre></div><div><span style="line-height: 22px;"   >commit_xact3;</span><span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >-- SESSION A :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into pitr_test values (4,'new');</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >commit_xact4;</span><span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >-- SESSION A :&nbsp;</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into pitr_test values (5,'new');</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div><div>切换日志, 归档 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_xlogfile_name(pg_switch_xlog());</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;pg_xlogfile_name &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;000000010000000000000003</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_xlogfile_name(pg_switch_xlog());</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;pg_xlogfile_name &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;000000010000000000000004</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>使用拷贝的备份以及归档日志还原 :&nbsp;</div><div>关闭数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_ctl stop -m fast</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div><p></p></pre></div><div>删除数据库目录以及表空间目录(为简化例子, 本例无新建的表空间.)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; rm -rf *</font></div><p></p></pre></div><div>还原备份以及表空间软链接</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cp -r /pgdata/digoal/1921/data04/pg93backup/20130527_onlinebackup/* $PGDATA</font></div><div></div><p></p></pre></div><div>创建pg_log目录, 存放日志 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >配置$PGDATA/recovery.conf</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cp $PGHOME/share/recovery.conf.sample ./recovery.conf</font></div><div><font size="2"   >vi recovery.conf</font></div><div><font size="2"   >restore_command = 'recovery.sh /pgdata/digoal/1921/data04/pg93archdir %f %p' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# e.g. 'cp /mnt/server/archivedir/%f %p'</font></div><div><font size="2"   >recovery_target_time = '2013-05-27 15:39:57.033134+08'</font></div><div><font size="2"   >recovery_target_inclusive = false</font></div><div><font size="2"   >recovery_target_timeline = 'latest'</font></div><p></p></pre></div><div>创建恢复脚本 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cat recovery.sh</font></div><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/opt/pgsql9.3</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >BASEDIR=$1</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >find $BASEDIR -name $2 -exec cp {} $3 \;</font></div><p></p></pre></div><div>添加可执行权限 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; chmod 700 recovery.sh</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >启动数据库</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_ctl start</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; LOG: &nbsp;00000: loaded library "pg_stat_statements"</font></div><div><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1296</font></div><p></p></pre></div><div>查看还原点是否与预计匹配 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select ctid,* from pitr_test ;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| id | info&nbsp;</font></div><div><font size="2"   >-------+----+------</font></div><div><font size="2"   >&nbsp;(0,1) | &nbsp;1 | test</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# insert into pitr_test values(10,'new');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# select ctid,* from pitr_test ;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| id | info&nbsp;</font></div><div><font size="2"   >-------+----+------</font></div><div><font size="2"   >&nbsp;(0,1) | &nbsp;1 | test</font></div><div><font size="2"   >&nbsp;(0,4) | 10 | new</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>新插入的数据ctid=4, 说明rollback_xact2;的xlog信息被恢复了, 但是回滚了. 如果没有执行info=new的ctid应该=2.</div></div><div style="line-height: 22px;"   >其他几种搭配就不测试了, 原理已经介绍清楚了. 有兴趣的朋友可以自行测试.</div></div><div style="line-height: 22px;"   ><br></div><div><span style="line-height: 22px;"   >3.&nbsp;</span></div><div>commit_xact1;begin2;query2_1;commit_xact3;commit_xact4;query2_2;rollback2;commit_xact5;</div><div><span style="line-height: 22px;"   >recovery_target_xid=</span><span style="line-height: 22px;"   >commit_xact1, 无论</span><span style="line-height: 22px;"   >recovery_target_inclusive=true|false, 恢复后数据库将包含</span><span style="line-height: 22px;"   >commit_xact1的数据变更;</span></div><div><span style="line-height: 22px;"   >recovery_target_xid=</span><span style="line-height: 22px;"   >rollback2; 则包含xact1,xact3,xact4的变更以及xact2的回滚;</span></div><div><span style="line-height: 22px;"   >recovery_target_xid=</span><span style="line-height: 22px;"   >xact5; 则包含所有xlog信息.</span></div><div><div>commit_xact1; -- SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# truncate pitr_test ;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# select txid_current();</font></div><div><font size="2"   >&nbsp;txid_current&nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1691</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# insert into pitr_test values (1,'test');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# end;</font></div><div><font size="2"   >COMMIT</font></div><p></p></pre></div><div>begin2;query2_1; -- SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# select txid_current();</font></div><div><font size="2"   >&nbsp;txid_current&nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1692</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# insert into pitr_test values (1692,'test');</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div>commit_xact3;commit_xact4; -- SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# select txid_current();</font></div><div><font size="2"   >&nbsp;txid_current&nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1693</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# insert into pitr_test values (1693,'teset');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# end;</font></div><div><font size="2"   >COMMIT</font></div><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# select txid_current();</font></div><div><font size="2"   >&nbsp;txid_current&nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1694</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# insert into pitr_test values (1693,'teset');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# insert into pitr_test values (1694,'teset');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# end;</font></div><div><font size="2"   >COMMIT</font></div><p></p></pre></div><div>query2_2;rollback2; -- SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into pitr_test values (1692,'new_test');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# rollback;</font></div><div><font size="2"   >ROLLBACK</font></div><p></p></pre></div><div>commit_xact5; -- SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# select txid_current();</font></div><div><font size="2"   >&nbsp;txid_current&nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1695</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# insert into pitr_test values (1695,'test');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# commit;</font></div><div><font size="2"   >COMMIT</font></div><p></p></pre></div><div><div>切换日志, 归档 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_xlogfile_name(pg_switch_xlog());</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;pg_xlogfile_name &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;000000020000000000000003</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_xlogfile_name(pg_switch_xlog());</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;pg_xlogfile_name &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;000000020000000000000004</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>使用拷贝的备份以及归档日志还原 :&nbsp;</div><div>关闭数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_ctl stop -m fast</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div><p></p></pre></div><div>删除数据库目录以及表空间目录(为简化例子, 本例无新建的表空间.)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; rm -rf *</font></div><p></p></pre></div><div>还原备份以及表空间软链接</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cp -r /pgdata/digoal/1921/data04/pg93backup/20130527_onlinebackup/* $PGDATA</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >创建pg_log目录, 存放日志 :&nbsp;</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >配置$PGDATA/recovery.conf</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cp $PGHOME/share/recovery.conf.sample ./recovery.conf</font></div><div><font size="2"   >vi recovery.conf</font></div><div><font size="2"   >restore_command = 'recovery.sh /pgdata/digoal/1921/data04/pg93archdir %f %p' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# e.g. 'cp /mnt/server/archivedir/%f %p'</font></div><div><font size="2"   >recovery_target_xid = '1692'</font></div><div><font size="2"   >recovery_target_inclusive = false</font></div><div><font size="2"   >recovery_target_timeline = 'latest'</font></div><p></p></pre></div><div>创建恢复脚本 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cat recovery.sh</font></div><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/opt/pgsql9.3</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >BASEDIR=$1</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >find $BASEDIR -name $2 -exec cp {} $3 \;</font></div><p></p></pre></div><div>添加可执行权限 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; chmod 700 recovery.sh</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >启动数据库</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_ctl start</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; LOG: &nbsp;00000: loaded library "pg_stat_statements"</font></div><div><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1296</font></div><p></p></pre></div><div>查看还原点是否与预计匹配 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select ctid,* from pitr_test ;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| &nbsp;id &nbsp;| info &nbsp;</font></div><div><font size="2"   >-------+------+-------</font></div><div><font size="2"   >&nbsp;(0,1) | &nbsp; &nbsp;1 | test</font></div><div><font size="2"   >&nbsp;(0,3) | 1693 | teset</font></div><div><font size="2"   >&nbsp;(0,4) | 1693 | teset</font></div><div><font size="2"   >&nbsp;(0,5) | 1694 | teset</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   >digoal=# insert into pitr_test values(10,'new');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# select ctid,* from pitr_test ;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| &nbsp;id &nbsp;| info &nbsp;</font></div><div><font size="2"   >-------+------+-------</font></div><div><font size="2"   >&nbsp;(0,1) | &nbsp; &nbsp;1 | test</font></div><div><font size="2"   >&nbsp;(0,3) | 1693 | teset</font></div><div><font size="2"   >&nbsp;(0,4) | 1693 | teset</font></div><div><font size="2"   >&nbsp;(0,5) | 1694 | teset</font></div><div><font size="2"   >&nbsp;(0,7) | &nbsp; 10 | new</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div><div>因为只有当record_info等于XLOG_XACT_ABORT,XLOG_XACT_COMMIT或者XLOG_XACT_COMMIT_COMPACT, 或者自建还原点时才可以被作为截至点,&nbsp;</div><div>所以本例使用xid=1692作为截至点, xlog会应用到query2_2;rollback2; -- SESSION A : 这个位置(并且包含这个xlog信息).</div><div>因此在此之前应该插入了6条记录, 所以新插入的数据ctid=7, 再次说明query2_2;rollback2;的xlog信息被恢复了, 但是回滚了.&nbsp;</div><div>其他几种搭配就不测试了, 原理已经介绍清楚了. 有兴趣的朋友可以自行测试.</div></div></div><div><br></div><div>自动备份</div><div>这个可以结合操作系统的定时脚本来实现, 在Linux中可以使用crontab.</div><div>例如 :&nbsp;</div><div>1. 首先规划好存放数据库数据文件的目录.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >mkdir -p&nbsp;/pgdata/digoal/1921/data04/pg93backup</font></div><div><font size="2"   >chown -R pg93:pg93&nbsp;/pgdata/digoal/1921/data04/pg93backup</font></div><div><font size="2"   >chmod 700&nbsp;/pgdata/digoal/1921/data04/pg93backup</font></div><p></p></pre></div><div>2. 编写备份脚本</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; vi backup.sh</font></div><div><font size="2"   ><span style="line-height: 19px;"   >#!/bin/bash<br><br>export LANG=en_US.utf8<br>export PGHOME=/opt/pgsql9.3<br>export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH<br>export DATE=`date +"%Y%m%d"`<br>export PATH=$PGHOME/bin:$PATH:.<br>export PGDATA=/pgdata1999<br><br>BASEDIR="/pgdata/digoal/1921/data04/pg93backup"<br><br>date +%F%T<br><br>if [ ! -d $BASEDIR/$DATE ]; then<br>  mkdir -p $BASEDIR/$DATE<br>  if [ $? -eq 0 ]; then<br>    psql -h 127.0.0.1 -p 1999 -U postgres postgres -c "select pg_start_backup(now()::text)"<br>    if [ $? -eq 0 ]; then<br>      cp -r -L $PGDATA $BASEDIR/$DATE<br>    else<br>      echo -e "select pg_start_backup(now()::text) error"<br>      exit 1<br>    fi<br>    psql -h 127.0.0.1 -p 1999 -U postgres postgres -c "select pg_stop_backup()"<br>    date +%F%T<br>    echo -e "backup successed"<br>    exit 0<br>  else<br>    echo -e "mkdir -p $BASEDIR/$DATE error"<br>    exit 1<br>  fi<br>else<br>  echo -e "$DATE backuped, don't backup repeated"<br>  exit 1<br>fi</span></font></div><p></p></pre></div><div>修改权限</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; chmod 700 backup.sh</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >3. 测试</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; ./backup.sh&nbsp;</font></div><div><font size="2"   >&nbsp;pg_start_backup&nbsp;</font></div><div><font size="2"   >-----------------</font></div><div><font size="2"   >&nbsp;0/6000028</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >NOTICE: &nbsp;pg_stop_backup complete, all required WAL segments have been archived</font></div><div><font size="2"   >&nbsp;pg_stop_backup&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;0/60000F0</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; 再次执行则退出, 因为今天已经备份了.</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; ./backup.sh&nbsp;</font></div><div><font size="2"   >20130527 backuped, don't backup repeated</font></div><p></p></pre></div><div>4. 配置crontab</div><div>首先删除当天备份</div><pre class="prettyprint"   ><p></p><div><font size="2"   >rm -rf /pgdata/digoal/1921/data04/pg93backup/20130527</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >配置自动备份</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - pg93</font></div><div><font size="2"   >crontab -e</font></div><div><font size="2"   >40 16 * * * /pgdata1999/backup.sh &gt;&gt;/tmp/backup.log 2&gt;&amp;1</font></div><p></p></pre></div><div>5. 检查是否自动备份.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cat /tmp/backup.log&nbsp;</font></div><div><font size="2"   >2013-05-2716:40:01</font></div><div><font size="2"   >&nbsp;pg_start_backup&nbsp;</font></div><div><font size="2"   >-----------------</font></div><div><font size="2"   >&nbsp;0/8000028</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >NOTICE: &nbsp;pg_stop_backup complete, all required WAL segments have been archived</font></div><div><font size="2"   >&nbsp;pg_stop_backup&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;0/80000F0</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >2013-05-2716:40:02</font></div><div><font size="2"   >backup successed</font></div><p></p></pre></div><div>检查备份成功后把crontab调整为你需要的备份时间即可. 例如每天都凌晨2点开始备份.</div><div><pre class="prettyprint"   ><p><font size="2"   >0 2 * * * /pgdata1999/backup.sh &gt;&gt;/tmp/backup.log 2&gt;&amp;1</font></p></pre></div><div><br></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/"   >http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/</a></div><div>2.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201303082942271/"   >http://blog.163.com/digoal@126/blog/static/163877040201303082942271/</a></div></div>
	</div>
</div>
</body>
</html>