<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL Daily Maintenance - cluster table</h2>
	<h5 id="">2013-05-30 15:12:53&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201343031253913/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div style="line-height: 22px;"   >Cluster簇管理 :&nbsp;</div><div style="line-height: 22px;"   >在PostgreSQL的统计信息表中, 有一项指标correlation指明了heap表存储的物理顺序和索引顺序的关系.</div><div style="line-height: 22px;"   >例如 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# create table tbl (id int primary key, info text);</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CREATE TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 25.762 ms</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# insert into tbl select generate_series(1,10000),'test';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INSERT 0 10000</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 32.397 ms</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select correlation from pg_stats where schemaname='public' and tablename='tbl' and attname='id';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;correlation&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 2.648 ms</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >1表示该列的物理存储顺序和索引顺序完全一致. 如果是-1则表示和索引顺序完全相反, 这种情况出现在索引使用了反向排序即desc的时候.</div><div style="line-height: 22px;"   >接下来按随机顺序插入.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# truncate tbl;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >TRUNCATE TABLE</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 34.648 ms</font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# insert into tbl select trunc(random()*100000),'test' from generate_series(1,100000) group by 1,2;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >INSERT 0 63321</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 332.371 ms</font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select correlation from pg_stats where schemaname='public' and tablename='tbl' and attname='id';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;correlation&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp;0.0047608</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 1.476 ms</font></div></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >现在这个值就很低了, 说明物理顺序和索引顺序偏差很大.</div><div style="line-height: 22px;"   >索引顺序和物理存储顺序一致的话, 使用索引进行范围检索时, 可以减少IO量. 例如 :&nbsp;</div><div style="line-height: 22px;"   >取1到100的id范围, 使用上述偏差很大的表查询时, 使用索引扫描的话需要扫描50个表的数据块, &nbsp;如下 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select split_part(ctid::text, ',', 1) from tbl where id between 1 and 100 group by 1 order by 1;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;split_part&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(103</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(127</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(130</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(132</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(134</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(135</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(139</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(14</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(143</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(151</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(157</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(160</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(164</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(178</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(180</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(188</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(189</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(201</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(203</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(204</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(22</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(223</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(238</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(270</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(272</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(274</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(275</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(310</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(314</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(327</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(33</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(330</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(334</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(337</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(37</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(38</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(40</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(49</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(51</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(53</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(60</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(63</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(75</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(78</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(8</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(87</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(88</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(90</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(50 rows)</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >在执行cluster后,&nbsp;<span style="line-height: 22px;"   >使用索引扫描的话</span><span style="line-height: 22px;"   >只需要扫描1个数据块. 可以大大降低范围查询的HEAP block扫描量.</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# cluster tbl using tbl_pkey;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >CLUSTER</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 198.924 ms</font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# analyze tbl;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >ANALYZE</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 15.418 ms</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select correlation from pg_stats where schemaname='public' and tablename='tbl' and attname='id';</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;correlation&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Time: 1.327 ms</font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >digoal=# select split_part(ctid::text, ',', 1) from tbl where id between 1 and 100 group by 1 order by 1;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;split_part&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;(0</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(1 row)</font></div><div><font size="2"   style="line-height: 19px;"   ><br></font></div></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   ></div><wbr></div>
	</div>
</div>
</body>
</html>