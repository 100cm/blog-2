<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL cert client auth method configed with hostssl and user mapping</h2>
	<h5 id="">2013-05-24 14:39:26&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201342335842432/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前面介绍了PostgreSQL 服务器和客户端之间的数据传输加密方法.</div><div>前提条件是数据库和客户端服务器都必须有ssl lib库.&nbsp;</div><wbr><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201342233131835/"   >http://blog.163.com/digoal@126/blog/static/163877040201342233131835/</a></div><div>前面还介绍了md5和password客户端认证方法的区别,&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402013423102431541/"   >http://blog.163.com/digoal@126/blog/static/1638770402013423102431541/</a></div><div>本文将要介绍的是客户端证书认证方法. 使用证书认证不需要客户端输入密码.&nbsp;</div><div>但是同样要求<span style="line-height: 22px;"   >数据库和客户端服务器都必须有ssl lib库. 数据传输为加密传输.&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >19.3.10. Certificate Authentication</font></div><div><font size="2"   >This authentication method uses SSL client certificates to perform authentication. It is therefore only available for SSL connections. When using this authentication method, the server will require that the client provide a valid certificate. No password prompt will be sent to the client. The cn (Common Name) attribute of the certificate will be compared to the requested database user name, and if they match the login will be allowed. User name mapping can be used to allow cn to be different from the database user name.</font></div><div><font size="2"   >The following configuration options are supported for SSL certificate authentication:</font></div><div><font size="2"   >map</font></div><div><font size="2"   >Allows for mapping between system and database user names. See Section 19.2 for details.</font></div><p></p></pre></div><div>[使用举例]</div><div>环境 :&nbsp;</div><div>CA server : 172.16.3.150 (随便一台服务器即可, 也可以是以下db server或者client server)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >数据库 : 172.16.3.33</font></div><div><font size="2"   >client 1 : 172.16.3.39</font></div><div><font size="2"   >attacker : 172.16.3.40</font></div><p></p></pre></div><div>1. 首先要创建CA 私钥</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@172-16-3-150:~# mkdir -p /etc/ssl/private</font></div><div><font size="2"   >root@172-16-3-150:~# openssl genrsa -des3 -out /etc/ssl/private/trustly-ca.key 2048</font></div><div><font size="2"   >Generating RSA private key, 2048 bit long modulus</font></div><div><font size="2"   >..........................................................+++</font></div><div><font size="2"   >...................................+++</font></div><div><font size="2"   >e is 65537 (0x10001)</font></div><div><font size="2"   >Enter pass phrase for /etc/ssl/private/trustly-ca.key: 输入digoal, 为了安全生产中使用最好输入复杂一点的.</font></div><div><font size="2"   >Verifying - Enter pass phrase for /etc/ssl/private/trustly-ca.key: 再次<span style="line-height: 22px;"   >输入digoal</span></font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 确保私钥安全, 修改权限和所属</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@172-16-3-150:~# chown root:root /etc/ssl/private/trustly-ca.key</font></div><div><font size="2"   >root@172-16-3-150:~# chmod 400 /etc/ssl/private/trustly-ca.key</font></div><p></p></pre></div><div># 查看一下私钥内容, 千万别泄露. 当然包括pass phrase也别泄露.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@172-16-3-150:~# cat /etc/ssl/private/trustly-ca.key&nbsp;</font></div><div><font size="2"   >-----BEGIN RSA PRIVATE KEY-----</font></div><div><font size="2"   >Proc-Type: 4,ENCRYPTED</font></div><div><font size="2"   >DEK-Info: DES-EDE3-CBC,F48701D7A1B00B0F</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >zV96wfQ8/tYDb46Ft7ZotEYJ3YYwNvTc/FVkVsq+W0mKnJ5mhXvF0piQFtMkQtdq</font></div><div><font size="2"   >gakxff9H+08qZxERAX+rXMA7chxZl6LKNxcfA6Rh82MFYrZAErJd5bW+m0geiefO</font></div><div><font size="2"   >WVlS2dD4Mfa/vup4kcIVZ2MG/4AS3J3efWoTNl1RFx+NYx6c2Wra0h9JmnVWaDiV</font></div><div><font size="2"   >7D8VAGUdJDxKh742v64+4Obf5+E/efxomMh9tQBv7Ms45O/plOeo5GOmHRqRIL+v</font></div><div><font size="2"   >I35V40MHCxZKsUkY7qJxy6TPraUn4OxtDepi/dL2qKlP3+KkeFQ7RIXYnsaMqgCS</font></div><div><font size="2"   >6yJrEUEx7zGnzyCczG5qXRleIA6+ww5HyTinkmSvSVYt1KPgGWe0cj89IrnSwjgi</font></div><div><font size="2"   >RCtIAHG3/eYjIZz81kiK8ZnPcJLrjmTrphfIrrbYvW/s733NA9117zx3H3PaxvNE</font></div><div><font size="2"   >S7hYGuUv+ahvrl1146Z0PJ6AvSxfHB0EjuvcQCyYWQg7WauLeozZywV0E5iieMqd</font></div><div><font size="2"   >RE1RCu2PltCEsAi0hZik+nTWRCQ2xopltuj5EMH4GrKDOfjcxBHg5WkGCid58laE</font></div><div><font size="2"   >3HO0mxnEu/ORVZqRNUu/F4LXnlwB1TFHY5Wu4OGx18VjL1MzkymWBuh1sahT+hLz</font></div><div><font size="2"   >Vs0P9i45HgwCbus2J4gjHNgQ3WJstsuNoZCiyCdd9c4qCgGE1QpTDaBDC3C6jGg5</font></div><div><font size="2"   >uRXpQahGgUHeWql+5m6FWDx0XD+Zv2qJM/V84c+5uRJrcFqOUnw7pNjLAy0ldJRE</font></div><div><font size="2"   >N1bsExJ8GOF2pyVleWsedWAxOsIt03b4nWHRXOcda+S5X52EqCIk2GSFCiX6aUPZ</font></div><div><font size="2"   >4zsmK6BGLWRbJBRfA3+L+f20uz66BGFguwErDM05XO78mpdMg6UgB8J5NJp86Rjl</font></div><div><font size="2"   >C/9TstPR6zqf6ZYbnPJ9nM1YB45MJLmiptbpZ45+d7W/C8BFf0jdnQCM/bRQY8N9</font></div><div><font size="2"   >5HAxOIMWoqqOHUa4fFv0skx438rcQ903SbinOtHocqFXnOzukYIBk83mfdLBaYAH</font></div><div><font size="2"   >J4L7AezH6cBCl8MU78P6VnfHgZtTtAp5YzAwxtayDa89nMGoGs4f3njyT04xjX1S</font></div><div><font size="2"   >IUF8jHQUnoHkBFtKnlrCyMXVH3sYoc8kjvNDahGCPDNVAt51vJyQ/EpLLcQcd+A9</font></div><div><font size="2"   >zazpVh5pRYlXs9Y49aKAxcRuQDXcTmSJnPY2EdQERU9o81IJ+NBmrCqvmcVqmVXM</font></div><div><font size="2"   >3JajGZWKaOi95J1WFS6fTeL3jHUlVzblnDwXeEWi9VbOTtQt4QljUqYq28+UGrkk</font></div><div><font size="2"   >NVLtNVnQ+tzGMXVEmrOQ2eHRU/gxUO7Eq/dsE39ZDxQmh0aP0Xb6QcvFX+gKr73Y</font></div><div><font size="2"   >aTCzvaugxDKYhhSvM3ixyxUcQoS2bV56djHBaAB3kfDOePIjEW97aOL1cRo7DAE7</font></div><div><font size="2"   >7jTFydZnwvJXIW7tH/l7Uhj124Jm69ChRgb4J+5lDh5Y+oVnm9mkv9v4UGgGryxH</font></div><div><font size="2"   >6mqniDL88aZ1UmeWVXeXr2U7iVtLxDEZagJHRcoX1igmWVP9lQepqtt8eiMAwH36</font></div><div><font size="2"   >Go20l9jgFzDoMX4ElRuiISYFoNoBspRdtMflgN2SOkwegt+Y6qJ5iw==</font></div><div><font size="2"   >-----END RSA PRIVATE KEY-----</font></div><p></p></pre></div><div># 文件属性</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@172-16-3-150:~# file /etc/ssl/private/trustly-ca.key&nbsp;</font></div><div><font size="2"   >/etc/ssl/private/trustly-ca.key: PEM RSA private key</font></div><p></p></pre></div><div><br></div><div>2. 生成公共证书</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@172-16-3-150:~# mkdir -p /usr/local/share/ca-certificates</font></div><div><font size="2"   >root@172-16-3-150:~# openssl req -new -x509 -days 3650 \</font></div><div><font size="2"   >&gt; -subj '/C=CN/ST=Zhejiang/L=Hangzhou/O=Skymobi/CN=trustly' \</font></div><div><font size="2"   >&gt; -key /etc/ssl/private/trustly-ca.key \</font></div><div><font size="2"   >&gt; -out /usr/local/share/ca-certificates/trustly-ca.crt</font></div><div><font size="2"   >Enter pass phrase for /etc/ssl/private/trustly-ca.key: 输入私钥的pass phrase: digoal</font></div><p></p></pre></div><div># 查看公共证书内容 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@172-16-3-150:~# cat /usr/local/share/ca-certificates/trustly-ca.crt&nbsp;</font></div><div><font size="2"   >-----BEGIN CERTIFICATE-----</font></div><div><font size="2"   >MIIDgTCCAmmgAwIBAgIJAIKNqfyd2XnOMA0GCSqGSIb3DQEBBQUAMFcxCzAJBgNV</font></div><div><font size="2"   >BAYTAkNOMREwDwYDVQQIDAhaaGVqaWFuZzERMA8GA1UEBwwISGFuZ3pob3UxEDAO</font></div><div><font size="2"   >BgNVBAoMB1NreW1vYmkxEDAOBgNVBAMMB3RydXN0bHkwHhcNMTMwNTI0MDUyNDUy</font></div><div><font size="2"   >WhcNMjMwNTIyMDUyNDUyWjBXMQswCQYDVQQGEwJDTjERMA8GA1UECAwIWmhlamlh</font></div><div><font size="2"   >bmcxETAPBgNVBAcMCEhhbmd6aG91MRAwDgYDVQQKDAdTa3ltb2JpMRAwDgYDVQQD</font></div><div><font size="2"   >DAd0cnVzdGx5MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsdCXygi7</font></div><div><font size="2"   >jx/Vs0KQHiPNCZxGsTkPTfWTjuDvDft7BVkRIdow+7LtFmdCoz5+nqfRRWUZPOJF</font></div><div><font size="2"   >6Eqc39DAqaWb0YzGYMWPlj3NJKwMwcw5FW5X7USr5SVWTmgf6IFxHsTuYptzWKDy</font></div><div><font size="2"   >LDE8Jkjm9RHRppkHpRaBdgWphQ8m0B4YEEJx0HzpPdAsd4YLuzHeswpmHenSO9eF</font></div><div><font size="2"   >wRaQRPG+cGMilaShSetVz904655t+WaJubzcur7AJPH3bcxCSlmApGcee4ydcm5j</font></div><div><font size="2"   >JAHXbQ26pPCe481MLYPQCHFatY2220PP2gre4g/4wQWd03tc3OU9AbdL+3wUuK3X</font></div><div><font size="2"   >eTwOfNcItj5KXQIDAQABo1AwTjAdBgNVHQ4EFgQUBK6vtbH8gu71m6rpW/iBnvZ2</font></div><div><font size="2"   >MuMwHwYDVR0jBBgwFoAUBK6vtbH8gu71m6rpW/iBnvZ2MuMwDAYDVR0TBAUwAwEB</font></div><div><font size="2"   >/zANBgkqhkiG9w0BAQUFAAOCAQEAEzMBp3Zn2TD3LW5S1lSoJ32G3FO8Auil71K8</font></div><div><font size="2"   >1K4BhedCj0x9Q1a3EGm4ve/cSiLSiSsO54g/+Cq81d5mxf4HHlHB8vZeFTQ73bwF</font></div><div><font size="2"   >xrNw1cCEHK166U7T+8A8VjesKGUGsjbFCcju/okLrjHBKxQBYkWSjOqpP39Ero9D</font></div><div><font size="2"   >3DcaLcvidUyh4cEOb/QQ5lhKZmLX78uwryfyk/nT70r3HMf9LlKCebQtTRbybtRZ</font></div><div><font size="2"   >rk2n+12o7IGEx5/ezV4ucAlfycuFVyGVqj7ZpyaStm7oOux1azuowJBSWoTH6PC9</font></div><div><font size="2"   >YKG0dB1ymkSYXZU7GIGDLyKOUHhxnV1kVINtPXEhxnnWohgB4A==</font></div><div><font size="2"   >-----END CERTIFICATE-----</font></div><p></p></pre></div><div># 文件属性</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@172-16-3-150:~# file /usr/local/share/ca-certificates/trustly-ca.crt</font></div><div><font size="2"   >/usr/local/share/ca-certificates/trustly-ca.crt: PEM certificate</font></div><p></p></pre></div><div><br></div><div>3. 配置PostgreSQL server</div><div>生成postgresql server 私钥</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 ca-certificates]# su - pg93</font></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; openssl genrsa -des3 -out $PGDATA/server.key 2048</font></div><div><font size="2"   >Generating RSA private key, 2048 bit long modulus</font></div><div><font size="2"   >....................................................................................+++</font></div><div><font size="2"   >.....................+++</font></div><div><font size="2"   >e is 65537 (0x10001)</font></div><div><font size="2"   >Enter pass phrase for /pgdata1999/server.key: 输入server key pass phrase, 这里随便输入server, 你随意.</font></div><div><font size="2"   >Verifying - Enter pass phrase for /pgdata1999/server.key: 再次<span style="line-height: 22px;"   >输入server key pass phrase, 这里随便输入server, 你随意.</span></font></div></div><p></p></pre></div><div>移除pass phrase, 为了方便做自启动脚本, 不然的话数据库启动时又要提示你输入pass phrase.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; openssl rsa -in $PGDATA/server.key -out $PGDATA/server.key</font></div><div><div><font size="2"   >Enter pass phrase for /pgdata1999/server.key: 输入server</font></div><div><font size="2"   >writing RSA key</font></div></div><p></p></pre></div><div>修改文件权限 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; chmod 400 $PGDATA/server.key</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   ># 查看key的内容和属性</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cat server.key&nbsp;</font></div><div><font size="2"   >-----BEGIN RSA PRIVATE KEY-----</font></div><div><font size="2"   >MIIEpQIBAAKCAQEA1022O0sclC+s/n3olmgew4FmtdAz0gBFwnLh+TGsna/4uHHA</font></div><div><font size="2"   >ZX5APXjG8W+8WhfE2UNQsj7difJuAGrm+BQc11lqZD7lQdaFIdUVKXKsZl6VycBQ</font></div><div><font size="2"   >aE3OK5q6IHjpewCYLBfiHA3t5l/9w7tPmzgwBdqQj2GEZgYsBoTJglNpkKFXXLBx</font></div><div><font size="2"   >3D51LhA4tN5+wsfJ54RC0JX9/JT3L3amkE8t1XOY7vVkm3ZV6sg7MnckLYdvJnv1</font></div><div><font size="2"   >9Lt/cPRx4HdJjLAm3PFzyk2DpuQhCZ/K0IP2fCJNXDxPUqiUzXjjqslUUsvIKsOu</font></div><div><font size="2"   >wP2dWvj+P2MJd41sEFgtlcztVvnhFlZs44BaNQIDAQABAoIBAQC6ff7OJ0aO+Sjw</font></div><div><font size="2"   >m6Eevvt+vxR3geuRCFlkj9w63JM3V1iqcyWDBDOiy34PXYiZxSLmSk+YxalhttMf</font></div><div><font size="2"   >m3mLAujkg/gK8wvj1mwlHQwihcjdNyqpweIkJtjhnjmArRsYRzCIaPua71nVBeqq</font></div><div><font size="2"   >YxIWUjoOp/41o/Np6Ai0cMqXD6dN9UwCeFx083eDKJh3CeyWnV+aiLRcUFonTq/V</font></div><div><font size="2"   >iuJw0uCGA+2tdY7UR23dDa+/R1C3CNM27vcCWa7M0yxyYL6aY9ClOtwaiRpRen4+</font></div><div><font size="2"   >B5nV4MAZKTWdOPDS2viXzNWrQ98bxRCErzEb+kaRjI22d21EnnjZl0GHCtOwzTMM</font></div><div><font size="2"   >w7MZkr+BAoGBAPBI95Q33MZ5PzCKXwzD8JDjuMNKEsFXlyt5SQ0jyFVnfn7vXztH</font></div><div><font size="2"   >L0dZFxxo/48K2RJriQ1RmIsHHrWPcAJWg40JH2XbVOIzH0mfvRdKGbBxH6tWl59S</font></div><div><font size="2"   >8Qt3hou3mVUx+3wjDwXOoPYKXVKYCh+jIpr79nFFS6BVA15iZmyLrgGhAoGBAOVi</font></div><div><font size="2"   >fHkEQLlHVcDB1NHDxfjmwFUrrQH+TSyXd/WOwhZZAOVNHZlM47sf6R4dfalfjfor</font></div><div><font size="2"   >DcJwYbXkyC2nxoKvN1e+HP1vc1gAL+bwImfGK4tX6FxRmf/X6BS51XBjKhr0VF7D</font></div><div><font size="2"   >rcLXJ0UuT8IZI5VU/k/nkZwRrMQhz4ea5FgvfzgVAoGBAJGATdNF5H2WzAnTsGzl</font></div><div><font size="2"   >dZX3H1m6UBMdvB+KKQ843MXCjtnEj5EwsNNugk0k06PFuN6rmWkkQM/nNtRQkE4K</font></div><div><font size="2"   >H0zW+llOcF8s/8QwY2tn5phuV/QD0nqa2fXMof+W5NWvF477F8y3a8axTgOGp5Ky</font></div><div><font size="2"   >0XCyJHBAuuPStuB/i3AtQOghAoGAHm7losyspahQOUW+LaJyxqYeyG4GAyixJoRm</font></div><div><font size="2"   >Fv88wuhGFSYZEjjAUhhWvncdL/aMiK9joPN2E0LqSBxlWvtSNWL0x68ct4U21cXw</font></div><div><font size="2"   >WqJRLqiYHH97FhWYJf/N0J5nfLID65q8mAghnq0ZSeA591sSbpmDmRhDOrZdqVkk</font></div><div><font size="2"   >iIqsr00CgYEArUcp6qV89nNFQG01Q0hMc/rY9g8Zi3/fiJmisg66aRR51Yq/4FVM</font></div><div><font size="2"   >YoTHlz9bwyRlMoO1orWgNW1fsSiCtW1YI6e4IA4bnmtjU8Qt+XRrn7YRN/BAmrD7</font></div><div><font size="2"   >IeCmUcqw/B7v9K44h/yE3Wu9gOCSYo50AKVCceovmZT1Op0TZUXQiCg=</font></div><div><font size="2"   >-----END RSA PRIVATE KEY-----</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; file server.key&nbsp;</font></div><div><font size="2"   >server.key: ASCII text</font></div><p></p></pre></div><div>因为除了CA服务器是Ubuntu 12.04其他都是CentOS 5.x, 所以文件属性并没有显示为key文件. 不过没有关系, 不影响使用.</div><div><br></div><div>4. 请求签名</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; openssl req -new -nodes -key $PGDATA/server.key -days 3650 -out /tmp/server.csr \</font></div><div><font size="2"   >&gt; -subj '/C=CN/ST=Zhejiang/L=Hangzhou/O=Skymobi/CN=pgserver'</font></div><p></p></pre></div><div><br></div><div>5. 使用CA 私钥进行签名</div><div>将&nbsp;<span style="line-height: 22px;"   >/tmp/server.csr 拷贝到CA服务器进行签名</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@172-16-3-150:~# cd /tmp</font></div><div><font size="2"   >root@172-16-3-150:/tmp# rz</font></div><p></p></pre></div><div>签名</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@172-16-3-150:/tmp# openssl req -x509 \</font></div><div><font size="2"   >&gt; -key /etc/ssl/private/trustly-ca.key \</font></div><div><font size="2"   >&gt; -in /tmp/server.csr \</font></div><div><font size="2"   >&gt; -out /tmp/server.crt</font></div><div><font size="2"   >Enter pass phrase for /etc/ssl/private/trustly-ca.key: 输入CA私钥pass phrase</font></div><p></p></pre></div><div># 查看一下这两个文件的内容和属性</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >root@172-16-3-150:/tmp# cat server.csr&nbsp;</font></div><div><font size="2"   >-----BEGIN CERTIFICATE REQUEST-----</font></div><div><font size="2"   >MIICnTCCAYUCAQAwWDELMAkGA1UEBhMCQ04xETAPBgNVBAgTCFpoZWppYW5nMREw</font></div><div><font size="2"   >DwYDVQQHEwhIYW5nemhvdTEQMA4GA1UEChMHU2t5bW9iaTERMA8GA1UEAxMIcGdz</font></div><div><font size="2"   >ZXJ2ZXIwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDXTbY7SxyUL6z+</font></div><div><font size="2"   >feiWaB7DgWa10DPSAEXCcuH5Maydr/i4ccBlfkA9eMbxb7xaF8TZQ1CyPt2J8m4A</font></div><div><font size="2"   >aub4FBzXWWpkPuVB1oUh1RUpcqxmXpXJwFBoTc4rmrogeOl7AJgsF+IcDe3mX/3D</font></div><div><font size="2"   >u0+bODAF2pCPYYRmBiwGhMmCU2mQoVdcsHHcPnUuEDi03n7Cx8nnhELQlf38lPcv</font></div><div><font size="2"   >dqaQTy3Vc5ju9WSbdlXqyDsydyQth28me/X0u39w9HHgd0mMsCbc8XPKTYOm5CEJ</font></div><div><font size="2"   >n8rQg/Z8Ik1cPE9SqJTNeOOqyVRSy8gqw67A/Z1a+P4/Ywl3jWwQWC2VzO1W+eEW</font></div><div><font size="2"   >VmzjgFo1AgMBAAGgADANBgkqhkiG9w0BAQUFAAOCAQEAXUZo2PQ1qEHwEFNDQhdO</font></div><div><font size="2"   >zYKp0ex9x36bHlvt/JMRqIHAKMQBUwsR+kuxpipRiTzQTG/hnZyv5qIf8Jr/gA6K</font></div><div><font size="2"   >qVlSE6Pwox8wLJ3kWAaqBmxCVi2MhubaIhaKZBx1U4v6sBZD7aP6jJsbHHqyYhHz</font></div><div><font size="2"   >yaUa3NjYvWylpkFXgwJ58XyfdebUZxiYmgXSiZj8ZcC9a2sURxzUY+66DmHBIYKi</font></div><div><font size="2"   >Lqx7mGx9aNvydV6S5cVnmbTxuMs1i36Y5235xh8ReMYo4+xJaydxFxgbRcvD1xxq</font></div><div><font size="2"   >nIjvVBUfuXb0ByyFXzmMU6K4JnOTRtNYPWe9TdAMcqqPuoGd0Uuobn+UrfADiPbc</font></div><div><font size="2"   >AQ==</font></div><div><font size="2"   >-----END CERTIFICATE REQUEST-----</font></div></div><div><div><font size="2"   >root@172-16-3-150:/tmp# cat server.crt</font></div><div><font size="2"   >-----BEGIN CERTIFICATE-----</font></div><div><font size="2"   >MIIDgzCCAmugAwIBAgIJAMDY6BIoiymHMA0GCSqGSIb3DQEBBQUAMFgxCzAJBgNV</font></div><div><font size="2"   >BAYTAkNOMREwDwYDVQQIEwhaaGVqaWFuZzERMA8GA1UEBxMISGFuZ3pob3UxEDAO</font></div><div><font size="2"   >BgNVBAoTB1NreW1vYmkxETAPBgNVBAMTCHBnc2VydmVyMB4XDTEzMDUyNDA1Mzcw</font></div><div><font size="2"   >OFoXDTEzMDYyMzA1MzcwOFowWDELMAkGA1UEBhMCQ04xETAPBgNVBAgTCFpoZWpp</font></div><div><font size="2"   >YW5nMREwDwYDVQQHEwhIYW5nemhvdTEQMA4GA1UEChMHU2t5bW9iaTERMA8GA1UE</font></div><div><font size="2"   >AxMIcGdzZXJ2ZXIwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDXTbY7</font></div><div><font size="2"   >SxyUL6z+feiWaB7DgWa10DPSAEXCcuH5Maydr/i4ccBlfkA9eMbxb7xaF8TZQ1Cy</font></div><div><font size="2"   >Pt2J8m4Aaub4FBzXWWpkPuVB1oUh1RUpcqxmXpXJwFBoTc4rmrogeOl7AJgsF+Ic</font></div><div><font size="2"   >De3mX/3Du0+bODAF2pCPYYRmBiwGhMmCU2mQoVdcsHHcPnUuEDi03n7Cx8nnhELQ</font></div><div><font size="2"   >lf38lPcvdqaQTy3Vc5ju9WSbdlXqyDsydyQth28me/X0u39w9HHgd0mMsCbc8XPK</font></div><div><font size="2"   >TYOm5CEJn8rQg/Z8Ik1cPE9SqJTNeOOqyVRSy8gqw67A/Z1a+P4/Ywl3jWwQWC2V</font></div><div><font size="2"   >zO1W+eEWVmzjgFo1AgMBAAGjUDBOMB0GA1UdDgQWBBQTRK0bZjIFkFfP2m2U7E2R</font></div><div><font size="2"   >qME3+TAfBgNVHSMEGDAWgBQTRK0bZjIFkFfP2m2U7E2RqME3+TAMBgNVHRMEBTAD</font></div><div><font size="2"   >AQH/MA0GCSqGSIb3DQEBBQUAA4IBAQAOAZKm1vmMaR2M6ZHB9U7RJnJSoQdcJUXz</font></div><div><font size="2"   >ckNHzgYhZwSYHaNvuvNILeoO0qsJxD2i9kDjBc+7MOFAhTaoFf5lfqQLKucKi+xh</font></div><div><font size="2"   >J82gWX4kOs3t0ECE9IqeWgRx8AraE1pdlyxu1XJZjVOCT1m4TO0aRbD9nzXiBnob</font></div><div><font size="2"   >x8oJmywRM1YRNtP6ETbxqoz2ntSRdpyp0jB2ApYYDqTdGewYgmQ8eT+lLR6XRC7l</font></div><div><font size="2"   >wCTGXz6sf371xQeq+5Ble1S9In4Sf1mbEBUwevFNsmY7e7b+58ATZziXECBjr0Hz</font></div><div><font size="2"   >baIjr5Clknf5+jb2Ab/zVaI2dRd5iNWn0xaUVjrtAHftIr5Qf5q+</font></div><div><font size="2"   >-----END CERTIFICATE-----</font></div></div><div><div><font size="2"   >root@172-16-3-150:/tmp# file server.crt&nbsp;</font></div><div><font size="2"   >server.crt: PEM certificate</font></div><div><font size="2"   >root@172-16-3-150:/tmp# file server.csr&nbsp;</font></div><div><font size="2"   >server.csr: PEM certificate request</font></div></div><p></p></pre></div><div><br></div><div>将签名后的server.crt拷贝到PostgreSQL 数据库$PGDATA目录.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@172-16-3-150:/tmp# sz server.crt</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; rz</font></div><p></p></pre></div><div>修改server.crt属性</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; chown pg93:pg93 $PGDATA/server.crt</font></div><div></div><p></p></pre></div><div>6. 在PostgreSQL 服务器上创建根证书. 其实就是合成CA公用证书和签名后的pgserver证书 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cp server.crt root.crt</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >把CA服务器上的/usr/local/share/ca-certificates/trustly-ca.crt内容添加到root.crt</span></div><div>合成后的root.crt内容如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cat root.crt&nbsp;</font></div><div><font size="2"   >-----BEGIN CERTIFICATE-----</font></div><div><font size="2"   >MIIDgzCCAmugAwIBAgIJAMDY6BIoiymHMA0GCSqGSIb3DQEBBQUAMFgxCzAJBgNV</font></div><div><font size="2"   >BAYTAkNOMREwDwYDVQQIEwhaaGVqaWFuZzERMA8GA1UEBxMISGFuZ3pob3UxEDAO</font></div><div><font size="2"   >BgNVBAoTB1NreW1vYmkxETAPBgNVBAMTCHBnc2VydmVyMB4XDTEzMDUyNDA1Mzcw</font></div><div><font size="2"   >OFoXDTEzMDYyMzA1MzcwOFowWDELMAkGA1UEBhMCQ04xETAPBgNVBAgTCFpoZWpp</font></div><div><font size="2"   >YW5nMREwDwYDVQQHEwhIYW5nemhvdTEQMA4GA1UEChMHU2t5bW9iaTERMA8GA1UE</font></div><div><font size="2"   >AxMIcGdzZXJ2ZXIwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDXTbY7</font></div><div><font size="2"   >SxyUL6z+feiWaB7DgWa10DPSAEXCcuH5Maydr/i4ccBlfkA9eMbxb7xaF8TZQ1Cy</font></div><div><font size="2"   >Pt2J8m4Aaub4FBzXWWpkPuVB1oUh1RUpcqxmXpXJwFBoTc4rmrogeOl7AJgsF+Ic</font></div><div><font size="2"   >De3mX/3Du0+bODAF2pCPYYRmBiwGhMmCU2mQoVdcsHHcPnUuEDi03n7Cx8nnhELQ</font></div><div><font size="2"   >lf38lPcvdqaQTy3Vc5ju9WSbdlXqyDsydyQth28me/X0u39w9HHgd0mMsCbc8XPK</font></div><div><font size="2"   >TYOm5CEJn8rQg/Z8Ik1cPE9SqJTNeOOqyVRSy8gqw67A/Z1a+P4/Ywl3jWwQWC2V</font></div><div><font size="2"   >zO1W+eEWVmzjgFo1AgMBAAGjUDBOMB0GA1UdDgQWBBQTRK0bZjIFkFfP2m2U7E2R</font></div><div><font size="2"   >qME3+TAfBgNVHSMEGDAWgBQTRK0bZjIFkFfP2m2U7E2RqME3+TAMBgNVHRMEBTAD</font></div><div><font size="2"   >AQH/MA0GCSqGSIb3DQEBBQUAA4IBAQAOAZKm1vmMaR2M6ZHB9U7RJnJSoQdcJUXz</font></div><div><font size="2"   >ckNHzgYhZwSYHaNvuvNILeoO0qsJxD2i9kDjBc+7MOFAhTaoFf5lfqQLKucKi+xh</font></div><div><font size="2"   >J82gWX4kOs3t0ECE9IqeWgRx8AraE1pdlyxu1XJZjVOCT1m4TO0aRbD9nzXiBnob</font></div><div><font size="2"   >x8oJmywRM1YRNtP6ETbxqoz2ntSRdpyp0jB2ApYYDqTdGewYgmQ8eT+lLR6XRC7l</font></div><div><font size="2"   >wCTGXz6sf371xQeq+5Ble1S9In4Sf1mbEBUwevFNsmY7e7b+58ATZziXECBjr0Hz</font></div><div><font size="2"   >baIjr5Clknf5+jb2Ab/zVaI2dRd5iNWn0xaUVjrtAHftIr5Qf5q+</font></div><div><font size="2"   >-----END CERTIFICATE-----</font></div><div><font size="2"   >-----BEGIN CERTIFICATE-----</font></div><div><font size="2"   >MIIDgTCCAmmgAwIBAgIJAIKNqfyd2XnOMA0GCSqGSIb3DQEBBQUAMFcxCzAJBgNV</font></div><div><font size="2"   >BAYTAkNOMREwDwYDVQQIDAhaaGVqaWFuZzERMA8GA1UEBwwISGFuZ3pob3UxEDAO</font></div><div><font size="2"   >BgNVBAoMB1NreW1vYmkxEDAOBgNVBAMMB3RydXN0bHkwHhcNMTMwNTI0MDUyNDUy</font></div><div><font size="2"   >WhcNMjMwNTIyMDUyNDUyWjBXMQswCQYDVQQGEwJDTjERMA8GA1UECAwIWmhlamlh</font></div><div><font size="2"   >bmcxETAPBgNVBAcMCEhhbmd6aG91MRAwDgYDVQQKDAdTa3ltb2JpMRAwDgYDVQQD</font></div><div><font size="2"   >DAd0cnVzdGx5MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsdCXygi7</font></div><div><font size="2"   >jx/Vs0KQHiPNCZxGsTkPTfWTjuDvDft7BVkRIdow+7LtFmdCoz5+nqfRRWUZPOJF</font></div><div><font size="2"   >6Eqc39DAqaWb0YzGYMWPlj3NJKwMwcw5FW5X7USr5SVWTmgf6IFxHsTuYptzWKDy</font></div><div><font size="2"   >LDE8Jkjm9RHRppkHpRaBdgWphQ8m0B4YEEJx0HzpPdAsd4YLuzHeswpmHenSO9eF</font></div><div><font size="2"   >wRaQRPG+cGMilaShSetVz904655t+WaJubzcur7AJPH3bcxCSlmApGcee4ydcm5j</font></div><div><font size="2"   >JAHXbQ26pPCe481MLYPQCHFatY2220PP2gre4g/4wQWd03tc3OU9AbdL+3wUuK3X</font></div><div><font size="2"   >eTwOfNcItj5KXQIDAQABo1AwTjAdBgNVHQ4EFgQUBK6vtbH8gu71m6rpW/iBnvZ2</font></div><div><font size="2"   >MuMwHwYDVR0jBBgwFoAUBK6vtbH8gu71m6rpW/iBnvZ2MuMwDAYDVR0TBAUwAwEB</font></div><div><font size="2"   >/zANBgkqhkiG9w0BAQUFAAOCAQEAEzMBp3Zn2TD3LW5S1lSoJ32G3FO8Auil71K8</font></div><div><font size="2"   >1K4BhedCj0x9Q1a3EGm4ve/cSiLSiSsO54g/+Cq81d5mxf4HHlHB8vZeFTQ73bwF</font></div><div><font size="2"   >xrNw1cCEHK166U7T+8A8VjesKGUGsjbFCcju/okLrjHBKxQBYkWSjOqpP39Ero9D</font></div><div><font size="2"   >3DcaLcvidUyh4cEOb/QQ5lhKZmLX78uwryfyk/nT70r3HMf9LlKCebQtTRbybtRZ</font></div><div><font size="2"   >rk2n+12o7IGEx5/ezV4ucAlfycuFVyGVqj7ZpyaStm7oOux1azuowJBSWoTH6PC9</font></div><div><font size="2"   >YKG0dB1ymkSYXZU7GIGDLyKOUHhxnV1kVINtPXEhxnnWohgB4A==</font></div><div><font size="2"   >-----END CERTIFICATE-----</font></div><p></p></pre></div><div><br></div><div>7. 为了管理方便, 可以为cert认证的用户添加一个组, 需要cert认证的用户都添加到这个组里面.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><div><font size="2"   >digoal=# create group sslcertgroup;</font></div><div><font size="2"   >CREATE ROLE</font></div></div><div><font size="2"   >将用户digoal加入这个组</font></div><div><div><font size="2"   >digoal=# alter group sslcertgroup add user digoal;</font></div><div><font size="2"   >ALTER ROLE</font></div></div><p></p></pre></div><div><br></div><div>8. 配置pg_hba.conf, 允许client 1连接.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd $PGDATA</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; vi pg_hba.conf&nbsp;</font></div></div><div><font size="2"   ># 允许sslcertgroup这个组使用cert认证方式从<span style="line-height: 22px;"   >172.16.3.39</span><span style="line-height: 22px;"   >连接所有数据库.</span></font></div><div><font size="2"   >hostssl all +sslcertgroup 172.16.3.39/32 cert clientcert=1</font></div><p></p></pre></div><div><br></div><div>9. 配置postgresql.conf 打开ssl</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >pg93@db-172-16-3-33-&gt;&nbsp;</span>vi $PGDATA/postgresql.conf</font></div><div><font size="2"   >ssl = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >ssl_ciphers = 'RC4-SHA:DEFAULT:!LOW:!EXP:!MD5:@STRENGTH' &nbsp; &nbsp; &nbsp; &nbsp;# allowed SSL ciphers</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >ssl_renegotiation_limit = 512MB # amount of data between renegotiations</font></div><div><font size="2"   >ssl_cert_file = 'server.crt' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >ssl_key_file = 'server.key' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >ssl_ca_file = 'root.crt' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><p></p></pre></div><div>重启数据库, 如果没有修改以上配置则不需要重启数据库, reload即可.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg_ctl restart -m fast</font></div><div></div><p></p></pre></div><div>10. 配置需要使用cert认证连接数据库的客户端, 需要用到固定格式的目录和文件如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >~/.postgresql</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >~/.postgresql/postgresql.key</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >~/.postgresql/postgresql.crt</font></span></div><p></p></pre></div><div><span style="line-height: 22px;"   >具体操作如下 :&nbsp;</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# su - pg92</font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; mkdir ~/.postgresql</font></div><p></p></pre></div><div>为了确保安全, 建议修改~/.postgresql权限为700</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; chmod 700 .postgresql</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >生成client key.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; openssl genrsa -des3 -out ~/.postgresql/postgresql.key 1024</font></div><div><font size="2"   >Enter pass phrase for /home/pg92/.postgresql/postgresql.key: 输入Client-3.39</font></div><div><font size="2"   >Verifying - Enter pass phrase for /home/pg92/.postgresql/postgresql.key: 再次输入Client-3.39</font></div><p></p></pre></div></div><div>如果不想每次新建连接都提示输入pass phrase, 可以删除pass phrase, 但是你要知道这样降低了安全性 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; openssl rsa -in ~/.postgresql/postgresql.key -out ~/.postgresql/postgresql.key</font></div><div><font size="2"   >Enter pass phrase for /home/pg92/.postgresql/postgresql.key:&nbsp;<span style="line-height: 22px;"   >输入Client-3.39</span></font></div><div><font size="2"   >writing RSA key</font></div><p></p></pre></div><div>生成请求CA签名的文件</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; openssl req -new -key ~/.postgresql/postgresql.key -out ~/.postgresql/postgresql.csr \</font></div><div><font size="2"   >&gt; -subj '/C=CN/ST=Zhejiang/L=Hangzhou/O=Skymobi/CN=client1'</font></div><p></p></pre></div><div><br></div><div>11. 给客户端证书签名</div><div>将客户端的<span style="line-height: 22px;"   >~/.postgresql/postgresql.csr拷贝到CA服务器进行签名.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; sz postgresql.csr</font></div><div><span style="line-height: 22px;"   ><font size="2"   ><div>root@172-16-3-150:/tmp# cd /tmp</div><div>root@172-16-3-150:/tmp# rz</div></font></span></div><div><div><font size="2"   >root@172-16-3-150:/tmp# openssl x509 -req -in /tmp/postgresql.csr \</font></div><div><font size="2"   >&gt; -CA /usr/local/share/ca-certificates/trustly-ca.crt \</font></div><div><font size="2"   >&gt; -CAkey /etc/ssl/private/trustly-ca.key \</font></div><div><font size="2"   >&gt; -out /tmp/postgresql.crt \</font></div><div><font size="2"   >&gt; -CAcreateserial</font></div><div><font size="2"   >Signature ok</font></div><div><font size="2"   >subject=/C=CN/ST=Zhejiang/L=Hangzhou/O=Skymobi/CN=client1</font></div><div><font size="2"   >Getting CA Private Key</font></div><div><font size="2"   >Enter pass phrase for /etc/ssl/private/trustly-ca.key: 输入pass phrase : digoal</font></div></div><p></p></pre></div><div>查看生成的证书 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@172-16-3-150:/tmp# file postgresql.crt&nbsp;</font></div><div><font size="2"   >postgresql.crt: PEM certificate</font></div><div><font size="2"   >root@172-16-3-150:/tmp# cat postgresql.crt&nbsp;</font></div><div><font size="2"   >-----BEGIN CERTIFICATE-----</font></div><div><font size="2"   >MIICpjCCAY4CCQC1fNg1fevU+zANBgkqhkiG9w0BAQUFADBXMQswCQYDVQQGEwJD</font></div><div><font size="2"   >TjERMA8GA1UECAwIWmhlamlhbmcxETAPBgNVBAcMCEhhbmd6aG91MRAwDgYDVQQK</font></div><div><font size="2"   >DAdTa3ltb2JpMRAwDgYDVQQDDAd0cnVzdGx5MB4XDTEzMDUyNDA2MDU1OFoXDTEz</font></div><div><font size="2"   >MDYyMzA2MDU1OFowVzELMAkGA1UEBhMCQ04xETAPBgNVBAgTCFpoZWppYW5nMREw</font></div><div><font size="2"   >DwYDVQQHEwhIYW5nemhvdTEQMA4GA1UEChMHU2t5bW9iaTEQMA4GA1UEAxMHY2xp</font></div><div><font size="2"   >ZW50MTCBnzANBgkqhkiG9w0BAQEFAAOBjQAwgYkCgYEAt9nljMDVCkGYFwc/dPTC</font></div><div><font size="2"   >BSqEyUtPFnRIH/Ce4TPdp5/ch5jvQgQsi1dLpzmVAJLoFfhBZlMsdQKWhbZoIgVH</font></div><div><font size="2"   >supSUiUCUbuaSf/A6XtezTvFNmCCKF7VGzjkW1LZhAmq4RrFq1q+0kcDJD9tw4mW</font></div><div><font size="2"   >BKTr0qZczEPnq99QJCZLNZMCAwEAATANBgkqhkiG9w0BAQUFAAOCAQEAc9u3jnnj</font></div><div><font size="2"   >vQTF2C+8jK7dGkuWPYGlg9Qned/aFfGBL43NM2E65Yr6IldaEfYTUK5ydz0IXY0B</font></div><div><font size="2"   >Pk4qpR3bCww+CNKpX30/UCgHzW7CjHu5COR9ruhv1juUY9eQgFQnTC7ppCWIJt7d</font></div><div><font size="2"   >c4QdciTrTR5zK7p+Tx8vFhk1FfP65IxK3Ag2CR6/KEze4Qf5KGTPvxOWnJaW9dyN</font></div><div><font size="2"   >RZKMB0DnXuHGRp5mIQDBz7ZKVoC6FrslLxDrsU89P+9jiU+nW5RP+VMkDgx9ArID</font></div><div><font size="2"   >F2QYtQ0VxShA8f9d3gLmW/XAkeQD39eqt2mayS8IAKrOtlS9hjljm7ipsZmPQ8gZ</font></div><div><font size="2"   >jyLM9rdT7uWVqA==</font></div><div><font size="2"   >-----END CERTIFICATE-----</font></div><p></p></pre></div><div>将证书内容写入客户端的~/.postgresql/postgresql.crt即可</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; vi ~/.postgresql/postgresql.crt</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >写入以上内容.</span></div><div>修改key文件权限 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >pg92@db-172-16-3-39-&gt; chmod 400 postgresql.key</font></p></pre></div><div><br></div><div>12. 连接数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; psql -h 172.16.3.33 -p 1999 -U digoal digoal</font></div><div><font size="2"   >psql: FATAL: &nbsp;certificate authentication failed for user "digoal"</font></div><div><font size="2"   >FATAL: &nbsp;no pg_hba.conf entry for host "172.16.3.39", user "digoal", database "digoal", SSL off</font></div><p></p></pre></div><div>这是为什么呢?</div><div>digoal用户应该是可以连接的啊.</div><div>原因是创建的客户端证书, 注意11步<span style="line-height: 22px;"   >生成请求CA签名的文件.</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >pg92@db-172-16-3-39-&gt; openssl req -new -key ~/.postgresql/postgresql.key -out ~/.postgresql/postgresql.csr \</font></div><div style="line-height: 22px;"   ><font size="2"   >&gt; -subj '/C=CN/ST=Zhejiang/L=Hangzhou/O=Skymobi/CN=client1'</font></div><p></p></pre></div></div><div style="line-height: 22px;"   >CN=client1. 这个指和数据库用户client1匹配.</div><div style="line-height: 22px;"   >在数据库中创建client1用户即可</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><div><font size="2"   >digoal=# create role client1 login encrypted password 'client1';</font></div><div><font size="2"   >CREATE ROLE</font></div></div><p></p></pre></div><div>再次连接 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; psql -h 172.16.3.33 -p 1999 -U client1 digoal</font></div><div><font size="2"   >psql: FATAL: &nbsp;no pg_hba.conf entry for host "172.16.3.39", user "client1", database "digoal", SSL on</font></div><div><font size="2"   >FATAL: &nbsp;no pg_hba.conf entry for host "172.16.3.39", user "client1", database "digoal", SSL off</font></div><p></p></pre></div><div>因为还没有加到sslcertgroup组, 添加后再连接即可.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><div><font size="2"   >digoal=# alter group sslcertgroup add user client1 ;</font></div><div><font size="2"   >ALTER ROLE</font></div></div><p></p></pre></div><div>再次连接, 正常 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg92@db-172-16-3-39-&gt; psql -h 172.16.3.33 -p 1999 -U client1 digoal</font></div><div><font size="2"   >psql (9.2beta1, server 9.3devel)</font></div><div><font size="2"   >WARNING: psql version 9.2, server version 9.3.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Some psql features might not work.</font></div><div><font size="2"   >SSL connection (cipher: RC4-SHA, bits: 128)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><font size="2"   >digoal=&gt;&nbsp;</font></div><p></p></pre></div><div><br></div><div>这就带来一个问题, 如果172.16.3.39需要使用多个用户连接数据库时怎么办呢?&nbsp;</div><div>例如要使用digoal用户登录数据库.&nbsp;</div><div>那么又需要到CA服务器签名, 然后将证书的内容合并到~/.postgresql/postgresql.crt.</div><div>或者使用postgresql支持的user mapping.</div><div>配置方法如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; vi $PGDATA/pg_ident.conf</font></div><div><font size="2"   ># MAPNAME &nbsp; &nbsp; &nbsp; SYSTEM-USERNAME &nbsp; &nbsp; &nbsp; &nbsp; PG-USERNAME</font></div><div><div><font size="2"   >m1 client1 client1</font></div><div><font size="2"   >m1 client1 digoal</font></div></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; vi&nbsp;<span style="line-height: 22px;"   >$PGDATA</span><span style="line-height: 22px;"   >/pg_hba.conf</span></font></div><div><font size="2"   >hostssl all +sslcertgroup 172.16.3.39/32 cert clientcert=1,map=m1</font></div><p></p></pre></div><div># reload配置</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_ctl reload</font></div><div><font size="2"   >server signaled</font></div><p></p></pre></div><div><br></div><div>接下来客户端就可以用digoal和client1用户登录了. 当然前提是他们在sslcertgroup组里面.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; psql -h 172.16.3.33 -p 1999 -U client1 digoal</font></div><div><font size="2"   >psql (9.2beta1, server 9.3devel)</font></div><div><font size="2"   >WARNING: psql version 9.2, server version 9.3.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Some psql features might not work.</font></div><div><font size="2"   >SSL connection (cipher: RC4-SHA, bits: 128)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=&gt; \q</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg92@db-172-16-3-39-&gt; psql -h 172.16.3.33 -p 1999 -U digoal digoal</font></div><div><font size="2"   >psql (9.2beta1, server 9.3devel)</font></div><div><font size="2"   >WARNING: psql version 9.2, server version 9.3.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Some psql features might not work.</font></div><div><font size="2"   >SSL connection (cipher: RC4-SHA, bits: 128)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=&gt; \q</font></div><p></p></pre></div><div><br></div><div>其他用户因为没有配置user mapping, 所以无法登陆. 例如想使用postgres用户登录.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; psql -h 172.16.3.33 -p 1999 -U postgres digoal</font></div><div><font size="2"   >psql: FATAL: &nbsp;certificate authentication failed for user "postgres"</font></div><div><font size="2"   >FATAL: &nbsp;no pg_hba.conf entry for host "172.16.3.39", user "postgres", database "digoal", SSL off</font></div><p></p></pre></div><div>想登录的话, 配置好即可.</div><div>1. 配置group, 即使是超级用户也需要配置到组里面, 例如这里的postgres用户.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# alter group sslcertgroup add user postgres ;</font></div><div><font size="2"   >ALTER ROLE</font></div><p></p></pre></div><div>2. 配置pg_ident.conf, 加一条 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >m1 client1 postgres</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >3. 检查pg_hba.conf有这个map配置.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >hostssl all +sslcertgroup 172.16.3.39/32 cert clientcert=1,map=m1</font></div><div></div><p></p></pre></div><div><span style="line-height: 22px;"   >4. 连接, 正常</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-39-&gt; psql -h 172.16.3.33 -p 1999 -U postgres digoal</font></div><div><font size="2"   >psql (9.2beta1, server 9.3devel)</font></div><div><font size="2"   >WARNING: psql version 9.2, server version 9.3.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Some psql features might not work.</font></div><div><font size="2"   >SSL connection (cipher: RC4-SHA, bits: 128)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \q</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >[其他]</span></div><div><span style="line-height: 22px;"   >1. 如果key和证书同时泄露是非常危险的, 就相当于泄露了密码一样.</span></div><div><span style="line-height: 22px;"   >假设172.16.3.40获得了172.16.3.39上的postgresql.key和postgresql.crt</span></div><div><span style="line-height: 22px;"   >那么就可以用来连接数据库了.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-40-&gt; psql -h 172.16.3.33 -p 1999 -U digoal postgres</font></div><div><font size="2"   >psql: FATAL: &nbsp;no pg_hba.conf entry for host "172.16.3.40", user "digoal", database "postgres", SSL on</font></div><div><font size="2"   >FATAL: &nbsp;no pg_hba.conf entry for host "172.16.3.40", user "digoal", database "postgres", SSL off</font></div><p></p></pre></div><div>在172.16.3.39上开端口代理即可.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# balance 20000 172.16.3.33:1999</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >连接代理端口 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-40-&gt; psql -h 172.16.3.39 -p 20000 -U digoal postgres</font></div><div><font size="2"   >psql (9.2beta1, server 9.3devel)</font></div><div><font size="2"   >WARNING: psql version 9.2, server version 9.3.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Some psql features might not work.</font></div><div><font size="2"   >SSL connection (cipher: RC4-SHA, bits: 128)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=&gt;&nbsp;</font></div><p></p></pre></div><div>又或者你的pg_hba.conf中本来就开放了172.16.3.0/24网段, 那就可以直接连接了. 不需要端口代理.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; vi pg_hba.conf</font></div><div><font size="2"   >hostssl all +sslcertgroup 172.16.3.0/24 cert clientcert=1,map=m1</font></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_ctl reload</font></div><div><font size="2"   >server signaled</font></div></div><p></p></pre></div><div>从攻击机直连 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-40-&gt; psql -h 172.16.3.33 -p 1999 -U digoal postgres</font></div><div><font size="2"   >psql (9.2beta1, server 9.3devel)</font></div><div><font size="2"   >WARNING: psql version 9.2, server version 9.3.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Some psql features might not work.</font></div><div><font size="2"   >SSL connection (cipher: RC4-SHA, bits: 128)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=&gt;&nbsp;</font></div><p></p></pre></div><div>所以为了安全, 请务必配置好pg_hba.conf, 以及保护好密码和密钥.</div><div><br></div><div>2. 在windows中使用pgadmin以及ssl模式连接数据库.</div><div>把客户端生成的postgresql.crt, postgresql.key, 以及服务端的root.crt文件拷贝到windows中.</div><div>然后配置连接, 如图 :&nbsp;</div><div>最高验证级别为sslmode=verify-full, 会去匹配连接主机和root.crt中配置的CN=pgserver. 所以需要编辑本地的hosts文件, 直接连IP的话是不允许的. 如果使用其他的sslmode则不需要匹配CN.</div><div>这里不需要配置crl文件, 因为是自签名的.</div><div><div><img title="PostgreSQL cert client auth method configed with hostssl and user mapping - 德哥@Digoal - PostgreSQL"   alt="PostgreSQL cert client auth method configed with hostssl and user mapping - 德哥@Digoal - PostgreSQL"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/iiSOI5VntBiW1dhBPGXGDA==/2455024746970504459.png"   ></div><div>主机名使用root.crt中配置的CN=pgserver</div><div><img title="PostgreSQL cert client auth method configed with hostssl and user mapping - 德哥@Digoal - PostgreSQL"   alt="PostgreSQL cert client auth method configed with hostssl and user mapping - 德哥@Digoal - PostgreSQL"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/4LVjVN2LEeR0PrEjP-PfbA==/3296353452358916472.png"   ></div><div>编辑hosts, 添加一行 :&nbsp;</div><div>172.16.3.150 pgserver</div><div><img title="PostgreSQL cert client auth method configed with hostssl and user mapping - 德哥@Digoal - PostgreSQL"   alt="PostgreSQL cert client auth method configed with hostssl and user mapping - 德哥@Digoal - PostgreSQL"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/Vf8ZnkhBrzxGh8URwqDW5A==/2986168028023389242.png"   ></div>然后就可以连接了.</div><div><br></div><div>3. sslmode相关的模式和可以避免的攻击方式</div><div><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; background-color: rgb(224, 236, 239); border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"   ><thead><tr><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   ><tt>sslmode</tt></th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Eavesdropping protection</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   ><acronym>MITM&nbsp;protection</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Statement</th></tr></thead><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>disable</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >No</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >No</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >I don't care about security, and I don't want to pay the overhead of encryption.</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   ><tt>allow</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   >Maybe</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   >No</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   >I don't care about security, but I will pay the overhead of encryption if the server insists on it.</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>prefer</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Maybe</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >No</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >I don't care about encryption, but I wish to pay the overhead of encryption if the server supports it.</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>require</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Yes</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >No</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >I want my data to be encrypted, and I accept the overhead. I trust that the network will make sure I always connect to the server I want.</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>verify-ca</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Yes</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>Depends on CA</tt>-policy</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >I want my data encrypted, and I accept the overhead. I want to be sure that I connect to a server that I trust.</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>verify-full</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Yes</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Yes</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >I want my data encrypted, and I accept the overhead. I want to be sure that I connect to a server I trust, and that it's the one I specify.</td></tr></table></div><br><wbr>【参考】<div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/auth-pg-hba-conf.html#EXAMPLE-PG-HBA.CONF"   >http://www.postgresql.org/docs/9.3/static/auth-pg-hba-conf.html#EXAMPLE-PG-HBA.CONF</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/auth-username-maps.html"   >http://www.postgresql.org/docs/9.3/static/auth-username-maps.html</a></div><div>3.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/auth-methods.html#AUTH-CERT"   >http://www.postgresql.org/docs/9.3/static/auth-methods.html#AUTH-CERT</a></div><div>4.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201342233131835/"   >http://blog.163.com/digoal@126/blog/static/163877040201342233131835/</a></div>5.&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013423102431541/"   >http://blog.163.com/digoal@126/blog/static/1638770402013423102431541/</a><br><div>6. libpq数据库连接函数参考</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/libpq-connect.html#LIBPQ-CONNSTRING"   >http://www.postgresql.org/docs/9.3/static/libpq-connect.html#LIBPQ-CONNSTRING</a></div><div>7.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/libpq-ssl.html"   >http://www.postgresql.org/docs/9.3/static/libpq-ssl.html</a></div><div>8.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/ssl-tcp.html"   >http://www.postgresql.org/docs/devel/static/ssl-tcp.html</a></div><div>9.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://en.wikipedia.org/wiki/Spoofing_attack"   >http://en.wikipedia.org/wiki/Spoofing_attack</a></div></div>
	</div>
</div>
</body>
</html>