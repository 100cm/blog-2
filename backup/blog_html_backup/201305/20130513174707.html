<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL partition table global constraint</h2>
	<h5 id="">2013-05-13 17:47:07&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201341353342245/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">PostgreSQL 中分表一般可以通过继承和触发器或者rule来实现.&nbsp;<div>没有接触过的朋友可以先阅读以下文章 :&nbsp;</div><div>PostgreSQL general public partition table trigger</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020128772037884/"   >http://blog.163.com/digoal@126/blog/static/16387704020128772037884/</a></div><div>execute plan difference between Oracle and PostgreSQL's partition table</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201212432441676/"   >http://blog.163.com/digoal@126/blog/static/163877040201212432441676/</a><wbr></div><div>PostgreSQL Partition Table Example</div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402012325111528424/"   >http://blog.163.com/digoal@126/blog/static/1638770402012325111528424/</a></div><div>PostgreSQL partition table or inherits table predict count and gap and privilege monitor</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020130433036377/"   >http://blog.163.com/digoal@126/blog/static/16387704020130433036377/</a></div><div>PostgreSQL partition table name convert to data type</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020130525628988/"   >http://blog.163.com/digoal@126/blog/static/16387704020130525628988/</a></div><div>PostgreSQL partition table or inherits table predict count and gap and privilege monitor</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020130433036377/"   >http://blog.163.com/digoal@126/blog/static/16387704020130433036377/</a></div><div>PostgreSQL partition table's arithmetic tuning example</div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402011210114036419/"   >http://blog.163.com/digoal@126/blog/static/1638770402011210114036419/</a></div><div>注意PostgreSQL 分区表的约束有一个问题, 是子表层面的约束, 而非全局约束.</div><div>例如唯一或主键的例子. 如果分区的字段不是约束字段, 那么这个约束就无法做到全局唯一.</div><div>例如按主键分区的例子 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create table t(id int primary key, info text, crt_time timestamp);</font></div><div><font size="2"   >create table t1(like t including all) inherits(t);</font></div><div><span style="line-height: 22px;"   ><font size="2"   >create table t2(like t including all) inherits(t);</font></span></div><p></p></pre></div><div><span style="line-height: 22px;"   >假设t为主表, t1, t2为子表.</span></div><div><span style="line-height: 22px;"   >如果要id全局唯一, 通常的做法是要对t1, t2都加约束, 例如hash取模, 或者t1和t2使用不同的值范围区间.</span></div><div><span style="line-height: 22px;"   >但是如果你使用的是crt_time这个字段作为分区字段的话, 抱歉, 你没有好的办法去约束t1.id和t2.id全局唯一.&nbsp;</span></div><div>所以本文要解决的就是这个问题.</div><div>方法如下 :&nbsp;</div><div>增加一个全局约束表, 同时给所有的表增加规则.&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >create table test(id int, info text);</font></div><div><font size="2"   >create table test_1 (like test including all) inherits(test);</font></div><div><font size="2"   >create table test_2 (like test including all) inherits(test);</font></div><div><font size="2"   >create table test_3 (like test including all) inherits(test);</font></div><div><font size="2"   >create table test_4 (like test including all) inherits(test);</font></div><div><font size="2"   >create table test_5 (like test including all) inherits(test);</font></div><div><font size="2"   >create table test_6 (like test including all) inherits(test);</font></div><div><font size="2"   >create table test_7 (like test including all) inherits(test);</font></div><div><font size="2"   >create table test_8 (like test including all) inherits(test);</font></div><div><font size="2"   >create table test_uk(id int primary key);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create or replace rule r_insert as on insert to test do also insert into test_uk(id) values (NEW.id);</font></div><div><font size="2"   >create or replace rule r_insert as on insert to test_1 do also insert into test_uk(id) values (NEW.id);</font></div><div><font size="2"   >create or replace rule r_insert as on insert to test_2 do also insert into test_uk(id) values (NEW.id);</font></div><div><font size="2"   >create or replace rule r_insert as on insert to test_3 do also insert into test_uk(id) values (NEW.id);</font></div><div><font size="2"   >create or replace rule r_insert as on insert to test_4 do also insert into test_uk(id) values (NEW.id);</font></div><div><font size="2"   >create or replace rule r_insert as on insert to test_5 do also insert into test_uk(id) values (NEW.id);</font></div><div><font size="2"   >create or replace rule r_insert as on insert to test_6 do also insert into test_uk(id) values (NEW.id);</font></div><div><font size="2"   >create or replace rule r_insert as on insert to test_7 do also insert into test_uk(id) values (NEW.id);</font></div><div><font size="2"   >create or replace rule r_insert as on insert to test_8 do also insert into test_uk(id) values (NEW.id);</font></div></div><div></div><p></p></pre></div></div><div>注意到test, test_1到test_8都没有主键了, 因为确实不需要主键了, 他们的约束在test_uk全局完成.</div><div>如果对test, test_1到test_8的id字段有where条件查询需求, 那么可以加上索引即可. 不需要加pk.</div><div><br></div><div>对于更新和删除建立相应的rule即可.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace rule r_update as on update to test do also update test_uk set id=NEW.id where id=OLD.id and NEW.id&lt;&gt;OLD.id;</font></div><div><font size="2"   >create or replace rule r_update as on update to test_1 do also update test_uk set id=NEW.id where id=OLD.id and NEW.id&lt;&gt;OLD.id;</font></div><div><font size="2"   >create or replace rule r_update as on update to test_2 do also update test_uk set id=NEW.id where id=OLD.id and NEW.id&lt;&gt;OLD.id;</font></div><div><font size="2"   >create or replace rule r_update as on update to test_3 do also update test_uk set id=NEW.id where id=OLD.id and NEW.id&lt;&gt;OLD.id;</font></div><div><font size="2"   >create or replace rule r_update as on update to test_4 do also update test_uk set id=NEW.id where id=OLD.id and NEW.id&lt;&gt;OLD.id;</font></div><div><font size="2"   >create or replace rule r_update as on update to test_5 do also update test_uk set id=NEW.id where id=OLD.id and NEW.id&lt;&gt;OLD.id;</font></div><div><font size="2"   >create or replace rule r_update as on update to test_6 do also update test_uk set id=NEW.id where id=OLD.id and NEW.id&lt;&gt;OLD.id;</font></div><div><font size="2"   >create or replace rule r_update as on update to test_7 do also update test_uk set id=NEW.id where id=OLD.id and NEW.id&lt;&gt;OLD.id;</font></div><div><font size="2"   >create or replace rule r_update as on update to test_8 do also update test_uk set id=NEW.id where id=OLD.id and NEW.id&lt;&gt;OLD.id;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create or replace rule r_delete as on delete to test do also delete from test_uk where id=OLD.id;</font></div><div><font size="2"   >create or replace rule r_delete as on delete to test_1 do also delete from test_uk where id=OLD.id;</font></div><div><font size="2"   >create or replace rule r_delete as on delete to test_2 do also delete from test_uk where id=OLD.id;</font></div><div><font size="2"   >create or replace rule r_delete as on delete to test_3 do also delete from test_uk where id=OLD.id;</font></div><div><font size="2"   >create or replace rule r_delete as on delete to test_4 do also delete from test_uk where id=OLD.id;</font></div><div><font size="2"   >create or replace rule r_delete as on delete to test_5 do also delete from test_uk where id=OLD.id;</font></div><div><font size="2"   >create or replace rule r_delete as on delete to test_6 do also delete from test_uk where id=OLD.id;</font></div><div><font size="2"   >create or replace rule r_delete as on delete to test_7 do also delete from test_uk where id=OLD.id;</font></div><div><font size="2"   >create or replace rule r_delete as on delete to test_8 do also delete from test_uk where id=OLD.id;</font></div><p></p></pre></div><div><br></div></div>[压力测试]<div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >将</font></div><div><font size="2"   >create table test(id int, info text);</font></div><div><font size="2"   >该为</font></div><div><font size="2"   >create table test(id serial4, info text);</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >pgbench脚本</span></div><div><div>cat ins.sql</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >insert into test(info) values ('test');</font></div><div><font size="2"   >insert into test_1(info) values ('test');</font></div><div><font size="2"   >insert into test_2(info) values ('test');</font></div><div><font size="2"   >insert into test_3(info) values ('test');</font></div><div><font size="2"   >insert into test_4(info) values ('test');</font></div><div><font size="2"   >insert into test_5(info) values ('test');</font></div><div><font size="2"   >insert into test_6(info) values ('test');</font></div><div><font size="2"   >insert into test_7(info) values ('test');</font></div><div><font size="2"   >insert into test_8(info) values ('test');</font></div><p></p></pre></div></div><div>测试结果 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -n -r -f ./ins.sql -T 60 -c 16 -j 4 <br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 16<br>number of threads: 4<br>duration: 60 s<br>number of transactions actually processed: 190070<br>tps = 3166.301318 (including connections establishing)<br>tps = 3167.459441 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        0.620477        insert into test(info) values ('test');<br>        0.569200        insert into test_1(info) values ('test');<br>        0.547128        insert into test_2(info) values ('test');<br>        0.555751        insert into test_3(info) values ('test');<br>        0.565593        insert into test_4(info) values ('test');<br>        0.534713        insert into test_5(info) values ('test');<br>        0.544489        insert into test_6(info) values ('test');<br>        0.555604        insert into test_7(info) values ('test');<br>        0.548428        insert into test_8(info) values ('test');</span></font></div><p></p></pre></div><div>相当于28503 insert tuples/s.<br>调整sequence cache后重新测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# alter sequence test_id_seq cache 100;</font></div><div><font size="2"   >ALTER SEQUENCE</font></div></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -n -r -f ./ins.sql -T 60 -c 16 -j 4&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 247980</font></div><div><font size="2"   >tps = 4131.280217 (including connections establishing)</font></div><div><font size="2"   >tps = 4132.752414 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.429888 &nbsp; &nbsp; &nbsp; &nbsp;insert into test(info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.428328 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_1(info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.416872 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_2(info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.426108 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_3(info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.435344 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_4(info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.426916 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_5(info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.429839 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_6(info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.436503 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_7(info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.432641 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_8(info) values ('test');</font></div></div><p></p></pre></div><div>性能相当于37188 insert tuples/s.</div><div>数据约束准确.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select count(distinct id) from test;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;6420357</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select count(distinct id) from test_uk;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;6420357</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >单子表测试性能 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; vi ins.sql</font></div><div><font size="2"   >insert into test_1(info) values ('test');</font></div></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -n -r -f ./ins.sql -T 60 -c 16 -j 4&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 2221629</font></div><div><font size="2"   >tps = 37014.441092 (including connections establishing)</font></div><div><font size="2"   >tps = 37028.853944 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.430538 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_1(info) values ('test');</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >对比单表(无rule情况)测试结果 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create table t(id serial4 primary key, info text);</font></div><div><div style="line-height: 22px;"   ><font size="2"   >cat ins.sql</font></div><div style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into t(info) values ('test');</font></div></div></div><p></p></pre></div><div>测试结果</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -n -r -f ./ins.sql -T 60 -c 16 -j 4&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 2307961</font></div><div><font size="2"   >tps = 38441.207992 (including connections establishing)</font></div><div><font size="2"   >tps = 38453.498771 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.414512 &nbsp; &nbsp; &nbsp; &nbsp;insert into t(info) values ('test');</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >调整sequence cache后重新测试 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# alter sequence t_id_seq cache 100;</font></div><div><font size="2"   >ALTER SEQUENCE</font></div></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -n -r -f ./ins.sql -T 60 -c 16 -j 4&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 2477591</font></div><div><font size="2"   >tps = 41288.409705 (including connections establishing)</font></div><div><font size="2"   >tps = 41304.253390 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.385917 &nbsp; &nbsp; &nbsp; &nbsp;insert into t(info) values ('test');</font></div></div><p></p></pre></div><div>使用规则后性能略有下降, 约10%.</div></div><div><br></div>【本例触发器/rules性能比较】<div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# drop table test cascade;</font></div><div><font size="2"   >NOTICE: &nbsp;drop cascades to 8 other objects</font></div><div><font size="2"   >DETAIL: &nbsp;drop cascades to table test_1</font></div><div><font size="2"   >drop cascades to table test_2</font></div><div><font size="2"   >drop cascades to table test_3</font></div><div><font size="2"   >drop cascades to table test_4</font></div><div><font size="2"   >drop cascades to table test_5</font></div><div><font size="2"   >drop cascades to table test_6</font></div><div><font size="2"   >drop cascades to table test_7</font></div><div><font size="2"   >drop cascades to table test_8</font></div><div><font size="2"   >dDROP TABLE</font></div><div><font size="2"   >postgres=# drop table test_uk ;</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# create or replace function tg_delete() returns trigger as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; delete from test_uk where id = OLD.id; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; return OLD;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# create or replace function tg_update() returns trigger as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; update test_uk set id=NEW.id where NEW.id&lt;&gt;OLD.id and id=OLD.id;</font></div><div><font size="2"   >&nbsp; return NEW;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# create or replace function tg_insert() returns trigger as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; insert into test_uk values(NEW.id);</font></div><div><font size="2"   >&nbsp; return NEW;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create table test(id serial4, info text);</font></div><div><font size="2"   >alter sequence test_id_seq cache 100;</font></div><div><font size="2"   >create table test_1 (like test including all) inherits(test);</font></div><div><font size="2"   >create table test_2 (like test including all) inherits(test);</font></div><div><font size="2"   >create table test_3 (like test including all) inherits(test);</font></div><div><font size="2"   >create table test_4 (like test including all) inherits(test);</font></div><div><font size="2"   >create table test_5 (like test including all) inherits(test);</font></div><div><font size="2"   >create table test_6 (like test including all) inherits(test);</font></div><div><font size="2"   >create table test_7 (like test including all) inherits(test);</font></div><div><font size="2"   >create table test_8 (like test including all) inherits(test);</font></div><div><font size="2"   >create table test_uk(id int primary key);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create trigger tg1 before insert on test for each row execute procedure tg_insert();</font></div><div><font size="2"   >create trigger tg2 before update on test for each row execute procedure tg_update();</font></div><div><font size="2"   >create trigger tg3 before delete on test for each row execute procedure tg_delete();</font></div><div><font size="2"   >create trigger tg1 before insert on test_1 for each row execute procedure tg_insert();</font></div><div><font size="2"   >create trigger tg2 before update on test_1 for each row execute procedure tg_update();</font></div><div><font size="2"   >create trigger tg3 before delete on test_1 for each row execute procedure tg_delete();</font></div><div><font size="2"   >create trigger tg1 before insert on test_2 for each row execute procedure tg_insert();</font></div><div><font size="2"   >create trigger tg2 before update on test_2 for each row execute procedure tg_update();</font></div><div><font size="2"   >create trigger tg3 before delete on test_2 for each row execute procedure tg_delete();</font></div><div><font size="2"   >create trigger tg1 before insert on test_3 for each row execute procedure tg_insert();</font></div><div><font size="2"   >create trigger tg2 before update on test_3 for each row execute procedure tg_update();</font></div><div><font size="2"   >create trigger tg3 before delete on test_3 for each row execute procedure tg_delete();</font></div><div><font size="2"   >create trigger tg1 before insert on test_4 for each row execute procedure tg_insert();</font></div><div><font size="2"   >create trigger tg2 before update on test_4 for each row execute procedure tg_update();</font></div><div><font size="2"   >create trigger tg3 before delete on test_4 for each row execute procedure tg_delete();</font></div><div><font size="2"   >create trigger tg1 before insert on test_5 for each row execute procedure tg_insert();</font></div><div><font size="2"   >create trigger tg2 before update on test_5 for each row execute procedure tg_update();</font></div><div><font size="2"   >create trigger tg3 before delete on test_5 for each row execute procedure tg_delete();</font></div><div><font size="2"   >create trigger tg1 before insert on test_6 for each row execute procedure tg_insert();</font></div><div><font size="2"   >create trigger tg2 before update on test_6 for each row execute procedure tg_update();</font></div><div><font size="2"   >create trigger tg3 before delete on test_6 for each row execute procedure tg_delete();</font></div><div><font size="2"   >create trigger tg1 before insert on test_7 for each row execute procedure tg_insert();</font></div><div><font size="2"   >create trigger tg2 before update on test_7 for each row execute procedure tg_update();</font></div><div><font size="2"   >create trigger tg3 before delete on test_7 for each row execute procedure tg_delete();</font></div><div><font size="2"   >create trigger tg1 before insert on test_8 for each row execute procedure tg_insert();</font></div><div><font size="2"   >create trigger tg2 before update on test_8 for each row execute procedure tg_update();</font></div><div><font size="2"   >create trigger tg3 before delete on test_8 for each row execute procedure tg_delete();</font></div><p></p></pre></div><div>单子表测试结果 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cat ins.sql</font></div><div><font size="2"   >insert into test_1(info) values ('test');</font></div></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -n -r -f ./ins.sql -T 60 -c 16 -j 4&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 2369510</font></div><div><font size="2"   >tps = 39407.697898 (including connections establishing)</font></div><div><font size="2"   >tps = 39421.790995 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.404299 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_1(info) values ('test');</font></div></div><p></p></pre></div><div><div>数据校验 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select count(distinct id) from test;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;4415894</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select count(distinct id) from test_uk;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;4415894</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>多表测试结果 :&nbsp;</div></div><div><div style="line-height: 22px;"   >cat ins.sql</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into test(info) values ('test');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into test_1(info) values ('test');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into test_2(info) values ('test');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into test_3(info) values ('test');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into test_4(info) values ('test');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into test_5(info) values ('test');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into test_6(info) values ('test');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into test_7(info) values ('test');</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >insert into test_8(info) values ('test');</font></div></pre></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -n -r -f ./ins.sql -T 60 -c 16 -j 4&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 227376</font></div><div><font size="2"   >tps = 3781.428899 (including connections establishing)</font></div><div><font size="2"   >tps = 3782.780356 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.479270 &nbsp; &nbsp; &nbsp; &nbsp;insert into test(info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.443284 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_1(info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.477760 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_2(info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.472192 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_3(info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.457428 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_4(info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.463708 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_5(info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.462552 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_6(info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.489863 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_7(info) values ('test');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.474460 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_8(info) values ('test');</font></div><p></p></pre></div>【其他】<div>1. 对于全局唯一表, 如果数据量太大依旧可以分区, 例如按hash取模分区.</div><div>这不影响全局唯一的约束, 因为分区键就是约束键.</div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">yyxh520 - 2015-01-13 16:19:06</h5>
				<div>CREATE TABLE student (student_id bigserial, name varchar(32), score smallint) ;<div><div class="line number1 index0 alt2"  style=""  >CREATE TABLE student_qualified (CHECK (score &gt;= 60 )) INHERITS (student) ;</div><div class="line number2 index1 alt1"  style=""  >CREATE TABLE student_nqualified (CHECK (score &lt; 60)) INHERITS (student) ;</div><div class="line number2 index1 alt1"  style=""  ><br></div><div class="line number2 index1 alt1"  style=""  ><div class="line number1 index0 alt2"  style=""  >CREATE OR REPLACE RULE insert_student_qualified </div><div class="line number2 index1 alt1"  style=""  >AS ON INSERT TO student </div><div class="line number3 index2 alt2"  style=""  >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE score &gt;= 60</div><div class="line number4 index3 alt1"  style=""  >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DO INSTEAD</div><div class="line number5 index4 alt2"  style=""  >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INSERT INTO student_qualified VALUES(NEW.*);</div><div class="line number6 index5 alt1"  style=""  >&nbsp;</div><div class="line number7 index6 alt2"  style=""  >CREATE OR REPLACE RULE insert_student_nqualified </div><div class="line number8 index7 alt1"  style=""  >AS ON INSERT TO student </div><div class="line number9 index8 alt2"  style=""  >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE score &lt; 60</div><div class="line number10 index9 alt1"  style=""  >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DO INSTEAD</div></div></div></div>
			</div>
	</div>
</div>
</body>
</html>