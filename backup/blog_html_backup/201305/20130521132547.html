<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL complex index's column position tuning case - 2</h2>
	<h5 id="">2013-05-21 13:25:47&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013421111529500/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>帮朋友优化的一个慢查询, 因为前导列用到范围查询, 导致索引扫描的page数大增, 因而降低了查询性能.</div><div><br></div><div>表结构 :&nbsp;</div><div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; \d digoal.digoal_day_p_p</font></div><div><font size="2"   >&nbsp; &nbsp; Table "digoal.digoal_day_p_p"</font></div><div><font size="2"   >&nbsp; &nbsp; Column &nbsp; &nbsp;| &nbsp; Type &nbsp; &nbsp;| Modifiers&nbsp;</font></div><div><font size="2"   >--------------+-----------+-----------</font></div><div><font size="2"   >&nbsp;digoal_date &nbsp; &nbsp; | integer &nbsp; | not null</font></div><div><font size="2"   >&nbsp;a_id &nbsp; &nbsp; &nbsp; | integer &nbsp; | not null</font></div><div><font size="2"   >&nbsp;a_vercd &nbsp;| integer &nbsp; | default 0</font></div><div><font size="2"   >&nbsp;p_p &nbsp; &nbsp;| integer[] |&nbsp;</font></div><div><font size="2"   >&nbsp;pe_timelen | integer[] |&nbsp;</font></div><div><font size="2"   >&nbsp;crt_date &nbsp; &nbsp; | integer &nbsp; | default 0</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "idx_digoal_day_p_p_1" btree (intarray_to_text(p_p), a_vercd, a_id, digoal_date), tablespace "tbs_digoal_idx"</font></div><p></p></pre></div><div>注意索引, 包含了以下SQL所有查询条件.</div><div>查询1 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; explain analyze select p_p[2] p1,count(*) count_total from digoal.digoal_day_p_p where digoal.intarray_to_text(p_p) ~ E'^\\{0,' and a_id = 2 &nbsp;and digoal_date between 20130515 and 20130521 and a_vercd = 1 &nbsp;group by 1 order by count_total desc;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >-----------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Sort &nbsp;(cost=2923377.89..2923377.89 rows=1 width=45) (actual time=20290.412..20290.413 rows=8 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Sort Key: (count(*))</font></div><div><font size="2"   >&nbsp; &nbsp;Sort Method: quicksort &nbsp;Memory: 25kB</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;HashAggregate &nbsp;(cost=2923377.87..2923377.88 rows=1 width=45) (actual time=20290.397..20290.399 rows=8 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using idx_digoal_day_p_p_1 on digoal_day_p_p &nbsp;(cost=1.19..2923377.84 rows=6 width=45) (actual time=0.1</font></div><div><font size="2"   >39..20287.888 rows=5085 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: ((intarray_to_text(p_p) &gt;= '{0,'::text) AND (intarray_to_text(p_p) &lt; '{0-'::text) AND (a_ve</font></div><div><font size="2"   >rcd = 1) AND (a_id = 2) AND (digoal_date &gt;= 20130515) AND (digoal_date &lt;= 20130521))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (intarray_to_text(p_p) ~ '^\{0,'::text)</font></div><div><font size="2"   >&nbsp;Total runtime: 20290.460 ms</font></div><div><font size="2"   >(8 rows)</font></div><p></p></pre></div><div>查询2 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; explain analyze select p_p[3] p1,count(*) count_total from digoal.digoal_day_p_p where digoal.intarray_to_text(p_p) ~ E'^\\{0,5,' and a_id = 2 &nbsp;and digoal_date between 20130515 and 20130520 and a_vercd = 1 &nbsp;group by 1 order by count_total desc;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >---------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Sort &nbsp;(cost=193.50..193.50 rows=1 width=45) (actual time=9.962..9.963 rows=6 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Sort Key: (count(*))</font></div><div><font size="2"   >&nbsp; &nbsp;Sort Method: quicksort &nbsp;Memory: 25kB</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;HashAggregate &nbsp;(cost=193.48..193.49 rows=1 width=45) (actual time=9.893..9.894 rows=6 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using idx_digoal_day_p_p_1 on digoal_day_p_p &nbsp;(cost=1.19..193.47 rows=1 width=45) (actual time=0.333..</font></div><div><font size="2"   >9.752 rows=209 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: ((intarray_to_text(p_p) &gt;= '{0,5,'::text) AND (intarray_to_text(p_p) &lt; '{0,5-'::text) AND (ap</font></div><div><font size="2"   >p_vercd = 1) AND (a_id = 2) AND (digoal_date &gt;= 20130515) AND (digoal_date &lt;= 20130520))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (intarray_to_text(p_p) ~ '^\{0,5,'::text)</font></div><div><font size="2"   >&nbsp;Total runtime: 10.035 ms</font></div><div><font size="2"   >(8 rows)</font></div><p></p></pre></div><div>以上两个查询除了<span style="line-height: 22px;"   >digoal.intarray_to_text(p_p) ~ E'^\\{0,5,' 和&nbsp;</span><span style="line-height: 22px;"   >digoal.intarray_to_text(p_p) ~ E'^\\{0,' 不一样,</span></div><div><span style="line-height: 22px;"   >其他条件都一样.&nbsp;</span></div><div><span style="line-height: 22px;"   >但是时间上相差了2000倍. &nbsp;</span></div><div><span style="line-height: 22px;"   >来看看索引各列的选择性.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select count(distinct(intarray_to_text(p_p))),count(distinct a_id),count(distinct a_vercd),count(distinct digoal_date),count(*) from digoal.digoal_day_p_p ;</font></div><div><font size="2"   >count &nbsp;| count | count | count | &nbsp;count &nbsp;&nbsp;</font></div><div><font size="2"   >---------+-------+-------+-------+----------</font></div><div><font size="2"   >&nbsp;6706225 | &nbsp; &nbsp;65 | &nbsp; 206 | &nbsp; 592 | 70435249</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >从选择性看, 这个索引这么做也没有什么不对.</span></div><div><span style="line-height: 22px;"   >但是注意SQL中查询条件</span><span style="line-height: 22px;"   >digoal.intarray_to_text(p_p) ~</span><span style="line-height: 22px;"   >&nbsp;这个是范围查询. 因此这么看选择性好不好是不行的.</span></div><div><span style="line-height: 22px;"   >因为前导列是范围查询, 所以范围越大, 扫描的索引page就越多.</span></div><div>来看看两个条件分别指向了多少条记录就知道原因了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select count(*) from digoal.digoal_day_p_p where digoal.intarray_to_text(p_p) ~ E'^\\{0,';</font></div><div><font size="2"   >&nbsp; count &nbsp;&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;70746931</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=&gt; select count(*) from digoal.digoal_day_p_p where digoal.intarray_to_text(p_p) ~ E'^\\{0,5,';</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;10061</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>数据相差了7000倍.</div><div><br></div><div>前导列, 索引用到的是&gt;=和&lt;操作符.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; explain select count(*) from digoal.digoal_day_p_p where digoal.intarray_to_text(p_p) ~ E'^\\{0,5,';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Aggregate &nbsp;(cost=10021.06..10021.07 rows=1 width=0)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Index Scan using idx_digoal_day_p_p_1 on digoal_day_p_p &nbsp;(cost=1.19..10011.57 rows=3794 width=0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: ((intarray_to_text(p_p) &gt;= '{0,5,'::text) AND (intarray_to_text(p_p) &lt; '{0,5-'::text))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (intarray_to_text(p_p) ~ '^\{0,5,'::text)</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"   ># 剩余的3个条件的记录数 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select count(*) from digoal.digoal_day_p_p where a_id = 2;</font></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;390913</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=&gt; select count(*) from digoal.digoal_day_p_p where digoal_date between 20130515 and 20130521;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1141898</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=&gt; select count(*) from digoal.digoal_day_p_p where a_vercd = 1;</font></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;388849</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div>注意digoal_date用到的也是范围查询, 不过它作为最后一个索引列, 影响不大.</div><div>根据这个查询条件, 索引顺序改成 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >a_vercd, a_id, digoal_date,&nbsp;<span style="line-height: 22px;"   >intarray_to_text(p_p)</span></font></p></pre></div><div><span style="line-height: 22px;"   >查询时间缩小 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create index idx_digoal_day_p_p_2 on digoal.digoal_day_p_p(a_vercd,a_id,digoal_date,intarray_to_text(p_p));</font></div><div><font size="2"   >CREATE INDEX</font></div><div><font size="2"   >digoal=&gt; explain analyze select count(*) from (select p_p[2] p1,count(*) count_total from digoal.digoal_day_p_p where digoal.intarray_to_text(p_p) ~ E'^\\{0,5' and a_id = 2 &nbsp;and digoal_date between 20130515 and 20130521 and a_vercd = 1 &nbsp;group by 1 order by count_total desc) t;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >-------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Aggregate &nbsp;(cost=5.62..5.63 rows=1 width=0) (actual time=10.545..10.545 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=5.60..5.61 rows=1 width=45) (actual time=10.543..10.543 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: (count(*))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Method: quicksort &nbsp;Memory: 25kB</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;HashAggregate &nbsp;(cost=5.58..5.59 rows=1 width=45) (actual time=10.535..10.535 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using idx_digoal_day_p_p_2 on digoal_day_p_p &nbsp;(cost=1.19..5.58 rows=1 width=45) (actual time=0.1</font></div><div><font size="2"   >39..10.056 rows=926 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: ((a_vercd = 1) AND (a_id = 2) AND (digoal_date &gt;= 20130515) AND (digoal_date &lt;= 20130521) AND (inta</font></div><div><font size="2"   >rray_to_text(p_p) &gt;= '{0,5'::text) AND (intarray_to_text(p_p) &lt; '{0,6'::text))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (intarray_to_text(p_p) ~ '^\{0,5'::text)</font></div><div><font size="2"   >&nbsp;Total runtime: 10.604 ms</font></div><div><font size="2"   >(9 rows)</font></div><div><font size="2"   >Time: 11.890 ms</font></div><div><font size="2"   >digoal=&gt; explain analyze select p_p[2] p1,count(*) count_total from digoal.digoal_day_p_p where digoal.intarray_to_text(p_p) ~ E'^\\{0,' and a_id = 2 &nbsp;and digoal_date between 20130515 and 20130521 and a_vercd = 1 &nbsp;group by 1 order by count_total desc limit 1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >-----------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Limit &nbsp;(cost=16.67..16.68 rows=1 width=45) (actual time=50.197..50.197 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=16.67..16.68 rows=1 width=45) (actual time=50.196..50.196 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: (count(*))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Method: top-N heapsort &nbsp;Memory: 25kB</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;HashAggregate &nbsp;(cost=16.65..16.66 rows=1 width=45) (actual time=50.184..50.187 rows=8 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using idx_digoal_day_p_p_2 on digoal_day_p_p &nbsp;(cost=1.19..16.62 rows=6 width=45) (actual time=0.</font></div><div><font size="2"   >094..47.675 rows=5085 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: ((a_vercd = 1) AND (a_id = 2) AND (digoal_date &gt;= 20130515) AND (digoal_date &lt;= 20130521) AND (inta</font></div><div><font size="2"   >rray_to_text(p_p) &gt;= '{0,'::text) AND (intarray_to_text(p_p) &lt; '{0-'::text))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (intarray_to_text(p_p) ~ '^\{0,'::text)</font></div><div><font size="2"   >&nbsp;Total runtime: 50.241 ms</font></div><div><font size="2"   >(9 rows)</font></div><div><font size="2"   >Time: 51.699 ms</font></div><p></p></pre></div><div><br></div></div><div>[小结]</div><div>1. 在多列索引中, 除了考虑索引列的选择性以外, 还要结合查询条件来分析.</div><div>例如本例中<span style="line-height: 22px;"   >intarray_to_text(p_p), 这个的选择性确实是最好的. 但是查询条件并不是等于. 而是一个范围查询.</span></div><div>当这个范围查询的范围非常大的时候, 做为前导列就没有任何优势了, 反而会拖累性能.</div><div><span style="line-height: 22px;"   >where digoal.intarray_to_text(p_p) ~ E'^\\{0,5,' &nbsp;</span><span style="line-height: 22px;"   >这个范围有1多万数据,</span><span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >耗时10毫秒.</span></div><div><span style="line-height: 22px;"   >where digoal.intarray_to_text(p_p) ~ E'^\\{0,' &nbsp;</span><span style="line-height: 22px;"   >这个范围有7000多万数据,</span><span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >耗时20秒.</span></div><div><span style="line-height: 22px;"   >对于这种场景,&nbsp;</span><span style="line-height: 22px;"   >intarray_to_text(p_p)不应该作为前导列, 而应该把它放到最后去, 或者直接从索引列中去除.</span></div><div><span style="line-height: 22px;"   >去除intarray_to_text(p_p)后, 索引3列, 索引缩小一半. 查询速度还可以维持在毫秒以内.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; drop index idx_digoal_day_p_p_1;</font></div><div><font size="2"   >digoal=&gt; create index idx_digoal_day_p_p_1 on digoal.digoal_day_p_p(a_vercd,a_id,digoal_date) tablespace tbs_digoal_idx;</font></div><div><font size="2"   >CREATE INDEX</font></div><div><font size="2"   >digoal=&gt; \di+ idx_digoal_day_p_p_1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Type &nbsp;| &nbsp; Owner &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; Table &nbsp; &nbsp; &nbsp; | &nbsp;Size &nbsp; | Description&nbsp;</font></div><div><font size="2"   >--------+-------------------------+-------+------------+-------------------+---------+-------------</font></div><div><font size="2"   >&nbsp;digoal &nbsp; &nbsp;| idx_digoal_day_p_p_1 | index | digoal | digoal_day_p_p | 2140 MB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; \di+ idx_digoal_day_p_p_2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Type &nbsp;| &nbsp; Owner &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; Table &nbsp; &nbsp; &nbsp; | &nbsp;Size &nbsp; | Description&nbsp;</font></div><div><font size="2"   >--------+-------------------------+-------+------------+-------------------+---------+-------------</font></div><div><font size="2"   >&nbsp;digoal &nbsp; &nbsp;| idx_digoal_day_p_p_2 | index | digoal | digoal_day_p_p | 4399 MB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; explain analyze select p_p[2] p1,count(*) count_total from digoal.digoal_day_p_p where digoal.intarray_to_text(p_p) ~ E'^\\{0,5,' and a_id = 2 &nbsp;and digoal_date between 20130515 and 20130521 and a_vercd = 1 &nbsp;group by 1 order by count_total desc;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;Sort &nbsp;(cost=4.87..4.88 rows=1 width=46) (actual time=38.453..38.453 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Sort Key: (count(*))</font></div><div><font size="2"   >&nbsp; &nbsp;Sort Method: quicksort &nbsp;Memory: 25kB</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;HashAggregate &nbsp;(cost=4.85..4.86 rows=1 width=46) (actual time=38.445..38.446 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using idx_digoal_day_p_p_1 on digoal_day_p_p &nbsp;(cost=0.57..4.85 rows=1 width=46) (actual time=0.259..38</font></div><div><font size="2"   >.370 rows=120 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: ((a_vercd = 1) AND (a_id = 2) AND (digoal_date &gt;= 20130515) AND (digoal_date &lt;= 20130521))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (intarray_to_text(p_p) ~ '^\{0,5,'::text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Rows Removed by Filter: 4156</font></div><div><font size="2"   >&nbsp;Total runtime: 38.511 ms</font></div><div><font size="2"   >(9 rows)</font></div><div><font size="2"   >Time: 39.707 ms</font></div><div><font size="2"   >digoal=&gt; explain analyze select p_p[2] p1,count(*) count_total from digoal.digoal_day_p_p where digoal.intarray_to_text(p_p) ~ E'^\\{0,' and a_id = 2 &nbsp;and digoal_date between 20130515 and 20130521 and a_vercd = 1 &nbsp;group by 1 order by count_total desc;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------</font></div><div><font size="2"   >&nbsp;Sort &nbsp;(cost=4.87..4.88 rows=1 width=46) (actual time=43.573..43.574 rows=7 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Sort Key: (count(*))</font></div><div><font size="2"   >&nbsp; &nbsp;Sort Method: quicksort &nbsp;Memory: 25kB</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;HashAggregate &nbsp;(cost=4.85..4.86 rows=1 width=46) (actual time=43.562..43.563 rows=7 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using idx_digoal_day_p_p_1 on digoal_day_p_p &nbsp;(cost=0.57..4.85 rows=1 width=46) (actual time=0.121..41</font></div><div><font size="2"   >.472 rows=4276 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: ((a_vercd = 1) AND (a_id = 2) AND (digoal_date &gt;= 20130515) AND (digoal_date &lt;= 20130521))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (intarray_to_text(p_p) ~ '^\{0,'::text)</font></div><div><font size="2"   >&nbsp;Total runtime: 43.633 ms</font></div><div><font size="2"   >(8 rows)</font></div><div><font size="2"   >Time: 45.158 ms</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201332283735674/"   >http://blog.163.com/digoal@126/blog/static/163877040201332283735674/</a></div></div>
	</div>
</div>
</body>
</html>