<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL pg_stat_replication sync_state introduce</h2>
	<h5 id="">2013-05-10 17:29:11&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201341052257227/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>PostgreSQL 9.2引入同步复制后, pg_stat_replication的sync_state列有3种状态.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >sync</font></div><div><font size="2"   >async</font></div><div><font size="2"   >potential</font></div><p></p></pre></div><div>分别代表同步standby, 异步standby, 可升级为同步的standby.</div><div>状态来自以下函数 : pg_stat_get_wal_senders</div><div>详见参考部分.</div><div><br></div><div>[测试]</div><div>环境:</div><pre class="prettyprint"   ><p></p><div><font size="2"   >1个 primary, 3个 standby.</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >第一种配置 :&nbsp;</span></div><div>primary配置</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgresql.conf</font></div><div><font size="2"   >synchronous_standby_names = 'test1,test2,test3'</font></div><p></p></pre></div><div>standby1配置</div><pre class="prettyprint"   ><p></p><div><font size="2"   >primary_conninfo = 'application_name=test1 host=127.0.0.1 port=1999 user=postgres keepalives_idle=60'</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >standby2配置</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >primary_conninfo = 'application_name=test2 host=127.0.0.1 port=1999 user=postgres keepalives_idle=60'</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >standby3配置</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >primary_conninfo = 'application_name=test3 host=127.0.0.1 port=1999 user=postgres keepalives_idle=60'</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >primary查询</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select pid,application_name,client_addr,sync_state from pg_stat_replication;</font></div><div><font size="2"   >&nbsp;pid &nbsp;| application_name | client_addr | sync_state&nbsp;</font></div><div><font size="2"   >------+------------------+-------------+------------</font></div><div><font size="2"   >&nbsp;6311 | test1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 127.0.0.1 &nbsp; | sync</font></div><div><font size="2"   >&nbsp;6321 | test2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 127.0.0.1 &nbsp; | potential</font></div><div><font size="2"   >&nbsp;6391 | test3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 127.0.0.1 &nbsp; | potential</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div><div>如果sync节点挂掉, 按synchronous_standby_names的顺序, 第一个potential节点会变成sync状态.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg_ctl stop -m fast -D /pgdata11999</font></div><div><font size="2"   >digoal=# select pid,application_name,client_addr,sync_state from pg_stat_replication;</font></div><div><font size="2"   >&nbsp;pid &nbsp;| application_name | client_addr | sync_state&nbsp;</font></div><div><font size="2"   >------+------------------+-------------+------------</font></div><div><font size="2"   >&nbsp;6564 | test2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 127.0.0.1 &nbsp; | sync</font></div><div><font size="2"   >&nbsp;6568 | test3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 127.0.0.1 &nbsp; | potential</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>当test1重新起来后又会变成sync状态.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_ctl start -D /pgdata11999</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >digoal=# select pid,application_name,client_addr,sync_state from pg_stat_replication;</font></div><div><font size="2"   >&nbsp;pid &nbsp;| application_name | client_addr | sync_state&nbsp;</font></div><div><font size="2"   >------+------------------+-------------+------------</font></div><div><font size="2"   >&nbsp;6564 | test2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 127.0.0.1 &nbsp; | potential</font></div><div><font size="2"   >&nbsp;6605 | test1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 127.0.0.1 &nbsp; | sync</font></div><div><font size="2"   >&nbsp;6568 | test3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 127.0.0.1 &nbsp; | potential</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div><div><br></div><div>第二种配置 :&nbsp;</div><div>primary配置</div><pre class="prettyprint"   ><p></p><div><font size="2"   >synchronous_standby_names = 'test1,test2'</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >standby1配置不变</span></div><div>standby2配置不变</div><div>standby3配置不变</div><div>primary查询</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select pid,application_name,client_addr,sync_state from pg_stat_replication;</font></div><div><font size="2"   >&nbsp;pid &nbsp;| application_name | client_addr | sync_state&nbsp;</font></div><div><font size="2"   >------+------------------+-------------+------------</font></div><div><font size="2"   >&nbsp;6470 | test1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 127.0.0.1 &nbsp; | sync</font></div><div><font size="2"   >&nbsp;6472 | test3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 127.0.0.1 &nbsp; | async</font></div><div><font size="2"   >&nbsp;6474 | test2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 127.0.0.1 &nbsp; | potential</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div><div>test3变成异步了. 因为test3没有配置在primary的synchronous_standby_names 中.</div><div><br></div><div>第三种配置 :&nbsp;</div><div>primary配置</div><pre class="prettyprint"   ><p></p><div><font size="2"   >synchronous_standby_names = 'test1'</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >standby1配置不变</span></div><div>standby2配置不变</div><div>standby3配置不变</div><div>primary查询</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select pid,application_name,client_addr,sync_state from pg_stat_replication;</font></div><div><font size="2"   >&nbsp;pid &nbsp;| application_name | client_addr | sync_state&nbsp;</font></div><div><font size="2"   >------+------------------+-------------+------------</font></div><div><font size="2"   >&nbsp;6519 | test2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 127.0.0.1 &nbsp; | async</font></div><div><font size="2"   >&nbsp;6521 | test3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 127.0.0.1 &nbsp; | async</font></div><div><font size="2"   >&nbsp;6523 | test1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 127.0.0.1 &nbsp; | sync</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div><div>test2,test3变成异步了. 因为test2,test3没有配置在primary的synchronous_standby_names 中.</div><div><br></div><div>[参考]</div><div>1. src/backend/replication/walsender.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* Returns activity of walsenders, including pids and xlog locations sent to</font></div><div><font size="2"   >&nbsp;* standby servers.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >Datum</font></div><div><font size="2"   >pg_stat_get_wal_senders(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >...略</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* More easily understood version of standby state. This is purely</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* informational, not different from priority.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (sync_priority[i] == 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; values[7] = CStringGetTextDatum("async");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (i == sync_standby)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; values[7] = CStringGetTextDatum("sync");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; values[7] = CStringGetTextDatum("potential");</font></div><div><font size="2"   >...略</font></div><p></p></pre></div></div><div><p></p></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL pg_stat_replication sync_state introduce - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>