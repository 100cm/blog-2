<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">USE SysBench test Mysql and PostgreSQL - 2</h2>
	<h5 id="">2013-05-14 17:08:15&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013414549515/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>&nbsp;上一篇BLOG介绍了使用sysbench测试mysql和postgresql的simple场景.</div><div>也就是只有select的场景,&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201341441042613/"   >http://blog.163.com/digoal@126/blog/static/163877040201341441042613/</a></div><div>本文将介绍包含复杂查询的场景, 包含如下SQL :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >&nbsp;INSERT INTO sbtest(k,c,pad) values(?,?,?)</font></span></div><div><font size="2"   >&nbsp;SELECT c from sbtest where id=$1</font></div><div><font size="2"   >&nbsp;UPDATE sbtest set k=k+? where id=$1</font></div><div><font size="2"   >&nbsp;SELECT DISTINCT c from sbtest where id between $1 and $2 order by c</font></div><div><font size="2"   >&nbsp;SELECT c from sbtest where id between $1 and $2 order by c</font></div><div><font size="2"   >&nbsp;SELECT SUM(K) from sbtest where id between $1 and $2</font></div><div><font size="2"   >&nbsp;SELECT c from sbtest where id between $1 and $2</font></div><div><font size="2"   >&nbsp;UPDATE sbtest set c=$1 where id=$2</font></div><div><font size="2"   >&nbsp;DELETE from sbtest where id=$1</font></div><p></p></pre></div><div>但是需要先解决一个问题, 因为sysbench对pg的支持不太好, 在插入数据时使用的是sysbench产生的值, 而不是sequence.</div><div>会产生如下错误 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 bin]# ./sysbench --max-requests=0 --max-time=60 --num-threads=16 --test=oltp --db-driver=pgsql --pgsql-host=127.0.0.1 --pgsql-port=1999 --pgsql-user=postgres --pgsql-password=postgres --pgsql-db=postgres --oltp-test-mode=complex --oltp-reconnect-mode=session run</font></div><div><font size="2"   >sysbench 0.4.12: &nbsp;multi-threaded system evaluation benchmark</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Running the test with following options:</font></div><div><font size="2"   >Number of threads: 16</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Doing OLTP test.</font></div><div><font size="2"   >Running mixed OLTP test</font></div><div><font size="2"   >Using Special distribution (12 iterations, &nbsp;1 pct of values are returned in 75 pct cases)</font></div><div><font size="2"   >Using "BEGIN" for starting transactions</font></div><div><font size="2"   >Using auto_inc on the id column</font></div><div><font size="2"   >Threads started!</font></div><div><font size="2"   >FATAL: query execution failed: 145040784</font></div><div><font size="2"   >FATAL: database error, exiting...</font></div><div><font size="2"   >Done.</font></div><p></p></pre></div><div>日志 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2013-05-14 16:36:31.259 CST,"postgres","postgres",13938,"127.0.0.1:23937",5191f78f.3672,3,"INSERT",2013-05-14 16:36:31 CST,7/464628,</font></div><div><font size="2"   >32112157,ERROR,23505,"duplicate key value violates unique constraint ""sbtest_pkey""","Key (id)=(5014) already exists.",,,,,"INSERT&nbsp;</font></div><div><font size="2"   >INTO sbtest values($1,0,' ','aaaaaaaaaaffffffffffrrrrrrrrrreeeeeeeeeeyyyyyyyyyy')",,"_bt_check_unique, nbtinsert.c:398",""</font></div><p></p></pre></div><div>产生这个错误后sysbench会直接退出. 这就无法测试了.</div><div>所以需要修改一下sysbench的代码 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >vi&nbsp;sysbench-0.4.12/sysbench/tests/oltp/sb_oltp.c</font></p></pre></div><div>找到</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; /* Prepare the insert statement */</font></div><div><font size="2"   >&nbsp; snprintf(query, MAX_QUERY_LEN, "INSERT INTO %s values(?,0,' ',"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"'aaaaaaaaaaffffffffffrrrrrrrrrreeeeeeeeeeyyyyyyyyyy')",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;args.table_name);</font></div><p></p></pre></div><div>改成 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; /* Prepare the insert statement */</font></div><div><font size="2"   >&nbsp; if (args.auto_inc)</font></div><div><font size="2"   >&nbsp; &nbsp; snprintf(query, MAX_QUERY_LEN, "INSERT INTO %s(k,c,pad) values(0,' ',"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"'aaaaaaaaaaffffffffffrrrrrrrrrreeeeeeeeeeyyyyyyyyyy')",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;args.table_name);</font></div><div><font size="2"   >&nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; snprintf(query, MAX_QUERY_LEN, "INSERT INTO %s values(?,0,' ',"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"'aaaaaaaaaaffffffffffrrrrrrrrrreeeeeeeeeeyyyyyyyyyy')",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;args.table_name);</font></div><p></p></pre></div></div><div>然后重新编译即可.</div><div>如何编译参考 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020134142151769/"   >http://blog.163.com/digoal@126/blog/static/16387704020134142151769/</a></div><div><br></div><div>接下来可以使用参数--oltp-auto-inc来控制选择是否使用序列.</div><div>[测试结果]</div><div>1. PostgreSQL</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 bin]# ./sysbench --oltp-auto-inc=on --max-requests=0 --max-time=60 --num-threads=16 --test=oltp --db-driver=pgsql --pgsql-host=127.0.0.1 --pgsql-port=1999 --pgsql-user=postgres --pgsql-password=postgres --pgsql-db=postgres --oltp-test-mode=complex --oltp-reconnect-mode=session run</font></div><div><font size="2"   >sysbench 0.4.12: &nbsp;multi-threaded system evaluation benchmark</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Running the test with following options:</font></div><div><font size="2"   >Number of threads: 16</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Doing OLTP test.</font></div><div><font size="2"   >Running mixed OLTP test</font></div><div><font size="2"   >Using Special distribution (12 iterations, &nbsp;1 pct of values are returned in 75 pct cases)</font></div><div><font size="2"   >Using "BEGIN" for starting transactions</font></div><div><font size="2"   >Using auto_inc on the id column</font></div><div><font size="2"   >Threads started!</font></div><div><font size="2"   >Time limit exceeded, exiting...</font></div><div><font size="2"   >(last message repeated 15 times)</font></div><div><font size="2"   >Done.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >OLTP test statistics:</font></div><div><font size="2"   >&nbsp; &nbsp; queries performed:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; read: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4328002</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; write: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1545715</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; other: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 618286</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; total: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 6492003</font></div><div><font size="2"   >&nbsp; &nbsp; transactions: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;309143 (5152.10 per sec.)</font></div><div><font size="2"   >&nbsp; &nbsp; deadlocks: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp;(0.00 per sec.)</font></div><div><font size="2"   >&nbsp; &nbsp; read/write requests: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5873717 (97889.81 per sec.)</font></div><div><font size="2"   >&nbsp; &nbsp; other operations: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;618286 (10304.19 per sec.)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Test execution summary:</font></div><div><font size="2"   >&nbsp; &nbsp; total time: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;60.0034s</font></div><div><font size="2"   >&nbsp; &nbsp; total number of events: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;309143</font></div><div><font size="2"   >&nbsp; &nbsp; total time taken by event execution: 956.5899</font></div><div><font size="2"   >&nbsp; &nbsp; per-request statistics:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;min: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1.34ms</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;avg: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3.09ms</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;max: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;179.74ms</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;approx. &nbsp;95 percentile: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8.93ms</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Threads fairness:</font></div><div><font size="2"   >&nbsp; &nbsp; events (avg/stddev): &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 19321.4375/325.75</font></div><div><font size="2"   >&nbsp; &nbsp; execution time (avg/stddev): &nbsp; 59.7869/0.02</font></div><p></p></pre></div><div>2. MySQL</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 bin]# ./sysbench --oltp-auto-inc=off --max-requests=0 --max-time=60 --num-threads=16 --test=oltp --db-driver=mysql --mysql-host=127.0.0.1 --mysql-port=3306 --mysql-user=root --mysql-password=root --mysql-db=test --oltp-test-mode=complex --oltp-reconnect-mode=session run</font></div><div><font size="2"   >sysbench 0.4.12: &nbsp;multi-threaded system evaluation benchmark</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Running the test with following options:</font></div><div><font size="2"   >Number of threads: 16</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Doing OLTP test.</font></div><div><font size="2"   >Running mixed OLTP test</font></div><div><font size="2"   >Using Special distribution (12 iterations, &nbsp;1 pct of values are returned in 75 pct cases)</font></div><div><font size="2"   >Using "BEGIN" for starting transactions</font></div><div><font size="2"   >Not using auto_inc on the id column</font></div><div><font size="2"   >Threads started!</font></div><div><font size="2"   >Time limit exceeded, exiting...</font></div><div><font size="2"   >(last message repeated 15 times)</font></div><div><font size="2"   >Done.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >OLTP test statistics:</font></div><div><font size="2"   >&nbsp; &nbsp; queries performed:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; read: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1380960</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; write: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 493088</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; other: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 197237</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; total: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2071285</font></div><div><font size="2"   >&nbsp; &nbsp; transactions: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;98597 &nbsp;(1643.12 per sec.)</font></div><div><font size="2"   >&nbsp; &nbsp; deadlocks: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 43 &nbsp; &nbsp; (0.72 per sec.)</font></div><div><font size="2"   >&nbsp; &nbsp; read/write requests: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1874048 (31231.08 per sec.)</font></div><div><font size="2"   >&nbsp; &nbsp; other operations: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;197237 (3286.96 per sec.)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Test execution summary:</font></div><div><font size="2"   >&nbsp; &nbsp; total time: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;60.0059s</font></div><div><font size="2"   >&nbsp; &nbsp; total number of events: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;98597</font></div><div><font size="2"   >&nbsp; &nbsp; total time taken by event execution: 958.6545</font></div><div><font size="2"   >&nbsp; &nbsp; per-request statistics:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;min: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2.30ms</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;avg: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9.72ms</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;max: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;204.51ms</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;approx. &nbsp;95 percentile: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;26.08ms</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Threads fairness:</font></div><div><font size="2"   >&nbsp; &nbsp; events (avg/stddev): &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 6162.3125/43.34</font></div><div><font size="2"   >&nbsp; &nbsp; execution time (avg/stddev): &nbsp; 59.9159/0.00</font></div><p></p></pre></div></div><div><br></div><div>[参考]</div><div>1.&nbsp;Install SysBench support MySQL and PostgreSQL</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020134142151769/"   >http://blog.163.com/digoal@126/blog/static/16387704020134142151769/</a></div><div>2.&nbsp;USE SysBench test Mysql and PostgreSQL - 1</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201341441042613/"   >http://blog.163.com/digoal@126/blog/static/163877040201341441042613/</a></div><div>3.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://wiki.bazaar.canonical.com/DistroDownloads#CentOS.2FRHEL"   >http://wiki.bazaar.canonical.com/DistroDownloads#CentOS.2FRHEL</a></div><div>4.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.percona.com/docs/wiki/benchmark:sysbench:olpt.lua"   >http://www.percona.com/docs/wiki/benchmark:sysbench:olpt.lua</a></div><div>5.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://wiki.gentoo.org/wiki/Sysbench"   >http://wiki.gentoo.org/wiki/Sysbench</a></div><div>6.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="https://launchpad.net/sysbench"   >https://launchpad.net/sysbench</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="USE SysBench test Mysql and PostgreSQL - 2 - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>