<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 Improve vacuum, Update visibility map in the second phase of vacuum.</h2>
	<h5 id="">2013-05-07 15:12:41&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020134711049565/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Update visibility map in the second phase of vacuum.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >There's a high chance that a page becomes all-visible when the second phase</font></div><div><font size="2"   >of vacuum removes all the dead tuples on it, so it makes sense to check for</font></div><div><font size="2"   >that. Otherwise the visibility map won't get updated until the next vacuum.</font></div><div><font size="2"   >Pavan Deolasee, reviewed by Jeff Janes.</font></div><p></p></pre></div><div>PostgreSQL 9.3 对vacuum的改进, 在vacuum中加入了更新vm的操作. 因为大多数块在vacuum后会变成所有tuple对所有事务可见, 那么下一次vacuum时可以根据vm的信息过滤掉扫描这些数据块. 因此这样可以大大的减少下一次vacuum的扫描块的数量(当然prevent xid wrapped触发的vacuum除外).</div><div>可以减少vacuum带来的io请求数量. 提升整体性能.</div><div><br></div><div>[测试]</div><div>关闭autovacuum</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi postgresql.conf</font></div><div><font size="2"   >autovacuum=off</font></div><div><font size="2"   >pg_ctl reload</font></div><p></p></pre></div><div>-- 测试表</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table test (id int) ;</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into test select generate_series(1,1000);</font></div><div><font size="2"   >INSERT 0 1000</font></div><div><font size="2"   >digoal=# vacuum analyze test;</font></div><div><font size="2"   >ANALYZE</font></div><p></p></pre></div><div>-- 占用5个数据块.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select min(ctid),max(ctid) from test;</font></div><div><font size="2"   >&nbsp; min &nbsp;| &nbsp;max &nbsp;&nbsp;</font></div><div><font size="2"   >-------+--------</font></div><div><font size="2"   >&nbsp;(0,1) | (4,96)</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# create extension pageinspect;</font></div><p></p></pre></div><div><br></div><div>PostgreSQL 9.2 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select substr((get_raw_page('test','vm',0))::text,0,64);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;substr &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;\x01000000b05dde33010000001800002000200420000000001f00000000000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select md5(substr((get_raw_page('test','vm',0))::text,0,64));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;md5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------------</font></div><div><font size="2"   >&nbsp;9f551b6b3b46c592075aebaa62534a4e</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# delete from test where id&lt;400;</font></div><p></p></pre></div><div>DELETE 399</div><div>-- 删除399行, 然后vacuum</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# vacuum verbose test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": removed 399 row versions in 2 pages</font></div><div><font size="2"   >INFO: &nbsp;"test": found 399 removable, 601 nonremovable row versions in 5 out of 5 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><p></p></pre></div><div>-- 查看contents</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from fsm_page_contents(get_raw_page('test','vm',0));</font></div><div><font size="2"   >&nbsp;fsm_page_contents&nbsp;</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp;fp_next_slot: 28 +</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select md5(substr((get_raw_page('test','vm',0))::text,0,64));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;md5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------------</font></div><div><font size="2"   >&nbsp;c1ebb9f135102f32068e0e70a4043a5c</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select substr((get_raw_page('test','vm',0))::text,0,64);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;substr &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;\x01000000b05dde33010000001800002000200420000000001c00000000000</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>-- 第二次vacuum, vm又有变化</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# vacuum verbose test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": found 0 removable, 601 nonremovable row versions in 5 out of 5 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 399 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><p></p></pre></div><div>-- 第二次vacuum后查看contents</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from fsm_page_contents(get_raw_page('test','vm',0));</font></div><div><font size="2"   >&nbsp;fsm_page_contents&nbsp;</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp;fp_next_slot: 31 +</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select substr((get_raw_page('test','vm',0))::text,0,64);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;substr &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;\x0100000050bede33010000001800002000200420000000001f00000000000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select md5(substr((get_raw_page('test','vm',0))::text,0,64));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;md5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------------</font></div><div><font size="2"   >&nbsp;0d8fa9003392fee1cda798d7ac061429</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>PostgreSQL 9.3 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select substr((get_raw_page('test','vm',0))::text,0,64);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;substr &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;\x0100000030d59bdf000000001800002000200420000000001f00000000000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select md5(substr((get_raw_page('test','vm',0))::text,0,64));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;md5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------------</font></div><div><font size="2"   >&nbsp;51a5ed00cf78970907ddd3a07dea219c</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# delete from test where id&lt;400;</font></div><div><font size="2"   >DELETE 399</font></div><p></p></pre></div><div>-- 第一次vacuum</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# vacuum verbose test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": removed 399 row versions in 2 pages</font></div><div><font size="2"   >INFO: &nbsp;"test": found 399 removable, 601 nonremovable row versions in 5 out of 5 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><div><font size="2"   >digoal=# select * from fsm_page_contents(get_raw_page('test','vm',0));</font></div><div><font size="2"   >&nbsp;fsm_page_contents&nbsp;</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp;fp_next_slot: 31 +</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select md5(substr((get_raw_page('test','vm',0))::text,0,64));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;md5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------------</font></div><div><font size="2"   >&nbsp;f37183dadd74c22f1f1d3c9337ee4a7f</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select substr((get_raw_page('test','vm',0))::text,0,64);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;substr &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;\x0100000018589cdf000000001800002000200420000000001f00000000000</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>-- 第二次vacuum , vm无变化</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# vacuum verbose test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": found 0 removable, 601 nonremovable row versions in 5 out of 5 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 399 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><div><font size="2"   >digoal=# select * from fsm_page_contents(get_raw_page('test','vm',0));</font></div><div><font size="2"   >&nbsp;fsm_page_contents&nbsp;</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp;fp_next_slot: 31 +</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select md5(substr((get_raw_page('test','vm',0))::text,0,64));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;md5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------------</font></div><div><font size="2"   >&nbsp;f37183dadd74c22f1f1d3c9337ee4a7f</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select substr((get_raw_page('test','vm',0))::text,0,64);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;substr &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;\x0100000018589cdf000000001800002000200420000000001f00000000000</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>-- 加大数据块查看效率.</div><div>PostgreSQL 9.2 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# truncate test;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >postgres=# \timing</font></div><div><font size="2"   >Timing is on.</font></div><div><font size="2"   >postgres=# insert into test select generate_series(1,10000000);</font></div><div><font size="2"   >INSERT 0 10000000</font></div><div><font size="2"   >Time: 15647.142 ms</font></div><div><font size="2"   >postgres=# update test set id=id+1;</font></div><div><font size="2"   >UPDATE 10000000</font></div><div><font size="2"   >Time: 33479.629 ms</font></div><div><font size="2"   >postgres=# vacuum verbose test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": removed 10000000 row versions in 44248 pages</font></div><div><font size="2"   >INFO: &nbsp;"test": found 10000000 removable, 10000000 nonremovable row versions in 88496 out of 88496 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.08s/2.05u sec elapsed 2.41 sec.</font></div><div><font size="2"   >VACUUM</font></div><div><font size="2"   >Time: 2646.817 ms</font></div><div><font size="2"   >-- 第二次vacuum为141毫秒</font></div><div><font size="2"   >postgres=# vacuum verbose test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": found 0 removable, 48 nonremovable row versions in 44248 out of 88496 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 10000000 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.11u sec elapsed 0.11 sec.</font></div><div><font size="2"   >VACUUM</font></div><div><font size="2"   >Time: 141.580 ms</font></div><div><font size="2"   >-- 第三次vacuum才缩短为11毫秒.</font></div><div><font size="2"   >postgres=# vacuum verbose test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": found 0 removable, 0 nonremovable row versions in 0 out of 88496 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><div><font size="2"   >Time: 11.776 ms</font></div></pre></div><div>PostgreSQL 9.3 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# truncate test;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >postgres=# insert into test select generate_series(1,10000000);</font></div><div><font size="2"   >INSERT 0 10000000</font></div><div><font size="2"   >postgres=# \timing</font></div><div><font size="2"   >Timing is on.</font></div><div><font size="2"   >postgres=# update test set id=id+1;</font></div><div><font size="2"   >UPDATE 10000000</font></div><div><font size="2"   >Time: 42543.687 ms</font></div><div><font size="2"   >postgres=# vacuum verbose test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": removed 10000000 row versions in 44248 pages</font></div><div><font size="2"   >INFO: &nbsp;"test": found 10000000 removable, 10000000 nonremovable row versions in 88496 out of 88496 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.73s/2.33u sec elapsed 3.88 sec.</font></div><div><font size="2"   >VACUUM</font></div><div><font size="2"   >Time: 3900.918 ms</font></div><div><font size="2"   >-- 第二次vacuum已经缩短为12毫秒</font></div><div><font size="2"   >postgres=# vacuum verbose test;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.test"</font></div><div><font size="2"   >INFO: &nbsp;"test": found 0 removable, 0 nonremovable row versions in 0 out of 88496 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><div><font size="2"   >Time: 12.663 ms</font></div></pre></div><div>-- 使用gdb来看</div></div><div>跟踪heap_page_is_all_visible</div><div>略</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/pageinspect.html"   >http://www.postgresql.org/docs/devel/static/pageinspect.html</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=fdf9e21196a6f58c6021c967dc5776a16190f295"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=fdf9e21196a6f58c6021c967dc5776a16190f295</a></div><div>3.&nbsp;src/backend/access/heap/visibilitymap.c</div><div>4.&nbsp;src/backend/commands/vacuumlazy.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >+/*</font></div><div><font size="2"   >+ * Check if every tuple in the given page is visible to all current and future</font></div><div><font size="2"   >+ * transactions. Also return the visibility_cutoff_xid which is the highest</font></div><div><font size="2"   >+ * xmin amongst the visible tuples.</font></div><div><font size="2"   >+ */</font></div><div><font size="2"   >+static bool</font></div><div><font size="2"   >+heap_page_is_all_visible(Buffer buf, TransactionId *visibility_cutoff_xid)</font></div><div><font size="2"   >+{</font></div><div><font size="2"   >+ &nbsp; Page &nbsp; &nbsp; &nbsp; &nbsp; page = BufferGetPage(buf);</font></div><div><font size="2"   >+ &nbsp; OffsetNumber offnum,</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;maxoff;</font></div><div><font size="2"   >+ &nbsp; bool &nbsp; &nbsp; &nbsp; &nbsp; all_visible = true;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; *visibility_cutoff_xid = InvalidTransactionId;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; /*</font></div><div><font size="2"   >+ &nbsp; &nbsp;* This is a stripped down version of the line pointer scan in</font></div><div><font size="2"   >+ &nbsp; &nbsp;* lazy_scan_heap(). So if you change anything here, also check that</font></div><div><font size="2"   >+ &nbsp; &nbsp;* code.</font></div><div><font size="2"   >+ &nbsp; &nbsp;*/</font></div><div><font size="2"   >+ &nbsp; maxoff = PageGetMaxOffsetNumber(page);</font></div><div><font size="2"   >+ &nbsp; for (offnum = FirstOffsetNumber;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; offnum &lt;= maxoff &amp;&amp; all_visible;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; offnum = OffsetNumberNext(offnum))</font></div><div><font size="2"   >+ &nbsp; {</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; ItemId &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;itemid;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; HeapTupleData &nbsp; tuple;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; itemid = PageGetItemId(page, offnum);</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; /* Unused or redirect line pointers are of no interest */</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; if (!ItemIdIsUsed(itemid) || ItemIdIsRedirected(itemid))</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; continue;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; ItemPointerSet(&amp;(tuple.t_self), BufferGetBlockNumber(buf), offnum);</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;* Dead line pointers can have index pointers pointing to them. So they</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;* can't be treated as visible</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; if (ItemIdIsDead(itemid))</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all_visible = false;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; Assert(ItemIdIsNormal(itemid));</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; tuple.t_data = (HeapTupleHeader) PageGetItem(page, itemid);</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; switch (HeapTupleSatisfiesVacuum(tuple.t_data, OldestXmin, buf))</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case HEAPTUPLE_LIVE:</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TransactionId xmin;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Check comments in lazy_scan_heap. */</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!(tuple.t_data-&gt;t_infomask &amp; HEAP_XMIN_COMMITTED))</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all_visible = false;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* The inserter definitely committed. But is it old</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* enough that everyone sees it as committed?</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xmin = HeapTupleHeaderGetXmin(tuple.t_data);</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!TransactionIdPrecedes(xmin, OldestXmin))</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all_visible = false;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Track newest xmin on page. */</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (TransactionIdFollows(xmin, *visibility_cutoff_xid))</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *visibility_cutoff_xid = xmin;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case HEAPTUPLE_DEAD:</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case HEAPTUPLE_RECENTLY_DEAD:</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case HEAPTUPLE_INSERT_IN_PROGRESS:</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case HEAPTUPLE_DELETE_IN_PROGRESS:</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all_visible = false;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default:</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, "unexpected HeapTupleSatisfiesVacuum result");</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >+ &nbsp; } &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* scan along page */</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; return all_visible;</font></div><div><font size="2"   >+}</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>