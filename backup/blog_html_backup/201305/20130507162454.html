<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 Add optional ability to checksum data pages and report corruption</h2>
	<h5 id="">2013-05-07 16:24:54&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020134742321288/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.3 添加了data page的校验功能. 在数据库集群初始化时配置.</div><div>initdb :&nbsp;</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >-k</font></div><div style="line-height: 22px;"   ><font size="2"   >--data-checksums</font></div><div style="line-height: 22px;"   ><font size="2"   >Use checksums on data pages to help detect corruption by the I/O system that would otherwise be silent. Enabling checksums may incur a noticeable performance penalty. This option can only be set during initialization, and cannot be changed later. If set, checksums are calculated for all objects, in all databases.</font></div><p></p></pre></div></div><div><br></div><div>如果出现了校验错误, 只要数据块的头信息未损坏, 可以配置ignore_checksum_failure来忽略错误, 读取数据块中未损坏的信息.</div><div>但是如果头信息损坏了, 抱歉, 即使配置了ignore_checksum_failure也无法忽略错误.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >Add optional ability to checksum data pages and report corruption (Simon Riggs, Jeff Davis, Greg Smith, Ants Aasma)</font></div><div><font size="2"   >The checksum option can be set during initdb.</font></div></div><div><div><font size="2"   >Allow I/O reliability checks using 16-bit checksums</font></div><div><font size="2"   >Checksums are set immediately prior to flush out of shared buffers</font></div><div><font size="2"   >and checked when pages are read in again. Hint bit setting will</font></div><div><font size="2"   >require full page write when block is dirtied, which causes various</font></div><div><font size="2"   >infrastructure changes. Extensive comments, docs and README.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >WARNING message thrown if checksum fails on non-all zeroes page;</font></div><div><font size="2"   >ERROR thrown but can be disabled with ignore_checksum_failure = on.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Feature enabled by an initdb option, since transition from option off</font></div><div><font size="2"   >to option on is long and complex and has not yet been implemented.</font></div><div><font size="2"   >Default is not to use checksums.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Checksum used is WAL CRC-32 truncated to 16-bits.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Simon Riggs, Jeff Davis, Greg Smith</font></div><div><font size="2"   >Wide input and assistance from many community members. Thank you.</font></div></div><p></p></pre></div><div>脏数据库从shared buffer刷出去时, 开启了checksum 的情况下, 需要写整个page, 所以开启checksum&nbsp;对写/更新/删除性能影响比较大.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=96ef3b8ff1cf1950e897fd2f766d4bd9ef0d5d56"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=96ef3b8ff1cf1950e897fd2f766d4bd9ef0d5d56</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/runtime-config-developer.html"   >http://www.postgresql.org/docs/devel/static/runtime-config-developer.html</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ignore_checksum_failure (boolean)</font></div><div><font size="2"   >Only has effect if data checksums are enabled.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Detection of a checksum failure during a read normally causes PostgreSQL to report an error, aborting the current transaction. Setting ignore_checksum_failure to on causes the system to ignore the failure (but still report a warning), and continue processing. This behavior may cause crashes, propagate or hide corruption, or other serious problems. However, it may allow you to get past the error and retrieve undamaged tuples that might still be present in the table if the block header is still sane. If the header is corrupt an error will be reported even if this option is enabled. The default setting is off, and it can only be changed by a superuser.</font></div><p></p></pre></div><div>3.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/app-initdb.html"   >http://www.postgresql.org/docs/devel/static/app-initdb.html</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-k</font></div><div><font size="2"   >--data-checksums</font></div><div><font size="2"   >Use checksums on data pages to help detect corruption by the I/O system that would otherwise be silent. Enabling checksums may incur a noticeable performance penalty. This option can only be set during initialization, and cannot be changed later. If set, checksums are calculated for all objects, in all databases.</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>