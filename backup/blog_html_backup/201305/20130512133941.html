<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL execute redis commands</h2>
	<h5 id="">2013-05-12 13:39:41&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201341283339724/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>需要使用到redis wrapper和redis client api.</div><div>下载地址 :&nbsp;</div><div>1.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="https://bitbucket.org/qooleot/redis_wrapper"   >https://bitbucket.org/qooleot/redis_wrapper</a></div><div>2.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="https://github.com/redis/hiredis"   >https://github.com/redis/hiredis</a></div><div><br></div><div>【安装】</div><div>1. 安装redis(服务端)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >wget http://redis.googlecode.com/files/redis-2.6.13.tar.gz</font></div><div><font size="2"   >tar -zxvf redis-2.6.13.tar.gz</font></div><div><font size="2"   >mv redis-2.6.13 /opt/</font></div><div><font size="2"   >cd /opt/redis-2.6.13</font></div><div><font size="2"   >make</font></div><p></p></pre></div><div>-- 配置redis.conf</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi redis.conf</font></div><div><font size="2"   >daemonize yes</font></div><div><font size="2"   >pidfile /var/run/redis.pid</font></div><div><font size="2"   >port 6379</font></div><div><font size="2"   >bind 0.0.0.0</font></div><div><font size="2"   >unixsocket /opt/redis-2.6.13/redis.sock</font></div><div><font size="2"   >unixsocketperm 755</font></div><div><font size="2"   >timeout 0</font></div><div><font size="2"   >tcp-keepalive 60</font></div><div><font size="2"   >loglevel notice</font></div><div><font size="2"   >logfile /var/log/redis.log</font></div><div><font size="2"   >databases 16</font></div><div><font size="2"   >save 900 1</font></div><div><font size="2"   >save 300 10</font></div><div><font size="2"   >save 60 10000</font></div><div><font size="2"   >stop-writes-on-bgsave-error yes</font></div><div><font size="2"   >rdbcompression yes</font></div><div><font size="2"   >rdbchecksum yes</font></div><div><font size="2"   >dbfilename dump6379.rdb</font></div><div><font size="2"   >dir /opt/redis-2.6.13/</font></div><div><font size="2"   >slave-serve-stale-data yes</font></div><div><font size="2"   >slave-read-only yes</font></div><div><font size="2"   >repl-disable-tcp-nodelay no</font></div><div><font size="2"   >slave-priority 100</font></div><div><font size="2"   >appendonly no</font></div><div><font size="2"   >appendfsync everysec</font></div><div><font size="2"   >no-appendfsync-on-rewrite no</font></div><div><font size="2"   >auto-aof-rewrite-percentage 100</font></div><div><font size="2"   >auto-aof-rewrite-min-size 64mb</font></div><div><font size="2"   >lua-time-limit 5000</font></div><div><font size="2"   >slowlog-log-slower-than 10000</font></div><div><font size="2"   >slowlog-max-len 128</font></div><div><font size="2"   >hash-max-ziplist-entries 512</font></div><div><font size="2"   >hash-max-ziplist-value 64</font></div><div><font size="2"   >list-max-ziplist-entries 512</font></div><div><font size="2"   >list-max-ziplist-value 64</font></div><div><font size="2"   >set-max-intset-entries 512</font></div><div><font size="2"   >zset-max-ziplist-entries 128</font></div><div><font size="2"   >zset-max-ziplist-value 64</font></div><div><font size="2"   >activerehashing yes</font></div><div><font size="2"   >client-output-buffer-limit normal 0 0 0</font></div><div><font size="2"   >client-output-buffer-limit slave 256mb 64mb 60</font></div><div><font size="2"   >client-output-buffer-limit pubsub 32mb 8mb 60</font></div><div><font size="2"   >hz 10</font></div><div><font size="2"   >aof-rewrite-incremental-fsync yes</font></div><p></p></pre></div><div>-- 启动redis</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/opt/redis-2.6.13/src/redis-server /opt/redis-2.6.13/redis.conf</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># netstat -anp|grep 6379</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:6379 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;16550/redis-server&nbsp;</font></div><p></p></pre></div><div><br></div><div>2. 安装hiredis(PostgreSQL 端)</div><div>下载: https://github.com/redis/hiredis</div><div>刚好我写本文的时候这个repository出了点问题,无法下载.</div><div>可以使用redis包含的hiredis源码.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd /opt/redis-2.6.13/deps/hiredis</font></div><div><font size="2"   >gmake</font></div><div><font size="2"   >gmake install</font></div><p></p></pre></div><div><br></div><div>3. 安装redis wrapper(PostgreSQL 端) https://bitbucket.org/qooleot/redis_wrapper</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >git clone https://bitbucket.org/qooleot/redis_wrapper.git</font></div><div><font size="2"   >mv redis_wrapper /opt/soft_bak/postgresql-9.2.4/contrib/</font></div><div><font size="2"   >[root@db-172-16-3-33 soft_bak]# export PATH=/opt/pgsql9.2.4/bin:$PATH</font></div><div><font size="2"   >[root@db-172-16-3-33 soft_bak]# which pg_config</font></div><div><font size="2"   >/opt/pgsql9.2.4/bin/pg_config</font></div><div><font size="2"   >cp -r /opt/redis-2.6.13/deps/hiredis /opt/soft_bak/postgresql-9.2.4/contrib/redis_wrapper</font></div><div><font size="2"   >cd /opt/soft_bak/postgresql-9.2.4/contrib/redis_wrapper/hiredis</font></div><div><font size="2"   >gmake</font></div><div><font size="2"   >gmake install</font></div><div><font size="2"   >su - pg92</font></div><div><font size="2"   >psql</font></div><div><font size="2"   >digoal=# create extension redis;</font></div><div><font size="2"   >CREATE EXTENSION</font></div><p></p></pre></div><div><br></div><div>【测试】</div><div>查看redis_wrapper包含的函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-33-&gt; cd /opt/pgsql9.2.4/share/extension/</font></div><div><font size="2"   >pg92@db-172-16-3-33-&gt; cat redis--0.0.2.sql&nbsp;</font></div><div><font size="2"   >-- complain if script is sourced in psql, rather than via CREATE EXTENSION</font></div><div><font size="2"   >\echo Use "CREATE EXTENSION redis" to load this file. \quit</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION redis_connect(con_num int,&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; con_host text = '127.0.0.1',&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; con_port int = 6379,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; con_pass text = '',</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; con_db int &nbsp;= 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ignore_duplicate bool = false)</font></div><div><font size="2"   >RETURNS void</font></div><div><font size="2"   >AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >LANGUAGE C;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION redis_disconnect(con_num int = 0)</font></div><div><font size="2"   >RETURNS void</font></div><div><font size="2"   >AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >LANGUAGE C;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION redis_command(</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;con_num int,&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;command text,&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;variadic args text[] DEFAULT '{}')</font></div><div><font size="2"   >RETURNS text</font></div><div><font size="2"   >AS 'MODULE_PATHNAME' , 'redis_command'</font></div><div><font size="2"   >LANGUAGE C;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION redis_command_argv(con_num int, variadic args text[])</font></div><div><font size="2"   >RETURNS text</font></div><div><font size="2"   >AS 'MODULE_PATHNAME' , 'redis_command_argv'</font></div><div><font size="2"   >LANGUAGE C;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION redis_push_record(</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;con_num &nbsp; &nbsp; &nbsp; int,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;data &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;record,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;push_keys &nbsp; &nbsp; boolean,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;key_set &nbsp; &nbsp; &nbsp; text,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;key_prefix &nbsp; &nbsp;text,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;key_fields &nbsp; &nbsp;text[])</font></div><div><font size="2"   >returns void</font></div><div><font size="2"   >AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >LANGUAGE C;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION redis_drop_table(</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;con_num &nbsp; &nbsp; &nbsp; int,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;key_set &nbsp; &nbsp; &nbsp; text DEFAULT NULL,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;key_prefix &nbsp; &nbsp;text DEFAULT NULL)</font></div><div><font size="2"   >returns void</font></div><div><font size="2"   >AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >LANGUAGE C;</font></div><p></p></pre></div><div><br></div><div>-- 连接redis</div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select redis_connect(</font></div><div><font size="2"   >0,</font></div><div><font size="2"   >'127.0.0.1', &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >6379, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >'', &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >0, &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >false);</font></div><div><font size="2"   >&nbsp;redis_connect&nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 ~]# netstat -anp|grep 6379</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:6379 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;16550/redis-server &nbsp;</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 127.0.0.1:47229 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1:6379 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ESTABLISHED 19210/postgres: pos&nbsp;</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 127.0.0.1:6379 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;127.0.0.1:47229 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESTABLISHED 16550/redis-server &nbsp;</font></div><p></p></pre></div><div>-- SET key value测试</div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select redis_command(0,'SET %s %s','a.key','a.value');</font></div><div><font size="2"   >&nbsp;redis_command&nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp;OK</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 ~]# /opt/redis-2.6.13/src/redis-cli&nbsp;</font></div><div><font size="2"   >redis 127.0.0.1:6379&gt;</font></div><div><font size="2"   >redis 127.0.0.1:6379&gt; get a.key</font></div><div><font size="2"   >"a.value"</font></div><div><font size="2"   >redis 127.0.0.1:6379&gt;&nbsp;</font></div><p></p></pre></div><div>-- mset 测试</div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select redis_command_argv(0,'MSET','key1','val1','key2','val2','key3','val3');</font></div><div><font size="2"   >&nbsp;redis_command_argv&nbsp;</font></div><div><font size="2"   >--------------------</font></div><div><font size="2"   >&nbsp;OK</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >redis 127.0.0.1:6379&gt; mget a.key key1 key2 key3</font></div><div><font size="2"   >1) "a.value"</font></div><div><font size="2"   >2) "val1"</font></div><div><font size="2"   >3) "val2"</font></div><div><font size="2"   >4) "val3"</font></div><p></p></pre></div><div>-- 测试push record, 将表的数据写入hash或者sets.</div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from t;</font></div><div><font size="2"   >&nbsp;id&nbsp;</font></div><div><font size="2"   >----</font></div><div><font size="2"   >&nbsp; 1</font></div><div><font size="2"   >&nbsp; 2</font></div><div><font size="2"   >&nbsp; 3</font></div><div><font size="2"   >&nbsp; 1</font></div><div><font size="2"   >&nbsp; 2</font></div><div><font size="2"   >&nbsp; 3</font></div><div><font size="2"   >(6 rows)</font></div><div><font size="2"   >postgres=# select redis_push_record(0, t, true, 'abc', 'def', '{id}'::text[]) from t;</font></div><div><font size="2"   >&nbsp;redis_push_record&nbsp;</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(6 rows)</font></div><p></p></pre></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >redis 127.0.0.1:6379&gt; scard abc</font></div><div><font size="2"   >(integer) 3</font></div><div><font size="2"   >redis 127.0.0.1:6379&gt; spop abc</font></div><div><font size="2"   >"def:2"</font></div><div><font size="2"   >redis 127.0.0.1:6379&gt; spop abc</font></div><div><font size="2"   >"def:3"</font></div><div><font size="2"   >redis 127.0.0.1:6379&gt; spop abc</font></div><div><font size="2"   >"def:1"</font></div><div><font size="2"   >redis 127.0.0.1:6379&gt; spop abc</font></div><div><font size="2"   >(nil)</font></div><div><font size="2"   >redis 127.0.0.1:6379&gt; scard abc</font></div><div><font size="2"   >(integer) 0</font></div><p></p></pre></div><div>-- 清除hashs或者sets的值.</div><div>session a :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select redis_push_record(0, t, true, 'abc', 'def', '{id}'::text[]) from t;</font></div><div><font size="2"   >&nbsp;redis_push_record&nbsp;</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(6 rows)</font></div><p></p></pre></div><div>session b :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >redis 127.0.0.1:6379&gt; scard abc</font></div><div><font size="2"   >(integer) 3</font></div><p></p></pre></div><div>session a :</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select redis_drop_table(0,'abc');</font></div><div><font size="2"   >&nbsp;redis_drop_table&nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>session b :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >redis 127.0.0.1:6379&gt; scard abc</font></div><div><font size="2"   >(integer) 0</font></div><p></p></pre></div><div><br></div><div>【参考】</div><div>1.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="https://bitbucket.org/qooleot/redis_wrapper"   >https://bitbucket.org/qooleot/redis_wrapper</a></div><div>2.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="https://github.com/redis/hiredis"   >https://github.com/redis/hiredis</a></div><div>3.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://redis.io/download"   >http://redis.io/download</a></div><div>4. 引用</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Redis commands from Postgres</font></div><div><font size="2"   >A while ago a client wanted a way to call Redis commands from Postgres, for example to push values to Redis, or perform other Redis housekeeping that can't be done by use of the Redis FDW. I put together a quick Postgres interface using the official hiredis client library, and I have been polishing it up a bit in preparation for my talk at PgCon, and the package is now available for public use.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The basic interface contains functions to provide persistent connection handles, to disconnect, and to call the library functions redisCommand() and redisCommandArgv(). Yesterday, I added functions to push a record to a Redis “table”, and to drop a Redis “table”. I am planning to add a function to push a whole Postgres table or view, but for now this can be achieved by pushing the records - tests yesterday on very modest hardware managed to push 1 million rows in 130 seconds and drop the same table in 45 seconds. Of course, in Redis dropping a table means in effect dropping its component objects, so it's still doing several million operations here.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Of course, Redis doesn't really have tables in the PostgreSQL sense. It has a single global namespace which contains keys, which are strings, and values, which are various sorts of things (strings, integers, lists, hashes, sets, ordered sets). Hence my use of inverted commas above. For this purpose, a Redis table consists of a set of objects whose keys have a common prefix, or whose keys are the elements of a Redis set object. These uses are critical to the effective use of the Redis Foreign Data Wrapper, which I will also be expanding upon in my talk.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >I also added some regression &nbsp;tests which demonstrate the abilities of the interface package. I'll be working on improving the documentation shortly.</font></div><p></p></pre></div></div></div>
	</div>
</div>
</body>
</html>