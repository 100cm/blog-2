<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 Collect and use histograms for range types</h2>
	<h5 id="">2013-05-09 13:36:24&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020134902516813/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>Collect and use histograms for range types (Alexander Korotkov)</div><div>PostgreSQL &nbsp;9.3 增加了对rangetype的统计信息收集, 用于收集range类型的lower和upper值的统计信息.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >Collect and use histograms of lower and upper bounds for range types.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This enables selectivity estimation of the &lt;&lt;, &gt;&gt;, &amp;&lt;, &amp;&gt; and &amp;&amp; operators,</font></div><div><font size="2"   >as well as the normal inequality operators: &lt;, &lt;=, &gt;=, &gt;. "range @&gt; element"</font></div><div><font size="2"   >is also supported, but the range-variant @&gt; and &lt;@ operators are not,</font></div><div><font size="2"   >because they cannot be sensibly estimated with lower and upper bound</font></div><div><font size="2"   >histograms alone. We would need to make some assumption about the lengths of</font></div><div><font size="2"   >the ranges for that. Alexander's patch included a separate histogram of</font></div><div><font size="2"   >lengths for that, but I left that out of the patch for simplicity. Hopefully</font></div><div><font size="2"   >that will be added as a followup patch.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The fraction of empty ranges is also calculated and used in estimation.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Alexander Korotkov, heavily modified by me.</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >Add cost estimation of range @&gt; and &lt;@ operators.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The estimates are based on the existing lower bound histogram, and a new</font></div><div><font size="2"   >histogram of range lengths.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Bump catversion, because the range length histogram now needs to be present</font></div><div><font size="2"   >in statistic slot kind 6, or you get an error on @&gt; and &lt;@ queries. (A</font></div><div><font size="2"   >re-ANALYZE would be enough to fix that, though)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Alexander Korotkov, with some refactoring by me.</font></div></div><p></p></pre></div><div><br></div><div>[测试]</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table test_range_spgist(ir int4range);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into test_range_spgist select int4range(g, g+10) from generate_series(1,2000) g;</font></div><div><font size="2"   >INSERT 0 2000</font></div><div><font size="2"   >digoal=# insert into test_range_spgist select 'empty'::int4range from generate_series(1,500) g;</font></div><div><font size="2"   >INSERT 0 500</font></div><div><font size="2"   >digoal=# insert into test_range_spgist select int4range(g, g+10000) from generate_series(1,1000) g;</font></div><div><font size="2"   >INSERT 0 1000</font></div><div><font size="2"   >digoal=# insert into test_range_spgist select 'empty'::int4range from generate_series(1,500) g;</font></div><div><font size="2"   >INSERT 0 500</font></div><div><font size="2"   >digoal=# insert into test_range_spgist select int4range(NULL,g*10,'(]') from generate_series(1,100) g;</font></div><div><font size="2"   >INSERT 0 100</font></div><div><font size="2"   >digoal=# insert into test_range_spgist select int4range(g*10,NULL,'(]') from generate_series(1,100) g;</font></div><div><font size="2"   >INSERT 0 100</font></div><div><font size="2"   >digoal=# insert into test_range_spgist select int4range(g, g+10) from generate_series(1,2000) g;</font></div><div><font size="2"   >INSERT 0 2000</font></div><div><font size="2"   >digoal=# create index test_range_gist_idx on test_range_spgist using gist (ir);</font></div><div><font size="2"   >digoal=# analyze test_range_spgist ;</font></div><div><font size="2"   >ANALYZE</font></div><div><font size="2"   >digoal=# select * from pg_stats where attname='ir';</font></div><div><font size="2"   >-[ RECORD 1 ]----------+------------------</font></div><div><font size="2"   >schemaname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | public</font></div><div><font size="2"   >tablename &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| test_range_spgist</font></div><div><font size="2"   >attname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| ir</font></div><div><font size="2"   >inherited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f</font></div><div><font size="2"   >null_frac &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"   >avg_width &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 13</font></div><div><font size="2"   >n_distinct &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | -1</font></div><div><font size="2"   >most_common_vals &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >most_common_freqs &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >histogram_bounds &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >correlation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >most_common_elems &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >most_common_elem_freqs |&nbsp;</font></div><div><font size="2"   >elem_count_histogram &nbsp; |&nbsp;</font></div><p></p></pre></div><div>histogram_bounds没有数据, 因为rangetype的统计信息没有存储在这里.</div><div>而是在RangeBound这个数据结构中, 参考本文末尾.</div><div>使用gdb可以跟踪到analyze时调用compute_range_stats.</div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select pg_backend_pid();</font></div><div><font size="2"   >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 17253</font></div><p></p></pre></div><div><br></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; gdb</font></div><div><font size="2"   >GNU gdb (GDB) Red Hat Enterprise Linux (7.0.1-37.el5)</font></div><div><font size="2"   >Copyright (C) 2009 Free Software Foundation, Inc.</font></div><div><font size="2"   >License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</font></div><div><font size="2"   >This is free software: you are free to change and redistribute it.</font></div><div><font size="2"   >There is NO WARRANTY, to the extent permitted by law. &nbsp;Type "show copying"</font></div><div><font size="2"   >and "show warranty" for details.</font></div><div><font size="2"   >This GDB was configured as "x86_64-redhat-linux-gnu".</font></div><div><font size="2"   >For bug reporting instructions, please see:</font></div><div><font size="2"   >&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</font></div><div><font size="2"   >(gdb) attach 17253</font></div><div><font size="2"   >Attaching to process 17253</font></div><div><font size="2"   >(gdb) b compute_range_stats</font></div><div><font size="2"   >Breakpoint 1 at 0x6eeb80: file rangetypes_typanalyze.c, line 97.</font></div><div><font size="2"   >(gdb) c</font></div><div><font size="2"   >Continuing.</font></div></pre></div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >digoal=# analyze test_range_spgist;</font></p></pre></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Breakpoint 1, compute_range_stats (stats=0x17763c98, fetchfunc=0x51aab0 &lt;std_fetch_func&gt;, samplerows=30000, totalrows=1006200)</font></div><div><font size="2"   >&nbsp; &nbsp; at rangetypes_typanalyze.c:97</font></div><div><font size="2"   >97 &nbsp; &nbsp; &nbsp;{</font></div><p></p></pre></div></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=918eee0c497c88260a2e107318843c9b1947bc6f"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=918eee0c497c88260a2e107318843c9b1947bc6f</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=59d0bf9dca58b237902c2fd1507e8bc5d54d4a63"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=59d0bf9dca58b237902c2fd1507e8bc5d54d4a63</a></div><div>3.&nbsp;src/backend/utils/adt/rangetypes_typanalyze.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* range_typanalyze -- typanalyze function for range columns</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >Datum</font></div><div><font size="2"   >range_typanalyze(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; VacAttrStats *stats = (VacAttrStats *) PG_GETARG_POINTER(0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TypeCacheEntry *typcache;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Form_pg_attribute attr = stats-&gt;attr;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Get information about range type */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; typcache = range_get_typcache(fcinfo, stats-&gt;attrtypid);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (attr-&gt;attstattarget &lt; 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; attr-&gt;attstattarget = default_statistics_target;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; stats-&gt;compute_stats = compute_range_stats;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; stats-&gt;extra_data = typcache;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* same as in std_typanalyze */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; stats-&gt;minrows = 300 * attr-&gt;attstattarget;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_BOOL(true);</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>4.&nbsp;src/include/utils/rangetypes.h</div><div>记录range的边界值, 例如包括 : 值, 是否无限值, 是否包含该值, 是lower还是upper值.</div><div>range类型的统计信息应该包括两个RangeBound值, 分别记录lower和upper值.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >00059 /* Internal representation of either bound of a range (not what's on disk) */</font></div><div><font size="2"   >00060 typedef struct</font></div><div><font size="2"   >00061 {</font></div><div><font size="2"   >00062 &nbsp; &nbsp; Datum &nbsp; &nbsp; &nbsp; val; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* the bound value, if any */</font></div><div><font size="2"   >00063 &nbsp; &nbsp; bool &nbsp; &nbsp; &nbsp; &nbsp;infinite; &nbsp; &nbsp; &nbsp; /* bound is +/- infinity */</font></div><div><font size="2"   >00064 &nbsp; &nbsp; bool &nbsp; &nbsp; &nbsp; &nbsp;inclusive; &nbsp; &nbsp; &nbsp;/* bound is inclusive (vs exclusive) */</font></div><div><font size="2"   >00065 &nbsp; &nbsp; bool &nbsp; &nbsp; &nbsp; &nbsp;lower; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* this is the lower (vs upper) bound */</font></div><div><font size="2"   >00066 } RangeBound;</font></div><p></p></pre></div><div>5.&nbsp;src/backend/utils/adt/rangetypes_typanalyze.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >00091 /*</font></div><div><font size="2"   >00092 &nbsp;* compute_range_stats() -- compute statistics for a range column</font></div><div><font size="2"   >00093 &nbsp;*/</font></div><div><font size="2"   >00094 static void</font></div><div><font size="2"   >00095 compute_range_stats(VacAttrStats *stats, AnalyzeAttrFetchFunc fetchfunc,</font></div><div><font size="2"   >00096 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int samplerows, double totalrows)</font></div><div><font size="2"   >00097 {</font></div><div><font size="2"   >00098 &nbsp; &nbsp; TypeCacheEntry *typcache = (TypeCacheEntry *) stats-&gt;extra_data;</font></div><div><font size="2"   >00099 &nbsp; &nbsp; bool &nbsp; &nbsp; &nbsp; &nbsp;has_subdiff = OidIsValid(typcache-&gt;rng_subdiff_finfo.fn_oid);</font></div><div><font size="2"   >00100 &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; null_cnt = 0;</font></div><div><font size="2"   >00101 &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; non_null_cnt = 0;</font></div><div><font size="2"   >00102 &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; non_empty_cnt = 0;</font></div><div><font size="2"   >00103 &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; empty_cnt = 0;</font></div><div><font size="2"   >00104 &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; range_no;</font></div><div><font size="2"   >00105 &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; slot_idx;</font></div><div><font size="2"   >00106 &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; num_bins = stats-&gt;attr-&gt;attstattarget;</font></div><div><font size="2"   >00107 &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; num_hist;</font></div><div><font size="2"   >00108 &nbsp; &nbsp; float8 &nbsp; &nbsp; *lengths;</font></div><div><font size="2"   >00109 &nbsp; &nbsp; RangeBound *lowers, *uppers;</font></div><div><font size="2"   >00110 &nbsp; &nbsp; double &nbsp; &nbsp; &nbsp;total_width = 0;</font></div><div><font size="2"   >00111&nbsp;</font></div><div><font size="2"   >00112 &nbsp; &nbsp; /* Allocate memory to hold range bounds and lengths of the sample ranges. */</font></div><div><font size="2"   >00113 &nbsp; &nbsp; lowers = (RangeBound *) palloc(sizeof(RangeBound) * samplerows);</font></div><div><font size="2"   >00114 &nbsp; &nbsp; uppers = (RangeBound *) palloc(sizeof(RangeBound) * samplerows);</font></div><div><font size="2"   >00115 &nbsp; &nbsp; lengths = (float8 *) palloc(sizeof(float8) * samplerows);</font></div><p></p></pre></div><div>略...</div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL 9.3 Collect and use histograms for range types - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>