<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 psql backslash commands improve</h2>
	<h5 id="">2013-05-16 8:39:22&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201341681647377/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p></p><div><font size="2"   >E.1.3.8.1.1. Backslash Commands</font></div><div><font size="2"   >Add psql \watch command to repeatedly execute commands (Will Leinweber)</font></div><div><font size="2"   >Add psql command \gset to store query results in psql variables (Pavel Stehule)</font></div><div><font size="2"   >Add SSL information to psql's \conninfo command (Alastair Turner)</font></div><div><font size="2"   >Add "Security" label to psql \df+ output (Jon Erdman)</font></div><div><font size="2"   >Allow psql \l to accept a database name pattern (Peter Eisentraut)</font></div><div><font size="2"   >In psql, do not allow \connect to use defaults if there is no active connection (Bruce Momjian)</font></div><div><font size="2"   >This might be the case if the server had crashed.</font></div><div><font size="2"   >Properly reset state if the SQL command executed with psql's "\g file" fails (Tom Lane)</font></div><div><font size="2"   >Previously, the output from subsequent SQL commands would unexpectedly continue to go to the same file.</font></div><p></p></pre></div><div><br></div><div>举例 :&nbsp;</div><div>1. PostgreSQL 9.3 psql 新增\watch命令, 可以重复执行query buffer中的指令.</div><div>例如当前的buffer如下</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select query from pg_stat_activity where state&lt;&gt;'idle';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------------------------------------------</font></div><div><font size="2"   >&nbsp;select query from pg_stat_activity where state&lt;&gt;'idle';</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >-- 查看当前query buffer</font></div><div><font size="2"   >postgres=# \p</font></div><div><font size="2"   >select query from pg_stat_activity where state&lt;&gt;'idle';</font></div><p></p></pre></div><div>单次执行 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \g</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------------------------------------------</font></div><div><font size="2"   >&nbsp;select query from pg_stat_activity where state&lt;&gt;'idle';</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>每隔2秒重复执行 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \watch 2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Watch every 2s &nbsp;Thu May 16 08:25:29 2013</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------------------------------------------</font></div><div><font size="2"   >&nbsp;select query from pg_stat_activity where state&lt;&gt;'idle';</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Watch every 2s &nbsp;Thu May 16 08:25:31 2013</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------------------------------------------</font></div><div><font size="2"   >&nbsp;select query from pg_stat_activity where state&lt;&gt;'idle';</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Watch every 2s &nbsp;Thu May 16 08:25:33 2013</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------------------------------------------</font></div><div><font size="2"   >&nbsp;select query from pg_stat_activity where state&lt;&gt;'idle';</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>CTRL+C退出, 同时清除当前的query buffer.</div><div><br></div><div>2. \gset 用来将单行查询结果存储到psql变量中.</div><div>执行步骤是先\g, 然后\set, 所以会执行一次buffer中的sql.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;\gset [ prefix ]</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sends the current query input buffer to the server and stores the query's output into psql variables (see</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Variables). The query to be executed must return exactly one row. Each column of the row is stored into a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;separate variable, named the same as the column. For example:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=&gt; SELECT 'hello' AS var1, 10 AS var2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; \gset</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=&gt; \echo :var1 :var2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hello 10</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;If you specify a prefix, that string is prepended to the query's column names to create the variable names</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;to use:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=&gt; SELECT 'hello' AS var1, 10 AS var2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; \gset result_</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=&gt; \echo :result_var1 :result_var2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hello 10</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;If a column result is NULL, the corresponding variable is unset rather than being set.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;If the query fails or does not return one row, no variables are changed.</font></div><p></p></pre></div><div>例如 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select clock_timestamp() as time, i from generate_series(1,10) i limit 1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| i&nbsp;</font></div><div><font size="2"   >-------------------------------+---</font></div><div><font size="2"   >&nbsp;2013-05-16 08:29:57.662355+08 | 1</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>查看当前buffer:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \p</font></div><div><font size="2"   >select clock_timestamp() as time, i from generate_series(1,10) i limit 1;</font></div><p></p></pre></div><div>单行结果, 先执行\g, 然后\set, 注意不是直接把前面的执行结果设置到变量中, 而是先执行, 然后设置成功.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \gset</font></div><div><font size="2"   >postgres=# \echo :time :i</font></div><div><font size="2"   >2013-05-16 08:30:00.387705+08 1</font></div><div><font size="2"   >postgres=# \gset prefix_</font></div><div><font size="2"   >postgres=# \echo :time :i</font></div><div><font size="2"   >2013-05-16 08:30:00.387705+08 1</font></div><div><font size="2"   >postgres=# \echo :prefix_time :prefix_i</font></div><div><font size="2"   >2013-05-16 08:31:09.343173+08 1</font></div><p></p></pre></div></div><div>多行将报错 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select clock_timestamp() as time, i from generate_series(1,10) i;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| i &nbsp;</font></div><div><font size="2"   >-------------------------------+----</font></div><div><font size="2"   >&nbsp;2013-05-16 08:29:37.038693+08 | &nbsp;1</font></div><div><font size="2"   >&nbsp;2013-05-16 08:29:37.038699+08 | &nbsp;2</font></div><div><font size="2"   >&nbsp;2013-05-16 08:29:37.038702+08 | &nbsp;3</font></div><div><font size="2"   >&nbsp;2013-05-16 08:29:37.038704+08 | &nbsp;4</font></div><div><font size="2"   >&nbsp;2013-05-16 08:29:37.038706+08 | &nbsp;5</font></div><div><font size="2"   >&nbsp;2013-05-16 08:29:37.038708+08 | &nbsp;6</font></div><div><font size="2"   >&nbsp;2013-05-16 08:29:37.03871+08 &nbsp;| &nbsp;7</font></div><div><font size="2"   >&nbsp;2013-05-16 08:29:37.038712+08 | &nbsp;8</font></div><div><font size="2"   >&nbsp;2013-05-16 08:29:37.038715+08 | &nbsp;9</font></div><div><font size="2"   >&nbsp;2013-05-16 08:29:37.038722+08 | 10</font></div><div><font size="2"   >(10 rows)</font></div><p></p></pre></div><div>查看当前buffer</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# \p</font></div><div><font size="2"   >select clock_timestamp() as time, i from generate_series(1,10) i;</font></div></div><div><font size="2"   >postgres=# \gset&nbsp;</font></div><div><font size="2"   >more than one row returned for \gset</font></div><p></p></pre></div></div><div><br></div><div>3. query buffer</div><div>\e进行编辑, 注意只保留最后1条完整的sql, 不管是否换行.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >\e</font></div><div><div><font size="2"   >select</font></div><div><font size="2"   >clock_timestamp() as time, i from generate_series(1,10) i limit 1</font></div><div><font size="2"   >;</font></div><div><font size="2"   >select now() as now,</font></div><div><font size="2"   >1 as id</font></div><div><font size="2"   >;</font></div></div><p></p></pre></div><div>:x 退出</div><div><div>"/tmp/psql.edit.3040.sql" 6L, 107C written</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| i&nbsp;</font></div><div><font size="2"   >-------------------------------+---</font></div><div><font size="2"   >&nbsp;2013-05-16 08:38:36.324295+08 | 1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; now &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| id&nbsp;</font></div><div><font size="2"   >-------------------------------+----</font></div><div><font size="2"   >&nbsp;2013-05-16 08:38:36.324422+08 | &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>-- query buffer中保留了第二条sql :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \p</font></div><div><font size="2"   >select now() as now,</font></div><div><font size="2"   >1 as id</font></div><div><font size="2"   >;</font></div><div><font size="2"   >postgres=# \g</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; now &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| id&nbsp;</font></div><div><font size="2"   >-------------------------------+----</font></div><div><font size="2"   >&nbsp;2013-05-16 08:38:41.003493+08 | &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div><br></div>[参考]<wbr><div>1. man psql</div></div>
	</div>
</div>
</body>
</html>