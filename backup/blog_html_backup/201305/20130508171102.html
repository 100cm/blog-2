<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 Add the last checkpoint's redo location to pg_controldata's output</h2>
	<h5 id="">2013-05-08 17:11:02&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013485940250/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>Add the last checkpoint's redo location to pg_controldata's output (Fujii Masao)</div><div>This information is useful for determining the WAL files needed for restore.</div></div><div>PostgreSQL 9.3 在控制文件中添加了最后一次checkpoint的wal文件名. 如果数据库崩溃要恢复到一个一致性状态, 那么需要从这个文件开始的所有xlog文件.</div><div>涉及到源码常见本文末尾部分.</div><div>如下 :&nbsp;</div><div><div>pg93@db-172-16-3-33-&gt; pg_controldata&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg_control version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;937</font></div><div><font size="2"   >Catalog version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 201304271</font></div><div><font size="2"   >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5874470726249995168</font></div><div><font size="2"   >Database cluster state: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in production</font></div><div><font size="2"   >pg_control last modified: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Wed 08 May 2013 05:04:08 PM CST</font></div><div><font size="2"   >Latest checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2/560007E0</font></div><div><font size="2"   >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2/56000740</font></div><div><font size="2"   >Latest checkpoint's REDO location: &nbsp; &nbsp;2/560007A8</font></div><div><font size="2"   >Latest checkpoint's REDO WAL file: &nbsp; &nbsp;000000030000000200000056</font></div><div><font size="2"   >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 3</font></div><div><font size="2"   >Latest checkpoint's PrevTimeLineID: &nbsp; 3</font></div><div><font size="2"   >Latest checkpoint's full_page_writes: on</font></div><div><font size="2"   >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/12158712</font></div><div><font size="2"   >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16525</font></div><div><font size="2"   >Latest checkpoint's NextMultiXactId: &nbsp;1</font></div><div><font size="2"   >Latest checkpoint's NextMultiOffset: &nbsp;0</font></div><div><font size="2"   >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;1674</font></div><div><font size="2"   >Latest checkpoint's oldestXID's DB: &nbsp; 1</font></div><div><font size="2"   >Latest checkpoint's oldestActiveXID: &nbsp;12158712</font></div><div><font size="2"   >Latest checkpoint's oldestMultiXid: &nbsp; 1</font></div><div><font size="2"   >Latest checkpoint's oldestMulti's DB: 1</font></div><div><font size="2"   >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Wed 08 May 2013 05:04:08 PM CST</font></div><div><font size="2"   >Fake LSN counter for unlogged rels: &nbsp; 0/3</font></div><div><font size="2"   >Minimum recovery ending location: &nbsp; &nbsp; 0/0</font></div><div><font size="2"   >Min recovery ending loc's timeline: &nbsp; 0</font></div><div><font size="2"   >Backup start location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"   >Backup end location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"   >End-of-backup record required: &nbsp; &nbsp; &nbsp; &nbsp;no</font></div><div><font size="2"   >Current wal_level setting: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hot_standby</font></div><div><font size="2"   >Current max_connections setting: &nbsp; &nbsp; &nbsp;100</font></div><div><font size="2"   >Current max_prepared_xacts setting: &nbsp; 0</font></div><div><font size="2"   >Current max_locks_per_xact setting: &nbsp; 64</font></div><div><font size="2"   >Maximum data alignment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8</font></div><div><font size="2"   >Database block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8192</font></div><div><font size="2"   >Blocks per segment of large relation: 131072</font></div><div><font size="2"   >WAL block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 16384</font></div><div><font size="2"   >Bytes per WAL segment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16777216</font></div><div><font size="2"   >Maximum length of identifiers: &nbsp; &nbsp; &nbsp; &nbsp;64</font></div><div><font size="2"   >Maximum columns in an index: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;32</font></div><div><font size="2"   >Maximum size of a TOAST chunk: &nbsp; &nbsp; &nbsp; &nbsp;1996</font></div><div><font size="2"   >Date/time type storage: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64-bit integers</font></div><div><font size="2"   >Float4 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><div><font size="2"   >Float8 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><div><font size="2"   >Data page checksum version: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >相比PostgreSQL 9.2新增了如下记录 :&nbsp;</font></div><div><div><font size="2"   >Latest checkpoint's REDO WAL file: &nbsp; &nbsp;000000030000000200000056</font></div><div><font size="2"   >Latest checkpoint's PrevTimeLineID: &nbsp; 3</font></div><div><font size="2"   >Latest checkpoint's oldestMultiXid: &nbsp; 1</font></div><div><font size="2"   >Latest checkpoint's oldestMulti's DB: 1</font></div><div><font size="2"   >Fake LSN counter for unlogged rels: &nbsp; 0/3</font></div><div><font size="2"   >Min recovery ending loc's timeline: &nbsp; 0</font></div><div><font size="2"   >Data page checksum version: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div></div><p></p></pre></div></div><div><br></div><div>其中<span style="line-height: 22px;"   >Latest checkpoint's REDO WAL file: &nbsp; &nbsp;000000030000000200000056就是文件名.</span></div><div><span style="line-height: 22px;"   >但是这个文件名实际上在已有的信息中也可以推算出来.</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 3</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >Latest checkpoint's REDO location: &nbsp; &nbsp;2/560007A8</font></span></div><p></p></pre></div><div>具体如何计算可以参考 :&nbsp;</div><div><a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/"   >http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/</a></div><div>得到的文件名也是<span style="line-height: 22px;"   >000000030000000200000056.</span></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/"   >http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/</a></div><div>2.&nbsp;src/bin/pg_controldata/pg_controldata.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Calculate name of the WAL file containing the latest checkpoint's REDO</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* start point.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; XLByteToSeg(ControlFile.checkPointCopy.redo, segno);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; XLogFileName(xlogfilename, ControlFile.checkPointCopy.ThisTimeLineID, segno);</font></div></div><div><font size="2"   >......</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; printf(_("Latest checkpoint's REDO WAL file: &nbsp; &nbsp;%s\n"),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;xlogfilename);</font></div></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>