<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL gin index fastupdate performance tuning case</h2>
	<h5 id="">2013-05-16 16:08:32&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201341625735128/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在使用PostgreSQL gin索引时, 发现插入速度很慢的现象.</div><div>来看一个测试 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create table trgm_test(id serial4 primary key, info text);&nbsp;</font></div><div><font size="2"   >create index trgm_test_gin on trgm_test using gin (info gin_trgm_ops);</font></div><p></p></pre></div><div>测试脚本 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi ins.sql</font></div><div><font size="2"   >insert into trgm_test (info) values(md5(random()::text));</font></div><div><font size="2"   >pgbench -M prepared -r -n -f ./ins.sql -c 16 -j 1 -T 60</font></div><p></p></pre></div></div><div># 测试过程中查看, 基本上pending_pages不会超过132.</div><div># 具体的原因见分析部分.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# show work_mem;</font></div><div><font size="2"   >&nbsp;work_mem&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;1MB</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=# show autovacuum;</font></div><div><font size="2"   >&nbsp;autovacuum&nbsp;</font></div><div><font size="2"   >------------</font></div><div><font size="2"   >&nbsp;on</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=# select 1024/8;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 128</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><span style="line-height: 19px;"   >digoal=# select * from pgstatginindex('trgm_test_gin');<br> version | pending_pages | pending_tuples <br>---------+---------------+----------------<br>       1 |           134 |            837<br>(1 row)<br>digoal=# \watch 1<br> Watch every 1s Thu May 16 15:10:15 2013<br><br> version | pending_pages | pending_tuples <br>---------+---------------+----------------<br>       1 |             7 |             83<br>(1 row)<br> Watch every 1s Thu May 16 15:10:16 2013<br><br> version | pending_pages | pending_tuples <br>---------+---------------+----------------<br>       1 |           131 |            852<br>(1 row)<br> Watch every 1s Thu May 16 15:10:17 2013<br><br> version | pending_pages | pending_tuples <br>---------+---------------+----------------<br>       1 |            51 |            459<br>(1 row)<br> Watch every 1s Thu May 16 15:10:18 2013<br> version | pending_pages | pending_tuples <br>---------+---------------+----------------<br>       1 |           133 |            893<br>(1 row)<br> Watch every 1s Thu May 16 15:10:19 2013<br><br> version | pending_pages | pending_tuples <br>---------+---------------+----------------<br>       1 |           132 |            827<br>(1 row)<br> Watch every 1s Thu May 16 15:10:20 2013<br><br> version | pending_pages | pending_tuples <br>---------+---------------+----------------<br>       1 |            50 |            347<br>(1 row)<br> Watch every 1s Thu May 16 15:10:21 2013<br><br> version | pending_pages | pending_tuples <br>---------+---------------+----------------<br>       1 |           135 |            772<br>(1 row)</span></font></div></div><p></p></pre></div><div>测试结果 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -r -n -f ./ins.sql -c 16 -j 1 -T 60</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 46369</font></div><div><font size="2"   >tps = 758.790984 (including connections establishing)</font></div><div><font size="2"   >tps = 759.240709 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 20.930864 &nbsp; &nbsp; &nbsp; insert into trgm_test (info) values(md5(random()::text));</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >tps只有758.&nbsp;</span></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >原因分析 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >57.3.1. GIN Fast Update Technique</font></span></div><div><div><font size="2"   >Updating a GIN index tends to be slow because of the intrinsic nature of inverted indexes: inserting or updating one heap row can cause many inserts into the index (one for each key extracted from the indexed item).&nbsp;</font></div><div><font size="2"   >因为插入一行, 可能会产生很多个gin条目, 因此gin的索引更新会是一个瓶颈.</font></div><div><font size="2"   >为了加快gin索引的更新速度, 从8.4开始, gin引入了临时空间的方法, 也就是gin的条目先临时存放到一个内存空间中.</font></div><div><font size="2"   >As of PostgreSQL 8.4, GIN is capable of postponing much of this work by inserting new tuples into a temporary, unsorted list of pending entries.&nbsp;</font></div><div><font size="2"   >When the table is vacuumed, or if the pending list becomes too large (larger than work_mem),&nbsp;</font></div><div><font size="2"   >当临时的未排序的list大于work_mem或者表被vacuum时, 这些条目采用batch的方式写入GIN索引数据结构中.</font></div><div><font size="2"   >the entries are moved to the main GIN data structure using the same bulk insert techniques used during initial index creation.&nbsp;</font></div><div><font size="2"   >This greatly improves GIN index update speed, even counting the additional vacuum overhead. Moreover the overhead work can be done by a background process instead of in foreground query processing.</font></div><div><font size="2"   >主要的缺点是, 当临时空间中的数据量很大时, 查询速度会变慢, 因为需要查询gin索引同时还需要查询临时空间结构(未排序).&nbsp;</font></div><div><font size="2"   >The main disadvantage of this approach is that searches must scan the list of pending entries in addition to searching the regular index, and so a large list of pending entries will slow searches significantly.&nbsp;</font></div><div><font size="2"   >另一个缺点是, 触发too large(也就是超出work_mem时)batch update的那个插入会变得很慢.就是说当work_mem满了的时候, 后续的插入无法利用work_mem了, 只有等batch update完毕, work_mem清除了才会变快.</font></div><div><font size="2"   >Another disadvantage is that, while most updates are fast, an update that causes the pending list to become "too large" will incur an immediate cleanup cycle and thus be much slower than other updates. Proper use of autovacuum can minimize both of these problems.</font></div><div><font size="2"   >如果要有比较均衡的速度, 最好使用autovacuum, 在work_mem满之前触发gin batch update.</font></div><div><font size="2"   >If consistent response time is more important than update speed, use of pending entries can be disabled by turning off the FASTUPDATE storage parameter for a GIN index. See CREATE INDEX for details.</font></div></div><p></p></pre></div><div>上面我们看到pending_pages最高只达到130多, 马上又会降下去.</div><div>原因是存放pending entries的空间达到work_mem定义的大小了, 到达后会执行batch gin update.</div><div>因此优化的简单办法就是提高work_mem.</div><div>(建议细化到会话级别的配置, 或者用户级别, 或者用户加数据库级别, 不太推荐global级别的配置.)</div><div>本例配置digoal用户连接digoal数据库的work_mem=10240MB;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# alter role digoal in database digoal set work_mem='10240MB';</font></div><div><font size="2"   >ALTER ROLE</font></div><p></p></pre></div><div>然后再进行测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -r -n -f ./ins.sql -c 16 -j 1 -T 60</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 1175152</font></div><div><font size="2"   >tps = 18963.009857 (including connections establishing)</font></div><div><font size="2"   >tps = 18973.793589 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.842189 &nbsp; &nbsp; &nbsp; &nbsp;insert into trgm_test (info) values(md5(random()::text));</font></div><p></p></pre></div><div>测试结束后查看 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select * from pgstatginindex('trgm_test_gin');</font></div><div><font size="2"   >&nbsp;version | pending_pages | pending_tuples&nbsp;</font></div><div><font size="2"   >---------+---------------+----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp;238767 | &nbsp; &nbsp; &nbsp; &nbsp;1175152</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ># 注意pgbench查看到的真实处理的事务数和pending_tuples一致, 原因是work_mem被调整到10GB了, 完全可以放下这些tuple.</font></div><div><font size="2"   ># 因此没有触发batch update</font></div><div><font size="2"   >digoal=# vacuum verbose trgm_test ;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.trgm_test"</font></div><div><font size="2"   >INFO: &nbsp;index "trgm_test_pkey" now contains 1175152 row versions in 3224 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 index row versions were removed.</font></div><div><font size="2"   >0 index pages have been deleted, 0 are currently reusable.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.01 sec.</font></div><div><font size="2"   >INFO: &nbsp;index "trgm_test_gin" now contains 1175152 row versions in 274998 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 index row versions were removed.</font></div><div><font size="2"   >238767 index pages have been deleted, 238767 are currently reusable.</font></div><div><font size="2"   >CPU 5.68s/20.41u sec elapsed 32.65 sec.</font></div><div><font size="2"   >INFO: &nbsp;"trgm_test": found 0 removable, 1175152 nonremovable row versions in 9800 out of 9800 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 5.75s/20.51u sec elapsed 32.82 sec.</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "pg_toast.pg_toast_26012"</font></div><div><font size="2"   >INFO: &nbsp;index "pg_toast_26012_index" now contains 0 row versions in 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 index row versions were removed.</font></div><div><font size="2"   >0 index pages have been deleted, 0 are currently reusable.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;"pg_toast_26012": found 0 removable, 0 nonremovable row versions in 0 out of 0 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div></div><div><div><font size="2"   >digoal=# select * from pgstatginindex('trgm_test_gin');</font></div><div><font size="2"   >&nbsp;version | pending_pages | pending_tuples&nbsp;</font></div><div><font size="2"   >---------+---------------+----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >vacuum结束后pengding tuples全部更新到gin索引了.</font></div><div><font size="2"   >digoal=# \di+ trgm_test_gin <br>                               List of relations<br> Schema |     Name      | Type  |  Owner   |   Table   |  Size   | Description <br>--------+---------------+-------+----------+-----------+---------+-------------<br> public | trgm_test_gin | index | postgres | trgm_test | 2149 MB | <br>(1 row)</font></div><p></p></pre></div><div>临时段的信息并不是存储在内存中, 因为数据库重启后这部分信息不会丢失.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select * from pgstatginindex('trgm_test_gin');</font></div><div><font size="2"   >&nbsp;version | pending_pages | pending_tuples&nbsp;</font></div><div><font size="2"   >---------+---------------+----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp;229168 | &nbsp; &nbsp; &nbsp; &nbsp;1548960</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_ctl stop -m fast</font></div><div><font size="2"   >waiting for server to shut down.......................... done</font></div><div><font size="2"   >server stopped</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_ctl start</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; LOG: &nbsp;00000: loaded library "pg_stat_statements"</font></div><div><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1296</font></div></div><div><div style="line-height: 22px;"   ><font size="2"   >digoal=# select * from pgstatginindex('trgm_test_gin');</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;version | pending_pages | pending_tuples&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >---------+---------------+----------------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp;229168 | &nbsp; &nbsp; &nbsp; &nbsp;1548960</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=# vacuum verbose trgm_test ;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.trgm_test"</font></div><div><font size="2"   >INFO: &nbsp;index "trgm_test_pkey" now contains 2724112 row versions in 7471 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 index row versions were removed.</font></div><div><font size="2"   >0 index pages have been deleted, 0 are currently reusable.</font></div><div><font size="2"   >CPU 0.02s/0.00u sec elapsed 0.03 sec.</font></div><div><font size="2"   >INFO: &nbsp;index "trgm_test_gin" now contains 2723798 row versions in 305968 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 index row versions were removed.</font></div><div><font size="2"   >229168 index pages have been deleted, 229168 are currently reusable.</font></div><div><font size="2"   >CPU 5.22s/36.42u sec elapsed 42.03 sec.</font></div><div><font size="2"   >INFO: &nbsp;"trgm_test": found 0 removable, 1550032 nonremovable row versions in 12923 out of 22707 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 5.35s/36.56u sec elapsed 42.30 sec.</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "pg_toast.pg_toast_26012"</font></div><div><font size="2"   >INFO: &nbsp;index "pg_toast_26012_index" now contains 0 row versions in 1 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 index row versions were removed.</font></div><div><font size="2"   >0 index pages have been deleted, 0 are currently reusable.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >INFO: &nbsp;"pg_toast_26012": found 0 removable, 0 nonremovable row versions in 0 out of 0 pages</font></div><div><font size="2"   >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div></div><p></p></pre></div><div>gin索引数据结构. 包含了metapage, btree of key entries, posting tree pages, list pages.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >A GIN index contains :&nbsp;</font></div><div><font size="2"   >1. a <u>metapage</u>,&nbsp;</font></div><div><font size="2"   >2. a <u>btree of key entries</u>,&nbsp;</font></div><div><font size="2"   >3. and possibly&nbsp;<span style="line-height: 22px;"   ><u>"posting tree" pages</u>, which hold the overflow when a key entry acquires&nbsp;</span><span style="line-height: 22px;"   >too many heap tuple pointers to fit in a btree page.&nbsp;</span></font></div><div><font size="2"   ><span style="line-height: 22px;"   >4. Additionally, if the&nbsp;</span><span style="line-height: 22px;"   >fast-update feature is enabled, there can be "<u>list pages</u>" holding "pending"&nbsp;</span><span style="line-height: 22px;"   >key entries that haven't yet been merged into the main btree. &nbsp;</span></font></div><div><font size="2"   >The list&nbsp;<span style="line-height: 22px;"   >pages have to be scanned linearly when doing a search, so the pending</span></font></div><div><font size="2"   >entries should be merged into the main btree before there get to be too</font></div><div><font size="2"   >many of them. &nbsp;The advantage of the pending list is that bulk insertion of</font></div><div><font size="2"   >a few thousand entries can be much faster than retail insertion. &nbsp;(The win</font></div><div><font size="2"   >comes mainly from not having to do multiple searches/insertions when the</font></div><div><font size="2"   >same key appears in multiple new heap tuples.)</font></div><p></p></pre></div><div><pre style="font-family: monospace, fixed; font-size: 9pt; border: 1px solid rgb(196, 207, 229); background-color: rgb(251, 252, 253); padding: 4px 6px; margin: 4px 8px 4px 2px; overflow: auto; word-wrap: break-word; line-height: 15px;"   ><a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html"   >00056</a> <span style="color: rgb(0, 128, 0);"   >typedef</span> <span style="color: rgb(0, 128, 0);"   >struct </span><a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html"   >GinMetaPageData</a>
<a style="color: rgb(61, 87, 140);" name="l00057" rel="nofollow"   ></a>00057 {
<a style="color: rgb(61, 87, 140);" name="l00058" rel="nofollow"   ></a>00058     <span style="color: rgb(128, 0, 0);"   >/*</span>
<a style="color: rgb(61, 87, 140);" name="l00059" rel="nofollow"   ></a>00059 <span style="color: rgb(128, 0, 0);"   >     * Pointers to head and tail of pending list, which consists of GIN_LIST</span>
<a style="color: rgb(61, 87, 140);" name="l00060" rel="nofollow"   ></a>00060 <span style="color: rgb(128, 0, 0);"   >     * pages.  These store fast-inserted entries that haven't yet been moved</span>
<a style="color: rgb(61, 87, 140);" name="l00061" rel="nofollow"   ></a>00061 <span style="color: rgb(128, 0, 0);"   >     * into the regular GIN structure.</span>
<a style="color: rgb(61, 87, 140);" name="l00062" rel="nofollow"   ></a>00062 <span style="color: rgb(128, 0, 0);"   >     */</span>
<a style="color: rgb(61, 87, 140);" name="l00063" rel="nofollow"   ></a><a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html#ade3ad30c915099eb270c5280c67be5da"   >00063</a>     <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/block_8h.html#a0be1c1ab88d7f8120e2cd2e8ac2697a1"   >BlockNumber</a> <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html#ade3ad30c915099eb270c5280c67be5da"   >head</a>;
<a style="color: rgb(61, 87, 140);" name="l00064" rel="nofollow"   ></a><a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html#a4feb2d7d3e735ac1a89bb7b107c3431c"   >00064</a>     <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/block_8h.html#a0be1c1ab88d7f8120e2cd2e8ac2697a1"   >BlockNumber</a> <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html#a4feb2d7d3e735ac1a89bb7b107c3431c"   >tail</a>;
<a style="color: rgb(61, 87, 140);" name="l00065" rel="nofollow"   ></a>00065 
<a style="color: rgb(61, 87, 140);" name="l00066" rel="nofollow"   ></a>00066     <span style="color: rgb(128, 0, 0);"   >/*</span>
<a style="color: rgb(61, 87, 140);" name="l00067" rel="nofollow"   ></a>00067 <span style="color: rgb(128, 0, 0);"   >     * Free space in bytes in the pending list's tail page.</span>
<a style="color: rgb(61, 87, 140);" name="l00068" rel="nofollow"   ></a>00068 <span style="color: rgb(128, 0, 0);"   >     */</span>
<a style="color: rgb(61, 87, 140);" name="l00069" rel="nofollow"   ></a><a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html#a6724ffacaee60a7865201f4869644872"   >00069</a>     <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/c_8h.html#a1134b580f8da4de94ca6b1de4d37975e"   >uint32</a>      <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html#a6724ffacaee60a7865201f4869644872"   >tailFreeSize</a>;
<a style="color: rgb(61, 87, 140);" name="l00070" rel="nofollow"   ></a>00070 
<a style="color: rgb(61, 87, 140);" name="l00071" rel="nofollow"   ></a>00071     <span style="color: rgb(128, 0, 0);"   >/*</span>
<a style="color: rgb(61, 87, 140);" name="l00072" rel="nofollow"   ></a>00072 <span style="color: rgb(128, 0, 0);"   >     * We store both number of pages and number of heap tuples that are in the</span>
<a style="color: rgb(61, 87, 140);" name="l00073" rel="nofollow"   ></a>00073 <span style="color: rgb(128, 0, 0);"   >     * pending list.</span>
<a style="color: rgb(61, 87, 140);" name="l00074" rel="nofollow"   ></a>00074 <span style="color: rgb(128, 0, 0);"   >     */</span>
<a style="color: rgb(61, 87, 140);" name="l00075" rel="nofollow"   ></a><a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html#a855b1f2d9220db7ef704892b16dd75ad"   >00075</a>     <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/block_8h.html#a0be1c1ab88d7f8120e2cd2e8ac2697a1"   >BlockNumber</a> <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html#a855b1f2d9220db7ef704892b16dd75ad"   >nPendingPages</a>;
<a style="color: rgb(61, 87, 140);" name="l00076" rel="nofollow"   ></a><a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html#a9eb44b4014cb887aeb72d63de80f4130"   >00076</a>     int64       <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html#a9eb44b4014cb887aeb72d63de80f4130"   >nPendingHeapTuples</a>;
<a style="color: rgb(61, 87, 140);" name="l00077" rel="nofollow"   ></a>00077 
<a style="color: rgb(61, 87, 140);" name="l00078" rel="nofollow"   ></a>00078     <span style="color: rgb(128, 0, 0);"   >/*</span>
<a style="color: rgb(61, 87, 140);" name="l00079" rel="nofollow"   ></a>00079 <span style="color: rgb(128, 0, 0);"   >     * Statistics for planner use (accurate as of last VACUUM)</span>
<a style="color: rgb(61, 87, 140);" name="l00080" rel="nofollow"   ></a>00080 <span style="color: rgb(128, 0, 0);"   >     */</span>
<a style="color: rgb(61, 87, 140);" name="l00081" rel="nofollow"   ></a><a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html#ab2243319e544114b85de4e6034a48ec7"   >00081</a>     <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/block_8h.html#a0be1c1ab88d7f8120e2cd2e8ac2697a1"   >BlockNumber</a> <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html#ab2243319e544114b85de4e6034a48ec7"   >nTotalPages</a>;
<a style="color: rgb(61, 87, 140);" name="l00082" rel="nofollow"   ></a><a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html#a6630072d0d350cc54018f909f3d4415e"   >00082</a>     <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/block_8h.html#a0be1c1ab88d7f8120e2cd2e8ac2697a1"   >BlockNumber</a> <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html#a6630072d0d350cc54018f909f3d4415e"   >nEntryPages</a>;
<a style="color: rgb(61, 87, 140);" name="l00083" rel="nofollow"   ></a><a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html#ade285ab846f5dacaea514694e717b644"   >00083</a>     <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/block_8h.html#a0be1c1ab88d7f8120e2cd2e8ac2697a1"   >BlockNumber</a> <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html#ade285ab846f5dacaea514694e717b644"   >nDataPages</a>;
<a style="color: rgb(61, 87, 140);" name="l00084" rel="nofollow"   ></a><a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html#a20f25095545213e77c2bccbc92b2dc2b"   >00084</a>     int64       <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html#a20f25095545213e77c2bccbc92b2dc2b"   >nEntries</a>;
<a style="color: rgb(61, 87, 140);" name="l00085" rel="nofollow"   ></a>00085 
<a style="color: rgb(61, 87, 140);" name="l00086" rel="nofollow"   ></a>00086     <span style="color: rgb(128, 0, 0);"   >/*</span>
<a style="color: rgb(61, 87, 140);" name="l00087" rel="nofollow"   ></a>00087 <span style="color: rgb(128, 0, 0);"   >     * GIN version number (ideally this should have been at the front, but too</span>
<a style="color: rgb(61, 87, 140);" name="l00088" rel="nofollow"   ></a>00088 <span style="color: rgb(128, 0, 0);"   >     * late now.  Don't move it!)</span>
<a style="color: rgb(61, 87, 140);" name="l00089" rel="nofollow"   ></a>00089 <span style="color: rgb(128, 0, 0);"   >     *</span>
<a style="color: rgb(61, 87, 140);" name="l00090" rel="nofollow"   ></a>00090 <span style="color: rgb(128, 0, 0);"   >     * Currently 1 (for indexes initialized in 9.1 or later)</span>
<a style="color: rgb(61, 87, 140);" name="l00091" rel="nofollow"   ></a>00091 <span style="color: rgb(128, 0, 0);"   >     *</span>
<a style="color: rgb(61, 87, 140);" name="l00092" rel="nofollow"   ></a>00092 <span style="color: rgb(128, 0, 0);"   >     * Version 0 (indexes initialized in 9.0 or before) is compatible but may</span>
<a style="color: rgb(61, 87, 140);" name="l00093" rel="nofollow"   ></a>00093 <span style="color: rgb(128, 0, 0);"   >     * be missing null entries, including both null keys and placeholders.</span>
<a style="color: rgb(61, 87, 140);" name="l00094" rel="nofollow"   ></a>00094 <span style="color: rgb(128, 0, 0);"   >     * Reject full-index-scan attempts on such indexes.</span>
<a style="color: rgb(61, 87, 140);" name="l00095" rel="nofollow"   ></a>00095 <span style="color: rgb(128, 0, 0);"   >     */</span>
<a style="color: rgb(61, 87, 140);" name="l00096" rel="nofollow"   ></a><a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html#a2f299eb1f0ace5f383910305ee32fdd8"   >00096</a>     <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/c_8h.html#a43d43196463bde49cb067f5c20ab8481"   >int32</a>       <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html#a2f299eb1f0ace5f383910305ee32fdd8"   >ginVersion</a>;
<a style="color: rgb(61, 87, 140);" name="l00097" rel="nofollow"   ></a>00097 } <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structGinMetaPageData.html"   >GinMetaPageData</a>;</pre></div><div>pending-list写函数见参考部分.</div><div>使用gdb可以跟踪到这个函数.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/gin-implementation.html#GIN-FAST-UPDATE"   >http://www.postgresql.org/docs/devel/static/gin-implementation.html#GIN-FAST-UPDATE</a></div><div>2.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201341615052957/"   >http://blog.163.com/digoal@126/blog/static/163877040201341615052957/</a></div><div>3.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/1638770402013416102141801/"   >http://blog.163.com/digoal@126/blog/static/1638770402013416102141801/</a></div><div>4.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/gin-tips.html"   >http://www.postgresql.org/docs/devel/static/gin-tips.html</a></div><div>5.&nbsp;src/backend/access/gin/README</div><div>6.&nbsp;src/include/access/gin_private.h</div><div>7.&nbsp;src/backend/access/gin/ginfast.c</div><div><pre style="font-family: monospace, fixed; font-size: 9pt; border: 1px solid rgb(196, 207, 229); background-color: rgb(251, 252, 253); padding: 4px 6px; margin: 4px 8px 4px 2px; overflow: auto; word-wrap: break-word; line-height: 15px;"   >00040 <span style="color: rgb(128, 0, 0);"   >/*</span>
<a style="color: rgb(61, 87, 140);" name="l00041" rel="nofollow"   ></a>00041 <span style="color: rgb(128, 0, 0);"   > * Build a pending-list page from the given array of tuples, and write it out.</span>
<a style="color: rgb(61, 87, 140);" name="l00042" rel="nofollow"   ></a>00042 <span style="color: rgb(128, 0, 0);"   > *</span>
<a style="color: rgb(61, 87, 140);" name="l00043" rel="nofollow"   ></a>00043 <span style="color: rgb(128, 0, 0);"   > * Returns amount of free space left on the page.</span>
<a style="color: rgb(61, 87, 140);" name="l00044" rel="nofollow"   ></a>00044 <span style="color: rgb(128, 0, 0);"   > */</span>
<a style="color: rgb(61, 87, 140);" name="l00045" rel="nofollow"   ></a>00045 <span style="color: rgb(0, 128, 0);"   >static</span> <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/c_8h.html#a43d43196463bde49cb067f5c20ab8481"   >int32</a>
<a style="color: rgb(61, 87, 140);" name="l00046" rel="nofollow"   ></a><a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/ginfast_8c.html#a3eac595362e5dec3c134881efcd1ae0a"   >00046</a> <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/ginfast_8c.html#a3eac595362e5dec3c134881efcd1ae0a"   >writeListPage</a>(<a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structRelationData.html"   >Relation</a> <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structindex.html"   >index</a>, <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/buf_8h.html#a13e825fcb656b677bc8fa431fd8582fe"   >Buffer</a> buffer,
<a style="color: rgb(61, 87, 140);" name="l00047" rel="nofollow"   ></a>00047               <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structIndexTupleData.html"   >IndexTuple</a> *tuples, <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/c_8h.html#a43d43196463bde49cb067f5c20ab8481"   >int32</a> ntuples, <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/block_8h.html#a0be1c1ab88d7f8120e2cd2e8ac2697a1"   >BlockNumber</a> rightlink)
<a style="color: rgb(61, 87, 140);" name="l00048" rel="nofollow"   ></a>00048 {
<a style="color: rgb(61, 87, 140);" name="l00049" rel="nofollow"   ></a>00049     <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/bufpage_8h.html#a2010e3258a7075b32ad5750134ab9c5c"   >Page</a>        page = <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/bufmgr_8h.html#afb570c83a17839dabeb75dba7ea8e1a5"   >BufferGetPage</a>(buffer);
<a style="color: rgb(61, 87, 140);" name="l00050" rel="nofollow"   ></a>00050     <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/c_8h.html#a43d43196463bde49cb067f5c20ab8481"   >int32</a>       <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/preproc-comment_8c.html#acb559820d9ca11295b4500f179ef6392"   >i</a>,
<a style="color: rgb(61, 87, 140);" name="l00051" rel="nofollow"   ></a>00051                 freesize,
<a style="color: rgb(61, 87, 140);" name="l00052" rel="nofollow"   ></a>00052                 size = 0;
<a style="color: rgb(61, 87, 140);" name="l00053" rel="nofollow"   ></a>00053     <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/off_8h.html#a983dfb92c804e2c79602580a4e2ef21d"   >OffsetNumber</a> l,
<a style="color: rgb(61, 87, 140);" name="l00054" rel="nofollow"   ></a>00054                 off;
<a style="color: rgb(61, 87, 140);" name="l00055" rel="nofollow"   ></a>00055     <span style="color: rgb(96, 64, 32);"   >char</span>       *workspace;
<a style="color: rgb(61, 87, 140);" name="l00056" rel="nofollow"   ></a>00056     <span style="color: rgb(96, 64, 32);"   >char</span>       *ptr;
<a style="color: rgb(61, 87, 140);" name="l00057" rel="nofollow"   ></a>00057 
<a style="color: rgb(61, 87, 140);" name="l00058" rel="nofollow"   ></a>00058     <span style="color: rgb(128, 0, 0);"   >/* workspace could be a local array; we use palloc for alignment */</span>
<a style="color: rgb(61, 87, 140);" name="l00059" rel="nofollow"   ></a>00059     workspace = <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/mcxt_8c.html#af25167ef63e16e1cbeb08b6f1f24e1d7"   >palloc</a>(BLCKSZ);
<a style="color: rgb(61, 87, 140);" name="l00060" rel="nofollow"   ></a>00060 
<a style="color: rgb(61, 87, 140);" name="l00061" rel="nofollow"   ></a>00061     <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/miscadmin_8h.html#a5a9c06b2eb9ecb91cb6eb5328a7a4ec9"   >START_CRIT_SECTION</a>();
<a style="color: rgb(61, 87, 140);" name="l00062" rel="nofollow"   ></a>00062 
<a style="color: rgb(61, 87, 140);" name="l00063" rel="nofollow"   ></a>00063     <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/ginutil_8c.html#a6041961dc4b5fda7e6079f5c792ef50a"   >GinInitBuffer</a>(buffer, <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/gin__private_8h.html#a97a555d2993e451659d2c27680444f99"   >GIN_LIST</a>);
<a style="color: rgb(61, 87, 140);" name="l00064" rel="nofollow"   ></a>00064 
<a style="color: rgb(61, 87, 140);" name="l00065" rel="nofollow"   ></a>00065     off = FirstOffsetNumber;
<a style="color: rgb(61, 87, 140);" name="l00066" rel="nofollow"   ></a>00066     ptr = workspace;
<a style="color: rgb(61, 87, 140);" name="l00067" rel="nofollow"   ></a>00067 
<a style="color: rgb(61, 87, 140);" name="l00068" rel="nofollow"   ></a>00068     <span style="color: rgb(224, 128, 0);"   >for</span> (i = 0; i &lt; ntuples; i++)
<a style="color: rgb(61, 87, 140);" name="l00069" rel="nofollow"   ></a>00069     {
<a style="color: rgb(61, 87, 140);" name="l00070" rel="nofollow"   ></a>00070         <span style="color: rgb(96, 64, 32);"   >int</span>         this_size = <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/itup_8h.html#a6c69461282e0b2be8b7ba9785f436b85"   >IndexTupleSize</a>(tuples[i]);
<a style="color: rgb(61, 87, 140);" name="l00071" rel="nofollow"   ></a>00071 
<a style="color: rgb(61, 87, 140);" name="l00072" rel="nofollow"   ></a>00072         memcpy(ptr, tuples[i], this_size);
<a style="color: rgb(61, 87, 140);" name="l00073" rel="nofollow"   ></a>00073         ptr += this_size;
<a style="color: rgb(61, 87, 140);" name="l00074" rel="nofollow"   ></a>00074         size += this_size;
<a style="color: rgb(61, 87, 140);" name="l00075" rel="nofollow"   ></a>00075 
<a style="color: rgb(61, 87, 140);" name="l00076" rel="nofollow"   ></a>00076         l = <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/bufpage_8c.html#a152fcb598f6524da0da17801e8a9087a"   >PageAddItem</a>(page, (<a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/item_8h.html#a6178ee370ac56a934f8835e7687ffa75"   >Item</a>) tuples[i], this_size, off, <span style="color: rgb(0, 128, 0);"   >false</span>, <span style="color: rgb(0, 128, 0);"   >false</span>);
<a style="color: rgb(61, 87, 140);" name="l00077" rel="nofollow"   ></a>00077 
<a style="color: rgb(61, 87, 140);" name="l00078" rel="nofollow"   ></a>00078         <span style="color: rgb(224, 128, 0);"   >if</span> (l == <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/off_8h.html#a47948eeaf74d4dbedc107f6ba4cbf339"   >InvalidOffsetNumber</a>)
<a style="color: rgb(61, 87, 140);" name="l00079" rel="nofollow"   ></a>00079             <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/elog_8h.html#a850290250a1449fc513da20ae2ce5ec5"   >elog</a>(<a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/elog_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5"   >ERROR</a>, <span style="color: rgb(0, 32, 128);"   >"failed to add item to index page in \"%s\""</span>,
<a style="color: rgb(61, 87, 140);" name="l00080" rel="nofollow"   ></a>00080                  <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/rel_8h.html#a5e9d450c92f70171110e22ffc678ed04"   >RelationGetRelationName</a>(index));
<a style="color: rgb(61, 87, 140);" name="l00081" rel="nofollow"   ></a>00081 
<a style="color: rgb(61, 87, 140);" name="l00082" rel="nofollow"   ></a>00082         off++;
<a style="color: rgb(61, 87, 140);" name="l00083" rel="nofollow"   ></a>00083     }
<a style="color: rgb(61, 87, 140);" name="l00084" rel="nofollow"   ></a>00084 
<a style="color: rgb(61, 87, 140);" name="l00085" rel="nofollow"   ></a>00085     <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/c_8h.html#a706ac5b1a53bd04067f81924b92cb9f6"   >Assert</a>(size &lt;= BLCKSZ);     <span style="color: rgb(128, 0, 0);"   >/* else we overran workspace */</span>
<a style="color: rgb(61, 87, 140);" name="l00086" rel="nofollow"   ></a>00086 
<a style="color: rgb(61, 87, 140);" name="l00087" rel="nofollow"   ></a>00087     <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/gin__private_8h.html#a379c8f4344010ef924d61d774215a7ee"   >GinPageGetOpaque</a>(page)-&gt;rightlink = rightlink;
<a style="color: rgb(61, 87, 140);" name="l00088" rel="nofollow"   ></a>00088 
<a style="color: rgb(61, 87, 140);" name="l00089" rel="nofollow"   ></a>00089     <span style="color: rgb(128, 0, 0);"   >/*</span>
<a style="color: rgb(61, 87, 140);" name="l00090" rel="nofollow"   ></a>00090 <span style="color: rgb(128, 0, 0);"   >     * tail page may contain only whole row(s) or final part of row placed on</span>
<a style="color: rgb(61, 87, 140);" name="l00091" rel="nofollow"   ></a>00091 <span style="color: rgb(128, 0, 0);"   >     * previous pages (a "row" here meaning all the index tuples generated for</span>
<a style="color: rgb(61, 87, 140);" name="l00092" rel="nofollow"   ></a>00092 <span style="color: rgb(128, 0, 0);"   >     * one heap tuple)</span>
<a style="color: rgb(61, 87, 140);" name="l00093" rel="nofollow"   ></a>00093 <span style="color: rgb(128, 0, 0);"   >     */</span>
<a style="color: rgb(61, 87, 140);" name="l00094" rel="nofollow"   ></a>00094     <span style="color: rgb(224, 128, 0);"   >if</span> (rightlink == <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/block_8h.html#a4c5ffb2838c103f9a3cfad64cd8f177f"   >InvalidBlockNumber</a>)
<a style="color: rgb(61, 87, 140);" name="l00095" rel="nofollow"   ></a>00095     {
<a style="color: rgb(61, 87, 140);" name="l00096" rel="nofollow"   ></a>00096         <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/gin__private_8h.html#af9e5d01ee969ca89dcc8c0144f625837"   >GinPageSetFullRow</a>(page);
<a style="color: rgb(61, 87, 140);" name="l00097" rel="nofollow"   ></a>00097         <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/gin__private_8h.html#a379c8f4344010ef924d61d774215a7ee"   >GinPageGetOpaque</a>(page)-&gt;maxoff = 1;
<a style="color: rgb(61, 87, 140);" name="l00098" rel="nofollow"   ></a>00098     }
<a style="color: rgb(61, 87, 140);" name="l00099" rel="nofollow"   ></a>00099     <span style="color: rgb(224, 128, 0);"   >else</span>
<a style="color: rgb(61, 87, 140);" name="l00100" rel="nofollow"   ></a>00100     {
<a style="color: rgb(61, 87, 140);" name="l00101" rel="nofollow"   ></a>00101         <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/gin__private_8h.html#a379c8f4344010ef924d61d774215a7ee"   >GinPageGetOpaque</a>(page)-&gt;maxoff = 0;
<a style="color: rgb(61, 87, 140);" name="l00102" rel="nofollow"   ></a>00102     }
<a style="color: rgb(61, 87, 140);" name="l00103" rel="nofollow"   ></a>00103 
<a style="color: rgb(61, 87, 140);" name="l00104" rel="nofollow"   ></a>00104     <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/bufmgr_8c.html#ab08d100d95c8e4d38e36241a56b53e69"   >MarkBufferDirty</a>(buffer);
<a style="color: rgb(61, 87, 140);" name="l00105" rel="nofollow"   ></a>00105 
<a style="color: rgb(61, 87, 140);" name="l00106" rel="nofollow"   ></a>00106     <span style="color: rgb(224, 128, 0);"   >if</span> (<a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/rel_8h.html#a6ec1e99df44ca322fa43c9cdd27ebc52"   >RelationNeedsWAL</a>(index))
<a style="color: rgb(61, 87, 140);" name="l00107" rel="nofollow"   ></a>00107     {
<a style="color: rgb(61, 87, 140);" name="l00108" rel="nofollow"   ></a>00108         <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structXLogRecData.html"   >XLogRecData</a> rdata[2];
<a style="color: rgb(61, 87, 140);" name="l00109" rel="nofollow"   ></a>00109         <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structginxlogInsertListPage.html"   >ginxlogInsertListPage</a> data;
<a style="color: rgb(61, 87, 140);" name="l00110" rel="nofollow"   ></a>00110         <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/xlogdefs_8h.html#a9f798cf05369dc78cd7688060d2c5993"   >XLogRecPtr</a>  recptr;
<a style="color: rgb(61, 87, 140);" name="l00111" rel="nofollow"   ></a>00111 
<a style="color: rgb(61, 87, 140);" name="l00112" rel="nofollow"   ></a>00112         data.<a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structginxlogInsertListPage.html#ae54f199fb971e96c51b0ad05daaf2511"   >node</a> = index-&gt;<a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structRelationData.html#aacaec92b0258484842aff8136336b604"   >rd_node</a>;
<a style="color: rgb(61, 87, 140);" name="l00113" rel="nofollow"   ></a>00113         data.<a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structginxlogInsertListPage.html#a25ff054c58fd434a01d402b24c2dca40"   >blkno</a> = <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/bufmgr_8c.html#a12ed528d88b55c558ed8d9c6eae22591"   >BufferGetBlockNumber</a>(buffer);
<a style="color: rgb(61, 87, 140);" name="l00114" rel="nofollow"   ></a>00114         data.<a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structginxlogInsertListPage.html#a2adc88f35dfab8e5eaa87219eddd92b4"   >rightlink</a> = rightlink;
<a style="color: rgb(61, 87, 140);" name="l00115" rel="nofollow"   ></a>00115         data.<a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structginxlogInsertListPage.html#acb69540587f0c6e8cc3f7870762ea713"   >ntuples</a> = ntuples;
<a style="color: rgb(61, 87, 140);" name="l00116" rel="nofollow"   ></a>00116 
<a style="color: rgb(61, 87, 140);" name="l00117" rel="nofollow"   ></a>00117         rdata[0].<a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structXLogRecData.html#afefc148a94cfaafc3495127f7709a961"   >buffer</a> = InvalidBuffer;
<a style="color: rgb(61, 87, 140);" name="l00118" rel="nofollow"   ></a>00118         rdata[0].<a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structXLogRecData.html#a46c8e0c57d48e19f197b5a0127c16e6e"   >data</a> = (<span style="color: rgb(96, 64, 32);"   >char</span> *) &amp;data;
<a style="color: rgb(61, 87, 140);" name="l00119" rel="nofollow"   ></a>00119         rdata[0].<a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structXLogRecData.html#a683205b1dcbe33b4c3765f494e2b7f64"   >len</a> = <span style="color: rgb(0, 128, 0);"   >sizeof</span>(<a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structginxlogInsertListPage.html"   >ginxlogInsertListPage</a>);
<a style="color: rgb(61, 87, 140);" name="l00120" rel="nofollow"   ></a>00120         rdata[0].<a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structXLogRecData.html#aa9625ed6464674481248c4d0e76ae705"   >next</a> = rdata + 1;
<a style="color: rgb(61, 87, 140);" name="l00121" rel="nofollow"   ></a>00121 
<a style="color: rgb(61, 87, 140);" name="l00122" rel="nofollow"   ></a>00122         rdata[1].<a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structXLogRecData.html#afefc148a94cfaafc3495127f7709a961"   >buffer</a> = buffer;
<a style="color: rgb(61, 87, 140);" name="l00123" rel="nofollow"   ></a>00123         rdata[1].<a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structXLogRecData.html#a99207e1269c0d77777c15d0ddb915efb"   >buffer_std</a> = <span style="color: rgb(0, 128, 0);"   >true</span>;
<a style="color: rgb(61, 87, 140);" name="l00124" rel="nofollow"   ></a>00124         rdata[1].<a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structXLogRecData.html#a46c8e0c57d48e19f197b5a0127c16e6e"   >data</a> = workspace;
<a style="color: rgb(61, 87, 140);" name="l00125" rel="nofollow"   ></a>00125         rdata[1].<a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structXLogRecData.html#a683205b1dcbe33b4c3765f494e2b7f64"   >len</a> = size;
<a style="color: rgb(61, 87, 140);" name="l00126" rel="nofollow"   ></a>00126         rdata[1].<a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/structXLogRecData.html#aa9625ed6464674481248c4d0e76ae705"   >next</a> = NULL;
<a style="color: rgb(61, 87, 140);" name="l00127" rel="nofollow"   ></a>00127 
<a style="color: rgb(61, 87, 140);" name="l00128" rel="nofollow"   ></a>00128         recptr = <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/xlog_8c.html#a858ef9f13042078dfcb977d2ddffe9e9"   >XLogInsert</a>(RM_GIN_ID, <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/gin__private_8h.html#ab697c4aab9b2da31177a87c5b46cca05"   >XLOG_GIN_INSERT_LISTPAGE</a>, rdata);
<a style="color: rgb(61, 87, 140);" name="l00129" rel="nofollow"   ></a>00129         <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/bufpage_8h.html#a9765e7a0f70b70bd667f1652c1e9739d"   >PageSetLSN</a>(page, recptr);
<a style="color: rgb(61, 87, 140);" name="l00130" rel="nofollow"   ></a>00130     }
<a style="color: rgb(61, 87, 140);" name="l00131" rel="nofollow"   ></a>00131 
<a style="color: rgb(61, 87, 140);" name="l00132" rel="nofollow"   ></a>00132     <span style="color: rgb(128, 0, 0);"   >/* get free space before releasing buffer */</span>
<a style="color: rgb(61, 87, 140);" name="l00133" rel="nofollow"   ></a>00133     freesize = <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/bufpage_8c.html#af4d8867a5c0a7931f02de8b843476998"   >PageGetExactFreeSpace</a>(page);
<a style="color: rgb(61, 87, 140);" name="l00134" rel="nofollow"   ></a>00134 
<a style="color: rgb(61, 87, 140);" name="l00135" rel="nofollow"   ></a>00135     <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/bufmgr_8c.html#aa3b15009fb5e6fa3440d2e8fc6eb6e3f"   >UnlockReleaseBuffer</a>(buffer);
<a style="color: rgb(61, 87, 140);" name="l00136" rel="nofollow"   ></a>00136 
<a style="color: rgb(61, 87, 140);" name="l00137" rel="nofollow"   ></a>00137     <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/miscadmin_8h.html#adc6ad2274da919cff449a752b2ea8a86"   >END_CRIT_SECTION</a>();
<a style="color: rgb(61, 87, 140);" name="l00138" rel="nofollow"   ></a>00138 
<a style="color: rgb(61, 87, 140);" name="l00139" rel="nofollow"   ></a>00139     <a style="color: rgb(70, 101, 162);" rel="nofollow" href="http://doxygen.postgresql.org/mcxt_8c.html#a4de9741ca04b2f01a82d3de16a1d6bf2"   >pfree</a>(workspace);
<a style="color: rgb(61, 87, 140);" name="l00140" rel="nofollow"   ></a>00140 
<a style="color: rgb(61, 87, 140);" name="l00141" rel="nofollow"   ></a>00141     <span style="color: rgb(224, 128, 0);"   >return</span> freesize;
<a style="color: rgb(61, 87, 140);" name="l00142" rel="nofollow"   ></a>00142 }</pre></div></div>
	</div>
</div>
</body>
</html>