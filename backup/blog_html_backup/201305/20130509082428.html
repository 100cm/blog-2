<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 Add wal_receiver_timeout allows more rapid detection of connection failure</h2>
	<h5 id="">2013-05-09 8:24:28&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013485393771/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Add wal_receiver_timeout parameter to control the WAL receiver timeout (Amit Kapila)</font></div><div><font size="2"   >This allows more rapid detection of connection failure.</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >Improve replication connection timeouts.</font></div><div><font size="2"   >Rename replication_timeout to wal_sender_timeout, and add a new setting</font></div><div><font size="2"   >called wal_receiver_timeout that does the same at the walreceiver side.</font></div><div><font size="2"   >There was previously no timeout in walreceiver, so if the network went down,</font></div><div><font size="2"   >for example, the walreceiver could take a long time to notice that the</font></div><div><font size="2"   >connection was lost. Now with the two settings, both sides of a replication</font></div><div><font size="2"   >connection will detect a broken connection similarly.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >It is no longer necessary to manually set wal_receiver_status_interval to</font></div><div><font size="2"   >a value smaller than the timeout. Both wal sender and receiver now</font></div><div><font size="2"   >automatically send a "ping" message if more than 1/2 of the configured</font></div><div><font size="2"   >timeout has elapsed, and it hasn't received any messages from the other end.</font></div><div><font size="2"   >Amit Kapila, heavily edited by me.</font></div></div><p></p></pre></div><div>PostgreSQL 9.3 新增standby端的心跳检测代码, 配置参数命名为wal_receiver_timeout.</div><div>同时将服务端的心跳检测参数更名为wal_sender_timeout, 这样在服务端和客户端都有了配置心跳检测的机制.</div><div><br></div><div>1. wal_receiver_timeout是一个standby参数, 配置在standby端, 用于检测对端的sender process的心跳的.</div><div>在receiver上没有数据传输的情况下会sleep 100毫秒, 并重置ping_sent, 那么接下来将检测心跳.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; 67 #define NAPTIME_PER_CYCLE 100 &nbsp; /* max sleep time between cycles (100ms) */</font></div><div><div><font size="2"   >&nbsp;322 &nbsp; &nbsp; &nbsp; &nbsp; /* Wait a while for data to arrive */</font></div><div><font size="2"   >&nbsp;323 &nbsp; &nbsp; &nbsp; &nbsp; if (walrcv_receive(NAPTIME_PER_CYCLE, &amp;type, &amp;buf, &amp;len))</font></div><div><font size="2"   >&nbsp;324 &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp;325 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Something was received from master, so reset timeout */</font></div><div><font size="2"   >&nbsp;326 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; last_recv_timestamp = GetCurrentTimestamp();</font></div><div><font size="2"   >&nbsp;327 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ping_sent = false;</font></div></div><p></p></pre></div><div>在没有数据传输的情况下会检测心跳.</div><div>最后一次接收到数据的时间和当前时间的差大于wal_receiver_timeout, 则报错.</div><div>检测超时的间隔最长为100毫秒. 就是前面提到的NAPTIME_PER_CYCLE.&nbsp;</div><div>当时间超过<span style="line-height: 22px;"   >wal_receiver_timeout的一半还没有收到任何数据, 就会通过</span><span style="line-height: 22px;"   >XLogWalRcvSendReply</span><span style="line-height: 22px;"   >发出ping包.&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;349 &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp;350 &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp;351 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp;352 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* We didn't receive anything new. If we haven't heard anything</font></div><div><font size="2"   >&nbsp;353 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* from the server for more than wal_receiver_timeout / 2,</font></div><div><font size="2"   >&nbsp;354 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* ping the server. Also, if it's been longer than</font></div><div><font size="2"   >&nbsp;355 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* wal_receiver_status_interval since the last update we sent,</font></div><div><font size="2"   >&nbsp;356 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* send a status update to the master anyway, to report any</font></div><div><font size="2"   >&nbsp;357 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* progress in applying WAL.</font></div><div><font size="2"   >&nbsp;358 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp;359 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bool requestReply = false;</font></div><div><font size="2"   >&nbsp;360&nbsp;</font></div><div><font size="2"   >&nbsp;361 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp;362 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Check if time since last receive from standby has reached the</font></div><div><font size="2"   >&nbsp;363 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* configured limit.</font></div><div><font size="2"   >&nbsp;364 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp;365 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (wal_receiver_timeout &gt; 0)</font></div><div><font size="2"   >&nbsp;366 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp;367 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TimestampTz now = GetCurrentTimestamp();</font></div><div><font size="2"   >&nbsp;368 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TimestampTz timeout;</font></div><div><font size="2"   >&nbsp;369&nbsp;</font></div><div><font size="2"   >&nbsp;370 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; timeout = TimestampTzPlusMilliseconds(last_recv_timestamp,</font></div><div><font size="2"   >&nbsp;371 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wal_receiver_timeout);</font></div><div><font size="2"   >&nbsp;372&nbsp;</font></div><div><font size="2"   >&nbsp;373 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (now &gt;= timeout)</font></div><div><font size="2"   >&nbsp;374 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp;375 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errmsg("terminating walreceiver due to timeout")));</font></div><div><font size="2"   >&nbsp;376&nbsp;</font></div><div><font size="2"   >&nbsp;377 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp;378 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* We didn't receive anything new, for half of receiver</font></div><div><font size="2"   >&nbsp;379 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* replication timeout. Ping the server.</font></div><div><font size="2"   >&nbsp;380 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp;381 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!ping_sent)</font></div><div><font size="2"   >&nbsp;382 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp;383 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; timeout = TimestampTzPlusMilliseconds(last_recv_timestamp,</font></div><div><font size="2"   >&nbsp;384 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (wal_receiver_timeout/2));</font></div><div><font size="2"   >&nbsp;385 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (now &gt;= timeout)</font></div><div><font size="2"   >&nbsp;386 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp;387 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; requestReply = true;</font></div><div><font size="2"   >&nbsp;388 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ping_sent = true;</font></div><div><font size="2"   >&nbsp;389 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp;390 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp;391 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div><div>ping 包程序 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;672 /*</font></div><div><font size="2"   >&nbsp;673 &nbsp;* Send reply message to primary, indicating our current XLOG positions, oldest</font></div><div><font size="2"   >&nbsp;674 &nbsp;* xmin and the current time.</font></div><div><font size="2"   >&nbsp;675 &nbsp;*</font></div><div><font size="2"   >&nbsp;676 &nbsp;* If 'force' is not set, the message is only sent if enough time has</font></div><div><font size="2"   >&nbsp;677 &nbsp;* passed since last status update to reach wal_receiver_status_internal.</font></div><div><font size="2"   >&nbsp;678 &nbsp;* If wal_receiver_status_interval is disabled altogether and 'force' is</font></div><div><font size="2"   >&nbsp;679 &nbsp;* false, this is a no-op.</font></div><div><font size="2"   >&nbsp;680 &nbsp;*</font></div><div><font size="2"   >&nbsp;681 &nbsp;* If 'requestReply' is true, requests the server to reply immediately upon</font></div><div><font size="2"   >&nbsp;682 &nbsp;* receiving this message. This is used for heartbearts, when approaching</font></div><div><font size="2"   >&nbsp;683 &nbsp;* wal_receiver_timeout.</font></div><div><font size="2"   >&nbsp;684 &nbsp;*/</font></div><div><font size="2"   >&nbsp;685 static void</font></div><div><font size="2"   >&nbsp;686 XLogWalRcvSendReply(bool force, bool requestReply)</font></div><div><font size="2"   >&nbsp;687 {</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >2. wal_sender_timeout是一个master参数, 配置在master端, 用于检测对端的receiver process的心跳的.</span></div><div><span style="line-height: 22px;"   >在服务端和客户端的XLOG传输完了或者没有数据传输的时候会主动检测心跳. 检测的间隔为</span>sleeptime = 1 + (wal_sender_timeout / 10).</div><div><br></div><div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=6f60fdd7015b032bf49273c99f80913d57eac284"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=6f60fdd7015b032bf49273c99f80913d57eac284</a></div><div>2.&nbsp;<span style="line-height: 22px;"   >wal_receiver_timeout (integer)</span></div><div><pre class="prettyprint"   ><p><font size="2"   >Terminate replication connections that are inactive longer than the specified number of milliseconds. This is useful for the receiving standby server to detect a primary node crash or network outage. A value of zero disables the timeout mechanism. This parameter can only be set in the postgresql.conf file or on the server command line. The default value is 60 seconds.</font></p></pre></div></div>3.&nbsp;<span style="line-height: 22px;"   >wal_sender_timeout (integer)</span><div><pre class="prettyprint"   ><p><font size="2"   >Terminate replication connections that are inactive longer than the specified number of milliseconds. This is useful for the sending server to detect a standby crash or network outage. A value of zero disables the timeout mechanism. This parameter can only be set in the postgresql.conf file or on the server command line. The default value is 60 seconds.</font></p></pre></div><div>4.&nbsp;src/backend/replication/walreceiver.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;361 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp;362 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Check if time since last receive from standby has reached the</font></div><div><font size="2"   >&nbsp;363 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* configured limit.</font></div><div><font size="2"   >&nbsp;364 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp;365 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (wal_receiver_timeout &gt; 0)</font></div><div><font size="2"   >&nbsp;366 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp;367 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TimestampTz now = GetCurrentTimestamp();</font></div><div><font size="2"   >&nbsp;368 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TimestampTz timeout;</font></div><div><font size="2"   >&nbsp;369&nbsp;</font></div><div><font size="2"   >&nbsp;370 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; timeout = TimestampTzPlusMilliseconds(last_recv_timestamp,</font></div><div><font size="2"   >&nbsp;371 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wal_receiver_timeout);</font></div><div><font size="2"   >&nbsp;372&nbsp;</font></div><div><font size="2"   >&nbsp;373 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (now &gt;= timeout)</font></div><div><font size="2"   >&nbsp;374 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp;375 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errmsg("terminating walreceiver due to timeout")));</font></div><div><font size="2"   >&nbsp;376&nbsp;</font></div><div><font size="2"   >&nbsp;377 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp;378 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* We didn't receive anything new, for half of receiver</font></div><div><font size="2"   >&nbsp;379 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* replication timeout. Ping the server.</font></div><div><font size="2"   >&nbsp;380 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp;381 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!ping_sent)</font></div><div><font size="2"   >&nbsp;382 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp;383 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; timeout = TimestampTzPlusMilliseconds(last_recv_timestamp,</font></div><div><font size="2"   >&nbsp;384 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (wal_receiver_timeout/2));</font></div><div><font size="2"   >&nbsp;385 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (now &gt;= timeout)</font></div><div><font size="2"   >&nbsp;386 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp;387 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; requestReply = true;</font></div><div><font size="2"   >&nbsp;388 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ping_sent = true;</font></div><div><font size="2"   >&nbsp;389 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp;390 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp;391 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div><div>5.&nbsp;src/backend/replication/walsender.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;735 &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp;736 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* We don't block if not caught up, unless there is unsent data</font></div><div><font size="2"   >&nbsp;737 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* pending in which case we'd better block until the socket is</font></div><div><font size="2"   >&nbsp;738 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* write-ready. &nbsp;This test is only needed for the case where XLogSend</font></div><div><font size="2"   >&nbsp;739 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* loaded a subset of the available data but then pq_flush_if_writable</font></div><div><font size="2"   >&nbsp;740 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* flushed it all --- we should immediately try to send more.</font></div><div><font size="2"   >&nbsp;741 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp;742 &nbsp; &nbsp; &nbsp; &nbsp; if (caughtup || pq_is_send_pending())</font></div><div><font size="2"   >&nbsp;743 &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp;744 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TimestampTz timeout = 0;</font></div><div><font size="2"   >&nbsp;745 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; long &nbsp; &nbsp; &nbsp; &nbsp;sleeptime = 10000; &nbsp; &nbsp; &nbsp;/* 10 s */</font></div><div><font size="2"   >&nbsp;746 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; wakeEvents;</font></div><div><font size="2"   >&nbsp;747&nbsp;</font></div><div><font size="2"   >&nbsp;748 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wakeEvents = WL_LATCH_SET | WL_POSTMASTER_DEATH |</font></div><div><font size="2"   >&nbsp;749 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WL_SOCKET_READABLE | WL_TIMEOUT;</font></div><div><font size="2"   >&nbsp;750&nbsp;</font></div><div><font size="2"   >&nbsp;751 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (pq_is_send_pending())</font></div><div><font size="2"   >&nbsp;752 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wakeEvents |= WL_SOCKET_WRITEABLE;</font></div><div><font size="2"   >&nbsp;753 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (wal_sender_timeout &gt; 0 &amp;&amp; !ping_sent)</font></div><div><font size="2"   >&nbsp;754 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp;755 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp;756 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* If half of wal_sender_timeout has lapsed without receiving</font></div><div><font size="2"   >&nbsp;757 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* any reply from standby, send a keep-alive message to standby</font></div><div><font size="2"   >&nbsp;758 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* requesting an immediate reply.</font></div><div><font size="2"   >&nbsp;759 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp;760 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; timeout = TimestampTzPlusMilliseconds(last_reply_timestamp,</font></div><div><font size="2"   >&nbsp;761 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wal_sender_timeout / 2);</font></div><div><font size="2"   >&nbsp;762 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (GetCurrentTimestamp() &gt;= timeout)</font></div><div><font size="2"   >&nbsp;763 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp;764 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WalSndKeepalive(true);</font></div><div><font size="2"   >&nbsp;765 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ping_sent = true;</font></div><div><font size="2"   >&nbsp;766 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Try to flush pending output to the client */</font></div><div><font size="2"   >&nbsp;767 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (pq_flush_if_writable() != 0)</font></div><div><font size="2"   >&nbsp;768 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >&nbsp;769 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp;770 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp;771&nbsp;</font></div><div><font size="2"   >&nbsp;772 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Determine time until replication timeout */</font></div><div><font size="2"   >&nbsp;773 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (wal_sender_timeout &gt; 0)</font></div><div><font size="2"   >&nbsp;774 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp;775 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; timeout = TimestampTzPlusMilliseconds(last_reply_timestamp,</font></div><div><font size="2"   >&nbsp;776 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wal_sender_timeout);</font></div><div><font size="2"   >&nbsp;777 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sleeptime = 1 + (wal_sender_timeout / 10);</font></div><div><font size="2"   >&nbsp;778 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp;779&nbsp;</font></div><div><font size="2"   >&nbsp;780 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Sleep until something happens or we time out */</font></div><div><font size="2"   >&nbsp;781 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ImmediateInterruptOK = true;</font></div><div><font size="2"   >&nbsp;782 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CHECK_FOR_INTERRUPTS();</font></div><div><font size="2"   >&nbsp;783 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WaitLatchOrSocket(&amp;MyWalSnd-&gt;latch, wakeEvents,</font></div><div><font size="2"   >&nbsp;784 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MyProcPort-&gt;sock, sleeptime);</font></div><div><font size="2"   >&nbsp;785 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ImmediateInterruptOK = false;</font></div><div><font size="2"   >&nbsp;786&nbsp;</font></div><div><font size="2"   >&nbsp;787 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp;788 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Check for replication timeout. &nbsp;Note we ignore the corner case</font></div><div><font size="2"   >&nbsp;789 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* possibility that the client replied just as we reached the</font></div><div><font size="2"   >&nbsp;790 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* timeout ... he's supposed to reply *before* that.</font></div><div><font size="2"   >&nbsp;791 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp;792 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (wal_sender_timeout &gt; 0 &amp;&amp; GetCurrentTimestamp() &gt;= timeout)</font></div><div><font size="2"   >&nbsp;793 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp;794 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp;795 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Since typically expiration of replication timeout means</font></div><div><font size="2"   >&nbsp;796 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* communication problem, we don't send the error message to</font></div><div><font size="2"   >&nbsp;797 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* the standby.</font></div><div><font size="2"   >&nbsp;798 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp;799 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(COMMERROR,</font></div><div><font size="2"   >&nbsp;800 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errmsg("terminating walsender process due to replication timeout")));</font></div><div><font size="2"   >&nbsp;801 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >&nbsp;802 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp;803 &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp;804 &nbsp; &nbsp; }</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>