<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 Have pg_basebackup --write-recovery-conf output a minimal recovery.conf</h2>
	<h5 id="">2013-05-08 17:34:46&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020134852916966/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Have pg_basebackup --write-recovery-conf output a minimal recovery.conf (Zoltán B?sz?rményi, Magnus Hagander)</font></div><div><font size="2"   >This simplifies setting up a standby server.</font></div><p></p></pre></div><div>个人感觉没有太大的意义.</div><div><br></div><div>[测试]</div><div>-- 命令行帮助</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_basebackup --help</font></div><div><font size="2"   >pg_basebackup takes a base backup of a running PostgreSQL server.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Usage:</font></div><div><font size="2"   >&nbsp; pg_basebackup [OPTION]...</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Options controlling the output:</font></div><div><font size="2"   >&nbsp; -D, --pgdata=DIRECTORY receive base backup into directory</font></div><div><font size="2"   >&nbsp; -F, --format=p|t &nbsp; &nbsp; &nbsp; output format (plain (default), tar)</font></div><div><font size="2"   >&nbsp; -R, --write-recovery-conf</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;write recovery.conf after backup</font></div><div><font size="2"   >&nbsp; -x, --xlog &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; include required WAL files in backup (fetch mode)</font></div><div><font size="2"   >&nbsp; -X, --xlog-method=fetch|stream</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;include required WAL files with specified method</font></div><div><font size="2"   >&nbsp; -z, --gzip &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; compress tar output</font></div><div><font size="2"   >&nbsp; -Z, --compress=0-9 &nbsp; &nbsp; compress tar output with given compression level</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >General options:</font></div><div><font size="2"   >&nbsp; -c, --checkpoint=fast|spread</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;set fast or spread checkpointing</font></div><div><font size="2"   >&nbsp; -l, --label=LABEL &nbsp; &nbsp; &nbsp;set backup label</font></div><div><font size="2"   >&nbsp; -P, --progress &nbsp; &nbsp; &nbsp; &nbsp; show progress information</font></div><div><font size="2"   >&nbsp; -v, --verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;output verbose messages</font></div><div><font size="2"   >&nbsp; -V, --version &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;output version information, then exit</font></div><div><font size="2"   >&nbsp; -?, --help &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; show this help, then exit</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Connection options:</font></div><div><font size="2"   >&nbsp; -d, --dbname=CONNSTR &nbsp; connection string</font></div><div><font size="2"   >&nbsp; -h, --host=HOSTNAME &nbsp; &nbsp;database server host or socket directory</font></div><div><font size="2"   >&nbsp; -p, --port=PORT &nbsp; &nbsp; &nbsp; &nbsp;database server port number</font></div><div><font size="2"   >&nbsp; -s, --status-interval=INTERVAL</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;time between status packets sent to server (in seconds)</font></div><div><font size="2"   >&nbsp; -U, --username=NAME &nbsp; &nbsp;connect as specified database user</font></div><div><font size="2"   >&nbsp; -w, --no-password &nbsp; &nbsp; &nbsp;never prompt for password</font></div><div><font size="2"   >&nbsp; -W, --password &nbsp; &nbsp; &nbsp; &nbsp; force password prompt (should happen automatically)</font></div><p></p></pre></div><div>-- 使用pg_basebackup并使用-R选项</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_basebackup -D /pgdata/digoal/1921/data03/test -F p --write-recovery-conf&nbsp;</font></div><div><font size="2"   >WARNING: &nbsp;skipping special file "./.s.PGSQL.1999"</font></div><div><font size="2"   >NOTICE: &nbsp;pg_stop_backup complete, all required WAL segments have been archived</font></div></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd /pgdata/digoal/1921/data03/test/</font></div><p></p></pre></div></div><div>-- 自动生成的recovery.conf文件.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cat recovery.conf</font></div><div><font size="2"   >standby_mode = 'on'</font></div><div><font size="2"   >primary_conninfo = 'user=''postgres'' port=''1999'' sslmode=''prefer'' sslcompression=''1'' '</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;src/bin/pg_basebackup/pg_basebackup.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >00071 /* Contents of recovery.conf to be generated */</font></div><div><font size="2"   >00072 static PQExpBuffer recoveryconfcontents = NULL;</font></div></div><div><font size="2"   >...</font></div><div><div><font size="2"   >00680 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (basetablespace &amp;&amp; writerecoveryconf)</font></div><div><font size="2"   >00681 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >00682 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; &nbsp;header[512];</font></div><div><font size="2"   >00683 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; padding;</font></div><div><font size="2"   >00684&nbsp;</font></div><div><font size="2"   >00685 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tarCreateHeader(header, "recovery.conf", NULL,</font></div><div><font size="2"   >00686 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; recoveryconfcontents-&gt;len,</font></div><div><font size="2"   >00687 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0600, 04000, 02000,</font></div><div><font size="2"   >00688 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; time(NULL));</font></div><div><font size="2"   >00689&nbsp;</font></div><div><font size="2"   >00690 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; padding = ((recoveryconfcontents-&gt;len + 511) &amp; ~511) - recoveryconfcontents-&gt;len;</font></div><div><font size="2"   >00691&nbsp;</font></div><div><font size="2"   >00692 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WRITE_TAR_DATA(header, sizeof(header));</font></div><div><font size="2"   >00693 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WRITE_TAR_DATA(recoveryconfcontents-&gt;data, recoveryconfcontents-&gt;len);</font></div><div><font size="2"   >00694 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (padding)</font></div><div><font size="2"   >00695 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WRITE_TAR_DATA(zerobuf, padding);</font></div><div><font size="2"   >00696 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div></div><div><font size="2"   >...</font></div><div><span style="line-height: 22px;"   ><font size="2"   >01190 /*</font></span></div><div><div><font size="2"   >01191 &nbsp;* Write a recovery.conf file into the directory specified in basedir,</font></div><div><font size="2"   >01192 &nbsp;* with the contents already collected in memory.</font></div><div><font size="2"   >01193 &nbsp;*/</font></div><div><font size="2"   >01194 static void</font></div><div><font size="2"   >01195 WriteRecoveryConf(void)</font></div><div><font size="2"   >01196 {</font></div><div><font size="2"   >01197 &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; &nbsp;filename[MAXPGPATH];</font></div><div><font size="2"   >01198 &nbsp; &nbsp; FILE &nbsp; &nbsp; &nbsp; *cf;</font></div><div><font size="2"   >01199&nbsp;</font></div><div><font size="2"   >01200 &nbsp; &nbsp; sprintf(filename, "%s/recovery.conf", basedir);</font></div><div><font size="2"   >01201&nbsp;</font></div><div><font size="2"   >01202 &nbsp; &nbsp; cf = fopen(filename, "w");</font></div><div><font size="2"   >01203 &nbsp; &nbsp; if (cf == NULL)</font></div><div><font size="2"   >01204 &nbsp; &nbsp; {</font></div><div><font size="2"   >01205 &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr, _("%s: could not create file \"%s\": %s\n"), progname, filename, strerror(errno));</font></div><div><font size="2"   >01206 &nbsp; &nbsp; &nbsp; &nbsp; disconnect_and_exit(1);</font></div><div><font size="2"   >01207 &nbsp; &nbsp; }</font></div><div><font size="2"   >01208&nbsp;</font></div><div><font size="2"   >01209 &nbsp; &nbsp; if (fwrite(recoveryconfcontents-&gt;data, recoveryconfcontents-&gt;len, 1, cf) != 1)</font></div><div><font size="2"   >01210 &nbsp; &nbsp; {</font></div><div><font size="2"   >01211 &nbsp; &nbsp; &nbsp; &nbsp; fprintf(stderr,</font></div><div><font size="2"   >01212 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _("%s: could not write to file \"%s\": %s\n"),</font></div><div><font size="2"   >01213 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; progname, filename, strerror(errno));</font></div><div><font size="2"   >01214 &nbsp; &nbsp; &nbsp; &nbsp; disconnect_and_exit(1);</font></div><div><font size="2"   >01215 &nbsp; &nbsp; }</font></div><div><font size="2"   >01216&nbsp;</font></div><div><font size="2"   >01217 &nbsp; &nbsp; fclose(cf);</font></div><div><font size="2"   >01218 }</font></div></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>