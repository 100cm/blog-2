<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 Improve performance of NUMERIC calculations?</h2>
	<h5 id="">2013-05-07 11:27:25&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020134792458729/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Speed up operations on numeric, mostly by avoiding palloc() overhead.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >In many functions, a NumericVar was initialized from an input Numeric, to be</font></div><div><font size="2"   >passed as input to a calculation function. When the NumericVar is not</font></div><div><font size="2"   >modified, the digits array of the NumericVar can point directly to the digits</font></div><div><font size="2"   >array in the original Numeric, and we can avoid a palloc() and memcpy(). Add</font></div><div><font size="2"   >init_var_from_num() function to initialize a var like that.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Remove dscale argument from get_str_from_var(), as all the callers just</font></div><div><font size="2"   >passed the dscale of the variable. That means that the rounding it used to</font></div><div><font size="2"   >do was not actually necessary, and get_str_from_var() no longer scribbles on</font></div><div><font size="2"   >its input. That makes it safer in general, and allows us to use the new</font></div><div><font size="2"   >init_var_from_num() function in e.g numeric_out().</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Also modified numericvar_to_int8() to no scribble on its input either. It</font></div><div><font size="2"   >creates a temporary copy to avoid that. To compensate, the callers no longer</font></div><div><font size="2"   >need to create a temporary copy, so the net # of pallocs is the same, but this</font></div><div><font size="2"   >is nicer.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >In the passing, use a constant for the number 10 in get_str_from_var_sci(),</font></div><div><font size="2"   >when calculating 10^exponent. Saves a palloc() and some cycles to convert</font></div><div><font size="2"   >integer 10 to numeric.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Original patch by Kyotaro HORIGUCHI, with further changes by me. Reviewed</font></div><div><font size="2"   >by Pavel Stehule.</font></div><p></p></pre></div><div>涉及的几个函数参考本文末尾部分, 针对这几个函数的referenced by进行测试.</div><div>从gdb跟踪来看, 确实调用了更新过的函数, 但是未发现有性能提升.</div><div><br></div><div>[测试1]</div><div><span style="line-height: 22px;"   >-- pgbench脚本</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   > vi sel.sql <br>\setrandom i 1 1000000<br>select numeric_add(:i, :i);</span></font></div><p></p></pre></div><div>-- PostgreSQL 9.2 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >pg92@db-172-16-3-33-&gt; pgbench -M prepared -f ./sel.sql -n -r -h $PGDATA -U postgres -c 16 -j 4 -T 60 postgres<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 16<br>number of threads: 4<br>duration: 60 s<br>number of transactions actually processed: 8514278<br>tps = 141892.123178 (including connections establishing)<br>tps = 141950.180415 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        0.001242        \setrandom i 1 1000000<br>        0.110091        select numeric_add(:i, :i);</span></font></div><p></p></pre></div><div>-- PostgreSQL 9.3 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -f ./sel.sql -n -r -h $PGDATA -U postgres -c 16 -j 4 -T 60 postgres<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 16<br>number of threads: 4<br>duration: 60 s<br>number of transactions actually processed: 8558332<br>tps = 142629.774019 (including connections establishing)<br>tps = 142686.376474 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        0.001244        \setrandom i 1 1000000<br>        0.109517        select numeric_add(:i, :i);</span></font></div><p></p></pre></div><div>-- gdb 9.3</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >(gdb) b init_var_from_num</font></div><div><font size="2"   >Breakpoint 1 at 0x68ba50: file numeric.c, line 3400.</font></div><div><font size="2"   >(gdb) c</font></div><div><font size="2"   >Continuing.</font></div><div><font size="2"   >Breakpoint 1, init_var_from_num (num=0xcc3bc60, dest=0x7fffab7c1350) at numeric.c:3400</font></div><div><font size="2"   >3400 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dest-&gt;ndigits = NUMERIC_NDIGITS(num);</font></div><p></p></pre></div><div><br></div><div>[测试2]</div><div><span style="line-height: 22px;"   >-- pgbench脚本</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;vi sel.sql</font></div><div><font size="2"   >select numeric_out(1.1);</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >-- PostgreSQL 9.2 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-33-&gt; pgbench -M prepared -f ./sel.sql -n -r -h $PGDATA -U postgres -c 16 -j 4 -T 60 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 12048102</font></div><div><font size="2"   >tps = 200786.671118 (including connections establishing)</font></div><div><font size="2"   >tps = 200865.128186 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.078412 &nbsp; &nbsp; &nbsp; &nbsp;select numeric_out(1.1);</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >-- PostgreSQL 9.3 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -f ./sel.sql -n -r -h $PGDATA -U postgres -c 16 -j 4 -T 60 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 11456116</font></div><div><font size="2"   >tps = 190919.445809 (including connections establishing)</font></div><div><font size="2"   >tps = 190993.391526 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.082437 &nbsp; &nbsp; &nbsp; &nbsp;select numeric_out(1.1);</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >-- gdb 9.3</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >(gdb) delete b 1</font></div><div><font size="2"   >(gdb) b get_str_from_var</font></div><div><font size="2"   >Breakpoint 2 at 0x68cf90: file numeric.c, line 3440.</font></div><div><font size="2"   >(gdb) c</font></div><div><font size="2"   >Continuing.</font></div><div><font size="2"   >Breakpoint 2, get_str_from_var (var=0x7fffab7c1350) at numeric.c:3440</font></div><div><font size="2"   >3440 &nbsp; &nbsp;{</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >[测试3]</span></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >-- pgbench脚本</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >&nbsp;vi sel.sql</font></span></div><div style="line-height: 22px;"   ><font size="2"   >select numeric_power(1.111,2.222);</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >-- PostgreSQL 9.2 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-33-&gt; pgbench -M prepared -f ./sel.sql -n -r -h $PGDATA -U postgres -c 16 -j 4 -T 60 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 11958466</font></div><div><font size="2"   >tps = 199291.597475 (including connections establishing)</font></div><div><font size="2"   >tps = 199365.428964 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.079041 &nbsp; &nbsp; &nbsp; &nbsp;select numeric_power(1.111,2.222);</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >-- PostgreSQL 9.3 :&nbsp;</span></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -f ./sel.sql -n -r -h $PGDATA -U postgres -c 16 -j 4 -T 60 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 11796137</font></div><div><font size="2"   >tps = 196587.712907 (including connections establishing)</font></div><div><font size="2"   >tps = 196669.655802 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.080078 &nbsp; &nbsp; &nbsp; &nbsp;select numeric_power(1.111,2.222);</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >[测试4]</span></div><div><span style="line-height: 22px;"   >-- pgbench脚本</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >&nbsp;vi sel.sql</font></span></div><div><font size="2"   >select to_char(1.1234,'999999.999999');</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >-- PostgreSQL 9.2 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-33-&gt; pgbench -M prepared -f ./sel.sql -n -r -h $PGDATA -U postgres -c 16 -j 4 -T 60 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 11041538</font></div><div><font size="2"   >tps = 184010.780596 (including connections establishing)</font></div><div><font size="2"   >tps = 184073.425697 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.085712 &nbsp; &nbsp; &nbsp; &nbsp;select to_char(1.1234,'999999.999999');</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >-- PostgreSQL 9.3 :&nbsp;</span></div><div><span style="line-height: 22px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -f ./sel.sql -n -r -h $PGDATA -U postgres -c 16 -j 4 -T 60 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 10818389</font></div><div><font size="2"   >tps = 180290.386407 (including connections establishing)</font></div><div><font size="2"   >tps = 180363.515780 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.087429 &nbsp; &nbsp; &nbsp; &nbsp;select to_char(1.1234,'999999.999999');</font></div><p></p></pre></div><div><br></div></span></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=5cb0e335976befdcedd069c59dd3858fb3e649b3"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=5cb0e335976befdcedd069c59dd3858fb3e649b3</a></div><div>2.&nbsp;src/backend/utils/adt/numeric.c</div><div>3.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >static void init_var_from_num<span>	</span>(<span>	</span>Numeric <span>	</span>num,</font></div><div><font size="2"   >NumericVar * <span>	</span>dest<span>	</span>&nbsp;</font></div><div><font size="2"   >)<span>			</span> [static]</font></div><div><font size="2"   >Definition at line 3398 of file numeric.c.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >References NumericVar::buf, NumericVar::digits, NumericVar::dscale, NumericVar::ndigits, NUMERIC_DIGITS, NUMERIC_DSCALE, NUMERIC_NDIGITS, NUMERIC_SIGN, NUMERIC_WEIGHT, NumericVar::sign, and NumericVar::weight.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Referenced by compute_bucket(), numeric_add(), numeric_ceil(), numeric_div(), numeric_div_trunc(), numeric_exp(), numeric_floor(), numeric_inc(), numeric_int2(), numeric_int4(), numeric_int8(), numeric_ln(), numeric_log(), numeric_mod(), numeric_mul(), numeric_out(), numeric_out_sci(), numeric_power(), numeric_send(), numeric_sqrt(), numeric_stddev_internal(), and numeric_sub().</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; dest-&gt;ndigits = NUMERIC_NDIGITS(num);</font></div><div><font size="2"   >&nbsp; &nbsp; dest-&gt;weight = NUMERIC_WEIGHT(num);</font></div><div><font size="2"   >&nbsp; &nbsp; dest-&gt;sign = NUMERIC_SIGN(num);</font></div><div><font size="2"   >&nbsp; &nbsp; dest-&gt;dscale = NUMERIC_DSCALE(num);</font></div><div><font size="2"   >&nbsp; &nbsp; dest-&gt;digits = NUMERIC_DIGITS(num);</font></div><div><font size="2"   >&nbsp; &nbsp; dest-&gt;buf = NULL; &nbsp; /* digits array is not palloc'd */</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>4.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >static char * get_str_from_var<span>	</span>(<span>	</span>NumericVar * <span>	</span>var<span>	</span> ) <span>	</span> [static]</font></div><div><font size="2"   >Definition at line 3439 of file numeric.c.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >References DEC_DIGITS, NumericVar::digits, NumericVar::dscale, NumericVar::ndigits, NUMERIC_NEG, palloc(), NumericVar::sign, and NumericVar::weight.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Referenced by get_str_from_var_sci(), numeric_out(), and numericvar_to_double_no_overflow().</font></div><p></p></pre></div><div>5.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >static bool numericvar_to_int8<span>	</span>(<span>	</span>NumericVar * <span>	</span>var,</font></div><div><font size="2"   >int64 * <span>	</span>result<span>	</span>&nbsp;</font></div><div><font size="2"   >)<span>			</span> [static]</font></div><div><font size="2"   >Definition at line 3840 of file numeric.c.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >References Assert, NumericVar::digits, free_var(), init_var, NBASE, NumericVar::ndigits, round_var(), set_var_from_var(), NumericVar::sign, strip_var(), val, and NumericVar::weight.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Referenced by numeric_int2(), numeric_int8(), numericvar_to_int4(), and power_var().</font></div><p></p></pre></div><div>6.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >static char * get_str_from_var_sci<span>	</span>(<span>	</span>NumericVar * <span>	</span>var,</font></div><div><font size="2"   >int <span>	</span>rscale<span>	</span>&nbsp;</font></div><div><font size="2"   >)<span>			</span> [static]</font></div><div><font size="2"   >Definition at line 3592 of file numeric.c.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >References DEC_DIGITS, NumericVar::digits, div_var(), free_var(), get_str_from_var(), init_var, NumericVar::ndigits, palloc(), pfree(), power_var_int(), snprintf(), and NumericVar::weight.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Referenced by numeric_out_sci().</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>