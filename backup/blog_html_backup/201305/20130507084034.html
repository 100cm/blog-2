<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 Add SP-GiST support for range data types</h2>
	<h5 id="">2013-05-07 8:40:34&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020134642936176/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>Add SP-GiST support for range data types (Alexander Korotkov)</div><div><div><span style="line-height: 22px;"   >The implementation is a quad-tree, largely copied from the quad-tree</span></div><div>implementation for points. The lower and upper bound of ranges are the 2d</div><div>coordinates, with some extra code to handle empty ranges.</div><div><br></div><div>I left out the support for adjacent operator, -|-, from the original patch.</div><div>Not because there was necessarily anything wrong with it, but it was more</div><div>complicated than the other operators, and I only have limited time for</div><div>reviewing. That will follow as a separate patch.</div><div>Alexander Korotkov, reviewed by Jeff Davis and me.</div></div><div><span style="line-height: 22px;"   >PostgreSQL 9.3 新增了range spgist的支持, 大部分代码是从point 四叉树spgist索引访问方法拷贝过来的.</span></div><div><span style="line-height: 22px;"   >四叉树的介绍可参照wiki.</span></div><div><div><img title="PostgreSQL 9.3 Add SP-GiST support for range data types - 德哥@Digoal - PostgreSQL"   alt="PostgreSQL 9.3 Add SP-GiST support for range data types - 德哥@Digoal - PostgreSQL"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/dDn1rqb9UrmLRNkSdVnWaA==/6597858116495043755.png"   ></div>主要的思想是将每个数据区域划分为四个象限.&nbsp;</div><div><span style="line-height: 22px;"   ><br></span></div><div>新增支持range 的 spgist index access method operator family :&nbsp;<span style="line-height: 22px;"   >range_ops如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from (SELECT am.amname AS index_method,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;opf.opfname AS opfamily_name,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;amop.amopopr::regoperator AS opfamily_operator</font></div><div><font size="2"   >&nbsp; &nbsp; FROM pg_am am, pg_opfamily opf, pg_amop amop</font></div><div><font size="2"   >&nbsp; &nbsp; WHERE opf.opfmethod = am.oid AND</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; amop.amopfamily = opf.oid</font></div><div><font size="2"   >&nbsp; &nbsp; ORDER BY index_method, opfamily_name, opfamily_operator) t where opfamily_name ~ 'range';</font></div><div><font size="2"   >&nbsp;index_method | opfamily_name | &nbsp; &nbsp;opfamily_operator &nbsp; &nbsp;</font></div><div><font size="2"   >--------------+---------------+-------------------------</font></div><div><font size="2"   >&nbsp;btree &nbsp; &nbsp; &nbsp; &nbsp;| range_ops &nbsp; &nbsp; | =(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;btree &nbsp; &nbsp; &nbsp; &nbsp;| range_ops &nbsp; &nbsp; | &lt;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;btree &nbsp; &nbsp; &nbsp; &nbsp;| range_ops &nbsp; &nbsp; | &lt;=(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;btree &nbsp; &nbsp; &nbsp; &nbsp;| range_ops &nbsp; &nbsp; | &gt;=(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;btree &nbsp; &nbsp; &nbsp; &nbsp;| range_ops &nbsp; &nbsp; | &gt;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;gist &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | =(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;gist &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | &amp;&amp;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;gist &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | @&gt;(anyrange,anyelement)</font></div><div><font size="2"   >&nbsp;gist &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | @&gt;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;gist &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | &lt;@(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;gist &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | &lt;&lt;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;gist &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | &gt;&gt;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;gist &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | &amp;&lt;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;gist &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | &amp;&gt;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;gist &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | -|-(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;hash &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | =(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;spgist &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | =(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;spgist &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | &amp;&amp;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;spgist &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | @&gt;(anyrange,anyelement)</font></div><div><font size="2"   >&nbsp;spgist &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | @&gt;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;spgist &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | &lt;@(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;spgist &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | &lt;&lt;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;spgist &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | &gt;&gt;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;spgist &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | &amp;&lt;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;spgist &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | &amp;&gt;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;spgist &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | -|-(anyrange,anyrange)</font></div></pre></div><div>PostgreSQL 9.2 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from (SELECT am.amname AS index_method,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;opf.opfname AS opfamily_name,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;amop.amopopr::regoperator AS opfamily_operator</font></div><div><font size="2"   >&nbsp; &nbsp; FROM pg_am am, pg_opfamily opf, pg_amop amop</font></div><div><font size="2"   >&nbsp; &nbsp; WHERE opf.opfmethod = am.oid AND</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; amop.amopfamily = opf.oid</font></div><div><font size="2"   >&nbsp; &nbsp; ORDER BY index_method, opfamily_name, opfamily_operator) t where opfamily_name ~ 'range';</font></div><div><font size="2"   >&nbsp;index_method | opfamily_name | &nbsp; &nbsp;opfamily_operator &nbsp; &nbsp;</font></div><div><font size="2"   >--------------+---------------+-------------------------</font></div><div><font size="2"   >&nbsp;btree &nbsp; &nbsp; &nbsp; &nbsp;| range_ops &nbsp; &nbsp; | =(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;btree &nbsp; &nbsp; &nbsp; &nbsp;| range_ops &nbsp; &nbsp; | &lt;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;btree &nbsp; &nbsp; &nbsp; &nbsp;| range_ops &nbsp; &nbsp; | &lt;=(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;btree &nbsp; &nbsp; &nbsp; &nbsp;| range_ops &nbsp; &nbsp; | &gt;=(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;btree &nbsp; &nbsp; &nbsp; &nbsp;| range_ops &nbsp; &nbsp; | &gt;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;gist &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | =(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;gist &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | &amp;&amp;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;gist &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | @&gt;(anyrange,anyelement)</font></div><div><font size="2"   >&nbsp;gist &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | @&gt;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;gist &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | &lt;@(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;gist &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | &lt;&lt;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;gist &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | &gt;&gt;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;gist &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | &amp;&lt;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;gist &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | &amp;&gt;(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;gist &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | -|-(anyrange,anyrange)</font></div><div><font size="2"   >&nbsp;hash &nbsp; &nbsp; &nbsp; &nbsp; | range_ops &nbsp; &nbsp; | =(anyrange,anyrange)</font></div></pre></div><div>[测试]</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-- test SP-GiST index that's been built incrementally</font></div><div><font size="2"   >create table test_range_spgist(ir int4range);</font></div><div><font size="2"   >create index test_range_spgist_idx on test_range_spgist using spgist (ir);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >insert into test_range_spgist select int4range(g, g+10) from generate_series(1,2000) g;</font></div><div><font size="2"   >insert into test_range_spgist select 'empty'::int4range from generate_series(1,500) g;</font></div><div><font size="2"   >insert into test_range_spgist select int4range(g, g+10000) from generate_series(1,1000) g;</font></div><div><font size="2"   >insert into test_range_spgist select 'empty'::int4range from generate_series(1,500) g;</font></div><div><font size="2"   >insert into test_range_spgist select int4range(NULL,g*10,'(]') from generate_series(1,100) g;</font></div><div><font size="2"   >insert into test_range_spgist select int4range(g*10,NULL,'(]') from generate_series(1,100) g;</font></div><div><font size="2"   >insert into test_range_spgist select int4range(g, g+10) from generate_series(1,2000) g;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- first, verify non-indexed results</font></div><div><font size="2"   >SET enable_seqscan &nbsp; &nbsp;= t;</font></div><div><font size="2"   >SET enable_indexscan &nbsp;= f;</font></div><div><font size="2"   >SET enable_bitmapscan = f;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >select count(*) from test_range_spgist where ir @&gt; 'empty'::int4range;</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir = int4range(10,20);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir @&gt; 10;</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir @&gt; int4range(10,20);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir &amp;&amp; int4range(10,20);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir &lt;@ int4range(10,50);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir &lt;&lt; int4range(100,500);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir &gt;&gt; int4range(100,500);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir &amp;&lt; int4range(100,500);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir &amp;&gt; int4range(100,500);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir -|- int4range(100,500);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- now check same queries using index</font></div><div><font size="2"   >SET enable_seqscan &nbsp; &nbsp;= f;</font></div><div><font size="2"   >SET enable_indexscan &nbsp;= t;</font></div><div><font size="2"   >SET enable_bitmapscan = f;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >select count(*) from test_range_spgist where ir @&gt; 'empty'::int4range;</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir = int4range(10,20);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir @&gt; 10;</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir @&gt; int4range(10,20);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir &amp;&amp; int4range(10,20);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir &lt;@ int4range(10,50);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir &lt;&lt; int4range(100,500);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir &gt;&gt; int4range(100,500);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir &amp;&lt; int4range(100,500);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir &amp;&gt; int4range(100,500);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir -|- int4range(100,500);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- now check same queries using a bulk-loaded index</font></div><div><font size="2"   >drop index test_range_spgist_idx;</font></div><div><font size="2"   >create index test_range_spgist_idx on test_range_spgist using spgist (ir);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >select count(*) from test_range_spgist where ir @&gt; 'empty'::int4range;</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir = int4range(10,20);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir @&gt; 10;</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir @&gt; int4range(10,20);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir &amp;&amp; int4range(10,20);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir &lt;@ int4range(10,50);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir &lt;&lt; int4range(100,500);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir &gt;&gt; int4range(100,500);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir &amp;&lt; int4range(100,500);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir &amp;&gt; int4range(100,500);</font></div><div><font size="2"   >select count(*) from test_range_spgist where ir -|- int4range(100,500);</font></div><p></p></pre></div><div>与gist索引的比较 :&nbsp;</div><div>size :&nbsp;</div><div>spgist索引比gist索引占用空间大.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \di+ test_range_gist_idx&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; &nbsp; | Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp; &nbsp; &nbsp; Table &nbsp; &nbsp; &nbsp; | &nbsp;Size &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+---------------------+-------+----------+-------------------+--------+-------------</font></div><div><font size="2"   >&nbsp;public | test_range_gist_idx | index | postgres | test_range_spgist | 264 kB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# \di+ test_range_spgist_idx&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp; &nbsp; Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp; &nbsp; &nbsp; Table &nbsp; &nbsp; &nbsp; | &nbsp;Size &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+-----------------------+-------+----------+-------------------+--------+-------------</font></div><div><font size="2"   >&nbsp;public | test_range_spgist_idx | index | postgres | test_range_spgist | 376 kB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></pre></div><div>select speed :&nbsp;</div><div>spgist查询速度比gist索引查询速度快.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# explain (analyze,verbose,buffers) select * from test_range_spgist where ir @&gt;1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp;Index Scan using test_range_gist_idx on public.test_range_spgist &nbsp;(cost=0.15..18.53 rows=22 width=32) (actual time=0.032..0.100 row</font></div><div><font size="2"   >s=103 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: ir</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: (test_range_spgist.ir @&gt; 1)</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=9</font></div><div><font size="2"   >&nbsp;Total runtime: 0.125 ms</font></div><div><font size="2"   >(5 rows)</font></div></div><div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# explain (analyze,verbose,buffers) select * from test_range_spgist where ir @&gt;1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;Index Only Scan using test_range_spgist_idx on public.test_range_spgist &nbsp;(cost=0.15..18.53 rows=22 width=32) (actual time=0.020..0.</font></div><div><font size="2"   >050 rows=103 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: ir</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: (test_range_spgist.ir @&gt; 1)</font></div><div><font size="2"   >&nbsp; &nbsp;Heap Fetches: 103</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=14</font></div><div><font size="2"   >&nbsp;Total runtime: 0.073 ms</font></div><div><font size="2"   >(6 rows)</font></div></div></pre></div><div>insert speed :&nbsp;</div><div>并行度一般时, 插入速度差不多.</div><div>-- pgbench 脚本</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi ins.sql</font></div><div><font size="2"   >\setrandom i 1 100000</font></div><div><font size="2"   >insert into test_range_spgist values (int4range(:i, :i+100, '[)'));</font></div><p></p></pre></div><div>-- spgist</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \d+ test_range_spgist</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "public.test_range_spgist"</font></div><div><font size="2"   >&nbsp;Column | &nbsp; Type &nbsp; &nbsp;| Modifiers | Storage &nbsp;| Stats target | Description&nbsp;</font></div><div><font size="2"   >--------+-----------+-----------+----------+--------------+-------------</font></div><div><font size="2"   >&nbsp;ir &nbsp; &nbsp; | int4range | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "test_range_spgist_idx" spgist (ir)</font></div><div><font size="2"   >Has OIDs: no</font></div><p></p></pre></div><div>-- spgist 压力测试结果</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -f ./ins.sql -n -r -h $PGDATA -U postgres -c 32 -j 4 -T 60 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 32</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 994780</font></div><div><font size="2"   >tps = 16571.329631 (including connections establishing)</font></div><div><font size="2"   >tps = 16583.348446 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001512 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom i 1 100000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.925790 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_range_spgist values (int4range(:i, :i+100, '[)'));</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >-- gist</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \d+ test_range_spgist&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "public.test_range_spgist"</font></div><div><font size="2"   >&nbsp;Column | &nbsp; Type &nbsp; &nbsp;| Modifiers | Storage &nbsp;| Stats target | Description&nbsp;</font></div><div><font size="2"   >--------+-----------+-----------+----------+--------------+-------------</font></div><div><font size="2"   >&nbsp;ir &nbsp; &nbsp; | int4range | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "test_range_gist_idx" gist (ir)</font></div><div><font size="2"   >Has OIDs: no</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >-- gist 压力测试结果</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -f ./ins.sql -n -r -h $PGDATA -U postgres -c 32 -j 4 -T 60 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 32</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 977163</font></div><div><font size="2"   >tps = 16280.498079 (including connections establishing)</font></div><div><font size="2"   >tps = 16292.777356 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001532 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom i 1 100000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.960390 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_range_spgist values (int4range(:i, :i+100, '[)'));</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >并行度测试 :&nbsp;</span></div><div><span style="line-height: 22px;"   >并行度高, gist索引的插入速度快.</span></div><div><span style="line-height: 22px;"   >-- spgist 压力测试结果</span></div><div><span style="line-height: 22px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -f ./ins.sql -n -r -h $PGDATA -U postgres -c 128 -j 4 -T 60 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 128</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 1754843</font></div><div><font size="2"   >tps = 29184.829543 (including connections establishing)</font></div><div><font size="2"   >tps = 29273.142723 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001689 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom i 1 100000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 4.363028 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_range_spgist values (int4range(:i, :i+100, '[)'));</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >-- gist 压力测试结果</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -f ./ins.sql -n -r -h $PGDATA -U postgres -c 128 -j 4 -T 60 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 128</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 1964692</font></div><div><font size="2"   >tps = 32683.703473 (including connections establishing)</font></div><div><font size="2"   >tps = 32785.598264 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001629 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom i 1 100000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 3.895888 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_range_spgist values (int4range(:i, :i+100, '[)'));</font></div><p></p></pre></div></span></div><div><span style="line-height: 22px;"   >create index speed :&nbsp;</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 22px;"   ><font size="2"   >digoal=# create index test_range_gist_idx on test_range_spgist using gist (ir);</font></div><div style="line-height: 22px;"   ><font size="2"   >CREATE INDEX</font></div><div style="line-height: 22px;"   ><font size="2"   >Time: 24504.650 ms</font></div></div><div><div><font size="2"   >digoal=# create index test_range_spgist_idx on test_range_spgist using spgist (ir);</font></div><div><font size="2"   >CREATE INDEX</font></div><div><font size="2"   >Time: 11414.184 ms</font></div></div><p></p></pre></div></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/rangetypes.html#RANGETYPES-INDEXING"   >http://www.postgresql.org/docs/devel/static/rangetypes.html#RANGETYPES-INDEXING</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=ae7363999ff36a6857b968ffee8487519273709b"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=ae7363999ff36a6857b968ffee8487519273709b</a></div><div>3.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=317dd55a9cae160c8d121eaec323a6aea3259fd8"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=317dd55a9cae160c8d121eaec323a6aea3259fd8</a></div><div>4.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020125701029222/"   >http://blog.163.com/digoal@126/blog/static/16387704020125701029222/</a></div><div>5.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201241752537254/"   >http://blog.163.com/digoal@126/blog/static/163877040201241752537254/</a></div><div>6.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020124174238681/"   >http://blog.163.com/digoal@126/blog/static/16387704020124174238681/</a></div><div>7.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://en.wikipedia.org/wiki/Quadtree"   >http://en.wikipedia.org/wiki/Quadtree</a></div><div>8.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://en.wikipedia.org/wiki/Spatial_database#Spatial_index"   >http://en.wikipedia.org/wiki/Spatial_database#Spatial_index</a></div><div>9.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/spgist.html"   >http://www.postgresql.org/docs/devel/static/spgist.html</a></div><div>10.&nbsp;src/test/regress/sql/rangetypes.sql</div><div>11.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/indexes-opclass.html"   >http://www.postgresql.org/docs/devel/static/indexes-opclass.html</a></div></div>
	</div>
</div>
</body>
</html>