<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 Make simple views auto-updatable</h2>
	<h5 id="">2013-05-09 14:30:49&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020134922356437/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Support automatically-updatable views.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This patch makes "simple" views automatically updatable, without the need</font></div><div><font size="2"   >to create either INSTEAD OF triggers or INSTEAD rules. &nbsp;"Simple" views</font></div><div><font size="2"   >are those classified as updatable according to SQL-92 rules. &nbsp;The rewriter</font></div><div><font size="2"   >transforms INSERT/UPDATE/DELETE commands on such views directly into an</font></div><div><font size="2"   >equivalent command on the underlying table, which will generally have</font></div><div><font size="2"   >noticeably better performance than is possible with either triggers or</font></div><div><font size="2"   >user-written rules. &nbsp;A view that has INSTEAD OF triggers or INSTEAD rules</font></div><div><font size="2"   >continues to operate the same as before.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >For the moment, security_barrier views are not considered simple.</font></div><div><font size="2"   >Also, we do not support WITH CHECK OPTION. &nbsp;These features may be</font></div><div><font size="2"   >added in future.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Dean Rasheed, reviewed by Amit Kapila</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >PostgreSQL 9.3 增加了对简单视图的自动可更新功能, 性能超越使用规则或触发器实现的视图更新.</span></div><div><span style="line-height: 22px;"   >简单视图的定义遵循SQL92标准.</span></div><div><span style="line-height: 22px;"   >目前不支持security_barrier视图或者with check option.</span></div><div><br></div><div><span style="line-height: 22px;"   >使用方法截取自 :&nbsp;</span></div><div><a rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-createview.html#SQL-CREATEVIEW-UPDATABLE-VIEWS"   >http://www.postgresql.org/docs/devel/static/sql-createview.html#SQL-CREATEVIEW-UPDATABLE-VIEWS</a></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >Updatable Views</font></span></div><div><div><span style="line-height: 22px;"   ><font size="2"   >Simple views are automatically updatable: the system will allow INSERT, UPDATE and DELETE statements to be used on the view in the same way as on a regular table. A view is automatically updatable if it satisfies all of the following conditions:</font></span></div><div><font size="2"   ><br></font></div><div><font size="2"   >The view must have exactly one entry in its FROM list, which must be a table or another updatable view.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The view definition must not contain WITH, DISTINCT, GROUP BY, HAVING, LIMIT, or OFFSET clauses at the top level.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The view definition must not contain set operations (UNION, INTERSECT or EXCEPT) at the top level.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >All columns in the view's select list must be simple references to columns of the underlying relation. They cannot be expressions, literals or functions. System columns cannot be referenced, either.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >No column of the underlying relation can appear more than once in the view's select list.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The view must not have the security_barrier property.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >If the view is automatically updatable the system will convert any INSERT, UPDATE or DELETE statement on the view into the corresponding statement on the underlying base relation.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >If an automatically updatable view contains a WHERE condition, the condition restricts which rows of the base relation are available to be modified by UPDATE and DELETE statements on the view. However, an UPDATE is allowed to change a row so that it no longer satisfies the WHERE condition, and thus is no longer visible through the view. Similarly, an INSERT command can potentially insert base-relation rows that do not satisfy the WHERE condition and thus are not visible through the view.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >A more complex view that does not satisfy all these conditions is read-only by default: the system will not allow an insert, update, or delete on the view. You can get the effect of an updatable view by creating INSTEAD OF triggers on the view, which must convert attempted inserts, etc. on the view into appropriate actions on other tables. For more information see CREATE TRIGGER. Another possibility is to create rules (see CREATE RULE), but in practice triggers are easier to understand and use correctly.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Note that the user performing the insert, update or delete on the view must have the corresponding insert, update or delete privilege on the view. In addition the view's owner must have the relevant privileges on the underlying base relations, but the user performing the update does not need any permissions on the underlying base relations (see Section 38.5).</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >[测试]</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table tbl (id int, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into tbl select generate_series(1,10),md5(random()::text);</font></div><div><font size="2"   >INSERT 0 10</font></div><div><font size="2"   >digoal=# create view v_tbl as select * from tbl;</font></div><div><font size="2"   >CREATE VIEW</font></div><div><font size="2"   >digoal=# \d+ v_tbl</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; View "public.v_tbl"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers | Storage &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+---------+-----------+----------+-------------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; | integer | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;info &nbsp; | text &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended |&nbsp;</font></div><div><font size="2"   >View definition:</font></div><div><font size="2"   >&nbsp;SELECT tbl.id,&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; tbl.info</font></div><div><font size="2"   >&nbsp; &nbsp;FROM tbl;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# insert into v_tbl values (100,'test'),(200,'test');</font></div><div><font size="2"   >INSERT 0 2</font></div><div><font size="2"   >digoal=# update v_tbl set id=id+1;</font></div><div><font size="2"   >UPDATE 12</font></div><div><font size="2"   >digoal=# delete from v_tbl where id&lt;6;</font></div><div><font size="2"   >DELETE 4</font></div><div><font size="2"   >digoal=# select * from v_tbl;</font></div><div><font size="2"   >&nbsp;id &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----+----------------------------------</font></div><div><font size="2"   >&nbsp; &nbsp;6 | c808dc1b1c4ad7dab3418a427c82c82f</font></div><div><font size="2"   >&nbsp; &nbsp;7 | 866d50ea140881c72b810e108975a1ab</font></div><div><font size="2"   >&nbsp; &nbsp;8 | 9b5a0e01420c6309d1c1a7114607c53e</font></div><div><font size="2"   >&nbsp; &nbsp;9 | 7da7e4aa0d5c7629e795ab789dee127c</font></div><div><font size="2"   >&nbsp; 10 | 8fde1bb6961d0a6562812f3c33c3c875</font></div><div><font size="2"   >&nbsp; 11 | f0b9e5217b43a568b2816746154eaae1</font></div><div><font size="2"   >&nbsp;101 | test</font></div><div><font size="2"   >&nbsp;201 | test</font></div><div><font size="2"   >(8 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from tbl;</font></div><div><font size="2"   >&nbsp;id &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----+----------------------------------</font></div><div><font size="2"   >&nbsp; &nbsp;6 | c808dc1b1c4ad7dab3418a427c82c82f</font></div><div><font size="2"   >&nbsp; &nbsp;7 | 866d50ea140881c72b810e108975a1ab</font></div><div><font size="2"   >&nbsp; &nbsp;8 | 9b5a0e01420c6309d1c1a7114607c53e</font></div><div><font size="2"   >&nbsp; &nbsp;9 | 7da7e4aa0d5c7629e795ab789dee127c</font></div><div><font size="2"   >&nbsp; 10 | 8fde1bb6961d0a6562812f3c33c3c875</font></div><div><font size="2"   >&nbsp; 11 | f0b9e5217b43a568b2816746154eaae1</font></div><div><font size="2"   >&nbsp;101 | test</font></div><div><font size="2"   >&nbsp;201 | test</font></div><div><font size="2"   >(8 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >详细的测试可参考</span></div><div>src/test/regress/sql/updatable_views.sql</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-createview.html#SQL-CREATEVIEW-UPDATABLE-VIEWS"   >http://www.postgresql.org/docs/devel/static/sql-createview.html#SQL-CREATEVIEW-UPDATABLE-VIEWS</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=a99c42f291421572aef2b0a9360294c7d89b8bc7"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=a99c42f291421572aef2b0a9360294c7d89b8bc7</a></div></div>
	</div>
</div>
</body>
</html>