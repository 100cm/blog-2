<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL password security</h2>
	<h5 id="">2013-05-25 22:20:48&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013425102048638/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>请参见</div><div><div>PostgreSQL 密码安全</div><div>如何防止暴力破解, 如何强制密码复杂度策略, 如何制定密码更换周期</div><div>如何防止密码在网络传输时被截获, 如何防止密码被超级用户获取</div><div>如何防止密码被审计服务器或日志服务器截获</div><div>通过修改源码限制密码最小长度</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020149852941586/"   >http://blog.163.com/digoal@126/blog/static/16387704020149852941586/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201453103526153/"   >http://blog.163.com/digoal@126/blog/static/163877040201453103526153/</a></div></div><div><br></div><div>一般来说数据库密码安全管理要考虑以下几个方面 :&nbsp;</div><div>1.<span style="white-space:pre;"   >	</span>密码过期策略, 决定密码的有效期, 多长时间过期.&nbsp;</div><div>PostgreSQL 不支持密码过期策略, 但是可以通过其他方式来实现过期提醒.</div><div>2.<span style="white-space:pre;"   >	</span>密码复用策略, 密码修改时需要对比以前的密码, 多少次以后才可以复用, 或者永不能使用与以前密码相同的密码.</div><div>PostgreSQL 不支持密码复用策略, 但是可以通过其他方式来实现强制密码复用策略.</div><div>3.<span style="white-space:pre;"   >	</span>密码长度策略, 密码的最小长度, 太短的话很容易被穷举法破解, 一般至少使用8位以上长度的密码.</div><div>PostgreSQL 不支持密码长度策略, 但是可以通过其他方式来实现强制密码长度策略.</div><div>4.<span style="white-space:pre;"   >	</span>密码复杂度策略, 密码包含的字符复杂度, 一般要求包含数字字母大小写以及特殊字符. 另外不要使用与数据库名, 用户名相似或一致的密码.</div><div>PostgreSQL 不支持密码复杂度策略, 但是可以通过其他方式来实现强制密码复杂度策略.</div><div>5.<span style="white-space:pre;"   >	</span>密码字典过滤, 过滤掉一些用户常用的或者有意义的字符, 也是为了避免密码很容易被穷举破解.&nbsp;</div><div>PostgreSQL 不支持密码字典过滤策略, 但是可以通过其他方式来实现强制字典过滤策略.</div><div>6.<span style="white-space:pre;"   >	</span>密码存储策略, 使用加密存储, 不要使用明文存储.&nbsp;</div><div>加密存储在创建用户时使用encrypted password即可.&nbsp;</div><div>如果设置了password_encryption=off, 同时创建用户时不加encrypted, 那么密码将以明文存储.</div><div>例如 :&nbsp;</div><div>加密存储 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create role u1 login encrypted password 'digoal';</font></div><div><font size="2"   >CREATE ROLE</font></div><div><font size="2"   >digoal=# select * from pg_shadow where usename='u1';</font></div><div><font size="2"   >&nbsp;usename | usesysid | usecreatedb | usesuper | usecatupd | userepl | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; passwd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| valuntil | useconfig&nbsp;</font></div><div><font size="2"   >---------+----------+-------------+----------+-----------+---------+-------------------------------------+----------+-----------</font></div><div><font size="2"   >&nbsp;u1 &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;26383 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; | md5bdf22a6622939c7c7ab2377eaca514d5 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>明文存储 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# set password_encryption=off;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# create role u2 login password 'digoal';</font></div><div><font size="2"   >CREATE ROLE</font></div><div><font size="2"   >digoal=# select * from pg_shadow where usename='u2';</font></div><div><font size="2"   >&nbsp;usename | usesysid | usecreatedb | usesuper | usecatupd | userepl | passwd | valuntil | useconfig&nbsp;</font></div><div><font size="2"   >---------+----------+-------------+----------+-----------+---------+--------+----------+-----------</font></div><div><font size="2"   >&nbsp;u2 &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;26387 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; | digoal | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>7.<span style="white-space:pre;"   >	</span>密码锁策略, 密码输入错误多少次后锁用户, 多长时间解锁.</div><div>PostgreSQL 不支持密码锁策略.</div><div>8.<span style="white-space:pre;"   >	</span>密码保护策略, 密码输入错误多少次后延迟认证. 可用来防止暴力破解.</div><div>PostgreSQL 不支持密码保护策略.</div><div><br></div><div><div>目前PostgreSQL在密码管理这块做得较弱,&nbsp;</div><div>以下举例通过函数来实现其中的部分安全策略 :&nbsp;</div><div>创建一个字典表, 用于存放已经使用过的密码的md5值, 以及用来进行暴力破解的密码字典的md5值.</div><p></p><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table pwd_dictionary(pwd text unique);</font></div><div></div><p></p><div></div><p></p><div><span style="line-height: 22px; font-family: Arial, Helvetica, sans-serif;"   ><font size="2"   >CREATE TABLE</font></span></div><p></p></pre></div><div>创建一个记录用户最后一次修改密码时间的表. 用于实施密码过期提醒策略.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table user_pwd(rolename name not null unique, pwd_modify_time timestamp not null);</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div>创建用户的函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create or replace function create_role(i_rolename name, i_pwd text) returns void as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_length int := 8;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; -- 密码长度策略</font></div><div><font size="2"   >&nbsp; if length(i_pwd) &lt; v_length then</font></div><div><font size="2"   >&nbsp; &nbsp; raise notice 'password too short, please use password long than %.', v_length;</font></div><div><font size="2"   >&nbsp; &nbsp; return;</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; -- 密码复杂度策略, 包含数字, 字母大小写.</font></div><div><font size="2"   >&nbsp; if not(i_pwd ~ '[a-z]' and i_pwd ~ '[A-Z]' and i_pwd ~ '[0-9]') then</font></div><div><font size="2"   >&nbsp; &nbsp; raise notice 'password too simple, please ensure password contain a-z,A-Z and 0-9.';</font></div><div><font size="2"   >&nbsp; &nbsp; return;</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; -- 密码复用策略, 不允许重复使用已经存在的密码.</font></div><div><font size="2"   >&nbsp; -- 密码字典策略, 不允许使用密码字典中的密码.</font></div><div><font size="2"   >&nbsp; insert into pwd_dictionary(pwd) values (md5(i_pwd));</font></div><div><font size="2"   >&nbsp; -- 插入用户表, 记录用户最后一次修改密码的时间, 用于密码过期策略</font></div><div><font size="2"   >&nbsp; insert into user_pwd(rolename, pwd_modify_time) values (i_rolename, now());</font></div><div><font size="2"   >&nbsp; -- 创建用户</font></div><div><font size="2"   >&nbsp; execute 'create role '||i_rolename||' encrypted password '||quote_literal(i_pwd);</font></div><div><font size="2"   >&nbsp; raise notice 'create role % successed.', i_rolename;</font></div><div><font size="2"   >&nbsp; return;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><p></p></pre></div><div>创建用户密码过短, 不允许创建.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from create_role('u4','pwd');</font></div><div><font size="2"   >NOTICE: &nbsp;password too short, please use password long than 8.</font></div><div><font size="2"   >&nbsp;create_role&nbsp;</font></div><div><font size="2"   >-------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>创建用户密码过于简单, 不允许创建.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from create_role('u4','abcdefee');</font></div><div><font size="2"   >NOTICE: &nbsp;password too simple, please ensure password contain a-z,A-Z and 0-9.</font></div><div><font size="2"   >&nbsp;create_role&nbsp;</font></div><div><font size="2"   >-------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>创建用户正常.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from create_role('u4','aA0ffffffff');</font></div><div><font size="2"   >NOTICE: &nbsp;create role u4 successed.</font></div><div><font size="2"   >&nbsp;create_role&nbsp;</font></div><div><font size="2"   >-------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>创建用户密码与现有密码重复, 不允许创建.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from create_role('new','aA0ffffffff');</font></div><div><font size="2"   >ERROR: &nbsp;duplicate key value violates unique constraint "pwd_dictionary_pwd_key"</font></div><div><font size="2"   >DETAIL: &nbsp;Key (pwd)=(2b9aa88182d13d35930180b4cc791beb) already exists.</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "insert into pwd_dictionary(pwd) values (md5(i_pwd))"</font></div><div><font size="2"   >PL/pgSQL function create_role(name,text) line 17 at SQL statement</font></div><p></p></pre></div><div><br></div><div>修改用户密码的函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create or replace function alter_role_pwd(i_rolename name, i_pwd text) returns void as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_length int := 8;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; -- 密码长度策略</font></div><div><font size="2"   >&nbsp; if length(i_pwd) &lt; v_length then</font></div><div><font size="2"   >&nbsp; &nbsp; raise notice 'password too short, please use password long than %.', v_length;</font></div><div><font size="2"   >&nbsp; &nbsp; return;</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; -- 密码复杂度策略, 包含数字, 字母大小写.</font></div><div><font size="2"   >&nbsp; if not(i_pwd ~ '[a-z]' and i_pwd ~ '[A-Z]' and i_pwd ~ '[0-9]') then</font></div><div><font size="2"   >&nbsp; &nbsp; raise notice 'password too simple, please ensure password contain a-z,A-Z and 0-9.';</font></div><div><font size="2"   >&nbsp; &nbsp; return;</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; -- 密码复用策略, 不允许重复使用已经存在的密码.</font></div><div><font size="2"   >&nbsp; -- 密码字典策略, 不允许使用密码字典中的密码.</font></div><div><font size="2"   >&nbsp; insert into pwd_dictionary(pwd) values (md5(i_pwd));</font></div><div><font size="2"   >&nbsp; -- 更新用户表, 记录用户最后一次修改密码的时间, 用于密码过期策略</font></div><div><font size="2"   >&nbsp; update user_pwd set pwd_modify_time=now() where rolename=i_rolename;</font></div><div><font size="2"   >&nbsp; -- 修改用户密码</font></div><div><font size="2"   >&nbsp; execute 'alter role '||i_rolename||' encrypted password '||quote_literal(i_pwd);</font></div><div><font size="2"   >&nbsp; raise notice 'modify role % password successed.', i_rolename;</font></div><div><font size="2"   >&nbsp; return;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><p></p></pre></div><div>使用该函数修改用户密码</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from alter_role_pwd('u4','new');</font></div><div><font size="2"   >NOTICE: &nbsp;password too short, please use password long than 8.</font></div><div><font size="2"   >&nbsp;alter_role_pwd&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select * from alter_role_pwd('u4','new22222222');</font></div><div><font size="2"   >NOTICE: &nbsp;password too simple, please ensure password contain a-z,A-Z and 0-9.</font></div><div><font size="2"   >&nbsp;alter_role_pwd&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select * from alter_role_pwd('u4','new2222222z2');</font></div><div><font size="2"   >NOTICE: &nbsp;password too simple, please ensure password contain a-z,A-Z and 0-9.</font></div><div><font size="2"   >&nbsp;alter_role_pwd&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select * from alter_role_pwd('u4','new2222222z2A');</font></div><div><font size="2"   >NOTICE: &nbsp;modify role u4 password successed.</font></div><div><font size="2"   >&nbsp;alter_role_pwd&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select * from alter_role_pwd('u4','new2222222z2A');</font></div><div><font size="2"   >ERROR: &nbsp;duplicate key value violates unique constraint "pwd_dictionary_pwd_key"</font></div><div><font size="2"   >DETAIL: &nbsp;Key (pwd)=(9a5c46207db775d4d98e64d427481cbc) already exists.</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "insert into pwd_dictionary(pwd) values (md5(i_pwd))"</font></div><div><font size="2"   >PL/pgSQL function alter_role_pwd(name,text) line 17 at SQL statement</font></div><p></p></pre></div><div><br></div><div>密码过期提醒 :&nbsp;</div><div>因为密码最后一次修改时间已经更新到user_pwd表, 所以结合这个可以在系统crontab中或者nagios监控软件中实施密码过期提醒.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from user_pwd ;</font></div><div><font size="2"   >&nbsp;rolename | &nbsp; &nbsp; &nbsp;pwd_modify_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----------+----------------------------</font></div><div><font size="2"   >&nbsp;u4 &nbsp; &nbsp; &nbsp;| 2013-05-25 18:21:59.376404</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>[小结]</div><div>1.<span style="white-space:pre;"   >	</span>为了密码安全性, 在PostgreSQL 中, 创建用户请使用create_role函数, 不要直接使用create role 命令.</div><div>2.<span style="white-space:pre;"   >	</span>修改用户密码请使用alter_role_pwd函数. 不要直接使用alter role 命令.</div><div>3.<span style="white-space:pre;"   >	</span>密码过期提醒请结合nagios软件或者操作系统crontab来实现邮件提醒数据库管理员.</div></div><wbr></div>
	</div>
</div>
</body>
</html>