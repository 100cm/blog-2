<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 Improve commit_delay</h2>
	<h5 id="">2013-05-06 12:11:13&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201346104155987/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p></p><div><font size="2"   >In PostgreSQL releases prior to 9.3, commit_delay behaved differently and was much less effective: it affected only commits, rather than all WAL flushes, and waited for the entire configured delay even if the WAL flush was completed sooner.&nbsp;</font></div><div><font size="2"   >Beginning in PostgreSQL 9.3, the first process that becomes ready to flush waits for the configured interval, while subsequent processes wait only until the leader completes the flush operation.</font></div><p></p></pre></div><div>在9.3以前commit_delay是比较低效的, 首先该参数只对commit起作用, 其他的wal flush请求不起作用. 并且所有参与wal flush和并的进程都要等待commit_delay时长.</div><div>9.3对此做了改进, 具体见参考部分.</div><div>对所有的wal flush请求生效, 同时不需要所有进程都等待commit_delay时长, 只有整组进程的第一个进程需要等待commit_delay时长, 其他进程只需要等到flush结束.</div><div>从测试来看在高并发下提升非常明显.</div><div>测试机 :&nbsp;</div><div>8核Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5440 &nbsp;@ 2.83GHz</div><div>146G 10K转sas 2.5寸硬盘.</div><div>CentOS 5.x x64.</div><div><br></div><div>[测试]</div><div>postgresql.conf</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >shared_buffers = 1024MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div><font size="2"   >wal_level = minimal &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, or hot_standby</font></div><div><font size="2"   >synchronous_commit = on &nbsp; &nbsp; &nbsp; &nbsp; # synchronization level;</font></div><div><font size="2"   >wal_sync_method = fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # the default is the first option</font></div><div><font size="2"   >commit_delay = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # range 0-100000, in microseconds</font></div><div><font size="2"   >commit_siblings = 5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # range 1-1000</font></div><div><font size="2"   >checkpoint_segments = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# in logfile segments, min 1, 16MB each</font></div><div><font size="2"   >autovacuum = off</font></div></pre></div><div># 测试表</div><div><pre class="prettyprint"   ><p><font size="2"   >digoal=# create table test(id int, info text);</font></p></pre></div><div>pgbench脚本 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi ins.sql</font></div><div><font size="2"   >insert into test values (1,'test');</font></div><p></p></pre></div><div><br></div><div># 测试前checkpoint.</div><div><pre class="prettyprint"   ><p><font size="2"   >digoal=# checkpoint;</font></p></pre></div></div><div>测试结果 :&nbsp;</div><div>连接数32.</div><div>PostgreSQL 9.2 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-33-&gt; pgbench -M prepared -f ./ins.sql -n -r -h $PGDATA -U postgres -c 32 -j 4 -T 60 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 32</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 1093293</font></div><div><font size="2"   >tps = 18217.546087 (including connections establishing)</font></div><div><font size="2"   >tps = 18232.311774 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.753613 &nbsp; &nbsp; &nbsp; &nbsp;insert into test values (1,'test');</font></div></pre></div><div>PostgreSQL 9.3 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -f ./ins.sql -n -r -h $PGDATA -U postgres -c 32 -j 4 -T 60 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 32</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 1200383</font></div><div><font size="2"   >tps = 20002.815831 (including connections establishing)</font></div><div><font size="2"   >tps = 20018.006205 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.596990 &nbsp; &nbsp; &nbsp; &nbsp;insert into test values (1,'test');</font></div></pre></div><div><span style="line-height: 22px;"   >连接数32时看不出PostgreSQL 9.3对commit_delay的改进部分有多少提升, 将并发加到128.&nbsp;</span></div><div><span style="line-height: 22px;"   >就能看出明显的提升了.</span></div><div><span style="line-height: 22px;"   >PostgreSQL 9.2 :&nbsp;</span></div><div><span style="line-height: 22px;"   >&nbsp;9.2性能下降严重.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-33-&gt; pgbench -M prepared -f ./ins.sql -n -r -h $PGDATA -U postgres -c 128 -j 4 -T 60 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 128</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 637837</font></div><div><font size="2"   >tps = 10622.588115 (including connections establishing)</font></div><div><font size="2"   >tps = 10657.532710 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 12.002027 &nbsp; &nbsp; &nbsp; insert into test values (1,'test');</font></div><p></p></pre></div><div>PostgreSQL 9.3 :&nbsp;</div><div>9.3性能提升明显, 说明commit_delay起到作用了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -f ./ins.sql -n -r -h $PGDATA -U postgres -c 128 -j 4 -T 60 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 128</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 2349980</font></div><div><font size="2"   >tps = 39140.073606 (including connections establishing)</font></div><div><font size="2"   >tps = 39260.745775 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 3.256934 &nbsp; &nbsp; &nbsp; &nbsp;insert into test values (1,'test');</font></div><p></p></pre></div><div><br></div><div>[其他]</div><div>PostgreSQL 9.3开始commit_delay需要超级用户权限进行配置.</div><div><br></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=13fe298ca06f5390df5edf073cf401f9f0b67458"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=13fe298ca06f5390df5edf073cf401f9f0b67458</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Change commit_delay to be SUSET for 9.3+</font></div><div><font size="2"   >Prior to 9.3 the commit_delay affected only the current user,</font></div><div><font size="2"   >whereas now only the group leader waits while holding the</font></div><div><font size="2"   >WALWriteLock. Deliberate or accidental settings to a poor</font></div><div><font size="2"   >value could seriously degrade performance for all users.</font></div><div><font size="2"   >Privileges may be delegated by SECURITY DEFINER functions</font></div><div><font size="2"   >for anyone that needs per-user settings in real situations.</font></div><div><font size="2"   >Request for change from Peter Geoghegan</font></div><p></p></pre></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/runtime-config-wal.html#GUC-COMMIT-DELAY"   >http://www.postgresql.org/docs/devel/static/runtime-config-wal.html#GUC-COMMIT-DELAY</a></div><div>3.&nbsp;src/backend/access/transam/xlog.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* Ensure that all XLOG data through the given position is flushed to disk.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* NOTE: this differs from XLogWrite mainly in that the WALWriteLock is not</font></div><div><font size="2"   >&nbsp;* already held, and we try to avoid acquiring it if possible.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >void</font></div><div><font size="2"   >XLogFlush(XLogRecPtr record)</font></div><div><font size="2"   >{</font></div></div><div><font size="2"   >............略</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Sleep before flush! By adding a delay here, we may give further</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* backends the opportunity to join the backlog of group commit</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* followers; this can significantly improve transaction throughput, at</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* the risk of increasing transaction latency.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* We do not sleep if enableFsync is not turned on, nor if there are</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* fewer than CommitSiblings other backends with active transactions.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (CommitDelay &gt; 0 &amp;&amp; enableFsync &amp;&amp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MinimumActiveBackends(CommitSiblings))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pg_usleep(CommitDelay);</font></div><p></p></pre></div><div>注意fsync=on时commit_delay才会生效.</div></div>
	</div>
</div>
</body>
</html>