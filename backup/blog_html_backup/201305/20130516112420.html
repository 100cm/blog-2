<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 pg_trgm imporve support multi-bytes char and gist,gin index for reg-exp search</h2>
	<h5 id="">2013-05-16 11:24:20&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013416102141801/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><span style="line-height: 22px;"   >PostgreSQL 9.3的pg_trgm模块主要有2方面的增强, 支持多字节字符, 同时支持gist, gin索引的规则表达式查询.</span></div><div><pre class="prettyprint"   ><p><font size="2"   >Note: pg_trgm ignores non-word characters (non-alphanumerics) when extracting trigrams from a string. Each word is considered to have two spaces prefixed and one space suffixed when determining the set of trigrams contained in the string. For example, the set of trigrams in the string "cat" is " c", " ca", "cat", and "at ". The set of trigrams in the string "foo|bar" is " f", " fo", "foo", "oo ", " b", " ba", "bar", and "ar ".</font></p></pre></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >1. 多字节字符支持测试 :&nbsp;</span></div><div><span style="line-height: 22px;"   >如果要让pg_trgm 支持宽字符, 数据库的collate不能是 C. 否则依旧忽略.</span></div><div><span style="line-height: 22px;"   >不过我发现在9.2上面选择collate不为C, 也支持宽字符.</span></div><div><span style="line-height: 22px;"   >PostgreSQL 9.3 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select show_trgm('刘德华abc, hello world. hello china.');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;show_trgm &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;{0xb207ac,0xd2efc5," &nbsp;c"," &nbsp;h"," &nbsp;w"," ch"," he"," wo",0x304695,0x403652,abc,"bc ",chi,ell,hel,hin,ina,"ld ",llo,"lo ","na ",0x6ff9</font></div><div><font size="2"   >5f,orl,rld,wor}</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>按照pg_trgm的拆分规则, 只保留了数字, 字母, 以及wchar. 标点空格等其他字符都不在组合的范围内.</div><div>得到的组合如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; 刘</font></div><div><font size="2"   >&nbsp;刘德</font></div><div><font size="2"   >刘德华</font></div><div><font size="2"   >德华a</font></div><div><font size="2"   >华ab</font></div><div><font size="2"   >abc</font></div><div><font size="2"   >bc&nbsp;</font></div><div><font size="2"   >&nbsp; h</font></div><div><font size="2"   >&nbsp;he</font></div><div><font size="2"   >hel</font></div><div><font size="2"   >ell</font></div><div><font size="2"   >llo</font></div><div><font size="2"   >lo&nbsp;</font></div><div><font size="2"   >&nbsp; w</font></div><div><font size="2"   >&nbsp;wo</font></div><div><font size="2"   >wor</font></div><div><font size="2"   >orl</font></div><div><font size="2"   >rld</font></div><div><font size="2"   >ld&nbsp;</font></div><div><font size="2"   >&nbsp; c</font></div><div><font size="2"   >&nbsp;ch</font></div><div><font size="2"   >chi</font></div><div><font size="2"   >hin</font></div><div><font size="2"   >ina</font></div><div><font size="2"   >na&nbsp;</font></div><p></p></pre></div><div><br><p></p></div><div>2. 规则表达式查询走gist或gin索引.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create table trgm_test(id serial4 primary key, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >digoal=# create index trgm_test_gin on trgm_test using gin(info gin_trgm_ops);</font></div><div><font size="2"   >CREATE INDEX</font></div></div><div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# insert into trgm_test (info) values ('abc刘德华def, hello world, hello china.');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >Time: 0.504 ms</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# insert into trgm_test (info) values ('abc张学友def, hello world, hello china.');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >Time: 0.267 ms</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# insert into trgm_test (info) select md5(random()::text) from generate_series(1,100000);</font></div><div><font size="2"   >INSERT 0 100000</font></div><div><font size="2"   >Time: 6003.028 ms</font></div></div><div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# select show_trgm(info), info from trgm_test where id=2;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;show_trgm &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >--------------------------------+-----------------------------------------</font></div><div><font size="2"   >&nbsp;{0x9212d6,0x09c328," &nbsp;a"," &nbsp;c"," &nbsp;h"," &nbsp;w"," ab"," ch"," he"," wo",0x480682,0x4c470a,abc,chi,def,"ef ",ell,hel,hin,ina,"ld ",llo,"l</font></div><div><font size="2"   >o ","na ",orl,rld,wor,0x7c9196} | abc张学友def, hello world, hello china.</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 0.310 ms</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# select show_trgm('el');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; show_trgm &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;{" &nbsp;e"," el","el "}</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 0.164 ms</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# select info from (select unnest(show_trgm(info)) as info from trgm_test where id=2) t where info=any(show_trgm('el'));</font></div><div><font size="2"   >&nbsp;info&nbsp;</font></div><div><font size="2"   >------</font></div><div><font size="2"   >(0 rows)</font></div><div><font size="2"   >Time: 0.280 ms</font></div></div><div><font size="2"   ><br></font></div><div><span style="font-family: Arial, Helvetica, sans-serif; line-height: 22px; white-space: normal;"   ><font size="2"   ># 对照以下结果以及以上结果, gin,gist索引不是简单的trgm拆分后的array gin索引. 否则el将检索不到.</font></span></div><div><font size="2"   >digoal=# explain analyze select * from trgm_test where info ~ 'el';<br>                                                 QUERY PLAN                                                 <br>------------------------------------------------------------------------------------------------------------<br> Seq Scan on trgm_test  (cost=0.00..2084.03 rows=20000 width=36) (actual time=0.014..97.282 rows=2 loops=1)<br>   Filter: (info ~ 'el'::text)<br>   Rows Removed by Filter: 100000<br> Total runtime: 97.309 ms<br>(4 rows)<br>Time: 97.874 ms</font></div><div><font size="2"   >digoal=# select * from trgm_test where info ~ 'el';<br> id |                  info                   <br>----+-----------------------------------------<br>  1 | abc刘德华def, hello world, hello china.<br>  2 | abc张学友def, hello world, hello china.<br>(2 rows)<br>Time: 95.281 ms</font></div><div><font size="2"   >digoal=# set enable_seqscan=off;<br>SET</font></div><div><font size="2"   >digoal=# explain analyze select * from trgm_test where info ~ 'el';<br>                                                              QUERY PLAN                                                            <br>   <br>------------------------------------------------------------------------------------------------------------------------------------<br>---<br> Bitmap Heap Scan on trgm_test  (cost=27143.00..28227.00 rows=20000 width=36) (actual time=222.531..312.936 rows=2 loops=1)<br>   Recheck Cond: (info ~ 'el'::text)<br>   Rows Removed by Index Recheck: 100000<br>   -&gt;  Bitmap Index Scan on trgm_test_gin  (cost=0.00..27138.00 rows=20000 width=0) (actual time=222.401..222.401 rows=100002 loops=<br>1)<br>         Index Cond: (info ~ 'el'::text)<br> Total runtime: 312.988 ms<br>(6 rows)</font></div><div><font size="2"   >digoal=# select * from trgm_test where info ~ 'el';<br> id |                  info                   <br>----+-----------------------------------------<br>  1 | abc刘德华def, hello world, hello china.<br>  2 | abc张学友def, hello world, hello china.<br>(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># 和trgm_limit也无关. 因为以下查询的匹配度小于limit 0.3, 但是走索引依然匹配了.</font></div><div><font size="2"   >postgres=# explain analyze select *,similarity(info,'刘德华') from trgm_test where info ~ '刘德华';<br>                                                      QUERY PLAN                                                       <br>-----------------------------------------------------------------------------------------------------------------------<br> Bitmap Heap Scan on trgm_test  (cost=6.08..25.13 rows=10 width=36) (actual time=0.063..0.064 rows=1 loops=1)<br>   Recheck Cond: (info ~ '刘德华'::text)<br>   -&gt;  Bitmap Index Scan on trgm_test_gin  (cost=0.00..6.08 rows=10 width=0) (actual time=0.046..0.046 rows=1 loops=1)<br>         Index Cond: (info ~ '刘德华'::text)<br> Total runtime: 0.077 ms<br>(5 rows)<br><br>postgres=# select *,similarity(info,'刘德华') from trgm_test where info ~ '刘德华';<br> id |                  info                   | similarity <br>----+-----------------------------------------+------------<br>  1 | abc刘德华def, hello world, hello china. |  0.0322581<br>(1 row)<br><br>postgres=# select show_limit();<br> show_limit <br>------------<br>        0.3<br>(1 row)</font></div><p></p></pre></div><div><div>匹配度越高, 速度越快.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from trgm_test where info ~ 'hello';</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----+-----------------------------------------</font></div><div><font size="2"   >&nbsp; 1 | abc刘德华def, hello world, hello china.</font></div><div><font size="2"   >&nbsp; 2 | abc张学友def, hello world, hello china.</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   >Time: 0.637 ms</font></div><div><font size="2"   >digoal=# explain analyze select * from trgm_test where info ~ 'hello';<br>                                                        QUERY PLAN                                                        <br>--------------------------------------------------------------------------------------------------------------------------<br> Bitmap Heap Scan on trgm_test  (cost=19.24..252.15 rows=160 width=36) (actual time=0.049..0.051 rows=2 loops=1)<br>   Recheck Cond: (info ~ 'hello'::text)<br>   -&gt;  Bitmap Index Scan on trgm_test_gin  (cost=0.00..19.20 rows=160 width=0) (actual time=0.043..0.043 rows=2 loops=1)<br>         Index Cond: (info ~ 'hello'::text)<br> Total runtime: 0.071 ms<br>(5 rows)<br><br>Time: 0.312 ms</font></div><p></p></pre></div></div><div>gist 索引 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# drop index trgm_test_gin ;</font></div><div><font size="2"   >DROP INDEX</font></div></div><div><div><font size="2"   >digoal=# create index trgm_test_gist on trgm_test using gist(info gist_trgm_ops);</font></div><div><font size="2"   >CREATE INDEX</font></div></div><div><div><font size="2"   >digoal=# explain analyze select * from trgm_test where info ~ 'hello';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Bitmap Heap Scan on trgm_test &nbsp;(cost=9.52..242.43 rows=160 width=36) (actual time=18.155..18.159 rows=2 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Recheck Cond: (info ~ 'hello'::text)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on trgm_test_gist &nbsp;(cost=0.00..9.48 rows=160 width=0) (actual time=18.126..18.126 rows=2 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (info ~ 'hello'::text)</font></div><div><font size="2"   >&nbsp;Total runtime: 18.204 ms</font></div><div><font size="2"   >(5 rows)</font></div></div><p></p></pre></div><div><br></div><div>索引大小 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# \dt+ trgm_test</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; Name &nbsp; &nbsp;| Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp;Size &nbsp; | Description&nbsp;</font></div><div><font size="2"   >--------+-----------+-------+----------+---------+-------------</font></div><div><font size="2"   >&nbsp;public | trgm_test | table | postgres | 6704 kB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# \di+ trgm_test_gist&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; Name &nbsp; &nbsp; &nbsp;| Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp; Table &nbsp; | Size &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+---------------+-------+----------+-----------+-------+-------------</font></div><div><font size="2"   >&nbsp;public | trgm_test_gist | index | postgres | trgm_test | 18 MB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# \di+ trgm_test_gin</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp;| Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp; Table &nbsp; | Size &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+----------------+-------+----------+-----------+-------+-------------</font></div><div><font size="2"   >&nbsp;public | trgm_test_gin | index | postgres | trgm_test | 35 MB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>[小结]</div><div>1. gin 索引比gist索引占用空间大, 但是gin查询速度快.</div><div>2. PostgreSQL又多了一个模糊查询的选择. 以前使用分词的方法有些可能检索不到, 但是用trgm是可以完全检测到的.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain analyze select * from trgm_test where info ~ '刘德华';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Bitmap Heap Scan on trgm_test &nbsp;(cost=6.08..25.11 rows=10 width=36) (actual time=0.043..0.044 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Recheck Cond: (info ~ '刘德华'::text)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on trgm_test_gin &nbsp;(cost=0.00..6.08 rows=10 width=0) (actual time=0.037..0.037 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (info ~ '刘德华'::text)</font></div><div><font size="2"   >&nbsp;Total runtime: 0.055 ms</font></div><div><font size="2"   >(5 rows)</font></div><div><font size="2"   >Time: 0.273 ms</font></div><div><font size="2"   >digoal=# select * from trgm_test where info ~ '刘德华';</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----+-----------------------------------------</font></div><div><font size="2"   >&nbsp; 1 | abc刘德华def, hello world, hello china.</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 0.242 ms</font></div><p></p></pre></div><div>但是gin索引的写性能比gist差很多, gin索引优化方法见如下, 可以达到gist 的性能 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201341625735128/"   >http://blog.163.com/digoal@126/blog/static/163877040201341625735128/</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; vi ins.sql</font></div><div><font size="2"   >insert into trgm_test (info) values(md5(random()::text));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -r -n -f ./ins.sql -c 16 -j 4 -T 60</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 52152</font></div><div><font size="2"   >tps = 824.689788 (including connections establishing)</font></div><div><font size="2"   >tps = 824.946710 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 19.267069 &nbsp; &nbsp; &nbsp; insert into trgm_test (info) values(md5(random()::text));</font></div><div><br></div><div><font size="2"   >postgres=# drop index trgm_test_gin ;</font></div><div><font size="2"   >DROP INDEX</font></div><div><font size="2"   >postgres=# create index trgm_test_gist on trgm_test using gist(info gist_trgm_ops);</font></div><div><font size="2"   >CREATE INDEX</font></div><div><font size="2"   >postgres=# truncate trgm_test ;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >postgres=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -r -n -f ./ins.sql -c 16 -j 4 -T 60</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 2129577</font></div><div><font size="2"   >tps = 35463.124921 (including connections establishing)</font></div><div><font size="2"   >tps = 35477.153945 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.449334 &nbsp; &nbsp; &nbsp; &nbsp;insert into trgm_test (info) values(md5(random()::text));</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=3ccae48f44d993351e1f881761bd6c556ebd6638"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=3ccae48f44d993351e1f881761bd6c556ebd6638</a></div><div>2.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020132254838733/"   >http://blog.163.com/digoal@126/blog/static/16387704020132254838733/</a></div><div>3.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201191882553803/"   >http://blog.163.com/digoal@126/blog/static/163877040201191882553803/</a></div><div>4.&nbsp;contrib/pg_trgm/trgm_regexp.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;797 /*</font></div><div><font size="2"   >&nbsp;798 &nbsp;* Convert pg_wchar to multibyte format.</font></div><div><font size="2"   >&nbsp;799 &nbsp;* Returns false if the character should be ignored completely.</font></div><div><font size="2"   >&nbsp;800 &nbsp;*/</font></div><div><font size="2"   >&nbsp;801 static bool</font></div><div><font size="2"   >&nbsp;802 convertPgWchar(pg_wchar c, trgm_mb_char *result)</font></div><div><font size="2"   >&nbsp;803 {</font></div><div><font size="2"   >&nbsp;804 &nbsp; &nbsp; /* "s" has enough space for a multibyte character and a trailing NUL */</font></div><div><font size="2"   >&nbsp;805 &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; &nbsp;s[MAX_MULTIBYTE_CHAR_LEN + 1];</font></div><div><font size="2"   >&nbsp;806&nbsp;</font></div><div><font size="2"   >&nbsp;807 &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp;808 &nbsp; &nbsp; &nbsp;* We can ignore the NUL character, since it can never appear in a PG text</font></div><div><font size="2"   >&nbsp;809 &nbsp; &nbsp; &nbsp;* string. &nbsp;This avoids the need for various special cases when</font></div><div><font size="2"   >&nbsp;810 &nbsp; &nbsp; &nbsp;* reconstructing trigrams.</font></div><div><font size="2"   >&nbsp;811 &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp;812 &nbsp; &nbsp; if (c == 0)</font></div><div><font size="2"   >&nbsp;813 &nbsp; &nbsp; &nbsp; &nbsp; return false;</font></div><div><font size="2"   >&nbsp;814&nbsp;</font></div><div><font size="2"   >&nbsp;815 &nbsp; &nbsp; /* Do the conversion, making sure the result is NUL-terminated */</font></div><div><font size="2"   >&nbsp;816 &nbsp; &nbsp; memset(s, 0, sizeof(s));</font></div><div><font size="2"   >&nbsp;817 &nbsp; &nbsp; pg_wchar2mb_with_len(&amp;c, s, 1);</font></div><div><font size="2"   >&nbsp;818&nbsp;</font></div><div><font size="2"   >&nbsp;819 &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp;820 &nbsp; &nbsp; &nbsp;* In IGNORECASE mode, we can ignore uppercase characters. &nbsp;We assume that</font></div><div><font size="2"   >&nbsp;821 &nbsp; &nbsp; &nbsp;* the regex engine generated both uppercase and lowercase equivalents</font></div><div><font size="2"   >&nbsp;822 &nbsp; &nbsp; &nbsp;* within each color, since we used the REG_ICASE option; so there's no</font></div><div><font size="2"   >&nbsp;823 &nbsp; &nbsp; &nbsp;* need to process the uppercase version.</font></div><div><font size="2"   >&nbsp;824 &nbsp; &nbsp; &nbsp;*</font></div><div><font size="2"   >&nbsp;825 &nbsp; &nbsp; &nbsp;* XXX this code is dependent on the assumption that lowerstr() works the</font></div><div><font size="2"   >&nbsp;826 &nbsp; &nbsp; &nbsp;* same as the regex engine's internal case folding machinery. &nbsp;Might be</font></div><div><font size="2"   >&nbsp;827 &nbsp; &nbsp; &nbsp;* wiser to expose pg_wc_tolower and test whether c == pg_wc_tolower(c).</font></div><div><font size="2"   >&nbsp;828 &nbsp; &nbsp; &nbsp;* On the other hand, the trigrams in the index were created using</font></div><div><font size="2"   >&nbsp;829 &nbsp; &nbsp; &nbsp;* lowerstr(), so we're probably screwed if there's any incompatibility</font></div><div><font size="2"   >&nbsp;830 &nbsp; &nbsp; &nbsp;* anyway.</font></div><div><font size="2"   >&nbsp;831 &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp;832 #ifdef IGNORECASE</font></div><div><font size="2"   >&nbsp;833 &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp;834 &nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *lowerCased = lowerstr(s);</font></div><div><font size="2"   >&nbsp;835&nbsp;</font></div><div><font size="2"   >&nbsp;836 &nbsp; &nbsp; &nbsp; &nbsp; if (strcmp(lowerCased, s) != 0)</font></div><div><font size="2"   >&nbsp;837 &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp;838 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pfree(lowerCased);</font></div><div><font size="2"   >&nbsp;839 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return false;</font></div><div><font size="2"   >&nbsp;840 &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp;841 &nbsp; &nbsp; &nbsp; &nbsp; pfree(lowerCased);</font></div><div><font size="2"   >&nbsp;842 &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp;843 #endif</font></div><div><font size="2"   >&nbsp;844&nbsp;</font></div><div><font size="2"   >&nbsp;845 &nbsp; &nbsp; /* Fill result with exactly MAX_MULTIBYTE_CHAR_LEN bytes */</font></div><div><font size="2"   >&nbsp;846 &nbsp; &nbsp; strncpy(result-&gt;bytes, s, MAX_MULTIBYTE_CHAR_LEN);</font></div><div><font size="2"   >&nbsp;847 &nbsp; &nbsp; return true;</font></div><div><font size="2"   >&nbsp;848 }</font></div><p></p></pre></div><div>3. gist, gin index operator.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/* contrib/pg_trgm/pg_trgm--1.0--1.1.sql */</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- complain if script is sourced in psql, rather than via CREATE EXTENSION</font></div><div><font size="2"   >\echo Use "ALTER EXTENSION pg_trgm UPDATE TO '1.1'" to load this file. \quit</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >ALTER OPERATOR FAMILY gist_trgm_ops USING gist ADD</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; OPERATOR &nbsp; &nbsp; &nbsp; &nbsp;5 &nbsp; &nbsp; &nbsp; pg_catalog.~ (text, text),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; OPERATOR &nbsp; &nbsp; &nbsp; &nbsp;6 &nbsp; &nbsp; &nbsp; pg_catalog.~* (text, text);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >ALTER OPERATOR FAMILY gin_trgm_ops USING gin ADD</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; OPERATOR &nbsp; &nbsp; &nbsp; &nbsp;5 &nbsp; &nbsp; &nbsp; pg_catalog.~ (text, text),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; OPERATOR &nbsp; &nbsp; &nbsp; &nbsp;6 &nbsp; &nbsp; &nbsp; pg_catalog.~* (text, text);</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>