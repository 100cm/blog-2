<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">ecryptfs Encryption directory in linux</h2>
	<h5 id="">2013-05-24 17:13:44&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201342443944861/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">前面介绍过使用cryptsetup-luks加密文件系统. 性能下降较为严重.<div><a href="http://blog.163.com/digoal@126/blog/static/1638770402013423384517/"   >http://blog.163.com/digoal@126/blog/static/1638770402013423384517/</a><br><wbr><div>本文将介绍使用ecryptfs包加密目录, 并且看看性能如何.</div><div>使用的环境与上面这篇BLOG一致.</div><div>需要的包如下 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 ca-certificates]# rpm -qf /usr/bin/ecryptfsd</font></div><div><font size="2"   >ecryptfs-utils-75-5.el5</font></div><p></p></pre></div><div>包含如下文件 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 ca-certificates]# rpm -ql ecryptfs-utils-75-5.el5</font></div><div><font size="2"   >/lib64/security/pam_ecryptfs.so</font></div><div><font size="2"   >/sbin/mount.ecryptfs</font></div><div><font size="2"   >/sbin/mount.ecryptfs_private</font></div><div><font size="2"   >/sbin/umount.ecryptfs</font></div><div><font size="2"   >/sbin/umount.ecryptfs_private</font></div><div><font size="2"   >/usr/bin/ecryptfs-add-passphrase</font></div><div><font size="2"   >/usr/bin/ecryptfs-dot-private</font></div><div><font size="2"   >/usr/bin/ecryptfs-generate-tpm-key</font></div><div><font size="2"   >/usr/bin/ecryptfs-insert-wrapped-passphrase-into-keyring</font></div><div><font size="2"   >/usr/bin/ecryptfs-manager</font></div><div><font size="2"   >/usr/bin/ecryptfs-mount-private</font></div><div><font size="2"   >/usr/bin/ecryptfs-rewrap-passphrase</font></div><div><font size="2"   >/usr/bin/ecryptfs-rewrite-file</font></div><div><font size="2"   >/usr/bin/ecryptfs-setup-private</font></div><div><font size="2"   >/usr/bin/ecryptfs-setup-swap</font></div><div><font size="2"   >/usr/bin/ecryptfs-stat</font></div><div><font size="2"   >/usr/bin/ecryptfs-umount-private</font></div><div><font size="2"   >/usr/bin/ecryptfs-unwrap-passphrase</font></div><div><font size="2"   >/usr/bin/ecryptfs-wrap-passphrase</font></div><div><font size="2"   >/usr/bin/ecryptfsd</font></div><div><font size="2"   >/usr/lib64/ecryptfs</font></div><div><font size="2"   >/usr/lib64/ecryptfs/libecryptfs_key_mod_openssl.so</font></div><div><font size="2"   >/usr/lib64/ecryptfs/libecryptfs_key_mod_passphrase.so</font></div><div><font size="2"   >/usr/lib64/ecryptfs/libecryptfs_key_mod_tspi.so</font></div><div><font size="2"   >/usr/lib64/libecryptfs.so.0</font></div><div><font size="2"   >/usr/lib64/libecryptfs.so.0.0.0</font></div><div><font size="2"   >/usr/share/doc/ecryptfs-utils-75</font></div><div><font size="2"   >/usr/share/doc/ecryptfs-utils-75/AUTHORS</font></div><div><font size="2"   >/usr/share/doc/ecryptfs-utils-75/COPYING</font></div><div><font size="2"   >/usr/share/doc/ecryptfs-utils-75/NEWS</font></div><div><font size="2"   >/usr/share/doc/ecryptfs-utils-75/README</font></div><div><font size="2"   >/usr/share/doc/ecryptfs-utils-75/THANKS</font></div><div><font size="2"   >/usr/share/doc/ecryptfs-utils-75/ecryptfs-faq.html</font></div><div><font size="2"   >/usr/share/doc/ecryptfs-utils-75/ecryptfs-pam-doc.txt</font></div><div><font size="2"   >/usr/share/ecryptfs-utils</font></div><div><font size="2"   >/usr/share/ecryptfs-utils/ecryptfs-mount-private.desktop</font></div><div><font size="2"   >/usr/share/ecryptfs-utils/ecryptfs-mount-private.txt</font></div><div><font size="2"   >/usr/share/ecryptfs-utils/ecryptfs-setup-private.desktop</font></div><div><font size="2"   >/usr/share/ecryptfs-utils/ecryptfs-utils.png</font></div><div><font size="2"   >/usr/share/man/man1/ecryptfs-add-passphrase.1.gz</font></div><div><font size="2"   >/usr/share/man/man1/ecryptfs-generate-tpm-key.1.gz</font></div><div><font size="2"   >/usr/share/man/man1/ecryptfs-insert-wrapped-passphrase-into-keyring.1.gz</font></div><div><font size="2"   >/usr/share/man/man1/ecryptfs-mount-private.1.gz</font></div><div><font size="2"   >/usr/share/man/man1/ecryptfs-rewrap-passphrase.1.gz</font></div><div><font size="2"   >/usr/share/man/man1/ecryptfs-rewrite-file.1.gz</font></div><div><font size="2"   >/usr/share/man/man1/ecryptfs-setup-private.1.gz</font></div><div><font size="2"   >/usr/share/man/man1/ecryptfs-umount-private.1.gz</font></div><div><font size="2"   >/usr/share/man/man1/ecryptfs-unwrap-passphrase.1.gz</font></div><div><font size="2"   >/usr/share/man/man1/ecryptfs-wrap-passphrase.1.gz</font></div><div><font size="2"   >/usr/share/man/man1/mount.ecryptfs_private.1.gz</font></div><div><font size="2"   >/usr/share/man/man1/umount.ecryptfs_private.1.gz</font></div><div><font size="2"   >/usr/share/man/man7/ecryptfs.7.gz</font></div><div><font size="2"   >/usr/share/man/man8/ecryptfs-manager.8.gz</font></div><div><font size="2"   >/usr/share/man/man8/ecryptfsd.8.gz</font></div><div><font size="2"   >/usr/share/man/man8/mount.ecryptfs.8.gz</font></div><div><font size="2"   >/usr/share/man/man8/pam_ecryptfs.8.gz</font></div><p></p></pre></div></div><div><br></div><div>[使用举例]</div><div>1. 查看要加密的目录信息.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 ~]# df -h</font></div><div><div><font size="2"   >/dev/mapper/vgdata01-lv06</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;98G &nbsp;188M &nbsp; 93G &nbsp; 1% /mnt</font></div></div><div><font size="2"   >[root@db-172-16-3-33 ~]# mount</font></div><div><font size="2"   >/dev/mapper/vgdata01-lv06 on /mnt type ext4 (rw)</font></div><p></p></pre></div><div>新建将要加密的目录</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 ~]# cd /mnt</font></div><div><font size="2"   >[root@db-172-16-3-33 mnt]# mkdir enc_dir</font></div><p></p></pre></div><div>使用ecryptfs加载enc_dir目录</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 mnt]# mount -t ecryptfs /mnt/enc_dir /mnt/enc_dir</font></div><div><font size="2"   >Select key type to use for newly created files:&nbsp;</font></div><div><font size="2"   >&nbsp;1) openssl</font></div><div><font size="2"   >&nbsp;2) passphrase</font></div><div><font size="2"   >&nbsp;3) tspi</font></div><div><font size="2"   >选择2</font></div><div><font size="2"   >Selection: 2</font></div><div><font size="2"   >输入passphrase, 这里为 digoal</font></div><div><font size="2"   >Passphrase:&nbsp;</font></div><div><font size="2"   >Select cipher:&nbsp;</font></div><div><font size="2"   >&nbsp;1) aes: blocksize = 16; min keysize = 16; max keysize = 32 (loaded)</font></div><div><font size="2"   >&nbsp;2) blowfish: blocksize = 8; min keysize = 4; max keysize = 56 (loaded)</font></div><div><font size="2"   >&nbsp;3) des3_ede: blocksize = 8; min keysize = 24; max keysize = 24 (not loaded)</font></div><div><font size="2"   >&nbsp;4) twofish: blocksize = 16; min keysize = 16; max keysize = 32 (not loaded)</font></div><div><font size="2"   >&nbsp;5) cast6: blocksize = 16; min keysize = 16; max keysize = 32 (not loaded)</font></div><div><font size="2"   >&nbsp;6) cast5: blocksize = 8; min keysize = 5; max keysize = 16 (not loaded)</font></div><div><font size="2"   >选择blowfish加密暗语</font></div><div><font size="2"   >Selection [aes]: 2</font></div><div><font size="2"   >Select key bytes:&nbsp;</font></div><div><font size="2"   >&nbsp;1) 16</font></div><div><font size="2"   >&nbsp;2) 32</font></div><div><font size="2"   >选择key size, 32</font></div><div><font size="2"   >Selection [16]: 32</font></div><div><font size="2"   >不允许明文直通 :&nbsp;</font></div><div><font size="2"   >Enable plaintext passthrough (y/n) [n]:&nbsp;</font></div><div><font size="2"   >Attempting to mount with the following options:</font></div><div><font size="2"   >&nbsp; ecryptfs_unlink_sigs</font></div><div><font size="2"   >&nbsp; ecryptfs_key_bytes=32</font></div><div><font size="2"   >&nbsp; ecryptfs_cipher=blowfish</font></div><div><font size="2"   >&nbsp; ecryptfs_sig=3f929d58007626f7</font></div><div><font size="2"   >WARNING: Based on the contents of [/root/.ecryptfs/sig-cache.txt],</font></div><div><font size="2"   >it looks like you have never mounted with this key&nbsp;</font></div><div><font size="2"   >before. This could mean that you have typed your&nbsp;</font></div><div><font size="2"   >passphrase wrong.</font></div><div><font size="2"   >这个警告是因为我前面测试过, 以及加载过一次并且密码与本次不一致.&nbsp;</font></div><div><font size="2"   >这里忽略掉.</font></div><div><font size="2"   >Would you like to proceed with the mount (yes/no)? : yes</font></div><div><font size="2"   >Would you like to append sig [3f929d58007626f7] to</font></div><div><font size="2"   >[/root/.ecryptfs/sig-cache.txt]&nbsp;</font></div><div><font size="2"   >#输入yes 忽略告警.</font></div><div><font size="2"   >in order to avoid this warning in the future (yes/no)? : yes</font></div><div><font size="2"   >Successfully appended new sig to user sig cache file</font></div><div><font size="2"   >Mounted eCryptfs</font></div><p></p></pre></div><div>查看加载信息</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 mnt]# mount</font></div><div><div><font size="2"   >/dev/mapper/vgdata01-lv06 on /mnt type ext4 (rw)</font></div><div><font size="2"   >/mnt/enc_dir on /mnt/enc_dir type ecryptfs (rw,ecryptfs_sig=3f929d58007626f7,ecryptfs_cipher=blowfish,ecryptfs_key_bytes=32,ecryptfs_unlink_sigs)</font></div></div><p></p></pre></div><div><br></div><div>拷贝一个文本文件到加密目录中</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 mnt]# cd /mnt/enc_dir/</font></div><div><font size="2"   >[root@db-172-16-3-33 enc_dir]# ll</font></div><div><font size="2"   >total 0</font></div><div><font size="2"   >[root@db-172-16-3-33 enc_dir]# cp /var/log/messages ./</font></div><p></p></pre></div><div>查看加密文件内容, 正常</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 enc_dir]# head -n 1 messages&nbsp;</font></div><div><font size="2"   >May 19 04:02:02 db-172-16-3-33 syslogd 1.4.1: restart.</font></div><p></p></pre></div><div><br></div><div>测试IO能力, 加密后不支持open_sync函数.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 enc_dir]# mkdir pg92</font></div><div><font size="2"   >[root@db-172-16-3-33 enc_dir]# chown pg92:pg92 pg92</font></div><div><font size="2"   >[root@db-172-16-3-33 enc_dir]# su - pg92</font></div><div><font size="2"   >pg92@db-172-16-3-33-&gt; cd /mnt/enc_dir/pg92/</font></div><div><font size="2"   >pg92@db-172-16-3-33-&gt; pg_test_fsync&nbsp;</font></div><div><font size="2"   >2 seconds per test</font></div><div><font size="2"   >O_DIRECT supported on this platform for open_datasync and open_sync.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Compare file sync methods using one 16kB write:</font></div><div><font size="2"   >(in wal_sync_method preference order, except fdatasync</font></div><div><font size="2"   >is Linux's default)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open_datasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n/a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3986.130 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fsync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2397.359 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fsync_writethrough &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;n/a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open_sync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;n/a*</font></div><div><font size="2"   >* This file system and its mount options do not support direct</font></div><div><font size="2"   >I/O, e.g. ext4 in journaled mode.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Compare file sync methods using two 16kB writes:</font></div><div><font size="2"   >(in wal_sync_method preference order, except fdatasync</font></div><div><font size="2"   >is Linux's default)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open_datasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n/a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2001.979 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fsync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1225.326 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fsync_writethrough &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;n/a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open_sync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;n/a*</font></div><div><font size="2"   >* This file system and its mount options do not support direct</font></div><div><font size="2"   >I/O, e.g. ext4 in journaled mode.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Compare open_sync with different write sizes:</font></div><div><font size="2"   >(This is designed to compare the cost of writing 16kB</font></div><div><font size="2"   >in different write open_sync sizes.)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 * 16kB open_sync write &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;n/a*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 * &nbsp;8kB open_sync writes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n/a*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 * &nbsp;4kB open_sync writes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n/a*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8 * &nbsp;2kB open_sync writes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n/a*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16 * &nbsp;1kB open_sync writes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n/a*</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Test if fsync on non-write file descriptor is honored:</font></div><div><font size="2"   >(If the times are similar, fsync() can sync data written</font></div><div><font size="2"   >on a different descriptor.)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; write, fsync, close &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2360.739 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; write, close, fsync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2391.995 ops/sec</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Non-Sync'ed 16kB writes:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; write &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3958.411 ops/sec</font></div><p></p></pre></div><div><br></div><div>卸载加密目录 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 enc_dir]# cd</font></div><div><font size="2"   >[root@db-172-16-3-33 ~]# umount /mnt/enc_dir</font></div><p></p></pre></div><div>卸载后文件无法查看 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 ~]# cd /mnt/enc_dir/</font></div><div><font size="2"   >[root@db-172-16-3-33 enc_dir]# ll</font></div><div><font size="2"   >total 380</font></div><div><font size="2"   >-rw------- 1 root root 385024 May 24 16:44 messages</font></div><div><font size="2"   >drwxr-xr-x 2 pg92 pg92 &nbsp; 4096 May 24 16:45 pg92</font></div><div><font size="2"   >[root@db-172-16-3-33 enc_dir]# less messages&nbsp;</font></div><div><font size="2"   >"messages" may be a binary file. &nbsp;See it anyway?&nbsp;</font></div><p></p></pre></div><div>卸载后的io能力测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 enc_dir]# su - pg92</font></div><div><font size="2"   >pg92@db-172-16-3-33-&gt; cd /mnt/enc_dir/pg92/</font></div><div><font size="2"   >pg92@db-172-16-3-33-&gt; pg_test_fsync&nbsp;</font></div><div><font size="2"   >2 seconds per test</font></div><div><font size="2"   >O_DIRECT supported on this platform for open_datasync and open_sync.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Compare file sync methods using one 16kB write:</font></div><div><font size="2"   >(in wal_sync_method preference order, except fdatasync</font></div><div><font size="2"   >is Linux's default)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open_datasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n/a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3082.643 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fsync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 114.960 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fsync_writethrough &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;n/a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open_sync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3089.237 ops/sec</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Compare file sync methods using two 16kB writes:</font></div><div><font size="2"   >(in wal_sync_method preference order, except fdatasync</font></div><div><font size="2"   >is Linux's default)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open_datasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n/a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2154.410 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fsync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 115.433 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fsync_writethrough &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;n/a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open_sync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;81.961 ops/sec</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Compare open_sync with different write sizes:</font></div><div><font size="2"   >(This is designed to compare the cost of writing 16kB</font></div><div><font size="2"   >in different write open_sync sizes.)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 * 16kB open_sync write &nbsp; &nbsp; &nbsp; &nbsp;3122.809 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 * &nbsp;8kB open_sync writes &nbsp; &nbsp; &nbsp; &nbsp; 83.105 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 * &nbsp;4kB open_sync writes &nbsp; &nbsp; &nbsp; &nbsp; 75.897 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8 * &nbsp;2kB open_sync writes &nbsp; &nbsp; &nbsp; &nbsp; 75.738 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16 * &nbsp;1kB open_sync writes &nbsp; &nbsp; &nbsp; &nbsp; 66.626 ops/sec</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Test if fsync on non-write file descriptor is honored:</font></div><div><font size="2"   >(If the times are similar, fsync() can sync data written</font></div><div><font size="2"   >on a different descriptor.)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; write, fsync, close &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 128.490 ops/sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; write, close, fsync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 136.747 ops/sec</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Non-Sync'ed 16kB writes:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; write &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 152942.311 ops/sec</font></div><p></p></pre></div><div>对比加密前后的数据, 加密后sync反而比加密前的iops要高, 但是加密后的non-sync却低得一塌糊涂, 几乎和sync相当.</div><div>猜测加密后sync做了cache处理, 并没有直接到达硬盘, 另外就是加密后确实性能差了很多, 因为non-sync的数字基本说明了加密后的iops瓶颈是cpu处理加密了.</div><div><br></div><div>[自动加载配置 : ]</div><div>1. 创建密码文件, 修改权限</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-33 ~]# vi /root/.pwd1&nbsp;</font></div><div><font size="2"   >passphrase_passwd=digoal</font></div></div><div><font size="2"   >[root@db-172-16-3-33 ~]# chmod 400 /root/.pwd1&nbsp;</font></div><p></p></pre></div><div>2. 配置profile</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 ~]# vi ~/.ecryptfsrc</font></div><div><div><font size="2"   >key=passphrase:passphrase_passwd_file=/root/.pwd1</font></div><div><font size="2"   >ecryptfs_sig=3f929d58007626f7</font></div><div><font size="2"   >ecryptfs_cipher=blowfish</font></div><div><font size="2"   >ecryptfs_key_bytes=32</font></div><div><font size="2"   >ecryptfs_passthrough=n</font></div><div><font size="2"   >ecryptfs_enable_filename_crypto=n</font></div></div><p></p></pre></div><div>其中这些配置取自创建ecryptfs时配置或生成的值. sig可以从~/.ecryptfs/sig-cache.txt中取到或者在创建时最后也会输出这个值.</div><div>3. 配置fstab</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 ~]# vi /etc/fstab</font></div><div><font size="2"   >/mnt/enc_dir /mnt/enc_dir ecryptfs defaults,noatime,nodiratime 0 0</font></div><p></p></pre></div><div>4. 测试mount</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-33 ~]# mount -a</font></div><div><font size="2"   >Attempting to mount with the following options:</font></div><div><font size="2"   >&nbsp; ecryptfs_unlink_sigs</font></div><div><font size="2"   >&nbsp; ecryptfs_key_bytes=32</font></div><div><font size="2"   >&nbsp; ecryptfs_cipher=blowfish</font></div><div><font size="2"   >&nbsp; ecryptfs_sig=3f929d58007626f7</font></div><div><font size="2"   >Mounted eCryptfs</font></div></div><div><div><font size="2"   >[root@db-172-16-3-33 ~]# df -h</font></div><div><font size="2"   >Filesystem &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Size &nbsp;Used Avail Use% Mounted on</font></div><div><font size="2"   >/dev/cciss/c0d0p1 &nbsp; &nbsp; &nbsp;29G &nbsp; 16G &nbsp; 12G &nbsp;56% /</font></div><div><font size="2"   >tmpfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 6.9G &nbsp; &nbsp; 0 &nbsp;6.9G &nbsp; 0% /dev/shm</font></div><div><font size="2"   >/dev/mapper/vgdata01-lv03</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 135G &nbsp; 25G &nbsp;104G &nbsp;20% /pgdata/digoal/1921/data03</font></div><div><font size="2"   >/dev/mapper/vgdata01-lv04</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 135G &nbsp; 69G &nbsp; 59G &nbsp;54% /pgdata/digoal/1921/data04</font></div><div><font size="2"   >/dev/mapper/vgdata01-lv05</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 135G &nbsp; 85G &nbsp; 44G &nbsp;66% /pgdata/digoal/1921/data05</font></div><div><font size="2"   >/dev/mapper/vgdata01-lv06</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;98G &nbsp;189M &nbsp; 93G &nbsp; 1% /mnt</font></div><div><font size="2"   >/mnt/enc_dir &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 98G &nbsp;189M &nbsp; 93G &nbsp; 1% /mnt/enc_dir</font></div></div><p></p></pre></div><div>加载成功.</div><div>注意保护好密码文件. 例如可以放在U盘中, 加载后把U盘拔掉.</div><div><br></div><div><span style="line-height: 22px;"   >[参考]</span></div><div>1.&nbsp;/usr/share/doc/ecryptfs-utils/ecryptfs-faq.html</div><div>2. man&nbsp;ecryptfs</div><div><br></div></div></div>
	</div>
</div>
</body>
</html>