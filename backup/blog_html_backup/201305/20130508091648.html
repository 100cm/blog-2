<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 Dramatically reduce System V shared memory requirements</h2>
	<h5 id="">2013-05-08 9:16:48&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020134885115102/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >Dramatically reduce System V shared memory requirements (Robert Haas)</font></div><div><font size="2"   >Instead, on Unix-like systems, mmap() is used for shared memory. For most users, this will eliminate the need to adjust kernel parameters for shared memory.</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >Dramatically reduce System V shared memory consumption.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Except when compiling with EXEC_BACKEND, we'll now allocate only a tiny</font></div><div><font size="2"   >amount of System V shared memory (as an interlock to protect the data</font></div><div><font size="2"   >directory) and allocate the rest as anonymous shared memory via mmap.</font></div><div><font size="2"   >This will hopefully spare most users the hassle of adjusting operating</font></div><div><font size="2"   >system parameters before being able to start PostgreSQL with a</font></div><div><font size="2"   >reasonable value for shared_buffers.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >There are a bunch of documentation updates needed here, and we might</font></div><div><font size="2"   >need to adjust some of the HINT messages related to shared memory as</font></div><div><font size="2"   >well. &nbsp;But it's not 100% clear how portable this is, so before we</font></div><div><font size="2"   >write the documentation, let's give it a spin on the buildfarm and</font></div><div><font size="2"   >see what turns red.</font></div><p></p></pre></div><div>如果没有设置EXEC_BACKEND宏(默认未设置), PostgreSQL 9.3启动时需要更少的共享内存, 因此即使配置了较大的shared_buffers, 大多数情况下也不需要调整内核, 数据库也可以起来.</div><div>以前的版本, 数据库启动时就会申请shared_buffers设置的内存, 所以数据库启动时就需要设置好内核.</div><div><br></div><div>[测试]</div><div>PostgreSQL 9.3 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi postgresql.conf</font></div><div><font size="2"   >shared_buffers = 1024MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div><font size="2"   >pg_ctl start</font></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; ipcs -m</font></div><div><font size="2"   >------ Shared Memory Segments --------</font></div><div><font size="2"   >key &nbsp; &nbsp; &nbsp; &nbsp;shmid &nbsp; &nbsp; &nbsp;owner &nbsp; &nbsp; &nbsp;perms &nbsp; &nbsp; &nbsp;bytes &nbsp; &nbsp; &nbsp;nattch &nbsp; &nbsp; status &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >0x001e8099 4292610 &nbsp; &nbsp;pg93 &nbsp; &nbsp; &nbsp;600 &nbsp; &nbsp; &nbsp; &nbsp;48 &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp;&nbsp;</font></div></div></pre></div><div>PostgreSQL 9.2 :&nbsp;</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 22px;"   ><font size="2"   >vi postgresql.conf</font></div><div style="line-height: 22px;"   ><font size="2"   >shared_buffers = 1024MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div style="line-height: 22px;"   ><font size="2"   >pg_ctl start</font></div></div><div><div><font size="2"   >pg92@db-172-16-3-33-&gt; ipcs -m</font></div><div><font size="2"   >------ Shared Memory Segments --------</font></div><div><font size="2"   >key &nbsp; &nbsp; &nbsp; &nbsp;shmid &nbsp; &nbsp; &nbsp;owner &nbsp; &nbsp; &nbsp;perms &nbsp; &nbsp; &nbsp;bytes &nbsp; &nbsp; &nbsp;nattch &nbsp; &nbsp; status &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >0x001d4819 4390916 &nbsp; &nbsp;pg92 &nbsp; &nbsp; &nbsp;600 &nbsp; &nbsp; &nbsp; &nbsp;1163427840 4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div></div><div></div><p></p></pre></div></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/kernel-resources.html#SYSVIPC"   >http://www.postgresql.org/docs/devel/static/kernel-resources.html#SYSVIPC</a></div><div>2.&nbsp;src/backend/port/sysv_shmem.c</div><div>3.&nbsp;src/backend/port/pg_shmem.c</div><div>4.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=b0fc0df9364d2d2d17c0162cf3b8b59f6cb09f67"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=b0fc0df9364d2d2d17c0162cf3b8b59f6cb09f67</a></div></div>
	</div>
</div>
</body>
</html>