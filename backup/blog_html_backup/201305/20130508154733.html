<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 Allow a streaming replication standby to follow a timeline switch</h2>
	<h5 id="">2013-05-08 15:47:33&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013482399908/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Allow a streaming replication standby to follow a timeline switch.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Before this patch, streaming replication would refuse to start replicating</font></div><div><font size="2"   >if the timeline in the primary doesn't exactly match the standby. The</font></div><div><font size="2"   >situation where it doesn't match is when you have a master, and two</font></div><div><font size="2"   >standbys, and you promote one of the standbys to become new master.</font></div><div><font size="2"   >Promoting bumps up the timeline ID, and after that bump, the other standby</font></div><div><font size="2"   >would refuse to continue.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >There's significantly more timeline related logic in streaming replication</font></div><div><font size="2"   >now. First of all, when a standby connects to primary, it will ask the</font></div><div><font size="2"   >primary for any timeline history files that are missing from the standby.</font></div><div><font size="2"   >The missing files are sent using a new replication command TIMELINE_HISTORY,</font></div><div><font size="2"   >and stored in standby's pg_xlog directory. Using the timeline history files,</font></div><div><font size="2"   >the standby can follow the latest timeline present in the primary</font></div><div><font size="2"   >(recovery_target_timeline='latest'), just as it can follow new timelines</font></div><div><font size="2"   >appearing in an archive directory.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >START_REPLICATION now takes a TIMELINE parameter, to specify exactly which</font></div><div><font size="2"   >timeline to stream WAL from. This allows the standby to request the primary</font></div><div><font size="2"   >to send over WAL that precedes the promotion. The replication protocol is</font></div><div><font size="2"   >changed slightly (in a backwards-compatible way although there's little hope</font></div><div><font size="2"   >of streaming replication working across major versions anyway), to allow</font></div><div><font size="2"   >replication to stop when the end of timeline reached, putting the walsender</font></div><div><font size="2"   >back into accepting a replication command.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Many thanks to Amit Kapila for testing and reviewing various versions of</font></div><div><font size="2"   >this patch.</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >PostgreSQL 9.3 对流复制协议进行了修改, 实现了通过流复制协议实现时间线文件的复制. 非常适合用在角色切换以及多standby的环境.</span></div><div>以前流复制协议并不支持复制时间线文件, 所以每当切换角色后, 都需要手工复制这个文件到standby中.</div><div>具体的实现见本文参考部分.</div><div><br></div><div>[测试]</div><div>一. PostgreSQL 9.2 :&nbsp;</div><div>1.建立standby</div><div>主库参数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >$PGDATA :&nbsp;/pgdata1919</font></div><div><font size="2"   >no other tablespace.</font></div></pre></div><div>postgresql.conf</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"   >port = 1919 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >max_connections = 100 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >superuser_reserved_connections = 13 &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_directory = '.' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_permissions = 0700 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# begin with 0 to use octal notation</font></div><div><font size="2"   >shared_buffers = 1024MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div><font size="2"   >wal_level = hot_standby &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, or hot_standby</font></div><div><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level;</font></div><div><font size="2"   >wal_sync_method = fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # the default is the first option</font></div><div><font size="2"   >wal_buffers = 16384kB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 32kB, -1 sets based on shared_buffers</font></div><div><font size="2"   >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"   >checkpoint_segments = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# in logfile segments, min 1, 16MB each</font></div><div><font size="2"   >archive_mode = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # allows archiving to be done</font></div><div><font size="2"   >archive_command = '/bin/date' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # command to use to archive a logfile segment</font></div><div><font size="2"   >max_wal_senders = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of walsender processes</font></div><div><font size="2"   >wal_keep_segments = 64 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# in logfile segments, 16MB each; 0 disables</font></div><div><font size="2"   >hot_standby = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# "on" allows queries during recovery</font></div><div><font size="2"   >max_standby_archive_delay = 300s &nbsp; &nbsp; &nbsp; &nbsp;# max delay before canceling queries</font></div><div><font size="2"   >max_standby_streaming_delay = 300s &nbsp; &nbsp; &nbsp;# max delay before canceling queries</font></div><div><font size="2"   >wal_receiver_status_interval = 1s &nbsp; &nbsp; &nbsp; # send replies at least this often</font></div><div><font size="2"   >hot_standby_feedback = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # send info from standby to prevent</font></div><div><font size="2"   >random_page_cost = 2.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# same scale as above</font></div><div><font size="2"   >effective_cache_size = 8192MB</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_directory = 'pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,</font></div><div><font size="2"   >log_file_mode = 0600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# creation mode for log files,</font></div><div><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div><font size="2"   >log_rotation_age = 1d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Automatic rotation of logfiles will</font></div><div><font size="2"   >log_rotation_size = 10MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Automatic rotation of logfiles will</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_disconnections = on</font></div><div><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div><font size="2"   >log_timezone = 'PRC'</font></div><div><font size="2"   >autovacuum = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Enable autovacuum subprocess? &nbsp;'on'</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >timezone = 'PRC'</font></div><div><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><div><font size="2"   >standard_conforming_strings = off</font></div><p></p></pre></div><div><br></div><div>recovery.done</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >recovery_target_timeline = 'latest'</font></div><div><font size="2"   >standby_mode = on</font></div><div><font size="2"   >primary_conninfo = 'host=127.0.0.1 port=11919 user=postgres keepalives_idle=60' &nbsp; &nbsp; &nbsp; &nbsp; # e.g. 'host=localhost port=5432'</font></div></pre></div><div>pg_hba.conf</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >local &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trust</font></div><div><font size="2"   >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div><div><font size="2"   >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ::1/128 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trust</font></div><div><div><font size="2"   >local &nbsp; replication &nbsp; &nbsp; postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div><div><font size="2"   >host &nbsp; &nbsp;replication &nbsp; &nbsp; postgres &nbsp; &nbsp; &nbsp; &nbsp;127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div></div><div><font size="2"   >host all all 0.0.0.0/0 md5</font></div><p></p></pre></div><div><br></div><div>备库参数 :&nbsp;</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >$PGDATA :&nbsp;/pgdata11919</font></div><div style="line-height: 22px;"   ><font size="2"   >no other tablespace.</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><br></div><div><div style="line-height: 22px;"   >postgresql.conf</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >port = 11919 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   ># 其他与primary配置相同</font></span></div></pre></div><div style="line-height: 22px;"   >recovery.conf</div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >recovery_target_timeline = 'latest'</font></div><div style="line-height: 22px;"   ><font size="2"   >standby_mode = on</font></div><div style="line-height: 22px;"   ><font size="2"   >primary_conninfo = 'host=127.0.0.1 port=1919 user=postgres keepalives_idle=60' &nbsp; &nbsp; &nbsp; &nbsp; # e.g. 'host=localhost port=5432'</font></div></pre></div></div><div style="line-height: 22px;"   >pg_hba.conf</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >local &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trust</font></div><div style="line-height: 22px;"   ><font size="2"   >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div><div style="line-height: 22px;"   ><font size="2"   >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ::1/128 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trust</font></div><div><div><font size="2"   >local &nbsp; replication &nbsp; &nbsp; postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div><div><font size="2"   >host &nbsp; &nbsp;replication &nbsp; &nbsp; postgres &nbsp; &nbsp; &nbsp; &nbsp;127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div></div><div style="line-height: 22px;"   ><font size="2"   >host all all 0.0.0.0/0 md5</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >启动主库和备库后, 确定正常复制.</div><div style="line-height: 22px;"   >pg_ctl start -D /pgdata1919</div><div style="line-height: 22px;"   >pg_ctl start -D /pgdata11919</div><div style="line-height: 22px;"   >ps -ewf|grep pg92</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92 &nbsp; &nbsp; 11644 &nbsp; &nbsp; 1 &nbsp;0 15:27 pts/1 &nbsp; &nbsp;00:00:00 /opt/pgsql9.2.4/bin/postgres</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 11645 11644 &nbsp;0 15:27 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: logger process &nbsp; &nbsp;</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 11647 11644 &nbsp;0 15:27 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp;&nbsp;</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 11648 11644 &nbsp;0 15:27 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp; &nbsp;</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 11649 11644 &nbsp;0 15:27 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal writer process &nbsp;&nbsp;</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 11650 11644 &nbsp;0 15:27 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum launcher process &nbsp;&nbsp;</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 11651 11644 &nbsp;0 15:27 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: archiver process &nbsp;&nbsp;</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 11652 11644 &nbsp;0 15:27 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process &nbsp;&nbsp;</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 11658 &nbsp; &nbsp; 1 &nbsp;0 15:27 pts/1 &nbsp; &nbsp;00:00:00 /opt/pgsql9.2.4/bin/postgres -D /pgdata11919</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 11659 11658 &nbsp;0 15:27 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: logger process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 11660 11658 &nbsp;0 15:27 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: startup process &nbsp; recovering 0000000100000001000000A1</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 11661 11658 &nbsp;0 15:27 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 11662 11658 &nbsp;0 15:27 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 11663 11658 &nbsp;0 15:27 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 11729 11658 &nbsp;0 15:28 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal receiver process &nbsp; streaming 1/A10245E0</font></div><div><font size="2"   >pg92 &nbsp; &nbsp; 11730 11644 &nbsp;0 15:28 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal sender process postgres 127.0.0.1(61278) streaming 1/A10245E0</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div></div><div>2.正常关闭primary</div><div><pre class="prettyprint"   ><p><font size="2"   >pg_ctl stop -m fast -D /pgdata1919</font></p></pre></div><div><br></div><div>3.promote standby</div><div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg92@db-172-16-3-33-&gt; pg_ctl promote -D /pgdata11919</font></div><div><font size="2"   >server promoting</font></div></div><div></div><p></p></pre></div></div><div>4.将primary改成standby启动</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg92@db-172-16-3-33-&gt; cd /pgdata1919</font></div><div><font size="2"   >pg92@db-172-16-3-33-&gt; mv recovery.done recovery.conf</font></div></div><div><div><font size="2"   >pg92@db-172-16-3-33-&gt; pg_ctl start -D /pgdata1919</font></div><div><font size="2"   >server starting</font></div></div><p></p></pre></div><div>查看日志</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd /pgdata1919/pg_log</font></div><div><font size="2"   >2013-05-08 15:32:05.887 CST,,,11840,,5189ff75.2e40,1,,2013-05-08 15:32:05 CST,,0,FATAL,XX000,"timeline 2 of the primary does not match recovery target timeline 1",,,,,,,,"libpqrcv_connect, libpqwalreceiver.c:154",""</font></div><p></p></pre></div><div>需要手工将时间线文件拷贝到pg_xlog中.</div><div><pre class="prettyprint"   ><p><font size="2"   >pg92@db-172-16-3-33-&gt; cp /pgdata11919/pg_xlog/00000002.history /pgdata1919/pg_xlog/</font></p></pre></div><div>再次查看日志, 正常复制</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2013-05-08 15:33:20.884 CST,,,11763,,5189ff39.2df3,5,,2013-05-08 15:31:05 CST,1/0,0,LOG,00000,"new target timeline is 2",,,,,,,,"rescanLatestTimeLine, xlog.c:4644",""</font></div><div><font size="2"   >2013-05-08 15:33:21.177 CST,,,11876,,5189ffc0.2e64,1,,2013-05-08 15:33:20 CST,,0,LOG,00000,"streaming replication successfully connected to primary",,,,,,,,"libpqrcv_connect, libpqwalreceiver.c:171",""</font></div><div><font size="2"   >2013-05-08 15:33:21.372 CST,,,11763,,5189ff39.2df3,6,,2013-05-08 15:31:05 CST,1/0,0,LOG,00000,"redo starts at 1/A2000080",,,,,,,,"StartupXLOG, xlog.c:6817",""</font></div><p></p></pre></div><div><br></div><div>二. PostgreSQL 9.3 :&nbsp;</div><div><div style="line-height: 22px;"   >1.建立standby</div><div style="line-height: 22px;"   >主库参数 :&nbsp;</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >$PGDATA :&nbsp;/pgdata1999</font></div><div style="line-height: 22px;"   ><font size="2"   >no other tablespace.</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >postgresql.conf</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"   >port = 1999 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >max_connections = 100 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >superuser_reserved_connections = 13 &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_directories = '.' &nbsp; # comma-separated list of directories</font></div><div><font size="2"   >unix_socket_permissions = 0700 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# begin with 0 to use octal notation</font></div><div><font size="2"   >tcp_keepalives_idle = 60 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPIDLE, in seconds;</font></div><div><font size="2"   >tcp_keepalives_interval = 60 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPINTVL, in seconds;</font></div><div><font size="2"   >tcp_keepalives_count = 60 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # TCP_KEEPCNT;</font></div><div><font size="2"   >shared_buffers = 1024MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div><font size="2"   >max_stack_depth = 8MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 100kB</font></div><div><font size="2"   >wal_level = hot_standby &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, or hot_standby</font></div><div><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level;</font></div><div><font size="2"   >wal_sync_method = fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # the default is the first option</font></div><div><font size="2"   >wal_buffers = 16384kB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 32kB, -1 sets based on shared_buffers</font></div><div><font size="2"   >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"   >commit_delay = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # range 0-100000, in microseconds</font></div><div><font size="2"   >commit_siblings = 5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # range 1-1000</font></div><div><font size="2"   >checkpoint_segments = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# in logfile segments, min 1, 16MB each</font></div><div><font size="2"   >archive_mode = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # allows archiving to be done</font></div><div><font size="2"   >archive_command = '/bin/date' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # command to use to archive a logfile segment</font></div><div><font size="2"   >max_wal_senders = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of walsender processes</font></div><div><font size="2"   >wal_keep_segments = 64 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# in logfile segments, 16MB each; 0 disables</font></div><div><font size="2"   >hot_standby = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# "on" allows queries during recovery</font></div><div><font size="2"   >max_standby_archive_delay = 300s &nbsp; &nbsp; &nbsp; &nbsp;# max delay before canceling queries</font></div><div><font size="2"   >max_standby_streaming_delay = 300s &nbsp; &nbsp; &nbsp;# max delay before canceling queries</font></div><div><font size="2"   >wal_receiver_status_interval = 1s &nbsp; &nbsp; &nbsp; # send replies at least this often</font></div><div><font size="2"   >hot_standby_feedback = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # send info from standby to prevent</font></div><div><font size="2"   >random_page_cost = 2.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# same scale as above</font></div><div><font size="2"   >effective_cache_size = 8192MB</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_directory = 'pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,</font></div><div><font size="2"   >log_file_mode = 0600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# creation mode for log files,</font></div><div><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div><font size="2"   >log_rotation_age = 1d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Automatic rotation of logfiles will</font></div><div><font size="2"   >log_rotation_size = 10MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Automatic rotation of logfiles will</font></div><div><font size="2"   >client_min_messages = notice &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# values in order of decreasing detail:</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_disconnections = on</font></div><div><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div><font size="2"   >log_timezone = 'PRC'</font></div><div><font size="2"   >autovacuum = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Enable autovacuum subprocess? &nbsp;'on'</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >timezone = 'PRC'</font></div><div><font size="2"   >lc_messages = 'en_US.utf8' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for system error message</font></div><div><font size="2"   >lc_monetary = 'en_US.utf8' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'en_US.utf8' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for number formatting</font></div><div><font size="2"   >lc_time = 'en_US.utf8' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >recovery.done</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >recovery_target_timeline = 'latest'</font></div><div><font size="2"   >standby_mode = on</font></div><div><font size="2"   >primary_conninfo = 'host=127.0.0.1 port=11999 user=postgres keepalives_idle=60' &nbsp; &nbsp; &nbsp; &nbsp; # e.g. 'host=localhost port=5432'</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >pg_hba.conf</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >local &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trust</font></div><div><font size="2"   >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div><div><font size="2"   >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ::1/128 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trust</font></div><div><font size="2"   >local &nbsp; replication &nbsp; &nbsp; postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div><div><font size="2"   >host &nbsp; &nbsp;replication &nbsp; &nbsp; postgres &nbsp; &nbsp; &nbsp; &nbsp;127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div><div><font size="2"   >host all all 0.0.0.0/0 md5</font></div><p></p></pre></div><div><br></div><div style="line-height: 22px;"   >备库参数 :&nbsp;</div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >$PGDATA :&nbsp;/pgdata11999</font></div><div style="line-height: 22px;"   ><font size="2"   >no other tablespace.</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >postgresql.conf</span></div></div><div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >port = 11999 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   ># 其他与primary配置相同</font></span></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >recovery.conf</span></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >recovery_target_timeline = 'latest'</font></div><div><font size="2"   >standby_mode = on</font></div><div><font size="2"   >primary_conninfo = 'host=127.0.0.1 port=1999 user=postgres keepalives_idle=60' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# e.g. 'host=localhost port=5432'</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >pg_hba.conf</span></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >local &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trust</font></div><div><font size="2"   >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div><div><font size="2"   >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ::1/128 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trust</font></div><div><font size="2"   >local &nbsp; replication &nbsp; &nbsp; postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div><div><font size="2"   >host &nbsp; &nbsp;replication &nbsp; &nbsp; postgres &nbsp; &nbsp; &nbsp; &nbsp;127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div><div><font size="2"   >host all all 0.0.0.0/0 md5</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >启动主库和备库后, 确定正常复制.</span></div><div><div style="line-height: 22px;"   >pg_ctl start -D /pgdata1999</div><div style="line-height: 22px;"   >pg_ctl start -D /pgdata11999</div><div style="line-height: 22px;"   >ps -ewf|grep pg93</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93 &nbsp; &nbsp; 12122 &nbsp; &nbsp; 1 &nbsp;0 15:39 pts/1 &nbsp; &nbsp;00:00:00 /opt/pgsql9.3/bin/postgres</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12123 12122 &nbsp;0 15:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: logger process &nbsp;&nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12125 12122 &nbsp;0 15:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp;&nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12126 12122 &nbsp;0 15:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp;&nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12127 12122 &nbsp;0 15:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal writer process &nbsp;&nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12128 12122 &nbsp;0 15:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum launcher process &nbsp;&nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12129 12122 &nbsp;0 15:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: archiver process &nbsp;&nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12130 12122 &nbsp;0 15:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process &nbsp;&nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12135 &nbsp; &nbsp; 1 &nbsp;0 15:39 pts/1 &nbsp; &nbsp;00:00:00 /opt/pgsql9.3/bin/postgres -D /pgdata11999</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12136 12135 &nbsp;0 15:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: logger process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12137 12135 &nbsp;0 15:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: startup process &nbsp; recovering 000000010000000200000050</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12138 12135 &nbsp;0 15:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12139 12135 &nbsp;0 15:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12140 12135 &nbsp;0 15:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12141 12135 &nbsp;0 15:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal receiver process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12142 12122 &nbsp;0 15:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal sender process postgres 127.0.0.1(9639) streaming 2/50000090</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><br></div></div><div style="line-height: 22px;"   >2.正常关闭primary</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_ctl stop -m fast -D /pgdata1999</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >3.promote standby</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_ctl promote -D /pgdata11999</font></div><div><font size="2"   >server promoting</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >4.将primary改成standby启动</span></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd /pgdata1999</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; mv recovery.done recovery.conf</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_ctl start</font></div><div><font size="2"   >server starting</font></div><p></p></pre></div><div>查看日志, 时间线文件已经自动获取了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; cd pg_log</font></div><div><div><font size="2"   >2013-05-08 15:43:07.089 CST,,,12196,,518a020b.2fa4,1,,2013-05-08 15:43:07 CST,,0,LOG,00000,"database system was shut down at 2013-05-08 15:42:38 CST",,,,,,,,"StartupXLOG, xlog.c:4885",""</font></div><div><font size="2"   >2013-05-08 15:43:07.089 CST,,,12196,,518a020b.2fa4,2,,2013-05-08 15:43:07 CST,,0,LOG,00000,"entering standby mode",,,,,,,,"StartupXLOG, xlog.c:4958",""</font></div><div><font size="2"   >2013-05-08 15:43:07.098 CST,,,12196,,518a020b.2fa4,3,,2013-05-08 15:43:07 CST,1/0,0,LOG,00000,"consistent recovery state reached at 2/51000090",,,,,,,,"CheckRecoveryConsistency, xlog.c:6175",""</font></div><div><font size="2"   >2013-05-08 15:43:07.098 CST,,,12196,,518a020b.2fa4,4,,2013-05-08 15:43:07 CST,1/0,0,LOG,00000,"record with zero length at 2/51000090",,,,,,,,"ReadRecord, xlog.c:3283",""</font></div><div><font size="2"   >2013-05-08 15:43:07.099 CST,,,12194,,518a020a.2fa2,1,,2013-05-08 15:43:06 CST,,0,LOG,00000,"database system is ready to accept read only connections",,,,,,,,"sigusr1_handler, postmaster.c:4656",""</font></div><div><font size="2"   >2013-05-08 15:43:07.102 CST,,,12200,,518a020b.2fa8,1,,2013-05-08 15:43:07 CST,,0,LOG,00000,"fetching timeline history file for timeline 2 from primary server",,,,,,,,"WalRcvFetchTimeLineHistoryFiles, walreceiver.c:660",""</font></div><div><font size="2"   >2013-05-08 15:43:07.128 CST,,,12200,,518a020b.2fa8,2,,2013-05-08 15:43:07 CST,,0,LOG,00000,"started streaming WAL from primary at 2/51000000 on timeline 1",,,,,,,,"WalReceiverMain, walreceiver.c:365",""</font></div><div><font size="2"   >2013-05-08 15:43:07.128 CST,,,12200,,518a020b.2fa8,3,,2013-05-08 15:43:07 CST,,0,LOG,00000,"replication terminated by primary server","End of WAL reached on timeline 1 at 2/51000090",,,,,,,"WalReceiverMain, walreceiver.c:438",""</font></div><div><font size="2"   >2013-05-08 15:43:07.128 CST,,,12196,,518a020b.2fa4,5,,2013-05-08 15:43:07 CST,1/0,0,LOG,00000,"new target timeline is 2",,,,,,,,"rescanLatestTimeLine, xlog.c:3455",""</font></div><div><font size="2"   >2013-05-08 15:43:07.128 CST,,,12200,,518a020b.2fa8,4,,2013-05-08 15:43:07 CST,,0,LOG,00000,"restarted WAL streaming at 2/51000000 on timeline 2",,,,,,,,"WalReceiverMain, walreceiver.c:370",""</font></div><div><font size="2"   >2013-05-08 15:43:07.303 CST,,,12196,,518a020b.2fa4,6,,2013-05-08 15:43:07 CST,1/0,0,LOG,00000,"redo starts at 2/51000090",,,,,,,,"StartupXLOG, xlog.c:5524",""</font></div></div><p></p></pre></div><div>数据库进程正常</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93 &nbsp; &nbsp; 12135 &nbsp; &nbsp; 1 &nbsp;0 15:39 pts/1 &nbsp; &nbsp;00:00:00 /opt/pgsql9.3/bin/postgres -D /pgdata11999</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12136 12135 &nbsp;0 15:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: logger process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12138 12135 &nbsp;0 15:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12139 12135 &nbsp;0 15:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12140 12135 &nbsp;0 15:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12179 12135 &nbsp;0 15:42 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal writer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12180 12135 &nbsp;0 15:42 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum launcher process &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12181 12135 &nbsp;0 15:42 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: archiver process &nbsp; last was 00000002.history</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12194 &nbsp; &nbsp; 1 &nbsp;0 15:43 pts/1 &nbsp; &nbsp;00:00:00 /opt/pgsql9.3/bin/postgres</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12195 12194 &nbsp;0 15:43 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: logger process &nbsp;&nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12196 12194 &nbsp;0 15:43 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: startup process &nbsp; recovering 000000020000000200000051</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12197 12194 &nbsp;0 15:43 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp;&nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12198 12194 &nbsp;0 15:43 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp;&nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12199 12194 &nbsp;0 15:43 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process &nbsp;&nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12200 12194 &nbsp;0 15:43 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal receiver process &nbsp; streaming 2/5100EC10</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12201 12135 &nbsp;0 15:43 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal sender process postgres 127.0.0.1(61597) streaming 2/5100EC10</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 12211 12135 &nbsp;0 15:43 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum worker process &nbsp; postgres</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=abfd192b1b5ba5216ac4b1f31dcd553106304b19"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=abfd192b1b5ba5216ac4b1f31dcd553106304b19</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/protocol-replication.html"   >http://www.postgresql.org/docs/devel/static/protocol-replication.html</a></div><div>流复制协议新增了TIMELINE_HISTORY 命令, 同时对START_REPLICATION命令做了修改支持TIMELINE参数.</div><div><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >TIMELINE_HISTORY tli</font></div><div><font size="2"   >Requests the server to send over the timeline history file for timeline tli. Server replies with a result set of a single row, containing two fields:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >filename</font></div><div><font size="2"   >Filename of the timeline history file, e.g 00000002.history.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >content</font></div><div><font size="2"   >Contents of the timeline history file.</font></div><div><font size="2"   ><br></font></div><div><span style="line-height: 19px; font-size: small; font-family: Arial, Helvetica, sans-serif;"   >START_REPLICATION XXX/XXX TIMELINE tli</span></div><p></p></pre></div><p></p></div><div>3.&nbsp;src/backend/replication/walreceiver.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errmsg("fetching timeline history file for timeline %u from primary server",</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tli)));</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>