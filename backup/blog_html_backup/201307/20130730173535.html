<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL cursor in batch commit use case</h2>
	<h5 id="">2013-07-30 17:35:35&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201363052241230/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>一位网友问到的问题如下 :&nbsp;</div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Hello,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;德哥，我想请您请教一个关于postgresql批量提交方面的问题。&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;由于我们现在的项目是在从oracle转pg，所以遇到了很多oracle中曾经写批量提交方面的问题，</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;类似如下情况：</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;FOR c IN cur LOOP &nbsp; ---游标</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;--更新&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; UPDATE tbname s</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; SET col1 = now(),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; col2 = now(),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; col3 = to_char(SYSDATE, 'yyyymmdd') ,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; col4 = c.orgcode_temp</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; WHERE s.id = c.id;</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; --计算,每500提交一次</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; i := i + 1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; IF MOD(i, 500) = 0 THEN</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; COMMIT;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; END IF;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; IF MOD(i, 5000) = 0 THEN</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; dbms_lock.sleep(10);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; END IF;</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; END LOOP;</font></div><div><font size="2"   >&nbsp; &nbsp; COMMIT; --提交</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >类似这种的问题，现在想问问您，对于这种批量提交有什么好的方法吗？</font></div><p></p></pre></div><div><br></div><div>由于PostgreSQL函数在处理时是作为一个事务来处理的, 不能像Oracle那样在函数中使用commit做部分提交.&nbsp;</div><div>除非写在exception中, 那会回滚前面的非exception部分, 执行exception部分, 同样无法达到以上目的.</div><div><br></div><div>所以不能单纯依靠PostgreSQL函数来解决以上问题. 需要在外部声明with hold游标, 在函数中使用这个游标. 这样是可以的.</div><div>以下均为autocommit模式. 即自动提交</div><div>1. 创建以下函数替换以上函数</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >create or replace function f_batch(b int, c refcursor) returns void as $$</font></div><div style="line-height: 22px;"   ><font size="2"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; i int := 0;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; rec record;</font></div><div style="line-height: 22px;"   ><font size="2"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; loop</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; fetch c into rec;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; if not found then</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice 'cursor is empty. close it';</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; close c;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; return;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; end if;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; raise notice 'do some thing , rec:%', rec;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; if i&gt;=b then</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice 'reach batch limit.';</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; return;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; end if;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; i := i+1;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; end loop;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; return;</font></div><div style="line-height: 22px;"   ><font size="2"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   >$$ language plpgsql strict;</font></div><p></p></pre></div></div><div>2. 在会话中声明游标,&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# declare c1 cursor with hold for select relname from pg_class;</font></div><div><font size="2"   >DECLARE CURSOR</font></div><p></p></pre></div><div>3. 通过多次调用函数来实现, 每次调用为一次事务.</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >digoal=# select f_batch(5,'c1');</font></span></div><div><div><font size="2"   >NOTICE: &nbsp;do some thing , rec:(pg_statistic,11,10818,0,10,0,12550,0,15,387,15,2840,0,t,f,p,r,26,0,f,f,f,f,f,t,1674,1,{postgres=arwdDxt/postgres},)</font></div><div><font size="2"   >NOTICE: &nbsp;do some thing , rec:(pg_type,11,71,0,10,0,0,0,8,334,8,0,0,t,f,p,r,30,0,t,f,f,f,f,t,1674,1,{=r/postgres},)</font></div><div><font size="2"   >NOTICE: &nbsp;do some thing , rec:(pg_toast_2619,99,11050,0,10,0,12552,0,2,10,2,0,2841,t,f,p,t,3,0,f,f,f,f,f,t,1674,1,,)</font></div><div><font size="2"   >NOTICE: &nbsp;do some thing , rec:(pg_toast_2619_index,99,0,0,10,403,12554,0,2,10,0,0,0,f,f,p,i,2,0,f,f,f,f,f,t,0,0,,)</font></div><div><font size="2"   >NOTICE: &nbsp;do some thing , rec:(pg_authid_rolname_index,11,0,0,10,403,0,1664,2,1,0,0,0,f,t,p,i,1,0,f,f,f,f,f,t,0,0,,)</font></div><div><font size="2"   >NOTICE: &nbsp;do some thing , rec:(pg_authid_oid_index,11,0,0,10,403,0,1664,2,1,0,0,0,f,t,p,i,1,0,f,f,f,f,f,t,0,0,,)</font></div><div><font size="2"   >NOTICE: &nbsp;reach batch limit.</font></div><div><font size="2"   >&nbsp;f_batch&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# select f_batch(5,'c1');</font></div><div><font size="2"   >NOTICE: &nbsp;do some thing , rec:(pg_attribute_relid_attnam_index,11,0,0,10,403,0,0,16,2281,0,0,0,f,f,p,i,2,0,f,f,f,f,f,t,0,0,,)</font></div><div><font size="2"   >NOTICE: &nbsp;do some thing , rec:(pg_attribute_relid_attnum_index,11,0,0,10,403,0,0,11,2281,0,0,0,f,f,p,i,2,0,f,f,f,f,f,t,0,0,,)</font></div><div><font size="2"   >NOTICE: &nbsp;do some thing , rec:(pg_toast_1255,99,11047,0,10,0,0,0,0,0,0,0,2837,t,f,p,t,3,0,f,f,f,f,f,t,1674,1,,)</font></div><div><font size="2"   >NOTICE: &nbsp;do some thing , rec:(pg_toast_1255_index,99,0,0,10,403,0,0,1,0,0,0,0,f,f,p,i,2,0,f,f,f,f,f,t,0,0,,)</font></div><div><font size="2"   >NOTICE: &nbsp;do some thing , rec:(pg_toast_2604,99,11044,0,10,0,12586,0,0,0,0,0,2831,t,f,p,t,3,0,f,f,f,f,f,t,1674,1,,)</font></div><div><font size="2"   >NOTICE: &nbsp;do some thing , rec:(pg_toast_2604_index,99,0,0,10,403,12588,0,1,0,0,0,0,f,f,p,i,2,0,f,f,f,f,f,t,0,0,,)</font></div><div><font size="2"   >NOTICE: &nbsp;reach batch limit.</font></div><div><font size="2"   >&nbsp;f_batch&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select f_batch(500,'c1');</font></div><div><font size="2"   >中间省略</font></div><div><div><font size="2"   >NOTICE: &nbsp;do some thing , rec:(pg_toast_12392_index,99,0,0,10,403,12782,0,1,0,0,0,0,f,f,p,i,2,0,f,f,f,f,f,t,0,0,,)</font></div><div><font size="2"   >NOTICE: &nbsp;do some thing , rec:(sql_packages,12269,12408,0,10,0,12793,0,1,10,1,12409,0,f,f,p,r,5,0,f,f,f,f,f,t,1674,1,"{postgres=arwdDxt/postgres,=r/postgres}",)</font></div><div><font size="2"   >NOTICE: &nbsp;do some thing , rec:(pg_toast_12412_index,99,0,0,10,403,12802,0,1,0,0,0,0,f,f,p,i,2,0,f,f,f,f,f,t,0,0,,)</font></div><div><font size="2"   >NOTICE: &nbsp;cursor is empty. close it</font></div><div><font size="2"   >&nbsp;f_batch&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>游标已关闭.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select f_batch(5,'c1');</font></div><div><font size="2"   >ERROR: &nbsp;cursor "c1" does not exist</font></div><div><font size="2"   >CONTEXT: &nbsp;PL/pgSQL function f_batch(integer,refcursor) line 7 at FETCH</font></div><p></p></pre></div><div><br></div><div>使用这种方法需要注意关闭游标, 因为其他会话看不到这个游标, 也无法去关闭这个游标. 只有声明这个游标的会话可以关闭它.</div><div>游标长时间不关闭会影响vacuum回收垃圾. 这个PostgreSQL的mvcc机制有关. 例如 :&nbsp;</div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# declare c1 cursor with hold for select * from pg_class;</font></div></div><div><div><font size="2"   >digoal=# select * from pg_cursors ;</font></div><div><font size="2"   >&nbsp;name | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;statement &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| is_holdable | is_binary | is_scrollable | &nbsp; &nbsp; &nbsp; &nbsp; creation_time &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------+---------------------------------------------------------+-------------+-----------+---------------+-------------------------</font></div><div><font size="2"   >------</font></div><div><font size="2"   >&nbsp;c1 &nbsp; | declare c1 cursor with hold for select * from pg_class; | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2013-07-30 17:23:35.3859</font></div><div><font size="2"   >97+08</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into t select generate_series(1,10000);</font></div><div><font size="2"   >INSERT 0 10000</font></div><div><font size="2"   >digoal=# delete from t;</font></div><div><font size="2"   >DELETE 10002</font></div><div><font size="2"   >digoal=# vacuum verbose t;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.t"</font></div><div><font size="2"   >INFO: &nbsp;"t": found 0 removable, 10002 nonremovable row versions in 45 out of 45 pages</font></div><div><font size="2"   >DETAIL: &nbsp;10002 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><p></p></pre></div><div><br></div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >fetch 10000 from c1;</font></div><div><div><font size="2"   >digoal=# fetch 100000 from c1;</font></div><div><font size="2"   >&nbsp;relname | relnamespace | reltype | reloftype | relowner | relam | relfilenode | reltablespace | relpages | reltuples | relallvisibl</font></div><div><font size="2"   >e | reltoastrelid | reltoastidxid | relhasindex | relisshared | relpersistence | relkind | relnatts | relchecks | relhasoids | relha</font></div><div><font size="2"   >spkey | relhasrules | relhastriggers | relhassubclass | relispopulated | relfrozenxid | relminmxid | relacl | reloptions&nbsp;</font></div><div><font size="2"   >---------+--------------+---------+-----------+----------+-------+-------------+---------------+----------+-----------+-------------</font></div><div><font size="2"   >--+---------------+---------------+-------------+-------------+----------------+---------+----------+-----------+------------+------</font></div><div><font size="2"   >------+-------------+----------------+----------------+----------------+--------------+------------+--------+------------</font></div><div><font size="2"   >(0 rows)</font></div></div><p></p></pre></div><div><br></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# vacuum verbose t;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.t"</font></div><div><font size="2"   >INFO: &nbsp;"t": found 0 removable, 10002 nonremovable row versions in 45 out of 45 pages</font></div><div><font size="2"   >DETAIL: &nbsp;10002 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><p></p></pre></div><div><br></div><div>SESSOIN A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# close c1;</font></div><div><font size="2"   >CLOSE CURSOR</font></div><p></p></pre></div><div><br></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# vacuum verbose t;</font></div><div><font size="2"   >INFO: &nbsp;vacuuming "public.t"</font></div><div><font size="2"   >INFO: &nbsp;"t": removed 0 row versions in 44 pages</font></div><div><font size="2"   >INFO: &nbsp;"t": found 0 removable, 58 nonremovable row versions in 45 out of 45 pages</font></div><div><font size="2"   >DETAIL: &nbsp;58 dead row versions cannot be removed yet.</font></div><div><font size="2"   >There were 0 unused item pointers.</font></div><div><font size="2"   >0 pages are entirely empty.</font></div><div><font size="2"   >CPU 0.00s/0.00u sec elapsed 0.00 sec.</font></div><div><font size="2"   >VACUUM</font></div><p></p></pre></div><wbr></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">yaojieya - 2013-07-31 9:03:51</h5>
				<div>谢谢德哥的神速回复！<img src="http://b.bst.126.net/common/portrait/face/preview/face1.gif"  ></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 yaojieya - 2013-07-31 9:03:51</h5>
				<div style="width:600px;"><img src="http://b.bst.126.net/common/portrait/face/preview/face1.gif"  >,多多交流.</div>
			</div>
	</div>
</div>
</body>
</html>