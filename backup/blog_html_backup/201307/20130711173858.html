<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL BIG EVENT. Improve scalability of WAL insertions.</h2>
	<h5 id="">2013-07-11 17:38:58&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020136115370967/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Improve scalability of WAL insertions.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This patch replaces WALInsertLock with a number of WAL insertion slots,</font></div><div><font size="2"   >allowing multiple backends to insert WAL records to the WAL buffers</font></div><div><font size="2"   >concurrently. This is particularly useful for parallel loading large amounts</font></div><div><font size="2"   >of data on a system with many CPUs.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This has one user-visible change: switching to a new WAL segment with</font></div><div><font size="2"   >pg_switch_xlog() now fills the remaining unused portion of the segment with</font></div><div><font size="2"   >zeros. This potentially adds some overhead, but it has been a very common</font></div><div><font size="2"   >practice by DBA's to clear the "tail" of the segment with an external</font></div><div><font size="2"   >pg_clearxlogtail utility anyway, to make the WAL files compress better.</font></div><div><font size="2"   >With this patch, it's no longer necessary to do that.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This patch adds a new GUC, xloginsert_slots, to tune the number of WAL</font></div><div><font size="2"   >insertion slots. Performance testing suggests that the default, 8, works</font></div><div><font size="2"   >pretty well for all kinds of worklods, but I left the GUC in place to allow</font></div><div><font size="2"   >others with different hardware to test that easily. We might want to remove</font></div><div><font size="2"   >that before release.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Reviewed by Andres Freund.</font></div><p></p></pre></div><div><br></div><div>1. 使用insert slot替代WALInsertLock, 对于当下流行的多核CPU来说是个非常的利好消息, 在多核下可以发挥更好的并行的大量数据导入(写入)性能.</div><div>2. 不需要使用pg_clearxlogtail来压缩pg_switch_xlog()产生的带有空白块的xlog文件了.&nbsp;</div><div>3. 目前的slots为8, 可以通过GUC来更改这个slots数. 对于更多核的系统可以适当调大它, 否则使用默认就可以了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >diff --git a/src/backend/utils/misc/guc.c b/src/backend/utils/misc/guc.c</font></div><div><font size="2"   >index d620061..5aefd1b 100644 (file)</font></div><div><font size="2"   >--- a/src/backend/utils/misc/guc.c</font></div><div><font size="2"   >+++ b/src/backend/utils/misc/guc.c</font></div><div><font size="2"   >@@ -2038,6 +2038,17 @@ static struct config_int ConfigureNamesInt[] =</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; {</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; {"xloginsert_slots", PGC_POSTMASTER, WAL_SETTINGS,</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gettext_noop("Sets the number of slots for concurrent xlog insertions."),</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NULL,</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GUC_NOT_IN_SAMPLE</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; },</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &amp;num_xloginsert_slots,</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; 8, 1, 1000,</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; NULL, NULL, NULL</font></div><div><font size="2"   >+ &nbsp; },</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* see max_connections */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {"max_wal_senders", PGC_POSTMASTER, REPLICATION_SENDING,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gettext_noop("Sets the maximum number of simultaneously running WAL sender processes."),</font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=9a20a9b21baa819df1760b36f3c36f25d11fc27b"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=9a20a9b21baa819df1760b36f3c36f25d11fc27b</a></div><wbr></div>
	</div>
</div>
</body>
</html>