<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL USE plpythonu get Linux FileSystem usage</h2>
	<h5 id="">2013-07-22 16:55:47&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020136224478561/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">PostgreSQL数据库表空间和目录一一对应, 目录有多少剩余空间, 代表表空间的剩余空间.<div>但是作为数据库的使用者, 可能没有操作系统的权限去查看目录有多少空间, 那么如何才能做到在数据库中获取文件系统的剩余空间呢?</div><div>比较简单的做法是使用plpythonu语言, 如下 :&nbsp;</div><div><br>查看系统安装了哪些语言handler.<wbr></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_pltemplate ;</font></div><div><font size="2"   >&nbsp; tmplname &nbsp;| tmpltrusted | tmpldbacreate | &nbsp; &nbsp; &nbsp;tmplhandler &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;tmplinline &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;tmplvalidator &nbsp; &nbsp;| &nbsp; &nbsp;tmpllibrary</font></div><div><font size="2"   >&nbsp; &nbsp; | tmplacl&nbsp;</font></div><div><font size="2"   >------------+-------------+---------------+------------------------+--------------------------+---------------------+---------------</font></div><div><font size="2"   >----+---------</font></div><div><font size="2"   >&nbsp;plpgsql &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plpgsql_call_handler &nbsp; | plpgsql_inline_handler &nbsp; | plpgsql_validator &nbsp; | $libdir/plpgsq</font></div><div><font size="2"   >l &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;pltcl &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | pltcl_call_handler &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | $libdir/pltcl&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;pltclu &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | pltclu_call_handler &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | $libdir/pltcl&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;plperl &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plperl_call_handler &nbsp; &nbsp;| plperl_inline_handler &nbsp; &nbsp;| plperl_validator &nbsp; &nbsp;| $libdir/plperl</font></div><div><font size="2"   >&nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;plperlu &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plperlu_call_handler &nbsp; | plperlu_inline_handler &nbsp; | plperlu_validator &nbsp; | $libdir/plperl</font></div><div><font size="2"   >&nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;plpythonu &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plpython_call_handler &nbsp;| plpython_inline_handler &nbsp;| plpython_validator &nbsp;| $libdir/plpyth</font></div><div><font size="2"   >on2 |&nbsp;</font></div><div><font size="2"   >&nbsp;plpython2u | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plpython2_call_handler | plpython2_inline_handler | plpython2_validator | $libdir/plpyth</font></div><div><font size="2"   >on2 |&nbsp;</font></div><div><font size="2"   >&nbsp;plpython3u | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plpython3_call_handler | plpython3_inline_handler | plpython3_validator | $libdir/plpyth</font></div><div><font size="2"   >on3 |&nbsp;</font></div><div><font size="2"   >(8 rows)</font></div><p></p></pre></div><div>安装语言 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create language plpythonu;</font></div><div><font size="2"   >CREATE LANGUAGE</font></div><p></p></pre></div><div>使用online code测试 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# do language plpythonu $$</font></div><div><font size="2"   >import os &nbsp;</font></div><div><font size="2"   >import statvfs</font></div><div><font size="2"   >phydevs = [] &nbsp;</font></div><div><font size="2"   >f = open("/proc/filesystems", "r") &nbsp;</font></div><div><font size="2"   >for line in f: &nbsp;</font></div><div><font size="2"   >&nbsp; if not line.startswith("nodev"): &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; phydevs.append(line.strip()) &nbsp;</font></div><div><font size="2"   >&nbsp; retlist = [] &nbsp;</font></div><div><font size="2"   >f = open('/etc/mtab', "r") &nbsp;</font></div><div><font size="2"   >for line in f: &nbsp;</font></div><div><font size="2"   >&nbsp; if line.startswith('none'): &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; continue &nbsp;</font></div><div><font size="2"   >&nbsp; fields = line.split() &nbsp;</font></div><div><font size="2"   >&nbsp; device = fields[0] &nbsp;</font></div><div><font size="2"   >&nbsp; mountpoint = fields[1] &nbsp;</font></div><div><font size="2"   >&nbsp; fstype = fields[2] &nbsp;</font></div><div><font size="2"   >&nbsp; if fstype not in phydevs: &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; continue &nbsp;</font></div><div><font size="2"   >&nbsp; if device == 'none': &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; device = '' &nbsp;</font></div><div><font size="2"   >&nbsp; vfs=os.statvfs(mountpoint)</font></div><div><font size="2"   >&nbsp; available=vfs[statvfs.F_BAVAIL]*vfs[statvfs.F_BSIZE]/(1024*1024*1024)</font></div><div><font size="2"   >&nbsp; capacity=vfs[statvfs.F_BLOCKS]*vfs[statvfs.F_BSIZE]/(1024*1024*1024)</font></div><div><font size="2"   >&nbsp; used=capacity-available</font></div><div><font size="2"   ><span style="line-height: 19px;"   >  plpy.notice('mountpoint',mountpoint,'capacityGB',capacity,'usedGB',used,'availableGB',available)</span></font></div><div><font size="2"   >$$;</font></div><p></p></pre></div><div>输出 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >NOTICE:  ('mountpoint', '/', 'capacityGB', 28, 'usedGB', 14, 'availableGB', 14)<br>CONTEXT:  PL/Python anonymous code block<br>NOTICE:  ('mountpoint', '/pgdata/digoal/1921/data01', 'capacityGB', 39, 'usedGB', 9, 'availableGB', 30)<br>CONTEXT:  PL/Python anonymous code block<br>NOTICE:  ('mountpoint', '/pgdata/digoal/1921/data02', 'capacityGB', 39, 'usedGB', 2, 'availableGB', 37)<br>CONTEXT:  PL/Python anonymous code block<br>NOTICE:  ('mountpoint', '/pgdata/digoal/1921/data03', 'capacityGB', 39, 'usedGB', 2, 'availableGB', 37)<br>CONTEXT:  PL/Python anonymous code block<br>NOTICE:  ('mountpoint', '/pgdata/digoal/1921/data04', 'capacityGB', 39, 'usedGB', 2, 'availableGB', 37)<br>CONTEXT:  PL/Python anonymous code block<br>NOTICE:  ('mountpoint', '/pgdata/digoal/1921/data05', 'capacityGB', 39, 'usedGB', 2, 'availableGB', 37)<br>CONTEXT:  PL/Python anonymous code block<br>NOTICE:  ('mountpoint', '/pgdata/digoal/1921/data06', 'capacityGB', 39, 'usedGB', 5, 'availableGB', 34)<br>CONTEXT:  PL/Python anonymous code block<br>DO</span></font></div><p></p></pre></div></div><div>需要注意的是这个language是untrusted的, 只有超级用户能够创建它的函数.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; grant usage on language plpythonu to digoal;</font></div><div><font size="2"   >ERROR: &nbsp;language "plpythonu" is not trusted</font></div><div><font size="2"   >HINT: &nbsp;Only superusers can use untrusted languages.</font></div><p></p></pre></div><div>例如使用普通用户执行以上online code, 将会报错 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; do language plpythonu $$ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >import os &nbsp;</font></div><div><font size="2"   >import statvfs</font></div><div><font size="2"   >phydevs = [] &nbsp;</font></div><div><font size="2"   >f = open("/proc/filesystems", "r") &nbsp;</font></div><div><font size="2"   >for line in f: &nbsp;</font></div><div><font size="2"   >&nbsp; if not line.startswith("nodev"): &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; phydevs.append(line.strip()) &nbsp;</font></div><div><font size="2"   >&nbsp; retlist = [] &nbsp;</font></div><div><font size="2"   >f = open('/etc/mtab', "r") &nbsp;</font></div><div><font size="2"   >for line in f: &nbsp;</font></div><div><font size="2"   >&nbsp; if line.startswith('none'): &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; continue &nbsp;</font></div><div><font size="2"   >&nbsp; fields = line.split() &nbsp;</font></div><div><font size="2"   >&nbsp; device = fields[0] &nbsp;</font></div><div><font size="2"   >&nbsp; mountpoint = fields[1] &nbsp;</font></div><div><font size="2"   >&nbsp; fstype = fields[2] &nbsp;</font></div><div><font size="2"   >&nbsp; if fstype not in phydevs: &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; continue &nbsp;</font></div><div><font size="2"   >&nbsp; if device == 'none': &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; device = '' &nbsp;</font></div><div><font size="2"   >&nbsp; vfs=os.statvfs(mountpoint)</font></div><div><font size="2"   >&nbsp; available=vfs[statvfs.F_BAVAIL]*vfs[statvfs.F_BSIZE]/(1024*1024*1024)</font></div><div><font size="2"   >&nbsp; capacity=vfs[statvfs.F_BLOCKS]*vfs[statvfs.F_BSIZE]/(1024*1024*1024)</font></div><div><font size="2"   >&nbsp; used=capacity-available</font></div><div><font size="2"   ><span style="line-height: 19px;"   >  plpy.notice('mountpoint',mountpoint,'capacityGB',capacity,'usedGB',used,'availableGB',available)</span></font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >ERROR: &nbsp;permission denied for language plpythonu</font></div><p></p></pre></div><div>使用超级用户创建函数, 让普通用户调用是可以的.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create or replace function get_fs() returns void as $$</font></div><div><font size="2"   >digoal$# import os &nbsp;</font></div><div><font size="2"   >digoal$# import statvfs</font></div><div><font size="2"   >digoal$# phydevs = [] &nbsp;</font></div><div><font size="2"   >digoal$# f = open("/proc/filesystems", "r") &nbsp;</font></div><div><font size="2"   >digoal$# for line in f: &nbsp;</font></div><div><font size="2"   >digoal$# &nbsp; if not line.startswith("nodev"): &nbsp;</font></div><div><font size="2"   >digoal$# &nbsp; &nbsp; phydevs.append(line.strip()) &nbsp;</font></div><div><font size="2"   >digoal$# &nbsp; retlist = [] &nbsp;</font></div><div><font size="2"   >digoal$# f = open('/etc/mtab', "r") &nbsp;</font></div><div><font size="2"   >digoal$# for line in f: &nbsp;</font></div><div><font size="2"   >digoal$# &nbsp; if line.startswith('none'): &nbsp;</font></div><div><font size="2"   >digoal$# &nbsp; &nbsp; continue &nbsp;</font></div><div><font size="2"   >digoal$# &nbsp; fields = line.split() &nbsp;</font></div><div><font size="2"   >digoal$# &nbsp; device = fields[0] &nbsp;</font></div><div><font size="2"   >digoal$# &nbsp; mountpoint = fields[1] &nbsp;</font></div><div><font size="2"   >digoal$# &nbsp; fstype = fields[2] &nbsp;</font></div><div><font size="2"   >digoal$# &nbsp; if fstype not in phydevs: &nbsp;</font></div><div><font size="2"   >digoal$# &nbsp; &nbsp; continue &nbsp;</font></div><div><font size="2"   >digoal$# &nbsp; if device == 'none': &nbsp;</font></div><div><font size="2"   >digoal$# &nbsp; &nbsp; device = '' &nbsp;</font></div><div><font size="2"   >digoal$# &nbsp; vfs=os.statvfs(mountpoint)</font></div><div><font size="2"   >digoal$# &nbsp; available=vfs[statvfs.F_BAVAIL]*vfs[statvfs.F_BSIZE]/(1024*1024*1024)</font></div><div><font size="2"   >digoal$# &nbsp; capacity=vfs[statvfs.F_BLOCKS]*vfs[statvfs.F_BSIZE]/(1024*1024*1024)</font></div><div><font size="2"   >digoal$# &nbsp; used=capacity-available</font></div><div><font size="2"   >digoal$# &nbsp; <span style="line-height: 19px;"   >plpy.notice('mountpoint',mountpoint,'capacityGB',capacity,'usedGB',used,'availableGB',available)</span></font></div><div><font size="2"   >digoal$# $$ language plpythonu;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><p></p></pre></div><div>普通用户调用 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >postgres=# \c digoal<br>You are now connected to database "digoal" as user "postgres".<br>digoal=# select get_fs();<br>NOTICE:  ('mountpoint', '/', 'capacityGB', 28, 'usedGB', 14, 'availableGB', 14)<br>CONTEXT:  PL/Python function "get_fs"<br>NOTICE:  ('mountpoint', '/pgdata/digoal/1921/data01', 'capacityGB', 39, 'usedGB', 9, 'availableGB', 30)<br>CONTEXT:  PL/Python function "get_fs"<br>NOTICE:  ('mountpoint', '/pgdata/digoal/1921/data02', 'capacityGB', 39, 'usedGB', 2, 'availableGB', 37)<br>CONTEXT:  PL/Python function "get_fs"<br>NOTICE:  ('mountpoint', '/pgdata/digoal/1921/data03', 'capacityGB', 39, 'usedGB', 2, 'availableGB', 37)<br>CONTEXT:  PL/Python function "get_fs"<br>NOTICE:  ('mountpoint', '/pgdata/digoal/1921/data04', 'capacityGB', 39, 'usedGB', 2, 'availableGB', 37)<br>CONTEXT:  PL/Python function "get_fs"<br>NOTICE:  ('mountpoint', '/pgdata/digoal/1921/data05', 'capacityGB', 39, 'usedGB', 2, 'availableGB', 37)<br>CONTEXT:  PL/Python function "get_fs"<br>NOTICE:  ('mountpoint', '/pgdata/digoal/1921/data06', 'capacityGB', 39, 'usedGB', 5, 'availableGB', 34)<br>CONTEXT:  PL/Python function "get_fs"<br> get_fs <br>--------<br> <br>(1 row)</span></font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.linux-field.com/archives/161"   >http://www.linux-field.com/archives/161</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[mps@mps-1 ~]$ python</font></div><div><font size="2"   >Python 2.4.3 (#1, Sep &nbsp;3 2009, 15:37:37)</font></div><div><font size="2"   >[GCC 4.1.2 20080704 (Red Hat 4.1.2-46)] on linux2</font></div><div><font size="2"   >Type "help", "copyright", "credits" or "license" for more information.</font></div><div><font size="2"   >&gt;&gt;&gt; import os</font></div><div><font size="2"   >&gt;&gt;&gt; import statvfs</font></div><div><font size="2"   >&gt;&gt;&gt; vfs=os.statvfs("/home")</font></div><div><font size="2"   >&gt;&gt;&gt; vfs</font></div><div><font size="2"   >(4096, 4096, 70959944, 70058799, 66396080, 73269248, 73234981, 73234981, 0, 255)</font></div><div><font size="2"   >&gt;&gt;&gt; dir(statvfs)</font></div><div><font size="2"   >['F_BAVAIL', 'F_BFREE', 'F_BLOCKS', 'F_BSIZE', 'F_FAVAIL', 'F_FFREE', 'F_FILES', 'F_FLAG', 'F_FRSIZE', 'F_NAMEMAX', '__builtins__', '__doc__', '__file__', '__name__']</font></div><div><font size="2"   >&gt;&gt;&gt; available=vfs[statvfs.F_BAVAIL]*vfs[statvfs.F_BSIZE]/(1024*1024*1024)</font></div><div><font size="2"   >&gt;&gt;&gt; available</font></div><div><font size="2"   >253</font></div><div><font size="2"   >&gt;&gt;&gt; capacity=vfs[statvfs.F_BLOCKS]*vfs[statvfs.F_BSIZE]/(1024*1024*1024)</font></div><div><font size="2"   >&gt;&gt;&gt; capacity</font></div><div><font size="2"   >270</font></div><div><font size="2"   >&gt;&gt;&gt; used=capacity-available</font></div><div><font size="2"   >&gt;&gt;&gt; used</font></div><div><font size="2"   >17</font></div><div><font size="2"   >&gt;&gt;&gt;</font></div><p></p></pre></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://blog.csdn.net/magic_zj00/article/details/7207445"   >http://blog.csdn.net/magic_zj00/article/details/7207445</a></div><div>3.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://docs.python.org/library/statvfs.html"   >http://docs.python.org/library/statvfs.html</a></div><div>4.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://docs.python.org/library/os.html"   >http://docs.python.org/library/os.html</a></div></div>
	</div>
</div>
</body>
</html>