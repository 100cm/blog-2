<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 Add SQL Standard WITH ORDINALITY support for UNNEST (and any other SRF)</h2>
	<h5 id="">2013-07-30 14:29:22&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020136301599959/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div><div><span style="line-height: 22px;"   >PostgreSQL 9.4 将支持</span><span style="line-height: 22px;"   >SQL标准</span><span style="line-height: 22px;"   >WITH ORDINALITY的写法,用于unnest以及其他查询相关的SQL中.</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >Add SQL Standard WITH ORDINALITY support for UNNEST (and any other SRF)</font></span></div><div style="line-height: 22px;"   ><font size="2"   >Author: Andrew Gierth, David Fetter</font></div><div style="line-height: 22px;"   ><font size="2"   >Reviewers: Dean Rasheed, Jeevan Chalke, Stephen Frost</font></div><p></p></pre></div></div><div>测试可以下载如下源码, 已包含此部分更新 :&nbsp;</div><div><a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=snapshot;h=c62736cc37f6812d1ebb41ea5a86ffe60564a1f0;sf=tgz"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=snapshot;h=c62736cc37f6812d1ebb41ea5a86ffe60564a1f0;sf=tgz</a></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >在9.4以前的版本可以通过unnest_ordinality插件实现, 如下</span></div><div style="line-height: 22px;"   ><a style="line-height: 22px;" rel="nofollow" href="http://pgxn.org/dist/unnest_ordinality/1.0.0/"   >http://pgxn.org/dist/unnest_ordinality/1.0.0/</a></div></div><div style="line-height: 22px;"   >查询中的用法说明, 紧跟在函数调用后面 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >function_name</font></div><div><font size="2"   >Function calls can appear in the FROM clause. (This is especially useful for functions that return result sets, but any function can be used.) This acts as though its output were created as a temporary table for the duration of this single SELECT command. When the optional WITH ORDINALITY is appended to the function call, a new column is appended after all the function call's columns with numbering for each row. For example:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SELECT * FROM unnest(ARRAY['a','b','c','d','e','f']) WITH ORDINALITY;</font></div><div><font size="2"   >&nbsp;unnest | ordinality&nbsp;</font></div><div><font size="2"   >--------+----------</font></div><div><font size="2"   >&nbsp;a &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >&nbsp;b &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >&nbsp;c &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;3</font></div><div><font size="2"   >&nbsp;d &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;4</font></div><div><font size="2"   >&nbsp;e &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;5</font></div><div><font size="2"   >&nbsp;f &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;6</font></div><div><font size="2"   >(6 rows)</font></div><div><font size="2"   >An alias can also be used. If an alias is written, a column alias list can also be written to provide substitute names for one or more attributes of the function's composite return type, including the column added by ORDINALITY if present.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >If the function has been defined as returning the record data type, then an alias or the key word AS must be present, followed by a column definition list in the form ( column_name data_type [, ... ]). The column definition list must match the actual number and types of columns returned by the function. ORDINALITY does not work in this case.</font></div><p></p></pre></div><div>目前ordinality不支持用在返回record类型的函数后.</div><div>测试 :&nbsp;</div></div><div>1. 函数测试</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select * from generate_series(1,4) with ordinality as g(g,o);</font></div><div><font size="2"   >&nbsp;g | o&nbsp;</font></div><div><font size="2"   >---+---</font></div><div><font size="2"   >&nbsp;1 | 1</font></div><div><font size="2"   >&nbsp;2 | 2</font></div><div><font size="2"   >&nbsp;3 | 3</font></div><div><font size="2"   >&nbsp;4 | 4</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from generate_series(1,4) with ordinality;</font></div><div><font size="2"   >&nbsp;generate_series | ordinality&nbsp;</font></div><div><font size="2"   >-----------------+------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4</font></div><div><font size="2"   >(4 rows)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# select * from unnest(array[5,4,3,2,1]);</font></div><div><font size="2"   >&nbsp;unnest&nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 5</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 4</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 3</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >(5 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from unnest(array[5,4,3,2,1]) with ordinality;</font></div><div><font size="2"   >&nbsp;unnest | ordinality&nbsp;</font></div><div><font size="2"   >--------+------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 5 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 3 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5</font></div><div><font size="2"   >(5 rows)</font></div></div><p></p></pre></div><div><br></div><div>2. 不支持返回record类型函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create or replace function f_record() returns setof record as $$ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; return query select relname,relkind from pg_class limit 5;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div></div><div><div><font size="2"   >digoal=# select * from f_record() as (a name, b "char");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| b&nbsp;</font></div><div><font size="2"   >-------------------------+---</font></div><div><font size="2"   >&nbsp;pg_statistic &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| r</font></div><div><font size="2"   >&nbsp;pg_type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | r</font></div><div><font size="2"   >&nbsp;pg_toast_2619 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;pg_toast_2619_index &nbsp; &nbsp; | i</font></div><div><font size="2"   >&nbsp;pg_authid_rolname_index | i</font></div><div><font size="2"   >(5 rows)</font></div></div><div><div><font size="2"   >digoal=# select * from f_record() with ordinality as (a name, b "char");</font></div><div><font size="2"   >ERROR: &nbsp;0A000: WITH ORDINALITY is not supported for functions returning "record"</font></div><div><font size="2"   >LINE 1: select * from f_record() with ordinality as (a name, b "char...</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   >LOCATION: &nbsp;addRangeTableEntryForFunction, parse_relation.c:1292</font></div></div><p></p></pre></div><div><br></div><div>3. 其他查询测试</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# SELECT * FROM (VALUES (1),(2),(3)) v(r) LEFT JOIN generate_series(11,13) f(i) ON (r+i)&lt;100;</font></div><div><font size="2"   >&nbsp;r | i &nbsp;</font></div><div><font size="2"   >---+----</font></div><div><font size="2"   >&nbsp;1 | 11</font></div><div><font size="2"   >&nbsp;1 | 12</font></div><div><font size="2"   >&nbsp;1 | 13</font></div><div><font size="2"   >&nbsp;2 | 11</font></div><div><font size="2"   >&nbsp;2 | 12</font></div><div><font size="2"   >&nbsp;2 | 13</font></div><div><font size="2"   >&nbsp;3 | 11</font></div><div><font size="2"   >&nbsp;3 | 12</font></div><div><font size="2"   >&nbsp;3 | 13</font></div><div><font size="2"   >(9 rows)</font></div></div><div><div><font size="2"   >digoal=# SELECT * FROM (VALUES (1),(2),(3)) v(r) LEFT JOIN generate_series(11,13) WITH ORDINALITY AS f(i,o) ON (r+i)&lt;100;</font></div><div><font size="2"   >&nbsp;r | i &nbsp;| o&nbsp;</font></div><div><font size="2"   >---+----+---</font></div><div><font size="2"   >&nbsp;1 | 11 | 1</font></div><div><font size="2"   >&nbsp;1 | 12 | 2</font></div><div><font size="2"   >&nbsp;1 | 13 | 3</font></div><div><font size="2"   >&nbsp;2 | 11 | 1</font></div><div><font size="2"   >&nbsp;2 | 12 | 2</font></div><div><font size="2"   >&nbsp;2 | 13 | 3</font></div><div><font size="2"   >&nbsp;3 | 11 | 1</font></div><div><font size="2"   >&nbsp;3 | 12 | 2</font></div><div><font size="2"   >&nbsp;3 | 13 | 3</font></div><div><font size="2"   >(9 rows)</font></div></div><p></p></pre></div><div>详细测试可参考:</div><div><a rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=blobdiff;f=src/test/regress/expected/rangefuncs.out;h=45ffd85b1b74715ea07b2f7995fc12ae64d85716;hp=16782776f45222b9b9ad75c5c776993baf5554dc;hb=c62736cc37f6812d1ebb41ea5a86ffe60564a1f0;hpb=55cbfa5366b78d93cd1ff8c4c622b552985344f6"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=blobdiff;f=src/test/regress/expected/rangefuncs.out;h=45ffd85b1b74715ea07b2f7995fc12ae64d85716;hp=16782776f45222b9b9ad75c5c776993baf5554dc;hb=c62736cc37f6812d1ebb41ea5a86ffe60564a1f0;hpb=55cbfa5366b78d93cd1ff8c4c622b552985344f6</a></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=c62736cc37f6812d1ebb41ea5a86ffe60564a1f0"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=c62736cc37f6812d1ebb41ea5a86ffe60564a1f0</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=blobdiff;f=src/test/regress/expected/rangefuncs.out;h=45ffd85b1b74715ea07b2f7995fc12ae64d85716;hp=16782776f45222b9b9ad75c5c776993baf5554dc;hb=c62736cc37f6812d1ebb41ea5a86ffe60564a1f0;hpb=55cbfa5366b78d93cd1ff8c4c622b552985344f6"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=blobdiff;f=src/test/regress/expected/rangefuncs.out;h=45ffd85b1b74715ea07b2f7995fc12ae64d85716;hp=16782776f45222b9b9ad75c5c776993baf5554dc;hb=c62736cc37f6812d1ebb41ea5a86ffe60564a1f0;hpb=55cbfa5366b78d93cd1ff8c4c622b552985344f6</a></div><div>3.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=blobdiff;f=doc/src/sgml/func.sgml;h=34c5c2a2d6b00e7d00ef09e64fccc324f41c74b7;hp=528197e4bcc6072fa16a13a743a212158a078de3;hb=c62736cc37f6812d1ebb41ea5a86ffe60564a1f0;hpb=55cbfa5366b78d93cd1ff8c4c622b552985344f6"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=blobdiff;f=doc/src/sgml/func.sgml;h=34c5c2a2d6b00e7d00ef09e64fccc324f41c74b7;hp=528197e4bcc6072fa16a13a743a212158a078de3;hb=c62736cc37f6812d1ebb41ea5a86ffe60564a1f0;hpb=55cbfa5366b78d93cd1ff8c4c622b552985344f6</a></div><div>4.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=blobdiff;f=doc/src/sgml/ref/select.sgml;h=42cfc28a5e52a25a5128540538b6deb4514465e2;hp=b0cec1421ca38411550463fba99a23bd75850093;hb=c62736cc37f6812d1ebb41ea5a86ffe60564a1f0;hpb=55cbfa5366b78d93cd1ff8c4c622b552985344f6"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=blobdiff;f=doc/src/sgml/ref/select.sgml;h=42cfc28a5e52a25a5128540538b6deb4514465e2;hp=b0cec1421ca38411550463fba99a23bd75850093;hb=c62736cc37f6812d1ebb41ea5a86ffe60564a1f0;hpb=55cbfa5366b78d93cd1ff8c4c622b552985344f6</a></div><div>5.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://pgxn.org/dist/unnest_ordinality/1.0.0/"   >http://pgxn.org/dist/unnest_ordinality/1.0.0/</a></div><div>6.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-select.html"   >http://www.postgresql.org/docs/devel/static/sql-select.html</a></div></div>
	</div>
</div>
</body>
</html>