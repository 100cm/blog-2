<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.1,9.2,9.3 clean switchover Primary and Standby Patch.</h2>
	<h5 id="">2013-07-19 8:05:23&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020136197354054/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前段时间在使用9.3 beta2的流复制时发现无法完成主备数据库的角色互相切换. 原因是备节点的receiver进程在知晓主节点的sender进程关闭后也会自动关闭,可能导致无法接收primary节点关闭时完全的xlog信息. 因此角色无法互相切换.</div><div>9.3beta2发布的第二天这个补丁就提交了, 如下 &nbsp;:&nbsp;</div><div><div style="font-family: sans-serif; font-size: small; line-height: normal;"   ><a style="color: rgb(0, 0, 0); display: block; padding: 6px 8px; font-weight: bold; background-color: rgb(237, 236, 230); text-decoration: none;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=985bd7d49726c9f178558491d31a570d47340459"   >Support clean switchover.</a></div><div style="padding: 6px 0px; border-style: solid; border-color: rgb(217, 216, 209); border-width: 0px 0px 1px; font-family: monospace; line-height: normal;"   ><table style="padding: 8px 4px; border-spacing: 0px;"   ><tbody><tr><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   >author</td><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   ><a title="Search for commits authored by Fujii Masao" style="color: rgb(0, 0, 0); text-decoration: none;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=search;h=985bd7d49726c9f178558491d31a570d47340459;s=Fujii+Masao;st=author"   >Fujii Masao</a>&nbsp;<a title="Search for commits authored by fujii@postgresql.org" style="color: rgb(0, 0, 0); text-decoration: none;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=search;h=985bd7d49726c9f178558491d31a570d47340459;s=fujii@postgresql.org;st=author"   >&lt;fujii@postgresql.org&gt;</a></td><td rowspan="2"   style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   ></td></tr><tr><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   ></td><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   >Tue, 25 Jun 2013 17:14:37 +0000 (<span style="color: rgb(204, 0, 0);"   >02:14</span>&nbsp;+0900)</td></tr><tr><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   >committer</td><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   ><a title="Search for commits committed by Fujii Masao" style="color: rgb(0, 0, 0); text-decoration: none;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=search;h=985bd7d49726c9f178558491d31a570d47340459;s=Fujii+Masao;st=committer"   >Fujii Masao</a>&nbsp;<a title="Search for commits committed by fujii@postgresql.org" style="color: rgb(0, 0, 0); text-decoration: none;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=search;h=985bd7d49726c9f178558491d31a570d47340459;s=fujii@postgresql.org;st=committer"   >&lt;fujii@postgresql.org&gt;</a></td><td rowspan="2"   style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   ></td></tr><tr><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   ></td><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   >Tue, 25 Jun 2013 17:14:37 +0000 (<span style="color: rgb(204, 0, 0);"   >02:14</span>&nbsp;+0900)</td></tr><tr><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   >commit</td><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   >985bd7d49726c9f178558491d31a570d47340459</td></tr><tr><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   >tree</td><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   ><a style="color: rgb(0, 0, 0); text-decoration: none;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=tree;h=765e3c0e22ee4991c5fb0b00dd8888e8161f4422;hb=985bd7d49726c9f178558491d31a570d47340459"   >765e3c0e22ee4991c5fb0b00dd8888e8161f4422</a></td><td style="padding: 2px 5px; font-size: 12px; vertical-align: top; font-family: sans-serif;"   ><a style="color: rgb(136, 0, 0);" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=tree;h=765e3c0e22ee4991c5fb0b00dd8888e8161f4422;hb=985bd7d49726c9f178558491d31a570d47340459"   >tree</a>&nbsp;|&nbsp;<a title="in format: tar.gz" style="color: rgb(136, 0, 0);" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=snapshot;h=985bd7d49726c9f178558491d31a570d47340459;sf=tgz"   >snapshot</a></td></tr><tr><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   >parent</td><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   ><a style="color: rgb(0, 0, 0); text-decoration: none;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=4f14c86d7434376b95477aeeb07fcc7272f4c47d"   >4f14c86d7434376b95477aeeb07fcc7272f4c47d</a></td><td style="padding: 2px 5px; font-size: 12px; vertical-align: top; font-family: sans-serif;"   ><a style="color: rgb(136, 0, 0);" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=4f14c86d7434376b95477aeeb07fcc7272f4c47d"   >commit</a>&nbsp;|&nbsp;<a style="color: rgb(136, 0, 0);" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=985bd7d49726c9f178558491d31a570d47340459;hp=4f14c86d7434376b95477aeeb07fcc7272f4c47d"   >diff</a></td></tr></table></div><div style="padding: 8px; font-family: monospace; line-height: normal;"   >Support&nbsp;clean&nbsp;switchover.<br><br>In&nbsp;replication,&nbsp;when&nbsp;we&nbsp;shutdown&nbsp;the&nbsp;master,&nbsp;walsender&nbsp;tries&nbsp;to&nbsp;send<br>all&nbsp;the&nbsp;outstanding&nbsp;WAL&nbsp;records&nbsp;to&nbsp;the&nbsp;standby,&nbsp;and&nbsp;then&nbsp;to&nbsp;exit.&nbsp;This<br>basically&nbsp;means&nbsp;that&nbsp;all&nbsp;the&nbsp;WAL&nbsp;records&nbsp;are&nbsp;fully&nbsp;synced&nbsp;between<br>two&nbsp;servers&nbsp;after&nbsp;the&nbsp;clean&nbsp;shutdown&nbsp;of&nbsp;the&nbsp;master.&nbsp;So,&nbsp;after<br>promoting&nbsp;the&nbsp;standby&nbsp;to&nbsp;new&nbsp;master,&nbsp;we&nbsp;can&nbsp;restart&nbsp;the&nbsp;stopped<br>master&nbsp;as&nbsp;new&nbsp;standby&nbsp;without&nbsp;the&nbsp;need&nbsp;for&nbsp;a&nbsp;fresh&nbsp;backup&nbsp;from<br>new&nbsp;master.<br><br>But&nbsp;there&nbsp;was&nbsp;one&nbsp;problem&nbsp;so&nbsp;far:&nbsp;though&nbsp;walsender&nbsp;tries&nbsp;to&nbsp;send&nbsp;all<br>the&nbsp;outstanding&nbsp;WAL&nbsp;records,&nbsp;it&nbsp;doesn't&nbsp;wait&nbsp;for&nbsp;them&nbsp;to&nbsp;be&nbsp;replicated<br>to&nbsp;the&nbsp;standby.&nbsp;Then,&nbsp;before&nbsp;receiving&nbsp;all&nbsp;the&nbsp;WAL&nbsp;records,<br>walreceiver&nbsp;can&nbsp;detect&nbsp;the&nbsp;closure&nbsp;of&nbsp;connection&nbsp;and&nbsp;exit.&nbsp;We&nbsp;cannot<br>guarantee&nbsp;that&nbsp;there&nbsp;is&nbsp;no&nbsp;missing&nbsp;WAL&nbsp;in&nbsp;the&nbsp;standby&nbsp;after&nbsp;clean<br>shutdown&nbsp;of&nbsp;the&nbsp;master.&nbsp;In&nbsp;this&nbsp;case,&nbsp;backup&nbsp;from&nbsp;new&nbsp;master&nbsp;is<br>required&nbsp;when&nbsp;restarting&nbsp;the&nbsp;stopped&nbsp;master&nbsp;as&nbsp;new&nbsp;standby.<br><br>This&nbsp;patch&nbsp;fixes&nbsp;this&nbsp;problem.&nbsp;It&nbsp;just&nbsp;changes&nbsp;walsender&nbsp;so&nbsp;that&nbsp;it<br>waits&nbsp;for&nbsp;all&nbsp;the&nbsp;outstanding&nbsp;WAL&nbsp;records&nbsp;to&nbsp;be&nbsp;replicated&nbsp;to&nbsp;the<br>standby&nbsp;before&nbsp;closing&nbsp;the&nbsp;replication&nbsp;connection.<br><br>Per&nbsp;discussion,&nbsp;this&nbsp;is&nbsp;a&nbsp;fix&nbsp;that&nbsp;needs&nbsp;to&nbsp;get&nbsp;backpatched&nbsp;rather&nbsp;than<br>new&nbsp;feature.&nbsp;So,&nbsp;back-patch&nbsp;to&nbsp;9.1&nbsp;where&nbsp;enough&nbsp;infrastructure&nbsp;for<br>this&nbsp;exists.<br><br>Patch&nbsp;by&nbsp;me,&nbsp;reviewed&nbsp;by&nbsp;Andres&nbsp;Freund.<br></div><div style="padding: 6px 8px 4px; border-style: solid; border-color: rgb(217, 216, 209); border-width: 1px 0px 0px; font-style: italic; font-family: sans-serif; font-size: small; line-height: normal;"   ></div><table style="padding: 8px 4px; border-spacing: 0px; font-family: monospace; color: rgb(0, 0, 0); line-height: normal;"   ><tbody><tr style="background-color: rgb(246, 246, 240);"   ><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   ><a style="color: rgb(0, 0, 0); text-decoration: none;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/replication/walsender.c;h=4006c10ca43c8a9bb35c908c8cb8882feefaae87;hb=985bd7d49726c9f178558491d31a570d47340459"   >src/backend/replication/walsender.c</a></td><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   ></td><td style="padding: 2px 5px; font-size: 12px; vertical-align: top; font-family: sans-serif;"   ><a style="color: rgb(136, 0, 0);" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=blobdiff;f=src/backend/replication/walsender.c;h=4006c10ca43c8a9bb35c908c8cb8882feefaae87;hp=717cbfd61c6c58b38c44bf3f653e22e2e190fbc8;hb=985bd7d49726c9f178558491d31a570d47340459;hpb=4f14c86d7434376b95477aeeb07fcc7272f4c47d"   >diff</a>&nbsp;|&nbsp;<a style="color: rgb(136, 0, 0);" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/replication/walsender.c;h=4006c10ca43c8a9bb35c908c8cb8882feefaae87;hb=985bd7d49726c9f178558491d31a570d47340459"   >blob</a>&nbsp;|&nbsp;<a style="color: rgb(136, 0, 0);" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=blame;f=src/backend/replication/walsender.c;hb=985bd7d49726c9f178558491d31a570d47340459"   >blame</a>&nbsp;|&nbsp;<a style="color: rgb(136, 0, 0);" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=history;f=src/backend/replication/walsender.c;hb=985bd7d49726c9f178558491d31a570d47340459"   >history</a><br><br></td></tr></table></div><div>这个补丁支持9.1,9.2,9.3三个版本.</div><div>9.0因为流复制架构问题不支持这个补丁.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >In 9.0, the standby doesn't send back any message to the master and</font></div><div><font size="2"   >there is no way to know whether replication has been done up to</font></div><div><font size="2"   >the specified location, so I don't think that we can backpatch.</font></div><p></p></pre></div><div>下面来测试一下. 打补丁.</div><div>将新版本的walsender.c下载到源码对应目录下替换原有文件.</div><div><a target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=blob_plain;f=src/backend/replication/walsender.c;hb=985bd7d49726c9f178558491d31a570d47340459"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=blob_plain;f=src/backend/replication/walsender.c;hb=985bd7d49726c9f178558491d31a570d47340459</a></div><div>例如我这里的话替换 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-39-&gt; ll /opt/soft_bak/postgresql-9.3beta2/src/backend/replication/walsender.c</font></div><div><font size="2"   >-rw-r--r-- 1 root root 58K Jul 19 07:50 /opt/soft_bak/postgresql-9.3beta2/src/backend/replication/walsender.c</font></div><p></p></pre></div><div>替换后重新编译安装.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-39-&gt; cd /opt/soft_bak/postgresql-9.3beta2</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; gmake world</font></div></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; gmake install-world</font></div><p></p></pre></div><div>重启数据库 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >pg_ctl restart -m fast</font></p></pre></div><div>重新做主备角色切换测试正常.</div><div>感谢Fujii Masao和Andres Freund.</div><div>最后建议大家将9.1, 9.2, 9.3 的版本都打上这个补丁.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/message-id/flat/CAHGQGwE=zoGTLTxxRp5e06K3zgi-dMFCns31xDyRsEbnEhHT8A@mail.gmail.com#CAHGQGwE=zoGTLTxxRp5e06K3zgi-dMFCns31xDyRsEbnEhHT8A@mail.gmail.com"   >http://www.postgresql.org/message-id/flat/CAHGQGwE=zoGTLTxxRp5e06K3zgi-dMFCns31xDyRsEbnEhHT8A@mail.gmail.com#CAHGQGwE=zoGTLTxxRp5e06K3zgi-dMFCns31xDyRsEbnEhHT8A@mail.gmail.com</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=09bd2acbe5ac866ce93d7c0e6ed90b426a576f1b"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=09bd2acbe5ac866ce93d7c0e6ed90b426a576f1b</a></div><div>3.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201361111633593/"   >http://blog.163.com/digoal@126/blog/static/163877040201361111633593/</a></div><div>4.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=985bd7d49726c9f178558491d31a570d47340459"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=985bd7d49726c9f178558491d31a570d47340459</a></div></div>
	</div>
</div>
</body>
</html>