<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL Improve fsm & vm output</h2>
	<h5 id="">2013-07-19 16:09:04&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201361931250103/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div><div>以前写过一篇关于使用pageinspect和pgstattuple来精确计算数据库对象膨胀量的文章.</div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402013527920474/"   >http://blog.163.com/digoal@126/blog/static/1638770402013527920474/</a></div><div>用到的就是freespacemap的记录的字节流信息(256份). 有兴趣的朋友可以参看上文.</div><div>本文要讲的是pg_freespacemap和pgstattuple模块的新增功能</div><div>这个补丁涉及两个模块, pg_freespacemap和pgstattuple.&nbsp;</div><div>补丁过程如下 :&nbsp;</div><div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >cd&nbsp;<span style="line-height: 22px;"   >postgresql-9.3beta2</span></font></div><div style="line-height: 22px;"   ><font size="2"   >wget&nbsp;http://www.postgresql.org/message-id/attachment/29690/pgstattuple_vm_v2.patch</font></div><div style="line-height: 22px;"   ><font size="2"   >wget&nbsp;http://www.postgresql.org/message-id/attachment/29689/pg_freespace_vm_v3.patch</font></div><div style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-33 postgresql-9.3beta2]# patch -p1 &lt; ./pg_freespace_vm_v3.patch&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >patching file contrib/pg_freespacemap/Makefile</font></div><div style="line-height: 22px;"   ><font size="2"   >patching file contrib/pg_freespacemap/expected/pg_freespacemap.out</font></div><div style="line-height: 22px;"   ><font size="2"   >patching file contrib/pg_freespacemap/pg_freespacemap--1.0--1.1.sql</font></div><div style="line-height: 22px;"   ><font size="2"   >patching file contrib/pg_freespacemap/pg_freespacemap--1.0.sql</font></div><div style="line-height: 22px;"   ><font size="2"   >patching file contrib/pg_freespacemap/pg_freespacemap--1.1.sql</font></div><div style="line-height: 22px;"   ><font size="2"   >patching file contrib/pg_freespacemap/pg_freespacemap.c</font></div><div style="line-height: 22px;"   ><font size="2"   >patching file contrib/pg_freespacemap/pg_freespacemap.control</font></div><div style="line-height: 22px;"   ><font size="2"   >patching file contrib/pg_freespacemap/sql/pg_freespacemap.sql</font></div><div style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-33 postgresql-9.3beta2]# patch -p1 &lt; ./pgstattuple_vm_v2.patch&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >patching file contrib/pgstattuple/Makefile</font></div><div style="line-height: 22px;"   ><font size="2"   >patching file contrib/pgstattuple/expected/pgstattuple.out</font></div><div style="line-height: 22px;"   ><font size="2"   >patching file contrib/pgstattuple/pgstattuple--1.0--1.1.sql</font></div><div style="line-height: 22px;"   ><font size="2"   >patching file contrib/pgstattuple/pgstattuple--1.0--1.2.sql</font></div><div style="line-height: 22px;"   ><font size="2"   >patching file contrib/pgstattuple/pgstattuple--1.1--1.2.sql</font></div><div style="line-height: 22px;"   ><font size="2"   >patching file contrib/pgstattuple/pgstattuple--1.1.sql</font></div><div style="line-height: 22px;"   ><font size="2"   >patching file contrib/pgstattuple/pgstattuple--1.2.sql</font></div><div style="line-height: 22px;"   ><font size="2"   >patching file contrib/pgstattuple/pgstattuple.c</font></div><div style="line-height: 22px;"   ><font size="2"   >patching file contrib/pgstattuple/pgstattuple.control</font></div><div style="line-height: 22px;"   ><font size="2"   >patching file contrib/pgstattuple/sql/pgstattuple.sql</font></div></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-33 postgresql-9.3beta2]# gmake world</font></div><div style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-33 postgresql-9.3beta2]# gmake install-world</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >pg93@db-172-16-3-33-&gt; pg_ctl start</font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >digoal=# create extension pg_freespacemap;</font></div><div style="line-height: 22px;"   ><font size="2"   >CREATE EXTENSION</font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >digoal=# create extension pgstattuple;</font></div><div style="line-height: 22px;"   ><font size="2"   >CREATE EXTENSION</font></div></div><p></p></pre></div></div></div><div>下面测试一下打完补丁后的函数.</div><div><br></div><div>一. pg_freespacemap的更改体现在函数层面如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >+-- complain if script is sourced in psql, rather than via CREATE EXTENSION</font></div><div><font size="2"   >+\echo Use "CREATE EXTENSION pg_freespacemap" to load this file. \quit</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+-- Register the C function.</font></div><div><font size="2"   >+CREATE FUNCTION pg_freespace(regclass, bigint)</font></div><div><font size="2"   >+RETURNS int2</font></div><div><font size="2"   >+AS 'MODULE_PATHNAME', 'pg_freespace'</font></div><div><font size="2"   >+LANGUAGE C STRICT;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+CREATE FUNCTION pg_is_all_visible(regclass, bigint)</font></div><div><font size="2"   >+RETURNS bool</font></div><div><font size="2"   >+AS 'MODULE_PATHNAME', 'pg_is_all_visible'</font></div><div><font size="2"   >+LANGUAGE C STRICT;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+-- pg_freespace shows the recorded space avail at each block in a relation</font></div><div><font size="2"   >+CREATE FUNCTION</font></div><div><font size="2"   >+ &nbsp;pg_freespace(rel regclass, blkno OUT bigint, avail OUT int2)</font></div><div><font size="2"   >+RETURNS SETOF RECORD</font></div><div><font size="2"   >+AS $$</font></div><div><font size="2"   >+ &nbsp;SELECT blkno, pg_freespace($1, blkno) AS avail</font></div><div><font size="2"   >+ &nbsp;FROM generate_series(0, pg_relation_size($1) / current_setting('block_size')::bigint - 1) AS blkno;</font></div><div><font size="2"   >+$$</font></div><div><font size="2"   >+LANGUAGE SQL;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+CREATE FUNCTION</font></div><div><font size="2"   >+ &nbsp;pg_freespace_with_vminfo(rel regclass, blkno OUT bigint, avail OUT int2, is_all_visible OUT boolean)</font></div><div><font size="2"   >+RETURNS SETOF RECORD</font></div><div><font size="2"   >+AS $$</font></div><div><font size="2"   >+ &nbsp;SELECT blkno, pg_freespace($1, blkno) AS avail, pg_is_all_visible($1, blkno) as is_all_visible</font></div><div><font size="2"   >+ &nbsp;FROM generate_series(0, pg_relation_size($1) / current_setting('block_size')::bigint - 1) AS blkno;</font></div><div><font size="2"   >+$$</font></div><div><font size="2"   >+LANGUAGE SQL;</font></div><p></p></pre></div></div><div>测试 :&nbsp;</div><div>查看数据对对象指定的数据块中的记录是否所有记录对所有事务可见.</div><div>创建测试表 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table t1(id int, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into t1 select generate_series(1,1000),md5(random()::text);</font></div><div><font size="2"   >INSERT 0 1000</font></div><p></p></pre></div><div>此时查询visible的话, 所有的数据块都是false的, 因为还没有建立vm文件.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select * from pg_is_all_visible('t1'::regclass, 1);</font></div><div><font size="2"   >&nbsp;pg_is_all_visible&nbsp;</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp;f</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=# select pg_relation_filepath('t1'::regclass);</font></div><div><font size="2"   >&nbsp;pg_relation_filepath&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;base/16384/16410</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=# select * from pg_stat_file('base/16384/16410_vm');</font></div><div><font size="2"   >ERROR: &nbsp;could not stat file "base/16384/16410_vm": No such file or directory</font></div></div><p></p></pre></div><div>但是注意fsm文件已经有了.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select * from pg_stat_file('base/16384/16410_fsm');</font></div><div><font size="2"   >&nbsp;size &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; access &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;modification &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; change &nbsp; &nbsp; &nbsp; &nbsp; | creation | isdir&nbsp;</font></div><div><font size="2"   >-------+------------------------+------------------------+------------------------+----------+-------</font></div><div><font size="2"   >&nbsp;24576 | 2013-07-19 15:52:40+08 | 2013-07-19 15:52:40+08 | 2013-07-19 15:52:40+08 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=# vacuum analyze t1;</font></div><div><font size="2"   >VACUUM</font></div></div><p></p></pre></div><div>vacuum后, vm文件将被建立.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_stat_file('base/16384/16410_vm');</font></div><div><font size="2"   >&nbsp;size | &nbsp; &nbsp; &nbsp; &nbsp; access &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;modification &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; change &nbsp; &nbsp; &nbsp; &nbsp; | creation | isdir&nbsp;</font></div><div><font size="2"   >------+------------------------+------------------------+------------------------+----------+-------</font></div><div><font size="2"   >&nbsp;8192 | 2013-07-19 15:53:34+08 | 2013-07-19 15:53:34+08 | 2013-07-19 15:53:34+08 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>查看数据库对象的数据块范围</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select min(ctid),max(ctid) from t1;</font></div><div><font size="2"   >&nbsp; min &nbsp;| &nbsp;max &nbsp;&nbsp;</font></div><div><font size="2"   >-------+--------</font></div><div><font size="2"   >&nbsp;(0,1) | (8,40)</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>查看指定的BLOCK_ID的可见性, 现在vm中记录了的块信息为0-8. 都有了.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select * from pg_is_all_visible('t1'::regclass, 8);</font></div><div><font size="2"   >&nbsp;pg_is_all_visible&nbsp;</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp;t</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=# select * from pg_is_all_visible('t1'::regclass, 0);</font></div><div><font size="2"   >&nbsp;pg_is_all_visible&nbsp;</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp;t</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>删除一条记录, 然后查看它的可见性.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# delete from t1 where ctid='(0,1)';</font></div><div><font size="2"   >DELETE 1</font></div><p></p></pre></div><div>此时block 0为false, 因为有一条脏数据是需要vacuum的. 这个块信息将从vm信息中抹除.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_is_all_visible('t1'::regclass, 0);</font></div><div><font size="2"   >&nbsp;pg_is_all_visible&nbsp;</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp;f</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>vacuum后, 这个block_id又变得可见了(换言之又在vm这种了.).</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# vacuum analyze t1;</font></div><div><font size="2"   >VACUUM</font></div><div><font size="2"   >digoal=# select * from pg_is_all_visible('t1'::regclass, 0);</font></div><div><font size="2"   >&nbsp;pg_is_all_visible&nbsp;</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp;t</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div>vm文件的设计初衷也包含了减轻vacuum负担. 因为在vm中记录的数据块vacuum进程可以不用理会(除了某些特殊情况, 例如prevent xid wrap).&nbsp;</div><div>pg_freespace函数则可以用来查询数据块包含多少剩余空间.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_freespace('t1');</font></div><div><font size="2"   >&nbsp;blkno | avail&nbsp;</font></div><div><font size="2"   >-------+-------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp;64</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;3 | &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;4 | &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;5 | &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;6 | &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;7 | &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;8 | &nbsp;5440</font></div><div><font size="2"   >(9 rows)</font></div><p></p></pre></div><div>以上结果表明0,8号数据块的剩余空间是多少字节.</div><div><br></div><div><span style="line-height: 22px;"   >二. pgstattuple的更改体现在函数层面如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >+-- complain if script is sourced in psql, rather than via CREATE EXTENSION</font></div><div><font size="2"   >+\echo Use "CREATE EXTENSION pgstattuple" to load this file. \quit</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+CREATE FUNCTION pgstattuple(IN relname text,</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT table_len BIGINT, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-- physical table length in bytes</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT tuple_count BIGINT, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-- number of live tuples</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT tuple_len BIGINT, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-- total tuples length in bytes</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT tuple_percent FLOAT8, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-- live tuples in %</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT dead_tuple_count BIGINT, &nbsp; &nbsp; &nbsp; -- number of dead tuples</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT dead_tuple_len BIGINT, &nbsp; &nbsp; &nbsp; &nbsp; -- total dead tuples length in bytes</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT dead_tuple_percent FLOAT8, &nbsp; &nbsp; -- dead tuples in %</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT free_space BIGINT, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -- free space in bytes</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT free_percent FLOAT8, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -- free space in %</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT all_visible_percent FLOAT8) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-- all visible blocks in %</font></div><div><font size="2"   >+AS 'MODULE_PATHNAME', 'pgstattuple'</font></div><div><font size="2"   >+LANGUAGE C STRICT;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+CREATE FUNCTION pgstattuple(IN reloid oid,</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT table_len BIGINT, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-- physical table length in bytes</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT tuple_count BIGINT, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-- number of live tuples</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT tuple_len BIGINT, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-- total tuples length in bytes</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT tuple_percent FLOAT8, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-- live tuples in %</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT dead_tuple_count BIGINT, &nbsp; &nbsp; &nbsp; -- number of dead tuples</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT dead_tuple_len BIGINT, &nbsp; &nbsp; &nbsp; &nbsp; -- total dead tuples length in bytes</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT dead_tuple_percent FLOAT8, &nbsp; &nbsp; -- dead tuples in %</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT free_space BIGINT, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -- free space in bytes</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT free_percent FLOAT8, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -- free space in %</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT all_visible_percent FLOAT8) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-- all visible blocks in %</font></div><div><font size="2"   >+AS 'MODULE_PATHNAME', 'pgstattuplebyid'</font></div><div><font size="2"   >+LANGUAGE C STRICT;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+CREATE FUNCTION pgstatindex(IN relname text,</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT version INT,</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT tree_level INT,</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT index_size BIGINT,</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT root_block_no BIGINT,</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT internal_pages BIGINT,</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT leaf_pages BIGINT,</font></div></div><div><div><font size="2"   >+ &nbsp; &nbsp;OUT empty_pages BIGINT,</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT deleted_pages BIGINT,</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT avg_leaf_density FLOAT8,</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT leaf_fragmentation FLOAT8)</font></div><div><font size="2"   >+AS 'MODULE_PATHNAME', 'pgstatindex'</font></div><div><font size="2"   >+LANGUAGE C STRICT;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+CREATE FUNCTION pg_relpages(IN relname text)</font></div><div><font size="2"   >+RETURNS BIGINT</font></div><div><font size="2"   >+AS 'MODULE_PATHNAME', 'pg_relpages'</font></div><div><font size="2"   >+LANGUAGE C STRICT;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+CREATE FUNCTION pgstatginindex(IN relname regclass,</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT version INT4,</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT pending_pages INT4,</font></div><div><font size="2"   >+ &nbsp; &nbsp;OUT pending_tuples BIGINT)</font></div><div><font size="2"   >+AS 'MODULE_PATHNAME', 'pgstatginindex'</font></div><div><font size="2"   >+LANGUAGE C STRICT;</font></div></div><p></p></pre></div><div>测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pgstattuple('t1');</font></div><div><font size="2"   >-[ RECORD 1 ]-------+------</font></div><div><font size="2"   >table_len &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 73728</font></div><div><font size="2"   >tuple_count &nbsp; &nbsp; &nbsp; &nbsp; | 999</font></div><div><font size="2"   >tuple_len &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 60939</font></div><div><font size="2"   >tuple_percent &nbsp; &nbsp; &nbsp; | 82.65</font></div><div><font size="2"   >dead_tuple_count &nbsp; &nbsp;| 0</font></div><div><font size="2"   >dead_tuple_len &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"   >dead_tuple_percent &nbsp;| 0</font></div><div><font size="2"   >free_space &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 5540</font></div><div><font size="2"   >free_percent &nbsp; &nbsp; &nbsp; &nbsp;| 7.51</font></div><div><font size="2"   >all_visible_percent | 100</font></div><p></p></pre></div><div>增加了all_visible_percent这个输出, 代表百分之多少的块是在VM中的, 越多的话vacuum这个表将越快. 因为可以忽略掉很多数据块的检测.</div><div>接下来执行一个删除动作. 将把0号块从vm中抹除.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# delete from t1 where ctid='(0,2)';</font></div><div><font size="2"   >DELETE 1</font></div></div><div><div><font size="2"   >digoal=# select * from pgstattuple('t1');</font></div><div><font size="2"   >-[ RECORD 1 ]-------+------</font></div><div><font size="2"   >table_len &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 73728</font></div><div><font size="2"   >tuple_count &nbsp; &nbsp; &nbsp; &nbsp; | 998</font></div><div><font size="2"   >tuple_len &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 60878</font></div><div><font size="2"   >tuple_percent &nbsp; &nbsp; &nbsp; | 82.57</font></div><div><font size="2"   >dead_tuple_count &nbsp; &nbsp;| 1</font></div><div><font size="2"   >dead_tuple_len &nbsp; &nbsp; &nbsp;| 61</font></div><div><font size="2"   >dead_tuple_percent &nbsp;| 0.08</font></div><div><font size="2"   >free_space &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 5540</font></div><div><font size="2"   >free_percent &nbsp; &nbsp; &nbsp; &nbsp;| 7.51</font></div><div><font size="2"   >all_visible_percent | 88.89</font></div></div><p></p></pre></div><div>9个块中有8个块是all visible的. 所以all_visible_percent是88.89;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select 8/9.0;</font></div><div><font size="2"   >-[ RECORD 1 ]--------------------</font></div><div><font size="2"   >?column? | 0.88888888888888888889</font></div><p></p></pre></div><div><br></div></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/message-id/flat/20130614.174415.66698858.horiguchi.kyotaro@lab.ntt.co.jp#20130614.174415.66698858.horiguchi.kyotaro@lab.ntt.co.jp"   >http://www.postgresql.org/message-id/flat/20130614.174415.66698858.horiguchi.kyotaro@lab.ntt.co.jp#20130614.174415.66698858.horiguchi.kyotaro@lab.ntt.co.jp</a></div><div>2.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/1638770402013527920474/"   >http://blog.163.com/digoal@126/blog/static/1638770402013527920474/</a></div></div>
	</div>
</div>
</body>
</html>