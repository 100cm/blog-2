<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 pgbench improve test target with --rate option</h2>
	<h5 id="">2013-07-24 11:31:39&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201362310598977/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.4 pgbench功能扩展, 新增对事务提交速率控制的选项.</div><div>-R 或者--rate</div><div>&nbsp; -R, --rate=SPEC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;target rate in transactions per second</div><div>限定每秒提交多少事务数, 当限定的速率超过实际数据库能够处理的速率时, 限定不起作用.</div><div>仅仅当限定速率小于数据库实际能够处理的速率时, 限定才会起到作用.</div><div>限定速率可以观察数据库在各种压力下的使用情况, 如服务器的IO情况, CPU使用情况, 网络吞吐量等.</div><div>速率限定采用泊松分布原理, 从客户端启动开始计时, 每个事务启动时都可以得知已经执行到第几个事务了, 除以时间流逝即可得知速率.&nbsp;</div><div>如果速率超过限定速率, 那么客户端线程会sleep一定时间再发起新的事物请求. 始终保持一定的速率运行.</div><div>如果实际运行速率没有达到限定的速率, 那么就产生了lag, 后面的请求如果处理速度够快的话也许还能追上限定的速率, 否则后面都会造成lag.</div><div>所有的lag时间除以所有lag的事务数就是平均的lag time, 最大lag time指lag的事务中的单个事务启动时已经lag的时间.</div><div>例如 :&nbsp;</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >pg94@db-172-16-3-33-&gt; pgbench &nbsp;-M prepared -n -r -f ./test.sql -T 10 -c 8 -j 8 digoal</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 8</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 8</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 10 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 2587983</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 258720.166510 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 259010.954469 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.029530 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >下面的lag是速率限制造成的, 并不是数据库本身性能不行.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-33-&gt; pgbench &nbsp;-M prepared -n -r -f ./test.sql -R 200 -T 10 -c 8 -j 8 digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 1941</font></div><div><font size="2"   >average rate limit schedule lag: 0.556 ms (max 6.319 ms)</font></div><div><font size="2"   >tps = 191.575060 (including connections establishing)</font></div><div><font size="2"   >tps = 191.704861 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.053081 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><p></p></pre></div><div>把速率限制提到超过实际可以处理的能力.</div><div>速率限制将不会起作用.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-33-&gt; pgbench &nbsp;-M prepared -n -r -f ./test.sql -R 2000000 -T 10 -c 8 -j 8 digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 2586459</font></div><div><font size="2"   >tps = 258587.355823 (including connections establishing)</font></div><div><font size="2"   >tps = 258790.415038 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.029560 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><p></p></pre></div><div>但是如果瞬时速率超过了限定速率的话, 限定也是会起作用的, 如下, 说明瞬时速率超过100W了.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-33-&gt; pgbench &nbsp;-M prepared -n -r -f ./test.sql -R 1000000 -T 10 -c 8 -j 8 digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 2589450</font></div><div><font size="2"   >average rate limit schedule lag: 3801.223 ms (max 7589.034 ms)</font></div><div><font size="2"   >tps = 258859.058792 (including connections establishing)</font></div><div><font size="2"   >tps = 259074.909875 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.029103 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=blobdiff;f=contrib/pgbench/pgbench.c;h=ad8e272c9109c755a67f32f6318b745a17fe4d10;hp=2ad8f0bb5b48411e2f8c5b5be76708f4a98768ac;hb=fc9f4e9f8c981bbc050e5566cf558112c938da2c;hpb=21e28e4531e761e7cdf1b9a0bbf0c06f6107686a"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=blobdiff;f=contrib/pgbench/pgbench.c;h=ad8e272c9109c755a67f32f6318b745a17fe4d10;hp=2ad8f0bb5b48411e2f8c5b5be76708f4a98768ac;hb=fc9f4e9f8c981bbc050e5566cf558112c938da2c;hpb=21e28e4531e761e7cdf1b9a0bbf0c06f6107686a</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/pgbench.html"   >http://www.postgresql.org/docs/devel/static/pgbench.html</a></div><div>3.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-R rate</font></div><div><font size="2"   >--rate=rate</font></div><div><font size="2"   >Execute transactions targeting the specified rate instead of running as fast as possible (the default). The rate is given in transactions per second. If the targeted rate is above the maximum possible rate, the rate limit won't impact the results.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The rate is targeted by starting transactions along a Poisson-distributed schedule time line. The expected finish time schedule moves forward based on when the client first started, not when the previous transaction ended. That approach means that when transactions go past their original scheduled end time, it is possible for later ones to catch up again.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >When throttling is active, the average and maximum transaction schedule lag time are reported in ms. This is the delay between the original scheduled transaction time and the actual transaction start times. The schedule lag shows whether a transaction was started on time or late. Once a client starts running behind its schedule, every following transaction can continue to be penalized for schedule lag. If faster transactions are able to catch up, it's possible for them to get back on schedule again. The lag measurement of every transaction is shown when pgbench is run with debugging output.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >High rate limit schedule lag values, that is lag values that are large compared to the actual transaction latency, indicate that something is amiss in the throttling process. High schedule lag can highlight a subtle problem there even if the target rate limit is met in the end. One possible cause of schedule lag is insufficient pgbench threads to handle all of the clients. To improve that, consider reducing the number of clients, increasing the number of threads in pgbench, or running pgbench on a separate host. Another possibility is that the database is not keeping up with the load at some point. When that happens, you will have to reduce the expected transaction rate to lower schedule lag.</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>