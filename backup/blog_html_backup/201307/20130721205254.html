<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 enable new error fields in plpgsql exception handler use RAISE and GET STACKED DIAGNOSTICS</h2>
	<h5 id="">2013-07-21 20:52:54&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020136216202632/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><span style="line-height: 22px;"   >PostgreSQL 9.4 将新增几个异常捕获的变量类型, 补丁已提交. 包括COLUMN_NAME, CONSTRAINT_NAME, PG_DATATYPE_NAME, TABLE_NAME, SCHEMA_NAME, 其中PG_DATATYPE_NAME为SQL标准扩展.</span></div><div><p style="line-height: 1.5em; margin: 1.2em 0em; font-family: verdana, sans-serif;"   ><font size="2"   >Table 40-1. Error diagnostics values</font></p><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; background-color: rgb(224, 236, 239); border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 13.333333969116211px; line-height: normal;"   ><colgroup><col><col><col><thead><tr><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   ><font size="2"   >Name</font></th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   ><font size="2"   >Type</font></th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   ><font size="2"   >Description</font></th></tr></thead><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >RETURNED_SQLSTATE</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >text</font></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >the SQLSTATE error code of the exception</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >COLUMN_NAME</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >text</font></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >the name of column related to exception</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >CONSTRAINT_NAME</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >text</font></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >the name of constraint related to exception</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >PG_DATATYPE_NAME</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >text</font></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >the name of datatype related to exception</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >MESSAGE_TEXT</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >text</font></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >the text of the exception's primary message</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >TABLE_NAME</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >text</font></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >the name of table related to exception</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >SCHEMA_NAME</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >text</font></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >the name of schema related to exception</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >PG_EXCEPTION_DETAIL</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >text</font></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >the text of the exception's detail message, if any</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >PG_EXCEPTION_HINT</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >text</font></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >the text of the exception's hint message, if any</font></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><font size="2"   >PG_EXCEPTION_CONTEXT</font></tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >text</font></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><font size="2"   >line(s) of text describing the call stack</font></td></tr></table></div><div>这些变量只在plpgsql的exception handler处理块中定义, 其他部分不能使用. 在exception handler中使用RAISE和GET&nbsp;STACKED DIAGNOSTICS即可得到这些变量的值.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v1 text;</font></div><div><font size="2"   >&nbsp; v2 text;</font></div><div><font size="2"   >&nbsp; v3 text;</font></div><div><font size="2"   >&nbsp; v4 text;</font></div><div><font size="2"   >&nbsp; v5 text;</font></div><div><font size="2"   >&nbsp; v6 text;</font></div><div><font size="2"   >&nbsp; v7 text;</font></div><div><font size="2"   >&nbsp; v8 text;</font></div><div><font size="2"   >&nbsp; v9 text;</font></div><div><font size="2"   >&nbsp; v10 text;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select * from ab;</font></div><div><font size="2"   >&nbsp; exception&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; when others then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; GET STACKED DIAGNOSTICS&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v1 := RETURNED_SQLSTATE,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v2 := COLUMN_NAME,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v3 := CONSTRAINT_NAME,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v4 := PG_DATATYPE_NAME,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v5 := MESSAGE_TEXT,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v6 := TABLE_NAME,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v7 := SCHEMA_NAME,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v8 := PG_EXCEPTION_DETAIL,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v9 := PG_EXCEPTION_HINT,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v10 := PG_EXCEPTION_CONTEXT;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice '1%-2%-3%-4%-5%-6%-7%-8%-9%-10%', v1, v2, v3, v4, v5, v6, v7, v8, v9, v10;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >NOTICE: &nbsp;142P01-2-3-4-5relation "ab" does not exist-6-7-8-9-10PL/pgSQL function inline_code_block line 14 at SQL statement</font></div><div><font size="2"   >DO</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v1 text;</font></div><div><font size="2"   >&nbsp; v2 text;</font></div><div><font size="2"   >&nbsp; v3 text;</font></div><div><font size="2"   >&nbsp; v4 text;</font></div><div><font size="2"   >&nbsp; v5 text;</font></div><div><font size="2"   >&nbsp; v6 text;</font></div><div><font size="2"   >&nbsp; v7 text;</font></div><div><font size="2"   >&nbsp; v8 text;</font></div><div><font size="2"   >&nbsp; v9 text;</font></div><div><font size="2"   >&nbsp; v10 text;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; create table test1(id int primary key);&nbsp;</font></div><div><font size="2"   >&nbsp; insert into test1 values (1),(1);</font></div><div><font size="2"   >&nbsp; exception&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; when others then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; GET STACKED DIAGNOSTICS&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v1 := RETURNED_SQLSTATE,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v2 := COLUMN_NAME,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v3 := CONSTRAINT_NAME,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v4 := PG_DATATYPE_NAME,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v5 := MESSAGE_TEXT,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v6 := TABLE_NAME,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v7 := SCHEMA_NAME,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v8 := PG_EXCEPTION_DETAIL,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v9 := PG_EXCEPTION_HINT,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v10 := PG_EXCEPTION_CONTEXT;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice '1%-2%-3%-4%-5%-6%-7%-8%-9%-10%', v1, v2, v3, v4, v5, v6, v7, v8, v9, v10;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >NOTICE: &nbsp;123505-2-3test1_pkey-4-5duplicate key value violates unique constraint "test1_pkey"-6test1-7public-8Key (id)=(1) already exists.-9-10SQL statement "insert into test1 values (1),(1)"</font></div><div><font size="2"   >PL/pgSQL function inline_code_block line 14 at SQL statement</font></div><div><font size="2"   >DO</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/message-id/flat/CAFj8pRC80Xc+Qf5HZuzCQFDBMXOFLXZzn9UMXa7GQCm3OHtL+w@mail.gmail.com#CAFj8pRC80Xc+Qf5HZuzCQFDBMXOFLXZzn9UMXa7GQCm3OHtL+w@mail.gmail.com"   >http://www.postgresql.org/message-id/flat/CAFj8pRC80Xc+Qf5HZuzCQFDBMXOFLXZzn9UMXa7GQCm3OHtL+w@mail.gmail.com#CAFj8pRC80Xc+Qf5HZuzCQFDBMXOFLXZzn9UMXa7GQCm3OHtL+w@mail.gmail.com</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/plpgsql-control-structures.html"   >http://www.postgresql.org/docs/devel/static/plpgsql-control-structures.html</a></div><div>3.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/plpgsql-errors-and-messages.html"   >http://www.postgresql.org/docs/devel/static/plpgsql-errors-and-messages.html</a></div></div>
	</div>
</div>
</body>
</html>