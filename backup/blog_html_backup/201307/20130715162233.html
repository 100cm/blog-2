<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL function cost performance tuning</h2>
	<h5 id="">2013-07-15 16:22:33&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201361491337541/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前段时间介绍过关于视图限制条件被攻克的文章, 通过调整函数成本的方法来控制查询树中节点执行的顺序.</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201361031431669/"   >http://blog.163.com/digoal@126/blog/static/163877040201361031431669/</a></div><div>本文将要介绍通过调整函数成本来优化SQL语句的场景.</div><wbr><div>创建测试表 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table dir1(id int primary key, info name);</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "dir1_pkey" for table "dir1"</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# create table test(dir1_id int, col1 text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><span style="line-height: 22px;"   ><font size="2"   >digoal=# create index idx_test_1 on test(col1);</font></span></div><p></p></pre></div><div>插入测试数据</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into dir1 select generate_series(1,10000),md5(random()::text);</font></div><div><font size="2"   >INSERT 0 10000</font></div><div><div><font size="2"   >digoal=# insert into test select 1,md5(random()::text) from generate_series(1,3);</font></div><div><font size="2"   >INSERT 0 3</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >创建测试函数</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace function get_dir1(int) returns name as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_name name;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; raise notice '<span style="line-height: 22px;"   >get_dir1&nbsp;</span><span style="line-height: 22px;"   >called';</span></font></div><div><font size="2"   >&nbsp; select info into v_name from dir1 where id=$1 limit 1;</font></div><div><font size="2"   >&nbsp; return v_name;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql strict cost 0.1;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><p></p></pre></div><div>将要用到的关联数据 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from test ;</font></div><div><font size="2"   >&nbsp;dir1_id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; col1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------+----------------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1 | 83d87c9a250ca38878fa4137505e39da</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1 | e51a16dba9d22a0e34deddba4f8f361e</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1 | 2f9f6f3a1e1bb195f0a1d9af2d9c54c3</font></div><div><font size="2"   >(3 rows)</font></div><div><font size="2"   >digoal=# select * from dir1 where id=1 ;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----+----------------------------------</font></div><div><font size="2"   >&nbsp; 1 | 9e85accd8a9113e9804212a6f9a9e9e5</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>测试SQL 1 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from test where get_dir1(dir1_id)='9e85accd8a9113e9804212a6f9a9e9e5' and col1='7c1e6df53c8ef6c4ffe2f9c2ad45a42e';</font></div><div><font size="2"   >&nbsp;dir1_id | col1&nbsp;</font></div><div><font size="2"   >---------+------</font></div><div><font size="2"   >(0 rows)</font></div><p></p></pre></div><div>这个SQL get_dir1(int)没有被调用到. 下面来分析一下为什么它没有被调用.</div><div>首先get_dir1(int)的成本是多少? 结果0.1</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select procost from pg_proc where proname='get_dir1';</font></div><div><font size="2"   >&nbsp;procost&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0.1</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >接下来看看</span><span style="line-height: 22px;"   >get_dir1(dir1_id)='9e85accd8a9113e9804212a6f9a9e9e5'</span><span style="line-height: 22px;"   >这个表达式中用到的等号对应的函数的成本是多少?结果0.1&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select oid from pg_type where typname='name';</font></div><div><font size="2"   >&nbsp;oid&nbsp;</font></div><div><font size="2"   >-----</font></div><div><font size="2"   >&nbsp; 19</font></div><div><font size="2"   >(1 row)</font></div><div><div><font size="2"   >digoal=# select oprcode from pg_operator where oprname='=' and oprleft=19 and oprright=19;</font></div><div><font size="2"   >&nbsp;oprcode&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;nameeq</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=# select procost from pg_proc where proname='nameeq';</font></div><div><font size="2"   >&nbsp;procost&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0.1</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>接下来看看<span style="line-height: 22px;"   >col1='7c1e6df53c8ef6c4ffe2f9c2ad45a42e'这个表达式中的等号对应的函数的成本是多少?结果1</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >digoal=# select oid from pg_type where typname='text';</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;oid&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >-----</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; 25</font></div><div style="line-height: 22px;"   ><font size="2"   >(1 row)</font></div><div><div><font size="2"   >digoal=# select oprcode from pg_operator where oprname='=' and oprleft=25 and oprright=25;</font></div><div><font size="2"   >&nbsp;oprcode&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;texteq</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select procost from pg_proc where proname='texteq';</font></div><div><font size="2"   >&nbsp;procost&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div></div><div>从以上结果分析,&nbsp;<span style="line-height: 22px;"   >get_dir1(dir1_id)='9e85accd8a9113e9804212a6f9a9e9e5' 这个表达式的开销总和是0.2</span></div><div><span style="line-height: 22px;"   >col1='7c1e6df53c8ef6c4ffe2f9c2ad45a42e'这个表达式的开销是1.</span></div><div><span style="line-height: 22px;"   >正常情况下应该是先执行成本低的表达式, 但是这里为什么没有这么做呢?</span></div><div><span style="line-height: 22px;"   >来看看执行计划 :&nbsp;</span></div><div><span style="line-height: 22px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain analyze select * from test where get_dir1(dir1_id)='9e85accd8a9113e9804212a6f9a9e9e5' and col1='7c1e6df53c8ef6c4ffe2f9c2ad45a42e';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using idx_test_1 on test &nbsp;(cost=0.00..8.27 rows=1 width=37) (actual time=0.009..0.009 rows=0 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: (col1 = '7c1e6df53c8ef6c4ffe2f9c2ad45a42e'::text)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (get_dir1(dir1_id) = '9e85accd8a9113e9804212a6f9a9e9e5'::name)</font></div><div><font size="2"   >&nbsp;Total runtime: 0.027 ms</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div><div>原来它走索引了, 表达式<span style="line-height: 22px;"   >col1='7c1e6df53c8ef6c4ffe2f9c2ad45a42e'作为索引条件, 而不是过滤条件. 所以get_dir1(int)就没有机会被调用到了.</span></div></span><span style="line-height: 22px;"   ><div>如果使用一个已经存在的值,通过NOTICE可以看到get_dir1(int)被调用1次.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from test where get_dir1(dir1_id)='9e85accd8a9113e9804212a6f9a9e9e5' and col1='83d87c9a250ca38878fa4137505e39da';</font></div><div><font size="2"   >NOTICE: &nbsp;get_dir1 called</font></div><div><font size="2"   >&nbsp;dir1_id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; col1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------+----------------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1 | 83d87c9a250ca38878fa4137505e39da</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div></span></div><div><span style="line-height: 22px;"   >测试SQL 2 :&nbsp;</span></div><div><span style="line-height: 22px;"   >与上一条SQL一样, 只是这次不走索引.&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \d test</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; Table "public.test"</font></div><div><font size="2"   >&nbsp;Column &nbsp;| &nbsp;Type &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >---------+---------+-----------</font></div><div><font size="2"   >&nbsp;dir1_id | integer |&nbsp;</font></div><div><font size="2"   >&nbsp;col1 &nbsp; &nbsp;| text &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "idx_test_1" btree (col1)</font></div><div><font size="2"   >postgres=# drop index idx_test_1;</font></div><div><font size="2"   >LOG: &nbsp;statement: drop index idx_test_1;</font></div><div><font size="2"   >DROP INDEX</font></div><p></p></pre></div><div>现在看到, git_dir1(int)被调用了3次. 因为<span style="line-height: 22px;"   >get_dir1(dir1_id)='9e85accd8a9113e9804212a6f9a9e9e5'和</span><span style="line-height: 22px;"   >col1 = '7c1e6df53c8ef6c4ffe2f9c2ad45a42e'都在过滤条件中了, 那么就需要通过cost的大小来判断谁先执行.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain analyze select * from test where get_dir1(dir1_id)='9e85accd8a9113e9804212a6f9a9e9e5' and col1='7c1e6df53c8ef6c4ffe2f9c2ad45a42e';</font></div><div><font size="2"   >NOTICE: &nbsp;get_dir1 called</font></div><div><font size="2"   >NOTICE: &nbsp;get_dir1 called</font></div><div><font size="2"   >NOTICE: &nbsp;get_dir1 called</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on test &nbsp;(cost=0.00..25.73 rows=1 width=37) (actual time=0.155..0.155 rows=0 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: ((get_dir1(dir1_id) = '9e85accd8a9113e9804212a6f9a9e9e5'::name) AND (col1 = '7c1e6df53c8ef6c4ffe2f9c2ad45a42e'::text))</font></div><div><font size="2"   >&nbsp; &nbsp;Rows Removed by Filter: 3</font></div><div><font size="2"   >&nbsp;Total runtime: 0.175 ms</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div><div>使用执行树能看得更加清楚一些.&nbsp;</div><div>从执行树中能看出先执行哪个,后执行哪个.</div><div>执行树中使用oid来表述, 可以通过系统表来查询对应的函数,操作符等信息.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# set client_min_messages=debug;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# set debug_print_plan=on;</font></div><div><font size="2"   >SET</font></div></div><div><div><font size="2"   >digoal=# explain analyze select * from test where get_dir1(dir1_id)='9e85accd8a9113e9804212a6f9a9e9e5' and col1='7c1e6df53c8ef6c4ffe2f9c2ad45a42e';</font></div><div><font size="2"   >LOG: &nbsp;plan:</font></div><div><font size="2"   >DETAIL: &nbsp; &nbsp; {PLANNEDSTMT&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:commandType 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:queryId 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:hasReturning false&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:hasModifyingCTE false&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:canSetTag true&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:transientPlan false&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:planTree&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; {SEQSCAN&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :startup_cost 0.00&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :total_cost 25.73&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :plan_rows 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :plan_width 37&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :targetlist (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{TARGETENTRY&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:expr&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {VAR&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varno 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varattno 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :vartype 23&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :vartypmod -1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varcollid 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varlevelsup 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varnoold 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varoattno 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :location 23</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:resno 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:resname dir1_id&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:ressortgroupref 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:resorigtbl 32773&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:resorigcol 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:resjunk false</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{TARGETENTRY&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:expr&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {VAR&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varno 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varattno 2&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :vartype 25&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :vartypmod -1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varcollid 100&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varlevelsup 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varnoold 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varoattno 2&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :location 23</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:resno 2&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:resname col1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:ressortgroupref 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:resorigtbl 32773&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:resorigcol 2&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:resjunk false</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; )</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :qual (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{OPEXPR # 对应get_dir1(dir1_id)='9e85accd8a9113e9804212a6f9a9e9e5'::name</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:opno 93 # 对应=,&nbsp;select oprname,oprleft,oprright from pg_operator where oid=93;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:opfuncid 62 # 对应nameeq &nbsp;select proname from pg_proc where oid=62;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:opresulttype 16&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:opretset false&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:opcollid 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:inputcollid 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:args (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {FUNCEXPR&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :funcid 32785 # 对应<span style="line-height: 22px;"   >get_dir1(dir1_id),&nbsp;</span>select proname from pg_proc where oid=32785;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :funcresulttype 19&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :funcretset false&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :funcformat 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :funccollid 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :inputcollid 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :args (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{VAR&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:varno 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:varattno 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:vartype 23&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:vartypmod -1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:varcollid 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:varlevelsup 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:varnoold 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:varoattno 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:location 50</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :location 41</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {CONST&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :consttype 19&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :consttypmod -1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :constcollid 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :constlen 64&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :constbyval false&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :constisnull false&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :location 59&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :constvalue 64 [ 57 101 56 53 97 99 99 100 56 97 57 49 49 51 101 5</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 7 56 48 52 50 49 50 97 54 102 57 97 57 101 57 101 53 0 0 0 0 0 0 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ]</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:location 58</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{OPEXPR # 对应col1='7c1e6df53c8ef6c4ffe2f9c2ad45a42e'::text</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:opno 98 # 对应=,&nbsp;select oprname,oprleft,oprright from pg_operator where oid=98;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:opfuncid 67 # 对应texteq,&nbsp;select proname from pg_proc where oid=67;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:opresulttype 16&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:opretset false&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:opcollid 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:inputcollid 100&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:args (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {VAR&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varno 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varattno 2&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :vartype 25&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :vartypmod -1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varcollid 100&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varlevelsup 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varnoold 1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :varoattno 2&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :location 98</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {CONST&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :consttype 25&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :consttypmod -1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :constcollid 100&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :constlen -1&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :constbyval false&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :constisnull false&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :location 103&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :constvalue 36 [ -112 0 0 0 55 99 49 101 54 100 102 53 51 99 56 10</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 102 54 99 52 102 102 101 50 102 57 99 50 97 100 52 53 97 52 50 1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 01 ]</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:location 102</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; )</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :lefttree &lt;&gt;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :righttree &lt;&gt;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :initPlan &lt;&gt;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :extParam (b)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :allParam (b)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :scanrelid 1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp;:rtable (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; {RTE&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :alias &lt;&gt;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :eref&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{ALIAS&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:aliasname test&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:colnames ("dir1_id" "col1")</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :rtekind 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :relid 32773&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :relkind r&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :inh false&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :inFromCl true&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :requiredPerms 2&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :checkAsUser 0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :selectedCols (b 9 10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :modifiedCols (b)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp;)</font></div><div><font size="2"   >&nbsp; &nbsp;:resultRelations &lt;&gt;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:utilityStmt &lt;&gt;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:subplans &lt;&gt;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:rewindPlanIDs (b)</font></div><div><font size="2"   >&nbsp; &nbsp;:rowMarks &lt;&gt;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;:relationOids (o 32773)</font></div><div><font size="2"   >&nbsp; &nbsp;:invalItems (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; {PLANINVALITEM&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :cacheId 40&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; :hashValue 3188174810</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp;)</font></div><div><font size="2"   >&nbsp; &nbsp;:nParamExec 0</font></div><div><font size="2"   >&nbsp; &nbsp;}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >NOTICE: &nbsp;get_dir1 called</font></div><div><font size="2"   >NOTICE: &nbsp;get_dir1 called</font></div><div><font size="2"   >NOTICE: &nbsp;get_dir1 called</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on test &nbsp;(cost=0.00..25.73 rows=1 width=37) (actual time=0.182..0.182 rows=0 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: ((get_dir1(dir1_id) = '9e85accd8a9113e9804212a6f9a9e9e5'::name) AND (col1 = '7c1e6df53c8ef6c4ffe2f9c2ad45a42e'::text))</font></div><div><font size="2"   >&nbsp; &nbsp;Rows Removed by Filter: 3</font></div><div><font size="2"   >&nbsp;Total runtime: 0.204 ms</font></div><div><font size="2"   >(4 rows)</font></div></div><p></p></pre></div><div>因为先执行<span style="line-height: 22px;"   >get_dir1</span><span style="line-height: 22px;"   >&nbsp;, 所以每条记录都被调用一次, 总计调用了3次.</span></div><div>通过调整cost的值即可决定哪个表达式先执行, 例如降低texteq的cost. 那么会先调用texteq, 后调用get_dir(int)=?</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# alter function texteq(text,text) cost 0.19;</font></div><div><font size="2"   >ALTER FUNCTION</font></div></div><div><div><font size="2"   >digoal=# select * from test where get_dir1(dir1_id)='9e85accd8a9113e9804212a6f9a9e9e5' and col1='83d87c9a250ca38878fa4137505e39da';</font></div><div><font size="2"   >NOTICE: &nbsp;get_dir1 called</font></div><div><font size="2"   >&nbsp;dir1_id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; col1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------+----------------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1 | 83d87c9a250ca38878fa4137505e39da</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# explain analyze select * from test where get_dir1(dir1_id)='9e85accd8a9113e9804212a6f9a9e9e5' and col1='83d87c9a250ca38878fa4137505e39da';</font></div><div><font size="2"   >NOTICE: &nbsp;get_dir1 called</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on test &nbsp;(cost=0.00..23.28 rows=1 width=37) (actual time=0.080..0.081 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: ((col1 = '83d87c9a250ca38878fa4137505e39da'::text) AND (get_dir1(dir1_id) = '9e85accd8a9113e9804212a6f9a9e9e5'::name))</font></div><div><font size="2"   >&nbsp; &nbsp;Rows Removed by Filter: 2</font></div><div><font size="2"   >&nbsp;Total runtime: 0.100 ms</font></div><div><font size="2"   >(4 rows)</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >调成texteq更大, 那么会先调用</span><span style="line-height: 22px;"   >get_dir(int)=?</span><span style="line-height: 22px;"   >, 后调用texteq.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# alter function texteq(text,text) cost 0.21;</font></div><div><font size="2"   >ALTER FUNCTION</font></div><div><font size="2"   >digoal=# explain analyze select * from test where get_dir1(dir1_id)='9e85accd8a9113e9804212a6f9a9e9e5' and col1='83d87c9a250ca38878fa4137505e39da';</font></div><div><font size="2"   >NOTICE: &nbsp;get_dir1 called</font></div><div><font size="2"   >NOTICE: &nbsp;get_dir1 called</font></div><div><font size="2"   >NOTICE: &nbsp;get_dir1 called</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on test &nbsp;(cost=0.00..23.34 rows=1 width=37) (actual time=0.038..0.084 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: ((get_dir1(dir1_id) = '9e85accd8a9113e9804212a6f9a9e9e5'::name) AND (col1 = '83d87c9a250ca38878fa4137505e39da'::text))</font></div><div><font size="2"   >&nbsp; &nbsp;Rows Removed by Filter: 2</font></div><div><font size="2"   >&nbsp;Total runtime: 0.092 ms</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   >digoal=# select * from test where get_dir1(dir1_id)='9e85accd8a9113e9804212a6f9a9e9e5' and col1='83d87c9a250ca38878fa4137505e39da';</font></div><div><font size="2"   >NOTICE: &nbsp;get_dir1 called</font></div><div><font size="2"   >NOTICE: &nbsp;get_dir1 called</font></div><div><font size="2"   >NOTICE: &nbsp;get_dir1 called</font></div><div><font size="2"   >&nbsp;dir1_id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; col1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------+----------------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1 | 83d87c9a250ca38878fa4137505e39da</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"   >测试SQL 3 :&nbsp;</span></div><div><span style="line-height: 22px;"   >1. 调整函数的成本有什么意义呢?</span></div><div><span style="line-height: 22px;"   >下面分别创建一个慢函数和一个快函数.</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >digoal=# create or replace function fast(boolean) returns boolean as $$</font></div><div style="line-height: 22px;"   ><font size="2"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; raise notice 'fast';</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; return $1; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >end; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >$$ language plpgsql strict cost 1;</font></div><div style="line-height: 22px;"   ><font size="2"   >CREATE FUNCTION</font></div><div style="line-height: 22px;"   ><div><font size="2"   >digoal=# create or replace function slow(boolean) returns boolean as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; perform pg_sleep(2); -- 延迟2秒.</font></div><div><font size="2"   >&nbsp; raise notice 'slow';</font></div><div><font size="2"   >&nbsp; return $1;</font></div><div><font size="2"   >end; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >$$ language plpgsql strict cost 1;</font></div><div><font size="2"   >CREATE FUNCTION</font></div></div><p></p></pre></div><div style="line-height: 22px;"   >接下来做一个查询.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select 1 where fast(false) and slow(false);</font></div><div><font size="2"   >NOTICE: &nbsp;fast</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >(0 rows)</font></div><div><font size="2"   >Time: 0.256 ms</font></div><div><font size="2"   >digoal=# select 1 where slow(false) and fast(false);</font></div><div><font size="2"   >NOTICE: &nbsp;slow</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >(0 rows)</font></div><div><font size="2"   >Time: 2000.128 ms</font></div><p></p></pre></div></div><div><span style="line-height: 22px;"   >对于and的过滤条件, 只要第一个条件为false, 后面就不用再执行了.</span></div><div>当cost一样的情况下, 执行顺序和SQL的写法有关. 先执行前面.</div><div>但是我们已知slow函数更慢的时候,可以调整它的cost更大, 那么执行计划会把它排到后面执行.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# alter function slow(boolean) cost 100;</font></div><div><font size="2"   >ALTER FUNCTION</font></div><div><font size="2"   >Time: 0.125 ms</font></div><div><font size="2"   >digoal=# select 1 where slow(false) and fast(false);</font></div><div><font size="2"   >NOTICE: &nbsp;fast</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >(0 rows)</font></div><div><font size="2"   >Time: 0.173 ms</font></div><p></p></pre></div><div>上面的例子很好的说明了函数cost在SQL优化中占有非常重要的意义. 特别是数据分析函数, 成本的精确性很重要.</div><div><br></div><div>[注意]</div><div>1. 在计算过滤条件的cost时, 不要忘记操作符的成本.&nbsp;</div><div>例如本例中的get_dir1(dir1_id)='9e85accd8a9113e9804212a6f9a9e9e5'表达式, 不要忘记=的成本.</div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201361031431669/"   >http://blog.163.com/digoal@126/blog/static/163877040201361031431669/</a></div><div><br></div></div></div>
	</div>
</div>
</body>
</html>