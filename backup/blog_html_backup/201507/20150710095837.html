<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.5 new feature - Allow pushdown of WHERE quals into subqueries with window functions</h2>
	<h5 id="">2015-07-10 9:58:37&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201561095327964/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.5 允许将WHERE条件下发至带有窗口查询的子查询，注意窗口查询是带分组的，所以这种下发适用于WHERE条件中有过滤分组字段的，通过这种方法可以减少窗口查询的分组，从而提高效率。</div><div>要下发WHERE 条件到窗口子查询，前提条件是WHERE条件中包含分组任意字段，条件操作符或函数必须是immutable或stable的，不能包含volatile函数。</div><div><div>Allow pushdown of WHERE quals into subqueries with window functions.</div><div><br></div><div>We can allow this even without any specific knowledge of the semantics</div><div>of the window function, so long as pushed-down quals will either accept</div><div>every row in a given window partition, or reject every such row. &nbsp;Because</div><div>window functions act only within a partition, such a case can't result</div><div>in changing the window functions' outputs for any surviving row.</div><div>Eliminating entire partitions in this way obviously can reduce the cost</div><div>of the window-function computations substantially.</div><div><br></div><div>The fly in the ointment is that it's hard to be entirely sure whether</div><div>this is true for an arbitrary qual condition. &nbsp;This patch allows pushdown</div><div>if (a) the qual references only partitioning columns, and (b) the qual</div><div>contains no volatile functions. &nbsp;We are at risk of incorrect results if</div><div>the qual can produce different answers for values that the partitioning</div><div>equality operator sees as equal. &nbsp;While it's not hard to invent cases</div><div>for which that can happen, it seems to seldom be a problem in practice,</div><div>since no one has complained about a similar assumption that we've had</div><div>for many years with respect to DISTINCT. &nbsp;The potential performance</div><div>gains seem to be worth the risk.</div><div><br></div><div>David Rowley, reviewed by Vik Fearing; some credit is due also to</div><div>Thomas Mayer who did considerable preliminary investigation.</div></div><div><br></div><div>测试：</div><div>允许下发</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >+-- Test pushdown of quals into a subquery containing window functions</font></div><div><font size="2"   >+-- pushdown is safe because all PARTITION BY clauses include depname:</font></div><div><font size="2"   >+EXPLAIN (COSTS OFF)</font></div><div><font size="2"   >+SELECT * FROM</font></div><div><font size="2"   >+ &nbsp;(SELECT depname,</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sum(salary) OVER (PARTITION BY depname) depsalary,</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;min(salary) OVER (PARTITION BY depname || 'A', depname) depminsalary</font></div><div><font size="2"   >+ &nbsp; FROM empsalary) emp</font></div><div><font size="2"   >+WHERE depname = 'sales';</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >+---------------------------------------------------------------------</font></div><div><font size="2"   >+ Subquery Scan on emp</font></div><div><font size="2"   >+ &nbsp; -&gt; &nbsp;WindowAgg</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; -&gt; &nbsp;Sort</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Sort Key: (((empsalary.depname)::text || 'A'::text))</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -&gt; &nbsp;WindowAgg</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -&gt; &nbsp;Seq Scan on empsalary</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Filter: ((depname)::text = 'sales'::text)</font></div><div><font size="2"   >+(7 rows)</font></div><div><font size="2"   >+</font></div><p></p></pre></div><div>不允许下发</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >+-- pushdown is unsafe because there's a PARTITION BY clause without depname:</font></div><div><font size="2"   >+EXPLAIN (COSTS OFF)</font></div><div><font size="2"   >+SELECT * FROM</font></div><div><font size="2"   >+ &nbsp;(SELECT depname,</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sum(salary) OVER (PARTITION BY enroll_date) enroll_salary,</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;min(salary) OVER (PARTITION BY depname) depminsalary</font></div><div><font size="2"   >+ &nbsp; FROM empsalary) emp</font></div><div><font size="2"   >+WHERE depname = 'sales';</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >+-----------------------------------------------------------</font></div><div><font size="2"   >+ Subquery Scan on emp</font></div><div><font size="2"   >+ &nbsp; Filter: ((emp.depname)::text = 'sales'::text)</font></div><div><font size="2"   >+ &nbsp; -&gt; &nbsp;WindowAgg</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; -&gt; &nbsp;Sort</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Sort Key: empsalary.depname</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -&gt; &nbsp;WindowAgg</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -&gt; &nbsp;Sort</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Sort Key: empsalary.enroll_date</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -&gt; &nbsp;Seq Scan on empsalary</font></div><div><font size="2"   >+(9 rows)</font></div><div><font size="2"   >+</font></div><p></p></pre></div></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=d222585a9f7a18f2d793785c82be4c877b90c461"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=d222585a9f7a18f2d793785c82be4c877b90c461</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL 9.5 new feature - Allow pushdown of WHERE quals into subqueries with window functions - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>