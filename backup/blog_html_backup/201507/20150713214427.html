<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">pg_locks.virtualxid & transactionid</h2>
	<h5 id="">2015-07-13 21:44:27&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020156136857214/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div><div>在pg_locks中，你可能会注意到两个字段virtualxid和transactionid，这两个字段到底有什么分别呢？</div><div><p style="font-size: 12.1599998474121px; line-height: 1.5em; margin: 1.2em 0em; font-weight: bold; font-family: verdana, sans-serif;"   >Table 48-61.&nbsp;<tt>pg_locks</tt>&nbsp;Columns</p><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: normal; background-color: rgb(224, 236, 239);"   ><colgroup><col><col><col><col><thead><tr><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Name</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Type</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >References</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Description</th></tr></thead><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>locktype</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>text</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Type of the lockable object:&nbsp;<tt>relation</tt>,&nbsp;<tt>extend</tt>,&nbsp;<tt>page</tt>,&nbsp;<tt>tuple</tt>,&nbsp;<tt>transactionid</tt>,&nbsp;<tt>virtualxid</tt>,&nbsp;<tt>object</tt>,&nbsp;<tt>userlock</tt>, or&nbsp;<tt>advisory</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>database</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>oid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt><a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/catalog-pg-database.html"   ><tt style="font-size: 1em;"   >pg_database</tt></a>.oid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >OID of the database in which the lock target exists, or zero if the target is a shared object, or null if the target is a transaction ID</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>relation</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>oid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt><a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/catalog-pg-class.html"   ><tt style="font-size: 1em;"   >pg_class</tt></a>.oid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >OID of the relation targeted by the lock, or null if the target is not a relation or part of a relation</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>page</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>integer</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Page number targeted by the lock within the relation, or null if the target is not a relation page or tuple</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>tuple</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>smallint</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Tuple number targeted by the lock within the page, or null if the target is not a tuple</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>virtualxid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>text</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Virtual ID of the transaction targeted by the lock, or null if the target is not a virtual transaction ID</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>transactionid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>xid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >ID of the transaction targeted by the lock, or null if the target is not a transaction ID</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>classid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>oid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt><a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/catalog-pg-class.html"   ><tt style="font-size: 1em;"   >pg_class</tt></a>.oid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >OID of the system catalog containing the lock target, or null if the target is not a general database object</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>objid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>oid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >any OID column</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >OID of the lock target within its system catalog, or null if the target is not a general database object</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>objsubid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>smallint</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Column number targeted by the lock (the&nbsp;<tt>classid</tt>&nbsp;and&nbsp;<tt>objid</tt>&nbsp;refer to the table itself), or zero if the target is some other general database object, or null if the target is not a general database object</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>virtualtransaction</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>text</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Virtual ID of the transaction that is holding or awaiting this lock</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>pid</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>integer</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Process ID of the server process holding or awaiting this lock, or null if the lock is held by a prepared transaction</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>mode</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>text</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >Name of the lock mode held or desired by this process (see&nbsp;<a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/explicit-locking.html#LOCKING-TABLES"   >Section 13.3.1</a>&nbsp;and&nbsp;<a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/transaction-iso.html#XACT-SERIALIZABLE"   >Section 13.2.3</a>)</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>granted</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>boolean</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >True if lock is held, false if lock is awaited</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>fastpath</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>boolean</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >True if lock was taken via fast path, false if taken via main lock table</td></tr></table></div><div>从字义上来看，一个是虚拟事务号，一个是事务号。</div><div>实际上他们表达的意思也是不一样的，虚拟事务号由两个部分组成，分别是backendid和local transaction id。</div><div>例如：</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select * from pg_locks where locktype='virtualxid';</font></div><div><font size="2"   >-[ RECORD 1 ]------+--------------</font></div><div><font size="2"   >locktype &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | virtualxid</font></div><div><font size="2"   >database &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >relation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >page &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >tuple &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >virtualxid &nbsp; &nbsp; &nbsp; &nbsp; | 2/412048</font></div><div><font size="2"   >transactionid &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >classid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >objid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >objsubid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >virtualtransaction | 2/412048</font></div><div><font size="2"   >pid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 24401</font></div><div><font size="2"   >mode &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | ExclusiveLock</font></div><div><font size="2"   >granted &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t</font></div><div><font size="2"   >fastpath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >-[ RECORD 2 ]------+--------------</font></div><div><font size="2"   >locktype &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | virtualxid</font></div><div><font size="2"   >database &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >relation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >page &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >tuple &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >virtualxid &nbsp; &nbsp; &nbsp; &nbsp; | 3/73709664</font></div><div><font size="2"   >transactionid &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >classid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >objid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >objsubid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >virtualtransaction | 3/73709664</font></div><div><font size="2"   >pid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 24554</font></div><div><font size="2"   >mode &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | ExclusiveLock</font></div><div><font size="2"   >granted &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t</font></div><div><font size="2"   >fastpath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | t</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# select * from pg_locks where pid=24401;</font></div><div><font size="2"   >&nbsp; &nbsp;locktype &nbsp; &nbsp;| database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualtransaction |</font></div><div><font size="2"   >&nbsp; pid &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;mode &nbsp; &nbsp; &nbsp; &nbsp; | granted | fastpath&nbsp;</font></div><div><font size="2"   >---------------+----------+----------+------+-------+------------+---------------+---------+-------+----------+--------------------+</font></div><div><font size="2"   >-------+---------------------+---------+----------</font></div><div><font size="2"   >&nbsp;relation &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;12944 | &nbsp; &nbsp;11181 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2/412049 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;24401 | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;virtualxid &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | 2/412049 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2/412049 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;24401 | ExclusiveLock &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;relation &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;12944 | &nbsp; &nbsp;60687 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2/412049 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;24401 | AccessExclusiveLock | t &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >&nbsp;object &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;12944 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp;2615 | &nbsp;2200 | &nbsp; &nbsp; &nbsp; &nbsp;0 | 2/412049 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;24401 | AccessShareLock &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >&nbsp;transactionid | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;1662669457 | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2/412049 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;24401 | ExclusiveLock &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >(5 rows)</font></div></div><p></p></pre></div></div><div><br></div><div>他们分别对应的锁TAG如下：</div><div>src/include/storage/lock.h</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LOCKTAG_TRANSACTION, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* transaction (for waiting for xact done) */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* ID info for a transaction is its TransactionId */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LOCKTAG_VIRTUALTRANSACTION, /* virtual transaction (ditto) */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* ID info for a virtual transaction is its VirtualTransactionId */</font></div><p></p></pre></div></div><div><br></div><div>虚拟事务号的数据结构如下：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* Top-level transactions are identified by VirtualTransactionIDs comprising</font></div><div><font size="2"   >&nbsp;* the BackendId of the backend running the xact, plus a locally-assigned</font></div><div><font size="2"   >&nbsp;* LocalTransactionId. &nbsp;These are guaranteed unique over the short term,</font></div><div><font size="2"   >&nbsp;* but will be reused after a database restart; hence they should never</font></div><div><font size="2"   >&nbsp;* be stored on disk.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Note that struct VirtualTransactionId can not be assumed to be atomically</font></div><div><font size="2"   >&nbsp;* assignable as a whole. &nbsp;However, type LocalTransactionId is assumed to</font></div><div><font size="2"   >&nbsp;* be atomically assignable, and the backend ID doesn't change often enough</font></div><div><font size="2"   >&nbsp;* to be a problem, so we can fetch or assign the two fields separately.</font></div><div><font size="2"   >&nbsp;* We deliberately refrain from using the struct within PGPROC, to prevent</font></div><div><font size="2"   >&nbsp;* coding errors from trying to use struct assignment with it; instead use</font></div><div><font size="2"   >&nbsp;* GET_VXID_FROM_PGPROC().</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >typedef struct</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; BackendId &nbsp; &nbsp; &nbsp; backendId; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* determined at backend startup */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LocalTransactionId localTransactionId; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* backend-local transaction</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* id */</font></div><div><font size="2"   >} VirtualTransactionId;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#define InvalidLocalTransactionId &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >#define LocalTransactionIdIsValid(lxid) ((lxid) != InvalidLocalTransactionId)</font></div><div><font size="2"   >#define VirtualTransactionIdIsValid(vxid) \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; (((vxid).backendId != InvalidBackendId) &amp;&amp; \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LocalTransactionIdIsValid((vxid).localTransactionId))</font></div><div><font size="2"   >#define VirtualTransactionIdEquals(vxid1, vxid2) \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ((vxid1).backendId == (vxid2).backendId &amp;&amp; \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(vxid1).localTransactionId == (vxid2).localTransactionId)</font></div><div><font size="2"   >#define SetInvalidVirtualTransactionId(vxid) \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ((vxid).backendId = InvalidBackendId, \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(vxid).localTransactionId = InvalidLocalTransactionId)</font></div><div><font size="2"   >#define GET_VXID_FROM_PGPROC(vxid, proc) \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ((vxid).backendId = (proc).backendId, \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(vxid).localTransactionId = (proc).lxid)</font></div><p></p></pre></div><div><br></div><div>本地事务号和事务号又有什么分别呢？实际上一个是用来表示本地事务的，并且本地事务号不会存储在磁盘中，只存在于内存中。而事务号则是存储在磁盘中的，属于持久化的值。</div><div>src/include/c.h</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >typedef uint32 TransactionId;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >typedef uint32 LocalTransactionId;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >typedef uint32 SubTransactionId;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#define InvalidSubTransactionId &nbsp; &nbsp; &nbsp; &nbsp; ((SubTransactionId) 0)</font></div><div><font size="2"   >#define TopSubTransactionId &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ((SubTransactionId) 1)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >/* MultiXactId must be equivalent to TransactionId, to fit in t_xmax */</font></div><div><font size="2"   >typedef TransactionId MultiXactId;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >typedef uint32 MultiXactOffset;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >typedef uint32 CommandId;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#define FirstCommandId &nbsp;((CommandId) 0)</font></div><div><font size="2"   >#define InvalidCommandId &nbsp; &nbsp; &nbsp; &nbsp;(~(CommandId)0)</font></div><p></p></pre></div><div><br></div><div>获得本地事务号的函数如下，不需要vacuum，因为不会持久化到磁盘，也不用于MVCC，所以直接轮询使用是没问题的，见如下函数：</div><div>src/backend/storage/ipc/sinvaladt.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* GetNextLocalTransactionId --- allocate a new LocalTransactionId</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* We split VirtualTransactionIds into two parts so that it is possible</font></div><div><font size="2"   >&nbsp;* to allocate a new one without any contention for shared memory, except</font></div><div><font size="2"   >&nbsp;* for a bit of additional overhead during backend startup/shutdown.</font></div><div><font size="2"   >&nbsp;* The high-order part of a VirtualTransactionId is a BackendId, and the</font></div><div><font size="2"   >&nbsp;* low-order part is a LocalTransactionId, which we assign from a local</font></div><div><font size="2"   >&nbsp;* counter. &nbsp;To avoid the risk of a VirtualTransactionId being reused</font></div><div><font size="2"   >&nbsp;* within a short interval, successive procs occupying the same backend ID</font></div><div><font size="2"   >&nbsp;* slot should use a consecutive sequence of local IDs, which is implemented</font></div><div><font size="2"   >&nbsp;* by copying nextLocalTransactionId as seen above.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >LocalTransactionId</font></div><div><font size="2"   >GetNextLocalTransactionId(void)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LocalTransactionId result;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* loop to avoid returning InvalidLocalTransactionId at wraparound */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; do</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = nextLocalTransactionId++;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; } while (!LocalTransactionIdIsValid(result));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return result;</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>那么虚拟事务号到底有什么用呢？</div><div>举一些例子，</div><div>1. 因为虚拟事务号是在内存中管理的，所以在处理锁冲突时效率更高，可以用于唯一标示发生锁冲突的事务对象。</div><div>见</div><div>src/backend/storage/lmgr/lock.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >VirtualTransactionId *</font></div><div><font size="2"   >GetLockConflicts(const LOCKTAG *locktag, LOCKMODE lockmode)</font></div><div><font size="2"   >{</font></div></div><div><font size="2"   >。。。。。。</font></div><p></p></pre></div><div>2. 同时应用于standby的查询和恢复的锁冲突标示。</div><div>3. 还可以用于标示检查点和用户执行的查询之间的锁冲突。</div><div>总的来说，虚拟事务号就是用来标示锁冲突的对象的。</div><div><br></div><div>[参考]</div><div><span style="line-height: 28px;"   >1. src/backend/storage/ipc/sinvaladt.c</span></div><div><span style="line-height: 28px;"   >2. src/include/c.h</span></div><div><span style="line-height: 28px;"   >3. src/include/storage/lock.h</span></div><div>4.&nbsp;<span style="line-height: 28px;"   >src/backend/storage/lmgr/lock.c</span></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="pg_locks.virtualxid  transactionid - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>