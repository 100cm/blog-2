<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.5 new feature - Improve in-memory hash performance</h2>
	<h5 id="">2015-07-09 22:12:57&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201569101039801/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">Improve in-memory hash performance (Tomas Vondra, Robert Haas)<div>详见</div><div><div style="line-height: 28px;"   >1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=8cce08f168481c5fc5be4e7e29b968e314f1b41e"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=8cce08f168481c5fc5be4e7e29b968e314f1b41e</a></div><div style="line-height: 28px;"   >2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=45f6240a8fa9d35548eb2ef23dba2c11540aa02a"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=45f6240a8fa9d35548eb2ef23dba2c11540aa02a</a></div></div><div>主要通过提高hashjointuple内存分配速度，以及搜索速度来提升HASHJOIN速度，具体提升效果如何，可以对比测试一下。</div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create table t1(id int,info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table t2(id int,info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# insert into t1 select generate_series(1,10000000);</font></div><div><font size="2"   >INSERT 0 10000000</font></div><div><font size="2"   >postgres=# insert into t2 select generate_series(1,10000000);</font></div><div><font size="2"   >INSERT 0 10000000</font></div><div><font size="2"   >postgres=# analyze t1;</font></div><div><font size="2"   >ANALYZE</font></div><div><font size="2"   >postgres=# analyze t2;</font></div><div><font size="2"   >ANALYZE</font></div><p></p></pre></div><div><br></div><div>9.4的内存使用量更大，速度更慢。</div><div>PostgreSQL 9.4</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# explain (analyze,timing,verbose,buffers,costs) select * from t1 join t2 using (id);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >--</font></div><div><font size="2"   >&nbsp;Hash Join &nbsp;(cost=236002.00..597004.00 rows=10000000 width=68) (actual time=5484.514..27850.011 rows=10000000 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: t1.id, t1.info, t2.info</font></div><div><font size="2"   >&nbsp; &nbsp;Hash Cond: (t1.id = t2.id)</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=22004</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on public.t1 &nbsp;(cost=0.00..111002.00 rows=10000000 width=36) (actual time=0.031..1474.728 rows=10000000 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: t1.id, t1.info</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buffers: shared hit=11002</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Hash &nbsp;(cost=111002.00..111002.00 rows=10000000 width=36) (actual time=5480.140..5480.140 rows=10000000 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: t2.info, t2.id</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buckets: 1048576 &nbsp;Batches: 1 &nbsp;Memory Usage: 351563kB</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buffers: shared hit=11002</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on public.t2 &nbsp;(cost=0.00..111002.00 rows=10000000 width=36) (actual time=0.034..1882.919 rows=10000000 loops=1</font></div><div><font size="2"   >)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: t2.info, t2.id</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buffers: shared hit=11002</font></div><div><font size="2"   >&nbsp;Planning time: 0.295 ms</font></div><div><font size="2"   >&nbsp;Execution time: 28654.718 ms</font></div><div><font size="2"   >(16 rows)</font></div><p></p></pre></div><div><br></div><div>PostgreSQL 9.5</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# explain (analyze,timing,verbose,buffers,costs) select * from t1 join t2 using (id);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >--</font></div><div><font size="2"   >&nbsp;Hash Join &nbsp;(cost=255534.00..675132.00 rows=10000000 width=68) (actual time=4911.462..14121.618 rows=10000000 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: t1.id, t1.info, t2.info</font></div><div><font size="2"   >&nbsp; &nbsp;Hash Cond: (t1.id = t2.id)</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=22004, temp read=15302 written=14792</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on public.t1 &nbsp;(cost=0.00..111002.00 rows=10000000 width=36) (actual time=0.038..1533.017 rows=10000000 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: t1.id, t1.info</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buffers: shared hit=11002</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Hash &nbsp;(cost=111002.00..111002.00 rows=10000000 width=36) (actual time=4906.195..4906.195 rows=10000000 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: t2.info, t2.id</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buckets: 65536 &nbsp;Batches: 256 &nbsp;Memory Usage: 1889kB</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buffers: shared hit=11002, temp written=7141</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on public.t2 &nbsp;(cost=0.00..111002.00 rows=10000000 width=36) (actual time=0.051..2108.836 rows=10000000 loops=1</font></div><div><font size="2"   >)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: t2.info, t2.id</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buffers: shared hit=11002</font></div><div><font size="2"   >&nbsp;Planning time: 0.141 ms</font></div><div><font size="2"   >&nbsp;Execution time: 14947.637 ms</font></div><div><font size="2"   >(16 rows)</font></div><p></p></pre></div><div><br></div><div><br></div><div><div>Pack tuples in a hash join batch densely, to save memory.</div><div><br></div><div>Instead of palloc'ing each HashJoinTuple individually, allocate 32kB chunks</div><div>and pack the tuples densely in the chunks. This avoids the AllocChunk</div><div>header overhead, and the space wasted by standard allocator's habit of</div><div>rounding sizes up to the nearest power of two.</div><div><br></div><div>This doesn't contain any planner changes, because the planner's estimate of</div><div>memory usage ignores the palloc overhead. Now that the overhead is smaller,</div><div>the planner's estimates are in fact more accurate.</div><div><br></div><div><br></div><div><div>Change NTUP_PER_BUCKET to 1 to improve hash join lookup speed.</div><div><br></div><div>Since this makes the bucket headers use ~10x as much memory, properly</div><div>account for that memory when we figure out whether everything fits</div><div>in work_mem. &nbsp;This might result in some cases that previously used</div><div>only a single batch getting split into multiple batches, but it's</div><div>unclear as yet whether we need defenses against that case, and if so,</div><div>what the shape of those defenses should be.</div><div><br></div><div>It's worth noting that even in these edge cases, users should still be</div><div>no worse off than they would have been last week, because commit</div><div>45f6240a8fa9d35548eb2ef23dba2c11540aa02a saved a big pile of memory</div><div>on exactly the same workloads.</div></div><wbr><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=8cce08f168481c5fc5be4e7e29b968e314f1b41e"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=8cce08f168481c5fc5be4e7e29b968e314f1b41e</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=45f6240a8fa9d35548eb2ef23dba2c11540aa02a"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=45f6240a8fa9d35548eb2ef23dba2c11540aa02a</a></div></div><div>3.&nbsp;src/include/executor/hashjoin.h</div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL 9.5 new feature - Improve in-memory hash performance - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>