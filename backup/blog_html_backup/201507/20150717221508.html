<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use PostgreSQL trigger manage stock & offer infomation</h2>
	<h5 id="">2015-07-17 22:15:08&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020156176558675/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">使用触发器来管理订单和库存信息，可以简化数据交互过程。这个例子来自postgresql server programming。<wbr><div>例如</div><div>库存表存储一家水果超市的水果的库存总量数据，以及已供应的量数据，库存总量必须大于等于已供应的量。</div><div>订单数据表存储每一笔水果的订单信息。</div><div>涉及的操作包括新增订单，修改订单，撤销订单。</div><div>新增订单，则需要增加库存表的已供应量字段信息，同时需要向订单表新增一条记录。</div><div>修改订单，需要修改库存表的已供应量字段信息，同时需要修改订单记录。</div><div>撤销订单，需要<span style="line-height: 28px;"   >修改库存表的已供应量字段信息，同时需要删除对应的订单记录。</span></div><div>例如：</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# create table stock (fruit name primary key, cnt int, offer int, check (cnt &gt;= offer and cnt&gt;=0 and offer&gt;=0));</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >postgres=# create table ordered (id serial primary key, fruit name references stock(fruit), cnt int, otime timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><p></p></pre></div><div>创建库存信息：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into stock values ('orange',1000,0);</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=# insert into stock values ('apple',1000,0);</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div>新增订单</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# insert into ordered(fruit,cnt,otime) values ('orange',100,now() at time zone 'PRC') returning *;</font></div><div><font size="2"   >&nbsp;id | fruit &nbsp;| cnt | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; otime &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+--------+-----+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | orange | 100 | 2015-07-17 21:30:08.001544</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=# update stock set offer=offer+100 where fruit='orange';</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# end;</font></div><div><font size="2"   >COMMIT</font></div><p></p></pre></div><div>修改订单</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# select cnt from ordered where id=1;</font></div><div><font size="2"   >&nbsp;cnt&nbsp;</font></div><div><font size="2"   >-----</font></div><div><font size="2"   >&nbsp;100</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# update stock set offer=offer-100 where fruit='orange';</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# update ordered set cnt=500,otime=now() at time zone 'PRC' where id=1 returning *;</font></div><div><font size="2"   >&nbsp;id | fruit &nbsp;| cnt | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; otime &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+--------+-----+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | orange | 500 | 2015-07-17 21:33:30.384528</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# update stock set offer=offer+500 where fruit='orange';</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# end;</font></div><div><font size="2"   >COMMIT</font></div><p></p></pre></div><div>撤销订单，回归库存</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# delete from ordered where id=1 returning *;</font></div><div><font size="2"   >&nbsp;id | fruit &nbsp;| cnt | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; otime &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+--------+-----+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | orange | 500 | 2015-07-17 21:33:30.384528</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >DELETE 1</font></div></div><div><div><font size="2"   >postgres=# update stock set offer=offer-500 where fruit='orange';</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# end;</font></div><div><font size="2"   >COMMIT</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# select * from stock ;</font></div><div><font size="2"   >&nbsp;fruit &nbsp;| cnt &nbsp;| offer&nbsp;</font></div><div><font size="2"   >--------+------+-------</font></div><div><font size="2"   >&nbsp;apple &nbsp;| 1000 | &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;orange | 1000 | &nbsp; &nbsp; 0</font></div><div><font size="2"   >(2 rows)</font></div></div><p></p></pre></div><div><br></div><div>我们看到以上操作非常的繁琐，需要交互很多次。</div><div>在订单表上使用触发器可以解决这样的问题。</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   ><span style="line-height: 28px;"   >postgres=</span># create or replace function tg_ordered() returns trigger as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; IF TG_OP = 'INSERT' then</font></div><div><font size="2"   >&nbsp; &nbsp; update stock set offer=offer+NEW.cnt where fruit=NEW.fruit;</font></div><div><font size="2"   >&nbsp; ELSIF TG_OP = 'DELETE' then</font></div><div><font size="2"   >&nbsp; &nbsp; update stock set offer=offer-OLD.cnt where fruit=OLD.fruit;</font></div><div><font size="2"   >&nbsp; ELSIF TG_OP = 'UPDATE' then</font></div><div><font size="2"   >&nbsp; &nbsp; update stock set offer=offer-OLD.cnt where fruit=OLD.fruit;</font></div><div><font size="2"   >&nbsp; &nbsp; update stock set offer=offer+NEW.cnt where fruit=NEW.fruit;</font></div><div><font size="2"   >&nbsp; end IF;&nbsp;</font></div><div><font size="2"   >&nbsp; return null;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# create trigger tg1 after insert or update or delete on ordered for each row execute procedure tg_ordered();</font></div><div><font size="2"   >CREATE TRIGGER</font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   >新增订单</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into ordered(fruit,cnt,otime) values ('orange',100,now() at time zone 'PRC') returning *;</font></div><div><font size="2"   >&nbsp;id | fruit &nbsp;| cnt | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; otime &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+--------+-----+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | orange | 100 | 2015-07-17 22:08:32.897824</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=# select * from ordered;</font></div><div><font size="2"   >&nbsp;id | fruit &nbsp;| cnt | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; otime &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+--------+-----+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | orange | 100 | 2015-07-17 22:08:32.897824</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select * from stock ;</font></div><div><font size="2"   >&nbsp;fruit &nbsp;| cnt &nbsp;| offer&nbsp;</font></div><div><font size="2"   >--------+------+-------</font></div><div><font size="2"   >&nbsp;apple &nbsp;| 1000 | &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;orange | 1000 | &nbsp; 100</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>当订单总量大于库存时，自动报错：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into ordered(fruit,cnt,otime) values ('orange',911,now() at time zone 'PRC') returning *;</font></div><div><font size="2"   >ERROR: &nbsp;new row for relation "stock" violates check constraint "stock_check"</font></div><div><font size="2"   >DETAIL: &nbsp;Failing row contains (orange, 1000, 1011).</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL statement "update stock set offer=offer+NEW.cnt where fruit=NEW.fruit"</font></div><div><font size="2"   >PL/pgSQL function tg_ordered() line 5 at SQL statement</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >修改订单</span></div><div>例如原来订单是100个桔子，改为999个苹果，自动修改库存。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# update ordered set fruit='apple',cnt=999 where id=1;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# select * from stock ;</font></div><div><font size="2"   >&nbsp;fruit &nbsp;| cnt &nbsp;| offer&nbsp;</font></div><div><font size="2"   >--------+------+-------</font></div><div><font size="2"   >&nbsp;orange | 1000 | &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;apple &nbsp;| 1000 | &nbsp; 999</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   >postgres=# select * from ordered;</font></div><div><font size="2"   >&nbsp;id | fruit | cnt | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; otime &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+-------+-----+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | apple | 999 | 2015-07-17 22:08:32.897824</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >撤销订单，撤销订单后，自动回归库存。</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# delete from ordered where id=1;</font></div><div><font size="2"   >DELETE 1</font></div><div><font size="2"   >postgres=# select * from ordered;</font></div><div><font size="2"   >&nbsp;id | fruit | cnt | otime&nbsp;</font></div><div><font size="2"   >----+-------+-----+-------</font></div><div><font size="2"   >(0 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select * from stock ;</font></div><div><font size="2"   >&nbsp;fruit &nbsp;| cnt &nbsp;| offer&nbsp;</font></div><div><font size="2"   >--------+------+-------</font></div><div><font size="2"   >&nbsp;orange | 1000 | &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;apple &nbsp;| 1000 | &nbsp; &nbsp; 0</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>本文介绍使用触发器自动维护库存表和订单表的关系，减少了应用层的处理逻辑，减少了网络层的交互。</div><div>触发器的用法可以参考我以前写的BLOG：</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013283547959/"   >http://blog.163.com/digoal@126/blog/static/1638770402013283547959/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013211102130526/"   >http://blog.163.com/digoal@126/blog/static/1638770402013211102130526/</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="use PostgreSQL trigger manage stock  offer infomation - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>