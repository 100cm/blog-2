<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL management - lock inspect</h2>
	<h5 id="">2013-06-24 17:05:01&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201352445735143/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">锁在数据库中的使用频率非常高. 数据库的并发能力除了和它的并发控制机制有关, 还和数据库的锁粒度控制息息相关, 粒度越细, 冲突范围就越小, 并发能力就越强.<div>以PostgreSQL 9.3为例, 它支持的表锁如下, X表示这两种锁会发生冲突 :&nbsp;</div><div><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; background-color: rgb(224, 236, 239); border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"   ><thead><tr><th rowspan="2"   style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Requested Lock Mode</th><th colspan="8"   style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Current Lock Mode</th></tr><tr><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >ACCESS SHARE</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >ROW SHARE</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >ROW EXCLUSIVE</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >SHARE UPDATE EXCLUSIVE</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >SHARE</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >SHARE ROW EXCLUSIVE</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >EXCLUSIVE</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >ACCESS EXCLUSIVE</th></tr></thead><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >ACCESS SHARE</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >ROW SHARE</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >ROW EXCLUSIVE</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >SHARE UPDATE EXCLUSIVE</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >SHARE</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >SHARE ROW EXCLUSIVE</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >EXCLUSIVE</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >ACCESS EXCLUSIVE</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td><td align="center"   style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >X</td></tr></table><div>PostgreSQL支持的行锁 :&nbsp;</div><div>exclusive row-level : select for update</div><div>shared row-level : select for share</div><div><span style="line-height: 22px;"   >PostgreSQL</span>支持的页锁 :&nbsp;</div><div><div style="line-height: 22px;"   >exclusive page-level : write access to table pages in the shared buffer pool.</div><div style="line-height: 22px;"   >shared page-level : write access to table pages in the shared buffer pool.</div></div><div>另外<span style="line-height: 22px;"   >PostgreSQL</span><span style="line-height: 22px;"   >还支持advisory lock :&nbsp;</span></div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201172492217830/"   >http://blog.163.com/digoal@126/blog/static/163877040201172492217830/</a></div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402013518111043463/"   >http://blog.163.com/digoal@126/blog/static/1638770402013518111043463/</a></div><div>本文将介绍一下如何查看PostgreSQL数据库的锁状态.<br><div><br></div><div>查看表锁, 页锁, advisory 锁的视图 :&nbsp;</div><div>pg_locks :&nbsp;</div><div><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; background-color: rgb(224, 236, 239); border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"   ><colgroup><col><col><col><col><thead><tr><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Name</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Type</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >References</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Description</th></tr></thead><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   ><tt>locktype</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   ><tt>text</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   >Type of the lockable object:&nbsp;<tt>relation</tt>,&nbsp;<tt>extend</tt>,&nbsp;<tt>page</tt>,&nbsp;<tt>tuple</tt>,&nbsp;<tt>transactionid</tt>,&nbsp;<tt>virtualxid</tt>,&nbsp;<tt>object</tt>,&nbsp;<tt>userlock</tt>, or&nbsp;<tt>advisory</tt></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>database</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>oid</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/catalog-pg-database.html"   ><tt style="font-size: 1em;"   >pg_database</tt></a>.oid</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >OID of the database in which the lock target exists, or zero if the target is a shared object, or null if the target is a transaction ID</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>relation</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>oid</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/catalog-pg-class.html"   ><tt style="font-size: 1em;"   >pg_class</tt></a>.oid</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >OID of the relation targeted by the lock, or null if the target is not a relation or part of a relation</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>page</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>integer</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Page number targeted by the lock within the relation, or null if the target is not a relation page or tuple</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>tuple</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>smallint</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Tuple number targeted by the lock within the page, or null if the target is not a tuple</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>virtualxid</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>text</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Virtual ID of the transaction targeted by the lock, or null if the target is not a virtual transaction ID</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>transactionid</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>xid</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >ID of the transaction targeted by the lock, or null if the target is not a transaction ID</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>classid</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>oid</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt><a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/catalog-pg-class.html"   ><tt style="font-size: 1em;"   >pg_class</tt></a>.oid</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >OID of the system catalog containing the lock target, or null if the target is not a general database object</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>objid</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>oid</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >any OID column</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >OID of the lock target within its system catalog, or null if the target is not a general database object</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>objsubid</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>smallint</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Column number targeted by the lock (the&nbsp;<tt>classid</tt>&nbsp;and&nbsp;<tt>objid</tt>&nbsp;refer to the table itself), or zero if the target is some other general database object, or null if the target is not a general database object</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>virtualtransaction</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>text</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Virtual ID of the transaction that is holding or awaiting this lock</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>pid</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>integer</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Process ID of the server process holding or awaiting this lock, or null if the lock is held by a prepared transaction</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>mode</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>text</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Name of the lock mode held or desired by this process (see&nbsp;<a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/explicit-locking.html#LOCKING-TABLES"   >Section 13.3.1</a>&nbsp;and&nbsp;<a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/transaction-iso.html#XACT-SERIALIZABLE"   >Section 13.2.3</a>)</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>granted</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>boolean</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >True if lock is held, false if lock is awaited</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>fastpath</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>boolean</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >&nbsp;</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >True if lock was taken via fast path, false if taken via main lock table</td></tr></table></div><div>关联视图 :&nbsp;</div><div>pg_stat_activity.pid 关联 pg_locks.pid</div><div>pg_prepared_xacts.transaction 关联pg_locks.transactionid</div><div>pg_class.oid 关联 pg_locks.relation, pg_locks.classid</div><div>pg_database.oid 关联 pg_locks.database</div><div><br></div><div>注意PostgreSQL不会将已获得的行锁信息存储在内存中,&nbsp;<span style="line-height: 22px;"   >行锁信息存储在行的头部信息infomask中. &nbsp;</span><span style="line-height: 22px;"   >换句话锁, 获得行锁时需要修改t_infomask.&nbsp;</span></div><div>一般在pg_locks中无法查看到行锁的信息.&nbsp;</div><div>当然如果在pg_locks中查看到了行锁信息, 并不代表行锁信息存储在内存中. 这种情况往往出现在行锁等待时.</div><div><span style="line-height: 22px;"   >如果需要查看行锁可以使用扩展模块pgrowlocks. 使用pgrowlocks模块查看行锁须知 :&nbsp;</span></div><div><span style="line-height: 22px;"   >1. 使用pgrowlocks查看行锁实际上是解析tuple的t_infomask信息, 所以表要能正常查询, 如果加了ACCESS Exclusive Lock, 那么正常的查询需要等待.</span></div><div><span style="line-height: 22px;"   >2. pgrowlocks不提供一致性数据, 例如tuple a locked, 但是在查看到lock b的时候, tuple a 可能已经unlocked了. 也就是说在查询过程中行锁随时都可以发生变化.</span></div><div><br></div><div>[举例]</div><div>一. 查看表锁</div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# begin; update lock_test set info='new' where id=1;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >UPDATE 1</font></div></div><div><font size="2"   >SESSION X :&nbsp;</font></div><div><div><font size="2"   >digoal=# select * from pg_stat_activity;</font></div><div><font size="2"   >&nbsp;datid | datname | pid &nbsp;| usesysid | usename &nbsp;| application_name | client_addr | client_hostname | client_port | &nbsp; &nbsp; &nbsp; &nbsp; backend_sta</font></div><div><font size="2"   >rt &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;xact_start &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;query_start &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; state_change &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| waiting | &nbsp; &nbsp; &nbsp; &nbsp;state&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------+---------+------+----------+----------+------------------+-------------+-----------------+-------------+--------------------</font></div><div><font size="2"   >-----------+-------------------------------+-------------------------------+-------------------------------+---------+--------------</font></div><div><font size="2"   >-------+---------------------------------------------</font></div><div><font size="2"   >&nbsp;16385 | digoal &nbsp;| 6102 | &nbsp; &nbsp; &nbsp; 10 | postgres | psql &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-1 | 2013-06-24 09:05:59</font></div><div><font size="2"   >.467026+08 | 2013-06-24 09:06:39.461293+08 | 2013-06-24 09:06:39.461425+08 | 2013-06-24 09:06:39.461689+08 | f &nbsp; &nbsp; &nbsp; | idle in trans</font></div><div><font size="2"   >action | update lock_test set info='new' where id=1;</font></div></div><p></p></pre></div><div>会话A的pid=6102, waiting=false.</div><div>查看会话A的锁信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_locks where pid=6102;</font></div><div><font size="2"   >&nbsp; &nbsp;locktype &nbsp; &nbsp;| database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualtransaction |</font></div><div><font size="2"   >&nbsp;pid &nbsp;| &nbsp; &nbsp; &nbsp; mode &nbsp; &nbsp; &nbsp; | granted | fastpath&nbsp;</font></div><div><font size="2"   >---------------+----------+----------+------+-------+------------+---------------+---------+-------+----------+--------------------+</font></div><div><font size="2"   >------+------------------+---------+----------</font></div><div><font size="2"   >&nbsp;relation &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;16385 | &nbsp; &nbsp;33155 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2/925855 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;6102 | RowExclusiveLock | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;virtualxid &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | 2/925855 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2/925855 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;6102 | ExclusiveLock &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;transactionid | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 3253067 | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2/925855 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp;6102 | ExclusiveLock &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div><div>解释, 事务开启后需要对virtualxid加ExclusiveLock锁.</div><div>并且由于会话A对数据库有write操作, 所以需要加transactionid锁类型的ExclusiveLock锁.</div><div>另外对数据库表lock_test有更新操作, 所以加了RowExclusiveLock的表锁. (注意是表锁, 不是行锁, 行锁在行头信息infomask中查看)</div><div><br></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# delete from lock_test where id=1;</font></div><p></p></pre></div><div><br></div><div>SESSION X :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_stat_activity;</font></div><div><div><font size="2"   >&nbsp;datid | datname | pid &nbsp;| usesysid | usename &nbsp;| application_name | client_addr | client_hostname | client_port | &nbsp; &nbsp; &nbsp; &nbsp; backend_sta</font></div><div><font size="2"   >rt &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;xact_start &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;query_start &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; state_change &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| waiting | &nbsp; &nbsp; &nbsp; &nbsp;state&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------+---------+------+----------+----------+------------------+-------------+-----------------+-------------+--------------------</font></div><div><font size="2"   >-----------+-------------------------------+-------------------------------+-------------------------------+---------+--------------</font></div><div><font size="2"   >-------+---------------------------------------------</font></div></div><div><div><font size="2"   >&nbsp;16385 | digoal &nbsp;| 6317 | &nbsp; &nbsp; &nbsp; 10 | postgres | psql &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-1 | 2013-06-24 09:06:10</font></div><div><font size="2"   >.860101+08 | 2013-06-24 09:06:41.471729+08 | 2013-06-24 09:06:48.446988+08 | 2013-06-24 09:06:48.446989+08 | t &nbsp; &nbsp; &nbsp; | active &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| delete from lock_test where id=1;</font></div></div><p></p></pre></div><div>会话B对应的pid=6317, waiting=true, 说明它处于等待状态.&nbsp;</div><div>那么它在等什么呢? 通过pg_locks来看一下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select c.relname,l.* from pg_locks l left outer join pg_class c on l.relation=c.oid where l.pid=6317 order by l.relation;</font></div><div><font size="2"   >&nbsp; relname &nbsp;| &nbsp; locktype &nbsp; &nbsp;| database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualt</font></div><div><font size="2"   >ransaction | pid &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;mode &nbsp; &nbsp; &nbsp; &nbsp; | granted | fastpath&nbsp;</font></div><div><font size="2"   >-----------+---------------+----------+----------+------+-------+------------+---------------+---------+-------+----------+---------</font></div><div><font size="2"   >-----------+------+---------------------+---------+----------</font></div><div><font size="2"   >&nbsp;lock_test | tuple &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp;16385 | &nbsp; &nbsp;33155 | &nbsp; &nbsp;0 | &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3/460438</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 6317 | AccessExclusiveLock | t &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >&nbsp;lock_test | relation &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;16385 | &nbsp; &nbsp;33155 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3/460438</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 6317 | RowExclusiveLock &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| transactionid | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 3253069 | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3/460438</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 6317 | ExclusiveLock &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| transactionid | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 3253067 | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3/460438</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 6317 | ShareLock &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| virtualxid &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | 3/460438 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3/460438</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 6317 | ExclusiveLock &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div><div>这个输出需要详细解释一下,&nbsp;</div><div>1. 第一行为tuple锁类型, locktype=tuple, granted=t, 表明会话B以及获得了这个行锁, 行的物理位置为ctid=(0,1), 0号数据块的第一条记录.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select ctid,* from lock_test where id=1;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| id | info&nbsp;</font></div><div><font size="2"   >-------+----+------</font></div><div><font size="2"   >&nbsp;(0,1) | &nbsp;1 | test</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>2. 第二行输出的为表锁,&nbsp;<span style="line-height: 22px;"   >RowExclusiveLock. 锁对象为lock_test.</span></div><div><span style="line-height: 22px;"   >3. transactionid的ExclusiveLock出现在当会话有write 数据库的操作时.</span></div><div><span style="line-height: 22px;"   >4. 第四行的granted=false, 说明它在等待这个锁, 是什么锁呢?&nbsp;</span></div><div>transactionid的ShareLock, transactionid=<span style="line-height: 22px;"   >3253067</span><span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >说明它在等事务号=</span><span style="line-height: 22px;"   >3253067</span><span style="line-height: 22px;"   >&nbsp;的事务释放ExclusiveLock锁.</span></div><div><span style="line-height: 22px;"   >在第二步操作时我们查看到了会话A的事务号为</span><span style="line-height: 22px;"   >3253067. 所以会话B的行锁等待体现为等待会话A的transacitonid ExclusiveLock释放.</span></div><div><span style="line-height: 22px;"   >5. 最后一行是virtualxid的ExclusiveLock, 所有事务开启后都会获得这个锁.</span></div><div><br></div><div>二. 查看advisory锁</div><div>参考<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/1638770402013518111043463/"   >http://blog.163.com/digoal@126/blog/static/1638770402013518111043463/</a></div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# select pg_advisory_lock(1,2);</font></div><div><font size="2"   >&nbsp;pg_advisory_lock&nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>SESSION X :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_locks where pid=6102;</font></div><div><font size="2"   >&nbsp; locktype &nbsp;| database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualtransaction | pi</font></div><div><font size="2"   >d &nbsp;| &nbsp; &nbsp; mode &nbsp; &nbsp; &nbsp;| granted | fastpath&nbsp;</font></div><div><font size="2"   >------------+----------+----------+------+-------+------------+---------------+---------+-------+----------+--------------------+---</font></div><div><font size="2"   >---+---------------+---------+----------</font></div><div><font size="2"   >&nbsp;virtualxid | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | 2/925861 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2/925861 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 61</font></div><div><font size="2"   >02 | ExclusiveLock | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;advisory &nbsp; | &nbsp; &nbsp;16385 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp;1 | 2/925861 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 61</font></div><div><font size="2"   >02 | ExclusiveLock | t &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>advisory 锁的几个有效信息字段, classid, objid, objsubid.&nbsp;</div><div>classid代表<span style="line-height: 22px;"   >pg_advisory_lock($1,$2) 中的$1.</span></div><div><span style="line-height: 22px;"   >objid代表</span><span style="line-height: 22px;"   >pg_advisory_lock($1,$2) 中的$2.</span></div><div><span style="line-height: 22px;"   >objsubid代表</span>LOCKTAG.<span style="line-height: 22px;"   >locktag_field4, 具体参考</span><a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/1638770402013518111043463/"   >http://blog.163.com/digoal@126/blog/static/1638770402013518111043463/</a></div><div><span style="line-height: 22px;"   ><br></span></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# select pg_advisory_lock(1,2);</font></div><p></p></pre></div><div><br></div><div>SESSION X :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_locks where pid=6317;</font></div><div><font size="2"   >&nbsp; locktype &nbsp;| database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualtransaction | pi</font></div><div><font size="2"   >d &nbsp;| &nbsp; &nbsp; mode &nbsp; &nbsp; &nbsp;| granted | fastpath&nbsp;</font></div><div><font size="2"   >------------+----------+----------+------+-------+------------+---------------+---------+-------+----------+--------------------+---</font></div><div><font size="2"   >---+---------------+---------+----------</font></div><div><font size="2"   >&nbsp;virtualxid | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | 3/460443 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3/460443 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 63</font></div><div><font size="2"   >17 | ExclusiveLock | t &nbsp; &nbsp; &nbsp; | t</font></div><div><font size="2"   >&nbsp;advisory &nbsp; | &nbsp; &nbsp;16385 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp;1 | 3/460443 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 63</font></div><div><font size="2"   >17 | ExclusiveLock | f &nbsp; &nbsp; &nbsp; | f</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>会话B无法获得这个advisory ExclusiveLock, 因为它与会话A冲突.</div><div><br></div><div>三. 查看行锁</div><div>首先要安装pgrowlocks模块</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create extension pgrowlocks;</font></div><div><font size="2"   >CREATE EXTENSION</font></div><p></p></pre></div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# update lock_test set info='new' where id=1;</font></div><div><font size="2"   >UPDATE 1</font></div><p></p></pre></div><div>SESSION X :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pgrowlocks('lock_test');</font></div><div><font size="2"   >&nbsp;locked_row | locker &nbsp;| multi | &nbsp; xids &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; modes &nbsp; &nbsp; &nbsp; | &nbsp;pids &nbsp;</font></div><div><font size="2"   >------------+---------+-------+-----------+-------------------+--------</font></div><div><font size="2"   >&nbsp;(0,8) &nbsp; &nbsp; &nbsp;| 3253077 | f &nbsp; &nbsp; | {3253077} | {"No Key Update"} | {6102}</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>测试阻断 :&nbsp;</div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >digoal=# lock table lock_test in access exclusive mode;</font></div><div><font size="2"   >LOCK TABLE</font></div><p></p></pre></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pgrowlocks('lock_test');</font></div><div><font size="2"   >会话B处于等待状态.</font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201172492217830/"   >http://blog.163.com/digoal@126/blog/static/163877040201172492217830/</a></div><div>2.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201210134586363/"   >http://blog.163.com/digoal@126/blog/static/163877040201210134586363/</a></div><div>3.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020130305109687/"   >http://blog.163.com/digoal@126/blog/static/16387704020130305109687/</a></div><div>4.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/1638770402013463425483/"   >http://blog.163.com/digoal@126/blog/static/1638770402013463425483/</a></div><div>5.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020130249109133/"   >http://blog.163.com/digoal@126/blog/static/16387704020130249109133/</a></div><div>6.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/1638770402011515105557166/"   >http://blog.163.com/digoal@126/blog/static/1638770402011515105557166/</a></div><div>7.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020130312271679/"   >http://blog.163.com/digoal@126/blog/static/16387704020130312271679/</a></div><div>8.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020131172754749/"   >http://blog.163.com/digoal@126/blog/static/16387704020131172754749/</a></div><div>9.&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020130249109133/"   >http://blog.163.com/digoal@126/blog/static/16387704020130249109133/</a></div><div>10.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/pgrowlocks.html"   >http://www.postgresql.org/docs/9.3/static/pgrowlocks.html</a></div><div>11.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/view-pg-locks.html"   >http://www.postgresql.org/docs/9.3/static/view-pg-locks.html</a></div><div>12.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/explicit-locking.html"   >http://www.postgresql.org/docs/9.3/static/explicit-locking.html</a></div><div>13.&nbsp;src/backend/storage/lmgr/README</div><div>14.&nbsp;</div><div>src/include/storage/lock.h</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* LOCKTAG is the key information needed to look up a LOCK item in the</font></div><div><font size="2"   >&nbsp;* lock hashtable. &nbsp; &nbsp; &nbsp;A LOCKTAG value uniquely identifies a lockable object.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* The LockTagType enum defines the different kinds of objects we can lock.</font></div><div><font size="2"   >&nbsp;* We can handle up to 256 different LockTagTypes.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >typedef enum LockTagType</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LOCKTAG_RELATION, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* whole relation */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* ID info for a relation is DB OID + REL OID; DB OID = 0 if shared */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LOCKTAG_RELATION_EXTEND, &nbsp; &nbsp; &nbsp; &nbsp;/* the right to extend a relation */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* same ID info as RELATION */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LOCKTAG_PAGE, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* one page of a relation */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* ID info for a page is RELATION info + BlockNumber */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LOCKTAG_TUPLE, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* one physical tuple */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* ID info for a tuple is PAGE info + OffsetNumber */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LOCKTAG_TRANSACTION, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* transaction (for waiting for xact done) */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* ID info for a transaction is its TransactionId */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LOCKTAG_VIRTUALTRANSACTION, /* virtual transaction (ditto) */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* ID info for a virtual transaction is its VirtualTransactionId */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LOCKTAG_OBJECT, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* non-relation database object */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* ID info for an object is DB OID + CLASS OID + OBJECT OID + SUBID */</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Note: object ID has same representation as in pg_depend and</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* pg_description, but notice that we are constraining SUBID to 16 bits.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Also, we use DB OID = 0 for shared objects such as tablespaces.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LOCKTAG_USERLOCK, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* reserved for old contrib/userlock code */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LOCKTAG_ADVISORY &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* advisory user locks */</font></div><div><font size="2"   >} LockTagType;</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* The LOCKTAG struct is defined with malice aforethought to fit into 16</font></div><div><font size="2"   >&nbsp;* bytes with no padding. &nbsp;Note that this would need adjustment if we were</font></div><div><font size="2"   >&nbsp;* to widen Oid, BlockNumber, or TransactionId to more than 32 bits.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* We include lockmethodid in the locktag so that a single hash table in</font></div><div><font size="2"   >&nbsp;* shared memory can store locks of different lockmethods.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >typedef struct LOCKTAG</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; uint32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;locktag_field1; /* a 32-bit ID field */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; uint32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;locktag_field2; /* a 32-bit ID field */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; uint32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;locktag_field3; /* a 32-bit ID field */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; uint16 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;locktag_field4; /* a 16-bit ID field */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; uint8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; locktag_type; &nbsp; /* see enum LockTagType */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; uint8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; locktag_lockmethodid; &nbsp; /* lockmethod indicator */</font></div><div><font size="2"   >} LOCKTAG;</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* These macros define how we map logical IDs of lockable objects into</font></div><div><font size="2"   >&nbsp;* the physical fields of LOCKTAG. &nbsp; &nbsp; &nbsp;Use these to set up LOCKTAG values,</font></div><div><font size="2"   >&nbsp;* rather than accessing the fields directly. &nbsp;Note multiple eval of target!</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >#define SET_LOCKTAG_RELATION(locktag,dboid,reloid) \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ((locktag).locktag_field1 = (dboid), \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(locktag).locktag_field2 = (reloid), \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(locktag).locktag_field3 = 0, \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(locktag).locktag_field4 = 0, \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(locktag).locktag_type = LOCKTAG_RELATION, \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(locktag).locktag_lockmethodid = DEFAULT_LOCKMETHOD)</font></div></div><div><font size="2"   >... 设置其他类型说的macro略.</font></div><div><font size="2"   >详见lock.h</font></div><p></p></pre></div><div><br></div><br><wbr></div><br></div></div></div>
	</div>
</div>
</body>
</html>