<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL advisory lock key introduce</h2>
	<h5 id="">2013-06-18 13:45:44&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013518111043463/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 支持应用程序控制的锁(advisory lock), 可规避长时间持普通锁带来的vacuum无法回收垃圾的问题.</div><div>用法可参见:</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201172492217830/"   >http://blog.163.com/digoal@126/blog/static/163877040201172492217830/</a></div><div>本文介绍一下获取锁的key值. advirosy lock的key值一共64比特, 可以为int8类型. 也可以选择两个int4类型的值, 拼凑起来就是64比特.</div><div>函数如下 :&nbsp;</div><div><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; background-color: rgb(224, 236, 239); border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"   ><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   ><tt>pg_try_advisory_lock(<tt style="font-size: 1em;"   >key</tt>&nbsp;<tt style="font-size: 1em;"   >bigint</tt>)</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   ><tt>boolean</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   >Obtain exclusive session level advisory lock if available</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>pg_try_advisory_lock(<tt style="font-size: 1em;"   >key1</tt>&nbsp;<tt style="font-size: 1em;"   >int</tt>,&nbsp;<tt style="font-size: 1em;"   >key2</tt>&nbsp;<tt style="font-size: 1em;"   >int</tt>)</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>boolean</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Obtain exclusive session level advisory lock if available</td></tr></table></div><div>对应的代码如下 :&nbsp;</div><div>src/backend/utils/adt/lockfuncs.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* pg_advisory_lock(int4, int4) - acquire exclusive lock on 2 int4 keys</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >Datum</font></div><div><font size="2"   >pg_advisory_lock_int4(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; key1 = PG_GETARG_INT32(0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; key2 = PG_GETARG_INT32(1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LOCKTAG &nbsp; &nbsp; &nbsp; &nbsp; tag;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SET_LOCKTAG_INT32(tag, key1, key2);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; (void) LockAcquire(&amp;tag, ExclusiveLock, true, false);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_VOID();</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* pg_advisory_lock(int8) - acquire exclusive lock on an int8 key</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >Datum</font></div><div><font size="2"   >pg_advisory_lock_int8(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int64 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; key = PG_GETARG_INT64(0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LOCKTAG &nbsp; &nbsp; &nbsp; &nbsp; tag;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SET_LOCKTAG_INT64(tag, key);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; (void) LockAcquire(&amp;tag, ExclusiveLock, true, false);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_VOID();</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >分别使用</span><span style="line-height: 22px;"   >SET_LOCKTAG_INT32和</span><span style="line-height: 22px;"   >SET_LOCKTAG_INT64来设置锁标签.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* Functions for manipulating advisory locks</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* We make use of the locktag fields as follows:</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;field1: MyDatabaseId ... ensures locks are local to each database</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;field2: first of 2 int4 keys, or high-order half of an int8 key</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;field3: second of 2 int4 keys, or low-order half of an int8 key</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;field4: 1 if using an int8 key, 2 if using 2 int4 keys</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >#define SET_LOCKTAG_INT64(tag, key64) \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SET_LOCKTAG_ADVISORY(tag, \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MyDatabaseId, \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(uint32) ((key64) &gt;&gt; 32), \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(uint32) (key64), \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1)</font></div><div><font size="2"   >#define SET_LOCKTAG_INT32(tag, key1, key2) \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SET_LOCKTAG_ADVISORY(tag, MyDatabaseId, key1, key2, 2)</font></div><p></p></pre></div><div>从以上macro可以看出, int8其实分解成了2个unsigned int4. 然后调用<span style="line-height: 22px;"   >SET_LOCKTAG_ADVISORY设置锁标签. 如下 :&nbsp;</span></div><div>src/include/storage/lock.h</div><div><span style="line-height: 22px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#define SET_LOCKTAG_ADVISORY(locktag,id1,id2,id3,id4) \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ((locktag).locktag_field1 = (id1), \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(locktag).locktag_field2 = (id2), \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(locktag).locktag_field3 = (id3), \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(locktag).locktag_field4 = (id4), \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(locktag).locktag_type = LOCKTAG_ADVISORY, \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(locktag).locktag_lockmethodid = USER_LOCKMETHOD)</font></div><p></p></pre></div><div>传入的参数key1和key2或者是int8分解出来的key1和key2分别用于设置<span style="line-height: 22px;"   >LOCKTAG的</span><span style="line-height: 22px;"   >&nbsp;locktag_field2和</span><span style="line-height: 22px;"   >&nbsp;locktag_field3.</span></div></span><div style="line-height: 22px;"   ><pre class="prettyprint"   ><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* The LOCKTAG struct is defined with malice aforethought to fit into 16</font></div><div><font size="2"   >&nbsp;* bytes with no padding. &nbsp;Note that this would need adjustment if we were</font></div><div><font size="2"   >&nbsp;* to widen Oid, BlockNumber, or TransactionId to more than 32 bits.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* We include lockmethodid in the locktag so that a single hash table in</font></div><div><font size="2"   >&nbsp;* shared memory can store locks of different lockmethods.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >typedef struct LOCKTAG</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; uint32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;locktag_field1; /* a 32-bit ID field */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; uint32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;locktag_field2; /* a 32-bit ID field */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; uint32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;locktag_field3; /* a 32-bit ID field */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; uint16 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;locktag_field4; /* a 16-bit ID field */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; uint8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; locktag_type; &nbsp; /* see enum LockTagType */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; uint8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; locktag_lockmethodid; &nbsp; /* lockmethod indicator */</font></div><div><font size="2"   >} LOCKTAG;</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >[测试]</div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >1. MyDatabaseId指数据库当前数据库ID, 所以不同的数据库中可以同时对同一个key获取advisory lock .</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >测试如下 :&nbsp;</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >SESSION A :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select pg_advisory_lock(0,1);</font></div><div><font size="2"   >&nbsp;pg_advisory_lock&nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >SESSION B :&nbsp;</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select pg_advisory_lock(0,1);</font></div><div><font size="2"   >Cancel request sent</font></div><div><font size="2"   >ERROR: &nbsp;canceling statement due to user request</font></div><div><font size="2"   >digoal=# select pg_try_advisory_lock(0,1);</font></div><div><font size="2"   >&nbsp;pg_try_advisory_lock&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;f</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>换个数据库, 对同样的key加锁, 即可获得成功.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \c postgres&nbsp;</font></div><div><font size="2"   >You are now connected to database "postgres" as user "postgres".</font></div><div><font size="2"   >postgres=# select pg_try_advisory_lock(0,1);</font></div><div><font size="2"   >&nbsp;pg_try_advisory_lock&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;t</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div><br></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >2.&nbsp;</span><span style="line-height: 22px;"   >pg_advisory_lock(int4, int4),&nbsp;</span><span style="line-height: 22px;"   >pg_advisory_lock(int8) 的key空间会不会冲突?</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >测试 :&nbsp;</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >将 int8 分解成2个int4, 然后使用&nbsp;</span><span style="line-height: 22px;"   >pg_advisory_lock(int4, int4) 加锁能成功么?</span></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >例如key=1, 数字转varbit的过程可参考 :&nbsp;</span></div><div style="line-height: 22px;"   ><a href="http://blog.163.com/digoal@126/blog/static/16387704020132592725462/"   >http://blog.163.com/digoal@126/blog/static/16387704020132592725462/</a></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; o_bit text;</font></div><div><font size="2"   >&nbsp; o_len int;</font></div><div><font size="2"   >&nbsp; i_num int;</font></div><div><font size="2"   >&nbsp; i_conv int;</font></div><div><font size="2"   >&nbsp; i_num_abs int;</font></div><div><font size="2"   >&nbsp; i_res int;</font></div><div><font size="2"   >&nbsp; i_mod int;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; o_len := 64;</font></div><div><font size="2"   >&nbsp; i_num := 1;</font></div><div><font size="2"   >&nbsp; i_conv := 2;</font></div><div><font size="2"   >&nbsp; i_num_abs := abs(i_num);</font></div><div><font size="2"   >&nbsp; i_res := i_num_abs/i_conv;</font></div><div><font size="2"   >&nbsp; i_mod := mod(i_num_abs,i_conv);</font></div><div><font size="2"   >&nbsp; o_bit := i_mod::text;</font></div><div><font size="2"   >&nbsp; loop</font></div><div><font size="2"   >&nbsp; &nbsp; if i_res = 0 then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; exit;</font></div><div><font size="2"   >&nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; &nbsp; i_mod := mod(i_res,i_conv);</font></div><div><font size="2"   >&nbsp; &nbsp; i_res := i_res/i_conv;</font></div><div><font size="2"   >&nbsp; &nbsp; o_bit := i_mod||o_bit;</font></div><div><font size="2"   >&nbsp; end loop;</font></div><div><font size="2"   >&nbsp; o_len := o_len - char_length(o_bit) - 1;</font></div><div><font size="2"   >&nbsp; o_bit := repeat('0', o_len)||o_bit;</font></div><div><font size="2"   >&nbsp; if i_num &gt;=0 then</font></div><div><font size="2"   >&nbsp; &nbsp; o_bit := '0'||o_bit;</font></div><div><font size="2"   >&nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; o_bit := '1'||o_bit;</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; raise notice '%', o_bit;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >NOTICE: &nbsp;0000000000000000000000000000000000000000000000000000000000000001</font></div><div><font size="2"   >DO</font></div><p></p></pre></div><div>转换成两个int4为0,1;</div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select pg_advisory_lock(int8 '1');</font></div><div><font size="2"   >&nbsp;pg_advisory_lock&nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >SESSION B :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select pg_try_advisory_lock(0,1);</font></div><div><font size="2"   >&nbsp;pg_try_advisory_lock&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;t</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=# select pg_try_advisory_lock(int8 '1');</font></div><div><font size="2"   >&nbsp;pg_try_advisory_lock&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;f</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>因此<span style="line-height: 22px;"   >pg_advisory_lock(int4, int4),&nbsp;</span><span style="line-height: 22px;"   >pg_advisory_lock(int8) 的key空间</span><span style="line-height: 22px;"   >不冲突.</span></div><div><span style="line-height: 22px;"   >原因是代码中对64bit和32bit分别设置</span>LOCKTAG.locktag_field4为1和2. 所以不会冲突.</div><div><span style="line-height: 22px;"   >如果将</span>SET_LOCKTAG_INT64 和 SET_LOCKTAG_INT32的macro的最后一个参数改成一致的那么就会冲突了.</div><div>如下, 修改</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 postgresql-9.3devel]# vi src/backend/utils/adt/lockfuncs.c</font></div><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* Functions for manipulating advisory locks</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* We make use of the locktag fields as follows:</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;field1: MyDatabaseId ... ensures locks are local to each database</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;field2: first of 2 int4 keys, or high-order half of an int8 key</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;field3: second of 2 int4 keys, or low-order half of an int8 key</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;field4: 1 if using an int8 key, 2 if using 2 int4 keys</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >#define SET_LOCKTAG_INT64(tag, key64) \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SET_LOCKTAG_ADVISORY(tag, \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MyDatabaseId, \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(uint32) ((key64) &gt;&gt; 32), \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(uint32) (key64), \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1)</font></div><div><font size="2"   >#define SET_LOCKTAG_INT32(tag, key1, key2) \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SET_LOCKTAG_ADVISORY(tag, MyDatabaseId, key1, key2, 1)</font></div></div><p></p></pre></div><div>重新编译 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 postgresql-9.3devel]# gmake world</font></div><div><font size="2"   >[root@db-172-16-3-33 postgresql-9.3devel]# gmake install-world</font></div><p></p></pre></div><div>重启数据库 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 postgresql-9.3devel]# su - pg93</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; pg_ctl restart -m fast</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div><div><font size="2"   >server starting</font></div><p></p></pre></div><div>重新测试以上是否冲突 :&nbsp;</div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select pg_advisory_lock(int8 '1');</font></div><div><font size="2"   >&nbsp;pg_advisory_lock&nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select pg_try_advisory_lock(0,1);</font></div><div><font size="2"   >&nbsp;pg_try_advisory_lock&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;f</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select pg_try_advisory_lock(int8 '1');</font></div><div><font size="2"   >&nbsp;pg_try_advisory_lock&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;f</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >现在冲突了.</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;src/backend/utils/adt/lockfuncs.c</div><div>2.&nbsp;src/include/storage/lock.h</div><div>3.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/functions-admin.html#FUNCTIONS-ADVISORY-LOCKS"   >http://www.postgresql.org/docs/9.3/static/functions-admin.html#FUNCTIONS-ADVISORY-LOCKS</a></div><div>4.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020132592725462/"   >http://blog.163.com/digoal@126/blog/static/16387704020132592725462/</a></div></div>
	</div>
</div>
</body>
</html>