<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL monitor - check_postgres usage - 2</h2>
	<h5 id="">2013-06-05 16:31:58&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020135512514428/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">上一篇介绍了check_postgres脚本的使用.<div><a href="http://blog.163.com/digoal@126/blog/static/1638770402013548284410/"   >http://blog.163.com/digoal@126/blog/static/1638770402013548284410/</a><br><div>本例要介绍一下结合nagios使用check_postgres监控数据库的配置.</div><div><br><wbr></div><div><div><div style="line-height: 22px;"   >7. 配置被监控机</div><div style="line-height: 22px;"   >7.1 修改本地执行监控命令的用户和组, 因为在监控中会涉及数据库表空间文件系统等监控, 而这些目录可能是700权限的. 所以尽量使用postgres的启动用户. 如下 :&nbsp;</div><div style="line-height: 22px;"   ><br></div><div><pre class="prettyprint"   ><p style="line-height: 22px;"   ></p><div><font size="2"   ><span style="line-height: 19px;"   >[root@db-172-16-3-39 ~]# </span></font><font size="2"   style="line-height: 19px;"   >vi /etc/xinetd.d/nrpe</font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; user &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= pg92</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; group &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = pg92</font></div></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >7.2 修改监控项配置, 新增监控项</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-39 ~]# vi /opt/nagios/etc/nrpe.cfg</font></div><div><div><font size="2"   >command[check_arch]=opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=archive_ready -w 10 -c 20</font></div><div><font size="2"   >command[check_freeze]=/opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=autovac_freeze -w 90% -c 95% --exclude=template1,template0</font></div><div><font size="2"   >command[check_conns]=/opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=backends -w=120 -c=150</font></div><div><font size="2"   >command[check_bloat]=/opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres,digoal_01 -u postgres --action=bloat -w="30% or 100M" -c="40% or 200M" --perflimit=5</font></div><div><font size="2"   >command[check_checkpoint]=/opt/check_postgres-2.20.0/check_postgres.pl --output=nagios --datadir=/pgdata1919 --action=checkpoint -w 300s -c 600s</font></div><div><font size="2"   >command[check_commitratio]=/opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=commitratio -w 90% -c 80%</font></div><div><font size="2"   >command[check_dbsize]=/opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=database_size -w 1T -c 2T</font></div><div><font size="2"   >command[check_triggers]=/opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres,digoal_01 -u postgres --action=disabled_triggers -w 1 -c 2</font></div><div><font size="2"   >command[check_hitratio]=/opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres,digoal_01 -u postgres --action=hitratio -w 90% -c 80%</font></div><div><font size="2"   >command[check_relsize]=/opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -db postgres,digoal_01 -u postgres --action=relation_size -w 10G -c 20G --perflimit=5</font></div><div><font size="2"   >command[check_autovacuum]=/opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres,digoal_01 --action=last_autovacuum --perflimit=3 -w '1 h'</font></div><div><font size="2"   >command[check_autoanalyze]=/opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres,digoal_01 --action=last_autoanalyze --perflimit=3 -w '1 h'</font></div><div><font size="2"   >command[check_locks]=/opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres --action=locks -w 100 -c total=250:waiting=5:exclusive=20</font></div><div><font size="2"   >command[check_query_time]=/opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres --action=query_time -w '10s'</font></div><div><font size="2"   >command[check_seq1]=/opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db digoal_01 --action=sequence -w 90%</font></div><div><font size="2"   >command[check_seq2]=/opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres --action=sequence -w 90%</font></div><div><font size="2"   >command[check_txnidle]=/opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres --action=txn_idle -w "1 for 100s" -c "3 for 100s"</font></div><div><font size="2"   >command[check_xlogs]=/opt/check_postgres-2.20.0/check_postgres.pl --output=nagios -H 127.0.0.1 -p 1919 -u postgres --db postgres --action=wal_files -w 100</font></div></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >7.3 重启xinetd</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-39 ~]# service xinetd restart</font></div><div style="line-height: 22px;"   ></div><p></p></pre></div><div style="line-height: 22px;"   >8. 配置nagios服务端,&nbsp;</div><div style="line-height: 22px;"   >配置服务之前, 可以先使用nrpe远程调用以下远端的命令, 看看是否正常, 正常后再配置服务.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 db_servers]# /opt/nagios-3.5.0/libexec/check_nrpe -H 172.16.3.39 -c check_arch</font></div><div><font size="2"   >ERROR: Could not find a suitable psql executable</font></div><p></p></pre></div><div>这里报错, 找不到psql命令.</div><div>所以需要在被监控机上指定psql的路径. 首先要修改check_postgres.pl脚本, 允许使用环境变量.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# vi /opt/check_postgres-2.20.0/check_postgres.pl</font></div><div><div><font size="2"   >## If this is true, $opt{PSQL} and $opt{PGBINDIR} are disabled for security reasons</font></div><div><font size="2"   >our $NO_PSQL_OPTION = 0;</font></div></div><p></p></pre></div><div>然后修改nrpe.cfg, 指定环境变量.&nbsp;<span style="line-height: 22px;"   >--PGBINDIR=/opt/pgsql92/bin</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# vi /opt/nagios/etc/nrpe.cfg</font></div><div><font size="2"   >command[check_arch]=opt/check_postgres-2.20.0/check_postgres.pl --PGBINDIR=/opt/pgsql92/bin --output=nagios -H 127.0.0.1 -p 1919 -db postgres -u postgres --action=archive_ready -w 10 -c 20</font></div><p></p></pre></div><div>其他命令略, 请自行修改.</div><div>修改好后重启xinetd服务</div><div>再次通过nrpe调用, OK</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 db_servers]# /opt/nagios-3.5.0/libexec/check_nrpe -H 172.16.3.39 -c check_arch</font></div><div><font size="2"   >POSTGRES_ARCHIVE_READY OK: DB "postgres" (host:127.0.0.1) (port=1919) WAL ".ready" files found: 0 | time=0.01s files=0;10;20</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >本例参考前面讲解nagios配置的环境, 所以以下文件以及配置好了, 只需要添加监控服务即可.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 db_servers]# cd /opt/nagios-3.5.0/etc/db_servers</font></div><div><div><font size="2"   >[root@db-172-16-3-33 db_servers]# less hosts.cfg&nbsp;</font></div><div><font size="2"   >define host{</font></div><div><font size="2"   >&nbsp; use linux-box ; Inherit default values from a template</font></div><div><font size="2"   >&nbsp; host_name db_3_39 ; The name we're giving to this server</font></div><div><font size="2"   >&nbsp; alias postgresql_3_39 ; A longer name for the server</font></div><div><font size="2"   >&nbsp; address 172.16.3.39 ; IP address of the server</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div>增加监控服务 :&nbsp;</div><div><span style="line-height: 22px;"   >同一主机的service_description不能重复.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 db_servers]# vi services.cfg</font></div><div><div><font size="2"   >define service{</font></div><div><font size="2"   >&nbsp; use generic-service</font></div><div><font size="2"   >&nbsp; host_name db_3_39</font></div><div><font size="2"   >&nbsp; service_description&nbsp;<span style="line-height: 22px;"   >check_arch</span></font></div><div><font size="2"   >&nbsp; check_command check_nrpe!check_arch</font></div><div><font size="2"   >}</font></div><div><font size="2"   >define service{</font></div><div><font size="2"   >&nbsp; use generic-service</font></div><div><font size="2"   >&nbsp; host_name db_3_39</font></div><div><font size="2"   >&nbsp; service_description&nbsp;<span style="line-height: 22px;"   >check_freeze</span></font></div><div><font size="2"   >&nbsp; check_command check_nrpe!check_freeze</font></div><div><font size="2"   >}</font></div><div><font size="2"   >define service{</font></div><div><font size="2"   >&nbsp; use generic-service</font></div><div><font size="2"   >&nbsp; host_name db_3_39</font></div><div><font size="2"   >&nbsp; service_description&nbsp;<span style="line-height: 22px;"   >check_conns</span></font></div><div><font size="2"   >&nbsp; check_command check_nrpe!check_conns</font></div><div><font size="2"   >}</font></div><div><font size="2"   >define service{</font></div><div><font size="2"   >&nbsp; use generic-service</font></div><div><font size="2"   >&nbsp; host_name db_3_39</font></div><div><font size="2"   >&nbsp; service_description&nbsp;<span style="line-height: 22px;"   >check_bloat</span></font></div><div><font size="2"   >&nbsp; check_command check_nrpe!check_bloat</font></div><div><font size="2"   >}</font></div><div><font size="2"   >define service{</font></div><div><font size="2"   >&nbsp; use generic-service</font></div><div><font size="2"   >&nbsp; host_name db_3_39</font></div><div><font size="2"   >&nbsp; service_description&nbsp;<span style="line-height: 22px;"   >check_checkpoint</span></font></div><div><font size="2"   >&nbsp; check_command check_nrpe!check_checkpoint</font></div><div><font size="2"   >}</font></div><div><font size="2"   >define service{</font></div><div><font size="2"   >&nbsp; use generic-service</font></div><div><font size="2"   >&nbsp; host_name db_3_39</font></div><div><font size="2"   >&nbsp; service_description&nbsp;<span style="line-height: 22px;"   >check_commitratio</span></font></div><div><font size="2"   >&nbsp; check_command check_nrpe!check_commitratio</font></div><div><font size="2"   >}</font></div><div><font size="2"   >define service{</font></div><div><font size="2"   >&nbsp; use generic-service</font></div><div><font size="2"   >&nbsp; host_name db_3_39</font></div><div><font size="2"   >&nbsp; service_description&nbsp;<span style="line-height: 22px;"   >check_dbsize</span></font></div><div><font size="2"   >&nbsp; check_command check_nrpe!check_dbsize</font></div><div><font size="2"   >}</font></div><div><font size="2"   >define service{</font></div><div><font size="2"   >&nbsp; use generic-service</font></div><div><font size="2"   >&nbsp; host_name db_3_39</font></div><div><font size="2"   >&nbsp; service_description&nbsp;<span style="line-height: 22px;"   >check_triggers</span></font></div><div><font size="2"   >&nbsp; check_command check_nrpe!check_triggers</font></div><div><font size="2"   >}</font></div><div><font size="2"   >define service{</font></div><div><font size="2"   >&nbsp; use generic-service</font></div><div><font size="2"   >&nbsp; host_name db_3_39</font></div><div><font size="2"   >&nbsp; service_description&nbsp;<span style="line-height: 22px;"   >check_hitratio</span></font></div><div><font size="2"   >&nbsp; check_command check_nrpe!check_hitratio</font></div><div><font size="2"   >}</font></div><div><font size="2"   >define service{</font></div><div><font size="2"   >&nbsp; use generic-service</font></div><div><font size="2"   >&nbsp; host_name db_3_39</font></div><div><font size="2"   >&nbsp; service_description&nbsp;<span style="line-height: 22px;"   >check_relsize</span></font></div><div><font size="2"   >&nbsp; check_command check_nrpe!check_relsize</font></div><div><font size="2"   >}</font></div><div><font size="2"   >define service{</font></div><div><font size="2"   >&nbsp; use generic-service</font></div><div><font size="2"   >&nbsp; host_name db_3_39</font></div><div><font size="2"   >&nbsp; service_description&nbsp;<span style="line-height: 22px;"   >check_autovacuum</span></font></div><div><font size="2"   >&nbsp; check_command check_nrpe!check_autovacuum</font></div><div><font size="2"   >}</font></div><div><font size="2"   >define service{</font></div><div><font size="2"   >&nbsp; use generic-service</font></div><div><font size="2"   >&nbsp; host_name db_3_39</font></div><div><font size="2"   >&nbsp; service_description&nbsp;<span style="line-height: 22px;"   >check_autoanalyze</span></font></div><div><font size="2"   >&nbsp; check_command check_nrpe!check_autoanalyze</font></div><div><font size="2"   >}</font></div><div><font size="2"   >define service{</font></div><div><font size="2"   >&nbsp; use generic-service</font></div><div><font size="2"   >&nbsp; host_name db_3_39</font></div><div><font size="2"   >&nbsp; service_description&nbsp;<span style="line-height: 22px;"   >check_locks</span></font></div><div><font size="2"   >&nbsp; check_command check_nrpe!check_locks</font></div><div><font size="2"   >}</font></div><div><font size="2"   >define service{</font></div><div><font size="2"   >&nbsp; use generic-service</font></div><div><font size="2"   >&nbsp; host_name db_3_39</font></div><div><font size="2"   >&nbsp; service_description&nbsp;<span style="line-height: 22px;"   >check_query_time</span></font></div><div><font size="2"   >&nbsp; check_command check_nrpe!check_query_time</font></div><div><font size="2"   >}</font></div><div><font size="2"   >define service{</font></div><div><font size="2"   >&nbsp; use generic-service</font></div><div><font size="2"   >&nbsp; host_name db_3_39</font></div><div><font size="2"   >&nbsp; service_description&nbsp;<span style="line-height: 22px;"   >check_seq1</span></font></div><div><font size="2"   >&nbsp; check_command check_nrpe!check_seq1</font></div><div><font size="2"   >}</font></div><div><font size="2"   >define service{</font></div><div><font size="2"   >&nbsp; use generic-service</font></div><div><font size="2"   >&nbsp; host_name db_3_39</font></div><div><font size="2"   >&nbsp; service_description&nbsp;<span style="line-height: 22px;"   >check_seq2</span></font></div><div><font size="2"   >&nbsp; check_command check_nrpe!check_seq2</font></div><div><font size="2"   >}</font></div><div><font size="2"   >define service{</font></div><div><font size="2"   >&nbsp; use generic-service</font></div><div><font size="2"   >&nbsp; host_name db_3_39</font></div><div><font size="2"   >&nbsp; service_description&nbsp;<span style="line-height: 22px;"   >check_txnidle</span></font></div><div><font size="2"   >&nbsp; check_command check_nrpe!check_txnidle</font></div><div><font size="2"   >}</font></div><div><font size="2"   >define service{</font></div><div><font size="2"   >&nbsp; use generic-service</font></div><div><font size="2"   >&nbsp; host_name db_3_39</font></div><div><font size="2"   >&nbsp; service_description&nbsp;<span style="line-height: 22px;"   >check_xlogs</span></font></div><div><font size="2"   >&nbsp; check_command check_nrpe!check_xlogs</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div><br></div><div>检查配置文件正确性, 确保无错误.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-33 db_servers]# /opt/nagios-3.5.0/bin/nagios -v /opt/nagios-3.5.0/etc/nagios.cfg&nbsp;</font></div></div><div style="line-height: 22px;"   ></div><p></p></pre><div><span style="line-height: 22px;"   >重启nagios</span></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-33 db_servers]# service nagios restart</font></div><div style="line-height: 22px;"   ><font size="2"   >Running configuration check...done.</font></div><div style="line-height: 22px;"   ><font size="2"   >Stopping nagios: done.</font></div><div style="line-height: 22px;"   ><font size="2"   >Starting nagios: done.</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >9. nagios web界面截图</div><div style="line-height: 22px;"   ><div><img title="PostgreSQL monitor - check_postgres usage - 2 - 德哥@Digoal - PostgreSQL"   alt="PostgreSQL monitor - check_postgres usage - 2 - 德哥@Digoal - PostgreSQL"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/pVAf3gcpTitBETiPqccFZg==/6597985659843958397.png"   ></div>&nbsp;</div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >[其他]</div><div style="line-height: 22px;"   >1. check_postgres的过滤选项</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >--exclude</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >--include</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >先排除后包含. 所以如果同一个值在包含和排除中都存在, 那么最后还是包含的.</div><div style="line-height: 22px;"   >2. LANG变量设置.</div><div style="line-height: 22px;"   >最好设置成en_US.UTF8</div><div style="line-height: 22px;"   >3.&nbsp;export LC_TIME=C , 需要与数据库一致.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pg92@db-172-16-3-39-&gt; psql -h 127.0.0.1 -U postgres</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >psql (9.2beta1)</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >Type "help" for help.</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   ><br style="line-height: 19px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >postgres=# \l</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of databases</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp;Name &nbsp; &nbsp;| &nbsp; Owner &nbsp; | Encoding | Collate | Ctype | &nbsp; Access privileges &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >-----------+-----------+----------+---------+-------+-----------------------</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;digoal &nbsp; &nbsp;| postgres &nbsp;| UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;digoal_01 | digoal_01 | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;digoal_02 | digoal_02 | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;postgres &nbsp;| postgres &nbsp;| UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;template0 | postgres &nbsp;| UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | =c/postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | postgres=CTc/postgres</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp;template1 | postgres &nbsp;| UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | =c/postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | postgres=CTc/postgres</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >(6 rows)</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >一致的情况下, 时间比对正常.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios --datadir=$PGDATA --action=checkpoint -w 10s -c 200000s</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >POSTGRES_CHECKPOINT WARNING: &nbsp;Last checkpoint was 1265 seconds ago | age=1265;10;200000</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >如果环境变量与数据库不一致, check point会有问题.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   style="line-height: 22px;"   ><p style="line-height: 22px;"   ></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pg92@db-172-16-3-39-&gt; export LC_TIME=en_US.UTF8</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >pg92@db-172-16-3-39-&gt; /opt/check_postgres-2.20.0/check_postgres.pl --output=nagios --datadir=$PGDATA --action=checkpoint -w 10s -c 200000s</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 19px;"   >POSTGRES_CHECKPOINT OK: &nbsp;Last checkpoint was -49101 seconds ago | age=-49101;10;200000&nbsp;</font></div><p style="line-height: 22px;"   ></p></pre></div><div style="line-height: 22px;"   >4. 修改LC_TIME后在本地调用正常, 但是在nagios服务端使用check_nrpe调用还是异常.</div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 db_servers]# /opt/nagios-3.5.0/libexec/check_nrpe -H 172.16.3.39 -c check_checkpoint</font></div><div><font size="2"   >POSTGRES_CHECKPOINT OK: &nbsp;Last checkpoint was -38070 seconds ago | age=-38070;300;600&nbsp;</font></div><p></p></pre></div><div style="line-height: 22px;"   >即使将LC_TIME=C写在nrpe.cfg中也不能正常使用.&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >command[check_checkpoint]=LC_TIME=C /opt/check_postgres-2.20.0/check_postgres.pl --PGBINDIR=/opt/pgsql92/bin --output=nagios --datadir=/pgdata1919 --action=checkpoint -w 300s -c 600s</font></p></pre></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 check_postgres-2.20.0]# service xinetd restart</font></div><div><font size="2"   >Stopping xinetd: [ &nbsp;OK &nbsp;]</font></div><div><font size="2"   >Starting xinetd: [ &nbsp;OK &nbsp;]</font></div></div><div><font size="2"   >[root@db-172-16-3-33 db_servers]# /opt/nagios-3.5.0/libexec/check_nrpe -H 172.16.3.39 -c check_checkpoint</font></div><div><font size="2"   >POSTGRES_CHECKPOINT OK: &nbsp;Last checkpoint was -37864 seconds ago | age=-37864;300;600&nbsp;</font></div><p></p></pre></div><div><br></div><span style="line-height: 22px;"   >[参考]</span><wbr style="line-height: 22px;"   ><div style="line-height: 22px;"   >1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://bucardo.org/check_postgres/check_postgres.pl.html"   >http://bucardo.org/check_postgres/check_postgres.pl.html</a></div><div style="line-height: 22px;"   >2.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020135313354383/"   >http://blog.163.com/digoal@126/blog/static/16387704020135313354383/</a></div><div style="line-height: 22px;"   >3.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020135334157531/"   >http://blog.163.com/digoal@126/blog/static/16387704020135334157531/</a></div><div style="line-height: 22px;"   >4.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/1638770402013531131023/"   >http://blog.163.com/digoal@126/blog/static/1638770402013531131023/</a></div><div style="line-height: 22px;"   >5.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://search.cpan.org/"   >http://search.cpan.org/</a></div><div style="line-height: 22px;"   >6.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/runtime-config-autovacuum.html"   >http://www.postgresql.org/docs/9.3/static/runtime-config-autovacuum.html</a></div></div><div style="line-height: 22px;"   >7.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/1638770402013548284410/"   >http://blog.163.com/digoal@126/blog/static/1638770402013548284410/</a></div><div><br></div></div></div>
	</div>
</div>
</body>
</html>