<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">A Smart PostgreSQL extension plproxy 2.2 practices</h2>
	<h5 id="">2011-10-25 15:56:30&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201192535630895/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL分布式设计:</div><div>三层结构 :&nbsp;</div><div>1. 路由层(几乎无限扩展)</div><div>&nbsp; &nbsp;主角: plproxy,postgresql</div><div>2. 连接池层(几乎无限扩展)</div><div>&nbsp; &nbsp;主角: pgbouncer</div><div>3. 数据层(几乎无限扩展)</div><div>&nbsp; &nbsp;主角: postgresql</div><div><br></div><div>扩展方式:</div><div>1. 路由层扩展:</div><div>路由层包含了数据层的连接配置(FDW或函数),plproxy语言写的函数壳(内置路由算法),这些基本上是静态数据,所以扩展非常方便.</div><div>添加服务器就行了.</div><div>2. 连接池层扩展:</div><div>连接池层扩展加服务器.</div><div>3. 数据层扩展:</div><div>数据层扩展,添加服务器,通过流复制增加数据节点,结合路由算法重分布数据(建议路由算法2^n取模),</div><div><br></div><div>物理分布:</div><div>1. 路由层和连接池层尽量靠近部署.可以考虑部署在同一台物理机.</div><div>2. 数据层尽量每个节点一台物理机.</div><div><br></div><div>环境需求:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CentOS 5.7 x64</font></div><div><font size="2"   >flex-2.5.35</font></div><div><font size="2"   >PostgreSQL-9.1.1</font></div><div><font size="2"   >plproxy-2.2</font></div><div><font size="2"   >pgfincore-v1.1</font></div><div><font size="2"   >libevent-1.4.14b-stable</font></div><div><font size="2"   >pgbouncer 1.4.2</font></div><p></p></pre></div><div><br></div><div>测试环境描述:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >1. pgbench : 172.16.3.176</font></div><div><font size="2"   >2. pgbouncer on pgbench HOST :&nbsp;</font></div><div><font size="2"   >172.16.3.176:1998(</font></div><div><font size="2"   >proxy0 = host=172.16.3.150 dbname=proxy port=1921 pool_size=16</font></div><div><font size="2"   >proxy1 = host=172.16.3.39 dbname=proxy port=1921 pool_size=16</font></div><div><font size="2"   >proxy2 = host=172.16.3.40 dbname=proxy port=1921 pool_size=16</font></div><div><font size="2"   >proxy3 = host=172.16.3.33 dbname=proxy port=1921 pool_size=16</font></div><div><font size="2"   >)</font></div><div><font size="2"   >3. PostgreSQL 数据节点 : 172.16.3.150:1921/digoal, 172.16.3.39:1921/digoal, 172.16.3.40:1921/digoal, 172.16.3.33:1921/digoal</font></div><div><font size="2"   >4. PostgreSQL plproxy节点 : 172.16.3.150:1921/proxy, 172.16.3.39:1921/proxy, 172.16.3.40:1921/proxy, 172.16.3.33:1921/proxy</font></div><div><font size="2"   >5. pgbouncers on plproxy HOST :&nbsp;</font></div><div><font size="2"   >172.16.3.150:1999, 172.16.3.39:1999, 172.16.3.40:1999, 172.16.3.33:1999(</font></div><div><font size="2"   >digoal0 = host=172.16.3.150 dbname=digoal port=1921 pool_size=8</font></div><div><font size="2"   >digoal1 = host=172.16.3.39 dbname=digoal port=1921 pool_size=8</font></div><div><font size="2"   >digoal2 = host=172.16.3.40 dbname=digoal port=1921 pool_size=8</font></div><div><font size="2"   >digoal3 = host=172.16.3.33 dbname=digoal port=1921 pool_size=8</font></div><div><font size="2"   >)</font></div><p></p></pre></div><div><br></div><div><br></div><div>环境搭建:</div><div>1. 编译安装flex-2.5.35</div><div><pre class="prettyprint"   ><p><font size="2"   >./configure &amp;&amp; make &amp;&amp; make install</font></p></pre></div><div>2. 编译安装PostgreSQL-9.1.1</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >./configure --prefix=/opt/pgsql --with-pgport=1921 --with-perl --with-python --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-segsize=64</font></div><div><font size="2"   >gmake world</font></div><div><font size="2"   >gmake install-world</font></div><p></p></pre></div><div>3. 编译安装plproxy-2.2</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >mv plproxy-2.2 postgresql-9.1.1/contrib/plproxy-2.2</font></div><div><font size="2"   >make PG_CONFIG=/path/to/pg_config</font></div><div><font size="2"   >make install PG_CONFIG=/path/to/pg_config</font></div><p></p></pre></div><div>4. 编译安装pgfincore-v1.1</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >mv pgfincore-v1.1 postgresql-9.1.1/contrib/pgfincore-v1.1</font></div><div><font size="2"   >cp pgfincore.control /</font></div><div><font size="2"   >make clean</font></div><div><font size="2"   >make</font></div><div><font size="2"   >su</font></div><div><font size="2"   >make install PG_CONFIG=/path/to/pg_config</font></div><p></p></pre></div><div>5. 编译安装libevent-1.4.14b-stable</div><div><pre class="prettyprint"   ><p><font size="2"   >./configure &amp;&amp; make &amp;&amp; make install</font></p></pre></div><div>6. 编译安装pgbouncer 1.4.2</div><div><pre class="prettyprint"   ><p><font size="2"   >./configure --prefix=/opt/pgbouncer &amp;&amp; make &amp;&amp; make install</font></p></pre></div><div><br></div><div>配置:</div><div>1. 配置数据节点信息</div><div>新建用户 : digoal(nosuperuser)</div><div>新建表空间 : digoal, digoal_idx</div><div>新建数据库 : digoal</div><div>digoal库新建schema : digoal</div><div>digoal库新建过程语言 : plpgsql</div><div>允许代理函数连的连接池所在的服务器连接上面新建的用户和库 : 配置pg_hba.conf</div><div>配置postgresql.conf : 略</div><div><br></div><div>2. 配置plproxy节点信息(本例与数据节点共用PostgreSQL数据库实例集群)</div><div>新建用户 : proxy(nosuperuser)</div><div>新建表空间 : 共用digoal</div><div>新建数据库 : proxy</div><div>proxy库新建schema : proxy</div><div>plproxy初始化 : 用超级用户执行/opt/pgsql/share/contrib/plproxy.sql 创建handler function,language,validator function,foreign data wrapper</div><div>更改language可信度(否则普通用户不可以使用plproxy语言) :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; proxy=&gt; \c proxy postgres</font></div><div><font size="2"   >&nbsp; update pg_language set lanpltrusted='t' where lanname='plproxy';</font></div><p></p></pre></div><div>这个操作是为了途方便, 生产中请使用超级用户创建plproxy函数, 把execute权限赋予给普通用户.</div><div><br></div><div>3. 配置pgfincore</div><div>连接到数据节点\c digoal postgres</div><div><pre class="prettyprint"   ><p><font size="2"   >CREATE EXTENSION pgfincore;</font></p></pre></div><div><br></div><div>4. 配置pgbouncer(代理函数连的连接池)</div><div>4台主机都需要配置,</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-digoal-&gt; cat config1999.ini&nbsp;</font></div><div><font size="2"   >[databases]</font></div><div><font size="2"   >digoal0 = host=172.16.3.150 dbname=digoal port=1921 pool_size=8</font></div><div><font size="2"   >digoal1 = host=172.16.3.39 dbname=digoal port=1921 pool_size=8</font></div><div><font size="2"   >digoal2 = host=172.16.3.40 dbname=digoal port=1921 pool_size=8</font></div><div><font size="2"   >digoal3 = host=172.16.3.33 dbname=digoal port=1921 pool_size=8</font></div><div><font size="2"   >[pgbouncer]</font></div><div><font size="2"   >pool_mode = transaction</font></div><div><font size="2"   >listen_port = 1999</font></div><div><font size="2"   >unix_socket_dir = /opt/pgbouncer/etc</font></div><div><font size="2"   >listen_addr = *</font></div><div><font size="2"   >auth_type = md5</font></div><div><font size="2"   >auth_file = /opt/pgbouncer/etc/users1999.txt</font></div><div><font size="2"   >logfile = /dev/null</font></div><div><font size="2"   >pidfile = /opt/pgbouncer/etc/pgbouncer1999.pid</font></div><div><font size="2"   >max_client_conn = 10000</font></div><div><font size="2"   >reserve_pool_timeout = 0</font></div><div><font size="2"   >server_reset_query =</font></div><div><font size="2"   >admin_users = pgbouncer_admin</font></div><div><font size="2"   >stats_users = pgbouncer_guest</font></div><div><font size="2"   >ignore_startup_parameters = extra_float_digits</font></div><div><font size="2"   >postgres@db-digoal-&gt; cat users1999.txt&nbsp;</font></div><div><font size="2"   >"digoal" "md5462f71c79368ccf422f8a773ef40074d"</font></div><p></p></pre></div><div><br></div><div>5. 配置pgbouncer(pgbench连的连接池)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-digoal-&gt; cat config1998.ini&nbsp;</font></div><div><font size="2"   >[databases]</font></div><div><font size="2"   >proxy0 = host=172.16.3.150 dbname=proxy port=1921 pool_size=16</font></div><div><font size="2"   >proxy1 = host=172.16.3.39 dbname=proxy port=1921 pool_size=16</font></div><div><font size="2"   >proxy2 = host=172.16.3.40 dbname=proxy port=1921 pool_size=16</font></div><div><font size="2"   >proxy3 = host=172.16.3.33 dbname=proxy port=1921 pool_size=16</font></div><div><font size="2"   >[pgbouncer]</font></div><div><font size="2"   >pool_mode = transaction</font></div><div><font size="2"   >listen_port = 1998</font></div><div><font size="2"   >unix_socket_dir = /opt/pgbouncer/config</font></div><div><font size="2"   >listen_addr = *</font></div><div><font size="2"   >auth_type = md5</font></div><div><font size="2"   >auth_file = /opt/pgbouncer/config/users.txt</font></div><div><font size="2"   >logfile = /dev/null</font></div><div><font size="2"   >pidfile = /opt/pgbouncer/config/pgbouncer1998.pid</font></div><div><font size="2"   >max_client_conn = 1500</font></div><div><font size="2"   >reserve_pool_timeout = 0</font></div><div><font size="2"   >server_reset_query =&nbsp;</font></div><div><font size="2"   >admin_users = pgbouncer_admin</font></div><div><font size="2"   >stats_users = pgbouncer_guest</font></div><div><font size="2"   >ignore_startup_parameters = extra_float_digits</font></div><p></p></pre></div><div><br></div><div><br></div><div>数据节点, 创建测试表, 插入测试数据:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >proxy=# \c digoal digoal</font></div><div><font size="2"   >create table user_info</font></div><div><font size="2"   >(userid int,</font></div><div><font size="2"   >engname text,</font></div><div><font size="2"   >cnname text,</font></div><div><font size="2"   >occupation text,</font></div><div><font size="2"   >birthday date,</font></div><div><font size="2"   >signname text,</font></div><div><font size="2"   >email text,</font></div><div><font size="2"   >qq numeric,</font></div><div><font size="2"   >crt_time timestamp without time zone,</font></div><div><font size="2"   >mod_time timestamp without time zone</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create table user_login_rec</font></div><div><font size="2"   >(userid int,</font></div><div><font size="2"   >login_time timestamp without time zone,</font></div><div><font size="2"   >ip inet</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create table user_logout_rec</font></div><div><font size="2"   >(userid int,</font></div><div><font size="2"   >logout_time timestamp without time zone,</font></div><div><font size="2"   >ip inet</font></div><div><font size="2"   >);</font></div><p></p></pre></div><div><br></div><div>测试数据 :&nbsp;</div><div>0号节点</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >insert into user_info (userid,engname,cnname,occupation,birthday,signname,email,qq,crt_time,mod_time)</font></div><div><font size="2"   >select generate_series(0,50000000,4),</font></div><div><font size="2"   >'digoal.zhou',</font></div><div><font size="2"   >'德哥',</font></div><div><font size="2"   >'DBA',</font></div><div><font size="2"   >'1970-01-01'</font></div><div><font size="2"   >,E'公益是一辈子的事, I\'m Digoal.Zhou, Just do it!',</font></div><div><font size="2"   >'digoal@126.com',</font></div><div><font size="2"   >276732431,</font></div><div><font size="2"   >clock_timestamp(),</font></div><div><font size="2"   >NULL</font></div><div><font size="2"   >;</font></div><p></p></pre></div><div>1号节点</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >insert into user_info (userid,engname,cnname,occupation,birthday,signname,email,qq,crt_time,mod_time)</font></div><div><font size="2"   >select generate_series(1,50000000,4),</font></div><div><font size="2"   >'digoal.zhou',</font></div><div><font size="2"   >'德哥',</font></div><div><font size="2"   >'DBA',</font></div><div><font size="2"   >'1970-01-01'</font></div><div><font size="2"   >,E'公益是一辈子的事, I\'m Digoal.Zhou, Just do it!',</font></div><div><font size="2"   >'digoal@126.com',</font></div><div><font size="2"   >276732431,</font></div><div><font size="2"   >clock_timestamp(),</font></div><div><font size="2"   >NULL</font></div><div><font size="2"   >;</font></div><p></p></pre></div><div>2号节点</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >insert into user_info (userid,engname,cnname,occupation,birthday,signname,email,qq,crt_time,mod_time)</font></div><div><font size="2"   >select generate_series(2,50000000,4),</font></div><div><font size="2"   >'digoal.zhou',</font></div><div><font size="2"   >'德哥',</font></div><div><font size="2"   >'DBA',</font></div><div><font size="2"   >'1970-01-01'</font></div><div><font size="2"   >,E'公益是一辈子的事, I\'m Digoal.Zhou, Just do it!',</font></div><div><font size="2"   >'digoal@126.com',</font></div><div><font size="2"   >276732431,</font></div><div><font size="2"   >clock_timestamp(),</font></div><div><font size="2"   >NULL</font></div><div><font size="2"   >;</font></div><p></p></pre></div><div>3号节点</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >insert into user_info (userid,engname,cnname,occupation,birthday,signname,email,qq,crt_time,mod_time)</font></div><div><font size="2"   >select generate_series(3,50000000,4),</font></div><div><font size="2"   >'digoal.zhou',</font></div><div><font size="2"   >'德哥',</font></div><div><font size="2"   >'DBA',</font></div><div><font size="2"   >'1970-01-01'</font></div><div><font size="2"   >,E'公益是一辈子的事, I\'m Digoal.Zhou, Just do it!',</font></div><div><font size="2"   >'digoal@126.com',</font></div><div><font size="2"   >276732431,</font></div><div><font size="2"   >clock_timestamp(),</font></div><div><font size="2"   >NULL</font></div><div><font size="2"   >;</font></div><p></p></pre></div><div>所有节点 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >set work_mem='2048MB';</font></div><div><font size="2"   >set maintenance_work_mem='2048MB';</font></div><div><font size="2"   >alter table user_info add constraint pk_user_info primary key (userid) using index tablespace digoal_idx;</font></div><p></p></pre></div><div><br></div><div><br></div><div>开发:&nbsp;</div><div>数据节点 :&nbsp;</div><div>实体函数:&nbsp;</div><div>登录函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace function f_user_login&nbsp;</font></div><div><font size="2"   >(i_userid int,</font></div><div><font size="2"   >OUT o_userid int,</font></div><div><font size="2"   >OUT o_engname text,</font></div><div><font size="2"   >OUT o_cnname text,</font></div><div><font size="2"   >OUT o_occupation text,</font></div><div><font size="2"   >OUT o_birthday date,</font></div><div><font size="2"   >OUT o_signname text,</font></div><div><font size="2"   >OUT o_email text,</font></div><div><font size="2"   >OUT o_qq numeric</font></div><div><font size="2"   >)</font></div><div><font size="2"   >as $BODY$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div><font size="2"   >into o_userid,o_engname,o_cnname,o_occupation,o_birthday,o_signname,o_email,o_qq</font></div><div><font size="2"   >from user_info where userid=i_userid;</font></div><div><font size="2"   >insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"   >return;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$BODY$</font></div><div><font size="2"   >language plpgsql;</font></div><p></p></pre></div><div><br></div><div>退出函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace function f_user_logout</font></div><div><font size="2"   >(i_userid int,</font></div><div><font size="2"   >OUT o_result int</font></div><div><font size="2"   >)</font></div><div><font size="2"   >as $BODY$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >insert into user_logout_rec (userid,logout_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"   >o_result := 0;</font></div><div><font size="2"   >return;</font></div><div><font size="2"   >exception&nbsp;</font></div><div><font size="2"   >when others then</font></div><div><font size="2"   >o_result := 1;</font></div><div><font size="2"   >return;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$BODY$</font></div><div><font size="2"   >language plpgsql;</font></div><p></p></pre></div><div><br></div><div>代理节点 :&nbsp;</div><div>创建server</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE SERVER digoal FOREIGN DATA WRAPPER plproxy</font></div><div><font size="2"   >OPTIONS (</font></div><div><font size="2"   >connection_lifetime '1800',</font></div><div><font size="2"   >disable_binary '1',</font></div><div><font size="2"   >p0 'dbname=digoal0 host=127.0.0.1 port=1999 client_encoding=UTF8',</font></div><div><font size="2"   >p1 'dbname=digoal1 host=127.0.0.1 port=1999 client_encoding=UTF8',</font></div><div><font size="2"   >p2 'dbname=digoal2 host=127.0.0.1 port=1999 client_encoding=UTF8',</font></div><div><font size="2"   >p3 'dbname=digoal3 host=127.0.0.1 port=1999 client_encoding=UTF8'</font></div><div><font size="2"   >);</font></div><p></p></pre></div><div>创建user mapping</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE USER MAPPING FOR proxy SERVER digoal</font></div><div><font size="2"   >OPTIONS (user 'digoal', password 'digoal');</font></div><p></p></pre></div><div>赋权server</div><div><pre class="prettyprint"   ><p><font size="2"   >grant usage on foreign server digoal to proxy;</font></p></pre></div><div>创建代理函数:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >\c proxy proxy</font></div><div><font size="2"   >登录函数:&nbsp;</font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION f_user_login(i_userid int,</font></div><div><font size="2"   >OUT o_userid int,</font></div><div><font size="2"   >OUT o_engname text,</font></div><div><font size="2"   >OUT o_cnname text,</font></div><div><font size="2"   >OUT o_occupation text,</font></div><div><font size="2"   >OUT o_birthday date,</font></div><div><font size="2"   >OUT o_signname text,</font></div><div><font size="2"   >OUT o_email text,</font></div><div><font size="2"   >OUT o_qq numeric</font></div><div><font size="2"   >)</font></div><div><font size="2"   >as $BODY$</font></div><div><font size="2"   >&nbsp; &nbsp; CLUSTER 'digoal';</font></div><div><font size="2"   >&nbsp; &nbsp; RUN ON i_userid;</font></div><div><font size="2"   >&nbsp; &nbsp; target digoal.f_user_login;</font></div><div><font size="2"   >$BODY$</font></div><div><font size="2"   >LANGUAGE plproxy;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >退出函数:&nbsp;</font></div><div><font size="2"   >create or replace function f_user_logout</font></div><div><font size="2"   >(i_userid int,</font></div><div><font size="2"   >OUT o_result int</font></div><div><font size="2"   >)</font></div><div><font size="2"   >as $BODY$</font></div><div><font size="2"   >&nbsp; &nbsp; CLUSTER 'digoal';</font></div><div><font size="2"   >&nbsp; &nbsp; RUN ON i_userid;</font></div><div><font size="2"   >&nbsp; &nbsp; target digoal.f_user_logout;</font></div><div><font size="2"   >$BODY$</font></div><div><font size="2"   >language plproxy;</font></div><p></p></pre></div><div><br></div><div>pgbench压力测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-digoal-&gt; cat begin.sh</font></div><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   >nohup pgbench -M extended -r -c 8 -f /home/postgres/digoal_bench/login.sql -j 8 -n -T 180 -h 127.0.0.1 -p 1998 -U proxy proxy0 &gt;&gt;./login_0.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >nohup pgbench -M extended -r -c 8 -f /home/postgres/digoal_bench/login.sql -j 8 -n -T 180 -h 127.0.0.1 -p 1998 -U proxy proxy1 &gt;&gt;./login_1.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >nohup pgbench -M extended -r -c 8 -f /home/postgres/digoal_bench/login.sql -j 8 -n -T 180 -h 127.0.0.1 -p 1998 -U proxy proxy2 &gt;&gt;./login_2.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >nohup pgbench -M extended -r -c 8 -f /home/postgres/digoal_bench/login.sql -j 8 -n -T 180 -h 127.0.0.1 -p 1998 -U proxy proxy3 &gt;&gt;./login_3.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >nohup pgbench -M extended -r -c 8 -f /home/postgres/digoal_bench/logout.sql -j 8 -n -T 180 -h 127.0.0.1 -p 1998 -U proxy proxy0 &gt;&gt;./logout_0.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >nohup pgbench -M extended -r -c 8 -f /home/postgres/digoal_bench/logout.sql -j 8 -n -T 180 -h 127.0.0.1 -p 1998 -U proxy proxy1 &gt;&gt;./logout_1.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >nohup pgbench -M extended -r -c 8 -f /home/postgres/digoal_bench/logout.sql -j 8 -n -T 180 -h 127.0.0.1 -p 1998 -U proxy proxy2 &gt;&gt;./logout_2.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >nohup pgbench -M extended -r -c 8 -f /home/postgres/digoal_bench/logout.sql -j 8 -n -T 180 -h 127.0.0.1 -p 1998 -U proxy proxy3 &gt;&gt;./logout_3.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >postgres@db-digoal-&gt; cat login.sql</font></div><div><font size="2"   >\setrandom userid 0 50000000</font></div><div><font size="2"   >SELECT f_user_login(:userid);</font></div><div><font size="2"   >postgres@db-digoal-&gt; cat logout.sql</font></div><div><font size="2"   >\setrandom userid 0 50000000</font></div><div><font size="2"   >SELECT f_user_logout(:userid);</font></div><p></p></pre></div><div>cat .pgpass 略</div><div><br></div><div>测试结果 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-digoal-&gt; cat login_0.log&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: extended</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 180 s</font></div><div><font size="2"   >number of transactions actually processed: 665468</font></div><div><font size="2"   >tps = 3695.624216 (including connections establishing)</font></div><div><font size="2"   >tps = 3695.675102 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002366 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 0 50000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2.158355 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login(:userid);</font></div><div><font size="2"   >postgres@db-digoal-&gt; cat login_1.log&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: extended</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 180 s</font></div><div><font size="2"   >number of transactions actually processed: 665288</font></div><div><font size="2"   >tps = 3694.720318 (including connections establishing)</font></div><div><font size="2"   >tps = 3694.777428 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002289 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 0 50000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2.159063 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login(:userid);</font></div><div><font size="2"   >postgres@db-digoal-&gt; cat login_2.log&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: extended</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 180 s</font></div><div><font size="2"   >number of transactions actually processed: 645371</font></div><div><font size="2"   >tps = 3585.275832 (including connections establishing)</font></div><div><font size="2"   >tps = 3585.340161 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002341 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 0 50000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2.225684 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login(:userid);</font></div><div><font size="2"   >postgres@db-digoal-&gt; cat login_3.log&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: extended</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 180 s</font></div><div><font size="2"   >number of transactions actually processed: 732428</font></div><div><font size="2"   >tps = 4068.985625 (including connections establishing)</font></div><div><font size="2"   >tps = 4069.059175 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002358 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 0 50000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.960421 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login(:userid);</font></div><div><font size="2"   >postgres@db-digoal-&gt; cat logout_0.log&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: extended</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 180 s</font></div><div><font size="2"   >number of transactions actually processed: 774532</font></div><div><font size="2"   >tps = 4302.899259 (including connections establishing)</font></div><div><font size="2"   >tps = 4302.942647 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002279 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 0 50000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.853726 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_logout(:userid);</font></div><div><font size="2"   >postgres@db-digoal-&gt; cat logout_1.log&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: extended</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 180 s</font></div><div><font size="2"   >number of transactions actually processed: 773650</font></div><div><font size="2"   >tps = 4298.002332 (including connections establishing)</font></div><div><font size="2"   >tps = 4298.047243 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002308 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 0 50000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.855774 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_logout(:userid);</font></div><div><font size="2"   >postgres@db-digoal-&gt; cat logout_2.log&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: extended</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 180 s</font></div><div><font size="2"   >number of transactions actually processed: 752476</font></div><div><font size="2"   >tps = 4180.389824 (including connections establishing)</font></div><div><font size="2"   >tps = 4180.437536 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002331 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 0 50000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.908120 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_logout(:userid);</font></div><div><font size="2"   >postgres@db-digoal-&gt; cat logout_3.log&nbsp;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: extended</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 180 s</font></div><div><font size="2"   >number of transactions actually processed: 855429</font></div><div><font size="2"   >tps = 4752.346080 (including connections establishing)</font></div><div><font size="2"   >tps = 4752.383363 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002288 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 0 50000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.677890 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_logout(:userid);</font></div><p></p></pre></div><div><br></div><div>小结 :&nbsp;</div><div>每秒处理事务数 : 32581</div><div>平均耗时 : 1.974879125 毫秒.</div><div>数据库节点平均负载 : 6</div><div>数据库节点平均空闲 : 78%</div><div><br></div><div>另一个测试的测试数据 :&nbsp;</div><div>8000W数据分布到4个节点,根据PK进行更新。</div><div>更新SQL请求频率 : 33027 次每秒</div><div>平均SQL处理耗时 : 1.9352235 毫秒</div><div><br></div><div>从测试结果来看，PLPROXY部署的环境得到的性能提升是超线性的。4台服务器得到的性能大于等于4倍单节点数据库的性能。</div><wbr></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">freya - 2014-09-25 18:20:45</h5>
				<div><P>德哥好，</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 上面的结果是集群测试的结果，，如果要测试相同情况下单个节点的性能，，是不是也是在单节点上创建相关表(包含50000000数据的表）和函数（login和logout)，，然后用pgbench执行执行同样的脚本？ 另外德哥，<SPAN style=""   >为什么执行下面的sql会很慢，比直接在单节点执行select * from user_info慢很多。。。。 </SPAN></P>
<P    ><SPAN style=""   >proxy=&gt; explain analyze select * from digoal.dquery('select * from user_info where userid &gt;=29000000 and userid &lt;=49000000') as (userid int,engname text,cnname text,occupation text,birthday date,signname text,email text,qq numeric,crt_time timestamp without time zone,mod_time timestamp without time zone);<BR>&nbsp;Function Scan on dquery&nbsp; (cost=0.25..10.25 rows=1000 width=216) (actual time=74856.946..77623.16<BR>6 rows=20000001 loops=1)<BR>&nbsp;Total runtime: 79187.832 ms<BR></SPAN></P>
<P    ><SPAN style=""   >Time: 79367.977 ms</SPAN></P>
<P    ><SPAN style=""   >直接在单节点执行：</SPAN></P>
<P    ><SPAN style=""   >&nbsp;Total runtime: 4582.771 ms<BR></SPAN></P>
<P    ><SPAN style=""   ></SPAN></P></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 freya - 2014-09-25 18:20:45</h5>
				<div style="width:600px;">HI,因为返回的数据量大,程序会在接收完所有结果后程序,你看看远程连接数据库后直接执行返回所有结果集的时间如何.</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">freya 回复 德哥@Digoal - 2014-09-25 18:20:45</h5>
				<div style="width:600px;">db3=&gt; explain analyze select * from user_infosingle;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; QUERY PLAN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>-------------------------------------------------------------------------------------------------------------------<BR>----------------<BR>&nbsp;Seq Scan on user_infosingle&nbsp; (cost=0.00..1461539.00 rows=50000000 width=126) (actual time=0.014..16607.107 rows=50<BR>000000 loops=1)<BR>&nbsp;Total runtime: 20465.774 ms<BR>(2 rows)</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">Freya 回复 freya - 2014-09-25 18:20:45</h5>
				<div style="width:600px;"><P>怀疑如果dquery函数嵌套的的话是不是就不走索引了？</P></div>
			</div>
			<div id="">
				<h5 id="">xmarker - 2013-11-10 23:37:02</h5>
				<div>德哥，能不能把<span style=""  >/home/postgres/digoal_bench/login.sql共享一下啊，另外plproxy已经很稳定了吧，在生产库上可以用的吧？</span><br><br></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 xmarker - 2013-11-10 23:37:02</h5>
				<div style="width:600px;">HI,<div>&nbsp;可以用的.</div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 xmarker - 2013-11-10 23:37:02</h5>
				<div style="width:600px;">login.sql在文中有的.<div>cat login.sql下面的内容</div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">xmarker 回复 德哥@Digoal - 2013-11-10 23:37:02</h5>
				<div style="width:600px;">多谢德哥，不好意思我没注意看。<div>另外我比较关心的是如何能把一个表根据一个字段分配到不同的库里，比如area_id=1001分配到node1，area_id=1002分配到node2，这样怎么做呢，plproxy的分库路由规则不太好懂，就本例来讲，根据传进去的参数f_user_login(i_user_id)的i_user_id来分库（<span class="pln"  style=""  >RUN ON i_userid</span><span class="pun"  style=""  >;</span>），但总共4个库，怎么分的呢，是取i_userid的模=0就是第一个库，=1就是第二个库，是这样么？</div><div><br></div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 xmarker - 2013-11-10 23:37:02</h5>
				<div style="width:600px;">HI,<div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; switch (func-&gt;run_type)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case R_HASH:</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tag_hash_partitions(func, fcinfo, tag, array_params, array_row);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case R_ALL:</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for (i = 0; i &lt; cluster-&gt;part_count; i++)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tag_part(cluster, i, tag);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case R_EXACT:</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i = func-&gt;exact_nr;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (i &lt; 0 || i &gt;= cluster-&gt;part_count)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; plproxy_error(func, "part number out of range");</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tag_part(cluster, i, tag);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case R_ANY:</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i = random() &amp; cluster-&gt;part_mask;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tag_part(cluster, i, tag);</div><div></div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">freya 回复 德哥@Digoal - 2013-11-10 23:37:02</h5>
				<div style="width:600px;"><P>德哥，本例中RUN ON i_userid的情况是case R_ANY:</P>
<DIV>i = random() &amp; cluster-&gt;part_mask;</DIV>
<DIV>tag_part(cluster, i, tag);这一种吧？必须是穿进去的参数是 random才可以，是吗？</DIV></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 freya - 2013-11-10 23:37:02</h5>
				<div style="width:600px;"><span style=""  >R_HASH</span></div>
			</div>
			<div id="">
				<h5 id="">freya - 2014-09-19 11:38:43</h5>
				<div>接下来试一下plproxy..</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 freya - 2014-09-19 11:38:43</h5>
				<div style="width:600px;"><P>恩,很棒的插件.</P>
<P>你可以参考一下</P>
<P><A href="http://blog.163.com/digoal@126/blog/static/1638770402013102242543765/"  >http://blog.163.com/digoal@126/blog/static/1638770402013102242543765/</A></P></div>
			</div>
			<div id="">
				<h5 id="">好东西 - 2013-03-16 15:13:49</h5>
				<div>好东西啊，看看能不能解决数据仓库的问题。</div>
			</div>
	</div>
</div>
</body>
</html>