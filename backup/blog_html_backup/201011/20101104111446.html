<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">[example]Sync data from PostgreSQL database to another PostgreSQL database</h2>
	<h5 id="">2010-11-04 11:14:46&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402010104104620588/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><br>利用EDB的database link实现从PostgreSQL到PostgreSQL的数据同步。<br>源数据是持续插入,无更新操作的记录.将create_time作为同步标记.并且需要定期清除同步来的历史数据.<br><br>Source Database : PostgreSQL<br>Destination Database : PostgreSQL<br>Sync Database : EnterpriseDB<br><br>SD_table : <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Table "public.s_table"<br>&nbsp;&nbsp;&nbsp; Column&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Modifiers&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>--------------+-----------------------------+--------------------------------------------------------------------<br>&nbsp;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | bigint&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | not null default nextval('s_table_id_seq'::regclass)<br>&nbsp;create_time&nbsp; | timestamp without time zone | default now()<br>&nbsp;s_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | integer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | <br>&nbsp;url&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | character varying(1000)&nbsp;&nbsp;&nbsp;&nbsp; | <br>&nbsp;ip&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | character varying(32)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | <br>&nbsp;module&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | character varying(64)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | <br>&nbsp;resource_id&nbsp; | character varying(100)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | <br>&nbsp;source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | character varying(64)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | <br>&nbsp;refer_url&nbsp;&nbsp;&nbsp; | character varying(1000)&nbsp;&nbsp;&nbsp;&nbsp; | <br>&nbsp;app_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | integer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | <br>&nbsp;last_foot_id | bigint&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | <br>Indexes:<br>&nbsp;&nbsp;&nbsp; "pk_s_table" PRIMARY KEY, btree (id)<br>&nbsp;&nbsp;&nbsp; "create_time_index" btree (create_time)<br><br>DD_table : <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Table "sync.d_table"<br>&nbsp;&nbsp; Column&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp; Modifiers&nbsp;&nbsp; <br>------------+-----------------------------+---------------<br>&nbsp;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | bigint&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | not null<br>&nbsp;appid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | integer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | <br>&nbsp;module&nbsp;&nbsp;&nbsp;&nbsp; | character varying(64)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | <br>&nbsp;createtime | timestamp without time zone | default now()<br>Indexes:<br>&nbsp;&nbsp;&nbsp; "pk_d_table" PRIMARY KEY, btree (id)<br>&nbsp;&nbsp;&nbsp; "idx_d_table_1" btree (createtime)<br><br>SD_database_link :<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List of database links<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Link&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Access |&nbsp;&nbsp;&nbsp; Owner&nbsp;&nbsp;&nbsp;&nbsp; | Type&nbsp; |&nbsp;&nbsp; User&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Connection String&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>-----------------------+--------+--------------+-------+----------+----------------------------------------------<br>&nbsp;sync_s | PUBLIC | enterprisedb | LIBPQ | s_user | host=xxx.xxx.xxx.xxx port=xxxx dbname=s_database_name<br>&nbsp;sync_d | PUBLIC | enterprisedb | LIBPQ | d_user | host=xxx.xxx.xxx.xxx port=xxxx dbname=d_database_name<br><br>SD_sync_function : <br>create or replace function f_sync_d_table () returns void as $BODY$<br>&nbsp;declare <br>s_max_time timestamp without time zone;<br>d_max_time timestamp without time zone;<br>del_time timestamp without time zone;<br>return_rows int;<br>begin <br>del_time := now() - interval '2 hour';<br>select max(createtime) into d_max_time from d_table@sync_d;<br>raise notice 'd_max_time is %.',d_max_time;<br>select max(create_time) into s_max_time from s_table@sync_s where create_time&gt;d_max_time;<br>raise notice 'The record time before % and after % will be synced.',s_max_time,d_max_time;<br>insert into d_table@sync_d (id,appid,module,createtime) select id,app_id,module,create_time from s_table@sync_s where create_time&gt;d_max_time and create_time&lt;s_max_time;<br>GET DIAGNOSTICS return_rows = ROW_COUNT;<br>raise notice 'sync row count is %.',return_rows;<br>raise notice 'The record time before % and before % will be deleted.',d_max_time,del_time;<br>delete from d_table@sync_d where createtime &lt; d_max_time and createtime &lt; del_time;<br>GET DIAGNOSTICS return_rows = ROW_COUNT;<br>raise notice 'del row count is %.',return_rows;<br>end;<br>$BODY$ language plpgsql;<br><br>TEST:<br>select * from f_sync_d_table();<br>NOTICE:&nbsp; d_max_time is 04-NOV-10 11:06:06.186422.<br>NOTICE:&nbsp; The record time before 04-NOV-10 11:08:06.193542 and after 04-NOV-10 11:06:06.186422 will be synced.<br>NOTICE:&nbsp; sync row count is 164.<br>NOTICE:&nbsp; The record time before 04-NOV-10 11:06:06.186422 and before 04-NOV-10 09:09:01.409094 will be deleted.<br>NOTICE:&nbsp; del row count is 0.<br>&nbsp;f_sync_tbl_deposit_visit_log <br>------------------------------<br>&nbsp;<br>(1 row)<br><br>搞个执行计划,定时执行就可以了(前提是至少执行周期比删除范围窄).</div>
	</div>
</div>
</body>
</html>