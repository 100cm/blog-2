<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">[tag] Setting IRQ affinity does not work with MSI devices</h2>
	<h5 id="">2010-11-17 8:58:40&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402010101785840848/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">【转自RHN】<br>CASE<br><pre>Description of problem:<br>Echoing a mask to /proc/irq/&lt;irq&gt;/smp_affinity and then <br>check /proc/interrupts shows that mask didn't work.<br><br>Version-Release number of selected component (if applicable):<br>Up to 2.6.18-80.el5<br><br>How reproducible:<br>Always<br><br>Steps to Reproduce:<br>1. Select a device with MSI without masking &amp; pending bit support<br>2. Find device irq<br>3. Change mask echoing to /proc/irq/&lt;IRQ&gt;/smp_affinity<br>4. Check the results in /proc/interrupts<br>  <br>Actual results:<br>The mask is ignored<br><br>Expected results:<br>IRQs moved to another CPU<br><br>Additional info:<br>The MSI should be disabled when moving IRQs on chips without <br>Mask-and-Pending bits. This patch based on upstream code <br>merge two IRQ chip drivers and also add msi_set_enable() to <br>handle this case.</pre><br><br>【RHEL 5.3 Release note】:<br>Configuring IRQ SMP affinity has no effect on some devices
that use message
signalled interrupts (MSI) with no MSI per-vector masking
capability. Examples of such devices include Broadcom
NetXtreme Ethernet devices that use the bnx2 driver.

If you need to configure IRQ affinity for such a device,
disable MSI by creating a file in /etc/modprobe.d/
containing the following line:

options bnx2 disable_msi=1

Alternatively, you can disable MSI completely using the
kernel boot parameter pci=nomsi.<br><br>【附录】<br><br>man bnx2<br><br>BNX2(4)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BNX2(4)<br><br>NAME<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bnx2 - Broadcom NetXtreme II BCM5706/5708/5709/5716 series Gigabit Ethernet device driver<br><br>SYNOPSIS<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; insmod bnx2.o [disable_msi=1]<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; insmod bnx2.ko [disable_msi=1]<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; modprobe bnx2 [disable_msi=1]<br><br>DESCRIPTION<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bnx2 is the network device driver for the Broadcom NetXtreme II BCM5706/5708/5709/5716 series PCI/PCI-X Gigabit<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Ethernet Network Interface Card (NIC). The driver has been tested on all 2.6.x kernels and 2.4.x&nbsp; kernels&nbsp; from<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2.4.24.<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Refer to the README.TXT from the driver package on how to compile and install the driver.<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Refer to various Linux documentations on how to configure network protocol and address.<br><br>DRIVER DEPENDENCIES<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; The&nbsp; driver&nbsp; uses&nbsp; library functions in the crc32 and zlib_inflate libraries.&nbsp; On most kernels, these libraries<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; are already built into the kernel. In some cases, it may be necessary to load these library modules before&nbsp; the<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; driver or unresolved symbol errors will appear. Using modprobe will resolve the dependencies automatically.<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; In rare cases where the crc32 and zlib_inflate libraries are not enabled in the kernel, it will be necessary to<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; compile the kernel again with the libraries enabled.<br><br>DRIVER SETTINGS<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Driver settings can be&nbsp; queried&nbsp; and&nbsp; changed&nbsp; using&nbsp; ethtool.&nbsp; The&nbsp; latest&nbsp; ethtool&nbsp; can&nbsp; be&nbsp; downloaded&nbsp; from<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; http://sourceforge.net/projects/gkernel&nbsp; if&nbsp; it&nbsp; is&nbsp; not&nbsp; already installed.&nbsp; See the ethtool man page for more<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; information. ethtool settings do not persist across reboot or module reload. The ethtool commands can be put in<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; a&nbsp; startup&nbsp; script&nbsp; such&nbsp; as&nbsp; /etc/rc.local to preserve the settings across a reboot. On Red Hat distributions,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ethtool -s" parameters can be specified in the ifcfg-ethx scripts using the ETHTOOL_OPTS keyword.&nbsp; The&nbsp; speci-<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fied ethtool parameters will be set during ifup. Example: /etc/sysconfig/network-scripts/ifcfg-eth0:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ETHTOOL_OPTS="wol g speed 100 duplex half autoneg off"<br><br>PARAMETERS<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; One&nbsp; optional&nbsp; parameter&nbsp; disable_msi can be supplied as a command line argument to the insmod or modprobe com-<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mand. This parameter is used to disable Message Signaled Interrupts (MSI) and the parameter is&nbsp; only&nbsp; valid&nbsp; on<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2.6 kernels that support MSI. On 2.4 kernels, this parameter cannot be used. By default, the driver will enable<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MSI if it is supported by the kernel. It will run an interrupt test during initialization to determine&nbsp; if&nbsp; MSI<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; is working. If the test passes, the driver will enable MSI. Otherwise, it will use legacy INTx mode.<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Set the disable_msi parameter to 1 as shown below to always disable MSI on all NetXtreme II NICs in the system.<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; insmod bnx2.ko disable_msi=1<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; or<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; modprobe bnx2 disable_msi=1<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; The parameter can also be set in modprobe.conf. See the man page for more information.<br><br>DEFAULT SETTINGS<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Speed :<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Autonegotiation with all speeds advertised<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Flow control :<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Autonegotiation with rx and tx advertised<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MTU :&nbsp; 1500 (range 46 - 9000)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Rx Ring Size :<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 255 (range 0 - 4080)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Rx Jumbo Ring Size :<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 (range 0 - 16320) automatically adjusted by the driver based on MTU and Rx Ring Size.<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Tx Ring Size :<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 255 (range (MAX_SKB_FRAGS+1) - 255)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MAX_SKB_FRAGS varies on different kernels&nbsp; and&nbsp; different&nbsp; architectures.&nbsp; On&nbsp; a&nbsp; 2.6&nbsp; kernel&nbsp; for&nbsp; x86,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MAX_SKB_FRAGS is 18.<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Coalesce rx usecs :<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 18 (range 0 - 1023)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Coalesce rx usecs irq :<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 18 (range 0 - 1023)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Coalesce rx frames :<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 12 (range 0 - 255)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Coalesce rx frames irq :<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 (range 0 - 255)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Coalesce tx usecs :<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 80 (range 0 - 1023)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Coalesce tx usecs irq :<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 18 (range 0 - 1023)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Coalesce tx frames :<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 20 (range 0 - 255)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Coalesce tx frames irq :<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 (range 0 - 255)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Coalesce stats usecs&nbsp;&nbsp; :<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 999936 (aprox. 1 sec.)&nbsp; (range 0 - 16776960 in 256 increments)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MSI :&nbsp; Enabled (if supported by 2.6 kernel and interrupt test passes)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TSO :&nbsp; Enabled on 2.6 kernels<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WoL :&nbsp; Initial setting based on NVRAM’s setting.<br><br>AUTHOR<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Michael Chan - mchan@broadcom.com<br><br>SEE ALSO<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ifconfig(8), insmod(8), modprobe.conf(5), ethtool(8).<br><br>Broadcom Corporation&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 04/17/09&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BNX2(4)</div>
	</div>
</div>
</body>
</html>