<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">postgresql copyin error case</h2>
	<h5 id="">2012-08-09 17:33:52&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020127953352231/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">从HADOOP导出数据到PostgreSQL, 采用了jdbc <span style="line-height: 22px;"  >的copyin方法.</span><div>导入失败, 原因是java在处理数据流的时候把分隔符去掉了.&nbsp;</div><div><br></div><div>错误记录如下 :&nbsp;</div><div>代码 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >public int startWrite(LineReceiver resultHandler) {</font></div><div><font size="2"  >  PreparedStatement pstmt=null;</font></div><div><font size="2"  >  String url=null;</font></div><div><font size="2"  >  try {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; url="jdbc:postgresql://"+host+":"+port+"/"+dbname;</font></div><div><font size="2"  >   this.connection = DBSource.getConnection(this.sourceUniqKey);</font></div><div><font size="2"  >   //return 2;</font></div><div><font size="2"  >   //this.baseconnection=DBSource.getBaseConnection(this.sourceUniqKey);</font></div><div><font size="2"  >   </font></div><div><font size="2"  >   baseconnection=(BaseConnection)DriverManager.getConnection(url,username,password);</font></div><div><font size="2"  >   </font></div><div><font size="2"  >   //this.baseconnection=DBSource.getConnection(this.sourceUniqKey);</font></div><div><font size="2"  >   connection.setAutoCommit(false);</font></div><div><font size="2"  >   CopyManager cm;</font></div><div><font size="2"  >   cm=new CopyManager(baseconnection) ;</font></div><div><font size="2"  >   copysql="copy "+this.table+" from stdin";</font></div><div><font size="2"  >   </font></div><div><font size="2"  >   //String typeSql="select ";</font></div><div><font size="2"  >   //String insertSql="insert into "+this.table;</font></div><div><font size="2"  >   /**if (this.colorder != null &amp;&amp; !this.colorder.trim().isEmpty()) {</font></div><div><font size="2"  >    insertSql += "(" + splitColumns(this.colorder) + ")";</font></div><div><font size="2"  >    typeSql+=splitColumns(this.colorder);</font></div><div><font size="2"  >   }else</font></div><div><font size="2"  >   {</font></div><div><font size="2"  >    typeSql+=" * ";</font></div><div><font size="2"  >   }</font></div><div><font size="2"  >   typeSql+=" from "+this.table+" where 1=2";</font></div><div><font size="2"  >   List typeList = getColumnTypeList(typeSql);</font></div><div><font size="2"  >   </font></div><div><font size="2"  >   insertSql +=" values";</font></div><div><font size="2"  >   </font></div><div><font size="2"  >   //this.logger.info("typeStr:"+typeList.toString());</font></div><div><font size="2"  >   </font></div><div><font size="2"  >   Line line = null;</font></div><div><font size="2"  >   String field;</font></div><div><font size="2"  >   int i_lineCounter=0;</font></div><div><font size="2"  >   String colparas="";**/</font></div><div><font size="2"  >   </font></div><div><font size="2"  >   this.logger.info("DataX write to postgre begin .");</font></div><div><font size="2"  >   </font></div><div><font size="2"  >   PostgreWriterInputStreamAdapter localInputStream = new PostgreWriterInputStreamAdapter(</font></div><div><font size="2"  >     resultHandler, this);</font></div><div><font size="2"  >   cm.copyIn(copysql, localInputStream );</font></div><p></p></pre></div><div><br></div><div>错误输出 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >2012-08-09 16:56:29,015 [pool-3-thread-1] INFO &nbsp;common.DBSource - Key [de5462f3add7bbff] connect to database pool successfully .</font></div><div><font size="2"  >2012-08-09 16:56:29,021 [pool-3-thread-1] INFO &nbsp;pcopywriter.PostgreCopyWriter - DataX write to postgre begin .</font></div><div><font size="2"  >2012-08-09 16:56:38,963 [main] INFO &nbsp;schedule.Engine - ReaderPool virgin-reader: Active Threads 20 .</font></div><div><font size="2"  >2012-08-09 16:56:38,964 [main] INFO &nbsp;schedule.Engine - WriterPool pcopywriter-virgin-writer: Active Threads 1 .</font></div><div><font size="2"  >2012-08-09 16:56:38,964 [main] INFO &nbsp;schedule.Engine - stat: &nbsp;1032397:1028397 speed 5MB/s 103239L/s|</font></div><div><font size="2"  >2012-08-09 16:56:48,992 [main] INFO &nbsp;schedule.Engine - ReaderPool virgin-reader: Active Threads 20 .</font></div><div><font size="2"  >2012-08-09 16:56:48,992 [main] INFO &nbsp;schedule.Engine - WriterPool pcopywriter-virgin-writer: Active Threads 1 .</font></div><div><font size="2"  >2012-08-09 16:56:48,992 [main] INFO &nbsp;schedule.Engine - stat: &nbsp;2239938:2238205 speed 6MB/s 120754L/s|</font></div><div><font size="2"  >2012-08-09 16:56:59,016 [main] INFO &nbsp;schedule.Engine - ReaderPool virgin-reader: Active Threads 20 .</font></div><div><font size="2"  >2012-08-09 16:56:59,017 [main] INFO &nbsp;schedule.Engine - WriterPool pcopywriter-virgin-writer: Active Threads 1 .</font></div><div><font size="2"  >2012-08-09 16:56:59,017 [main] INFO &nbsp;schedule.Engine - stat: &nbsp;3761575:3756925 speed 7MB/s 152163L/s|</font></div><div><font size="2"  >org.postgresql.util.PSQLException: ERROR: missing data for column "screen"</font></div><div><font size="2"  >&nbsp; Where: COPY tbl_preaprior_roughrule_wao_test, line 1: "MSTAR240X3203240023997110.0070474220836163412012-08-08MSTAR240X3203240023996910.0070474220..."</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at org.postgresql.core.v3.QueryExecutorImpl.receiveErrorResponse(QueryExecutorImpl.java:2102)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at org.postgresql.core.v3.QueryExecutorImpl.processCopyResults(QueryExecutorImpl.java:964)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at org.postgresql.core.v3.QueryExecutorImpl.endCopy(QueryExecutorImpl.java:826)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at org.postgresql.core.v3.CopyInImpl.endCopy(CopyInImpl.java:61)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at org.postgresql.copy.CopyManager.copyIn(CopyManager.java:183)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at org.postgresql.copy.CopyManager.copyIn(CopyManager.java:163)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at com.taobao.datax.plugins.writer.pcopywriter.PostgreCopyWriter.startWrite(PostgreCopyWriter.java:278)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at java.lang.reflect.Method.invoke(Method.java:597)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at com.taobao.datax.engine.schedule.WriterWorker.run(WriterWorker.java:101)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at java.lang.Thread.run(Thread.java:662)</font></div><div><font size="2"  >2012-08-09 16:57:01,698 [pool-3-thread-1] ERROR schedule.WriterWorker - java.lang.reflect.InvocationTargetException</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at java.lang.reflect.Method.invoke(Method.java:597)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at com.taobao.datax.engine.schedule.WriterWorker.run(WriterWorker.java:101)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at java.lang.Thread.run(Thread.java:662)</font></div><div><font size="2"  >Caused by: null</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; at com.taobao.datax.plugins.writer.pcopywriter.PostgreCopyWriter.startWrite(PostgreCopyWriter.java:350)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; ... 8 more</font></div><p></p></pre></div><div><br></div><div>API :&nbsp;</div><div>http://jdbc.postgresql.org/development/privateapi/index.html</div></div><div><br></div><div><br><br><wbr></div></div>
	</div>
</div>
</body>
</html>