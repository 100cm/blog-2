<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Makefile usage</h2>
	<h5 id="">2012-08-07 15:38:49&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012773274398/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">如果你的程序是很多个c文件组成的, 某天你对其中的一个c文件做了更改。　其他的都不变。<div>如果要重新编译的话, 所有的c文件都重新编译显然是很浪费时间的.</div><div>gcc编译由4步骤组成, 可以看我前面的BLOG。</div><div>其中link前面的一个步骤是产生对象文件如a.c产生a.o的对象文件(gcc -c) .</div><div>link是把这些O文件组装成一个可执行文件的过程(gcc -o) .</div><div><br></div><div>也就是说如果要提高编译速度, 可以保存这些o文件即对象文件, 只编译变更过的c文件, 然后再link成可执行文件.</div><div>一般可以通过文件的时间改变来判断是否需要重新编译。例如 :&nbsp;</div><div>通过c文件和o文件以及bin文件的时间比较哪个文件是变更过的.</div><div><div><img title="Makefile usage - 德哥@Digoal - The Heart,The World."  alt="Makefile usage - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img8.ph.126.net/wWRBT9gMjQ0WllC8lDhZXg==/3032611399098439058.jpg"  ></div>&nbsp;<div><img title="Makefile usage - 德哥@Digoal - The Heart,The World."  alt="Makefile usage - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img8.ph.126.net/63-XNBwCKYjLNsEkP9jnlg==/6597233593889440898.jpg"  ></div>&nbsp;<br>那么只需要对变更的c文件重新生成o文件然后link. 或者拿最新的o文件link即可.<wbr></div><div>如果手工来判断, 实在是很繁琐.</div><div><br></div><div>还好这个可以交给make来搞定.</div><div>make 需要用到的是Makefile 或者 makefile.</div><div>makefile的语法 :&nbsp;</div><div>1. target file冒号(一般是每个c文件都写一个targetfile , o文件. 最后是link后的bin文件)</div><div><br></div><div>2. depend file(如果target是o文件, 这部分包含了一个c文件和所有的h文件.(&lt;&gt;中的h文件不用写出); &nbsp;如果是bin文件, 写出所有的o文件即可)</div><div>3. rule (如果targetfile是o文件, 这里写gcc -c c文件即可. &nbsp;如果targetfile是bin文件, 那么gcc 所有的o文件 -o bin文件名)</div><div><br></div><div>文件内容和格式如图 :&nbsp;</div><div><div><img title="Makefile usage - 德哥@Digoal - The Heart,The World."  alt="Makefile usage - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img9.ph.126.net/0hv-Lt_2zGI08UbyvLCqXw==/6597167623191778289.jpg"  ></div>&nbsp;</div><div>接下来是一个范例 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >代码中包含1个H文件和2个C文件.</font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# ll</font></div><div><font size="2"  >total 16</font></div><div><font size="2"  >-rw-r--r-- 1 root root 295 Aug &nbsp;7 14:44 a.c</font></div><div><font size="2"  >-rw-r--r-- 1 root root 107 Aug &nbsp;7 14:33 encrypt.c</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp;26 Aug &nbsp;7 14:17 encrypt.h</font></div><div><font size="2"  >-rw-r--r-- 1 root root 210 Aug &nbsp;7 15:21 makefile</font></div><div><font size="2"  ><span style="line-height: 19px;"  >encrypt.c的内容.</span></font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# cat encrypt.c</font></div><div><font size="2"  >//#include "encrypt.h"</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >void encrypt(char *msg) {</font></div><div><font size="2"  >&nbsp; while (* msg) {</font></div><div><font size="2"  >&nbsp; &nbsp; *msg = *msg ^ 31;</font></div><div><font size="2"  >&nbsp; &nbsp; msg++;</font></div><div><font size="2"  >&nbsp; }</font></div><div><font size="2"  >}</font></div><div><span style="line-height: 19px; font-size: small;"  >encrypt.h的内容.</span><br></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# cat encrypt.h</font></div><div><font size="2"  >void encrypt(char * msg);</font></div><div><font size="2"  >a.c文件的内容.</font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# cat a.c</font></div><div><font size="2"  >#include &lt;stdio.h&gt;</font></div><div><font size="2"  >#include &lt;encrypt.h&gt;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >int main() {</font></div><div><font size="2"  >&nbsp; char msg[80];</font></div><div><font size="2"  >&nbsp; while(fgets(msg,80,stdin)) {</font></div><div><font size="2"  >&nbsp; &nbsp; printf("original msg:%s\n", msg);</font></div><div><font size="2"  >&nbsp; &nbsp; // encode</font></div><div><font size="2"  >&nbsp; &nbsp; encrypt(msg);</font></div><div><font size="2"  >&nbsp; &nbsp; printf("encoded msg:%s\n", msg);</font></div><div><font size="2"  >&nbsp; &nbsp; // decode</font></div><div><font size="2"  >&nbsp; &nbsp; encrypt(msg);</font></div><div><font size="2"  >&nbsp; &nbsp; printf("decoded msg:%s\n", msg);</font></div><div><font size="2"  >&nbsp; }</font></div><div><font size="2"  >&nbsp; return 0;</font></div><div><font size="2"  >}</font></div><div><font size="2"  >makefile的内容.</font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# cat makefile&nbsp;</font></div><div><font size="2"  >encrypt.o: encrypt.c</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; gcc -O3 -Wall -Wextra -Werror -g -c encrypt.c</font></div><div><font size="2"  >a.o: a.c encrypt.h</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; gcc -O3 -Wall -Wextra -Werror -I/root/zzz -g -c a.c</font></div><div><font size="2"  >a: a.o encrypt.o</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; gcc -O3 -Wall -Wextra -Werror -g a.o encrypt.o -o a</font></div></div><div><font size="2"  ><br></font></div><div><font size="2"  >使用make 生成a文件的命令.</font></div><div><div><font size="2"  >[root@db-172-16-3-150 zzz]# make a</font></div><div><font size="2"  >gcc -O3 -Wall -Wextra -Werror -I/root/zzz -g -c a.c</font></div><div><font size="2"  >gcc -O3 -Wall -Wextra -Werror -g -c encrypt.c</font></div><div><font size="2"  >gcc -O3 -Wall -Wextra -Werror -g a.o encrypt.o -o a</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ><span style="line-height: 19px;"  >生成a文件的过程中产生了一堆o文件.</span></font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# ll</font></div><div><font size="2"  >total 40</font></div><div><font size="2"  >-rwxr-xr-x 1 root root 10349 Aug &nbsp;7 15:33 a</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp; 295 Aug &nbsp;7 14:44 a.c</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp;6568 Aug &nbsp;7 15:33 a.o</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp; 107 Aug &nbsp;7 14:33 encrypt.c</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp; &nbsp;26 Aug &nbsp;7 14:17 encrypt.h</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp;3144 Aug &nbsp;7 15:33 encrypt.o</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp; 210 Aug &nbsp;7 15:21 makefile</font></div></div><p></p></pre></div><div><br></div><div>修改encrypt.c :&nbsp;</div><div>删除注释行. 再次make a. 我们看到encrypt.c 重新生成了o文件, 并且重新link了bin文件.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 zzz]# make a</font></div><div><font size="2"  >gcc -O3 -Wall -Wextra -Werror -g -c encrypt.c</font></div><div><font size="2"  >gcc -O3 -Wall -Wextra -Werror -g a.o encrypt.o -o a</font></div><p></p></pre></div><div>注意rule部分必须是tab开头的. 否则会没有用.</div><div><br></div><div>还可以在makefile中使用环境变量. 例如 :&nbsp;</div><div><div><img title="Makefile usage - 德哥@Digoal - The Heart,The World."  alt="Makefile usage - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img7.ph.126.net/p5h9BFT8kr8_XR9X3rDz5g==/6597434804516424417.jpg"  ></div>&nbsp;</div></div>
	</div>
</div>
</body>
</html>