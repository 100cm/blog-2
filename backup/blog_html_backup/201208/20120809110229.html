<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">bit-field</h2>
	<h5 id="">2012-08-09 11:02:29&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201279102822977/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">在struct中, 如果定义了几个元素,分别代表性别, 星期, 月份, 几号.<div>其中性别只有2种值,&nbsp;</div><div>星期只有7种值,</div><div>月份只有12种值,</div><div>几号只需要31种值.</div><div>怎么样做到这个struct长度最小呢.</div><div>在C中占用一个字节的是char, short 2字节, int 4字节.&nbsp;</div><div>显然如果使用char和short的话这么定义.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >struct test {</font></div><div><font size="2"  >&nbsp; char sex;</font></div><div><font size="2"  >&nbsp; short week;</font></div><div><font size="2"  >&nbsp; short month;</font></div><div><font size="2"  >&nbsp; short day;</font></div><div><font size="2"  >};</font></div><p></p></pre></div><div>看看多长?</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >[root@db-172-16-3-150 ~]# cat g.c</font></div><div><font size="2"  >#include &lt;stdio.h&gt;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >int main() {</font></div><div><font size="2"  >&nbsp; typedef struct test {</font></div><div><font size="2"  >&nbsp; &nbsp; char sex;</font></div><div><font size="2"  >&nbsp; &nbsp; short week;</font></div><div><font size="2"  >&nbsp; &nbsp; short month;</font></div><div><font size="2"  >&nbsp; &nbsp; short day;</font></div><div><font size="2"  >&nbsp; } test;</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "sizeof(test):%lu\n", sizeof(test));</font></div><div><font size="2"  >&nbsp; return 0;</font></div><div><font size="2"  >}</font></div><div><font size="2"  >结果</font></div><div><font size="2"  >[root@db-172-16-3-150 ~]# gcc -O3 -Wall -Wextra -Werror -g ./g.c -o g &amp;&amp; ./g</font></div><div><font size="2"  >sizeof(test):8</font></div></div><div><font size="2"  >注意1+2+2+2应该等于7字节, 怎么test会占用8字节呢, 这里发生了alignment;</font></div><p></p></pre></div><div>来看看每个元素的地址 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >[root@db-172-16-3-150 ~]# cat g.c</font></div><div><font size="2"  >#include &lt;stdio.h&gt;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >int main() {</font></div><div><font size="2"  >&nbsp; typedef struct test {</font></div><div><font size="2"  >&nbsp; &nbsp; char sex;</font></div><div><font size="2"  >&nbsp; &nbsp; short week;</font></div><div><font size="2"  >&nbsp; &nbsp; short month;</font></div><div><font size="2"  >&nbsp; &nbsp; short day;</font></div><div><font size="2"  >&nbsp; } test;</font></div><div><font size="2"  >&nbsp; test t1 = {'m', 1, 12, 31};</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "sizeof(t1):%lu\n", sizeof(t1));</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "&amp;t1:%p, &amp;(t1.sex):%p, &amp;(t1.week):%p, &amp;(t1.month):%p, &amp;(t1.day):%p\n", &amp;t1, &amp;(t1.sex), &amp;(t1.week), &amp;(t1.month), &amp;(t1.day));</font></div><div><font size="2"  >&nbsp; return 0;</font></div><div><font size="2"  >}</font></div><div><font size="2"  >结果</font></div><div><font size="2"  >[root@db-172-16-3-150 ~]# gcc -O3 -Wall -Wextra -Werror -g ./g.c -o g &amp;&amp; ./g</font></div><div><font size="2"  >sizeof(t1):8</font></div><div><font size="2"  >&amp;t1:0x7fffda4c68f0, &amp;(t1.sex):0x7fffda4c68f0, &amp;(t1.week):0x7fffda4c68f2, &amp;(t1.month):0x7fffda4c68f4, &amp;(t1.day):0x7fffda4c68f6</font></div></div><div><font size="2"  >// 显然char sex在这里占用了2字节. 它和short week一样大.</font></div><p></p></pre></div><div><br></div><div>如果把short week 改成int week会怎么样呢?</div><div><div><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >&nbsp; typedef struct test {</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; char sex;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; int week;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; short month;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; short day;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; } test;</font></div><p></p></pre></div></div><div>结果如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >[root@db-172-16-3-150 ~]# gcc -O3 -Wall -Wextra -Werror -g ./g.c -o g &amp;&amp; ./g</font></div><div><font size="2"  >sizeof(t1):12</font></div><div><font size="2"  >&amp;t1:0x7fff37b19a80, &amp;(t1.sex):0x7fff37b19a80, &amp;(t1.week):0x7fff37b19a84, &amp;(t1.month):0x7fff37b19a88, &amp;(t1.day):0x7fff37b19a8a</font></div></div><div><font size="2"  >// 此时char sex占用4字节了, 这说明补齐和后面的元素类型有关.</font></div><p></p></pre></div><div><br></div><div>把short day改成int day看看会怎么样?</div><div><div><pre class="prettyprint"  ><p></p><div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; typedef struct test {</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; char sex;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; int week;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; short month;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; int day;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; } test;</font></div></div><div><font size="2"  >结果如下 :&nbsp;</font></div><div><div><font size="2"  >[root@db-172-16-3-150 ~]# gcc -O3 -Wall -Wextra -Werror -g ./g.c -o g &amp;&amp; ./g</font></div><div><font size="2"  >sizeof(t1):16</font></div><div><font size="2"  >&amp;t1:0x7fffc9fe0180, &amp;(t1.sex):0x7fffc9fe0180, &amp;(t1.week):0x7fffc9fe0184, &amp;(t1.month):0x7fffc9fe0188, &amp;(t1.day):0x7fffc9fe018c</font></div></div><div><font size="2"  >// 此时short month变成了4字节.</font></div><p></p></pre></div></div><div><br></div><div>不改类型, 重新排列一下, 把int都放在前面, 小的放后面. 看看结果如何?</div><div>结果如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >[root@db-172-16-3-150 ~]# cat g.c</font></div><div><font size="2"  >#include &lt;stdio.h&gt;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >int main() {</font></div><div><font size="2"  >&nbsp; typedef struct test {</font></div><div><font size="2"  >&nbsp; &nbsp; int week; &nbsp;// 4字节</font></div><div><font size="2"  >&nbsp; &nbsp; int day;<span style="line-height: 22px;"  >&nbsp;</span><span style="line-height: 22px;"  >&nbsp;// 4字节</span></font></div><div><font size="2"  >&nbsp; &nbsp; short month;<span style="line-height: 22px;"  >&nbsp;</span><span style="line-height: 22px;"  >&nbsp;// 2字节</span></font></div><div><font size="2"  >&nbsp; &nbsp; char sex;<span style="line-height: 22px;"  >&nbsp;</span><span style="line-height: 22px;"  >&nbsp;// 2字节</span></font></div><div><font size="2"  >&nbsp; } test;</font></div><div><font size="2"  >&nbsp; test t1 = {.sex='m', .week=1, .month=12, .day=31};</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "sizeof(t1):%lu\n", sizeof(t1));</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "&amp;t1:%p, &amp;(t1.week):%p, &amp;(t1.day):%p, &amp;(t1.month):%p, &amp;(t1.sex):%p\n", &amp;t1, &amp;(t1.week), &amp;(t1.day), &amp;(t1.month), &amp;(t1.sex));</font></div><div><font size="2"  >&nbsp; return 0;</font></div><div><font size="2"  >}</font></div><div><font size="2"  >[root@db-172-16-3-150 ~]# gcc -O3 -Wall -Wextra -Werror -g ./g.c -o g &amp;&amp; ./g</font></div><div><font size="2"  >sizeof(t1):12</font></div><div><font size="2"  >&amp;t1:0x7fffd3d455d0, &amp;(t1.week):0x7fffd3d455d0, &amp;(t1.day):0x7fffd3d455d4, &amp;(t1.month):0x7fffd3d455d8, &amp;(t1.sex):0x7fffd3d455da</font></div></div><div><font size="2"  >// 总长度变成了12字节.</font></div><p></p></pre></div><div><br>好了下面切入正题, week, sex, day, month 如果用比特位来表示的话。<wbr></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >week 3个bit</font></div><div><font size="2"  >sex 1个bit</font></div><div><font size="2"  >day 5个bit</font></div><div><font size="2"  >month 4个bit&nbsp;</font></div><p></p></pre></div><div>这些就能够表示了. 总共加起来13个比特, 也就是2个字节（16bit）就可以表示。</div><div>注意, 由于用到了bit, 带符号的数字类型就不合适了, 如int, 第一个比特位表示正负, 所以要使用unsigned来定义数字类型来存储bit信息.</div><div>(unsigned int, unsigned char, unsigned short 等等 都可以)</div><div>如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 ~]# cat g.c</font></div><div><font size="2"  >#include &lt;stdio.h&gt;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >int main() {</font></div><div><font size="2"  >&nbsp; typedef struct test {</font></div><div><font size="2"  >&nbsp; &nbsp; unsigned short week:3;</font></div><div><font size="2"  >&nbsp; &nbsp; unsigned short day:5;</font></div><div><font size="2"  >&nbsp; &nbsp; unsigned short month:4;</font></div><div><font size="2"  >&nbsp; &nbsp; unsigned short sex:1;</font></div><div><font size="2"  >&nbsp; } test;</font></div><div><font size="2"  >&nbsp; test t1 = {.sex=1, .week=1, .month=12, .day=31}; &nbsp;// 此时sex也必须用数字(0和1)来表示</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "sizeof(t1):%lu\n", sizeof(t1));</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "&amp;t1:%p, &amp;(t1.week):%p, &amp;(t1.day):%p, &amp;(t1.month):%p, &amp;(t1.sex):%p\n", &amp;t1, &amp;(t1.week), &amp;(t1.day), &amp;(t1.month), &amp;(t1.sex));</font></div><div><font size="2"  >&nbsp; return 0;</font></div><div><font size="2"  >}</font></div><div><font size="2"  >结果, 因为没有办法获取bit-field的地址(地址最小单位是1字节, 1字节内已经没法获取了.)</font></div><div><font size="2"  >[root@db-172-16-3-150 ~]# gcc -O3 -Wall -Wextra -Werror -g ./g.c -o g &amp;&amp; ./g</font></div><div><font size="2"  >cc1: warnings being treated as errors</font></div><div><font size="2"  >./g.c: In function ‘main’:</font></div><div><font size="2"  >./g.c:10: warning: large integer implicitly truncated to unsigned type</font></div><div><font size="2"  >./g.c:12: error: cannot take address of bit-field ‘week’</font></div><div><font size="2"  >./g.c:12: error: cannot take address of bit-field ‘day’</font></div><div><font size="2"  >./g.c:12: error: cannot take address of bit-field ‘month’</font></div><div><font size="2"  >./g.c:12: error: cannot take address of bit-field ‘sex’</font></div><p></p></pre></div><div>下面看看这个struct占用了多少空间.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >// 注释掉<span style="line-height: 22px;"  >fprintf(stdout, "&amp;t1:%p, &amp;(t1.week):%p, &amp;(t1.day):%p, &amp;(t1.month):%p, &amp;(t1.sex):%p\n", &amp;t1, &amp;(t1.week), &amp;(t1.day), &amp;(t1.month), &amp;(t1.sex));</span></font></div><div><font size="2"  >结果 :&nbsp;</font></div><div><div><font size="2"  >[root@db-172-16-3-150 ~]# gcc -O3 -Wall -Wextra -Werror -g ./g.c -o g &amp;&amp; ./g</font></div><div><font size="2"  >sizeof(t1):2</font></div></div><div><font size="2"  >// 现在struct test 只占用了2字节, 显然大大节约了空间.</font></div><p></p></pre></div><div><br></div><div>但是又有要注意的问题来了, 前面已经提到了alignment, 如果这些bit-field不是连续存储的, 中间穿插了其他类型如int, 那么占用空间又不一样了.</div><div>因此要节约空间, 设计结构的时候要考虑到这些点.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 ~]# cat g.c</font></div><div><font size="2"  >#include &lt;stdio.h&gt;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >int main() {</font></div><div><font size="2"  >&nbsp; typedef struct test {</font></div><div><font size="2"  >&nbsp; &nbsp; unsigned short week:3; &nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; unsigned short day:5; &nbsp;// day+week 占用4字节</font></div><div><font size="2"  >&nbsp; &nbsp; int age; &nbsp;// 4字节</font></div><div><font size="2"  >&nbsp; &nbsp; unsigned short month:4;</font></div><div><font size="2"  >&nbsp; &nbsp; unsigned short sex:1; &nbsp;// sex+month占用4字节, 这里为什么不是2字节? 因为这个结构中 最大的元素 int age 这个元素单独占用了4字节, 所以整个结构体必须占用4的倍数字节. 如果改成long int age, 那么这个结构将占用24字节, 也就是8的倍数.</font></div><div><font size="2"  >&nbsp; } test;</font></div><div><font size="2"  >&nbsp; test t1 = {.age=10, .sex=1, .week=1, .month=12, .day=31};</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "sizeof(t1):%lu\n", sizeof(t1));</font></div><div><font size="2"  >// &nbsp;fprintf(stdout, "&amp;t1:%p, &amp;(t1.week):%p, &amp;(t1.day):%p, &amp;(t1.month):%p, &amp;(t1.sex):%p\n", &amp;t1, &amp;(t1.week), &amp;(t1.day), &amp;(t1.month), &amp;(t1.sex));</font></div><div><font size="2"  >&nbsp; return 0;</font></div><div><font size="2"  >}</font></div><div><font size="2"  >结果 :&nbsp;</font></div><div><font size="2"  >[root@db-172-16-3-150 ~]# gcc -O3 -Wall -Wextra -Werror -g ./g.c -o g &amp;&amp; ./g</font></div><div><font size="2"  >sizeof(t1):12</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>