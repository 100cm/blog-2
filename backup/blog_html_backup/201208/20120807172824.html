<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">flex length type in struct</h2>
	<h5 id="">2012-08-07 17:28:24&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020127752342756/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">结构体的长度是定长的, 也就是说结构体内部每个元素应该都是固定长度的, 像char a[]这种不定长度的类型, 按理说不应该放在结构体内.<div>但是很奇怪的是, C中允许把char a[]这样的类型定义在结构体中, 只是它只能放在结构体元素的末端.</div><div>例如 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 zzz]# cat d.c</font></div><div><font size="2"  >struct fish {</font></div><div><font size="2"  >&nbsp; int a;</font></div><div><font size="2"  >&nbsp; char b[];</font></div><div><font size="2"  >&nbsp; float c;</font></div><div><font size="2"  >};</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >int main() {</font></div><div><font size="2"  >&nbsp; return 0;</font></div><div><font size="2"  >}</font></div><div><font size="2"  >编译时将报错 :&nbsp;</font></div><div><div><font size="2"  >[root@db-172-16-3-150 zzz]# gcc -O3 -Wall -Wextra -Werror -g ./d.c -o d</font></div><div><font size="2"  >./d.c:3: error: flexible array member not at end of struct</font></div></div><p></p></pre></div><div><br></div><div>把char b[]改成定长的char b[10]; 就可以了。</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 zzz]# cat d.c</font></div><div><font size="2"  >struct fish {</font></div><div><font size="2"  >&nbsp; int a;</font></div><div><font size="2"  >&nbsp; char b[10];</font></div><div><font size="2"  >&nbsp; float c;</font></div><div><font size="2"  >};</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >int main() {</font></div><div><font size="2"  >&nbsp; return 0;</font></div><div><font size="2"  >}</font></div><div><font size="2"  >[root@db-172-16-3-150 zzz]# gcc -O3 -Wall -Wextra -Werror -g ./d.c -o d</font></div><p></p></pre></div><div><br></div><div>或者把char b[]放在末端, 也可以, 只是用法会比较特别。</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >[root@db-172-16-3-150 zzz]# cat d.c</font></div><div><font size="2"  >struct fish {</font></div><div><font size="2"  >&nbsp; int a;</font></div><div><font size="2"  >&nbsp; float c;</font></div><div><font size="2"  >&nbsp; char b[];</font></div><div><font size="2"  >};</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >int main() {</font></div><div><font size="2"  >&nbsp; return 0;</font></div><div><font size="2"  >}</font></div></div><div><font size="2"  >编译正常</font></div><div><span style="line-height: 22px;"  ><font size="2"  >[root@db-172-16-3-150 zzz]# gcc -O3 -Wall -Wextra -Werror -g ./d.c -o d</font></span></div><p></p></pre></div><div><br></div>例子 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >[root@db-172-16-3-150 zzz]# cat b.c</font></div><div><font size="2"  >#include &lt;stdio.h&gt;</font></div><div><font size="2"  >#include &lt;string.h&gt;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >struct fish {</font></div><div><font size="2"  >&nbsp; int b;</font></div><div><font size="2"  >&nbsp; float c;</font></div><div><font size="2"  >&nbsp; char a[];</font></div><div><font size="2"  >};</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >struct monkey {</font></div><div><font size="2"  >&nbsp; int b;</font></div><div><font size="2"  >&nbsp; float c;</font></div><div><font size="2"  >&nbsp; char a[100];</font></div><div><font size="2"  >};</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >int main() {</font></div><div><font size="2"  >&nbsp; struct fish f1;</font></div><div><font size="2"  >&nbsp; struct monkey m1 = {100, 9.9, "ddabc"};</font></div><div><font size="2"  >&nbsp; f1.b=100;</font></div><div><font size="2"  >&nbsp; f1.c=9.9;</font></div><div><font size="2"  >&nbsp; f1.a[0]='a';</font></div><div><font size="2"  >&nbsp; f1.a[1]='b';</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "fish:%lu, monkey:%lu, float:%lu, int:%lu\n", sizeof(struct fish), sizeof(struct monkey), sizeof(float), sizeof(int));</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "f1.b:%i, f1.c:%f, f1.a:%s\n", f1.b, f1.c, (char *) &amp;f1.a);</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "m1.b:%i, m1.c:%f, m1.a:%s\n", m1.b, m1.c, (char *) &amp;m1.a);</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "f1:%p, f1.b:%p, f1.c:%p, f1.a:%p\n", &amp;f1, &amp;f1.b, &amp;f1.c, &amp;f1.a);</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "m1:%p, m1.b:%p, m1.c:%p, m1.a:%p\n", &amp;m1, &amp;m1.b, &amp;m1.c, &amp;m1.a);</font></div><div><font size="2"  >&nbsp; fprintf(stdout, "f1:%lu, m1:%lu\n", sizeof(f1), sizeof(m1));</font></div><div><font size="2"  >&nbsp; return 0;</font></div><div><font size="2"  >}</font></div></div><div><font size="2"  ><br></font></div><div><font size="2"  >结果 :&nbsp;</font></div><div><div><font size="2"  >[root@db-172-16-3-150 zzz]# gcc -O3 -Wall -Wextra -Werror -g ./b.c -o b &amp;&amp; ./b</font></div><div><font size="2"  >fish:8, monkey:108, float:4, int:4</font></div><div><font size="2"  >f1.b:100, f1.c:9.900000, f1.a:ab?_4</font></div><div><font size="2"  >m1.b:100, m1.c:9.900000, m1.a:ddabc</font></div><div><font size="2"  >f1:0x7fff166ff610, f1.b:0x7fff166ff610, f1.c:0x7fff166ff614, f1.a:0x7fff166ff618</font></div><div><font size="2"  >m1:0x7fff166ff5a0, m1.b:0x7fff166ff5a0, m1.c:0x7fff166ff5a4, m1.a:0x7fff166ff5a8</font></div><div><font size="2"  >f1:8, m1:108</font></div></div><p></p></pre></div><div><br></div><div>从长度上看, f1 只占用了8字节, 没有留出空间用于存放a[], 所以可能会导致溢出, 或改到其他重要数据, 因为这块内存没有被声明.</div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">hgj1995 - 2015-01-09 11:13:34</h5>
				<div>这个好像叫灵活数组成员</div>
			</div>
	</div>
</div>
</body>
</html>