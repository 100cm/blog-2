<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL's pgsql_tmp like oracle's temp tablespace</h2>
	<h5 id="">2011-07-22 22:17:27&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201162205249938/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>&nbsp; 在Oracle里面，不同的用户可以指定不同的默认临时表空间。</div><div>&nbsp; 在PostgreSQL里面，临时目录pgsql_tmp。是放在数据库的默认表空间里面。如果建数据库的时候没有指定默认表空间，那么pgsql_tmp放在</div><div>$PGDATA/base/pgsql_tmp，如果指定了默认表空间，那么放在默认表空间里面.</div><div>如 :&nbsp;</div><div><div>digoal=&gt; \db</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of tablespaces</div><div>&nbsp; &nbsp; Name &nbsp; &nbsp;| &nbsp;Owner &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Location &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>------------+----------+---------------------------------</div><div>&nbsp;pg_default | postgres |&nbsp;</div><div>&nbsp;pg_global &nbsp;| postgres |&nbsp;</div><div>&nbsp;tbs_digoal | digoal &nbsp; | /home/pgdata/pg_root/tbs_digoal</div></div><div>digoal数据库的默认表空间是tbs_digoal,那么在/home/pgdata/pg_root/tbs_digoal里面肯定有一个pgsql_tmp目录.</div><div><div>postgres@db5-&gt; ll /home/pgdata/pg_root/tbs_digoal/PG_9.1_201105231/</div><div>total 16K</div><div>drwx------ 2 postgres postgres &nbsp;12K Jul 22 15:52 16386</div><div><font size="4"  >drwx------ 2 postgres postgres 4.0K Jul 22 16:29 pgsql_tmp</font></div></div><div><br></div><div>&nbsp; pgsql_tmp功能与Oracle数据库的temp tablespace功能类似，用于存放排序,hash表等产生的临时数据,如order by,group by,distinct,merge join等操作。</div><div>&nbsp; pgsql_tmp目录中，文件格式如下:</div><div><span style="font-family: monospace; font-size: 12px; line-height: 19px;"  >pgsql_tmp<tt style="line-height: 19px; font-size: 1em;"  ><i style="line-height: 19px;"  >PPP</i></tt>.<tt style="line-height: 19px; font-size: 1em;"  ><i style="line-height: 19px;"  >NNN</i></tt></span></div><div>其中PPP表示数据库backend process的PID，NNN表示这个BACKEND PROCESS产生的第N个临时文件。</div><div>pgsql_tmp中的使用和work_mem参数至关重要，work_mem很小时，如果排序操作超出work_mem定制的SIZE,那么会使用到pgsql_tmp。不仅如此,PostgreSQL不是说work_mem能满足就一定不写pgsql_tmp目录，有时候还是会用到pgsql_tmp。下面举例来看看是什么情况:</div><div><br></div><div>首先建立测试数据 :&nbsp;</div><div><div>digoal=&gt; create table user_info (id bigint,firstname text,lastname text,corp text,post text,age int,crt_time timestamp without time zone,comment text);</div><div>CREATE TABLE</div><div>digoal=&gt; insert into user_info select generate_series(1,5000000),'zhou','digoal'||generate_series(2,5000001),'sky-mobi','dba team leader',28,clock_timestamp(),'flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj'||generate_series(3,5000002);</div><div>INSERT 0 5000000</div><div>digoal=&gt; analyze user_info;</div><div>ANALYZE</div><div>digoal=&gt; select pg_relation_size('user_info')/1024/1024;</div><div>&nbsp;?column?&nbsp;</div><div>----------</div><div>&nbsp; &nbsp; &nbsp; 831</div><div>下面这个表主要是测算ID所占用的空间大概是多少。（待会用ID来做group by或distinct,我们可以看看数据库需要多少临时空间来处理这种SQL操作.最终你会发现，数据库需要的空间和实际排序用到的空间差不多）</div><div><div>digoal=&gt; create table user_id (id bigint);</div><div>CREATE TABLE</div><div>digoal=&gt; insert into user_id select generate_series(1,5000000);</div><div>INSERT 0 5000000</div></div></div><div><div>digoal=&gt; select pg_relation_size('user_id')/1024/1024;</div><div>&nbsp;?column?&nbsp;</div><div>----------</div><div>&nbsp; &nbsp; &nbsp; 172</div><div>因为有PAGE和tuple的头部信息，所以实际上ID占用的空间约120MB</div></div><div><br></div><div>查看当前的work_mem配置 :&nbsp;</div><div><div>digoal=&gt; show work_mem;</div><div>&nbsp;work_mem&nbsp;</div><div>----------</div><div>&nbsp;1MB</div></div><div><br></div><div>因为ID内容约120MB，这里使用ID来分组或DISTINCT的话，我们可以想象，肯定是用到pgsql_tmp的。如下验证了我们的猜想。</div><div><font size="4"  ># Sort Method: external sort &nbsp;Disk: 87984kB</font></div><div>digoal=&gt; explain analyze verbose select distinct id from user_info;</div><div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>&nbsp; &nbsp; &nbsp;&nbsp;</div><div>------------------------------------------------------------------------------------------------------------------------------------</div><div>------</div><div>&nbsp;Unique &nbsp;(cost=859215.04..884215.22 rows=5000036 width=8) (actual time=10747.954..20153.818 rows=5000000 loops=1)</div><div>&nbsp; &nbsp;Output: id</div><div>&nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=859215.04..871715.13 rows=5000036 width=8) (actual time=10747.951..14051.498 rows=5000000 loops=1)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: user_info.id</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Method: external sort &nbsp;Disk: 87984kB</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on digoal.user_info &nbsp;(cost=0.00..156383.36 rows=5000036 width=8) (actual time=0.014..3689.517 rows=5000000 loo</div><div>ps=1)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id</div><div>&nbsp;Total runtime: 22895.580 ms</div><div>(9 rows)</div></div><div><br></div><div>在执行过程中在/home/pgdata/pg_root/tbs_digoal/PG_9.1_201105231/pgsql_tmp中产生文件pgsql_tmp23123.0 大小就是87984kB。</div><div>执行完这个文件自动删除。</div><div><br></div><div>然后我们来加大work_mem到120MB看看还用不用pgsql_tmp</div><div><div>digoal=&gt; set work_mem='120 MB';</div><div>SET</div><div>digoal=&gt; explain analyze verbose select distinct id from user_info;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>------------------------------------------------------------------------------------------------------------------------------------</div><div>&nbsp;HashAggregate &nbsp;(cost=168883.45..218883.81 rows=5000036 width=8) (actual time=8561.560..13222.270 rows=5000000 loops=1)</div><div>&nbsp; &nbsp;Output: id</div><div>&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on digoal.user_info &nbsp;(cost=0.00..156383.36 rows=5000036 width=8) (actual time=0.021..3665.240 rows=5000000 loops=1)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id</div><div>&nbsp;Total runtime: 16016.834 ms</div><div>显然已经不使用disk文件了。</div></div><div><br></div><div>然后我们换一句SQL，distinct id,comment看看会不会用disk。因为id+comment是当前的排序操作内容，大于120MB。我们预计是会使用DISK的。</div><div>结果与我们预期的一致：</div><div><div>digoal=&gt; explain analyze verbose select distinct id,comment from user_info;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp;</div><div>------------------------------------------------------------------------------------------------------------------------------------</div><div>-------</div><div>&nbsp;Unique &nbsp;(cost=883625.04..921125.31 rows=5000036 width=83) (actual time=14416.251..25803.966 rows=5000000 loops=1)</div><div>&nbsp; &nbsp;Output: id, comment</div><div>&nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=883625.04..896125.13 rows=5000036 width=83) (actual time=14416.248..18399.329 rows=5000000 loops=1)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id, comment</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: user_info.id, user_info.comment</div><div><font size="4"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Method: external merge &nbsp;Disk: 458352kB</font></div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on digoal.user_info &nbsp;(cost=0.00..156383.36 rows=5000036 width=83) (actual time=0.011..4205.069 rows=5000000 lo</div><div>ops=1)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id, comment</div><div>&nbsp;Total runtime: 28704.160 ms</div><div>(9 rows)</div></div><div>接下来我们加大work_mem到458352kB+120MB看看是什么情况?</div><div><div>digoal=&gt; explain analyze verbose select distinct id,comment from user_info;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp;</div><div>------------------------------------------------------------------------------------------------------------------------------------</div><div>-</div><div>&nbsp;HashAggregate &nbsp;(cost=181383.54..231383.90 rows=5000036 width=83) (actual time=10108.302..14901.176 rows=5000000 loops=1)</div><div>&nbsp; &nbsp;Output: id, comment</div><div>&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on digoal.user_info &nbsp;(cost=0.00..156383.36 rows=5000036 width=83) (actual time=0.020..4080.396 rows=5000000 loops=1)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id, comment</div><div>&nbsp;Total runtime: 17653.570 ms</div><div>(5 rows)</div></div><div>显然，不需要使用DISK了。</div><div><br></div><div>再次调整work_mem到 &lt;&nbsp;<span style="line-height: 28px; font-size: large;"  >458352kB的值如370 MB.看看什么情况?</span></div><div><div>digoal=&gt; set work_mem='370 MB';</div><div>SET</div><div>digoal=&gt; explain analyze verbose select distinct id,comment from user_info;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp;</div><div>------------------------------------------------------------------------------------------------------------------------------------</div><div>-------</div><div>&nbsp;Unique &nbsp;(cost=883625.04..921125.31 rows=5000036 width=83) (actual time=14656.450..25803.112 rows=5000000 loops=1)</div><div>&nbsp; &nbsp;Output: id, comment</div><div>&nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=883625.04..896125.13 rows=5000036 width=83) (actual time=14656.447..18389.175 rows=5000000 loops=1)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id, comment</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: user_info.id, user_info.comment</div><div><font size="4"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Method: external merge &nbsp;Disk: 458352kB</font></div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on digoal.user_info &nbsp;(cost=0.00..156383.36 rows=5000036 width=83) (actual time=0.014..4138.056 rows=5000000 lo</div><div>ops=1)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id, comment</div><div>&nbsp;Total runtime: 28735.377 ms</div><div>是不是很奇怪？没错work_mem的370MB没有被使用，直接使用磁盘了。说明work_mem不满足需求的时候，就全部使用磁盘了。</div></div><div><br></div><div>再次调整work_mem到一个极其大的数字，目的是看看work_mem是不是一次性allocate的，还是需要多少用多少？为确保公正，我们重新开一个session。</div><div><div>postgres@db5-&gt; psql -h 127.0.0.1 digoal digoal</div><div>psql (9.1beta2)</div><div>Type "help" for help.</div><div><br></div><div>digoal=&gt; select pg_backend_pid();</div><div>&nbsp;pg_backend_pid&nbsp;</div><div>----------------</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 23496</div><div>查看23496这个backend process当前使用的内存是多少.如下，结果是4176KB。</div></div><div><div>postgres@db5-&gt; ps -eo pid,rss,cmd|grep 23496</div><div>23496 &nbsp;4176 postgres: digoal digoal 127.0.0.1(2486) idle</div></div><div><br></div><div>下面执行一个SQL，看看RSS的变化。</div><div><div>digoal=&gt; set work_mem='10240 MB';</div><div>SET</div><div>digoal=&gt; explain analyze verbose select distinct id,comment from user_info;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp;</div><div>------------------------------------------------------------------------------------------------------------------------------------</div><div>-</div><div>&nbsp;HashAggregate &nbsp;(cost=181383.54..231383.90 rows=5000036 width=83) (actual time=10480.524..15375.754 rows=5000000 loops=1)</div><div>&nbsp; &nbsp;Output: id, comment</div><div>&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on digoal.user_info &nbsp;(cost=0.00..156383.36 rows=5000036 width=83) (actual time=0.052..4387.955 rows=5000000 loops=1)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id, comment</div><div>&nbsp;Total runtime: 18207.895 ms</div><div>(5 rows)</div></div><div>查看内存消耗等于1767168KB ,约1.7GB。</div><div><div>postgres@db5-&gt; ps -eo pid,rss,cmd|grep 23496</div><div>23496 1767168 postgres: digoal digoal 127.0.0.1(2486) EXPLAIN</div></div><div>SQL执行完后,内存消耗降低到877276KB ，约870MB。也就是说刚才的distinct操作用掉了约830MB内存。</div><div><div>postgres@db5-&gt; ps -eo pid,rss,cmd|grep 23496</div><div>23496 877276 postgres: digoal digoal 127.0.0.1(2486) idle</div></div><div>为什么内存要用掉830MB,而磁盘只需要<span style="line-height: 28px; font-size: large;"  >458352kB呢?将近一倍。</span></div><div><span style="line-height: 28px; font-size: large;"  >原因很简单，回想一下这个表是不是约830MB呢，再看看两次的执行计划，是不是不一样呢？而且执行完后进程还保留了870MB左右的内存，实际上就是user_info表的数据占据的空间以及其他分配给backend process的内存。而使用磁盘的时候，只用到了id和comment字段的内容，约</span><span style="line-height: 28px; font-size: large;"  >458352kB。</span></div><div><span style="line-height: 28px; font-size: large;"  >我们再往表里插入一些数据来证实一下这个想法：</span></div><div><div style="line-height: 28px; font-size: large;"  >digoal=&gt; insert into user_info select generate_series(1,5000000),'zhou','digoal'||generate_series(2,5000001),'sky-mobi','dba team leader',28,clock_timestamp(),'flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj'||generate_series(3,5000002);</div><div style="line-height: 28px; font-size: large;"  >INSERT 0 5000000</div><div style="line-height: 28px; font-size: large;"  >digoal=&gt; analyze user_info;</div><div style="line-height: 28px; font-size: large;"  >ANALYZE</div><div style="line-height: 28px; font-size: large;"  >digoal=&gt; select pg_relation_size('user_info')/1024/1024;</div><div style="line-height: 28px; font-size: large;"  >&nbsp;?column?&nbsp;</div><div style="line-height: 28px; font-size: large;"  >----------</div><div style="line-height: 28px; font-size: large;"  >&nbsp; &nbsp; &nbsp;1698</div><div style="line-height: 28px; font-size: large;"  >此时表的SIZE是1698MB,同样我们执行如下SQL</div><div><div><font size="4"  ><span style="line-height: 28px;"  ><br></span></font></div><div><font size="4"  ><span style="line-height: 28px;"  >digoal=&gt; explain analyze verbose select distinct id,comment from user_info;</span></font></div><div><font size="4"  ><span style="line-height: 28px;"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></font></div><div><font size="4"  ><span style="line-height: 28px;"  >&nbsp; &nbsp;</span></font></div><div><font size="4"  ><span style="line-height: 28px;"  >------------------------------------------------------------------------------------------------------------------------------------</span></font></div><div><font size="4"  ><span style="line-height: 28px;"  >---</span></font></div><div><font size="4"  ><span style="line-height: 28px;"  >&nbsp;HashAggregate &nbsp;(cost=369825.15..471442.58 rows=10161743 width=86) (actual time=20834.803..30828.287 rows=10000000 loops=1)</span></font></div><div><font size="4"  ><span style="line-height: 28px;"  >&nbsp; &nbsp;Output: id, comment</span></font></div><div><font size="4"  ><span style="line-height: 28px;"  >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on digoal.user_info &nbsp;(cost=0.00..319016.43 rows=10161743 width=86) (actual time=0.021..8309.780 rows=10000000 loops=</span></font></div><div><font size="4"  ><span style="line-height: 28px;"  >1)</span></font></div><div><font size="4"  ><span style="line-height: 28px;"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id, comment</span></font></div><div><font size="4"  ><span style="line-height: 28px;"  >&nbsp;Total runtime: 36475.840 ms</span></font></div></div><div><font size="4"  ><span style="line-height: 28px;"  >再次查看内存的使用，没错现在的使用是3.6GB</span></font></div><div style="line-height: 28px; font-size: large;"  ><div>postgres@db5-&gt; ps -eo pid,rss,cmd|grep 23496</div><div>23496 3632540 postgres: digoal digoal 127.0.0.1(2486) EXPLAIN</div></div><div style="line-height: 28px; font-size: large;"  >执行完后驻留了1.8GB。是不是刚好排序使用的是1698MB呢。没错。</div><div style="line-height: 28px; font-size: large;"  ><div>postgres@db5-&gt; ps -eo pid,rss,cmd|grep 23496</div><div>23496 1858568 postgres: digoal digoal 127.0.0.1(2486) idle</div></div></div><div><span style="line-height: 28px; font-size: large;"  >注意，</span><span style="line-height: 28px; font-size: large;"  >1858568这部分被驻留的内存应该是操作系统OS CACHE。驻留的behavior可以通过posix来调整.pg_fincore就是不错的一个软件。</span></div><div><span style="line-height: 28px; font-size: large;"  ><br></span></div><div><span style="line-height: 28px; font-size: large;"  >接下来我们要测试一下pgsql_tmp这个里面的文件,在执行过程中删掉会怎么样?</span></div><div><span style="line-height: 28px; font-size: large;"  >首先把work_mem调下来,</span></div><div><div style="line-height: 28px; font-size: large;"  >digoal=&gt; set work_mem='1 MB';</div><div style="line-height: 28px; font-size: large;"  >SET</div><div style="line-height: 28px; font-size: large;"  >然后执行如下SQL</div><div style="line-height: 28px; font-size: large;"  >digoal=&gt; select distinct id,comment from user_info limit 100;</div><div style="line-height: 28px; font-size: large;"  >然后马上到/home/pgdata/pg_root/tbs_digoal/PG_9.1_201105231/pgsql_tmp删除pgsql_tmp23496.*</div><div style="line-height: 28px; font-size: large;"  >神奇的事情发生了，结果可以正常返回。</div><div style="line-height: 28px; font-size: large;"  ><div>&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;comment &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>----+----------------------------------------------------------------------------</div><div>&nbsp; 1 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj3</div><div>&nbsp; 1 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj3</div><div>&nbsp; 2 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj4</div><div>&nbsp; 2 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj4</div><div>&nbsp; 3 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj5</div><div>&nbsp; 3 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj5</div><div>&nbsp; 4 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj6</div><div>&nbsp; 4 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj6</div><div>&nbsp; 5 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj7</div><div>&nbsp; 5 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj7</div><div>&nbsp; 6 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj8</div><div>&nbsp; 6 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj8</div><div>&nbsp; 7 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj9</div><div>&nbsp; 7 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj9</div><div>&nbsp; 8 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj10</div><div>&nbsp; 8 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj10</div><div>&nbsp; 9 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj11</div><div>&nbsp; 9 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj11</div><div>&nbsp;10 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj12</div><div>&nbsp;10 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj12</div><div>&nbsp;11 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj13</div><div>&nbsp;11 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj13</div><div>&nbsp;12 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj14</div><div>&nbsp;12 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj14</div><div>&nbsp;13 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj15</div><div>&nbsp;13 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj15</div><div>&nbsp;14 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj16</div><div>&nbsp;14 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj16</div><div>&nbsp;15 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj17</div><div>&nbsp;15 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj17</div><div>&nbsp;16 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj18</div><div>&nbsp;16 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj18</div><div>&nbsp;17 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj19</div><div>&nbsp;17 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj19</div><div>&nbsp;18 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj20</div><div>&nbsp;18 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj20</div><div>&nbsp;19 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj21</div><div>&nbsp;19 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj21</div><div>&nbsp;20 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj22</div><div>&nbsp;20 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj22</div><div>&nbsp;21 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj23</div><div>&nbsp;21 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj23</div><div>&nbsp;22 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj24</div><div>&nbsp;22 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj24</div><div>&nbsp;23 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj25</div><div>&nbsp;23 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj25</div><div>&nbsp;24 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj26</div><div>&nbsp;24 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj26</div><div>&nbsp;25 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj27</div><div>&nbsp;25 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj27</div><div>&nbsp;26 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj28</div><div>&nbsp;26 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj28</div><div>&nbsp;27 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj29</div><div>&nbsp;27 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj29</div><div>&nbsp;28 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj30</div><div>&nbsp;28 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj30</div><div>&nbsp;29 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj31</div><div>&nbsp;29 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj31</div><div>&nbsp;30 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj32</div><div>&nbsp;30 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj32</div><div>&nbsp;31 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj33</div><div>&nbsp;31 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj33</div><div>&nbsp;32 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj34</div><div>&nbsp;32 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj34</div><div>&nbsp;33 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj35</div><div>&nbsp;33 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj35</div><div>&nbsp;34 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj36</div><div>&nbsp;34 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj36</div><div>&nbsp;35 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj37</div><div>&nbsp;35 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj37</div><div>&nbsp;36 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj38</div><div>&nbsp;36 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj38</div><div>&nbsp;37 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj39</div><div>&nbsp;37 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj39</div><div>&nbsp;38 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj40</div><div>&nbsp;38 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj40</div><div>&nbsp;39 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj41</div><div>&nbsp;39 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj41</div><div>&nbsp;40 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj42</div><div>&nbsp;40 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj42</div><div>&nbsp;41 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj43</div><div>&nbsp;41 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj43</div><div>&nbsp;42 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj44</div><div>&nbsp;42 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj44</div><div>&nbsp;43 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj45</div><div>&nbsp;43 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj45</div><div>&nbsp;44 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj46</div><div>&nbsp;44 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj46</div><div>&nbsp;45 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj47</div><div>&nbsp;45 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj47</div><div>&nbsp;46 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj48</div><div>&nbsp;46 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj48</div><div>&nbsp;47 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj49</div><div>&nbsp;47 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj49</div><div>&nbsp;48 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj50</div><div>&nbsp;48 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj50</div><div>&nbsp;49 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj51</div><div>&nbsp;49 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj51</div><div>&nbsp;50 | flkejwkhnlkjahg()JIOlk &nbsp;fkljkejhnKHJLKJHFKWEhgfoi2o43it09KHKJFnhrksj52</div><div>&nbsp;50 | flkejwkhnlkjahgJLIJFOIJOIJEGF fkljkejhnKHJL你好Ehgfoi2o43it09KHKJFnhrksj52</div><div>(100 rows)</div></div><div style="line-height: 28px; font-size: large;"  ><br></div><div style="line-height: 28px; font-size: large;"  >那么pgsql_tmp里面的文件存储的到底是啥呢？</div><div style="line-height: 28px; font-size: large;"  >在源代码中我找到了这个相关的。</div><div><font size="4"  ><span style="line-height: 28px;"  >src/include/storage/fd.h</span></font></div></div><div><font size="4"  ><div style="line-height: 28px;"  >/* Filename components for OpenTemporaryFile */</div><div style="line-height: 28px;"  >#define PG_TEMP_FILES_DIR "pgsql_tmp"</div><div style="line-height: 28px;"  >#define PG_TEMP_FILE_PREFIX "pgsql_tmp"</div><div>src/backend/storage/file/fd.c</div><div><div><div>/*</div><div>&nbsp;* Remove temporary and temporary relation files left over from a prior</div><div>&nbsp;* postmaster session</div><div>&nbsp;*</div><div>&nbsp;* This should be called during postmaster startup. &nbsp;It will forcibly</div><div>&nbsp;* remove any leftover files created by OpenTemporaryFile and any leftover</div><div>&nbsp;* temporary relation files created by mdcreate.</div><div>&nbsp;*</div><div>&nbsp;* NOTE: we could, but don't, call this during a post-backend-crash restart</div><div>&nbsp;* cycle. &nbsp;The argument for not doing it is that someone might want to examine</div><div>&nbsp;* the temp files for debugging purposes. &nbsp;This does however mean that</div><div>&nbsp;* OpenTemporaryFile had better allow for collision with an existing temp</div><div>&nbsp;* file name.</div><div>&nbsp;*/</div></div><div>&nbsp; &nbsp; &nbsp; &nbsp; /*</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* In EXEC_BACKEND case there is a pgsql_tmp directory at the top level of</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* DataDir as well.</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</div><div>#ifdef EXEC_BACKEND</div><div>&nbsp; &nbsp; &nbsp; &nbsp; RemovePgTempFilesInDir(PG_TEMP_FILES_DIR);</div><div>#endif</div></div><div><div>/* Process one pgsql_tmp directory for RemovePgTempFiles */</div><div>static void</div><div>RemovePgTempFilesInDir(const char *tmpdirname)</div><div>{</div><div>&nbsp; &nbsp; &nbsp; &nbsp; DIR &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*temp_dir;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; struct dirent *temp_de;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;rm_path[MAXPGPATH];</div><div><br></div><div>&nbsp; &nbsp; &nbsp; &nbsp; temp_dir = AllocateDir(tmpdirname);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; if (temp_dir == NULL)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* anything except ENOENT is fishy */</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (errno != ENOENT)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(LOG,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"could not open temporary-files directory \"%s\": %m",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tmpdirname);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; }</div><div><br></div><div>&nbsp; &nbsp; &nbsp; &nbsp; while ((temp_de = ReadDir(temp_dir, tmpdirname)) != NULL)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (strcmp(temp_de-&gt;d_name, ".") == 0 ||</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; strcmp(temp_de-&gt;d_name, "..") == 0)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; continue;</div><div><br></div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(rm_path, sizeof(rm_path), "%s/%s",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tmpdirname, temp_de-&gt;d_name);</div><div><br></div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (strncmp(temp_de-&gt;d_name,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_TEMP_FILE_PREFIX,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; strlen(PG_TEMP_FILE_PREFIX)) == 0)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unlink(rm_path); &nbsp; &nbsp; &nbsp; &nbsp;/* note we ignore any error */</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(LOG,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"unexpected file found in temporary-files directory: \"%s\"",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;rm_path);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; }</div><div><br></div><div>&nbsp; &nbsp; &nbsp; &nbsp; FreeDir(temp_dir);</div><div>}</div></div><div><br></div></font></div><div>相信在<span style="line-height: 28px; font-size: large;"  >src/backend/storage/file/fd.c中可以找到答案.</span></div><div><br></div><div>另外我们再来验证一下手册上说的work_mem的内容不会复用。</div><div>Session 1 :&nbsp;</div><div><div>postgres@db5-&gt; psql -h 127.0.0.1 digoal digoal</div><div>psql (9.1beta2)</div><div>Type "help" for help.</div><div><br></div><div>digoal=&gt; set work_mem='10240 MB';</div><div>SET</div><div>digoal=&gt; explain analyze verbose select distinct id,comment from user_info order by id,comment desc;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>------------------------------------------------------------------------------------------------------------------------------------</div><div>---------</div><div>&nbsp;Unique &nbsp;(cost=1501672.83..1577885.90 rows=10161743 width=86) (actual time=24547.376..44742.270 rows=10000000 loops=1)</div><div>&nbsp; &nbsp;Output: id, comment</div><div>&nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=1501672.83..1527077.19 rows=10161743 width=86) (actual time=24547.371..31096.446 rows=10000000 loops=1)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id, comment</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: user_info.id, user_info.comment</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Method: quicksort &nbsp;Memory: 1799467kB</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on digoal.user_info &nbsp;(cost=0.00..319016.43 rows=10161743 width=86) (actual time=0.028..8872.090 rows=10000000&nbsp;</div><div>loops=1)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id, comment</div><div>&nbsp;Total runtime: 51242.900 ms</div><div>(9 rows)</div></div><div><br></div><div>Session 2 :&nbsp;</div><div><div>postgres@db5-&gt; psql -h 127.0.0.1 digoal digoal</div><div>psql (9.1beta2)</div><div>Type "help" for help.</div><div><br></div><div>digoal=&gt; set work_mem='10240 MB';</div><div>SET</div><div>digoal=&gt; explain analyze verbose select distinct id,comment from user_info order by id,comment desc;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>------------------------------------------------------------------------------------------------------------------------------------</div><div>---------</div><div>&nbsp;Unique &nbsp;(cost=1501672.83..1577885.90 rows=10161743 width=86) (actual time=24529.584..44689.774 rows=10000000 loops=1)</div><div>&nbsp; &nbsp;Output: id, comment</div><div>&nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=1501672.83..1527077.19 rows=10161743 width=86) (actual time=24529.579..31043.949 rows=10000000 loops=1)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id, comment</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: user_info.id, user_info.comment</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Method: quicksort &nbsp;Memory: 1799467kB</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on digoal.user_info &nbsp;(cost=0.00..319016.43 rows=10161743 width=86) (actual time=0.021..8925.400 rows=10000000&nbsp;</div><div>loops=1)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id, comment</div><div>&nbsp;Total runtime: 51170.098 ms</div><div>(9 rows)</div></div><div># 注意到这里又用到了一种新的Sort Method : &nbsp;quicksort &nbsp;Memory: 1799467kB</div><div>下面来分析一下OS层监控到的内存使用情况,</div><div>1. 执行explain analyze之前</div><div>top - 07:01:00 up 17 days, 15:30, &nbsp;3 users, &nbsp;load average: 0.54, 0.57, 0.25</div><div><div>Tasks: 160 total, &nbsp; 1 running, 159 sleeping, &nbsp; 0 stopped, &nbsp; 0 zombie</div><div>Cpu(s): &nbsp;0.1%us, &nbsp;0.1%sy, &nbsp;0.0%ni, 99.8%id, &nbsp;0.0%wa, &nbsp;0.0%hi, &nbsp;0.0%si, &nbsp;0.0%st</div><div>Mem: &nbsp;16438912k total, &nbsp;9507680k used, &nbsp;<font size="4"  >6931232k free</font>, &nbsp; 163756k buffers</div><div>Swap: 16777208k total, &nbsp; &nbsp;18432k used, 16758776k free, &nbsp;<font size="4"  >8979204k cached</font></div></div><div>&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;<font size="4"  >RES &nbsp;SHR</font> S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div><div>&nbsp;4444 postgres &nbsp;15 &nbsp; 0 2324m <font size="4"  >3672 2060</font> S &nbsp; &nbsp;0 &nbsp;0.0 &nbsp; 0:00.00 postgres: digoal digoal 127.0.0.1(42278) idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp;4446 postgres &nbsp;15 &nbsp; 0 2324m <font size="4"  >3672 2060</font> S &nbsp; &nbsp;0 &nbsp;0.0 &nbsp; 0:00.00 postgres: digoal digoal 127.0.0.1(42279) idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div></div><div>2. 执行explain analyze过程中</div><div><div>top - 07:01:54 up 17 days, 15:31, &nbsp;3 users, &nbsp;load average: 1.20, 0.73, 0.32</div><div>Tasks: 160 total, &nbsp; 3 running, 157 sleeping, &nbsp; 0 stopped, &nbsp; 0 zombie</div><div>Cpu(s): 25.0%us, &nbsp;0.1%sy, &nbsp;0.0%ni, 74.7%id, &nbsp;0.1%wa, &nbsp;0.0%hi, &nbsp;0.0%si, &nbsp;0.0%st</div><div>Mem: &nbsp;16438912k total, 12805700k used, &nbsp;<font size="4"  >3633212k free</font>, &nbsp; 163848k buffers</div><div>Swap: 16777208k total, &nbsp; &nbsp;18432k used, 16758776k free, &nbsp;<font size="4"  >8979204k cached</font></div></div><div><div>&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;<font size="4"  >RES &nbsp;SHR</font> S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>&nbsp;4444 postgres &nbsp;25 &nbsp; 0 4085m <font size="4"  >3.3g 1.7g</font> R &nbsp;100 20.8 &nbsp; 0:41.43 postgres: digoal digoal 127.0.0.1(42278) EXPLAIN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp;4446 postgres &nbsp;25 &nbsp; 0 4085m <font size="4"  >3.3g 1.7g</font> R &nbsp; 99 20.8 &nbsp; 0:42.97 postgres: digoal digoal 127.0.0.1(42279) EXPLAIN &nbsp; &nbsp;&nbsp;</div><div># 可以注意到free有变化,总体使用了约3.2G(=3.3-1.7 + 3.3-1.7)，shr=1.7G(user_info表的OS-FS cache用掉的,所以我们看到cached前后没有变化) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div></div><div>3. 执行完explain analyze之后</div><div><div>top - 07:02:07 up 17 days, 15:31, &nbsp;3 users, &nbsp;load average: 1.22, 0.76, 0.34</div><div>Tasks: 160 total, &nbsp; 1 running, 159 sleeping, &nbsp; 0 stopped, &nbsp; 0 zombie</div><div>Cpu(s): &nbsp;0.1%us, &nbsp;0.0%sy, &nbsp;0.0%ni, 99.6%id, &nbsp;0.2%wa, &nbsp;0.0%hi, &nbsp;0.0%si, &nbsp;0.0%st</div><div>Mem: &nbsp;16438912k total, &nbsp;9518956k used, &nbsp;<font size="4"  >6919956k free</font>, &nbsp; 163868k buffers</div><div>Swap: 16777208k total, &nbsp; &nbsp;18432k used, 16758776k free, &nbsp;<font size="4"  >8979196k cached</font></div></div><div><div>&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;<font size="4"  >RES &nbsp;SHR</font> S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>4444 postgres &nbsp;25 &nbsp; 0 2324m <font size="4"  >1.7g 1.7g</font> S &nbsp; &nbsp;0 10.8 &nbsp; 0:51.15 postgres: digoal digoal 127.0.0.1(42278) idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>4446 postgres &nbsp;25 &nbsp; 0 2324m <font size="4"  >1.7g 1.7g</font> S &nbsp; &nbsp;0 10.8 &nbsp; 0:51.17 postgres: digoal digoal 127.0.0.1(42279) idle&nbsp;</div></div><div>&nbsp; &nbsp; 执行完后，我们看到free回到执行前的水平,并且进程的res和SHR现在是相同的，原因是user_info表仍在OS-FS的cache里面。这部分是共享的开销。使用pg_fincore提供的pgfadv_willnotneed调整USER_INFO表的behavior，就能看到它很快被释放(不推荐这么做，因为PG很需要OS的CACHE)。</div><div>&nbsp; &nbsp; 由此可以解释，sort用到的work_mem不共享或者说不复用。</div><div><br></div><div>接下来我们把work_mem调到1MB,更能清晰的反映这个问题。</div><div>set work_mem='1 MB';</div><div>然后同样执行上面的两个SESSION，执行过程中会在表空间目录的pgsql_tmp &nbsp;&nbsp;/home/pgdata/pg_root/tbs_digoal/PG_9.1_201105231/pgsql_tmp 里面产生两个临时文件pgsql_tmp4444.0和pgsql_tmp4446.0。显然不是共享的。</div><div><br></div><div>总结 :&nbsp;</div><div>1. work_mem配多大不要紧，因为不会一次全部分配掉。manual中的as much as这个让我在之前对work_mem有所误解。</div><div>2. work_mem配大了，确实可能造成内存的过度开销，就像上面看到的一样。</div><div>3. Oracle早前的进程工作内存也是这么来设置的，后来引入了PGA的概念，可以将所有进程的WORK_MEM的总和圈定在一个范围内，而不用限定某一个进程的使用大小。这样的好处是显而易见的。不知道PostgreSQL什么时候会改进这个机制。</div><div><br></div><div><br></div><div>【参考】</div><div><font size="5"  >Oracle :&nbsp;</font></div><div><span style="font-family: Tahoma, sans-serif; line-height: normal;"  ><p style="font-size: small;"  >A&nbsp;<span style="font-weight: bold;"  >temporary tablespace</span>&nbsp;contains transient data that persists only for the duration of the session. Temporary tablespaces can improve the concurrency of multiple sort operations, reduce their overhead, and avoid Oracle Database space management operations. A temporary tablespace can be assigned to users with the&nbsp;<code style="font-family: monospace; font-size: 12px;"  >CREATE USER</code>&nbsp;or&nbsp;<code style="font-family: monospace; font-size: 12px;"  >ALTER USER</code>&nbsp;statement and can be shared by multiple users.</p><p style="font-size: small;"  >Within a temporary tablespace, all sort operations for a given instance and tablespace share a single&nbsp;<span style="font-weight: bold;"  >sort segment</span>. Sort segments exist for every instance that performs sort operations within a given tablespace. The sort segment is created by the first statement that uses a temporary tablespace for sorting, after startup, and is released only at shutdown. An extent cannot be shared by multiple transactions.</p><p style="font-size: small;"  >You can view the allocation and deallocation of space in a temporary tablespace sort segment using the&nbsp;<code style="font-family: monospace; font-size: 12px;"  >V$SORT_SEGMENT</code>&nbsp;view. The&nbsp;<code style="font-family: monospace; font-size: 12px;"  >V$TEMPSEG_USAGE</code>&nbsp;view identifies the current sort users in those segments.</p><p style="font-size: small;"  >You cannot explicitly create objects in a temporary tablespace.</p><p style="font-size: small;"  ><br></p><p><font size="5"  >PostgreSQL :&nbsp;</font></p></span></div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.0/static/runtime-config-resource.html#RUNTIME-CONFIG-RESOURCE-MEMORY"  >http://www.postgresql.org/docs/9.0/static/runtime-config-resource.html#RUNTIME-CONFIG-RESOURCE-MEMORY</a></div><div><br></div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >Temporary files (for operations such as sorting more data than can fit in memory) are created within</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >&nbsp;</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  ><tt>PGDATA</tt></span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  ><tt>/base/pgsql_tmp</tt></span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >, or within a</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >&nbsp;</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  ><tt>pgsql_tmp</tt></span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >&nbsp;</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >subdirectory of a tablespace directory if a tablespace other than</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >&nbsp;</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  ><tt>pg_default</tt></span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >&nbsp;</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >is specified for them. The name of a temporary file has the form</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >&nbsp;</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  ><tt>pgsql_tmp<tt style="font-size: 1em;"  ><i>PPP</i></tt>.<tt style="font-size: 1em;"  ><i>NNN</i></tt></tt></span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >, where</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >&nbsp;</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  ><tt><i>PPP</i></tt></span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >&nbsp;</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >is the PID of the owning backend and</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  ><tt><i>NNN</i></tt></span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >&nbsp;</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >distinguishes different temporary files of that backend.</span></div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  ><br></span></div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  ><a rel="nofollow" href="http://www.postgresql.org/docs/9.0/static/runtime-config-resource.html#RUNTIME-CONFIG-RESOURCE-MEMORY"  >http://www.postgresql.org/docs/9.0/static/runtime-config-resource.html#RUNTIME-CONFIG-RESOURCE-MEMORY</a></span></div><div><dt style="font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"  ><tt>work_mem</tt>&nbsp;(<tt>integer</tt>)</dt><dd style="font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"  ><p style="font-size: 1em; line-height: 1.5em; margin-top: 1.2em; margin-right: 0em; margin-bottom: 1.2em; margin-left: 0em;"  >Specifies the amount of memory to be used by internal sort operations and hash tables before writing to temporary disk files. The value defaults to one megabyte (<tt>1MB</tt>). Note that for a complex query, several sort or hash operations might be running in parallel; each operation will be allowed to use as much memory as this value specifies before it starts to write data into temporary files. Also, several running sessions could be doing such operations concurrently. Therefore, the total memory used could be many times the value of&nbsp;<tt>work_mem</tt>; it is necessary to keep this fact in mind when choosing the value. Sort operations are used for&nbsp;<tt>ORDER BY</tt>,&nbsp;<tt>DISTINCT</tt>, and merge joins. Hash tables are used in hash joins, hash-based aggregation, and hash-based processing of&nbsp;<tt>IN</tt>&nbsp;subqueries.</p><p style="font-size: 1em; line-height: 1.5em; margin-top: 1.2em; margin-right: 0em; margin-bottom: 1.2em; margin-left: 0em;"  ><br></p></dd></div></div>
	</div>
</div>
</body>
</html>