<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">some timestamp parse in gram.y (' ' AT TIME ZONE ' ')</h2>
	<h5 id="">2015-04-30 16:52:53&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402015330421288/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">去哪儿的AVEN兄弟提到的一个问题：<div>为什么当前时区是+8的情况，结果感觉上有点不对劲？<br><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 28px;"   ><font size="2"   >postgres=# show timezone;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;TimeZone&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >----------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;PRC</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div></div><div><font size="2"   >postgres=# select extract(epoch from 'today'::timestamptz);</font></div><div><font size="2"   >&nbsp;date_part &nbsp;</font></div><div><font size="2"   >------------</font></div><div><font size="2"   >&nbsp;1430323200</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select extract(epoch from 'today' at time zone '0');</font></div><div><font size="2"   >&nbsp;date_part &nbsp;</font></div><div><font size="2"   >------------</font></div><div><font size="2"   >&nbsp;1430323200</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select extract(epoch from 'today' at time zone '8');</font></div><div><font size="2"   >&nbsp;date_part &nbsp;</font></div><div><font size="2"   >------------</font></div><div><font size="2"   >&nbsp;1430294400</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div></div><div>我们首先要看一下这个语法是怎么解析的。</div><div><div>src/backend/parser/gram.y</div><div>EXTRACT的写法会解析为调用函数<span style="line-height: 28px;"   >date_part</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span>			</span>| EXTRACT '(' extract_list ')'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $$ = (Node *) makeFuncCall(SystemFuncName("date_part"), $3, @1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >extract_list:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; extract_arg FROM a_expr</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $$ = list_make2(makeStringConst($1, @1), $3);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | /*EMPTY*/ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; { $$ = NIL; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;</font></div><p></p></pre></div><div>而 AT TIME ZONE的写法实际调用了函数timezone</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | a_expr AT TIME ZONE a_expr &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;%prec AT</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $$ = (Node *) makeFuncCall(SystemFuncName("timezone"),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;list_make2($5, $1),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;@2);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div></div><div>这两个函数如下：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >postgres=# \df+ date_part<br>                                                                                                                       List of funct<br>ions<br>   Schema   |   Name    | Result data type |        Argument data types        |  Type  | Security | Volatility |  Owner   | Languag<br>e |                               Source code                                |                 Description                 <br>------------+-----------+------------------+-----------------------------------+--------+----------+------------+----------+--------<br>--+--------------------------------------------------------------------------+---------------------------------------------<br> pg_catalog | date_part | double precision | text, abstime                     | normal | invoker  | stable     | postgres | sql    <br>  | select pg_catalog.date_part($1, cast($2 as timestamp with time zone))    | extract field from abstime<br> pg_catalog | date_part | double precision | text, date                        | normal | invoker  | immutable  | postgres | sql    <br>  | select pg_catalog.date_part($1, cast($2 as timestamp without time zone)) | extract field from date<br> pg_catalog | date_part | double precision | text, interval                    | normal | invoker  | immutable  | postgres | interna<br>l | interval_part                                                            | extract field from interval<br> pg_catalog | date_part | double precision | text, reltime                     | normal | invoker  | stable     | postgres | sql    <br>  | select pg_catalog.date_part($1, cast($2 as pg_catalog.interval))         | extract field from reltime<br> pg_catalog | date_part | double precision | text, time with time zone         | normal | invoker  | immutable  | postgres | interna<br>l | timetz_part                                                              | extract field from time with time zone<br> pg_catalog | date_part | double precision | text, time without time zone      | normal | invoker  | immutable  | postgres | interna<br>l | time_part                                                                | extract field from time<br> pg_catalog | date_part | double precision | text, timestamp with time zone    | normal | invoker  | stable     | postgres | interna<br>l | timestamptz_part                                                         | extract field from timestamp with time zone<br> pg_catalog | date_part | double precision | text, timestamp without time zone | normal | invoker  | immutable  | postgres | interna<br>l | timestamp_part                                                           | extract field from timestamp<br>(8 rows)</span></font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span style="line-height: 21px;"   >postgres=# \df+ timezone<br>                                                                                                List of functions<br>   Schema   |   Name   |      Result data type       |          Argument data types          |  Type  | Security | Volatility |  Own<br>er   | Language |    Source code    |              Description               <br>------------+----------+-----------------------------+---------------------------------------+--------+----------+------------+-----<br>-----+----------+-------------------+----------------------------------------<br> pg_catalog | timezone | time with time zone         | interval, time with time zone         | normal | invoker  | immutable  | post<br>gres | internal | timetz_izone      | adjust time with time zone to new zone<br> pg_catalog | timezone | timestamp without time zone | interval, timestamp with time zone    | normal | invoker  | immutable  | post<br>gres | internal | timestamptz_izone | adjust timestamp to new time zone<br> pg_catalog | timezone | timestamp with time zone    | interval, timestamp without time zone | normal | invoker  | immutable  | post<br>gres | internal | timestamp_izone   | adjust timestamp to new time zone<br> pg_catalog | timezone | time with time zone         | text, time with time zone             | normal | invoker  | volatile   | post<br>gres | internal | timetz_zone       | adjust time with time zone to new zone<br> pg_catalog | timezone | timestamp without time zone | text, timestamp with time zone        | normal | invoker  | immutable  | post<br>gres | internal | timestamptz_zone  | adjust timestamp to new time zone<br> pg_catalog | timezone | timestamp with time zone    | text, timestamp without time zone     | normal | invoker  | immutable  | post<br>gres | internal | timestamp_zone    | adjust timestamp to new time zone<br>(6 rows)</span></font></div><p></p></pre></div><div>我们接下来分解一下以上查询：</div><div><pre class="prettyprint"   ><div><font size="2"   >postgres=# select&nbsp;</font></div><div><font size="2"   >extract(epoch from 'today'::timestamptz),&nbsp;</font></div><div><font size="2"   >date_part('epoch', 'today'::timestamptz),</font></div><div><font size="2"   >'today'::timestamptz;</font></div><div><div><font size="2"   >&nbsp;date_part &nbsp;| date_part &nbsp;| &nbsp; &nbsp; &nbsp;timestamptz &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------+------------+------------------------</font></div><div><font size="2"   >&nbsp;1430323200 | 1430323200 | 2015-04-30 00:00:00+08</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select pg_typeof('today'::timestamptz);<br>        pg_typeof         <br>--------------------------<br> timestamp with time zone<br>(1 row)</font></div><p></p></pre></div><div>这个查询用到了timestamptz_part</div><div><br></div><div>对于AT TIME ZONE的写法，因为对应的timezone函数可能输出带时区，或不带时区的值，所以我们需要区分一下，</div><div>但是对于date_part来说，结果是一样的，因为date_part也支持带时区和不带时区的参数。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >postgres=# select <br>extract(epoch from 'today' at time zone '0'), <br>date_part('epoch', timezone('0', 'today'::timestamptz)), <br>timezone('0', 'today'::timestamptz),</span></font></div><div><font size="2"   ><span style="line-height: 21px;"   >timezone('0', 'today');<br> date_part  | date_part  |      timezone       |      timezone       <br>------------+------------+---------------------+---------------------<br> 1430323200 | 1430323200 | 2015-04-29 16:00:00 | 2015-04-29 16:00:00<br>(1 row)</span></font></div><div><font size="2"   ><span style="line-height: 21px;"   ><br></span></font></div><div><font size="2"   >postgres=# select pg_typeof(timezone('0', 'today'));<br>          pg_typeof          <br>-----------------------------<br> timestamp without time zone<br>(1 row)</font></div><p></p></pre></div><div>这个查询用到了timestamp_part，timestamptz_zone</div><div>结果一致的原因非常明显，因为我们用到的时间：<span style="line-height: 28px;"   >2015-04-30 00:00:00+08 等于&nbsp;</span><span style="line-height: 28px;"   >2015-04-29 16:00:00。</span></div><div>调用的函数分别为：</div><div><span style="line-height: 28px;"   >timestamptz_part(</span>text, timestamp with time zone<span style="line-height: 28px;"   >)</span></div><div><span style="line-height: 28px;"   >timestamp_part(</span>text, timestamp without time zone<span style="line-height: 28px;"   >)</span></div><div>现在可以解释为什么<span style="line-height: 28px;"   >extract(epoch from 'today' at time zone '8')的结果有点问题了。</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select&nbsp;</font></div><div><font size="2"   >date_part('epoch', timezone('8', 'today')),&nbsp;</font></div><div><font size="2"   >timezone('8', 'today');</font></div><div><font size="2"   >&nbsp;date_part &nbsp;| &nbsp; &nbsp; &nbsp;timezone &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------+---------------------</font></div><div><font size="2"   >&nbsp;1430294400 | 2015-04-29 08:00:00</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1. timestamptz_part，<span style="line-height: 28px;"   >timestamp_part，timestamptz_zone</span></div><div>src/backend/utils/adt/timestamp.c</div><div><span style="line-height: 28px;"   >2. src/backend/parser/gram.y</span></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="some timestamp parse in gram.y (  AT TIME ZONE  ) - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>