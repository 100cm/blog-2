<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.5 new feature - can define row security policy for table</h2>
	<h5 id="">2015-04-09 10:32:33&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020153984016177/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.5 新增了一个非常给力的安全相关特性, 精细化控制用户对数据的可视性, 可写性.</div><div>这种方法有利于隔离控制共享表在多个用户之间的数据呈现和使用.</div><div><br></div><div>实现方法,&nbsp;</div><div>创建针对表和角色的策略, 不同的角色对表记录的查询, 插入, 更新, 删除 可以有不同的控制方法.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE POLICY name ON table_name</font></div><div><font size="2"   >&nbsp; &nbsp; [ FOR { ALL | SELECT | INSERT | UPDATE | DELETE } ]</font></div><div><font size="2"   >&nbsp; &nbsp; [ TO { role_name | PUBLIC } [, ...] ]</font></div><div><font size="2"   >&nbsp; &nbsp; [ USING ( using_expression ) ]</font></div><div><font size="2"   >&nbsp; &nbsp; [ WITH CHECK ( check_expression ) ]</font></div><p></p></pre></div><div>using 针对已经存在的记录的校验. 可实施在select, update, delete, ALL上.</div><div>whth check 针对将要新增的记录的校验, 可实施在insert, update, ALL上.</div><div>需要注意的是, UPDATE因为涉及旧的记录和新的记录, 如果只写了using , 但是没有提供with check的话, using同时会当成with check来使用进行检查.</div><div>如果针对同样的命令创建了多个策略, 所有策略中任意一个为TRUE都通过.&nbsp;</div><div>例如ALL, SELECT个创建了一个策略for role r1, 执行select时<span style="line-height: 28px;"   >任意一个为TRUE都通过.&nbsp;</span></div><div><span style="line-height: 28px;"   >例如SELECT个创建了多个策略for role r1, 执行select时</span><span style="line-height: 28px;"   >任意一个为TRUE都通过.&nbsp;</span></div><div><br></div><div>测试 :　</div><div>去git下载一个开发版本</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=summary</font></div><div><font size="2"   >[root@db-172-16-3-150 soft_bak]# tar -zxvf postgresql-7320681.tar.gz</font></div><div><font size="2"   ><span style="line-height: 28px;"   >[root@db-172-16-3-150 soft_bak]</span># cd&nbsp;<span style="line-height: 28px;"   >postgresql-7320681</span></font></div><div><font size="2"   >[root@db-172-16-3-150 postgresql-7320681]# ./configure --prefix=/opt/pgsql9.5 --with-pgport=1922 --with-perl --with-python --with-tcl --with-openssl --with-pam --with-ldap --with-libxml --with-libxslt --enable-thread-safety --with-blocksize=32 --enable-debug</font></div><div><font size="2"   >[root@db-172-16-3-150 postgresql-7320681]# gmake world &amp;&amp; gmake install-world</font></div><div><font size="2"   ><br></font></div><div><span style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 postgresql-7320681]# useradd pg95</font></span></div><div><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 ~]# su - pg95</font></div><div style="line-height: 28px;"   ><font size="2"   >[pg95@db-172-16-3-150 ~]$ vi .bash_profile&nbsp;</font></div></div><div><div><font size="2"   ># add by digoal</font></div><div><font size="2"   >export PS1="$USER@`/bin/hostname -s`-&gt; "</font></div><div><font size="2"   >export PGPORT=1922</font></div><div><font size="2"   >export PGDATA=/data02/pgdata95/pg_root</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/opt/pgsql9.5</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"   >export PGHOST=$PGDATA</font></div><div><font size="2"   >export PGDATABASE=postgres</font></div><div><font size="2"   >alias rm='rm -i'</font></div><div><font size="2"   >alias ll='ls -lh'</font></div><div><font size="2"   >unalias vi</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-150 ~]# mkdir /data02/pgdata95</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# chown pg95:pg95 /data02/pgdata95</font></div></div><div><font size="2"   ><br></font></div><div><span style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 ~]# su - pg95</font></span></div><div><font size="2"   >pg95@db-172-16-3-150-&gt; initdb -D $PGDATA -E UTF8 --locale=C -U postgres -W</font></div><p></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >创建三个角色</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create role r1 login;</font></div><div><font size="2"   >CREATE ROLE</font></div><div><font size="2"   >postgres=# create role r2 login;</font></div><div><font size="2"   >CREATE ROLE</font></div><div><font size="2"   >postgres=# create role r3 login;</font></div><div><font size="2"   >CREATE ROLE</font></div><p></p></pre></div><div>创建测试表</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# create table test(id int, r name);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# insert into test values(1, 'r1');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=# insert into test values(2, 'r2');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=# insert into test values(3, 'r3');</font></div><div><font size="2"   >INSERT 0 1</font></div></div><div><div><font size="2"   >postgres=# grant all on table test to public;</font></div><div><font size="2"   >GRANT</font></div></div><p></p></pre></div></div><div>创建一个新增数据的策略(使用with check)</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >postgres=# create policy p on test for insert to r1 with check( r = current_user);</font></div><div style="line-height: 28px;"   ><font size="2"   >CREATE POLICY</font></div><p></p></pre></div></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >默认情况下策略是disable状态的,&nbsp;</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \d+ test</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Table "public.test"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers | Storage | Stats target | Description&nbsp;</font></div><div><font size="2"   >--------+---------+-----------+---------+--------------+-------------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; | integer | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;r &nbsp; &nbsp; &nbsp;| name &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >Policies (Row Security Disabled):</font></div><div><font size="2"   >&nbsp; &nbsp; POLICY "p" FOR INSERT</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; TO r1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; WITH CHECK (r = "current_user"())</font></div><p></p></pre></div><div>通过pg_policies视图可以查看已经创建的策略.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from pg_policies ;</font></div><div><font size="2"   >&nbsp;schemaname | tablename | policyname | roles | &nbsp;cmd &nbsp; | qual | &nbsp; &nbsp; &nbsp; with_check &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------+-----------+------------+-------+--------+------+------------------------</font></div><div><font size="2"   >&nbsp;public &nbsp; &nbsp; | test &nbsp; &nbsp; &nbsp;| p &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {r1} &nbsp;| INSERT | &nbsp; &nbsp; &nbsp;| (r = "current_user"())</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>在策略enable前, 是无视策略的.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; insert into test values(4,'r1');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=&gt; insert into test values(4,'r2');</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div>使策略生效</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# alter table test enable row level security;</font></div><div><font size="2"   >ALTER TABLE</font></div></div><div><div><font size="2"   >postgres=&gt; \d+ test</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Table "public.test"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers | Storage | Stats target | Description&nbsp;</font></div><div><font size="2"   >--------+---------+-----------+---------+--------------+-------------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; | integer | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;r &nbsp; &nbsp; &nbsp;| name &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >Policies:</font></div><div><font size="2"   >&nbsp; &nbsp; POLICY "p" FOR INSERT</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; TO r1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; WITH CHECK (r = "current_user"())</font></div></div><p></p></pre></div></div><div>现在策略生效了, 再次插入, 你会看到只能插入和r1角色同名的r值.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \c postgres r1</font></div><div><font size="2"   >You are now connected to database "postgres" as user "r1".</font></div><div><font size="2"   >postgres=&gt; insert into test values(4,'r2');</font></div><div><font size="2"   >ERROR: &nbsp;new row violates WITH CHECK OPTION for "test"</font></div><div><font size="2"   >postgres=&gt; insert into test values(4,'r1');</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div>再新增一个策略, 现在r1角色插入test表时, 允许r字段的值为'r1','r2'.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# create policy p1 on test for insert to r1 with check( r = 'r2');</font></div><div><font size="2"   >CREATE POLICY</font></div></div><div><div><font size="2"   >postgres=# \c postgres r1</font></div><div><font size="2"   >You are now connected to database "postgres" as user "r1".</font></div><div><font size="2"   >postgres=&gt; insert into test values(4,'r2');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=&gt; insert into test values(4,'r1');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=&gt; insert into test values(4,'r3');</font></div><div><font size="2"   >ERROR: &nbsp;new row violates WITH CHECK OPTION for "test"</font></div></div><p></p></pre></div><div><br></div><div>接下来创建旧值的策略. r1用户只能查看到r=current_user的值.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; \c postgres postgres</font></div><div><font size="2"   >You are now connected to database "postgres" as user "postgres".\</font></div><div><font size="2"   >postgres=# create policy p2 on test for select to r1 using ( r = current_user);</font></div><div><font size="2"   >CREATE POLICY</font></div><div><font size="2"   >postgres=# \c postgres r1</font></div><div><font size="2"   >You are now connected to database "postgres" as user "r1".</font></div><div><font size="2"   >postgres=&gt; select * from test;</font></div><div><font size="2"   >&nbsp;id | r &nbsp;</font></div><div><font size="2"   >----+----</font></div><div><font size="2"   >&nbsp; 1 | r1</font></div><div><font size="2"   >&nbsp; 4 | r1</font></div><div><font size="2"   >&nbsp; 4 | r1</font></div><div><font size="2"   >&nbsp; 4 | r1</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div><div>当然, 我们也可以创建一个针对所有用户的策略, 例如, 所有用户只能看到<span style="line-height: 28px;"   >&nbsp;</span><span style="line-height: 28px;"   >r = current_user 的值.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; \c postgres postgres</font></div><div><font size="2"   >You are now connected to database "postgres" as user "postgres".</font></div><div><font size="2"   >postgres=# create policy p3 on test for select to public using ( r = current_user);</font></div><div><font size="2"   >CREATE POLICY</font></div><div><font size="2"   >postgres=# \c postgres r2</font></div><div><font size="2"   >You are now connected to database "postgres" as user "r2".</font></div><div><font size="2"   >postgres=&gt; select * from test;</font></div><div><font size="2"   >&nbsp;id | r &nbsp;</font></div><div><font size="2"   >----+----</font></div><div><font size="2"   >&nbsp; 2 | r2</font></div><div><font size="2"   >&nbsp; 4 | r2</font></div><div><font size="2"   >&nbsp; 4 | r2</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div><div><br></div><div>当然了, 所有这些策略只针对非超级用户以及非owner</div><div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; \c postgres postgres</font></div><div><font size="2"   >You are now connected to database "postgres" as user "postgres".</font></div><div><font size="2"   >postgres=# select * from test;</font></div><div><font size="2"   >&nbsp;id | r &nbsp;</font></div><div><font size="2"   >----+----</font></div><div><font size="2"   >&nbsp; 1 | r1</font></div><div><font size="2"   >&nbsp; 2 | r2</font></div><div><font size="2"   >&nbsp; 3 | r3</font></div><div><font size="2"   >&nbsp; 4 | r1</font></div><div><font size="2"   >&nbsp; 4 | r2</font></div><div><font size="2"   >&nbsp; 4 | r1</font></div><div><font size="2"   >&nbsp; 4 | r2</font></div><div><font size="2"   >&nbsp; 4 | r1</font></div><div><font size="2"   >(8 rows)</font></div><p></p></pre></div></div><div>把r1改为超级用户, 策略失效.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# alter role r1 superuser;</font></div><div><font size="2"   >ALTER ROLE</font></div><div><font size="2"   >postgres=# \c postgres r1</font></div><div><font size="2"   >You are now connected to database "postgres" as user "r1".</font></div><div><font size="2"   >postgres=# select * from test;</font></div><div><font size="2"   >&nbsp;id | r &nbsp;</font></div><div><font size="2"   >----+----</font></div><div><font size="2"   >&nbsp; 1 | r1</font></div><div><font size="2"   >&nbsp; 2 | r2</font></div><div><font size="2"   >&nbsp; 3 | r3</font></div><div><font size="2"   >&nbsp; 4 | r1</font></div><div><font size="2"   >&nbsp; 4 | r2</font></div><div><font size="2"   >&nbsp; 4 | r1</font></div><div><font size="2"   >&nbsp; 4 | r2</font></div><div><font size="2"   >&nbsp; 4 | r1</font></div><div><font size="2"   >(8 rows)</font></div><p></p></pre></div><div><br></div><div>对于update操作, 因为先需要查看数据, 然后才是插入数据, 所以先会执行using检查, 然后执行with check检查. 如果只有using, 那么with check还是需要检查的, 只不过会使用using策略.</div><div>如果只有with check则在查询数据时不检查, 但是插入时检查.</div><div><br></div><div>另外需要说明一旦对用户创建了策略, 必须在所有命令上创建, 否则默认采用拒绝方式.</div><div>src/backend/rewrite/rowsecurity.c</div><div><div>if row-level security is enabled on the table and there</div><div>is no policy which applies, then a default-deny policy will be used.</div></div><div><br></div><div>例如, 现在有1个update的策略.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# \d test</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;Table "public.test"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >--------+---------+-----------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; | integer |&nbsp;</font></div><div><font size="2"   >&nbsp;r &nbsp; &nbsp; &nbsp;| name &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >Policies:</font></div><div><font size="2"   >&nbsp; &nbsp; POLICY "p4" FOR UPDATE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; TO r3</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; USING (r = "current_user"())</font></div></div><div><div><font size="2"   >postgres=# \c postgres r3</font></div><div><font size="2"   >You are now connected to database "postgres" as user "r3".</font></div></div><p></p></pre></div><div><div>因为针对r3角色创建了update策略, 但是没有创建其他命令的策略, 所以其他命令的策略默认为FALSE?</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; select * from test;</font></div><div><font size="2"   >&nbsp;id | r&nbsp;</font></div><div><font size="2"   >----+---</font></div><div><font size="2"   >(0 rows)</font></div><p></p></pre></div></div><div>更新操作应用了策略.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; update test set id=4 where r='r3';</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=&gt; select * from test;</font></div><div><font size="2"   >&nbsp;id | r&nbsp;</font></div><div><font size="2"   >----+---</font></div><div><font size="2"   >(0 rows)</font></div><p></p></pre></div><div>现在创建SELECT的策略, 可以查询了</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# create policy p1 on test for select to r3 using ( r = current_user);</font></div><div><font size="2"   >CREATE POLICY</font></div><div><font size="2"   >postgres=# \d+ test</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Table "public.test"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers | Storage | Stats target | Description&nbsp;</font></div><div><font size="2"   >--------+---------+-----------+---------+--------------+-------------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; | integer | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;r &nbsp; &nbsp; &nbsp;| name &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >Policies:</font></div><div><font size="2"   >&nbsp; &nbsp; POLICY "p1" FOR SELECT</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; TO r3</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; USING (r = "current_user"())</font></div><div><font size="2"   >&nbsp; &nbsp; POLICY "p4" FOR UPDATE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; TO r3</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; USING (r = "current_user"())</font></div></div><div><div><font size="2"   >postgres=# \c postgres r3</font></div><div><font size="2"   >You are now connected to database "postgres" as user "r3".</font></div><div><font size="2"   >postgres=&gt; select * from test;</font></div><div><font size="2"   >&nbsp;id | r &nbsp;</font></div><div><font size="2"   >----+----</font></div><div><font size="2"   >&nbsp; 4 | r3</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><div>但是delete命令上还没有创建策略, 所以删除操作直接FALSE.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; delete from test ;</font></div><div><font size="2"   >DELETE 0</font></div><p></p></pre></div></div><div>在r1角色上, 没有创建任何策略, 所以操作是允许的.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; \c postgres r1</font></div><div><font size="2"   >You are now connected to database "postgres" as user "r1".</font></div><div><font size="2"   >postgres=# select * from test;</font></div><div><font size="2"   >&nbsp;id | r &nbsp;</font></div><div><font size="2"   >----+----</font></div><div><font size="2"   >&nbsp; 1 | r1</font></div><div><font size="2"   >&nbsp; 2 | r2</font></div><div><font size="2"   >&nbsp; 4 | r1</font></div><div><font size="2"   >&nbsp; 4 | r2</font></div><div><font size="2"   >&nbsp; 4 | r1</font></div><div><font size="2"   >&nbsp; 4 | r2</font></div><div><font size="2"   >&nbsp; 4 | r1</font></div><div><font size="2"   >&nbsp; 4 | r3</font></div><div><font size="2"   >(8 rows)</font></div><p></p></pre></div><div><br></div><div>在使用pg_dump导出或者使用pg_restore导入时. 如果表enable了row security策略.</div><div>普通用户在执行pg_dump或pg_restore时会报错.</div><div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg95@db-172-16-3-150-&gt; pg_dump -U r2 -t test postgres</font></div><div><font size="2"   >.....</font></div><div><font size="2"   >COPY test (id, r) FROM stdin;</font></div><div><font size="2"   >pg_dump: [archiver (db)] query failed: ERROR: &nbsp;insufficient privilege to bypass row security.</font></div><div><font size="2"   >pg_dump: [archiver (db)] query was: COPY public.test (id, r) TO stdout;</font></div><p></p></pre></div></div><div><br></div><div>最后要讲一下使用策略的过滤顺序, 还记得视图攻击吗?</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201431410032638"   >http://blog.163.com/digoal@126/blog/static/163877040201431410032638</a></div><div>同样, leakproof 函数也在策略过滤器前调用.</div><div>例子 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >普通函数</font></div><div><font size="2"   >postgres=&gt; \c postgres postgres</font></div><div><font size="2"   >You are now connected to database "postgres" as user "postgres".</font></div><div><font size="2"   >postgres=# create or replace function attack(int,name) returns boolean as $$</font></div><div><font size="2"   >postgres$# declare</font></div><div><font size="2"   >postgres$# begin</font></div><div><font size="2"   >postgres$# &nbsp; raise notice '%,%', $1,$2;</font></div><div><font size="2"   >postgres$# &nbsp; return true;</font></div><div><font size="2"   >postgres$# end;</font></div><div><font size="2"   >postgres$# $$ language plpgsql cost 0.00000000000000000000001 ;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >postgres=# \c postgres r3</font></div><div><font size="2"   >You are now connected to database "postgres" as user "r3".</font></div><div><font size="2"   >postgres=&gt; select * from test where attack(id,r);</font></div><div><font size="2"   >NOTICE: &nbsp;4,r3</font></div><div><font size="2"   >&nbsp;id | r &nbsp;</font></div><div><font size="2"   >----+----</font></div><div><font size="2"   >&nbsp; 4 | r3</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >普通函数在语句中的过滤是在策略过滤器后面执行</font></div><div><font size="2"   >postgres=&gt; explain select * from test where attack(id,r);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Subquery Scan on test &nbsp;(cost=0.00..61.32 rows=6 width=68)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: attack(test.id, test.r)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on test test_1 &nbsp;(cost=0.00..61.15 rows=17 width=68)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (r = "current_user"())</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   >如果修改为leakproof函数的话</font></div><div><font size="2"   >postgres=&gt; \c postgres postgres</font></div><div><font size="2"   >You are now connected to database "postgres" as user "postgres".</font></div><div><font size="2"   >postgres=# alter function attack(int,name) LEAKPROOF;</font></div><div><font size="2"   >ALTER FUNCTION</font></div><div><font size="2"   >就直接上升到和过滤器一起执行了</font></div><div><font size="2"   >postgres=# \c postgres r3</font></div><div><font size="2"   >postgres=&gt; explain select * from test where attack(id,r);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on test &nbsp;(cost=0.00..61.15 rows=6 width=68)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (attack(id, r) AND (r = "current_user"()))</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   >可以从函数中读取出所有数据</font></div><div><font size="2"   >postgres=&gt; select * from test where attack(id,r);</font></div><div><font size="2"   >NOTICE: &nbsp;1,r1</font></div><div><font size="2"   >NOTICE: &nbsp;2,r2</font></div><div><font size="2"   >NOTICE: &nbsp;4,r1</font></div><div><font size="2"   >NOTICE: &nbsp;4,r2</font></div><div><font size="2"   >NOTICE: &nbsp;4,r1</font></div><div><font size="2"   >NOTICE: &nbsp;4,r2</font></div><div><font size="2"   >NOTICE: &nbsp;4,r1</font></div><div><font size="2"   >NOTICE: &nbsp;4,r3</font></div><div><font size="2"   >&nbsp;id | r &nbsp;</font></div><div><font size="2"   >----+----</font></div><div><font size="2"   >&nbsp; 4 | r3</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-createpolicy.html"   >http://www.postgresql.org/docs/devel/static/sql-createpolicy.html</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/runtime-config-client.html#RUNTIME-CONFIG-CLIENT-STATEMENT"   >http://www.postgresql.org/docs/devel/static/runtime-config-client.html#RUNTIME-CONFIG-CLIENT-STATEMENT</a></div><div><dt style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: normal;"   ><tt>row_security</tt>&nbsp;(<tt>enum</tt>)</dt><dd style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: normal;"   ><p style="font-size: 1em; line-height: 1.5em; margin: 1.2em 0em;"   >This variable controls if row security policies are to be applied to queries which are run against tables that have row security enabled. The default is 'on'. When set to 'on', all users, except superusers and the owner of the table, will have the row policies for the table applied to their queries. The table owner and superuser can request that row policies be applied to their queries by setting this to 'force'. Lastly, this can also be set to 'off' which will bypass row policies for the table, if possible, and error if not.</p><p style="font-size: 1em; line-height: 1.5em; margin: 1.2em 0em;"   >For a user who is not a superuser and not the table owner to bypass row policies for the table, they must have the BYPASSRLS role attribute. If this is set to 'off' and the user queries a table which has row policies enabled and the user does not have the right to bypass row policies then a permission denied error will be returned.</p><p style="font-size: 1em; line-height: 1.5em; margin: 1.2em 0em;"   >The allowed values of&nbsp;<tt>row_security</tt>&nbsp;are&nbsp;<tt>on</tt>&nbsp;(apply normally - not to superuser or table owner),&nbsp;<tt>off</tt>&nbsp;(fail if row security would be applied), and&nbsp;<tt>force</tt>&nbsp;(apply always - even to superuser and table owner).</p><p style="font-size: 1em; line-height: 1.5em; margin: 1.2em 0em;"   >For more information on row security policies, see&nbsp;<a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-createpolicy.html"   >CREATE POLICY</a>.</p></dd></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL 9.5 new feature - can define security policy for table - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>