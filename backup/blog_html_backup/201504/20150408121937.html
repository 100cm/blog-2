<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use systemtap analyze pgpool-II performance, which functions use the most time</h2>
	<h5 id="">2015-04-08 12:19:37&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402015380712956/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div style="line-height: 28px;"   >为了找到pgpool-II慢在什么地方, 这里用到stap进行跟踪.</div><div style="line-height: 28px;"   >pgpool-II默认开启了debug, 所以直接编译即可, 不需要修改Makefile</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 pgpool-II-3.4.1]# less Makefile</font></div><div style="line-height: 28px;"   ><font size="2"   >默认开启了debug, 如下</font></div><div style="line-height: 28px;"   ><font size="2"   >CFLAGS = -g -O2 -Wall -Wmissing-prototypes -Wmissing-declarations</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   ># man gcc</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Options for Debugging Your Program or GCC</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;GCC has various special options that are used for debugging either your program or GCC:</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;-g &nbsp;Produce debugging information in the operating system’s native format (stabs, COFF, XCOFF, or DWARF 2).</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;GDB can work with this debugging information.</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;On most systems that use stabs format, -g enables use of extra debugging information that only GDB can use;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;this extra information makes debugging work better in GDB but will probably make other debuggers crash or</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;refuse to read the program. &nbsp;If you want to control for certain whether to generate the extra information,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;use -gstabs+, -gstabs, -gxcoff+, -gxcoff, or -gvms (see below).</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;GCC allows you to use -g with -O. &nbsp;The shortcuts taken by optimized code may occasionally produce</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;surprising results: some variables you declared may not exist at all; flow of control may briefly move</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;where you did not expect it; some statements may not be executed because they compute constant results or</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;their values were already at hand; some statements may execute in different places because they were moved</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;out of loops.</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Nevertheless it proves possible to debug optimized output. &nbsp;This makes it reasonable to use the optimizer</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for programs that might have bugs.</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;The following options are useful when GCC is generated with the capability for more than one debugging</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;format.</font></div><p></p></pre></div><div style="line-height: 28px;"   >测试用到3台服务器,&nbsp;</div></div><div style="line-height: 28px;"   >1. db</div><div style="line-height: 28px;"   >8核 Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5405 &nbsp;@ 2.00GHz</div><div style="line-height: 28px;"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm syscall lm constant_tsc pni monitor ds_cpl vmx tm2 cx16 xtpr lahf_lm</div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >2. pgbench</div><div style="line-height: 28px;"   >8核 Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5405 &nbsp;@ 2.00GHz</div><div style="line-height: 28px;"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm syscall lm constant_tsc pni monitor ds_cpl vmx tm2 cx16 xtpr lahf_lm</div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >3. pgpool</div><div style="line-height: 28px;"   >8核 Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</div><div style="line-height: 28px;"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx rdtscp lm constant_tsc arch_perfmon pebs bts rep_good xtopology nonstop_tsc aperfmperf pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 sse4_2 popcnt lahf_lm dts tpr_shadow vnmi flexpriority ept vpid</div></div><div><br></div><div>安装pgpool-II</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 src]# cd /opt/soft_bak/</font></div><div><font size="2"   >[root@db-172-16-3-150 soft_bak]# wget http://www.pgpool.net/download.php?f=pgpool-II-3.4.1.tar.gz</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-150 soft_bak]# tar -zxvf pgpool-II-3.4.1.tar.gz</font></div><div><font size="2"   >[root@db-172-16-3-150 soft_bak]# cd pgpool-II-3.4.1</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-150 pgpool-II-3.4.1]# ./configure --prefix=/opt/pgpool3.4.1 --with-pgsql=/opt/pgsql</font></div><div><font size="2"   >[root@db-172-16-3-150 pgpool-II-3.4.1]# gmake &amp;&amp; gmake install</font></div><div><font size="2"   >[root@db-172-16-3-150 pgpool-II-3.4.1]# vi /etc/ld.so.conf</font></div><div><font size="2"   >/opt/pgpool3.4.1/lib</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-150 pgpool-II-3.4.1]# ldconfig</font></div><div><font size="2"   >[root@db-172-16-3-150 pgpool-II-3.4.1]# ldconfig -p|grep pgpool</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; libpcp.so.0 (libc6,x86-64) =&gt; /opt/pgpool3.4.1/lib/libpcp.so.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; libpcp.so (libc6,x86-64) =&gt; /opt/pgpool3.4.1/lib/libpcp.so</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-150 pgpool-II-3.4.1]# vi /etc/profile</font></div><div><font size="2"   >export PATH=/opt/pgpool3.4.1/bin:$PATH</font></div><p></p></pre></div><div><br></div><div>配置文件样本如下&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 pgpool-II-3.4.1]# cd src/sample/</font></div><div><font size="2"   >[root@db-172-16-3-150 sample]# ll</font></div><div><font size="2"   >total 176K</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres 2.0K Feb &nbsp;5 18:28 dist_def_pgbench.sql</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres &nbsp;858 Feb &nbsp;5 18:28 pcp.conf.sample</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres &nbsp;33K Feb &nbsp;5 18:33 pgpool.conf.sample</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres &nbsp;33K Feb &nbsp;5 18:33 pgpool.conf.sample-master-slave</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres &nbsp;33K Feb &nbsp;5 18:33 pgpool.conf.sample-replication</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres &nbsp;33K Feb &nbsp;5 18:33 pgpool.conf.sample-stream</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres &nbsp; 71 Feb &nbsp;5 18:28 pgpool.pam</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres &nbsp;695 Feb &nbsp;5 18:28 pgpool_recovery</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres &nbsp;656 Feb &nbsp;5 18:28 pgpool_recovery_pitr</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres &nbsp;239 Feb &nbsp;5 18:28 pgpool_remote_start</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres 3.2K Feb &nbsp;5 18:28 pool_hba.conf.sample</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres &nbsp;420 Feb &nbsp;5 18:28 replicate_def_pgbench.sql</font></div><p></p></pre></div><div><br></div><div>pgpool-II启动命令, 需要配置3个配置文件.</div><div><br></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 sample]# pgpool --help</font></div><div style="line-height: 28px;"   ><font size="2"   >pgpool-II version 3.4.1 (tataraboshi),</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; A generic connection pool/replication/load balance server for PostgreSQL</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >Usage:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; pgpool [ -c] [ -f CONFIG_FILE ] [ -F PCP_CONFIG_FILE ] [ -a HBA_CONFIG_FILE ]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[ -n ] [ -D ] [ -d ]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; pgpool [ -f CONFIG_FILE ] [ -F PCP_CONFIG_FILE ] [ -a HBA_CONFIG_FILE ]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[ -m SHUTDOWN-MODE ] stop</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; pgpool [ -f CONFIG_FILE ] [ -F PCP_CONFIG_FILE ] [ -a HBA_CONFIG_FILE ] reload</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >Common options:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; -a, --hba-file=HBA_CONFIG_FILE</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Sets the path to the pool_hba.conf configuration file</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (default: /opt/pgpool3.4.1/etc/pool_hba.conf)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; -f, --config-file=CONFIG_FILE</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Sets the path to the pgpool.conf configuration file</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (default: /opt/pgpool3.4.1/etc/pgpool.conf)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; -F, --pcp-file=PCP_CONFIG_FILE</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Sets the path to the pcp.conf configuration file</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (default: /opt/pgpool3.4.1/etc/pcp.conf)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; -h, --help &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Prints this help</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >Start options:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; -C, --clear-oidmaps Clears query cache oidmaps when memqcache_method is memcached</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (If shmem, discards whenever pgpool starts.)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; -n, --dont-detach &nbsp; Don't run in daemon mode, does not detach control tty</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; -x, --debug-assertions &nbsp; Turns on various assertion checks, This is a debugging aid</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; -D, --discard-status Discard pgpool_status file and do not restore previous status</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; -d, --debug &nbsp; &nbsp; &nbsp; &nbsp; Debug mode</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >Stop options:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; -m, --mode=SHUTDOWN-MODE</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Can be "smart", "fast", or "immediate"</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >Shutdown modes are:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; smart &nbsp; &nbsp; &nbsp; quit after all clients have disconnected</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; fast &nbsp; &nbsp; &nbsp; &nbsp;quit directly, with proper shutdown</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; immediate &nbsp; the same mode as fast</font></div><p></p></pre></div></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >将配置文件样本拷贝到对应位置.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 sample]# pwd</font></div><div><font size="2"   >/opt/soft_bak/pgpool-II-3.4.1/src/sample</font></div><div><font size="2"   >[root@db-172-16-3-150 sample]# mkdir /etc/pgpool</font></div><div><font size="2"   >[root@db-172-16-3-150 sample]# cp pcp.conf.sample /etc/pgpool/pcp.conf</font></div><div><font size="2"   >[root@db-172-16-3-150 sample]# cp pgpool.conf.sample /etc/pgpool/pgpool.conf</font></div><div><font size="2"   >[root@db-172-16-3-150 sample]# cp pool_hba.conf.sample /etc/pgpool/pool_hba.conf</font></div><div><font size="2"   >[root@db-172-16-3-150 sample]# chown -R postgres:postgres /etc/pgpool</font></div><p></p></pre></div><div><br></div><div>修改3个配置文件, 为了方便测试, 我们这里使用trust认证.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 pgpool]# which pg_md5</font></div><div><font size="2"   >/opt/pgpool3.4.1/bin/pg_md5</font></div><div><font size="2"   >[root@db-172-16-3-150 pgpool]# pg_md5 -p</font></div><div><font size="2"   >password: 输入密码,如digoal</font></div><div><font size="2"   >ebe067295ca3f3b8040d0f4d955d2d72</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 pgpool]# cd /etc/pgpool/</font></div><div><font size="2"   >[root@db-172-16-3-150 pgpool]# vi pcp.conf&nbsp;</font></div><div><font size="2"   >postgres:ebe067295ca3f3b8040d0f4d955d2d72</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 pgpool]# vi pool_hba.conf&nbsp;</font></div><div><font size="2"   ># "local" is for Unix domain socket connections only</font></div><div><font size="2"   >local &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trust</font></div><div><font size="2"   ># IPv4 local connections:</font></div><div><font size="2"   >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div><div><font size="2"   >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; ::1/128 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trust</font></div><div><font size="2"   >host all all 0.0.0.0/0 trust</font></div><p></p></pre></div><div><br></div><div>我们这里只用连接池模式, 不使用其他任何附加功能.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 pgpool]# vi pgpool.conf&nbsp;</font></div><div><font size="2"   ># ----------------------------</font></div><div><font size="2"   ># pgPool-II configuration file</font></div><div><font size="2"   ># ----------------------------</font></div><div><br></div><div><font size="2"   ># - pgpool Connection Settings -</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >listen_addresses = '0.0.0.0'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Host name or IP address to listen on:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# '*' for all, '' for no TCP/IP connections</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >port = 9999</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Port number</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >socket_dir = '/tmp'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Unix domain socket path</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# The Debian package defaults to</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# /var/run/postgresql</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >listen_backlog_multiplier = 2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Set the backlog parameter of listen(2) to</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# num_init_children * listen_backlog_multiplier.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># - pgpool Communication Manager Connection Settings -</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pcp_listen_addresses = '*'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Host name or IP address for pcp process to listen on:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# '*' for all, '' for no TCP/IP connections</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >pcp_port = 9898</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Port number for pcp</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >pcp_socket_dir = '/tmp'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Unix domain socket path for pcp</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# The Debian package defaults to</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# /var/run/postgresql</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># - Backend Connection Settings -</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >backend_hostname0 = '172.16.3.176'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Host name or IP address to connect to for backend 0</font></div><div><font size="2"   >backend_port0 = 1921</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Port number for backend 0</font></div><div><font size="2"   >backend_weight0 = 1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Weight for backend 0 (only in load balancing mode)</font></div><div><font size="2"   >backend_data_directory0 = '/data02/pgdata/pg_root'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Data directory for backend 0</font></div><div><font size="2"   >backend_flag0 = 'ALLOW_TO_FAILOVER'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Controls various backend behavior</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# ALLOW_TO_FAILOVER or DISALLOW_TO_FAILOVER</font></div><div><br></div><div><font size="2"   ><br></font></div><div><font size="2"   ># - Authentication -</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >enable_pool_hba = off</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Use pool_hba.conf for client authentication</font></div><div><font size="2"   >pool_passwd = 'pool_passwd'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# File name of pool_passwd for md5 authentication.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# "" disables pool_passwd.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >authentication_timeout = 60</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Delay in seconds to complete client authentication</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 0 means no timeout.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># - SSL Connections -</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >ssl = off</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable SSL support</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >#ssl_key = './server.key'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Path to the SSL private key file</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >#ssl_cert = './server.cert'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Path to the SSL public certificate file</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >#ssl_ca_cert = ''</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Path to a single PEM format file</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# containing CA root certificate(s)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >#ssl_ca_cert_dir = ''</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Directory containing CA root certificate(s)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ># POOLS</font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># - Pool size -</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >num_init_children = 32</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Number of pools</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >max_pool = 4</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Number of connections per pool</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># - Life time -</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >child_life_time = 300</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Pool exits after being idle for this many seconds</font></div><div><font size="2"   >child_max_connections = 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Pool exits after receiving that many connections</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 0 means no exit</font></div><div><font size="2"   >connection_life_time = 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Connection to backend closes after being idle for this many seconds</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 0 means no close</font></div><div><font size="2"   >client_idle_limit = 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Client is disconnected after being idle for that many seconds</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (even inside an explicit transactions!)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 0 means no disconnection</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ># LOGS</font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># - Where to log -</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >log_destination = 'syslog'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Where to log</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of stderr,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# and syslog. Default to stderr.</font></div><div><font size="2"   ><br></font></div><div><br></div><div><font size="2"   ><br></font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ># FILE LOCATIONS</font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pid_file_name = '/var/run/pgpool/pgpool.pid'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# PID file name</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >logdir = '/var/log/pgpool'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Directory of pgPool status file</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ># CONNECTION POOLING</font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >connection_cache = on</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Activate connection pools</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Semicolon separated list of queries</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# to be issued at the end of a session</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# The default is for 8.3 and later</font></div><div><font size="2"   >reset_query_list = 'ABORT; DISCARD ALL'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# The following one is for 8.2 and before</font></div><div><font size="2"   >#reset_query_list = 'ABORT; RESET ALL; SET SESSION AUTHORIZATION DEFAULT'</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ># REPLICATION MODE</font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >replication_mode = off</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Activate replication mode</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><br></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ># LOAD BALANCING MODE</font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >load_balance_mode = off</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Activate load balancing mode</font></div><div><br></div><div><font size="2"   ><br></font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ># MASTER/SLAVE MODE</font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >master_slave_mode = off</font></div><div><br></div><div><font size="2"   ><br></font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ># HEALTH CHECK</font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >health_check_period = 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Health check period</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Disabled (0) by default</font></div><div><br></div><div><font size="2"   ><br></font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ># ONLINE RECOVERY</font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span style="line-height: 21px;"   >...</span></font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ># WATCHDOG</font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># - Enabling -</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >use_watchdog = off</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Activates watchdog</font></div><div><font size="2"   ><span style="line-height: 21px;"   >...</span></font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ># OTHERS</font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ><span style="line-height: 21px;"   >...</span></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ># IN MEMORY QUERY MEMORY CACHE</font></div><div><font size="2"   >#------------------------------------------------------------------------------</font></div><div><font size="2"   ><span style="line-height: 21px;"   >...</span></font></div><p></p></pre></div><div><br></div><div>创建日志目录和run pid目录.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 pgpool]# mkdir /var/log/pgpool</font></div><div><font size="2"   >[root@db-172-16-3-150 pgpool]# mkdir /var/run/pgpool</font></div><p></p></pre></div><div><br></div><div>启动pgpool</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 pgpool]# pgpool -a /etc/pgpool/pool_hba.conf -f /etc/pgpool/pgpool.conf -F /etc/pgpool/pcp.conf&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-150 pgpool]# tail -f -n 10 /var/log/messages</font></div><div><font size="2"   >Apr &nbsp;8 08:40:51 db-172-16-3-150 pgpool[1780]: [1-1] 2015-04-08 08:40:51: pid 1780: LOG: &nbsp;Backend status file /var/log/pgpool/pgpool_status does not exist</font></div><div><font size="2"   >Apr &nbsp;8 08:40:51 db-172-16-3-150 pgpool[1780]: [1-2] 2015-04-08 08:40:51: pid 1780: LOCATION: &nbsp;pgpool_main.c:2755</font></div><div><font size="2"   >Apr &nbsp;8 08:40:51 db-172-16-3-150 pgpool[1780]: [2-1] 2015-04-08 08:40:51: pid 1780: LOG: &nbsp;Setting up socket for 0.0.0.0:9999</font></div><div><font size="2"   >Apr &nbsp;8 08:40:51 db-172-16-3-150 pgpool[1780]: [2-2] 2015-04-08 08:40:51: pid 1780: LOCATION: &nbsp;pgpool_main.c:797</font></div><div><font size="2"   >Apr &nbsp;8 08:40:51 db-172-16-3-150 pgpool[1780]: [3-1] 2015-04-08 08:40:51: pid 1780: LOG: &nbsp;pgpool-II successfully started. version 3.4.1 (tataraboshi)</font></div><div><font size="2"   >Apr &nbsp;8 08:40:51 db-172-16-3-150 pgpool[1780]: [3-2] 2015-04-08 08:40:51: pid 1780: LOCATION: &nbsp;pgpool_main.c:330</font></div><p></p></pre></div><div><br></div><div>测试是否可以正常连接</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 9999 -U postgres postgres</font></div><div><font size="2"   >psql (9.4.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# \q</font></div><p></p></pre></div><div><br></div><div>准备用于压力测试的脚本, 因为我们测的是pgpool-II, 而不是数据库, 所以使用最简单的查询.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-174-&gt; vi test.sql</font></div><div><font size="2"   >select 1;</font></div><p></p></pre></div><div><br></div><div>在数据库本地, 直接连接数据库测试, 结果如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@176-&gt; pgbench -M prepared -n -r -f ./test.sql -h 127.0.0.1 -p 1921 -U postgres -c 16 -j 8 -T 120 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 120 s</font></div><div><font size="2"   >number of transactions actually processed: 13798268</font></div><div><font size="2"   >tps = 114984.315254 (including connections establishing)</font></div><div><font size="2"   >tps = 114995.257173 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.137798 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >在测试机, 直接连接数据库测试, 结果如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-174-&gt; pgbench -M prepared -n -r -f ./test.sql -h 172.16.3.176 -p 1921 -U postgres -c 16 -j 8 -T 120 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 120 s</font></div><div><font size="2"   >number of transactions actually processed: 7534770</font></div><div><font size="2"   >tps = 62788.712417 (including connections establishing)</font></div><div><font size="2"   >tps = 62794.058850 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.252501 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >在测试机, 连接pgpool-II测试, 结果如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-174-&gt; pgbench -M prepared -n -r -f ./test.sql -h 172.16.3.150 -p 9999 -U postgres -c 16 -j 8 -T 120 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 120 s</font></div><div><font size="2"   >number of transactions actually processed: 2065233</font></div><div><font size="2"   >tps = 17209.981713 (including connections establishing)</font></div><div><font size="2"   >tps = 17211.768999 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.765831 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >在pgpool-II机器本地, 直接连接数据库测试, 结果如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -h 172.16.3.176 -p 1921 -U postgres -c 16 -j 8 -T 120 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 120 s</font></div><div><font size="2"   >number of transactions actually processed: 8632236</font></div><div><font size="2"   >latency average: 0.222 ms</font></div><div><font size="2"   >tps = 71934.282729 (including connections establishing)</font></div><div><font size="2"   >tps = 71943.727533 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.220962 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >在pgpool-II机器本地, 直接连接pgpool-II测试, 结果如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -h 127.0.0.1 -p 9999 -U postgres -c 16 -j 8 -T 120 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 120 s</font></div><div><font size="2"   >number of transactions actually processed: 2033971</font></div><div><font size="2"   >latency average: 0.944 ms</font></div><div><font size="2"   >tps = 16949.161299 (including connections establishing)</font></div><div><font size="2"   >tps = 16951.540647 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.771560 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><p></p></pre></div><div><br></div><div>从测试数据来看, pgpool-II 3.4.1版本的性能损耗依旧.</div><div>下面是一stap来进行跟踪.</div><div>安装systemtap</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 src]# uname -r</font></div><div><font size="2"   >2.6.32-504.el6.x86_64</font></div></div><div><font size="2"   >yum install -y&nbsp;kernel-devel-2.6.32-504.el6.x86_64 systemtap</font></div><p></p></pre></div><div>编写跟踪脚本</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># vi cat trc.stp&nbsp;</font></div><div><font size="2"   >global f_start[999999],f_stop[999999]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe process("/opt/pgpool3.4.1/bin/pgpool").function("*@/opt/soft_bak/pgpool-II-3.4.1/src/*").call {&nbsp;</font></div><div><font size="2"   >&nbsp; f_start[execname(), pid(), tid(), cpu()] = gettimeofday_ns()</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe process("/opt/pgpool3.4.1/bin/pgpool").function("*@/opt/soft_bak/pgpool-II-3.4.1/src/*").return {&nbsp;</font></div><div><font size="2"   >&nbsp; t=gettimeofday_ns()</font></div><div><font size="2"   >&nbsp; a=execname()</font></div><div><font size="2"   >&nbsp; b=cpu()</font></div><div><font size="2"   >&nbsp; c=pid()</font></div><div><font size="2"   >&nbsp; d=pp()</font></div><div><font size="2"   >&nbsp; e=tid()</font></div><div><font size="2"   >&nbsp; if (f_start[a,c,e,b]) {</font></div><div><font size="2"   >&nbsp; &nbsp; f_stop[a,d] &lt;&lt;&lt; t - f_start[a,c,e,b]</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >&nbsp;&nbsp;</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe timer.s(5) {</font></div><div><font size="2"   >&nbsp; foreach ([a,d] in f_stop @sum - limit 50 ) {&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; printf("avg_ns:%d, sum_ns:%d, cnt:%d, execname:%s, pp:%s\n", @avg(f_stop[a,d]), @sum(f_stop[a,d]), @count(f_stop[a,d]), a, d)</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >在pgbench测试机开启pgbench, 连接pgpool-II</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db6-&gt; pgbench -M prepared -n -r -f ./test.sql -h 172.16.3.150 -p 9999 -U postgres -c 16 -j 8 -T 50 postgres</font></div><div><font size="2"   >Client 5 aborted in state 0. Probably the backend died while processing.</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 8</font></div><div><font size="2"   >duration: 50 s</font></div><div><font size="2"   >number of transactions actually processed: 784156</font></div><div><font size="2"   >tps = 15682.483918 (including connections establishing)</font></div><div><font size="2"   >tps = 15686.457333 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.808510 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><p></p></pre></div><div><br></div><div>同时开启stap, 确保可以跟踪到压力测试过程. &nbsp;收集5秒的测试数据报告如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# stap -vp 5 -DMAXSKIPPED=9999999 -DSTP_NO_OVERLOAD -DMAXTRYLOCK=100 ./trc.stp</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >Pass 1: parsed user script and 116 library script(s) using 212504virt/40068res/3172shr/37724data kb, in 330usr/30sys/358real ms.</font></div><div><font size="2"   >Pass 2: analyzed script: 937 probe(s), 7 function(s), 4 embed(s), 2 global(s) using 218240virt/46796res/4184shr/43460data kb, in 160usr/80sys/328real ms.</font></div><div><font size="2"   >Pass 3: translated to C into "/tmp/stapooq1sT/stap_cfcc5355227f07104ee2359b8481c4a1_394533_src.c" using 218244virt/47344res/4532shr/43464data kb, in 100usr/80sys/169real ms.</font></div><div><font size="2"   >Pass 4: compiled C into "stap_cfcc5355227f07104ee2359b8481c4a1_394533.ko" in 2590usr/310sys/2868real ms.</font></div><div><font size="2"   >Pass 5: starting run.</font></div><div><font size="2"   >avg_ns:5266, sum_ns:1909464893, cnt:362594, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return</font></div><div><font size="2"   >avg_ns:19393, sum_ns:255681973, cnt:13184, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("appendStringInfoVA@/opt/soft_bak/pgpool-II-3.4.1/src/parser/stringinfo.c:114").return</font></div><div><font size="2"   >avg_ns:5178, sum_ns:204855738, cnt:39558, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("initStringInfo@/opt/soft_bak/pgpool-II-3.4.1/src/parser/stringinfo.c:47").return</font></div><div><font size="2"   >avg_ns:14494, sum_ns:191096928, cnt:13184, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("pg_vsnprintf@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:202").return</font></div><div><font size="2"   >avg_ns:10092, sum_ns:133073987, cnt:13186, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("makeStringInfo@/opt/soft_bak/pgpool-II-3.4.1/src/parser/stringinfo.c:29").return</font></div><div><font size="2"   >avg_ns:9907, sum_ns:130620770, cnt:13184, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("dopr@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:355").return</font></div><div><font size="2"   >avg_ns:5339, sum_ns:35205838, cnt:6593, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("appendStringInfoChar@/opt/soft_bak/pgpool-II-3.4.1/src/parser/stringinfo.c:174").return</font></div><div><font size="2"   >WARNING: Number of errors: 0, skipped probes: 20377</font></div><div><font size="2"   >Pass 5: run completed in 10usr/12590sys/22383real ms.</font></div><p></p></pre></div><div><br></div><div>有些函数因为锁超时跳过, 从剩下的结果来看, 大部分耗时在这个函数. 调用次数最多, 累计耗时最长.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c</font></div><div><div><font size="2"   >static void</font></div><div><font size="2"   >dopr_outch(int c, PrintfTarget *target)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (target-&gt;bufend != NULL &amp;&amp; target-&gt;bufptr &gt;= target-&gt;bufend)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* buffer full, can we dump to stream? */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (target-&gt;stream == NULL)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* no, lose the data */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; flushbuffer(target);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; *(target-&gt;bufptr++) = c;</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div><div style="line-height: 28px;"   >接下来我把这个函数内容清空, 重新编译pgpool-II再次测试, 结果依旧</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >postgres@db6-&gt; pgbench -M prepared -n -r -f ./test.sql -h 172.16.3.150 -p 9999 -U postgres -c 16 -j 8 -T 50 postgres</font></div><div style="line-height: 28px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 28px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 28px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 28px;"   ><font size="2"   >number of clients: 16</font></div><div style="line-height: 28px;"   ><font size="2"   >number of threads: 8</font></div><div style="line-height: 28px;"   ><font size="2"   >duration: 50 s</font></div><div style="line-height: 28px;"   ><font size="2"   >number of transactions actually processed: 844017</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 16879.764062 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 16884.295568 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.781028 &nbsp; &nbsp; &nbsp; &nbsp;select 1;</font></div><p></p></pre></div></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >接下来做一下单SQL的所有函数跟踪.</div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 9999 -U postgres postgres</font></div><div><font size="2"   >psql (9.4.1, server 9.3.5)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=#&nbsp;</font></div><p></p></pre></div><div style="line-height: 28px;"   >定位到POOL的pid, 用于stap跟踪.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >ps -ewf|grep pgpool</font></div><div><font size="2"   >root &nbsp; &nbsp; 21962 21961 &nbsp;0 13:36 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 pgpool: postgres postgres 127.0.0.1(44044) idle&nbsp;</font></div><p></p></pre></div><div style="line-height: 28px;"   >稍微修改一下跟踪脚本</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# vi trc.stp&nbsp;</font></div><div><font size="2"   ><span style="line-height: 21px;"   >global f_start[999999],f_stop[999999]<br><br>probe process("/opt/pgpool3.4.1/bin/pgpool").function("*@/opt/soft_bak/pgpool-II-3.4.1/src/*").call {<br>  f_start[execname(), pid(), tid(), cpu()] = gettimeofday_ns()<br>}<br><br>probe process("/opt/pgpool3.4.1/bin/pgpool").function("*@/opt/soft_bak/pgpool-II-3.4.1/src/*").return {<br>  t=gettimeofday_ns()<br>  a=execname()<br>  b=cpu()<br>  c=pid()<br>  d=pp()<br>  e=tid()<br>  if (f_start[a,c,e,b]) {<br>    f_stop[a,d] &lt;&lt;&lt; t - f_start[a,c,e,b]<br>    printf("%d, %s\n", t - f_start[a,c,e,b], d)</span></font></div><div><font size="2"   ><span style="line-height: 21px;"   >    # or you can </span></font><span style="font-size: small; line-height: 21px;"   >printf("%s \n", $$locals$$)</span><font size="2"   ><span style="line-height: 21px;"   ><br>  }<br><br>}<br><br>probe end {<br>  foreach ([a,d] in f_stop @sum - limit 50 ) {<br>    printf("avg_ns:%d, sum_ns:%d, cnt:%d, execname:%s, pp:%s\n", @avg(f_stop[a,d]), @sum(f_stop[a,d]), @count(f_stop[a,d]), a, d)<br>  }<br>  exit()<br>}</span></font></div><p></p></pre></div><div><br></div><div>跟踪过程中执行一条查询.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from pg_class limit 1;</font></div><div><font size="2"   >&nbsp; &nbsp;relname &nbsp; &nbsp;| relnamespace | reltype | reloftype | relowner | relam | relfilenode | reltablespace | relpages | reltuples | relallv</font></div><div><font size="2"   >isible | reltoastrelid | reltoastidxid | relhasindex | relisshared | relpersistence | relkind | relnatts | relchecks | relhasoids |&nbsp;</font></div><div><font size="2"   >relhaspkey | relhasrules | relhastriggers | relhassubclass | relispopulated | relfrozenxid | relminmxid | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relacl &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; | reloptions&nbsp;</font></div><div><font size="2"   >--------------+--------------+---------+-----------+----------+-------+-------------+---------------+----------+-----------+--------</font></div><div><font size="2"   >-------+---------------+---------------+-------------+-------------+----------------+---------+----------+-----------+------------+-</font></div><div><font size="2"   >-----------+-------------+----------------+----------------+----------------+--------------+------------+---------------------------</font></div><div><font size="2"   >--+------------</font></div><div><font size="2"   >&nbsp;pg_statistic | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11 | &nbsp; 10818 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; 10 | &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; 12629 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; 15 | &nbsp; &nbsp; &nbsp; 388 | &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; 15 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2840 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | p &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| r &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 26 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 1800 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 | {postgres=arwdDxt/postgres</font></div><div><font size="2"   >} |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 2.566 ms</font></div><p></p></pre></div><div><br></div><div>跟踪结果 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >[root@db-172-16-3-150 ~]# stap -vp 5 -DMAXSKIPPED=9999999 -DSTP_NO_OVERLOAD -DMAXTRYLOCK=100 ./trc.stp -x 21962<br>Pass 1: parsed user script and 116 library script(s) using 212508virt/40068res/3172shr/37728data kb, in 320usr/30sys/355real ms.<br>Pass 2: analyzed script: 937 probe(s), 7 function(s), 4 embed(s), 2 global(s) using 218660virt/47212res/4168shr/43880data kb, in 190usr/80sys/345real ms.<br>Pass 3: translated to C into "/tmp/stapX1vB5l/stap_3d39e5129acf59add49b6bf0e6dbd2cb_420727_src.c" using 218668virt/47752res/4512shr/43888data kb, in 100usr/70sys/174real ms.<br>Pass 4: compiled C into "stap_3d39e5129acf59add49b6bf0e6dbd2cb_420727.ko" in 2570usr/350sys/2866real ms.<br>Pass 5: starting run.<br>5768, process("/opt/pgpool3.4.1/bin/pgpool").function("core_yylex_init@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.c:3279").return<br>4786, process("/opt/pgpool3.4.1/bin/pgpool").function("core_yyensure_buffer_stack@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.c:2945").return<br>10659, process("/opt/pgpool3.4.1/bin/pgpool").function("core_yy_switch_to_buffer@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.c:2740").return<br>16177, process("/opt/pgpool3.4.1/bin/pgpool").function("core_yy_scan_buffer@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.c:2995").return<br>22334, process("/opt/pgpool3.4.1/bin/pgpool").function("scanner_init@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.l:1070").return<br>4711, process("/opt/pgpool3.4.1/bin/pgpool").function("parser_init@/opt/soft_bak/pgpool-II-3.4.1/src/parser/gram.y:14022").return<br>6561, process("/opt/pgpool3.4.1/bin/pgpool").function("ScanKeywordLookup@/opt/soft_bak/pgpool-II-3.4.1/src/parser/kwlookup.c:38").return<br>12141, process("/opt/pgpool3.4.1/bin/pgpool").function("core_yylex@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.c:1325").return<br>17366, process("/opt/pgpool3.4.1/bin/pgpool").function("base_yylex@/opt/soft_bak/pgpool-II-3.4.1/src/parser/parser.c:108").return<br>4026, process("/opt/pgpool3.4.1/bin/pgpool").function("core_yylex@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.c:1325").return<br>8694, process("/opt/pgpool3.4.1/bin/pgpool").function("base_yylex@/opt/soft_bak/pgpool-II-3.4.1/src/parser/parser.c:108").return<br>4399, process("/opt/pgpool3.4.1/bin/pgpool").function("new_list@/opt/soft_bak/pgpool-II-3.4.1/src/parser/list.c:68").return<br>9963, process("/opt/pgpool3.4.1/bin/pgpool").function("lcons@/opt/soft_bak/pgpool-II-3.4.1/src/parser/list.c:264").return<br>3421, process("/opt/pgpool3.4.1/bin/pgpool").function("new_list@/opt/soft_bak/pgpool-II-3.4.1/src/parser/list.c:68").return<br>8066, process("/opt/pgpool3.4.1/bin/pgpool").function("lcons@/opt/soft_bak/pgpool-II-3.4.1/src/parser/list.c:264").return<br>4211, process("/opt/pgpool3.4.1/bin/pgpool").function("ScanKeywordLookup@/opt/soft_bak/pgpool-II-3.4.1/src/parser/kwlookup.c:38").return<br>8851, process("/opt/pgpool3.4.1/bin/pgpool").function("core_yylex@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.c:1325").return<br>13218, process("/opt/pgpool3.4.1/bin/pgpool").function("base_yylex@/opt/soft_bak/pgpool-II-3.4.1/src/parser/parser.c:108").return<br>4509, process("/opt/pgpool3.4.1/bin/pgpool").function("ScanKeywordLookup@/opt/soft_bak/pgpool-II-3.4.1/src/parser/kwlookup.c:38").return<br>4511, process("/opt/pgpool3.4.1/bin/pgpool").function("downcase_truncate_identifier@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scansup.c:131").return<br>10093, process("/opt/pgpool3.4.1/bin/pgpool").function("core_yylex@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.c:1325").return<br>14532, process("/opt/pgpool3.4.1/bin/pgpool").function("base_yylex@/opt/soft_bak/pgpool-II-3.4.1/src/parser/parser.c:108").return<br>4516, process("/opt/pgpool3.4.1/bin/pgpool").function("ScanKeywordLookup@/opt/soft_bak/pgpool-II-3.4.1/src/parser/kwlookup.c:38").return<br>9213, process("/opt/pgpool3.4.1/bin/pgpool").function("core_yylex@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.c:1325").return<br>13574, process("/opt/pgpool3.4.1/bin/pgpool").function("base_yylex@/opt/soft_bak/pgpool-II-3.4.1/src/parser/parser.c:108").return<br>4585, process("/opt/pgpool3.4.1/bin/pgpool").function("makeRangeVar@/opt/soft_bak/pgpool-II-3.4.1/src/parser/makefuncs.c:421").return<br>3432, process("/opt/pgpool3.4.1/bin/pgpool").function("new_list@/opt/soft_bak/pgpool-II-3.4.1/src/parser/list.c:68").return<br>7994, process("/opt/pgpool3.4.1/bin/pgpool").function("lcons@/opt/soft_bak/pgpool-II-3.4.1/src/parser/list.c:264").return<br>6101, process("/opt/pgpool3.4.1/bin/pgpool").function("process_integer_literal@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.l:1177").return<br>10490, process("/opt/pgpool3.4.1/bin/pgpool").function("core_yylex@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.c:1325").return<br>15001, process("/opt/pgpool3.4.1/bin/pgpool").function("base_yylex@/opt/soft_bak/pgpool-II-3.4.1/src/parser/parser.c:108").return<br>4647, process("/opt/pgpool3.4.1/bin/pgpool").function("makeIntConst@/opt/soft_bak/pgpool-II-3.4.1/src/parser/gram.y:13370").return<br>4495, process("/opt/pgpool3.4.1/bin/pgpool").function("core_yylex@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.c:1325").return<br>9066, process("/opt/pgpool3.4.1/bin/pgpool").function("base_yylex@/opt/soft_bak/pgpool-II-3.4.1/src/parser/parser.c:108").return<br>3499, process("/opt/pgpool3.4.1/bin/pgpool").function("new_list@/opt/soft_bak/pgpool-II-3.4.1/src/parser/list.c:68").return<br>8153, process("/opt/pgpool3.4.1/bin/pgpool").function("lcons@/opt/soft_bak/pgpool-II-3.4.1/src/parser/list.c:264").return<br>3497, process("/opt/pgpool3.4.1/bin/pgpool").function("lcons@/opt/soft_bak/pgpool-II-3.4.1/src/parser/list.c:264").return<br>4836, process("/opt/pgpool3.4.1/bin/pgpool").function("list_nth@/opt/soft_bak/pgpool-II-3.4.1/src/parser/list.c:415").return<br>3732, process("/opt/pgpool3.4.1/bin/pgpool").function("list_nth@/opt/soft_bak/pgpool-II-3.4.1/src/parser/list.c:415").return<br>4430, process("/opt/pgpool3.4.1/bin/pgpool").function("list_concat@/opt/soft_bak/pgpool-II-3.4.1/src/parser/list.c:326").return<br>9653, process("/opt/pgpool3.4.1/bin/pgpool").function("insertSelectOptions@/opt/soft_bak/pgpool-II-3.4.1/src/parser/gram.y:13588").return<br>3565, process("/opt/pgpool3.4.1/bin/pgpool").function("new_list@/opt/soft_bak/pgpool-II-3.4.1/src/parser/list.c:68").return<br>8187, process("/opt/pgpool3.4.1/bin/pgpool").function("lcons@/opt/soft_bak/pgpool-II-3.4.1/src/parser/list.c:264").return<br>3923, process("/opt/pgpool3.4.1/bin/pgpool").function("core_yylex@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.c:1325").return<br>8453, process("/opt/pgpool3.4.1/bin/pgpool").function("base_yylex@/opt/soft_bak/pgpool-II-3.4.1/src/parser/parser.c:108").return<br>14031, process("/opt/pgpool3.4.1/bin/pgpool").function("base_yyparse@/opt/soft_bak/pgpool-II-3.4.1/src/parser/gram.c:20532").return<br>4695, process("/opt/pgpool3.4.1/bin/pgpool").function("scanner_finish@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.l:1108").return<br>10165, process("/opt/pgpool3.4.1/bin/pgpool").function("raw_parser@/opt/soft_bak/pgpool-II-3.4.1/src/parser/parser.c:49").return<br>6052, process("/opt/pgpool3.4.1/bin/pgpool").function("initStringInfo@/opt/soft_bak/pgpool-II-3.4.1/src/parser/stringinfo.c:47").return<br>15669, process("/opt/pgpool3.4.1/bin/pgpool").function("makeStringInfo@/opt/soft_bak/pgpool-II-3.4.1/src/parser/stringinfo.c:29").return<br>4255, process("/opt/pgpool3.4.1/bin/pgpool").function("initStringInfo@/opt/soft_bak/pgpool-II-3.4.1/src/parser/stringinfo.c:47").return<br>13428, process("/opt/pgpool3.4.1/bin/pgpool").function("makeStringInfo@/opt/soft_bak/pgpool-II-3.4.1/src/parser/stringinfo.c:29").return<br>4565, process("/opt/pgpool3.4.1/bin/pgpool").function("appendStringInfoChar@/opt/soft_bak/pgpool-II-3.4.1/src/parser/stringinfo.c:174").return<br>3760, process("/opt/pgpool3.4.1/bin/pgpool").function("initStringInfo@/opt/soft_bak/pgpool-II-3.4.1/src/parser/stringinfo.c:47").return<br>3342, process("/opt/pgpool3.4.1/bin/pgpool").function("initStringInfo@/opt/soft_bak/pgpool-II-3.4.1/src/parser/stringinfo.c:47").return<br>4465, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3308, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3455, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3250, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3340, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3286, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3327, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3306, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3298, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3282, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3337, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3260, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3352, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3295, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3308, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3284, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3306, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3278, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3330, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3286, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3291, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3290, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3304, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3284, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>7861, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:355").return<br>12794, process("/opt/pgpool3.4.1/bin/pgpool").function("pg_vsnprintf@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:202").return<br>17946, process("/opt/pgpool3.4.1/bin/pgpool").function("appendStringInfoVA@/opt/soft_bak/pgpool-II-3.4.1/src/parser/stringinfo.c:114").return<br>3430, process("/opt/pgpool3.4.1/bin/pgpool").function("initStringInfo@/opt/soft_bak/pgpool-II-3.4.1/src/parser/stringinfo.c:47").return<br>3286, process("/opt/pgpool3.4.1/bin/pgpool").function("initStringInfo@/opt/soft_bak/pgpool-II-3.4.1/src/parser/stringinfo.c:47").return<br>3300, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3314, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3316, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3324, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3280, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3328, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3286, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3292, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3257, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3352, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3282, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3306, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3283, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3330, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3286, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3288, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3292, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3294, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3278, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3300, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3276, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3328, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3289, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3268, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3347, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3296, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3280, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3301, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3276, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3329, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>3286, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>7872, process("/opt/pgpool3.4.1/bin/pgpool").function("dopr@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:355").return<br>12239, process("/opt/pgpool3.4.1/bin/pgpool").function("pg_vsnprintf@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:202").return<br>16750, process("/opt/pgpool3.4.1/bin/pgpool").function("appendStringInfoVA@/opt/soft_bak/pgpool-II-3.4.1/src/parser/stringinfo.c:114").return<br><br><br>^C<br><br>avg_ns:3323, sum_ns:182786, cnt:55, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("dopr_outch@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:1024").return<br>avg_ns:12488, sum_ns:99904, cnt:8, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("base_yylex@/opt/soft_bak/pgpool-II-3.4.1/src/parser/parser.c:108").return<br>avg_ns:7904, sum_ns:63232, cnt:8, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("core_yylex@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.c:1325").return<br>avg_ns:7643, sum_ns:45860, cnt:6, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("lcons@/opt/soft_bak/pgpool-II-3.4.1/src/parser/list.c:264").return<br>avg_ns:17348, sum_ns:34696, cnt:2, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("appendStringInfoVA@/opt/soft_bak/pgpool-II-3.4.1/src/parser/stringinfo.c:114").return<br>avg_ns:14548, sum_ns:29097, cnt:2, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("makeStringInfo@/opt/soft_bak/pgpool-II-3.4.1/src/parser/stringinfo.c:29").return<br>avg_ns:12516, sum_ns:25033, cnt:2, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("pg_vsnprintf@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:202").return<br>avg_ns:4020, sum_ns:24125, cnt:6, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("initStringInfo@/opt/soft_bak/pgpool-II-3.4.1/src/parser/stringinfo.c:47").return<br>avg_ns:22334, sum_ns:22334, cnt:1, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("scanner_init@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.l:1070").return<br>avg_ns:4949, sum_ns:19797, cnt:4, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("ScanKeywordLookup@/opt/soft_bak/pgpool-II-3.4.1/src/parser/kwlookup.c:38").return<br>avg_ns:3663, sum_ns:18316, cnt:5, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("new_list@/opt/soft_bak/pgpool-II-3.4.1/src/parser/list.c:68").return<br>avg_ns:16177, sum_ns:16177, cnt:1, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("core_yy_scan_buffer@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.c:2995").return<br>avg_ns:7866, sum_ns:15733, cnt:2, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("dopr@/opt/soft_bak/pgpool-II-3.4.1/src/parser/snprintf.c:355").return<br>avg_ns:14031, sum_ns:14031, cnt:1, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("base_yyparse@/opt/soft_bak/pgpool-II-3.4.1/src/parser/gram.c:20532").return<br>avg_ns:10659, sum_ns:10659, cnt:1, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("core_yy_switch_to_buffer@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.c:2740").return<br>avg_ns:10165, sum_ns:10165, cnt:1, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("raw_parser@/opt/soft_bak/pgpool-II-3.4.1/src/parser/parser.c:49").return<br>avg_ns:9653, sum_ns:9653, cnt:1, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("insertSelectOptions@/opt/soft_bak/pgpool-II-3.4.1/src/parser/gram.y:13588").return<br>avg_ns:4284, sum_ns:8568, cnt:2, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("list_nth@/opt/soft_bak/pgpool-II-3.4.1/src/parser/list.c:415").return<br>avg_ns:6101, sum_ns:6101, cnt:1, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("process_integer_literal@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.l:1177").return<br>avg_ns:5768, sum_ns:5768, cnt:1, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("core_yylex_init@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.c:3279").return<br>avg_ns:4786, sum_ns:4786, cnt:1, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("core_yyensure_buffer_stack@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.c:2945").return<br>avg_ns:4711, sum_ns:4711, cnt:1, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("parser_init@/opt/soft_bak/pgpool-II-3.4.1/src/parser/gram.y:14022").return<br>avg_ns:4695, sum_ns:4695, cnt:1, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("scanner_finish@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scan.l:1108").return<br>avg_ns:4647, sum_ns:4647, cnt:1, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("makeIntConst@/opt/soft_bak/pgpool-II-3.4.1/src/parser/gram.y:13370").return<br>avg_ns:4585, sum_ns:4585, cnt:1, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("makeRangeVar@/opt/soft_bak/pgpool-II-3.4.1/src/parser/makefuncs.c:421").return<br>avg_ns:4565, sum_ns:4565, cnt:1, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("appendStringInfoChar@/opt/soft_bak/pgpool-II-3.4.1/src/parser/stringinfo.c:174").return<br>avg_ns:4511, sum_ns:4511, cnt:1, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("downcase_truncate_identifier@/opt/soft_bak/pgpool-II-3.4.1/src/parser/scansup.c:131").return<br>avg_ns:4430, sum_ns:4430, cnt:1, execname:pgpool, pp:process("/opt/pgpool3.4.1/bin/pgpool").function("list_concat@/opt/soft_bak/pgpool-II-3.4.1/src/parser/list.c:326").return<br>Pass 5: run completed in 10usr/14470sys/20108real ms.</span></font></div><p></p></pre></div><div>时间总和 698965us =&nbsp;0.698965 毫秒. &nbsp;也可以理解为pgpool-II处理一个查询时, 自身的开心约0.698965毫秒, (实际上应该略小, 因为stap计算时间时也有一定的开销, 在这个基础上, 最后给个经验值约 0.5毫秒左右吧.)</div><div>(和本文前面测试中的0.765831-0.252501 = 0.51333毫秒差不多)</div><div>这部分时间是select * from pg_class limit 1; 在pgpool-II代码中的耗费.</div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="use systemtap analyze pgpool-II performance, which functions use the most time - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>