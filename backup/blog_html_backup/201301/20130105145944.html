<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL partition table name convert to data type</h2>
	<h5 id="">2013-01-05 14:59:44&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020130525628988/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>昨天写了一篇关于PostgreSQL的分区表监控, 如下 :&nbsp;</div><div><a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020130433036377/"   >http://blog.163.com/digoal@126/blog/static/16387704020130433036377/</a></div><div>将表名转成日期的方法举例 :&nbsp;</div><div>方法1 :&nbsp;</div><div>用到规则表达式的替换和转数组函数.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select&nbsp;</font></div><div><font size="2"   >regexp_split_to_array(</font></div><div><font size="2"   >&nbsp; regexp_replace(</font></div><div><font size="2"   >&nbsp; &nbsp; rtrim(</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; ltrim(</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; regexp_replace('b2.ffw2wf2ab2012_11_31_fe_2'</font></div><div><font size="2"   ><span> </span>,'[^[:digit:]]','_','g')</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; ,'_')</font></div><div><font size="2"   >&nbsp; &nbsp; ,'_')</font></div><div><font size="2"   >&nbsp; ,'_+','_','g')</font></div><div><font size="2"   >,'_');</font></div><p></p></pre></div><div>结果 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >inherit_mon=&gt; select&nbsp;</font></div><div><font size="2"   >inherit_mon-&gt; regexp_split_to_array(</font></div><div><font size="2"   >inherit_mon(&gt; &nbsp; regexp_replace(</font></div><div><font size="2"   >inherit_mon(&gt; &nbsp; &nbsp; rtrim(</font></div><div><font size="2"   >inherit_mon(&gt; &nbsp; &nbsp; &nbsp; ltrim(</font></div><div><font size="2"   >inherit_mon(&gt; &nbsp; &nbsp; &nbsp; &nbsp; regexp_replace('b2.ffw2wf2ab2012_11_31_fe_2'</font></div><div><font size="2"   >inherit_mon(&gt; ,'[^[:digit:]]','_','g')</font></div><div><font size="2"   >inherit_mon(&gt; &nbsp; &nbsp; &nbsp; ,'_')</font></div><div><font size="2"   >inherit_mon(&gt; &nbsp; &nbsp; ,'_')</font></div><div><font size="2"   >inherit_mon(&gt; &nbsp; ,'_+','_','g')</font></div><div><font size="2"   >inherit_mon(&gt; ,'_');</font></div><div><font size="2"   >&nbsp;regexp_split_to_array&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;{2,2,2,2012,11,31,2}</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>表名转日期的函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >create or replace function mon_part_conv_to_date(i_relname text) returns date as $$<br>declare<br>  arr text[] := ARRAY[0];<br>  v_date text := '';<br>  i text := '';<br>  v_len int := 0;<br>begin<br>  arr := regexp_split_to_array( regexp_replace( rtrim( ltrim( regexp_replace(i_relname,'[^[:digit:]]','_','g') ,'_') ,'_') ,'_+','_','g') ,'_');<br>  FOREACH i IN ARRAY arr<br>  loop<br>    if (length(v_date) = 8) then<br>      exit;<br>    end if;<br>    if (length(i) = 4 and length(v_date)=0 and (substr(i,1,2) &gt;= '18' and substr(i,1,2) &lt;= '22')) then<br>      v_date := v_date||i;<br>    elsif (length(i) = 6 and length(v_date)=0 and (substr(i,1,2) &gt;= '18' and substr(i,1,2) &lt;= '22') and (substr(i,5,2)&gt;='01' and substr(i,5,2)&lt;='12')) then<br>      v_date := v_date||i;<br>    elsif (length(i) = 8 and length(v_date)=0 and (substr(i,1,2) &gt;= '18' and substr(i,1,2) &lt;= '22') and (substr(i,5,2)&gt;='01' and substr(i,5,2)&lt;='12') and (substr(i,7,2)&gt;='01' and substr(i,7,2)&lt;='31')) then<br>      v_date := v_date||i;<br>    elsif (length(i)=4 and length(v_date) = 4 and (substr(i,1,2)&gt;='01' and substr(i,1,2)&lt;='12') and (substr(i,3,2)&gt;='01' and substr(i,3,2)&lt;='31')) then<br>      v_date := v_date||i;<br>    elsif (length(i)=2 and length(v_date) = 4 and (substr(i,1,2)&gt;='01' and substr(i,1,2)&lt;='12')) then<br>      v_date := v_date||i;<br>    elsif (length(i)=2 and length(v_date) = 6 and (substr(i,1,2)&gt;='01' and substr(i,1,2)&lt;='31')) then<br>      v_date := v_date||i;<br>    else<br>      continue;<br>    end if;<br>  end loop;<br>  v_len := length(v_date);<br>  case v_len<br>  when 4 then -- 按年分表<br>    return (v_date||'0101')::date;<br>  when 6 then -- 按月分表<br>    return (v_date||'01')::date;<br>  when 8 then -- 按天分表<br>    return v_date::date;<br>  else -- 长度为5和7非日期分表<br>    return '22220101'::date;<br>  end case;<br>exception when others then<br>  return '22220101'::date;<br>end;<br>$$ language plpgsql;</span></font></div><p></p></pre></div><div>测试几种表的格式正确转换 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >inherit_mon=&gt; select mon_part_conv_to_date('digoal1234.tbl_2012_12_01');</font></div><div><font size="2"   >&nbsp;mon_part_conv_to_date&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;2012-12-01</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >inherit_mon=&gt; select mon_part_conv_to_date('digoal1234.tbl_2012_12_02');</font></div><div><font size="2"   >&nbsp;mon_part_conv_to_date&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;2012-12-02</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >inherit_mon=&gt; select mon_part_conv_to_date('digoal1234.tbl_2012_12_1');</font></div><div><font size="2"   >&nbsp;mon_part_conv_to_date&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;2012-12-01</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >inherit_mon=&gt; select mon_part_conv_to_date('digoal1234.tbl_2012_12_2');</font></div><div><font size="2"   >&nbsp;mon_part_conv_to_date&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;2012-12-01</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >inherit_mon=&gt; select mon_part_conv_to_date('digoal1234.tbl_2012_1203');</font></div><div><font size="2"   >&nbsp;mon_part_conv_to_date&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;2012-12-03</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >inherit_mon=&gt; select mon_part_conv_to_date('digoal1234.tbl_20121203');</font></div><div><font size="2"   >&nbsp;mon_part_conv_to_date&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;2012-12-03</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >inherit_mon=&gt; select mon_part_conv_to_date('digoal1234.tbl_2012');</font></div><div><font size="2"   >&nbsp;mon_part_conv_to_date&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;2012-01-01</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >inherit_mon=&gt; select mon_part_conv_to_date('digoal1234.tbl_201212');</font></div><div><font size="2"   >&nbsp;mon_part_conv_to_date&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;2012-12-01</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >inherit_mon=&gt; select mon_part_conv_to_date('digoal1234.tbl_20121202');</font></div><div><font size="2"   >&nbsp;mon_part_conv_to_date&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;2012-12-02</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >inherit_mon=&gt; select mon_part_conv_to_date('digoal1234.tbl_2012s12f0001');</font></div><div><font size="2"   >&nbsp;mon_part_conv_to_date&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;2012-12-01</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >inherit_mon=&gt; select mon_part_conv_to_date('digoal1234.tbl_2012s12f0002');</font></div><div><font size="2"   >&nbsp;mon_part_conv_to_date&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;2012-12-01</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >inherit_mon=&gt; select mon_part_conv_to_date('digoal20341221.tbl_2012s12f0002');<br> mon_part_conv_to_date <br>-----------------------<br> 2034-12-21<br>(1 row)<br><br>inherit_mon=&gt; select mon_part_conv_to_date('digoal20341241.tbl_2012s12f0002');<br> mon_part_conv_to_date <br>-----------------------<br> 2012-12-01<br>(1 row)</font></div><p></p></pre></div><div>适用于含 .*yyyy.*[mm].*[dd] 格式的表名转换.</div><div>其中mm和dd可选.</div><div>也就是说适合按年分表, 按月分表, 按日分表的表名转换.</div><div><br></div><div>方法2, 使用父表表名作为prefix, 将子表名的剩余部分的数字全部截取出来 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace function mon_part_conv_to_date(i_relname text, i_prefix text) returns date as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_len int;</font></div><div><font size="2"   >&nbsp; v_date text := '';</font></div><div><font size="2"   >&nbsp; i text := '';</font></div><div><font size="2"   >&nbsp; v_suffix text := '';</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; v_suffix := replace(i_relname,i_prefix,'');</font></div><div><font size="2"   >&nbsp; FOREACH i IN ARRAY regexp_split_to_array(v_suffix, '')</font></div><div><font size="2"   >&nbsp; loop</font></div><div><font size="2"   >&nbsp; &nbsp; if (i &gt;= '0' and i &lt;= '9') then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; v_date := v_date||i;</font></div><div><font size="2"   >&nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; end loop;</font></div><div><font size="2"   >&nbsp; v_len := length(v_date);</font></div><div><font size="2"   >&nbsp; -- the first 2str must 18,19,20,21,22</font></div><div><font size="2"   >&nbsp; if (substr(v_date,1,2) &gt;= '18' and substr(v_date,1,2) &lt;= '22' ) then</font></div><div><font size="2"   >&nbsp; &nbsp; if (v_len &gt;= 4 and v_len &lt;=8) then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; case v_len</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; when 4 then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return (v_date||'0101')::date;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; when 6 then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return (v_date||'01')::date;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; when 8 then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return v_date::date;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return '19700101'::date;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end case;</font></div><div><font size="2"   >&nbsp; &nbsp; else&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; -- not a valid date</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; return '22220101';</font></div><div><font size="2"   >&nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; -- not a valid date</font></div><div><font size="2"   >&nbsp; &nbsp; return '22220101';</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >exception when others then</font></div><div><font size="2"   >&nbsp; raise notice 'partition table name date format error.';</font></div><div><font size="2"   >&nbsp; return '19700101'::date;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql;</font></div><p></p></pre></div><div><br></div><div>【参考】</div><div>1.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020130433036377/"   >http://blog.163.com/digoal@126/blog/static/16387704020130433036377/</a></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL partition table name convert to data type - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>