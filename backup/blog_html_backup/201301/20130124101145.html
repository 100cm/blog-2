<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL performance speedup by avoid lock references tuple when add or update(new) Foreign Key's value.</h2>
	<h5 id="">2013-01-24 10:11:45&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020130249109133/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>PostgreSQL 将针对foreign key场景的一致性约束手段进行优化, 目前依赖对references表的对应行加RowShareLock锁保障一致性. 有几大的锁冲突弊端.&nbsp;</div><div>优化后将降低锁冲突, 除关联字段, 其他字段都不会产生冲突.</div><div>补丁如下 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="https://commitfest.postgresql.org/action/patch_view?id=987"  >https://commitfest.postgresql.org/action/patch_view?id=987</a></div><div>foreign key在很多场景中都有应用, 例如以下场景 :&nbsp;</div><div>课程表</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create table course (</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >cname name</font></div><div><font size="2"  >);</font></div><p></p></pre></div><div>学生信息表</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create table student (</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >sname name</font></div><div><font size="2"  >);</font></div><p></p></pre></div><div>选修表</div><div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >create table selective (</font></div><div style="line-height: 22px;"  ><font size="2"  >sid int references student(id),</font></div><div style="line-height: 22px;"  ><font size="2"  >cid int references course(id),</font></div><div style="line-height: 22px;"  ><font size="2"  >info text</font></div><div style="line-height: 22px;"  ><font size="2"  >);</font></div><p></p></pre></div></div><div style="line-height: 22px;"  >当新增1条选修记录时, 需要扫描课程表和学生信息表中是否有关联的id记录, 有则可以插入, 同时需要锁住课程表以及学生信息表的对应记录.</div><div style="line-height: 22px;"  >当更新选修表的sid或cid为一个新值是, 同样需要<span style="line-height: 22px;"  >扫描课程表或学生信息表中是否有关联的id记录, 有则可以更新, 同时需要锁住课程表以及学生信息表的对应记录.</span></div><div style="line-height: 22px;"  ><br></div><div>创建测试表 : &nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; CREATE TABLE A (</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; AID integer not null,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Col1 integer,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; PRIMARY KEY (AID)</font></div><div><font size="2"  >&nbsp; );</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; CREATE TABLE B (</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; BID integer not null,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; AID integer not null,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; Col2 integer,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; PRIMARY KEY (BID),</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; FOREIGN KEY (AID) REFERENCES A(AID)</font></div><div><font size="2"  >&nbsp; );</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >插入测试数据 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; INSERT INTO A (AID) VALUES (1),(2);</font></div><div><font size="2"  >&nbsp; INSERT INTO B (BID,AID) VALUES (2,1);</font></div><p></p></pre></div></div><div><br></div><div>创建pgrowlocks extension, 观察行锁.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# create extension pgrowlocks;</font></div><div><font size="2"  >CREATE EXTENSION</font></div><p></p></pre></div><div>测试 :&nbsp;</div><div>模拟B表新增记录, &nbsp;A表的对应行将加锁.</div><div>SESSION A:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 22px;"  >digoal</span>=# begin;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  ><span style="line-height: 22px;"  >digoal</span>=# insert into b (aid,bid) values (1,1);</font></div><div><font size="2"  >INSERT 0 1</font></div><p></p></pre></div><div><br></div><div>SESSION B:</div><div><pre class="prettyprint"  ><p><font size="2"  ><span style="line-height: 22px;"  >digoal</span><span style="line-height: 19px;"  >=# select * from pgrowlocks('b');</span><br></font></p><div><div><font size="2"  >&nbsp;locked_row | lock_type | locker | multi | xids | pids&nbsp;</font></div><div><font size="2"  >------------+-----------+--------+-------+------+------</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  ><span style="line-height: 22px;"  >digoal</span>=# select * from pgrowlocks('a');</font></div><div><font size="2"  >&nbsp;locked_row | lock_type | locker | multi | &nbsp;xids &nbsp;| &nbsp;pids &nbsp;</font></div><div><font size="2"  >------------+-----------+--------+-------+--------+--------</font></div><div><font size="2"  >&nbsp;(0,3) &nbsp; &nbsp; &nbsp;| Shared &nbsp; &nbsp;| &nbsp; 1755 | f &nbsp; &nbsp; | {1755} | {9126}</font></div><div><font size="2"  >(1 row)</font></div></div><div><div><font size="2"  >digoal=# select * from a where ctid='(0,3)';</font></div><div><font size="2"  >&nbsp;aid | col1&nbsp;</font></div><div><font size="2"  >-----+------</font></div><div><font size="2"  >&nbsp; &nbsp;1 | &nbsp; &nbsp;2</font></div><div><font size="2"  >(1 row)</font></div></div><div><span style="font-size: small; line-height: 19px;"  >此时无法修改A表对应的该行, 因为锁冲突.</span></div><div><font size="2"  >digoal=# update a set col1=22 where aid=1;</font></div><div><font size="2"  >等待锁...</font></div><div><span style="font-size: small; line-height: 19px;"  >-- 在Oracle 10G中测试并提交不需要等待. 说明Oracle已经处理了这个锁机制.</span></div><p></p></pre><p></p></div><div><br></div><div><span style="line-height: 22px;"  >模拟B表修改FK的内容为一个新值, &nbsp;A表的对应行将加锁.</span></div><div>SESSION A:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 22px;"  >digoal</span>=# begin;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  ><span style="line-height: 22px;"  >digoal</span>=# update b set aid=2 where aid&lt;&gt;2;</font></div><div><font size="2"  >UPDATE 3</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >SESSION B:</span></div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  ><span style="line-height: 22px;"  >digoal</span>=# select * from pgrowlocks('a');</font></div><div><font size="2"  >&nbsp;locked_row | lock_type | locker | multi | &nbsp;xids &nbsp;| &nbsp;pids &nbsp;</font></div><div><font size="2"  >------------+-----------+--------+-------+--------+--------</font></div><div><font size="2"  >&nbsp;(0,4) &nbsp; &nbsp; &nbsp;| Shared &nbsp; &nbsp;| &nbsp; 1757 | f &nbsp; &nbsp; | {1757} | {9126}</font></div><div><font size="2"  >(1 row)</font></div></div><div><div><font size="2"  ><span style="line-height: 22px;"  >digoal</span>=# select * from a where ctid='(0,4)';</font></div><div><font size="2"  >&nbsp;aid | col1&nbsp;</font></div><div><font size="2"  >-----+------</font></div><div><font size="2"  >&nbsp; &nbsp;2 | &nbsp; &nbsp;2</font></div><div><font size="2"  >(1 row)</font></div></div><div><font size="2"  >此时无法修改A表对应的该行</font><span style="line-height: 19px; font-size: small; font-family: Arial, Helvetica, sans-serif;"  >, 因为锁冲突.</span></div><div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal=# update a set col1=22 where aid=2;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >等待锁...</font></div></div><div><font size="2"  ><span style="line-height: 19px;"  >-- 在Oracle 10G中测试并提交不需要等待. 说明Oracle已经处理了这个锁机制.</span></font></div><p></p></pre></div><div><br><span style="line-height: 22px;"  >模拟B表修改FK的内容, 但是值不变, &nbsp;A表的对应行不会加锁.</span></div><div>SESSION A:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 22px;"  >digoal</span>=# begin;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  ><span style="line-height: 22px;"  >digoal</span>=# update b set aid=2 where aid=2;</font></div><div><font size="2"  >UPDATE 3</font></div><p></p></pre></div><div><br></div><div>SESSION B:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 22px;"  >digoal</span>=# select * from pgrowlocks('a');</font></div><div><font size="2"  >&nbsp;locked_row | lock_type | locker | multi | xids | pids&nbsp;</font></div><div><font size="2"  >------------+-----------+--------+-------+------+------</font></div><div><font size="2"  >(0 rows)</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"  >【小结</span><span style="line-height: 22px;"  >】</span></div><div>1. 目前Foreign Key的约束关系是通过对references table的相关tuple追加RowShareLock来实现的, 因此在新增B表记录或者更新B表的关联字段为新值时, &nbsp;A表的对应行也会被<span style="line-height: 22px;"  >追加RowShareLock</span><span style="line-height: 22px;"  >锁. 这个显然增加了A表的锁等待的几率, 降低了并行处理能力.</span></div><div><span style="line-height: 22px;"  >2. 因此对锁A表的整行改成不允许修改对应的相关字段值, 可以允许大部分A表的操作. 例如上面的例子A表修改col1的值应该是允许的。</span></div><div><span style="line-height: 22px;"  >&nbsp; &nbsp; 这样可以大大提高并行处理能力.</span></div><div><br></div>【参考】<div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://database-explorer.blogspot.hk/2013/01/reducing-contention-with-foreign-key.html"  >http://database-explorer.blogspot.hk/2013/01/reducing-contention-with-foreign-key.html</a><br>2.&nbsp;src/test/isolation/specs/fk-deadlock2.spec<wbr></div><div>3.&nbsp;src/backend/storage/lmgr/lmgr.c</div><div>4.&nbsp;src/include/storage/lock.h</div><div>5.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201210134586363/"  >http://blog.163.com/digoal@126/blog/static/163877040201210134586363/</a></div>6.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/explicit-locking.html"  >http://www.postgresql.org/docs/9.2/static/explicit-locking.html</a><br><div>7.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="https://commitfest.postgresql.org/action/patch_view?id=987"  >https://commitfest.postgresql.org/action/patch_view?id=987</a></div></div>
	</div>
</div>
</body>
</html>