<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL avoid rewrite table because extend column length - case</h2>
	<h5 id="">2013-01-07 16:01:35&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020130732537519/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>我们知道PostgreSQL 中给表的字段修改字段类型, 扩字段长度等操作可能会rewrite table(也就是重建表). 不同的版本是否需要rewrite表的触发条件不一样, 总的来说PostgreSQL 版本越高, 触发rewrite table的可能性越小. 具体参考版本的Release Notes.</div><div>下面将针对字段长度这个场景来规避一下rewrite table的可能性.</div><div>例如某个表的字段在使用一段时间后发现长度不够用了, 需要扩长度.&nbsp;</div><div>一般的做法是</div><div><pre class="prettyprint"  ><p><font size="2"  >ALTER [ COLUMN ] column_name [ SET DATA ] TYPE data_type</font></p></pre></div><div>这个版本较低的PostgreSQL 是会rewrite 表的.</div><div>要避免这个问题, 以字符串类型为例.&nbsp;</div><div>1. 设计表的时候选择较大的范围如当前可能只需要10的长度, 但是表结构中可以使用1000的长度, 或者使用text类型.</div><div>10的长度限制可以放在程序端控制. 或则使用check约束.</div><div>那么如果使用check约束的话, 会带来多少的性能影响呢?</div><div>下面举例说明一下 :&nbsp;</div><div><br></div><div>1. 数据库端不含约束的表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create table t1(info text);</font></div><div><font size="2"  >CREATE TABLE</font></div><p></p></pre></div><div><br></div><div>编辑pgbench测试脚本 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; cat t.sql</font></div><div><font size="2"  >insert into t1 values ('1234567890');</font></div><p></p></pre></div><div>测试结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -n -r -c 16 -j 4 -f ./t.sql -T 60 -h 127.0.0.1 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 16</font></div><div><font size="2"  >number of threads: 4</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 3816351</font></div><div><font size="2"  >tps = 63601.341725 (including connections establishing)</font></div><div><font size="2"  >tps = 63620.557482 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.249796 &nbsp; &nbsp; &nbsp; &nbsp;insert into t1 values ('1234567890');</font></div><p></p></pre></div><div><br></div><div><br></div><div>2. 创建<span style="line-height: 22px;"  >数据库端含约束的表 :&nbsp;</span></div><div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >digoal=&gt; create table t2(info text check (length(info)&lt;=10));</font></div><div style="line-height: 22px;"  ><font size="2"  >CREATE TABLE</font></div><p></p></pre></div></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >注意length(text)返回的是字符长度.&nbsp;</span></div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >PostgreSQL中varchar(10)指的也是10个字符.</font></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  >postgres=# select length('你好');</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp;length&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  >--------</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; &nbsp; 2</font></div><div style="line-height: 22px;"  ><font size="2"  >(1 row)</font></div></div><p></p></pre></div></div><div>编辑pgbench测试脚本 :&nbsp;</div><div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >ocz@db-172-16-3-150-&gt; cat t.sql</font></div><div style="line-height: 22px;"  ><font size="2"  >insert into t2 values ('1234567890');</font></div><p></p></pre></div></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >测试结果 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -n -r -c 16 -j 4 -f ./t.sql -T 60 -h 127.0.0.1 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 16</font></div><div><font size="2"  >number of threads: 4</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 3293606</font></div><div><font size="2"  >tps = 54889.130026 (including connections establishing)</font></div><div><font size="2"  >tps = 54905.454196 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.289670 &nbsp; &nbsp; &nbsp; &nbsp;insert into t2 values ('1234567890');</font></div><p></p></pre></div><div><br></div><div>使用length约束后, 插入性能下降13.7%.</div><div><br></div>【参考】<div>1.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201242485627235/"  >http://blog.163.com/digoal@126/blog/static/163877040201242485627235/</a><br><br><wbr></div></div>
	</div>
</div>
</body>
</html>