<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL varbit type used case : railway | train ticket sales</h2>
	<h5 id="">2013-01-22 11:03:37&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201302092558484/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div><div>在PostgreSQL 中可以使用varbit存储比特位, 下面模拟一个简单的应用场景.</div><div>马上春节了, 火车票又到了销售旺季, 一票难求依旧.</div><div>下面就以火车票销售为例来介绍一下PostgreSQL varbit类型的用法.</div><div>测试环境 :&nbsp;</div><div>PostgreSQL 9.2.1</div><div><br></div><div>测试表 :&nbsp;</div><div>列车信息表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create table train&nbsp;</font></div><div><font size="2"  >(id int primary key, --主键</font></div><div><font size="2"  >go_date date, -- 发车日期</font></div><div><font size="2"  >train_num name, -- 车次</font></div><div><font size="2"  >station text[]&nbsp;<span style="line-height: 22px;"  >-- 途径站点</span></font></div><div><font size="2"  >);&nbsp;</font></div><p></p></pre></div><div><br></div><div>车厢或bucket信息表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create table train_bucket&nbsp;</font></div><div><font size="2"  >(id int primary key, --主键</font></div><div><font size="2"  >tid int references train (id), -- 关联列车ID</font></div><div><font size="2"  >bno int, -- 车厢或bucket号</font></div><div><font size="2"  >sit_level text, -- 席别</font></div><div><font size="2"  >sit_cnt int, -- 该车厢或bucket的座位总数</font></div><div><font size="2"  >sit_remain int, -- 剩余座位</font></div><div><font size="2"  >sit_bit varbit -- 座位BIT位, 已售座位用1表示, 未售座位用0表示</font></div><div><font size="2"  >);</font></div><p></p></pre></div><div><br></div><div>位置信息表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create table train_sit&nbsp;</font></div><div><font size="2"  >(id serial8 primary key, -- 主键</font></div><div><font size="2"  >tid int references train (id), --关联列车ID</font></div><div><font size="2"  >tbid int references train_bucket(id), --关联bucket表ID</font></div><div><font size="2"  >sit_no int, &nbsp;-- 座位号, 来自train_bucket.sit_bit的位置信息.</font></div><div><font size="2"  >station_bit varbit &nbsp;-- 途径站点组成的BIT位信息, 已售站点用1表示, 未售站点用0表示.</font></div><div><font size="2"  >);</font></div><p></p></pre></div><div><br></div><div>创建索引 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create index idx_train_bucket_sit_remain on train_bucket(sit_remain) where sit_remain&gt;0;</font></div><div><font size="2"  >create index idx_train_sit_station_bit on train_sit (station_bit) where station_bit&lt;&gt;repeat('1', 13)::varbit;</font></div><p></p></pre></div><div><br></div><div>插入测试数据, 1趟火车, 途径14个站点.</div><div><pre class="prettyprint"  ><p><font size="2"  >insert into train values (1, '2013-01-20', 'D645', array['上海南','嘉兴','杭州南','诸暨','义乌','金华','衢州','上饶','鹰潭','新余','宜春','萍乡','株洲','长沙']);</font></p></pre></div><div>插入测试数据, 共计200W个车厢或bucket, 每个车厢98个位置.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >insert into train_bucket values (generate_series(1,1000000), 1, generate_series(1,1000000), '一等座', 98, 98, repeat('0',98)::varbit);</font></div><div><font size="2"  >insert into train_bucket values (generate_series(1000001,2000000), 1, generate_series(1000001,2000000), '二等座', 98, 98, repeat('0',98)::varbit);</font></div><p></p></pre></div><div><br></div><div>创建取数组中元素位置的函数 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><span style="line-height: 22px;"  ><font size="2"  >create or replace function array_pos (a anyarray, b anyelement) returns int as $$</font></span></div><div><font size="2"  >declare</font></div><div><font size="2"  >&nbsp; i int;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >&nbsp; for i in 1..array_length(a,1) loop</font></div><div><font size="2"  >&nbsp; &nbsp; if b=a[i] then</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; return i;</font></div><div><font size="2"  >&nbsp; &nbsp; end if;</font></div><div><font size="2"  >&nbsp; &nbsp; i := i+1;</font></div><div><font size="2"  >&nbsp; end loop;</font></div><div><font size="2"  >&nbsp; return null;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$ language plpgsql;</font></div><p></p></pre></div><div><br></div><div><br></div><div>创建购票函数 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function buy&nbsp;</font></div><div><font size="2"  >(</font></div><div><font size="2"  >inout i_train_num name,&nbsp;</font></div><div><font size="2"  >inout i_fstation text,&nbsp;</font></div><div><font size="2"  >inout i_tstation text,</font></div><div><font size="2"  >inout i_go_date date,</font></div><div><font size="2"  >out o_slevel text,</font></div><div><font size="2"  >out o_bucket_no int,</font></div><div><font size="2"  >out o_sit_no int,</font></div><div><font size="2"  >out o_order_status boolean</font></div><div><font size="2"  >)&nbsp;</font></div><div><font size="2"  >returns record as $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >&nbsp; curs1 refcursor;</font></div><div><font size="2"  >&nbsp; curs2 refcursor;</font></div><div><font size="2"  >&nbsp; v_row int;</font></div><div><font size="2"  >&nbsp; v_station text[];</font></div><div><font size="2"  >&nbsp; v_train_id int;</font></div><div><font size="2"  >&nbsp; v_train_bucket_id int;</font></div><div><font size="2"  >&nbsp; v_train_sit_id int;</font></div><div><font size="2"  >&nbsp; v_from_station_idx int;</font></div><div><font size="2"  >&nbsp; v_to_station_idx int;</font></div><div><font size="2"  >&nbsp; v_station_len int;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >&nbsp; set enable_seqscan=off;</font></div><div><font size="2"  >&nbsp; v_row := 0;</font></div><div><font size="2"  >&nbsp; o_order_status := false;</font></div><div><font size="2"  >&nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp; select array_length(station,1), station, id, array_pos(station, i_fstation), array_pos(station, i_tstation)&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; into v_station_len, v_station, v_train_id, v_from_station_idx, v_to_station_idx&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; from train where train_num=i_train_num and go_date = i_go_date;</font></div><div><font size="2"  >&nbsp; if ( found and array_pos(v_station, i_fstation) is not null&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;and array_pos(v_station, i_tstation) is not null&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;and array_pos(v_station, i_fstation) &lt; array_pos(v_station, i_tstation)&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;) then</font></div><div><font size="2"  >&nbsp; else</font></div><div><font size="2"  >&nbsp; &nbsp; o_order_status := false;</font></div><div><font size="2"  >&nbsp; &nbsp; return;</font></div><div><font size="2"  >&nbsp; end if;</font></div><div><font size="2"  >&nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp; open curs2 for select tid,tbid,sit_no from train_sit</font></div><div><font size="2"  >&nbsp; &nbsp; where (station_bit &amp; bitsetvarbit(repeat('0', v_station_len-1)::varbit, v_from_station_idx-1, v_to_station_idx-v_from_station_idx, 1)) = repeat('0', v_station_len-1)::varbit&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; and station_bit &lt;&gt; repeat('1', v_station_len-1)::varbit</font></div><div><font size="2"  >&nbsp; &nbsp; -- and ctid not in (select locked_row from pgrowlocks('train_sit')) -- 耗时约300毫秒, 用它来解决热点锁等待不划算.</font></div><div><font size="2"  >&nbsp; &nbsp; limit 1</font></div><div><font size="2"  >&nbsp; &nbsp; for update nowait; -- 也可不加nowait, 加了的话如果获取锁失败将返回<span style="line-height: 19px;"  >55P03异常, 需要程序重新提交</span></font></div><div><font size="2"  >&nbsp; loop</font></div><div><font size="2"  >&nbsp; &nbsp; fetch curs2 into v_train_id,v_train_bucket_id,o_sit_no;</font></div><div><font size="2"  >&nbsp; &nbsp; if found then</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; update train_sit set station_bit=bitsetvarbit(station_bit, v_from_station_idx-1, v_to_station_idx-v_from_station_idx, 1)&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; where current of curs2;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; GET DIAGNOSTICS v_row = ROW_COUNT;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; if (v_row = 1) then</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; select sit_level, bno into o_slevel, o_bucket_no from train_bucket where id=v_train_bucket_id;</font></div><div><font size="2"  ><span> </span>close curs2;</font></div><div><font size="2"  ><span> </span>o_order_status := true;</font></div><div><font size="2"  ><span> </span>return;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; end if;</font></div><div><font size="2"  >&nbsp; &nbsp; else&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; close curs2;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; exit;</font></div><div><font size="2"  >&nbsp; &nbsp; end if;</font></div><div><font size="2"  >&nbsp; end loop;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; v_row := 0;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; open curs1 for select id, tid, strpos(sit_bit::text,'0'), sit_level, bno from train_bucket&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; where sit_remain&gt;0</font></div><div><font size="2"  >&nbsp; &nbsp; -- and ctid not in (select locked_row from pgrowlocks('train_bucket')) -- 耗时约300毫秒, 用它来解决热点锁等待不划算.</font></div><div><font size="2"  >&nbsp; &nbsp; limit 1&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; for update </font><span style="font-family: Arial, Helvetica, sans-serif; font-size: small; line-height: 19px;"  >nowait; -- 也可不加nowait, 加了的话如果获取锁失败将返回</span><span style="font-family: Arial, Helvetica, sans-serif; line-height: 19px; font-size: small;"  >55P03异常, 需要程序重新提交.</span></div><div><font size="2"  >&nbsp; loop</font></div><div><font size="2"  >&nbsp; &nbsp; fetch curs1 into v_train_bucket_id, v_train_id, o_sit_no, o_slevel, o_bucket_no;</font></div><div><font size="2"  >&nbsp; &nbsp; if found then</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; update train_bucket set sit_bit = set_bit(sit_bit, strpos(sit_bit::text,'0')-1, 1), sit_remain = sit_remain-1</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; where current of curs1;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; GET DIAGNOSTICS v_row = ROW_COUNT;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; if (v_row = 1) then</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; close curs1;</font></div><div><font size="2"  ><span> </span>exit;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; end if;</font></div><div><font size="2"  >&nbsp; &nbsp; else&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; close curs1;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; exit;</font></div><div><font size="2"  >&nbsp; &nbsp; end if;</font></div><div><font size="2"  >&nbsp; end loop;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; if v_row = 1 then</font></div><div><font size="2"  >&nbsp; &nbsp; insert into train_sit(tid,tbid,sit_no,station_bit)</font></div><div><font size="2"  >&nbsp; &nbsp; values (</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; v_train_id,&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; v_train_bucket_id,&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; o_sit_no,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; bitsetvarbit(repeat('0', v_station_len-1)::varbit, v_from_station_idx-1, v_to_station_idx-v_from_station_idx, 1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; );</font></div><div><font size="2"  >&nbsp; &nbsp; o_order_status := true;</font></div><div><font size="2"  >&nbsp; &nbsp; return;</font></div><div><font size="2"  >&nbsp; else</font></div><div><font size="2"  >&nbsp; &nbsp; o_order_status := false;</font></div><div><font size="2"  >&nbsp; &nbsp; return;</font></div><div><font size="2"  >&nbsp; end if;</font></div><div><font size="2"  >&nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp; exception&nbsp;</font></div><div><font size="2"  >&nbsp; when others then</font></div><div><font size="2"  >&nbsp; &nbsp; </font><span style="font-size: small; line-height: 19px;"  >o_order_status </span><font size="2"  >:= false;</font></div><div><font size="2"  >&nbsp; &nbsp; return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$ language plpgsql;</font></div><p></p></pre></div></div><div><br></div><div>测试 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select * from buy('D645','杭州南','宜春','2013-01-20');</font></div><div><font size="2"  >&nbsp;i_train_num | i_fstation | i_tstation | i_go_date &nbsp;| o_slevel | o_bucket_no | o_sit_no | o_order_status&nbsp;</font></div><div><font size="2"  >-------------+------------+------------+------------+----------+-------------+----------+----------------</font></div><div><font size="2"  >&nbsp;D645 &nbsp; &nbsp; &nbsp; &nbsp;| 杭州南 &nbsp; &nbsp; | 宜春 &nbsp; &nbsp; &nbsp; | 2013-01-20 | 一等座 &nbsp; | &nbsp; &nbsp; &nbsp; 35356 | &nbsp; &nbsp; &nbsp; &nbsp;9 | t</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>【压力测试】</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >vi test.sql</font></div><div><font size="2"  >select * from buy('D645','上海南','长沙','2013-01-20');</font></div><p></p></pre></div><div>不加nowait测试结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./test.sql -n -r -c 16 -j 8 -T 1200 -U postgres digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 16</font></div><div><font size="2"  >number of threads: 8</font></div><div><font size="2"  >duration: 1200 s</font></div><div><font size="2"  >number of transactions actually processed: 2197407</font></div><div><font size="2"  >tps = 1831.143708 (including connections establishing)</font></div><div><font size="2"  >tps = 1831.169308 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 8.734424 &nbsp; &nbsp; &nbsp; &nbsp;select * from buy('D645','上海南','长沙','2013-01-20');</font></div><p></p></pre></div><div>加nowait测试结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./test.sql -n -r -c 16 -j 16 -T 12 -U postgres digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 16</font></div><div><font size="2"  >number of threads: 16</font></div><div><font size="2"  >duration: 12 s</font></div><div><font size="2"  >number of transactions actually processed: 93632</font></div><div><font size="2"  >tps = 7800.056248 (including connections establishing)</font></div><div><font size="2"  >tps = 7818.803904 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 2.042862 &nbsp; &nbsp; &nbsp; &nbsp;select * from buy('D645','上海南','长沙','2013-01-20');</font></div><p></p></pre></div><div><br></div><div>【小结】</div></div><div><div>1. 需要解决更新热点, 降低等待, 提高并行处理几率.&nbsp;</div><div>&nbsp; &nbsp; 本例的热点在 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >update train_bucket set sit_bit = set_bit(sit_bit, strpos(sit_bit::text,'0')-1, 1), sit_remain = sit_remain-1</font></div><div><font size="2"  >&nbsp; &nbsp;where current of curs1;</font></div></div><div><font size="2"  >以及</font></div><div><div><font size="2"  >&nbsp;update train_sit set station_bit=bitsetvarbit(station_bit, v_from_station_idx-1, v_to_station_idx-v_from_station_idx, 1)&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; where current of curs2;</font></div></div><p></p></pre></div><div>对应的游标 &nbsp;:</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >&nbsp; open curs2 for select tid,tbid,sit_no from train_sit</font></div><div><font size="2"  >&nbsp; &nbsp; where (station_bit &amp; bitsetvarbit(repeat('0', v_station_len-1)::varbit, v_from_station_idx-1, v_to_station_idx-v_from_station_idx, 1)) = repeat('0', v_station_len-1)::varbit&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; and station_bit &lt;&gt; repeat('1', v_station_len-1)::varbit</font></div><div><font size="2"  >&nbsp; &nbsp; -- and ctid not in (select locked_row from pgrowlocks('train_sit')) -- 耗时约300毫秒, 用它来解决热点锁等待不划算.</font></div><div><font size="2"  >&nbsp; &nbsp; limit 1</font></div><div><font size="2"  >&nbsp; &nbsp; for update;</font></div></div><div><font size="2"  >以及</font></div><div><div><font size="2"  >&nbsp; open curs1 for select id, tid, strpos(sit_bit::text,'0'), sit_level, bno from train_bucket&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; where sit_remain&gt;0</font></div><div><font size="2"  >&nbsp; &nbsp; -- and ctid not in (select locked_row from pgrowlocks('train_bucket')) -- 耗时约300毫秒, 用它来解决热点锁等待不划算.</font></div><div><font size="2"  >&nbsp; &nbsp; limit 1&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; for update;</font></div></div><p></p></pre></div><div>解决的关键在这里.</div><div>如果不能解决热点的问题, 那就提高处理速度, 精简字段数量和长度, 精简索引. 提高更新速度.</div><div><br></div><div>2. 减少数据扫描的量.</div></div><div><span style="line-height: 22px;"  >&nbsp; &nbsp; partial index, 避免满座车厢的扫描, 以及全程占位位子的扫描.</span></div><div><span style="line-height: 22px;"  ><br></span></div><div>3. 先查bucket 是否空闲, 再查sit是否空闲.&nbsp;</div><div><br></div><div>4. 还需要考虑优先级的问题 :&nbsp;</div><div>例如有111000和111100两个位子, 如果请求要最后两个站的票, 应该优先匹配111100, 这样更不容易浪费。如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >111000 | 000011 = 111011</font></div><div><font size="2"  >111100 | 000011 = 111111</font></div><p></p></pre></div><div><br></div><div>【参考】</div><div><span style="line-height: 22px;"  >1. setbitvarbit</span></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201302192427651/"  >http://blog.163.com/digoal@126/blog/static/163877040201302192427651/</a></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">francs - 2013-01-22 16:02:10</h5>
				<div>有意思，模拟下抢票吧，得做牛B的方案了。<br><br></div>
			</div>
	</div>
</div>
</body>
</html>