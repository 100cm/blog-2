<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">reduce PostgreSQL pg_xlog full page writes</h2>
	<h5 id="">2013-01-15 14:31:56&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201301522423261/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">pg_xlog 是 PostgreSQL 可靠性的保证.<div>今天群里的兄弟聊到归档文件颇多, 如何减少的问题.</div><div>简单的方法是通过调整shared_buffer, checkpoint间隔. &nbsp;</div><div>如下 :&nbsp;</div><div>【场景1】 :&nbsp;</div><div><div><span style="line-height: 22px;"   >vi postgresql.conf</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >shared_buffers = 32MB</font></div><div><font size="2"   >checkpoint_segments = 3&nbsp;</font></div><div><font size="2"   >checkpoint_timeout = 1min</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >重启数据库.</span></div><div><span style="line-height: 22px;"   >创建测试表 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >digoal=&gt; create table test (id int primary key, info text);</font></span></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "test_pkey" for table "test"</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=&gt; insert into test select generate_series(1,1000000),'DIGOAL';</font></div><div><font size="2"   >INSERT 0 1000000</font></div><p></p></pre></div><div>创建检查点 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><p></p></pre></div><div>记下当前的xlog位置.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;96E8/6ABEB740</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>pgbench脚本 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; cat test.sql</font></div><div><font size="2"   >\setrandom id 1 1000000</font></div><div><font size="2"   >update test set info=clock_timestamp()::text where id=:id;</font></div><p></p></pre></div><div>pgbench测试, 处理80万更新事务 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 8 -j 4 -t 100000 -U digoal digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >number of transactions per client: 100000</font></div><div><font size="2"   >number of transactions actually processed: 800000/800000</font></div><div><font size="2"   >tps = 4833.566032 (including connections establishing)</font></div><div><font size="2"   >tps = 4833.864802 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002287 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 1000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.640042 &nbsp; &nbsp; &nbsp; &nbsp;update test set info=clock_timestamp()::text where id=:id;</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >测试完后创建检查点, 并查看当前的xlog位置 :&nbsp;</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 22px;"   ><font size="2"   >postgres=# checkpoint;</font></div><div style="line-height: 22px;"   ><font size="2"   >CHECKPOINT</font></div></div><div><span style="line-height: 22px;"   ><font size="2"   >digoal=# select pg_current_xlog_location();</font></span></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;96E9/1E7DAF50</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div><span style="line-height: 22px;"   >计算历经了多少的XLOG数据, 如下</span><span style="line-height: 22px;"   >2860MB.</span><span style="line-height: 22px;"   >&nbsp;:&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select pg_xlog_location_diff('96E9/1E7DAF50', '96E8/6ABEB740')/1024/1024;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;?column? &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;2859.9355621337890625</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>【场景2】</div><div>vi $PGDATA/postgresql.conf</div><div>修改以下三个参数的值 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >shared_buffers = 4096MB</font></div><div><font size="2"   >checkpoint_segments = 256</font></div><div><font size="2"   >checkpoint_timeout = 5min</font></div><p></p></pre></div><div>xlog文件大小16MB, shared_buffers=4096MB, checkpoint_segments=shared_buffers/xlog文件大小=256;</div><div>这几个参数需要配合调节.</div><div><br></div><div>重启数据库 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; pg_ctl stop -m fast</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div><div><font size="2"   >ocz@db-172-16-3-150-&gt; pg_ctl start</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >ocz@db-172-16-3-150-&gt; LOG: &nbsp;00000: loaded library "pg_stat_statements"</font></div><div><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1249</font></div><p></p></pre></div><div><br></div><div>创建检查点, 记录当前的xlog位置:&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><span style="line-height: 22px;"   ><font size="2"   >postgres=# checkpoint;</font></span></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >postgres=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;96E9/25FE5558</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"   >pgbench测试, 处理80万更新事务 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 8 -j 4 -t 100000 -U digoal digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >number of transactions per client: 100000</font></div><div><font size="2"   >number of transactions actually processed: 800000/800000</font></div><div><font size="2"   >tps = 35387.346131 (including connections establishing)</font></div><div><font size="2"   >tps = 35405.115679 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002269 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 1000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.202819 &nbsp; &nbsp; &nbsp; &nbsp;update test set info=clock_timestamp()::text where id=:id;</font></div><p></p></pre></div><div><br></div><div>测完后, 创建检查点并记录当前的xlog位置 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >postgres=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;96E9/35B5FB80</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>计算历经了多少的xlog, 如下251MB.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select pg_xlog_location_diff('96E9/35B5FB80', '96E9/25FE5558')/1024/1024;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;?column? &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;251.4780654907226563</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>执行同样的事务量, xlog从2860MB下降到251MB.</div><div><br></div><div>【小结】</div><div>1. 通过减少block_size的大小也是方法之一, 当然效果没有以上的方法明显. 并且程序编译完后就没有办法修改了.</div><div>2. 检查点的间隔太长虽然减少了xlog的产生, 但是如果数据库异常关闭(-m immediate)或者服务器异常导致服务器异常关闭后, 在数据库启动时需要recovery, 这个过程也会拉长. 因为要应用更多的变更.&nbsp;</div><div><br></div><div>【参考】</div><div>1.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/wal-configuration.html"   >http://www.postgresql.org/docs/9.2/static/wal-configuration.html</a></div><div>为什么调了这几个参数能减少xlog的量, 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >If full_page_writes is set (as is the default), there is another factor to consider. To ensure data page consistency, the first modification of a data page after each checkpoint results in logging the entire page content.&nbsp;</font></span></div><div><font size="2"   >In that case, a smaller checkpoint interval increases the volume of output to the WAL log, partially negating the goal of using a smaller interval, and in any case causing more disk I/O.</font></div></pre></div></div></div>
	</div>
</div>
</body>
</html>