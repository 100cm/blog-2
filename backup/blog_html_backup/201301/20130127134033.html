<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 will add pg_isready script to test PostgreSQL server if allowed to connect</h2>
	<h5 id="">2013-01-27 13:40:33&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201302714527/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>使用过Oracle数据库的朋友大概对tnsping有过了解, 它是Oracle用来测试数据库tnsnames.ora配置项连通性的工具之一.</div><div>PostgreSQL 9.3将要加入这样一个客户端, 名为pg_idready.</div><div>也是用于检测数据库的连通性, 参数如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal@db-172-16-3-150-&gt; pg_isready --help</font></div><div><font size="2"   >pg_isready issues a connection check to a PostgreSQL database.</font></div><div><span style="line-height: 22px;"   ><font size="2"   ><br></font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >Usage:</font></span></div><div><font size="2"   >&nbsp; pg_isready [OPTION]...</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Options:</font></div><div><font size="2"   >&nbsp; -d, --dbname=DBNAME &nbsp; &nbsp; &nbsp;database name</font></div><div><font size="2"   >&nbsp; -q, --quiet &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;run quietly</font></div><div><font size="2"   >&nbsp; -V, --version &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;output version information, then exit</font></div><div><font size="2"   >&nbsp; -?, --help &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; show this help, then exit</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Connection options:</font></div><div><font size="2"   >&nbsp; -h, --host=HOSTNAME &nbsp; &nbsp; &nbsp;database server host or socket directory</font></div><div><font size="2"   >&nbsp; -p, --port=PORT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;database server port</font></div><div><font size="2"   >&nbsp; -t, --timeout=SECS &nbsp; &nbsp; &nbsp; seconds to wait when attempting connection, 0 disables (default: 3)</font></div><div><font size="2"   >&nbsp; -U, --username=USERNAME &nbsp;database username</font></div><div><span style="line-height: 22px;"   ><font size="2"   >Report bugs to &lt;pgsql-bugs@postgresql.org&gt;.</font></span></div><p></p></pre></div><div><span style="line-height: 22px;"   >-d 和 -U参数目前没有实际的用处, 只需要-h 和-p就够了.</span></div><div><br></div><div>一般我们在启动PostgreSQL后会看到这样一条日志 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >2013-01-27 12:50:27.494 CST,,,2574,,5104b213.0a0e,1,,2013-01-27 12:50:27 CST,,0,LOG,00000,"database system is ready to accept connections",,,,,,,,,""</font></p></pre></div><div>这可能也是pg_isready命名的由来.</div><div><br></div><div>pg_isready的返回值如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >EXIT STATUS</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;pg_isready returns 0 to the shell if the server is accepting connections normally, 1 if the server is rejecting</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;connections (for example during startup), 2 if there was no response to the connection attempt, and 3 if no</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;attempt was made (for example due to invalid parameters).</font></div><p></p></pre></div><div><br></div><div>【测试】</div><div>1. 测试正常启动的数据库</div><div><pre class="prettyprint"   ><p></p><div><div><font face="Arial, Helvetica, sans-serif"   size="2"   ><span style="line-height: 19px;"   >digoal</span></font><font size="2"   >@db-172-16-3-150-&gt; pg_isready -h 127.0.0.1 -p 9300</font></div><div><font size="2"   >127.0.0.1:9300 - accepting connections</font></div><div><span style="line-height: 19px; font-size: small; font-family: Arial, Helvetica, sans-serif;"   >digoal</span><font size="2"   >@db-172-16-3-150-&gt; echo $?</font></div><div><font size="2"   >0</font></div></div><div><font size="2"   >返回值为0</font></div><p></p></pre></div><div><br></div><div>2. 测试, 修改pg_hba.conf 禁止连接.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi $PGDATA/pg_hba.conf</font></div><div><font size="2"   >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;reject</font></div><div><font size="2"   >pg_ctl reload</font></div><div><div><font size="2"   ><span style="line-height: 19px;"   >digoal</span>@db-172-16-3-150-&gt; pg_isready -h 127.0.0.1 -p 9300</font></div><div><font size="2"   >127.0.0.1:9300 - accepting connections</font></div><div><font size="2"   ><span style="line-height: 19px;"   >digoal</span>@db-172-16-3-150-&gt; echo $?</font></div><div><font size="2"   >0</font></div></div><div><font size="2"   ><span style="line-height: 22px;"   >返回值为0, 和pg_hba.conf的配置无关. 因为pg_isready使用的是</span><span style="line-height: 19px;"   >PQconnectStartParams.</span></font></div><p></p></pre></div><div><span style="line-height: 22px;"   ><br></span></div><div>3. 测试其他服务端口, 例如sshd监听端口<br><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   ><span style="line-height: 19px;"   >digoal</span>@db-172-16-3-150-&gt; netstat -anp|grep 22</font></div><div><font size="2"   >(Not all processes could be identified, non-owned process info</font></div><div><font size="2"   >&nbsp;will not be shown, you would have to be root to see it all.)</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:22 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;-&nbsp;</font></div></div><div><div><font size="2"   ><span style="line-height: 19px;"   >digoal</span>@db-172-16-3-150-&gt; pg_isready -h 127.0.0.1 -p 22</font></div><div><font size="2"   >127.0.0.1:22 - no response</font></div><div><font size="2"   ><span style="line-height: 19px;"   >digoal</span>@db-172-16-3-150-&gt; echo $?</font></div><div><font size="2"   >2</font></div></div><p></p></pre></div></div><div><br></div><div>4. 测试无监听的端口</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >digoal</span>@db-172-16-3-150-&gt; netstat -anp|grep 1234</font></div><div><font size="2"   >(Not all processes could be identified, non-owned process info</font></div><div><font size="2"   >&nbsp;will not be shown, you would have to be root to see it all.)</font></div><div><font size="2"   ><span style="line-height: 19px;"   >digoal</span>@db-172-16-3-150-&gt; pg_isready -h 127.0.0.1 -p 1234</font></div><div><font size="2"   >127.0.0.1:1234 - no response</font></div><div><font size="2"   ><span style="line-height: 19px;"   >digoal</span>@db-172-16-3-150-&gt; echo $?</font></div><div><font size="2"   >2</font></div><p></p></pre></div><div><br></div><div>5. 测试数据库恢复中的情况</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >当数据库处于恢复状态, 日志输出如下时 :&nbsp;</font></div><div><font size="2"   >2013-01-27 13:34:19.657 CST,"postgres","",3892,"127.0.0.1:49691",5104bc5b.0f34,1,"",2013-01-27 13:34:19 CST,,0,FATAL,57P03,"the database system is starting up",,,,,,,,,""</font></div><div><font size="2"   >pg_isready的返回值是1. 拒绝连接.</font></div><div><div><font size="2"   ><span style="line-height: 19px;"   >digoal</span>@db-172-16-3-150-&gt; pg_isready -h 127.0.0.1 -p 9300</font></div><div><font size="2"   >127.0.0.1:9300 - rejecting connections</font></div><div><font size="2"   ><span style="line-height: 19px;"   >digoal</span>@db-172-16-3-150-&gt; echo $?</font></div><div><font size="2"   >1</font></div></div><p></p></pre></div><div><br></div><div>【小结】</div><div>1. pg_isready和pg_hba.conf的配置无关.&nbsp;</div><div>2. pg_isready目前还仅仅局限于端口和IP的参数可用. 不支持用户以及数据库. 因为不涉及到认证的环节.</div><div>3. pg_isready需要SERVER返回SQLSTATE, 所以并不是所有版本的数据库都适用, 7.4以前的版本可能会遇到问题, (代码注释里面提到的, 我这里没有测试过).</div><div><br></div>【参考】<wbr><div>1.&nbsp;src/interfaces/libpq/fe-connect.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PQpingParams</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* check server status, accepting parameters identical to PQconnectdbParams</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >PGPing</font></div><div><font size="2"   >PQpingParams(const char *const * keywords,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;const char *const * values,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int expand_dbname)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PGconn &nbsp; &nbsp; *conn = PQconnectStartParams(keywords, values, expand_dbname);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PGPing &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ret;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ret = internal_ping(conn);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PQfinish(conn);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return ret;</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* internal_ping</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Determine if a server is running and if we can connect to it.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* The argument is a connection that's been started, but not completed.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static PGPing</font></div><div><font size="2"   >internal_ping(PGconn *conn)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Say "no attempt" if we never got to PQconnectPoll */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!conn || !conn-&gt;options_valid)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return PQPING_NO_ATTEMPT;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Attempt to complete the connection */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (conn-&gt;status != CONNECTION_BAD)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (void) connectDBComplete(conn);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Definitely OK if we succeeded */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (conn-&gt;status != CONNECTION_BAD)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return PQPING_OK;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Here begins the interesting part of "ping": determine the cause of the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* failure in sufficient detail to decide what to return. &nbsp;We do not want</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* to report that the server is not up just because we didn't have a valid</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* password, for example. &nbsp;In fact, any sort of authentication request</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* implies the server is up. &nbsp;(We need this check since the libpq side of</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* things might have pulled the plug on the connection before getting an</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* error as such from the postmaster.)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (conn-&gt;auth_req_received)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return PQPING_OK;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* If we failed to get any ERROR response from the postmaster, report</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* PQPING_NO_RESPONSE. &nbsp;This result could be somewhat misleading for a</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* pre-7.4 server, since it won't send back a SQLSTATE, but those are long</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* out of support. &nbsp; &nbsp; &nbsp;Another corner case where the server could return a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* failure without a SQLSTATE is fork failure, but NO_RESPONSE isn't</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* totally unreasonable for that anyway. &nbsp;We expect that every other</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* failure case in a modern server will produce a report with a SQLSTATE.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* NOTE: whenever we get around to making libpq generate SQLSTATEs for</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* client-side errors, we should either not store those into</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* last_sqlstate, or add an extra flag so we can tell client-side errors</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* apart from server-side ones.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (strlen(conn-&gt;last_sqlstate) != 5)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return PQPING_NO_RESPONSE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Report PQPING_REJECT if server says it's not accepting connections. (We</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* distinguish this case mainly for the convenience of pg_ctl.)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (strcmp(conn-&gt;last_sqlstate, ERRCODE_CANNOT_CONNECT_NOW) == 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return PQPING_REJECT;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Any other SQLSTATE can be taken to indicate that the server is up.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Presumably it didn't like our username, password, or database name; or</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* perhaps it had some transient failure, but that should not be taken as</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* meaning "it's down".</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return PQPING_OK;</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PQconnectStartParams</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Begins the establishment of a connection to a postgres backend through the</font></div><div><font size="2"   >&nbsp;* postmaster using connection information in a struct.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* See comment for PQconnectdbParams for the definition of the string format.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Returns a PGconn*. &nbsp;If NULL is returned, a malloc error has occurred, and</font></div><div><font size="2"   >&nbsp;* you should not attempt to proceed with this connection. &nbsp; &nbsp; &nbsp;If the status</font></div><div><font size="2"   >&nbsp;* field of the connection returned is CONNECTION_BAD, an error has</font></div><div><font size="2"   >&nbsp;* occurred. In this case you should call PQfinish on the result, (perhaps</font></div><div><font size="2"   >&nbsp;* inspecting the error message first). &nbsp;Other fields of the structure may not</font></div><div><font size="2"   >&nbsp;* be valid if that occurs. &nbsp;If the status field is not CONNECTION_BAD, then</font></div><div><font size="2"   >&nbsp;* this stage has succeeded - call PQconnectPoll, using select(2) to see when</font></div><div><font size="2"   >&nbsp;* this is necessary.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* See PQconnectPoll for more info.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >PGconn *</font></div><div><font size="2"   >PQconnectStartParams(const char *const * keywords,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;const char *const * values,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int expand_dbname)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PGconn &nbsp; &nbsp; *conn;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PQconninfoOption *connOptions;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Allocate memory for the conn structure</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; conn = makeEmptyPGconn();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (conn == NULL)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Parse the conninfo arrays</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; connOptions = conninfo_array_parse(keywords, values,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;conn-&gt;errorMessage,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;true, expand_dbname);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (connOptions == NULL)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; conn-&gt;status = CONNECTION_BAD;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* errorMessage is already set */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return conn;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Move option values into conn structure</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fillPGconn(conn, connOptions);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Free the option info - all is in conn now</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PQconninfoFree(connOptions);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Compute derived options</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!connectOptions2(conn))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return conn;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Connect to the database</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!connectDBStart(conn))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Just in case we failed to set it in connectDBStart */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; conn-&gt;status = CONNECTION_BAD;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return conn;</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div><br></div><div>2.&nbsp;src/bin/scripts/pg_isready.c</div><div><pre class="prettyprint"   ><p><font size="2"   >PQpingParams(keywords, values, 1);</font></p></pre></div><div><br></div><div>3. man pg_isready</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >EXIT STATUS</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;pg_isready returns 0 to the shell if the server is accepting connections normally, 1 if the server is rejecting</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;connections (for example during startup), 2 if there was no response to the connection attempt, and 3 if no</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;attempt was made (for example due to invalid parameters).</font></div><p></p></pre></div><div><br></div><div>4.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://docs.oracle.com/cd/E11882_01/network.112/e10836/connect.htm"   >http://docs.oracle.com/cd/E11882_01/network.112/e10836/connect.htm</a></div>5.&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/devel/static/app-pg-isready.html"   >http://www.postgresql.org/docs/devel/static/app-pg-isready.html</a></div>
	</div>
</div>
</body>
</html>