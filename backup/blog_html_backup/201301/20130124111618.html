<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL file text array fdw used for unpredictable columns of text file.</h2>
	<h5 id="">2013-01-24 11:16:18&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201302410511382/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>这里要说的是file_text_array_fdw, Andrew开发的插件.</div><div>主要是解决file_fdw的局限性, file_fdw针对固定格式的文本, 创建外部表时需要为每个列指定数据类型.</div><div><br></div><div>file_text_array_fdw使用text数组存储行信息, 所以即使每行可能存在无固定长度的文本也适用.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >CREATE FOREIGN TABLE pglog (</font></div><div><font size="2"  >&nbsp; log_time timestamp(3) with time zone,</font></div><div><font size="2"  >&nbsp; user_name text,</font></div><div><font size="2"  >&nbsp; database_name text,</font></div><div><font size="2"  >&nbsp; process_id integer,</font></div><div><font size="2"  >&nbsp; connection_from text,</font></div><div><font size="2"  >&nbsp; session_id text,</font></div><div><font size="2"  >&nbsp; session_line_num bigint,</font></div><div><font size="2"  >&nbsp; command_tag text,</font></div><div><font size="2"  >&nbsp; session_start_time timestamp with time zone,</font></div><div><font size="2"  >&nbsp; virtual_transaction_id text,</font></div><div><font size="2"  >&nbsp; transaction_id bigint,</font></div><div><font size="2"  >&nbsp; error_severity text,</font></div><div><font size="2"  >&nbsp; sql_state_code text,</font></div><div><font size="2"  >&nbsp; message text,</font></div><div><font size="2"  >&nbsp; detail text,</font></div><div><font size="2"  >&nbsp; hint text,</font></div><div><font size="2"  >&nbsp; internal_query text,</font></div><div><font size="2"  >&nbsp; internal_query_pos integer,</font></div><div><font size="2"  >&nbsp; context text,</font></div><div><font size="2"  >&nbsp; query text,</font></div><div><font size="2"  >&nbsp; query_pos integer,</font></div><div><font size="2"  >&nbsp; location text,</font></div><div><font size="2"  >&nbsp; application_name text</font></div><div><font size="2"  >) SERVER pglog</font></div><div><font size="2"  >OPTIONS ( filename '/home/josh/9.1/data/pg_log/pglog.csv', format 'csv' );</font></div><p></p></pre></div><div><br></div><div>测试<span style="line-height: 22px;"  >file_text_array_fdw-master :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >root@db-172-16-3-150-&gt; unzip file_text_array_fdw-master.zip&nbsp;</font></div><div><font size="2"  >root@db-172-16-3-150-&gt;&nbsp;mv file_text_array_fdw-master /home/pgdev/postgresql-9.3devel/contrib/</font></div><div><div><font size="2"  >root@db-172-16-3-150-&gt; gmake clean</font></div><div><font size="2"  >rm -f file_textarray_fdw.so file_textarray_fdw.o</font></div><div><font size="2"  >rm -rf sql/file_textarray_fdw.sql expected/file_textarray_fdw.out</font></div><div><font size="2"  >rm -rf results/ regression.diffs regression.out tmp_check/ log/</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >root@db-172-16-3-150-&gt; gmake</font></div><div><font size="2"  >cp file_textarray_fdw.sql file_textarray_fdw--1.0.1.sql</font></div><div><font size="2"  >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -g -fpic -I. -I. -I../../src/include -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o file_textarray_fdw.o file_textarray_fdw.c</font></div><div><font size="2"  >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -g -fpic -L../../src/port &nbsp;-Wl,-rpath,'/home/pgdev/pgsql9.3/lib',--enable-new-dtags &nbsp;-shared -o file_textarray_fdw.so file_textarray_fdw.o</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >root@db-172-16-3-150-&gt; gmake install</font></div><div><font size="2"  >/bin/mkdir -p '/home/pgdev/pgsql9.3/share/extension'</font></div><div><font size="2"  >/bin/mkdir -p '/home/pgdev/pgsql9.3/share/extension'</font></div><div><font size="2"  >/bin/mkdir -p '/home/pgdev/pgsql9.3/lib'</font></div><div><font size="2"  >/usr/bin/install -c -m 644 ./file_textarray_fdw.control '/home/pgdev/pgsql9.3/share/extension/'</font></div><div><font size="2"  >/usr/bin/install -c -m 644 ./file_textarray_fdw--1.0.1.sql &nbsp;'/home/pgdev/pgsql9.3/share/extension/'</font></div><div><font size="2"  >/usr/bin/install -c -m 755 &nbsp;file_textarray_fdw.so '/home/pgdev/pgsql9.3/lib/'</font></div></div><div><font size="2"  ><br></font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; cd $PGHOME/share/extension</font></div><div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; ll|grep file</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp;475 Jan 23 13:15 file_fdw--1.0.sql</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp;155 Jan 23 13:15 file_fdw.control</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp;379 Jan 24 10:52 file_textarray_fdw--1.0.1.sql</font></div><div><font size="2"  >-rw-r--r-- 1 root root &nbsp;183 Jan 24 10:52 file_textarray_fdw.control</font></div></div><p></p></pre></div><div><div>创建测试文件 :&nbsp;</div><div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >pgdev@db-172-16-3-150-&gt; cat test.csv</font></div><div style="line-height: 22px;"  ><font size="2"  >1,2,3,4</font></div><div style="line-height: 22px;"  ><font size="2"  >a,b,c</font></div><div style="line-height: 22px;"  ><font size="2"  >d</font></div><div style="line-height: 22px;"  ><font size="2"  >e</font></div><div style="line-height: 22px;"  ><font size="2"  >f</font></div><div style="line-height: 22px;"  ><font size="2"  >g,e</font></div><p></p></pre></div></div><div style="line-height: 22px;"  >测试 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; psql</font></div><div><font size="2"  >psql (9.3devel)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  >digoal=# create extension file_textarray_fdw;</font></div><div><font size="2"  >CREATE EXTENSION</font></div></div><div><font size="2"  ><br></font></div><div><div><font size="2"  >CREATE SERVER file_server FOREIGN DATA WRAPPER file_textarray_fdw;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >CREATE FOREIGN TABLE agg_csv_array (</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;t text[]</font></div><div><font size="2"  >)&nbsp;</font></div><div><font size="2"  >&nbsp; SERVER file_server</font></div><div><font size="2"  >&nbsp; OPTIONS (format 'csv',&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;filename '/home/pgdev/test.csv',&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;header 'false',&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;delimiter ',',&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;quote '"',&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;escape '\',&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;null '');</font></div></div><div><font size="2"  ><br></font></div><div><div><font size="2"  >digoal=# select array_length(t,1),t from agg_csv_array ;</font></div><div><font size="2"  >&nbsp;array_length | &nbsp; &nbsp; t &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >--------------+-----------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 | {1,2,3,4}</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3 | {a,b,c}</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | {d}</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | {e}</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | {f}</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | {g,e}</font></div><div><font size="2"  >(6 rows)</font></div></div><p></p></pre></div></div><div><br></div>【参考】<div>1.&nbsp;<a target="_blank" rel="nofollow" href="https://github.com/adunstan/file_text_array_fdw"  >https://github.com/adunstan/file_text_array_fdw</a></div><div>2.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/file-fdw.html"  >http://www.postgresql.org/docs/9.2/static/file-fdw.html</a><br><br><wbr></div></div>
	</div>
</div>
</body>
</html>