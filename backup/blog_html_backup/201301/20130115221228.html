<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL case: emulate 2nd column based SEQUENCE in MYSQL</h2>
	<h5 id="">2013-01-15 22:12:28&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201301591912554/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>今天QQ群里一位兄弟问道的一个问题, 如下 :&nbsp;</div><div>我现在的工作是: 建一颗树</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create table tree</font></div><div><font size="2"  >(</font></div><div><font size="2"  >&nbsp; id bigserial PRIMARY KEY, &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; name varchar(20),</font></div><div><font size="2"  >&nbsp; parent_id bigint, &nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp; order_by int,</font></div><div><font size="2"  >&nbsp; CONSTRAINT fk_tree_self FOREIGN KEY (parent_id)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; REFERENCES tree (id)</font></div><div><font size="2"  >);</font></div><p></p></pre></div><div><br></div><div>参考数据内容 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >id name parent_id order_by&nbsp;</font></div><div><font size="2"  >1 &nbsp;公司 &nbsp;null &nbsp; &nbsp; 0</font></div><div><font size="2"  >2 &nbsp;办公室　1 &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"  >3 &nbsp;财务科 &nbsp;1 &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"  >4 &nbsp;质量科 &nbsp;1 &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"  >.....</font></div><p></p></pre></div><div>插入测试数据 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; insert into tree (name,parent_id,order_by) values ('公司', null, 0);</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; insert into tree (name,parent_id,order_by) values ('办公司', 1, 0);</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; insert into tree (name,parent_id,order_by) values ('财务科', 1, 1);</font></div><div><font size="2"  >INSERT 0 1</font></div></div><div><div><font size="2"  >digoal=&gt; insert into tree (name,parent_id,order_by) values ('质量科', 1, 2);</font></div><div><font size="2"  >INSERT 0 1</font></div></div><p></p></pre></div><div><br></div><div>对同一级的parent_id，维护一个order_by 顺序, 同一个parent_id, order_by值必须唯一。</div><div>这是用户定义的顺序，所以要加order_by 列。以后用户还可能需要调整这个顺序。</div><div>现在插入新记录时，要做的如下：</div><div><pre class="prettyprint"  ><div><font size="2"  >start transaction;</font></div><div><font size="2"  >select max(order_by) where parent_id = :parent_id;</font></div><div><font size="2"  >insert into tree(name,parent_id,order_by) values</font></div><div><font size="2"  >(:name,:parent_id,:order_by);</font></div><div><font size="2"  >commit;</font></div><p></p></pre></div><div>以上操作存在幻读 :&nbsp;</div><div>当我按照当前记录数　max+1 -&gt; order_by 时，另一并发进程可能也这样操作，就会有重复的 order_by 值了。</div><div>mysql 有个基于第2列自动递增，不知postgresql有没有?</div><div><br></div><div>【下面是解决办法举例】 :&nbsp;</div><div>1. 首先确保数据一致性, 建立约束.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; alter table tree add constraint uk_pid_oby unique (parent_id, order_by);</font></div><div><font size="2"  >NOTICE: &nbsp;ALTER TABLE / ADD UNIQUE will create implicit index "uk_pid_oby" for table "tree"</font></div><div><font size="2"  >ALTER TABLE</font></div><p></p></pre></div><div>这样同一个parent_id下不会产生重复的order_by值, 因为如果后插入的数据与前面插入的数据重复了, 会产生约束错误, 整个事务回滚.</div><div>例如 :&nbsp;</div><div>SESSION A:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; begin;</font></div><div><font size="2"  >BEGIN</font></div><div><div><font size="2"  >digoal=&gt; select max(order_by) from tree where parent_id=1;</font></div><div><font size="2"  >&nbsp;max&nbsp;</font></div><div><font size="2"  >-----</font></div><div><font size="2"  >&nbsp; &nbsp;2</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>SESSION B:</div><div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >digoal=&gt; begin;</font></div><div style="line-height: 22px;"  ><font size="2"  >BEGIN</font></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  >digoal=&gt; select max(order_by) from tree where parent_id=1;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp;max&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  >-----</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp;2</font></div><div style="line-height: 22px;"  ><font size="2"  >(1 row)</font></div></div><p></p></pre></div></div><div><br></div><div>SESSION A:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; insert into tree (name,parent_id,order_by) values ('产品科', 1, 3);</font></div><div><font size="2"  >INSERT 0 1</font></div><p></p></pre></div><div><br></div><div>SESSION B:</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; insert into tree (name,parent_id,order_by) values ('材料科', 1, 3);</font></div></div><div><font size="2"  >处于等待状态</font></div><p></p></pre></div><div><br></div><div>SESSION A:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; commit;</font></div><div><font size="2"  >COMMIT</font></div><p></p></pre></div><div><br></div><div>SESSION B:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >SESSION A提交后, SESSION B将报错, 需要回滚.</font></div><div><font size="2"  >ERROR: &nbsp;duplicate key value violates unique constraint "uk_pid_oby"</font></div><div><font size="2"  >DETAIL: &nbsp;Key (parent_id, order_by)=(1, 3) already exists.</font></div><p></p></pre></div><div><br></div><div>处理失败事务 :&nbsp;</div><div>SESSION B:</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; rollback;</font></div><div><font size="2"  >ROLLBACK</font></div></div><div><div><font size="2"  >digoal=&gt; begin;</font></div><div><font size="2"  >BEGIN</font></div></div><div><div><font size="2"  >digoal=&gt; select max(order_by) from tree where parent_id=1;</font></div><div><font size="2"  >&nbsp;max&nbsp;</font></div><div><font size="2"  >-----</font></div><div><font size="2"  >&nbsp; &nbsp;3</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; insert into tree (name,parent_id,order_by) values ('材料科', 1, 4);</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; commit;</font></div><div><font size="2"  >COMMIT</font></div></div><p></p></pre></div><div><br></div><div>2. mysql 有个基于第2列自动递增，不知postgresql有没有?</div><div>PostgreSQL 没有这种语法, 但是有解决办法.</div><div>通过一个序列来获取order_by需要的值, 但是需要注意这个值在同一个parent_id里可能不是呈现为1,2,3,4,5这样的连续数值. 可能是2,7,100,200,1333这样的有大小区分的唯一数值. (仍然可以用来满足排序的需求)</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create sequence seq_order_by start with 5;</font></div><div><font size="2"  >CREATE SEQUENCE</font></div><p></p></pre></div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; begin;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >digoal=&gt; insert into tree (name,parent_id,order_by) values ('产品科', 1, nextval('seq_order_by'::regclass));</font></div><div><font size="2"  >INSERT 0 1</font></div><p></p></pre></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; begin;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >digoal=&gt; insert into tree (name,parent_id,order_by) values ('材料科', 1, nextval('seq_order_by'::regclass));</font></div><div><font size="2"  >INSERT 0 1</font></div><p></p></pre></div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; commit;</font></div><div><font size="2"  >COMMIT</font></div><p></p></pre></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; commit;</font></div><div><font size="2"  >COMMIT</font></div><p></p></pre></div><div>使用了序列后, 不会有因为幻读导致的等待和回滚.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select * from tree;</font></div><div><font size="2"  >&nbsp;id | &nbsp;name &nbsp;| parent_id | order_by&nbsp;</font></div><div><font size="2"  >----+--------+-----------+----------</font></div><div><font size="2"  >&nbsp; 1 | 公司 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"  >&nbsp; 2 | 办公司 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"  >&nbsp; 3 | 财务科 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"  >&nbsp; 5 | 质量科 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"  >&nbsp; 6 | 产品科 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp;3</font></div><div><font size="2"  >&nbsp; 8 | 材料科 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp;4</font></div><div><font size="2"  >&nbsp; 9 | 产品科 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp;5</font></div><div><font size="2"  >&nbsp;10 | 材料科 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp;6</font></div><div><font size="2"  >(8 rows)</font></div><p></p></pre></div><div>再次插入一些数据 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; insert into tree (name,parent_id,order_by) values ('test1', 2, nextval('seq_order_by'::regclass));</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; insert into tree (name,parent_id,order_by) values ('test1', 3, nextval('seq_order_by'::regclass));</font></div><div><font size="2"  >INSERT 0 1</font></div></div><div><div><font size="2"  >digoal=&gt; insert into tree (name,parent_id,order_by) values ('test1', 5, nextval('seq_order_by'::regclass));</font></div><div><font size="2"  >INSERT 0 1</font></div></div><div><div><font size="2"  >digoal=&gt; insert into tree (name,parent_id,order_by) values ('test2', 5, nextval('seq_order_by'::regclass));</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; insert into tree (name,parent_id,order_by) values ('test3', 5, nextval('seq_order_by'::regclass));</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; insert into tree (name,parent_id,order_by) values ('test4', 5, nextval('seq_order_by'::regclass));</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; insert into tree (name,parent_id,order_by) values ('test4', 3, nextval('seq_order_by'::regclass));</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; insert into tree (name,parent_id,order_by) values ('test5', 3, nextval('seq_order_by'::regclass));</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; insert into tree (name,parent_id,order_by) values ('test1', 3, nextval('seq_order_by'::regclass));</font></div><div><font size="2"  >INSERT 0 1</font></div><div><div><font size="2"  >digoal=&gt; select * from tree;</font></div><div><font size="2"  >&nbsp;id | &nbsp;name &nbsp;| parent_id | order_by&nbsp;</font></div><div><font size="2"  >----+--------+-----------+----------</font></div><div><font size="2"  >&nbsp; 1 | 公司 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"  >&nbsp; 2 | 办公司 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"  >&nbsp; 3 | 财务科 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"  >&nbsp; 5 | 质量科 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"  >&nbsp; 6 | 产品科 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp;3</font></div><div><font size="2"  >&nbsp; 8 | 材料科 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp;4</font></div><div><font size="2"  >&nbsp; 9 | 产品科 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp;5</font></div><div><font size="2"  >&nbsp;10 | 材料科 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp;6</font></div><div><font size="2"  >&nbsp;11 | test1 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; &nbsp;7</font></div><div><font size="2"  >&nbsp;12 | test1 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 3 | &nbsp; &nbsp; &nbsp; &nbsp;8</font></div><div><font size="2"  >&nbsp;14 | test1 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 5 | &nbsp; &nbsp; &nbsp; 10</font></div><div><font size="2"  >&nbsp;15 | test2 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 5 | &nbsp; &nbsp; &nbsp; 11</font></div><div><font size="2"  >&nbsp;16 | test3 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 5 | &nbsp; &nbsp; &nbsp; 12</font></div><div><font size="2"  >&nbsp;17 | test4 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 5 | &nbsp; &nbsp; &nbsp; 13</font></div><div><font size="2"  >&nbsp;18 | test4 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 3 | &nbsp; &nbsp; &nbsp; 14</font></div><div><font size="2"  >&nbsp;19 | test5 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 3 | &nbsp; &nbsp; &nbsp; 15</font></div><div><font size="2"  >&nbsp;20 | test1 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 3 | &nbsp; &nbsp; &nbsp; 16</font></div><div><font size="2"  >&nbsp; 4 | test1 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 3 | &nbsp; &nbsp; &nbsp; 18</font></div><div><font size="2"  >(18 rows)</font></div></div></div><p></p></pre></div><div>如果要显示1,2,3,4,5这样的连续数值, 可以用row_number()来得到 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select id,name,parent_id,row_number() over (partition by parent_id order by order_by) as rn from tree order by parent_id nulls first,id;</font></div><div><font size="2"  >&nbsp;id | &nbsp;name &nbsp;| parent_id | rn&nbsp;</font></div><div><font size="2"  >----+--------+-----------+----</font></div><div><font size="2"  >&nbsp; 1 | 公司 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;1</font></div><div><font size="2"  >&nbsp; 2 | 办公司 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp;1</font></div><div><font size="2"  >&nbsp; 3 | 财务科 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp;2</font></div><div><font size="2"  >&nbsp; 5 | 质量科 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp;3</font></div><div><font size="2"  >&nbsp; 6 | 产品科 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp;4</font></div><div><font size="2"  >&nbsp; 8 | 材料科 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp;5</font></div><div><font size="2"  >&nbsp; 9 | 产品科 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp;6</font></div><div><font size="2"  >&nbsp;10 | 材料科 | &nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp;7</font></div><div><font size="2"  >&nbsp;11 | test1 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp;1</font></div><div><font size="2"  >&nbsp; 4 | test1 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 3 | &nbsp;5</font></div><div><font size="2"  >&nbsp;12 | test1 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 3 | &nbsp;1</font></div><div><font size="2"  >&nbsp;18 | test4 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 3 | &nbsp;2</font></div><div><font size="2"  >&nbsp;19 | test5 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 3 | &nbsp;3</font></div><div><font size="2"  >&nbsp;20 | test1 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 3 | &nbsp;4</font></div><div><font size="2"  >&nbsp;14 | test1 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 5 | &nbsp;1</font></div><div><font size="2"  >&nbsp;15 | test2 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 5 | &nbsp;2</font></div><div><font size="2"  >&nbsp;16 | test3 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 5 | &nbsp;3</font></div><div><font size="2"  >&nbsp;17 | test4 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 5 | &nbsp;4</font></div><div><font size="2"  >(18 rows)</font></div><p></p></pre></div><div>需要调整顺序的话, 交换真实的order_by即可.</div><div><br></div><div>另外, 同时需要考虑cache的问题.</div><div>虽然使用单一序列来处理order_by的值, 唯一性没有问题. 开了CACHE的话，并发插入将可能出现后插入的数据order_by 小于 前面插入的数据的order_by.</div><div>因此如果要保证序列的顺序和插入时间一致不能开启cache.</div><div>不开cache的情况下取序列的性能 ：</div><div><span style="line-height: 22px;"  >2颗Intel(R) Xeon(R) CPU E5504 &nbsp;@ 2.00GHz的机器每秒可取10.29W个序列.</span></div><div>可参考 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201301591241964/"  >http://blog.163.com/digoal@126/blog/static/163877040201301591241964/</a></div><div><br></div><div>【参考】</div><div>1.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201101735842150/"  >http://blog.163.com/digoal@126/blog/static/163877040201101735842150/</a></div></div>
	</div>
</div>
</body>
</html>