<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL sequence get speed with 2 Intel(R) Xeon(R) CPU E5504  @ 2.00GHz</h2>
	<h5 id="">2013-01-15 21:13:59&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201301591241964/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">PostgreSQL 的序列性能测试 :&nbsp;<wbr><div>测试机 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >CentOS 5.7 x64</font></div><div><font size="2"  >PostgreSQL 9.2.1</font></div><div><font size="2"  >DELL R610</font></div><div><font size="2"  >CPU 2 * Intel(R) Xeon(R) CPU E5504 &nbsp;@ 2.00GHz</font></div><p></p></pre></div><div><br></div><div>1. 测试不开启cache的情况下取序列的速度 :&nbsp;</div><div>创建序列 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; psql&nbsp;</font></div><div><font size="2"  >psql (9.2.1)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  >digoal=&gt; create sequence seq_test;</font></div><div><font size="2"  >CREATE SEQUENCE</font></div><p></p></pre></div><div>查看当前序列ID :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select * from seq_test ;</font></div><div><font size="2"  >-[ RECORD 1 ]-+--------------------</font></div><div><font size="2"  >sequence_name | seq_test</font></div><div><font size="2"  >last_value &nbsp; &nbsp;| 1</font></div><div><font size="2"  >start_value &nbsp; | 1</font></div><div><font size="2"  >increment_by &nbsp;| 1</font></div><div><font size="2"  >max_value &nbsp; &nbsp; | 9223372036854775807</font></div><div><font size="2"  >min_value &nbsp; &nbsp; | 1</font></div><div><font size="2"  >cache_value &nbsp; | 1</font></div><div><font size="2"  >log_cnt &nbsp; &nbsp; &nbsp; | 0</font></div><div><font size="2"  >is_cycled &nbsp; &nbsp; | f</font></div><div><font size="2"  >is_called &nbsp; &nbsp; | f</font></div><p></p></pre></div><div><br></div><div>pgbench测试脚本 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; cat t.sql</font></div><div><font size="2"  >select nextval('seq_test');</font></div><p></p></pre></div><div><br></div><div>测试结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./t.sql -c 16 -j 4 -T 30 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 16</font></div><div><font size="2"  >number of threads: 4</font></div><div><font size="2"  >duration: 30 s</font></div><div><font size="2"  >number of transactions actually processed: 3085448</font></div><div><font size="2"  >tps = 102832.533289 (including connections establishing)</font></div><div><font size="2"  >tps = 102891.321540 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.153352 &nbsp; &nbsp; &nbsp; &nbsp;select nextval('seq_test');</font></div><p></p></pre></div><div>由此看出不启用cache的情况下每秒可取<span style="line-height: 22px;"  >102891个序列值.</span></div><div><br></div><div><span style="line-height: 22px;"  >2. 测试开启cache的情况下取序列的速度 :&nbsp;</span></div><div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >digoal=&gt; alter sequence seq_test restart with 1;</font></div><div style="line-height: 22px;"  ><font size="2"  >ALTER SEQUENCE</font></div><div style="line-height: 22px;"  ><div><font size="2"  >digoal=&gt; alter sequence seq_test cache 100;</font></div><div><font size="2"  >ALTER SEQUENCE</font></div></div><div style="line-height: 22px;"  ><div><font size="2"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./t.sql -c 16 -j 4 -T 30 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 16</font></div><div><font size="2"  >number of threads: 4</font></div><div><font size="2"  >duration: 30 s</font></div><div><font size="2"  >number of transactions actually processed: 3359853</font></div><div><font size="2"  >tps = 111975.743127 (including connections establishing)</font></div><div><font size="2"  >tps = 112049.881187 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.140799 &nbsp; &nbsp; &nbsp; &nbsp;select nextval('seq_test');</font></div></div><div><div><font size="2"  >ocz@db-172-16-3-150-&gt; psql digoal digoal</font></div><div><font size="2"  >psql (9.2.1)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  >digoal=&gt; \x</font></div><div><font size="2"  >Expanded display is on.</font></div><div><font size="2"  >digoal=&gt; select * from seq_test ;</font></div><div><font size="2"  >-[ RECORD 1 ]-+--------------------</font></div><div><font size="2"  >sequence_name | seq_test</font></div><div><font size="2"  >last_value &nbsp; &nbsp;| 3360400</font></div><div><font size="2"  >start_value &nbsp; | 1</font></div><div><font size="2"  >increment_by &nbsp;| 1</font></div><div><font size="2"  >max_value &nbsp; &nbsp; | 9223372036854775807</font></div><div><font size="2"  >min_value &nbsp; &nbsp; | 1</font></div><div><font size="2"  >cache_value &nbsp; | 100</font></div><div><font size="2"  >log_cnt &nbsp; &nbsp; &nbsp; | 32</font></div><div><font size="2"  >is_cycled &nbsp; &nbsp; | f</font></div><div><font size="2"  >is_called &nbsp; &nbsp; | t</font></div></div><p></p></pre></div><div style="line-height: 22px;"  >获取速度为112049每秒. 略有提高. 但是如果非长连接的话, 将造成巨大的浪费. 如下 :&nbsp;</div></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; alter sequence seq_test restart with 1;</font></div><div><font size="2"  >ALTER SEQUENCE</font></div><p></p></pre></div><div><br></div><div>调整pgbench参数 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >&nbsp; -C &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; establish new connection for each transaction</font></p></pre></div><div>测试结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; pgbench -M simple -C -n -r -f ./t.sql -c 16 -j 4 -T 30 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: simple</font></div><div><font size="2"  >number of clients: 16</font></div><div><font size="2"  >number of threads: 4</font></div><div><font size="2"  >duration: 30 s</font></div><div><font size="2"  >number of transactions actually processed: 25865</font></div><div><font size="2"  >tps = 861.986914 (including connections establishing)</font></div><div><font size="2"  >tps = 59712.243088 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 13.960707 &nbsp; &nbsp; &nbsp; select nextval('seq_test');</font></div><p></p></pre></div><div><div>查看最后的序列值 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; psql digoal digoal</font></div><div><font size="2"  >psql (9.2.1)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  >digoal=&gt; \x</font></div><div><font size="2"  >Expanded display is on.</font></div><div><font size="2"  >digoal=&gt; select * from seq_test ;</font></div><div><font size="2"  >-[ RECORD 1 ]-+--------------------</font></div><div><font size="2"  >sequence_name | seq_test</font></div><div><font size="2"  >last_value &nbsp; &nbsp;| 2588100</font></div><div><font size="2"  >start_value &nbsp; | 1</font></div><div><font size="2"  >increment_by &nbsp;| 1</font></div><div><font size="2"  >max_value &nbsp; &nbsp; | 9223372036854775807</font></div><div><font size="2"  >min_value &nbsp; &nbsp; | 1</font></div><div><font size="2"  >cache_value &nbsp; | 100</font></div><div><font size="2"  >log_cnt &nbsp; &nbsp; &nbsp; | 32</font></div><div><font size="2"  >is_cycled &nbsp; &nbsp; | f</font></div><div><font size="2"  >is_called &nbsp; &nbsp; | t</font></div><p></p></pre></div></div><div>实际处理事务为25865个, &nbsp;但是序列值已经增长到了<span style="line-height: 22px;"  >2588100, 100倍的浪费.</span></div><div><span style="line-height: 22px;"  >测试结果仅供参考.</span></div></div>
	</div>
</div>
</body>
</html>