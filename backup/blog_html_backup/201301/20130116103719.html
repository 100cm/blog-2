<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Linux multipath device monitor with nagios</h2>
	<h5 id="">2013-01-16 10:37:19&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013016103719302/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>Linux下多路径设备的监控.</div><div>当路径出现failed, failover, fault, inactive状态时告警.</div><div>通过multipath -ll可以查看 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# multipath -ll</font></div><div><font size="2"   >mpath2 (SATA_OCZ-REVODRIVE3_OCZ-886PWVEQ351TAPNH) dm-2 ATA,OCZ-REVODRIVE3</font></div><div><font size="2"   >[size=224G][features=0][hwhandler=0][rw]</font></div><div><font size="2"   >\_ round-robin 0 [prio=0][active]</font></div><div><font size="2"   >&nbsp;\_ 5:0:126:0 sde 8:64 &nbsp;[active][ready]</font></div><div><font size="2"   >mpath1 (SATA_OCZ-REVODRIVE3_OCZ-Z2134R0TLQBNE659) dm-1 ATA,OCZ-REVODRIVE3</font></div><div><font size="2"   >[size=224G][features=0][hwhandler=0][rw]</font></div><div><font size="2"   >\_ round-robin 0 [prio=0][active]</font></div><div><font size="2"   >&nbsp;\_ 4:0:126:0 sdd 8:48 &nbsp;[active][ready]</font></div><div><font size="2"   >mpath0 (360026b902fe2ce0017c654500ba7cfad) dm-0 DELL,PERC 6/i</font></div><div><font size="2"   >[size=186G][features=0][hwhandler=0][rw]</font></div><div><font size="2"   >\_ round-robin 0 [prio=0][active]</font></div><div><font size="2"   >&nbsp;\_ 0:2:1:0 &nbsp; sdb 8:16 &nbsp;[active][ready]</font></div><p></p></pre></div><div><br></div><div>首先要增加/sbin/multipath -ll命令的普通用户执行权限.</div><div>visudo -f /etc/sudoers</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># 1. 注释 requiretty</font></div><div><font size="2"   ># Defaults &nbsp; &nbsp;requiretty</font></div><div><font size="2"   ># 2. 末尾添加</font></div><div><font size="2"   ># add by digoal</font></div><div><font size="2"   >ALL ALL=(ALL) NOPASSWD: /sbin/multipath -ll</font></div><p></p></pre></div><div>测试是否可以正常执行 :&nbsp;</div><div>su - postgres</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db1-&gt; sudo /sbin/multipath -ll</font></div><div><font size="2"   >msa2012fc_vd01vol01 (3600c0ff000d70bed2016f94c01000000) dm-4 HP,MSA2012fc</font></div><div><font size="2"   >[size=1.9T][features=0][hwhandler=0]</font></div><div><font size="2"   >\_ round-robin 0 [prio=0][active]</font></div><div><font size="2"   >&nbsp;\_ 0:0:0:1 sda 8:0 &nbsp; [active][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=0][enabled]</font></div><div><font size="2"   >&nbsp;\_ 1:0:0:1 sdf 8:80 &nbsp;[active][ready]</font></div><div><font size="2"   >msa2312fc_vd01vol01 (3600c0ff0001063a4a59df84c01000000) dm-5 HP,MSA2312fc</font></div><div><font size="2"   >[size=1.1T][features=0][hwhandler=0]</font></div><div><font size="2"   >\_ round-robin 0 [prio=0][active]</font></div><div><font size="2"   >&nbsp;\_ 0:0:2:1 sdb 8:16 &nbsp;[active][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=0][enabled]</font></div><div><font size="2"   >&nbsp;\_ 0:0:3:1 sdd 8:48 &nbsp;[active][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=0][enabled]</font></div><div><font size="2"   >&nbsp;\_ 1:0:2:1 sdg 8:96 &nbsp;[active][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=0][enabled]</font></div><div><font size="2"   >&nbsp;\_ 1:0:3:1 sdi 8:128 [active][ready]</font></div><div><font size="2"   >msa2312fc_vd02vol01 (3600c0ff000106a63aa9df84c01000000) dm-6 HP,MSA2312fc</font></div><div><font size="2"   >[size=1.1T][features=0][hwhandler=0]</font></div><div><font size="2"   >\_ round-robin 0 [prio=0][active]</font></div><div><font size="2"   >&nbsp;\_ 0:0:2:2 sdc 8:32 &nbsp;[active][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=0][enabled]</font></div><div><font size="2"   >&nbsp;\_ 0:0:3:2 sde 8:64 &nbsp;[active][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=0][enabled]</font></div><div><font size="2"   >&nbsp;\_ 1:0:2:2 sdh 8:112 [active][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=0][enabled]</font></div><div><font size="2"   >&nbsp;\_ 1:0:3:2 sdj 8:144 [active][ready]</font></div><p></p></pre></div><div>改成其他参数需密码 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db1-&gt; sudo /sbin/multipath -l</font></div><div><font size="2"   >Password:</font></div><p></p></pre></div><div>新增一个监控脚本 :&nbsp;</div><div>vi /usr/local/nagios/libexec/mon_multipath.sh</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   >export PATH=/usr/local/bin:/bin:/usr/bin:.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >MULTIPATH=`sudo /sbin/multipath -ll|wc -l`</font></div><div><font size="2"   >if [ $MULTIPATH -eq 0 ]; then</font></div><div><font size="2"   >&nbsp; exit 0</font></div><div><font size="2"   >fi</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >FAILED=`sudo /sbin/multipath -ll|grep -c -E "fault|fail|inactive"`</font></div><div><font size="2"   >if [ $FAILED -ne 0 ]; then</font></div><div><font size="2"   >&nbsp; sudo /sbin/multipath -ll</font></div><div><font size="2"   >&nbsp; exit 2</font></div><div><font size="2"   >fi</font></div><div><font size="2"   >exit 0</font></div><p></p></pre></div><div>添加执行权限 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >chmod 555 /usr/local/nagios/libexec/mon_multipath.sh</font></p></pre></div><div><br></div><div>修改nagios配置文件 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi /usr/local/nagios/etc/nrpe.cfg</font></div><div><font size="2"   >command[check_multipath]=/usr/local/nagios/libexec/mon_multipath.sh</font></div><div><font size="2"   >重启xinetd服务</font></div><div><font size="2"   >service xinetd restart</font></div><p></p></pre></div><div>nagios服务端增加这台主机的check_multipath监控项.</div><div><br></div><div>【参考】</div><div>1. /usr/share/doc/device-mapper-multipath-0.4.7</div><div>2.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://christophe.varoqui.free.fr/usage.html"   >http://christophe.varoqui.free.fr/usage.html</a></div><div>3.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://christophe.varoqui.free.fr/refbook.html"   >http://christophe.varoqui.free.fr/refbook.html</a></div><div>4.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://christophe.varoqui.free.fr/"   >http://christophe.varoqui.free.fr/</a></div><div>5.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://serverfault.com/questions/110053/how-do-you-fix-a-faulty-path-in-device-mapper-multipath"   >http://serverfault.com/questions/110053/how-do-you-fix-a-faulty-path-in-device-mapper-multipath</a></div><wbr></div>
	</div>
</div>
</body>
</html>