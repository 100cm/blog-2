<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL JSON json_in and json_validate_cstring performance test</h2>
	<h5 id="">2013-01-16 17:42:08&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020130165241651/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>Andrew Dunstan在测试JSON的json_in性能, 其实主要测试的是json.c中的json_validate_cstring的性能.</div><div>如下 :&nbsp;</div><div>取自PostgreSQL 9.2.1</div><div>src/backend/utils/adt/json.c</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >/*</font></div><div><font size="2"  >&nbsp;* Input.</font></div><div><font size="2"  >&nbsp;*/</font></div><div><font size="2"  >Datum</font></div><div><font size="2"  >json_in(PG_FUNCTION_ARGS)</font></div><div><font size="2"  >{</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *text = PG_GETARG_CSTRING(0);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; json_validate_cstring(text);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; /* Internal representation is the same as text, for now */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_TEXT_P(cstring_to_text(text));</font></div><div><font size="2"  >}</font></div></div><div><div><font size="2"  >/*</font></div><div><font size="2"  >&nbsp;* Check whether supplied input is valid JSON.</font></div><div><font size="2"  >&nbsp;*/</font></div><div><font size="2"  >static void</font></div><div><font size="2"  >json_validate_cstring(char *input)</font></div><div><font size="2"  >{</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; JsonLexContext lex;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; JsonParseStack *stack,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*stacktop;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stacksize;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; /* Set up lexing context. */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; lex.input = input;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; lex.token_terminator = lex.input;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; /* Set up parse stack. */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; stacksize = 32;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; stacktop = (JsonParseStack *) palloc(sizeof(JsonParseStack) * stacksize);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; stack = stacktop;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; stack-&gt;state = JSON_PARSE_VALUE;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; /* Main parsing loop. */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; for (;;)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JsonStackOp op;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Fetch next token. */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; json_lex(&amp;lex);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Check for unexpected end of input. */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (lex.token_start == NULL)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; report_parse_error(stack, &amp;lex);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >redo:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Figure out what to do with this token. */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; op = JSON_STACKOP_NONE;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; switch (stack-&gt;state)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div></div><div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case JSON_PARSE_VALUE:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (lex.token_type != JSON_VALUE_INVALID)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; op = JSON_STACKOP_POP;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (lex.token_start[0] == '[')</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stack-&gt;state = JSON_PARSE_ARRAY_START;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (lex.token_start[0] == '{')</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stack-&gt;state = JSON_PARSE_OBJECT_START;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; report_parse_error(stack, &amp;lex);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case JSON_PARSE_ARRAY_START:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (lex.token_type != JSON_VALUE_INVALID)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stack-&gt;state = JSON_PARSE_ARRAY_NEXT;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (lex.token_start[0] == ']')</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; op = JSON_STACKOP_POP;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (lex.token_start[0] == '[' ||</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lex.token_start[0] == '{')</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stack-&gt;state = JSON_PARSE_ARRAY_NEXT;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; op = JSON_STACKOP_PUSH_WITH_PUSHBACK;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; report_parse_error(stack, &amp;lex);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case JSON_PARSE_ARRAY_NEXT:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (lex.token_type != JSON_VALUE_INVALID)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; report_parse_error(stack, &amp;lex);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (lex.token_start[0] == ']')</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; op = JSON_STACKOP_POP;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (lex.token_start[0] == ',')</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; op = JSON_STACKOP_PUSH;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; report_parse_error(stack, &amp;lex);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case JSON_PARSE_OBJECT_START:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (lex.token_type == JSON_VALUE_STRING)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stack-&gt;state = JSON_PARSE_OBJECT_LABEL;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (lex.token_type == JSON_VALUE_INVALID &amp;&amp;</font></div></div><div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lex.token_start[0] == '}')</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; op = JSON_STACKOP_POP;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; report_parse_error(stack, &amp;lex);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case JSON_PARSE_OBJECT_LABEL:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (lex.token_type == JSON_VALUE_INVALID &amp;&amp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lex.token_start[0] == ':')</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stack-&gt;state = JSON_PARSE_OBJECT_NEXT;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; op = JSON_STACKOP_PUSH;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; report_parse_error(stack, &amp;lex);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case JSON_PARSE_OBJECT_NEXT:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (lex.token_type != JSON_VALUE_INVALID)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; report_parse_error(stack, &amp;lex);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (lex.token_start[0] == '}')</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; op = JSON_STACKOP_POP;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (lex.token_start[0] == ',')</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stack-&gt;state = JSON_PARSE_OBJECT_COMMA;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; report_parse_error(stack, &amp;lex);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case JSON_PARSE_OBJECT_COMMA:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (lex.token_type == JSON_VALUE_STRING)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stack-&gt;state = JSON_PARSE_OBJECT_LABEL;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; report_parse_error(stack, &amp;lex);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, "unexpected json parse state: %d",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(int) stack-&gt;state);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Push or pop the state stack, if needed. */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; switch (op)</font></div></div><div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case JSON_STACKOP_PUSH:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case JSON_STACKOP_PUSH_WITH_PUSHBACK:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stack++;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (stack &gt;= &amp;stacktop[stacksize])</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Need to enlarge the stack. */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stackoffset = stack - stacktop;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stacksize += 32;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stacktop = (JsonParseStack *)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; repalloc(stacktop,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sizeof(JsonParseStack) * stacksize);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stack = stacktop + stackoffset;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stack-&gt;state = JSON_PARSE_VALUE;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (op == JSON_STACKOP_PUSH_WITH_PUSHBACK)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto redo;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case JSON_STACKOP_POP:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (stack == stacktop)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Expect end of input. */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; json_lex(&amp;lex);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (lex.token_start != NULL)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; report_parse_error(NULL, &amp;lex);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stack--;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case JSON_STACKOP_NONE:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* nothing to do */</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >}</font></div></div><p></p></pre></div><div>接下来我在DELL R610的服务器上进行测试, 配置如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >DELL R610</font></div><div><font size="2"  >2 *&nbsp;Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"  >PostgreSQL 9.2.1</font></div><p></p></pre></div><div><br></div><div>具体如何测试呢? 测试inline脚本 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >do language plpgsql $$&nbsp;</font></div><div><font size="2"  >declare&nbsp;</font></div><div><font size="2"  >&nbsp; it text;</font></div><div><font size="2"  >&nbsp; oj json;</font></div><div><font size="2"  >begin&nbsp;</font></div><div><font size="2"  >select array_to_json(array_agg(q)) into it</font></div><div><font size="2"  >&nbsp; from (select * from pg_class) q;</font></div><div><font size="2"  >for i in 1 .. 10000 loop&nbsp;</font></div><div><font size="2"  >&nbsp; select it::json into oj;</font></div><div><font size="2"  >end loop;&nbsp;</font></div><div><font size="2"  >end;&nbsp;</font></div><div><font size="2"  >$$;</font></div><p></p></pre></div><div>用gdb跟踪一下循环中是否真的每次都调用了json_in和json_validate_cstring</div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; psql</font></div><div><font size="2"  >psql (9.2.1)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# select pg_backend_pid();</font></div><div><font size="2"  >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"  >----------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 868</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >gdb</font></div><div><div><font size="2"  >(gdb) attach 868</font></div><div><font size="2"  >Attaching to process 868</font></div></div><div><div><font size="2"  >(gdb) break json_in</font></div><div><font size="2"  >Breakpoint 1 at 0x681f80: file json.c, line 108.</font></div><div><font size="2"  >(gdb) break json_out</font></div><div><font size="2"  >Breakpoint 2 at 0x682000: file json.c, line 126.</font></div><div><font size="2"  >(gdb) break json_validate_cstring</font></div><div><font size="2"  >Breakpoint 3 at 0x681c70: file json.c, line 178.</font></div></div><div><div><font size="2"  >(gdb) c</font></div><div><font size="2"  >Continuing.</font></div></div><p></p></pre></div><div><br></div><div>SESSION A :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# do language plpgsql $$&nbsp;</font></div><div><font size="2"  >declare&nbsp;</font></div><div><font size="2"  >&nbsp; it text;</font></div><div><font size="2"  >&nbsp; oj json;</font></div><div><font size="2"  >begin&nbsp;</font></div><div><font size="2"  >select array_to_json(array_agg(q)) into it</font></div><div><font size="2"  >&nbsp; from (select * from pg_class) q;</font></div><div><font size="2"  >for i in 1 .. 10 loop&nbsp;</font></div><div><font size="2"  >&nbsp; select it::json into oj;</font></div><div><font size="2"  >end loop;&nbsp;</font></div><div><font size="2"  >end;&nbsp;</font></div><div><font size="2"  >$$;</font></div><p></p></pre></div><div><br></div><div>SESSION B :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >Breakpoint 2, json_out (fcinfo=0x7fff1f836090) at json.c:126</font></div><div><font size="2"  >126 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_CSTRING(TextDatumGetCString(txt));</font></div><div><font size="2"  >(gdb) c</font></div><div><font size="2"  >Continuing.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Breakpoint 1, json_in (fcinfo=0x7fff1f835e20) at json.c:108</font></div><div><font size="2"  >108 &nbsp; &nbsp; {</font></div><div><font size="2"  >(gdb)&nbsp;</font></div><div><font size="2"  >Continuing.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Breakpoint 3, json_validate_cstring (</font></div><div><font size="2"  >&nbsp; &nbsp; input=0x18e2f4f0 "[{\"relname\":\"pg_statistic\",\"relnamespace\":11,\"reltype\":10802,\"reloftype\":0,\"relowner\":10,\"relam\":0,\"relfilenode\":12525,\"reltablespace\":0,\"relpages\":17,\"reltuples\":389,\"relallvisible\":12,\"reltoastrelid"...)</font></div><div><font size="2"  >&nbsp; &nbsp; at json.c:178</font></div><div><font size="2"  >178 &nbsp; &nbsp; {</font></div><div><font size="2"  >(gdb)&nbsp;</font></div><div><font size="2"  >Continuing.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Breakpoint 1, json_in (fcinfo=0x7fff1f835e20) at json.c:108</font></div><div><font size="2"  >108 &nbsp; &nbsp; {</font></div><div><font size="2"  >(gdb)&nbsp;</font></div><div><font size="2"  >Continuing.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Breakpoint 3, json_validate_cstring (</font></div><div><font size="2"  >&nbsp; &nbsp; input=0x18e53000 "[{\"relname\":\"pg_statistic\",\"relnamespace\":11,\"reltype\":10802,\"reloftype\":0,\"relowner\":10,\"relam\":0,\"relfilenode\":12525,\"reltablespace\":0,\"relpages\":17,\"reltuples\":389,\"relallvisible\":12,\"reltoastrelid"...)</font></div><div><font size="2"  >&nbsp; &nbsp; at json.c:178</font></div><div><font size="2"  >178 &nbsp; &nbsp; {</font></div><div><font size="2"  >(gdb)&nbsp;</font></div><div><font size="2"  >Continuing.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Breakpoint 1, json_in (fcinfo=0x7fff1f835e20) at json.c:108</font></div><div><font size="2"  >108 &nbsp; &nbsp; {</font></div><div><font size="2"  >(gdb)&nbsp;</font></div><div><font size="2"  >Continuing.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Breakpoint 3, json_validate_cstring (</font></div><div><font size="2"  >&nbsp; &nbsp; input=0x18e53000 "[{\"relname\":\"pg_statistic\",\"relnamespace\":11,\"reltype\":10802,\"reloftype\":0,\"relowner\":10,\"relam\":0,\"relfilenode\":12525,\"reltablespace\":0,\"relpages\":17,\"reltuples\":389,\"relallvisible\":12,\"reltoastrelid"...)</font></div><div><font size="2"  >&nbsp; &nbsp; at json.c:178</font></div><div><font size="2"  >178 &nbsp; &nbsp; {</font></div><div><font size="2"  >(gdb)&nbsp;</font></div><div><font size="2"  >Continuing.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Breakpoint 1, json_in (fcinfo=0x7fff1f835e20) at json.c:108</font></div><div><font size="2"  >108 &nbsp; &nbsp; {</font></div><div><font size="2"  >(gdb)&nbsp;</font></div><div><font size="2"  >Continuing.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Breakpoint 3, json_validate_cstring (</font></div><div><font size="2"  >&nbsp; &nbsp; input=0x18e53000 "[{\"relname\":\"pg_statistic\",\"relnamespace\":11,\"reltype\":10802,\"reloftype\":0,\"relowner\":10,\"relam\":0,\"relfilenode\":12525,\"reltablespace\":0,\"relpages\":17,\"reltuples\":389,\"relallvisible\":12,\"reltoastrelid"...)</font></div><div><font size="2"  >&nbsp; &nbsp; at json.c:178</font></div><div><font size="2"  >178 &nbsp; &nbsp; {</font></div><div><font size="2"  >(gdb)&nbsp;</font></div><div><font size="2"  >Continuing.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Breakpoint 1, json_in (fcinfo=0x7fff1f835e20) at json.c:108</font></div><div><font size="2"  >108 &nbsp; &nbsp; {</font></div><div><font size="2"  >(gdb)&nbsp;</font></div><div><font size="2"  >Continuing.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Breakpoint 3, json_validate_cstring (</font></div><div><font size="2"  >&nbsp; &nbsp; input=0x18e53000 "[{\"relname\":\"pg_statistic\",\"relnamespace\":11,\"reltype\":10802,\"reloftype\":0,\"relowner\":10,\"relam\":0,\"relfilenode\":12525,\"reltablespace\":0,\"relpages\":17,\"reltuples\":389,\"relallvisible\":12,\"reltoastrelid"...)</font></div><div><font size="2"  >&nbsp; &nbsp; at json.c:178</font></div><div><font size="2"  >178 &nbsp; &nbsp; {</font></div><div><font size="2"  >(gdb)&nbsp;</font></div><div><font size="2"  >Continuing.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Breakpoint 1, json_in (fcinfo=0x7fff1f835e20) at json.c:108</font></div><div><font size="2"  >108 &nbsp; &nbsp; {</font></div><div><font size="2"  >(gdb)&nbsp;</font></div><div><font size="2"  >Continuing.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Breakpoint 3, json_validate_cstring (</font></div><div><font size="2"  >&nbsp; &nbsp; input=0x18dba390 "[{\"relname\":\"pg_statistic\",\"relnamespace\":11,\"reltype\":10802,\"reloftype\":0,\"relowner\":10,\"relam\":0,\"relfilenode\":12525,\"reltablespace\":0,\"relpages\":17,\"reltuples\":389,\"relallvisible\":12,\"reltoastrelid"...)</font></div><div><font size="2"  >&nbsp; &nbsp; at json.c:178</font></div><div><font size="2"  >178 &nbsp; &nbsp; {</font></div><div><font size="2"  >(gdb)&nbsp;</font></div><div><font size="2"  >Continuing.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Breakpoint 1, json_in (fcinfo=0x7fff1f835e20) at json.c:108</font></div><div><font size="2"  >108 &nbsp; &nbsp; {</font></div><div><font size="2"  >(gdb)&nbsp;</font></div><div><font size="2"  >Continuing.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Breakpoint 3, json_validate_cstring (</font></div><div><font size="2"  >&nbsp; &nbsp; input=0x18d96870 "[{\"relname\":\"pg_statistic\",\"relnamespace\":11,\"reltype\":10802,\"reloftype\":0,\"relowner\":10,\"relam\":0,\"relfilenode\":12525,\"reltablespace\":0,\"relpages\":17,\"reltuples\":389,\"relallvisible\":12,\"reltoastrelid"...)</font></div><div><font size="2"  >&nbsp; &nbsp; at json.c:178</font></div><div><font size="2"  >178 &nbsp; &nbsp; {</font></div><div><font size="2"  >(gdb)&nbsp;</font></div><div><font size="2"  >Continuing.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Breakpoint 1, json_in (fcinfo=0x7fff1f835e20) at json.c:108</font></div><div><font size="2"  >108 &nbsp; &nbsp; {</font></div><div><font size="2"  >(gdb)&nbsp;</font></div><div><font size="2"  >Continuing.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Breakpoint 3, json_validate_cstring (</font></div><div><font size="2"  >&nbsp; &nbsp; input=0x18dba390 "[{\"relname\":\"pg_statistic\",\"relnamespace\":11,\"reltype\":10802,\"reloftype\":0,\"relowner\":10,\"relam\":0,\"relfilenode\":12525,\"reltablespace\":0,\"relpages\":17,\"reltuples\":389,\"relallvisible\":12,\"reltoastrelid"...)</font></div><div><font size="2"  >&nbsp; &nbsp; at json.c:178</font></div><div><font size="2"  >178 &nbsp; &nbsp; {</font></div><div><font size="2"  >(gdb)&nbsp;</font></div><div><font size="2"  >Continuing.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Breakpoint 1, json_in (fcinfo=0x7fff1f835e20) at json.c:108</font></div><div><font size="2"  >108 &nbsp; &nbsp; {</font></div><div><font size="2"  >(gdb)&nbsp;</font></div><div><font size="2"  >Continuing.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Breakpoint 3, json_validate_cstring (</font></div><div><font size="2"  >&nbsp; &nbsp; input=0x18d96870 "[{\"relname\":\"pg_statistic\",\"relnamespace\":11,\"reltype\":10802,\"reloftype\":0,\"relowner\":10,\"relam\":0,\"relfilenode\":12525,\"reltablespace\":0,\"relpages\":17,\"reltuples\":389,\"relallvisible\":12,\"reltoastrelid"...)</font></div><div><font size="2"  >&nbsp; &nbsp; at json.c:178</font></div><div><font size="2"  >178 &nbsp; &nbsp; {</font></div><div><font size="2"  >(gdb)&nbsp;</font></div><div><font size="2"  >Continuing.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Breakpoint 1, json_in (fcinfo=0x7fff1f835e20) at json.c:108</font></div><div><font size="2"  >108 &nbsp; &nbsp; {</font></div><div><font size="2"  >(gdb)&nbsp;</font></div><div><font size="2"  >Continuing.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Breakpoint 3, json_validate_cstring (</font></div><div><font size="2"  >&nbsp; &nbsp; input=0x18dba390 "[{\"relname\":\"pg_statistic\",\"relnamespace\":11,\"reltype\":10802,\"reloftype\":0,\"relowner\":10,\"relam\":0,\"relfilenode\":12525,\"reltablespace\":0,\"relpages\":17,\"reltuples\":389,\"relallvisible\":12,\"reltoastrelid"...)</font></div><div><font size="2"  >&nbsp; &nbsp; at json.c:178</font></div><div><font size="2"  >178 &nbsp; &nbsp; {</font></div><div><font size="2"  >(gdb)&nbsp;</font></div><div><font size="2"  >Continuing.</font></div><p></p></pre></div><div>共跟踪到1次json_out, 10次json_in和10次json_validate_cstring.</div><div>第一次json_out是array_to_json(array_agg(q))这个函数用到的. 仅此一次.</div><div>为什么要确定一下呢, 因为函数特稳定性的关系, 常量可能只调用一次. 如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# do language plpgsql</font></div><div><font size="2"  >$$ &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >declare &nbsp;&nbsp;</font></div><div><font size="2"  >begin &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >for i in 1 .. 1000000 loop</font></div><div><font size="2"  >perform json_out(json '{"a": "b"}'); &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >end loop; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >end; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >$$ ;</font></div><div><font size="2"  >DO</font></div><div><font size="2"  >Time: 5622.756 ms</font></div><p></p></pre></div><div>这个测试json_out就只调用1次.</div><div>改成如下, 循环中将每次都调用json_out, 因为用了变量 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# do language plpgsql &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >$$</font></div><div><font size="2"  >declare&nbsp;</font></div><div><font size="2"  >&nbsp; a json;</font></div><div><font size="2"  >begin&nbsp;</font></div><div><font size="2"  >&nbsp; a := json '{"a": "b"}';</font></div><div><font size="2"  >&nbsp; for i in 1 .. 1000000 loop</font></div><div><font size="2"  >&nbsp; &nbsp; perform json_out(a);</font></div><div><font size="2"  >&nbsp; end loop;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$ ;</font></div><p></p></pre></div><div><br></div><div>函数稳定性参考 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201211241434248/"  >http://blog.163.com/digoal@126/blog/static/163877040201211241434248/</a></div><div><br></div><div>确定每次都会调用后, 接下来就可以看看性能了 :&nbsp;</div><div>1. 先退出gdb</div><div>2. 然后执行10W次以下循环 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# \timing</font></div><div><font size="2"  >Timing is on.</font></div><div><font size="2"  >postgres=# do language plpgsql $$&nbsp;</font></div><div><font size="2"  >declare&nbsp;</font></div><div><font size="2"  >&nbsp; it text;</font></div><div><font size="2"  >&nbsp; oj json;</font></div><div><font size="2"  >begin&nbsp;</font></div><div><font size="2"  >select array_to_json(array_agg(q)) into it</font></div><div><font size="2"  >&nbsp; from (select * from pg_class) q;</font></div><div><font size="2"  >for i in 1 .. 100000 loop&nbsp;</font></div><div><font size="2"  >&nbsp; select it::json into oj;</font></div><div><font size="2"  >end loop;&nbsp;</font></div><div><font size="2"  >end;&nbsp;</font></div><div><font size="2"  >$$;</font></div><div><font size="2"  >DO<br>Time: 201343.110 ms</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >耗时201秒.</span></div><div><span style="line-height: 22px;"  >测试的JSON值的长度为146KB :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select length(array_to_json(array_agg(q))::text) &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; from (select * from pg_class) q;</font></div><div><font size="2"  >&nbsp;length&nbsp;</font></div><div><font size="2"  >--------</font></div><div><font size="2"  >&nbsp;146134</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>每个CPU核每秒约处理72.7MB数据.</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select (146134*100000::int8)/201.0;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;?column? &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >-----------------------</font></div><div><font size="2"  >&nbsp;72703482.587064676617</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div></div>【参考】<div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://adpgtech.blogspot.hk/2013/01/robert-haas-wanted-to-know-how-much.html"  >http://adpgtech.blogspot.hk/2013/01/robert-haas-wanted-to-know-how-much.html</a></div><div>2.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/sql-createtype.html"  >http://www.postgresql.org/docs/9.2/static/sql-createtype.html</a></div><div>3.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020130163491530/"  >http://blog.163.com/digoal@126/blog/static/16387704020130163491530/</a></div><div>4.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201211241434248/"  >http://blog.163.com/digoal@126/blog/static/163877040201211241434248/</a><br><br><wbr></div></div>
	</div>
</div>
</body>
</html>