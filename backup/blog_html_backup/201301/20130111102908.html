<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use pg_resetxlog Recover or Fix PostgreSQL pg_control file Error or crash or failed</h2>
	<h5 id="">2013-01-11 10:29:08&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020130109400557/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 控制文件在$PGDATA/global目录下名为pg_control.</div><div>控制文件中记录了以下三部分信息 :&nbsp;</div><div>1. initdb时生成的静态信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg_control version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;922</font></div><div><font size="2"   >Catalog version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 201204301</font></div><div><font size="2"   >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5831753892046499175</font></div></div><div><div><font size="2"   >Maximum data alignment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8</font></div><div><font size="2"   >Database block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8192</font></div><div><font size="2"   >Blocks per segment of large relation: 131072</font></div><div><font size="2"   >WAL block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 16384</font></div><div><font size="2"   >Bytes per WAL segment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16777216</font></div><div><font size="2"   >Maximum length of identifiers: &nbsp; &nbsp; &nbsp; &nbsp;64</font></div><div><font size="2"   >Maximum columns in an index: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;32</font></div><div><font size="2"   >Maximum size of a TOAST chunk: &nbsp; &nbsp; &nbsp; &nbsp;1996</font></div><div><font size="2"   >Date/time type storage: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64-bit integers</font></div><div><font size="2"   >Float4 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><div><font size="2"   >Float8 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >2. postgresql.conf中的配置信息 :&nbsp;</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >Current wal_level setting: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hot_standby</font></div><div style="line-height: 22px;"   ><font size="2"   >Current max_connections setting: &nbsp; &nbsp; &nbsp;1000</font></div><div style="line-height: 22px;"   ><font size="2"   >Current max_prepared_xacts setting: &nbsp; 10</font></div><div style="line-height: 22px;"   ><font size="2"   >Current max_locks_per_xact setting: &nbsp; 64</font></div><p></p></pre></div></div><div style="line-height: 22px;"   >3.&nbsp;write-ahead logging以及checkpoint的动态信息 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Latest checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 96E8/5B000020</font></div><div><font size="2"   >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;96E8/5A0C8CC0</font></div><div><font size="2"   >Latest checkpoint's REDO location: &nbsp; &nbsp;96E8/5B000020</font></div><div><font size="2"   >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >Latest checkpoint's full_page_writes: on</font></div><div><font size="2"   >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/1183664222</font></div><div><font size="2"   >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;309701</font></div><div><font size="2"   >Latest checkpoint's NextMultiXactId: &nbsp;1</font></div><div><font size="2"   >Latest checkpoint's NextMultiOffset: &nbsp;0</font></div><div><font size="2"   >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;1006759584</font></div><div><font size="2"   >Latest checkpoint's oldestXID's DB: &nbsp; 1</font></div><div><font size="2"   >Latest checkpoint's oldestActiveXID: &nbsp;0</font></div><div><font size="2"   >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Fri 11 Jan 2013 07:44:19 AM CST</font></div><div><font size="2"   >Minimum recovery ending location: &nbsp; &nbsp; 0/0</font></div><div><font size="2"   >Backup start location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"   >Backup end location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"   >End-of-backup record required: &nbsp; &nbsp; &nbsp; &nbsp;no</font></div><p></p></pre></div><div>以上信息可以使用pg_controldata从pg_control获取 :&nbsp;</div></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   style="line-height: 20px;"   >src/bin/pg_controldata/pg_controldata.c</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 20px;"   >&nbsp;* pg_controldata</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 20px;"   >&nbsp;*</font></div><div style="line-height: 22px;"   ><font size="2"   style="line-height: 20px;"   >&nbsp;* reads the data from $PGDATA/global/pg_control</font></div><p></p></pre></div></div><div><br></div><div>如果控制文件$PGDATA/global/pg_control损坏或丢失, 数据库将运行异常, 无法启动.</div><div>如何修复? 关键在于恢复<span style="line-height: 22px;"   >write-ahead logging以及checkpoint的动态信息.&nbsp;</span></div><div><span style="line-height: 22px;"   >这些信息可以从pg_xlog, pg_clog,&nbsp;</span>pg_multixact这些目录的文件中解析出来。</div><div>pg_xlog的文件名解析可参看, 不同的段大小, 命名大不相同, pg_resetxlog的帮助文件适用16MB的段大小, 如果是其他大小, 需要重新计算名字 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/"   >http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/</a></div><div><br></div><div>接下来介绍一下使用pg_resetxlog重建pg_control的方法.</div><div>pg_resetxlog功能如下 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >src/bin/pg_resetxlog/pg_resetxlog.c</font></div><div><font size="2"   >&nbsp;* pg_resetxlog.c</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;A utility to "zero out" the xlog when it's corrupt beyond recovery.</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;Can also rebuild pg_control if needed.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* The theory of operation is fairly simple:</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;1. Read the existing pg_control (which will include the last</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; checkpoint record). &nbsp;If it is an old format then update to</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; current format.</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;2. If pg_control is corrupt, attempt to intuit reasonable values,</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; by scanning the old xlog if necessary.</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;3. Modify pg_control to reflect a "shutdown" state with a checkpoint</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; record at the start of xlog.</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;4. Flush the existing xlog files and write a new segment with</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; just a checkpoint record in it. &nbsp;The new segment is positioned</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; just past the end of the old xlog, so that existing LSNs in</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data pages will appear to be "in the past".</font></div><div><font size="2"   >&nbsp;* This is all pretty straightforward except for the intuition part of</font></div><div><font size="2"   >&nbsp;* step 2 ...</font></div><p></p></pre></div><div>pg_resetxlog的用法 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; pg_resetxlog --help</font></div><div><font size="2"   >pg_resetxlog resets the PostgreSQL transaction log.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Usage:</font></div><div><font size="2"   >&nbsp; pg_resetxlog [OPTION]... DATADIR</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Options:</font></div><div><font size="2"   >&nbsp; -e XIDEPOCH &nbsp; &nbsp; &nbsp;set next transaction ID epoch</font></div><div><font size="2"   >&nbsp; -f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; force update to be done</font></div><div><font size="2"   >&nbsp; -l TLI,FILE,SEG &nbsp;force minimum WAL starting location for new transaction log</font></div><div><font size="2"   >&nbsp; -m XID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set next multitransaction ID</font></div><div><font size="2"   >&nbsp; -n &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; no update, just show extracted control values (for testing)</font></div><div><font size="2"   >&nbsp; -o OID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set next OID</font></div><div><font size="2"   >&nbsp; -O OFFSET &nbsp; &nbsp; &nbsp; &nbsp;set next multitransaction offset</font></div><div><font size="2"   >&nbsp; -V, --version &nbsp; &nbsp;output version information, then exit</font></div><div><font size="2"   >&nbsp; -x XID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set next transaction ID</font></div><div><font size="2"   >&nbsp; -?, --help &nbsp; &nbsp; &nbsp; show this help, then exit</font></div><p></p></pre></div><div>参数具体含义 :&nbsp;</div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-l timelineid,fileid,seg</font></div><div><font size="2"   >&nbsp; The WAL starting address (-l) should be larger than any WAL segment file name currently existing in the</font></div><div><font size="2"   >directory pg_xlog under the data directory. These names are also in hexadecimal and have three parts. The</font></div><div><font size="2"   >first part is the “timeline ID” and should usually be kept the same. Do not choose a value larger than 255</font></div><div><font size="2"   >(0xFF) for the third part; instead increment the second part and reset the third part to 0. For example, if</font></div><div><font size="2"   >00000001000000320000004A is the largest entry in pg_xlog, -l 0x1,0x32,0x4B will work; but if the largest</font></div><div><font size="2"   >entry is 000000010000003A000000FF, choose -l 0x1,0x3B,0x0 or more.</font></div><div><font size="2"   >&nbsp; &nbsp; Note</font></div><div><font size="2"   >&nbsp; &nbsp; pg_resetxlog itself looks at the files in pg_xlog and chooses a default -l setting beyond the last</font></div><div><font size="2"   >&nbsp; &nbsp; existing file name. Therefore, manual adjustment of -l should only be needed if you are aware of WAL</font></div><div><font size="2"   >&nbsp; &nbsp; segment files that are not currently present in pg_xlog, such as entries in an offline archive; or if</font></div><div><font size="2"   >&nbsp; &nbsp; the contents of pg_xlog have been lost entirely.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-e XIDEPOCH</font></div><div><font size="2"   >&nbsp; The transaction ID epoch is not actually stored anywhere in the database except in the field that is set by</font></div><div><font size="2"   >pg_resetxlog, so any value will work so far as the database itself is concerned. You might need to adjust</font></div><div><font size="2"   >this value to ensure that replication systems such as Slony-I work correctly - if so, an appropriate value</font></div><div><font size="2"   >should be obtainable from the state of the downstream replicated database.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-x XID</font></div><div><font size="2"   >&nbsp; A safe value for the next transaction ID (-x) can be determined by looking for the numerically largest file</font></div><div><font size="2"   >name in the directory pg_clog under the data directory, adding one, and then multiplying by 1048576. Note</font></div><div><font size="2"   >that the file names are in hexadecimal. It is usually easiest to specify the option value in hexadecimal</font></div><div><font size="2"   >too. For example, if 0011 is the largest entry in pg_clog, -x 0x1200000 will work (five trailing zeroes</font></div><div><font size="2"   >provide the proper multiplier).</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-m XID</font></div><div><font size="2"   >&nbsp; A safe value for the next multitransaction ID (-m) can be determined by looking for the numerically largest</font></div><div><font size="2"   >file name in the directory pg_multixact/offsets under the data directory, adding one, and then multiplying</font></div><div><font size="2"   >by 65536. As above, the file names are in hexadecimal, so the easiest way to do this is to specify the</font></div><div><font size="2"   >option value in hexadecimal and add four zeroes.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-O OFFSET</font></div><div><font size="2"   >&nbsp; &nbsp;A safe value for the next multitransaction offset (-O) can be determined by looking for the numerically</font></div><div><font size="2"   >largest file name in the directory pg_multixact/members under the data directory, adding one, and then</font></div><div><font size="2"   >multiplying by 65536. As above, the file names are in hexadecimal, so the easiest way to do this is to</font></div><div><font size="2"   >specify the option value in hexadecimal and add four zeroes.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-o OID</font></div><div><font size="2"   >&nbsp; There is no comparably easy way to determine a next OID that's beyond the largest one in the database, but</font></div><div><font size="2"   >fortunately it is not critical to get the next-OID setting right.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-n</font></div><div><font size="2"   >&nbsp; no update, just show extracted control values (for testing)</font></div><div><font size="2"   >-f</font></div><div><font size="2"   >&nbsp; force</font></div><p></p></pre></div><div>测试步骤如下(基于PostgreSQL 9.2.1) :&nbsp;</div><div>1. 新建测试数据, 用到with oids的表, 因为OID无法确定, 看看是否会有异常.</div><div>2. 关闭数据库</div><div>3. 记下pg_controldata信息, 方便修复后进行比对</div><div>4. 删除$PGDATA/global/pg_control</div><div>5. 开启数据库观察报错输出</div><div>6. touch&nbsp;<span style="line-height: 22px;"   >$PGDATA/global/pg_control</span></div><div><span style="line-height: 22px;"   >7. 使用pg_resetxlog修复pg_control</span></div><div><span style="line-height: 22px;"   >8.&nbsp;</span><span style="line-height: 22px;"   >记下pg_controldata信息, 与前面的pg_controldata输出进行比对</span></div><div><span style="line-height: 22px;"   >9. 启动数据库</span></div><div><span style="line-height: 22px;"   >10. 查看测试数据是否正常, 新插入数据</span></div><div><span style="line-height: 22px;"   >11. 关闭数据库, 并记下pg_controldata的信息, 看看有何变化.</span></div><div><br></div><div>测试过程 :&nbsp;</div><div>1. 测试数据</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; create table oid_test(id int primary key) with oids;</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "oid_test_pkey" for table "oid_test"</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >digoal=&gt; insert into oid_test select generate_series(1,100000);</font></div><div><font size="2"   >INSERT 0 100000</font></div></div><div><div><font size="2"   >digoal=&gt; select min(oid),max(oid) from oid_test ;</font></div><div><font size="2"   >&nbsp; min &nbsp;| &nbsp;max &nbsp;&nbsp;</font></div><div><font size="2"   >-------+--------</font></div><div><font size="2"   >&nbsp;16397 | 116396</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>2. 关闭数据</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; pg_ctl stop -m fast</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >3. 记下pg_controldata信息, 方便修复后进行比对</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >ocz@db-172-16-3-150-&gt; pg_controldata&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pg_control version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;922</font></div><div style="line-height: 22px;"   ><font size="2"   >Catalog version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 201204301</font></div><div style="line-height: 22px;"   ><font size="2"   >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5832000131111550393</font></div><div style="line-height: 22px;"   ><font size="2"   >Database cluster state: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shut down</font></div><div style="line-height: 22px;"   ><font size="2"   >pg_control last modified: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fri 11 Jan 2013 09:48:18 AM CST</font></div><div style="line-height: 22px;"   ><font size="2"   >Latest checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 96E8/5F000020</font></div><div style="line-height: 22px;"   ><font size="2"   >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;96E8/5EE5C698</font></div><div style="line-height: 22px;"   ><font size="2"   >Latest checkpoint's REDO location: &nbsp; &nbsp;96E8/5F000020</font></div><div style="line-height: 22px;"   ><font size="2"   >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 1</font></div><div style="line-height: 22px;"   ><font size="2"   >Latest checkpoint's full_page_writes: on</font></div><div style="line-height: 22px;"   ><font size="2"   >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/1183842312</font></div><div style="line-height: 22px;"   ><font size="2"   >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;116414</font></div><div style="line-height: 22px;"   ><font size="2"   >Latest checkpoint's NextMultiXactId: &nbsp;65536</font></div><div style="line-height: 22px;"   ><font size="2"   >Latest checkpoint's NextMultiOffset: &nbsp;65536</font></div><div style="line-height: 22px;"   ><font size="2"   >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;1006759584</font></div><div style="line-height: 22px;"   ><font size="2"   >Latest checkpoint's oldestXID's DB: &nbsp; 1</font></div><div style="line-height: 22px;"   ><font size="2"   >Latest checkpoint's oldestActiveXID: &nbsp;0</font></div><div style="line-height: 22px;"   ><font size="2"   >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Fri 11 Jan 2013 09:48:18 AM CST</font></div><div style="line-height: 22px;"   ><font size="2"   >Minimum recovery ending location: &nbsp; &nbsp; 0/0</font></div><div style="line-height: 22px;"   ><font size="2"   >Backup start location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div style="line-height: 22px;"   ><font size="2"   >Backup end location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div style="line-height: 22px;"   ><font size="2"   >End-of-backup record required: &nbsp; &nbsp; &nbsp; &nbsp;no</font></div><div style="line-height: 22px;"   ><font size="2"   >Current wal_level setting: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hot_standby</font></div><div style="line-height: 22px;"   ><font size="2"   >Current max_connections setting: &nbsp; &nbsp; &nbsp;1000</font></div><div style="line-height: 22px;"   ><font size="2"   >Current max_prepared_xacts setting: &nbsp; 10</font></div><div style="line-height: 22px;"   ><font size="2"   >Current max_locks_per_xact setting: &nbsp; 64</font></div><div style="line-height: 22px;"   ><font size="2"   >Maximum data alignment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8</font></div><div style="line-height: 22px;"   ><font size="2"   >Database block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8192</font></div><div style="line-height: 22px;"   ><font size="2"   >Blocks per segment of large relation: 131072</font></div><div style="line-height: 22px;"   ><font size="2"   >WAL block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 16384</font></div><div style="line-height: 22px;"   ><font size="2"   >Bytes per WAL segment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16777216</font></div><div style="line-height: 22px;"   ><font size="2"   >Maximum length of identifiers: &nbsp; &nbsp; &nbsp; &nbsp;64</font></div><div style="line-height: 22px;"   ><font size="2"   >Maximum columns in an index: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;32</font></div><div style="line-height: 22px;"   ><font size="2"   >Maximum size of a TOAST chunk: &nbsp; &nbsp; &nbsp; &nbsp;1996</font></div><div style="line-height: 22px;"   ><font size="2"   >Date/time type storage: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64-bit integers</font></div><div style="line-height: 22px;"   ><font size="2"   >Float4 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><div style="line-height: 22px;"   ><font size="2"   >Float8 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><p></p></pre></div><div><div style="line-height: 22px;"   >4. 删除$PGDATA/global/pg_control</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; rm $PGDATA/global/pg_control&nbsp;</font></div><div><font size="2"   >rm: remove regular file `/data05/ocz/pg_root/global/pg_control'? y</font></div><p></p></pre></div><div style="line-height: 22px;"   >5. 开启数据库观察报错输出</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; pg_ctl start</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >ocz@db-172-16-3-150-&gt; postgres: could not find the database system</font></div><div><font size="2"   >Expected to find it in the directory "/data05/ocz/pg_root",</font></div><div><font size="2"   >but could not open file "/data05/ocz/pg_root/global/pg_control": No such file or directory</font></div><p></p></pre></div><div style="line-height: 22px;"   >接下来进行修复 :&nbsp;</div><div style="line-height: 22px;"   >6. touch&nbsp;<span style="line-height: 22px;"   >$PGDATA/global/pg_control</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; touch $PGDATA/global/pg_control</font></div><div><font size="2"   >ocz@db-172-16-3-150-&gt; chmod 600 $PGDATA/global/pg_control</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >7. 使用pg_resetxlog修复pg_control</span></div></div></div><div><span style="line-height: 22px;"   >首先确定-l&nbsp;</span>timelineid,fileid,seg<span style="line-height: 22px;"   >的信息 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; cd $PGDATA/pg_xlog</font></div><div><font size="2"   >ocz@db-172-16-3-150-&gt; ll</font></div><div><font size="2"   >total 65M</font></div><div><font size="2"   >-rw------- 1 ocz ocz 16M Jan 11 09:39 00000001000096E80000005C</font></div><div><font size="2"   >-rw------- 1 ocz ocz 16M Jan 11 09:39 00000001000096E80000005D</font></div><div><font size="2"   >-rw------- 1 ocz ocz 16M Jan 11 09:48 00000001000096E80000005E</font></div><div><font size="2"   >-rw------- 1 ocz ocz 16M Jan 11 09:48 00000001000096E80000005F</font></div><div><font size="2"   >drwx------ 2 ocz ocz 44K Jan 11 09:48 archive_status</font></div><p></p></pre></div><div>-l timelineid,fileid,seg 的数据来自pg_xlog文件名的三个部分, 分别占用8个16进制位.</div><div>段大小为16MB, 所以末端最大为0xFF.</div><div>得出-l 0x1,0x96E8,0x60</div><div><br></div><div>接下来确定-x XID的信息</div><div>来自pg_clog</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; cd $PGDATA/pg_clog</font></div><div><div><font size="2"   >ocz@db-172-16-3-150-&gt; ll -t|head -n 5</font></div><div><font size="2"   >total 43M</font></div><div><font size="2"   >-rw------- 1 ocz ocz 8.0K Jan 11 09:48 0469</font></div><div><font size="2"   >-rw------- 1 ocz ocz 216K Jan 10 21:00 0468</font></div><div><font size="2"   >-rw------- 1 ocz ocz 256K Jan 10 12:56 0467</font></div><div><font size="2"   >-rw------- 1 ocz ocz 256K Jan 10 09:35 0466</font></div></div><p></p></pre></div><div>取最大值加1然后乘以1048576.&nbsp;</div><div>转换成16进制的话相当于<span style="line-height: 22px;"   >取最大值加1然后末尾添加5个0</span></div><div><span style="line-height: 22px;"   >得到-x 0x</span><span style="line-height: 22px;"   >046A00000</span></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >接下来确定</span>-m XID<span style="line-height: 22px;"   >的信息</span></div><div><span style="line-height: 22px;"   >来自</span>pg_multixact/offsets</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; cd $PGDATA/pg_multixact/offsets</font></div><div><font size="2"   >ocz@db-172-16-3-150-&gt; ll</font></div><div><font size="2"   >total 0</font></div><p></p></pre></div><div><div style="line-height: 22px;"   >取最大值加1然后乘以65536.&nbsp;</div><div style="line-height: 22px;"   >转换成16进制的话相当于<span style="line-height: 22px;"   >取最大值加1然后末尾添加4个0</span></div></div><div>没有文件的话使用0加1,&nbsp;<span style="line-height: 22px;"   >然后末尾添加4个0</span></div><div><span style="line-height: 22px;"   >得到-m 0x</span><span style="line-height: 22px;"   >10000</span></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >接下来确定</span>-O OFFSET<span style="line-height: 22px;"   >的信息</span></div><div><span style="line-height: 22px;"   >来自</span>pg_multixact/members</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; cd $PGDATA/pg_multixact/members</font></div><div><font size="2"   >ocz@db-172-16-3-150-&gt; ll</font></div><div><font size="2"   >total 0</font></div><p></p></pre></div><div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >取最大值加1然后乘以65536.&nbsp;</div><div style="line-height: 22px;"   >转换成16进制的话相当于<span style="line-height: 22px;"   >取最大值加1然后末尾添加4个0</span></div></div><div style="line-height: 22px;"   >没有文件的话使用0加1,&nbsp;<span style="line-height: 22px;"   >然后末尾添加4个0</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >得到-O 0x</span><span style="line-height: 22px;"   >10000</span></div></div><div><br></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >最后, 不确定的值有2个 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-e XIDEPOCH</font></div><div><font size="2"   >-o OID</font></div><p></p></pre></div><div>先不管这两个值.</div><div><br></div><div>执行pg_resetxlog 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; pg_resetxlog -l 0x1,0x96E8,0x60 -x 0x046A00000 -m 0x10000 -O 0x10000 -f $PGDATA</font></div><div><font size="2"   >pg_resetxlog: pg_control exists but is broken or unknown version; ignoring it</font></div><div><font size="2"   >Transaction log reset</font></div><p></p></pre></div><div><br></div><div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >8.&nbsp;</span><span style="line-height: 22px;"   >记下pg_controldata信息, 与前面的pg_controldata输出进行比对</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; pg_controldata&nbsp;</font></div><div><font size="2"   >pg_control version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;922</font></div><div><font size="2"   >Catalog version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 201204301</font></div><div><font size="2"   >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5832008033851373032</font></div><div><font size="2"   >Database cluster state: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shut down</font></div><div><font size="2"   >pg_control last modified: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fri 11 Jan 2013 10:09:44 AM CST</font></div><div><font size="2"   >Latest checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 96E8/60000020</font></div><div><font size="2"   >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"   >Latest checkpoint's REDO location: &nbsp; &nbsp;96E8/60000020</font></div><div><font size="2"   >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >Latest checkpoint's full_page_writes: off</font></div><div><font size="2"   >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/1184890880</font></div><div><font size="2"   >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10000</font></div><div><font size="2"   >Latest checkpoint's NextMultiXactId: &nbsp;65536</font></div><div><font size="2"   >Latest checkpoint's NextMultiOffset: &nbsp;65536</font></div><div><font size="2"   >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;3479858176</font></div><div><font size="2"   >Latest checkpoint's oldestXID's DB: &nbsp; 0</font></div><div><font size="2"   >Latest checkpoint's oldestActiveXID: &nbsp;0</font></div><div><font size="2"   >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Fri 11 Jan 2013 10:09:44 AM CST</font></div><div><font size="2"   >Minimum recovery ending location: &nbsp; &nbsp; 0/0</font></div><div><font size="2"   >Backup start location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"   >Backup end location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"   >End-of-backup record required: &nbsp; &nbsp; &nbsp; &nbsp;no</font></div><div><font size="2"   >Current wal_level setting: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;minimal</font></div><div><font size="2"   >Current max_connections setting: &nbsp; &nbsp; &nbsp;100</font></div><div><font size="2"   >Current max_prepared_xacts setting: &nbsp; 0</font></div><div><font size="2"   >Current max_locks_per_xact setting: &nbsp; 64</font></div><div><font size="2"   >Maximum data alignment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8</font></div><div><font size="2"   >Database block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8192</font></div><div><font size="2"   >Blocks per segment of large relation: 131072</font></div><div><font size="2"   >WAL block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 16384</font></div><div><font size="2"   >Bytes per WAL segment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16777216</font></div><div><font size="2"   >Maximum length of identifiers: &nbsp; &nbsp; &nbsp; &nbsp;64</font></div><div><font size="2"   >Maximum columns in an index: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;32</font></div><div><font size="2"   >Maximum size of a TOAST chunk: &nbsp; &nbsp; &nbsp; &nbsp;1996</font></div><div><font size="2"   >Date/time type storage: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64-bit integers</font></div><div><font size="2"   >Float4 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><div><font size="2"   >Float8 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><p></p></pre></div><div>注意修复后从控制文件读取到的不确定的-e XIDEPOCH和-o OID信息如下 :&nbsp;</div><div>也就是initdb后的初始值.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/1184890880 &nbsp;:&nbsp;</span><span style="line-height: 22px;"   >XIDEPOCH=0</span></font></div><div><span style="line-height: 22px;"   ><font size="2"   >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10000</font></span></div><p></p></pre></div><div>与修复pg_control前发生了变化的值如下 :&nbsp;</div><div>修复前</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5832000131111550393</font></div><div><font size="2"   >pg_control last modified: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fri 11 Jan 2013 09:48:18 AM CST</font></div><div><font size="2"   >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;96E8/5EE5C698</font></div><div><div><font size="2"   >Latest checkpoint's full_page_writes: on</font></div><div><font size="2"   >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/1183842312</font></div><div><font size="2"   >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;116414</font></div></div><div><div><font size="2"   >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;1006759584</font></div><div><font size="2"   >Latest checkpoint's oldestXID's DB: &nbsp; 1</font></div></div><div><font size="2"   >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Fri 11 Jan 2013 09:48:18 AM CST</font></div><div><div><font size="2"   >Current wal_level setting: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hot_standby</font></div><div><font size="2"   >Current max_connections setting: &nbsp; &nbsp; &nbsp;1000</font></div><div><font size="2"   >Current max_prepared_xacts setting: &nbsp; 10</font></div></div><p></p></pre></div><div>修复后</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5832008033851373032</font></div><div><font size="2"   >pg_control last modified: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fri 11 Jan 2013 10:09:44 AM CST</font></div><div><font size="2"   >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"   >Latest checkpoint's full_page_writes: off</font></div><div><div><font size="2"   >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/1184890880</font></div><div><font size="2"   >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10000</font></div></div><div><div><font size="2"   >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;3479858176</font></div><div><font size="2"   >Latest checkpoint's oldestXID's DB: &nbsp; 0</font></div></div><div><font size="2"   >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Fri 11 Jan 2013 10:09:44 AM CST</font></div><div><div><font size="2"   >Current wal_level setting: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;minimal</font></div><div><font size="2"   >Current max_connections setting: &nbsp; &nbsp; &nbsp;100</font></div><div><font size="2"   >Current max_prepared_xacts setting: &nbsp; 0</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >9. 启动数据库</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; pg_ctl start</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >ocz@db-172-16-3-150-&gt; LOG: &nbsp;00000: loaded library "pg_stat_statements"</font></div><div><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1249</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >10. 查看测试数据是否正常, 然后新插入数据</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; psql digoal digoal</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=&gt; select min(oid),max(oid),count(*) from oid_test ;</font></div><div><font size="2"   >&nbsp; min &nbsp;| &nbsp;max &nbsp; | count &nbsp;</font></div><div><font size="2"   >-------+--------+--------</font></div><div><font size="2"   >&nbsp;16397 | 116396 | 100000</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>数据可以正常访问.</div><div>新插入数据 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; insert into oid_test select generate_series(100001,200000);</font></div><div><font size="2"   >INSERT 0 100000</font></div><div><font size="2"   >digoal=&gt; select min(oid),max(oid),count(*) from oid_test ;</font></div><div><font size="2"   >&nbsp; min &nbsp;| &nbsp;max &nbsp; | count &nbsp;</font></div><div><font size="2"   >-------+--------+--------</font></div><div><font size="2"   >&nbsp;16384 | 116396 | 200000</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=&gt; select oid,* from oid_test where oid=16397;</font></div><div><font size="2"   >&nbsp; oid &nbsp;| &nbsp; id &nbsp;&nbsp;</font></div><div><font size="2"   >-------+--------</font></div><div><font size="2"   >&nbsp;16397 | &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >&nbsp;16397 | 100014</font></div><div><font size="2"   >(2 rows)</font></div></div><p></p></pre></div><div>注意oid出现了重复, 印证了PostgreSQL中的说明, OID不确保唯一性.</div><div><br></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >11. 关闭数据库, 并记下pg_controldata的信息, 看看有何变化.</span></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; pg_ctl stop -m fast</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div><div><font size="2"   >ocz@db-172-16-3-150-&gt; pg_controldata&nbsp;</font></div><div><font size="2"   >pg_control version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;922</font></div><div><font size="2"   >Catalog version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 201204301</font></div><div><font size="2"   >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5832008033851373032</font></div><div><font size="2"   >Database cluster state: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shut down</font></div><div><font size="2"   >pg_control last modified: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fri 11 Jan 2013 10:16:18 AM CST</font></div><div><font size="2"   >Latest checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 96E8/61000020</font></div><div><font size="2"   >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;96E8/60DFF470</font></div><div><font size="2"   >Latest checkpoint's REDO location: &nbsp; &nbsp;96E8/61000020</font></div><div><font size="2"   >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >Latest checkpoint's full_page_writes: on</font></div><div><font size="2"   >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/1184890883</font></div><div><font size="2"   >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;116385</font></div><div><font size="2"   >Latest checkpoint's NextMultiXactId: &nbsp;65536</font></div><div><font size="2"   >Latest checkpoint's NextMultiOffset: &nbsp;65536</font></div><div><font size="2"   >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;1006759584</font></div><div><font size="2"   >Latest checkpoint's oldestXID's DB: &nbsp; 1</font></div><div><font size="2"   >Latest checkpoint's oldestActiveXID: &nbsp;0</font></div><div><font size="2"   >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Fri 11 Jan 2013 10:16:18 AM CST</font></div><div><font size="2"   >Minimum recovery ending location: &nbsp; &nbsp; 0/0</font></div><div><font size="2"   >Backup start location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"   >Backup end location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"   >End-of-backup record required: &nbsp; &nbsp; &nbsp; &nbsp;no</font></div><div><font size="2"   >Current wal_level setting: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hot_standby</font></div><div><font size="2"   >Current max_connections setting: &nbsp; &nbsp; &nbsp;1000</font></div><div><font size="2"   >Current max_prepared_xacts setting: &nbsp; 10</font></div><div><font size="2"   >Current max_locks_per_xact setting: &nbsp; 64</font></div><div><font size="2"   >Maximum data alignment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8</font></div><div><font size="2"   >Database block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8192</font></div><div><font size="2"   >Blocks per segment of large relation: 131072</font></div><div><font size="2"   >WAL block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 16384</font></div><div><font size="2"   >Bytes per WAL segment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16777216</font></div><div><font size="2"   >Maximum length of identifiers: &nbsp; &nbsp; &nbsp; &nbsp;64</font></div><div><font size="2"   >Maximum columns in an index: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;32</font></div><div><font size="2"   >Maximum size of a TOAST chunk: &nbsp; &nbsp; &nbsp; &nbsp;1996</font></div><div><font size="2"   >Date/time type storage: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64-bit integers</font></div><div><font size="2"   >Float4 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><div><font size="2"   >Float8 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><p></p></pre></div><div>关闭数据库后与刚修复好时的控制文件信息变化如下 :&nbsp;</div><div>开库前 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg_control last modified: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fri 11 Jan 2013 10:09:44 AM CST</font></div><div><div><font size="2"   >Latest checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 96E8/60000020</font></div><div><font size="2"   >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"   >Latest checkpoint's REDO location: &nbsp; &nbsp;96E8/60000020</font></div></div><div><div><font size="2"   >Latest checkpoint's full_page_writes: off</font></div><div><font size="2"   >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/1184890880</font></div><div><font size="2"   >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10000</font></div></div><div><div><font size="2"   >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;3479858176</font></div><div><font size="2"   >Latest checkpoint's oldestXID's DB: &nbsp; 0</font></div></div><div><font size="2"   >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Fri 11 Jan 2013 10:09:44 AM CST</font></div><div><div><font size="2"   >Current wal_level setting: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;minimal</font></div><div><font size="2"   >Current max_connections setting: &nbsp; &nbsp; &nbsp;100</font></div><div><font size="2"   >Current max_prepared_xacts setting: &nbsp; 0</font></div></div><p></p></pre></div><div>关库后 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg_control last modified: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fri 11 Jan 2013 10:16:18 AM CST</font></div><div><div><font size="2"   >Latest checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 96E8/61000020</font></div><div><font size="2"   >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;96E8/60DFF470</font></div><div><font size="2"   >Latest checkpoint's REDO location: &nbsp; &nbsp;96E8/61000020</font></div></div><div><div><font size="2"   >Latest checkpoint's full_page_writes: on</font></div><div><font size="2"   >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/1184890883</font></div><div><font size="2"   >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;116385</font></div></div><div><div><font size="2"   >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;1006759584</font></div><div><font size="2"   >Latest checkpoint's oldestXID's DB: &nbsp; 1</font></div></div><div><font size="2"   >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Fri 11 Jan 2013 10:16:18 AM CST</font></div><div><div><font size="2"   >Current wal_level setting: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hot_standby</font></div><div><font size="2"   >Current max_connections setting: &nbsp; &nbsp; &nbsp;1000</font></div><div><font size="2"   >Current max_prepared_xacts setting: &nbsp; 10</font></div></div><p></p></pre></div><div>【注意】</div><div>1. 使用pg_resetxlog后, 先检查数据一致性, 必要时将数据导出, 使用initdb新建数据库, 再导入.</div><div>2. 如果控制文件丢失, 并且没有备份的话, pg_resetxlog你不知道该填啥, 但是可以从pg_xlog目录中获得大概的redo location, 或者pg_resetxlog 会猜测一些值, 直接-f生成控制文件, 启动数据库后, 可能由于XID回归到以前的XID而致使数据"消失", 你可以使用txid_current()函数不断的消耗XID来得到一致的值.&nbsp;</div><div>参考</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201183043153622/"   >http://blog.163.com/digoal@126/blog/static/163877040201183043153622/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201251911813661/"   >http://blog.163.com/digoal@126/blog/static/163877040201251911813661/</a></div><div>使用pg_xlogdump从xlog中抽取信息, 包括txid.</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020134993845555/"   >http://blog.163.com/digoal@126/blog/static/16387704020134993845555/</a></div><div><br></div>【参考】<div>1. man pg_controldata</div><div>2. man pg_resetxlog</div><div>3.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201171233710582/"   >http://blog.163.com/digoal@126/blog/static/163877040201171233710582/</a></div><div>4.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/"   >http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/</a></div><div><div>5.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/wal-internals.html"   >http://www.postgresql.org/docs/9.2/static/wal-internals.html</a></div><div>6.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/app-pgresetxlog.html"   >http://www.postgresql.org/docs/9.2/static/app-pgresetxlog.html</a></div><div>7.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/pgupgrade.html"   >http://www.postgresql.org/docs/9.2/static/pgupgrade.html</a></div><div>8.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/continuous-archiving.html"   >http://www.postgresql.org/docs/9.2/static/continuous-archiving.html</a></div><div><div>9. src/bin/pg_resetxlog/pg_resetxlog.c</div><div>10. src/include/catalog/pg_control.h</div><div>11. src/bin/pg_controldata/pg_controldata.c</div></div><div>12. src/backend/access/transam/clog.c</div><div>13. src/include/access/clog.h</div><div>14. src/backend/access/transam/xlog.c</div><div>15. src/include/access/xlog.h</div><div><br></div><div><br></div></div></div>
	</div>
</div>
</body>
</html>