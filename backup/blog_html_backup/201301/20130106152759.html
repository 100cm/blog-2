<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL pl/v8 language (use google v8 javascript engine)</h2>
	<h5 id="">2013-01-06 15:27:59&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013045395446/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>PostgreSQL 过程语言较多, 如pljava, plpgsql, pltcl, plpython 等.</div><div>因为前段时间想劝说一些使用mongoDB的业务迁移到PostgreSQL, 开发人员认为PostgreSQL不支持javascript比较犹豫.</div><div>那么PostgreSQL如何支持javascript呢? 其中一种方法是使用plv8语言.</div><div>本文涉及到的是plv8的安装部分.</div><div>详细的使用请参考 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://api.pgxn.org/src/plv8/plv8-1.3.0/"   >http://api.pgxn.org/src/plv8/plv8-1.3.0/</a></div><div>安装前首先确认gcc和gmake的版本, gcc请使用4.1.x, gmake请使用3.81以上版本.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 ~]# gcc -v</font></div><div><font size="2"   >Using built-in specs.</font></div><div><font size="2"   >Target: x86_64-redhat-linux</font></div><div><font size="2"   >Configured with: ../configure --prefix=/usr --mandir=/usr/share/man --infodir=/usr/share/info --enable-shared --enable-threads=posix --enable-checking=release --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-libgcj-multifile --enable-languages=c,c++,objc,obj-c++,java,fortran,ada --enable-java-awt=gtk --disable-dssi --disable-plugin --with-java-home=/usr/lib/jvm/java-1.4.2-gcj-1.4.2.0/jre --with-cpu=generic --host=x86_64-redhat-linux</font></div><div><font size="2"   >Thread model: posix</font></div><div><font size="2"   >gcc version 4.1.2 20080704 (Red Hat 4.1.2-51)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-33 ~]# gmake -v</font></div><div><font size="2"   >GNU Make 3.81</font></div><div><font size="2"   >Copyright (C) 2006 &nbsp;Free Software Foundation, Inc.</font></div><div><font size="2"   >This is free software; see the source for copying conditions.</font></div><div><font size="2"   >There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A</font></div><div><font size="2"   >PARTICULAR PURPOSE.</font></div><div><font size="2"   >This program built for x86_64-redhat-linux-gnu</font></div><p></p></pre></div><div><br></div><div>python 版本同样需要注意, 使用2.4.3版本可能编译无法通过, 语法错误.&nbsp;</div><div>如果遇到python版本问题, 请使用2.7.3版本.</div><div><br></div><div>首先下载v8引擎, 两种方式如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >git clone git://github.com/v8/v8.git v8</font></div><div><font size="2"   >或者</font></div><div><font size="2"   >wget --no-check-certificate https://github.com/v8/v8/archive/master.zip</font></div><p></p></pre></div><div><br></div><div>接下来安装v8引擎, 因为plv8要用到libv8.so 共享库.</div><div>请使用plv8要求的v8版本. 不一定要最新的. 例如1.4.1版本的plv8说明 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >plv8 1.4.1</font></div><div><div><font size="2"   >plv8 is tested with:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >- PG: version 8.4, 9.0, 9.1, 9.2 and 9.3dev (maybe older are allowed)</font></div><div><font size="2"   >- V8: version 3.14.5</font></div><div><font size="2"   >- g++: version 4.5.1</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >进到目录 :&nbsp;</span></div><div><pre class="prettyprint"   ><p><font size="2"   >cd v8 或 cd v8-master</font></p></pre></div><div><br></div><div>v8依赖谷歌的gyp, 需要把gyp的源码放到v8的源码根目录的build/gyp位置.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >make dependencies</font></div><div><font size="2"   >或在v8源码根目录执行如下 :&nbsp;</font></div><div><font size="2"   >svn co http://gyp.googlecode.com/svn/trunk build/gyp</font></div><p></p></pre></div><div><br></div><div>如果python版本太低则可能遇到以下编译错误 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@db-172-16-3-33-&gt; make x64.release</font></div><div><font size="2"   >GYP_GENERATORS=make \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; build/gyp/gyp --generator-output="out" build/all.gyp \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -Ibuild/standalone.gypi --depth=. \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -Dv8_target_arch=x64 \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -S.x64 &nbsp;-Dv8_enable_backtrace=1 -Dv8_can_use_vfp2_instructions=true -Darm_fpu=vfpv2 -Dv8_can_use_vfp3_instructions=true -Darm_fpu=vfpv3</font></div><div><font size="2"   >Traceback (most recent call last):</font></div><div><font size="2"   >&nbsp; File "build/gyp/gyp", line 15, in ?</font></div><div><font size="2"   >&nbsp; &nbsp; import gyp</font></div><div><font size="2"   >&nbsp; File "build/gyp/pylib/gyp/__init__.py", line 8, in ?</font></div><div><font size="2"   >&nbsp; &nbsp; import gyp.input</font></div><div><font size="2"   >&nbsp; File "build/gyp/pylib/gyp/input.py", line 14, in ?</font></div><div><font size="2"   >&nbsp; &nbsp; import gyp.common</font></div><div><font size="2"   >&nbsp; File "build/gyp/pylib/gyp/common.py", line 395</font></div><div><font size="2"   >&nbsp; &nbsp; with open(source_path) as source_file:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   >SyntaxError: invalid syntax</font></div><div><font size="2"   >make: *** [out/Makefile.x64] Error 1</font></div><p></p></pre></div><div><br></div><div>安装2.7.3的python版本.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >wget http://python.org/ftp/python/2.7.3/Python-2.7.3.tgz</font></div><div><font size="2"   >tar -zxvf Python-2.7.3.tgz</font></div><div><font size="2"   >cd Python-2.7.3</font></div><div><font size="2"   >./configure&nbsp;</font></div><div><font size="2"   >make</font></div><div><font size="2"   >make install</font></div><div><font size="2"   >root@db-172-16-3-33-&gt; python -V</font></div><div><font size="2"   >Python 2.7.3</font></div><p></p></pre></div><div><br></div><div>重新到v8源码目录安装v8.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd v8 或 cd v8-master</font></div><div><font size="2"   >root@db-172-16-3-33-&gt; make x64.release</font></div><div><font size="2"   >cc1plus: warnings being treated as errors</font></div><div><font size="2"   >../src/heap.h: In member function ‘v8::internal::byte** v8::internal::Heap::store_buffer_top_address()’:</font></div><div><font size="2"   >../src/heap.h:1264: warning: dereferencing type-punned pointer will break strict-aliasing rules</font></div><div><font size="2"   >make[1]: *** [/root/v8-master/out/x64.release/obj.target/v8_base/src/accessors.o] Error 1</font></div><div><font size="2"   >make[1]: Leaving directory `/root/v8-master/out'</font></div><div><font size="2"   >make: *** [x64.release] Error 2</font></div><p></p></pre></div><div><br></div><div>加上werror=no可以编译通过.</div><div><pre class="prettyprint"   ><p><font size="2"   >gmake x64.release -j 4 library=shared werror=no</font></p></pre></div><div><br></div><div>找到libv8.so</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@db-172-16-3-33-&gt; find / -name libv8.so -print</font></div><div><font size="2"   >/root/v8-master/out/x64.release/lib.target/libv8.so</font></div><div><font size="2"   >/root/v8-master/out/x64.release/obj.target/tools/gyp/libv8.so</font></div><div><font size="2"   >root@db-172-16-3-33-&gt; md5sum /root/v8-master/out/x64.release/lib.target/libv8.so</font></div><div><font size="2"   >b03edfbfda768381047a5ad679bb69be &nbsp;/root/v8-master/out/x64.release/lib.target/libv8.so</font></div><div><font size="2"   >root@db-172-16-3-33-&gt; md5sum /root/v8-master/out/x64.release/obj.target/tools/gyp/libv8.so</font></div><div><font size="2"   >b03edfbfda768381047a5ad679bb69be &nbsp;/root/v8-master/out/x64.release/obj.target/tools/gyp/libv8.so</font></div><p></p></pre></div><div>将libv8.so拷贝到$PGHOME/lib</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@db-172-16-3-33-&gt; which psql</font></div><div><font size="2"   >/home/digoal/pgsql91/bin/psql</font></div><div><font size="2"   >root@db-172-16-3-33-&gt; cp /root/v8-master/out/x64.release/lib.target/libv8.so /home/digoal/pgsql91/lib/</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >安装plv8前, 确保pg_config在PATH中 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - root</font></div><div><font size="2"   >. /home/digoal/.bash_profile</font></div><div><font size="2"   >root@db-172-16-3-33-&gt; which pg_config</font></div><div><font size="2"   >/home/digoal/pgsql91/bin/pg_config</font></div><p></p></pre></div><div><br></div><div>下载plv8源码 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd /home/digoal</font></div><div><font size="2"   >wget http://api.pgxn.org/dist/plv8/1.3.0/plv8-1.3.0.zip</font></div><div><font size="2"   >unzip plv8-1.3.0.zip</font></div><p></p></pre></div><div>将解压后的plv8放到PostgreSQL 源码的contrib目录下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >mv plv8-1.3.0 postgresql-9.1.3/contrib/</font></div><div><font size="2"   >cd postgresql-9.1.3/contrib/plv8-1.3.0/</font></div><p></p></pre></div><div>修改Makefile, 因为要用到v8.h的头文件</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >less plv8.h</font></div><div><div><font size="2"   >#include &lt;v8.h&gt;</font></div><div><font size="2"   >#ifdef ENABLE_DEBUGGER_SUPPORT</font></div><div><font size="2"   >#include &lt;v8-debug.h&gt;</font></div><div><font size="2"   >#endif &nbsp;// ENABLE_DEBUGGER_SUPPORT</font></div></div><p></p></pre></div><div>vi Makefile</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CCFLAGS = -Wall $(OPTFLAGS) $(OPT_ENABLE_DEBUGGER_SUPPORT)</font></div><div><font size="2"   >改成</font></div><div><font size="2"   >CCFLAGS = -Wall $(OPTFLAGS) $(OPT_ENABLE_DEBUGGER_SUPPORT) -I/root/v8-master/include</font></div><p></p></pre></div><div>安装plv8 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >gmake clean</font></div><div><font size="2"   >gmake</font></div><div><font size="2"   >gmake install</font></div><p></p></pre></div><div><br></div><div>plv8带三个extension, plv8, plls, plcoffee. 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd $PGHOME/share/extension/</font></div><div><font size="2"   >digoal@db-172-16-3-33-&gt; cat plv8--1.3.0.sql&nbsp;</font></div><div><font size="2"   >CREATE FUNCTION plv8_call_handler() RETURNS language_handler</font></div><div><font size="2"   >&nbsp;AS 'MODULE_PATHNAME' LANGUAGE C;</font></div><div><font size="2"   >CREATE FUNCTION plv8_inline_handler(internal) RETURNS void</font></div><div><font size="2"   >&nbsp;AS 'MODULE_PATHNAME' LANGUAGE C;</font></div><div><font size="2"   >CREATE FUNCTION plv8_call_validator(oid) RETURNS void</font></div><div><font size="2"   >&nbsp;AS 'MODULE_PATHNAME' LANGUAGE C;</font></div><div><font size="2"   >CREATE TRUSTED LANGUAGE plv8</font></div><div><font size="2"   >&nbsp;HANDLER plv8_call_handler</font></div><div><font size="2"   >&nbsp;INLINE plv8_inline_handler</font></div><div><font size="2"   >&nbsp;VALIDATOR plv8_call_validator;</font></div><div><font size="2"   >CREATE DOMAIN plv8_int2array AS int2[];</font></div><div><font size="2"   >CREATE DOMAIN plv8_int4array AS int4[];</font></div><div><font size="2"   >CREATE DOMAIN plv8_float4array AS float4[];</font></div><div><font size="2"   >CREATE DOMAIN plv8_float8array AS float8[];</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal@db-172-16-3-33-&gt; cat plls--1.3.0.sql&nbsp;</font></div><div><font size="2"   >CREATE FUNCTION plls_call_handler() RETURNS language_handler</font></div><div><font size="2"   >&nbsp;AS 'MODULE_PATHNAME' LANGUAGE C;</font></div><div><font size="2"   >CREATE FUNCTION plls_inline_handler(internal) RETURNS void</font></div><div><font size="2"   >&nbsp;AS 'MODULE_PATHNAME' LANGUAGE C;</font></div><div><font size="2"   >CREATE FUNCTION plls_call_validator(oid) RETURNS void</font></div><div><font size="2"   >&nbsp;AS 'MODULE_PATHNAME' LANGUAGE C;</font></div><div><font size="2"   >CREATE TRUSTED LANGUAGE plls</font></div><div><font size="2"   >&nbsp;HANDLER plls_call_handler</font></div><div><font size="2"   >&nbsp;INLINE plls_inline_handler</font></div><div><font size="2"   >&nbsp;VALIDATOR plls_call_validator;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal@db-172-16-3-33-&gt; cat plcoffee--1.3.0.sql&nbsp;</font></div><div><font size="2"   >CREATE FUNCTION plcoffee_call_handler() RETURNS language_handler</font></div><div><font size="2"   >&nbsp;AS 'MODULE_PATHNAME' LANGUAGE C;</font></div><div><font size="2"   >CREATE FUNCTION plcoffee_inline_handler(internal) RETURNS void</font></div><div><font size="2"   >&nbsp;AS 'MODULE_PATHNAME' LANGUAGE C;</font></div><div><font size="2"   >CREATE FUNCTION plcoffee_call_validator(oid) RETURNS void</font></div><div><font size="2"   >&nbsp;AS 'MODULE_PATHNAME' LANGUAGE C;</font></div><div><font size="2"   >CREATE TRUSTED LANGUAGE plcoffee</font></div><div><font size="2"   >&nbsp;HANDLER plcoffee_call_handler</font></div><div><font size="2"   >&nbsp;INLINE plcoffee_inline_handler</font></div><div><font size="2"   >&nbsp;VALIDATOR plcoffee_call_validator;</font></div><p></p></pre></div><div><br></div><div>在需要用的数据库中创建extension .</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@db-172-16-3-33-&gt; su - digoal</font></div><div><font size="2"   >digoal@db-172-16-3-33-&gt; psql digoal</font></div><div><font size="2"   >psql (9.1.3)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=&gt; \c digoal postgres</font></div><div><font size="2"   >You are now connected to database "digoal" as user "postgres".</font></div><div><font size="2"   >digoal=# create extension plv8;</font></div><div><font size="2"   >CREATE EXTENSION</font></div><div><font size="2"   >digoal=# create extension plls;</font></div><div><font size="2"   >CREATE EXTENSION</font></div><div><font size="2"   >digoal=# create extension plcoffee;</font></div><div><font size="2"   >CREATE EXTENSION</font></div><p></p></pre></div><div><br></div><div>【测试】</div><div>本文略</div><div><br></div><div>[其他]</div><div>1. 如果遇到类似</div><pre class="prettyprint"   ><p></p><div><font size="2"   >ar: illegal option -- T</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >的错误, 说明你下载了较新版本的v8, ar时使用了T选项.</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >root@digoal-Dell-System-Vostro-3450:~# ar -V</font></div><div><font size="2"   >GNU ar (GNU Binutils for Ubuntu) 2.22</font></div><div><font size="2"   >Copyright 2011 Free Software Foundation, Inc.</font></div><div><font size="2"   >This program is free software; you may redistribute it under the terms of</font></div><div><font size="2"   >the GNU General Public License version 3 or (at your option) any later version.</font></div><div><font size="2"   >This program has absolutely no warranty.</font></div></div><div><font size="2"   >man ar</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;T &nbsp; Make the specified archive a thin archive. &nbsp;If it already exists and is a regular archive, the existing members must</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;be present in the same directory as archive.</font></div></div><div><font size="2"   >ar -h</font></div><div><font size="2"   >&nbsp; [T] &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- make a thin archive</font></div><p></p></pre></div><div>老版本的ar没有T选项, 所以编译v8时将报错 .</div><div>怎么处理呢. 在执行完svn co http://gyp.googlecode.com/svn/trunk build/gyp后</div><div>检索crsT.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 v8-3.21.0]# grep -r crsT *</font></div><div><font size="2"   >[root@db-172-16-3-33 v8-3.21.0]# vi build/gyp/pylib/gyp/generator/make.py</font></div><div><font size="2"   >[root@db-172-16-3-33 v8-3.21.0]# vi build/gyp/pylib/gyp/generator/.svn/text-base/make.py.svn-base</font></div><p></p></pre></div><div>把crsT改成crs, 例如</div><pre class="prettyprint"   ><p></p><div><font size="2"   >cmd_alink_thin = rm -f $@ &amp;&amp; $(AR.$(TOOLSET)) crs $@ $(filter %.o,$^)</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >保存, 执行</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 v8-3.21.0]# make x64 -j 4 library=shared werror=no</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >即可</span></div><div><br></div></div><div>【参考】</div><div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://www.ecma-international.org/publications/standards/Ecma-262.htm"   >http://www.ecma-international.org/publications/standards/Ecma-262.htm</a></div><div>2.&nbsp;<a target="_blank" rel="nofollow" href="http://en.wikipedia.org/wiki/Ecma"   >http://en.wikipedia.org/wiki/Ecma</a></div><div>3.&nbsp;<a target="_blank" rel="nofollow" href="https://developers.google.com/v8/intro"   >https://developers.google.com/v8/intro</a></div><div>4.&nbsp;<a target="_blank" rel="nofollow" href="http://docs.mongodb.org/manual/release-notes/2.4/"   >http://docs.mongodb.org/manual/release-notes/2.4/</a></div><div>5.&nbsp;<a target="_blank" rel="nofollow" href="http://pgxn.org/dist/plv8/doc/plv8.html"   >http://pgxn.org/dist/plv8/doc/plv8.html</a></div><div>6.&nbsp;<a target="_blank" rel="nofollow" href="https://github.com/v8/v8"   >https://github.com/v8/v8</a></div><div>7.&nbsp;<a target="_blank" rel="nofollow" href="http://code.google.com/p/v8/"   >http://code.google.com/p/v8/</a></div><div>8.&nbsp;<a target="_blank" rel="nofollow" href="http://code.google.com/p/gyp/"   >http://code.google.com/p/gyp/</a></div><div><div style="line-height: 22px;"   >9. git install</div><div style="line-height: 22px;"   ><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201242512825860/"   >http://blog.163.com/digoal@126/blog/static/163877040201242512825860/</a></div></div>10.&nbsp;<a rel="nofollow" href="https://code.google.com/p/v8/wiki/BuildingWithGYP"   >https://code.google.com/p/v8/wiki/BuildingWithGYP</a>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL pl/v8 language (use google v8 javascript engine) - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>