<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL delete | update returning</h2>
	<h5 id="">2013-01-22 15:41:59&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020130223386433/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 支持delete, update返回删除前的值以及更新后的值.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >postgres=# create table test (old text, new text, mod_time timestamp);</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >postgres=# insert into test values ('old', 'new', now());</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >postgres=# select * from test ;</font></div><div><font size="2"  >&nbsp;old | new | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >-----+-----+----------------------------</font></div><div><font size="2"  >&nbsp;old | new | 2013-01-22 15:36:02.543393</font></div><div><font size="2"  >(1 row)</font></div></div><div><div><font size="2"  ><br></font></div><div><div><font size="2"  >postgres=# update test set new='DIGOAL', old=new, mod_time=clock_timestamp() returning *;</font></div><div><font size="2"  >&nbsp;old | &nbsp;new &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >-----+--------+----------------------------</font></div><div><font size="2"  >&nbsp;new | DIGOAL | 2013-01-22 15:36:40.062419</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >UPDATE 1</font></div></div></div><div><font size="2"  >update returning 返回的是更新后的值.</font></div><div><font size="2"  ><br></font></div><div><div><font size="2"  >postgres=# select * from test ;</font></div><div><font size="2"  >&nbsp;old | &nbsp;new &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >-----+--------+----------------------------</font></div><div><font size="2"  >&nbsp;new | DIGOAL | 2013-01-22 15:36:40.062419</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# delete from test returning *;</font></div><div><font size="2"  >&nbsp;old | &nbsp;new &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >-----+--------+----------------------------</font></div><div><font size="2"  >&nbsp;new | DIGOAL | 2013-01-22 15:36:40.062419</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >DELETE 1</font></div></div><div><font size="2"  >delete returning 返回的是删除前的值.</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >returning 后的子句类似select ... from 中的子句, 所以也支持表达式 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# insert into test values ('old', 'new', now());</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >postgres=# update test set new='DIGOAL', old=new, mod_time=clock_timestamp() returning 1,2,3,old,new,mod_time,old||new;</font></div><div><font size="2"  >&nbsp;?column? | ?column? | ?column? | old | &nbsp;new &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| ?column? &nbsp;</font></div><div><font size="2"  >----------+----------+----------+-----+--------+----------------------------+-----------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp;3 | new | DIGOAL | 2013-01-22 15:39:13.238924 | newDIGOAL</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >UPDATE 1</font></div><p></p></pre></div><div><br></div><div>【注意】</div><div>1. update 中, 如果将一个字段的值赋予给另一个字段, 那会将更新前的值赋予给它, 而不是更新后的值.</div><div>如上 :&nbsp;</div><div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div><div style="line-height: 22px;"  ><font size="2"  >postgres=# update test set new='DIGOAL', old=new, mod_time=clock_timestamp() returning 1,2,3,old,new,mod_time,old||new;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp;?column? | ?column? | ?column? | old | &nbsp;new &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| ?column? &nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  >----------+----------+----------+-----+--------+----------------------------+-----------</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp;2 | &nbsp; &nbsp; &nbsp; &nbsp;3 | new | DIGOAL | 2013-01-22 15:39:13.238924 | newDIGOAL</font></div><div style="line-height: 22px;"  ><font size="2"  >(1 row)</font></div><div style="line-height: 22px;"  ><font size="2"  >UPDATE 1</font></div></div><div style="line-height: 22px;"  ><font size="2"  ><span style="line-height: 22px;"  >new='DIGOAL',&nbsp;</span>old=new</font></div><p></p></pre></div></div><div style="line-height: 22px;"  >更新后 :&nbsp;</div><div style="line-height: 22px;"  >old = 'new' (new字段更新前的值)</div><div style="line-height: 22px;"  >new = 'DIGOAL'</div><div><br></div><div>【参考】</div><div><span style="line-height: 22px;"  >1.&nbsp;</span><a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/sql-delete.html"  >http://www.postgresql.org/docs/9.2/static/sql-delete.html</a></div><div><span style="line-height: 22px;"  >2.&nbsp;</span><a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/sql-update.html"  >http://www.postgresql.org/docs/9.2/static/sql-update.html</a></div><wbr></div>
	</div>
</div>
</body>
</html>