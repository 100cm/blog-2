<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">edit guc.c upgrade PostgreSQL 9.0.x max_standby_archive_delay and max_standby_streaming_delay to 2147483647 ms</h2>
	<h5 id="">2012-09-06 17:27:06&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020128651836977/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>使用PostgreSQL 9.0.x的朋友, 如果用到了standby做大事务的查询, 可能会遇到过query 被强制cancel的情况, 通过调整max_standby_archive_delay或max_standby_streaming_delay, 最大可以调整到2147483毫秒(<span style="line-height: 22px;"  >通过查看pg_settings得到</span>).</div><div>如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select * from pg_settings where name ~ 'max_standby_archive_delay';</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| setting | unit | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; category &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sh</font></div><div><font size="2"  >ort_desc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extra_desc | context | vartype | source &nbsp;| min_val | max_val | enumvals |</font></div><div><font size="2"  >&nbsp;boot_val | reset_val | sourcefile | sourceline&nbsp;</font></div><div><font size="2"  >---------------------------+---------+------+-----------------------------------+---------------------------------------------------</font></div><div><font size="2"  >---------------------------------------------------------+------------+---------+---------+---------+---------+---------+----------+</font></div><div><font size="2"  >----------+-----------+------------+------------</font></div><div><font size="2"  >&nbsp;max_standby_archive_delay | 30000 &nbsp; | ms &nbsp; | Write-Ahead Log / Standby Servers | Sets the maximum delay before canceling queries wh</font></div><div><font size="2"  >en a hot standby server is processing archived WAL data. | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| sighup &nbsp;| integer | default | -1 &nbsp; &nbsp; &nbsp;| 2147483 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"  >&nbsp;30000 &nbsp; &nbsp;| 30000 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>也许就算调到最大仍旧不能满足需求, 那就只能升级到9.1 了, 因为9.1修改了这两个参数的最大限制, 如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; &nbsp; &nbsp;* Increase the maximum values for max_standby_archive_delay and</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;max_standby_streaming_delay</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;The maximum value for each of these parameters was previously only</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;about 35 minutes. Much larger values are now allowed.</font></div><p></p></pre></div><div>那么不升级版本行不行呢?</div><div>我们首先来看看这个源码在什么地方?</div><div>下面是9.0的源码 :&nbsp;</div><div><div>https://raw.github.com/postgres/postgres/REL9_0_STABLE/src/backend/utils/misc/guc.c</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  ><span> </span>{</font></div><div><font size="2"  ><span> </span>{"max_standby_archive_delay", PGC_SIGHUP, WAL_STANDBY_SERVERS,</font></div><div><font size="2"  ><span> </span>gettext_noop("Sets the maximum delay before canceling queries when a hot standby server is processing archived WAL data."),</font></div><div><font size="2"  ><span> </span>NULL,</font></div><div><font size="2"  ><span> </span>GUC_UNIT_MS</font></div><div><font size="2"  ><span> </span>},</font></div><div><font size="2"  ><span> </span>&amp;max_standby_archive_delay,</font></div><div><font size="2"  ><span> </span>30 * 1000, -1, INT_MAX / 1000, NULL, NULL</font></div><div><font size="2"  ><span> </span>},</font></div></div><div><font size="2"  ><span> </span>{</font></div><div><font size="2"  ><span> </span>{"max_standby_streaming_delay", PGC_SIGHUP, WAL_STANDBY_SERVERS,</font></div><div><font size="2"  ><span> </span>gettext_noop("Sets the maximum delay before canceling queries when a hot standby server is processing streamed WAL data."),</font></div><div><font size="2"  ><span> </span>NULL,</font></div><div><font size="2"  ><span> </span>GUC_UNIT_MS</font></div><div><font size="2"  ><span> </span>},</font></div><div><font size="2"  ><span> </span>&amp;max_standby_streaming_delay,</font></div><div><font size="2"  ><span> </span>30 * 1000, -1, INT_MAX / 1000, NULL, NULL</font></div><div><font size="2"  ><span> </span>},</font></div><p></p></pre></div><div>max值是<span style="line-height: 22px;"  >INT_MAX / 1000, 这里INT_MAX = int, 有符号整形, 除以1000刚好就是</span></div><div><br></div><div><span style="line-height: 22px;"  >下面是9.1的源码 :&nbsp;</span></div><div>https://raw.github.com/postgres/postgres/REL9_1_STABLE/src/backend/utils/misc/guc.c</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  ><span> </span>{</font></div><div><font size="2"  ><span> </span>{"max_standby_archive_delay", PGC_SIGHUP, REPLICATION_STANDBY,</font></div><div><font size="2"  ><span> </span>gettext_noop("Sets the maximum delay before canceling queries when a hot standby server is processing archived WAL data."),</font></div><div><font size="2"  ><span> </span>NULL,</font></div><div><font size="2"  ><span> </span>GUC_UNIT_MS</font></div><div><font size="2"  ><span> </span>},</font></div><div><font size="2"  ><span> </span>&amp;max_standby_archive_delay,</font></div><div><font size="2"  ><span> </span>30 * 1000, -1, INT_MAX,</font></div><div><font size="2"  ><span> </span>NULL, NULL, NULL</font></div><div><font size="2"  ><span> </span>},</font></div></div><div><font size="2"  ><span> </span>{</font></div><div><font size="2"  ><span> </span>{"max_standby_streaming_delay", PGC_SIGHUP, REPLICATION_STANDBY,</font></div><div><font size="2"  ><span> </span>gettext_noop("Sets the maximum delay before canceling queries when a hot standby server is processing streamed WAL data."),</font></div><div><font size="2"  ><span> </span>NULL,</font></div><div><font size="2"  ><span> </span>GUC_UNIT_MS</font></div><div><font size="2"  ><span> </span>},</font></div><div><font size="2"  ><span> </span>&amp;max_standby_streaming_delay,</font></div><div><font size="2"  ><span> </span>30 * 1000, -1, INT_MAX,</font></div><div><font size="2"  ><span> </span>NULL, NULL, NULL</font></div><div><font size="2"  ><span> </span>},</font></div><p></p></pre></div></div><div><br></div><div>很好, 修改PostgreSQL 9.0.x的这个源码文件.<span style="line-height: 22px;"  >INT_MAX / 1000改成</span><span style="line-height: 22px;"  >INT_MAX. 然后按照你原来编译的参数重新编译安装.</span></div><div>使用新的pgsql安装文件启动数据库. 启动后查看pg_settings, 最大值已经变化, 可以改为最大试试.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >max_standby_archive_delay = 21474830ms &nbsp;# max delay before canceling queries</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # when reading WAL from archive;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # -1 allows indefinite delay</font></div><div><font size="2"  >max_standby_streaming_delay = 21474830ms &nbsp; &nbsp; &nbsp; &nbsp;# max delay before canceling queries</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # when reading streaming WAL;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # -1 allows indefinite delay</font></div><p></p></pre></div><div>pg_ctl start</div><div><br></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db1-&gt; psql&nbsp;</font></div><div><font size="2"  >psql (9.0.2)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# select * from pg_settings where name ~ 'stream';</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | setting &nbsp;| unit | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; category &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp;short_desc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extra_desc | context | vartype | &nbsp; &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; | min_val | &nbsp;max_v</font></div><div><font size="2"  >al &nbsp; | enumvals | boot_val | reset_val | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sourcefile &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| sourceline&nbsp;</font></div><div><font size="2"  >-----------------------------+----------+------+-----------------------------------+------------------------------------------------</font></div><div><font size="2"  >------------------------------------------------------------+------------+---------+---------+--------------------+---------+-------</font></div><div><font size="2"  >-----+----------+----------+-----------+----------------------------------+------------</font></div><div><font size="2"  >&nbsp;max_standby_streaming_delay | 21474830 | ms &nbsp; | Write-Ahead Log / Standby Servers | Sets the maximum delay before canceling queries</font></div><div><font size="2"  >&nbsp;when a hot standby server is processing streamed WAL data. | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| sighup &nbsp;| integer | configuration file | -1 &nbsp; &nbsp; &nbsp;| 214748</font></div><div><font size="2"  >3647 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 30000 &nbsp; &nbsp;| 21474830 &nbsp;| /database/pgdata/postgresql.conf | &nbsp; &nbsp; &nbsp; &nbsp;202</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><wbr></div>
	</div>
</div>
</body>
</html>