<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">match ip address from text</h2>
	<h5 id="">2012-09-24 17:30:23&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201282453023981/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>今天一位网友问到规则表达式能不能把IP地址从字符串中匹配出来.</div><div>先提供一个参考, 完全用规则表达式来实现应该来说也是可以的, 只是对IP地址的校验会比较麻烦, 如1.1.1.1000它不是一个IP.</div><div>但是<span style="line-height: 22px;"   >(\d+\.\d+\.\d+\.\d+) 来匹配时能够匹配.</span></div><div><span style="line-height: 22px;"   >下面提供一个函数给大家一个思路, 使用数据库的类型转换来检验IP地址的合法性, 当然这个肯定是可以直接掉C的接口来实现的, 暂时不多说了 :&nbsp;</span></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >1.1.1.1000格式正确但是IP地址不合法 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# do language plpgsql</font></div><div><font size="2"   >$$</font></div><div><font size="2"   >declare&nbsp;</font></div><div><font size="2"   >  i_ip text;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >  select substring('abc1.1.1.1000.100def','(\d+\.\d+\.\d+\.\d+)') into i_ip;&nbsp;</font></div><div><font size="2"   >  raise notice 'ip: %', i_ip::inet;&nbsp;</font></div><div><font size="2"   >  exception</font></div><div><font size="2"   >  when others then</font></div><div><font size="2"   >    raise notice '% is not a ip', i_ip;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >NOTICE: &nbsp;1.1.1.1000 is not a ip</font></div><div><font size="2"   >DO</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >1.1.1.100格式正确并且IP地址合法 :&nbsp;</span> </div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgre</font><span style="font-size: small;"   >s=# do language plpgsql</span></div><div><font size="2"   >$$</font></div><div><font size="2"   >declare&nbsp;</font></div><div><font size="2"   >  i_ip text;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >  select substring('abc1.1.1.100.100def','(\d+\.\d+\.\d+\.\d+)') into i_ip;&nbsp;</font></div><div><font size="2"   >  raise notice 'ip: %', i_ip::inet; &nbsp;</font></div><div><font size="2"   >  exception</font></div><div><font size="2"   >  when others then</font></div><div><font size="2"   >    raise notice '% is not a ip', i_ip;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >NOTICE: &nbsp;ip: 1.1.1.100</font></div><div><font size="2"   >DO</font></div><p></p></pre></div><wbr><div>所以写成通用的函数如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace function conv_text_to_inetv4 (i_text text) returns inet as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_ip_str text;</font></div><div><font size="2"   >&nbsp; v_ip inet;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select substring(i_text, '(\d+\.\d+\.\d+\.\d+)') into v_ip_str;</font></div><div><font size="2"   >&nbsp; v_ip := v_ip_str::inet;</font></div><div><font size="2"   >&nbsp; return v_ip;</font></div><div><font size="2"   >&nbsp; exception</font></div><div><font size="2"   >&nbsp; when others then</font></div><div><font size="2"   >&nbsp; &nbsp; return null;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql;</font></div><p></p></pre></div><div><br></div><div>测试如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select conv_text_to_inetv4('abc1.1.1.100dee');</font></div><div><font size="2"   >&nbsp;conv_text_to_inetv4&nbsp;</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;1.1.1.100</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select conv_text_to_inetv4('abc1.1.1.1000dee');</font></div><div><font size="2"   >&nbsp;conv_text_to_inetv4&nbsp;</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div>【参考】<div>1.&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/functions-matching.html"   >http://www.postgresql.org/docs/9.2/static/functions-matching.html</a></div><div>2. src/backend/utils/adt/network.c<br><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* Common INET/CIDR input routine</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static inet *</font></div><div><font size="2"   >network_in(char *src, bool is_cidr)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bits;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; inet &nbsp; &nbsp; &nbsp; *dst;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; dst = (inet *) palloc0(sizeof(inet));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* First, check to see if this is an IPv6 or IPv4 address. &nbsp; &nbsp; &nbsp;IPv6 addresses</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* will have a : somewhere in them (several, in fact) so if there is one</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* present, assume it's V6, otherwise assume it's V4.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (strchr(src, ':') != NULL)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ip_family(dst) = PGSQL_AF_INET6;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ip_family(dst) = PGSQL_AF_INET;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bits = inet_net_pton(ip_family(dst), src, ip_addr(dst),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;is_cidr ? ip_addrsize(dst) : -1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if ((bits &lt; 0) || (bits &gt; ip_maxbits(dst)))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_INVALID_TEXT_REPRESENTATION),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* translator: first %s is inet or cidr */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("invalid input syntax for type %s: \"%s\"",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; is_cidr ? "cidr" : "inet", src)));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Error check: CIDR values must not have any bits set beyond the masklen.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (is_cidr)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!addressOK(ip_addr(dst), bits, ip_family(dst)))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_INVALID_TEXT_REPRESENTATION),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("invalid cidr value: \"%s\"", src),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errdetail("Value has bits set to right of mask.")));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ip_bits(dst) = bits;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; SET_INET_VARSIZE(dst);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return dst;</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="match ip address from text - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>