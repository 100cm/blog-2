<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use dml instead of trigger on views implement increment migration</h2>
	<h5 id="">2012-09-10 11:33:33&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012810112526993/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>数据迁移是DBA经常干的事情之一, 譬如从Oracle迁移到PG, PG迁移到PG .&nbsp;</div><div>PG到PG的同版本的迁移可以使用自带的流复制或在log shipping技术, 停机时间可以做到非常的短暂 .&nbsp;</div><div>如果是跨版本的迁移, 或者是仅仅需要迁移部分表. 使用流复制就不太合适了 .&nbsp;</div><div>pg到pg跨版本数据迁移可选的方案比较多, 例如londiste, slony, snapshot(<a rel="nofollow" href="http://pgfoundry.org/projects/snapshot/"  >http://pgfoundry.org/projects/snapshot/</a>)等. 也可以做到比较短的停机时间.</div><div>pg_dump来迁移的话停机时间就比较长, 要保证一致性. 或者结合业务特性, pg_dump也可以做到比较短的停机时间. 但是适用性就比较差.</div><div>接下来我们使用PostgreSQL 的视图以及视图上应用instead of DML触发器, 来设计增量的数据迁移.</div><div>需要用到四个对象 : 视图, 原表, 更新表, 删除表.<br>以下操作建立触发器函数, 在视图上创建相应触发器.</div><div>1. 更新操作, 从原表删除, 从更新表删除, 调用插入函数步骤(<span style="line-height: 22px;"  >判断插入原表约束, 插入更新表.</span>).</div><div>2. 删除操作, 从原表删除, 从更新表删除, 插入删除记录表.</div><div>3. 插入操作, 判断插入原表约束, 插入更新表, 删除删除表中对应记录.</div><div>具体操作如下 :&nbsp;</div><div>创建测试表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create table user_info(userid int primary key, username name unique, info text, crt_time timestamp(0), mod_time timestamp(0));</font></div><div><font size="2"  >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "user_info_pkey" for table "user_info"</font></div><div><font size="2"  >NOTICE: &nbsp;CREATE TABLE / UNIQUE will create implicit index "user_info_username_key" for table "user_info"</font></div><div><font size="2"  >CREATE TABLE</font></div><p></p></pre></div><div>插入测试数据100W条</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; insert into user_info select generate_series(1,1000000), 'test'||generate_series(1,1000000), '增量测试'||random(), clock_timestamp(), null;</font></div><div><font size="2"  >INSERT 0 1000000</font></div><p></p></pre></div><div>把表名改为<span style="line-height: 22px;"  >user_info_old.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; alter table user_info rename to user_info_old;</font></div><div><font size="2"  >ALTER TABLE</font></div><p></p></pre></div><div>创建一个增量数据表.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create table user_info_change (like user_info_old including all);</font></div><div><font size="2"  >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "user_info_change_pkey" for table "user_info_change"</font></div><div><font size="2"  >NOTICE: &nbsp;CREATE TABLE / UNIQUE will create implicit index "user_info_change_username_key" for table "user_info_change"</font></div><div><font size="2"  >CREATE TABLE</font></div><p></p></pre></div><div>创建一个记录删除记录的表.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create table user_info_del (like user_info_old including all);</font></div><div><font size="2"  >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "user_info_del_pkey" for table "user_info_del"</font></div><div><font size="2"  >NOTICE: &nbsp;CREATE TABLE / UNIQUE will create implicit index "user_info_del_username_key" for table "user_info_del"</font></div><div><font size="2"  >CREATE TABLE</font></div><p></p></pre></div><div>创建一个与生产表同名的视图.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create or replace view user_info as select * from user_info_old where userid not in (select userid from user_info_del union select userid from user_info_change) union select * from user_info_change where userid not in (select userid from user_info_del);</font></div><div><font size="2"  >CREATE VIEW</font></div><p></p></pre></div><div>创建插入触发器函数 v1</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function f_user_info_insert () returns trigger as $$<br>declare<br>begin<br>  raise notice 'userid: %', NEW.userid;<br> &nbsp;-- <span style="line-height: 19px;"  >f_user_info_insert() v1.</span></font></div><div><font size="2"  >  -- 虽然新的记录都插入user_info_change, 但是需要确保约束, 所以需要在user_info_old表再判断一遍.</font></div><div><font size="2"  >  -- 更好的办法是插入user_info_old表, 然后在末端再从user_info_old表删除, 这样就不用写判断语句了.(因为pg最低的事务隔离级别是read committed)</font></div><div><font size="2"  >  perform 1 from user_info_old where userid = NEW.userid;<br>  if not found then<br>    perform 1 from user_info_old where username = NEW.username;<br>    if not found then<br>      insert into user_info_change values (NEW.*);<br>      delete from user_info_del where userid = NEW.userid;<br>    else<br>      raise exception 'unique key conflict';<br>    end if;<br>  else<br>    raise exception 'primary key conflict';<br>  end if;<br>  return null;<br>end;<br>$$ language plpgsql;</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >插入触发器函数 v2</span></div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function f_user_info_insert () returns trigger as $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >&nbsp; raise notice 'userid: %', NEW.userid;</font></div><div><font size="2"  >&nbsp; -- f_user_info_insert() v2.</font></div><div><font size="2"  >&nbsp; insert into user_info_old values (NEW.*);</font></div><div><font size="2"  >&nbsp; insert into user_info_change values (NEW.*);</font></div><div><font size="2"  >&nbsp; delete from user_info_del where userid = NEW.userid;</font></div><div><font size="2"  >&nbsp; delete from user_info_old where userid = NEW.userid;</font></div><div><font size="2"  >&nbsp; return null;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$ language plpgsql;</font></div><p></p></pre></div><div style="line-height: 22px;"  ><br></div></div><div>创建更新触发器函数v1</div><div><p></p><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function f_user_info_update () returns trigger as $$<br>declare<br>begin<br>  raise notice 'userid: %', OLD.userid;<br>  delete from user_info_old where userid = OLD.userid;<br>  delete from user_info_change where userid = OLD.userid;</font></div><div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  > &nbsp;-- <span style="line-height: 19px;"  >f_user_info_update() v1.</span></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >  -- 虽然新的记录都插入user_info_change, 但是需要确保约束, 所以需要在user_info_old表再判断一遍.</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >  -- 更好的办法是插入user_info_old表, 然后在末端再从user_info_old表删除, 这样就不用写判断语句了.(因为pg最低的事务隔离级别是read committed)</font></div><font size="2"  >  perform 1 </font><span style="font-size: small; line-height: 22px;"  >from user_info_old where userid = NEW.userid;</span><font size="2"  ><br></font><font size="2"  >  if not found then<br>    perform 1 from user_info_old where username = NEW.username;<br>    if not found then<br>      insert into user_info_change values (NEW.*);<br>      delete from user_info_del where userid = NEW.userid;<br>    else<br>      raise exception 'unique key conflict';<br>    end if;<br>  else<br>    raise exception 'primary key conflict';<br>  end if;<br>  return null;<br>end;<br>$$ language plpgsql;</font></div><p></p></pre></div><p></p></div><div><span style="line-height: 22px;"  >更新触发器函数v2</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function f_user_info_update () returns trigger as $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >&nbsp; raise notice 'userid: %', OLD.userid;</font></div><div><font size="2"  >&nbsp; delete from user_info_old where userid = OLD.userid;</font></div><div><font size="2"  >&nbsp; delete from user_info_change where userid = OLD.userid;</font></div><div><font size="2"  >&nbsp; insert into user_info_old values (NEW.*);</font></div><div><font size="2"  >&nbsp; insert into user_info_change values (NEW.*);</font></div><div><font size="2"  >&nbsp; delete from user_info_del where userid = NEW.userid;</font></div><div><font size="2"  >&nbsp; delete from user_info_old where userid = NEW.userid;</font></div><div><font size="2"  >&nbsp; return null;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$ language plpgsql;</font></div><p></p></pre></div><div>创建删除触发器函数</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function f_user_info_delete () returns trigger as $$<br>declare<br>begin<br>  raise notice 'userid: %', OLD.userid;<br>  delete from user_info_old where userid = OLD.userid;<br>  delete from user_info_change where userid = OLD.userid;<br>  perform 1 from user_info_del where userid = OLD.userid;<br>  if not found then<br>    insert into user_info_del values (OLD.*);<br>  end if;<br>  return null;<br>end;<br>$$ language plpgsql;</font></div><p></p></pre></div><div><br></div><div>在视图上创建DML 触发器</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create trigger tg_user_info_insert instead of insert on user_info for each row execute procedure f_user_info_insert();</font></div><div><font size="2"  >CREATE TRIGGER</font></div><div><font size="2"  >Time: 0.806 ms</font></div><div><font size="2"  >digoal=&gt; create trigger tg_user_info_delete instead of delete on user_info for each row execute procedure f_user_info_delete();</font></div><div><font size="2"  >CREATE TRIGGER</font></div><div><font size="2"  >Time: 0.958 ms</font></div><div><font size="2"  >digoal=&gt; create trigger tg_user_info_update instead of update on user_info for each row execute procedure f_user_info_update();</font></div><div><font size="2"  >CREATE TRIGGER</font></div><div><font size="2"  >Time: 0.706 ms</font></div><p></p></pre></div><div>测试:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select * from user_info where userid=1;</font></div><div><font size="2"  >&nbsp;userid | username | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | mod_time&nbsp;</font></div><div><font size="2"  >--------+----------+---------------------------+---------------------+----------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 1 | test1 &nbsp; &nbsp;| 增量测试0.613957106601447 | 2012-09-10 11:14:46 |&nbsp;</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Time: 1.444 ms</font></div><div><font size="2"  >digoal=&gt; update user_info set username='testtest' where userid=1;</font></div><div><font size="2"  >NOTICE: &nbsp;userid: 1</font></div><div><font size="2"  >UPDATE 0</font></div><div><font size="2"  >Time: 2.310 ms</font></div><div><font size="2"  >digoal=&gt; select * from user_info where userid=1;</font></div><div><font size="2"  >&nbsp;userid | username | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | mod_time&nbsp;</font></div><div><font size="2"  >--------+----------+---------------------------+---------------------+----------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 1 | testtest | 增量测试0.613957106601447 | 2012-09-10 11:14:46 |&nbsp;</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Time: 1.251 ms</font></div><div><font size="2"  >digoal=&gt; delete from user_info where userid=1;</font></div><div><font size="2"  >NOTICE: &nbsp;userid: 1</font></div><div><font size="2"  >DELETE 0</font></div><div><font size="2"  >Time: 2.470 ms</font></div><div><font size="2"  >digoal=&gt; select * from user_info where userid=1;</font></div><div><font size="2"  >&nbsp;userid | username | info | crt_time | mod_time&nbsp;</font></div><div><font size="2"  >--------+----------+------+----------+----------</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Time: 1.087 ms</font></div><div><font size="2"  >digoal=&gt; insert into user_info values (1,'test1',now(),now());</font></div><div><font size="2"  >NOTICE: &nbsp;userid: 1</font></div><div><font size="2"  >INSERT 0 0</font></div><div><font size="2"  >Time: 1.274 ms</font></div><div><font size="2"  >digoal=&gt; select * from user_info where userid=1;</font></div><div><font size="2"  >&nbsp;userid | username | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | mod_time&nbsp;</font></div><div><font size="2"  >--------+----------+-------------------------------+---------------------+----------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 1 | test1 &nbsp; &nbsp;| 2012-09-10 11:16:06.000839+08 | 2012-09-10 11:16:06 |&nbsp;</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Time: 1.139 ms</font></div><div><font size="2"  >digoal=&gt; update user_info set info='测试数据' where userid=1;</font></div><div><font size="2"  >NOTICE: &nbsp;userid: 1</font></div><div><font size="2"  >UPDATE 0</font></div><div><font size="2"  >Time: 1.653 ms</font></div><div><font size="2"  >digoal=&gt; select * from user_info where userid=1;</font></div><div><font size="2"  >&nbsp;userid | username | &nbsp; info &nbsp; | &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | mod_time&nbsp;</font></div><div><font size="2"  >--------+----------+----------+---------------------+----------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 1 | test1 &nbsp; &nbsp;| 测试数据 | 2012-09-10 11:16:06 |&nbsp;</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Time: 0.686 ms</font></div><div><font size="2"  >digoal=&gt; insert into user_info values (0,'test0','测试',now(),now());</font></div><div><font size="2"  >NOTICE: &nbsp;userid: 0</font></div><div><font size="2"  >INSERT 0 0</font></div><div><font size="2"  >Time: 0.811 ms</font></div><div><font size="2"  >digoal=&gt; select * from user_info where userid=0;</font></div><div><font size="2"  >&nbsp;userid | username | info | &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >--------+----------+------+---------------------+---------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 0 | test0 &nbsp; &nbsp;| 测试 | 2012-09-10 11:17:02 | 2012-09-10 11:17:02</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Time: 1.015 ms</font></div><div><font size="2"  >digoal=&gt; update user_info set info='测试数据' where userid=0;</font></div><div><font size="2"  >NOTICE: &nbsp;userid: 0</font></div><div><font size="2"  >UPDATE 0</font></div><div><font size="2"  >Time: 1.377 ms</font></div><div><font size="2"  >digoal=&gt; select * from user_info where userid=0;</font></div><div><font size="2"  >&nbsp;userid | username | &nbsp; info &nbsp; | &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >--------+----------+----------+---------------------+---------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 0 | test0 &nbsp; &nbsp;| 测试数据 | 2012-09-10 11:17:02 | 2012-09-10 11:17:02</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Time: 0.995 ms</font></div><div><font size="2"  >digoal=&gt; delete from user_info where userid=0;</font></div><div><font size="2"  >NOTICE: &nbsp;userid: 0</font></div><div><font size="2"  >DELETE 0</font></div><div><font size="2"  >Time: 1.597 ms</font></div><div><font size="2"  >digoal=&gt; select * from user_info where userid=0;</font></div><div><font size="2"  >&nbsp;userid | username | info | crt_time | mod_time&nbsp;</font></div><div><font size="2"  >--------+----------+------+----------+----------</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Time: 0.961 ms</font></div><div><font size="2"  >digoal=&gt; insert into user_info values (0,'test0','测试',now(),now());</font></div><div><font size="2"  >NOTICE: &nbsp;userid: 0</font></div><div><font size="2"  >INSERT 0 0</font></div><div><font size="2"  >Time: 0.759 ms</font></div><div><font size="2"  >digoal=&gt; select * from user_info where userid=0;</font></div><div><font size="2"  >&nbsp;userid | username | info | &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >--------+----------+------+---------------------+---------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 0 | test0 &nbsp; &nbsp;| 测试 | 2012-09-10 11:17:24 | 2012-09-10 11:17:24</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Time: 1.016 ms</font></div><div><font size="2"  >digoal=&gt; update user_info set info='测试数据' where userid=0;</font></div><div><font size="2"  >NOTICE: &nbsp;userid: 0</font></div><div><font size="2"  >UPDATE 0</font></div><div><font size="2"  >Time: 1.390 ms</font></div><div><font size="2"  >digoal=&gt; select * from user_info where userid=0;</font></div><div><font size="2"  >&nbsp;userid | username | &nbsp; info &nbsp; | &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >--------+----------+----------+---------------------+---------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 0 | test0 &nbsp; &nbsp;| 测试数据 | 2012-09-10 11:17:24 | 2012-09-10 11:17:24</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Time: 0.985 ms</font></div><div><font size="2"  >digoal=&gt; delete from user_info where userid=0;</font></div><div><font size="2"  >NOTICE: &nbsp;userid: 0</font></div><div><font size="2"  >DELETE 0</font></div><div><font size="2"  >Time: 2.661 ms</font></div><div><font size="2"  >digoal=&gt; select * from user_info where userid=0;</font></div><div><font size="2"  >&nbsp;userid | username | info | crt_time | mod_time&nbsp;</font></div><div><font size="2"  >--------+----------+------+----------+----------</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Time: 0.953 ms</font></div><p></p></pre></div><div>迁移过程简单描述 :&nbsp;</div><div>1. 导出user_info_old</div><div>2. 导入user_info_old到新库</div><div>3. 停止业务(停止对user_info的DML操作)</div><div>4. 导出user_info_change</div><div>5. 导入user_info_change<span style="line-height: 22px;"  >到新库</span></div><div>6.&nbsp;<span style="line-height: 22px;"  >新库 :&nbsp;</span>以下操作放在一个事务中进行.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >begin;</font></div><div><font size="2"  >delete from user_info_old where userid in (select userid from user_info_change) or userid in (select userid from user_info_del);</font></div><div><font size="2"  >delete from user_info_change where userid in (select userid from user_info_del);</font></div><div><font size="2"  >insert into user_info_old select * from user_info_change;</font></div><div><font size="2"  >alter table user_info_old rename to user_info;</font></div><div><font size="2"  >end;</font></div><p></p></pre></div><div>【注意】</div><div>1. 由于是on each row的触发器, 在表中但是不在view里面的记录是无法被触发的.</div><div>例如, update user_info set info='test' where userid=1;</div><div>当select * from user_info where userid=1 无记录时, 不会触发.</div><div>即使user_info_old或者user_info_change中有userid=1并且user_info_del里面也有userid=1的记录.</div><div>测试如下 :</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; insert into user_info_old values (-2,'test','test',now(),now());</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; insert into user_info_del values (-2,'test','test',now(),now());</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; select * from user_info where userid=-2;</font></div><div><font size="2"  >&nbsp;userid | username | info | crt_time | mod_time&nbsp;</font></div><div><font size="2"  >--------+----------+------+----------+----------</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; delete from user_info where userid=-2;</font></div><div><font size="2"  >DELETE 0</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >因为记录都还在user_info_old里面,&nbsp;</span>显然没有触发f_user_info_delete(). 因为触发器是on each row的.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select * from user_info_old where userid=-2;</font></div><div><font size="2"  >&nbsp;userid | username | info | &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >--------+----------+------+---------------------+---------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;-2 | test &nbsp; &nbsp; | test | 2012-09-11 16:42:33 | 2012-09-11 16:42:33</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; select * from user_info_del where userid=-2;</font></div><div><font size="2"  >&nbsp;userid | username | info | &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;mod_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >--------+----------+------+---------------------+---------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;-2 | test &nbsp; &nbsp; | test | 2012-09-11 16:42:37 | 2012-09-11 16:42:37</font></div><div><font size="2"  >(1 row)&nbsp;</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>