<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">eth0:1's status after server restart? eth0 ONBOOT=yes,eth0:1 ONBOOT=no</h2>
	<h5 id="">2011-06-26 16:02:01&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020115263749914/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>现象 :&nbsp;</div><div># ifcfg-eth0</div><div><div style="line-height: 22px;"   >DEVICE=eth0&nbsp;</div><div style="line-height: 22px;"   >ONBOOT=yes&nbsp;</div></div><div style="line-height: 22px;"   ># ifcfg-eth0:1&nbsp;</div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >DEVICE=eth0:1&nbsp;</div><div style="line-height: 22px;"   >ONBOOT=no&nbsp;</div></div><div style="line-height: 22px;"   >在系统重启后 eth0:1 这个设备也会启动。</div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >[注意]</div><div style="line-height: 22px;"   >如果要让eth0:1 不启动 , 需要配置ONPARENT=no, 而不是ONBOOT=no.</div><div style="line-height: 22px;"   ><br></div><div><br></div><div>环境 :&nbsp;</div><div>Server A :&nbsp;192.168.x.115</div><div>网卡配置文件 :&nbsp;</div><div><div style="line-height: 22px;"   >DEVICE=eth0</div><div style="line-height: 22px;"   >ONBOOT=yes</div><div style="line-height: 22px;"   >BOOTPROTO=static</div><div style="line-height: 22px;"   >HWADDR=F4:CE:46:xx:xx:xx</div><div style="line-height: 22px;"   >IPADDR=192.168.x.115</div><div style="line-height: 22px;"   >NETMASK=255.255.255.0</div></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >DEVICE=eth0:1</div><div style="line-height: 22px;"   >ONBOOT=no</div><div style="line-height: 22px;"   >BOOTPROTO=static</div><div style="line-height: 22px;"   >HWADDR=F4:CE:46:xx:xx:xx</div><div style="line-height: 22px;"   >IPADDR=192.168.x.107</div><div style="line-height: 22px;"   >NETMASK=255.255.255.0</div><div style="line-height: 22px;"   ><br></div></div><div>Server B :&nbsp;192.168.x.116</div><div>网卡配置文件 :&nbsp;</div><div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >DEVICE=eth0</div><div style="line-height: 22px;"   >ONBOOT=yes</div><div style="line-height: 22px;"   >BOOTPROTO=static</div><div style="line-height: 22px;"   >HWADDR=F4:CE:46:xx:xx:xx</div><div style="line-height: 22px;"   >IPADDR=192.168.x.116</div><div style="line-height: 22px;"   >NETMASK=255.255.255.0</div></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >DEVICE=eth0:1</div><div style="line-height: 22px;"   >ONBOOT=no</div><div style="line-height: 22px;"   >BOOTPROTO=static</div><div style="line-height: 22px;"   >HWADDR=F4:CE:46:xx:xx:xx</div><div style="line-height: 22px;"   >IPADDR=192.168.x.107</div><div style="line-height: 22px;"   >NETMASK=255.255.255.0</div><div style="line-height: 22px;"   ><br></div></div></div><div>VIP :&nbsp;192.168.x.107 (手工起这块网卡在ServerA上面)</div><div>ifup eth0:1&nbsp;</div><div><br></div><div>上面跑的PostgreSQL数据库,</div><div>ServerA:primary ServerB:standby&nbsp;</div><div>今天ServerB服务器因为硬件故障重启了 . &nbsp;但是重启后数据库无法跟主节点建立Stream连接。报错 :&nbsp;</div><div>FATAL: &nbsp;recovery is still in progress, can't accept WAL streaming connections</div><div>一开始我以为PostgreSQL数据库的Standby被破坏了。（后来发现这个想法是错误的，PG没那么脆弱）</div><div><br></div><div>真正的原因是，ServerB重启后 eth0:1 也被启动了。此时两台主机竞争192.168.x.107这个IP。（当交换机的MAC表过期的时候，192.168.x.107这个IP可能会被ServerB获得，那么APP Server就有可能会连错数据库了。）</div><div>而ServerB则无法连接到192.168.x.107,因此报错&nbsp;FATAL: &nbsp;recovery is still in progress, can't accept WAL streaming connections</div><div>&nbsp;(primary_conninfo = 'host=192.168.x.107 port=1921 user=replica keepalives_idle=60')</div><div><br></div><div>处理方法 :&nbsp;</div></div><div>1.&nbsp;</div><div>把&nbsp;eth0 的&nbsp;ONBOOT 也改为 no&nbsp;</div><div>然后在/etc/rc.local里面加入一条 /sbin/ifup eth0</div><div>(结果无效，eth0:1 照样启动)</div><div>2.&nbsp;</div><div><div style="line-height: 22px;"   >在启动文件 /etc/rc.local 里面加一条 /sbin/ifdown eth0:1 &nbsp;, 启动的时候强制关闭。</div></div><div style="line-height: 22px;"   >(结果无效，eth0:1 照样启动)</div><div>3.&nbsp;</div><div>mv /etc/sysconfig/network-scripts/ifcfg-eth0:1 /etc/sysconfig/network-scripts/bak.ifcfg-eth0:1</div><div>(有效,但是使用的时候需要MV回来，并且MV回来后重启还会UP。所以不建议使用)</div><div>4.&nbsp;</div><div>chkconfig network off</div><div>然后在/etc/rc.local 里面添加</div><div>/sbin/service network start</div><div>/sbin/ifdown eth0:1</div><div>(需要检查启动的时候有没有其他服务依赖这个服务启动，如果没有的话目前还是这个方法比较保险)&nbsp;</div><div><br></div><div>那么为什么?</div><div><div style="line-height: 22px;"   >DEVICE=eth0:1&nbsp;</div><div style="line-height: 22px;"   >ONBOOT=no&nbsp;</div></div><div style="line-height: 22px;"   >在系统重启后 eth0:1 这个设备会启动。</div><div style="line-height: 22px;"   >我的初步判断是因为 :&nbsp;</div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >DEVICE=eth0&nbsp;</div><div style="line-height: 22px;"   >ONBOOT=yes&nbsp;</div><div style="line-height: 22px;"   >所以子接口也就随之启动了。</div></div><div style="line-height: 22px;"   ><br></div><div><br></div><wbr></div>
	</div>
</div>
</body>
</html>