<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">RHCS fence each other when start the cman service</h2>
	<h5 id="">2011-06-16 16:18:17&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020115163448218/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">今天给两台HP DL360G6的server做RHCS集群的时候，发生了诡异的事情。起CMAN服务的时候相互把对方FENCE掉。<wbr><div>启动方法1： 两台同时起CMAN</div><div>启动方法2：先起一台的CMAN，这时会杀掉另一台。然后等另一台重启后起CMAN，此时会把之前起好的那台SERVER FENCE掉。就像相互都感知不到对方的存在一样。</div><div><br></div><div>配置文件:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&lt;?xml version="1.0"?&gt;</font></div><div><font size="2"  >&lt;cluster alias="mycluster" config_version="1" name="mycluster"&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &lt;fence_daemon post_fail_delay="30" post_join_delay="30"/&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &lt;clusternodes&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;clusternode name="my-host-1" nodeid="1" votes="1"&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;fence&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;method name="1"&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;device name="my-host-1-fence"/&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/method&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/fence&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/clusternode&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;clusternode name="my-host-2" nodeid="2" votes="1"&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;fence&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;method name="1"&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;device name="my-host-2-fence"/&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/method&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/fence&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/clusternode&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &lt;/clusternodes&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &lt;cman expected_votes="1" two_node="1"/&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &lt;fencedevices&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;fencedevice agent="fence_ilo" hostname="my-host-1-fence" login="username" name="my-host-1-fence" passwd="xxxxxxx"/&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;fencedevice agent="fence_ilo" hostname="my-host-2-fence" login="username" name="my-host-2-fence" passwd="xxxxxxx"/&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &lt;/fencedevices&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &lt;rm&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;failoverdomains&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;failoverdomain name="db_failover" ordered="0" restricted="1"&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;failoverdomainnode name="my-host-1" priority="1"/&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;failoverdomainnode name="my-host-2" priority="1"/&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/failoverdomain&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/failoverdomains&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;resources&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;ip address="192.168.1.21" monitor_link="1"/&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;script file="/usr/local/bin/pgctl.sh" name="myscript"/&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/resources&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;service autostart="0" domain="db_failover" name="myservice"&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;script ref="myscript"/&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/service&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &lt;/rm&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &lt;dlm plock_ownership="1" plock_rate_limit="0"/&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &lt;gfs_controld plock_rate_limit="0"/&gt;</font></div><div><font size="2"  >&lt;/cluster&gt;</font></div><p></p></pre></div><div><br></div><div>排查：</div><div>1，首先确保两台服务器的网络是畅通的。查了IPTABLES，都开放了相互的访问权限，即使把IPTABLES 关掉结果依旧。</div><div>2，检查日志</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >Jun 16 10:22:54 my-host-2 kernel: DLM (built Dec 19 2010 14:23:46) installed</font></div><div><font size="2"  >Jun 16 10:22:54 my-host-2 kernel: GFS2 (built Dec 19 2010 14:24:40) installed</font></div><div><font size="2"  >Jun 16 10:22:54 my-host-2 kernel: Lock_DLM (built Dec 19 2010 14:24:52) installed</font></div><div><font size="2"  >Jun 16 10:22:54 my-host-2 ccsd[7089]: Starting ccsd 2.0.115:&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:54 my-host-2 ccsd[7089]: &nbsp;Built: Dec 10 2010 11:19:49&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:54 my-host-2 ccsd[7089]: &nbsp;Copyright (C) Red Hat, Inc. &nbsp;2004 &nbsp;All rights reserved.&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:54 my-host-2 ccsd[7089]: cluster.conf (cluster name = mycluster, version = 1) found.&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:56 my-host-2 openais[7098]: [MAIN ] AIS Executive Service RELEASE 'subrev 1887 version 0.80.6'&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:56 my-host-2 openais[7098]: [MAIN ] Copyright (C) 2002-2006 MontaVista Software, Inc and contributors.&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:56 my-host-2 openais[7098]: [MAIN ] Copyright (C) 2006 Red Hat, Inc.&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:56 my-host-2 openais[7098]: [MAIN ] AIS Executive Service: started and ready to provide service.&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:56 my-host-2 openais[7098]: [MAIN ] Using default multicast address of 239.192.53.207&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:56 my-host-2 openais[7098]: [TOTEM] Token Timeout (10000 ms) retransmit timeout (495 ms)&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:56 my-host-2 openais[7098]: [TOTEM] token hold (386 ms) retransmits before loss (20 retrans)&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:56 my-host-2 openais[7098]: [TOTEM] join (60 ms) send_join (0 ms) consensus (2000 ms) merge (200 ms)&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:56 my-host-2 openais[7098]: [TOTEM] downcheck (1000 ms) fail to recv const (2500 msgs)&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:56 my-host-2 openais[7098]: [TOTEM] seqno unchanged const (30 rotations) Maximum network MTU 1402&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:56 my-host-2 openais[7098]: [TOTEM] window size per rotation (50 messages) maximum messages per rotation (17 me</font></div><div><font size="2"  >ssages)&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:56 my-host-2 openais[7098]: [TOTEM] missed count const (5 messages)&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:56 my-host-2 openais[7098]: [TOTEM] send threads (0 threads)&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:56 my-host-2 openais[7098]: [TOTEM] RRP token expired timeout (495 ms)&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:56 my-host-2 openais[7098]: [TOTEM] RRP token problem counter (2000 ms)&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:56 my-host-2 openais[7098]: [TOTEM] RRP threshold (10 problem count)&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:56 my-host-2 openais[7098]: [TOTEM] RRP mode set to none.&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:56 my-host-2 openais[7098]: [TOTEM] heartbeat_failures_allowed (0)&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:56 my-host-2 openais[7098]: [TOTEM] max_network_delay (50 ms)&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [TOTEM] HeartBeat is Disabled. To enable set heartbeat_failures_allowed &gt; 0&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 ccsd[7089]: Cluster is not quorate. &nbsp;Refusing connection.&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [TOTEM] Receive multicast socket recv buffer size (320000 bytes).&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 ccsd[7089]: Error while processing connect: Connection refused&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [TOTEM] Transmit multicast socket send buffer size (320000 bytes).&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [TOTEM] The network interface [192.168.1.82] is now up.&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [TOTEM] Created or loaded sequence id 36.192.168.1.82 for this ring.&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [TOTEM] entering GATHER state from 15.&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [CMAN ] CMAN 2.0.115 (built Dec 10 2010 11:19:51) started&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [MAIN ] Service initialized 'openais CMAN membership service 2.01'&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [SERV ] Service initialized 'openais extended virtual synchrony service'&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [SERV ] Service initialized 'openais cluster membership service B.01.01'&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [SERV ] Service initialized 'openais availability management framework B.01.01'&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [SERV ] Service initialized 'openais checkpoint service B.01.01'&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [SERV ] Service initialized 'openais event service B.01.01'&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [SERV ] Service initialized 'openais distributed locking service B.01.01'&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [SERV ] Service initialized 'openais message service B.01.01'&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [SERV ] Service initialized 'openais configuration service'&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [SERV ] Service initialized 'openais cluster closed process group service v1.01'&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [SERV ] Service initialized 'openais cluster config database access v1.01'&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [SYNC ] Not using a virtual synchrony filter.&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [TOTEM] Creating commit token because I am the rep.&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [TOTEM] Saving state aru 0 high seq received 0&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [TOTEM] Storing new sequence id for ring 28&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [TOTEM] entering COMMIT state.&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [TOTEM] entering RECOVERY state.&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [TOTEM] position [0] member 192.168.1.82:&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [TOTEM] previous ring seq 36 rep 192.168.1.82&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [TOTEM] aru 0 high delivered 0 received flag 1&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [TOTEM] Did not need to originate any messages in recovery.&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [TOTEM] Sending initial ORF token&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [CLM &nbsp;] CLM CONFIGURATION CHANGE&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [CLM &nbsp;] New Configuration:&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [CLM &nbsp;] Members Left:&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [CLM &nbsp;] Members Joined:&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 ccsd[7089]: Initial status:: Quorate&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [CLM &nbsp;] CLM CONFIGURATION CHANGE&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [CLM &nbsp;] New Configuration:&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [CLM &nbsp;] &nbsp; &nbsp; &nbsp; &nbsp;r(0) ip(192.168.1.82) &nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [CLM &nbsp;] Members Left:&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [CLM &nbsp;] Members Joined:&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [CLM &nbsp;] &nbsp; &nbsp; &nbsp; &nbsp;r(0) ip(192.168.1.82) &nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [SYNC ] This node is within the primary component and will provide service.&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [TOTEM] entering OPERATIONAL state.&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [CMAN ] quorum regained, resuming activity&nbsp;</font></div><div><font size="2"  >Jun 16 10:22:57 my-host-2 openais[7098]: [CLM &nbsp;] got nodejoin message 192.168.1.82&nbsp;</font></div><div><font size="2"  >Jun 16 10:24:14 my-host-2 fenced[7118]: my-host-1 not a cluster member after 30 sec post_join_delay</font></div><div><font size="2"  >Jun 16 10:24:14 my-host-2 fenced[7118]: fencing node "my-host-1"</font></div><div><font size="2"  >Jun 16 10:24:28 my-host-2 fenced[7118]: fence "my-host-1" success</font></div><p></p></pre></div><div><br></div></div><div>发现这里使用的多播地址239.192.53.207在整个VLAN中，只有自己这台机器能正常接收。</div><div>使用 &nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >tcpdump ip net 239.0.0.0/8|grep my-host-</font></p></pre></div><div>只有启动了CMAN的节点上面有结果输出，在另一台上面看不到输出。</div><div><br></div><div>其他在这个VLAN里面也有RHCS集群，使用正常。</div><div>于是找网络工程师帮忙查看是不是网络设备上限制了。告知，没有限制。</div><div># 启动CMAN后，查看多播应该是这样的.但是my-host-1无法加入这个多播环境，反之依然。</div><div>my-host-2 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@my-host-2 ~]# ip maddress show</font></div><div><font size="2"  >1: &nbsp; &nbsp; &nbsp;lo</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; inet &nbsp;224.0.0.1</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; inet6 ff02::1</font></div><div><font size="2"  >2: &nbsp; &nbsp; &nbsp;eth0</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; link &nbsp;01:00:5e:40:35:cf</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; link &nbsp;33:33:00:03:00:01</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; link &nbsp;01:00:5e:00:00:fb</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; link &nbsp;33:33:00:00:00:fb</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; link &nbsp;33:33:ff:86:91:84</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; link &nbsp;33:33:00:00:00:01</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; link &nbsp;01:00:5e:00:00:01</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; inet &nbsp;239.192.53.207</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; inet &nbsp;224.0.0.251</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; inet &nbsp;224.0.0.1</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; inet6 ff02::3:1</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; inet6 ff02::fb</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; inet6 ff02::1:ff86:9184</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; inet6 ff02::1</font></div><p></p></pre></div><div>my-host-1 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@my-host-1 ~]# ip maddress show</font></div><div><font size="2"  >1: &nbsp; &nbsp; &nbsp;lo</font></div><div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; inet &nbsp;224.0.0.1</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; inet6 ff02::1</font></div><div><font size="2"  >2: &nbsp; &nbsp; &nbsp;eth0</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; link &nbsp;01:00:5e:00:00:fb</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; link &nbsp;33:33:00:00:00:fb</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; link &nbsp;33:33:ff:86:52:d4</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; link &nbsp;33:33:00:00:00:01</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; link &nbsp;01:00:5e:00:00:01</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; inet &nbsp;224.0.0.251</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; inet &nbsp;224.0.0.1</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; inet6 ff02::fb</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; inet6 ff02::1:ff86:52d4</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; inet6 ff02::1</font></div></div><p></p></pre></div><div><br></div><div>3，# 实在没有办法，看到ip maddress add可以添加对方的多播地址，于是试了一把。</div><div>在my-host-1上面执行如下 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >ip maddress add address&nbsp;239.192.53.207&nbsp;dev eth0</font></p></pre></div><div>没有办法加入到这个组。</div><div><br></div><div>4，修改了如下参数</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >sysctl -w net.ipv4.igmp_max_msf=100</font></div><div><div><font size="2"  >net.ipv4.igmp_max_memberships=200</font></div></div><p></p></pre></div><div>还是不能解决。</div><div><br></div><div>5，# 最终解决办法</div><div>1. my-host-1 执行</div><div><pre class="prettyprint"  ><p><font size="2"  >ip maddress add address 33:33:ff:86:91:84 dev eth0</font></p></pre></div><div><div>使用 ip maddress show 查看将多出一条信息</div><div><pre class="prettyprint"  ><p><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; link &nbsp;33:33:ff:86:91:84 static</font></p></pre></div></div><div>2. my-host-2 执行</div><div><pre class="prettyprint"  ><p><font size="2"  >ip maddress add address&nbsp;33:33:ff:86:52:d4&nbsp;dev eth0</font></p></pre></div><div>使用 ip maddress show 查看将多出一条信息</div><div><pre class="prettyprint"  ><p><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; link &nbsp;33:33:ff:86:52:d4 static</font></p></pre></div><div>3. 双机执行</div><div><pre class="prettyprint"  ><p><font size="2"  >&nbsp;service cman start</font></p></pre></div><div>4. 正常加入到多播组,服务也启动正常.</div><div><br></div><div>因为rhcs的这个环境，我们依赖多播来做心跳(还可以用QUOTAM DISK),所以无法加入多播组就导致了相互FENCE的情况出现。为什么不能正常加入到多播组的原因还有待分析。</div><div><br></div><div>【其它】</div><div>RHCS的多播地址是怎么生成的呢?</div><div>看看cman的帮助文件就知道了, 和cluster id number有关, 所以一个VLAN中如果多个RHCS集群使用了同样的cluster id, 那是会有大麻烦的, 因为他们相互干扰了, 就像两组人员使用对讲机调到了同一个频率一样, 串线了 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >Multicast network configuration</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;cman uses multicast UDP packets to communicate with other nodes in the cluster. &nbsp;By default it will generate &nbsp;a</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;multicast address using 239.192.x.x where x.x is the 16bit cluster ID number split into bytes. This, in turn is</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;generated from a hash of the cluster name though it can be specified explicitly. The purpose of this is to &nbsp;al-</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;low &nbsp;multiple &nbsp;clusters &nbsp;to share the same subnet - they will each use a different multicast address. You might</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;also/instead want to isolate clusters using the port number as shown above.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;It is possible to override the multicast address by specifying it in cluster.conf as shown:</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;cman&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;multicast addr="229.192.0.1"/&gt;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/cman&gt;</font></div><p></p></pre></div><div>IP地址转换成多播地址的规则可以参考 :&nbsp;</div><div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://www.firewall.cx/networking-topics/general-networking/107-network-multicast.html"  >http://www.firewall.cx/networking-topics/general-networking/107-network-multicast.html</a></div><div>2.&nbsp;<a target="_blank" rel="nofollow" href="http://http://www.aqwnet.com/index.php/tools/ip-mac-calculator"  >http://www.aqwnet.com/index.php/tools/ip-mac-calculator</a></div><div><br></div><div>【参考】</div><div><a rel="nofollow" href="http://tldp.org/HOWTO/Multicast-HOWTO.html#toc2"  >http://tldp.org/HOWTO/Multicast-HOWTO.html#toc2</a></div><div>man ip</div><div>man cman</div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">多播 - 2012-12-20 17:55:29</h5>
				<div><P>ip maddress add address 33:33:ff:86:91:84 dev eth0</P>  <P>这里的33:33:ff:86:91:84是什么意思？哪里得来的？</P>  <P>谢谢！</P></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 多播 - 2012-12-20 17:55:29</h5>
				<div style="width:600px;">参考本文[其他]部分</div>
			</div>
			<div id="">
				<h5 id="">PacoPink - 2012-10-24 22:15:45</h5>
				<div>心跳线是不是连在思科的交换机上？某些型号的交换机对多播支持有问题，需要打补丁或者改配置。</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 PacoPink - 2012-10-24 22:15:45</h5>
				<div style="width:600px;">是的.</div>
			</div>
	</div>
</div>
</body>
</html>