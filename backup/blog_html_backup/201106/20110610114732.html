<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Thinking PostgreSQL Function's Volatility Categories</h2>
	<h5 id="">2011-06-10 11:47:32&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201151011105494/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">PostgreSQL 函数在定义的时候有三个稳定性状态可选:<wbr><div>IMMUTABLE | STABLE | VOLATILE</div><div>分别代表，非常稳定，稳定，不稳定。</div><div><br></div><div>不稳定，函数可以修改数据库的数据，输入同样的参数可以返回不同的结果，同一个QUERY中，如果需要返回该函数的结果，那么每一行都会运算一遍这个函数(后面会有例子)。</div><div>稳定，函数不可以修改数据库的数据，同一个QUERY中，如果需要返回该函数的结果，那么将合并多次运算为一次这个函数(后面会有例子)。另外，只有stable和immutable的函数才可以被执行计划选择作为索引的比较条件。(因为索引比较时，被比较的值只运算一次.这个就需要stable和immutable了)</div><div>非常稳定,函数不可以修改数据库的数据,并且在任何情况下调用，只要输入参数一致，返回结果都一致。</div><div><br></div><div>在创建函数时，必须严格的定义稳定性状态，否则可能导致意想不到的后果，因为PLAN CACHE以及prepared statement等原因.</div><div>函数索引必须是immutable的 .&nbsp;</div><div><br></div><div>注意稳定和非常稳定的函数中只能出现SELECT语句。但是SELECT语句中可以调用不稳定函数，因此这些稳定性选项都不是强限制。</div><div>另外稳定性选项还影响了对数据的可视特性,如&nbsp;<span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  ><tt>STABLE</tt>&nbsp;and&nbsp;<tt>IMMUTABLE</tt>&nbsp;functions use a snapshot established as of the start of the calling query, whereas&nbsp;<tt>VOLATILE</tt>&nbsp;functions obtain a fresh snapshot at the start of each query they execute.</span></div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  ><br></span></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 18px;"  >实例:</span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 18px;"  >下面来用几个时间函数来测试一下:</span></font></div><div><font face="verdana, sans-serif"  ><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; proname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | provolatile | pronargs&nbsp;</font></div><div><font size="2"  >----------------------------------------+-------------+----------</font></div><div><font size="2"  >&nbsp;timenow &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| s &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"  >&nbsp;timeofday &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| v &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"  >&nbsp;now &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| s &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"  >&nbsp;transaction_timestamp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| s &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"  >&nbsp;statement_timestamp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| s &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"  >&nbsp;clock_timestamp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| v &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><p></p></pre></div><div style="line-height: 18px; font-size: 12px;"  ><br></div><div style="line-height: 18px; font-size: 12px;"  >其中</div></font><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 19px;"  >clock_timestamp是voatile的.now是stable的。</span></div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 19px;"  ><br></span></div><div><pre class="prettyprint"  ><p></p><div><span style="font-family: verdana, sans-serif; line-height: 19px;"  ><font size="2"  ><div>digoal=&gt; create table tbl_time (id int,row_time timestamp without time zone,stat_time timestamp without time zone);</div><div>CREATE TABLE</div><div>digoal=&gt; insert into tbl_time select generate_series(1,10000),clock_timestamp(),now();</div><div>INSERT 0 10000</div><div><br></div></font></span></div><div><div style="font-family: verdana, sans-serif; line-height: 19px;"  ><font size="2"  >digoal=&gt; select count(*),count(distinct row_time),count(distinct stat_time) from tbl_time;</font></div><div style="font-family: verdana, sans-serif; line-height: 19px;"  ><font size="2"  >&nbsp;count | count | count&nbsp;</font></div><div style="font-family: verdana, sans-serif; line-height: 19px;"  ><font size="2"  >-------+-------+-------</font></div><div style="font-family: verdana, sans-serif; line-height: 19px;"  ><font size="2"  >&nbsp;10000 | 10000 | &nbsp; &nbsp; 1</font></div><div style="font-family: verdana, sans-serif; line-height: 19px;"  ><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div style="font-family: verdana, sans-serif; font-size: 12px; line-height: 19px;"  ><br></div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 19px;"  ># 情况已经很明朗了</span></div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 19px;"  >volatile每一行都运算了，stable的只是STATEMANT开始是运算。</span></div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 19px;"  ># 再来看看索引的比较</span></div><div><pre class="prettyprint"  ><p></p><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >digoal=&gt; explain select * from tbl_time where row_time&gt;now();</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >------------------------------------------------------------------------------</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >&nbsp;Index Scan using idx_row_time on tbl_time &nbsp;(cost=0.00..4.27 rows=1 width=20)</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >&nbsp; &nbsp;Index Cond: (row_time &gt; now())</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >(2 rows)</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br></span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >digoal=&gt; explain select * from tbl_time where row_time&gt;clock_timestamp();</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >--------------------------------------------------------------</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >&nbsp;Seq Scan on tbl_time &nbsp;(cost=0.00..214.00 rows=3333 width=20)</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >&nbsp; &nbsp;Filter: (row_time &gt; clock_timestamp())</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >(2 rows)</span></font></div><p></p></pre></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ># 很明显,volatile的函数在WHERE条件中，不走索引。而now()即stable的函数，使用了索引。</span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ><br></span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ># 把clock_timestamp改成stable试试。马上就走索引了。不过这个不能乱改.</span></font></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; \c digoal postgres</font></div><div><font size="2"  >You are now connected to database "digoal" as user "postgres".</font></div><div><font size="2"  >digoal=# alter function clock_timestamp() strict stable;</font></div><div><font size="2"  >ALTER FUNCTION</font></div><div><font size="2"  >digoal=# \c digoal digoal</font></div><div><font size="2"  >You are now connected to database "digoal" as user "digoal".</font></div><div><font size="2"  >digoal=&gt; explain select * from tbl_time where row_time&gt;clock_timestamp();</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Index Scan using idx_row_time on tbl_time &nbsp;(cost=0.00..4.27 rows=1 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp;Index Cond: (row_time &gt; clock_timestamp())</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ><br></span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ># 那么看看插入会不会受到影响</span></font></div><div><font face="verdana, sans-serif"  ><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; truncate table tbl_time;</font></div><div><font size="2"  >TRUNCATE TABLE</font></div><div><font size="2"  >digoal=&gt; insert into tbl_time select generate_series(1,10000),clock_timestamp(),now();</font></div><div><font size="2"  >INSERT 0 10000</font></div><div><font size="2"  >digoal=&gt; select count(*),count(distinct row_time),count(distinct stat_time) from tbl_time;</font></div><div><font size="2"  >&nbsp;count | count | count&nbsp;</font></div><div><font size="2"  >-------+-------+-------</font></div><div><font size="2"  >&nbsp;10000 | 10000 | &nbsp; &nbsp; 1</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div style="line-height: 19px; font-size: 12px;"  ># 看来插入的时候还是每一个ROW运行一次。</div><div style="line-height: 19px; font-size: 12px;"  ><br></div><div style="line-height: 19px; font-size: 12px;"  >所以三个状态都是定义层面的，不是完全的执行层面的。</div></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ><br></span></font></div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >[参考]</span></div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/xfunc-volatility.html"  >http://www.postgresql.org/docs/9.1/static/xfunc-volatility.html</a></div></div>
	</div>
</div>
</body>
</html>