<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">auto_explain usage</h2>
	<h5 id="">2011-06-08 15:33:48&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020115825612145/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">auto_explain 一个比较给力的模块.<wbr><div>用于向日志输出超出定义阈值执行时间的SQL的执行计划。更强大的是可以选择是否输出内嵌SQL的执行计划(如函数中的SQL).</div><div>auto_explain的输出更详细的解释可以参考EXPLAIN的解释。或者man EXPLAIN.</div><div><div>SYNOPSIS</div><div>&nbsp; &nbsp; &nbsp; &nbsp;EXPLAIN [ ( option [, ...] ) ] statement</div><div>&nbsp; &nbsp; &nbsp; &nbsp;EXPLAIN [ ANALYZE ] [ VERBOSE ] statement</div><div><br></div><div>&nbsp; &nbsp; &nbsp; &nbsp;where option can be one of:</div><div><br></div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ANALYZE [ boolean ]</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;VERBOSE [ boolean ]</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;COSTS [ boolean ]</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;BUFFERS [ boolean ]</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FORMAT { TEXT | XML | JSON | YAML }</div></div><div><br></div><div>开启方式有两种 :&nbsp;</div><div>1. 通过配置文件postgresql.conf</div><div>需要重启数据库。</div><div>2. 通过LOAD 'auto_explain';</div><div>这个只在当前SESSION生效，不需要重启数据库,需要超级用户权限。</div><div><br></div><div>下面举例:</div><div>1. 修改配置文件:</div><div>shared_preload_libraries = 'auto_explain'</div><div>或</div><div>shared_preload_libraries = 'auto_explain'</div><div>新增如下配置:</div><div><div>auto_explain.log_min_duration = 0 &nbsp;# 为了方便查看,这里把时间设置为0,所有SQL都会被auto_explain捕获输出.实际使用的时候适当调大。如 100ms</div><div>auto_explain.log_analyze = true</div><div># 以下可选</div><div>auto_explain.log_verbose = true</div><div>auto_explain.log_buffers = true</div><div>auto_explain.log_nested_statements = true</div></div><div><br></div><div>然后重启数据库.重启时会输出一个LOG</div><div>postgres@db5-&gt; LOG: &nbsp;loaded library "$libdir/auto_explain.so"</div><div><br></div><div># 下面来执行几条SQL</div><div><div>postgres@db5-&gt; psql -h 127.0.0.1 digoal digoal</div><div>psql (9.1beta1)</div><div>Type "help" for help.</div><div><br></div><div>digoal=&gt; select * from tbl_user_info limit 2;</div><div>&nbsp;id | firstname | lastname | &nbsp; corp &nbsp;&nbsp;</div><div>----+-----------+----------+----------</div><div>&nbsp; 1 | zhou1 &nbsp; &nbsp; | digoal1 &nbsp;| sky-mobi</div><div>&nbsp; 2 | zhou2 &nbsp; &nbsp; | digoal2 &nbsp;| sky-mobi</div><div>(2 rows)</div><div><br></div><div>digoal=&gt; select count(*) from tbl_test;</div><div>&nbsp; count &nbsp;</div><div>---------</div><div>&nbsp;1000100</div><div>(1 row)</div></div><div><br></div><div># 日志输出</div><div><div>2011-06-08 15:19:14.390 CST,"digoal","digoal",13789,"127.0.0.1:59549",4def2270.35dd,1,"SELECT",2011-06-08 15:19:12 CST,2/18,0,LOG,00</div><div>000,"duration: 0.040 ms &nbsp;plan:</div><div>Query Text: select * from tbl_user_info limit 2;</div><div>Limit &nbsp;(cost=0.00..0.04 rows=2 width=31) (actual time=0.020..0.023 rows=2 loops=1)</div><div>&nbsp; Output: id, firstname, lastname, corp</div><div>&nbsp; Buffers: shared hit=1</div><div>&nbsp; -&gt; &nbsp;Seq Scan on public.tbl_user_info &nbsp;(cost=0.00..183.00 rows=10000 width=31) (actual time=0.014..0.015 rows=2 loops=1)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; Output: id, firstname, lastname, corp</div><div>&nbsp; &nbsp; &nbsp; &nbsp; Buffers: shared hit=1",,,,,,,,,"psql"</div><div>2011-06-08 15:19:17.902 CST,"digoal","digoal",13789,"127.0.0.1:59549",4def2270.35dd,2,"SELECT",2011-06-08 15:19:12 CST,2/19,0,LOG,00</div><div>000,"duration: 1232.064 ms &nbsp;plan:</div><div>Query Text: select count(*) from tbl_test;</div><div>Aggregate &nbsp;(cost=16927.25..16927.26 rows=1 width=0) (actual time=1232.044..1232.045 rows=1 loops=1)</div><div>&nbsp; Output: count(*)</div><div>&nbsp; Buffers: shared hit=4426</div><div>&nbsp; -&gt; &nbsp;Seq Scan on public.tbl_test &nbsp;(cost=0.00..14427.00 rows=1000100 width=0) (actual time=0.015..626.872 rows=1000100 loops=1)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; Output: id</div><div>&nbsp; &nbsp; &nbsp; &nbsp; Buffers: shared hit=4426",,,,,,,,,"psql"</div></div><div><br></div><div><br></div><div><div style="line-height: 22px;"  >2. 通过LOAD 'auto_explain' ;&nbsp;</div><div style="line-height: 22px;"  >这个只在当前SESSION生效，不需要重启数据库, 需要超级用户权限。</div></div><div>首先先恢复postgresql.conf的配置，去除前面的配置.然后重启数据库.</div><div><br></div><div># 普通用户不允许加载auto_explain模块.(普通用户只允许加载$libdir/plugins目录下的模块,但是auto_explain即使拷贝到这个目录也不行)</div><div><div>digoal=&gt; load 'auto_explain';</div><div>ERROR: &nbsp;access to library "auto_explain" is not allowed</div><div>digoal=&gt; \c digoal postgres</div><div>You are now connected to database "digoal" as user "postgres".</div><div>digoal=# load 'auto_explain';</div><div>LOAD</div><div>digoal=# set auto_explain.log_min_duration=0;</div><div>SET</div><div>digoal=# select * from tbl_user_info limit 2;</div><div>&nbsp;id | firstname | lastname | &nbsp; corp &nbsp;&nbsp;</div><div>----+-----------+----------+----------</div><div>&nbsp; 1 | zhou1 &nbsp; &nbsp; | digoal1 &nbsp;| sky-mobi</div><div>&nbsp; 2 | zhou2 &nbsp; &nbsp; | digoal2 &nbsp;| sky-mobi</div><div>(2 rows)</div></div><div># 查看日志</div><div><div>2011-06-08 15:25:33.361 CST,"postgres","digoal",13968,"127.0.0.1:15445",4def23d5.3690,1,"SELECT",2011-06-08 15:25:09 CST,2/9,0,LOG,0</div><div>0000,"duration: 0.048 ms &nbsp;plan:</div><div>Query Text: select * from tbl_user_info limit 2;</div><div>Limit &nbsp;(cost=0.00..0.04 rows=2 width=31)</div><div>&nbsp; -&gt; &nbsp;Seq Scan on tbl_user_info &nbsp;(cost=0.00..183.00 rows=10000 width=31)",,,,,,,,,"psql"</div></div><div><br></div><div># 连接到digoal用户，这个LOAD的模块消失(后面会有解释).</div><div><div>digoal=# load 'auto_explain';</div><div>LOAD</div><div>digoal=# set session auto_explain.log_min_duration=0;</div><div>SET</div><div>digoal=# \c digoal digoal</div><div>You are now connected to database "digoal" as user "digoal".</div><div>digoal=&gt; select * from tbl_user_info limit 3;</div><div>&nbsp;id | firstname | lastname | &nbsp; corp &nbsp;&nbsp;</div><div>----+-----------+----------+----------</div><div>&nbsp; 1 | zhou1 &nbsp; &nbsp; | digoal1 &nbsp;| sky-mobi</div><div>&nbsp; 2 | zhou2 &nbsp; &nbsp; | digoal2 &nbsp;| sky-mobi</div><div>&nbsp; 3 | zhou3 &nbsp; &nbsp; | digoal3 &nbsp;| sky-mobi</div><div>(3 rows)</div></div><div># 查看日志，没有auto_explain的输出.即使这里使用了session来定义这个参数的有效范围。</div><div># 原因是session重新分配了，因为\c digoal digoal 相当于重新连接，backend也重新生成,如下.</div><div><div><br></div><div>digoal=&gt; select * from pg_stat_activity;</div><div>&nbsp;datid | datname | procpid | usesysid | usename | application_name | client_addr | client_hostname | client_port | &nbsp; &nbsp; &nbsp; &nbsp; backend_s</div><div>tart &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;xact_start &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;query_start &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| waiting | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;current_query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>-------+---------+---------+----------+---------+------------------+-------------+-----------------+-------------+------------------</div><div>-------------+-------------------------------+-------------------------------+---------+---------------------------------</div><div>&nbsp;16430 | digoal &nbsp;| &nbsp; 14155 | &nbsp; &nbsp;16423 | digoal &nbsp;| psql &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 127.0.0.1 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;5959 | 2011-06-08 15:31:</div><div>32.794906+08 | 2011-06-08 15:31:40.616346+08 | 2011-06-08 15:31:40.616346+08 | f &nbsp; &nbsp; &nbsp; | select * from pg_stat_activity;</div><div>(1 row)</div><div><br></div><div>digoal=&gt; \c digoal postgres</div><div>You are now connected to database "digoal" as user "postgres".</div><div>digoal=# select * from pg_stat_activity;</div><div>&nbsp;datid | datname | procpid | usesysid | usename &nbsp;| application_name | client_addr | client_hostname | client_port | &nbsp; &nbsp; &nbsp; &nbsp; backend_</div><div>start &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;xact_start &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;query_start &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| waiting | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;current_query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>-------+---------+---------+----------+----------+------------------+-------------+-----------------+-------------+-----------------</div><div>--------------+-------------------------------+-------------------------------+---------+---------------------------------</div><div>&nbsp;16430 | digoal &nbsp;| &nbsp; 14161 | &nbsp; &nbsp; &nbsp; 10 | postgres | psql &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 127.0.0.1 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;5961 | 2011-06-08 15:31</div><div>:43.937297+08 | 2011-06-08 15:31:45.178005+08 | 2011-06-08 15:31:45.178005+08 | f &nbsp; &nbsp; &nbsp; | select * from pg_stat_activity;</div><div>(1 row)</div></div><div><br></div><div># 那么如何避免这样的情况发生呢? 答案是使用set role .&nbsp;</div><div><div>digoal=# load 'auto_explain';</div><div>LOAD</div><div>digoal=# set session auto_explain.log_min_duration=0;</div><div>SET</div></div><div><div>digoal=# set role digoal;</div><div>SET</div><div>digoal=&gt; select * from tbl_user_info limit 3;</div><div>&nbsp;id | firstname | lastname | &nbsp; corp &nbsp;&nbsp;</div><div>----+-----------+----------+----------</div><div>&nbsp; 1 | zhou1 &nbsp; &nbsp; | digoal1 &nbsp;| sky-mobi</div><div>&nbsp; 2 | zhou2 &nbsp; &nbsp; | digoal2 &nbsp;| sky-mobi</div><div>&nbsp; 3 | zhou3 &nbsp; &nbsp; | digoal3 &nbsp;| sky-mobi</div><div>(3 rows)</div></div><div># 再看日志,已经有了 :&nbsp;</div><div><div>2011-06-08 15:29:30.011 CST,"postgres","digoal",14062,"127.0.0.1:5939",4def24bc.36ee,1,"SELECT",2011-06-08 15:29:00 CST,2/29,0,LOG,0</div><div>0000,"duration: 0.031 ms &nbsp;plan:</div><div>Query Text: select * from tbl_user_info limit 3;</div><div>Limit &nbsp;(cost=0.00..0.05 rows=3 width=31)</div><div>&nbsp; -&gt; &nbsp;Seq Scan on tbl_user_info &nbsp;(cost=0.00..183.00 rows=10000 width=31)",,,,,,,,,"psql"</div></div><div><br></div><div><br></div><div><br></div><div>参考:</div><div>man LOAD</div><div>man EXPLAIN</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/auto-explain.html"  >http://www.postgresql.org/docs/9.1/static/auto-explain.html</a></div></div>
	</div>
</div>
</body>
</html>