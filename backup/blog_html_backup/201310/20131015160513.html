<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap EXP: trace PostgreSQL instruction or block of instructions per sql or per session</h2>
	<h5 id="">2013-10-15 16:05:13&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020139153455311/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>执行一个SQL需要多少条单步指令或指令块?&nbsp;</div><div>这个问题可以通过Instruction probes来得到.</div><div>参考以前写的一篇blog :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201383042846295/"   >http://blog.163.com/digoal@126/blog/static/163877040201383042846295/</a></div><div>同时也测试一下使用普通全局变量和统计类型看看在没有锁争抢的情况下, 哪个效率更高一点, 从结果来看没有锁争抢的情况下普通的全局变量自增效率略高.</div><div>下面是统计一个SQL以及整个会话耗费的单步指令数的 :&nbsp;</div><div>查找当前连接的pid</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select pg_backend_pid();</font></div><div><font size="2"   >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 31531</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>一定要使用target process模式, 因为insn太庞大了 .</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >stap -e '</font></div><div><font size="2"   >global var1%[60000], var2%[60000]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").insn {&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; var1[pid()]++</font></div><div><font size="2"   >&nbsp; &nbsp; var2[pid()]++</font></div><div><font size="2"   >}&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__start") {</font></div><div><font size="2"   >&nbsp; delete var1[pid()]</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__done") {</font></div><div><font size="2"   >&nbsp; printf("query:%s, insn:%d\n", user_string($arg1), var1[pid()])</font></div><div><font size="2"   >&nbsp; delete var1[pid()]</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe end {</font></div><div><font size="2"   >&nbsp; foreach(x in var2-)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; printf("pid:%d, insn:%d\n", x, var2[x])</font></div><div><font size="2"   >&nbsp; delete var1</font></div><div><font size="2"   >&nbsp; delete var2</font></div><div><font size="2"   >}</font></div><div><font size="2"   >' -x 31531</font></div><p></p></pre></div><div>执行以下SQL :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select count(*) from pg_class;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp;296</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 1177.310 ms</font></div><div><font size="2"   >digoal=# select count(*) from pg_class;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp;296</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 1175.815 ms</font></div><div><font size="2"   >digoal=# select count(*) from pg_class;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp;296</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 1173.867 ms</font></div><p></p></pre></div><div>输出, 以上sql每条消耗了48万多次单步指令 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >query:select count(*) from pg_class;, insn:488264</font></div><div><font size="2"   >query:select count(*) from pg_class;, insn:488252</font></div><div><font size="2"   >query:select count(*) from pg_class;, insn:488252</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >一下为使用统计类型的测试结果, 速率上略慢 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >stap -e '</font></span></div><div><font size="2"   >global var1%[60000], var2%[60000]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").insn {&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; var1[pid()] &lt;&lt;&lt; 0</font></div><div><font size="2"   >&nbsp; &nbsp; var2[pid()] &lt;&lt;&lt; 0</font></div><div><font size="2"   >}&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__start") {</font></div><div><font size="2"   >&nbsp; delete var1[pid()]</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__done") {</font></div><div><font size="2"   >&nbsp; printf("query:%s, insn:%d\n", user_string($arg1), @count(var1[pid()]))</font></div><div><font size="2"   >&nbsp; delete var1[pid()]</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe end {</font></div><div><font size="2"   >&nbsp; foreach(x in var2-)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; printf("pid:%d, insn:%d\n", x, @count(var2[x]))</font></div><div><font size="2"   >&nbsp; delete var1</font></div><div><font size="2"   >&nbsp; delete var2</font></div><div><font size="2"   >}</font></div><div><font size="2"   >' -x 31531</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select count(*) from pg_class;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp;296</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 1225.236 ms</font></div><div><font size="2"   >digoal=# select count(*) from pg_class;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp;296</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 1223.868 ms</font></div><div><font size="2"   >digoal=# select count(*) from pg_class;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp;296</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 1222.593 ms</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >query:select count(*) from pg_class;, insn:488252</font></div><div><font size="2"   >query:select count(*) from pg_class;, insn:488252</font></div><div><font size="2"   >query:select count(*) from pg_class;, insn:488252</font></div><p></p></pre></div><div><br></div><div>以下为指令块的测试 :&nbsp;</div><div>指令块约为单步指令的1/8</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 ~]# stap -e '</font></span></div><div><font size="2"   >global var1%[60000], var2%[60000]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").insn.block {&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; var1[pid()] &lt;&lt;&lt; 0</font></div><div><font size="2"   >&nbsp; &nbsp; var2[pid()] &lt;&lt;&lt; 0</font></div><div><font size="2"   >}&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__start") {</font></div><div><font size="2"   >&nbsp; delete var1[pid()]</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__done") {</font></div><div><font size="2"   >&nbsp; printf("query:%s, insn:%d\n", user_string($arg1), @count(var1[pid()]))</font></div><div><font size="2"   >&nbsp; delete var1[pid()]</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe end {</font></div><div><font size="2"   >&nbsp; foreach(x in var2-)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; printf("pid:%d, insn:%d\n", x, @count(var2[x]))</font></div><div><font size="2"   >&nbsp; delete var1</font></div><div><font size="2"   >&nbsp; delete var2</font></div><div><font size="2"   >}</font></div><div><font size="2"   >' -x 31531</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select count(*) from pg_class;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp;296</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 159.659 ms</font></div><div><font size="2"   >digoal=# select count(*) from pg_class;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp;296</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 159.453 ms</font></div><div><font size="2"   >digoal=# select count(*) from pg_class;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp;296</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 159.501 ms</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >query:select count(*) from pg_class;, insn:60330</font></div><div><font size="2"   >query:select count(*) from pg_class;, insn:60342</font></div><div><font size="2"   >query:select count(*) from pg_class;, insn:60342</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >[参考]</span></div></div>1.&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201383042846295/"   >http://blog.163.com/digoal@126/blog/static/163877040201383042846295/</a><wbr></div>
	</div>
</div>
</body>
</html>