<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap kernel Marker probes</h2>
	<h5 id="">2013-10-07 10:18:50&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013971009843/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p></p><div><font size="2"   >This family of probe points connects to static probe markers inserted into the kernel or a module.&nbsp;</font></div><div><font size="2"   >These markers are special macro calls in the kernel that make probing faster and more reliable than with DWARF-based probes.&nbsp;</font></div><div><font size="2"   >DWARF debugging information is not required to use probe markers.</font></div><div><font size="2"   >mark探针是内核中定义的一些特殊的宏, 在编译内核或模块时就有了(类似前面讲到的userspace mark probe, 例如postgresql中的静态探针), 所以使用mark探针时不需要用到DWARF-based debuginfo包.</font></div><div><font size="2"   >mark探针使用起来比DWARF-based探针更快, 更安全.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Marker probe points begin with a kernel prefix which identifies the source of the symbol table used for finding markers.&nbsp;</font></div><div><font size="2"   >The suffix names the marker itself: mark.("MARK").&nbsp;</font></div><div><font size="2"   >The marker name string, which can contain wildcard characters, is matched against the names given to the marker macros when the kernel or module is compiled.&nbsp;</font></div><div><font size="2"   >Optionally, you can specify format("FORMAT").&nbsp;</font></div><div><font size="2"   >Specifying the marker format string allows differentiation between two markers with the same name but different marker format strings.</font></div><div><font size="2"   >mark探针用法, kernel.mark("MARK")[.format("FORMAT")], .format是可选的, 用于区分格式不同但是同名的mark探针.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The handler associated with a marker probe reads any optional parameters specified at the macro call site named $arg1 through $argNN, where NN is the number of parameters supplied by the macro. Number and string parameters are passed in a type-safe manner.</font></div><div><font size="2"   >在mark的宏定义时的参数, 可以在probe的handler中读取, 参数名的命名规则为$arg1 ... $argNN</font></div><div><font size="2"   >当然使用$$vars也可以输出这些参数.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The marker format string associated with a marker is available in $format. The marker name string is available in $name.</font></div><div><font size="2"   >在handler中如果要输出该mark探针的mark name以及格式name, 以$name和$format表述.</font></div><div><font size="2"   >Here are the marker probe constructs:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >kernel.mark("MARK")</font></div><div><font size="2"   >kernel.mark("MARK").format("FORMAT")</font></div><div><font size="2"   >For more information about marker probes, see http://sourceware.org/systemtap/wiki/UsingMarkers.</font></div><p></p></pre></div><div>举例 :&nbsp;</div><div>查看系统中有哪些mark探针, 使用stap -l, 如下</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 23px;"   ><font size="2"   >[root@db-172-16-3-39 ~]# stap -l 'kernel.mark("**")'</font></span></div><div><div><font size="2"   >kernel.mark("ext4_allocate_blocks").format("dev %s block %llu flags %u len %u ino %lu logical %llu goal %llu lleft %llu lright %llu pleft %llu pright %llu ")</font></div><div><font size="2"   >kernel.mark("ext4_allocate_inode").format("dev %s ino %lu dir %lu mode %d")</font></div><div><font size="2"   >kernel.mark("ext4_da_write_begin").format("dev %s ino %lu pos %llu len %u flags %u")</font></div><div><font size="2"   >kernel.mark("ext4_da_write_end").format("dev %s ino %lu pos %llu len %u copied %u")</font></div><div><font size="2"   >kernel.mark("ext4_da_writepage_result").format("dev %s ino %lu ret %d pages_written %d pages_skipped %ld congestion %d no_nrwrite_index_update %d")</font></div><div><font size="2"   >kernel.mark("ext4_da_writepages").format("dev %s ino %lu nr_t_write %ld pages_skipped %ld range_start %llu range_end %llu nonblocking %d for_kupdate %d for_reclaim %d for_writepages %d range_cyclic %d")</font></div><div><font size="2"   >kernel.mark("ext4_discard_preallocations").format("dev %s ino %lu")</font></div><div><font size="2"   >kernel.mark("ext4_free_blocks").format("dev %s block %llu count %lu flags %d ino %lu")</font></div><div><font size="2"   >kernel.mark("ext4_free_inode").format("dev %s ino %lu mode %d uid %lu gid %lu bocks %llu")</font></div><div><font size="2"   >kernel.mark("ext4_journalled_write_end").format("dev %s ino %lu pos %llu len %u copied %u")</font></div><div><font size="2"   >kernel.mark("ext4_mb_discard_preallocations").format("dev %s needed %d")</font></div><div><font size="2"   >kernel.mark("ext4_mb_new_group_pa").format("dev %s pstart %llu len %u lstart %u")</font></div><div><font size="2"   >kernel.mark("ext4_mb_new_inode_pa").format("dev %s ino %lu pstart %llu len %u lstart %u")</font></div><div><font size="2"   >kernel.mark("ext4_mb_release_group_pa").format("dev %s pstart %llu len %d")</font></div><div><font size="2"   >kernel.mark("ext4_mb_release_inode_pa").format("dev %s ino %lu block %llu count %u")</font></div><div><font size="2"   >kernel.mark("ext4_ordered_write_end").format("dev %s ino %lu pos %llu len %u copied %u")</font></div><div><font size="2"   >kernel.mark("ext4_request_blocks").format("dev %s flags %u len %u ino %lu lblk %llu goal %llu lleft %llu lright %llu pleft %llu pright %llu ")</font></div><div><font size="2"   >kernel.mark("ext4_request_inode").format("dev %s dir %lu mode %d")</font></div><div><font size="2"   >kernel.mark("ext4_sync_file").format("dev %s datasync %d ino %ld parent %ld")</font></div><div><font size="2"   >kernel.mark("ext4_sync_fs").format("dev %s wait %d")</font></div><div><font size="2"   >kernel.mark("ext4_write_begin").format("dev %s ino %lu pos %llu len %u flags %u")</font></div><div><font size="2"   >kernel.mark("ext4_writeback_write_end").format("dev %s ino %lu pos %llu len %u copied %u")</font></div><div><font size="2"   >kernel.mark("ext4_writepage").format("dev %s ino %lu page_index %lu")</font></div><div><font size="2"   >kernel.mark("jbd2_checkpoint").format("dev %s need_checkpoint %d")</font></div><div><font size="2"   >kernel.mark("jbd2_end_commit").format("dev %s transaction %d head %d")</font></div><div><font size="2"   >kernel.mark("jbd2_start_commit").format("dev %s transaction %d")</font></div></div><p></p></pre></div><div><br></div><div>探针使用举例 :&nbsp;</div><div>查看当前的文件系统</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-39-&gt; mount</font></div><div><font size="2"   >/dev/sda1 on / type ext3 (rw)</font></div><div><font size="2"   >proc on /proc type proc (rw)</font></div><div><font size="2"   >sysfs on /sys type sysfs (rw)</font></div><div><font size="2"   >devpts on /dev/pts type devpts (rw,gid=5,mode=620)</font></div><div><font size="2"   >tmpfs on /dev/shm type tmpfs (rw)</font></div><div><font size="2"   >none on /proc/sys/fs/binfmt_misc type binfmt_misc (rw)</font></div><div><font size="2"   >sunrpc on /var/lib/nfs/rpc_pipefs type rpc_pipefs (rw)</font></div><div><font size="2"   >/dev/mapper/vgdata01-lv01 on /pgdata/digoal/1921/data01 type ext4 (rw)</font></div><div><font size="2"   >/dev/mapper/vgdata01-lv02 on /pgdata/digoal/1921/data02 type ext4 (rw)</font></div><div><font size="2"   >/dev/mapper/vgdata01-lv03 on /pgdata/digoal/1921/data03 type ext4 (rw)</font></div><div><font size="2"   >/dev/mapper/vgdata01-lv04 on /pgdata/digoal/1921/data04 type ext4 (rw)</font></div><div><font size="2"   >/dev/mapper/vgdata01-lv05 on /pgdata/digoal/1921/data05 type ext4 (rw)</font></div><div><font size="2"   >/dev/mapper/vgdata01-lv06 on /pgdata/digoal/1921/data06 type ext4 (rw)</font></div><p></p></pre></div><div>执行以下stap</div><div><div style="line-height: 23px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 23px;"   ><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe kernel.mark("ext4_allocate_blocks") {printf("%s\n%s\n%s\n", $name, $format, $$vars)}'</font></div><div style="line-height: 23px;"   ></div><p></p></pre></div></div><div>然后在ext4文件系统<span style="line-height: 23px;"   >/pgdata/digoal/1921/data01</span><span style="line-height: 23px;"   >中做读写文件操作, stap输出如下</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 23px;"   ><font size="2"   >ext4_allocate_blocks</font></span></div><div><div><font size="2"   >dev %s block %llu flags %u len %u ino %lu logical %llu goal %llu lleft %llu lright %llu pleft %llu pright %llu&nbsp;</font></div><div><font size="2"   >$arg1=dm-2 $arg2=0x70a7a2 $arg3=0x420 $arg4=0x1 $arg5=0x1c041e $arg6=0x0 $arg7=0x708000 $arg8=0x0 $arg9=0x0 $arg10=0x0 $arg11=0x0</font></div><div><font size="2"   >ext4_allocate_blocks</font></div><div><font size="2"   >dev %s block %llu flags %u len %u ino %lu logical %llu goal %llu lleft %llu lright %llu pleft %llu pright %llu&nbsp;</font></div><div><font size="2"   >$arg1=dm-2 $arg2=0x70a7c1 $arg3=0x420 $arg4=0x1 $arg5=0x1c041c $arg6=0x0 $arg7=0x708000 $arg8=0x0 $arg9=0x0 $arg10=0x0 $arg11=0x0</font></div><div><font size="2"   >ext4_allocate_blocks</font></div><div><font size="2"   >dev %s block %llu flags %u len %u ino %lu logical %llu goal %llu lleft %llu lright %llu pleft %llu pright %llu&nbsp;</font></div><div><font size="2"   >$arg1=dm-2 $arg2=0x70abfc $arg3=0x420 $arg4=0x2 $arg5=0x1c0421 $arg6=0x0 $arg7=0x708000 $arg8=0x0 $arg9=0x0 $arg10=0x0 $arg11=0x0</font></div><div><font size="2"   >ext4_allocate_blocks</font></div><div><font size="2"   >dev %s block %llu flags %u len %u ino %lu logical %llu goal %llu lleft %llu lright %llu pleft %llu pright %llu&nbsp;</font></div><div><font size="2"   >$arg1=dm-2 $arg2=0x70a8f3 $arg3=0x420 $arg4=0x1 $arg5=0x1c0418 $arg6=0x0 $arg7=0x708000 $arg8=0x0 $arg9=0x0 $arg10=0x0 $arg11=0x0</font></div></div><p></p></pre></div><div>因为mark探针不需要debuginfo支持, 所以在未按照debuginfo包的OS中也可以使用, 例如</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-40 ~]# rpm -qa|grep debuginfo</font></div><div><font size="2"   >[root@db-172-16-3-40 ~]# stap -e 'probe kernel.mark("ext4_allocate_blocks") {printf("%s\n%s\n%s\n", $name, $format, $$vars)}'</font></div><div><font size="2"   >ext4_allocate_blocks</font></div><div><font size="2"   >dev %s block %llu flags %u len %u ino %lu logical %llu goal %llu lleft %llu lright %llu pleft %llu pright %llu&nbsp;</font></div><div><font size="2"   >$arg1=dm-0 $arg2=0x408079 $arg3=0x420 $arg4=0x1 $arg5=0x100463 $arg6=0x0 $arg7=0x408000 $arg8=0x0 $arg9=0x0 $arg10=0x0 $arg11=0x0</font></div><div><font size="2"   >ext4_allocate_blocks</font></div><div><font size="2"   >dev %s block %llu flags %u len %u ino %lu logical %llu goal %llu lleft %llu lright %llu pleft %llu pright %llu&nbsp;</font></div><div><font size="2"   >$arg1=dm-0 $arg2=0x40807b $arg3=0x420 $arg4=0x1 $arg5=0x10045e $arg6=0x0 $arg7=0x408000 $arg8=0x0 $arg9=0x0 $arg10=0x0 $arg11=0x0</font></div><div><font size="2"   >ext4_allocate_blocks</font></div><div><font size="2"   >dev %s block %llu flags %u len %u ino %lu logical %llu goal %llu lleft %llu lright %llu pleft %llu pright %llu&nbsp;</font></div><div><font size="2"   >$arg1=dm-0 $arg2=0x4093b1 $arg3=0x420 $arg4=0x3 $arg5=0x10045f $arg6=0x0 $arg7=0x408000 $arg8=0x0 $arg9=0x0 $arg10=0x0 $arg11=0x0</font></div><div><font size="2"   >ext4_allocate_blocks</font></div><div><font size="2"   >dev %s block %llu flags %u len %u ino %lu logical %llu goal %llu lleft %llu lright %llu pleft %llu pright %llu&nbsp;</font></div><div><font size="2"   >$arg1=dm-0 $arg2=0x4080e2 $arg3=0x420 $arg4=0x1 $arg5=0x10044e $arg6=0x0 $arg7=0x408000 $arg8=0x0 $arg9=0x0 $arg10=0x0 $arg11=0x0</font></div><p></p></pre></div><div>结构类型参数不能使用suffix 加$$的方法打印结构数据.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 linux]# stap -e 'probe kernel.mark("ext4_allocate_blocks") {printf("%s\n%s\n%s\n%s\n", $name, $format, $$vars, $arg2$$)}'</font></div><div><font size="2"   >semantic error: marker variable '$arg2' may not be pretty-printed: identifier '$arg2$$' at &lt;input&gt;:1:95</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; source: probe kernel.mark("ext4_allocate_blocks") {printf("%s\n%s\n%s\n%s\n", $name, $format, $$vars, $arg2$$)}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Pass 2: analysis failed. &nbsp;Try again with another '--vp 01' option.</font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="https://sourceware.org/systemtap/langref/Probe_points.html"   >https://sourceware.org/systemtap/langref/Probe_points.html</a></div><div>2.&nbsp;<a style="line-height: 23px;" target="_blank" rel="nofollow" href="http://sourceware.org/systemtap/wiki/UsingMarkers"   >http://sourceware.org/systemtap/wiki/UsingMarkers</a></div>3.&nbsp;<div>/usr/share/doc/kernel-doc-2.6.18/Documentation/markers.txt<div><div>/usr/share/man/man3/tapset::stap_staticmarkers.3stap.gz</div><div>/usr/share/systemtap/tapset/stap_staticmarkers.stp</div></div></div><div><div>/usr/src/debug/kernel-2.6.18/linux-2.6.18-348.12.1.el5.x86_64/include/linux/marker.h</div><div>/usr/src/debug/kernel-2.6.18/linux-2.6.18-348.12.1.el5.x86_64/kernel/marker.c</div></div><div><div>/usr/src/kernels/2.6.18-348.12.1.el5-x86_64/Module.markers</div><div>/usr/src/kernels/2.6.18-348.12.1.el5-x86_64/include/config/markers.h</div><div>/usr/src/kernels/2.6.18-348.12.1.el5-x86_64/include/config/sample/markers.h</div><div>/usr/src/kernels/2.6.18-348.12.1.el5-x86_64/include/linux/marker.h</div><div>/usr/src/kernels/2.6.18-348.12.1.el5-x86_64/samples/markers</div><div>/usr/src/kernels/2.6.18-348.12.1.el5-x86_64/samples/markers/Makefile</div></div></div>
	</div>
</div>
</body>
</html>