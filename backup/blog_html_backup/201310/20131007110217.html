<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap kernel Trace probes</h2>
	<h5 id="">2013-10-07 11:02:17&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020139710289441/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >This family of probe points hooks to static probing tracepoints inserted into the kernel or kernel modules.&nbsp;</font></div><div><font size="2"   >As with marker probes, these tracepoints are <u>special macro calls</u> inserted by kernel developers to make probing faster and more reliable than with DWARF-based probes.&nbsp;</font></div><div><font size="2"   >DWARF debugging information is not required to probe tracepoints.&nbsp;</font></div><div><font size="2"   >Tracepoints have more strongly-typed parameters than marker probes.</font></div><div><font size="2"   >内核trace探针和前面讲的内核mark探针类似, 也是一些内核中的特殊宏, 编译内核时就有了, 不需要DWARF-based debuginfo包的支持.</font></div><div><font size="2"   >使用trace探针比使用<span style="line-height: 23px;"   >DWARF-based探针速度快, 可靠.</span></font></div><div><span style="line-height: 23px;"   ><font size="2"   >trace探针比mark探针有更多的强类型参数可以使用, 命名规则也不一样, mark探针的参数$arg1 ... $argNN, trace探针不是以此规则命名, 见下面的讲解.</font></span></div><div><font size="2"   ><br></font></div><div><font size="2"   >Tracepoint probes begin with kernel. The next part names the tracepoint itself: trace("name").&nbsp;</font></div><div><font size="2"   >The tracepoint name string, which can contain wildcard characters, is matched against the names defined by the kernel developers in the tracepoint header files.</font></div><div><font size="2"   >trace探针使用方法: kernel.trace("NAME"), &nbsp;这里NAME同样可以使用通配符.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The handler associated with a tracepoint-based probe can read the optional parameters specified at the macro call site.&nbsp;</font></div><div><font size="2"   >These parameters are named according to the declaration by the tracepoint author.&nbsp;</font></div><div><font size="2"   >For example, the tracepoint probe kernel.trace("sched_switch") provides the parameters $rq, $prev, and $next.&nbsp;</font></div><div><font size="2"   >If the parameter is a complex type such as a struct pointer, then a script can access fields with the same syntax as DWARF $target variables.&nbsp;</font></div><div><font size="2"   >Tracepoint parameters cannot be modified; however, in guru mode a script can modify fields of parameters.</font></div><div><font size="2"   >trace探针的参数名是探针的作者指定的, 如<span style="line-height: 23px;"   >&nbsp;</span><span style="line-height: 23px;"   >kernel.trace("sched_switch") provides the parameters $rq, $prev, and $next.</span></font></div><div><font size="2"   >如果参数类型为结构类型, 可以使用suffix $来输出子结构或者$$来输出所有子结构直到基础类型. (注意前面讲过的mark探针不行.)</font></div><div><font size="2"   ><br></font></div><div><span style="line-height: 23px;"   ><font size="2"   >The name of the tracepoint is available in $$name, and a string of name=value pairs for all parameters of the tracepoint is available in $$vars or $$parms.</font></span></div></div><div><span style="line-height: 23px;"   ><font size="2"   >这里有几个特殊的变量, $$name指tracepoint名字.</font></span></div><div><span style="line-height: 23px;"   ><font size="2"   >$$vars指tracepoint的所有变量以name=value形式输出</font></span></div><div><font size="2"   ><span style="line-height: 23px;"   >$$parms</span><span style="line-height: 23px;"   >指tracepoint的参数以name=value形式输出</span></font></div><p></p></pre></div><div><span style="line-height: 23px;"   ><br></span></div><div><span style="line-height: 23px;"   >举例 :&nbsp;</span></div><div>使用stap -l输出系统支持的trace探针 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -l 'kernel.trace("**")'</font></div><div><font size="2"   >kernel.trace("activate_task")</font></div><div><font size="2"   >kernel.trace("add_to_page_cache")</font></div><div><font size="2"   >kernel.trace("block_bio_backmerge")</font></div><div><font size="2"   >kernel.trace("block_bio_bounce")</font></div><div><font size="2"   >kernel.trace("block_bio_complete")</font></div><div><font size="2"   >kernel.trace("block_bio_frontmerge")</font></div><div><font size="2"   >kernel.trace("block_bio_queue")</font></div><div><font size="2"   >kernel.trace("block_getrq")</font></div><div><font size="2"   >kernel.trace("block_plug")</font></div><div><font size="2"   >kernel.trace("block_remap")</font></div><div><font size="2"   >kernel.trace("block_rq_complete")</font></div><div><font size="2"   >kernel.trace("block_rq_insert")</font></div><div><font size="2"   >kernel.trace("block_rq_issue")</font></div><div><font size="2"   >kernel.trace("block_rq_requeue")</font></div><div><font size="2"   >kernel.trace("block_sleeprq")</font></div><div><font size="2"   >kernel.trace("block_split")</font></div><div><font size="2"   >kernel.trace("block_unplug_io")</font></div><div><font size="2"   >kernel.trace("block_unplug_timer")</font></div><div><font size="2"   >kernel.trace("consume_skb")</font></div><div><font size="2"   >kernel.trace("deactivate_task")</font></div><div><font size="2"   >kernel.trace("irq_entry")</font></div><div><font size="2"   >kernel.trace("irq_exit")</font></div><div><font size="2"   >kernel.trace("irq_softirq_entry")</font></div><div><font size="2"   >kernel.trace("irq_softirq_exit")</font></div><div><font size="2"   >kernel.trace("irq_tasklet_high_entry")</font></div><div><font size="2"   >kernel.trace("irq_tasklet_high_exit")</font></div><div><font size="2"   >kernel.trace("irq_tasklet_low_entry")</font></div><div><font size="2"   >kernel.trace("irq_tasklet_low_exit")</font></div><div><font size="2"   >kernel.trace("itimer_expire")</font></div><div><font size="2"   >kernel.trace("itimer_state")</font></div><div><font size="2"   >kernel.trace("kfree_skb")</font></div><div><font size="2"   >kernel.trace("mm_anon_cow")</font></div><div><font size="2"   >kernel.trace("mm_anon_fault")</font></div><div><font size="2"   >kernel.trace("mm_anon_pgin")</font></div><div><font size="2"   >kernel.trace("mm_anon_unmap")</font></div><div><font size="2"   >kernel.trace("mm_anon_userfree")</font></div><div><font size="2"   >kernel.trace("mm_directreclaim_reclaimall")</font></div><div><font size="2"   >kernel.trace("mm_directreclaim_reclaimzone")</font></div><div><font size="2"   >kernel.trace("mm_filemap_cow")</font></div><div><font size="2"   >kernel.trace("mm_filemap_fault")</font></div><div><font size="2"   >kernel.trace("mm_filemap_unmap")</font></div><div><font size="2"   >kernel.trace("mm_filemap_userunmap")</font></div><div><font size="2"   >kernel.trace("mm_kernel_pagefault")</font></div><div><font size="2"   >kernel.trace("mm_kswapd_runs")</font></div><div><font size="2"   >kernel.trace("mm_page_allocation")</font></div><div><font size="2"   >kernel.trace("mm_page_free")</font></div><div><font size="2"   >kernel.trace("mm_pagereclaim_free")</font></div><div><font size="2"   >kernel.trace("mm_pagereclaim_pgout")</font></div><div><font size="2"   >kernel.trace("mm_pagereclaim_shrinkactive")</font></div><div><font size="2"   >kernel.trace("mm_pagereclaim_shrinkactive_a2a")</font></div><div><font size="2"   >kernel.trace("mm_pagereclaim_shrinkactive_a2i")</font></div><div><font size="2"   >kernel.trace("mm_pagereclaim_shrinkinactive")</font></div><div><font size="2"   >kernel.trace("mm_pagereclaim_shrinkinactive_i2a")</font></div><div><font size="2"   >kernel.trace("mm_pagereclaim_shrinkinactive_i2i")</font></div><div><font size="2"   >kernel.trace("mm_pagereclaim_shrinkzone")</font></div><div><font size="2"   >kernel.trace("mm_pdflush_bgwriteout")</font></div><div><font size="2"   >kernel.trace("mm_pdflush_kupdate")</font></div><div><font size="2"   >kernel.trace("napi_poll")</font></div><div><font size="2"   >kernel.trace("net_dev_queue")</font></div><div><font size="2"   >kernel.trace("net_dev_receive")</font></div><div><font size="2"   >kernel.trace("net_dev_xmit")</font></div><div><font size="2"   >kernel.trace("netif_rx")</font></div><div><font size="2"   >kernel.trace("remove_from_page_cache")</font></div><div><font size="2"   >kernel.trace("rpc_bind_status")</font></div><div><font size="2"   >kernel.trace("rpc_call_status")</font></div><div><font size="2"   >kernel.trace("rpc_connect_status")</font></div><div><font size="2"   >kernel.trace("sched_process_exit")</font></div><div><font size="2"   >kernel.trace("sched_process_fork")</font></div><div><font size="2"   >kernel.trace("sched_process_free")</font></div><div><font size="2"   >kernel.trace("sched_process_wait")</font></div><div><font size="2"   >kernel.trace("sched_switch")</font></div><div><font size="2"   >kernel.trace("sched_wakeup")</font></div><div><font size="2"   >kernel.trace("sched_wakeup_new")</font></div><div><font size="2"   >kernel.trace("scsi_dispatch_cmd_done")</font></div><div><font size="2"   >kernel.trace("scsi_dispatch_cmd_error")</font></div><div><font size="2"   >kernel.trace("scsi_dispatch_cmd_start")</font></div><div><font size="2"   >kernel.trace("scsi_dispatch_cmd_timeout")</font></div><div><font size="2"   >kernel.trace("scsi_eh_wakeup")</font></div><div><font size="2"   >kernel.trace("signal_coredump")</font></div><div><font size="2"   >kernel.trace("signal_deliver")</font></div><div><font size="2"   >kernel.trace("signal_generate")</font></div><div><font size="2"   >kernel.trace("signal_lose_info")</font></div><div><font size="2"   >kernel.trace("signal_overflow_fail")</font></div><div><font size="2"   >kernel.trace("socket_recvmsg")</font></div><div><font size="2"   >kernel.trace("socket_sendmsg")</font></div><div><font size="2"   >kernel.trace("socket_sendpage")</font></div><div><font size="2"   >kernel.trace("softirq_raise")</font></div><div><font size="2"   >kernel.trace("timer_cancel")</font></div><div><font size="2"   >kernel.trace("timer_expire_entry")</font></div><div><font size="2"   >kernel.trace("timer_expire_exit")</font></div><div><font size="2"   >kernel.trace("timer_init")</font></div><div><font size="2"   >kernel.trace("timer_start")</font></div><p></p></pre></div><div><div>探针使用举例 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe kernel.trace("socket_sendmsg") { printf("%s\n%s\n%s\n", $$name, $$vars, $$parms) }'</font></div><div><font size="2"   >socket_sendmsg</font></div><div><font size="2"   >sock=0xffff81012f485580 msg=0xffff81012eb97da0 size=0xb0 ret=0xb0</font></div><div><font size="2"   >sock=0xffff81012f485580 msg=0xffff81012eb97da0 size=0xb0 ret=0xb0</font></div><div><font size="2"   >socket_sendmsg</font></div><div><font size="2"   >sock=0xffff81012efbfac0 msg=0xffff81022af7fe18 size=0xe8 ret=0xe8</font></div><div><font size="2"   >sock=0xffff81012efbfac0 msg=0xffff81022af7fe18 size=0xe8 ret=0xe8</font></div><p></p></pre></div></div><div>使用suffix $$输出结构数据 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe kernel.trace("socket_sendmsg") { printf("%s\n%s\n%s\n%s\n", $$name, $$vars, $$parms, $sock$$) }'</font></div><div><font size="2"   >socket_sendmsg</font></div><div><font size="2"   >sock=0xffff81012f485580 msg=0xffff81012eb97da0 size=0xb0 ret=0xb0</font></div><div><font size="2"   >sock=0xffff81012f485580 msg=0xffff81012eb97da0 size=0xb0 ret=0xb0</font></div><div><font size="2"   >{.state=1, .flags=0, .ops=0xffffffff802b5860, .fasync_list=0x0, .file=0xffff81012f5e69c0, .sk=0xffff81012fc6f100, .wait={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012f4855b8, .prev=0xffff81012f4855b8}}, .type=2}</font></div><div><font size="2"   >socket_sendmsg</font></div><div><font size="2"   >sock=0xffff8102004e8d00 msg=0xffff810202efdda0 size=0x1a4 ret=0x1a4</font></div><div><font size="2"   >sock=0xffff8102004e8d00 msg=0xffff810202efdda0 size=0x1a4 ret=0x1a4</font></div><div><font size="2"   >{.state=3, .flags=0, .ops=0xffffffff802b4960, .fasync_list=0x0, .file=0xffff81022ff75480, .sk=0xffff81022ac866c0, .wait={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff8102004e8d38, .prev=0xffff8102004e8d38}}, .type=1}</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 23px;" target="_blank" rel="nofollow" href="https://sourceware.org/systemtap/langref/Probe_points.html"   >https://sourceware.org/systemtap/langref/Probe_points.html</a></div><div>2.</div><div><div>/usr/share/doc/systemtap-client-1.8/examples/memory/vm.tracepoints.meta</div><div>/usr/share/doc/systemtap-client-1.8/examples/memory/vm.tracepoints.stp</div><div>/usr/share/systemtap/runtime/autoconf-utrace-via-tracepoints.c</div><div>/usr/src/debug/kernel-2.6.18/linux-2.6.18-348.12.1.el5.x86_64/include/linux/tracepoint.h</div><div>/usr/src/debug/kernel-2.6.18/linux-2.6.18-348.12.1.el5.x86_64/kernel/tracepoint.c</div><div>/usr/src/kernels/2.6.18-348.12.1.el5-x86_64/include/config/tracepoints.h</div><div>/usr/src/kernels/2.6.18-348.12.1.el5-x86_64/include/config/have/syscall/tracepoints.h</div><div>/usr/src/kernels/2.6.18-348.12.1.el5-x86_64/include/config/sample/tracepoints.h</div><div>/usr/src/kernels/2.6.18-348.12.1.el5-x86_64/include/linux/tracepoint.h</div><div>/usr/src/kernels/2.6.18-348.12.1.el5-x86_64/samples/tracepoints</div><div>/usr/src/kernels/2.6.18-348.12.1.el5-x86_64/samples/tracepoints/Makefile</div></div></div>
	</div>
</div>
</body>
</html>