<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap EXP: fix process probe global variables output BUG?(PostgreSQL checkpoint__done)</h2>
	<h5 id="">2013-10-18 9:02:21&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201391883345365/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>最近在测试PostgreSQL checkpoint__done以及buffer__sync__done动态跟踪时, 输出这个探针的变量出现错误, 详见</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201391622459221/"   >http://blog.163.com/digoal@126/blog/static/163877040201391622459221/</a></div><div>已经在pgsql-bug报告中提交了这个bug, 还未得到答复.</div><div><br></div><div>本文将分析一下出错的原因, 以及如何解决这个问题.</div><div>checkpoint__done输出变量NBuffers以及CheckpointStats时错误 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 postgresql-9.3.1]# stap --vp 10000 -e 'probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("checkpoint__done") {println($$vars)}'</font></div><div><font size="2"   >Pass 1: parsed user script and 96 library script(s) using 152024virt/25212res/2104shr/23932data kb, in 230usr/20sys/252real ms.</font></div><div><font size="2"   >WARNING: Can't parse SDT_V3 operand 'CheckpointStats+40(%rip)': identifier '$$vars' at &lt;input&gt;:1:87</font></div><div><font size="2"   >&nbsp;source: probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("checkpoint__done") {println($$vars)}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >WARNING: Can't parse SDT_V3 operand 'NBuffers(%rip)': identifier '$$vars' at :1:87</font></div><div><font size="2"   >&nbsp;source: probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("checkpoint__done") {println($$vars)}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >WARNING: Can't parse SDT_V3 operand 'CheckpointStats+44(%rip)': identifier '$$vars' at :1:87</font></div><div><font size="2"   >&nbsp;source: probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("checkpoint__done") {println($$vars)}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >WARNING: Can't parse SDT_V3 operand 'CheckpointStats+48(%rip)': identifier '$$vars' at :1:87</font></div><div><font size="2"   >&nbsp;source: probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("checkpoint__done") {println($$vars)}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >WARNING: Can't parse SDT_V3 operand 'CheckpointStats+52(%rip)': identifier '$$vars' at :1:87</font></div><div><font size="2"   >&nbsp;source: probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("checkpoint__done") {println($$vars)}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >semantic error: unable to find local 'arg1', [man error::dwarf] dieoffset 0xd00f5 in /home/pg93/pgsql9.3.1/bin/postgres, near pc 0x4b9789 in CreateCheckPoint xlog.c (alternatives: $flags $shutdown $checkPoint $recptr $Insert $rdata $freespace $_logSegNo $vxids $nvxids $__func__): identifier '$$vars' at :1:87</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; source: probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("checkpoint__done") {println($$vars)}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >semantic error: SDT asm not understood, requires debuginfo: identifier '$$vars' at :1:87</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; source: probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("checkpoint__done") {println($$vars)}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Pass 2: analysis failed. &nbsp;[man error::pass2]</font></div><p></p></pre></div><div>buffer__sync__done探针输出变量NBuffers时错误 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 postgresql-9.3.1]# stap --vp 10000 -e 'probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("buffer__sync__done") {println($$vars)}'</font></div><div><font size="2"   >Pass 1: parsed user script and 96 library script(s) using 152024virt/25212res/2104shr/23932data kb, in 230usr/20sys/252real ms.</font></div><div><font size="2"   >WARNING: Can't parse SDT_V3 operand 'NBuffers(%rip)': identifier '$$vars' at &lt;input&gt;:1:89</font></div><div><font size="2"   >&nbsp;source: probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("buffer__sync__done") {println($$vars)}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >semantic error: unable to find local 'arg1', [man error::dwarf] dieoffset 0x43a1d1 in /home/pg93/pgsql9.3.1/bin/postgres, near pc 0x630697 in &lt;unknown&gt; bufmgr.c (alternatives: $buf_id $num_to_scan $num_to_write $num_written $mask): identifier '$$vars' at :1:89</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; source: probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("buffer__sync__done") {println($$vars)}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >semantic error: SDT asm not understood, requires debuginfo: identifier '$$vars' at :1:89</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; source: probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("buffer__sync__done") {println($$vars)}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Pass 2: analysis failed. &nbsp;[man error::pass2]</font></div><p></p></pre></div></div><div>这两个错误都源自输出的不是探针所在函数内的本地变量, 而是全局变量</div><div>例如checkpoint__done :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TRACE_POSTGRESQL_CHECKPOINT_DONE(CheckpointStats.ckpt_bufs_written,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;NBuffers,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CheckpointStats.ckpt_segs_added,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CheckpointStats.ckpt_segs_removed,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CheckpointStats.ckpt_segs_recycled);</font></div><p></p></pre></div><div>探针所在函数内没有<span style="line-height: 28px;"   >CheckpointStats以及NBuffers变量的定义,&nbsp;</span><span style="line-height: 28px;"   >CheckpointStats在文件内函数外,&nbsp;</span><span style="line-height: 28px;"   >NBuffers则在其他文件中.</span></div><div>src/backend/access/transam/xlog.c</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >/*</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* Statistics for current checkpoint are collected in this global struct.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* Because only the background writer or a stand-alone backend can perform</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* checkpoints, this will be unused in normal backends.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;*/</font></div><div style="line-height: 28px;"   ><font size="2"   >CheckpointStatsData CheckpointStats;</font></div><p></p></pre></div><div>src/backend/utils/init/globals.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* Primary determinants of sizes of shared-memory structures.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* MaxBackends is computed by PostmasterMain after modules have had a chance to</font></div><div><font size="2"   >&nbsp;* register background workers.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NBuffers = 1000;</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >src/include/storage/bufmgr.h</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/* in globals.c ... this duplicates miscadmin.h */</font></div><div><font size="2"   >extern PGDLLIMPORT int NBuffers;</font></div><p></p></pre></div><div>在buffer__sync__done探针中则是用到了NBuffers :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >src/backend/storage/buffer/bufmgr.c</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TRACE_POSTGRESQL_BUFFER_SYNC_DONE(NBuffers, num_written, num_to_write);</font></div><p></p></pre></div><div style="line-height: 28px;"   >[解决办法1 : ]</div><div style="line-height: 28px;"   >新建本地变量用来存储这些全局变量的值, 探针输出这些本地变量即可. 例如 :&nbsp;</div></div><div>[root@db-172-16-3-150 postgresql-9.3.1]# vi src/backend/access/transam/xlog.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int v1,v2,v3,v4,vnb;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; vnb = NBuffers;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v1 = CheckpointStats.ckpt_bufs_written;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v2 = CheckpointStats.ckpt_segs_added;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v3 = CheckpointStats.ckpt_segs_removed;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v4 = CheckpointStats.ckpt_segs_recycled;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TRACE_POSTGRESQL_CHECKPOINT_DONE(v1,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;vnb,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v2,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v3,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v4);</font></div><p></p></pre></div><div>[root@db-172-16-3-150 postgresql-9.3.1]# vi src/backend/storage/buffer/bufmgr.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int vnb;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; vnb = NBuffers;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TRACE_POSTGRESQL_BUFFER_SYNC_DONE(vnb, num_written, num_to_write);</font></div><p></p></pre></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 postgresql-9.3.1]# gmake &amp;&amp; gmake install</font></div><div><div><font size="2"   >[root@db-172-16-3-150 postgresql-9.3.1]# su - pg93</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; pg_ctl restart -m fast</font></div></div><p></p></pre></div><div>在探针$$locals本地变量中就可以看到这几个刚才定义的变量了.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 ~]# stap -D MAXSTRINGLEN=100000 --vp 10000 -e 'probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("checkpoint__done") {println($$locals$$)}'</font></div><div><font size="2"   >Pass 1: parsed user script and 96 library script(s) using 152048virt/25252res/2116shr/23956data kb, in 230usr/10sys/252real ms.</font></div><div><font size="2"   >shutdown=? checkPoint={.redo=26648020808, .ThisTimeLineID=1, .PrevTimeLineID=1, .fullPageWrites='\001', .nextXidEpoch=0, .nextXid=130667532, .nextOid=57479, .nextMulti=1, .nextMultiOffset=0, .oldestXid=1800, .oldestXidDB=1, .oldestMulti=1, .oldestMultiDB=1, .time=1382057407, .oldestActiveXid=130667532} recptr=26648020968 Insert={.PrevRecord=26648020864, .curridx=886, .currpage=0x7f6ca01fc000, .currpos="", .RedoRecPtr=26648020808, .forcePageWrites='\000', .fullPageWrites='\001', .exclusiveBackup='\000', .nonExclusiveBackups=0, .lastBackupStart=0} rdata={.data="H?X4", .len=72, .buffer=0, .buffer_std='\001', .next=0x0} freespace=? _logSegNo=? vxids={.backendId=?, .localTransactionId=?} nvxids=0 __func__="CreateCheckPoint" v1=0 v2=0 v3=0 v4=0 vnb=?</font></div></div><div><div><font size="2"   ><br></font></div><div><span style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 ~]# stap -D MAXSTRINGLEN=1000000 --vp 10000 -e 'probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("buffer__sync__done") {println($$locals)}'</font></span></div><div><font size="2"   >Pass 1: parsed user script and 96 library script(s) using 152040virt/25244res/2116shr/23948data kb, in 240usr/10sys/251real ms.</font></div><div><font size="2"   >buf_id=0x501 num_to_scan=? num_to_write=0x21e num_written=0x21e mask=? vnb=?</font></div></div><p></p></pre></div></div><div>举例, 输出checkpoint的探针信息 :&nbsp;</div><div><span style="line-height: 28px;"   >page_size=8KB, xlog_segment_size=16MB</span></div><div><span style="line-height: 28px;"   >执行stap 以及输出 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# stap -D MAXSTRINGLEN=100000 --vp 10000 -e '</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("checkpoint__done") {</font></div><div><font size="2"   >&nbsp; printf("ckpt_bufs_written:%d, ckpt_segs_added:%d, ckpt_segs_removed:%d, ckpt_segs_recycled:%d\n", $v1, $v2, $v3, $v4)</font></div><div><font size="2"   >}'</font></div><div><font size="2"   >Pass 1: parsed user script and 96 library script(s) using 152048virt/25248res/2116shr/23956data kb, in 240usr/20sys/256real ms.</font></div><div><font size="2"   >ckpt_bufs_written:1, ckpt_segs_added:0, ckpt_segs_removed:0, ckpt_segs_recycled:0</font></div><div><font size="2"   >ckpt_bufs_written:54056, ckpt_segs_added:0, ckpt_segs_removed:0, ckpt_segs_recycled:43</font></div><p></p></pre></div><div>SQL 如下 :&nbsp;</div><div>经计算和stap输出结果吻合.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# truncate t1;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;6/8E9ABA48</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# insert into t1 select generate_series(1,10000000),'test';</font></div><div><font size="2"   >INSERT 0 10000000</font></div><div><font size="2"   >digoal=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;6/B9952F18</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;6/B9952FB8</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# \dt+ t1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | Name | Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp;Size &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+------+-------+----------+--------+-------------</font></div><div><font size="2"   >&nbsp;public | t1 &nbsp; | table | postgres | 422 MB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select 54056*8/1024;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 422</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select pg_xlog_location_diff('6/B9952FB8', '6/8E9ABA48');</font></div><div><font size="2"   >&nbsp;pg_xlog_location_diff&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;721057136</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select 721057136/16/1024/1024;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;42</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >[解决办法2 : ]</span></div><div><span style="line-height: 28px;"   >使用@("varname")或者$varname的方式来访问本地或全局变量, 适用所有探针, 如果探针没有定义参数, 也可以使用这种方法得到探针所在函数的本地变量或全局变量值.&nbsp;</span></div><div><span style="line-height: 28px;"   >参考, man stapprobes</span></div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020138113455697/"   >http://blog.163.com/digoal@126/blog/static/16387704020138113455697/</a></div><div>把修改过的源码还原重新编译, 重启数据库, 使用以下stap脚本即可.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# stap -D MAXSTRINGLEN=100000 --vp 10000 -e '</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("checkpoint__done") {</font></div><div><font size="2"   >&nbsp; printf("ckpt_bufs_written:%d, ckpt_segs_added:%d, ckpt_segs_removed:%d, ckpt_segs_recycled:%d, NBuffers:%d\n", @var("CheckpointStats")-&gt;ckpt_bufs_written, @var("CheckpointStats")-&gt;ckpt_segs_added, @var("CheckpointStats")-&gt;ckpt_segs_removed, @var("CheckpointStats")-&gt;ckpt_segs_recycled, @var("NBuffers"))</font></div><div><font size="2"   >}'</font></div><div><font size="2"   >Pass 1: parsed user script and 96 library script(s) using 151984virt/25256res/2116shr/23892data kb, in 240usr/20sys/251real ms.</font></div><div><font size="2"   >ckpt_bufs_written:0, ckpt_segs_added:0, ckpt_segs_removed:0, ckpt_segs_recycled:0, NBuffers:262144</font></div><div><font size="2"   >ckpt_bufs_written:0, ckpt_segs_added:0, ckpt_segs_removed:0, ckpt_segs_recycled:0, NBuffers:262144</font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" href="http://blog.163.com/digoal@126/blog/static/163877040201391622459221/"   >http://blog.163.com/digoal@126/blog/static/163877040201391622459221/</a></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">fche@redhat.com - 2013-10-21 8:11:45</h5>
				<div>See also https://sourceware.org/git/gitweb.cgi?p=systemtap.git;a=blob_plain;f=man/error::sdt.7stap</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 fche@redhat.com - 2013-10-21 8:11:45</h5>
				<div style="width:600px;">thanks</div>
			</div>
	</div>
</div>
</body>
</html>