<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap parse preprocessing stage - Conditional compilation</h2>
	<h5 id="">2013-10-08 16:22:13&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020139831157191/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p></p><div><font size="2"   >One of the steps of parsing is a simple preprocessing stage.&nbsp;</font></div><div><font size="2"   >The preprocessor supports conditionals with a general form similar to the ternary operator (Section [*]).</font></div><div><font size="2"   >%( CONDITION %? TRUE-TOKENS %)</font></div><div><font size="2"   >%( CONDITION %? TRUE-TOKENS %: FALSE-TOKENS %)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The CONDITION is a limited expression whose format is determined by its first keyword.&nbsp;</font></div><div><font size="2"   >The following is the general syntax.</font></div><div><font size="2"   >%( &lt;condition&gt; %? &lt;code&gt; [ %: &lt;code&gt; ] %)</font></div><p></p></pre></div><div>stap 预处理阶段支持条件编译, 类似C里面的#ifdef 这种的, stap的条件编译语法与三目操作符类似, 语法如下 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><span style="line-height: 23px;"   ><font size="2"   >%( &lt;condition&gt; %? &lt;code&gt; [ %: &lt;code&gt; ] %)</font></span></div><div></div><p></p></pre><div><span style="line-height: 23px;"   >中括号部分表示可选.</span></div><div><span style="line-height: 23px;"   >例如 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 23px;"   ><font size="2"   ><div>[root@db-172-16-3-39 ~]# stap -e '%( CONFIG_UTRACE == "y" %? probe begin {printf("true\n"); exit();} %: probe begin {printf("false\n"); exit();} %)'</div><div>true</div><div><br></div><div>[root@db-172-16-3-39 ~]# stap -e '%( CONFIG_UTRACE == "n" %? probe begin {printf("true\n"); exit();} %: probe begin {printf("false\n"); exit();} %)'</div><div>false</div><div><br></div><div>[root@db-172-16-3-39 ~]# stap -e '%( 1==1 %? probe begin {printf("true\n"); exit();} %: probe begin {printf("false\n"); exit();} %)'</div><div>true</div><div><br></div><div>[root@db-172-16-3-39 ~]# stap -e '%( 1!=1 %? probe begin {printf("true\n"); exit();} %: probe begin {printf("false\n"); exit();} %)'</div><div>false</div></font></span></div><div><font size="2"   >因为是预编译, 以下的条件为false, 但是缺少%:部分, 所以这个条件编译的结果为空, 报错如下.</font></div><div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -e '%( 1!=1 %? probe begin {printf("true\n"); exit();} %)'</font></div><div><font size="2"   >Input file '&lt;input&gt;' is empty or missing.</font></div><div><font size="2"   >Pass 1: parse failed. &nbsp;Try again with another '--vp 1' option.</font></div></div><p></p></pre></div><div><br></div><div>条件1, 判断变量是否定义.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Conditions based on available target variables</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The predicate @defined() is available for testing whether a particular $variable/expression is resolvable at translation time. The following is an example of its use:</font></div><div><font size="2"   >&nbsp; probe foo { if (@defined($bar)) log ("$bar is available here") }</font></div><p></p></pre></div><div>变量是否定义的判断不能放在条件预编译中处理. 报错<span style="line-height: 23px;"   >parse error: expected 'arch' or 'kernel_v' or 'kernel_vr' or 'CONFIG_...'</span></div><div>条件预编译的条件TOKEN只能是arch, kernel_v, kernel_vr或者CONFIG_..., 所以@define不能算条件预编译.</div><div>如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 20px;"   >[root@db-172-16-3-39 tapset]# stap --vp 1 -e '%( @defined(abc) %? probe begin {printf("true\n"); exit();} %)'<br>parse error: expected 'arch' or 'kernel_v' or 'kernel_vr' or 'CONFIG_...'<br>             or comparison between strings or integers<br>        at: identifier '@defined' at &lt;input&gt;:1:4<br>     source: %( @defined(abc) %? probe begin {printf("true\n"); exit();} %)<br>                ^<br>parse error: incomplete conditional - missing '%('<br>        at: operator '%?' at &lt;input&gt;:1:18<br>     source: %( @defined(abc) %? probe begin {printf("true\n"); exit();} %)<br>                              ^<br>parse error: incomplete conditional - missing '%('<br>        at: operator '%)' at &lt;input&gt;:1:61<br>     source: %( @defined(abc) %? probe begin {printf("true\n"); exit();} %)<br>                                                                         ^<br>3 parse errors.<br>Pass 1: parsed user script and 85 library script(s) using 146796virt/23708res/3016shr/21392data kb, in 160usr/10sys/173real ms.<br>Pass 1: parse failed.  Try again with another '--vp 1' option.</span></font></div><p></p></pre></div><div>但是它可以用在probe语法中.</div><div>例如</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >probe begin if (condition) {...}</font></div><div><div><font size="2"   >[root@db-172-16-3-39 tapset]# stap -e 'probe begin if (1==1) {printf("trigged\n"); exit()}'</font></div><div><font size="2"   >trigged</font></div><div><font size="2"   >[root@db-172-16-3-39 tapset]# stap -e 'probe begin if (1!=1) {printf("trigged\n"); exit()}'</font></div><div><font size="2"   >[root@db-172-16-3-39 tapset]#&nbsp;</font></div></div><p></p></pre></div><div>详见</div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402013811957335/"   >http://blog.163.com/digoal@126/blog/static/1638770402013811957335/</a></div><div>判断变量是否存在, 一般用于handler内部, 放在handler外面也会报错.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 tapset]# stap --vp 01 -e 'probe kernel.function("icmp_echo") if (@defined($var1)) { printf("trigged\n"); exit(); }'</font></div><div><font size="2"   >semantic error: unexpected @defined: identifier '@defined' at &lt;input&gt;:1:40</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; source: probe kernel.function("icmp_echo") if (@defined($var1)) { printf("trigged\n"); exit(); }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Pass 2: analyzed script: 1 probe(s), 1 function(s), 0 embed(s), 0 global(s) using 222896virt/81852res/45260shr/37356data kb, in 300usr/70sys/379real ms.</font></div><div><font size="2"   >Pass 2: analysis failed. &nbsp;Try again with another '--vp 01' option.</font></div><p></p></pre></div><div>通常的用法如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 tapset]# stap -e 'probe kernel.function("icmp_echo") { if (@defined($skb)) printf("trigged\n"); exit(); }'</font></div><div><font size="2"   >trigged</font></div></div><div><font size="2"   >[root@db-172-16-3-39 tapset]# stap -e 'probe kernel.function("icmp_echo") { if (@defined($var1)) printf("trigged\n"); exit(); }'</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 23px;"   >条件2, 内核版本的比较.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Conditions based on kernel version: kernel_v, kernel_vr</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >If the first part of a conditional expression is the identifier kernel_v or kernel_vr,&nbsp;</font></div><div><font size="2"   >the second part must be one of six standard numeric comparison operators ``&lt;'', ``&lt;='', ``=='', ``!='', ``&gt;'', or ``&gt;='',&nbsp;</font></div><div><font size="2"   >and the third part must be a string literal that contains an RPM-style version-release value.&nbsp;</font></div><div><font size="2"   >The condition returns true if the version of the target kernel (as optionally overridden by the -r option) matches the given version string.&nbsp;</font></div><div><font size="2"   >The comparison is performed by the glibc function strverscmp.</font></div><div><font size="2"   >kernel_v refers to the kernel version number only, such as ``2.6.13".</font></div><div><font size="2"   >kernel_vr refers to the kernel version number including the release code suffix, such as ``2.6.13-1.322FC3smp''.</font></div><p></p></pre></div><div>在条件预编译中使用kernel_v或者kernel_vr可以比较内核版本.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 tapset]# uname -r</font></div><div><font size="2"   >2.6.18-348.12.1.el5</font></div></div><div><div><font size="2"   >[root@db-172-16-3-39 tapset]# stap -e 'probe begin {%( kernel_v == "2.6.181" %? printf("true\n"); %: printf("false\n"); %) exit();}'&nbsp;</font></div><div><font size="2"   >false</font></div><div><font size="2"   >[root@db-172-16-3-39 tapset]# stap -e 'probe begin {%( kernel_v == "2.6.18" %? printf("true\n"); %: printf("false\n"); %) exit();}'</font></div><div><font size="2"   >true</font></div><div><font size="2"   >[root@db-172-16-3-39 tapset]# stap -e 'probe begin {%( kernel_vr == "2.6.18-348.12.1.el5" %? printf("true\n"); %: printf("false\n"); %) exit();}'</font></div><div><font size="2"   >true</font></div></div><p></p></pre></div><div>还可以判断版本号的大小, 大于等于, 不等于 等.</div><div>底层使用glibc函数strverscmp来实现.</div><div><br></div><div><span style="line-height: 23px;"   >条件3, 硬件架构判断.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Conditions based on architecture: arch</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >If the first part of the conditional expression is the identifier arch which refers to the processor architecture, then the second part is a string comparison operator ''=='' or ''!='', and the third part is a string literal for matching it. This comparison is a simple string equality or inequality. The currently supported architecture strings are i386, i686, x86_64, ia64, s390, and powerpc.</font></div><p></p></pre></div><div>硬件架构判断只能使用等于或不等于. 例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 tapset]# uname -m</font></div><div><font size="2"   >x86_64</font></div></div><div><div><font size="2"   >[root@db-172-16-3-39 tapset]# stap -e 'probe begin {%( arch == "x86" %? printf("true\n"); %: printf("false\n"); %) exit();}'</font></div><div><font size="2"   >false</font></div><div><font size="2"   >[root@db-172-16-3-39 tapset]# stap -e 'probe begin {%( arch == "x86_64" %? printf("true\n"); %: printf("false\n"); %) exit();}'</font></div><div><font size="2"   >true</font></div></div><p></p></pre></div><div><span style="line-height: 23px;"   ><br></span></div><div><span style="line-height: 23px;"   >条件4, 执行stap脚本的用户权限判断.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Conditions based on privilege level: systemtap_privilege</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >If the first part of the conditional expression is the identifier systemtap_privilege which refers to the privilege level the systemtap script is being compiled with, then the second part is a string comparison operator ''=='' or ''!='', and the third part is a string literal for matching it.&nbsp;</font></div><div><font size="2"   >This comparison is a simple string equality or inequality.&nbsp;</font></div><div><font size="2"   >The possible privilege strings to consider are "stapusr" for unprivileged scripts, and "stapsys" or "stapdev" for privileged scripts.&nbsp;</font></div><div><font size="2"   >(In general, to test for a privileged script it is best to use != "stapusr".)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This condition can be used to write scripts that can be run in both privileged and unprivileged modes, with additional functionality made available in the privileged case.</font></div><p></p></pre></div><div>在1.8的stap版本中报错, 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 tapset]# stap -e 'probe begin {%( systemtap_privilege == "stapusr" %? printf("true\n"); %: printf("false\n"); %) exit();}'</font></div><div><font size="2"   >parse error: expected 'arch' or 'kernel_v' or 'kernel_vr' or 'CONFIG_...'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;or comparison between strings or integers</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at: identifier 'systemtap_privilege' at &lt;input&gt;:1:17</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;source: probe begin {%( systemtap_privilege == "stapusr" %? printf("true\n"); %: printf("false\n"); %) exit();}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >parse error: incomplete conditional - missing '%('</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at: operator '%?' at &lt;input&gt;:1:50</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;source: probe begin {%( systemtap_privilege == "stapusr" %? printf("true\n"); %: printf("false\n"); %) exit();}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   >parse error: incomplete conditional - missing '%('</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at: operator '%:' at &lt;input&gt;:1:71</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;source: probe begin {%( systemtap_privilege == "stapusr" %? printf("true\n"); %: printf("false\n"); %) exit();}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >parse error: incomplete conditional - missing '%('</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at: operator '%)' at &lt;input&gt;:1:93</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;source: probe begin {%( systemtap_privilege == "stapusr" %? printf("true\n"); %: printf("false\n"); %) exit();}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >4 parse errors.</font></div><div><font size="2"   >Pass 1: parse failed. &nbsp;Try again with another '--vp 1' option.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-39 tapset]# stap -V<br>Systemtap translator/driver (version 1.8/0.152 non-git sources)<br>Copyright (C) 2005-2012 Red Hat, Inc. and others<br>This is free software; see the source for copying conditions.<br>enabled features: AVAHI LIBRPM LIBSQLITE3 NSS BOOST_SHARED_PTR TR1_UNORDERED_MAP NLS</font></div><p></p></pre></div><div><br></div><div>最后, 以下是书上的例子,&nbsp;</div><div>5.&nbsp;True and False Tokens</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >TRUE-TOKENS and FALSE-TOKENS are zero or more general parser tokens, possibly including nested preprocessor conditionals, that are pasted into the input stream if the condition is true or false.&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >For example, the following code induces a parse error unless the target kernel version is newer than 2.6.5.</font></div><div><font size="2"   >%( kernel_v &lt;= "2.6.5" %? **ERROR** %) &nbsp; &nbsp; &nbsp;# invalid token sequence</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The following code adapts to hypothetical kernel version drift.</font></div><div><font size="2"   ><span style="line-height: 20px;"   >实现对不同的版本使用不同的探针函数名:</span></font></div><div><font size="2"   >probe kernel.function (</font></div><div><font size="2"   >&nbsp; &nbsp; %( kernel_v &lt;= "2.6.12" %? "__mm_do_fault" %:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; %( kernel_vr == "2.6.13-1.8273FC3smp" %? "do_page_fault" %: UNSUPPORTED %)</font></div><div><font size="2"   >&nbsp; &nbsp; %)) { /* ... */ }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >%( arch == "ia64" %?</font></div><div><font size="2"   >&nbsp; &nbsp; probe syscall.vliw = kernel.function("vliw_widget") {}</font></div><div><font size="2"   >%)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The following code adapts to the presence of a kernel CONFIG option.</font></div><div><font size="2"   >%( CONFIG_UTRACE == "y" %?</font></div><div><font size="2"   >&nbsp; &nbsp; probe process.syscall {}</font></div><div><font size="2"   >%)</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 23px;"   >[参考]</span></div><wbr><div>1.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="https://sourceware.org/systemtap/langref/Language_elements.html"   >https://sourceware.org/systemtap/langref/Language_elements.html</a></div><div>2. man&nbsp;strverscmp</div></div>
	</div>
</div>
</body>
</html>