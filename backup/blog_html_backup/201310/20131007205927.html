<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap Special probe points (begin, end, error, never)</h2>
	<h5 id="">2013-10-07 20:59:27&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013978959440/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >The probe points begin and end are defined by the translator to refer to the time of session startup and shutdown.&nbsp;</font></div><div><font size="2"   >There are no target variables available in either context.</font></div><p></p></pre></div><div>begin和end探针在stap会话开始和结束时触发, 显然这类探针没有target variable.</div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >4.11.1 begin</font></div><div><font size="2"   >The begin probe is the start of the SystemTap session. All begin probe handlers are run during the startup of the session.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >4.11.2 end</font></div><div><font size="2"   >The end probe is the end of the SystemTap session.&nbsp;</font></div><div><font size="2"   >All end probes are run during the normal shutdown of a session, such as in the aftermath of a SystemTap exit() function call, or an interruption from the user.&nbsp;</font></div><div><font size="2"   >In the case of an shutdown triggered by error, end probes are not run.</font></div><p></p></pre></div><div>end探针在正常的会话退出时触发, 如果是发生错误的情况下退出stap会话, 那么不会触发end探针, 这种情况下如果启用了error探针那么会触发error探针.&nbsp;</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe begin {exit()} probe end {printf("endprobe\n") }'</font></div><div><font size="2"   >endprobe</font></div><p></p></pre></div><div>exit()函数被调用后, 触发end探针.</div><div>如下用户使用Ctrl+C退出stap进程, 也会触发end探针.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe end {printf("endprobe\n") }'</font></div><div><font size="2"   >endprobe</font></div><p></p></pre></div><div>使用kill 关闭stap进程, 触发end探针.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe end {printf("endprobe\n") }'</font></div><div><font size="2"   ><br></font></div></div><div><div><font size="2"   >[root@db-172-16-3-39 ~]# ps -ewf|grep stap</font></div><div><font size="2"   >root &nbsp; &nbsp; 19895 18140 &nbsp;2 20:35 pts/1 &nbsp; &nbsp;00:00:00 stap -e probe end {printf("endprobe\n") }</font></div><div><font size="2"   >root &nbsp; &nbsp; 19896 19895 &nbsp;0 20:35 pts/1 &nbsp; &nbsp;00:00:00 /usr/libexec/systemtap/stapio -R stap_3b85e14e7aa8d5cc9dc48f854a127851_612</font></div><div><font size="2"   >root &nbsp; &nbsp; 19910 18273 &nbsp;0 20:35 pts/2 &nbsp; &nbsp;00:00:00 grep stap</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# kill 19895</font></div></div><div><font size="2"   >探针handler输出 :&nbsp;</font></div><div><span style="line-height: 23px;"   ><font size="2"   >endprobe</font></span></div><p></p></pre></div><div><span style="line-height: 23px;"   >使用kill-9&nbsp;</span><span style="line-height: 23px;"   >关闭stap进程, 不会触发end探针.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe end {printf("endprobe\n") }'</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-39 ~]# ps -ewf|grep stap</font></div><div><font size="2"   >root &nbsp; &nbsp; 19946 18140 &nbsp;4 20:35 pts/1 &nbsp; &nbsp;00:00:00 stap -e probe end {printf("endprobe\n") }</font></div><div><font size="2"   >root &nbsp; &nbsp; 19947 19946 &nbsp;0 20:35 pts/1 &nbsp; &nbsp;00:00:00 /usr/libexec/systemtap/stapio -R stap_3b85e14e7aa8d5cc9dc48f854a127851_612</font></div><div><font size="2"   >root &nbsp; &nbsp; 19960 18273 &nbsp;0 20:35 pts/2 &nbsp; &nbsp;00:00:00 grep stap</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# kill -9 19946</font></div></div><div><font size="2"   >探针handler输出 :&nbsp;</font></div><div><font size="2"   >Killed</font></div><p></p></pre></div><div>注意 : 使用kill -9 杀死stap进程会造成stap临时模块无法卸载.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe end {printf("endprobe\n") }'</font></div><div><font size="2"   >Error inserting module '/tmp/stapj6rK9K/stap_3b85e14e7aa8d5cc9dc48f854a127851_612.ko': File exists</font></div><div><font size="2"   >WARNING: /usr/bin/staprun exited with status: 1</font></div><div><font size="2"   >Pass 5: run failed. &nbsp;Try again with another '--vp 00001' option.</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# lsmod|grep stap</font></div><div><font size="2"   >stap_3b85e14e7aa8d5cc9dc48f854a127851_612 &nbsp; &nbsp;68864 &nbsp;2&nbsp;</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# rmmod stap_3b85e14e7aa8d5cc9dc48f854a127851_612</font></div><div><font size="2"   >ERROR: Module stap_3b85e14e7aa8d5cc9dc48f854a127851_612 is in use</font></div></div><div><div><font size="2"   >[root@db-172-16-3-39 ~]# rmmod -f stap_3b85e14e7aa8d5cc9dc48f854a127851_612</font></div><div><font size="2"   >ERROR: Removing 'stap_3b85e14e7aa8d5cc9dc48f854a127851_612': Resource temporarily unavailable</font></div></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >4.11.3 error</font></div><div><font size="2"   >The error probe point is similar to the end probe, except the probe handler runs when the session ends if an error occurred.&nbsp;</font></div><div><font size="2"   >In this case, an end probe is skipped, but each error probe is still attempted.&nbsp;</font></div><div><font size="2"   >You can use an error probe to clean up or perform a final action on script termination.</font></div><div><font size="2"   >Here is a simple example:</font></div><div><font size="2"   >probe error { println ("Oops, errors occurred. Here's a report anyway.")</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; foreach (coin in mint) { println (coin) } }</font></div><p></p></pre></div><div>error探针在stap会话发生错误并且退出会话时触发, 如果触发了error探针, 那么end探针不会被触发.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe begin {error("1.error funn\n")} probe end {printf("2.end probe\n")} probe error {printf("3.error probe\n") }'</font></div><div><font size="2"   >ERROR: 1.error funn</font></div><div><font size="2"   >3.error probe</font></div><div><font size="2"   >WARNING: Number of errors: 1, skipped probes: 0</font></div><div><font size="2"   >WARNING: /usr/bin/staprun exited with status: 1</font></div><div><font size="2"   >Pass 5: run failed. &nbsp;Try again with another '--vp 00001' option.</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >4.11.4 begin, end, and error probe sequence</font></div><div><font size="2"   >begin, end, and error probes can be specified with an optional sequence number that controls the order in which they are run.&nbsp;</font></div><div><font size="2"   >If no sequence number is provided, the sequence number defaults to zero and probes are run in the order that they occur in the script file. Sequence numbers may be either positive or negative, and are especially useful for tapset writers who want to do initialization in a begin probe.&nbsp;</font></div><div><font size="2"   >The following are examples.</font></div><div><font size="2"   ># In a tapset file:</font></div><div><font size="2"   >probe begin(-1000) { ... }</font></div><div><font size="2"   ># In a user script:</font></div><div><font size="2"   >probe begin { ... }</font></div><div><font size="2"   >The user script begin probe defaults to sequence number zero, so the tapset begin probe will run first.</font></div><p></p></pre></div><div>使用begin, end, error时, 还可以加上序列号, 例如begin(10), 使用序列号的目的是当有多个begin探针时, 区分触发的先后顺序. 序列从小到大执行.</div><div>例如 :&nbsp;</div><div><div style="line-height: 23px;"   ><div style="line-height: 23px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 23px;"   ><div style="line-height: 23px;"   ><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe begin {printf ("a\n")} probe begin(0) {printf ("b\n")} probe begin(10) {printf ("c\n")}'&nbsp;</font></div><div style="line-height: 23px;"   ><font size="2"   >a</font></div><div style="line-height: 23px;"   ><font size="2"   >b</font></div><div style="line-height: 23px;"   ><font size="2"   >c</font></div></div><div style="line-height: 23px;"   ><div style="line-height: 23px;"   ><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe begin {printf ("a\n")} probe begin(0) {printf ("b\n")} probe begin(-10) {printf ("c\n")}'&nbsp;</font></div><div style="line-height: 23px;"   ><font size="2"   >c</font></div><div style="line-height: 23px;"   ><font size="2"   >a</font></div><div style="line-height: 23px;"   ><font size="2"   >b</font></div></div><p></p></pre></div></div></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >4.11.5 never</font></div><div><font size="2"   >The never probe point is defined by the translator to mean never.&nbsp;</font></div><div><font size="2"   >Its statements are analyzed for symbol and type correctness, but its probe handler is never run.&nbsp;</font></div><div><font size="2"   >This probe point may be useful in conjunction with optional probes.</font></div><p></p></pre></div></div><div>never探针的handler不会执行.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 23px;" target="_blank" rel="nofollow" href="https://sourceware.org/systemtap/langref/Probe_points.html"   >https://sourceware.org/systemtap/langref/Probe_points.html</a></div><div>2.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="https://sourceware.org/systemtap/langref/Probe_points.html#sub:Optional-probe-points"   >https://sourceware.org/systemtap/langref/Probe_points.html#sub:Optional-probe-points</a></div><div>3.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-error.html"   >https://sourceware.org/systemtap/tapsets/API-error.html</a></div></div>
	</div>
</div>
</body>
</html>