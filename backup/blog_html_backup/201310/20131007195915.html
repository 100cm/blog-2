<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap Timer probes</h2>
	<h5 id="">2013-10-07 19:59:15&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020139752612312/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p></p><div><font size="2"   >You can use intervals defined by the standard kernel jiffies timer to trigger probe handlers asynchronously.</font></div><div><font size="2"   >A jiffy is a kernel-defined unit of time typically between 1 and 60 msec.&nbsp;</font></div><div><font size="2"   >timer属于异步探针, 利用<span style="line-height: 23px;"   >standard kernel jiffies timer触发.</span></font></div><div><span style="line-height: 23px;"   ><font size="2"   >standard kernel jiffies timer一般内核定义1个jiffy为1到60毫秒.</font></span></div><div><span style="line-height: 23px;"   ><font size="2"   ><br></font></span></div><div><font size="2"   >Two probe point variants are supported by the translator:</font></div><div><font size="2"   >timer.jiffies(N)</font></div><div><font size="2"   >timer.jiffies(N).randomize(M)</font></div><div><font size="2"   >The probe handler runs every N jiffies.&nbsp;</font></div><div><font size="2"   >If the randomize component is given, a linearly distributed random value in the range [-M ... +M] is added to N every time the handler executes.&nbsp;</font></div><div><font size="2"   >N is restricted to a reasonable range (1 to approximately 1,000,000), and M is restricted to be less than N.&nbsp;</font></div><div><font size="2"   >There are no target variables provided in either context.&nbsp;</font></div><div><font size="2"   >Probes can be run concurrently on multiple processors.</font></div><div><font size="2"   >timer探针的用法之一 :&nbsp;</font></div><div><font size="2"   >timer.jiffies(N), 每隔N个jiffy后触发.</font></div><div><span style="line-height: 23px;"   ><font size="2"   >timer.jiffies(N).randomize(M) , 每隔N个jiffy+(-M到M之间的一个随机数) , N必须大于M</font></span></div><div><font size="2"   >例如N=10, M=3, 那么每隔10+(-3到3之间的一个随机数)个jiffy后触发.</font></div><div><font size="2"   >N的取值范围<span style="line-height: 23px;"   >1 to approximately 1,000,000</span></font></div><div><font size="2"   >timer探针没有上下文相关变量, 同时timer探针支持同时被多个处理器触发(如多核CPU).</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Intervals may be specified in units of time.&nbsp;</font></div><div><font size="2"   >There are two probe point variants similar to the jiffies timer:</font></div><div><span style="line-height: 23px;"   ><font size="2"   >timer.ms(N)</font></span></div><div><font size="2"   >timer.ms(N).randomize(M)</font></div><div><font size="2"   >Here, N and M are specified in milliseconds, but the full options for units are:</font></div><div><font size="2"   >seconds (s or sec),&nbsp;</font></div><div><font size="2"   >milliseconds (ms or msec),&nbsp;</font></div><div><font size="2"   >microseconds (us or usec),&nbsp;</font></div><div><font size="2"   >nanoseconds (ns or nsec),&nbsp;</font></div><div><font size="2"   >hertz (hz).&nbsp;</font></div><div><font size="2"   >Randomization is not supported for hertz timers. // 时间单位为赫兹时不能使用随机数加减.</font></div><div><font size="2"   >timer计数器除了可以使用jiffy单位, 还可以使用其他时间单位如s, ms, us, ns, hz(赫兹).</font></div><div><font size="2"   ><br></font></div><div><span style="line-height: 23px;"   ><font size="2"   >The resolution of the timers depends on the target kernel.&nbsp;</font></span></div><div><font size="2"   >For kernels prior to 2.6.17, timers are limited to jiffies resolution, so intervals are rounded up to the nearest jiffies interval.&nbsp;</font></div><div><font size="2"   >After 2.6.17, the implementation uses hrtimers for greater precision, though the resulting resolution will be dependent upon architecture.&nbsp;</font></div><div><font size="2"   >In either case, if the randomize component is given, then the random value will be added to the interval before any rounding occurs.</font></div><div><font size="2"   >不同的内核版本支持的时间精度不一样, 例如2.6.17以前的内核版本, 最小的时间单位为jiffy, 所以如果使用us, ns, hz时会round为最接近的jiffy. 将丢失probe中定义的精度.</font></div><div><font size="2"   >2.6.17以后的版本, 使用hrtimer得到更高的精度.</font></div><div><font size="2"   >不管使用什么内核版本, 如果使用了randomize, 都是先计算timer+随机数, 然后做round.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Profiling timers are available to provide probes that execute on all CPUs at each system tick.&nbsp;</font></div><div><font size="2"   >This probe takes no parameters, as follows.</font></div><div><font size="2"   >timer.profile</font></div><div><font size="2"   >还有一个时间探针是timer.profile, 间隔每个系统时钟周期触发.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Full context information of the interrupted process is available, making this probe suitable for implementing a time-based sampling profiler.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The following is an example of timer usage.</font></div><div><font size="2"   ># Refers to a periodic interrupt, every 1000 jiffies:</font></div><div><font size="2"   >timer.jiffies(1000)</font></div><div><font size="2"   ># Fires every 5 seconds:</font></div><div><font size="2"   >timer.sec(5)</font></div><div><font size="2"   ># Refers to a periodic interrupt, every 1000 +/- 200 jiffies:</font></div><div><font size="2"   >timer.jiffies(1000).randomize(200)</font></div><p></p></pre></div><div><br></div><div>timer.profile举例, 8核cpu :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe timer.profile {printf("cpu:%d, ns:%d, execname:%s, pid:%d\n", cpu(), cpu_clock_ns(cpu()), execname(), pid())}'</font></div><div><div><font size="2"   >cpu:6, ns:1381147076271836282, execname:swapper, pid:0</font></div><div><font size="2"   >cpu:5, ns:1381147076272759039, execname:swapper, pid:0</font></div><div><font size="2"   >cpu:3, ns:1381147076272759641, execname:swapper, pid:0</font></div><div><font size="2"   >cpu:7, ns:1381147076272758724, execname:swapper, pid:0</font></div><div><font size="2"   >cpu:1, ns:1381147076272759556, execname:swapper, pid:0</font></div><div><font size="2"   >cpu:0, ns:1381147076272830348, execname:swapper, pid:0</font></div><div><font size="2"   >cpu:4, ns:1381147076272834135, execname:swapper, pid:0</font></div><div><font size="2"   >cpu:6, ns:1381147076272834370, execname:swapper, pid:0</font></div><div><font size="2"   >cpu:2, ns:1381147076272834220, execname:swapper, pid:0</font></div><div><font size="2"   >cpu:3, ns:1381147076273714522, execname:stapio, pid:18710</font></div></div><p></p></pre></div><div><br></div><div>时间探针支持的格式 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >timer.jiffies(N)[.<span style="line-height: 23px;"   >randomize(M)</span><span style="line-height: 23px;"   >]</span></font></div><div><font size="2"   ><span style="line-height: 23px;"   >timer.s(N)[.</span><span style="line-height: 23px;"   >randomize(M)</span><span style="line-height: 23px;"   >]</span></font></div><div><font size="2"   ><span style="line-height: 23px;"   >timer.ms(N)[.</span><span style="line-height: 23px;"   >randomize(M)</span><span style="line-height: 23px;"   >]</span></font></div><div><font size="2"   ><span style="line-height: 23px;"   >timer.us(N)[.</span><span style="line-height: 23px;"   >randomize(M)</span><span style="line-height: 23px;"   >]</span></font></div><div><font size="2"   ><span style="line-height: 23px;"   >timer.ns(N)[.</span><span style="line-height: 23px;"   >randomize(M)</span><span style="line-height: 23px;"   >]</span></font></div><div><span style="line-height: 23px;"   ><font size="2"   >timer.hz(N)</font></span></div><div><span style="line-height: 23px;"   ><font size="2"   >timer.profile</font></span></div><p></p></pre></div><div><span style="line-height: 23px;"   ><br></span></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 23px;" target="_blank" rel="nofollow" href="https://sourceware.org/systemtap/langref/Probe_points.html"   >https://sourceware.org/systemtap/langref/Probe_points.html</a></div><div>2.&nbsp;<a style="line-height: 23px;" href="http://blog.163.com/digoal@126/blog/static/163877040201062810748700/"   >http://blog.163.com/digoal@126/blog/static/163877040201062810748700/</a></div><div>3.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-cpu-clock-ns.html"   >https://sourceware.org/systemtap/tapsets/API-cpu-clock-ns.html</a></div><div>4.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/timestamp_stp.html"   >https://sourceware.org/systemtap/tapsets/timestamp_stp.html</a></div></div>
	</div>
</div>
</body>
</html>