<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap PROCFS probes</h2>
	<h5 id="">2013-10-06 10:10:30&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201396882559/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div><div>systemtap 虚拟文件交互探针, 在/proc/systemtap/MODNAME目录下对指定文件读写时触发.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >These probe points allow procfs pseudo-files in /proc/systemtap/MODNAME to be created, read and written. Specify the name of the systemtap module as MODNAME. There are four probe point variants supported by the translator:</font></div><div><font size="2"   >procfs("PATH").read</font></div><div><font size="2"   >procfs("PATH").write</font></div><div><font size="2"   >procfs.read</font></div><div><font size="2"   >procfs.write</font></div><div><font size="2"   >PATH is the file name to be created, relative to /proc/systemtap/MODNAME. If no PATH is specified (as in the last two variants in the previous list), PATH defaults to "command".</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >When a user reads /proc/systemtap/MODNAME/PATH, the corresponding procfs read probe is triggered. Assign the string data to be read to a variable named $value, as follows:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >procfs("PATH").read { $value = "100\n" }</font></div><div><font size="2"   >When a user writes into /proc/systemtap/MODNAME/PATH, the corresponding procfs write probe is triggered. The data the user wrote is available in the string variable named $value, as follows:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >procfs("PATH").write { printf("User wrote: %s", $value) }</font></div><p></p></pre></div><div>MODNAME不固定, 随机生成, PATH指文件名, PATH不指定的话默认名为command.</div><div>例如 :&nbsp;</div><div>以下探针在用户读取command时, 内容为$value指定的"abc\n"</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 05 -e 'probe procfs.read { $value = "abc\n"; }'</font></div><div><font size="2"   >Eliding side-effect-free singleton block operator '{' at &lt;input&gt;:1:19</font></div><div><font size="2"   >Pass 2: analyzed script: 1 probe(s), 1 function(s), 1 embed(s), 0 global(s) using 147764virt/24452res/3256shr/22360data kb, in 10usr/0sys/6real ms.</font></div><p></p></pre></div></div><div>stap执行后, 自动创建MODNAME, 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# lsmod|grep stap</font></div><div><font size="2"   >stap_c8e98652dbf72a846df6f69d72aa98de_1058 &nbsp; &nbsp;74144 &nbsp;2</font></div><p></p></pre></div></div><div>进入<span style="line-height: 23px;"   >/proc/systemtap/stap_c8e98652dbf72a846df6f69d72aa98de_1058/目录, 可以看到名为command的文件.</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cd /proc/systemtap/stap_c8e98652dbf72a846df6f69d72aa98de_1058/</font></div><div><font size="2"   >[root@db-172-16-3-39 stap_c8e98652dbf72a846df6f69d72aa98de_1058]# ll</font></div><div><font size="2"   >total 0</font></div><div><font size="2"   >-r-------- 1 root root 0 Oct &nbsp;6 08:06 command</font></div><p></p></pre></div><div>用户读取这个文件时, 探针触发, 并输出给用户$value值abc\n.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 stap_c8e98652dbf72a846df6f69d72aa98de_1058]# cat command&nbsp;</font></div><div><font size="2"   >abc</font></div><p></p></pre></div></div><div>PATH命名探针举例 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 05 -e 'probe procfs("digoal").read { $value = "abc\n"; }'</font></div><div><font size="2"   >Eliding side-effect-free singleton block operator '{' at &lt;input&gt;:1:29</font></div><div><font size="2"   >Pass 2: analyzed script: 1 probe(s), 1 function(s), 1 embed(s), 0 global(s) using 148284virt/24444res/3256shr/22880data kb, in 10usr/0sys/6real ms.</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-39 ~]# cd /proc/systemtap/stap_c6373a2dc49ccd7f60f51cb02d421026_1078/</font></div><div><font size="2"   >[root@db-172-16-3-39 stap_c6373a2dc49ccd7f60f51cb02d421026_1078]# ll</font></div><div><font size="2"   >total 0</font></div><div><font size="2"   >-r-------- 1 root root 0 Oct &nbsp;6 08:06 digoal</font></div><div><font size="2"   >[root@db-172-16-3-39 stap_c6373a2dc49ccd7f60f51cb02d421026_1078]# cat digoal&nbsp;</font></div><div><font size="2"   >abc</font></div></div><p></p></pre></div><div><br></div><div>写探针举例, 当用户写文件时, 在探针的handler中可以通过$value读取到用户往文件写入的值.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 05 -e 'probe procfs("digoal").write { printf("%s", $value) }'</font></div><div><font size="2"   >Eliding side-effect-free singleton block operator '{' at &lt;input&gt;:1:30</font></div><div><font size="2"   >Pass 2: analyzed script: 1 probe(s), 1 function(s), 1 embed(s), 0 global(s) using 147320virt/24428res/3248shr/21916data kb, in 10usr/0sys/6real ms.</font></div><p></p></pre></div><div>往虚拟文件中写入两行 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cd /proc/systemtap/stap_96658768b416c658023814c8d71d4eb9_1098/</font></div><div><font size="2"   >[root@db-172-16-3-39 stap_96658768b416c658023814c8d71d4eb9_1098]# echo -e "Hello, I'm digoal\nWho are you?\n" &gt; ./digoal</font></div><p></p></pre></div><div>执行完以上写入后, 探针的handler,&nbsp;<span style="line-height: 23px;"   >printf("%s", $value)输出了用户使用</span><span style="line-height: 23px;"   >echo -e "Hello, I'm digoal\nWho are you?\n" &gt; ./digoal</span><span style="line-height: 23px;"   >写入的值.</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 23px;"   ><font size="2"   >Pass 2: analyzed script: 1 probe(s), 1 function(s), 1 embed(s), 0 global(s) using 147320virt/24428res/3248shr/21916data kb, in 10usr/0sys/6real ms.</font></span></div><div><font size="2"   >Hello, I'm digoal</font></div><div><font size="2"   >Who are you?</font></div><p></p></pre></div><div><br></div><div>读写探针举例 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 05 -e 'probe procfs("digoal").read { $value = "abc\n"; } probe procfs("digoal").write { printf("%s", $value) }'</font></div><div><font size="2"   >Eliding side-effect-free singleton block operator '{' at &lt;input&gt;:1:29</font></div><div><font size="2"   >Eliding side-effect-free singleton block operator '{' at &lt;input&gt;:1:80</font></div><div><font size="2"   >Pass 2: analyzed script: 2 probe(s), 2 function(s), 1 embed(s), 0 global(s) using 147328virt/24460res/3264shr/21924data kb, in 0usr/0sys/6real ms.</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-39 systemtap]# lsmod|grep stap</font></div><div><font size="2"   >stap_b8c49f4eed3186e72a6dc47a0ffe4c8b_1410 &nbsp; &nbsp;76320 &nbsp;2&nbsp;</font></div></div><div><div><font size="2"   >[root@db-172-16-3-39 systemtap]# cd /proc/systemtap/stap_b8c49f4eed3186e72a6dc47a0ffe4c8b_1410/</font></div><div><font size="2"   >[root@db-172-16-3-39 stap_b8c49f4eed3186e72a6dc47a0ffe4c8b_1410]# ll</font></div><div><font size="2"   >total 0</font></div><div><font size="2"   >-rw------- 1 root root 0 Oct &nbsp;6 08:12 digoal</font></div></div><div><div><font size="2"   >[root@db-172-16-3-39 stap_b8c49f4eed3186e72a6dc47a0ffe4c8b_1410]# cat digoal&nbsp;</font></div><div><font size="2"   >abc</font></div><div><font size="2"   >[root@db-172-16-3-39 stap_b8c49f4eed3186e72a6dc47a0ffe4c8b_1410]# echo -e "Hello, I'm digoal\nWho are you?\n" &gt; ./digoal</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >Pass 2: analyzed script: 2 probe(s), 2 function(s), 1 embed(s), 0 global(s) using 147324virt/24456res/3264shr/21920data kb, in 0usr/0sys/6real ms.</font></div><div><font size="2"   >Hello, I'm digoal</font></div><div><font size="2"   >Who are you?</font></div></div><p></p></pre></div><div><div><br></div></div><div>最后, 使用procfs探针注意, 如果用户未退出虚拟文件系统目录, 例如<span style="line-height: 23px;"   >/proc/systemtap/stap_96658768b416c658023814c8d71d4eb9_1098/, 那么在探针结束时,如 Ctrl+C, 不能及时收回mod. 对于这种情况可以退出改目录, 使用rmmod删除对应的mod.</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 05 -e 'probe procfs.read { $value = "abc\n"; }'</font></div><div><font size="2"   >Eliding side-effect-free singleton block operator '{' at &lt;input&gt;:1:19</font></div><div><font size="2"   >Pass 2: analyzed script: 1 probe(s), 1 function(s), 1 embed(s), 0 global(s) using 148280virt/24432res/3256shr/22876data kb, in 10usr/0sys/6real ms.</font></div><div><font size="2"   >Error inserting module '/tmp/stapLYrleG/stap_c8e98652dbf72a846df6f69d72aa98de_1058.ko': File exists</font></div><div><font size="2"   >WARNING: /usr/bin/staprun exited with status: 1</font></div><div><font size="2"   >Pass 5: run failed. &nbsp;Try again with another '--vp 00001' option.</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-39 ~]# lsmod|grep stap</font></div><div><font size="2"   >Module &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Size &nbsp;Used by</font></div><div><font size="2"   >stap_a8bfea9ea582644b887b62bb4323e296_1370 &nbsp; &nbsp;76192 &nbsp;1&nbsp;</font></div><div><font size="2"   >stap_c8e98652dbf72a846df6f69d72aa98de_1058 &nbsp; &nbsp;74144 &nbsp;0&nbsp;</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-39 ~]# rmmod stap_c8e98652dbf72a846df6f69d72aa98de_1058</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# rmmod stap_a8bfea9ea582644b887b62bb4323e296_1370</font></div><div><font size="2"   >ERROR: Module stap_a8bfea9ea582644b887b62bb4323e296_1370 is in use</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# lsmod|grep stap</font></div><div><font size="2"   >stap_a8bfea9ea582644b887b62bb4323e296_1370 &nbsp; &nbsp;76192 &nbsp;0&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-39 stap_a8bfea9ea582644b887b62bb4323e296_1370]# cd</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# rmmod stap_a8bfea9ea582644b887b62bb4323e296_1370</font></div></div><p></p></pre></div><div><br></div><div><br></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="https://sourceware.org/systemtap/langref/Probe_points.html#SECTION00056000000000000000"   >https://sourceware.org/systemtap/langref/Probe_points.html#SECTION00056000000000000000</a></div><div>2. man lsmod, rmmod, modinfo</div></div>
	</div>
</div>
</body>
</html>