<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap EXP: PostgreSQL IN-BUILD mark Class 5 - read|write relation</h2>
	<h5 id="">2013-10-16 19:41:27&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201391653616103/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><br></div><div>本文介绍relation 读写相关的探针: 包含读relation以及写relation(例如index, table,tmp table或者他们的fsm, vm文件等).</div><div>从这些探针中我们可以得到一下信息 :&nbsp;</div><div>1. 读relation开始: forkNum, blocknum, tbs_oid, db_oid, pg_class.relfilenode, (read to local or shared buffer)</div><div>这些信息和buffer类的探针相似, 这里就不介绍了, 请参考 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402013916488761/"   >http://blog.163.com/digoal@126/blog/static/1638770402013916488761/</a></div><div>2. 读relation结束: 比开始多了2个变量, 真实的从relation读到的字节数以及期望的字节数.<span style="line-height: 28px;"   >如果两者不相等则意味着问题.</span></div><div>3. 写relation开始: 同<span style="line-height: 28px;"   >读relation开始.</span></div><div><span style="line-height: 28px;"   >4.&nbsp;</span><span style="line-height: 28px;"   >写relation结束: 比开始多了2个变量, 真实的写到relation的字节数以及期望的字节数. 如果两者不相等则意味着问题.</span></div><div>探针的详细信息如下 :&nbsp;</div><div><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; background-color: rgb(224, 236, 239); border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 13.333333969116211px; line-height: normal;"   ><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >smgr-md-read-start</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >(ForkNumber, BlockNumber, Oid, Oid, Oid, int)</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Probe that fires when beginning to read a block from a relation. arg0 and arg1 contain the fork and block numbers of the page. arg2, arg3, and arg4 contain the tablespace, database, and relation OIDs identifying the relation. arg5 is the ID of the backend which created the temporary relation for a local buffer, or InvalidBackendId (-1) for a shared buffer.</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >smgr-md-read-done</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >(ForkNumber, BlockNumber, Oid, Oid, Oid, int, int, int)</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Probe that fires when a block read is complete. arg0 and arg1 contain the fork and block numbers of the page. arg2, arg3, and arg4 contain the tablespace, database, and relation OIDs identifying the relation. arg5 is the ID of the backend which created the temporary relation for a local buffer, or InvalidBackendId (-1) for a shared buffer. arg6 is the number of bytes actually read, while arg7 is the number requested (if these are different it indicates trouble).</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >smgr-md-write-start</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >(ForkNumber, BlockNumber, Oid, Oid, Oid, int)</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Probe that fires when beginning to write a block to a relation. arg0 and arg1 contain the fork and block numbers of the page. arg2, arg3, and arg4 contain the tablespace, database, and relation OIDs identifying the relation. arg5 is the ID of the backend which created the temporary relation for a local buffer, or InvalidBackendId (-1) for a shared buffer.</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >smgr-md-write-done</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >(ForkNumber, BlockNumber, Oid, Oid, Oid, int, int, int)</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Probe that fires when a block write is complete. arg0 and arg1 contain the fork and block numbers of the page. arg2, arg3, and arg4 contain the tablespace, database, and relation OIDs identifying the relation. arg5 is the ID of the backend which created the temporary relation for a local buffer, or InvalidBackendId (-1) for a shared buffer. arg6 is the number of bytes actually written, while arg7 is the number requested (if these are different it indicates trouble).</td></tr></table></div><div><br></div><div>探针在probes.h总的定义信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/* TRACE_POSTGRESQL_SMGR_MD_READ_START ( int, unsigned int, unsigned int, unsigned int, unsigned int, int) */</font></div><div><font size="2"   >#if defined STAP_SDT_V1</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_SMGR_MD_READ_START_ENABLED() __builtin_expect (smgr__md__read__start_semaphore, 0)</font></div><div><font size="2"   >#define postgresql_smgr__md__read__start_semaphore smgr__md__read__start_semaphore</font></div><div><font size="2"   >#else</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_SMGR_MD_READ_START_ENABLED() __builtin_expect (postgresql_smgr__md__read__start_semaphore, 0)</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   >__extension__ extern unsigned short postgresql_smgr__md__read__start_semaphore __attribute__ ((unused)) __attribute__ ((section (".probes")));</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_SMGR_MD_READ_START(arg1,arg2,arg3,arg4,arg5,arg6) \</font></div><div><font size="2"   >DTRACE_PROBE6(postgresql,smgr__md__read__start,arg1,arg2,arg3,arg4,arg5,arg6)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >/* TRACE_POSTGRESQL_SMGR_MD_READ_DONE ( int, unsigned int, unsigned int, unsigned int, unsigned int, int, int, int) */</font></div><div><font size="2"   >#if defined STAP_SDT_V1</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_SMGR_MD_READ_DONE_ENABLED() __builtin_expect (smgr__md__read__done_semaphore, 0)</font></div><div><font size="2"   >#define postgresql_smgr__md__read__done_semaphore smgr__md__read__done_semaphore</font></div><div><font size="2"   >#else</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_SMGR_MD_READ_DONE_ENABLED() __builtin_expect (postgresql_smgr__md__read__done_semaphore, 0)</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   >__extension__ extern unsigned short postgresql_smgr__md__read__done_semaphore __attribute__ ((unused)) __attribute__ ((section (".probes")));</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_SMGR_MD_READ_DONE(arg1,arg2,arg3,arg4,arg5,arg6,arg7,arg8) \</font></div><div><font size="2"   >DTRACE_PROBE8(postgresql,smgr__md__read__done,arg1,arg2,arg3,arg4,arg5,arg6,arg7,arg8)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >/* TRACE_POSTGRESQL_SMGR_MD_WRITE_START ( int, unsigned int, unsigned int, unsigned int, unsigned int, int) */</font></div><div><font size="2"   >#if defined STAP_SDT_V1</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_SMGR_MD_WRITE_START_ENABLED() __builtin_expect (smgr__md__write__start_semaphore, 0)</font></div><div><font size="2"   >#define postgresql_smgr__md__write__start_semaphore smgr__md__write__start_semaphore</font></div><div><font size="2"   >#else</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_SMGR_MD_WRITE_START_ENABLED() __builtin_expect (postgresql_smgr__md__write__start_semaphore, 0)</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   >__extension__ extern unsigned short postgresql_smgr__md__write__start_semaphore __attribute__ ((unused)) __attribute__ ((section (".probes")));</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_SMGR_MD_WRITE_START(arg1,arg2,arg3,arg4,arg5,arg6) \</font></div><div><font size="2"   >DTRACE_PROBE6(postgresql,smgr__md__write__start,arg1,arg2,arg3,arg4,arg5,arg6)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >/* TRACE_POSTGRESQL_SMGR_MD_WRITE_DONE ( int, unsigned int, unsigned int, unsigned int, unsigned int, int, int, int) */</font></div><div><font size="2"   >#if defined STAP_SDT_V1</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_SMGR_MD_WRITE_DONE_ENABLED() __builtin_expect (smgr__md__write__done_semaphore, 0)</font></div><div><font size="2"   >#define postgresql_smgr__md__write__done_semaphore smgr__md__write__done_semaphore</font></div><div><font size="2"   >#else</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_SMGR_MD_WRITE_DONE_ENABLED() __builtin_expect (postgresql_smgr__md__write__done_semaphore, 0)</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   >__extension__ extern unsigned short postgresql_smgr__md__write__done_semaphore __attribute__ ((unused)) __attribute__ ((section (".probes")));</font></div><div><font size="2"   >#define TRACE_POSTGRESQL_SMGR_MD_WRITE_DONE(arg1,arg2,arg3,arg4,arg5,arg6,arg7,arg8) \</font></div><div><font size="2"   >DTRACE_PROBE8(postgresql,smgr__md__write__done,arg1,arg2,arg3,arg4,arg5,arg6,arg7,arg8)</font></div></div><p></p></pre></div><div><br></div><div>探针在源码中的信息 :&nbsp;</div><div>src/backend/storage/smgr/md.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;mdread() -- Read the specified block from a relation.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >void</font></div><div><font size="2"   >mdread(SMgrRelation reln, ForkNumber forknum, BlockNumber blocknum,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;char *buffer)</font></div><div><font size="2"   >{</font></div></div><div><font size="2"   >...</font></div><div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TRACE_POSTGRESQL_SMGR_MD_READ_START(forknum, blocknum,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reln-&gt;smgr_rnode.node.spcNode,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reln-&gt;smgr_rnode.node.dbNode,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reln-&gt;smgr_rnode.node.relNode,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reln-&gt;smgr_rnode.backend);</font></div></div><div><font size="2"   >...</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; nbytes = FileRead(v-&gt;mdfd_vfd, buffer, BLCKSZ);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TRACE_POSTGRESQL_SMGR_MD_READ_DONE(forknum, blocknum,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;reln-&gt;smgr_rnode.node.spcNode,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;reln-&gt;smgr_rnode.node.dbNode,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;reln-&gt;smgr_rnode.node.relNode,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;reln-&gt;smgr_rnode.backend,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nbytes,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;BLCKSZ);</font></div></div><div><font size="2"   >...</font></div><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;mdwrite() -- Write the supplied block at the appropriate location.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;This is to be used only for updating already-existing blocks of a</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;relation (ie, those before the current EOF). &nbsp;To extend a relation,</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;use mdextend().</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >void</font></div><div><font size="2"   >mdwrite(SMgrRelation reln, ForkNumber forknum, BlockNumber blocknum,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; char *buffer, bool skipFsync)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; off_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; seekpos;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nbytes;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; MdfdVec &nbsp; &nbsp;*v;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* This assert is too expensive to have on normally ... */</font></div><div><font size="2"   >#ifdef CHECK_WRITE_VS_EXTEND</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Assert(blocknum &lt; mdnblocks(reln, forknum));</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TRACE_POSTGRESQL_SMGR_MD_WRITE_START(forknum, blocknum,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;reln-&gt;smgr_rnode.node.spcNode,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;reln-&gt;smgr_rnode.node.dbNode,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;reln-&gt;smgr_rnode.node.relNode,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;reln-&gt;smgr_rnode.backend);</font></div></div><div><font size="2"   >...</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; nbytes = FileWrite(v-&gt;mdfd_vfd, buffer, BLCKSZ);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TRACE_POSTGRESQL_SMGR_MD_WRITE_DONE(forknum, blocknum,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reln-&gt;smgr_rnode.node.spcNode,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reln-&gt;smgr_rnode.node.dbNode,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reln-&gt;smgr_rnode.node.relNode,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reln-&gt;smgr_rnode.backend,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nbytes,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BLCKSZ);</font></div></div><p></p></pre></div><div>使用举例 :&nbsp;</div><div>1. &nbsp;输出读和写relation的信息, 每个数据块1条记录.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 postgresql-9.3.1]stap -e '</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__read__done") {</font></div><div><font size="2"   >&nbsp; printdln("***", pn(), $arg1, $arg2, $arg3, $arg4, $arg5, $arg6, $arg7, $arg8)</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done") {</font></div><div><font size="2"   >&nbsp; printdln("***", pn(), $arg1, $arg2, $arg3, $arg4, $arg5, $arg6, $arg7, $arg8)</font></div><div><font size="2"   >}<span style="line-height: 28px;"   >'</span></font></div><p></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >SQL对应的输出如下 :&nbsp;</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain (analyze,verbose,costs,buffers,timing) select count(*) from test ;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Aggregate &nbsp;(cost=106075.99..106076.00 rows=1 width=0) (actual time=1561.052..1561.053 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: count(*)</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=47319</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on public.test &nbsp;(cost=0.00..94324.59 rows=4700559 width=0) (actual time=0.011..883.486 rows=4676559 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buffers: shared hit=47319</font></div><div><font size="2"   >&nbsp;Total runtime: 1561.094 ms</font></div><div><font size="2"   >(7 rows)</font></div><div><span style="font-family: Arial, Helvetica, sans-serif; line-height: 28px; white-space: normal;"   ><font size="2"   >shared buffer命中, 本例stap无输出</font></span></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table t1(id int, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><span style="font-family: Arial, Helvetica, sans-serif; line-height: 28px; white-space: normal;"   ><font size="2"   >无输出</font></span></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into t1 select generate_series(1,100000),md5(random()::text);</font></div><div><font size="2"   >INSERT 0 100000</font></div><div><font size="2"   >输出:</font></div><div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__read__done")***1***2***1663***16384***24726***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__read__done")***1***0***1663***16384***24726***-1***8192***8192</font></div></div><p></p></pre></div><div><br></div><div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >digoal=# explain (analyze,verbose,costs,buffers,timing) select count(*) from t1 ;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >----------------------------------------------------------------------------------------------------------------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;Aggregate &nbsp;(cost=21.50..21.51 rows=1 width=0) (actual time=0.316..0.316 rows=1 loops=1)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Output: count(*)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=9</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on public.t1 &nbsp;(cost=0.00..19.00 rows=1000 width=0) (actual time=0.010..0.164 rows=1000 loops=1)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: id, info</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buffers: shared hit=9</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;Total runtime: 0.353 ms</font></div><div style="line-height: 28px;"   ><font size="2"   >(7 rows)</font></div></div></div><div style="line-height: 28px;"   ><font size="2"   ><span style="line-height: 28px;"   >shared buffer命中, 本例stap</span>无输出</font></div><p></p></pre></div></div></div></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >输出, checkpoint涉及一些系统表的写.</font></div><div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***0***1663***16384***12658***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***2***1663***16384***12658***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***5***1663***16384***12658***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***7***1663***16384***12658***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***1***1663***16384***12660***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***1***1663***16384***12685***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***2***1663***16384***12682***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***1***1663***16384***12637***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***1***1663***16384***12638***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***2***1663***16384***12661***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***10***1663***16384***12650***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***43***1663***16384***12647***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***2***1663***16384***12638***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***1***1663***16384***12684***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***2***1663***16384***12634***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***18***1663***16384***12629***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***1***1663***16384***12633***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***1***2***1663***16384***12631***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***6***1663***16384***12631***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***19***1663***16384***12629***-1***8192***8192</font></div><div><font size="2"   ><u>process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***8***1663***16384***24726***-1***8192***8192</u></font></div><div><font size="2"   ><u>process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***7***1663***16384***24726***-1***8192***8192</u></font></div><div><font size="2"   ><u>process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***6***1663***16384***24726***-1***8192***8192</u></font></div><div><font size="2"   ><u>process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***5***1663***16384***24726***-1***8192***8192</u></font></div><div><font size="2"   ><u>process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***4***1663***16384***24726***-1***8192***8192</u></font></div><div><font size="2"   ><u>process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***3***1663***16384***24726***-1***8192***8192</u></font></div><div><font size="2"   ><u>process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***2***1663***16384***24726***-1***8192***8192</u></font></div><div><font size="2"   ><u>process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***1***1663***16384***24726***-1***8192***8192</u></font></div><div><font size="2"   ><u>process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***0***1663***16384***24726***-1***8192***8192</u></font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***16***1663***16384***12649***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***7***1663***16384***12631***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***7***1663***16384***12635***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***27***1663***16384***12767***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***46***1663***16384***12764***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***20***1663***16384***12766***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***5***1663***16384***12767***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***3***1663***16384***12649***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***15***1663***16384***12649***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***21***1663***16384***12767***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***23***1663***16384***12766***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***44***1663***16384***12647***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***11***1663***16384***12631***-1***8192***8192</font></div><div><font size="2"   >process("/home/pg93/pgsql9.3.1/bin/postgres").mark("smgr__md__write__done")***0***0***1663***16384***12669***-1***8192***8192</font></div></div><p></p></pre></div></div><div>相关系统表列举 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select oid,relname from pg_class where relfilenode in (12658,12660,12682,12685,12637,12638,12661,12650,12631);</font></div><div><font size="2"   >&nbsp;oid &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------+---------------------------</font></div><div><font size="2"   >&nbsp;2840 | pg_toast_2619</font></div><div><font size="2"   >&nbsp;2679 | pg_index_indexrelid_index</font></div><div><font size="2"   >&nbsp;2610 | pg_index</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div><div>当然也涉及了t1表的9个数据块的flush, 在stap输出中下划线标出.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select relfilenode from pg_class where relname='t1';</font></div><div><font size="2"   >&nbsp;relfilenode&nbsp;</font></div><div><font size="2"   >-------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;24726</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/dynamic-trace.html"   >http://www.postgresql.org/docs/9.3/static/dynamic-trace.html</a></div><div>2.&nbsp;src/backend/storage/smgr/md.c</div><div>3.&nbsp;<a style="line-height: 28px;" href="http://blog.163.com/digoal@126/blog/static/1638770402013916488761/"   >http://blog.163.com/digoal@126/blog/static/1638770402013916488761/</a></div></div>
	</div>
</div>
</body>
</html>