<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap Preprocessor macros</h2>
	<h5 id="">2013-10-08 17:32:37&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020139851437162/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>上一篇讲了预处理阶段的条件预编译, 本文要讲的也是stap预处理阶段的事务: 宏定义.</div><div>宏定义在stap中算是个实验特性, 前面我们提到的规则表达式匹配操作也是实验特性.</div><div>另外要注意宏定义的顺序, 它在条件预编译前完成. 所以如果宏定义出错的话不会进行后面的条件预编译解析.</div><div>宏定义类似C里面的宏定义#define.</div><div>语法如下, 可以定义参数, 也可以不定义参数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >@define NAME %( BODY %)</font></div><div><font size="2"   >@define NAME(PARAM_1, PARAM_2, ...) %( BODY %)</font></div><p></p></pre></div><div>如果定义了参数, 那么在BODY中引用参数时在变量名前加@, 例如</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >@define foo %( x %)</font></div><div><font size="2"   >@define add(a,b) %( ((@a)+(@b)) %)</font></div><div><font size="2"   >&nbsp; &nbsp;@foo = @add(2,2)</font></div><p></p></pre></div><div>宏的使用也要在NAME前面加@</div><div><br></div><div>前面提到的<span style="line-height: 23px;"   >宏定义的顺序, 它在条件预编译前完成. 所以如果宏定义出错的话不会进行后面的条件预编译解析.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Macro expansion is currently performed in a separate pass before conditional compilation. Therefore, both TRUE- and FALSE-tokens in conditional expressions will be macroexpanded regardless of how the condition is evaluated. This can sometimes lead to errors:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >// The following results in a conflict:</font></div><div><font size="2"   >%( CONFIG_UTRACE == "y" %?</font></div><div><font size="2"   >&nbsp; &nbsp; @define foo %( process.syscall %)</font></div><div><font size="2"   >%:</font></div><div><font size="2"   >&nbsp; &nbsp; @define foo %( **ERROR** %)</font></div><div><font size="2"   >%)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >// The following works properly as expected:</font></div><div><font size="2"   >@define foo %(</font></div><div><font size="2"   >&nbsp; %( CONFIG_UTRACE == "y" %? process.syscall %: **ERROR** %)</font></div><div><font size="2"   >%)</font></div><div><font size="2"   >The first example is incorrect because both @defines are evaluated in a pass prior to the conditional being evaluated.</font></div><p></p></pre></div><div>使用举例 :&nbsp;</div><div>在1.8的stap中未测试成功.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -e '@define add(x, y) %( ((@x)+(@y)) %) probe begin {printf("%d\n", @add($1,$2)); exit();}' 2 3</font></div><div><font size="2"   >parse error: expected 'probe', 'global', 'function', or '%{'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; saw: identifier '@define' at &lt;input&gt;:1:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;source: @define add(x, y) %( ((@x)+(@y)) %) probe begin {printf("%d\n", @add($1,$2)); exit();}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >parse error: expected 'arch' or 'kernel_v' or 'kernel_vr' or 'CONFIG_...'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;or comparison between strings or integers</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at: operator '(' at &lt;input&gt;:1:22</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;source: @define add(x, y) %( ((@x)+(@y)) %) probe begin {printf("%d\n", @add($1,$2)); exit();}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   >parse error: incomplete conditional - missing '%('</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; at: operator '%)' at &lt;input&gt;:1:34</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;source: @define add(x, y) %( ((@x)+(@y)) %) probe begin {printf("%d\n", @add($1,$2)); exit();}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   >parse error: unknown operator @add</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; saw: identifier '@add' at &lt;input&gt;:1:65</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;source: @define add(x, y) %( ((@x)+(@y)) %) probe begin {printf("%d\n", @add($1,$2)); exit();}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >4 parse errors.</font></div><div><font size="2"   >Pass 1: parse failed. &nbsp;Try again with another '--vp 1' option.</font></div><p></p></pre></div><div><span style="line-height: 23px;"   >使用stap2.4正常 :&nbsp;</span></div><div><span style="line-height: 23px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# /opt/systemtap/bin/stap -e '@define add(x, y) %( ((@x)+(@y)) %) probe begin {printf("%d\n", @add($1,$2)); exit();}' 2 3</font></div><div><font size="2"   >5</font></div><p></p></pre></div><div>参考 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201391391613269/"   >http://blog.163.com/digoal@126/blog/static/163877040201391391613269/</a></div></span></div><div><span style="line-height: 23px;"   ><br></span></div><div><span style="line-height: 23px;"   >上面提到的宏是在stap脚本中使用的,&nbsp;</span>下面提到的是宏库. 前面我们提到过stap库在一堆.stp文件中.&nbsp;</div><div>自定义的stp文件可以使用stap的-I参数加入到检索路径中.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >man stap</font></div><div><font size="2"   >-I DIR Add the given directory to the tapset search directory. &nbsp;See the description of pass 2 for details.</font></div><p></p></pre></div><div>默认的stp库目录</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/usr/share/systemtap/tapset</font></div><div></div><p></p></pre></div><div>宏定义文件则以.stpm结尾. 同样可以使用-I加入到检索路径.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Library macros</font></div><div><div><font size="2"   >Normally, a macro definition is local to the file it occurs in.&nbsp;</font></div><div><font size="2"   >Thus, defining a macro in a tapset does not make it available to the user of the tapset.</font></div><div><font size="2"   >Publically available library macros can be defined by including .stpm files on the tapset search path.&nbsp;</font></div><div><font size="2"   >These files may only contain @define constructs, which become visible across all tapsets and user scripts.</font></div></div><p></p></pre></div><div>举例 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cd /tmp</font></div><div><font size="2"   >[root@db-172-16-3-39 tmp]# vi test.stpm</font></div><div><font size="2"   >@define add(x, y) %( ((@x)+(@y)) %)</font></div><p></p></pre></div><div>同样测试失败 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -I /tmp -e 'probe begin {printf("%d\n", @add($1,$2)); exit();}' 2 3</font></div><div><font size="2"   >parse error: unknown operator @add</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; saw: identifier '@add' at &lt;input&gt;:1:29</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;source: probe begin {printf("%d\n", @add($1,$2)); exit();}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >1 parse error.</font></div><div><font size="2"   >Pass 1: parse failed. &nbsp;Try again with another '--vp 1' option.</font></div><p></p></pre></div><div>使用systemtap 2.4测试正常 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 tmp]# /opt/systemtap/bin/stap -I /tmp -e 'probe begin {printf("%d\n", @add($1,$2)); exit();}' 2 3</font></div><div><font size="2"   >5</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 23px;" href="http://blog.163.com/digoal@126/blog/static/16387704020139831157191/"   >http://blog.163.com/digoal@126/blog/static/16387704020139831157191/</a></div><div>2.&nbsp;<a style="line-height: 23px;" target="_blank" rel="nofollow" href="https://sourceware.org/systemtap/langref/Language_elements.html"   >https://sourceware.org/systemtap/langref/Language_elements.html</a></div><div>3.&nbsp;<a style="line-height: 28px;" href="http://blog.163.com/digoal@126/blog/static/163877040201391391613269/"   >http://blog.163.com/digoal@126/blog/static/163877040201391391613269/</a></div></div>
	</div>
</div>
</body>
</html>