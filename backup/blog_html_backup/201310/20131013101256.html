<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap(2.4) fixed BUG(1.8) : delete from statistics(aggregates) type stored in array elements</h2>
	<h5 id="">2013-10-13 10:12:56&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201391391613269/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>上一篇BLOG中在测试使用delete删除数组元素中存储的统计信息时出现未删除的BUG.</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201391234023230/"   >http://blog.163.com/digoal@126/blog/static/163877040201391234023230/</a></div><div>本文从git上下载最新的2.4版本进行同样场景的测试, 发现这个bug已经不存在了. (建议使用CentOS 6.x以上版本测试, 否则可能因为elfutils版本太低无法安装stap 2.4)</div><div>测试过程如下 :&nbsp;</div><div>环境准备 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >yum install -y systemtap-devel systemtap-client systemtap-runtime systemtap-sdt-devel systemtap</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >其中systemtap-sdt-devel 是PostgreSQL --enable-dtrace需要的包.</span></div></div><div><br></div><div>安装git, CentOS 6.x 可以直接从yum源中下载.</div><div>或者从google code中下载.</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201242512825860/"   >http://blog.163.com/digoal@126/blog/static/163877040201242512825860/</a></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >从sourceware 站点下载和安装stap :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >git clone git://sourceware.org/git/systemtap.git</font></div><div><font size="2"   >cd systemtap/</font></div></div><div><div><font size="2"   >./configure --prefix=/opt/systemtap &amp;&amp; gmake all &amp;&amp; gmake install</font></div><div><span style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 ~]# /opt/systemtap/bin/stap -V</font></span></div></div><div><font size="2"   >Systemtap translator/driver (version 2.4/0.152, commit release-2.3-133-g335e342 + changes)</font></div><div><font size="2"   >Copyright (C) 2005-2013 Red Hat, Inc. and others</font></div><div><font size="2"   >This is free software; see the source for copying conditions.</font></div><div><font size="2"   >enabled features: LIBSQLITE3 BOOST_SHARED_PTR TR1_UNORDERED_MAP NLS JAVA</font></div><p></p></pre></div><div><br></div><div>测试 :&nbsp;</div><div>脚本如下, 与1.8版本相同 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# cat test.stp</font></div><div><font size="2"   >global var1[50000], var2[50000], var3[50000]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__start") {</font></div><div><font size="2"   >&nbsp; pid=pid()</font></div><div><font size="2"   >&nbsp; delete var1[pid]</font></div><div><font size="2"   >&nbsp; delete var2[pid]</font></div><div><font size="2"   >&nbsp; delete var3[pid]</font></div><div><font size="2"   >&nbsp; var3[pid] = user_string($arg1)</font></div><div><font size="2"   >&nbsp; printf("pid:%u, query start: %s, read: %u,%u, write: %u,%u\n", pid, var3[pid], @sum(var1[pid]), @count(var1[pid]), @sum(var2[pid]), @count(var2[pid]))</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__done") {</font></div><div><font size="2"   >&nbsp; pid=pid()</font></div><div><font size="2"   >&nbsp; printf("pid:%u, query done: %s, read: %u,%u, write: %u,%u\n", pid, var3[pid], @sum(var1[pid]), @count(var1[pid]), @sum(var2[pid]), @count(var2[pid]))</font></div><div><font size="2"   >&nbsp; delete var1[pid]</font></div><div><font size="2"   >&nbsp; delete var2[pid]</font></div><div><font size="2"   >&nbsp; delete var3[pid]</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe syscall.read.return {</font></div><div><font size="2"   >&nbsp; if (execname()=="postgres") {</font></div><div><font size="2"   >&nbsp; &nbsp; pid=pid()</font></div><div><font size="2"   >&nbsp; &nbsp; var1[pid] &lt;&lt;&lt; $count</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe syscall.write.return {</font></div><div><font size="2"   >&nbsp; if (execname()=="postgres") {</font></div><div><font size="2"   >&nbsp; &nbsp; pid=pid()</font></div><div><font size="2"   >&nbsp; &nbsp; var2[pid] &lt;&lt;&lt; $count</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe end {</font></div><div><font size="2"   >&nbsp; delete var1</font></div><div><font size="2"   >&nbsp; delete var2</font></div><div><font size="2"   >&nbsp; delete var3</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>执行stap脚本, 测试场景与1.8版本相同.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# /opt/systemtap/bin/stap -D MAXSKIPPED=1 test.stp&nbsp;</font></div><div></div><p></p></pre></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# su - pg93</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.3.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# drop table t;</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >digoal=# create table t(id int, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into t select generate_series(1,1000000),md5(random()::text),now();</font></div><div><font size="2"   >INSERT 0 1000000</font></div><div><font size="2"   >digoal=# select count(*) from t;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1000000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select count(*) from t;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1000000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# create index idx_t_1 on t(id);</font></div><div><font size="2"   >CREATE INDEX</font></div><div><font size="2"   >digoal=# select count(*) from t;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1000000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select count(*) from t;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1000000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select count(*) from t;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1000000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >stap输出结果如下, delete var1[pid]和delete var2[pid]已经可以正常清楚statistic类型的数据了.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pid:17397, query start: drop table t;, read: 0,0, write: 0,0</font></div><div><font size="2"   >pid:17397, query done: drop table t;, read: 0,0, write: 65536,1</font></div><div><font size="2"   >pid:17397, query start: create table t(id int, info text, crt_time timestamp);, read: 0,0, write: 0,0</font></div><div><font size="2"   >pid:17397, query done: create table t(id int, info text, crt_time timestamp);, read: 8192,1, write: 16384,2</font></div><div><font size="2"   >pid:17397, query start: insert into t select generate_series(1,1000000),md5(random()::text),now();, read: 0,0, write: 0,0</font></div><div><font size="2"   >pid:17397, query done: insert into t select generate_series(1,1000000),md5(random()::text),now();, read: 32768,4, write: 76603392,9351</font></div><div><font size="2"   >pid:17397, query start: select count(*) from t;, read: 0,0, write: 0,0</font></div><div><font size="2"   >pid:17397, query done: select count(*) from t;, read: 0,0, write: 0,0</font></div><div><font size="2"   >pid:17397, query start: select count(*) from t;, read: 0,0, write: 0,0</font></div><div><font size="2"   >pid:17397, query done: select count(*) from t;, read: 0,0, write: 0,0</font></div><div><font size="2"   >pid:17397, query start: create index idx_t_1 on t(id);, read: 0,0, write: 0,0</font></div><div><font size="2"   >pid:17397, query done: create index idx_t_1 on t(id);, read: 0,0, write: 24158208,2853</font></div><div><font size="2"   >pid:17397, query start: select count(*) from t;, read: 0,0, write: 0,0</font></div><div><font size="2"   >pid:17397, query done: select count(*) from t;, read: 8192,1, write: 0,0</font></div><div><font size="2"   >pid:17397, query start: select count(*) from t;, read: 0,0, write: 0,0</font></div><div><font size="2"   >pid:17397, query done: select count(*) from t;, read: 0,0, write: 0,0</font></div><div><font size="2"   >pid:17397, query start: select count(*) from t;, read: 0,0, write: 0,0</font></div><div><font size="2"   >pid:17397, query done: select count(*) from t;, read: 0,0, write: 0,0</font></div><div><font size="2"   >pid:17397, query start: checkpoint;, read: 0,0, write: 0,0</font></div><div><font size="2"   >pid:17397, query done: checkpoint;, read: 0,0, write: 0,0</font></div><div><font size="2"   >pid:17397, query start: checkpoint;, read: 0,0, write: 0,0</font></div><div><font size="2"   >pid:17397, query done: checkpoint;, read: 0,0, write: 0,0</font></div><p></p></pre></div></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" href="http://blog.163.com/digoal@126/blog/static/163877040201391234023230/"   >http://blog.163.com/digoal@126/blog/static/163877040201391234023230/</a></div><div>2.&nbsp;<a style="line-height: 28px;" href="http://blog.163.com/digoal@126/blog/static/16387704020137140265557/"   >http://blog.163.com/digoal@126/blog/static/16387704020137140265557/</a></div><div>3.&nbsp;<a style="line-height: 28px;" href="http://blog.163.com/digoal@126/blog/static/163877040201242512825860/"   >http://blog.163.com/digoal@126/blog/static/163877040201242512825860/</a></div><wbr></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">yanqing_1226 - 2013-11-20 13:21:54</h5>
				<div>LZ您好。请教一个问题。<div><div>我使用systemtap2.4-elfutils-0.157。</div></div><div>在执行/systemtap-2.4/doc/tutorial下的例子inode-watch.stp时。一直报错，这个例子是输出vfs_read函数中参数struct file *file中结构体成员。报错说不能resolving file这个结构体。我在1.6的systemtap下运行是可以的。是2.4不能直接使用$file-&gt;f_path这样的吗？</div><div>我的OS是ubuntu 13.10，自己编译的内核3.12.。先谢谢。急等您的回复。</div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 yanqing_1226 - 2013-11-20 13:21:54</h5>
				<div style="width:600px;">会不会是没有3.12的debuginfo.</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">yanqing_1226 回复 德哥@Digoal - 2013-11-20 13:21:54</h5>
				<div style="width:600px;">这个有的。我自己编译的内核。<span style=""  >&nbsp;这些配置选项CONFIG_DEBUG_INFO, CONFIG_KPROBES, CONFIG_RELAY, CONFIG_DEBUG_FS, CONFIG_MODULES, CONFIG_MODULE_UNLOAD都选了的。可以查看sys_open等系统调用函数。</span></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 yanqing_1226 - 2013-11-20 13:21:54</h5>
				<div style="width:600px;">用&amp; $file-f_path</div>
			</div>
			<div id="">
				<h5 id="">yanqing_1226 - 2013-11-20 13:23:15</h5>
				<div>同时，类似<div><span style=""  >stap -e 'probe kernel.function("icmp_echo") {printf("%s\n", $$parms$$); exit();}'</span></div><div><span style=""  >这样的脚本，展开输出parms中结构体成员，会被skip过去。</span></div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 yanqing_1226 - 2013-11-20 13:23:15</h5>
				<div style="width:600px;">HI, 展开返回字符串过长会截断到MAXSTRINGLEN</div>
			</div>
	</div>
</div>
</body>
</html>