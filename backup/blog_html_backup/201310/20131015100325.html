<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap: Generating Instrumentation module(.ko) for Other Computers</h2>
	<h5 id="">2013-10-15 10:03:25&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201391451459751/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在生产环境中, 如果服务器比较多, 同时都需要运行一样的stap脚本的话, 有几个弊端,&nbsp;</div><div>1. 每台机器都需要相应的内核开发包, debug包等.&nbsp;</div><div>2. 每次运行stap 脚本时都需要经历5步骤, 消耗资源.&nbsp;</div><div>(<a style="line-height: 28px;" href="http://blog.163.com/digoal@126/blog/static/163877040201391434530674/"   >http://blog.163.com/digoal@126/blog/static/163877040201391434530674/</a><span style="line-height: 28px;"   >)</span></div><div>有没有办法只在1台机器上产生内核模块, 在其他机器上直接加载这个模块呢?</div><div>systemtap提供了这样的便捷. 但是需要符合一定的要求 :&nbsp;</div><div>1. 产生内核模块的机器必须包含所有stap所需的包.</div><div>参考 :&nbsp;</div><div><a rel="nofollow" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/using-systemtap.html#install-kinfo"   >https://sourceware.org/systemtap/SystemTap_Beginners_Guide/using-systemtap.html#install-kinfo</a></div><div>例如主机器的操作系统为CentOS 5.x</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 ~]# uname -r</font></div><div><font size="2"   >2.6.18-348.12.1.el5</font></div></div><div><div><font size="2"   >[root@db-172-16-3-39 ~]# rpm -qa|grep kernel</font></div><div><font size="2"   >kernel-2.6.18-348.12.1.el5</font></div><div><font size="2"   >kernel-debuginfo-common-2.6.18-348.12.1.el5</font></div><div><font size="2"   >kernel-devel-2.6.18-348.12.1.el5</font></div><div><font size="2"   >kernel-debuginfo-2.6.18-348.12.1.el5</font></div></div><div><div style="line-height: 28px;"   ><font size="2"   >kernel-doc-2.6.18-348.12.1.el5</font></div><div style="line-height: 28px;"   ><font size="2"   >kernel-headers-2.6.18-348.12.1.el5</font></div></div><div><div><font size="2"   >[root@db-172-16-3-39 ~]# rpm -qa|grep systemtap</font></div><div><font size="2"   >systemtap-sdt-devel-1.8-6.el5</font></div><div><font size="2"   >systemtap-devel-1.8-6.el5</font></div><div><font size="2"   >systemtap-1.8-6.el5</font></div><div><font size="2"   >systemtap-client-1.8-6.el5</font></div><div><font size="2"   >systemtap-runtime-1.8-6.el5</font></div><div><font size="2"   >systemtap-sdt-devel-1.8-6.el5</font></div></div><p></p></pre></div><div><br></div><div>2. 产生内核模块的机器和运行内核模块的其他机器必须架构相同, 例如都是x86_64架构的.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 ~]# uname -m</font></div><div><font size="2"   >x86_64</font></div></div><div><div><font size="2"   >[root@db-172-16-3-33 ~]# uname -m</font></div><div><font size="2"   >x86_64</font></div></div><p></p></pre></div><div><br></div><div>3. 产生<span style="line-height: 28px;"   >内核模块的机器还需要包含目标机内核同版本的相关kernel-devel, kernel-debuginfo, kernel-debuginfo-common包.</span></div><div>主机器正在运行的内核版本最好和目标机正在运行的内核版本一致, 那么就不需要安装与运行版本不一致的debuginfo了.</div><div>本例<span style="line-height: 28px;"   >主机器和目标机运行的内核版本一致, 所以</span><span style="line-height: 28px;"   >不需要额外安装其他版本的</span><span style="line-height: 28px;"   >kernel-devel, kernel-debuginfo, kernel-debuginfo-common</span><span style="line-height: 28px;"   >.</span></div><div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >4. 目标机上要正常运行模块, 必须有systemtap-runtime包.</span></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 ~]# rpm -qa|grep systemtap</font></div><div><font size="2"   >systemtap-runtime-1.8-6.el5</font></div><p></p></pre></div><div>但是不需要<span style="line-height: 28px;"   >kernel-devel, kernel-debuginfo, kernel-debuginfo-common包</span></div><div><span style="line-height: 28px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 ~]# rpm -qa|grep kernel</font></div><div><font size="2"   >kernel-2.6.18-348.12.1.el5</font></div><div><font size="2"   >kernel-headers-2.6.18-348.12.1.el5</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >接下来在主机上写一个stp脚本.</span></div></span></div></span></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cat io.stp&nbsp;</font></div><div><font size="2"   >global var1%[60000], var2%[60000]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe syscall.read {</font></div><div><font size="2"   >&nbsp; var1[pid(),execname()] &lt;&lt;&lt; $count</font></div><div><font size="2"   >&nbsp; var2[pid(),execname()] &lt;&lt;&lt; $count</font></div><div><font size="2"   >}&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe timer.s($1) {</font></div><div><font size="2"   >&nbsp; print("**********\n")</font></div><div><font size="2"   >&nbsp; foreach([x,y] in var1- limit 5)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; printdln("---", x, y, @count(var1[x,y]), @sum(var1[x,y]))</font></div><div><font size="2"   >&nbsp; delete var1</font></div><div><font size="2"   >}&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe timer.s($2) {</font></div><div><font size="2"   >&nbsp; print("END:**********\n")</font></div><div><font size="2"   >&nbsp; foreach([x,y] in var2- limit 5)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; printdln("---", x, y, @count(var2[x,y]), @sum(var2[x,y]))</font></div><div><font size="2"   >&nbsp; delete var1</font></div><div><font size="2"   >&nbsp; delete var2&nbsp;</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>测试这个脚本是否使用正常</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap io.stp 1 5</font></div><div><font size="2"   >**********</font></div><div><font size="2"   >3377---pcscd---27---444</font></div><div><font size="2"   >24917---stapio---7---671752</font></div><div><font size="2"   >19947---stapio---5---655360</font></div><div><font size="2"   >3391---hald---4---8192</font></div><div><font size="2"   >8969---postgres---4---64</font></div><div><font size="2"   >**********</font></div><div><font size="2"   >3377---pcscd---27---444</font></div><div><font size="2"   >24917---stapio---6---786432</font></div><div><font size="2"   >19947---stapio---5---655360</font></div><div><font size="2"   >8969---postgres---4---64</font></div><div><font size="2"   >8968---postgres---4---64</font></div><div><font size="2"   >**********</font></div><div><font size="2"   >3377---pcscd---27---444</font></div><div><font size="2"   >24917---stapio---6---786432</font></div><div><font size="2"   >19947---stapio---5---655360</font></div><div><font size="2"   >3391---hald---4---8192</font></div><div><font size="2"   >8969---postgres---4---64</font></div><div><font size="2"   >**********</font></div><div><font size="2"   >3377---pcscd---27---444</font></div><div><font size="2"   >24917---stapio---6---786432</font></div><div><font size="2"   >19947---stapio---5---655360</font></div><div><font size="2"   >8969---postgres---4---64</font></div><div><font size="2"   >8968---postgres---4---64</font></div><div><font size="2"   >**********</font></div><div><font size="2"   >3377---pcscd---27---444</font></div><div><font size="2"   >3173---irqbalance---6---6144</font></div><div><font size="2"   >24917---stapio---6---786432</font></div><div><font size="2"   >19947---stapio---5---655360</font></div><div><font size="2"   >3391---hald---4---8192</font></div><div><font size="2"   >END:**********</font></div><div><font size="2"   >3377---pcscd---135---2220</font></div><div><font size="2"   >24917---stapio---31---3817480</font></div><div><font size="2"   >19947---stapio---25---3276800</font></div><div><font size="2"   >8969---postgres---20---320</font></div><div><font size="2"   >8968---postgres---20---320</font></div><div><font size="2"   >WARNING: Number of errors: 0, skipped probes: 1</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >运行正常, 产生模块, &nbsp;:&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -p 4 -r 2.6.18-348.12.1.el5 -m ioread_top5 io.stp 1 10</font></div><div><font size="2"   >ioread_top5.ko</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# ll ioread_top5.ko&nbsp;</font></div><div><font size="2"   >-rw-r--r-- 1 root root 107960 Oct 15 09:42 ioread_top5.ko</font></div><p></p></pre></div><div>将ioread_top5.ko拷贝到目标机运行.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 ~]# staprun ioread_top5.ko&nbsp;</font></div><div><font size="2"   >**********</font></div><div><font size="2"   >3431---pcscd---24---378</font></div><div><font size="2"   >19556---stapio---7---671752</font></div><div><font size="2"   >**********</font></div><div><font size="2"   >3431---pcscd---24---378</font></div><div><font size="2"   >19556---stapio---6---786432</font></div><div><font size="2"   >4068---sshd---1---16384</font></div><div><font size="2"   >**********</font></div><div><font size="2"   >3431---pcscd---24---378</font></div><div><font size="2"   >19556---stapio---6---786432</font></div><div><font size="2"   >3762---sendmail---1---1024</font></div><div><font size="2"   >4068---sshd---1---16384</font></div><div><font size="2"   >**********</font></div><div><font size="2"   >3431---pcscd---24---378</font></div><div><font size="2"   >19556---stapio---6---786432</font></div><div><font size="2"   >4068---sshd---1---16384</font></div><div><font size="2"   >**********</font></div><div><font size="2"   >3431---pcscd---24---378</font></div><div><font size="2"   >19556---stapio---6---786432</font></div><div><font size="2"   >3229---irqbalance---5---5120</font></div><div><font size="2"   >4068---sshd---1---16384</font></div><div><font size="2"   >**********</font></div><div><font size="2"   >3431---pcscd---24---378</font></div><div><font size="2"   >19556---stapio---6---786432</font></div><div><font size="2"   >4068---sshd---1---16384</font></div><div><font size="2"   >**********</font></div><div><font size="2"   >3431---pcscd---24---378</font></div><div><font size="2"   >19556---stapio---6---786432</font></div><div><font size="2"   >4068---sshd---1---16384</font></div><div><font size="2"   >**********</font></div><div><font size="2"   >3431---pcscd---24---378</font></div><div><font size="2"   >19556---stapio---6---786432</font></div><div><font size="2"   >3762---sendmail---1---1024</font></div><div><font size="2"   >4068---sshd---1---16384</font></div><div><font size="2"   >**********</font></div><div><font size="2"   >3431---pcscd---24---378</font></div><div><font size="2"   >19556---stapio---6---786432</font></div><div><font size="2"   >4068---sshd---1---16384</font></div><div><font size="2"   >END:**********</font></div><div><font size="2"   >3431---pcscd---240---3780</font></div><div><font size="2"   >19556---stapio---61---7749640</font></div><div><font size="2"   >4068---sshd---9---147456</font></div><div><font size="2"   >3229---irqbalance---5---5120</font></div><div><font size="2"   >3762---sendmail---2---2048</font></div><p></p></pre></div><div>注意本文的例子中, 用到了两个stap传入参数$1, $2, 但是在目标机上不需要输入这两个参数, 原因是模块编译好后就无法改变.</div><div>目前还无法生成带参数的module, 期待systemtap以后版本中改进.&nbsp;</div><div>但是可以通过全局变量来取代传入参数, 只是全局变量不能放在探针入口例如timer.s(global_var)是不行的.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 50000 -e 'global var=1; probe timer.s(var) {println("hello")}'</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >parse error: expected literal string or number</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; saw: identifier 'var' at &lt;input&gt;:1:29</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;source: global var=1; probe timer.s(var) {println("hello")}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >1 parse error.</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 146792virt/23704res/3020shr/21388data kb, in 190usr/10sys/206real ms.</font></div><div><font size="2"   >Pass 1: parse failed. &nbsp;Try again with another '--vp 1' option.</font></div><div><font size="2"   >Running rm -rf /tmp/stap4b1okP</font></div><div><font size="2"   >Spawn waitpid result (0x0): 0</font></div><div><font size="2"   >Removed temporary directory "/tmp/stap4b1okP"</font></div><p></p></pre></div><div>把io.stp脚本改成如下, 使用全局变量interval来控制输出间隔.</div><div>注意不要在begin中初始化interval, 否则staprun传入的global 变量会被begin中的覆盖. 初始化在global定义时指定就不会覆盖staprun指定的全局变量值.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >global var1%[60000], var2%[60000], ts, interval=1</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe begin {</font></div><div><font size="2"   >&nbsp; ts = gettimeofday_s()</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe syscall.read {</font></div><div><font size="2"   >&nbsp; var1[pid(),execname()] &lt;&lt;&lt; $count</font></div><div><font size="2"   >&nbsp; var2[pid(),execname()] &lt;&lt;&lt; $count</font></div><div><font size="2"   >}&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe timer.s(1) {</font></div><div><font size="2"   >&nbsp; if ((gettimeofday_s() - ts) &gt;= interval) {</font></div><div><font size="2"   >&nbsp; &nbsp; ts = gettimeofday_s()</font></div><div><font size="2"   >&nbsp; &nbsp; print("**********\n")</font></div><div><font size="2"   >&nbsp; &nbsp; foreach([x,y] in var1- limit 5)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; printdln("---", x, y, @count(var1[x,y]), @sum(var1[x,y]))</font></div><div><font size="2"   >&nbsp; &nbsp; delete var1</font></div><div><font size="2"   >&nbsp; &nbsp;}</font></div><div><font size="2"   >}&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe end {</font></div><div><font size="2"   >&nbsp; print("END:**********\n")</font></div><div><font size="2"   >&nbsp; foreach([x,y] in var2- limit 5)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; printdln("---", x, y, @count(var2[x,y]), @sum(var2[x,y]))</font></div><div><font size="2"   >&nbsp; delete var1</font></div><div><font size="2"   >&nbsp; delete var2&nbsp;</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>运行io.stp脚本, 测试是否正常 .</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap io.stp&nbsp;</font></div><div><font size="2"   >**********</font></div><div><font size="2"   >3377---pcscd---27---444</font></div><div><font size="2"   >25393---stapio---7---671752</font></div><div><font size="2"   >19947---stapio---5---655360</font></div><div><font size="2"   >8969---postgres---4---64</font></div><div><font size="2"   >8968---postgres---4---64</font></div><div><font size="2"   >**********</font></div><div><font size="2"   >3377---pcscd---27---444</font></div><div><font size="2"   >25393---stapio---6---786432</font></div><div><font size="2"   >19947---stapio---5---655360</font></div><div><font size="2"   >3391---hald---4---8192</font></div><div><font size="2"   >8969---postgres---4---64</font></div><div><font size="2"   >**********</font></div><div><font size="2"   >3377---pcscd---27---444</font></div><div><font size="2"   >25393---stapio---6---786432</font></div><div><font size="2"   >19947---stapio---5---655360</font></div><div><font size="2"   >8969---postgres---4---64</font></div><div><font size="2"   >8968---postgres---4---64</font></div><div><font size="2"   >**********</font></div><div><font size="2"   >25410---perl---250---946396</font></div><div><font size="2"   >25405---nrpe---43---48502</font></div><div><font size="2"   >25406---nrpe---43---48502</font></div><div><font size="2"   >25415---psql---36---56640</font></div><div><font size="2"   >25413---psql---36---56640</font></div><div><font size="2"   >**********</font></div><div><font size="2"   >3377---pcscd---27---444</font></div><div><font size="2"   >25393---stapio---6---786432</font></div><div><font size="2"   >19947---stapio---5---655360</font></div><div><font size="2"   >8969---postgres---4---64</font></div><div><font size="2"   >8968---postgres---4---64</font></div><div><font size="2"   >END:**********</font></div><div><font size="2"   >25410---perl---250---946396</font></div><div><font size="2"   >3377---pcscd---135---2220</font></div><div><font size="2"   >25405---nrpe---43---48502</font></div><div><font size="2"   >25406---nrpe---43---48502</font></div><div><font size="2"   >25415---psql---36---56640</font></div><p></p></pre></div><div>生成模块 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -p 4 -r 2.6.18-348.12.1.el5 -m ioread_top5 io.stp</font></div><div><font size="2"   >ioread_top5.ko</font></div><p></p></pre></div><div>将ioread_top5拷贝到目标机器运行, 使用全局变量interval控制输出频率.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 ~]# staprun ioread_top5.ko interval=5&nbsp;</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >这样就可以在目标机器上实现每5秒输出1次了.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >**********</font></div><div><font size="2"   >3431---pcscd---120---1890</font></div><div><font size="2"   >19940---check_nrpe---41---42422</font></div><div><font size="2"   >19927---stapio---28---3424264</font></div><div><font size="2"   >19940---sh---8---16640</font></div><div><font size="2"   >3229---irqbalance---5---5120</font></div><div><font size="2"   >END:**********</font></div><div><font size="2"   >3431---pcscd---168---2646</font></div><div><font size="2"   >19940---check_nrpe---41---42422</font></div><div><font size="2"   >19927---stapio---38---4734984</font></div><div><font size="2"   >19940---sh---8---16640</font></div><div><font size="2"   >3229---irqbalance---5---5120</font></div><p></p></pre></div><div><br></div></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/cross-compiling.html"   >https://sourceware.org/systemtap/SystemTap_Beginners_Guide/cross-compiling.html</a></div><div>2.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/using-systemtap.html#install-kinfo"   >https://sourceware.org/systemtap/SystemTap_Beginners_Guide/using-systemtap.html#install-kinfo</a></div><div>3.&nbsp;<a style="line-height: 28px;" href="http://blog.163.com/digoal@126/blog/static/163877040201391434530674/"   >http://blog.163.com/digoal@126/blog/static/163877040201391434530674/</a></div><div>4. man stap , man staprun</div></div>
	</div>
</div>
</body>
</html>