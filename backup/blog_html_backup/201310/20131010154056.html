<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL Systemtap example : autovacuum_naptime & databases in cluster</h2>
	<h5 id="">2013-10-10 15:40:56&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201391033439344/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div style="line-height: 28px;"   >本文是一个systemtap的使用例子, 从这里例子观察到的一个现象.</div><div>autovacuum_naptime 这个参数和数据库个数的关系, 以及如何影响autovacuum进程唤醒频率的.</div><div>数据库进程如下 :&nbsp;</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-39 ~]# ps -ewf|grep postgres</font></span></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >pg93 &nbsp; &nbsp; 28144 &nbsp; &nbsp; 1 &nbsp;0 10:39 pts/3 &nbsp; &nbsp;00:00:00 /home/pg93/pgsql9.3.0/bin/postgres</font></div><div style="line-height: 28px;"   ><font size="2"   >pg93 &nbsp; &nbsp; 28145 28144 &nbsp;0 10:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: logger process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >pg93 &nbsp; &nbsp; 28147 28144 &nbsp;0 10:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >pg93 &nbsp; &nbsp; 28148 28144 &nbsp;0 10:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >pg93 &nbsp; &nbsp; 28149 28144 &nbsp;0 10:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal writer process &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >pg93 &nbsp; &nbsp; 28150 28144 &nbsp;0 10:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum launcher process &nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >pg93 &nbsp; &nbsp; 28151 28144 &nbsp;0 10:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: archiver process &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >pg93 &nbsp; &nbsp; 28152 28144 &nbsp;0 10:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process</font></div></div><p></p></pre></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   >数据库没有任何连接.</div><div style="line-height: 28px;"   >stap脚本如下, 运行一段时间后发现没有连接居然会有<span style="line-height: 28px;"   >transaction__start探针被触发了.</span></div></div></div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-39 utils]# stap -e 'probe process("/home/pg93/pgsql9.3.0/bin/postgres").mark("transaction__start") {printdln("arg1,execname(),pid(),tid(),cpu(),gettimeofday_s(),thread_indent(1)); }'</font></div><div style="line-height: 28px;"   ><font size="2"   >535/postgres/28150/28150/1/1381388788/ &nbsp; &nbsp; 0 postgres(28150):</font></div><div style="line-height: 28px;"   ><font size="2"   >1014/postgres/2179/2179/1/1381388788/ &nbsp; &nbsp; 0 postgres(2179):</font></div><div style="line-height: 28px;"   ><font size="2"   >1015/postgres/2179/2179/1/1381388788/ 10786 postgres(2179):&nbsp;</font></div></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >536/postgres/28150/28150/1/1381388818/30322989 postgres(28150):&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >1016/postgres/2188/2188/1/1381388818/ &nbsp; &nbsp; 0 postgres(2188):</font></div><div style="line-height: 28px;"   ><font size="2"   >1017/postgres/2188/2188/1/1381388818/ 10867 postgres(2188):&nbsp;</font></div></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >537/postgres/28150/28150/1/1381388848/60098973 postgres(28150): &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >1018/postgres/2190/2190/1/1381388848/ &nbsp; &nbsp; 0 postgres(2190):</font></div><div style="line-height: 28px;"   ><font size="2"   >1019/postgres/2190/2190/1/1381388848/ 10925 postgres(2190):&nbsp;</font></div></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >538/postgres/28150/28150/1/1381388878/90421976 postgres(28150): &nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >1020/postgres/2192/2192/1/1381388878/ &nbsp; &nbsp; 0 postgres(2192):</font></div><div style="line-height: 28px;"   ><font size="2"   >1021/postgres/2192/2192/1/1381388878/ 10981 postgres(2192):&nbsp;</font></div></div><p></p></pre></div></div><div style="line-height: 28px;"   >以上进程号<span style="line-height: 28px;"   >28150对应postgresql的</span><span style="line-height: 28px;"   >autovacuum launcher process进程.</span></div><div style="line-height: 28px;"   >从结果上发现有一定的规律性, 每隔30秒会输出一次.</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   >每隔一段时间<span style="line-height: 28px;"   >autovacuum launcher process进程会告知postgresql主进程fork autovacuum worker进程进行vacuum操作 .</span></div></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >使用以下的syscall.fork探针能看到这一点 :&nbsp;</span></div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe syscall.fork {printdln("/", execname(), pid(), tid())}'</font></div><div style="line-height: 28px;"   ><font size="2"   >postgres/28144/28144</font></div><p></p></pre></div><div style="line-height: 28px;"   >28144进程正是postgresql主进程号.</div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >autovacuum</span><span style="line-height: 28px;"   >&nbsp;进程的唤醒</span>时间间隔和当前集群中有多少个数据库以及配置autovacuum_naptime 有关 :&nbsp;</div><div style="line-height: 28px;"   >参见autovacuum_naptime的解释 :&nbsp;</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >autovacuum_naptime (integer)</font></div><div style="line-height: 28px;"   ><font size="2"   >Specifies the minimum delay between autovacuum runs on any given database. In each round the daemon examines the database and issues VACUUM and ANALYZE commands as needed for tables in that database. The delay is measured in seconds, and the default is one minute (1min). This parameter can only be set in the postgresql.conf file or on the server command line.</font></div><p></p></pre></div></div><div style="line-height: 28px;"   >注意注解, 这个时间是autovacuum进程对每个数据库扫描的最小时间间隔. 所以autovacuum唤醒autovacuum worker的频率就等于<span style="line-height: 28px;"   >autovacuum_naptime除以集群中数据库的个数(不包含template0和template1)</span></div><div style="line-height: 28px;"   >轮询间隔为<span style="line-height: 28px;"   >autovacuum_naptime</span><span style="line-height: 28px;"   >&nbsp;/ 数据库个数.(不包含template0以及template1)</span></div><div style="line-height: 28px;"   >新建一个数据库后, 轮询时间间隔变成了20秒(现在集群中有3个数据库postgres,digoal,test), 每次探测一个数据库.</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >digoal=# create database test;</font></div><div style="line-height: 28px;"   ><font size="2"   >CREATE DATABASE</font></div></div><div><div style="line-height: 28px;"   ><font size="2"   >test=# create table t(id int);</font></div><div style="line-height: 28px;"   ><font size="2"   >CREATE TABLE</font></div><div><div><font size="2"   >g93@db-172-16-3-39-&gt; ps -efw|grep postgres</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; &nbsp;2451 &nbsp; &nbsp; 1 &nbsp;0 15:19 pts/4 &nbsp; &nbsp;00:00:00 /home/pg93/pgsql9.3.0/bin/postgres</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; &nbsp;2452 &nbsp;2451 &nbsp;0 15:19 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: logger process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; &nbsp;2454 &nbsp;2451 &nbsp;0 15:19 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp; &nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; &nbsp;2455 &nbsp;2451 &nbsp;0 15:19 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; &nbsp;2456 &nbsp;2451 &nbsp;0 15:19 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal writer process &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; &nbsp;2457 &nbsp;2451 &nbsp;0 15:19 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum launcher process &nbsp;&nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; &nbsp;2458 &nbsp;2451 &nbsp;0 15:19 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: archiver process &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; &nbsp;2459 &nbsp;2451 &nbsp;0 15:19 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process &nbsp;&nbsp;</font></div></div></div><p></p></pre></div></div><div style="line-height: 28px;"   >stap 脚本的输出发生了一些改变, 时间间隔变了, 现在是20秒.</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >6/postgres/2457/2457/2/1381389699/120218073 postgres(2457): &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >8/postgres/2483/2483/1/1381389699/ &nbsp; &nbsp; 0 postgres(2483):</font></div><div style="line-height: 28px;"   ><font size="2"   >9/postgres/2483/2483/1/1381389699/ 10738 postgres(2483):&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >7/postgres/2457/2457/2/1381389719/140316989 postgres(2457): &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >10/postgres/2494/2494/1/1381389719/ &nbsp; &nbsp; 0 postgres(2494):</font></div><div style="line-height: 28px;"   ><font size="2"   >11/postgres/2494/2494/1/1381389719/ 10885 postgres(2494):&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >8/postgres/2457/2457/2/1381389739/160316982 postgres(2457): &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >12/postgres/2502/2502/1/1381389739/ &nbsp; &nbsp; 0 postgres(2502):</font></div><div style="line-height: 28px;"   ><font size="2"   >13/postgres/2502/2502/1/1381389739/ 10900 postgres(2502):&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >9/postgres/2457/2457/2/1381389759/180316985 postgres(2457): &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >14/postgres/2510/2510/1/1381389759/ &nbsp; &nbsp; 0 postgres(2510):</font></div><div style="line-height: 28px;"   ><font size="2"   >15/postgres/2510/2510/1/1381389759/ 10734 postgres(2510):&nbsp;</font></div><p></p></pre></div></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >再新建一个数据库 :&nbsp;</span></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >digoal=# create database test1;</font></div><div style="line-height: 28px;"   ><font size="2"   >CREATE DATABASE</font></div><div style="line-height: 28px;"   ><font size="2"   >digoal=# \c test1</font></div><div style="line-height: 28px;"   ><font size="2"   >You are now connected to database "test1" as user "postgres".</font></div><div style="line-height: 28px;"   ><font size="2"   >test1=# create table t1(id int);</font></div><div style="line-height: 28px;"   ><font size="2"   >CREATE TABLE</font></div><p></p></pre></div></div><div style="line-height: 28px;"   >轮询间隔变成了15秒 (<span style="line-height: 28px;"   >现在集群中有4个数据库postgres,digoal,test,test1)</span></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >16/postgres/2457/2457/2/1381389874/295623989 postgres(2457): &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >26/postgres/2568/2568/1/1381389874/ &nbsp; &nbsp; 0 postgres(2568):</font></div><div style="line-height: 28px;"   ><font size="2"   >27/postgres/2568/2568/1/1381389874/ 10733 postgres(2568):&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >17/postgres/2457/2457/2/1381389889/310623979 postgres(2457): &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >28/postgres/2569/2569/1/1381389889/ &nbsp; &nbsp; 0 postgres(2569):</font></div><div style="line-height: 28px;"   ><font size="2"   >29/postgres/2569/2569/1/1381389889/ 10833 postgres(2569):&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >18/postgres/2457/2457/2/1381389904/325623987 postgres(2457): &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >30/postgres/2585/2585/1/1381389904/ &nbsp; &nbsp; 0 postgres(2585):</font></div><div style="line-height: 28px;"   ><font size="2"   >31/postgres/2585/2585/1/1381389904/ 10746 postgres(2585):&nbsp;</font></div><p></p></pre></div><div style="line-height: 28px;"   >[其他]</div><div style="line-height: 28px;"   >1. 使用cmdline_str()函数可以输出详细的命令行参数.</div><div style="line-height: 28px;"   >如</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 utils]# stap -e 'probe process("/home/pg93/pgsql9.3.0/bin/postgres").mark("transaction__start") {printdln("/",$arg1,execname(),pid(),tid(),cpu(),gettimeofday_s(),thread_indent(1),cmdline_str()); }'</font></div><div><font size="2"   >456/postgres/5184/5184/4/1381397061/ &nbsp; &nbsp; 0 postgres(5184):/postgres: postgres digoal [local] authentication</font></div><div><font size="2"   >293/postgres/2457/2457/6/1381397071/ &nbsp; &nbsp; 0 postgres(2457):/postgres: autovacuum launcher process &nbsp;&nbsp;</font></div><div><font size="2"   >457/postgres/5186/5186/1/1381397071/ &nbsp; &nbsp; 0 postgres(5186):/postgres: autovacuum worker process &nbsp;&nbsp;</font></div><div><font size="2"   >458/postgres/5186/5186/1/1381397071/ 10784 postgres(5186): /postgres: autovacuum worker process &nbsp; postgres</font></div><div><font size="2"   >294/postgres/2457/2457/6/1381397101/29888994 postgres(2457): /postgres: autovacuum launcher process &nbsp;&nbsp;</font></div><div><font size="2"   >459/postgres/5202/5202/1/1381397101/ &nbsp; &nbsp; 0 postgres(5202):/postgres: autovacuum worker process &nbsp;&nbsp;</font></div><div><font size="2"   >460/postgres/5202/5202/1/1381397101/ 10784 postgres(5202): /postgres: autovacuum worker process &nbsp; digoal</font></div><div><font size="2"   >295/postgres/2457/2457/6/1381397131/60098978 postgres(2457): &nbsp;/postgres: autovacuum launcher process &nbsp;&nbsp;</font></div><div><font size="2"   >461/postgres/5219/5219/1/1381397131/ &nbsp; &nbsp; 0 postgres(5219):/postgres: autovacuum worker process &nbsp;&nbsp;</font></div><div><font size="2"   >462/postgres/5219/5219/1/1381397131/ 10761 postgres(5219): /postgres: autovacuum worker process &nbsp; postgres</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >[参考]</div><div style="line-height: 28px;"   >1.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/runtime-config-autovacuum.html"   >http://www.postgresql.org/docs/9.3/static/runtime-config-autovacuum.html</a></div><div style="line-height: 28px;"   >2.&nbsp;<a style="line-height: 28px;" href="http://blog.163.com/digoal@126/blog/static/163877040201383044341926/"   >http://blog.163.com/digoal@126/blog/static/163877040201383044341926/</a></div><div style="line-height: 28px;"   >3.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/dynamic-trace.html"   >http://www.postgresql.org/docs/9.3/static/dynamic-trace.html</a></div></div><wbr></div>
	</div>
</div>
</body>
</html>