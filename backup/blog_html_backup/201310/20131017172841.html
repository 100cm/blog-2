<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">SystemTap Tapset: common used functions - 2</h2>
	<h5 id="">2013-10-17 17:28:41&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201391741643669/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><dt style="font-family: Simsun; line-height: normal;"   ><pre class="prettyprint"   ><p></p><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-format-ipaddr.html"   >function::format_ipaddr</a>&nbsp;― Returns a string representation for an IP address</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><span style="line-height: 28px;"   ><a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-ip-ntop.html"   >function::ip_ntop</a></span><span style="line-height: 28px;"   >&nbsp;― Returns a string representation for an IPv4 address</span></font></dt><p></p></pre></dt><dt style="font-family: Simsun; font-size: medium; line-height: normal;"   ><span><span style="line-height: 28px;"   >把数字格式的IP地址转换成字符串格式. 例子可参考:</span></span></dt><dt style="font-family: Simsun; font-size: medium; line-height: normal;"   ><span><span style="line-height: 28px;"   ><a href="http://blog.163.com/digoal@126/blog/static/16387704020139153195701/"   >http://blog.163.com/digoal@126/blog/static/16387704020139153195701/</a></span></span></dt><dt style="font-family: Simsun; font-size: medium; line-height: normal;"   ><br></dt><dt style="font-family: Simsun; line-height: normal;"   ><pre class="prettyprint"   ><p></p><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-htonl.html"   >function::htonl</a>&nbsp;― Convert 32-bit long from host to network order</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-htonll.html"   >function::htonll</a>&nbsp;― Convert 64-bit long long from host to network order</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-htons.html"   >function::htons</a>&nbsp;― Convert 16-bit short from host to network order</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-ntohl.html"   >function::ntohl</a>&nbsp;― Convert 32-bit long from network to host order</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-ntohll.html"   >function::ntohll</a>&nbsp;― Convert 64-bit long long from network to host order</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-ntohs.html"   >function::ntohs</a>&nbsp;― Convert 16-bit short from network to host order</font></dt><p></p></pre></dt><dt style="font-family: Simsun; font-size: medium; line-height: normal;"   ><span>主机与网络传输字节顺序的相互转化函数.</span></dt><dt style="font-family: Simsun; font-size: medium; line-height: normal;"   ><span><br></span></dt><dt style="font-family: Simsun; font-size: medium; line-height: normal;"   ><span></span></dt><dt style="line-height: normal;"   ><pre class="prettyprint"   ><p></p><dt style="line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-inet-get-ip-source.html"   >function::inet_get_ip_source</a>&nbsp;― Provide IP source address string for a kernel socket</font></dt><dt style="line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-inet-get-local-port.html"   >function::inet_get_local_port</a>&nbsp;― Provide local port number for a kernel socket</font></dt><p></p></pre></dt><dt style="line-height: normal;"   ><span>从socket中获取远程ip地址以及本地端口</span></dt><dt><span><font face="Simsun"   size="3"   ></font></span></dt><dt><font face="Simsun"   size="3"   >[root@db-172-16-3-150 ~]# stap -e 'probe tcp.recvmsg {println(inet_get_ip_source($sk)); exit()}'</font></dt><dt><font face="Simsun"   size="3"   >172.16.8.31</font></dt><dt><span><font face="Simsun"   size="3"   ></font></span></dt><dt><font face="Simsun"   size="3"   >[root@db-172-16-3-150 ~]# stap -e 'probe tcp.sendmsg {println(inet_get_ip_source($sock-&gt;sk)); exit()}'</font></dt><dt><font face="Simsun"   size="3"   >172.16.8.31</font></dt><dt><span><font face="Simsun"   size="3"   ></font></span></dt><dt><font face="Simsun"   size="3"   >[root@db-172-16-3-150 ~]# stap -e 'probe tcp.recvmsg {println(inet_get_local_port($sk)); exit()}'</font></dt><dt><font face="Simsun"   size="3"   >22</font></dt><dt><font face="Simsun"   size="3"   >获取IP和端口用得更多的是</font></dt><dt></dt><dt><font face="Simsun"   size="3"   >saddr &nbsp; = format_ipaddr(__ip_sock_saddr($sk), __ip_sock_family($sk))</font></dt><dt><font face="Simsun"   size="3"   >daddr &nbsp; = format_ipaddr(__ip_sock_daddr($sk), __ip_sock_family($sk))</font></dt><dt><font face="Simsun"   size="3"   >sport = __tcp_sock_sport($sk)</font></dt><dt><font face="Simsun"   size="3"   >dport = __tcp_sock_dport($sk)</font></dt><dt><font face="Simsun"   size="3"   ><br></font></dt><dt></dt><dt style="line-height: normal;"   ><pre class="prettyprint"   ><p></p><dt style="line-height: normal;"   ><font face="Simsun"   size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-MAJOR.html"   >function::MAJOR</a>&nbsp;― Extract major device number from a kernel device number (kdev_t)</font></dt><dt style="line-height: normal;"   ><font face="Simsun"   size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-MINOR.html"   >function::MINOR</a>&nbsp;― Extract minor device number from a kernel device number (kdev_t)</font></dt><dt style="line-height: normal;"   ><font face="Simsun"   size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-MKDEV.html"   >function::MKDEV</a>&nbsp;― Creates a value that can be compared to a kernel device number (kdev_t)</font></dt><dt style="line-height: normal;"   ><font face="Simsun"   size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-usrdev2kerndev.html"   >function::usrdev2kerndev</a>&nbsp;― Converts a user-space device number into the format used in the kernel</font></dt><p></p></pre></dt><dt><font face="Simsun"   size="3"   >获取设备的major id和minor id. 创建一个内核设备, 等.</font></dt><dt><font face="Simsun"   size="3"   >例子 :&nbsp;</font></dt><dt></dt><dt><font face="Simsun"   size="3"   >[root@db-172-16-3-150 tapset]# stap -e 'probe vfs.read {if (devname != "N/A") {printdln(".", MAJOR(dev), MINOR(dev), devname); exit()}}'</font></dt><dt><font face="Simsun"   size="3"   >8.1.sda1</font></dt><dt></dt><dt>[root@db-172-16-3-150 tapset]# ll /dev/sda1</dt><dt>brw-rw---- 1 root disk 8, 1 Oct 17 14:44 /dev/sda1</dt><dt><a rel="nofollow" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/traceio2sect.html"   >https://sourceware.org/systemtap/SystemTap_Beginners_Guide/traceio2sect.html</a></dt><dt></dt><dt>#! /usr/bin/env stap</dt><dt><br></dt><dt>global device_of_interest</dt><dt><br></dt><dt>probe begin {</dt><dt>&nbsp; /* The following is not the most efficient way to do this.</dt><dt>&nbsp; &nbsp; &nbsp; One could directly put the result of usrdev2kerndev()</dt><dt>&nbsp; &nbsp; &nbsp; into device_of_interest. &nbsp;However, want to test out</dt><dt>&nbsp; &nbsp; &nbsp; the other device functions */</dt><dt>&nbsp; dev = usrdev2kerndev($1)</dt><dt>&nbsp; device_of_interest = MKDEV(MAJOR(dev), MINOR(dev))</dt><dt>}</dt><dt><br></dt><dt>probe vfs.write, vfs.read</dt><dt>{</dt><dt>&nbsp; if (dev == device_of_interest)</dt><dt>&nbsp; &nbsp; printf ("%s(%d) %s 0x%x\n",</dt><dt>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; execname(), pid(), probefunc(), dev)</dt><dt>}</dt><dt><br></dt><dt><span></span></dt><dt style="font-family: Simsun; line-height: normal;"   ><pre class="prettyprint"   ><p></p><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-error.html"   >function::error</a>&nbsp;― Send an error message</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-exit.html"   >function::exit</a>&nbsp;― Start shutting down probing script.</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-ftrace.html"   >function::ftrace</a>&nbsp;― Send a message to the ftrace ring-buffer</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-log.html"   >function::log</a>&nbsp;― Send a line to the common trace buffer</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-printk.html"   >function::printk</a>&nbsp;― Send a message to the kernel trace buffer</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-warn.html"   >function::warn</a>&nbsp;― Send a line to the warning stream</font></dt><p></p></pre></dt><dt style="font-family: Simsun; font-size: medium; line-height: normal;"   ><span>用于往各个目标发布消息, 例如error用以发布错误消息, 如果MAXERRORS=1将退出stap.</span></dt><dt><span><font face="Simsun"   size="3"   ></font></span></dt><dt><font face="Simsun"   size="3"   >[root@db-172-16-3-150 tapset]# stap -e 'probe begin {</font></dt><dt><font face="Simsun"   size="3"   >try {</font></dt><dt><font face="Simsun"   size="3"   >&nbsp; error("Hello, ")</font></dt><dt><font face="Simsun"   size="3"   >}</font></dt><dt><font face="Simsun"   size="3"   >catch(msg) {</font></dt><dt><font face="Simsun"   size="3"   >&nbsp; println(msg)</font></dt><dt><font face="Simsun"   size="3"   >&nbsp; exit()</font></dt><dt><font face="Simsun"   size="3"   >}</font></dt><dt><font face="Simsun"   size="3"   >}'</font></dt><dt><font face="Simsun"   size="3"   >Hello,&nbsp;</font></dt><dt style="font-family: Simsun; font-size: medium; line-height: normal;"   ><span><br></span></dt><pre class="prettyprint"   ><p></p><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><span style="line-height: normal;"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-randint.html"   >function::randint</a></span><span style="line-height: normal;"   >&nbsp;― Return a random number between [0,n)</span></font></dt><dt style="font-family: Simsun; font-size: medium; line-height: normal;"   ></dt><p></p></pre><dt style="font-family: Simsun; line-height: normal;"   ><span style="line-height: normal; font-size: medium;"   >返回&gt;=0, &lt;n 的一个随机数字.</span></dt><dt><span><font face="Simsun"   size="3"   ></font></span></dt><dt><font face="Simsun"   size="3"   >[root@db-172-16-3-150 tapset]# stap -e 'probe begin {</font></dt><dt><font face="Simsun"   size="3"   >&nbsp; for(i=0;i&lt;10;i++)</font></dt><dt><font face="Simsun"   size="3"   >&nbsp; &nbsp; println(randint(99))</font></dt><dt><font face="Simsun"   size="3"   >&nbsp; exit()</font></dt><dt><font face="Simsun"   size="3"   >}'</font></dt><dt><font face="Simsun"   size="3"   >51</font></dt><dt><font face="Simsun"   size="3"   >57</font></dt><dt><font face="Simsun"   size="3"   >82</font></dt><dt><font face="Simsun"   size="3"   >85</font></dt><dt><font face="Simsun"   size="3"   >4</font></dt><dt><font face="Simsun"   size="3"   >70</font></dt><dt><font face="Simsun"   size="3"   >79</font></dt><dt><font face="Simsun"   size="3"   >37</font></dt><dt><font face="Simsun"   size="3"   >69</font></dt><dt><font face="Simsun"   size="3"   >97</font></dt><dt style="font-family: Simsun; font-size: medium; line-height: normal;"   ><span><br></span></dt><dt><span></span></dt><dt style="font-family: Simsun; line-height: normal;"   ><pre class="prettyprint"   ><p></p><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-atomic-long-read.html"   >function::atomic_long_read</a>&nbsp;― Retrieves an atomic long variable from kernel memory</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-atomic-read.html"   >function::atomic_read</a>&nbsp;― Retrieves an atomic variable from kernel memory</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-kernel-char.html"   >function::kernel_char</a>&nbsp;― Retrieves a char value stored in kernel memory</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-kernel-int.html"   >function::kernel_int</a>&nbsp;― Retrieves an int value stored in kernel memory</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-kernel-long.html"   >function::kernel_long</a>&nbsp;― Retrieves a long value stored in kernel memory</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-kernel-pointer.html"   >function::kernel_pointer</a>&nbsp;― Retrieves a pointer value stored in kernel memory</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-kernel-short.html"   >function::kernel_short</a>&nbsp;― Retrieves a short value stored in kernel memory</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-kernel-string.html"   >function::kernel_string</a>&nbsp;― Retrieves string from kernel memory</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-kernel-string2.html"   >function::kernel_string2</a>&nbsp;― Retrieves string from kernel memory with alternative error string</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-kernel-string2-utf16.html"   >function::kernel_string2_utf16</a>&nbsp;― Retrieves UTF-16 string from kernel memory with alternative error string</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-kernel-string2-utf32.html"   >function::kernel_string2_utf32</a>&nbsp;― Retrieves UTF-32 string from kernel memory with alternative error string</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-kernel-string-n.html"   >function::kernel_string_n</a>&nbsp;― Retrieves string of given length from kernel memory</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-kernel-string-utf16.html"   >function::kernel_string_utf16</a>&nbsp;― Retrieves UTF-16 string from kernel memory</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-kernel-string-utf32.html"   >function::kernel_string_utf32</a>&nbsp;― Retrieves UTF-32 string from kernel memory</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-char.html"   >function::user_char</a>&nbsp;― Retrieves a char value stored in user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-char-warn.html"   >function::user_char_warn</a>&nbsp;― Retrieves a char value stored in user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-int.html"   >function::user_int</a>&nbsp;― Retrieves an int value stored in user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-int16.html"   >function::user_int16</a>&nbsp;― Retrieves a 16-bit integer value stored in user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-int32.html"   >function::user_int32</a>&nbsp;― Retrieves a 32-bit integer value stored in user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-int64.html"   >function::user_int64</a>&nbsp;― Retrieves a 64-bit integer value stored in user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-int8.html"   >function::user_int8</a>&nbsp;― Retrieves a 8-bit integer value stored in user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-int-warn.html"   >function::user_int_warn</a>&nbsp;― Retrieves an int value stored in user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-long.html"   >function::user_long</a>&nbsp;― Retrieves a long value stored in user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-long-warn.html"   >function::user_long_warn</a>&nbsp;― Retrieves a long value stored in user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-short.html"   >function::user_short</a>&nbsp;― Retrieves a short value stored in user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-short-warn.html"   >function::user_short_warn</a>&nbsp;― Retrieves a short value stored in user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-string.html"   >function::user_string</a>&nbsp;― Retrieves string from user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-string2.html"   >function::user_string2</a>&nbsp;― Retrieves string from user space with alternative error string</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-string2-utf16.html"   >function::user_string2_utf16</a>&nbsp;― Retrieves UTF-16 string from user memory with alternative error string</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-string2-utf32.html"   >function::user_string2_utf32</a>&nbsp;― Retrieves UTF-32 string from user memory with alternative error string</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-string-n.html"   >function::user_string_n</a>&nbsp;― Retrieves string of given length from user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-string-n2.html"   >function::user_string_n2</a>&nbsp;― Retrieves string of given length from user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-string-n-quoted.html"   >function::user_string_n_quoted</a>&nbsp;― Retrieves and quotes string from user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-string-n-warn.html"   >function::user_string_n_warn</a>&nbsp;― Retrieves string from user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-string-quoted.html"   >function::user_string_quoted</a>&nbsp;― Retrieves and quotes string from user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-string-utf16.html"   >function::user_string_utf16</a>&nbsp;― Retrieves UTF-16 string from user memory</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-string-utf32.html"   >function::user_string_utf32</a>&nbsp;― Retrieves UTF-32 string from user memory</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-string-warn.html"   >function::user_string_warn</a>&nbsp;― Retrieves string from user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-uint16.html"   >function::user_uint16</a>&nbsp;― Retrieves an unsigned 16-bit integer value stored in user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-uint32.html"   >function::user_uint32</a>&nbsp;― Retrieves an unsigned 32-bit integer value stored in user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-uint64.html"   >function::user_uint64</a>&nbsp;― Retrieves an unsigned 64-bit integer value stored in user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-uint8.html"   >function::user_uint8</a>&nbsp;― Retrieves an unsigned 8-bit integer value stored in user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-ushort.html"   >function::user_ushort</a>&nbsp;― Retrieves an unsigned short value stored in user space</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-user-ushort-warn.html"   >function::user_ushort_warn</a>&nbsp;― Retrieves an unsigned short value stored in user space</font></dt><p></p></pre></dt><dt style="font-family: Simsun; font-size: medium; line-height: normal;"   ><span>从用户空间地址或内核内存地址中取出相应类型的值, 取出字符串长度受stap -D MAXSTRINGLEN 限制. 如果输出长度截断, 可以增加</span><span style="line-height: 28px;"   >MAXSTRINGLEN</span><span style="line-height: 28px;"   >&nbsp;值.</span></dt><dt style="font-family: Simsun; font-size: medium; line-height: normal;"   ><span>例如 :&nbsp;</span></dt><dt><span><font face="Simsun"   size="3"   ></font></span></dt><dt><font face="Simsun"   size="3"   >[root@db-172-16-3-150 ~]# stap -e '</font></dt><dt><font face="Simsun"   size="3"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__start") {</font></dt><dt><font face="Simsun"   size="3"   >&nbsp; printdln("**", sprintf("%p",$arg1), user_string($arg1))</font></dt><dt><font face="Simsun"   size="3"   >&nbsp; exit()</font></dt><dt><font face="Simsun"   size="3"   >}'</font></dt><dt><font face="Simsun"   size="3"   >输出 :&nbsp;</font></dt><dt><font face="Simsun"   size="3"   >0x1b6f280**select * from t1 limit 1;</font></dt><dt><font face="Simsun"   size="3"   >SQL语句 :&nbsp;</font></dt><dt></dt><dt><font face="Simsun"   size="3"   >digoal=# select * from t1 limit 1;</font></dt><dt><font face="Simsun"   size="3"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></dt><dt><font face="Simsun"   size="3"   >----+----------------------------------</font></dt><dt><font face="Simsun"   size="3"   >&nbsp; 1 | 006f3673faa5991478e6db0c01c88716</font></dt><dt><font face="Simsun"   size="3"   >(1 row)</font></dt><dt><font face="Simsun"   size="3"   >截断输出:</font></dt><dt></dt><dt><font face="Simsun"   size="3"   >[root@db-172-16-3-150 ~]# stap -D MAXSTRINGLEN=5 -e '</font></dt><dt><font face="Simsun"   size="3"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__start") {</font></dt><dt><font face="Simsun"   size="3"   >&nbsp; printdln("**", sprintf("%p",$arg1), user_string($arg1)) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></dt><dt><font face="Simsun"   size="3"   >&nbsp; exit()</font></dt><dt><font face="Simsun"   size="3"   >}'</font></dt><dt><font face="Simsun"   size="3"   >0x1b**sele</font></dt><dt><font face="Simsun"   size="3"   >因为<span style="line-height: 28px;"   >MAXSTRINGLEN=5, 所以截断后只有4个字符, 需要减去字符串\0占位符</span></font></dt><dt style="font-family: Simsun; font-size: medium; line-height: normal;"   ><span><br></span></dt><dt><span></span></dt><dt style="font-family: Simsun; line-height: normal;"   ><pre class="prettyprint"   ><p></p><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-set-kernel-char.html"   >function::set_kernel_char</a>&nbsp;― Writes a char value to kernel memory</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-set-kernel-int.html"   >function::set_kernel_int</a>&nbsp;― Writes an int value to kernel memory</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-set-kernel-long.html"   >function::set_kernel_long</a>&nbsp;― Writes a long value to kernel memory</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-set-kernel-pointer.html"   >function::set_kernel_pointer</a>&nbsp;― Writes a pointer value to kernel memory.</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-set-kernel-short.html"   >function::set_kernel_short</a>&nbsp;― Writes a short value to kernel memory</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-set-kernel-string.html"   >function::set_kernel_string</a>&nbsp;― Writes a string to kernel memory</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-set-kernel-string-n.html"   >function::set_kernel_string_n</a>&nbsp;― Writes a string of given length to kernel memory</font></dt><p></p></pre></dt><dt style="font-family: Simsun; font-size: medium;"   >往指定内核内存地址中写入各种类型的值, 非常危险, 只能在-g模式下使用.</dt><dt style="font-family: Simsun; font-size: medium;"   >例如</dt><dt></dt><dt><font face="Simsun"   size="3"   >[root@db-172-16-3-150 ~]# stap -g -e ' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></dt><dt><font face="Simsun"   size="3"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__start") {</font></dt><dt><font face="Simsun"   size="3"   >&nbsp; printdln("**", sprintf("%p",$arg1), user_string($arg1))</font></dt><dt><font face="Simsun"   size="3"   >&nbsp; set_kernel_string($arg1, "delete from t1;")</font></dt><dt><font face="Simsun"   size="3"   >&nbsp; exit()</font></dt><dt><font face="Simsun"   size="3"   >}'</font></dt><dt><font face="Simsun"   size="3"   >0x1b6f280**select * from t1 limit 1;</font></dt><dt><font face="Simsun"   size="3"   >在数据库中执行</font><span style="line-height: 28px; font-family: Simsun; font-size: medium;"   >select * from t1 limit 1;, 但是这个内容已被改写成</span><font face="Simsun"   size="3"   >"delete from t1;", 所以实际执行的操作是删除操作.</font></dt><dt><font face="Simsun"   size="3"   ></font></dt><dt><font face="Simsun"   size="3"   >digoal=# select * from t1 limit 1;</font></dt><dt><font face="Simsun"   size="3"   >DELETE 5635072</font></dt><dt></dt><dt><font face="Simsun"   size="3"   >digoal=# select * from t1 limit 1;</font></dt><dt><font face="Simsun"   size="3"   >&nbsp;id | info&nbsp;</font></dt><dt><font face="Simsun"   size="3"   >----+------</font></dt><dt><font face="Simsun"   size="3"   >(0 rows)</font></dt><dt>相当危险, 执行完后数据没了.</dt><dt><font face="Simsun"   size="3"   ><br></font></dt><dt style="font-family: Simsun; line-height: normal;"   ><pre class="prettyprint"   ><p></p><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-mdelay.html"   >function::mdelay</a>&nbsp;― millisecond delay</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ></font></dt><dt style="line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-panic.html"   >function::panic</a>&nbsp;― trigger a panic</font></dt><dt style="line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-udelay.html"   >function::udelay</a>&nbsp;― microsecond delay</font></dt><p></p></pre></dt><dt style="line-height: normal;"   ><span>延迟函数, 类似数据库中的pg_sleep(), 因此只能在stap guru模式中才可以使用.&nbsp;</span></dt><dt><span><font face="Simsun"   size="3"   ></font></span></dt><dt><font face="Simsun"   size="3"   >[root@db-172-16-3-150 tapset]# stap -g -e 'probe begin {</font></dt><dt><font face="Simsun"   size="3"   >ts1=gettimeofday_ms()</font></dt><dt><font face="Simsun"   size="3"   >mdelay(100)</font></dt><dt><font face="Simsun"   size="3"   >ts2=gettimeofday_ms()</font></dt><dt><font face="Simsun"   size="3"   >printdln("**",ts1,ts2,ts2-ts1)</font></dt><dt><font face="Simsun"   size="3"   >exit()</font></dt><dt><font face="Simsun"   size="3"   >}'</font></dt><dt><font face="Simsun"   size="3"   >1381999610011**1381999610111**100</font></dt><dt><font face="Simsun"   size="3"   >panic向内核发出kernel panic消息.</font></dt><dt><font face="Simsun"   size="3"   ><u><font color="#ff0000"   >将导致系统重启, 千万不要胡乱使用.</font></u></font></dt><dt></dt><dt><font face="Simsun"   size="3"   >[root@db-172-16-3-150 tapset]# stap -g -e 'probe begin {</font></dt><dt><font face="Simsun"   size="3"   >panic("this is a test")</font></dt><dt><font face="Simsun"   size="3"   >exit() &nbsp; &nbsp;&nbsp;</font></dt><dt><font face="Simsun"   size="3"   >}'</font></dt></div><div><br></div><div><dt style="font-family: Simsun; line-height: normal;"   ><pre class="prettyprint"   ><p></p><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-isdigit.html"   >function::isdigit</a>&nbsp;― Checks for a digit</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-isinstr.html"   >function::isinstr</a>&nbsp;― Returns whether a string is a substring of another string</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-str-replace.html"   >function::str_replace</a>&nbsp;― str_replace Replaces all instances of a substring with another</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-stringat.html"   >function::stringat</a>&nbsp;― Returns the char at a given position in the string</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-strlen.html"   >function::strlen</a>&nbsp;― Returns the length of a string</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-strtol.html"   >function::strtol</a>&nbsp;― strtol - Convert a string to a long</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-substr.html"   >function::substr</a>&nbsp;― Returns a substring</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-text-str.html"   >function::text_str</a>&nbsp;― Escape any non-printable chars in a string</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-text-strn.html"   >function::text_strn</a>&nbsp;― Escape any non-printable chars in a string</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-tokenize.html"   >function::tokenize</a>&nbsp;― Return the next non-empty token in a string</font></dt><p></p></pre></dt><dt style="font-family: Simsun; font-size: medium;"   >一系列字符和数字的操作函数, 检查字符串首字符是否为数字, 判断字符串是否在另一个字符串中, 字符串替换, 字符串长度, 字符转数字, substr等, 类似数据库中的一些字符操作函数.</dt><dt></dt><dt><font face="Simsun"   size="3"   >[root@db-172-16-3-150 ~]# stap -e 'probe begin</font></dt><dt><font face="Simsun"   size="3"   >{</font></dt><dt><font face="Simsun"   size="3"   >print(isinstr("hello ", "el"))</font></dt><dt><font face="Simsun"   size="3"   >exit()</font></dt><dt><font face="Simsun"   size="3"   >}'</font></dt><dt><font face="Simsun"   size="3"   >1[root@db-172-16-3-150 ~]#&nbsp;</font></dt><dt><font face="Simsun"   size="3"   >[root@db-172-16-3-150 ~]# stap -e 'probe begin</font></dt><dt><font face="Simsun"   size="3"   >{</font></dt><dt><font face="Simsun"   size="3"   >print(isinstr("hello ", "H"))&nbsp;</font></dt><dt><font face="Simsun"   size="3"   >exit()</font></dt><dt><font face="Simsun"   size="3"   >}'</font></dt><dt><font face="Simsun"   size="3"   >0</font></dt><dt><font face="Simsun"   size="3"   ><br></font></dt><dt></dt><dt style="font-family: Simsun; line-height: normal;"   ><pre class="prettyprint"   ><p></p><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-ansi-clear-screen.html"   >function::ansi_clear_screen</a>&nbsp;― Move cursor to top left and clear screen.</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-ansi-cursor-hide.html"   >function::ansi_cursor_hide</a>&nbsp;― Hides the cursor.</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-ansi-cursor-move.html"   >function::ansi_cursor_move</a>&nbsp;― Move cursor to new coordinates.</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-ansi-cursor-restore.html"   >function::ansi_cursor_restore</a>&nbsp;― Restores a previously saved cursor position.</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-ansi-cursor-save.html"   >function::ansi_cursor_save</a>&nbsp;― Saves the cursor position.</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-ansi-cursor-show.html"   >function::ansi_cursor_show</a>&nbsp;― Shows the cursor.</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-ansi-new-line.html"   >function::ansi_new_line</a>&nbsp;― Move cursor to new line.</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-ansi-reset-color.html"   >function::ansi_reset_color</a>&nbsp;― Resets Select Graphic Rendition mode.</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-ansi-set-color.html"   >function::ansi_set_color</a>&nbsp;― Set the ansi Select Graphic Rendition mode.</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-ansi-set-color2.html"   >function::ansi_set_color2</a>&nbsp;― Set the ansi Select Graphic Rendition mode.</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-ansi-set-color3.html"   >function::ansi_set_color3</a>&nbsp;― Set the ansi Select Graphic Rendition mode.</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-indent.html"   >function::indent</a>&nbsp;― returns an amount of space to indent</font></dt><dt style="font-family: Simsun; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-thread-indent.html"   >function::thread_indent</a>&nbsp;― returns an amount of space with the current task information</font></dt><p></p></pre></dt><dt style="font-family: Simsun; font-size: medium; line-height: normal;"   ><span>与输出格式相关的一些函数, 例如清屏, 缩进格式等.</span></dt><dt style="font-family: Simsun; font-size: medium; line-height: normal;"   ><br></dt></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/"   >https://sourceware.org/systemtap/tapsets/</a></div></div>
	</div>
</div>
</body>
</html>