<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL fast bit set 1 count for int4</h2>
	<h5 id="">2015-01-14 17:44:28&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201501454428766/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>一个关于int的比特位为1的计数函数, 效率还挺高的.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Thanks for all the replies.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >I'm giving this a spin, at present. It's based on Rikard's suggestion of using plpgsql script function. Like Jason and other have said, it could be done in a C function (and this was my first inclination), but the hassle of worrying about linking libraries, 32/64-bit installation etc is probably overkill. So this implementation of the 'MIT Hakmem' algorithm seemed like a good compromise between efficiency and efficacy:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION mybitcount(n int4) RETURNS int4 AS $$</font></div><div><font size="2"   >&nbsp; DECLARE tmp int4;</font></div><div><font size="2"   >&nbsp; BEGIN</font></div><div><font size="2"   >&nbsp; &nbsp; tmp = n - ((n &gt;&gt; 1) &amp; 3681400539) - ((n &gt;&gt; 2) &amp; 1227133513);</font></div><div><font size="2"   >&nbsp; &nbsp; RETURN ((tmp + (tmp &gt;&gt; 3)) &amp; 3340530119) % 63;</font></div><div><font size="2"   >&nbsp; END</font></div><div><font size="2"   >$$ LANGUAGE plpgsql IMMUTABLE STRICT;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Nathaniel</font></div><p></p></pre></div><div><br></div><div>关于效率, 在一个8核 2.0Ghz的机器上测试.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres@localhost-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -h 127.0.0.1 -T 30</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 2900374</font></div><div><font size="2"   >tps = 96665.458393 (including connections establishing)</font></div><div><font size="2"   >tps = 96710.178913 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.164305 &nbsp; &nbsp; &nbsp; &nbsp;select mybitcount(111111);</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres@localhost-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -h 127.0.0.1 -T 30</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 2940944</font></div><div><font size="2"   >tps = 98020.831406 (including connections establishing)</font></div><div><font size="2"   >tps = 98065.039233 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.162040 &nbsp; &nbsp; &nbsp; &nbsp;select 1;&nbsp;</font></div></div><p></p></pre></div><div><br></div><div>但是对于变长的bit, 可以参考redis的bit count, 移植到pg来.</div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/message-id/flat/998131.26971.qm@web25007.mail.ukl.yahoo.com#998131.26971.qm@web25007.mail.ukl.yahoo.com"   >http://www.postgresql.org/message-id/flat/998131.26971.qm@web25007.mail.ukl.yahoo.com#998131.26971.qm@web25007.mail.ukl.yahoo.com</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://en.wikipedia.org/wiki/Hamming_weight"   >http://en.wikipedia.org/wiki/Hamming_weight</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://redis.io/commands/bitcount"   >http://redis.io/commands/bitcount</a></div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL fast bit set 1 count for int4 - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>