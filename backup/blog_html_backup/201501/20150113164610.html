<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">zfs performance tuning basic</h2>
	<h5 id="">2015-01-13 16:46:10&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402015013105044250/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>ZFS优化的一些基础常识.</div><div>zfs模块每个参数的讲解, 包括IO调度, ARC的优化</div><div>man&nbsp;<span style="line-height: 28px;"   >/usr/share/man/man5/zfs-module-parameters.5.gz</span></div><div><span style="line-height: 28px;"   >例如zfs将IO分为5个队列, 针对每个队列可以通过模块参数来控制IO调度, 例如为了提高同步写的能力, 同步写的active可以设大, 为了提高异步写的能力, 可以设置较大的脏ARC区域, 以及设置较宽的加速区域来降低同步写的冲突IO争抢.</span></div><div><span style="line-height: 28px;"   >5个队列分别为同步读,写, 异步读,写, 以及ZFS自身的检查和修复操作IO.</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >ZFS I/O SCHEDULER</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ZFS issues I/O operations to leaf vdevs to satisfy and complete I/Os. &nbsp;The I/O scheduler determines when and in</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;what order those operations are issued. &nbsp;The I/O scheduler divides operations into five I/O classes prioritized</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;in the following order: sync read, sync write, async read, async write, and scrub/resilver. &nbsp;Each queue defines</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;the minimum and maximum number of concurrent operations that may be issued to the &nbsp;device. &nbsp; In &nbsp;addition, &nbsp;the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;device &nbsp;has &nbsp;an &nbsp;aggregate &nbsp;maximum, &nbsp;zfs_vdev_max_active. Note that the sum of the per-queue minimums must not</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;exceed the aggregate maximum. &nbsp;If the sum of the per-queue maximums exceeds the &nbsp;aggregate &nbsp;maximum, &nbsp;then &nbsp;the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;number of active I/Os may reach zfs_vdev_max_active, in which case no further I/Os will be issued regardless of</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;whether all per-queue minimums have been met.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;For many physical devices, throughput increases with the number of concurrent operations, but latency typically</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;suffers. Further, physical devices typically have a limit at which more concurrent operations have no effect on</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;throughput or can actually cause it to decrease.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The scheduler selects the next operation to issue by first looking for an I/O class whose minimum has not &nbsp;been</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;satisfied. &nbsp;Once &nbsp;all are satisfied and the aggregate maximum has not been hit, the scheduler looks for classes</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;whose maximum has not been satisfied. Iteration through the I/O classes is done in the order &nbsp;specified &nbsp;above.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;No &nbsp;further &nbsp;operations &nbsp;are issued if the aggregate maximum number of concurrent operations has been hit or if</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;there are no operations queued for an I/O class that has not hit its maximum. &nbsp;Every time an I/O is &nbsp;queued &nbsp;or</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;an operation completes, the I/O scheduler looks for new operations to issue.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;In general, smaller max_active’s will lead to lower latency of synchronous operations. &nbsp;Larger max_active’s may</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;lead to higher overall throughput, depending on underlying storage.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The ratio of the queues’ max_actives determines the balance of performance between reads, writes, &nbsp;and &nbsp;scrubs.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;E.g., increasing zfs_vdev_scrub_max_active will cause the scrub or resilver to complete more quickly, but reads</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;and writes to have higher latency and lower throughput.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;All I/O classes have a fixed maximum number of outstanding operations except for the async write &nbsp;class. &nbsp;Asyn-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;chronous writes represent the data that is committed to stable storage during the syncing stage for transaction</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;groups. Transaction groups enter the syncing state periodically so the &nbsp;number &nbsp;of &nbsp;queued &nbsp;async &nbsp;writes &nbsp;will</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;quickly burst up and then bleed down to zero. Rather than servicing them as quickly as possible, the I/O sched-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;uler changes the maximum number of active async write I/Os according to the amount of dirty data in &nbsp;the &nbsp;pool.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Since &nbsp;both throughput and latency typically increase with the number of concurrent operations issued to physi-</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;cal devices, reducing the burstiness in the number of concurrent operations also stabilizes the &nbsp;response &nbsp;time</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;of &nbsp;operations &nbsp;from other -- and in particular synchronous -- queues. In broad strokes, the I/O scheduler will</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;issue more concurrent operations from the async write queue as there’s more dirty data in the pool.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Async Writes</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The number of concurrent operations issued for the async write I/O class follows a piece-wise &nbsp;linear &nbsp;function</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;defined by a few adjustable points.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;o---------| &lt;-- zfs_vdev_async_write_max_active</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^ &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /^ &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/ | &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;active | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; / &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; I/O &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/ &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;count &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; / &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;/ &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |-------o &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; | &lt;-- zfs_vdev_async_write_min_active</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0|_______^______|_________|</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0% &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 100% of zfs_dirty_data_max</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;‘-- zfs_vdev_async_write_active_max_dirty_percent</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ‘--------- zfs_vdev_async_write_active_min_dirty_percent</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Until &nbsp;the &nbsp;amount &nbsp;of &nbsp;dirty &nbsp;data exceeds a minimum percentage of the dirty data allowed in the pool, the I/O</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;scheduler will limit the number of concurrent operations to the minimum. As that threshold is crossed, the num-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ber &nbsp;of &nbsp;concurrent &nbsp;operations issued increases linearly to the maximum at the specified maximum percentage of</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;the dirty data allowed in the pool.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Ideally, the amount of dirty data on a busy pool &nbsp;will &nbsp;stay &nbsp;in &nbsp;the &nbsp;sloped &nbsp;part &nbsp;of &nbsp;the &nbsp;function &nbsp;between</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;zfs_vdev_async_write_active_min_dirty_percent &nbsp;and zfs_vdev_async_write_active_max_dirty_percent. If it exceeds</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;the maximum percentage, this indicates that the rate of incoming data is greater than the rate that the backend</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;storage can handle. In this case, we must further throttle incoming writes, as described in the next section.</font></div></div><p></p></pre></div><div><br></div><div>通过延迟来控制IO请求.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >ZFS TRANSACTION DELAY</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;We &nbsp;delay &nbsp;transactions &nbsp;when &nbsp;we’ve &nbsp;determined that the backend storage isn’t able to accommodate the rate of</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;incoming writes.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;If there is already a transaction waiting, we delay relative to when &nbsp;that &nbsp;transaction &nbsp;will &nbsp;finish &nbsp;waiting.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;This way the calculated delay time is independent of the number of threads concurrently executing transactions.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;If we are the only waiter, wait relative to when the transaction started, rather than the current &nbsp;time. &nbsp; This</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;credits the transaction for "time already served", e.g. reading indirect blocks.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The minimum time for a transaction to take is calculated as:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;min_time = zfs_delay_scale * (dirty - min) / (max - dirty)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;min_time is then capped at 100 milliseconds.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The &nbsp;delay has two degrees of freedom that can be adjusted via tunables. &nbsp;The percentage of dirty data at which</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;we &nbsp;start &nbsp;to &nbsp;delay &nbsp;is &nbsp;defined &nbsp;by &nbsp;zfs_delay_min_dirty_percent. &nbsp;This &nbsp;should &nbsp;typically &nbsp;be &nbsp;at &nbsp;or &nbsp;above</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;zfs_vdev_async_write_active_max_dirty_percent &nbsp;so &nbsp;that &nbsp;we only start to delay after writing at full speed has</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;failed to keep up with the incoming write rate. The scale of the curve is defined by &nbsp;zfs_delay_scale. &nbsp;Roughly</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;speaking, this variable determines the amount of delay at the midpoint of the curve.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;delay</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 10ms +-------------------------------------------------------------*+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *|</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9ms + &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *|</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8ms + &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;7ms + &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* +</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6ms + &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* +</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5ms + &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * &nbsp;+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * &nbsp;|</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4ms + &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * &nbsp;+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * &nbsp;|</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3ms + &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* &nbsp; +</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2ms + &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(midpoint) * &nbsp; &nbsp;+</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;** &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1ms + &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v *** &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; zfs_delay_scale ----------&gt; &nbsp; &nbsp; ******** &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 +-------------------------------------*********----------------+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0% &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;- zfs_dirty_data_max -&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 100%</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Note &nbsp;that since the delay is added to the outstanding time remaining on the most recent transaction, the delay</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;is effectively the inverse of IOPS. &nbsp;Here the midpoint of 500us translates to 2000 IOPS. The shape of the curve</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;was &nbsp;chosen such that small changes in the amount of accumulated dirty data in the first 3/4 of the curve yield</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;relatively small differences in the amount of delay.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The effects can be easier to understand when the amount of delay is represented on a log scale:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;delay</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;100ms +-------------------------------------------------------------++</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 10ms + &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ** +</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(midpoint) &nbsp;** &nbsp;|</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; ** &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1ms + &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v **** &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; zfs_delay_scale ----------&gt; &nbsp; &nbsp; &nbsp; &nbsp;***** &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; **** &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;**** &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;100us + &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;** &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 10us + &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+--------------------------------------------------------------+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0% &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;- zfs_dirty_data_max -&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 100%</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Note here that only as the amount of dirty data approaches its limit does the delay start to increase &nbsp;rapidly.</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The &nbsp;goal &nbsp;of &nbsp;a &nbsp;properly &nbsp;tuned &nbsp;system should be to keep the amount of dirty data out of that range by first</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ensuring that the appropriate limits are set for the I/O scheduler to reach optimal throughput on &nbsp;the &nbsp;backend</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;storage, and then by changing the value of zfs_delay_scale to increase the steepness of the curve.</font></div></div><p></p></pre></div><div><br></div><div>最佳实践 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://www.solarisinternals.com/wiki/index.php/ZFS_Best_Practices_Guide"   >http://www.solarisinternals.com/wiki/index.php/ZFS_Best_Practices_Guide</a></div><a target="_blank" rel="nofollow" href="http://wiki.gentoo.org/wiki/ZFS"   >http://wiki.gentoo.org/wiki/ZFS</a><br><wbr><div><br></div><div>zfs包的MAN文件 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   ># rpm -ql zfs|grep man</font></div><div><font size="2"   >/usr/share/man/man1/zhack.1.gz</font></div><div><font size="2"   >/usr/share/man/man1/zpios.1.gz</font></div><div><font size="2"   >/usr/share/man/man1/ztest.1.gz</font></div><div><font size="2"   >/usr/share/man/man5/vdev_id.conf.5.gz</font></div><div><font size="2"   >/usr/share/man/man5/zfs-module-parameters.5.gz</font></div><div><font size="2"   >/usr/share/man/man5/zpool-features.5.gz</font></div><div><font size="2"   >/usr/share/man/man8/fsck.zfs.8.gz</font></div><div><font size="2"   >/usr/share/man/man8/mount.zfs.8.gz</font></div><div><font size="2"   >/usr/share/man/man8/vdev_id.8.gz</font></div><div><font size="2"   >/usr/share/man/man8/zdb.8.gz</font></div><div><font size="2"   >/usr/share/man/man8/zed.8.gz</font></div><div><font size="2"   >/usr/share/man/man8/zfs.8.gz</font></div><div><font size="2"   >/usr/share/man/man8/zinject.8.gz</font></div><div><font size="2"   >/usr/share/man/man8/zpool.8.gz</font></div><div><font size="2"   >/usr/share/man/man8/zstreamdump.8.gz</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   ># rpm -ql spl|grep man</font></div><div><font size="2"   >/usr/share/man/man1/splat.1.gz</font></div><div><font size="2"   >/usr/share/man/man5/spl-module-parameters.5.gz</font></div></div><p></p></pre></div><div><br></div><div>模块信息</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >man&nbsp;<span style="line-height: 28px;"   >/usr/share/man/man5/spl-module-parameters.5.gz	</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   >man&nbsp;</span><span style="line-height: 28px;"   >/usr/share/man/man5/zfs-module-parameters.5.gz</span></font></div><p></p></pre></div><div><br></div><div>模块配置举例</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># vi /etc/modprobe.d/zfs.conf</font></div><div><div><font size="2"   >options zfs zfs_arc_max=140000000000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >options zfs zfs_dirty_data_max=28000000000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >options zfs zfs_vdev_async_write_active_min_dirty_percent=10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >options zfs zfs_vdev_async_write_active_max_dirty_percent=30 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >options zfs zfs_delay_min_dirty_percent=60 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >options zfs zfs_arc_shrink_shift=11&nbsp;</font></div></div><p></p></pre></div><div><br></div><div>动态配置举例</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># cd /sys/module/zfs/parameters/</font></div><div><font size="2"   >echo&nbsp;<span style="line-height: 28px;"   >140000000000 &gt;&nbsp;</span><span style="line-height: 28px;"   >zfs_arc_max</span></font></div><p></p></pre></div><div><br></div><div>zfs arc统计信息举例</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># cat /proc/spl/kstat/zfs/arcstats&nbsp;</font></div><div><font size="2"   >5 1 0x01 85 4080 8782326609 24297023672599</font></div><div><font size="2"   >name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;type data</font></div><div><font size="2"   >hits &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;7126326</font></div><div><font size="2"   >misses &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;427540</font></div><div><font size="2"   >demand_data_hits &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;6266146</font></div><div><font size="2"   >demand_data_misses &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;109399</font></div><div><font size="2"   >demand_metadata_hits &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;576415</font></div><div><font size="2"   >demand_metadata_misses &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;12326</font></div><div><font size="2"   >prefetch_data_hits &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;22855</font></div><div><font size="2"   >prefetch_data_misses &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;304415</font></div><div><font size="2"   >prefetch_metadata_hits &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;260910</font></div><div><font size="2"   >prefetch_metadata_misses &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;1400</font></div><div><font size="2"   >mru_hits &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;1587485</font></div><div><font size="2"   >mru_ghost_hits &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;8</font></div><div><font size="2"   >mfu_hits &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;5255091</font></div><div><font size="2"   >mfu_ghost_hits &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;16</font></div><div><font size="2"   >deleted &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;9</font></div><div><font size="2"   >recycle_miss &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;0</font></div><div><font size="2"   >mutex_miss &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;0</font></div><div><font size="2"   >evict_skip &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;0</font></div><div><font size="2"   >evict_l2_cached &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;0</font></div><div><font size="2"   >evict_l2_eligible &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;0</font></div><div><font size="2"   >evict_l2_ineligible &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;2048</font></div><div><font size="2"   >hash_elements &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;595708</font></div><div><font size="2"   >hash_elements_max &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;595728</font></div><div><font size="2"   >hash_collisions &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;112924</font></div><div><font size="2"   >hash_chains &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;19671</font></div><div><font size="2"   >hash_chain_max &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;4</font></div><div><font size="2"   >p &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;51202534400</font></div><div><font size="2"   >c &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;102400000000</font></div><div><font size="2"   >c_min &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;4194304</font></div><div><font size="2"   >c_max &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;140000000000</font></div><div><font size="2"   >size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;66260770016</font></div><div><font size="2"   >hdr_size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;208741536</font></div><div><font size="2"   >data_size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;65659827200</font></div><div><font size="2"   >meta_size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;217717760</font></div><div><font size="2"   >other_size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;157795760</font></div><div><font size="2"   >anon_size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;4341760</font></div><div><font size="2"   >anon_evict_data &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;0</font></div><div><font size="2"   >anon_evict_metadata &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;0</font></div><div><font size="2"   >mru_size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;51018742272</font></div><div><font size="2"   >mru_evict_data &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;50805975040</font></div><div><font size="2"   >mru_evict_metadata &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;12618240</font></div><div><font size="2"   >mru_ghost_size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;7270469632</font></div><div><font size="2"   >mru_ghost_evict_data &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;7223246848</font></div><div><font size="2"   >mru_ghost_evict_metadata &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;47222784</font></div><div><font size="2"   >mfu_size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;14854460928</font></div><div><font size="2"   >mfu_evict_data &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;14849526784</font></div><div><font size="2"   >mfu_evict_metadata &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;4213248</font></div><div><font size="2"   >mfu_ghost_size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;549280256</font></div><div><font size="2"   >mfu_ghost_evict_data &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;509110272</font></div><div><font size="2"   >mfu_ghost_evict_metadata &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;40169984</font></div><div><font size="2"   >l2_hits &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;0</font></div><div><font size="2"   >l2_misses &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;427519</font></div><div><font size="2"   >l2_feeds &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;28921</font></div><div><font size="2"   >l2_rw_clash &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;0</font></div><div><font size="2"   >l2_read_bytes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;0</font></div><div><font size="2"   >l2_write_bytes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;119772508160</font></div><div><font size="2"   >l2_writes_sent &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;11483</font></div><div><font size="2"   >l2_writes_done &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;11483</font></div><div><font size="2"   >l2_writes_error &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;0</font></div><div><font size="2"   >l2_writes_hdr_miss &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;26</font></div><div><font size="2"   >l2_evict_lock_retry &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;0</font></div><div><font size="2"   >l2_evict_reading &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;0</font></div><div><font size="2"   >l2_free_on_write &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;1552</font></div><div><font size="2"   >l2_abort_lowmem &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;0</font></div><div><font size="2"   >l2_cksum_bad &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;0</font></div><div><font size="2"   >l2_io_error &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;0</font></div><div><font size="2"   >l2_size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;51763794432</font></div><div><font size="2"   >l2_asize &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;51697022976</font></div><div><font size="2"   >l2_hdr_size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;16687760</font></div><div><font size="2"   >l2_compress_successes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;114612</font></div><div><font size="2"   >l2_compress_zeros &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;0</font></div><div><font size="2"   >l2_compress_failures &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;0</font></div><div><font size="2"   >memory_throttle_count &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;0</font></div><div><font size="2"   >duplicate_buffers &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;0</font></div><div><font size="2"   >duplicate_buffers_size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;0</font></div><div><font size="2"   >duplicate_reads &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;0</font></div><div><font size="2"   >memory_direct_count &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;0</font></div><div><font size="2"   >memory_indirect_count &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;0</font></div><div><font size="2"   >arc_no_grow &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;0</font></div><div><font size="2"   >arc_tempreserve &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;0</font></div><div><font size="2"   >arc_loaned_bytes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;0</font></div><div><font size="2"   >arc_prune &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;0</font></div><div><font size="2"   >arc_meta_used &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;600942816</font></div><div><font size="2"   >arc_meta_limit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;76800000000</font></div><div><font size="2"   >arc_meta_max &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;600942536</font></div><p></p></pre></div><div><br></div><div>ARC原理</div><div><a target="_blank" rel="nofollow" href="https://pthree.org/2012/12/07/zfs-administration-part-iv-the-adjustable-replacement-cache/"   >https://pthree.org/2012/12/07/zfs-administration-part-iv-the-adjustable-replacement-cache/</a></div><div>ZFS&nbsp;<span style="line-height: 28px;"   >adjustable replacement cache (ARC)</span>&nbsp;可以认为是IBM ARC的增强版.</div><div>包含most recent used , most frequency used, mru ghost(数据块已驱逐到磁盘, 但是目录中还存储了磁盘的位置来加速读取), mfu ghost(<span style="line-height: 28px;"   >数据块已驱逐到磁盘, 但是目录中还存储了磁盘的位置来加速读取</span><span style="line-height: 28px;"   >)</span></div><div><div><img title="zfs performance tuning basic - 德哥@Digoal - PostgreSQL research"   alt="zfs performance tuning basic - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://pthree.org/wp-content/uploads/2012/12/arc1.png"   ></div>&nbsp;<img title="zfs performance tuning basic - 德哥@Digoal - PostgreSQL research"   alt="zfs performance tuning basic - 德哥@Digoal - PostgreSQL research"   src="http://pthree.org/wp-content/uploads/2012/12/hybrid-pool.jpg"   style="line-height: 28px; margin: 0px 10px 0px 0px;"   ></div><div><div>术语 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Adjustable Replacement Cache, or ARC-&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; A cache residing in physical RAM. It is built using two caches- the most frequently used cached and the most recently used cache. A cache directory indexes pointers to the caches, including pointers to disk called the ghost frequently used cache, and the ghost most recently used cache.</font></div><div><font size="2"   >Cache Directory-&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; An indexed directory of pointers making up the MRU, MFU, ghost MRU and ghost MFU caches.</font></div><div><font size="2"   >MRU Cache-&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; The most recently used cache of the ARC. The most recently requested blocks from the filesystem are cached here.</font></div><div><font size="2"   >MFU Cache-&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; The most frequently used cache of the ARC. The most frequently requested blocks from the filesystem are cached here.</font></div><div><font size="2"   >Ghost MRU-&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; Evicted pages from the MRU cache back to disk to save space in the MRU. Pointers still track the location of the evicted pages on disk.</font></div><div><font size="2"   >Ghost MFU-&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; Evicted pages from the MFU cache back to disk to save space in the MFU. Pointers still track the location of the evicted pages on disk.</font></div><div><font size="2"   >Level 2 Adjustable Replacement Cache, or L2ARC-&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; A cache residing outside of physical memory, typically on a fast SSD. It is a literal, physical extension of the RAM ARC.</font></div><p></p></pre></div></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="zfs performance tuning basic - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>