<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">fast random data query & delete use ctid in postgresql</h2>
	<h5 id="">2015-01-29 16:42:58&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201502943955427/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>朋友公司有一个需求, 需要生成一笔随机的唯一数据, 随机取出来使用, 用完下次不能重复使用.</div><div>使用PostgreSQL来实现的话, 有以下方法, 性能OK.</div><div>创建测试表, 存放一堆唯一值.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create table tbl (id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div>唯一值随机插入, 取数据时按照数据块倒序取出, 这么做的好处是vacuum时可以直接回收这部分空间.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select generate_series(1,10) order by random();</font></div><div><font size="2"   >&nbsp;generate_series&nbsp;</font></div><div><font size="2"   >-----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;7</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 10</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5</font></div><div><font size="2"   >(10 rows)</font></div><div><font size="2"   >postgres=# \timing</font></div><div><font size="2"   >Timing is on.</font></div><p></p></pre></div><div>随机的插入数据</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into tbl select generate_series(1,10000000) order by random();</font></div><div><font size="2"   >INSERT 0 10000000</font></div><div><font size="2"   >Time: 42204.425 ms</font></div><p></p></pre></div><div>从数据来看 , 已经随机插入了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from tbl limit 10;</font></div><div><font size="2"   >&nbsp; &nbsp;id &nbsp; &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;9318426</font></div><div><font size="2"   >&nbsp;4366165</font></div><div><font size="2"   >&nbsp;4661718</font></div><div><font size="2"   >&nbsp;8491396</font></div><div><font size="2"   >&nbsp;9413591</font></div><div><font size="2"   >&nbsp;9845650</font></div><div><font size="2"   >&nbsp;8830805</font></div><div><font size="2"   >&nbsp; 999712</font></div><div><font size="2"   >&nbsp;7944907</font></div><div><font size="2"   >&nbsp;2487468</font></div><div><font size="2"   >(10 rows)</font></div><p></p></pre></div><div>在ctid上创建索引, 取数据时使用这个索引, 倒序从最后的数据块开始取数据.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create index idx_tbl_ctid on tbl(ctid);</font></div><div><font size="2"   >CREATE INDEX</font></div><div><font size="2"   >Time: 18824.496 ms</font></div><p></p></pre></div><div>例如:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select ctid,* from tbl order by ctid desc limit 5;</font></div><div><font size="2"   >&nbsp; &nbsp; ctid &nbsp; &nbsp;| &nbsp; id &nbsp; &nbsp;</font></div><div><font size="2"   >------------+---------</font></div><div><font size="2"   >&nbsp;(11001,91) | 1121211</font></div><div><font size="2"   >&nbsp;(11001,90) | 1157632</font></div><div><font size="2"   >&nbsp;(11001,89) | 3024993</font></div><div><font size="2"   >&nbsp;(11001,88) | 6147265</font></div><div><font size="2"   >&nbsp;(11001,87) | 3057019</font></div><div><font size="2"   >(5 rows)</font></div><div><font size="2"   >Time: 0.675 ms</font></div><p></p></pre></div><div>为了防止多个进程重复取数据, 使用这种方法.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# with t as(select ctid from tbl order by ctid desc limit 5) delete from tbl where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >&nbsp; &nbsp;id &nbsp; &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;3057019</font></div><div><font size="2"   >&nbsp;6147265</font></div><div><font size="2"   >&nbsp;3024993</font></div><div><font size="2"   >&nbsp;1157632</font></div><div><font size="2"   >&nbsp;1121211</font></div><div><font size="2"   >(5 rows)</font></div><div><font size="2"   >DELETE 5</font></div><div><font size="2"   >Time: 1.136 ms</font></div><p></p></pre></div><div>测试并行取数据.</div><div>测试方法, 将数据插入另一张表</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# with t as(select ctid from tbl order by ctid desc limit 5),t1 as (delete from tbl where ctid in (select ctid from t) returning *) insert into test select * from t1 ;</font></div><div><font size="2"   >INSERT 0 5</font></div><div><font size="2"   >Time: 1.225 ms</font></div><div><font size="2"   >postgres=# select * from test;</font></div><div><font size="2"   >&nbsp; &nbsp;id &nbsp; &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;9879376</font></div><div><font size="2"   >&nbsp;8194987</font></div><div><font size="2"   >&nbsp;4095242</font></div><div><font size="2"   >&nbsp;4486826</font></div><div><font size="2"   >&nbsp;5762760</font></div><div><font size="2"   >(5 rows)</font></div><div><font size="2"   >Time: 0.400 ms</font></div><p></p></pre></div><div>使用pgbench 测试, 16个并行取数据进程, 每次取5条.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@localhost-&gt; vi test.sql</font></div><div><font size="2"   >with t as(select ctid from tbl order by ctid desc limit 5),t1 as (delete from tbl where ctid in (select ctid from t) returning *) insert into test select * from t1;</font></div><p></p></pre></div><div>测试完成后, 查询test表, 看看有没有重复数据就知道这种方法是否靠谱了.</div><div>性能见下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@localhost-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -T 30</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 225225</font></div><div><font size="2"   >tps = 7505.450512 (including connections establishing)</font></div><div><font size="2"   >tps = 7508.798021 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2.128700 &nbsp; &nbsp; &nbsp; &nbsp;with t as(select ctid from tbl order by ctid desc limit 5),t1 as (delete from tbl where ctid in (select ctid from t) returning *) insert into test select * from t1;</font></div><p></p></pre></div><div>经查没有重复数据, 方法靠谱</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select count(*),count(distinct id) from test;</font></div><div><font size="2"   >&nbsp;count &nbsp;| count &nbsp;</font></div><div><font size="2"   >--------+--------</font></div><div><font size="2"   >&nbsp;127625 | 127625</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>使用这种方式, 垃圾回收将回收文件.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select relpages from pg_class where relname='tbl';</font></div><div><font size="2"   >&nbsp;relpages&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; 10442</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# \q</font></div><div><font size="2"   >postgres@localhost-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -T 30</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 221771</font></div><div><font size="2"   >tps = 7390.878883 (including connections establishing)</font></div><div><font size="2"   >tps = 7393.894430 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2.161958 &nbsp; &nbsp; &nbsp; &nbsp;with t as(select ctid from tbl order by ctid desc limit 5) delete from tbl where ctid in (select ctid from t) returning *;</font></div></div><div><div><font size="2"   >postgres=# vacuum analyze tbl;</font></div><div><font size="2"   >VACUUM</font></div><div><font size="2"   >postgres=# select relpages from pg_class where relname='tbl';</font></div><div><font size="2"   >&nbsp;relpages&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; 10301</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>使用多个表的话, 性能还有提升.</div><div>如下 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create table tbl0(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table tbl1(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table tbl2(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table tbl3(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table tbl4(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table tbl5(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table tbl6(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table tbl7(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table tbl8(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table tbl9(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table tbl10(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table tbl11(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table tbl12(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table tbl13(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table tbl14(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table tbl15(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >insert into tbl0 select generate_series(1,1000000) order by random();</font></div><div><font size="2"   >insert into tbl1 select generate_series(1000001,2000000) order by random();</font></div><div><font size="2"   >insert into tbl2 select generate_series(2000001,3000000) order by random();</font></div><div><font size="2"   >insert into tbl3 select generate_series(3000001,4000000) order by random();</font></div><div><font size="2"   >insert into tbl4 select generate_series(4000001,5000000) order by random();</font></div><div><font size="2"   >insert into tbl5 select generate_series(5000001,6000000) order by random();</font></div><div><font size="2"   >insert into tbl6 select generate_series(6000001,7000000) order by random();</font></div><div><font size="2"   >insert into tbl7 select generate_series(7000001,8000000) order by random();</font></div><div><font size="2"   >insert into tbl8 select generate_series(8000001,9000000) order by random();</font></div><div><font size="2"   >insert into tbl9 select generate_series(9000001,10000000) order by random();</font></div><div><font size="2"   >insert into tbl10 select generate_series(10000001,11000000) order by random();</font></div><div><font size="2"   >insert into tbl11 select generate_series(11000001,12000000) order by random();</font></div><div><font size="2"   >insert into tbl12 select generate_series(12000001,13000000) order by random();</font></div><div><font size="2"   >insert into tbl13 select generate_series(13000001,14000000) order by random();</font></div><div><font size="2"   >insert into tbl14 select generate_series(14000001,15000000) order by random();</font></div><div><font size="2"   >insert into tbl15 select generate_series(15000001,16000000) order by random();</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create index idx_tbl0_ctid on tbl0(ctid desc);</font></div><div><font size="2"   >create index idx_tbl1_ctid on tbl1(ctid desc);</font></div><div><font size="2"   >create index idx_tbl2_ctid on tbl2(ctid desc);</font></div><div><font size="2"   >create index idx_tbl3_ctid on tbl3(ctid desc);</font></div><div><font size="2"   >create index idx_tbl4_ctid on tbl4(ctid desc);</font></div><div><font size="2"   >create index idx_tbl5_ctid on tbl5(ctid desc);</font></div><div><font size="2"   >create index idx_tbl6_ctid on tbl6(ctid desc);</font></div><div><font size="2"   >create index idx_tbl7_ctid on tbl7(ctid desc);</font></div><div><font size="2"   >create index idx_tbl8_ctid on tbl8(ctid desc);</font></div><div><font size="2"   >create index idx_tbl9_ctid on tbl9(ctid desc);</font></div><div><font size="2"   >create index idx_tbl10_ctid on tbl10(ctid desc);</font></div><div><font size="2"   >create index idx_tbl11_ctid on tbl11(ctid desc);</font></div><div><font size="2"   >create index idx_tbl12_ctid on tbl12(ctid desc);</font></div><div><font size="2"   >create index idx_tbl13_ctid on tbl13(ctid desc);</font></div><div><font size="2"   >create index idx_tbl14_ctid on tbl14(ctid desc);</font></div><div><font size="2"   >create index idx_tbl15_ctid on tbl15(ctid desc);</font></div><div><br></div><div><font size="2"   >postgres@localhost-&gt; ll tbl*.sql</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres 125 Jan 30 03:28 tbl0.sql</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres 127 Jan 30 03:32 tbl10.sql</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres 127 Jan 30 03:32 tbl11.sql</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres 127 Jan 30 03:32 tbl12.sql</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres 127 Jan 30 03:32 tbl13.sql</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres 127 Jan 30 03:33 tbl14.sql</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres 127 Jan 30 03:33 tbl15.sql</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres 125 Jan 30 03:29 tbl1.sql</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres 125 Jan 30 03:29 tbl2.sql</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres 125 Jan 30 03:32 tbl3.sql</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres 125 Jan 30 03:32 tbl4.sql</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres 125 Jan 30 03:32 tbl5.sql</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres 125 Jan 30 03:32 tbl6.sql</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres 125 Jan 30 03:32 tbl7.sql</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres 125 Jan 30 03:32 tbl8.sql</font></div><div><font size="2"   >-rw-rw-r-- 1 postgres postgres 125 Jan 30 03:32 tbl9.sql</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@localhost-&gt; cat tbl*.sql</font></div><div><font size="2"   >with t as(select ctid from tbl0 order by ctid desc limit 5) delete from tbl0 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >with t as(select ctid from tbl10 order by ctid desc limit 5) delete from tbl10 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >with t as(select ctid from tbl11 order by ctid desc limit 5) delete from tbl11 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >with t as(select ctid from tbl12 order by ctid desc limit 5) delete from tbl12 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >with t as(select ctid from tbl13 order by ctid desc limit 5) delete from tbl13 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >with t as(select ctid from tbl14 order by ctid desc limit 5) delete from tbl14 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >with t as(select ctid from tbl15 order by ctid desc limit 5) delete from tbl15 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >with t as(select ctid from tbl1 order by ctid desc limit 5) delete from tbl1 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >with t as(select ctid from tbl2 order by ctid desc limit 5) delete from tbl2 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >with t as(select ctid from tbl3 order by ctid desc limit 5) delete from tbl3 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >with t as(select ctid from tbl4 order by ctid desc limit 5) delete from tbl4 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >with t as(select ctid from tbl5 order by ctid desc limit 5) delete from tbl5 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >with t as(select ctid from tbl6 order by ctid desc limit 5) delete from tbl6 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >with t as(select ctid from tbl7 order by ctid desc limit 5) delete from tbl7 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >with t as(select ctid from tbl8 order by ctid desc limit 5) delete from tbl8 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >with t as(select ctid from tbl9 order by ctid desc limit 5) delete from tbl9 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@localhost-&gt; cat bench.sh&nbsp;</font></div><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./tbl0.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./tbl1.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./tbl2.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./tbl3.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./tbl4.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./tbl5.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./tbl6.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./tbl7.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./tbl8.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./tbl9.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./tbl10.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./tbl11.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./tbl12.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./tbl13.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./tbl14.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./tbl15.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@localhost-&gt; . ./bench.sh&nbsp;</font></div><div><font size="2"   >postgres@localhost-&gt; jobs</font></div><div><font size="2"   >[1] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -r -f ./tbl0.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >[2] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -r -f ./tbl1.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >[3] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -r -f ./tbl2.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >[4] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -r -f ./tbl3.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >[5] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -r -f ./tbl4.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >[6] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -r -f ./tbl5.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >[7] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -r -f ./tbl6.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >[8] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -r -f ./tbl7.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >[9] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -r -f ./tbl8.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >[10] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -r -f ./tbl9.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >[11] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -r -f ./tbl10.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >[12] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -r -f ./tbl11.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >[13] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -r -f ./tbl12.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >[14] &nbsp; Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -r -f ./tbl13.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >[15]- &nbsp;Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -r -f ./tbl14.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   >[16]+ &nbsp;Running &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgbench -M prepared -n -r -f ./tbl15.sql -c 1 -j 1 -T 30 &amp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@localhost-&gt; transaction type: Custom query</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 18323</font></div><div><font size="2"   >number of transactions actually processed: 18744</font></div><div><font size="2"   >tps = 610.744476 (including connections establishing)</font></div><div><font size="2"   >tps = 624.776154 (including connections establishing)</font></div><div><font size="2"   >tps = 610.882388 (excluding connections establishing)</font></div><div><font size="2"   >tps = 624.974076 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.635022 &nbsp; &nbsp; &nbsp; &nbsp;with t as(select ctid from tbl5 order by ctid desc limit 5) delete from tbl5 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.598122 &nbsp; &nbsp; &nbsp; &nbsp;with t as(select ctid from tbl0 order by ctid desc limit 5) delete from tbl0 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 18660</font></div><div><font size="2"   >tps = 621.969606 (including connections establishing)</font></div><div><font size="2"   >tps = 622.153610 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.605455 &nbsp; &nbsp; &nbsp; &nbsp;with t as(select ctid from tbl7 order by ctid desc limit 5) delete from tbl7 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 18625</font></div><div><font size="2"   >tps = 620.807135 (including connections establishing)</font></div><div><font size="2"   >tps = 621.057183 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.608170 &nbsp; &nbsp; &nbsp; &nbsp;with t as(select ctid from tbl3 order by ctid desc limit 5) delete from tbl3 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of transactions actually processed: 18679</font></div><div><font size="2"   >tps = 622.613140 (including connections establishing)</font></div><div><font size="2"   >tps = 622.763449 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.603809 &nbsp; &nbsp; &nbsp; &nbsp;with t as(select ctid from tbl4 order by ctid desc limit 5) delete from tbl4 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 18480</font></div><div><font size="2"   >tps = 615.974889 (including connections establishing)</font></div><div><font size="2"   >tps = 616.107203 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.621196 &nbsp; &nbsp; &nbsp; &nbsp;with t as(select ctid from tbl11 order by ctid desc limit 5) delete from tbl11 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 18521</font></div><div><font size="2"   >tps = 617.330182 (including connections establishing)</font></div><div><font size="2"   >tps = 617.443250 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.617626 &nbsp; &nbsp; &nbsp; &nbsp;with t as(select ctid from tbl10 order by ctid desc limit 5) delete from tbl10 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 18366</font></div><div><font size="2"   >tps = 612.146172 (including connections establishing)</font></div><div><font size="2"   >tps = 612.431254 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.631034 &nbsp; &nbsp; &nbsp; &nbsp;with t as(select ctid from tbl9 order by ctid desc limit 5) delete from tbl9 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 18738</font></div><div><font size="2"   >tps = 624.574018 (including connections establishing)</font></div><div><font size="2"   >tps = 624.715406 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.598772 &nbsp; &nbsp; &nbsp; &nbsp;with t as(select ctid from tbl6 order by ctid desc limit 5) delete from tbl6 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 18448</font></div><div><font size="2"   >tps = 614.888405 (including connections establishing)</font></div><div><font size="2"   >tps = 615.075231 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.623808 &nbsp; &nbsp; &nbsp; &nbsp;with t as(select ctid from tbl12 order by ctid desc limit 5) delete from tbl12 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 18875</font></div><div><font size="2"   >tps = 629.134497 (including connections establishing)</font></div><div><font size="2"   >tps = 629.315227 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.587065 &nbsp; &nbsp; &nbsp; &nbsp;with t as(select ctid from tbl2 order by ctid desc limit 5) delete from tbl2 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 18449</font></div><div><font size="2"   >tps = 614.934670 (including connections establishing)</font></div><div><font size="2"   >tps = 615.066184 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.623882 &nbsp; &nbsp; &nbsp; &nbsp;with t as(select ctid from tbl8 order by ctid desc limit 5) delete from tbl8 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 18633</font></div><div><font size="2"   >tps = 621.077579 (including connections establishing)</font></div><div><font size="2"   >tps = 621.244771 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.607780 &nbsp; &nbsp; &nbsp; &nbsp;with t as(select ctid from tbl13 order by ctid desc limit 5) delete from tbl13 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 18573</font></div><div><font size="2"   >tps = 619.008531 (including connections establishing)</font></div><div><font size="2"   >tps = 619.148479 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.613143 &nbsp; &nbsp; &nbsp; &nbsp;with t as(select ctid from tbl1 order by ctid desc limit 5) delete from tbl1 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 18717</font></div><div><font size="2"   >tps = 623.839093 (including connections establishing)</font></div><div><font size="2"   >tps = 623.982969 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.600710 &nbsp; &nbsp; &nbsp; &nbsp;with t as(select ctid from tbl14 order by ctid desc limit 5) delete from tbl14 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 18710</font></div><div><font size="2"   >tps = 623.627170 (including connections establishing)</font></div><div><font size="2"   >tps = 623.762851 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.601275 &nbsp; &nbsp; &nbsp; &nbsp;with t as(select ctid from tbl15 order by ctid desc limit 5) delete from tbl15 where ctid in (select ctid from t) returning *;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >TPS可以达到将近1W.</font></div><div><font size="2"   >postgres=# select 623*16;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;9968</font></div><div><font size="2"   >(1 row)</font></div><div></div><p></p></pre></div><div>为了达到更好的吞吐量, 建议程序一次多取一些, 例如一次取20条, 用完再来取, 那么可以减少和数据库的交互次数, 提高整体性能.</div></div><div><br></div><div><span style="line-height: 28px;"   >&nbsp;</span><a style="line-height: 28px;" rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="fast random data query  delete use ctid in postgresql - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div></div>
	</div>
</div>
</body>
</html>