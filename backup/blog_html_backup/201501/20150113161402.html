<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">ZFS case : top CPU 100%sy, when no free memory trigger it.</h2>
	<h5 id="">2015-01-13 16:14:02&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201501210550312/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><span style="line-height: 28px;"   >最近在一个系统频频遇到负载突然飙升到几百, 然后又下去的情况.</span></div><div>根据负载升高的时间点对应的数据库日志分析, 对应的时间点, 有大量的类似如下的日志 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >"UPDATE waiting",2015-01-09 01:38:47 CST,979/7,2927976054,LOG,00000,"process 26366 still waiting for ExclusiveLock on extension of relation 686062002 of database 35078604 after 1117.676 ms",,,,,,"</font></div><div><div><font size="2"   >"INSERT waiting",2015-01-09 01:38:36 CST,541/8,2927976307,LOG,00000,"process 25936 still waiting for ExclusiveLock on extension of relation 686062002 of database 35078604 after 1219.762 ms",,,,,,"</font></div><div><font size="2"   >"INSERT waiting",2015-01-09 01:38:48 CST,1018/64892,2929458056,LOG,00000,"process 26439 still waiting for ExclusiveLock on extension of relation 686061993 of database 35078604 after 1000.105 ms",</font></div><div><font size="2"   >.........</font></div></div><p></p></pre></div><div><div>对应几个对象的块扩展等待</div><div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >select 686062002::regclass;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; regclass &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >-----------------------------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;pg_toast.pg_toast_686061993</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >select relname from pg_class where reltoastrelid=686062002;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >-------------------------------------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;tbl_xxx_20150109</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div><div style="line-height: 28px;"   ><font size="2"   >Time: 4.643 ms</font></div></div><p></p></pre></div></div></div><div><br></div><div>同时系统的dmesg还伴随 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres: page allocation failure. order:1, mode:0x20</font></div><div><font size="2"   >Pid: 20427, comm: postgres Tainted: P &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --------------- &nbsp; &nbsp;2.6.32-504.el6.x86_64 #1</font></div><div><font size="2"   >Call Trace:</font></div><div><font size="2"   >&nbsp;&lt;IRQ&gt; &nbsp;[&lt;ffffffff8113438a&gt;] ? __alloc_pages_nodemask+0x74a/0x8d0</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff810eaa90&gt;] ? handle_IRQ_event+0x60/0x170</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff81173332&gt;] ? kmem_getpages+0x62/0x170</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff81173f4a&gt;] ? fallback_alloc+0x1ba/0x270</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8117399f&gt;] ? cache_grow+0x2cf/0x320</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff81173cc9&gt;] ? ____cache_alloc_node+0x99/0x160</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff81174c4b&gt;] ? kmem_cache_alloc+0x11b/0x190</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8144c768&gt;] ? sk_prot_alloc+0x48/0x1c0</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8144d992&gt;] ? sk_clone+0x22/0x2e0</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff814a1b76&gt;] ? inet_csk_clone+0x16/0xd0</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff814bb713&gt;] ? tcp_create_openreq_child+0x23/0x470</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff814b8ecd&gt;] ? tcp_v4_syn_recv_sock+0x4d/0x310</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff814bb4b6&gt;] ? tcp_check_req+0x226/0x460</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff814b890b&gt;] ? tcp_v4_do_rcv+0x35b/0x490</font></div><div><font size="2"   >&nbsp;[&lt;ffffffffa0207557&gt;] ? ipv4_confirm+0x87/0x1d0 [nf_conntrack_ipv4]</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff814ba1a2&gt;] ? tcp_v4_rcv+0x522/0x900</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff81496d10&gt;] ? ip_local_deliver_finish+0x0/0x2d0</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff81496ded&gt;] ? ip_local_deliver_finish+0xdd/0x2d0</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff81497078&gt;] ? ip_local_deliver+0x98/0xa0</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8149653d&gt;] ? ip_rcv_finish+0x12d/0x440</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff81496ac5&gt;] ? ip_rcv+0x275/0x350</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8145c88b&gt;] ? __netif_receive_skb+0x4ab/0x750</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff81460588&gt;] ? netif_receive_skb+0x58/0x60</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff81460690&gt;] ? napi_skb_finish+0x50/0x70</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff81461f69&gt;] ? napi_gro_receive+0x39/0x50</font></div><div><font size="2"   >&nbsp;[&lt;ffffffffa01a7d91&gt;] ? igb_poll+0x981/0x1010 [igb]</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff814b59c0&gt;] ? tcp_delack_timer+0x0/0x270</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff814b3af9&gt;] ? tcp_send_ack+0xd9/0x120</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff81462083&gt;] ? net_rx_action+0x103/0x2f0</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8107d8b1&gt;] ? __do_softirq+0xc1/0x1e0</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff810eaa90&gt;] ? handle_IRQ_event+0x60/0x170</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8107d90f&gt;] ? __do_softirq+0x11f/0x1e0</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8100c30c&gt;] ? call_softirq+0x1c/0x30</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8100fc15&gt;] ? do_softirq+0x65/0xa0</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8107d765&gt;] ? irq_exit+0x85/0x90</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff81533b45&gt;] ? do_IRQ+0x75/0xf0</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8100b9d3&gt;] ? ret_from_intr+0x0/0x11</font></div><div><font size="2"   >&nbsp;&lt;EOI&gt; &nbsp;[&lt;ffffffff8116f5f9&gt;] ? compaction_alloc+0x269/0x4b0</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8116f552&gt;] ? compaction_alloc+0x1c2/0x4b0</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff811799fa&gt;] ? migrate_pages+0xaa/0x480</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8100b9ce&gt;] ? common_interrupt+0xe/0x13</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8116f390&gt;] ? compaction_alloc+0x0/0x4b0</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8116e9ea&gt;] ? compact_zone+0x61a/0xba0</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8116f01c&gt;] ? compact_zone_order+0xac/0x100</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8116f151&gt;] ? try_to_compact_pages+0xe1/0x120</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff81133b6a&gt;] ? __alloc_pages_direct_compact+0xda/0x1b0</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff81134055&gt;] ? __alloc_pages_nodemask+0x415/0x8d0</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8116c79a&gt;] ? alloc_pages_vma+0x9a/0x150</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8118845d&gt;] ? do_huge_pmd_anonymous_page+0x14d/0x3b0</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8114fdb0&gt;] ? handle_mm_fault+0x2f0/0x300</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8104d0d8&gt;] ? __do_page_fault+0x138/0x480</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8152ae5e&gt;] ? mutex_lock+0x1e/0x50</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8152ffbe&gt;] ? do_page_fault+0x3e/0xa0</font></div><div><font size="2"   >&nbsp;[&lt;ffffffff8152d375&gt;] ? page_fault+0x25/0x30</font></div><p></p></pre></div><div><br></div></div><div style="line-height: 28px; font-size: 16px;"   >这是个日志表, 有4个索引, 其中一个变长字段存储的值较长(因此有用到TOAST存储), 例如</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >DxxxxxxxxxxxxzwLlyyDd7xGd7^7xxwLDxyD@5xHB7^if5^vv4&amp;DJCEL7xxxCFyhsxxxd4x~j2%$BB%ChkzHlzzvxBwqn5^DDCFexzwC@zyLDz</font></div><div style="line-height: 28px;"   ><font size="2"   >zC~zyDDzyCbAyyh3M~v5^DDCHvBBy%j0%iL4^fJB%K1xxxB%G1wz~h2M%B4%qn5&amp;7xxwyPs!$xJ!Dd7xCb3^DFCGLnzyzlzyP7zyCJ7x)Lx^xxxxxxxy73$rLB&amp;DND</font></div><div style="line-height: 28px;"   ><font size="2"   >zL5zy~xxyCt4xPj4%DJCE~DzyP#zyLPzyypxxx3&amp;~DB^P1zzC5zye5wzz10MCb3^Gp4^DLCEiNywi$yzvxBwL73&amp;$F7%7xzwG5zyy5wyah4MbzB%C1DzL9zyf5yyG9z</font></div><div style="line-height: 28px;"   ><font size="2"   >y!1zyLJxyCt4xPP5%nLB&amp;xxxx</font></div><div style="line-height: 28px;"   ><font size="2"   >&amp;7xxwjHzzi#yyi$yzi$yzmHIPm^K@CbAzzh5MDBCGLxxxxwz~h5M$JB%DxDzGlzyH5zyL7zzylzyC9AyLxxx7xxwC5AyzNxxxxxx5%Pp0</font></div><div style="line-height: 28px;"   ><font size="2"   >^~d0&amp;6NzwK1wyzN1M%xxxx^P74^DJCGD7yyvBByiF4&amp;Pt0%~d0&amp;6hwwvDByiF4&amp;et5xxxxxx17%$$1^DBCFGfwxzh2M!j1%qv5^DLCF!NzyH5zzvJBy%h4</font></div><div style="line-height: 28px;"   ><font size="2"   >%aD4&amp;%v4^61zwDnyyK5wyzN0Mxxxx5$71zwCd7xCv0&amp;fj5&amp;(h1%yNc%mf7%71zwxxx%a@4%rpd^a5d$71zwCt5x!l1$~^l^LDx&amp;K1wzmh5MxxxxxxxxxxGr4&amp;Dvd&amp;$jl</font></div><div style="line-height: 28px;"   ><font size="2"   >%LBx%K1wzPh5M$Ll^yn1&amp;Ht6+fxxxxxxwC@5xqnxxx&amp;~90^fj5+Oh5%71zwDJ7xH~j&amp;yDh$G@5^7xxxx^Gp4@DLCEf1yw7b0~bn0^%^i&amp;HDzyebz</font></div><div style="line-height: 28px;"   ><font size="2"   >y6)zyLBzyfdyyvxBwH#5%GP5^nvd&amp;$LB^DN5zqHA^%P1^nLlEDL5%$@n^i#4^$J7%nPn+bzF@Ct4xD~1&amp;GB4^add%7xxw!7zybBxyC@5xqn5xxxxx!DLCEvBxxxd6&amp;!vL@7xx</font></div><div style="line-height: 28px;"   ><font size="2"   >w)dyECn5&amp;)B1zxxxxxOz)D&amp;HND&amp;C9DOOl1yzpD&amp;xxxxxx1^6hzwLrzyf3zxxx&amp;L73+Gp4@DLCEiNywi$yzvxBw$h5%Hdf&amp;(l9%zh0%nHB^D1zz~7zyvzB</font></div><div style="line-height: 28px;"   ><font size="2"   >yHl6%jl4!!Fg^rLB%DhDzC5xxxxb7j&amp;aH4^)txxxDzvxBw$v0%DJCEzNxxxxzyzr1y~Lzx(vA&amp;(@zyrtCyy5DxxxHl5OHbDO$3DxxxyyN0MD~1%afd&amp;71z</font></div><div style="line-height: 28px;"   ><font size="2"   >wDd7xj17xxxxx$)7^7N2wq8*=</font></div><p></p></pre></div><div style="font-size: 16px; line-height: 28px;"   ><span style="line-height: 28px;"   >每天会新建一个表, 因此不停的在做数据块的扩展, 但是理论上扩展是比较快的, 不会导致以上情况的发生, 而且发生问题的时间点, 数据量, 并发量也正常.</span></div></div><div><br></div><div><div style="line-height: 28px;"   >关于这个等待的情况, 可以参考之前写过一篇文章, 关于批量导入遇到的extend lock等待的性能问题.</div><div style="line-height: 28px;"   ><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201392641033482"   >http://blog.163.com/digoal@126/blog/static/163877040201392641033482</a></div></div><div style="line-height: 28px;"   >和本文 性能的 case 无关.</div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >看样子是ZFS的问题, 最后排查发现.&nbsp;</div><div style="line-height: 28px;"   >free的内存在不停的减少, 当减少到0的时候, 负载就会马上飙升.&nbsp;</div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >环境 :&nbsp;</div><div style="line-height: 28px;"   >CentOS 6.x x64</div><div>2.6.32-504.el6.x86_64</div><div><br></div><div>zfs 版本</div><div><div>zfs-0.6.3-1.1.el6.x86_64</div><div>libzfs2-0.6.3-1.1.el6.x86_64</div><div>zfs-dkms-0.6.3-1.1.el6.noarch</div></div><div><br></div><div>服务器内存 384G</div><div><br></div><div>数据库shared buffer 20GB,&nbsp;maintenance_work_mem=2G,&nbsp;autovacuum_max_workers=6&nbsp;</div><div>不算work_MEM的话, 数据库最多可能占用32G内存.&nbsp;</div><div>还有300多G可以给系统和ZFS使用.</div><div><br></div><div>zfs 参数如下</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd&nbsp;/sys/module/zfs/parameters</font></div><div><div><font size="2"   ># grep '' *|sort&nbsp;</font></div><div><font size="2"   >l2arc_feed_again:1</font></div><div><font size="2"   >l2arc_feed_min_ms:200</font></div><div><font size="2"   >l2arc_feed_secs:1</font></div><div><font size="2"   >l2arc_headroom:2</font></div><div><font size="2"   >l2arc_headroom_boost:200</font></div><div><font size="2"   >l2arc_nocompress:0</font></div><div><font size="2"   >l2arc_noprefetch:1</font></div><div><font size="2"   >l2arc_norw:0</font></div><div><font size="2"   >l2arc_write_boost:8388608</font></div><div><font size="2"   >l2arc_write_max:8388608</font></div><div><font size="2"   >metaslab_debug_load:0</font></div><div><font size="2"   >metaslab_debug_unload:0</font></div><div><font size="2"   >spa_asize_inflation:24</font></div><div><font size="2"   >spa_config_path:/etc/zfs/zpool.cache</font></div><div><font size="2"   >zfetch_array_rd_sz:1048576</font></div><div><font size="2"   >zfetch_block_cap:256</font></div><div><font size="2"   >zfetch_max_streams:8</font></div><div><font size="2"   >zfetch_min_sec_reap:2</font></div><div><font size="2"   >zfs_arc_grow_retry:5</font></div><div><font size="2"   >zfs_arc_max:10240000000</font></div><div><font size="2"   >zfs_arc_memory_throttle_disable:1</font></div><div><font size="2"   >zfs_arc_meta_limit:0</font></div><div><font size="2"   >zfs_arc_meta_prune:1048576</font></div><div><font size="2"   >zfs_arc_min:0</font></div><div><font size="2"   >zfs_arc_min_prefetch_lifespan:1000</font></div><div><font size="2"   >zfs_arc_p_aggressive_disable:1</font></div><div><font size="2"   >zfs_arc_p_dampener_disable:1</font></div><div><font size="2"   >zfs_arc_shrink_shift:5</font></div><div><font size="2"   >zfs_autoimport_disable:0</font></div><div><font size="2"   >zfs_dbuf_state_index:0</font></div><div><font size="2"   >zfs_deadman_enabled:1</font></div><div><font size="2"   >zfs_deadman_synctime_ms:1000000</font></div><div><font size="2"   >zfs_dedup_prefetch:1</font></div><div><font size="2"   >zfs_delay_min_dirty_percent:60</font></div><div><font size="2"   >zfs_delay_scale:500000</font></div><div><font size="2"   >zfs_dirty_data_max:10240000000</font></div><div><font size="2"   >zfs_dirty_data_max_max:101595342848</font></div><div><font size="2"   >zfs_dirty_data_max_max_percent:25</font></div><div><font size="2"   >zfs_dirty_data_max_percent:10</font></div><div><font size="2"   >zfs_dirty_data_sync:67108864</font></div><div><font size="2"   >zfs_disable_dup_eviction:0</font></div><div><font size="2"   >zfs_expire_snapshot:300</font></div><div><font size="2"   >zfs_flags:1</font></div><div><font size="2"   >zfs_free_min_time_ms:1000</font></div><div><font size="2"   >zfs_immediate_write_sz:32768</font></div><div><font size="2"   >zfs_mdcomp_disable:0</font></div><div><font size="2"   >zfs_nocacheflush:0</font></div><div><font size="2"   >zfs_nopwrite_enabled:1</font></div><div><font size="2"   >zfs_no_scrub_io:0</font></div><div><font size="2"   >zfs_no_scrub_prefetch:0</font></div><div><font size="2"   >zfs_pd_blks_max:100</font></div><div><font size="2"   >zfs_prefetch_disable:0</font></div><div><font size="2"   >zfs_read_chunk_size:1048576</font></div><div><font size="2"   >zfs_read_history:0</font></div><div><font size="2"   >zfs_read_history_hits:0</font></div><div><font size="2"   >zfs_recover:0</font></div><div><font size="2"   >zfs_resilver_delay:2</font></div><div><font size="2"   >zfs_resilver_min_time_ms:3000</font></div><div><font size="2"   >zfs_scan_idle:50</font></div><div><font size="2"   >zfs_scan_min_time_ms:1000</font></div><div><font size="2"   >zfs_scrub_delay:4</font></div><div><font size="2"   >zfs_send_corrupt_data:0</font></div><div><font size="2"   >zfs_sync_pass_deferred_free:2</font></div><div><font size="2"   >zfs_sync_pass_dont_compress:5</font></div><div><font size="2"   >zfs_sync_pass_rewrite:2</font></div><div><font size="2"   >zfs_top_maxinflight:32</font></div><div><font size="2"   >zfs_txg_history:0</font></div><div><font size="2"   >zfs_txg_timeout:5</font></div><div><font size="2"   >zfs_vdev_aggregation_limit:131072</font></div><div><font size="2"   >zfs_vdev_async_read_max_active:3</font></div><div><font size="2"   >zfs_vdev_async_read_min_active:1</font></div><div><font size="2"   >zfs_vdev_async_write_active_max_dirty_percent:60</font></div><div><font size="2"   >zfs_vdev_async_write_active_min_dirty_percent:30</font></div><div><font size="2"   >zfs_vdev_async_write_max_active:10</font></div><div><font size="2"   >zfs_vdev_async_write_min_active:1</font></div><div><font size="2"   >zfs_vdev_cache_bshift:16</font></div><div><font size="2"   >zfs_vdev_cache_max:16384</font></div><div><font size="2"   >zfs_vdev_cache_size:0</font></div><div><font size="2"   >zfs_vdev_max_active:1000</font></div><div><font size="2"   >zfs_vdev_mirror_switch_us:10000</font></div><div><font size="2"   >zfs_vdev_read_gap_limit:32768</font></div><div><font size="2"   >zfs_vdev_scheduler:noop</font></div><div><font size="2"   >zfs_vdev_scrub_max_active:2</font></div><div><font size="2"   >zfs_vdev_scrub_min_active:1</font></div><div><font size="2"   >zfs_vdev_sync_read_max_active:10</font></div><div><font size="2"   >zfs_vdev_sync_read_min_active:10</font></div><div><font size="2"   >zfs_vdev_sync_write_max_active:10</font></div><div><font size="2"   >zfs_vdev_sync_write_min_active:10</font></div><div><font size="2"   >zfs_vdev_write_gap_limit:4096</font></div><div><font size="2"   >zfs_zevent_cols:80</font></div><div><font size="2"   >zfs_zevent_console:0</font></div><div><font size="2"   >zfs_zevent_len_max:768</font></div><div><font size="2"   >zil_replay_disable:0</font></div><div><font size="2"   >zil_slog_limit:1048576</font></div><div><font size="2"   >zio_bulk_flags:0</font></div><div><font size="2"   >zio_delay_max:30000</font></div><div><font size="2"   >zio_injection_enabled:0</font></div><div><font size="2"   >zio_requeue_io_start_cut_in_line:1</font></div><div><font size="2"   >zvol_inhibit_dev:0</font></div><div><font size="2"   >zvol_major:230</font></div><div><font size="2"   >zvol_max_discard_blocks:16384</font></div><div><font size="2"   >zvol_threads:32</font></div></div><p></p></pre></div><div>这些参数的介绍可参考 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >man /usr/share/man/man5/zfs-module-parameters.5.gz</font></div><div></div><p></p></pre></div><div style="line-height: 28px;"   >zpool参数</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   ># zpool get all zp1</font></div><div style="line-height: 28px;"   ><font size="2"   >NAME &nbsp;PROPERTY &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; VALUE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SOURCE</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 40T &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; capacity &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2% &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; altroot &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; health &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; guid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 15254203672861282738 &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; version &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; bootfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; delegation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; autoreplace &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; cachefile &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; failmode &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wait &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; listsnapshots &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; autoexpand &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; dedupditto &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; dedupratio &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1.00x &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; free &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 39.0T &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; allocated &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;995G &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; readonly &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; ashift &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 12 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; local</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; comment &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; expandsize &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; freeing &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; feature@async_destroy &nbsp;enabled &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;local</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; feature@empty_bpobj &nbsp; &nbsp;active &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; local</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1 &nbsp; feature@lz4_compress &nbsp; active &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; local</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div></div><div style="line-height: 28px;"   >zfs参数</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   ># zfs get all zp1/data_a0</font></div><div style="line-height: 28px;"   ><font size="2"   >NAME &nbsp; &nbsp; &nbsp; &nbsp; PROPERTY &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;VALUE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SOURCE</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;filesystem &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;creation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Thu Dec 18 10:30 2014 &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;used &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;98.8G &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;available &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 34.1T &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;referenced &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;98.8G &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;compressratio &nbsp; &nbsp; &nbsp; &nbsp; 1.00x &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;mounted &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;quota &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;reservation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;recordsize &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;128K &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;mountpoint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/data_a0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; local</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;sharenfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;checksum &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;compression &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;local</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;atime &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;inherited from zp1</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;devices &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;exec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;setuid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;readonly &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;zoned &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;snapdir &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hidden &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;aclinherit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;restricted &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;canmount &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;xattr &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sa &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; local</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;copies &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;version &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;utf8only &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;normalization &nbsp; &nbsp; &nbsp; &nbsp; none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;casesensitivity &nbsp; &nbsp; &nbsp; sensitive &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;vscan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;nbmand &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;sharesmb &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;refquota &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;refreservation &nbsp; &nbsp; &nbsp; &nbsp;none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;primarycache &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;metadata &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; local</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;secondarycache &nbsp; &nbsp; &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;local</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;usedbysnapshots &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;usedbydataset &nbsp; &nbsp; &nbsp; &nbsp; 98.8G &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;usedbychildren &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;usedbyrefreservation &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;logbias &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; latency &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;dedup &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;mlslabel &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;sync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;standard &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;refcompressratio &nbsp; &nbsp; &nbsp;1.00x &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;written &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 98.8G &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;logicalused &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 98.7G &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;logicalreferenced &nbsp; &nbsp; 98.7G &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;snapdev &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hidden &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;acltype &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;context &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;fscontext &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;defcontext &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;rootcontext &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div style="line-height: 28px;"   ><font size="2"   >zp1/data_a0 &nbsp;relatime &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><p></p></pre></div></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >解决问题可能要从 arc入手 :&nbsp;</div><div style="line-height: 28px;"   >ARC原理参考</div><div><a target="_blank" rel="nofollow" href="https://pthree.org/2012/12/07/zfs-administration-part-iv-the-adjustable-replacement-cache/"   >https://pthree.org/2012/12/07/zfs-administration-part-iv-the-adjustable-replacement-cache/</a></div><div>man&nbsp;zfs-module-parameters</div><div>arc 优化案例</div><div><a target="_blank" rel="nofollow" href="http://dtrace.org/blogs/brendan/2014/02/11/another-10-performance-wins/"   >http://dtrace.org/blogs/brendan/2014/02/11/another-10-performance-wins/</a></div><div><a target="_blank" rel="nofollow" href="https://www.cupfighter.net/2013/03/default-nexenta-zfs-settings-you-want-to-change-part-2"   >https://www.cupfighter.net/2013/03/default-nexenta-zfs-settings-you-want-to-change-part-2</a></div><div>在大内存下建议调整<span style="line-height: 28px;"   >ARC shrink shift (降到每次100M左右)</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;zfs_arc_shrink_shift (int)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;log2(fraction of arc to reclaim)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Default value: 5.</font></div><p></p></pre></div><div>默认是5, 也就是1/32 , 如果内存有384G, 将达到12GB, 一次shrink 12GB arc的话, 要hang很久的.</div><div>建议降低到100MB左右, 那么可以设置<span style="line-height: 28px;"   >zfs_arc_shrink_shift</span><span style="line-height: 28px;"   >&nbsp;=11, 也就是1/2048, 相当于187.5MB</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >Description: Semi-regular spikes in I/O latency on an SSD postgres server.</font></div><div><font size="2"   >Analysis: The customer reported multi-second I/O latency for a server with flash memory-based solid state disks (SSDs). Since this SSD type was new in production, it was feared that there may be a new drive or firmware problem causing high latency. ZFS latency counters, measured at the VFS interface, confirmed that I/O latency was dismal, sometimes reaching 10 seconds for I/O. The DTrace-based iosnoop tool (DTraceToolkit) was used to trace at the block device level, however, no seriously slow I/O was observed from the SSDs. I plotted the iosnoop traces using R for evidence of queueing behind TXG flushes, but they didn’t support that theory either.</font></div><div><font size="2"   >This was difficult to investigate since the slow I/O was intermittent, sometimes only occurring once per hour. Instead of a typical interactive investigation, I developed various ways to log activity from DTrace and kstats, so that clues for the issue could be examined afterwards from the logs. This included capturing which processes were executed using execsnoop, and dumping ZFS metrics from kstat, including arcstats. This showed that various maintenance processes were executing during the hour, and, the ZFS ARC, which was around 210 Gbytes, would sometimes drop by around 6 Gbytes. Having worked performance issues with shrinking ARCs before, I developed a DTrace script to trace ARC reaping along with process execution, and found that it was a match with a cp(1) command. This was part of the maintenance task, which was copying a 30 Gbyte file, hitting the ARC limit and triggering an ARC shrink. Shrinking involves holding ARC hash locks, which can cause latency, especially when shrinking 6 Gbytes worth of buffers. The zfs:zfs_arc_shrink_shift tunable was adjusted to reduce the shrink size, which also made them more frequent. The worst-case I/O improved from 10s to 100ms.</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >ARC shrink shift</font></div><div><font size="2"   >Every second a process runs which checks if data can be removed from the ARC and evicts it. Default max 1/32nd of the ARC can be evicted at a time. This is limited because evicting large amounts of data from ARC stalls all other processes. Back when 8GB was a lot of memory 1/32nd meant 256MB max at a time. When you have 196GB of memory 1/32nd is 6.3GB, which can cause up to 20-30 seconds of unresponsiveness (depending on the record size).</font></div><div><font size="2"   >This 1/32nd needs to be changed to make sure the max is set to ~100-200MB again, by adding the following to /etc/system:</font></div><div><font size="2"   >set zfs:zfs_arc_shrink_shift=11</font></div><div><font size="2"   >(where 11 is 1/2 11 or 1/2048th, 10 is &nbsp;1/2 10 or 1/1024th etc. Change depending on amount of RAM in your system).</font></div></div><p></p></pre></div><div><br></div><div>结合ARC原理还有异步dirty write delay的情况, 优化如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;zfs_vdev_async_write_active_min_dirty_percent (int)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;When &nbsp;the &nbsp;pool &nbsp;has &nbsp;less &nbsp;than &nbsp;zfs_vdev_async_write_active_min_dirty_percent &nbsp;dirty &nbsp;data, &nbsp; use</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;zfs_vdev_async_write_min_active to limit active async writes. &nbsp;If the dirty data is between min and</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;max, the active I/O limit is linearly interpolated. See the section "ZFS I/O SCHEDULER".</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Default value: 30.</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;zfs_vdev_async_write_active_max_dirty_percent (int)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;When &nbsp;the &nbsp;pool &nbsp;has &nbsp;more &nbsp;than &nbsp;zfs_vdev_async_write_active_max_dirty_percent &nbsp;dirty &nbsp;data, &nbsp; use</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;zfs_vdev_async_write_max_active to limit active async writes. &nbsp;If the dirty data is between min and</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;max, the active I/O limit is linearly interpolated. See the section "ZFS I/O SCHEDULER".</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Default value: 60.</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;zfs_vdev_async_write_max_active (int)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Maxium asynchronous write I/Os active to each device. &nbsp;See the section "ZFS I/O SCHEDULER".</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Default value: 10.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;zfs_vdev_async_write_min_active (int)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Minimum asynchronous write I/Os active to each device. &nbsp;See the section "ZFS I/O SCHEDULER".</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Default value: 1.</font></div></div><p></p></pre></div><div>这幅图表示异步dirty write的提速和限速情况, 降低zfs_vdev_async_write_active_min_dirty_percent可以使最小限速区间变小,</div><div>降低zfs_vdev_async_write_active_max_dirty_percent可以使最大限速提早, 从而提高脏数据的flush速度.&nbsp;</div><div>但是可能影响同步写的IO争抢.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;o---------| &lt;-- zfs_vdev_async_write_max_active</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^ &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /^ &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/ | &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;active | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; / &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; I/O &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/ &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;count &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; / &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;/ &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |-------o &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; | &lt;-- zfs_vdev_async_write_min_active</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0|_______^______|_________|</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0% &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 100% of zfs_dirty_data_max</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;‘-- zfs_vdev_async_write_active_max_dirty_percent</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ‘--------- zfs_vdev_async_write_active_min_dirty_percent</font></div><p></p></pre></div><div>另一方面, 我们需要设置arc max, 注意不是dirty arc max</div><div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >因为数据库也占用了大部分内存, ZFS ARC不限制的话就无节制了.</span></div><div style="line-height: 28px;"   >有文章指出将ARC限制到总内存的40% . (总内存有384GB, PostgreSQL shared buffer用掉 20GB)</div><div style="line-height: 28px;"   ><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201462204333503"   >http://blog.163.com/digoal@126/blog/static/163877040201462204333503</a></div></div><div>到底设置为多少呢 ?</div><div><br></div><div>查看当前情况, 数据库已经开启,&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># free</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;total &nbsp; &nbsp; &nbsp; used &nbsp; &nbsp; &nbsp; free &nbsp; &nbsp; shared &nbsp; &nbsp;buffers &nbsp; &nbsp; cached</font></div><div><font size="2"   >Mem: &nbsp; &nbsp; 396856808 &nbsp;228812456 &nbsp;168044352 &nbsp; 21633868 &nbsp; &nbsp; &nbsp;58744 &nbsp; 45380060</font></div><p></p></pre></div><div>系统有168GB空闲内存</div><div>ARC已使用约20GB内存</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># cat /proc/spl/kstat/zfs/arcstats |grep size</font></div><div><font size="2"   >size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;19751851104</font></div><p></p></pre></div><div>那么, 在当前空闲内存的情形下我再留48GB给系统和数据库的话, ZFS还有120GB可用.</div><div>加上已用的20G, ZFS可以用140G.</div><div>把arc max设置到140GB &nbsp;(差不多是总内存的40%)</div><pre class="prettyprint"   ><p></p><div><font size="2"   ># echo 140000000000 &gt; /sys/module/zfs/parameters/zfs_arc_max</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >接下来设置一下dirty相关的参数</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >zfs_dirty_data_max 降到 arc max 的 1/5 =&nbsp;28000000000&nbsp;(可动态调整)</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >异步写的加速参数调整</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >zfs_vdev_async_write_active_min_dirty_percent=10</font></div><div><font size="2"   >zfs_vdev_async_write_active_max_dirty_percent=30 &nbsp;(务必小于<span style="line-height: 28px;"   >zfs_delay_min_dirty_percent</span><span style="line-height: 28px;"   >)</span></font></div><div><font size="2"   >zfs_delay_min_dirty_percent=60</font></div><p></p></pre></div><div><br></div><div>动态调整后, 建议设置启动模块参数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># cd /sys/module/zfs/parameters/</font></div><div><div><font size="2"   ># echo 140000000000 &gt;zfs_arc_max</font></div><div><font size="2"   ># echo 28000000000 &gt;zfs_dirty_data_max</font></div><div><font size="2"   ># echo 10 &gt; zfs_vdev_async_write_active_min_dirty_percent</font></div><div><font size="2"   ># echo 30 &gt; zfs_vdev_async_write_active_max_dirty_percent</font></div><div><font size="2"   ># echo 60 &gt; zfs_delay_min_dirty_percent</font></div><div><font size="2"   ># echo 11 &gt; zfs_arc_shrink_shift</font></div></div><p></p></pre></div><div>zfs模块启动参数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># vi&nbsp;/etc/modprobe.d/zfs.conf</font></div><div><font size="2"   >options zfs zfs_arc_max=<span style="line-height: 28px;"   >140000000000</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   >options zfs&nbsp;</span><span style="line-height: 28px;"   >zfs_dirty_data_max</span><span style="line-height: 28px;"   >=</span><span style="line-height: 28px;"   >28000000000</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   >options zfs&nbsp;</span><span style="line-height: 28px;"   >zfs_vdev_async_write_active_min_dirty_percent</span><span style="line-height: 28px;"   >=</span><span style="line-height: 28px;"   >10</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   >options zfs&nbsp;</span><span style="line-height: 28px;"   >zfs_vdev_async_write_active_max_dirty_percent</span><span style="line-height: 28px;"   >=3</span><span style="line-height: 28px;"   >0</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   >options zfs&nbsp;</span><span style="line-height: 28px;"   >zfs_delay_min_dirty_percent=60</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   >options zfs&nbsp;</span><span style="line-height: 28px;"   >zfs_arc_shrink_shift=11</span></font></div><p></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >观察期.....</span></div><div><span style="line-height: 28px;"   >还是一个样子, 内存会用光, 然后一样CPU暴增.</span></div><div><span style="line-height: 28px;"   >但是进程的内存消耗是正常的,</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># ps -e --width=1024 -o pid,%mem,rss,size,sz,vsz,cmd --sort rss</font></div><div><div><font size="2"   >rss &nbsp; &nbsp; &nbsp; &nbsp;RSS &nbsp; &nbsp; &nbsp;resident set size, the non-swapped physical memory that a task has used (in kiloBytes).</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (alias rssize, rsz).</font></div></div><div><div><font size="2"   >size &nbsp; &nbsp; &nbsp; SZ &nbsp; &nbsp; &nbsp; approximate amount of swap space that would be required if the process were to dirty all writable</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pages and then be swapped out. This number is very rough!</font></div></div><div><div><font size="2"   >sz &nbsp; &nbsp; &nbsp; &nbsp; SZ &nbsp; &nbsp; &nbsp; size in physical pages of the core image of the process. This includes text, data, and stack</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; space. Device mappings are currently excluded; this is subject to change. See vsz and rss.</font></div></div><div><div><font size="2"   >vsz &nbsp; &nbsp; &nbsp; &nbsp;VSZ &nbsp; &nbsp; &nbsp;virtual memory size of the process in KiB (1024-byte units). Device mappings are currently</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; excluded; this is subject to change. (alias vsize).</font></div></div><p></p></pre></div><div><br></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >06:10:01 AM kbmemfree kbmemused &nbsp;%memused kbbuffers &nbsp;kbcached &nbsp;kbcommit &nbsp; %commit</font></div><div><font size="2"   >06:20:01 AM 219447748 177409060 &nbsp; &nbsp; 44.70 &nbsp; &nbsp; 23196 &nbsp;22965260 &nbsp;27351828 &nbsp; &nbsp; &nbsp;6.75</font></div><div><font size="2"   >06:30:01 AM 219304016 177552792 &nbsp; &nbsp; 44.74 &nbsp; &nbsp; 24628 &nbsp;23080756 &nbsp;27348820 &nbsp; &nbsp; &nbsp;6.75</font></div><div><font size="2"   >06:40:01 AM 218698000 178158808 &nbsp; &nbsp; 44.89 &nbsp; &nbsp; 26276 &nbsp;23638736 &nbsp;27365764 &nbsp; &nbsp; &nbsp;6.75</font></div><div><font size="2"   >06:50:01 AM 218454732 178402076 &nbsp; &nbsp; 44.95 &nbsp; &nbsp; 27588 &nbsp;23852552 &nbsp;27365664 &nbsp; &nbsp; &nbsp;6.75</font></div><div><font size="2"   >07:00:01 AM 218211060 178645748 &nbsp; &nbsp; 45.02 &nbsp; &nbsp; 28840 &nbsp;24066384 &nbsp;27365736 &nbsp; &nbsp; &nbsp;6.75</font></div><div><font size="2"   >07:10:01 AM 218006588 178850220 &nbsp; &nbsp; 45.07 &nbsp; &nbsp; 30144 &nbsp;24231036 &nbsp;27366528 &nbsp; &nbsp; &nbsp;6.75</font></div><div><font size="2"   >07:20:01 AM 217784072 179072736 &nbsp; &nbsp; 45.12 &nbsp; &nbsp; 31424 &nbsp;24412084 &nbsp;27365496 &nbsp; &nbsp; &nbsp;6.75</font></div><div><font size="2"   >07:30:01 AM 217128620 179728188 &nbsp; &nbsp; 45.29 &nbsp; &nbsp; 32752 &nbsp;24970064 &nbsp;27370048 &nbsp; &nbsp; &nbsp;6.75</font></div><div><font size="2"   >07:40:01 AM 216704964 180151844 &nbsp; &nbsp; 45.39 &nbsp; &nbsp; 34372 &nbsp;25331396 &nbsp;27369700 &nbsp; &nbsp; &nbsp;6.75</font></div><div><font size="2"   >07:50:01 AM 216372456 180484352 &nbsp; &nbsp; 45.48 &nbsp; &nbsp; 35740 &nbsp;25610760 &nbsp;27371348 &nbsp; &nbsp; &nbsp;6.75</font></div><div><font size="2"   >08:00:01 AM 216028392 180828416 &nbsp; &nbsp; 45.57 &nbsp; &nbsp; 37060 &nbsp;25890136 &nbsp;27393748 &nbsp; &nbsp; &nbsp;6.76</font></div><div><font size="2"   >08:10:01 AM 214706196 182150612 &nbsp; &nbsp; 45.90 &nbsp; &nbsp; 38808 &nbsp;27120088 &nbsp;27400288 &nbsp; &nbsp; &nbsp;6.76</font></div><div><font size="2"   >08:20:01 AM 213981920 182874888 &nbsp; &nbsp; 46.08 &nbsp; &nbsp; 42712 &nbsp;27798924 &nbsp;27413000 &nbsp; &nbsp; &nbsp;6.76</font></div><div><font size="2"   >08:30:01 AM 213551104 183305704 &nbsp; &nbsp; 46.19 &nbsp; &nbsp; 44268 &nbsp;28193028 &nbsp;27411516 &nbsp; &nbsp; &nbsp;6.76</font></div><p></p></pre></div></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >设置cache的使用趋势</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vfs_cache_pressure</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This percentage value controls the tendency of the kernel to reclaim</font></div><div><font size="2"   >the memory which is used for caching of directory and inode objects.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >At the default value of vfs_cache_pressure=100 the kernel will attempt to</font></div><div><font size="2"   >reclaim dentries and inodes at a "fair" rate with respect to pagecache and</font></div><div><font size="2"   >swapcache reclaim. &nbsp;Decreasing vfs_cache_pressure causes the kernel to prefer</font></div><div><font size="2"   >to retain dentry and inode caches. When vfs_cache_pressure=0, the kernel will</font></div><div><font size="2"   >never reclaim dentries and inodes due to memory pressure and this can easily</font></div><div><font size="2"   >lead to out-of-memory conditions. Increasing vfs_cache_pressure beyond 100</font></div><div><font size="2"   >causes the kernel to prefer to reclaim dentries and inodes.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Increasing vfs_cache_pressure significantly beyond 100 may have negative</font></div><div><font size="2"   >performance impact. Reclaim code needs to take various locks to find freeable</font></div><div><font size="2"   >directory and inode objects. With vfs_cache_pressure=1000, it will look for</font></div><div><font size="2"   >ten times more freeable objects than there are.</font></div><p></p></pre></div><div>即使设置为1, 貌似还是不断的使用cache.</div><div><br></div><div>因为和脏数据无关, 所以也不需要调整脏数据的内核参数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># cat /proc/meminfo |grep -i -E "dirt|back"</font></div><div><font size="2"   >Dirty: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 kB</font></div><div><font size="2"   >Writeback: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 kB</font></div><div><font size="2"   >WritebackTmp: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 kB</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >==============================================================</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >dirty_background_bytes</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Contains the amount of dirty memory at which the background kernel</font></div><div><font size="2"   >flusher threads will start writeback.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >If dirty_background_bytes is written, dirty_background_ratio becomes a function</font></div><div><font size="2"   >of its value (dirty_background_bytes / the amount of dirtyable system memory).</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >==============================================================</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >dirty_background_ratio</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Contains, as a percentage of total system memory, the number of pages at which</font></div><div><font size="2"   >the background kernel flusher threads will start writing out dirty data.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >==============================================================</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >dirty_bytes</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Contains the amount of dirty memory at which a process generating disk writes</font></div><div><font size="2"   >will itself start writeback.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >If dirty_bytes is written, dirty_ratio becomes a function of its value</font></div><div><font size="2"   >(dirty_bytes / the amount of dirtyable system memory).</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Note: the minimum value allowed for dirty_bytes is two pages (in bytes); any</font></div><div><font size="2"   >value lower than this limit will be ignored and the old configuration will be</font></div><div><font size="2"   >retained.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >==============================================================</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >dirty_expire_centisecs</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This tunable is used to define when dirty data is old enough to be eligible</font></div><div><font size="2"   >for writeout by the kernel flusher threads. &nbsp;It is expressed in 100'ths</font></div><div><font size="2"   >of a second. &nbsp;Data which has been dirty in-memory for longer than this</font></div></div><div><div><font size="2"   >interval will be written out next time a flusher thread wakes up.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >==============================================================</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >dirty_ratio</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Contains, as a percentage of total system memory, the number of pages at which</font></div><div><font size="2"   >a process which is generating disk writes will itself start writing out dirty</font></div><div><font size="2"   >data.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >==============================================================</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >dirty_writeback_centisecs</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The kernel flusher threads will periodically wake up and write `old' data</font></div><div><font size="2"   >out to disk. &nbsp;This tunable expresses the interval between those wakeups, in</font></div><div><font size="2"   >100'ths of a second.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Setting this to zero disables periodic writeback altogether.</font></div></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >现在暂且增加一个空闲时间自动FREE的脚本.</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/usr/share/doc/kernel-doc-2.6.32/Documentation/sysctl/vm.txt</font></div><div><font size="2"   >drop_caches</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Writing to this will cause the kernel to drop clean caches, dentries and</font></div><div><font size="2"   >inodes from memory, causing that memory to become free.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >To free pagecache:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; echo 1 &gt; /proc/sys/vm/drop_caches</font></div><div><font size="2"   >To free dentries and inodes:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; echo 2 &gt; /proc/sys/vm/drop_caches</font></div><div><font size="2"   >To free pagecache, dentries and inodes:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; echo 3 &gt; /proc/sys/vm/drop_caches</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >As this is a non-destructive operation and dirty objects are not freeable, the</font></div><div><font size="2"   >user should run `sync' first.</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >crontab -e</font></div><div><font size="2"   >30 4 * * * /usr/local/bin/free.sh &gt;&gt;/tmp/free.log 2&gt;&amp;1</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   ># cat /usr/local/bin/free.sh</font></div><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >. /root/.bash_profile</font></div><div><font size="2"   >. /etc/profile</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >echo "`date +%F%T` start drop cache."</font></div><div><font size="2"   >free</font></div><div><font size="2"   ><span style="line-height: 21px;"   >sync</span></font></div><div><font size="2"   >echo 3 &gt; /proc/sys/vm/drop_caches</font></div><div><font size="2"   >echo "`date +%F%T` end drop cache."</font></div><div><font size="2"   >free</font></div></div><p></p></pre></div><div><br></div><div>最终调整的参数如下 :&nbsp;</div><div>负载恢复正常.</div><div>减少脏数据比例, 提高脏数据刷新频率</div><div>将ARC改成只存储metadata, 不存储page.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >sysctl -w vm.zone_reclaim_mode=1</font></div><div><font size="2"   >sysctl -w vm.dirty_background_bytes=102400000</font></div><div><font size="2"   >sysctl -w vm.dirty_bytes=102400000</font></div><div><font size="2"   >sysctl -w vm.dirty_expire_centisecs=10</font></div><div><font size="2"   >sysctl -w vm.dirty_writeback_centisecs=10</font></div><div><font size="2"   >sysctl -w vm.swappiness=0</font></div><div><font size="2"   >sysctl -w vm.vfs_cache_pressure=80</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># vi /etc/sysctl.conf</font></div><div><font size="2"   >vm.zone_reclaim_mode=1</font></div><div><font size="2"   >vm.dirty_background_bytes=102400000</font></div><div><font size="2"   >vm.dirty_bytes=102400000</font></div><div><font size="2"   >vm.dirty_expire_centisecs=10</font></div><div><font size="2"   >vm.dirty_writeback_centisecs=10</font></div><div><font size="2"   >vm.swappiness=0</font></div><div><font size="2"   >vm.vfs_cache_pressure=80</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># cd /sys/module/zfs/parameters/</font></div><div><font size="2"   ># cat zfs_arc_max&nbsp;</font></div><div><font size="2"   >10240000000</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span style="line-height: 28px;"   >查看arc统计信息</span>/proc/spl/kstat/zfs/arcstats<span style="line-height: 28px;"   >, 可以看到metadata使用了不到2G, 所以给10G差不多了.</span></font></div><div><span style="line-height: 28px;"   ><font size="2"   >不够的话, 以后可以再调整.</font></span></div><div><font size="2"   >meta_size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp;1952531968</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># cat /etc/modprobe.d/zfs.conf&nbsp;</font></div><div><font size="2"   >options zfs zfs_arc_max=10240000000</font></div><div><font size="2"   >options zfs zfs_dirty_data_max=800000000</font></div><div><font size="2"   >options zfs zfs_vdev_async_write_active_min_dirty_percent=10</font></div><div><font size="2"   >options zfs zfs_vdev_async_write_active_max_dirty_percent=30</font></div><div><font size="2"   >options zfs zfs_delay_min_dirty_percent=60</font></div><div><font size="2"   >options zfs zfs_arc_shrink_shift=11</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >设置为metadata, 因为LINUX本身也带cache, 没有必要多重cache.&nbsp;</font></div><div><font size="2"   >zfs 和 PostgreSQL 一样有这个多重cache问题, 除非使用directIO.</font></div><div><font size="2"   ># zfs set primarycache=metadata zp1</font></div><div><font size="2"   ># zfs set primarycache=metadata zp1/data_a0</font></div><div><font size="2"   ># zfs set primarycache=metadata zp1/data_a1</font></div><div><font size="2"   ># zfs set primarycache=metadata zp1/data_b0</font></div><div><font size="2"   ># zfs set primarycache=metadata zp1/data_b1</font></div><div><font size="2"   ># zfs set primarycache=metadata zp1/data_c0</font></div><div><font size="2"   ># zfs set primarycache=metadata zp1/data_c1</font></div><div><font size="2"   ># zfs set primarycache=metadata zp1/data_ssd0</font></div><div><font size="2"   ># zfs set primarycache=metadata zp1/data_ssd1</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >设置为与数据库块大小一致.</font></div><div><font size="2"   ># zfs set recordsize=16k zp1/data_a0 &nbsp;wal_block_size=16k</font></div><div><font size="2"   ># zfs set recordsize=8k zp1/data_a0 &nbsp;block_size=8k</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >[参考]</span></div></div><wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201392641033482"   >http://blog.163.com/digoal@126/blog/static/163877040201392641033482</a></div>2.&nbsp;<a target="_blank" rel="nofollow" href="http://constantin.glez.de/blog/2010/04/ten-ways-easily-improve-oracle-solaris-zfs-filesystem-performance"   >http://constantin.glez.de/blog/2010/04/ten-ways-easily-improve-oracle-solaris-zfs-filesystem-performance</a><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://github.com/zfsonlinux/zfs/issues/258"   >https://github.com/zfsonlinux/zfs/issues/258</a></div><div><span style="line-height: 28px;"   >4.&nbsp;</span><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201462204333503"   >http://blog.163.com/digoal@126/blog/static/163877040201462204333503</a></div><div>5.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://github.com/spacelama"   >https://github.com/spacelama</a></div><div>6.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://github.com/mharsch"   >https://github.com/mharsch</a></div><div><div style="line-height: 28px;"   >7.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://pthree.org/2012/12/07/zfs-administration-part-iv-the-adjustable-replacement-cache/"   >https://pthree.org/2012/12/07/zfs-administration-part-iv-the-adjustable-replacement-cache/</a></div><div style="line-height: 28px;"   >8. man&nbsp;zfs-module-parameters</div><div style="line-height: 28px;"   >&nbsp; &nbsp; rpm -ql zfs</div><div style="line-height: 28px;"   >9.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://dtrace.org/blogs/brendan/2014/02/11/another-10-performance-wins/"   >http://dtrace.org/blogs/brendan/2014/02/11/another-10-performance-wins/</a></div><div style="line-height: 28px;"   >10.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://www.cupfighter.net/2013/03/default-nexenta-zfs-settings-you-want-to-change-part-2"   >https://www.cupfighter.net/2013/03/default-nexenta-zfs-settings-you-want-to-change-part-2</a></div></div><div style="line-height: 28px;"   >11. /proc/spl/*</div><div style="line-height: 28px;"   ><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="ZFS case : top CPU 100sy, when no free memory trigger it. - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>