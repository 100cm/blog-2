<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL real-time count(*) performance tuning case - 3</h2>
	<h5 id="">2013-04-15 21:07:19&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020133155179877/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>前两篇blog介绍了表的count(*)的优化, 但是未涉及group by column的情况, 有兴趣的朋友可以阅读 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201331252945440/"   >http://blog.163.com/digoal@126/blog/static/163877040201331252945440/</a></div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020133151402415/"   >http://blog.163.com/digoal@126/blog/static/16387704020133151402415/</a></div><div>本例则是这个话题的延展.&nbsp;<span style="line-height: 22px;"   >主要讲述针对列group by的count(*)的优化.</span></div><div># 测试表 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create table log (id serial primary key, c1 int not null, c2 int not null, c3 int not null, c4 text not null, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div># 存放count(*)的表, 假设经常需要按log.c1以及log.crt_time分天, 周, 月, 年进行count(*)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create table log_c1_cnt_day (c1 int, pid int, cnt int8, stat_time text, primary key(c1,pid,stat_time));</font></div><div><font size="2"   >create table log_c1_cnt_week (c1 int, pid int, cnt int8, stat_time text, primary key(c1,pid,stat_time));</font></div><div><font size="2"   >create table log_c1_cnt_month (c1 int, pid int, cnt int8, stat_time text, primary key(c1,pid,stat_time));</font></div><div><font size="2"   >create table log_c1_cnt_year (c1 int, pid int, cnt int8, stat_time text, primary key(c1,pid,stat_time));</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 存放count(*)的表, 假设经常需要按log.c2, log.c3以及log.crt_time分天, 周, 月, 年进行count(*)</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create table log_c2_c3_cnt_day (c2 int, c3 int, pid int, cnt int8, stat_time text, primary key(c2,c3,pid,stat_time));</font></div><div><font size="2"   >create table log_c2_c3_cnt_week (c2 int, c3 int, pid int, cnt int8, stat_time text, primary key(c2,c3,pid,stat_time));</font></div><div><font size="2"   >create table log_c2_c3_cnt_month (c2 int, c3 int, pid int, cnt int8, stat_time text, primary key(c2,c3,pid,stat_time));</font></div><div><font size="2"   >create table log_c2_c3_cnt_year (c2 int, c3 int, pid int, cnt int8, stat_time text, primary key(c2,c3,pid,stat_time));</font></div><p></p></pre></div><div><br></div><div>-- # 创建插入触发器函数, 每条插入的</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION public.tg_insert_log()</font></div><div><font size="2"   >&nbsp;RETURNS trigger</font></div><div><font size="2"   >&nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_pid int;</font></div><div><font size="2"   >&nbsp; v_cnt1 int8 := null;</font></div><div><font size="2"   >&nbsp; v_cnt2 int8 := null;</font></div><div><font size="2"   >&nbsp; v_cnt3 int8 := null;</font></div><div><font size="2"   >&nbsp; v_cnt4 int8 := null;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select pg_backend_pid() into v_pid;</font></div><div><font size="2"   >&nbsp; -- c1统计</font></div><div><font size="2"   >&nbsp; update log_c1_cnt_day set cnt=cnt+1 where c1=NEW.c1 and pid=v_pid and stat_time=to_char(NEW.crt_time,'yyyymmdd') returning cnt into v_cnt1;</font></div><div><font size="2"   >&nbsp; update log_c1_cnt_week set cnt=cnt+1 where c1=NEW.c1 and pid=v_pid and stat_time=to_char(date(NEW.crt_time)-(EXTRACT(ISODOW FROM date(NEW.crt_time)))::int+1,'yyyymmdd') returning cnt into v_cnt2;</font></div><div><font size="2"   >&nbsp; update log_c1_cnt_month set cnt=cnt+1 where c1=NEW.c1 and pid=v_pid and stat_time=to_char(NEW.crt_time,'yyyymm') returning cnt into v_cnt3;</font></div><div><font size="2"   >&nbsp; update log_c1_cnt_year set cnt=cnt+1 where c1=NEW.c1 and pid=v_pid and stat_time=to_char(NEW.crt_time,'yyyy') returning cnt into v_cnt4;</font></div><div><font size="2"   >&nbsp; if v_cnt1 is null then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into log_c1_cnt_day(c1, pid, cnt, stat_time) values (NEW.c1, v_pid, 1, to_char(NEW.crt_time,'yyyymmdd'));</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; if v_cnt2 is null then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into log_c1_cnt_week(c1, pid, cnt, stat_time) values (NEW.c1, v_pid, 1, to_char(date(NEW.crt_time)-(EXTRACT(ISODOW FROM date(NEW.crt_time)))::int+1,'yyyymmdd'));</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; if v_cnt3 is null then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into log_c1_cnt_month(c1, pid, cnt, stat_time) values (NEW.c1, v_pid, 1, to_char(NEW.crt_time,'yyyymm'));</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; if v_cnt4 is null then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into log_c1_cnt_year(c1, pid, cnt, stat_time) values (NEW.c1, v_pid, 1, to_char(NEW.crt_time,'yyyy'));</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; -- c2_c3 统计</font></div><div><font size="2"   >&nbsp; v_cnt1 := null;</font></div><div><font size="2"   >&nbsp; v_cnt2 := null;</font></div><div><font size="2"   >&nbsp; v_cnt3 := null;</font></div><div><font size="2"   >&nbsp; v_cnt4 := null;</font></div><div><font size="2"   >&nbsp; update log_c2_c3_cnt_day set cnt=cnt+1 where c2=NEW.c2 and c3=NEW.c3 and pid=v_pid and stat_time=to_char(NEW.crt_time,'yyyymmdd') returning cnt into v_cnt1;</font></div><div><font size="2"   >&nbsp; update log_c2_c3_cnt_week set cnt=cnt+1 where c2=NEW.c2 and c3=NEW.c3 and pid=v_pid and stat_time=to_char(date(NEW.crt_time)-(EXTRACT(ISODOW FROM date(NEW.crt_time)))::int+1,'yyyymmdd') returning cnt into v_cnt2;</font></div><div><font size="2"   >&nbsp; update log_c2_c3_cnt_month set cnt=cnt+1 where c2=NEW.c2 and c3=NEW.c3 and pid=v_pid and stat_time=to_char(NEW.crt_time,'yyyymm') returning cnt into v_cnt3;</font></div><div><font size="2"   >&nbsp; update log_c2_c3_cnt_year set cnt=cnt+1 where c2=NEW.c2 and c3=NEW.c3 and pid=v_pid and stat_time=to_char(NEW.crt_time,'yyyy') returning cnt into v_cnt4;</font></div><div><font size="2"   >&nbsp; if v_cnt1 is null then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into log_c2_c3_cnt_day(c2, c3, pid, cnt, stat_time) values (NEW.c2, NEW.c3, v_pid, 1, to_char(NEW.crt_time,'yyyymmdd'));</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; if v_cnt2 is null then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into log_c2_c3_cnt_week(c2, c3, pid, cnt, stat_time) values (NEW.c2, NEW.c3, v_pid, 1, to_char(date(NEW.crt_time)-(EXTRACT(ISODOW FROM date(NEW.crt_time)))::int+1,'yyyymmdd'));</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; if v_cnt3 is null then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into log_c2_c3_cnt_month(c2, c3, pid, cnt, stat_time) values (NEW.c2, NEW.c3, v_pid, 1, to_char(NEW.crt_time,'yyyymm'));</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; if v_cnt4 is null then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into log_c2_c3_cnt_year(c2, c3, pid, cnt, stat_time) values (NEW.c2, NEW.c3, v_pid, 1, to_char(NEW.crt_time,'yyyy'));</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; -- 其他列统计, 以此类推</font></div><div><font size="2"   >&nbsp; return null;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >-- # 创建删除触发器函数</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION public.tg_delete_log()</font></div><div><font size="2"   >&nbsp;RETURNS trigger</font></div><div><font size="2"   >&nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_pid int;</font></div><div><font size="2"   >&nbsp; v_cnt1 int8 := null;</font></div><div><font size="2"   >&nbsp; v_cnt2 int8 := null;</font></div><div><font size="2"   >&nbsp; v_cnt3 int8 := null;</font></div><div><font size="2"   >&nbsp; v_cnt4 int8 := null;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select pg_backend_pid() into v_pid;</font></div><div><font size="2"   >&nbsp; -- c1统计</font></div><div><font size="2"   >&nbsp; update log_c1_cnt_day set cnt=cnt-1 where c1=OLD.c1 and pid=v_pid and stat_time=to_char(OLD.crt_time,'yyyymmdd') returning cnt into v_cnt1;</font></div><div><font size="2"   >&nbsp; update log_c1_cnt_week set cnt=cnt-1 where c1=OLD.c1 and pid=v_pid and stat_time=to_char(date(OLD.crt_time)-(EXTRACT(ISODOW FROM date(OLD.crt_time)))::int+1,'yyyymmdd') returning cnt into v_cnt2;</font></div><div><font size="2"   >&nbsp; update log_c1_cnt_month set cnt=cnt-1 where c1=OLD.c1 and pid=v_pid and stat_time=to_char(OLD.crt_time,'yyyymm') returning cnt into v_cnt3;</font></div><div><font size="2"   >&nbsp; update log_c1_cnt_year set cnt=cnt-1 where c1=OLD.c1 and pid=v_pid and stat_time=to_char(OLD.crt_time,'yyyy') returning cnt into v_cnt4;</font></div><div><font size="2"   >&nbsp; if v_cnt1 is null then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into log_c1_cnt_day(c1, pid, cnt, stat_time) values (OLD.c1, v_pid, -1, to_char(OLD.crt_time,'yyyymmdd'));</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; if v_cnt2 is null then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into log_c1_cnt_week(c1, pid, cnt, stat_time) values (OLD.c1, v_pid, -1, to_char(date(OLD.crt_time)-(EXTRACT(ISODOW FROM date(OLD.crt_time)))::int+1,'yyyymmdd'));</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; if v_cnt3 is null then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into log_c1_cnt_month(c1, pid, cnt, stat_time) values (OLD.c1, v_pid, -1, to_char(OLD.crt_time,'yyyymm'));</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; if v_cnt4 is null then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into log_c1_cnt_year(c1, pid, cnt, stat_time) values (OLD.c1, v_pid, -1, to_char(OLD.crt_time,'yyyy'));</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; -- c2_c3 统计</font></div><div><font size="2"   >&nbsp; v_cnt1 := null;</font></div><div><font size="2"   >&nbsp; v_cnt2 := null;</font></div><div><font size="2"   >&nbsp; v_cnt3 := null;</font></div><div><font size="2"   >&nbsp; v_cnt4 := null;</font></div><div><font size="2"   >&nbsp; update log_c2_c3_cnt_day set cnt=cnt-1 where c2=OLD.c2 and c3=OLD.c3 and pid=v_pid and stat_time=to_char(OLD.crt_time,'yyyymmdd') returning cnt into v_cnt1;</font></div><div><font size="2"   >&nbsp; update log_c2_c3_cnt_week set cnt=cnt-1 where c2=OLD.c2 and c3=OLD.c3 and pid=v_pid and stat_time=to_char(date(OLD.crt_time)-(EXTRACT(ISODOW FROM date(OLD.crt_time)))::int+1,'yyyymmdd') returning cnt into v_cnt2;</font></div><div><font size="2"   >&nbsp; update log_c2_c3_cnt_month set cnt=cnt-1 where c2=OLD.c2 and c3=OLD.c3 and pid=v_pid and stat_time=to_char(OLD.crt_time,'yyyymm') returning cnt into v_cnt3;</font></div><div><font size="2"   >&nbsp; update log_c2_c3_cnt_year set cnt=cnt-1 where c2=OLD.c2 and c3=OLD.c3 and pid=v_pid and stat_time=to_char(OLD.crt_time,'yyyy') returning cnt into v_cnt4;</font></div><div><font size="2"   >&nbsp; if v_cnt1 is null then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into log_c2_c3_cnt_day(c2, c3, pid, cnt, stat_time) values (OLD.c2, OLD.c3, v_pid, -1, to_char(OLD.crt_time,'yyyymmdd'));</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; if v_cnt2 is null then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into log_c2_c3_cnt_week(c2, c3, pid, cnt, stat_time) values (OLD.c2, OLD.c3, v_pid, -1, to_char(date(OLD.crt_time)-(EXTRACT(ISODOW FROM date(OLD.crt_time)))::int+1,'yyyymmdd'));</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; if v_cnt3 is null then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into log_c2_c3_cnt_month(c2, c3, pid, cnt, stat_time) values (OLD.c2, OLD.c3, v_pid, -1, to_char(OLD.crt_time,'yyyymm'));</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; if v_cnt4 is null then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into log_c2_c3_cnt_year(c2, c3, pid, cnt, stat_time) values (OLD.c2, OLD.c3, v_pid, -1, to_char(OLD.crt_time,'yyyy'));</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; -- 其他列统计, 以此类推</font></div><div><font size="2"   >&nbsp; return null;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >-- #　创建truncate触发器函数</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION public.tg_truncate_log()</font></div><div><font size="2"   >&nbsp;RETURNS trigger</font></div><div><font size="2"   >&nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; -- c1统计</font></div><div><font size="2"   >&nbsp; truncate log_c1_cnt_day;</font></div><div><font size="2"   >&nbsp; truncate log_c1_cnt_week;</font></div><div><font size="2"   >&nbsp; truncate log_c1_cnt_month;</font></div><div><font size="2"   >&nbsp; truncate log_c1_cnt_year;</font></div><div><font size="2"   >&nbsp; -- c2_c3 统计</font></div><div><font size="2"   >&nbsp; truncate log_c2_c3_cnt_day;</font></div><div><font size="2"   >&nbsp; truncate log_c2_c3_cnt_week;</font></div><div><font size="2"   >&nbsp; truncate log_c2_c3_cnt_month;</font></div><div><font size="2"   >&nbsp; truncate log_c2_c3_cnt_year;</font></div><div><font size="2"   >&nbsp; return null;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >-- # 创建触发器</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create trigger tg1 after insert on log for each row execute procedure tg_insert_log();</font></div><div><font size="2"   >create trigger tg2 after delete on log for each row execute procedure tg_delete_log();</font></div><div><font size="2"   >create trigger tg3 after truncate on log for each statement execute procedure tg_truncate_log();</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >-- INSERT pgbench</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; cat insert.sql&nbsp;</font></div><div><font size="2"   >\setrandom c1 1 10</font></div><div><font size="2"   >\setrandom c2 1 5</font></div><div><font size="2"   >\setrandom c3 1 2</font></div><div><font size="2"   >\setrandom c4 1 100</font></div><div><font size="2"   >\setrandom day 1 300</font></div><div><font size="2"   >insert into log (c1,c2,c3,c4,crt_time) values (:c1, :c2, :c3, :c4, current_date+:day::int);</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >-- 测试结果</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; pgbench -M prepared -r -n -f ./insert.sql -h $PGDATA -p 1919 -U postgres -T 60 -c 16 -j 4 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 392105</font></div><div><font size="2"   >tps = 6533.401527 (including connections establishing)</font></div><div><font size="2"   >tps = 6534.950565 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003611 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom c1 1 10</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.000821 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom c2 1 5</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.000762 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom c3 1 2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.000740 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom c4 1 100</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.000873 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom day 1 300</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2.438667 &nbsp; &nbsp; &nbsp; &nbsp;insert into log (c1,c2,c3,c4,crt_time) values (:c1, :c2, :c3, :c4, current_date+:day::int);</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >-- UPDATE pgbench</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; cat id.sql&nbsp;</font></div><div><font size="2"   >\setrandom c1 1 10</font></div><div><font size="2"   >\setrandom c2 1 5</font></div><div><font size="2"   >\setrandom c3 1 2</font></div><div><font size="2"   >\setrandom c4 1 100</font></div><div><font size="2"   >\setrandom day 1 300</font></div><div><font size="2"   >\setrandom id 1 5000000</font></div><div><font size="2"   >begin;</font></div><div><font size="2"   >insert into log (c1,c2,c3,c4,crt_time) values (:c1, :c2, :c3, :c4, current_date+:day::int);</font></div><div><font size="2"   >insert into log (c1,c2,c3,c4,crt_time) values (:c2, :c1, :c3, :c4, current_date+:day::int);</font></div><div><font size="2"   >delete from log where id=:id;</font></div><div><font size="2"   >insert into log (c1,c2,c3,c4,crt_time) values (:c1, :c2, :c4, :c3, current_date+:day::int);</font></div><div><font size="2"   >delete from log where id=:id;</font></div><div><font size="2"   >insert into log (c1,c2,c3,c4,crt_time) values (:c1, :c2, :c1, :c4, current_date+:day::int);</font></div><div><font size="2"   >delete from log where id=:id;</font></div><div><font size="2"   >insert into log (c1,c2,c3,c4,crt_time) values (:c1, :c1, :c3, :c4, current_date+:day::int);</font></div><div><font size="2"   >delete from log where id=:id;</font></div><div><font size="2"   >delete from log where id=:id;</font></div><div><font size="2"   >insert into log (c1,c2,c3,c4,crt_time) values (:c1, :c2, :c3, :c1, current_date+:day::int);</font></div><div><font size="2"   >end;</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >-- 测试结果</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; pgbench -M prepared -r -n -f ./id.sql -h $PGDATA -p 1919 -U postgres -T 60 -c 16 -j 4 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 68535</font></div><div><font size="2"   >tps = 1141.824233 (including connections establishing)</font></div><div><font size="2"   >tps = 1142.090645 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.004085 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom c1 1 10</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.000841 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom c2 1 5</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.000848 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom c3 1 2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.000800 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom c4 1 100</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.000899 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom day 1 300</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.000858 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.124333 &nbsp; &nbsp; &nbsp; &nbsp;begin;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2.105232 &nbsp; &nbsp; &nbsp; &nbsp;insert into log (c1,c2,c3,c4,crt_time) values (:c1, :c2, :c3, :c4, current_date+:day::int);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2.099313 &nbsp; &nbsp; &nbsp; &nbsp;insert into log (c1,c2,c3,c4,crt_time) values (:c2, :c1, :c3, :c4, current_date+:day::int);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.553053 &nbsp; &nbsp; &nbsp; &nbsp;delete from log where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.951419 &nbsp; &nbsp; &nbsp; &nbsp;insert into log (c1,c2,c3,c4,crt_time) values (:c1, :c2, :c4, :c3, current_date+:day::int);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.484705 &nbsp; &nbsp; &nbsp; &nbsp;delete from log where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.856407 &nbsp; &nbsp; &nbsp; &nbsp;insert into log (c1,c2,c3,c4,crt_time) values (:c1, :c2, :c1, :c4, current_date+:day::int);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.479868 &nbsp; &nbsp; &nbsp; &nbsp;delete from log where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.661506 &nbsp; &nbsp; &nbsp; &nbsp;insert into log (c1,c2,c3,c4,crt_time) values (:c1, :c1, :c3, :c4, current_date+:day::int);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.469769 &nbsp; &nbsp; &nbsp; &nbsp;delete from log where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.267489 &nbsp; &nbsp; &nbsp; &nbsp;delete from log where id=:id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.623206 &nbsp; &nbsp; &nbsp; &nbsp;insert into log (c1,c2,c3,c4,crt_time) values (:c1, :c2, :c3, :c1, current_date+:day::int);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.301404 &nbsp; &nbsp; &nbsp; &nbsp;end;</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 验证数据准确性的SQL如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select sum(hashtext(t.*::text)) from (select c1,stat_time,sum(cnt) from log_c1_cnt_year group by 1,2 having sum(cnt)&lt;&gt;0 order by 1,2) t;</font></div><div><font size="2"   >select sum(hashtext(t.*::text)) from (select c1,to_char(crt_time,'yyyy'),count(*) from log group by 1,2 having count(*)&lt;&gt;0 order by 1,2) t;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >select sum(hashtext(t.*::text)) from (select c1,stat_time,sum(cnt) from log_c1_cnt_month group by 1,2 having sum(cnt)&lt;&gt;0 order by 1,2) t;</font></div><div><font size="2"   >select sum(hashtext(t.*::text)) from (select c1,to_char(crt_time,'yyyymm'),count(*) from log group by 1,2 having count(*)&lt;&gt;0 order by 1,2) t;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >select sum(hashtext(t.*::text)) from (select c1,stat_time,sum(cnt) from log_c1_cnt_week group by 1,2 having sum(cnt)&lt;&gt;0 order by 1,2) t;</font></div><div><font size="2"   >select sum(hashtext(t.*::text)) from (select c1,to_char(date(crt_time)-(EXTRACT(ISODOW FROM date(crt_time)))::int+1,'yyyymmdd'),count(*) from log group by 1,2 having count(*)&lt;&gt;0 order by 1,2) t;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >select sum(hashtext(t.*::text)) from (select c1,stat_time,sum(cnt) from log_c1_cnt_day group by 1,2 having sum(cnt)&lt;&gt;0 order by 1,2) t;</font></div><div><font size="2"   >select sum(hashtext(t.*::text)) from (select c1,to_char(crt_time,'yyyymmdd'),count(*) from log group by 1,2 having count(*)&lt;&gt;0 order by 1,2) t;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >select sum(hashtext(t.*::text)) from (select c2,c3,stat_time,sum(cnt) from log_c2_c3_cnt_year group by 1,2,3 having sum(cnt)&lt;&gt;0 order by 1,2,3) t;</font></div><div><font size="2"   >select sum(hashtext(t.*::text)) from (select c2,c3,to_char(crt_time,'yyyy'),count(*) from log group by 1,2,3 having count(*)&lt;&gt;0 order by 1,2,3) t;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >select sum(hashtext(t.*::text)) from (select c2,c3,stat_time,sum(cnt) from log_c2_c3_cnt_month group by 1,2,3 having sum(cnt)&lt;&gt;0 order by 1,2,3) t;</font></div><div><font size="2"   >select sum(hashtext(t.*::text)) from (select c2,c3,to_char(crt_time,'yyyymm'),count(*) from log group by 1,2,3 having count(*)&lt;&gt;0 order by 1,2,3) t;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >select sum(hashtext(t.*::text)) from (select c2,c3,stat_time,sum(cnt) from log_c2_c3_cnt_week group by 1,2,3 having sum(cnt)&lt;&gt;0 order by 1,2,3) t;</font></div><div><font size="2"   >select sum(hashtext(t.*::text)) from (select c2,c3,to_char(date(crt_time)-(EXTRACT(ISODOW FROM date(crt_time)))::int+1,'yyyymmdd'),count(*) from log group by 1,2,3 having count(*)&lt;&gt;0 order by 1,2,3) t;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >select sum(hashtext(t.*::text)) from (select c2,c3,stat_time,sum(cnt) from log_c2_c3_cnt_day group by 1,2,3 having sum(cnt)&lt;&gt;0 order by 1,2,3) t;</font></div><div><font size="2"   >select sum(hashtext(t.*::text)) from (select c2,c3,to_char(crt_time,'yyyymmdd'),count(*) from log group by 1,2,3 having count(*)&lt;&gt;0 order by 1,2,3) t;</font></div><p></p></pre></div></div><div># 经过验证数据准确.</div><div>【小结】</div><div>1. 实时性的统计带来的开销与维度有关, 维度越多, 开销越大, 这样带来的后果是入口表(明细表)的dml吞吐量会急剧下降.</div><div>下一篇将介绍非实时的统计. 结合非实时的统计以及明细数据也能达到实时count的效果.</div><div><br></div><div><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 25px;"   >[参考]</span><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><div style="line-height: 25px;"   >为方便大家查询, 汇总PostgreSQL实时和非实时数据统计的案例分析文章系列 - 如下 :&nbsp;</div><div style="line-height: 25px;"   >1.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201331252945440/"   >http://blog.163.com/digoal@126/blog/static/163877040201331252945440/</a></div><div style="line-height: 25px;"   >2.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020133151402415/"   >http://blog.163.com/digoal@126/blog/static/16387704020133151402415/</a></div><div style="line-height: 25px;"   >3.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020133155179877/"   >http://blog.163.com/digoal@126/blog/static/16387704020133155179877/</a></div><div style="line-height: 25px;"   >4.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020133156636579/"   >http://blog.163.com/digoal@126/blog/static/16387704020133156636579/</a></div><div style="line-height: 25px;"   >5.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020133218305242/"   >http://blog.163.com/digoal@126/blog/static/16387704020133218305242/</a></div><div style="line-height: 25px;"   >6.&nbsp;<a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020133224161563/"   >http://blog.163.com/digoal@126/blog/static/16387704020133224161563/</a></div></div></div><div><div><div><span style="line-height: 22px;"   >7.&nbsp;</span><a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020133271134563/"   >http://blog.163.com/digoal@126/blog/static/16387704020133271134563/</a></div></div></div><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 25px;"   >8.&nbsp;</span><a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136); font-family: Arial, Helvetica, simsun, u5b8bu4f53;" href="http://blog.163.com/digoal@126/blog/static/16387704020134311144755/"   >http://blog.163.com/digoal@126/blog/static/16387704020134311144755/</a>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL real-time count(*) performance tuning case - 3 - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>