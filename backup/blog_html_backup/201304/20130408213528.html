<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">virsh start kvm Failed to allocate 8589934592 B: Cannot allocate memory</h2>
	<h5 id="">2013-04-08 21:35:28&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020133892536983/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">主机环境 :&nbsp;<div>Ubuntu 12.04 x64</div><div><div>root@digoal-PowerEdge-R610:/var/log/libvirt/qemu# free</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;total &nbsp; &nbsp; &nbsp; used &nbsp; &nbsp; &nbsp; free &nbsp; &nbsp; shared &nbsp; &nbsp;buffers &nbsp; &nbsp; cached</div><div>Mem: &nbsp; &nbsp; &nbsp;98997784 &nbsp; 11981272 &nbsp; 87016512 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; 207876 &nbsp; &nbsp;7051404</div><div>-/+ buffers/cache: &nbsp; &nbsp;4721992 &nbsp; 94275792</div><div>Swap: &nbsp; &nbsp; &nbsp;8385924 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp;8385924</div></div><div>配置了8个虚拟机, 每个分配了8GB内存.</div><div>前段时间启动正常. 8个虚拟机可以同时启动.</div><div>但是今天突然之间不行了, 只能同时启动5台.</div><div>后面三台启动会报错 :&nbsp;</div><div><div>root@digoal-PowerEdge-R610:/var/log/libvirt/qemu# virsh start centos-5.9-x64-03</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >error: Failed to start domain centos-5.9-x64-03</font></div><div><font size="2"   >error: internal error process exited while connecting to monitor: char device redirected to /dev/pts/10</font></div><div><font size="2"   >Failed to allocate 8589934592 B: Cannot allocate memory</font></div><p></p></pre></div></div><div><br></div><div>root@digoal-PowerEdge-R610:/var/log/libvirt/qemu# less centos-5.9-x64-03.log</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2013-04-08 13:10:16.867+0000: starting up</font></div><div><font size="2"   >LC_ALL=C PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin QEMU_AUDIO_DRV=none /usr/bin/kvm -S -M pc-1.0 -enable-kvm -m 8192 -smp 1,sockets=1,cores=1,threads=1 -name centos-5.9-x64-03 -uuid b819df34-d4a1-4ffb-8f8e-d05d2652fd26 -nodefconfig -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/centos-5.9-x64-03.monitor,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc -no-shutdown -drive file=/data02/vm/centos-5.9-x64_03.img,if=none,id=drive-virtio-disk0,format=qcow2 -device virtio-blk-pci,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive if=none,media=cdrom,id=drive-ide0-1-0,readonly=on,format=raw -device ide-drive,bus=ide.1,unit=0,drive=drive-ide0-1-0,id=ide0-1-0 -netdev tap,fd=18,id=hostnet0,vhost=on,vhostfd=24 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:fa:be:c5,bus=pci.0,addr=0x3 -chardev pty,id=charserial0 -device isa-serial,chardev=charserial0,id=serial0 -usb -vnc 127.0.0.1:5 -vga cirrus -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x5</font></div><div><font size="2"   >char device redirected to /dev/pts/10</font></div><div><font size="2"   >Failed to allocate 8589934592 B: Cannot allocate memory</font></div><div><font size="2"   >2013-04-08 13:10:17.446+0000: shutting down</font></div><p></p></pre></div><div><br></div><div>root@digoal-PowerEdge-R610:/var/log/libvirt# less libvirtd.log&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2013-04-08 13:08:10.714+0000: 1449: error : qemuMonitorOpenUnix:295 : failed to connect to monitor socket: No such process</font></div><div><font size="2"   >2013-04-08 13:08:10.714+0000: 1449: error : qemuProcessWaitForMonitor:1301 : internal error process exited while connecting to monitor: char device redirected to /dev/pts/10</font></div><div><font size="2"   >Failed to allocate 8589934592 B: Cannot allocate memory</font></div><div><font size="2"   >2013-04-08 13:10:17.446+0000: 1448: error : qemuMonitorIORead:513 : Unable to read from monitor: Connection reset by peer</font></div><div><font size="2"   >2013-04-08 13:10:21.105+0000: 1448: error : qemuMonitorIORead:513 : Unable to read from monitor: Connection reset by peer</font></div><div><font size="2"   >2013-04-08 13:10:24.590+0000: 1448: error : qemuMonitorIORead:513 : Unable to read from monitor: Connection reset by peer</font></div><p></p></pre></div><div><br></div><div>less /var/log/syslog</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Apr &nbsp;8 21:10:16 digoal-PowerEdge-R610 kernel: [31270.939326] device vnet5 entered promiscuous mode</font></div><div><font size="2"   >Apr &nbsp;8 21:10:16 digoal-PowerEdge-R610 kernel: [31270.973190] virbr0: topology change detected, propagating</font></div><div><font size="2"   >Apr &nbsp;8 21:10:16 digoal-PowerEdge-R610 kernel: [31270.973200] virbr0: port 6(vnet5) entered forwarding state</font></div><div><font size="2"   >Apr &nbsp;8 21:10:16 digoal-PowerEdge-R610 kernel: [31270.973215] virbr0: port 6(vnet5) entered forwarding state</font></div><div><font size="2"   >Apr &nbsp;8 21:10:17 digoal-PowerEdge-R610 kernel: [31271.559270] virbr0: port 6(vnet5) entered disabled state</font></div><div><font size="2"   >Apr &nbsp;8 21:10:17 digoal-PowerEdge-R610 avahi-daemon[1283]: Withdrawing workstation service for vnet5.</font></div><div><font size="2"   >Apr &nbsp;8 21:10:17 digoal-PowerEdge-R610 NetworkManager[1335]: &nbsp; &nbsp;SCPlugin-Ifupdown: devices removed (path: /sys/devices/virtual/net/vn</font></div><div><font size="2"   >et5, iface: vnet5)</font></div><div><font size="2"   >Apr &nbsp;8 21:10:17 digoal-PowerEdge-R610 kernel: [31271.563422] virbr0: port 6(vnet5) entered disabled state</font></div><div><font size="2"   >Apr &nbsp;8 21:10:17 digoal-PowerEdge-R610 kernel: [31271.563686] device vnet5 left promiscuous mode</font></div><div><font size="2"   >Apr &nbsp;8 21:10:17 digoal-PowerEdge-R610 kernel: [31271.563690] virbr0: port 6(vnet5) entered disabled state</font></div><div><font size="2"   >Apr &nbsp;8 21:10:18 digoal-PowerEdge-R610 kernel: [31272.486100] type=1400 audit(1365426618.372:73): apparmor="STATUS" operation="profil</font></div><div><font size="2"   >e_remove" name="libvirt-b819df34-d4a1-4ffb-8f8e-d05d2652fd26" pid=20960 comm="apparmor_parser"</font></div><div><font size="2"   >Apr &nbsp;8 21:10:20 digoal-PowerEdge-R610 kernel: [31274.438750] type=1400 audit(1365426620.329:74): apparmor="STATUS" operation="profil</font></div><div><font size="2"   >e_load" name="libvirt-f4a8170a-436d-a731-a5c5-8cc4b59acb72" pid=20967 comm="apparmor_parser"</font></div><div><font size="2"   >Apr &nbsp;8 21:10:20 digoal-PowerEdge-R610 NetworkManager[1335]: &nbsp; &nbsp;SCPlugin-Ifupdown: devices added (path: /sys/devices/virtual/net/vnet</font></div><div><font size="2"   >5, iface: vnet5)</font></div><div><font size="2"   >Apr &nbsp;8 21:10:20 digoal-PowerEdge-R610 NetworkManager[1335]: &nbsp; &nbsp;SCPlugin-Ifupdown: device added (path: /sys/devices/virtual/net/vnet5</font></div><div><font size="2"   >, iface: vnet5): no ifupdown configuration found.</font></div><div><font size="2"   >Apr &nbsp;8 21:10:20 digoal-PowerEdge-R610 NetworkManager[1335]: &lt;warn&gt; /sys/devices/virtual/net/vnet5: couldn't determine device driver;</font></div><div><font size="2"   >&nbsp;ignoring...</font></div><p></p></pre></div><div>原因是设置了oom.</div><div><div>vm.overcommit_memory = 2</div><div>vm.overcommit_ratio = 50</div></div><div>由于主机的内存+swap总计=104GB</div><div>5台虚拟机消耗40GB, 本地还开了一个PostgreSQL, shared_buffers消耗4GB.</div><div>开第六台虚拟机时申请8GB内存, 因此总计消耗52G. 加上系统其他的开销, 申请第六台虚拟机的8GB内存时已经超过了50%,</div><div>所以虚拟机就开不起来了.</div><div>将<span style="line-height: 22px;"   >vm.overcommit_memory改为0, 恢复正常.</span></div><div><span style="line-height: 22px;"   >sysctl -w&nbsp;</span><span style="line-height: 22px;"   >vm.overcommit_memory=0</span></div><div>修改/etc/sysctl.conf确保重启系统后依然生效.</div><div><br></div><div>具体的解释可参考 :&nbsp;</div><div><a rel="nofollow" href="https://www.kernel.org/doc/Documentation/sysctl/vm.txt"   >https://www.kernel.org/doc/Documentation/sysctl/vm.txt</a></div><div><pre class="prettyprint"   ><div><font size="2"   >==============================================================</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >overcommit_memory:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This value contains a flag that enables memory overcommitment.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >When this flag is 0, the kernel attempts to estimate the amount</font></div><div><font size="2"   >of free memory left when userspace requests more memory.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >When this flag is 1, the kernel pretends there is always enough</font></div><div><font size="2"   >memory until it actually runs out.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >When this flag is 2, the kernel uses a "never overcommit"</font></div><div><font size="2"   >policy that attempts to prevent any overcommit of memory.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This feature can be very useful because there are a lot of</font></div><div><font size="2"   >programs that malloc() huge amounts of memory "just-in-case"</font></div><div><font size="2"   >and don't use much of it.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The default value is 0.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >See Documentation/vm/overcommit-accounting and</font></div><div><font size="2"   >security/commoncap.c::cap_vm_enough_memory() for more information.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >==============================================================</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >overcommit_ratio:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >When overcommit_memory is set to 2, the committed address</font></div><div><font size="2"   >space is not permitted to exceed swap plus this percentage</font></div><div><font size="2"   >of physical RAM. &nbsp;See above.</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>