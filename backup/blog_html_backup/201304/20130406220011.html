<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Postgres-XC count() agg in function BUG</h2>
	<h5 id="">2013-04-06 22:00:11&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013368542925/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">在使用Postgres-XC函数是遇到一个BUG, 使用count(*)查询一个表并记录到变量时结果异常.<wbr><div>如下 :&nbsp;</div><div>创建4个测试表, 分别使用4种分布方法(hasn, modulo, round robin, replication) :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create table count_test1(id int primary key, info text) distribute by hash(id) to group gp0;</font></div><div><font size="2"   >digoal=&gt; create table count_test2(id int primary key, info text) distribute by modulo(id) to group gp0;</font></div><div><font size="2"   >digoal=&gt; create table count_test3(id int, info text) distribute by round robin to group gp0;</font></div><div><font size="2"   >digoal=&gt; create table count_test4(id int primary key, info text) distribute by replication to group gp0;</font></div><p></p></pre></div><div># 插入测试数据</div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; insert into count_test1 select generate_series(1,10000),md5(random()::text);</font></div><div><font size="2"   >INSERT 0 10000</font></div><div><font size="2"   >Time: 3025.973 ms</font></div><div><font size="2"   >digoal=&gt; insert into count_test2 select generate_series(1,10000),md5(random()::text);</font></div><div><font size="2"   >INSERT 0 10000</font></div><div><font size="2"   >Time: 3428.379 ms</font></div><div><font size="2"   >digoal=&gt; insert into count_test3 select generate_series(1,10000),md5(random()::text);</font></div><div><font size="2"   >INSERT 0 10000</font></div><div><font size="2"   >Time: 3563.013 ms</font></div><div><font size="2"   >digoal=&gt; insert into count_test4 select generate_series(1,10000),md5(random()::text);</font></div><div><font size="2"   >INSERT 0 10000</font></div><div><font size="2"   >Time: 3569.041 ms</font></div><p></p></pre></div><div># 验证count(*)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select count(*) from count_test1;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;10000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 2.847 ms</font></div><div><font size="2"   >digoal=&gt; select count(*) from count_test2;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;10000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 2.873 ms</font></div><div><font size="2"   >digoal=&gt; select count(*) from count_test3;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;10000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 2.533 ms</font></div><div><font size="2"   >digoal=&gt; select count(*) from count_test4;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;10000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 4.075 ms</font></div><p></p></pre></div><div># 验证各个点的数据 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# execute direct on datanode_1 'select count(*) from digoal.count_test1';</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; 1982</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# execute direct on datanode_2 'select count(*) from digoal.count_test1';</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; 2040</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# execute direct on datanode_3 'select count(*) from digoal.count_test1';</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; 1959</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# execute direct on datanode_4 'select count(*) from digoal.count_test1';</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; 2017</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# execute direct on datanode_5 'select count(*) from digoal.count_test1';</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; 2002</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div># replication表每个节点数据一致.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# execute direct on datanode_1 'select count(*) from digoal.count_test4';</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;10000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# execute direct on datanode_2 'select count(*) from digoal.count_test4';</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;10000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# execute direct on datanode_3 'select count(*) from digoal.count_test4';</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;10000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# execute direct on datanode_4 'select count(*) from digoal.count_test4';</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;10000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# execute direct on datanode_5 'select count(*) from digoal.count_test4';</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;10000</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div># 以下函数, 正常结果应该为10000. 实际返回5</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; create or replace function f_count() returns int as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; ret int8;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select count(*) into ret from count_test1;</font></div><div><font size="2"   >&nbsp; raise notice 'count: %.', ret;</font></div><div><font size="2"   >&nbsp; return ret;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql;</font></div></div><div><div><font size="2"   >digoal=&gt; select * from f_count();</font></div><div><font size="2"   >NOTICE: &nbsp;count: 5.</font></div><div><font size="2"   >&nbsp;f_count&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;5</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div># 返回1</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create or replace function f_count() returns int as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; ret int8;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select count(*) into ret from count_test1 where id=1;</font></div><div><font size="2"   >&nbsp; raise notice 'count: %.', ret;</font></div><div><font size="2"   >&nbsp; return ret;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >digoal=&gt; select * from f_count();</font></div><div><font size="2"   >NOTICE: &nbsp;count: 1.</font></div><div><font size="2"   >&nbsp;f_count&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 以下函数, 正常结果应该为99. 实际返回5.&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create or replace function f_count() returns int as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; ret int8;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select count(*) into ret from count_test1 where id&lt;100;</font></div><div><font size="2"   >&nbsp; raise notice 'count: %.', ret;</font></div><div><font size="2"   >&nbsp; return ret;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >digoal=&gt; select * from f_count();</font></div><div><font size="2"   >NOTICE: &nbsp;count: 5.</font></div><div><font size="2"   >&nbsp;f_count&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;5</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div># 当表为replication时, 返回正常结果</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create or replace function f_count() returns int as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; ret int8;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select count(*) into ret from count_test4 where id&lt;100;</font></div><div><font size="2"   >&nbsp; raise notice 'count: %.', ret;</font></div><div><font size="2"   >&nbsp; return ret;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >digoal=&gt; select * from f_count();</font></div><div><font size="2"   >NOTICE: &nbsp;count: 99.</font></div><div><font size="2"   >&nbsp;f_count&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 99</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div># online code</div><div>将以上函数在online code中执行, 结果一样有问题. replication table没有问题.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; do language plpgsql $$ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; ret int8;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select count(*) into ret from count_test4 where id&lt;100;</font></div><div><font size="2"   >&nbsp; raise notice 'count: %.', ret;</font></div><div><font size="2"   >end; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >NOTICE: &nbsp;count: 99.</font></div><div><font size="2"   >DO</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; ret int8;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select count(*) into ret from count_test1 where id&lt;100;</font></div><div><font size="2"   >&nbsp; raise notice 'count: %.', ret;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >NOTICE: &nbsp;count: 5.</font></div><div><font size="2"   >DO</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; ret int8;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select count(*) into ret from count_test2 where id&lt;100;</font></div><div><font size="2"   >&nbsp; raise notice 'count: %.', ret;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >NOTICE: &nbsp;count: 5.</font></div><div><font size="2"   >DO</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; ret int8;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select count(*) into ret from count_test3 where id&lt;100;</font></div><div><font size="2"   >&nbsp; raise notice 'count: %.', ret;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >NOTICE: &nbsp;count: 5.</font></div><div><font size="2"   >DO</font></div><p></p></pre></div></div><div><br></div><div>[需要返回正常的结果, 可以使用动态SQL]</div><div># 使用动态SQL的话, 以上异常的结果返回都正常了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; ret int8;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; execute 'select count(*) from count_test3 where id&lt;100' into ret;</font></div><div><font size="2"   >&nbsp; raise notice 'count: %.', ret;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >NOTICE: &nbsp;count: 99.</font></div><div><font size="2"   >DO</font></div><p></p></pre></div><div># 使用execute direct语句返回结果也是正常的.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; ret int8;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; execute 'execute direct on datanode_1 $_$select count(*) from digoal.count_test1$_$' into ret;</font></div><div><font size="2"   >&nbsp; raise notice 'count: %.', ret;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >NOTICE: &nbsp;count: 1982.</font></div><div><font size="2"   >DO</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; ret int8;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; execute 'execute direct on datanode_2 $_$select count(*) from digoal.count_test1$_$' into ret;</font></div><div><font size="2"   >&nbsp; raise notice 'count: %.', ret;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >NOTICE: &nbsp;count: 2040.</font></div><div><font size="2"   >DO</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>