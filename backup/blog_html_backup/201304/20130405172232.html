<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Postgres-XC customized tablespace, role, database, schema usage</h2>
	<h5 id="">2013-04-05 17:22:32&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013353942527/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>Postgres-XC和单节点的PostgreSQL节点一样可以支持表空间, 数据库, 角色以及schema.</div><div>但是需要注意的是Postgres-XC自己创建的角色, 数据库, 表空间, schema必须在所有的coordinator, datanode节点上一致.&nbsp;</div><div>否则DDL语句可能会报错.</div><div>例如在单节点的PostgreSQL数据库中执行如下SQL :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >\c digoal digoal</font></div><div><font size="2"   >create table digoal.test(id int primary key, info text) tablespace tbs_digoal;</font></div></pre></div><div>在Postgres-XC节点中执行时需要考虑以下问题 :&nbsp;</div><div>1. 所有的coordinator 以及datanode节点必须存在digoal数据库</div><div><div style="line-height: 22px;"   >2. 所有的coordinator&nbsp;<span style="line-height: 22px;"   >以及datanode</span><span style="line-height: 22px;"   >节点必须存在digoal用户</span></div></div><div><div style="line-height: 22px;"   >3. 所有的coordinator&nbsp;<span style="line-height: 22px;"   >以及datanode</span><span style="line-height: 22px;"   >节点的digoal库中必须存在digoal schema</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >4.&nbsp;</span><span style="line-height: 22px;"   >所有的coordinator&nbsp;</span><span style="line-height: 22px;"   >以及datanode</span><span style="line-height: 22px;"   >节点</span><span style="line-height: 22px;"   >必须存在tbs_digoal表空间.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >5.&nbsp;</span><span style="line-height: 22px;"   >所有的coordinator&nbsp;</span><span style="line-height: 22px;"   >以及datanode</span><span style="line-height: 22px;"   >节点</span><span style="line-height: 22px;"   >必须配置如下权限 :&nbsp;</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >&nbsp; &nbsp; 允许digoal用户连接digoal库, 并且在digoal schema中创建表的权限.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >&nbsp; &nbsp; digoal用户写表空间tbs_digoal的权限.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >具体的操作方法如下 :&nbsp;</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >1. 新建用户</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >连接到Postgres-XC集群中的任意一台coordinator节点, 前提条件是已经正常的配置了pgxc_node(包含所有的coordinator和datanode).</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >执行以下SQL :&nbsp;</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create role digoal nosuperuser login encrypted password 'digoal';</font></div><div><font size="2"   >CREATE ROLE</font></div><p></p></pre></div><div>这样将会自动在pgxc_node中的所有节点执行以上SQL.</div></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >2. 新建表空间</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >注意如果datanode和coordinator部署在同一台服务器上, 就不能使用以上方法创建表空间. 因为要指定不同的表空间目录.</span></div><div style="line-height: 22px;"   >实际上在Postgres-XL中可以直接创建, 因为在表空间目录的子目录中会使用节点名后缀, 所以目录不会冲突, 详<span style="line-height: 22px;"   >见 :&nbsp;</span></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201462511494662/"   >http://blog.163.com/digoal@126/blog/static/163877040201462511494662/</a></div><div><br></div><div>所以没有本文如此麻烦, 在不支持节点名后缀时才需要如此.</div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >需要使用execute direct on node_name $$SQL$$; 来创建表空间.</div><div style="line-height: 22px;"   >例如 :&nbsp;</div><div style="line-height: 22px;"   >假设当前环境如下 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from pgxc_node order by node_name;</font></div><div><font size="2"   >&nbsp; node_name &nbsp; | node_type | node_port | &nbsp; &nbsp;node_host &nbsp; &nbsp;| nodeis_primary | nodeis_preferred | &nbsp; node_id &nbsp;&nbsp;</font></div><div><font size="2"   >--------------+-----------+-----------+-----------------+----------------+------------------+-------------</font></div><div><font size="2"   >&nbsp;coordinate_1 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1921 | db-172-16-19-11 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;-922782310</font></div><div><font size="2"   >&nbsp;coordinate_2 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1921 | db-172-16-19-13 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;1027955327</font></div><div><font size="2"   >&nbsp;coordinate_3 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1921 | db-172-16-19-15 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; 183504851</font></div><div><font size="2"   >&nbsp;coordinate_4 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1921 | db-172-16-19-17 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| -1338651536</font></div><div><font size="2"   >&nbsp;coordinate_5 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1921 | 127.0.0.1 &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;2058409530</font></div><div><font size="2"   >&nbsp;datanode_1 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-172-16-19-11 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;-675012441</font></div><div><font size="2"   >&nbsp;datanode_2 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-172-16-19-13 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| -1047623914</font></div><div><font size="2"   >&nbsp;datanode_3 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-172-16-19-15 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;1787525382</font></div><div><font size="2"   >&nbsp;datanode_4 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-172-16-19-17 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; -83063638</font></div><div><font size="2"   >&nbsp;datanode_5 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-172-16-19-19 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; 137889650</font></div><div><font size="2"   >(10 rows)</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >(在所有的datanode和coordinator节点) 创建表空间目录 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >db-172-16-19-11 : mkdir -p /data01/pgxc_coordinate_tbs/tbs_digoal ; chown -R postgres:postgres&nbsp;<span style="line-height: 22px;"   >/data01/pgxc_coordinate_tbs</span></font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >db-172-16-19-11 : mkdir -p /data01/pgxc_datanode_tbs/tbs_digoal ; chown -R postgres:postgres&nbsp;<span style="line-height: 22px;"   >/data01/pgxc_datanode_tbs</span></font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >db-172-16-19-13 : mkdir -p /data01/pgxc_coordinate_tbs/tbs_digoal ; chown -R postgres:postgres&nbsp;<span style="line-height: 22px;"   >/data01/pgxc_coordinate_tbs</span></font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >db-172-16-19-13 : mkdir -p /data01/pgxc_datanode_tbs/tbs_digoal ; chown -R postgres:postgres&nbsp;<span style="line-height: 22px;"   >/data01/pgxc_datanode_tbs</span></font></div><div><div style="line-height: 22px;"   ><font size="2"   >db-172-16-19-15 : mkdir -p /data01/pgxc_coordinate_tbs/tbs_digoal ; chown -R postgres:postgres&nbsp;<span style="line-height: 22px;"   >/data01/pgxc_coordinate_tbs</span></font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >db-172-16-19-15 : mkdir -p /data01/pgxc_datanode_tbs/tbs_digoal ; chown -R postgres:postgres&nbsp;<span style="line-height: 22px;"   >/data01/pgxc_datanode_tbs</span></font></div><div><div style="line-height: 22px;"   ><font size="2"   >db-172-16-19-17 : mkdir -p /data01/pgxc_coordinate_tbs/tbs_digoal ; chown -R postgres:postgres&nbsp;<span style="line-height: 22px;"   >/data01/pgxc_coordinate_tbs</span></font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >db-172-16-19-17 : mkdir -p /data01/pgxc_datanode_tbs/tbs_digoal ; chown -R postgres:postgres&nbsp;<span style="line-height: 22px;"   >/data01/pgxc_datanode_tbs</span></font></div><div><div style="line-height: 22px;"   ><font size="2"   >db-172-16-19-19 : mkdir -p /data01/pgxc_coordinate_tbs/tbs_digoal ; chown -R postgres:postgres&nbsp;<span style="line-height: 22px;"   >/data01/pgxc_coordinate_tbs</span></font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >db-172-16-19-19 : mkdir -p /data01/pgxc_datanode_tbs/tbs_digoal ; chown -R postgres:postgres&nbsp;<span style="line-height: 22px;"   >/data01/pgxc_datanode_tbs</span></font></div></div></div></div></div></div></div></div></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >(连接到任意1个coordinator节点, 使用超级用户执行以下SQL)</span><span style="line-height: 22px;"   >&nbsp;</span>创建表空间 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >psql -h&nbsp;<span style="line-height: 22px;"   >db-172-16-19-11 -p 1921 -U postgres postgres</span></font></div><div><div><div><font size="2"   >execute direct on datanode_1 $$create tablespace tbs_digoal location '/data01/pgxc_datanode_tbs/tbs_digoal'$$;</font></div><div><font size="2"   >execute direct on coordinate_1 $$create tablespace tbs_digoal location '/data01/pgxc_coordinate_tbs/tbs_digoal'$$;</font></div><div><font size="2"   >execute direct on datanode_2 $$create tablespace tbs_digoal location '/data01/pgxc_datanode_tbs/tbs_digoal'$$;</font></div><div><font size="2"   >execute direct on coordinate_2 $$create tablespace tbs_digoal location '/data01/pgxc_coordinate_tbs/tbs_digoal'$$;</font></div><div><font size="2"   >execute direct on datanode_3 $$create tablespace tbs_digoal location '/data01/pgxc_datanode_tbs/tbs_digoal'$$;</font></div><div><font size="2"   >execute direct on coordinate_3 $$create tablespace tbs_digoal location '/data01/pgxc_coordinate_tbs/tbs_digoal'$$;</font></div><div><font size="2"   >execute direct on datanode_4 $$create tablespace tbs_digoal location '/data01/pgxc_datanode_tbs/tbs_digoal'$$;</font></div><div><font size="2"   >execute direct on coordinate_4 $$create tablespace tbs_digoal location '/data01/pgxc_coordinate_tbs/tbs_digoal'$$;</font></div><div><font size="2"   >execute direct on datanode_5 $$create tablespace tbs_digoal location '/data01/pgxc_datanode_tbs/tbs_digoal'$$;</font></div><div><font size="2"   >execute direct on coordinate_5 $$create tablespace tbs_digoal location '/data01/pgxc_coordinate_tbs/tbs_digoal'$$;</font></div></div></div><p></p></pre></div><div>注意本地节点不能使用execute direct来执行,</div><div><pre class="prettyprint"   ><p><font size="2"   >ERROR: &nbsp;EXECUTE DIRECT cannot execute locally this utility query</font></p></pre></div><div><span style="line-height: 22px;"   >(连接到任意另1个coordinator节点, 使用超级用户执行以下SQL)</span><span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >创建表空间 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >psql -h&nbsp;</span><span style="line-height: 22px;"   >db-172-16-19-12 -p 1921 -U postgres postgres</span></font></div><div><span style="line-height: 22px;"   ><font size="2"   >execute direct on coordinate_1 $$create tablespace tbs_digoal location '/data01/pgxc_coordinate_tbs/tbs_digoal'$$;</font></span></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >3.&nbsp;</span><span style="line-height: 22px;"   >(连接到任意1个coordinator节点, 使用超级用户执行以下SQL)</span><span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >新建数据库</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >psql -h&nbsp;</span><span style="line-height: 22px;"   >db-172-16-19-11 -p 1921 -U postgres postgres</span></font></div><div><font size="2"   >create database digoal with owner postgres template template0 encoding 'UTF8' tablespace tbs_digoal;</font></div><p></p></pre></div><div><br></div><div>4.<span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >(连接到任意1个coordinator节点, 使用超级用户执行以下SQL)</span><span style="line-height: 22px;"   >&nbsp;新建用户</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >psql -h&nbsp;</span><span style="line-height: 22px;"   >db-172-16-19-11 -p 1921 -U postgres postgres</span></font></div><div><span style="line-height: 22px;"   ><font size="2"   ><div>postgres=# create role digoal nosuperuser login encrypted password 'digoal';</div><div>CREATE ROLE</div></font></span></div><p></p></pre></div><div><br></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >5.&nbsp;</span><span style="line-height: 22px;"   >(连接到任意1个coordinator节点, 使用超级用户执行以下SQL)</span><span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >赋予权限</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >psql -h&nbsp;</span><span style="line-height: 22px;"   >db-172-16-19-11 -p 1921 -U postgres postgres</span></font></div><div><div><font size="2"   >postgres=# grant all on database digoal to digoal;</font></div><div><font size="2"   >GRANT</font></div></div><div><div><font size="2"   >postgres=# grant all on tablespace tbs_digoal to digoal;</font></div><div><font size="2"   >GRANT</font></div></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6.&nbsp;</span><span style="line-height: 22px;"   >(连接到任意1个coordinator节点, 使用超级用户执行以下SQL)</span><span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >新建schema</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >psql -h&nbsp;</span><span style="line-height: 22px;"   >db-172-16-19-11 -p 1921 -U postgres postgres</span></font></div><div><div><font size="2"   >postgres=# \c digoal digoal</font></div><div><font size="2"   >You are now connected to database "digoal" as user "digoal".</font></div><div><font size="2"   >digoal=&gt; create schema digoal ;</font></div><div><font size="2"   >CREATE SCHEMA</font></div></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >7.&nbsp;</span><span style="line-height: 22px;"   >(连接到任意1个coordinator节点, 使用超级用户执行以下SQL)</span><span style="line-height: 22px;"   >&nbsp;</span><span style="line-height: 22px;"   >新建表</span></div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >psql -h&nbsp;</span><span style="line-height: 22px;"   >db-172-16-19-11 -p 1921 -U postgres postgres</span></font></div><div><div><font size="2"   >digoal=&gt; create table digoal.test(id int primary key, info text) tablespace tbs_digoal distribute by hash(id) to node datanode_1,datanode_2,datanode_3,datanode_4,datanode_5;</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "test_pkey" for table "test"</font></div><div><font size="2"   >CREATE TABLE</font></div></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >【注意】</div><div style="line-height: 22px;"   >1. 执行DDL前一定要确保pgxc_pool_check()返回真.</div><div style="line-height: 22px;"   >如果不为真, 使用pgxc_pool_reload() 重置. 再执行<span style="line-height: 22px;"   >pgxc_pool_check()检查pool和pgxc_node是否一致.</span></div><div style="line-height: 22px;"   >这样才能确保接下来要执行的DDL会在所有的coordinator DDL同步.</div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >【参考】</div><div style="line-height: 22px;"   >1.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020133292915600/"   >http://blog.163.com/digoal@126/blog/static/16387704020133292915600/</a></div></div></div>
	</div>
</div>
</body>
</html>