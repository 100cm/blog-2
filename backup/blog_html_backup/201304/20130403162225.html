<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Postgres-XC can add normal PostgreSQL node to XC's datanode?</h2>
	<h5 id="">2013-04-03 16:22:25&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020133335814136/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">从Postgres-XC的架构来看, datanode只是充当了存储数据的角色. 理论上是可以使用普通的PostgreSQL节点来充当普通节点的.<div>但是实际上做了限制, 至少从以下的测试来看, 连接参数就做过改动.</div><div>不仅如此, XID也做了改动, 需要从GTM申请. 还有snapshot的机制.</div><div>本文主要折腾一下, 如果把普通的PostgreSQL 加到datanode角色去会出什么样的问题.</div><div><br></div><div>当然就算不做任何限制, 还是会有其他的问题存在的, 因为还涉及到其他的修改, 例如聚合函数. Postgres-XC中聚合函数类似mapreduce, 需要多节点的汇聚, 甚至可以做多次的mapreduce. 未来Postgres-XC是否能在数据仓库领域大有可为至少聚合函数这块要有比较便利的开发框架才行.</div><div><br></div><div>下面尝试将普通的数据库节点添加到某个Postgres-XC的coordinator节点 :&nbsp;</div><div>测试环境请参考 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020133292915600/"   >http://blog.163.com/digoal@126/blog/static/16387704020133292915600/</a></div><div>1. 配置普通数据库节点</div><div>vi pg_hba.conf</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >host all all 192.168.122.0/24 trust</font></div><div><font size="2"   >pg_ctl reload</font></div><p></p></pre></div><div><br></div><div>2. 操作Postgres-XC中的任意一个coordinator</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# create node test with (type=datanode, host='192.168.122.1', port=1921);</font></div><div><font size="2"   >CREATE NODE</font></div><div><font size="2"   >postgres=# select * from pgxc_node;</font></div><div><font size="2"   >&nbsp; node_name &nbsp; | node_type | node_port | &nbsp; &nbsp; node_host &nbsp; &nbsp; &nbsp;| nodeis_primary | nodeis_preferred | &nbsp; node_id &nbsp;&nbsp;</font></div><div><font size="2"   >--------------+-----------+-----------+--------------------+----------------+------------------+-------------</font></div><div><font size="2"   >&nbsp;coordinate_6 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1921 | db-192-168-122-178 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;15814306</font></div><div><font size="2"   >&nbsp;datanode_2 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-174 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| -1047623914</font></div><div><font size="2"   >&nbsp;datanode_3 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-175 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;1787525382</font></div><div><font size="2"   >&nbsp;datanode_4 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-176 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; -83063638</font></div><div><font size="2"   >&nbsp;datanode_5 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-177 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; 137889650</font></div><div><font size="2"   >&nbsp;coordinate_1 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1921 | db-192-168-122-173 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;-922782310</font></div><div><font size="2"   >&nbsp;coordinate_2 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1921 | db-192-168-122-174 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;1027955327</font></div><div><font size="2"   >&nbsp;coordinate_3 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1921 | db-192-168-122-175 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; 183504851</font></div><div><font size="2"   >&nbsp;coordinate_4 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1921 | db-192-168-122-176 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| -1338651536</font></div><div><font size="2"   >&nbsp;coordinate_5 | C &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1921 | db-192-168-122-177 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;2058409530</font></div><div><font size="2"   >&nbsp;datanode_6 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-178 | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;-678318491</font></div><div><font size="2"   >&nbsp;datanode_1 &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1923 | db-192-168-122-173 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;-675012441</font></div><div><font size="2"   >&nbsp;test &nbsp; &nbsp; &nbsp; &nbsp; | D &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;1921 | 192.168.122.1 &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;1771415073</font></div><div><font size="2"   >(13 rows)</font></div></div><div><div><font size="2"   >postgres=# \set VERBOSITY verbose</font></div></div><p></p></pre></div><div><div># 在新建的普通postgresql数据库节点新建表.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# create table test(id int primary key, info text) distribute by (id) to node test;</font></div><div><font size="2"   >NOTICE: &nbsp;00000: CREATE TABLE / PRIMARY KEY will create implicit index "test_pkey" for table "test"</font></div><div><font size="2"   >LOCATION: &nbsp;DefineIndex, indexcmds.c:428</font></div><div><font size="2"   >ERROR: &nbsp;42710: PGXC Node test: object not defined</font></div></div><div><font size="2"   >LOCATION: &nbsp;pgxc_node_report_error, execRemote.c:4697</font></div><p></p></pre></div></div><div># 这里报错是因为其他coordinator节点没有定义test节点.</div><div># 因此我们删掉这些coordinator, 保留本地节点即可.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# drop NODE coordinate_1;</font></div><div><font size="2"   >DROP NODE</font></div><div><font size="2"   >postgres=# drop NODE coordinate_2;</font></div><div><font size="2"   >DROP NODE</font></div></div><div><div><font size="2"   >postgres=# drop NODE coordinate_4;</font></div><div><font size="2"   >DROP NODE</font></div><div><font size="2"   >postgres=# drop NODE coordinate_5;</font></div><div><font size="2"   >DROP NODE</font></div><div><font size="2"   >postgres=# drop NODE coordinate_6;</font></div><div><font size="2"   >DROP NODE</font></div></div><div><div><font size="2"   >postgres=# create table test(id int primary key, info text) distribute by (id) to node test;</font></div><div><font size="2"   >NOTICE: &nbsp;00000: CREATE TABLE / PRIMARY KEY will create implicit index "test_pkey" for table "test"</font></div><div><font size="2"   >LOCATION: &nbsp;DefineIndex, indexcmds.c:428</font></div><div><font size="2"   >ERROR: &nbsp;42710: PGXC Node test: object not defined</font></div><div><font size="2"   >LOCATION: &nbsp;pgxc_node_report_error, execRemote.c:4697</font></div></div><p></p></pre></div><div># 现在还报错, 是因为coordinator pool未重载.</div><div><br></div><div>3. 重载pool</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select pgxc_pool_reload();</font></div><div><font size="2"   >&nbsp;pgxc_pool_reload&nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp;t</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >postgres=# \q</font></div><div><font size="2"   >[pgxc@db-192-168-122-175 ~]$ psql -h 127.0.0.1</font></div><div><font size="2"   >psql (PGXC 1.0.2, based on PG 9.1.7)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><div><font size="2"   >postgres=# \set VERBOSITY verbose</font></div><div><font size="2"   >postgres=# create table test(id int primary key, info text) distribute by (id) to node test;</font></div><div><font size="2"   >NOTICE: &nbsp;00000: CREATE TABLE / PRIMARY KEY will create implicit index "test_pkey" for table "test"</font></div><div><font size="2"   >LOCATION: &nbsp;DefineIndex, indexcmds.c:428</font></div><div><font size="2"   >ERROR: &nbsp;53000: Failed to get pooled connections</font></div><div><font size="2"   >LOCATION: &nbsp;get_handles, pgxcnode.c:1912</font></div></div><p></p></pre></div><div># 注意现在报的错不一样了.</div><div><br></div><div>4. 观察普通数据库节点的日志</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2013-04-03 15:43:28.979 CST,,,17595,"",515bdda0.44bb,1,"",2013-04-03 15:43:28 CST,,0,LOG,00000,"connection received: host=192.168.122.175 port=12185",,,,,,,,"BackendInitialize, postmaster.c:3476",""</font></div><div><font size="2"   >2013-04-03 15:43:28.980 CST,"postgres","postgres",17595,"192.168.122.175:12185",515bdda0.44bb,2,"authentication",2013-04-03 15:43:28 CST,2/124055,0,LOG,00000,"connection authorized: user=postgres database=postgres",,,,,,,,"PerformAuthentication, postinit.c:230",""</font></div><div><font size="2"   >2013-04-03 15:43:28.981 CST,"postgres","postgres",17595,"192.168.122.175:12185",515bdda0.44bb,3,"startup",2013-04-03 15:43:28 CST,2/124055,0,FATAL,42704,"unrecognized configuration parameter ""remotetype""",,,,,,,,"set_config_option, guc.c:5158",""</font></div><p></p></pre></div><div><br></div>原因是Postgres-XC修改了连接参数 :<wbr></div><div>src/backend/utils/misc/guc.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#ifdef PGXC</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {"remotetype", PGC_BACKEND, CONN_AUTH,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gettext_noop("Sets the type of Postgres-XC remote connection"),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NULL</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;remoteConnType,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; REMOTE_CONN_APP, pgxc_conn_types,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NULL, NULL, NULL</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; },</font></div><div><font size="2"   >#endif</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >src/backend/pgxc/pool/pgxcnode.c</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* Builds up a connection string</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >char *</font></div><div><font size="2"   >PGXCNodeConnStr(char *host, int port, char *dbname,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; char *user, char *pgoptions, char *remote_type)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *out,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; connstr[256];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; num;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Build up connection string</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* remote type can be Coordinator, Datanode or application.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; num = snprintf(connstr, sizeof(connstr),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"host=%s port=%d dbname=%s user=%s application_name=pgxc options='-c remotetype=%s %s'",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;host, port, dbname, user, remote_type, pgoptions);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Check for overflow */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (num &gt; 0 &amp;&amp; num &lt; sizeof(connstr))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Output result */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out = (char *) palloc(num + 1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; strcpy(out, connstr);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return out;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* return NULL if we have problem */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"   >}</font></div><p></p></pre></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="Postgres-XC can add normal PostgreSQL node to XCs datanode? - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">zhangqhd511 - 2014-01-15 10:55:30</h5>
				<div>德哥，请教个问题：<div>我想在现有的PGXC群集里 添加DATANODE 在coordinator 重载后 创建库没有问题，但是在现有的库里新建表都报错 就是：<span style=""  >Failed to get pooled connections   </span></div><div><span style=""  >在新datanode 的日志里能看到的错误是 不存在xx库  ，我想如果手动创建库 和相应的表 就没问题了，可以找个时候的datanode 是只读模式的， 找了一天的资料没有什么收获。。。。</span></div><div><span style=""  >德哥 给点建议 谢谢</span></div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 zhangqhd511 - 2014-01-15 10:55:30</h5>
				<div style="width:600px;">重载后结构变更应该要刷一下配置. 再去创建, 否则会沿用老的配置, 新的PGXC版本不知道还有没有这个问题.</div>
			</div>
	</div>
</div>
</body>
</html>