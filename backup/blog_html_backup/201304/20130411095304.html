<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL, disable tcp SO_KEEPALIVE, connection tuning</h2>
	<h5 id="">2013-04-11 9:53:04&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201331194014892/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">前面一篇BLOG介绍了如何使用tcp keepalive解决防火墙的会话超时关闭的问题.<div><a href="http://blog.163.com/digoal@126/blog/static/163877040201331041830502/"   >http://blog.163.com/digoal@126/blog/static/163877040201331041830502/</a></div><div>但是tcp keepalive需要计时器, 如果连接数很多的话, 可能会带来一定的开销.</div><div>这里介绍一下在PostgreSQL中如何禁用keepalive.</div><div>修改src/backend/libpq/pqcomm.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >root@digoal-PowerEdge-R610-&gt; cd /data01/soft_bak/postgresql-9.2.4/src/backend/libpq/</font></div><div><font size="2"   >root@digoal-PowerEdge-R610-&gt; vi pqcomm.c</font></div></div><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* StreamConnection -- create a new connection with client using</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;server port. &nbsp;Set port-&gt;sock to the FD of the new connection.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* ASSUME: that this doesn't need to be non-blocking because</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;the Postmaster uses select() to tell when the server master</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;socket is ready for accept().</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* RETURNS: STATUS_OK or STATUS_ERROR</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >int</font></div><div><font size="2"   >StreamConnection(pgsocket server_fd, Port *port)</font></div></div><p></p></pre></div><div>.... 略, 修改以下行.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; on = 0; &nbsp;//modify by digoal, old_val: &nbsp; on = 1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (setsockopt(port-&gt;sock, SOL_SOCKET, SO_KEEPALIVE,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(char *) &amp;on, sizeof(on)) &lt; 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(LOG, "setsockopt(SO_KEEPALIVE) failed: %m");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return STATUS_ERROR;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div><div># 将pg_config包含到$PATH. 略.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >root@digoal-PowerEdge-R610-&gt; make clean</font></div><div><font size="2"   >rm -f objfiles.txt be-fsstubs.o be-secure.o auth.o crypt.o hba.o ip.o md5.o pqcomm.o pqformat.o pqsignal.o</font></div><div><font size="2"   >root@digoal-PowerEdge-R610-&gt; make</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -g -I../../../src/include -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o be-fsstubs.o be-fsstubs.c</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -g -I../../../src/include -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o be-secure.o be-secure.c</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -g -I../../../src/include -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o auth.o auth.c</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -g -I../../../src/include -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o crypt.o crypt.c</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -g -I../../../src/include -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o hba.o hba.c</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -g -I../../../src/include -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o ip.o ip.c</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -g -I../../../src/include -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o md5.o md5.c</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -g -I../../../src/include -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o pqcomm.o pqcomm.c</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -g -I../../../src/include -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o pqformat.o pqformat.c</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -g -I../../../src/include -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o pqsignal.o pqsignal.c</font></div><div><font size="2"   >( echo src/backend/libpq/be-fsstubs.o src/backend/libpq/be-secure.o src/backend/libpq/auth.o src/backend/libpq/crypt.o src/backend/libpq/hba.o src/backend/libpq/ip.o src/backend/libpq/md5.o src/backend/libpq/pqcomm.o src/backend/libpq/pqformat.o src/backend/libpq/pqsignal.o ) &gt;objfiles.txt</font></div></div><div><div><font size="2"   >root@digoal-PowerEdge-R610-&gt; cd ..</font></div><div><font size="2"   >root@digoal-PowerEdge-R610-&gt; pwd</font></div><div><font size="2"   >/data01/soft_bak/postgresql-9.2.4/src/backend</font></div><div><font size="2"   >root@digoal-PowerEdge-R610-&gt; make install</font></div></div><p></p></pre></div><div># 重启数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@digoal-PowerEdge-R610-&gt; su - pg92</font></div><div><font size="2"   >pg_pg92@digoal-PowerEdge-R610-&gt; pg_ctl restart -m fast -D $PGDATA</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div><div><font size="2"   >server starting</font></div><p></p></pre></div><div># 打开一个客户端连接数据库,</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-33-&gt; psql -h 172.16.3.150 -p 1919 -U postgres postgres</font></div><div><font size="2"   >psql (9.2.4)</font></div><div><font size="2"   >Type "help" for help.</font></div><p></p></pre></div><div># 检查keepalive是否关闭</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-PowerEdge-R610-&gt; netstat -anpo|grep 1919</font></div><div><font size="2"   >(Not all processes could be identified, non-owned process info</font></div><div><font size="2"   >&nbsp;will not be shown, you would have to be root to see it all.)</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:1919 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;13895/postgres &nbsp; off (0.00/0/0)</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 172.16.3.150:1919 &nbsp; &nbsp; &nbsp; 172.16.3.33:62769 &nbsp; &nbsp; &nbsp; ESTABLISHED 13903/postgres: pos off (0.00/0/0)</font></div><p></p></pre></div><div># 显示已经关闭了keepalive</div><div><br></div><div><p></p></div><div>[参考]</div><div>1.&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201331041830502/"   >http://blog.163.com/digoal@126/blog/static/163877040201331041830502/</a></div><div>2.&nbsp;src/backend/libpq/pqcomm.c<br><wbr></div>3. man 7 &nbsp;tcp</div>
	</div>
</div>
</body>
</html>