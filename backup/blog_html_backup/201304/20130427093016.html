<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL Use rsync instead of pg_basebackup when create standby in wan environment</h2>
	<h5 id="">2013-04-27 9:30:16&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020133277305874/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>上一篇BLOG简单的介绍了一下PostgreSQL广域网的容灾.</div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402013324103828603/"   >http://blog.163.com/digoal@126/blog/static/1638770402013324103828603/</a></div><div>里面介绍的主要是standby搭建好之后的一些注意要点, 本文主要介绍一下广域网搭建standby的注意要点.</div><div>广域网对本案影响最大的问题如下 :&nbsp;</div><div>问题1. 带宽</div><div>广域网带宽小将致使创建standby的整个数据复制过程变长, 时间越长, 主库在这段时间的变化量也就, xlog文件越多.&nbsp;</div><div>带来的后果是standby基础备份做好后要恢复大量的xlog文件.</div><div>如果主库没有对pg_xlog做archive的话, 那么复制可能无效, 因为需要的pg_xlog已经被覆盖了.</div><div>解决办法1:</div><div>&nbsp; &nbsp; 加大主库的wal_keep_segments, 确保基础备份的时间段内pg_xlog不会被覆盖.</div><div><span style="line-height: 22px;"   >解决办法2:</span></div><div><span style="line-height: 22px;"   >&nbsp; &nbsp; 在主库添加pg_xlog归档.&nbsp;</span></div><div><span style="line-height: 22px;"   >解决办法3:</span></div><div><span style="line-height: 22px;"   >&nbsp; &nbsp; 在备库或其他地方使用pg_</span><span style="line-height: 22px;"   >receivexlog实时接收主库产生的xlog文件.</span></div><div><span style="line-height: 22px;"   >以上三种解决办法都是为了保留standby需要的最早的pg_xlog文件开始的所有pg_xlog文件.</span></div><div><br></div><div>问题2. 稳定性</div><div>广域网的稳定性也是一个问题, 我这几天在使用pg_basebackup创建standby的过程中发现, 网络会不定期的被断开连接.</div><div>断开时在主库看到的日志信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2013-04-27 05:26:14.729 CST,"digoal","",27083,"192.1.1.1:58679",5179c9ad.69cb,4,"sending backup ""pg_basebackup base backup""",2013-04-26 08:26:21 CST,59/0,0,LOG,08006,"could not send data to client: Connection reset by peer",,,,,,,,"internal_flush, pqcomm.c:1253","pg_basebackup"</font></div><div><font size="2"   >2013-04-27 05:26:14.729 CST,"digoal","",27083,"192.1.1.1:58679",5179c9ad.69cb,5,"sending backup ""pg_basebackup base backup""",2013-04-26 08:26:21 CST,59/0,0,FATAL,XX000,"base backup could not send data, aborting backup",,,,,,,,"sendFile, basebackup.c:1027","pg_basebackup"</font></div><div><font size="2"   >2013-04-27 05:26:14.729 CST,"digoal","",27083,"192.1.1.1:58679",5179c9ad.69cb,6,"sending backup ""pg_basebackup base backup""",2013-04-26 08:26:21 CST,59/0,0,LOG,08006,"could not send data to client: Broken pipe",,,,,,,,"internal_flush, pqcomm.c:1253","pg_basebackup"</font></div><div><font size="2"   >2013-04-27 05:26:14.729 CST,"digoal","",27083,"192.1.1.1:58679",5179c9ad.69cb,7,"sending backup ""pg_basebackup base backup""",2013-04-26 08:26:21 CST,59/0,0,FATAL,08006,"connection to client lost",,,,,,,,"ProcessInterrupts, postgres.c:2867","pg_basebackup"</font></div><div><font size="2"   >2013-04-27 05:26:14.729 CST,"digoal","",27083,"192.1.1.1:58679",5179c9ad.69cb,8,"sending backup ""pg_basebackup base backup""",2013-04-26 08:26:21 CST,,0,LOG,00000,"disconnection: session time: 20:59:52.949 user=digoal database= host=192.1.1.1 port=58679",,,,,,,,"log_disconnections, postgres.c:4366","pg_basebackup"</font></div><p></p></pre></div><div>原因不明.</div><div>尝试了3次使用pg_basebackup做备份, 都断开了, 而且断开时没有明显特点, 传输速率并没有达到最高时断开过, 传输到3%时断开过, 传输到90%时断开过.&nbsp;</div><div>解决办法 :&nbsp;</div><div>&nbsp; &nbsp;使用rsync代替pg_basebackup, 因为pg_basebackup没有断点续传的功能, 每次失败后都要重新来过. 并且pg_basebackup拷贝的文件时间戳不会保留, 所以即使要做断点续传也比较麻烦.</div><div>&nbsp; &nbsp;rsync 有几个好处, 1. 它可以保留时间戳, 这样的话如果断掉还可以做断点续传. 因为单个数据文件的大小可以在编译数据库时指定, 默认是1GB. 所以即使断掉, 单个文件最多再多传输1次, 而其他的已经传输完整的文件不需要重传, 即使改变了也不需要重传, 因为可以通过pg_xlog恢复.</div><div>&nbsp; &nbsp; 需要注意的是rsync如果中途中断, 未传完的临时文件会保留在目的端, 所以全部结束后需要清除这些临时文件.&nbsp;</div><div>临时文件清除参考:</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201011794210567/"   >http://blog.163.com/digoal@126/blog/static/163877040201011794210567/</a></div><div>&nbsp; &nbsp; 使用rsync注意tcp心跳的设置, 必须要小于经过的所有网络设备的链接超时时间. 否则链接可能被网络设备给关闭掉.</div><div>&nbsp; &nbsp; 修改客户端 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/etc/sysctl.conf</font></div><div><font size="2"   >net.ipv4.tcp_keepalive_time=90</font></div><div><font size="2"   >sysctl -p</font></div><p></p></pre></div><div>建立连接后检查 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >netstat -anpo|grep ssh</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 127.0.0.1:29568 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1:22212 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESTABLISHED 18653/ssh &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; keepalive (23.06/0/0)</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 127.0.0.1:29571 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1:22212 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESTABLISHED 18726/ssh &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; keepalive (37.48/0/0)</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 127.0.0.1:29570 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1:22212 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESTABLISHED 18724/ssh &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; keepalive (18.71/0/0)</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 127.0.0.1:29573 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1:22212 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESTABLISHED 18730/ssh &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; keepalive (69.39/0/0)</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 127.0.0.1:29572 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1:22212 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESTABLISHED 18728/ssh &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; keepalive (73.43/0/0)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >【rsync创建standby举例】</span></div><div>1. 在standby节点创建表空间目录以及$PGDATA目录,pg_xlog等等目录. 修改权限</div><div>在主库上获得需要的目录:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >postgres@db-192-1-1-5-&gt; cd $PGDATA<br>postgres@db-192-1-1-5-&gt; pwd<br>/data02/pg_root<br>postgres@db-192-1-1-5-&gt; ll|grep pg_xlog<br>lrwxrwxrwx 1 postgres postgres   27 Dec 13 18:54 pg_xlog -&gt; /data01/pg_xlog<br>postgres@db-192-1-1-5-&gt; cd $PGDATA/pg_tblspc<br>postgres@db-192-1-1-5-&gt; ll<br>lrwxrwxrwx 1 postgres postgres 24 Feb 20 14:22 16387 -&gt; /data09/digoal<br>lrwxrwxrwx 1 postgres postgres 31 Mar  6 11:11 16388 -&gt; /data06/tbs_digoal_old<br>lrwxrwxrwx 1 postgres postgres 28 Dec 13 18:55 16381 -&gt; /data03/tbs_digoal<br>lrwxrwxrwx 1 postgres postgres 32 Dec 13 18:55 16382 -&gt; /data04/tbs_digoal_idx<br>lrwxrwxrwx 1 postgres postgres 29 Dec 13 18:56 16389 -&gt; /data05/tbs_digoal1<br>postgres@db-192-1-1-5-&gt; cat $PGDATA/postgresql.conf|grep log_directory<br>log_directory = '/var/applog/pg_log'               # directory where log files are written,</span></font></div><p></p></pre></div><div>在standby服务器上创建这些目录:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >mkdir -p /data02/pg_root<br>mkdir -p /data01/pg_xlog<br>mkdir -p /data09/digoal<br>mkdir -p /data06/tbs_digoal_old<br>mkdir -p /data03/tbs_digoal<br>mkdir -p /data04/tbs_digoal_idx<br>mkdir -p /data05/tbs_digoal1<br>mkdir -p /var/applog/pg_log</span></font></div><p></p></pre></div><div># 修改为数据库启动用户权限</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >chown -R postgres:postgres /data02/pg_root<br>chown -R postgres:postgres /data01/pg_xlog<br>chown -R postgres:postgres /data09/digoal<br>chown -R postgres:postgres /data06/tbs_digoal_old<br>chown -R postgres:postgres /data03/tbs_digoal<br>chown -R postgres:postgres /data04/tbs_digoal_idx<br>chown -R postgres:postgres /data05/tbs_digoal1<br>chown -R postgres:postgres /var/applog/pg_log</span></font></div><p></p></pre></div><div># 修改为700</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >chmod -R 700  /data02/pg_root<br>chmod -R 700  /data01/pg_xlog<br>chmod -R 700  /data09/digoal<br>chmod -R 700  /data06/tbs_digoal_old<br>chmod -R 700  /data03/tbs_digoal<br>chmod -R 700  /data04/tbs_digoal_idx<br>chmod -R 700  /data05/tbs_digoal1<br>chmod -R 700  /var/applog/pg_log</span></font></div></pre></div><div>2. 在standby 节点创建秘钥</div><div><pre class="prettyprint"   ><p><font size="2"   >postgres@db-192-1-1-1-&gt; ssh-keygen -t rsa</font></p></pre></div><div>3. 将公钥拷贝到master节点</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - postgres</font></div><div><font size="2"   >chmod 700 ~</font></div><div><font size="2"   >cd ~/.ssh</font></div><div><font size="2"   >vi authorized_keys</font></div><div><font size="2"   >#standby节点上~/.ssh/id_rsa.pub内容拷贝到这里</font></div><div><font size="2"   >chmod 700 ~/.ssh</font></div><div><font size="2"   >chmod 400 ~/.ssh/<span style="line-height: 22px;"   >authorized_keys</span></font></div></pre></div><div># 确保master节点允许公钥验证.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-192-1-1-5 ~]# cat /etc/ssh/sshd_config |grep Pub</font></div><div><font size="2"   >PubkeyAuthentication yes</font></div><p></p></pre></div><div><span style="line-height: 22px;"   ># 如果如果有超时关闭连接的设备, 建议建立隧道.</span></div><div><span style="line-height: 22px;"   ><div><pre class="prettyprint"   ><p><font size="2"   >ssh -o ServerAliveInterval=90 -o ServerAliveCountMax=60 -o CompressionLevel=9 -p&nbsp;<span style="line-height: 22px;"   >remote_direct_ip_ssh_port</span>&nbsp;-CqTfnN -L *:10022:remote_dest_ip:remote_dest_ssh_port postgres@remote_direct_ip</font></p></pre></div><div><span style="line-height: 22px;"   >4. 在standby 节点执行pg_receivexlog (早于pg_start_backup开始, 可以拿到所有需要的pg_xlog文件)</span></div></span></div><div><pre class="prettyprint"   ><p><font size="2"   >pg_receivexlog -D $PGDATA/pg_xlog -v -h 192.1.1.5 -p 5432 -s 60 -U replica</font></p></pre></div><div><span style="line-height: 22px;"   >5. 在master节点执行开始备份</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   ><div>psql</div><div>psql (9.2.4)</div><div>Type "help" for help.</div></font></span></div><div><font size="2"   >postgres=# select pg_start_backup(now()::text);</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >6. master节点执行完pg_start_backup后, 在standby节点执行rsync.</span></div><div><pre class="prettyprint"   ><p style="line-height: 22px;"   ></p><div><font size="2"   ><span style="line-height: 19px;"   >nohup rsync -acvz --progress --rsh='ssh -p 10022' --delete --exclude=pg_xlog* --exclude=*.pid postgres@192.1.1.5:/data02/pg_root/ /data02/pg_root &gt;&gt;/home/postgres/pg_root.log 2&gt;&amp;1 &amp;<br>nohup rsync -acvz --progress --rsh='ssh -p 10022' --delete postgres@192.1.1.5:/data09/digoal/ /data09/digoal &gt;&gt;/home/postgres/digoal.log 2&gt;&amp;1 &amp;<br>nohup rsync -acvz --progress --rsh='ssh -p 10022' --delete postgres@192.1.1.5:/data03/tbs_digoal/ /data03/tbs_digoal &gt;&gt;/home/postgres/tbs_digoal.log 2&gt;&amp;1 &amp;<br>nohup rsync -acvz --progress --rsh='ssh -p 10022' --delete postgres@192.1.1.5:/data05/tbs_digoal1/ /data05/tbs_digoal1 &gt;&gt;/home/postgres/tbs_digoal1.log 2&gt;&amp;1 &amp;<br>nohup rsync -acvz --progress --rsh='ssh -p 10022' --delete postgres@192.1.1.5:/data04/tbs_digoal_idx/ /data04/tbs_digoal_idx &gt;&gt;/home/postgres/tbs_digoal_idx.log 2&gt;&amp;1 &amp;<br>nohup rsync -acvz --progress --rsh='ssh -p 10022' --delete postgres@192.1.1.5:/data06/tbs_digoal_old/ /data06/tbs_digoal_old &gt;&gt;/home/postgres/tbs_digoal_old.log 2&gt;&amp;1 &amp;</span></font></div></pre></div><div><span style="line-height: 22px;"   >7. standby收尾</span></div><div>检查pg_xlog软链接是否正常</div><div>修改postgresql.conf, 监听端口不要与其他端口冲突, standby相关参数等等.</div><div>修改recovery.conf</div><div>停掉pg_receivexlog</div><div>主节点数据库执行pg_stop_backup();</div><div><br></div><div>8. 启动standby</div><div><br></div><div>【其他】</div><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://repmgr.org/"   >http://repmgr.org/</a></div><div>这个管理软件可以用于管理PostgreSQL standby环境, 也可以调用rsync做数据同步.</div><div>有兴趣的朋友可以研究一下, instagram也是用的这个管理软件.</div><div><br></div>【参考】<div>1.&nbsp;<a style="line-height: 22px;" href="http://www.blog.163.com/digoal@126/blog/static/163877040201162541727318/"   >http://www.blog.163.com/digoal@126/blog/static/163877040201162541727318/</a></div><div>2.&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201182885211344/"   >http://blog.163.com/digoal@126/blog/static/163877040201182885211344/</a></div><div>3.&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013324103828603/"   >http://blog.163.com/digoal@126/blog/static/1638770402013324103828603/</a></div><div><div>4.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020115294425540/"   >http://blog.163.com/digoal@126/blog/static/16387704020115294425540/</a></div><div>5.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201152753352356/"   >http://blog.163.com/digoal@126/blog/static/163877040201152753352356/</a></div><div>6.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020132279020755/"   >http://blog.163.com/digoal@126/blog/static/16387704020132279020755/</a></div><div>7.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201011794210567/"   >http://blog.163.com/digoal@126/blog/static/163877040201011794210567/</a></div>8.&nbsp;<wbr></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >pg173212@db-192-168-20-4-&gt; pg_receivexlog --help</font></div><div style="line-height: 22px;"   ><font size="2"   >pg_receivexlog receives PostgreSQL streaming transaction logs.</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >Usage:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; pg_receivexlog [OPTION]...</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >Options:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; -D, --directory=DIR &nbsp; &nbsp;receive transaction log files into this directory</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; -n, --no-loop &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;do not loop on connection lost</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; -v, --verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;output verbose messages</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; -V, --version &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;output version information, then exit</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; -?, --help &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; show this help, then exit</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >Connection options:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; -h, --host=HOSTNAME &nbsp; &nbsp;database server host or socket directory</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; -p, --port=PORT &nbsp; &nbsp; &nbsp; &nbsp;database server port number</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; -s, --status-interval=INTERVAL</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;time between status packets sent to server (in seconds)</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; -U, --username=NAME &nbsp; &nbsp;connect as specified database user</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; -w, --no-password &nbsp; &nbsp; &nbsp;never prompt for password</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; -W, --password &nbsp; &nbsp; &nbsp; &nbsp; force password prompt (should happen automatically)</font></div><div style="line-height: 22px;"   ><font size="2"   >Report bugs to &lt;pgsql-bugs@postgresql.org&gt;.</font></div><p></p></pre></div></div><div style="line-height: 22px;"   >9.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://repmgr.org/"   >http://repmgr.org/</a></div><div style="line-height: 22px;"   ><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL Use rsync instead of pg_basebackup when create standby in wan environment - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>