<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL oltp test benchmark for osc beijing</h2>
	<h5 id="">2014-11-13 13:37:28&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020141013115219217/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>为北京源创会写的一个测试benchmark.&nbsp;</div><div>参考模型</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201221382150858/"   >http://blog.163.com/digoal@126/blog/static/163877040201221382150858/</a></div><div>不太喜欢用sysbench, (开销太大).</div><div><br></div><div><br></div><div>测试环境 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >DELL R610</font></div><div><font size="2"   >$PGDATA &nbsp;OCZ REVODRIVE3 240G</font></div><div><font size="2"   >内存 96G</font></div><div><font size="2"   >CPU E5504 2.0G 8核</font></div><div><font size="2"   >系统 CentOS 6.5 x64</font></div><div><font size="2"   >数据库 PostgreSQL 9.3.5</font></div><div><font size="2"   >CONFIGURE = '--prefix=/opt/pgsql9.3.5' '--with-pgport=5432' '--with-perl' '--with-tcl' '--with-python' '--with-openssl' '--with-pam' '--with-ldap' '--with-libxml' '--with-libxslt' '--enable-thread-safety'</font></div><div><font size="2"   >文件系统 EXT4</font></div><div><font size="2"   ><br></font></div><p></p></pre></div><div><br></div><div>测试数据量 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >用户信息记录1亿, 约15G.</font></div><div><font size="2"   >用户会话记录1亿, 约6G.</font></div><p></p></pre></div><div><br></div><div>数据库参数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"   >max_connections = 100 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >superuser_reserved_connections = 13 &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_directories = '.' &nbsp; # comma-separated list of directories</font></div><div><font size="2"   >tcp_keepalives_idle = 70 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPIDLE, in seconds;</font></div><div><font size="2"   >tcp_keepalives_interval = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPINTVL, in seconds;</font></div><div><font size="2"   >tcp_keepalives_count = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # TCP_KEEPCNT;</font></div><div><font size="2"   >shared_buffers = 8192MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div><font size="2"   >vacuum_cost_delay = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 0-100 milliseconds</font></div><div><font size="2"   >vacuum_cost_limit = 10000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 credits</font></div><div><font size="2"   >bgwriter_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 10-10000ms between rounds</font></div><div><font size="2"   >wal_level = minimal &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, or hot_standby</font></div><div><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level;</font></div><div><font size="2"   >wal_buffers = 16384kB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 32kB, -1 sets based on shared_buffers</font></div><div><font size="2"   >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"   >checkpoint_segments = 512 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # in logfile segments, min 1, 16MB each</font></div><div><font size="2"   >effective_cache_size = 128000MB</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_directory = 'pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,</font></div><div><font size="2"   >log_file_mode = 0600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# creation mode for log files,</font></div><div><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_disconnections = on</font></div><div><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div><font size="2"   >log_lock_waits = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # log lock waits &gt;= deadlock_timeout</font></div><div><font size="2"   >log_statement = 'ddl' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # none, ddl, mod, all</font></div><div><font size="2"   >log_timezone = 'PRC'</font></div><div><font size="2"   >log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</font></div><div><font size="2"   >autovacuum_vacuum_cost_delay = 10ms &nbsp; &nbsp; # default vacuum cost delay for</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >timezone = 'PRC'</font></div><div><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><p></p></pre></div><div><br></div><div>测试模型和测试数据生成 :&nbsp;</div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create table user_info</font></div><div><font size="2"   >(userid int,</font></div><div><font size="2"   >engname text,</font></div><div><font size="2"   >cnname text,</font></div><div><font size="2"   >occupation text,</font></div><div><font size="2"   >birthday date,</font></div><div><font size="2"   >signname text,</font></div><div><font size="2"   >email text,</font></div><div><font size="2"   >qq numeric,</font></div><div><font size="2"   >crt_time timestamp without time zone,</font></div><div><font size="2"   >mod_time timestamp without time zone</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create table user_session</font></div><div><font size="2"   >(userid int,</font></div><div><font size="2"   >logintime timestamp(0) without time zone,</font></div><div><font size="2"   >login_count bigint default 0,</font></div><div><font size="2"   >logouttime timestamp(0) without time zone,</font></div><div><font size="2"   >online_interval interval default interval '0'</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create unlogged table user_login_rec</font></div><div><font size="2"   >(userid int,</font></div><div><font size="2"   >login_time timestamp without time zone,</font></div><div><font size="2"   >ip inet</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create unlogged table user_logout_rec</font></div><div><font size="2"   >(userid int,</font></div><div><font size="2"   >logout_time timestamp without time zone,</font></div><div><font size="2"   >ip inet</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create table user_info_0 (like user_info including all);</font></div><div><font size="2"   >create table user_info_1 (like user_info including all);</font></div><div><font size="2"   >create table user_info_2 (like user_info including all);</font></div><div><font size="2"   >create table user_info_3 (like user_info including all);</font></div><div><font size="2"   >create table user_info_4 (like user_info including all);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create table user_session_0 (like user_session including all);</font></div><div><font size="2"   >create table user_session_1 (like user_session including all);</font></div><div><font size="2"   >create table user_session_2 (like user_session including all);</font></div><div><font size="2"   >create table user_session_3 (like user_session including all);</font></div><div><font size="2"   >create table user_session_4 (like user_session including all);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >insert into user_info_0 (userid,engname,cnname,occupation,birthday,signname,email,qq,crt_time,mod_time)</font></div><div><font size="2"   >select generate_series(1,20000000),</font></div><div><font size="2"   >'digoal.zhou',</font></div><div><font size="2"   >'德哥',</font></div><div><font size="2"   >'DBA',</font></div><div><font size="2"   >'1970-01-01'</font></div><div><font size="2"   >,E'公益是一辈子的事, I\'m Digoal.Zhou, Just do it!',</font></div><div><font size="2"   >'digoal@126.com',</font></div><div><font size="2"   >276732431,</font></div><div><font size="2"   >clock_timestamp(),</font></div><div><font size="2"   >NULL;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >insert into user_info_1 (userid,engname,cnname,occupation,birthday,signname,email,qq,crt_time,mod_time)</font></div><div><font size="2"   >select generate_series(20000001,40000000),</font></div><div><font size="2"   >'digoal.zhou',</font></div><div><font size="2"   >'德哥',</font></div><div><font size="2"   >'DBA',</font></div><div><font size="2"   >'1970-01-01'</font></div><div><font size="2"   >,E'公益是一辈子的事, I\'m Digoal.Zhou, Just do it!',</font></div><div><font size="2"   >'digoal@126.com',</font></div><div><font size="2"   >276732431,</font></div><div><font size="2"   >clock_timestamp(),</font></div><div><font size="2"   >NULL;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >insert into user_info_2 (userid,engname,cnname,occupation,birthday,signname,email,qq,crt_time,mod_time)</font></div><div><font size="2"   >select generate_series(40000001,60000000),</font></div><div><font size="2"   >'digoal.zhou',</font></div><div><font size="2"   >'德哥',</font></div><div><font size="2"   >'DBA',</font></div><div><font size="2"   >'1970-01-01'</font></div><div><font size="2"   >,E'公益是一辈子的事, I\'m Digoal.Zhou, Just do it!',</font></div><div><font size="2"   >'digoal@126.com',</font></div><div><font size="2"   >276732431,</font></div><div><font size="2"   >clock_timestamp(),</font></div><div><font size="2"   >NULL;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >insert into user_info_3 (userid,engname,cnname,occupation,birthday,signname,email,qq,crt_time,mod_time)</font></div><div><font size="2"   >select generate_series(60000001,80000000),</font></div><div><font size="2"   >'digoal.zhou',</font></div><div><font size="2"   >'德哥',</font></div><div><font size="2"   >'DBA',</font></div><div><font size="2"   >'1970-01-01'</font></div><div><font size="2"   >,E'公益是一辈子的事, I\'m Digoal.Zhou, Just do it!',</font></div><div><font size="2"   >'digoal@126.com',</font></div><div><font size="2"   >276732431,</font></div><div><font size="2"   >clock_timestamp(),</font></div><div><font size="2"   >NULL;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >insert into user_info_4 (userid,engname,cnname,occupation,birthday,signname,email,qq,crt_time,mod_time)</font></div><div><font size="2"   >select generate_series(80000001,100000000),</font></div><div><font size="2"   >'digoal.zhou',</font></div><div><font size="2"   >'德哥',</font></div><div><font size="2"   >'DBA',</font></div><div><font size="2"   >'1970-01-01'</font></div><div><font size="2"   >,E'公益是一辈子的事, I\'m Digoal.Zhou, Just do it!',</font></div><div><font size="2"   >'digoal@126.com',</font></div><div><font size="2"   >276732431,</font></div><div><font size="2"   >clock_timestamp(),</font></div><div><font size="2"   >NULL;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >insert into user_session_0 (userid) select generate_series(1,20000000);</font></div><div><font size="2"   >insert into user_session_1 (userid) select generate_series(20000001,40000000);</font></div><div><font size="2"   >insert into user_session_2 (userid) select generate_series(40000001,60000000);</font></div><div><font size="2"   >insert into user_session_3 (userid) select generate_series(60000001,80000000);</font></div><div><font size="2"   >insert into user_session_4 (userid) select generate_series(80000001,100000000);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >set work_mem='4096MB';</font></div><div><font size="2"   >set maintenance_work_mem='4096MB';</font></div><div><font size="2"   >alter table user_info_0 add primary key (userid);</font></div><div><font size="2"   >alter table user_info_1 add primary key (userid);</font></div><div><font size="2"   >alter table user_info_2 add primary key (userid);</font></div><div><font size="2"   >alter table user_info_3 add primary key (userid);</font></div><div><font size="2"   >alter table user_info_4 add primary key (userid);</font></div><div><font size="2"   >alter table user_session_0 add primary key (userid);</font></div><div><font size="2"   >alter table user_session_1 add primary key (userid);</font></div><div><font size="2"   >alter table user_session_2 add primary key (userid);</font></div><div><font size="2"   >alter table user_session_3 add primary key (userid);</font></div><div><font size="2"   >alter table user_session_4 add primary key (userid);</font></div><p></p></pre></div><div><br></div><div><br></div><div>测试函数&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace function f_user_login_0</font></div><div><font size="2"   >(i_userid int,</font></div><div><font size="2"   >OUT userid int,</font></div><div><font size="2"   >OUT engname text,</font></div><div><font size="2"   >OUT cnname text,</font></div><div><font size="2"   >OUT occupation text,</font></div><div><font size="2"   >OUT birthday date,</font></div><div><font size="2"   >OUT signname text,</font></div><div><font size="2"   >OUT email text,</font></div><div><font size="2"   >OUT qq numeric</font></div><div><font size="2"   >)</font></div><div><font size="2"   >as $BODY$</font></div><div><font size="2"   >&nbsp; insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"   >&nbsp; update user_session_0 set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div><font size="2"   >&nbsp; select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div><font size="2"   >&nbsp; &nbsp; from user_info_0 where userid=i_userid;</font></div><div><font size="2"   >$BODY$</font></div><div><font size="2"   >language sql strict volatile;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create or replace function f_user_login_1</font></div><div><font size="2"   >(i_userid int,</font></div><div><font size="2"   >OUT userid int,</font></div><div><font size="2"   >OUT engname text,</font></div><div><font size="2"   >OUT cnname text,</font></div><div><font size="2"   >OUT occupation text,</font></div><div><font size="2"   >OUT birthday date,</font></div><div><font size="2"   >OUT signname text,</font></div><div><font size="2"   >OUT email text,</font></div><div><font size="2"   >OUT qq numeric</font></div><div><font size="2"   >)</font></div><div><font size="2"   >as $BODY$</font></div><div><font size="2"   >&nbsp; insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"   >&nbsp; update user_session_1 set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div><font size="2"   >&nbsp; select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div><font size="2"   >&nbsp; &nbsp; from user_info_1 where userid=i_userid;</font></div><div><font size="2"   >$BODY$</font></div><div><font size="2"   >language sql strict volatile;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create or replace function f_user_login_2</font></div><div><font size="2"   >(i_userid int,</font></div><div><font size="2"   >OUT userid int,</font></div><div><font size="2"   >OUT engname text,</font></div><div><font size="2"   >OUT cnname text,</font></div><div><font size="2"   >OUT occupation text,</font></div><div><font size="2"   >OUT birthday date,</font></div><div><font size="2"   >OUT signname text,</font></div><div><font size="2"   >OUT email text,</font></div><div><font size="2"   >OUT qq numeric</font></div><div><font size="2"   >)</font></div><div><font size="2"   >as $BODY$</font></div><div><font size="2"   >&nbsp; insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"   >&nbsp; update user_session_2 set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div><font size="2"   >&nbsp; select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div><font size="2"   >&nbsp; &nbsp; from user_info_2 where userid=i_userid;</font></div><div><font size="2"   >$BODY$</font></div><div><font size="2"   >language sql strict volatile;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create or replace function f_user_login_3</font></div><div><font size="2"   >(i_userid int,</font></div><div><font size="2"   >OUT userid int,</font></div><div><font size="2"   >OUT engname text,</font></div><div><font size="2"   >OUT cnname text,</font></div><div><font size="2"   >OUT occupation text,</font></div><div><font size="2"   >OUT birthday date,</font></div><div><font size="2"   >OUT signname text,</font></div><div><font size="2"   >OUT email text,</font></div><div><font size="2"   >OUT qq numeric</font></div><div><font size="2"   >)</font></div><div><font size="2"   >as $BODY$</font></div><div><font size="2"   >&nbsp; insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"   >&nbsp; update user_session_3 set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div><font size="2"   >&nbsp; select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div><font size="2"   >&nbsp; &nbsp; from user_info_3 where userid=i_userid;</font></div><div><font size="2"   >$BODY$</font></div><div><font size="2"   >language sql strict volatile;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create or replace function f_user_login_4</font></div><div><font size="2"   >(i_userid int,</font></div><div><font size="2"   >OUT userid int,</font></div><div><font size="2"   >OUT engname text,</font></div><div><font size="2"   >OUT cnname text,</font></div><div><font size="2"   >OUT occupation text,</font></div><div><font size="2"   >OUT birthday date,</font></div><div><font size="2"   >OUT signname text,</font></div><div><font size="2"   >OUT email text,</font></div><div><font size="2"   >OUT qq numeric</font></div><div><font size="2"   >)</font></div><div><font size="2"   >as $BODY$</font></div><div><font size="2"   >&nbsp; insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"   >&nbsp; update user_session_4 set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div><font size="2"   >&nbsp; select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div><font size="2"   >&nbsp; &nbsp; from user_info_4 where userid=i_userid;</font></div><div><font size="2"   >$BODY$</font></div><div><font size="2"   >language sql strict volatile;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create or replace function f_user_logout_0</font></div><div><font size="2"   >(i_userid int</font></div><div><font size="2"   >)</font></div><div><font size="2"   >returns void</font></div><div><font size="2"   >as $BODY$</font></div><div><font size="2"   >&nbsp; insert into user_logout_rec (userid,logout_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"   >&nbsp; update user_session_0 set logouttime=now(),online_interval=online_interval+(now()-logintime) where userid=i_userid;</font></div><div><font size="2"   >$BODY$</font></div><div><font size="2"   >language sql strict volatile;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create or replace function f_user_logout_1</font></div><div><font size="2"   >(i_userid int</font></div><div><font size="2"   >)</font></div><div><font size="2"   >returns void</font></div><div><font size="2"   >as $BODY$</font></div><div><font size="2"   >&nbsp; insert into user_logout_rec (userid,logout_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"   >&nbsp; update user_session_1 set logouttime=now(),online_interval=online_interval+(now()-logintime) where userid=i_userid;</font></div><div><font size="2"   >$BODY$</font></div><div><font size="2"   >language sql strict volatile;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create or replace function f_user_logout_2</font></div><div><font size="2"   >(i_userid int</font></div><div><font size="2"   >)</font></div><div><font size="2"   >returns void</font></div><div><font size="2"   >as $BODY$</font></div><div><font size="2"   >&nbsp; insert into user_logout_rec (userid,logout_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"   >&nbsp; update user_session_2 set logouttime=now(),online_interval=online_interval+(now()-logintime) where userid=i_userid;</font></div><div><font size="2"   >$BODY$</font></div><div><font size="2"   >language sql strict volatile;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create or replace function f_user_logout_3</font></div><div><font size="2"   >(i_userid int</font></div><div><font size="2"   >)</font></div><div><font size="2"   >returns void</font></div><div><font size="2"   >as $BODY$</font></div><div><font size="2"   >&nbsp; insert into user_logout_rec (userid,logout_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"   >&nbsp; update user_session_3 set logouttime=now(),online_interval=online_interval+(now()-logintime) where userid=i_userid;</font></div><div><font size="2"   >$BODY$</font></div><div><font size="2"   >language sql strict volatile;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create or replace function f_user_logout_4</font></div><div><font size="2"   >(i_userid int</font></div><div><font size="2"   >)</font></div><div><font size="2"   >returns void</font></div><div><font size="2"   >as $BODY$</font></div><div><font size="2"   >&nbsp; insert into user_logout_rec (userid,logout_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"   >&nbsp; update user_session_4 set logouttime=now(),online_interval=online_interval+(now()-logintime) where userid=i_userid;</font></div><div><font size="2"   >$BODY$</font></div><div><font size="2"   >language sql strict volatile;</font></div><p></p></pre></div><div><br></div><div>os缓存预热</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create extension pgfincore;</font></div><div><font size="2"   >select * from pgfadvise_willneed('user_info_0');</font></div><div><font size="2"   >select * from pgfadvise_willneed('user_info_1');</font></div><div><font size="2"   >select * from pgfadvise_willneed('user_info_2');</font></div><div><font size="2"   >select * from pgfadvise_willneed('user_info_3');</font></div><div><font size="2"   >select * from pgfadvise_willneed('user_info_4');</font></div><div><font size="2"   >select * from pgfadvise_willneed('user_session_0');</font></div><div><font size="2"   >select * from pgfadvise_willneed('user_session_1');</font></div><div><font size="2"   >select * from pgfadvise_willneed('user_session_2');</font></div><div><font size="2"   >select * from pgfadvise_willneed('user_session_3');</font></div><div><font size="2"   >select * from pgfadvise_willneed('user_session_4');</font></div><div><font size="2"   >select * from pgfadvise_willneed('user_info_0_pkey');</font></div><div><font size="2"   >select * from pgfadvise_willneed('user_info_1_pkey');</font></div><div><font size="2"   >select * from pgfadvise_willneed('user_info_2_pkey');</font></div><div><font size="2"   >select * from pgfadvise_willneed('user_info_3_pkey');</font></div><div><font size="2"   >select * from pgfadvise_willneed('user_info_4_pkey');</font></div><div><font size="2"   >select * from pgfadvise_willneed('user_session_0_pkey');</font></div><div><font size="2"   >select * from pgfadvise_willneed('user_session_1_pkey');</font></div><div><font size="2"   >select * from pgfadvise_willneed('user_session_2_pkey');</font></div><div><font size="2"   >select * from pgfadvise_willneed('user_session_3_pkey');</font></div><div><font size="2"   >select * from pgfadvise_willneed('user_session_4_pkey');</font></div><p></p></pre></div><div><br></div><div>数据消耗空间</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \dt+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; | Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp; &nbsp;Size &nbsp; &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+-----------------+-------+----------+------------+-------------</font></div><div><font size="2"   >&nbsp;public | user_info &nbsp; &nbsp; &nbsp; | table | postgres | 8192 bytes |&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_info_0 &nbsp; &nbsp; | table | postgres | 3006 MB &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_info_1 &nbsp; &nbsp; | table | postgres | 3006 MB &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_info_2 &nbsp; &nbsp; | table | postgres | 3006 MB &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_info_3 &nbsp; &nbsp; | table | postgres | 3006 MB &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_info_4 &nbsp; &nbsp; | table | postgres | 3006 MB &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_login_rec &nbsp;| table | postgres | 24 kB &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_logout_rec | table | postgres | 16 kB &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_session &nbsp; &nbsp;| table | postgres | 0 bytes &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_session_0 &nbsp;| table | postgres | 1149 MB &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_session_1 &nbsp;| table | postgres | 1149 MB &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_session_2 &nbsp;| table | postgres | 1149 MB &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_session_3 &nbsp;| table | postgres | 1149 MB &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_session_4 &nbsp;| table | postgres | 1149 MB &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >(14 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# \di+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; &nbsp; | Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp; &nbsp; Table &nbsp; &nbsp; &nbsp;| &nbsp;Size &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+---------------------+-------+----------+----------------+--------+-------------</font></div><div><font size="2"   >&nbsp;public | user_info_0_pkey &nbsp; &nbsp;| index | postgres | user_info_0 &nbsp; &nbsp;| 428 MB |&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_info_1_pkey &nbsp; &nbsp;| index | postgres | user_info_1 &nbsp; &nbsp;| 428 MB |&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_info_2_pkey &nbsp; &nbsp;| index | postgres | user_info_2 &nbsp; &nbsp;| 428 MB |&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_info_3_pkey &nbsp; &nbsp;| index | postgres | user_info_3 &nbsp; &nbsp;| 428 MB |&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_info_4_pkey &nbsp; &nbsp;| index | postgres | user_info_4 &nbsp; &nbsp;| 428 MB |&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_session_0_pkey | index | postgres | user_session_0 | 428 MB |&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_session_1_pkey | index | postgres | user_session_1 | 428 MB |&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_session_2_pkey | index | postgres | user_session_2 | 428 MB |&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_session_3_pkey | index | postgres | user_session_3 | 428 MB |&nbsp;</font></div><div><font size="2"   >&nbsp;public | user_session_4_pkey | index | postgres | user_session_4 | 428 MB |&nbsp;</font></div><div><font size="2"   >(10 rows)</font></div><p></p></pre></div><div><br></div><div><br></div><div><br></div><div>1. 测试脚本</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >$ vi test0.sql</font></div><div><font size="2"   >\setrandom userid 1 20000000</font></div><div><font size="2"   >SELECT f_user_login_0(:userid);</font></div><div><font size="2"   >SELECT f_user_logout_0(:userid);</font></div><div><font size="2"   >$ vi test1.sql</font></div><div><font size="2"   >\setrandom userid 20000001 40000000</font></div><div><font size="2"   >SELECT f_user_login_1(:userid);</font></div><div><font size="2"   >SELECT f_user_logout_1(:userid);</font></div><div><font size="2"   >$ vi test2.sql</font></div><div><font size="2"   >\setrandom userid 40000001 60000000</font></div><div><font size="2"   >SELECT f_user_login_2(:userid);</font></div><div><font size="2"   >SELECT f_user_logout_2(:userid);</font></div><div><font size="2"   >$ vi test3.sql</font></div><div><font size="2"   >\setrandom userid 60000001 80000000</font></div><div><font size="2"   >SELECT f_user_login_3(:userid);</font></div><div><font size="2"   >SELECT f_user_logout_3(:userid);</font></div><div><font size="2"   >$ vi test4.sql</font></div><div><font size="2"   >\setrandom userid 80000001 100000000</font></div><div><font size="2"   >SELECT f_user_login_4(:userid);</font></div><div><font size="2"   >SELECT f_user_logout_4(:userid);</font></div><p></p></pre></div><div><br></div><div><br></div><div><br></div><div>2. 压力测试</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pgbench -M prepared -n -r -f ./test0.sql -f ./test1.sql -f ./test2.sql -f ./test3.sql -f ./test4.sql -c 16 -j 4 -T 180 -h $PGDATA -p 5432 -U postgres postgres &gt;./test.log</font></div><div></div><p></p></pre></div><div><br></div><div>测试结果</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@150-&gt; cat test.log</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 180 s</font></div><div><font size="2"   >number of transactions actually processed: 1730323</font></div><div><font size="2"   >tps = 9611.129846 (including connections establishing)</font></div><div><font size="2"   >tps = 9611.928556 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds, file 1:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002554 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 20000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.899903 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_0(:userid);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.758023 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_logout_0(:userid);</font></div><div><font size="2"   >statement latencies in milliseconds, file 2:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002608 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 20000001 40000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.900919 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_1(:userid);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.756734 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_logout_1(:userid);</font></div><div><font size="2"   >statement latencies in milliseconds, file 3:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002611 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 40000001 60000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.907649 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_2(:userid);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.758628 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_logout_2(:userid);</font></div><div><font size="2"   >statement latencies in milliseconds, file 4:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002633 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 60000001 80000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.901050 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_3(:userid);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.757335 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_logout_3(:userid);</font></div><div><font size="2"   >statement latencies in milliseconds, file 5:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002649 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 80000001 100000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.896310 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_4(:userid);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.758776 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_logout_4(:userid);</font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201221382150858/"   >http://blog.163.com/digoal@126/blog/static/163877040201221382150858/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201221333411196/"   >http://blog.163.com/digoal@126/blog/static/163877040201221333411196/</a></div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL oltp test benchmark for osc beijing - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>