<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">recovery standby base old pg_controlfile after pg_resetxlog</h2>
	<h5 id="">2014-11-30 13:48:41&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020141030133421/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>&nbsp; &nbsp; 今早一个数据库的流复制standby因为主库产生的XLOG过多, 延迟后触发了recovery.conf的restore命令, 但是restore里面用了sudo 进行copy并未保持源文件的owner, 属性等特征, 使用了root owner, 导致COPY完的xlog不能被postgresql 正常读取.</div><div>同事在处理这个事情, 因为没有了解实际情况, 上去就使用了pg_resetxlog修改standby的nextXID(resetxlog在这个场景属于扯淡的操作, 千万不要这么干), 接着大家知道的, standby无法正常完成standby的工作了.</div><div>&nbsp; &nbsp; 这个数据库有10几个T, 要重新做standby的话, 拷贝的数据量太大了, 即使使用rsync重做, 工作量也比较大(表空间过多, 目录过多).</div><div>&nbsp; &nbsp; 有没有省事的方法呢?</div><div>&nbsp; &nbsp; 首先来分析一下事件,&nbsp;</div><div>&nbsp; &nbsp; 1.&nbsp;<span style="line-height: 28px;"   >xlog不能被postgresql 正常读取(这个很好修复, 修改一下restore command就可以了, 或者不要用sudo 来拷贝).</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2014-11-30 10:05:54.505 CST,,,3695,,5435f48b.e6f,6,,2014-10-09 10:35:55 CST,1/0,0,LOG,00000,"restored log file ""0000000300002A9D0000004D"" from archive",,,,,,,,"RestoreArchivedFile, xlogarchive.c:254",""</font></div><div><font size="2"   >2014-11-30 10:05:54.534 CST,,,3695,,5435f48b.e6f,7,,2014-10-09 10:35:55 CST,1/0,0,PANIC,42501,"could not open file ""pg_xlog/0000000300002A9D0000004D"": Permission denied",,,,,,,,"XLogFileRead, xlog.c:2696",""</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >&nbsp; &nbsp; 2. pg_resetxlog对控制文件造成了持久性伤害, 没有办法修复.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp;pg_resetxlog -x 90010254 -f $PGDATA</font></div><div></div><p></p></pre></div><div><span style="line-height: 28px;"   >&nbsp; &nbsp; 为了快速恢复, 可以找到更早的控制文件, 刚好这套数据库的备份系统使用的是ZFS快照做的, 每天会创建一个快照, 所以可以取早些时间的快照, 拿到控制文件, 替换掉standby被人为"破坏"的控制文件, 启动standby后, 将从控制文件开始恢复需要的xlog. (只要这些xlog归档还在就可以了).</span></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >&nbsp; &nbsp; 操作过程 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 1. shutdown standby</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 2. mount zfs snapshot old then standby crashed time.</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 3. copy $PGDATA/global/pg_control from snapshot to standby.</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 4. startup standby.</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 5. umount snapshot.</font></span></div><p></p></pre></div><div><span style="line-height: 28px;"   >&nbsp; &nbsp; 注意, 拿到的控制文件必须是standby crash之前的控制文件, 并且控制文件至今的所有xlog归档必须都在. postgresql standby将从控制文件需要的xlog开始恢复数据块. 所以这么做是完全可以的.</span></div><div><span style="line-height: 28px;"   >&nbsp; &nbsp; 现在standby数据库已经完全恢复了</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; 882 postgres &nbsp;20 &nbsp; 0 2337m &nbsp;15m &nbsp;14m S &nbsp;0.0 &nbsp;0.1 &nbsp; 0:00.10 /opt/pgsql9.3.2/bin/postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; 883 postgres &nbsp;20 &nbsp; 0 &nbsp;157m 1072 &nbsp;476 S &nbsp;0.0 &nbsp;0.0 &nbsp; 0:00.14 postgres: logger process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; 884 postgres &nbsp;20 &nbsp; 0 2338m 2.0g 2.0g S &nbsp;0.0 &nbsp;8.6 &nbsp; 5:16.35 postgres: startup process &nbsp; recovering 0000000300002AA50000003F &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 889 postgres &nbsp;20 &nbsp; 0 2338m 2.0g 2.0g S &nbsp;0.0 &nbsp;8.6 &nbsp; 0:35.69 postgres: checkpointer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; 890 postgres &nbsp;20 &nbsp; 0 2338m 2.0g 2.0g S &nbsp;0.0 &nbsp;8.6 &nbsp; 0:34.98 postgres: writer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; 905 postgres &nbsp;20 &nbsp; 0 &nbsp;159m 1212 &nbsp;456 S &nbsp;0.0 &nbsp;0.0 &nbsp; 0:02.62 postgres: stats collector process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1922 postgres &nbsp;20 &nbsp; 0 &nbsp;105m 1632 1180 S &nbsp;0.0 &nbsp;0.0 &nbsp; 0:00.01 -bash &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;1959 postgres &nbsp;20 &nbsp; 0 &nbsp;137m 1764 1292 S &nbsp;0.0 &nbsp;0.0 &nbsp; 0:00.00 psql &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;1960 postgres &nbsp;20 &nbsp; 0 2340m 6780 4684 S &nbsp;0.0 &nbsp;0.0 &nbsp; 0:00.01 postgres: postgres postgres [local] idle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;4309 postgres &nbsp;20 &nbsp; 0 2346m 7080 1748 S &nbsp;0.0 &nbsp;0.0 &nbsp; 0:00.67 postgres: wal receiver process &nbsp; streaming 2AA5/3F0429C0&nbsp;</font></div><p></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div><div>&nbsp; &nbsp; 有备份真好, 有合理的备份更好.&nbsp;</div><div>&nbsp; &nbsp; 对zfs pitr备份有兴趣的朋友可以参考 :&nbsp;</div><div>&nbsp; &nbsp;&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201451894734122/"   >http://blog.163.com/digoal@126/blog/static/163877040201451894734122/</a></div><div><br></div>[参考]<div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201451894734122/"   >http://blog.163.com/digoal@126/blog/static/163877040201451894734122/</a></div><div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="recovery standby after pg_resetxlog - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a><br></div></div>
	</div>
</div>
</body>
</html>