<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">ceph install in CentOS 7 x64 within docker - 2</h2>
	<h5 id="">2014-11-27 16:21:56&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014102732027457/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>接着上一篇</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201410269169450/"   >http://blog.163.com/digoal@126/blog/static/163877040201410269169450/</a></div><div>接下来要准备deploy节点和node的环境.</div><div><br></div><div>一. 部署ceph-deploy节点 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# ssh 172.17.0.1</font></div><div><font size="2"   >root@172.17.0.1's password:&nbsp;</font></div><div><font size="2"   >Last login: Thu Nov 27 15:05:54 2014 from 172.17.42.1</font></div><div><font size="2"   >[root@65a05647c55d ~]# yum install -y ceph-deploy</font></div><p></p></pre></div><div><br></div><div>二. 部署node (所有node节点需执行, 包括deploy节点) :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >The admin node must be have password-less SSH access to Ceph nodes. When ceph-deploy logs in to a Ceph node as a user, that particular user must have passwordless sudo privileges.</font></div><div><font size="2"   >The ceph-deploy utility must login to a Ceph node as a user that has passwordless sudo privileges, because it needs to install software and configuration files without prompting for passwords.</font></div><p></p></pre></div><div><br></div><div>1. 配置时钟同步(本例docker环境中不需要)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># crontab -e</font></div><div><font size="2"   >8 * * * * /usr/sbin/ntpdate asia.pool.ntp.org &amp;&amp; /sbin/hwclock --systohc</font></div><p></p></pre></div><div><br></div><div>2. 安装ssh server<span style="line-height: 28px;"   >(本例docker环境中不需要,已安装)</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >yum install -y openssh-server openssh-clients</font></div><div></div><p></p></pre></div><div>3. 创建一个ceph用户, 用于deploy节点对node节点进行管理. (deploy节点也需要创建这个用户)</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@localhost ~]# ssh 172.17.0.2</font></div><div><font size="2"   >root@172.17.0.2's password:&nbsp;</font></div><div><font size="2"   >Last login: Thu Nov 27 15:06:29 2014 from 172.17.42.1</font></div><div><font size="2"   >[root@136dd8993abd ~]# useradd ceph</font></div></div><div><font size="2"   >设置密码</font></div><div><font size="2"   >[root@136dd8993abd ~]# echo 'ceph:cephpwd' | chpasswd</font></div><div><font size="2"   >配置sudo</font></div><div><font size="2"   >[root@136dd8993abd ~]# yum install -y sudo</font></div><div><font size="2"   >[root@136dd8993abd ~]# echo "ceph ALL = (root) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/ceph</font></div><div><font size="2"   >验证sudo 配置是否正确</font></div><div><font size="2"   >[root@136dd8993abd ~]# su - ceph</font></div><div><div><font size="2"   >[ceph@136dd8993abd ~]$ sudo date</font></div><div><font size="2"   >Thu Nov 27 15:41:53 GMT 2014</font></div></div><div><font size="2"   >..............</font></div><p></p></pre></div><div><br></div><div>4. 生成deploy节点ceph用户的ssh key</div><div>当前为deploy节点 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@deploy ~]# ip addr show v1</font></div><div><font size="2"   >64: v1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 4a:e5:cd:99:f5:c8 brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >&nbsp; &nbsp; inet 172.17.0.1/16 scope global v1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;valid_lft forever preferred_lft forever</font></div><div><font size="2"   >&nbsp; &nbsp; inet6 fe80::48e5:cdff:fe99:f5c8/64 scope link&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;valid_lft forever preferred_lft forever</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >在ceph用户下生成key, 不要输入passphrase :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >[root@deploy ~]# su - ceph<br>Last login: Fri Nov 28 11:14:46 GMT 2014 on pts/0<br>[ceph@deploy ~]$ ssh-keygen<br>Generating public/private rsa key pair.<br>Enter file in which to save the key (/home/ceph/.ssh/id_rsa): <br>Created directory '/home/ceph/.ssh'.<br>Enter passphrase (empty for no passphrase): <br>Enter same passphrase again: <br>Your identification has been saved in /home/ceph/.ssh/id_rsa.<br>Your public key has been saved in /home/ceph/.ssh/id_rsa.pub.<br>The key fingerprint is:<br>32:3b:89:89:36:28:e7:01:3e:1b:80:ce:70:de:ca:34 ceph@deploy<br>The key's randomart image is:<br>+--[ RSA 2048]----+<br>|                 |<br>|                 |<br>|                 |<br>|.                |<br>|= .   o S        |<br>|*= o o =         |<br>|o*E + +          |<br>|.*+=   .         |<br>| .+              |<br>+-----------------+</span></font></div><p></p></pre></div><div>将ceph用户的key拷贝到所有节点(包括自己)的ceph用户下面 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><span style="font-size: small; line-height: 21px;"   >[ceph@deploy ~]$ ssh-copy-id ceph@172.17.0.1</span></div><div><span style="font-size: small; line-height: 21px;"   >....................</span></div><div><font size="2"   ><span style="line-height: 21px;"   >[ceph@deploy ~]$ ssh-copy-id ceph@172.17.0.8</span></font></div><div><font size="2"   ><span style="line-height: 21px;"   ><br>The authenticity of host '172.17.0.8 (172.17.0.8)' can't be established.<br>ECDSA key fingerprint is db:5c:6b:2a:bc:9e:3e:31:24:1b:c0:8d:5f:96:f2:e0.<br>Are you sure you want to continue connecting (yes/no)? yes<br>/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed<br>/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys<br>ceph@172.17.0.8's password: <br><br>Number of key(s) added: 1<br><br>Now try logging into the machine, with:   "ssh 'ceph@172.17.0.8'"<br>and check to make sure that only the key(s) you wanted were added.</span></font></div></div><div><font size="2"   >..................</font></div><div><font size="2"   >测试是否无需密码调用ceph.</font></div><div><font size="2"   ><span style="line-height: 21px;"   >[ceph@deploy ~]$ ssh ceph@172.17.0.1 date<br>Fri Nov 28 11:22:04 GMT 2014<br>[ceph@deploy ~]$ ssh ceph@172.17.0.2 date<br>Fri Nov 28 11:22:06 GMT 2014<br>[ceph@deploy ~]$ ssh ceph@172.17.0.3 date<br>Fri Nov 28 11:22:08 GMT 2014<br>[ceph@deploy ~]$ ssh ceph@172.17.0.4 date<br>Fri Nov 28 11:22:09 GMT 2014<br>[ceph@deploy ~]$ ssh ceph@172.17.0.5 date<br>Fri Nov 28 11:22:10 GMT 2014<br>[ceph@deploy ~]$ ssh ceph@172.17.0.6 date<br>Fri Nov 28 11:22:12 GMT 2014<br>[ceph@deploy ~]$ ssh ceph@172.17.0.7 date<br>Fri Nov 28 11:22:13 GMT 2014<br>[ceph@deploy ~]$ ssh ceph@172.17.0.8 date<br>Fri Nov 28 11:22:15 GMT 2014</span></font></div><p></p></pre></div><div><br></div><div>5. 配置nodes的网络自动启动(本例不需要配置) :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Ceph OSDs peer with each other and report to Ceph Monitors over the network. If networking is off by default, the Ceph cluster cannot come online during bootup until you enable networking.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The default configuration on some distributions (e.g., CentOS) has the networking interface(s) off by default. Ensure that, during boot up, your network interface(s) turn(s) on so that your Ceph daemons can communicate over the network. For example, on Red Hat and CentOS, navigate to /etc/sysconfig/network-scripts and ensure that the ifcfg-{iface} file has ONBOOT set to yes.</font></div><p></p></pre></div><div><br></div><div>6. 配置主机名连通性, 在所有节点包括deploy节点执行.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@deploy ~]# yum install -y hostname</font></div><div><div><font size="2"   >[root@deploy ~]# vi /etc/hosts</font></div><div><font size="2"   ><span style="line-height: 21px;"   >172.17.0.1      deploy<br>172.17.0.2      mon1<br>172.17.0.3      mon2<br>172.17.0.4      mon3<br>172.17.0.5      osd1<br>172.17.0.6      osd2<br>172.17.0.7      osd3<br>172.17.0.8      osd4<br>127.0.0.1       localhost</span></font></div><div><font size="2"   >.......................</font></div></div><p></p></pre></div><div><br></div><div>7. 配置防火墙(本例已打开, 不需要添加条目)</div><div><p style="line-height: 1.5em; color: rgb(62, 67, 73); font-family: Helvetica, Arial, sans-serif; font-size: 14px;"   >Ceph Monitors communicate using port&nbsp;<tt style="color: rgb(34, 34, 34); font-size: 15px; background-color: rgb(236, 240, 243);"   ><span>6789</span></tt>&nbsp;by default. Ceph OSDs communicate in a port range of&nbsp;<tt style="color: rgb(34, 34, 34); font-size: 15px; background-color: rgb(236, 240, 243);"   ><span>6800:7810</span></tt>&nbsp;by default. See the&nbsp;<a style="color: rgb(240, 92, 86); text-decoration: none;" rel="nofollow" href="http://ceph.com/docs/master/rados/configuration/network-config-ref"   >Network Configuration Reference</a>&nbsp;for details. Ceph OSDs can use multiple network connections to communicate with clients, monitors, other OSDs for replication, and other OSDs for heartbeats.</p><p style="line-height: 1.5em; color: rgb(62, 67, 73); font-family: Helvetica, Arial, sans-serif; font-size: 14px;"   >On some distributions (e.g., RHEL), the default firewall configuration is fairly strict. You may need to adjust your firewall settings allow inbound requests so that clients in your network can communicate with daemons on your Ceph nodes.</p><p style="line-height: 1.5em; color: rgb(62, 67, 73); font-family: Helvetica, Arial, sans-serif; font-size: 14px;"   >For&nbsp;<tt style="color: rgb(34, 34, 34); font-size: 15px; background-color: rgb(236, 240, 243);"   ><span>firewalld</span></tt>&nbsp;on RHEL 7, add port&nbsp;<tt style="color: rgb(34, 34, 34); font-size: 15px; background-color: rgb(236, 240, 243);"   ><span>6789</span></tt>&nbsp;for Ceph Monitor nodes and ports&nbsp;<tt style="color: rgb(34, 34, 34); font-size: 15px; background-color: rgb(236, 240, 243);"   ><span>6800:7100</span></tt>&nbsp;for Ceph OSDs to the public zone and ensure that you make the setting permanent so that it is enabled on reboot. For example:</p><div style="color: rgb(62, 67, 73); font-family: Helvetica, Arial, sans-serif; font-size: 14px; line-height: 19.6000003814697px;"   ><pre style="overflow-x: auto; overflow-y: hidden; padding: 10px; color: rgb(34, 34, 34); line-height: 1.2em; border: 1px solid rgb(94, 106, 113); font-size: 1.1em; margin: 1.5em; -webkit-box-shadow: rgb(230, 232, 232) 1px 1px 1px;"   >sudo firewall-cmd --zone=public --add-port=6789/tcp --permanent</pre></div><p style="line-height: 1.5em; color: rgb(62, 67, 73); font-family: Helvetica, Arial, sans-serif; font-size: 14px;"   >For&nbsp;<tt style="color: rgb(34, 34, 34); font-size: 15px; background-color: rgb(236, 240, 243);"   ><span>iptables</span></tt>, add port&nbsp;<tt style="color: rgb(34, 34, 34); font-size: 15px; background-color: rgb(236, 240, 243);"   ><span>6789</span></tt>&nbsp;for Ceph Monitors and ports&nbsp;<tt style="color: rgb(34, 34, 34); font-size: 15px; background-color: rgb(236, 240, 243);"   ><span>6800:7100</span></tt>&nbsp;for Ceph OSDs. For example:</p><div style="color: rgb(62, 67, 73); font-family: Helvetica, Arial, sans-serif; font-size: 14px; line-height: 19.6000003814697px;"   ><pre style="overflow-x: auto; overflow-y: hidden; padding: 10px; color: rgb(34, 34, 34); line-height: 1.2em; border: 1px solid rgb(94, 106, 113); font-size: 1.1em; margin: 1.5em; -webkit-box-shadow: rgb(230, 232, 232) 1px 1px 1px;"   >sudo iptables -A INPUT -i {iface} -p tcp -s {ip-address}/{netmask} --dport 6789 -j ACCEPT</pre></div><p style="line-height: 1.5em; color: rgb(62, 67, 73); font-family: Helvetica, Arial, sans-serif; font-size: 14px;"   >Once you have finished configuring&nbsp;<tt style="color: rgb(34, 34, 34); font-size: 15px; background-color: rgb(236, 240, 243);"   ><span>iptables</span></tt>, ensure that you make the changes persistent on each node so that they will be in effect when your nodes reboot. For example:</p><div style="color: rgb(62, 67, 73); font-family: Helvetica, Arial, sans-serif; font-size: 14px; line-height: 19.6000003814697px;"   ><pre style="overflow-x: auto; overflow-y: hidden; padding: 10px; color: rgb(34, 34, 34); line-height: 1.2em; border: 1px solid rgb(94, 106, 113); font-size: 1.1em; margin: 1.5em; -webkit-box-shadow: rgb(230, 232, 232) 1px 1px 1px;"   >/sbin/service iptables save</pre></div></div><div>8. 配置tty. (所有节点)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@deploy ~]# visudo -f /etc/sudoers</font></div><div><font size="2"   >注释</font></div><div><font size="2"   >#Defaults &nbsp; &nbsp;requiretty</font></div><p></p></pre></div><div><br></div><div>9. 关闭selinux(所有节点)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># setenforce 0</font></div><div><font size="2"   ># vi /etc/selinux/config</font></div><div><font size="2"   >SELINUX=disabled</font></div><p></p></pre></div><div><br></div><div>10. 添加epel源(所有节点)</div><div><a target="_blank" rel="nofollow" href="http://ftp.cuhk.edu.hk/pub/linux/fedora-epel/7/x86_64/repoview/epel-release.html"   >http://ftp.cuhk.edu.hk/pub/linux/fedora-epel/7/x86_64/repoview/epel-release.html</a></div><div><a target="_blank" rel="nofollow" href="http://ftp.cuhk.edu.hk/pub/linux/fedora-epel/7/x86_64/e/epel-release-7-2.noarch.rpm"   >http://ftp.cuhk.edu.hk/pub/linux/fedora-epel/7/x86_64/e/epel-release-7-2.noarch.rpm</a></div><div>[root@ &nbsp;~]# yum install -y http://ftp.cuhk.edu.hk/pub/linux/fedora-epel/7/x86_64/e/epel-release-7-2.noarch.rpm</div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[ceph@deploy ~]$ ssh 172.17.0.1 sudo yum install -y http://ftp.cuhk.edu.hk/pub/linux/fedora-epel/7/x86_64/e/epel-release-7-2.noarch.rpm</font></div><div><font size="2"   >[ceph@deploy ~]$ ssh 172.17.0.2 sudo yum install -y http://ftp.cuhk.edu.hk/pub/linux/fedora-epel/7/x86_64/e/epel-release-7-2.noarch.rpm</font></div><div><font size="2"   >[ceph@deploy ~]$ ssh 172.17.0.3 sudo yum install -y http://ftp.cuhk.edu.hk/pub/linux/fedora-epel/7/x86_64/e/epel-release-7-2.noarch.rpm</font></div><div><font size="2"   >[ceph@deploy ~]$ ssh 172.17.0.4 sudo yum install -y http://ftp.cuhk.edu.hk/pub/linux/fedora-epel/7/x86_64/e/epel-release-7-2.noarch.rpm</font></div><div><font size="2"   >[ceph@deploy ~]$ ssh 172.17.0.5 sudo yum install -y http://ftp.cuhk.edu.hk/pub/linux/fedora-epel/7/x86_64/e/epel-release-7-2.noarch.rpm</font></div><div><font size="2"   >[ceph@deploy ~]$ ssh 172.17.0.6 sudo yum install -y http://ftp.cuhk.edu.hk/pub/linux/fedora-epel/7/x86_64/e/epel-release-7-2.noarch.rpm</font></div><div><font size="2"   >[ceph@deploy ~]$ ssh 172.17.0.7 sudo yum install -y http://ftp.cuhk.edu.hk/pub/linux/fedora-epel/7/x86_64/e/epel-release-7-2.noarch.rpm</font></div><div><font size="2"   >[ceph@deploy ~]$ ssh 172.17.0.8 sudo yum install -y http://ftp.cuhk.edu.hk/pub/linux/fedora-epel/7/x86_64/e/epel-release-7-2.noarch.rpm</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201410269169450/"   >http://blog.163.com/digoal@126/blog/static/163877040201410269169450/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014102711413675/"   >http://blog.163.com/digoal@126/blog/static/1638770402014102711413675/</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="ceph install in CentOS 7 x64 within docker - 2 - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>