<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">extended the postgresql metric python module on ganglia</h2>
	<h5 id="">2014-09-24 14:56:48&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201482345943567/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>本文主要拿PostgreSQL ganglia python module 来讲一下如何扩展这个模块, 增加我们想要的监控项.</div><div><br></div><wbr><div>首先要了解一下metric的数据类型, 以及各字段的含义, 以帮助了解如何自定义metric模块.</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201481835916946/"   >http://blog.163.com/digoal@126/blog/static/163877040201481835916946/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201481843417188/"   >http://blog.163.com/digoal@126/blog/static/163877040201481843417188/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014819102825333/"   >http://blog.163.com/digoal@126/blog/static/1638770402014819102825333/</a></div><div><br></div><div>接下来需要对监控软件简单的分析, 了解什么样的监控点适合用在什么样的监控软件中.</div><div>哪些适合放在ganglia, 哪些适合放在nagios / zabbix, 哪些适合定期人工巡检.</div><div><br></div><div>1. 适合用ganglia来展示的数据, 务必是数字类型或者可以转换成数据类型(如true, false转换成0,1), 最好是集群级别的数据.</div><div>如果是表级别, 或者数据库级别的数据, 那么.py会变复杂一点, 例如<span style="line-height: 28px;"   >需要在.pyconf中配置需要监控的表, 库(不像zabbix可以使用discovery接口), 需要在.py里分别在不同的库中取不同的表的数据.&nbsp;</span></div><div>本文简化一下, 只在ganglia中采样和展示集群级别的metric.</div><div>采样点举例 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >最大连接, 已用连接, 剩余连接, idle in transaction连接, active连接</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >pg_stat_bgwriter</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >shared buffer size</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >提交比例</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >集群大小</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >数据库统计, 命中率, pg_stat_database</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >hot standby延迟</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >剩余年龄</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >锁等待数量</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >锁等待时长(秒)</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >当天产生的 pg_log 文件大小(bytes)</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >prepared 事务数 以及 时长(秒).</font></span></div><div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >当前慢查询数(例如&gt;500ms)</font></div><div style="line-height: 28px;"   ><font size="2"   >当前最长查询时间<span style="line-height: 28px;"   >(秒)</span></font></div><div style="line-height: 28px;"   ><font size="2"   >当前最长事务空闲时间<span style="line-height: 28px;"   >(秒)</span></font></div><div style="line-height: 28px;"   ><font size="2"   >当前最长事务时间<span style="line-height: 28px;"   >(秒)</span></font></div></div><div style="line-height: 28px;"   ><font size="2"   >10分钟内产生wal的量(bytes)</font></div></div><div style="line-height: 28px;"   ><font size="2"   >数据库状态是否正常, 返回1正常, 其他不正常.</font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div><div>2. 适合在nagios中监控的数据, 可以是一些容易设置阈值来判断状态(正常, 告警, 异常)的点.</div><div>监控点举例 :&nbsp;</div><div>数据库健康状态,&nbsp;<span style="line-height: 28px;"   >监听端口,&nbsp;</span><span style="line-height: 28px;"   >是否开启归档, 是否开启autovacuum, 数据库的年龄, 剩余连接数, 活跃连接数, idle in transaction连接数, 提交和回滚比例, standby延迟, 锁等待, 长事务, prepared事务, 序列剩余量, 表的膨胀, 未使用的索引(索引的扫描次数), 等.</span></div><div>可参考&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201412763135184/"   >http://blog.163.com/digoal@126/blog/static/163877040201412763135184/</a></div><div>3. 适合在zabbix中展示的数据, zabbix可以认为是ganglia和nagios的结合体, 图形方面和告警能力都还行, 所以基本上通吃.</div><div>4. 适合定期人工巡检的数据.</div><div>不容易做成自动化监控的点, 都可以归类到人工定期巡检里面. 包括巡检自动化监控程序自身是否正常.</div><div>巡检点举例 :&nbsp;</div><div>数据库基本信息(版本,OS,编译参数,内核参数,库,....), 数据库配置文件, 错误日志分析, 数据库连接异常排查, 定时任务, 数据库增长情况, TOP 10 SQL, 数据库运行状态(连接数, 年龄, 大表, 索引超标表, 冷索引, 触发器, 膨胀, 垃圾数据, 存储空间, IO, 归档, 回滚比例, 长事务, 序列, 备份, 容灾, HA状态) , 安全检查(密码策略, 用户审计, 特殊配置, 事件触发器, 触发器, 审计参数, 用户权限, SQL注入, public对象, 对象大小写, 个人账号审计).</div><div><span style="line-height: 28px;"   >可参考&nbsp;</span><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014252816497/"   >http://blog.163.com/digoal@126/blog/static/1638770402014252816497/</a></div><div><br></div><div>ganglia采样点SQL :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >最大连接, 已用连接, 剩余连接, idle in transaction连接, active连接</font></div><div><font size="2"   >select t2.max::int,t1.used,(t2.max::int-t1.used) free,t1.idle,t1.active from (select count(*) used,sum(case state when 'idle in transaction' then 1 else 0 end) idle,sum(case state when 'active' then 1 else 0 end) active from pg_stat_activity)t1,(select setting as max from pg_settings where name = 'max_connections')t2;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg_stat_bgwriter</font></div><div><font size="2"   >postgres=# \d pg_stat_bgwriter&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; View "pg_catalog.pg_stat_bgwriter"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Column &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >-----------------------+--------------------------+-----------</font></div><div><font size="2"   >&nbsp;checkpoints_timed &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;checkpoints_req &nbsp; &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;checkpoint_write_time | double precision &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;checkpoint_sync_time &nbsp;| double precision &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;buffers_checkpoint &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;buffers_clean &nbsp; &nbsp; &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;maxwritten_clean &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;buffers_backend &nbsp; &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;buffers_backend_fsync | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;buffers_alloc &nbsp; &nbsp; &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;stats_reset &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | timestamp with time zone |&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >shared buffer size</font></div><div><font size="2"   >select t1.setting*t2.setting from (select setting::int8 from pg_settings where name = 'shared_buffers')t1, (select setting::int8 from pg_settings where name = 'block_size')t2;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >提交比例</font></div><div><font size="2"   >select 100*sum(xact_commit)/sum(xact_commit+xact_rollback) from pg_stat_database;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >集群大小</font></div><div><font size="2"   >select sum(pg_database_size(datname)) from pg_database;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >数据库统计, 命中率, pg_stat_database</font></div><div><font size="2"   >postgres=# \d pg_stat_database</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; View "pg_catalog.pg_stat_database"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;Column &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >----------------+--------------------------+-----------</font></div><div><font size="2"   >&nbsp;datid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;datname &nbsp; &nbsp; &nbsp; &nbsp;| name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;numbackends &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;xact_commit &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;xact_rollback &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;blks_read &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;blks_hit &nbsp; &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;tup_returned &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;tup_fetched &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;tup_inserted &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;tup_updated &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;tup_deleted &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;conflicts &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;temp_files &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;temp_bytes &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;deadlocks &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;blk_read_time &nbsp;| double precision &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;blk_write_time | double precision &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;stats_reset &nbsp; &nbsp;| timestamp with time zone |&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >hot standby延迟</font></div><div><font size="2"   >postgres=# \d pg_stat_replication&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; View "pg_catalog.pg_stat_replication"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; Column &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >------------------+--------------------------+-----------</font></div><div><font size="2"   >&nbsp;pid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;usesysid &nbsp; &nbsp; &nbsp; &nbsp; | oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;usename &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;application_name | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;client_addr &nbsp; &nbsp; &nbsp;| inet &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;client_hostname &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;client_port &nbsp; &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;backend_start &nbsp; &nbsp;| timestamp with time zone |&nbsp;</font></div><div><font size="2"   >&nbsp;state &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;sent_location &nbsp; &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;write_location &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;flush_location &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;replay_location &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;sync_priority &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;sync_state &nbsp; &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >select max(pg_xlog_location_diff(pg_current_xlog_location(),flush_location)) from pg_stat_replication;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >剩余年龄</font></div><div><font size="2"   >select min(2000000000-age(datfrozenxid)) from pg_database;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >锁等待数量</font></div><div><font size="2"   >select count(*) from pg_stat_activity where waiting;</font></div><div><font size="2"   ><br></font></div><div><span style="line-height: 28px;"   ><font size="2"   >锁等待时长(秒)</font></span></div><div><font size="2"   >select max(trunc(EXTRACT(EPOCH FROM now()-query_start))) inter from pg_stat_activity where waiting;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >当天产生的 pg_log 文件大小(bytes)</font></div><div><font size="2"   >postgres=# select sum((pg_stat_file(file)).size) from (select dir||'/'||pg_ls_dir(dir) as file from (select setting as dir from pg_settings where name='log_directory') t)t where (pg_stat_file(file)).change&gt;=current_date;</font></div><div><font size="2"   >&nbsp; sum &nbsp;&nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;722653</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select pg_ls_dir('/tmp');</font></div><div><font size="2"   >ERROR: &nbsp;absolute path not allowed</font></div><div><font size="2"   >如果使用绝对路径, 建议将pg_log软连接.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >prepared 事务数 以及 时长(秒).</font></div><div><font size="2"   >select count(*),max(trunc(EXTRACT(EPOCH FROM now()-prepared))) inter from pg_prepared_xacts;</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >当前慢查询数(例如&gt;500ms)</font></div><div><font size="2"   >select count(*) from pg_stat_activity where now()-query_start&gt;interval '0.5 s' and state='active';</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >当前最长查询时间(s)</font></div><div><font size="2"   >select max(trunc(EXTRACT(EPOCH FROM now()-query_start))) from pg_stat_activity where state='active';</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >当前最长事务空闲时间</font></div><div><font size="2"   >select max(trunc(EXTRACT(EPOCH FROM now()-xact_start))) from pg_stat_activity where state='idle in transaction';</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >当前最长事务时间</font></div><div><font size="2"   >select max(trunc(EXTRACT(EPOCH FROM now()-xact_start))) from pg_stat_activity where state='idle in transaction' or state='active';</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >10分钟内产生wal的量(bytes)</font></div><div><font size="2"   >select sum((pg_stat_file(file)).size) from (select 'pg_xlog/'||pg_ls_dir('pg_xlog') as file)t where now()-(pg_stat_file(file)).change&lt;=interval '10 min';</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >数据库状态是否正常, 返回1正常, 其他不正常.</font></div><div><div><font size="2"   >postgres=# select function();</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >自定义一个函数, 处理一些逻辑, 例如 :&nbsp;</font></div><div><a target="_blank" rel="nofollow" href="https://github.com/digoal/sky_postgresql_cluster/raw/master/INSTALL.txt"   ><font size="2"   >https://github.com/digoal/sky_postgresql_cluster/raw/master/INSTALL.txt</font></a></div><p></p></pre></div><div><br></div><div>以上采样点对应的.py和.pyconf文件部分内容 :&nbsp;</div><div>以集群剩余年龄为例</div><div>postgres.py 添加需要采样的代码 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >在&nbsp; &nbsp; db_curs.close()前加入</font></div><div><div><font size="2"   >&nbsp; &nbsp; # PostgreSQL cluster xacts remain</font></div><div><font size="2"   >&nbsp; &nbsp; db_curs.execute(</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 'select min(2000000000-age(datfrozenxid)) from pg_database<span style="line-height: 28px;"   >;')</span></font></div><div><font size="2"   >&nbsp; &nbsp; results = db_curs.fetchall()</font></div><div><font size="2"   >    pg_xacts_remain = results[0]</font></div><div><font size="2"   >&nbsp; &nbsp; pg_metrics.update(<span style="line-height: 28px;"   >{'Pypg_xacts_remain':pg_xacts_remain</span><span style="line-height: 28px;"   >[0]</span><span style="line-height: 28px;"   >})</span></font></div></div><div><span style="font-size: small; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, 宋体; line-height: 28px;"   ><br></span></div><div><span style="font-size: small; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, 宋体; line-height: 28px;"   >并在</span><span style="line-height: 21px; font-size: small; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, 宋体;"   >metric_init(params)函数的&nbsp; &nbsp; descriptors 字典末尾中加入metric的描述.</span></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {'name':'Pypg_hours_since_last_analyze','units':'hours','slope':'both','description':'PG hours since last analyze'}, &nbsp;# 加入:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {'name':'Pypg_xacts_remain','units':'xact','slope':'both','description':'PG xacts remain'}]</font></div></div><p></p></pre></div><div><br></div><div>postgres.pyconf 添加需要采样的metric配置 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp;metric {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;name = "Pypg_xacts_remain"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;title = "Postgres&nbsp;<span style="line-height: 28px;"   >Cluster xacts Remain</span>"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;value_threshold = 0</font></div><div><font size="2"   >&nbsp; &nbsp;}</font></div><p></p></pre></div><div><br></div><div>将postgres.py和postgres.pyconf拷贝到配置指定的相应位置, 并重启gmond.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-221 soft_bak]# cat /opt/ganglia-core-3.6.0/etc/conf.d/modpython.conf&nbsp;</font></div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp; params - path to the directory where mod_python</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;should look for python metric modules</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; the "pyconf" files in the include directory below</font></div><div><font size="2"   >&nbsp; will be scanned for configurations for those modules</font></div><div><font size="2"   >*/</font></div><div><font size="2"   >modules {</font></div><div><font size="2"   >&nbsp; module {</font></div><div><font size="2"   >&nbsp; &nbsp; name = "python_module"</font></div><div><font size="2"   >&nbsp; &nbsp; path = "modpython.so"</font></div><div><font size="2"   >&nbsp; &nbsp; params = "/opt/ganglia-core-3.6.0/lib64/ganglia/python_modules"</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >include ("/opt/ganglia-core-3.6.0/etc/conf.d/*.pyconf")</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-221 soft_bak]# ll /opt/ganglia-core-3.6.0/lib64/ganglia/python_modules/postgres.py</font></div><div><font size="2"   >-rw-r--r-- 1 root root 11466 Sep 24 13:51 /opt/ganglia-core-3.6.0/lib64/ganglia/python_modules/postgres.py</font></div></div><div><div><font size="2"   >[root@db-172-16-3-221 soft_bak]# ll /opt/ganglia-core-3.6.0/etc/conf.d/postgres.pyconf&nbsp;</font></div><div><font size="2"   >-rw-r--r-- 1 root root 4183 Sep 24 13:52 /opt/ganglia-core-3.6.0/etc/conf.d/postgres.pyconf</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >配置pyconf的数据库连接参数 : </font></div><div><font size="2"   >modules {<br>   module {<br>     name = "postgres"<br>     language = "python"<br>     param host {<br>       value = "127.0.0.1"<br>     }<br>     param port {<br>       value = "5432"<br>     }<br>     param dbname {<br>       value = "postgres"<br>     }<br>     param username {<br>       value = "postgres"<br>     }<br>     param password {<br>       value = "postgres"<br>     }<br>   }<br>}</font></div><p></p></pre></div><div><br></div><div>验证metric是否正常, 如果遇到如下错误, 可能是这个模块依赖的库没有安装 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 conf.d]# gmond -m</font></div><div><font size="2"   >[PYTHON] Can't import the metric module [postgres].</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Traceback (most recent call last):</font></div><div><font size="2"   >&nbsp; File "/opt/ganglia-core-3.6.0/lib64/ganglia/python_modules/postgres.py", line 1, in &lt;module&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; import psycopg2</font></div><div><font size="2"   >ImportError: No module named psycopg2</font></div><p></p></pre></div><div>以上问题的解决办法 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># wget http://www.psycopg.org/psycopg/tarballs/PSYCOPG-2-5/psycopg2-2.5.4.tar.gz</font></div><div><font size="2"   ># tar -zxvf psycopg2-2.5.4.tar.gz</font></div><div><font size="2"   ># cd psycopg2-2.5.4</font></div><div><font size="2"   ># python ./setup.py install</font></div><p></p></pre></div><div><br></div><div>接下来的这个问题是没有加载libpq库.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 psycopg2-2.5.4]# gmond -m</font></div><div><font size="2"   >[PYTHON] Can't import the metric module [postgres].</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Traceback (most recent call last):</font></div><div><font size="2"   >&nbsp; File "/opt/ganglia-core-3.6.0/lib64/ganglia/python_modules/postgres.py", line 1, in &lt;module&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; import psycopg2</font></div><div><font size="2"   >&nbsp; File "/usr/lib64/python2.6/site-packages/psycopg2/__init__.py", line 50, in &lt;module&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; from psycopg2._psycopg import BINARY, NUMBER, STRING, DATETIME, ROWID</font></div><div><font size="2"   >ImportError: libpq.so.5: cannot open shared object file: No such file or directory</font></div><p></p></pre></div><div>加载即可</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># vi /etc/ld.so.conf</font></div><div><font size="2"   >/opt/pgsql/lib</font></div><div><font size="2"   ># ldconfig</font></div><div><div><font size="2"   ># ldconfig -p|grep libpq</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; libpqwalreceiver.so (libc6,x86-64) =&gt; /opt/pgsql/lib/libpqwalreceiver.so</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; libpq.so.5 (libc6,x86-64) =&gt; /opt/pgsql/lib/libpq.so.5</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; libpq.so (libc6,x86-64) =&gt; /opt/pgsql/lib/libpq.so</font></div></div><p></p></pre></div><div><br></div><div>现在可以正常查看这些新增的metric了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># gmond -m|grep Py</font></div><div><font size="2"   >Pypg_hours_since_last_vacuum &nbsp; &nbsp;PG hours since last vacuum (module python_module)</font></div><div><font size="2"   >Pypg_blks_memread &nbsp; &nbsp; &nbsp; PG Blocks Read from Memory (module python_module)</font></div><div><font size="2"   >Pypg_inserts &nbsp; &nbsp;PG Inserts (module python_module)</font></div><div><font size="2"   >Pypg_waiting_sessions &nbsp; PG Waiting Sessions Blocked (module python_module)</font></div><div><font size="2"   >Pypg_longest_query &nbsp; &nbsp; &nbsp;PG Longest Query in Seconds (module python_module)</font></div><div><font size="2"   >Pypg_bgwriter_buffers_clean &nbsp; &nbsp; PG number of buffers written by the background writer (module python_module)</font></div><div><font size="2"   >Pypg_locks_otherexclusive &nbsp; &nbsp; &nbsp; PG Exclusive Locks write blocking (module python_module)</font></div><div><font size="2"   >Pypg_bgwriter_buffers_alloc &nbsp; &nbsp; PG number of buffers allocated (module python_module)</font></div><div><font size="2"   >Pypg_bgwriter_checkpoint_write_time &nbsp; &nbsp; PG time to write checkpoints to disk (module python_module)</font></div><div><font size="2"   >Pypg_deletes &nbsp; &nbsp;PG Deletes (module python_module)</font></div><div><font size="2"   >Pypg_bgwriter_checkpoints_req &nbsp; PG unscheduled checkpoints (module python_module)</font></div><div><font size="2"   >Pypg_longest_xact &nbsp; &nbsp; &nbsp; PG Longest Transaction in Seconds (module python_module)</font></div><div><font size="2"   >Pypg_locks_shared &nbsp; &nbsp; &nbsp; PG Shared Locks NON blocking (module python_module)</font></div><div><font size="2"   >Pypg_active_sessions &nbsp; &nbsp;PG Active Sessions (module python_module)</font></div><div><font size="2"   >Pypg_bgwriter_buffers_checkpoint &nbsp; &nbsp; &nbsp; &nbsp;PG number of buffers written during checkpoint (module python_module)</font></div><div><font size="2"   >Pypg_transactions &nbsp; &nbsp; &nbsp; PG Transactions (module python_module)</font></div><div><font size="2"   >Pypg_locks_accessexclusive &nbsp; &nbsp; &nbsp;PG AccessExclusive Locks read write blocking (module python_module)</font></div><div><font size="2"   >Pypg_tup_idxfetch &nbsp; &nbsp; &nbsp; PG Tuples fetched from indexes (module python_module)</font></div><div><font size="2"   >Pypg_reads &nbsp; &nbsp; &nbsp;PG Reads (module python_module)</font></div><div><font size="2"   >Pypg_bgwriter_checkpoints_timed PG scheduled checkpoints (module python_module)</font></div><div><font size="2"   >Pypg_blks_diskread &nbsp; &nbsp; &nbsp;PG Blocks Read from Disk (module python_module)</font></div><div><font size="2"   >Pypg_idle_sessions &nbsp; &nbsp; &nbsp;PG Idle Sessions (module python_module)</font></div><div><font size="2"   >Pypg_updates &nbsp; &nbsp;PG Updates (module python_module)</font></div><div><font size="2"   >Pypg_bgwriter_checkpoint_sync_time &nbsp; &nbsp; &nbsp;PG time to sync checkpoints to disk (module python_module)</font></div><div><font size="2"   >Pypg_xacts_remain &nbsp; &nbsp; &nbsp; PG xacts remain (module python_module)</font></div><div><font size="2"   >Pypg_tup_seqscan &nbsp; &nbsp; &nbsp; &nbsp;PG Tuples sequentially scanned (module python_module)</font></div><div><font size="2"   >Pypg_hours_since_last_analyze &nbsp; PG hours since last analyze (module python_module)</font></div><div><font size="2"   >Pypg_idle_in_transaction_sessions &nbsp; &nbsp; &nbsp; PG Idle In Transaction Sessions (module python_module)</font></div><div><font size="2"   >Pypg_bgwriter_buffers_backend &nbsp; PG number of buffers written directly by a backend (module python_module)</font></div><p></p></pre></div><div><br></div><div>gmond -f 在前台执行, 可以看到一些问题, 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Traceback (most recent call last):</font></div><div><font size="2"   >&nbsp; File "/opt/ganglia-core-3.6.0/lib64/ganglia/python_modules/postgres.py", line 168, in metric_handler</font></div><div><font size="2"   >&nbsp; &nbsp; pg_metrics = pg_metrics_queries()</font></div><div><font size="2"   >&nbsp; File "/opt/ganglia-core-3.6.0/lib64/ganglia/python_modules/postgres.py", line 20, in deco</font></div><div><font size="2"   >&nbsp; &nbsp; self.last_value = func(*args, **kwds)</font></div><div><font size="2"   >&nbsp; File "/opt/ganglia-core-3.6.0/lib64/ganglia/python_modules/postgres.py", line 149, in pg_metrics_queries</font></div><div><font size="2"   >&nbsp; &nbsp; hours_since_vacuum = int(pg_stat_table_values[2])</font></div><div><font size="2"   >TypeError: int() argument must be a string or a number, not 'NoneType'</font></div><div><font size="2"   >[PYTHON] Can't call the metric handler function for [Pypg_xacts_remain] in the python module [postgres].</font></div><p></p></pre></div><div>这是由于<span style="line-height: 28px;"   >extract(epoch from now() - min(last_vacuum))::int/60/60</span><span style="line-height: 28px;"   >空值引起的.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select sum(seq_tup_read), sum(idx_tup_fetch),&nbsp;</font></div><div><span style="line-height: 28px;"   ><font size="2"   >digoal-# &nbsp; &nbsp; &nbsp; &nbsp; extract(epoch from now() - min(last_vacuum))::int/60/60,&nbsp;</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >digoal-# &nbsp; &nbsp; &nbsp; &nbsp; extract(epoch from now() - min(last_analyze))::int/60/60&nbsp;</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >digoal-# &nbsp; &nbsp; &nbsp; &nbsp; from pg_stat_all_tables;</font></span></div><div><font size="2"   >&nbsp; &nbsp; sum &nbsp; &nbsp;| &nbsp; sum &nbsp; &nbsp;| ?column? | ?column?&nbsp;</font></div><div><font size="2"   >-----------+----------+----------+----------</font></div><div><font size="2"   >&nbsp;152919588 | 17332093 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;937</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>处理方法 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; hours_since_vacuum = int(pg_stat_table_values[2])</font></div><div><font size="2"   >改成</font></div><div><font size="2"   >&nbsp; &nbsp; hours_since_vacuum = int(pg_stat_table_values[2] or 0)</font></div><p></p></pre></div><div>所有可能出现空值的metric, 都建议修改一下.</div><div><br></div><div>[注意]</div><div>1. 自定义metric name的命名规则, 便于在gweb中聚合, 还有title, 便于了解含义.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://bucardo.org/wiki/Check_postgres"   >http://bucardo.org/wiki/Check_postgres</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014252816497/"   >http://blog.163.com/digoal@126/blog/static/1638770402014252816497/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201412763135184/"   >http://blog.163.com/digoal@126/blog/static/163877040201412763135184/</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://github.com/ganglia/gmond_python_modules/tree/master/postgresql"   >https://github.com/ganglia/gmond_python_modules/tree/master/postgresql</a></div><div>5.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014823102256805/"   >http://blog.163.com/digoal@126/blog/static/1638770402014823102256805/</a></div><div>6.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020148345219914/"   >http://blog.163.com/digoal@126/blog/static/16387704020148345219914/</a></div><div>7.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://github.com/mentalblock/ganglia_postgresql"   >https://github.com/mentalblock/ganglia_postgresql</a></div><div><div style="line-height: 28px;"   >8.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201481835916946/"   >http://blog.163.com/digoal@126/blog/static/163877040201481835916946/</a></div><div style="line-height: 28px;"   >9.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201481843417188/"   >http://blog.163.com/digoal@126/blog/static/163877040201481843417188/</a></div><div style="line-height: 28px;"   >10.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014819102825333/"   >http://blog.163.com/digoal@126/blog/static/1638770402014819102825333/</a></div></div><div style="line-height: 28px;"   >11.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://github.com/digoal/sky_postgresql_cluster/raw/master/INSTALL.txt"   >https://github.com/digoal/sky_postgresql_cluster/raw/master/INSTALL.txt</a></div><div style="line-height: 28px;"   >12.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://pgstatsinfo.projects.pgfoundry.org/"   >http://pgstatsinfo.projects.pgfoundry.org/</a></div><div style="line-height: 28px;"   >13.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201211354145701/"   >http://blog.163.com/digoal@126/blog/static/163877040201211354145701/</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="extended the postgresql metric python module on ganglia - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>