<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">ganglia - distributed monitor system</h2>
	<h5 id="">2014-09-03 16:42:47&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014833639454/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>传统的监控系统, 通常采用agent+server的方式, agent负责收集监控信息, 主动或被动发送给server, server负责向agent请求监控数据(agent被动), server和agent都通常使用TCP来进行连接.&nbsp;</div><div>传统监控的主要弊端,&nbsp;<span style="line-height: 28px;"   >当被监控的主机很多的情况下, server端的压力会很大, 例如要监控2万台主机的30个监控项, 就有60万个监控数据要从agent收集, 假设每分钟收集一次监控数据, 每秒需要上千次的metric get请求.&nbsp;</span></div><div>ganglia的设计思路比较巧妙, 有效的避免了这些问题.</div><div><br></div><div>ganglia分成3个主要组件.&nbsp;</div><div>gmond: 负责收集监控数据(metric), 有别于传统的agent, gmond除了收集自己的数据, 同时可以整合整个多播域的监控数据, 也就是说, 一个多播域里面, 单个gmond就可以包含所有的数据. &nbsp;例如一个多播域有200台主机, 那么200台主机的监控数据可以只从1台gmond获取, 从而减少了服务端以往要从200个主机获取的链接. 并且gmond之间是使用UDP来传输消息的, 在本地网络中比tcp效率要高. &nbsp;gmond 整合了一些常规监控(metric)例如cpu, network, memory, 同时支持c, python, gmetric来扩展监控项.</div><div>配置文件在gmond本地配置, 监控数据则通过XDR格式传输(<a target="_blank" rel="nofollow" href="http://en.wikipedia.org/wiki/External_Data_Representation"   >http://en.wikipedia.org/wiki/External_Data_Representation</a>)</div><div>gmond之间共享数据主要交给2个模块进行, sender和receiver, sender只负责往多播域发数据, receiver只负责从多播地址监听端口接收数据. 而且sender和receiver可以独立开启, 也就是说一个gmond可以配置为只发数据的模式, 那就类似传统的agent. 而如果配置为只接收数据的话, 就类似传统解决方案的proxy. 例如把整个多播域的所有gmond的数据全部接收到一个或几个gmond主机, 然后server则只需要从这几台中的任意一台gmond get metric即可.</div><div>只发不收的成为deaf(聋子), 只收不发的成为mute(哑巴).</div><div><br></div><div>gmetad: 负责从gmond获取metric数据, 解析gmond的监控数据, 按照每台主机的每个metric, 将数据写入RRDtools文件, 即每台主机的每个metric对应一个rrdtools文件(s).&nbsp;</div><div>因为gmetad的功能比较单一, 所以不使用gmetad, 直接使用SHELL或python写相关功能的脚本也可以代替gmetad的功能.</div><div>gmetad除了基本的功能, gmetad还支持从其他gmetad获取数据, 将数据发生给其他监控系统(如Graphite), 或者其他监控系统主动向gmetad请求数据(如nagios).&nbsp;</div><div><br></div><div>gweb: 负责监控数据的可视化, 使用RRD数据库.</div><div><br></div><div><span style="line-height: 28px;"   >扩展模块: c, python, gmetric, 因为gmond只整合了一些常见的metric, 如果要扩展监控的话, 需要写扩展模块, 或者直接使用gmetric来向gmond的sender通道发送监控数据, 例如我们要监控一个数据库的指标, 可以自己扩展监控模块.&nbsp;</span></div><div><span style="line-height: 28px;"   ><br></span></div><div><div><img title="ganglia - distributed monitor system - 德哥@Digoal - PostgreSQL research"   alt="ganglia - distributed monitor system - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/M6LFDwpGVvJUmCmRyT6NUQ==/6597346843589021016.png"   ></div><div><span style="line-height: 28px;"   >&nbsp;</span></div><div><img title="ganglia - distributed monitor system - 德哥@Digoal - PostgreSQL research"   alt="ganglia - distributed monitor system - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/UcPhZrlNUETuNr7FI7aZQg==/6597661303914271050.png"   ></div></div><div><span style="line-height: 28px;"   ><br></span></div><div>ganglia core的帮助文件可见一斑 : (core不包含gweb)</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-221 mans]# pwd</font></div><div><font size="2"   >/opt/soft_bak/ganglia-3.6.0/mans</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;2104 May &nbsp;7 &nbsp;2013 gmetad.1</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;1177 May &nbsp;7 &nbsp;2013 gmetad.py.1</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;2894 May &nbsp;7 &nbsp;2013 gmetric.1</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;2680 May &nbsp;7 &nbsp;2013 gmond.1</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;2412 May &nbsp;7 &nbsp;2013 gstat.1</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >gmetad : Ganglia Meta Daemon</font></div><div><div><font size="2"   >DESCRIPTION</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The &nbsp;Ganglia &nbsp;Meta &nbsp;Daemon &nbsp;(gmetad) collects information from multiple gmond or gmetad data sources, saves the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;information to local round-robin databases, and exports XML which is the concatentation of all data sources</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >gmetad.py : Ganglia Meta Daemon in Python</font></div><font size="2"   ><wbr></font><div><font size="2"   ><br></font></div><div><font size="2"   >gmond:&nbsp;Ganglia Monitor Daemon</font></div><div><div><font size="2"   >DESCRIPTION</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The &nbsp;Ganglia &nbsp;Monitoring &nbsp;Daemon &nbsp;(gmond) listens to the cluster message channel, stores the data in-memory and</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;when requested will output an XML description of the state of the cluster</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >gmetric:&nbsp;Ganglia Custom Metric Utility</font></div><div><div><font size="2"   >DESCRIPTION</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The &nbsp;Ganglia &nbsp;Metric Client (gmetric) announces a metric on the list of defined send channels defined in a con-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;figuration file</font></div></div><p></p></pre></div><div><br></div><div>其他,&nbsp;</div><div>当然ganglia也有其弱点, 例如没有像nagios, zabbix这种监控软件强大的事件管理功能. 需要结合ganglia和类nagios来使用.</div><div>也没有像pgstatsinfo这种监控软件的专业方面的功能.&nbsp;</div><div>我们一般可以利用ganglia来做数据波动类的监控, 例如负载, 内存使用量, 流量, TPS, 响应延迟, 队列数量, 数据库容量变化, 服务响应延迟, 等.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://ganglia.sourceforge.net/"   >http://ganglia.sourceforge.net/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://github.com/ganglia"   >https://github.com/ganglia</a></div><div>3. gmond, gmetad, gmetric依赖 :&nbsp;</div><div>* APR (<a target="_blank" rel="nofollow" href="http://apr.apache.org/"   >http://apr.apache.org/</a>)</div><div>* libConfuse (<a target="_blank" rel="nofollow" href="http://www.nongnu.org/confuse/"   >http://www.nongnu.org/confuse/</a>)</div><div>* expat (<a target="_blank" rel="nofollow" href="http://expat.sourceforge.net/"   >http://expat.sourceforge.net/</a>)</div><div>* pkg-config (<a target="_blank" rel="nofollow" href="http://www.freedesktop.org/wiki/Software/pkg-config"   >http://www.freedesktop.org/wiki/Software/pkg-config</a>)</div><div>* python (<a target="_blank" rel="nofollow" href="http://www.python.org/"   >http://www.python.org/</a>)</div><div>* PCRE (<a target="_blank" rel="nofollow" href="http://www.pcre.org/"   >http://www.pcre.org/</a>)</div><div>* RRDtool (<a target="_blank" rel="nofollow" href="http://oss.oetiker.ch/rrdtool/"   >http://oss.oetiker.ch/rrdtool/</a>)</div><div>4.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >Name</font></div><div><font size="2"   >&nbsp; &nbsp; ganglia - distributed monitoring system</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Version</font></div><div><font size="2"   >&nbsp; &nbsp; ganglia 3.6.0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; The latest version of this software and document will always be found at</font></div><div><font size="2"   >&nbsp; &nbsp; http://ganglia.sourceforge.net/.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Synopsis</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;______ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;___</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; / ____/___ _____ &nbsp;____ _/ (_)___ _</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;/ / __/ __ `/ __ \/ __ `/ / / __ `/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; / /_/ / /_/ / / / / /_/ / / / /_/ /</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; \____/\__,_/_/ /_/\__, /_/_/\__,_/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/____/ Distributed Monitoring System</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; Ganglia is a scalable distributed monitoring system for high-performance</font></div><div><font size="2"   >&nbsp; &nbsp; computing systems such as clusters and Grids. It is based on a</font></div><div><font size="2"   >&nbsp; &nbsp; hierarchical design targeted at federations of clusters. It relies on a</font></div><div><font size="2"   >&nbsp; &nbsp; multicast-based listen/announce protocol to monitor state within</font></div><div><font size="2"   >&nbsp; &nbsp; clusters and uses a tree of point-to-point connections amongst</font></div><div><font size="2"   >&nbsp; &nbsp; representative cluster nodes to federate clusters and aggregate their</font></div><div><font size="2"   >&nbsp; &nbsp; state. It leverages widely used technologies such as XML for data</font></div><div><font size="2"   >&nbsp; &nbsp; representation, XDR for compact, portable data transport, and RRDtool</font></div><div><font size="2"   >&nbsp; &nbsp; for data storage and visualization. It uses carefully engineered data</font></div><div><font size="2"   >&nbsp; &nbsp; structures and algorithms to achieve very low per-node overheads and</font></div><div><font size="2"   >&nbsp; &nbsp; high concurrency. The implementation is robust, has been ported to an</font></div><div><font size="2"   >&nbsp; &nbsp; extensive set of operating systems and processor architectures, and is</font></div><div><font size="2"   >&nbsp; &nbsp; currently in use on over 500 clusters around the world. It has been used</font></div><div><font size="2"   >&nbsp; &nbsp; to link clusters across university campuses and around the world and can</font></div><div><font size="2"   >&nbsp; &nbsp; scale to handle clusters with 2000 nodes.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; The ganglia system is comprised of two unique daemons, a PHP-based web</font></div><div><font size="2"   >&nbsp; &nbsp; frontend and a few other small utility programs.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; Ganglia Monitoring Daemon (gmond)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Gmond is a multi-threaded daemon which runs on each cluster node you</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; want to monitor. Installation is easy. You don't have to have a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; common NFS filesystem or a database backend, install special</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; accounts, maintain configuration files or other annoying hassles.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Gmond has four main responsibilities: monitor changes in host state,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; announce relevant changes, listen to the state of all other ganglia</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; nodes via a unicast or multicast channel and answer requests for an</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; XML description of the cluster state.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Each gmond transmits in information in two different ways:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; unicasting/multicasting host state in external data representation</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; (XDR) format using UDP messages or sending XML over a TCP</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; connection.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; Ganglia Meta Daemon (gmetad)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Federation in Ganglia is achieved using a tree of point-to-point</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; connections amongst representative cluster nodes to aggregate the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; state of multiple clusters. At each node in the tree, a Ganglia Meta</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Daemon ("gmetad") periodically polls a collection of child data</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sources, parses the collected XML, saves all numeric, volatile</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; metrics to round-robin databases and exports the aggregated XML over</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; a TCP sockets to clients. Data sources may be either "gmond"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; daemons, representing specific clusters, or other "gmetad" daemons,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; representing sets of clusters. Data sources use source IP addresses</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; for access control and can be specified using multiple IP addresses</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; for failover. The latter capability is natural for aggregating data</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; from clusters since each "gmond" daemon contains the entire state of</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; its cluster.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; Ganglia PHP Web Frontend</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; The Ganglia web frontend provides a view of the gathered information</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; via real-time dynamic web pages. Most importantly, it displays</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Ganglia data in a meaningful way for system administrators and</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; computer users. Although the web frontend to ganglia started as a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; simple HTML view of the XML tree, it has evolved into a system that</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; keeps a colorful history of all collected data.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; The Ganglia web frontend caters to system administrators and users.</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; For example, one can view the CPU utilization over the past hour,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; day, week, month, or year. The web frontend shows similar graphs for</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Memory usage, disk usage, network statistics, number of running</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; processes, and all other Ganglia metrics.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; The web frontend depends on the existence of the "gmetad" which</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; provides it with data from several Ganglia sources. Specifically,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; the web frontend will open the local port 8651 (by default) and</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; expects to receive a Ganglia XML tree. The web pages themselves are</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; highly dynamic; any change to the Ganglia data appears immediately</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; on the site. This behavior leads to a very responsive site, but</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; requires that the full XML tree be parsed on every page access.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Therefore, the Ganglia web frontend should run on a fairly powerful,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; dedicated machine if it presents a large amount of data.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; The Ganglia web frontend is written in the PHP scripting language,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; and uses graphs generated by "gmetad" to display history</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; information. It has been tested on many flavours of Unix (primarily</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Linux) with the Apache webserver and the PHP module (5.0.0 or</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; later). The GD graphics library for PHP is used to generate pie</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; charts in the frontend and needs to be installed separately. On</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; RPM-based system, it is usually provided by the php-gd package.</font></div></div><p></p></pre></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="ganglia - distributed monitor system - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>