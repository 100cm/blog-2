<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">ganglia customized module : postgresql module</h2>
	<h5 id="">2014-09-03 17:11:00&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020148345219914/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前面我们简单的聊了一下ganglia的架构, 以及它和其他监控软件如nagios, zabbix对比的优缺点.</div><div>gmond只整合了一些常用的监控metric, 如果需要监控不在gmond范围内的metric, 那么ganglia提供了一个接口, 可以用于扩展.</div><div>例如你可以用C/C++写扩展模块, 也可以用python写扩展模块, 如果你不想写扩展模块, 也可以使用gmetric直接向send channel发送自定义的metric数据.</div><div>本文将拿一个开源的ganglia module for postgresql为例, 结合PostgreSQL常用的监控指标来实现ganglia采样postgresql监控指标数据.</div><div>这个模块的代码请参见 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="https://github.com/ganglia/gmond_python_modules"   >https://github.com/ganglia/gmond_python_modules</a></div><div><a target="_blank" rel="nofollow" href="https://github.com/mentalblock/ganglia_postgresql/tree/master/python_modules"   >https://github.com/mentalblock/ganglia_postgresql/tree/master/python_modules</a></div><div><a target="_blank" rel="nofollow" href="https://github.com/elecnix/postgres_gmetric"   >https://github.com/elecnix/postgres_gmetric</a></div><div><br></div><div>postgresql python module的详解, 参考</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014823102256805/"   >http://blog.163.com/digoal@126/blog/static/1638770402014823102256805/</a></div><div><br></div><div>这个模块提到的监控项有 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># Create your queries here. Keys whose names match those defined in the default</font></div><div><font size="2"   ># set are overridden. Any additional key-value pairs (i.e. query) will not be</font></div><div><font size="2"   ># added to the Ganglia metric definition but can be useful for data purposes.</font></div><div><font size="2"   >metric_defs = {</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_backends_waiting": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Number of postgres backends that are waiting",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "backends",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT count(*) AS backends_waiting FROM " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pg_stat_activity WHERE waiting = 't';"</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_database_size": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Total size of all databases in bytes",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "value_type": "double",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "format": "%.0f",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "bytes",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT sum(pg_database_size(d.oid)) AS " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "size_database FROM pg_database d ORDER BY 1 DESC;"</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_idx_blks_read": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Total index blocks read",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "slope": "positive",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "blocks",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT sum(idx_blks_read) AS idx_blks_read " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "FROM pg_statio_all_indexes;"</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_idx_blks_hit": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Total index blocks hit",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "slope": "positive",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "blocks",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT sum(idx_blks_hit) AS idx_blks_hit " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "FROM pg_statio_all_indexes;"</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_locks": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Number of locks held",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "locks",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT count(*) FROM pg_locks;"</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_query_time_idle_in_txn": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": 'Age of longest _idle in transaction_ transaction',</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "seconds",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT COALESCE(max(COALESCE(ROUND(EXTRACT(epoch " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "FROM now()-query_start)),0)),0) AS " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "query_time_idle_in_txn FROM pg_stat_activity " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "WHERE current_query = '% in transaction';"</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_max_idle_txn_time": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Age of longest idle transaction",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "seconds",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT COALESCE(max(COALESCE(ROUND(EXTRACT(epoch " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "FROM now()-query_start)),0)),0) as query_time_max FROM " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"pg_stat_activity WHERE current_query &lt;&gt; '&lt;IDLE&gt;';"</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_txn_time_max": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Age of longest transaction",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "seconds",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT max(COALESCE(ROUND(EXTRACT(epoch " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "FROM now()-xact_start)),0)) as txn_time_max " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "FROM pg_stat_activity WHERE xact_start IS NOT NULL;"</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_connections": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Number of connections",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "connctions",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT sum(numbackends) FROM pg_stat_database;"</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_wal_files": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "number of wal files in pg_xlog directory",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "# wal files",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT count(*) AS wal_files FROM " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pg_ls_dir('pg_xlog') WHERE pg_ls_dir ~ E'^[0-9A-F]{24}$';"</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_xact_commit": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Transactions committed",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "slope": "positive",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "transactions",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT sum(xact_commit) as xact_commit FROM " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pg_stat_database;",</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_xact_rollback": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Transactions rolled back",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "slope": "positive",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "transactions",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT sum(xact_rollback) as xact_rollback FROM " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pg_stat_database;",</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_blks_read": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Blocks read",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "slope": "positive",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "blocks",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT sum(blks_read) as blks_read FROM " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pg_stat_database;",</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_blks_hit": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Blocks hit",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "slope": "positive",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "blocks",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT sum(blks_hit) as blks_hit FROM " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pg_stat_database;",</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_tup_returned": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Tuples returned",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "slope": "positive",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "tuples",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT sum(tup_returned) as tup_returned FROM " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pg_stat_database;",</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_tup_fetched": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Tuples fetched",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "slope" &nbsp; &nbsp; &nbsp; : "positive",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "tuples",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT sum(tup_fetched) as tup_fetched FROM " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pg_stat_database;",</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_tup_inserted": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Tuples inserted",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "slope": "positive",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "tuples",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT sum(tup_inserted) as tup_inserted FROM " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pg_stat_database;",</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_tup_updated": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Tuples updated",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "slope": "positive",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "tuples",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT sum(tup_updated) as tup_updated FROM " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pg_stat_database;",</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_tup_deleted": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Tuples deleted",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "slope": "positive",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "tuples",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT sum(tup_deleted) as tup_deleted FROM " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pg_stat_database;",</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_heap_blks_read": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Heap blocks read",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "slope": "positive",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "blocks",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT sum(heap_blks_read) as heap_blks_read FROM " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pg_statio_all_tables;",</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_heap_blks_hit": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Heap blocks hit",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "slope": "positive",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "blocks",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT sum(heap_blks_hit) as heap_blks_hit FROM " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pg_statio_all_tables;",</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_idx_blks_read_tbl": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Index blocks read",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "slope": "positive",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "blocks",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT sum(idx_blks_read) as idx_blks_read_tbl FROM " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pg_statio_all_tables;",</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_idx_blks_hit_tbl": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Index blocks hit",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "slope": "positive",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "blocks",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT sum(idx_blks_hit) as idx_blks_hit_tbl FROM " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pg_statio_all_tables;",</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_toast_blks_read": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Toast blocks read",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "slope": "positive",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "blocks",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT sum(toast_blks_read) as toast_blks_read FROM " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pg_statio_all_tables;",</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_toast_blks_hit": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Toast blocks hit",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "slope": "positive",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "blocks",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT sum(toast_blks_hit) as toast_blks_hit FROM " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pg_statio_all_tables;",</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_tidx_blks_read": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Toast index blocks read",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "slope": "positive",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "blocks",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT sum(tidx_blks_read) as tidx_blks_read FROM " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pg_statio_all_tables;",</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; "pg_tidx_blks_hit": {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "description": "Toast index blocks hit",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "slope": "positive",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "units": "blocks",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query": "SELECT sum(tidx_blks_hit) as tidx_blks_hit FROM " + \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pg_statio_all_tables;",</font></div><div><font size="2"   >&nbsp; &nbsp; },</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>除此以外, 还可以丰富一下监控项. 如下 :&nbsp;</div><div>postgresql常见监控项 :&nbsp;</div><div><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201412763135184/"   >http://blog.163.com/digoal@126/blog/static/163877040201412763135184/</a></div><div><div>1. 是否打开归档, 布尔逻辑值.</div><div>2. 是否打开autovacuum<span style="line-height: 28px;"   >, 布尔逻辑值.</span></div><div>3. 数据库年龄, 数字, 大于2, 低于20亿(大约).</div><div>4. 连接数, 低于最大连接数</div><div>5. 提交和回滚的比例(问题修复后,手工清除统计信息pg_stat_reset(), 连接到对应的库执行).</div><div>6. standby延迟, 字节数, 延迟高说明网络或STANDBY的IO有问题.&nbsp;</div><div>7. 锁等待, 锁等待时间, 长则说明业务或在SQL的处理效率上有问题.&nbsp;</div><div>8. 长事务/空闲事务, 长事务一般可能是业务设计的问题.&nbsp;</div><div>9. prepared事务, 长时间的PREPARED事务可能是业务层出了问题, 例如未及时提交, 或业务以及挂了, prepared事务变成了僵尸事务.&nbsp;</div><div>10. 序列剩余量(每个库查询), 序列如果没有开启cycle, 那么需要注意是否耗尽的问题.&nbsp;</div><div>11. 未使用的索引(每个库查询), 如果索引不常使用, 那么说明索引不如不建.&nbsp;</div></div><div>以上监控指标都可以量化, 所以使用ganglia来监控是可以的.</div><div><br></div><div>常见巡检项 :&nbsp;</div><div><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014252816497/"   >http://blog.163.com/digoal@126/blog/static/1638770402014252816497/</a></div><wbr><div><br></div>[参考<span style="line-height: 28px;"   >]</span><div><wbr></div><div><span style="line-height: 28px;"   >1.&nbsp;</span><a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://github.com/mentalblock/ganglia_postgresql"   >https://github.com/mentalblock/ganglia_postgresql</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014833639454/"   >http://blog.163.com/digoal@126/blog/static/1638770402014833639454/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014252816497/"   >http://blog.163.com/digoal@126/blog/static/1638770402014252816497/</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201412763135184/"   >http://blog.163.com/digoal@126/blog/static/163877040201412763135184/</a></div><div>5.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://bucardo.org/wiki/Check_postgres"   >http://bucardo.org/wiki/Check_postgres</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="ganglia customized module : postgresql module - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>