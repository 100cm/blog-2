<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">zabbix template pg_monz for PostgreSQL</h2>
	<h5 id="">2014-09-22 15:12:18&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201481951534154/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>之前写过一些关于zabbix监控和ganglia监控的相关文章, 有兴趣的朋友可以参考</div><div><a target="_blank" rel="nofollow" href="http://blog.163.com/digoal@126/blog/#m=0&amp;t=1&amp;c=fks_084075080085088066084084082095085080082075083081086071084"   >http://blog.163.com/digoal@126/blog/#m=0&amp;t=1&amp;c=fks_084075080085088066084084082095085080082075083081086071084</a></div><div>ganglia的应用场景有限, 强项是画图, 众多监控目标的实时收集采集等, 利用rrdtool特性可以在图形上做一些文章, 例如添加event区域, 图形属性聚合, compare等.</div><div>但是<span style="line-height: 28px;"   >ganglia欠缺</span><span style="line-height: 28px;"   >设置阈值告警的功能, 这类功能可以用如zabbix, nagios这样的监控软件来实现.&nbsp;</span></div><div><span style="line-height: 28px;"   >PostgreSQL要监控哪些东西, 可以参考 :&nbsp;</span></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014252816497/"   >http://blog.163.com/digoal@126/blog/static/1638770402014252816497/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201412763135184/"   >http://blog.163.com/digoal@126/blog/static/163877040201412763135184/</a></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >本文要说的是zabbix的一个postgresql监控模板,&nbsp;</span></div><div><a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://pg-monz.github.io/pg_monz/index-en.html"   >http://pg-monz.github.io/pg_monz/index-en.html</a></div><div><br></div><div>部署步骤如下:</div><div>1. 部署zabbix server端</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014731111811804/"   >http://blog.163.com/digoal@126/blog/static/1638770402014731111811804/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014811040957/"   >http://blog.163.com/digoal@126/blog/static/1638770402014811040957/</a></div><div>2. 部署zabbix proxy (可选)</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020148110173574/"   >http://blog.163.com/digoal@126/blog/static/16387704020148110173574/</a></div><div>3. 部署zabbix agent (建议在被监控的数据库服务器上安装, 使用127.0.0.1或unix socket连接数据库, 配置为trust或配置.pgpass)</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201481103924780/"   >http://blog.163.com/digoal@126/blog/static/163877040201481103924780/</a></div><div>4. 下载模板(zabbix server 端)</div><div><a target="_blank" rel="nofollow" href="https://raw.githubusercontent.com/pg-monz/pg_monz/master/pg_monz/pg_monz_template.xml"   >https://raw.githubusercontent.com/pg-monz/pg_monz/master/pg_monz/pg_monz_template.xml</a></div><div>(注意不要直接另存为, 最好是git clone , 或直接拷贝内容, 编译一个xml文件)</div><div># git clone https://raw.githubusercontent.com/pg-monz/pg_monz</div><div><br></div><div>5. 导入模板<span style="line-height: 28px;"   >(zabbix server 端)</span></div><div><span style="line-height: 28px;"   >在web界面点击, Configuration, Templates, Import</span></div><div><div><img title="zabbix template pg_monz for PostgreSQL - 德哥@Digoal - PostgreSQL research"   alt="zabbix template pg_monz for PostgreSQL - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/ghuevoj7cCftMZuUGPl-zQ==/6619514097514077033.png"   ></div>已导入 :&nbsp;<br><div><img title="zabbix template pg_monz for PostgreSQL - 德哥@Digoal - PostgreSQL research"   alt="zabbix template pg_monz for PostgreSQL - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/HSsX4u_BRvgDFV-yuk_WOQ==/6619123770886218266.png"   ></div><div><br></div>6. 配置模板 :&nbsp;</div><div>某些宏根据你的应用场景进行修改.<br><div><img title="zabbix template pg_monz for PostgreSQL - 德哥@Digoal - PostgreSQL research"   alt="zabbix template pg_monz for PostgreSQL - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/fPeH3mKC6wGa-wSbUmd9gg==/6608919203469189027.png"   ></div>注意宏的用途, 例如PGSCRIPTDIR.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 pg_monz]# grep -r PGSCRIPTDIR *</font></div><div><font size="2"   >pg_monz_template.xml: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;key&gt;db_table.list.discovery[{$PGHOST},{$PGPORT},{$PGROLE},{$PGDATABASE},{$PGSCRIPTDIR}]&lt;/key&gt;</font></div><div><font size="2"   >pg_monz_template.xml: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;key&gt;db.list.discovery[{$PGHOST},{$PGPORT},{$PGROLE},{$PGDATABASE},{$PGSCRIPTDIR}]&lt;/key&gt;</font></div><div><font size="2"   >pg_monz_template.xml: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;macro&gt;{$PGSCRIPTDIR}&lt;/macro&gt;</font></div><p></p></pre></div><div>显然是用于调用find_dbname.sh和find_dbname_table.sh的.</div><div>PGLOGDIR则是postgresql log的目录.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 pg_monz]# grep -r PGLOGDIR *</font></div><div><font size="2"   >pg_monz_template.xml: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;key&gt;logrt[&amp;quot;{$PGLOGDIR}/postgresql-.*\.log&amp;quot;,&amp;quot;PANIC|FATAL|ERROR|[Ee]rror&amp;quot;]&lt;/key&gt;</font></div><div><font size="2"   >pg_monz_template.xml: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;macro&gt;{$PGLOGDIR}&lt;/macro&gt;</font></div><p></p></pre></div><div>但是LOG目录可能不同的数据库配置不一样, 所以你可以在所有的数据库服务器建立一个软链接, 来解决这个问题.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ln -s $PGDATA/pg_log /var/pg_log</font></div><div><font size="2"   >{$PGLOGDIR} = /var/pg_log &nbsp;(统一使用这个)</font></div><p></p></pre></div><div>PGROLE可能需要PG超级用户, 或者是可以执行本监控模板中所有SQL的用户.</div><div>如果需要密码的话, 建议配置.pgpass.</div><div><br></div><div>7. 下载监控脚本以及配置文件(zabbix agent 端)</div><div><a target="_blank" rel="nofollow" href="https://github.com/pg-monz/pg_monz/blob/master/pg_monz/find_dbname.sh"   >https://github.com/pg-monz/pg_monz/blob/master/pg_monz/find_dbname.sh</a></div><div><a target="_blank" rel="nofollow" href="https://github.com/pg-monz/pg_monz/blob/master/pg_monz/find_dbname_table.sh"   >https://github.com/pg-monz/pg_monz/blob/master/pg_monz/find_dbname_table.sh</a></div><div><a target="_blank" rel="nofollow" href="https://github.com/pg-monz/pg_monz/blob/master/pg_monz/userparameter_pgsql.conf"   >https://github.com/pg-monz/pg_monz/blob/master/pg_monz/userparameter_pgsql.conf</a></div><div>脚本需要放到模板宏<span style="line-height: 28px;"   >PGSCRIPTDIR的制定位置.</span></div><div><span style="line-height: 28px;"   >并配置可执行权限.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 pg_monz]# cp find_dbname.sh find_dbname_table.sh /usr/local/bin/</font></div><div><font size="2"   >[root@db-172-16-3-221 pg_monz]# chown postgres:postgres /usr/local/bin/find_dbname*.sh</font></div><div><font size="2"   >[root@db-172-16-3-221 pg_monz]# chmod 555 /usr/local/bin/find_dbname*.sh</font></div><p></p></pre></div><wbr><div>简单的来看一个脚本:&nbsp;</div><div>find_dbname.sh, 用来输出PostgreSQL的所有数据库 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 pg_monz]# cat find_dbname.sh</font></div><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Get list of Database Name which you want to monitor.</font></div><div><font size="2"   ># The default settings are excepted template databases(template0/template1).</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># :Example</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># If you want to monitor "foo" and "bar" databases, you set the GETDB as</font></div><div><font size="2"   ># GETDB="select datname from pg_database where datname in ('foo','bar');"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >GETDB="select datname from pg_database where datistemplate = 'f';"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >for dbname in $(psql -h $1 -p $2 -U $3 -d $4 -t -c "${GETDB}"); do</font></div><div><font size="2"   >&nbsp; &nbsp; dblist="$dblist,"'{"{#DBNAME}":"'$dbname'"}'</font></div><div><font size="2"   >done</font></div><div><font size="2"   >echo '{"data":['${dblist#,}' ]}'</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-221 pg_monz]# export PATH=/opt/pgsql/bin:$PATH</font></div><div><font size="2"   >[root@db-172-16-3-221 pg_monz]# . ./find_dbname.sh 127.0.0.1 5432 postgres postgres</font></div><div><font size="2"   >{"data":[{"{#DBNAME}":"postgres"},{"{#DBNAME}":"digoal"} ]}</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >find_dbname_table.sh, 用来输出数据库对应的表.</span></div><div><span style="line-height: 28px;"   >在得到数据库和表之后, 可以对数据库, 表进行监控查询.</span></div><div><span style="line-height: 28px;"   ><br></span></div><div>8. 配置zabbix agent端.</div><div>8.1. 修改数据库的pg_log, 到/var/pg_log, (和PGLOGDIR一致即可).</div><div>另外需要确认其他的宏和被监控的数据库一致.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 pg_monz]# ln -s /data01/pgdata/pg_root/pg_log /var/</font></div><div></div><p></p></pre></div><div>8.2. 可能需要添加.pgpass, 配合模板需要的连接, 不需要密码访问.</div><div>8.3. 将userparameter_pgsql.conf拷贝到zabbix agent配置目录.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 pg_monz]# cp userparameter_pgsql.conf /opt/zabbix/etc/zabbix_agentd.conf.d/</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >这里的监控项如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 zabbix_agentd.conf.d]# cat userparameter_pgsql.conf&nbsp;</font></div><div><font size="2"   ># PostgreSQL user parameter</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#</font></div><div><font size="2"   ># Server specific examples</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># Get the total number of committed transactions</font></div><div><font size="2"   >UserParameter=psql.tx_committed[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select sum(xact_commit) from pg_stat_database"</font></div><div><font size="2"   ># Get the total number of rolled back transactions</font></div><div><font size="2"   >UserParameter=psql.tx_rolledback[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select sum(xact_rollback) from pg_stat_database"</font></div><div><font size="2"   ># Max Connections</font></div><div><font size="2"   >UserParameter=psql.server_maxcon[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "show max_connections"</font></div><div><font size="2"   ># PostgreSQL is running</font></div><div><font size="2"   >UserParameter=psql.running[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select 1" &gt; /dev/null 2&gt;&amp;1 ; echo $?</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Added by SRA OSS</font></div><div><font size="2"   ># Get number of checkpoint count (by checkpoint_timeout)</font></div><div><font size="2"   >UserParameter=psql.checkpoints_timed[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select checkpoints_timed from pg_stat_bgwriter"</font></div><div><font size="2"   ># Get number of checkpoint count (by checkpoint_segments)</font></div><div><font size="2"   >UserParameter=psql.checkpoints_req[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select checkpoints_req from pg_stat_bgwriter"</font></div><div><font size="2"   ># Get the total number of connections</font></div><div><font size="2"   >UserParameter=psql.server_connections[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select count(*) from pg_stat_activity;"</font></div><div><font size="2"   ># Get the total number of active (on processing SQL) connections</font></div><div><font size="2"   >UserParameter=psql.active_connections[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select count(state) from pg_stat_activity where state = 'active'"</font></div><div><font size="2"   ># Get the total number of idle connections</font></div><div><font size="2"   >UserParameter=psql.idle_connections[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select count(state) from pg_stat_activity where state = 'idle'"</font></div><div><font size="2"   ># Get the total number of idle in transaction connections</font></div><div><font size="2"   >UserParameter=psql.idle_tx_connections[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select count(state) from pg_stat_activity where state = 'idle in transaction'"</font></div><div><font size="2"   ># Get the total number of lock-waiting connections</font></div><div><font size="2"   >UserParameter=psql.locks_waiting[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select count(*) from pg_stat_activity where waiting = 't'"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Get buffer information</font></div><div><font size="2"   >UserParameter=psql.buffers_checkpoint[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select buffers_checkpoint from pg_stat_bgwriter"</font></div><div><font size="2"   >UserParameter=psql.buffers_clean[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select buffers_clean from pg_stat_bgwriter"</font></div><div><font size="2"   >UserParameter=psql.maxwritten_clean[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select maxwritten_clean from pg_stat_bgwriter"</font></div><div><font size="2"   >UserParameter=psql.buffers_backend[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select buffers_backend from pg_stat_bgwriter"</font></div><div><font size="2"   >UserParameter=psql.buffers_backend_fsync[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select buffers_backend_fsync from pg_stat_bgwriter"</font></div><div><font size="2"   >UserParameter=psql.buffers_alloc[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select buffers_alloc from pg_stat_bgwriter"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Get number of slow queries</font></div><div><font size="2"   >UserParameter=psql.slow_queries[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select count(*) from pg_stat_activity where state = 'active' and now() - query_start &gt; '$5 sec'::interval"</font></div><div><font size="2"   >UserParameter=psql.slow_select_queries[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select count(*) from pg_stat_activity where state = 'active' and now() - query_start &gt; '$5 sec'::interval and query ilike 'select%'"</font></div><div><font size="2"   >UserParameter=psql.slow_dml_queries[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select count(*) from pg_stat_activity where state = 'active' and now() - query_start &gt; '$5 sec'::interval and query ~* '^(insert|update|delete)'"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#</font></div><div><font size="2"   ># Database specific examples</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># Get the size of a Database (in bytes)</font></div><div><font size="2"   >UserParameter=psql.db_size[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select pg_database_size('$5') from pg_database where datname = '$5'"</font></div><div><font size="2"   ># Get number of active connections for a specified database</font></div><div><font size="2"   >UserParameter=psql.db_connections[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select numbackends from pg_stat_database where datname = '$5'"</font></div><div><font size="2"   ># Get number of tuples returned for a specified database</font></div><div><font size="2"   >UserParameter=psql.db_returned[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select tup_returned from pg_stat_database where datname = '$5'"</font></div><div><font size="2"   ># Get number of tuples fetched for a specified database</font></div><div><font size="2"   >UserParameter=psql.db_fetched[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select tup_fetched from pg_stat_database where datname = '$5'"</font></div><div><font size="2"   ># Get number of tuples inserted for a specified database</font></div><div><font size="2"   >UserParameter=psql.db_inserted[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select tup_inserted from pg_stat_database where datname = '$5'"</font></div><div><font size="2"   ># Get number of tuples updated for a specified database</font></div><div><font size="2"   >UserParameter=psql.db_updated[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select tup_updated from pg_stat_database where datname = '$5'"</font></div><div><font size="2"   ># Get number of tuples deleted for a specified database</font></div><div><font size="2"   >UserParameter=psql.db_deleted[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select tup_deleted from pg_stat_database where datname = '$5'"</font></div><div><font size="2"   ># Get number of committed/rolled back transactions for a specified database</font></div><div><font size="2"   >UserParameter=psql.db_tx_committed[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select xact_commit from pg_stat_database where datname = '$5'"</font></div><div><font size="2"   >UserParameter=psql.db_tx_rolledback[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select xact_rollback from pg_stat_database where datname = '$5'"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Cache Hit Ratio</font></div><div><font size="2"   >UserParameter=psql.cachehit_ratio[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "SELECT round(blks_hit*100/(blks_hit+blks_read), 2) AS cache_hit_ratio FROM pg_stat_database WHERE datname = '$5' and blks_read &gt; 0 union all select 0.00 AS cache_hit_ratio order by cache_hit_ratio desc limit 1"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Added by SRA OSS</font></div><div><font size="2"   ># Get number of temp files</font></div><div><font size="2"   >UserParameter=psql.db_temp_files[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select temp_files from pg_stat_database where datname = '$5'"</font></div><div><font size="2"   ># Get temp file size (in bytes)</font></div><div><font size="2"   >UserParameter=psql.db_temp_bytes[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select temp_bytes from pg_stat_database where datname = '$5'"</font></div><div><font size="2"   ># Get percentage of dead tuples of all tables for a specified database</font></div><div><font size="2"   >UserParameter=psql.db_dead_tup_ratio[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select round(sum(n_dead_tup)*100/sum(n_live_tup+n_dead_tup), 2) as dead_tup_ratio from pg_stat_all_tables where n_live_tup &gt; 0"</font></div><div><font size="2"   ># Get number of deadlocks for a specified database (9.2 or later)</font></div><div><font size="2"   >UserParameter=psql.db_deadlocks[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select deadlocks from pg_stat_database where datname = '$5'"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#</font></div><div><font size="2"   ># Table specific examples</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># Get table cache hit ratio of a specific table</font></div><div><font size="2"   >UserParameter=psql.table_cachehit_ratio[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select round(heap_blks_hit*100/(heap_blks_hit+heap_blks_read), 2) as cache_hit_ratio from pg_statio_user_tables where schemaname = '$5' and relname = '$6' and heap_blks_read &gt; 0 union all select 0.00 as cache_hit_ratio order by cache_hit_ratio desc limit 1"</font></div><div><font size="2"   ># Get number of sequencial scan of a specific table</font></div><div><font size="2"   >UserParameter=psql.table_seq_scan[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select seq_scan from pg_stat_user_tables where schemaname = '$5' and relname = '$6'"</font></div><div><font size="2"   ># Get number of index scan of a specific table</font></div><div><font size="2"   >UserParameter=psql.table_idx_scan[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select coalesce(idx_scan,0) from pg_stat_user_tables where schemaname = '$5' and relname = '$6'"</font></div><div><font size="2"   ># Get number of vacuum count of a specific table</font></div><div><font size="2"   >UserParameter=psql.table_vacuum_count[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select vacuum_count from pg_stat_user_tables where schemaname = '$5' and relname = '$6'"</font></div><div><font size="2"   ># Get number of analyze count of a specific table</font></div><div><font size="2"   >UserParameter=psql.table_analyze_count[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select analyze_count from pg_stat_user_tables where schemaname = '$5' and relname = '$6'"</font></div><div><font size="2"   ># Get number of autovacuum count of a specific table</font></div><div><font size="2"   >UserParameter=psql.table_autovacuum_count[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select autovacuum_count from pg_stat_user_tables where schemaname = '$5' and relname = '$6'"</font></div><div><font size="2"   ># Get number of autoanalyze count of a specific table</font></div><div><font size="2"   >UserParameter=psql.table_autoanalyze_count[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select autoanalyze_count from pg_stat_user_tables where schemaname = '$5' and relname = '$6'"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Get number of tuples of a specific table</font></div><div><font size="2"   >UserParameter=psql.table_n_tup_ins[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select n_tup_ins from pg_stat_user_tables where schemaname = '$5' and relname = '$6'"</font></div><div><font size="2"   >UserParameter=psql.table_n_tup_upd[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select n_tup_upd from pg_stat_user_tables where schemaname = '$5' and relname = '$6'"</font></div><div><font size="2"   >UserParameter=psql.table_n_tup_del[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select n_tup_del from pg_stat_user_tables where schemaname = '$5' and relname = '$6'"</font></div><div><font size="2"   >UserParameter=psql.table_seq_tup_read[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select seq_tup_read from pg_stat_user_tables where schemaname = '$5' and relname = '$6'"</font></div><div><font size="2"   >UserParameter=psql.table_idx_tup_fetch[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select coalesce(idx_tup_fetch,0) from pg_stat_user_tables where schemaname = '$5' and relname = '$6'"</font></div><div><font size="2"   >UserParameter=psql.table_n_tup_hot_upd[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select n_tup_hot_upd from pg_stat_user_tables where schemaname = '$5' and relname = '$6'"</font></div><div><font size="2"   >UserParameter=psql.table_n_live_tup[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select n_live_tup from pg_stat_user_tables where schemaname = '$5' and relname = '$6'"</font></div><div><font size="2"   >UserParameter=psql.table_n_dead_tup[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select n_dead_tup from pg_stat_user_tables where schemaname = '$5' and relname = '$6'"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#</font></div><div><font size="2"   ># Discovery Rule</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># Database Discovery</font></div><div><font size="2"   >UserParameter=db.list.discovery[*],$5/find_dbname.sh $1 $2 $3 $4</font></div><div><font size="2"   >UserParameter=db_table.list.discovery[*],$5/find_dbname_table.sh $1 $2 $3 $4</font></div><p></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >8.4. 配置</span><span style="line-height: 28px;"   >zabbix_agentd.conf (被动监控)</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-221 etc]# cd /opt/zabbix/etc/</font></div><div><font size="2"   >[root@db-172-16-3-221 etc]# ll</font></div><div><font size="2"   >total 20</font></div><div><font size="2"   >-rw-r--r-- 1 root root 2485 Sep &nbsp;1 14:45 zabbix_agent.conf</font></div><div><font size="2"   >drwxr-xr-x 2 root root 4096 Sep 22 14:24 zabbix_agent.conf.d</font></div><div><font size="2"   >-rw-r--r-- 1 root root 7456 Sep &nbsp;1 17:19 zabbix_agentd.conf</font></div><div><font size="2"   >drwxr-xr-x 2 root root 4096 Sep &nbsp;1 14:45 zabbix_agentd.conf.d</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-221 etc]# vi zabbix_agentd.conf</font></div></div><div><font size="2"   >Include=<span style="line-height: 28px;"   >/opt/zabbix/etc/zabbix_agentd.conf.d/</span></font></div><div><font size="2"   >PidFile=/tmp/zabbix_agentd.pid<br>LogFile=/tmp/zabbix_agentd.log<br>LogFileSize=10<br>EnableRemoteCommands=1<br>LogRemoteCommands=1<br>Server=172.16.3.150<br>ListenPort=10050<br>ListenIP=0.0.0.0<br>StartAgents=8<br>ServerActive=172.16.3.150:10052<br>Hostname=agent221<br>RefreshActiveChecks=60</font></div><p></p></pre></div><div><br></div><div>8.5. 启动agentd</div><div>[root@db-172-16-3-221 etc]# su - postgres -c "<span style="line-height: 28px;"   >/opt/zabbix/sbin/</span><span style="line-height: 28px;"   >zabbix_agentd -c /opt/zabbix/etc/zabbix_agentd.conf"</span></div><div><br></div><div>9. 创建监控主机, 或配置已监控的主机添加模板.</div><div><div><img title="zabbix template pg_monz for PostgreSQL - 德哥@Digoal - PostgreSQL research"   alt="zabbix template pg_monz for PostgreSQL - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/5Xp8IJph66kueTS-pdD6wQ==/6608257297470333318.png"   ></div></div><div><br></div><div>10. 查看PostgreSQL监控模板的items有被刷新.</div><div><div><img title="zabbix template pg_monz for PostgreSQL - 德哥@Digoal - PostgreSQL research"   alt="zabbix template pg_monz for PostgreSQL - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/_0Ac0VZvUJFOeU_qVd1OYA==/6619514097514077501.png"   ></div><br></div><div><br></div><div>[其他]</div><div>1. 如果宏的配置不通用的话(例如被监控的数据库有几百台, 但是监听端口不一样的话), 可以配置主机宏覆盖值.</div><div><div><img title="zabbix template pg_monz for PostgreSQL - 德哥@Digoal - PostgreSQL research"   alt="zabbix template pg_monz for PostgreSQL - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/rmXpyNS0dIDcPXUYV_cBwQ==/6608830143027340684.png"   ></div></div><div>2. 如果没有PostgreSQL模板信息被刷新的话, 可以排查一下agentd端的脚本权限, PATH路径等是否正确. 除了要调用两个脚本, 还需要调用psql命令.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://pg-monz.github.io/pg_monz/index-en.html"   >http://pg-monz.github.io/pg_monz/index-en.html</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://github.com/pg-monz/pg_monz/tree/master/pg_monz"   >https://github.com/pg-monz/pg_monz/tree/master/pg_monz</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014731111811804/"   >http://blog.163.com/digoal@126/blog/static/1638770402014731111811804/</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL zabbix template - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>