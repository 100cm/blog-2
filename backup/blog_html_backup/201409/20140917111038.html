<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">RHCS fence_openstack client used in openstack</h2>
	<h5 id="">2014-09-17 11:10:38&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014817111038741/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>用于openstack环境中的fence.</div><div>RHCS Fencing Agent for use on OpenStack guests</div><div><a target="_blank" rel="nofollow" href="https://github.com/beekhof/fence_openstack"   >https://github.com/beekhof/fence_openstack</a></div><div><br></div><wbr><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># Copyright (c) 2012 Andrew Beekhof</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;All Rights Reserved.</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># This program is free software; you can redistribute it and/or modify</font></div><div><font size="2"   ># it under the terms of version 2 of the GNU General Public License as</font></div><div><font size="2"   ># published by the Free Software Foundation.</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># This program is distributed in the hope that it would be useful, but</font></div><div><font size="2"   ># WITHOUT ANY WARRANTY; without even the implied warranty of</font></div><div><font size="2"   ># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># Further, this software is distributed without any warranty that it is</font></div><div><font size="2"   ># free of the rightful claim of any third person regarding infringement</font></div><div><font size="2"   ># or the like. &nbsp;Any license provided herein, whether implied or</font></div><div><font size="2"   ># otherwise, applies only to this software file. &nbsp;Patent licenses, if</font></div><div><font size="2"   ># any, provided herein do not apply to combinations of this program with</font></div><div><font size="2"   ># other software, or any other product whatsoever.</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># You should have received a copy of the GNU General Public License</font></div><div><font size="2"   ># along with this program; if not, write the Free Software Foundation,</font></div><div><font size="2"   ># Inc., 59 Temple Place - Suite 330, Boston MA 02111-1307, USA.</font></div><div><font size="2"   >#</font></div><div><font size="2"   >#######################################################################</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >description="</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >fence_openstack is an I/O Fencing agent which can be used with</font></div><div><font size="2"   >OpenStack instances. &nbsp;In order to function, the agent needs the Python</font></div><div><font size="2"   >nova client and the following data:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >- region name</font></div><div><font size="2"   >- tenant name</font></div><div><font size="2"   >- authentication url (eg. http://open.stack:5000/v2.0/)</font></div><div><font size="2"   >- user name</font></div><div><font size="2"   >- password</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The value for 'port' can either be the.</font></div><div><font size="2"   >&nbsp;- Instance name (must not contain spaces),</font></div><div><font size="2"   >&nbsp;- Instance ID (eg. 0365bd97-3c2d-416f-ae07-b9772aff5938)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >If the name used by the cluster node is one of these values, then,</font></div><div><font size="2"   >when used with Pacemaker, the agent should be able to automatically</font></div><div><font size="2"   >discover the instances it can control.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The name and id values can be obtained using 'nova list', eg.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >+--------------------------------------+----------------+--------+---------------------------------------+</font></div><div><font size="2"   >| ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Status | Networks &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"   >+--------------------------------------+----------------+--------+---------------------------------------+</font></div><div><font size="2"   >| 0365bd97-3c2d-416f-ae07-b9772aff5938 | CTS-Master &nbsp; &nbsp; | ACTIVE | novanetwork=192.168.0.40, 10.16.16.55 |</font></div><div><font size="2"   >| 7320e184-afbd-46a8-aec7-94c38ec67e21 | Fedora-18-base | ACTIVE | novanetwork=192.168.0.9 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"   >+--------------------------------------+----------------+--------+---------------------------------------+</font></div><div><font size="2"   >"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >port=""</font></div><div><font size="2"   >quiet=0</font></div><div><font size="2"   >unknown_are_stopped=0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >action="list" &nbsp; &nbsp; &nbsp; &nbsp; # Default fence action</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Inherit from the environment if present</font></div><div><font size="2"   >os_region="$OS_REGION_NAME"</font></div><div><font size="2"   >os_tenant="$OS_TENANT_NAME"</font></div><div><font size="2"   >os_auth="$OS_AUTH_URL"</font></div><div><font size="2"   >os_user="$OS_USERNAME"</font></div><div><font size="2"   >os_pass="$OS_PASSWORD"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >function usage()</font></div><div><font size="2"   >{</font></div><div><font size="2"   >cat &lt;&lt;EOF</font></div><div><font size="2"   >`basename $0` - A fencing agent for OpenStack instances</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >$description</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >Usage: `basename $0` -o|--action [-n|--port] [options]</font></div><div><font size="2"   >Options:</font></div><div><font size="2"   >&nbsp;-h, --help <span>		</span>This text</font></div><div><font size="2"   >&nbsp;-V, --version<span>		</span>Version information</font></div><div><font size="2"   >&nbsp;-q, --quiet <span>		</span>Reduced output mode</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >Commands:</font></div><div><font size="2"   >&nbsp;-o, --action<span>		</span>Action to perform: on|off|reboot|status|monitor</font></div><div><font size="2"   >&nbsp;-n, --port <span>		</span>The name of a machine/instance to control/check</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Additional Options:</font></div><div><font size="2"   >&nbsp;-a, --auth<span>	</span> <span>	</span>The OpenStack authentication URL (eg. http://open.stack:5000/v2.0/)</font></div><div><font size="2"   >&nbsp;-r, --region<span>		</span>The OpenStack region for which the device should control instances (defaults to us-east-1)</font></div><div><font size="2"   >&nbsp;-t, --tenant<span>		</span>The OpenStack tenant name. Might match the username.</font></div><div><font size="2"   >&nbsp;-u, --user<span>		</span>The OpenStack username to connect as</font></div><div><font size="2"   >&nbsp;-p, --pass <span>		</span>The OpenStack password</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Dangerous options:</font></div><div><font size="2"   >&nbsp;-U, --unknown-are-stopped <span>	</span>Assume any unknown instance is safely stopped</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >EOF</font></div><div><font size="2"   >&nbsp; &nbsp; exit 0;</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >function metadata()</font></div><div><font size="2"   >{</font></div><div><font size="2"   >cat &lt;&lt;EOF</font></div><div><font size="2"   >&lt;?xml version="1.0" ?&gt;</font></div><div><font size="2"   >&lt;resource-agent name="fence_openstack" shortdesc="Fencing agent for OpenStack instances" &gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;longdesc&gt;</font></div><div><font size="2"   >$description</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;/longdesc&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;parameters&gt;</font></div><div><font size="2"   ><span>	</span>&lt;parameter name="action" unique="1" required="0"&gt;</font></div><div><font size="2"   ><span>		</span>&lt;getopt mixed="-o, --action=[action]" /&gt;</font></div><div><font size="2"   ><span>		</span>&lt;content type="string" default="reboot" /&gt;</font></div><div><font size="2"   ><span>		</span>&lt;shortdesc lang="en"&gt;Fencing Action&lt;/shortdesc&gt;</font></div><div><font size="2"   ><span>	</span>&lt;/parameter&gt;</font></div><div><font size="2"   ><span>	</span>&lt;parameter name="port" unique="1" required="0"&gt;</font></div><div><font size="2"   ><span>		</span>&lt;getopt mixed="-n, --port=[port]" /&gt;</font></div><div><font size="2"   ><span>		</span>&lt;content type="string" /&gt;</font></div><div><font size="2"   ><span>		</span>&lt;shortdesc lang="en"&gt;The name/id of a instance to control/check&lt;/shortdesc&gt;</font></div><div><font size="2"   ><span>	</span>&lt;/parameter&gt;</font></div><div><font size="2"   ><span>	</span>&lt;parameter name="auth" unique="0" required="0"&gt;</font></div><div><font size="2"   ><span>		</span>&lt;getopt mixed="-a, --auth=[url]" /&gt;</font></div><div><font size="2"   ><span>		</span>&lt;content type="string" /&gt;</font></div><div><font size="2"   ><span>		</span>&lt;shortdesc lang="en"&gt;The OpenStack authentication URL (eg. http://open.stack:5000/v2.0/)&lt;/shortdesc&gt;</font></div><div><font size="2"   ><span>	</span>&lt;/parameter&gt;</font></div><div><font size="2"   ><span>	</span>&lt;parameter name="region" unique="0" required="0"&gt;</font></div><div><font size="2"   ><span>		</span>&lt;getopt mixed="-r, --region" /&gt;</font></div><div><font size="2"   ><span>		</span>&lt;content type="string" /&gt;</font></div><div><font size="2"   ><span>		</span>&lt;shortdesc lang="en"&gt;The OpenStack region for which the device should control instances (defaults to us-east-1)&lt;/shortdesc&gt;</font></div><div><font size="2"   ><span>	</span>&lt;/parameter&gt;</font></div><div><font size="2"   ><span>	</span>&lt;parameter name="tenant" unique="0" required="0"&gt;</font></div><div><font size="2"   ><span>		</span>&lt;getopt mixed="-t, --tenant" /&gt;</font></div><div><font size="2"   ><span>		</span>&lt;content type="string" /&gt;</font></div><div><font size="2"   ><span>		</span>&lt;shortdesc lang="en"&gt;The OpenStack tenant name. Might match the username.&lt;/shortdesc&gt;</font></div><div><font size="2"   ><span>	</span>&lt;/parameter&gt;</font></div><div><font size="2"   ><span>	</span>&lt;parameter name="user" unique="0" required="0"&gt;</font></div><div><font size="2"   ><span>		</span>&lt;getopt mixed="-u, --user" /&gt;</font></div><div><font size="2"   ><span>		</span>&lt;content type="string" /&gt;</font></div><div><font size="2"   ><span>		</span>&lt;shortdesc lang="en"&gt;The OpenStack username to connect as&lt;/shortdesc&gt;</font></div><div><font size="2"   ><span>	</span>&lt;/parameter&gt;</font></div><div><font size="2"   ><span>	</span>&lt;parameter name="password" unique="0" required="0"&gt;</font></div><div><font size="2"   ><span>		</span>&lt;getopt mixed="-p, --password" /&gt;</font></div><div><font size="2"   ><span>		</span>&lt;content type="string" /&gt;</font></div><div><font size="2"   ><span>		</span>&lt;shortdesc lang="en"&gt;The OpenStack password&lt;/shortdesc&gt;</font></div><div><font size="2"   ><span>	</span>&lt;/parameter&gt;</font></div><div><font size="2"   ><span>	</span>&lt;parameter name="unknown-are-stopped" unique="1" required="0"&gt;</font></div><div><font size="2"   ><span>		</span>&lt;getopt mixed="-U, --unknown-are-stopped" /&gt;</font></div><div><font size="2"   ><span>		</span>&lt;content type="string" default="false" /&gt;</font></div><div><font size="2"   ><span>		</span>&lt;shortdesc lang="en"&gt;DANGER: Assume any unknown instance is safely stopped&lt;/shortdesc&gt;</font></div><div><font size="2"   ><span>	</span>&lt;/parameter&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;/parameters&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;actions&gt;</font></div><div><font size="2"   ><span>	</span>&lt;action name="on" /&gt;</font></div><div><font size="2"   ><span>	</span>&lt;action name="off" /&gt;</font></div><div><font size="2"   ><span>	</span>&lt;action name="reboot" /&gt;</font></div><div><font size="2"   ><span>	</span>&lt;action name="status" /&gt;</font></div><div><font size="2"   ><span>	</span>&lt;action name="list" /&gt;</font></div><div><font size="2"   ><span>	</span>&lt;action name="monitor" /&gt;</font></div><div><font size="2"   ><span>	</span>&lt;action name="metadata" /&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &lt;/actions&gt;</font></div><div><font size="2"   >&lt;/resource-agent&gt;</font></div><div><font size="2"   >EOF</font></div><div><font size="2"   >&nbsp; &nbsp; exit 0;</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >function debug() {</font></div><div><font size="2"   >&nbsp; &nbsp; if [ $quiet -eq 1 ]; then</font></div><div><font size="2"   ><span>	</span>: nothing</font></div><div><font size="2"   >&nbsp; &nbsp; else</font></div><div><font size="2"   ><span>	</span>printf "$*\n"</font></div><div><font size="2"   >&nbsp; &nbsp; fi</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >function error() {</font></div><div><font size="2"   >&nbsp; &nbsp; printf "$*\n" 1&gt;&amp;2</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >function fence_done()&nbsp;</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; if [ $quiet -eq 1 ]; then</font></div><div><font size="2"   ><span>	</span>: nothing</font></div><div><font size="2"   >&nbsp; &nbsp; elif [ $1 -eq 0 ]; then</font></div><div><font size="2"   ><span>	</span>debug "Operation $action (port=$port) passed"</font></div><div><font size="2"   >&nbsp; &nbsp; else</font></div><div><font size="2"   ><span>	</span>error "Operation $action (port=$port) failed: $1"</font></div><div><font size="2"   >&nbsp; &nbsp; fi</font></div><div><font size="2"   >&nbsp; &nbsp; exit $1</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >function instance_for_port()</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; # Do any funky mapping (like partial ID matches) here</font></div><div><font size="2"   >&nbsp; &nbsp; echo $1</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >function status_for_port() {</font></div><div><font size="2"   >&nbsp; &nbsp; status=`$nova show $1 | grep status | awk '{ print $4 }'`</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; if [ -z $status ]; then</font></div><div><font size="2"   ><span>	</span>if [ $unknown_are_stopped = 1 ]; then</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;echo "STOPPED"</font></div><div><font size="2"   ><span>	</span>else</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;echo "UNKNOWN"</font></div><div><font size="2"   ><span>	</span>fi</font></div><div><font size="2"   >&nbsp; &nbsp; else</font></div><div><font size="2"   ><span>	</span>echo $status</font></div><div><font size="2"   >&nbsp; &nbsp; fi</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >TEMP=`getopt -o qVo:e:k:c:r:n:t:U -l version,help,region:,action:,port:,option:,home:,region:,cert:,tenant:,user:,password:,unknown-are-stopped \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;-n 'fence_ec2' -- "$@"`</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >if [ $? != 0 ];then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; usage</font></div><div><font size="2"   >&nbsp; &nbsp; exit 1</font></div><div><font size="2"   >fi</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Note the quotes around `$TEMP': they are essential!</font></div><div><font size="2"   >eval set -- "$TEMP"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># stdin option processing</font></div><div><font size="2"   >if [ -z $2 ]; then</font></div><div><font size="2"   >&nbsp; &nbsp; # If there are no command line args, look for options from stdin</font></div><div><font size="2"   >&nbsp; &nbsp; while read line; do</font></div><div><font size="2"   ><span>	</span>case $line in&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; option=*|action=*) action=`echo $line | sed s/.*=//`;;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; port=*) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;port=`echo $line | sed s/.*=//`;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;region=*) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os_region=`echo $line | sed s/.*=//`;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;tenant=*) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os_tenant=`echo $line | sed s/.*=//`;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;auth=*) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os_auth=`echo $line | sed s/.*=//`;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;user=*) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os_user=`echo $line | sed s/.*=//`;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;password=*) &nbsp; &nbsp; &nbsp; &nbsp;os_pass=`echo $line | sed s/.*=//`;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;quiet*) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;quiet=1;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;unknown-are-stopped*) unknown_are_stopped=1;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;--);;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;*) error "Invalid command: $line";;</font></div><div><font size="2"   ><span>	</span>esac</font></div><div><font size="2"   >&nbsp; &nbsp; done</font></div><div><font size="2"   >fi</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Command line option processing</font></div><div><font size="2"   >while true ; do</font></div><div><font size="2"   >&nbsp; &nbsp; case "$1" in</font></div><div><font size="2"   ><span>	</span>-o|--action|--option) action=$2; &nbsp; &nbsp;shift; shift;;</font></div><div><font size="2"   ><span>	</span>-n|--port) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;port=$2; &nbsp; &nbsp; &nbsp;shift; shift;;</font></div><div><font size="2"   ><span>	</span>-r|--region) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os_region=$2; shift; shift;;</font></div><div><font size="2"   ><span>	</span>-t|--tenant) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os_tenant=$2; shift; shift;;</font></div><div><font size="2"   ><span>	</span>-a|--auth) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os_auth=$2; &nbsp; shift; shift;;</font></div><div><font size="2"   ><span>	</span>-u|--user) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os_user=$2; &nbsp; shift; shift;;</font></div><div><font size="2"   ><span>	</span>-p|--password) &nbsp; &nbsp; &nbsp; &nbsp;os_pass=$2; &nbsp; shift; shift;;</font></div><div><font size="2"   ><span>	</span>-U|--unknown-are-stopped) unknown_are_stopped=1; shift;;</font></div><div><font size="2"   ><span>	</span>-q|--quiet) quiet=1; shift;;</font></div><div><font size="2"   ><span>	</span>-V|--version) echo "1.0.0"; exit 0;;</font></div><div><font size="2"   ><span>	</span>--help|-h)&nbsp;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;usage;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;exit 0;;</font></div><div><font size="2"   ><span>	</span>--) shift ; break ;;</font></div><div><font size="2"   ><span>	</span>*) error "Unknown option: $1. See --help for details."; exit 1;;</font></div><div><font size="2"   >&nbsp; &nbsp; esac</font></div><div><font size="2"   >done</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Normalize the action</font></div><div><font size="2"   >action=`echo $action | tr 'A-Z' 'a-z'`</font></div><div><font size="2"   >case $action in</font></div><div><font size="2"   >&nbsp; &nbsp; hostlist|list) action=list;;</font></div><div><font size="2"   >&nbsp; &nbsp; stat|status) &nbsp; action=status;;</font></div><div><font size="2"   >&nbsp; &nbsp; reboot|reset) &nbsp;action=reboot;;</font></div><div><font size="2"   >&nbsp; &nbsp; poweron|on) &nbsp; &nbsp;action=start;;</font></div><div><font size="2"   >&nbsp; &nbsp; poweroff|off) &nbsp;action=stop;;</font></div><div><font size="2"   >esac</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >nova="nova --os-username $os_user --os-password $os_pass --os-tenant-name $os_tenant --os-auth-url $os_auth"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >instance=""</font></div><div><font size="2"   >if [ ! -z "$port" ]; then</font></div><div><font size="2"   >&nbsp; &nbsp; instance=`instance_for_port $port`</font></div><div><font size="2"   >fi</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >case $action in&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; metadata) metadata;;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; list)</font></div><div><font size="2"   ><span>	</span># List of names we know about</font></div><div><font size="2"   ><span>	</span>$nova list | grep -v -e Status -e --- | awk '{print $4 " " $2}'</font></div><div><font size="2"   ><span>	</span>;;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; monitor)</font></div><div><font size="2"   ><span>	</span># Is the device ok?</font></div><div><font size="2"   ><span>	</span>$nova list &amp;&gt; /dev/null</font></div><div><font size="2"   ><span>	</span>if [ $? != 0 ]; then</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;# If there is a problem, we're probably interested in the output</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;$nova list 1&gt;&amp;2</font></div><div><font size="2"   ><span>	</span>fi</font></div><div><font size="2"   ><span>	</span>;;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; status)</font></div><div><font size="2"   ><span>	</span>state=`status_for_port $instance`</font></div><div><font size="2"   ><span>	</span>case $state in</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;ACTIVE) &nbsp; &nbsp;fence_done 0;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;STOPPED) &nbsp; fence_done 1;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;PAUSED) &nbsp; &nbsp;fence_done 2;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;SUSPENDED) fence_done 3;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;UNKNOWN) &nbsp; fence_done 99;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;*) error "Unexpected state: $state"; fence_done 100;;</font></div><div><font size="2"   ><span>	</span>esac</font></div><div><font size="2"   ><span>	</span>;;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; reboot)</font></div><div><font size="2"   ><span>	</span>state=`status_for_port $instance`</font></div><div><font size="2"   ><span>	</span>case $state in</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;UNKNOWN)&nbsp;</font></div><div><font size="2"   ><span>		</span>error "Cannot $action unknown instance: $port"</font></div><div><font size="2"   ><span>		</span>fence_done 1</font></div><div><font size="2"   ><span>		</span>;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;SUSPENDED)&nbsp;</font></div><div><font size="2"   ><span>		</span>$nova resume $instance</font></div><div><font size="2"   ><span>		</span>while [ $state != ACTIVE ]; do</font></div><div><font size="2"   ><span>		</span> &nbsp; &nbsp;state=`status_for_port $instance`</font></div><div><font size="2"   ><span>		</span>done</font></div><div><font size="2"   ><span>		</span>$nova $action $instance</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp; &nbsp; &nbsp;;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;PAUSED)</font></div><div><font size="2"   ><span>		</span>$nova unpause $instance</font></div><div><font size="2"   ><span>		</span>while [ $state != ACTIVE ]; do</font></div><div><font size="2"   ><span>		</span> &nbsp; &nbsp;state=`status_for_port $instance`</font></div><div><font size="2"   ><span>		</span>done</font></div><div><font size="2"   ><span>		</span>$nova $action $instance;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;ACTIVE) &nbsp;$nova $action $instance;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;STOPPED) $nova start $instance;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;*) error "Cannot $action instance $port in unexpected state: $status"; fence_done 1;;</font></div><div><font size="2"   ><span>	</span>esac</font></div><div><font size="2"   ><span>	</span>;;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; start)</font></div><div><font size="2"   ><span>	</span>state=`status_for_port $instance`</font></div><div><font size="2"   ><span>	</span>case $state in</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;UNKNOWN)&nbsp;</font></div><div><font size="2"   ><span>		</span>error "Cannot perform $action action on unknown instance: $port"</font></div><div><font size="2"   ><span>		</span>fence_done 1</font></div><div><font size="2"   ><span>		</span>;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;SUSPENDED) $nova resume $instance;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;PAUSED) &nbsp; &nbsp;$nova unpause $instance;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;ACTIVE) &nbsp; &nbsp;debug "Already active";;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;STOPPED) &nbsp; $nova $action $instance;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;*) error "Cannot $action instance $port in unexpected state: $status"; fence_done 1;;</font></div><div><font size="2"   ><span>	</span>esac</font></div><div><font size="2"   ><span>	</span>;;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; stop)</font></div><div><font size="2"   ><span>	</span>state=`status_for_port $instance`</font></div><div><font size="2"   ><span>	</span>case $state in</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;UNKNOWN)&nbsp;</font></div><div><font size="2"   ><span>		</span>error "Cannot perform $action action on unknown instance: $port"</font></div><div><font size="2"   ><span>		</span>fence_done 1</font></div><div><font size="2"   ><span>		</span>;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;STOPPED|PAUSED|SUSPENDED)&nbsp;</font></div><div><font size="2"   ><span>		</span># Stop, start, and reboot do not function on a suspended or paused instances</font></div><div><font size="2"   ><span>		</span># But for all intensive purposes they are already in a safe state</font></div><div><font size="2"   ><span>		</span>debug "$instance is $state"</font></div><div><font size="2"   ><span>		</span>;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;ACTIVE) &nbsp; &nbsp;$nova $action $instance;;</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;*) error "Cannot perform $action action on instance $port in unexpected state: $status"; fence_done 1;;</font></div><div><font size="2"   ><span>	</span>esac</font></div><div><font size="2"   ><span>	</span>;;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; *) error "Unknown action: $action"; fence_done 1;;</font></div><div><font size="2"   >esac</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >fence_done $?</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://github.com/beekhof/fence_openstack"   >https://github.com/beekhof/fence_openstack</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="RHCS fence_openstack client used in openstack - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>