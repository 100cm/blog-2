<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">zabbix template customize example for PostgreSQL pg_monz</h2>
	<h5 id="">2014-09-22 15:53:06&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201482233126269/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>zabbix PostgreSQL监控模板最终合并到如下repo :&nbsp;</div><div><a target="_blank" rel="nofollow" href="https://github.com/digoal/pg_monz"   >https://github.com/digoal/pg_monz</a></div><div><br></div><div>监控项内容参考 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201482345943567/"   >http://blog.163.com/digoal@126/blog/static/163877040201482345943567/</a></div><div>或自行添加.</div><div><br></div><div>以下主要将一下如何定制模板的xml和agentd的conf.</div><div>ITEM内容截取自</div><div><a target="_blank" rel="nofollow" href="https://raw.githubusercontent.com/pg-monz/pg_monz/master/pg_monz/pg_monz_template.xml"   >https://raw.githubusercontent.com/pg-monz/pg_monz/master/pg_monz/pg_monz_template.xml</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;item&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;name&gt;Buffers_alloc&lt;/name&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;type&gt;0&lt;/type&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;snmp_community/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;multiplier&gt;0&lt;/multiplier&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;snmp_oid/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;key&gt;psql.buffers_alloc[{$PGHOST},{$PGPORT},{$PGROLE},{$PGDATABASE}]&lt;/key&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;delay&gt;300&lt;/delay&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;history&gt;90&lt;/history&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;trends&gt;365&lt;/trends&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;status&gt;0&lt;/status&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;value_type&gt;3&lt;/value_type&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;allowed_hosts/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;units&gt;buffers/s&lt;/units&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;delta&gt;1&lt;/delta&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;snmpv3_securityname/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;snmpv3_securitylevel&gt;0&lt;/snmpv3_securitylevel&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;snmpv3_authpassphrase/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;snmpv3_privpassphrase/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;formula&gt;1&lt;/formula&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;delay_flex/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;params/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;ipmi_sensor/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;data_type&gt;0&lt;/data_type&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;authtype&gt;0&lt;/authtype&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;username/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;password/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;publickey/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;privatekey/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;port/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;description/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;inventory_link&gt;0&lt;/inventory_link&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;applications&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;application&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;name&gt;PostgreSQL&lt;/name&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/application&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/applications&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;valuemap/&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/item&gt;</font></div><p></p></pre></div><div><br></div><div>给当前模板添加Items :&nbsp;</div><div>选中模板</div><div><div><img title="zabbix template customize - 德哥@Digoal - PostgreSQL research"   alt="zabbix template customize - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/_1yPxx3XM0P5vym36RgpHQ==/6619575670165235504.png"   ></div>选择一个合适的Items, 和将要添加的items类似.<br><div><img title="zabbix template customize - 德哥@Digoal - PostgreSQL research"   alt="zabbix template customize - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/l4Jw-wOlGk-52FUneimirA==/6608632230934341251.png"   ></div>选择克隆<br><div><img title="zabbix template customize - 德哥@Digoal - PostgreSQL research"   alt="zabbix template customize - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/ngebsxxLR_Mwy2grjSYD7A==/6608789461097111077.png"   ></div><div><span style="line-height: 28px;"   >修改name, key, 以及其他需要修改的地方.&nbsp;</span></div><div><img title="zabbix template customize - 德哥@Digoal - PostgreSQL research"   alt="zabbix template customize - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/CmtdfcjJhn9cR88_g6H0SQ==/6608632230934341252.png"   ></div></div><div>值存储注意修改, AS IS. 不要用speed per second.</div><div><div><img title="zabbix template customize - 德哥@Digoal - PostgreSQL research"   alt="zabbix template customize - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/PaGuWu9Lj5Sbn_HUkQvNIQ==/6608720191864562183.png"   ></div>&nbsp;</div><div><br></div><div>同时还需要修改agentd.conf配置.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 bin]# vi /opt/zabbix/etc/zabbix_agentd.conf.d/userparameter_pgsql.conf</font></div><div><div><font size="2"   ># add by digoal</font></div><div><font size="2"   >UserParameter=psql.database_age[*],psql -h $1 -p $2 -U $3 -d $4 -t -c "select max(age(datfrozenxid)) from pg_database"</font></div></div><p></p></pre></div><div><br></div><div>重启zabbix_agentd, 查看主机是否已添加对应的Items.</div><div><div><img title="zabbix template customize - 德哥@Digoal - PostgreSQL research"   alt="zabbix template customize - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/iQW6tB7OvlyhLSznIz1ZPg==/6608608041678529804.png"   ></div><br><div><img title="zabbix template customize - 德哥@Digoal - PostgreSQL research"   alt="zabbix template customize - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/svmujM7yzmC2iiyzBMxa8g==/6619528391165238424.png"   ></div></div><div><br></div><div>还可以给当前模板添加触发器 :&nbsp;</div><div>同样克隆一个. 选择这个来克隆.</div><div><div><img title="zabbix template customize - 德哥@Digoal - PostgreSQL research"   alt="zabbix template customize - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/s6HhoXV8ujrrLiqVPJaAXg==/6619210632304812282.png"   ></div><br></div><div>修改为age 的触发器, 超过10亿则触发.</div><div><div><img title="zabbix template customize - 德哥@Digoal - PostgreSQL research"   alt="zabbix template customize - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/_WXEoAjSLJrLoaM3hZUWcg==/6619381056607117766.png"   ></div></div><div><br></div><div>[注意]</div><div>1. 建议使用postgresql server的启动用户启动zabbix_agentd, 否则可能造成get item的权限问题(例如读取在$PGDATA中的csvlog).</div><div>2. 建议使用zabbix_get测试zabbix_agentd配置是否正常.</div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201481951534154/"   >http://blog.163.com/digoal@126/blog/static/163877040201481951534154/</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="zabbix template customize - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>