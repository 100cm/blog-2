<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">ganglia Spoof with Modules or gmetric</h2>
	<h5 id="">2014-09-19 10:41:16&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014819102825333/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>spoof的作用是篡改metric包里主机IP, 主机名, metric名的信息.</div><div>例如我们要在A主机监控其他主机或应用, 同时通过A主机发送到网络上的metric接收者, 正常情况下, metric发出去会携带A主机的IP, 主机名. 那么就导致接收方会按照IP将信息写入A主机对应的RRD文件, 在gweb上显示时, 也会显示在A主机的监控项里面.</div><div>但实际上我们希望它写入其他主机对应的rrd文件.</div><div>如图1, 在不使用spoof时, 如果从a主机将b,c,d的监控数据发出去, 会写入a主机IP对应的rrd file.</div><div><div><img title="ganglia Spoof with Modules or gmetric - 德哥@Digoal - PostgreSQL research"   alt="ganglia Spoof with Modules or gmetric - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/OdKpGjwAZj-P8Ai0L2skpA==/6608235307237767557.png"   ></div><div>当使用spoof后, 我们可以纂改metric携带的IP, hostname, metric name.</div><div>因此可以从a主机发出, 并写入对应的rrd file. 如下图 :&nbsp;<span style="line-height: 28px;"   >&nbsp;</span></div><div><img title="ganglia Spoof with Modules or gmetric - 德哥@Digoal - PostgreSQL research"   alt="ganglia Spoof with Modules or gmetric - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/GqdHIqnUb_Ie_HU_BGMITg==/2127669349056191073.png"   ></div></div><div><div>在模块中使用变量<span style="line-height: 28px;"   >SPOOF_HOST and &nbsp;SPOOF_NAME后, gmond会将这个数据包按照spoof来处理.</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >Spoofing with Modules</font></div><div><font size="2"   >Spoofing is a concept that allows an instance of gmond running on one host to report</font></div><div><font size="2"   >the metrics that it gathers as if they were coming from an instance of gmond running</font></div><div><font size="2"   >on another host. In other words, gmond can fool the rest of Ganglia into thinking that</font></div><div><font size="2"   >the metrics that it is gathering are really coming from somewhere else. Spoofing was a</font></div><div><font size="2"   >concept originally designed and implemented as part of the gmetric utility. The idea of</font></div><div><font size="2"   >being able to report metrics as if they originated somewhere else was so popular in</font></div><div><font size="2"   >gmetric, that it only seemed natural to extend that idea into gmond modules as well.</font></div><div><font size="2"   >Spoofing a metric within a gmond Python module is a matter of adding extra metadata</font></div><div><font size="2"   >elements to the metric description. Each metric definition, as previously described, may</font></div><div><font size="2"   >contain extra elements, which indicate to gmond that special handling of the metric is</font></div><div><font size="2"   >required. &nbsp;These &nbsp;extra &nbsp;elements &nbsp;include &nbsp;SPOOF_HOST and &nbsp;SPOOF_NAME. &nbsp;By &nbsp;adding</font></div><div><font size="2"   >SPOOF_HOST and &nbsp;SPOOF_NAME to &nbsp;a &nbsp;metric &nbsp;definition, &nbsp;gmond &nbsp;will &nbsp;treat &nbsp;the &nbsp;metric &nbsp;as &nbsp;a</font></div><div><font size="2"   >spoofed metric rather than an actual metric.</font></div><div><font size="2"   >Because the concept of spoofing original came from the gmetric utility, the format of</font></div><div><font size="2"   >the &nbsp;SPOOF_HOSTand &nbsp;SPOOF_NAMEvalues also follow the same format as defined by gmetric.</font></div><div><font size="2"   >The SPOOF_HOSTextra element specifies the IP address and the hostname of the host for</font></div><div><font size="2"   >which the metric should be reported. The format of the SPOOF_HOSTvalue must be the</font></div><div><font size="2"   >IP address followed by the hostname separated by a colon (ip_address:host_name).</font></div><div><font size="2"   >When gmond sees this extra element, it will automatically replace the originating IP</font></div><div><font size="2"   >address &nbsp;and &nbsp;hostname &nbsp;with &nbsp;the &nbsp;values &nbsp;that &nbsp;are &nbsp;specified &nbsp;by &nbsp;this &nbsp;element. &nbsp;The</font></div><div><font size="2"   >SPOOF_NAMEextra element is used to indicate to gmond that the metric definition should</font></div><div><font size="2"   >assume the name of a different metric. In other words, if spoofing is being used to gather</font></div></div><div><div><font size="2"   >the boot time of a remote host, the SPOOF_NAMEcan be set to boot_timeto indicate that</font></div><div><font size="2"   >this metric is actually an alias of the standard boot_timemetric. This concept makes a</font></div><div><font size="2"   >little more sense when you consider that each spoofed metric must also have a unique</font></div><div><font size="2"   >name.</font></div></div><div><div><font size="2"   >Let’s take the example of the &nbsp;boot_time &nbsp;metric. If you have a metric module that gathers</font></div><div><font size="2"   >the boot time of not only the host on which it is currently running but also several other</font></div><div><font size="2"   >remote hosts, the dictionary of metric definitions that is returned by this module must</font></div><div><font size="2"   >include a metric definition for the local &nbsp;boot_timemetric as well as each remote host</font></div><div><font size="2"   >boot_time. Because gmond requires that every metric defined by a module have a unique</font></div><div><font size="2"   >metric name, there would be no way to define three different metrics all with the same</font></div><div><font size="2"   >boot_timemetric name. Therefore, in order to uniquely identify each metric by its name,</font></div><div><font size="2"   >a common practice when defining a spoofed metric is to include the hostname as part</font></div><div><font size="2"   >of the metric name (boot_time:my_host). But naming a metric in this way would cause</font></div><div><font size="2"   >each of the remote host boot time metrics to show up in the web frontend as separate</font></div><div><font size="2"   >metrics that don’t actually correspond to the boot time of the host. In order to fix this</font></div><div><font size="2"   >problem, use the SPOOF_NAMEextra element to tell gmond that the metric definition is</font></div><div><font size="2"   >actually an alias for the standard boot_timemetric.</font></div><div><font size="2"   >Just to make sure that you got all of that, let’s summarize. Specifying &nbsp;SPOOF_HOSTas part</font></div><div><font size="2"   >of the metric definition tells gmond that this metric is a spoofed metric. The format of</font></div><div><font size="2"   >its value should be the remote host IP address followed by the hostname separated by</font></div><div><font size="2"   >a colon. Specifying &nbsp;SPOOF_NAMEas part of the metric definition tells gmond that the spoof</font></div><div><font size="2"   >name is really an alias for another metric. Finally, the name of each spoofed metric must</font></div><div><font size="2"   >be unique. In addition to that, you will need to remember that when your metric callback function is called, the name parameter that is passed in will be the unique name</font></div><div><font size="2"   >of the metric and not the SPOOF_NAME. By passing in the unique name, this helps your</font></div><div><font size="2"   >callback function determine not only the metric it needs to gather but also the remote</font></div><div><font size="2"   >host that it should gather the metric from.</font></div></div><p></p></pre></div></div><div><br></div><div>使用gmetric来填写spoof信息 :&nbsp;</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; -S, --spoof=STRING &nbsp; &nbsp;IP address and name of host/device (colon separated) we&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; are spoofing &nbsp;(default=`')</font></div></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >&nbsp; -n, --name=STRING &nbsp; &nbsp; Name of the metric</font></span></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div><div><font size="2"   >[root@150 data03]# gmetric -h</font></div><div><font size="2"   >gmetric 3.6.0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The Ganglia Metric Client (gmetric) announces a metric</font></div><div><font size="2"   >on the list of defined send channels defined in a configuration file</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Usage: gmetric [OPTIONS]...</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; -h, --help &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Print help and exit</font></div><div><font size="2"   >&nbsp; -V, --version &nbsp; &nbsp; &nbsp; &nbsp; Print version and exit</font></div><div><font size="2"   >&nbsp; -c, --conf=STRING &nbsp; &nbsp; The configuration file to use for finding send channels&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(default=`/opt/ganglia-core-3.6.0/etc/gmond.conf')</font></div><div><font size="2"   >&nbsp; -n, --name=STRING &nbsp; &nbsp; Name of the metric</font></div><div><font size="2"   >&nbsp; -v, --value=STRING &nbsp; &nbsp;Value of the metric</font></div><div><font size="2"   >&nbsp; -t, --type=STRING &nbsp; &nbsp; Either&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; string|int8|uint8|int16|uint16|int32|uint32|float|double</font></div><div><font size="2"   >&nbsp; -u, --units=STRING &nbsp; &nbsp;Unit of measure for the value e.g. Kilobytes, Celcius &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (default=`')</font></div><div><font size="2"   >&nbsp; -s, --slope=STRING &nbsp; &nbsp;Either zero|positive|negative|both &nbsp;(default=`both')</font></div><div><font size="2"   >&nbsp; -x, --tmax=INT &nbsp; &nbsp; &nbsp; &nbsp;The maximum time in seconds between gmetric calls &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (default=`60')</font></div><div><font size="2"   >&nbsp; -d, --dmax=INT &nbsp; &nbsp; &nbsp; &nbsp;The lifetime in seconds of this metric &nbsp;(default=`0')</font></div><div><font size="2"   >&nbsp; -g, --group=STRING &nbsp; &nbsp;Group(s) of the metric (comma-separated)</font></div><div><font size="2"   >&nbsp; -C, --cluster=STRING &nbsp;Cluster of the metric</font></div><div><font size="2"   >&nbsp; -D, --desc=STRING &nbsp; &nbsp; Description of the metric</font></div><div><font size="2"   >&nbsp; -T, --title=STRING &nbsp; &nbsp;Title of the metric</font></div><div><font size="2"   >&nbsp; -S, --spoof=STRING &nbsp; &nbsp;IP address and name of host/device (colon separated) we&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; are spoofing &nbsp;(default=`')</font></div><div><font size="2"   >&nbsp; -H, --heartbeat &nbsp; &nbsp; &nbsp; spoof a heartbeat message (use with spoof option)</font></div></div><p></p></pre></div></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201481835916946/"   >http://blog.163.com/digoal@126/blog/static/163877040201481835916946/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201481843417188/"   >http://blog.163.com/digoal@126/blog/static/163877040201481843417188/</a></div><div><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201481843417188/"   ><br></a><span style="line-height: 28px;"   >
</span><a style="line-height: 28px;" rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="ganglia Spoof with Modules or gmetric - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div></div>
	</div>
</div>
</body>
</html>