<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL trigger on predict row and predict DML on some columns</h2>
	<h5 id="">2014-09-17 8:50:50&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020148178320844/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>回答一位朋友问的一个问题 :&nbsp;</div><div><div>写一个触发器，将当前的表中某一行的一个字段被修改了，然后将该行记录插入到另一张表里面？如何写呢.</div></div><div><br></div><div>要对触发器用法有详细的了解, 请参考 :&nbsp;</div><div><div style="line-height: 28px;"   >1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013283547959/"   >http://blog.163.com/digoal@126/blog/static/1638770402013283547959/</a></div><div style="line-height: 28px;"   >2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013211102130526/"   >http://blog.163.com/digoal@126/blog/static/1638770402013211102130526/</a></div><div style="line-height: 28px;"   >3.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014728105442434/"   >http://blog.163.com/digoal@126/blog/static/1638770402014728105442434/</a></div></div><div><br></div><div>本文首先看看触发器的语法 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE [ CONSTRAINT ] TRIGGER name { BEFORE | AFTER | INSTEAD OF } { event [ OR ... ] }</font></div><div><font size="2"   >&nbsp; &nbsp; ON table_name</font></div><div><font size="2"   >&nbsp; &nbsp; [ FROM referenced_table_name ]</font></div><div><font size="2"   >&nbsp; &nbsp; [ NOT DEFERRABLE | [ DEFERRABLE ] { INITIALLY IMMEDIATE | INITIALLY DEFERRED } ]</font></div><div><font size="2"   >&nbsp; &nbsp; [ FOR [ EACH ] { ROW | STATEMENT } ]</font></div><div><font size="2"   >&nbsp; &nbsp; [ WHEN ( condition ) ]</font></div><div><font size="2"   >&nbsp; &nbsp; EXECUTE PROCEDURE function_name ( arguments )</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >where event can be one of:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; INSERT</font></div><div><font size="2"   >&nbsp; &nbsp; UPDATE [ OF column_name [, ... ] ]</font></div><div><font size="2"   >&nbsp; &nbsp; DELETE</font></div><div><font size="2"   >&nbsp; &nbsp; TRUNCATE</font></div><p></p></pre></div><div>为了实现这位朋友的需求, 需要用到行触发器, 以及<span style="line-height: 28px;"   >WHEN ( condition )</span></div><div><span style="line-height: 28px;"   >这里实际用了前段时间写的关于模拟flashback query的一个触发器.</span></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014728105442434/"   >http://blog.163.com/digoal@126/blog/static/1638770402014728105442434/</a></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >例子 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create table tgtest(id int, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# insert into tgtest values (1,'abc',now());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=# insert into tgtest values (2,'abcdef',now());</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div>创建一个表, 用来记录跟踪tgtest表的某条记录的某个字段被更新时的记录.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE TABLE public.undo_tgtest (</font></div><div><font size="2"   >&nbsp; id serial8 primary key,</font></div><div><font size="2"   >&nbsp; xid int8,</font></div><div><font size="2"   >&nbsp; relid oid,</font></div><div><font size="2"   >&nbsp; table_schema text,</font></div><div><font size="2"   >&nbsp; table_name text,</font></div><div><font size="2"   >&nbsp; when_tg text,</font></div><div><font size="2"   >&nbsp; level text,</font></div><div><font size="2"   >&nbsp; op text,</font></div><div><font size="2"   >&nbsp; encoding name,</font></div><div><font size="2"   >&nbsp; old_rec public.tgtest,</font></div><div><font size="2"   >&nbsp; new_rec public.tgtest,</font></div><div><font size="2"   >&nbsp; crt_time timestamp without time zone DEFAULT now(),</font></div><div><font size="2"   >&nbsp; username text,</font></div><div><font size="2"   >&nbsp; client_addr inet,</font></div><div><font size="2"   >&nbsp; client_port int</font></div><div><font size="2"   >);</font></div><p></p></pre></div><div>创建一个触发器函数, 记录当tgtest表的某条记录的某个字段被更新时, 插入另一个表.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION public.undo_tgtest_trace()</font></div><div><font size="2"   >RETURNS trigger</font></div><div><font size="2"   >LANGUAGE plpgsql</font></div><div><font size="2"   >AS $BODY$</font></div><div><font size="2"   >DECLARE</font></div><div><font size="2"   >&nbsp; v_username text := session_user;</font></div><div><font size="2"   >&nbsp; v_client_addr inet := inet_client_addr();</font></div><div><font size="2"   >&nbsp; v_client_port int := inet_client_port();</font></div><div><font size="2"   >&nbsp; v_xid bigint := txid_current(); &nbsp;-- 记录这条记录被更新的事务号.</font></div><div><font size="2"   >&nbsp; v_encoding name := pg_client_encoding();</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >&nbsp; case TG_OP</font></div><div><font size="2"   >&nbsp; when 'UPDATE' then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; insert into public.undo_tgtest (xid, relid, table_schema, table_name, when_tg, level, op, encoding, old_rec, new_rec, username, client_addr, client_port)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; values (v_xid, tg_relid, tg_table_schema, tg_table_name, tg_when, tg_level, tg_op, v_encoding, OLD, NEW, v_username, v_client_addr, v_client_port);</font></div><div><font size="2"   >&nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; return null;</font></div><div><font size="2"   >&nbsp; end case;</font></div><div><font size="2"   >&nbsp; RETURN null;</font></div><div><font size="2"   >END;</font></div><div><font size="2"   >$BODY$ strict volatile;</font></div><p></p></pre></div><div><br></div><div>创建触发器, 当tgtest表的某条记录(info='abc')的某个字段(info)被更新时, 调用触发器函数undo_tgtest_trace() :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create trigger tg1 after update on tgtest for each row when (old.info&lt;&gt;new.info and old.info='abc') execute procedure&nbsp;<span style="line-height: 28px;"   >undo_tgtest_trace</span>();</font></div><div><font size="2"   >CREATE TRIGGER</font></div><p></p></pre></div><div><div>测试&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   ><span style="line-height: 21px;"   >跟踪</span></font></div><div><font size="2"   >postgres=# update tgtest set info='abcd' where id=1;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# select * from undo_tgtest;</font></div><div><font size="2"   >&nbsp;id | &nbsp; xid &nbsp; &nbsp;| relid | table_schema | table_name | when_tg | level | &nbsp; op &nbsp; | encoding | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; old_rec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_rec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| username | client_addr | client_port&nbsp;</font></div><div><font size="2"   >----+----------+-------+--------------+------------+---------+-------+--------+----------+--------------------------------------+---</font></div><div><font size="2"   >------------------------------------+----------------------------+----------+-------------+-------------</font></div><div><font size="2"   >&nbsp; 1 | 17572725 | 31051 | public &nbsp; &nbsp; &nbsp; | tgtest &nbsp; &nbsp; | AFTER &nbsp; | ROW &nbsp; | UPDATE | UTF8 &nbsp; &nbsp; | (1,abc,"2014-09-17 08:38:54.622664") | (1</font></div><div><font size="2"   >,abcd,"2014-09-17 08:38:54.622664") | 2014-09-17 08:40:25.268737 | postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select * from tgtest ;</font></div><div><font size="2"   >&nbsp;id | &nbsp;info &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+--------+----------------------------</font></div><div><font size="2"   >&nbsp; 2 | abcdef | 2014-09-17 08:38:59.28963</font></div><div><font size="2"   >&nbsp; 1 | abcd &nbsp; | 2014-09-17 08:38:54.622664</font></div><div><font size="2"   >(2 rows)</font></div></div><div><font size="2"   ><span style="line-height: 21px;"   ><br></span></font></div><div><font size="2"   ><span style="line-height: 21px;"   >不跟踪</span></font></div><div><div><font size="2"   >postgres=# update tgtest set info='abcdefgi' where id=2;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# select * from tgtest ;</font></div><div><font size="2"   >&nbsp;id | &nbsp; info &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----------+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | abcd &nbsp; &nbsp; | 2014-09-17 08:38:54.622664</font></div><div><font size="2"   >&nbsp; 2 | abcdefgi | 2014-09-17 08:38:59.28963</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select * from undo_tgtest;</font></div><div><font size="2"   >&nbsp;id | &nbsp; xid &nbsp; &nbsp;| relid | table_schema | table_name | when_tg | level | &nbsp; op &nbsp; | encoding | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; old_rec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_rec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| username | client_addr | client_port&nbsp;</font></div><div><font size="2"   >----+----------+-------+--------------+------------+---------+-------+--------+----------+--------------------------------------+---</font></div><div><font size="2"   >------------------------------------+----------------------------+----------+-------------+-------------</font></div><div><font size="2"   >&nbsp; 1 | 17572725 | 31051 | public &nbsp; &nbsp; &nbsp; | tgtest &nbsp; &nbsp; | AFTER &nbsp; | ROW &nbsp; | UPDATE | UTF8 &nbsp; &nbsp; | (1,abc,"2014-09-17 08:38:54.622664") | (1</font></div><div><font size="2"   >,abcd,"2014-09-17 08:38:54.622664") | 2014-09-17 08:40:25.268737 | postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div></div><div><br></div><div><span style="line-height: 28px;"   >注意事项 :&nbsp;</span></div><div>空值的判断, 因为空和任何值的比较都返回空, 所以条件不成立. 因此在写when时, 看你有没有这方面的需求, 如果有的话, 需要多写几个条件.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# update tgtest set info='abc' where id=1;</font></div><div><font size="2"   >UPDATE 1</font></div></div><div><div><font size="2"   >postgres=# update tgtest set info=null where id=1;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# select * from undo_tgtest;</font></div><div><font size="2"   >&nbsp;id | &nbsp; xid &nbsp; &nbsp;| relid | table_schema | table_name | when_tg | level | &nbsp; op &nbsp; | encoding | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; old_rec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_rec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| username | client_addr | client_port&nbsp;</font></div><div><font size="2"   >----+----------+-------+--------------+------------+---------+-------+--------+----------+--------------------------------------+---</font></div><div><font size="2"   >------------------------------------+----------------------------+----------+-------------+-------------</font></div><div><font size="2"   >&nbsp; 1 | 17572725 | 31051 | public &nbsp; &nbsp; &nbsp; | tgtest &nbsp; &nbsp; | AFTER &nbsp; | ROW &nbsp; | UPDATE | UTF8 &nbsp; &nbsp; | (1,abc,"2014-09-17 08:38:54.622664") | (1</font></div><div><font size="2"   >,abcd,"2014-09-17 08:38:54.622664") | 2014-09-17 08:40:25.268737 | postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>要解决这个问题, 需要重建触发器 :&nbsp;</div><div>例如 :&nbsp;</div><div><span style="line-height: 28px;"   >((old.info&lt;&gt;new.info or (old.info is null and new.info is not null) or (old.info is not null and new.info is null)) and old.id=1)</span></div><div><span style="line-height: 28px;"   >这里使用id=1来定位一条记录, 并且判断info字段是否被变更.</span></div><div><span style="line-height: 28px;"   ><br></span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# drop trigger tg1 on tgtest;</font></div><div><font size="2"   >DROP TRIGGER</font></div><div><font size="2"   >postgres=# create trigger tg1 after update on tgtest for each row when ((old.info&lt;&gt;new.info or (old.info is null and new.info is not null) or (old.info is not null and new.info is null)) and old.id=1) execute procedure undo_tgtest_trace();</font></div><div><font size="2"   >CREATE TRIGGER</font></div><p></p></pre></div><div><br></div><div>从null更新到not null, 被记录 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# update tgtest set info='ab' where id=1;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# select * from undo_tgtest;</font></div><div><font size="2"   >&nbsp;id | &nbsp; xid &nbsp; &nbsp;| relid | table_schema | table_name | when_tg | level | &nbsp; op &nbsp; | encoding | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; old_rec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_rec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| username | client_addr | client_port&nbsp;</font></div><div><font size="2"   >----+----------+-------+--------------+------------+---------+-------+--------+----------+--------------------------------------+---</font></div><div><font size="2"   >------------------------------------+----------------------------+----------+-------------+-------------</font></div><div><font size="2"   >&nbsp; 1 | 17572725 | 31051 | public &nbsp; &nbsp; &nbsp; | tgtest &nbsp; &nbsp; | AFTER &nbsp; | ROW &nbsp; | UPDATE | UTF8 &nbsp; &nbsp; | (1,abc,"2014-09-17 08:38:54.622664") | (1</font></div><div><font size="2"   >,abcd,"2014-09-17 08:38:54.622664") | 2014-09-17 08:40:25.268737 | postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 2 | 17573021 | 31051 | public &nbsp; &nbsp; &nbsp; | tgtest &nbsp; &nbsp; | AFTER &nbsp; | ROW &nbsp; | UPDATE | UTF8 &nbsp; &nbsp; | (1,,"2014-09-17 08:38:54.622664") &nbsp; &nbsp;| (1</font></div><div><font size="2"   >,ab,"2014-09-17 08:38:54.622664") &nbsp; | 2014-09-17 08:46:10.78577 &nbsp;| postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >从not null更新到null, 被记录 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# update tgtest set info=null where id=1;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# select * from undo_tgtest;</font></div><div><font size="2"   >&nbsp;id | &nbsp; xid &nbsp; &nbsp;| relid | table_schema | table_name | when_tg | level | &nbsp; op &nbsp; | encoding | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; old_rec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_rec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| username | client_addr | client_port&nbsp;</font></div><div><font size="2"   >----+----------+-------+--------------+------------+---------+-------+--------+----------+--------------------------------------+---</font></div><div><font size="2"   >------------------------------------+----------------------------+----------+-------------+-------------</font></div><div><font size="2"   >&nbsp; 1 | 17572725 | 31051 | public &nbsp; &nbsp; &nbsp; | tgtest &nbsp; &nbsp; | AFTER &nbsp; | ROW &nbsp; | UPDATE | UTF8 &nbsp; &nbsp; | (1,abc,"2014-09-17 08:38:54.622664") | (1</font></div><div><font size="2"   >,abcd,"2014-09-17 08:38:54.622664") | 2014-09-17 08:40:25.268737 | postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 2 | 17573021 | 31051 | public &nbsp; &nbsp; &nbsp; | tgtest &nbsp; &nbsp; | AFTER &nbsp; | ROW &nbsp; | UPDATE | UTF8 &nbsp; &nbsp; | (1,,"2014-09-17 08:38:54.622664") &nbsp; &nbsp;| (1</font></div><div><font size="2"   >,ab,"2014-09-17 08:38:54.622664") &nbsp; | 2014-09-17 08:46:10.78577 &nbsp;| postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 3 | 17573033 | 31051 | public &nbsp; &nbsp; &nbsp; | tgtest &nbsp; &nbsp; | AFTER &nbsp; | ROW &nbsp; | UPDATE | UTF8 &nbsp; &nbsp; | (1,ab,"2014-09-17 08:38:54.622664") &nbsp;| (1</font></div><div><font size="2"   >,,"2014-09-17 08:38:54.622664") &nbsp; &nbsp; | 2014-09-17 08:46:22.820805 | postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >从null更新到null, 不被记录 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# update tgtest set info=null where id=1;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# select * from undo_tgtest;</font></div><div><font size="2"   >&nbsp;id | &nbsp; xid &nbsp; &nbsp;| relid | table_schema | table_name | when_tg | level | &nbsp; op &nbsp; | encoding | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; old_rec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_rec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| username | client_addr | client_port&nbsp;</font></div><div><font size="2"   >----+----------+-------+--------------+------------+---------+-------+--------+----------+--------------------------------------+---</font></div><div><font size="2"   >------------------------------------+----------------------------+----------+-------------+-------------</font></div><div><font size="2"   >&nbsp; 1 | 17572725 | 31051 | public &nbsp; &nbsp; &nbsp; | tgtest &nbsp; &nbsp; | AFTER &nbsp; | ROW &nbsp; | UPDATE | UTF8 &nbsp; &nbsp; | (1,abc,"2014-09-17 08:38:54.622664") | (1</font></div><div><font size="2"   >,abcd,"2014-09-17 08:38:54.622664") | 2014-09-17 08:40:25.268737 | postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 2 | 17573021 | 31051 | public &nbsp; &nbsp; &nbsp; | tgtest &nbsp; &nbsp; | AFTER &nbsp; | ROW &nbsp; | UPDATE | UTF8 &nbsp; &nbsp; | (1,,"2014-09-17 08:38:54.622664") &nbsp; &nbsp;| (1</font></div><div><font size="2"   >,ab,"2014-09-17 08:38:54.622664") &nbsp; | 2014-09-17 08:46:10.78577 &nbsp;| postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 3 | 17573033 | 31051 | public &nbsp; &nbsp; &nbsp; | tgtest &nbsp; &nbsp; | AFTER &nbsp; | ROW &nbsp; | UPDATE | UTF8 &nbsp; &nbsp; | (1,ab,"2014-09-17 08:38:54.622664") &nbsp;| (1</font></div><div><font size="2"   >,,"2014-09-17 08:38:54.622664") &nbsp; &nbsp; | 2014-09-17 08:46:22.820805 | postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div></div><div><br></div><wbr><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013283547959/"   >http://blog.163.com/digoal@126/blog/static/1638770402013283547959/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013211102130526/"   >http://blog.163.com/digoal@126/blog/static/1638770402013211102130526/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014728105442434/"   >http://blog.163.com/digoal@126/blog/static/1638770402014728105442434/</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/sql-createtrigger.html"   >http://www.postgresql.org/docs/9.3/static/sql-createtrigger.html</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL trigger on predict row and predict DML on some columns - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>