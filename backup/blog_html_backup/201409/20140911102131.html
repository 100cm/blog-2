<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">CDPs PDPs RRAs RRDTools xff</h2>
	<h5 id="">2014-09-11 10:21:31&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201481195123510/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>RRA的配置格式如下 :&nbsp;</div><div>RRA:AVERAGE | MIN | MAX | LAST:xff:steps:rows</div><div>压缩函数支持:&nbsp;<span style="line-height: 28px;"   >AVERAGE | MIN | MAX | LAST</span></div><div><span style="line-height: 28px;"   >steps表示把多少个采样点(</span>Primary Data Point&nbsp;<span style="line-height: 28px;"   >PDP)压缩成一个压缩点(</span>consolidated data point&nbsp;<span style="line-height: 28px;"   >CDP)</span></div><div><span style="line-height: 28px;"   >rows表示保留多少个压缩点.</span></div><div><span style="line-height: 28px;"   >xff表示一次压缩区间允许有多少比例的未知的PDP, 超过比例的话对应的CDP也称为未知.</span></div><div><br></div><div>截取自man rrdcreate</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp;RRA:CF:cf arguments</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The purpose of an RRD is to store data in the round robin archives (RRA). An archive consists of a number of</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;data values or statistics for each of the defined data-sources (DS) and is defined with an RRA line.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;When data is entered into an RRD, it is first fit into time slots of the length defined with the -s option,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;thus becoming a primary data point.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The data is also processed with the consolidation function (CF) of the archive. There are several consolidation</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;functions that consolidate primary data points via an aggregate function: AVERAGE, MIN, MAX, LAST.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;AVERAGE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;the average of the data points is stored.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;MIN the smallest of the data points is stored.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;MAX the largest of the data points is stored.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;LAST</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;the last data points is used.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Note that data aggregation inevitably leads to loss of precision and information. The trick is to pick the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;aggregate function such that the interesting properties of your data is kept across the aggregation process.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The format of RRA line for these consolidation functions is:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;RRA:AVERAGE | MIN | MAX | LAST:xff:steps:rows</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;xff The xfiles factor defines what part of a consolidation interval may be made up from *UNKNOWN* data while</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;the consolidated value is still regarded as known. It is given as the ratio of allowed *UNKNOWN* PDPs to the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;number of PDPs in the interval. Thus, it ranges from 0 to 1 (exclusive).</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;steps defines how many of these primary data points are used to build a consolidated data point which then goes</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;into the archive.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;rows defines how many generations of data values are kept in an RRA. &nbsp;Obviously, this has to be greater than</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;zero.</font></div><p></p></pre></div><div>rrd-beginners的例子讲得比较清晰 :&nbsp;</div><div>截取自man&nbsp;rrd-beginners</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; rrdtool create target.rrd \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --start 1023654125 \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --step 300 \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DS:mem:GAUGE:600:0:671744 \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RRA:AVERAGE:0.5:12:24 \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RRA:AVERAGE:0.5:288:31</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The next line declares a round robin archive (RRA). The syntax for declaring an RRA is</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; RRA:CF:xff:step:rows</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;RRA is the keyword to declare RRAs. The consolidation function (CF) can be AVERAGE, MINIMUM, MAXIMUM, and LAST.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The concept of the consolidated data point (CDP) comes into the picture here. A CDP is CFed (averaged,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;maximum/minimum value or last value) from step number of PDPs. This RRA will hold rows CDPs.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Lets have a look at the example above. For the first RRA, 12 (steps) PDPs (DS variables) are AVERAGEed (CF) to</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;form one CDP. 24 (rows) of theses CDPs are archived. Each PDP occurs at 300 seconds. 12 PDPs represent 12 times</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;300 seconds which is 1 hour. It means 1 CDP (which is equal to 12 PDPs) represents data worth 1 hour. 24 such</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;CDPs represent 1 day (1 hour times 24 CDPs). This means, this RRA is an archive for one day. After 24 CDPs, CDP</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;number 25 will replace the 1st CDP. The second RRA saves 31 CDPs; each CPD represents an AVERAGE value for a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;day (288 PDPs, each covering 300 seconds = 24 hours). Therefore this RRA is an archive for one month. A single</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;database can have many RRAs. If there are multiple DSs, each individual RRA will save data for all the DSs in</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;the database. For example, if a database has 3 DSs and daily, weekly, monthly, and yearly RRAs are declared,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;then each RRA will hold data from all 3 data sources.</font></div></div><p></p></pre></div><div><br></div><div>[参考]</div>1. man rrd-beginners<wbr><div>2. man rrdcreate</div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://blog.clanzx.net/2010/07/16/rrdtool.html"   >http://blog.clanzx.net/2010/07/16/rrdtool.html</a></div><div><div>一直对 rrdtool 在 create 时 RRA 中的 xff 参数的意义不是很清楚，今天 仔细研究了一下，做个总结。下面是 man rrdcreate 里的说明：</div><div>RRA:AVERAGE | MIN | MAX | LAST:xff:steps:rows</div><div>xff The xfiles factor defines what part of a consolidation interval may be made up from *UNKNOWN* data while the consolidated value is still regarded as known. It is given as the ratio of allowed *UNKNOWN* PDPs to the number of PDPs in the interval. Thus, it ranges from 0 to 1 (exclusive).</div><div>xff 决定在给定间隔中可以有多大比例的未知 PDP，超过这个比例则该间隔内的值 为 UNKNOWN，其取值范围为前闭后开区间，即： [0, 1) 。举两个极端的例子：</div><div>xff = 0 表示不能有未知 PDP</div><div>xff = 0.9 表示可以有 90% 的 未知PDP</div><div>下面是测试的程序（备忘）。</div><div>&nbsp;1 #!/bin/sh</div><div>&nbsp;2&nbsp;</div><div>&nbsp;3 LANG=C</div><div>&nbsp;4&nbsp;</div><div>&nbsp;5 xff=0.5</div><div>&nbsp;6&nbsp;</div><div>&nbsp;7 #t=$(date +%s)</div><div>&nbsp;8 t=1480272727</div><div>&nbsp;9&nbsp;</div><div>10 echo $(date), $t</div><div>11&nbsp;</div><div>12 rrdtool create test.rrd -b $(date +%s) --step 1 DS:temp:GAUGE:1:0:100 RRA:AVERAGE:${xff}:5:10</div><div>13 for i in `seq 1 20`; do</div><div>14 &nbsp; &nbsp; rrdtool update test.rrd ${t}:${i}</div><div>15 &nbsp; &nbsp; t=$((t + 1))</div><div>16 done</div><div>17&nbsp;</div><div>18 rrdtool dump test.rrd</div></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="CDPs PDPs RRAs RRDTools xff - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>