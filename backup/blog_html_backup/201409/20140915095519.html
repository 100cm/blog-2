<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">ganglia mtu metric BUG? on CentOS 6.x x64</h2>
	<h5 id="">2014-09-15 9:55:19&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201481594910585/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><span style="line-height: 28px;"   >今天在添加mtu的metric时, 发现一个ganglia bug, MTU值获取的应该是所有UP端口的最小MTU值, 但是实际上得到的结果并非如此.</span></div><div><span style="line-height: 28px;"   >gmond.conf配置如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >gmond.conf</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >collection_group {</font></span></div><div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; collect_once = yes</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; time_threshold = 1200</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; metric {</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; name = "mtu"</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; title = "MTU"</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; }</font></div></div><p></p></pre></div><div>所有端口的MTU,&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># ifconfig -a|grep MTU</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BROADCAST MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP LOOPBACK RUNNING &nbsp;MTU:16436 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BROADCAST MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><p></p></pre></div><div>UP端口的mtu最小值是第一条1500, 但是实际ganglia画出来的是回环口的MTU 16436.</div><div><br></div><div><div><img title="ganglia mtu metric BUG? on CentOS 6.x x64 - 德哥@Digoal - PostgreSQL research"   alt="ganglia mtu metric BUG? on CentOS 6.x x64 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/o_klnd-aD2BPcr2J_kYHRA==/1689412810318131937.png"   ></div></div><div><br></div><div>获取mtu的代码如下 :&nbsp;</div><div><div style="line-height: 28px;"   >libmetrics/linux/metrics.c</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >/* --------------------------------------------------------------------------- */</font></div><div style="line-height: 28px;"   ><font size="2"   >g_val_t</font></div><div style="line-height: 28px;"   ><font size="2"   >mtu_func ( void )</font></div><div style="line-height: 28px;"   ><font size="2"   >{</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;/* We want to find the minimum MTU (Max packet size) over all UP interfaces. */</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;g_val_t val;</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;val.uint32 = get_min_mtu();</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;/* A val of 0 means there are no UP interfaces. Shouldn't happen. */</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;return val;</font></div><div style="line-height: 28px;"   ><font size="2"   >}</font></div><p></p></pre></div></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >libmetrics/</span>interface.c</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >int</font></div><div style="line-height: 28px;"   ><font size="2"   >get_min_mtu( void )</font></div><div style="line-height: 28px;"   ><font size="2"   >{</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; struct ifi_info *info, *n;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; unsigned min_mtu_set = 0;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; unsigned min_mtu = 0;</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; info = Get_ifi_info(AF_INET, 0);</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; for(n = info; n; n = n-&gt;ifi_next)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; {</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; if(!min_mtu_set)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; min_mtu = n-&gt;ifi_mtu;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; min_mtu_set = 1;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; else if( n-&gt;ifi_mtu &lt; min_mtu )</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; min_mtu = n-&gt;ifi_mtu;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; }</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; free_ifi_info(info);</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; return min_mtu;</font></div><div style="line-height: 28px;"   ><font size="2"   >}</font></div><p></p></pre></div></div></div><div>libmetrics/get_ifi_info.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >struct ifi_info *</font></div><div><font size="2"   >get_ifi_info(int family, int doaliases)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct ifi_info &nbsp; &nbsp; &nbsp; &nbsp; *ifi, *ifihead, **ifipnext;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sockfd, len, lastlen, flags, myflags;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*ptr, *buf, lastname[IFNAMSIZ], *cptr;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct ifconf &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ifc;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct ifreq &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*ifr, ifrcopy;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct sockaddr_in &nbsp; &nbsp; &nbsp;*sinptr;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct ifreq &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mtu;</font></div><div><font size="2"   >#ifdef SOLARIS</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int _c_virt = 0;</font></div><div><font size="2"   >#endif /* SOLARIS */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int _all_virt = 0;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sockfd = Socket(AF_INET, SOCK_DGRAM, 0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (sockfd == -1) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err_ret("get_ifi_info error: socket returns -1");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; lastlen = 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; len = 100 * sizeof(struct ifreq); &nbsp; &nbsp; &nbsp; /* initial buffer size guess */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; for ( ; ; ) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf = Malloc(len);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ifc.ifc_len = len;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ifc.ifc_buf = buf;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (ioctl(sockfd, SIOCGIFCONF, &amp;ifc) &lt; 0) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (errno != EINVAL || lastlen != 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err_sys("ioctl error");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (ifc.ifc_len == lastlen)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* success, len has not changed */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lastlen = ifc.ifc_len;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len += 10 * sizeof(struct ifreq); &nbsp; &nbsp; &nbsp; /* increment */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; free(buf);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ifihead = NULL;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ifipnext = &amp;ifihead;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; lastname[0] = 0;</font></div><div><font size="2"   >/* end get_ifi_info1 */</font></div></div><div><font size="2"   >.......</font></div><div><font size="2"   >略</font></div><div><div><font size="2"   >struct ifi_info *</font></div><div><font size="2"   >Get_ifi_info(int family, int doaliases)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct ifi_info *ifi;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if ( (ifi = get_ifi_info(family, doaliases)) == NULL)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; err_quit("get_ifi_info error");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return(ifi);</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014810227936/"   >http://blog.163.com/digoal@126/blog/static/1638770402014810227936/</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="ganglia mtu metric BUG? on CentOS 6.x x64 - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>