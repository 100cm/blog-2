<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">pg_class.relfilenode=0 stored in pg_filenode.map per database</h2>
	<h5 id="">2014-09-30 10:47:39&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014830103813499/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在PostgreSQL里面, 一般我们查找对象对应的filenode可以通过pg_class.relfilenode直接得到, 或者使用pg_relation_filenode函数来获取.&nbsp;</div><div>你可能会发现有些对象的pg_class.relfilenode=0, 例如pg_class, pg_database等.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select relkind,relname,relfilenode from pg_class where relfilenode=0 order by 1,2;</font></div><div><font size="2"   >&nbsp;relkind | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | relfilenode&nbsp;</font></div><div><font size="2"   >---------+-----------------------------------------+-------------</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_attribute_relid_attnam_index &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_attribute_relid_attnum_index &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_auth_members_member_role_index &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_auth_members_role_member_index &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_authid_oid_index &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_authid_rolname_index &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_class_oid_index &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_class_relname_nsp_index &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_database_datname_index &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_database_oid_index &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_db_role_setting_databaseid_rol_index | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_pltemplate_name_index &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_proc_oid_index &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_proc_proname_args_nsp_index &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_shdepend_depender_index &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_shdepend_reference_index &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_shdescription_o_c_index &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_shseclabel_object_index &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_tablespace_oid_index &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_tablespace_spcname_index &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_toast_1255_index &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_toast_2396_index &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_toast_2964_index &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_type_oid_index &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; &nbsp; | pg_type_typname_nsp_index &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;r &nbsp; &nbsp; &nbsp; | pg_attribute &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;r &nbsp; &nbsp; &nbsp; | pg_auth_members &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;r &nbsp; &nbsp; &nbsp; | pg_authid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;r &nbsp; &nbsp; &nbsp; | pg_class &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;r &nbsp; &nbsp; &nbsp; | pg_database &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;r &nbsp; &nbsp; &nbsp; | pg_db_role_setting &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;r &nbsp; &nbsp; &nbsp; | pg_pltemplate &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;r &nbsp; &nbsp; &nbsp; | pg_proc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;r &nbsp; &nbsp; &nbsp; | pg_shdepend &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;r &nbsp; &nbsp; &nbsp; | pg_shdescription &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;r &nbsp; &nbsp; &nbsp; | pg_shseclabel &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;r &nbsp; &nbsp; &nbsp; | pg_tablespace &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;r &nbsp; &nbsp; &nbsp; | pg_type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;t &nbsp; &nbsp; &nbsp; | pg_toast_1255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;t &nbsp; &nbsp; &nbsp; | pg_toast_2396 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;t &nbsp; &nbsp; &nbsp; | pg_toast_2964 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >(41 rows)</font></div><p></p></pre></div><div>这些对象的relfilenode=0是怎么回事呢?</div><div>来看一段代码注释就知道了 :&nbsp;</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* However, that obviously won't work for pg_class</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* itself, nor for the other "nailed" catalogs for which we have to be able</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* to set up working Relation entries without access to pg_class. &nbsp;It also</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* does not work for shared catalogs, since there is no practical way to</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* update other databases' pg_class entries when relocating a shared catalog.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* Therefore, for these special catalogs (henceforth referred to as "mapped</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* catalogs") we rely on a separately maintained file that shows the mapping</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* from catalog OIDs to filenode numbers. &nbsp;Each database has a map file for</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* its local mapped catalogs, and there is a separate map file for shared</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* catalogs. &nbsp;Mapped catalogs have zero in their pg_class.relfilenode entries.</font></div><p></p></pre></div></div><div style="line-height: 28px;"   >因为一些跨集群的共享对象, 以及pg_class本身无法将relfilenode存储在每个库的pg_class中(或者不方便这么做).</div><div>这些对象的relfilenode标记为0, 存储在每个库的pg_filenode.map文件中.</div><div>例如 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres@39-&gt; cd $PGDATA</font></div><div><font size="2"   >postgres@39-&gt; cd base/1</font></div><div><font size="2"   >postgres@39-&gt; ll pg_filenode.map&nbsp;</font></div><div><font size="2"   >-rw-------. 1 postgres postgres 512 Jul 28 07:35 pg_filenode.map</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@39-&gt; cd ..</font></div><div><div><font size="2"   >postgres@39-&gt; cd pg_tblspc/</font></div><div><font size="2"   >postgres@39-&gt; ll</font></div><div><font size="2"   >total 0</font></div><div><font size="2"   >lrwxrwxrwx. 1 postgres postgres 17 Jul 28 07:39 16384 -&gt; /data01/tbs_ovirt</font></div><div><font size="2"   >postgres@39-&gt; cd 16384/</font></div><div><font size="2"   >postgres@39-&gt; ll</font></div><div><font size="2"   >total 0</font></div><div><font size="2"   >drwx------. 3 postgres postgres 18 Jul 28 07:39 PG_9.3_201306121</font></div><div><font size="2"   >postgres@39-&gt; cd PG_9.3_201306121/</font></div><div><font size="2"   >postgres@39-&gt; ll</font></div><div><font size="2"   >total 36K</font></div><div><font size="2"   >drwx------. 2 postgres postgres 16K Aug &nbsp;1 17:13 16385</font></div><div><font size="2"   >postgres@39-&gt; cd 16385/</font></div><div><font size="2"   >postgres@39-&gt; ll pg_filenode.map&nbsp;</font></div><div><font size="2"   >-rw-------. 1 postgres postgres 512 Jul 28 07:39 pg_filenode.map</font></div></div><div></div><p></p></pre></div></div><div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   >通过<span style="line-height: 28px;"   >RelationMapOidToFilenode函数, 来获取pg_filenode.map的内容, 具体参见</span></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >src/backend/utils/cache/relmapper.c</span></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><br></span></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >以下是</span><span style="line-height: 28px;"   >pg_relation_filenode函数对应的代码,&nbsp;</span></div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case RELKIND_RELATION:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case RELKIND_MATVIEW:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case RELKIND_INDEX:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case RELKIND_SEQUENCE:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case RELKIND_TOASTVALUE:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* okay, these have storage */</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (relform-&gt;relfilenode)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = relform-&gt;relfilenode;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else &nbsp; &nbsp;/* Consult the relation mapper */</font></div></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = RelationMapOidToFilenode(relid,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relform-&gt;relisshared);</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div></div><p></p></pre></div></div><div><div><span style="line-height: 28px;"   >所以我们要获取任何对象的filenode, 使用</span><span style="line-height: 28px;"   >pg_relation_filenode函数即可, 不建议直接读取pg_class.relfilenode.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \df pg_relation_filenode</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of functions</font></div><div><font size="2"   >&nbsp; &nbsp;Schema &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; Name &nbsp; &nbsp; &nbsp; &nbsp; | Result data type | Argument data types | &nbsp;Type &nbsp;</font></div><div><font size="2"   >------------+----------------------+------------------+---------------------+--------</font></div><div><font size="2"   >&nbsp;pg_catalog | pg_relation_filenode | oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| regclass &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select pg_relation_filenode('pg_class');</font></div><div><font size="2"   >&nbsp;pg_relation_filenode&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 12658</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div></div><wbr><div><br></div>[参考]<wbr><div>1.&nbsp;src/backend/utils/cache/relmapper.c</div><div><div>&nbsp;<span style="line-height: 21px; font-size: small;"   >* relmapper.c</span></div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;Catalog-to-filenode mapping</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* For most tables, the physical file underlying the table is specified by</font></div><div><font size="2"   >&nbsp;* pg_class.relfilenode. &nbsp;However, that obviously won't work for pg_class</font></div><div><font size="2"   >&nbsp;* itself, nor for the other "nailed" catalogs for which we have to be able</font></div><div><font size="2"   >&nbsp;* to set up working Relation entries without access to pg_class. &nbsp;It also</font></div><div><font size="2"   >&nbsp;* does not work for shared catalogs, since there is no practical way to</font></div><div><font size="2"   >&nbsp;* update other databases' pg_class entries when relocating a shared catalog.</font></div><div><font size="2"   >&nbsp;* Therefore, for these special catalogs (henceforth referred to as "mapped</font></div><div><font size="2"   >&nbsp;* catalogs") we rely on a separately maintained file that shows the mapping</font></div><div><font size="2"   >&nbsp;* from catalog OIDs to filenode numbers. &nbsp;Each database has a map file for</font></div><div><font size="2"   >&nbsp;* its local mapped catalogs, and there is a separate map file for shared</font></div><div><font size="2"   >&nbsp;* catalogs. &nbsp;Mapped catalogs have zero in their pg_class.relfilenode entries.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Relocation of a normal table is committed (ie, the new physical file becomes</font></div><div><font size="2"   >&nbsp;* authoritative) when the pg_class row update commits. &nbsp;For mapped catalogs,</font></div><div><font size="2"   >&nbsp;* the act of updating the map file is effectively commit of the relocation.</font></div><div><font size="2"   >&nbsp;* We postpone the file update till just before commit of the transaction</font></div><div><font size="2"   >&nbsp;* doing the rewrite, but there is necessarily a window between. &nbsp;Therefore</font></div><div><font size="2"   >&nbsp;* mapped catalogs can only be relocated by operations such as VACUUM FULL</font></div><div><font size="2"   >&nbsp;* and CLUSTER, which make no transactionally-significant changes: it must be</font></div><div><font size="2"   >&nbsp;* safe for the new file to replace the old, even if the transaction itself</font></div><div><font size="2"   >&nbsp;* aborts. &nbsp;An important factor here is that the indexes and toast table of</font></div><div><font size="2"   >&nbsp;* a mapped catalog must also be mapped, so that the rewrites/relocations of</font></div><div><font size="2"   >&nbsp;* all these files commit in a single map file update rather than being tied</font></div><div><font size="2"   >&nbsp;* to transaction commit.</font></div></div><div><font size="2"   >#define RELMAPPER_FILENAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"pg_filenode.map"</font></div><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* RelationMapOidToFilenode</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* The raison d' etre ... given a relation OID, look up its filenode.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Although shared and local relation OIDs should never overlap, the caller</font></div><div><font size="2"   >&nbsp;* always knows which we need --- so pass that information to avoid useless</font></div><div><font size="2"   >&nbsp;* searching.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Returns InvalidOid if the OID is not known (which should never happen,</font></div><div><font size="2"   >&nbsp;* but the caller is in a better position to report a meaningful error).</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >Oid</font></div><div><font size="2"   >RelationMapOidToFilenode(Oid relationId, bool shared)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; const RelMapFile *map;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* If there are active updates, believe those over the main maps */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (shared)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; map = &amp;active_shared_updates;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for (i = 0; i &lt; map-&gt;num_mappings; i++)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (relationId == map-&gt;mappings[i].mapoid)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return map-&gt;mappings[i].mapfilenode;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; map = &amp;shared_map;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for (i = 0; i &lt; map-&gt;num_mappings; i++)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (relationId == map-&gt;mappings[i].mapoid)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return map-&gt;mappings[i].mapfilenode;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; map = &amp;active_local_updates;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for (i = 0; i &lt; map-&gt;num_mappings; i++)</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (relationId == map-&gt;mappings[i].mapoid)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return map-&gt;mappings[i].mapfilenode;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; map = &amp;local_map;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for (i = 0; i &lt; map-&gt;num_mappings; i++)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (relationId == map-&gt;mappings[i].mapoid)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return map-&gt;mappings[i].mapfilenode;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return InvalidOid;</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div><br></div><div>2.&nbsp;src/backend/utils/adt/dbsize.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* Get the filenode of a relation</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* This is expected to be used in queries like</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SELECT pg_relation_filenode(oid) FROM pg_class;</font></div><div><font size="2"   >&nbsp;* That leads to a couple of choices. &nbsp;We work from the pg_class row alone</font></div><div><font size="2"   >&nbsp;* rather than actually opening each relation, for efficiency. &nbsp;We don't</font></div><div><font size="2"   >&nbsp;* fail if we can't find the relation --- some rows might be visible in</font></div><div><font size="2"   >&nbsp;* the query's MVCC snapshot but already dead according to SnapshotNow.</font></div><div><font size="2"   >&nbsp;* (Note: we could avoid using the catcache, but there's little point</font></div><div><font size="2"   >&nbsp;* because the relation mapper also works "in the now".) &nbsp;We also don't</font></div><div><font size="2"   >&nbsp;* fail if the relation doesn't have storage. &nbsp;In all these cases it</font></div><div><font size="2"   >&nbsp;* seems better to quietly return NULL.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >Datum</font></div><div><font size="2"   >pg_relation_filenode(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relid = PG_GETARG_OID(0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; HeapTuple &nbsp; &nbsp; &nbsp; tuple;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Form_pg_class relform;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; tuple = SearchSysCache1(RELOID, ObjectIdGetDatum(relid));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!HeapTupleIsValid(tuple))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; relform = (Form_pg_class) GETSTRUCT(tuple);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; switch (relform-&gt;relkind)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case RELKIND_RELATION:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case RELKIND_MATVIEW:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case RELKIND_INDEX:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case RELKIND_SEQUENCE:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case RELKIND_TOASTVALUE:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* okay, these have storage */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (relform-&gt;relfilenode)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = relform-&gt;relfilenode;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else &nbsp; &nbsp;/* Consult the relation mapper */</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = RelationMapOidToFilenode(relid,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relform-&gt;relisshared);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* no storage, return NULL */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = InvalidOid;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ReleaseSysCache(tuple);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!OidIsValid(result))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_OID(result);</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div><br></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="pg_class.relfilenode=0 stored in pg_filenode.map per database - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>