<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL HA manual with shared disk use RHCS - 2</h2>
	<h5 id="">2014-09-10 20:56:24&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201481085624211/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div style="line-height: 28px;"   ><span style="color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; line-height: 28px;"   >(续)</span></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201481085344535/"   >http://blog.163.com/digoal@126/blog/static/163877040201481085344535/</a></div><div style="line-height: 28px;"   ><span style="color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; line-height: 28px;"   >应朋友要求, 写一篇RHCS利用共享存储的PostgreSQL HA部署手册 :&nbsp;</span></div><div style="line-height: 28px;"   ><span style="color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; line-height: 28px;"   >PostgreSQL windows域认证以及在vmware vSphere中的HA部署请参考 :&nbsp;</span></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014824551899/"   >http://blog.163.com/digoal@126/blog/static/1638770402014824551899/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201481805519157/"   >http://blog.163.com/digoal@126/blog/static/163877040201481805519157/</a></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >接下来需要配置逻辑卷:</div><div style="line-height: 28px;"   >如果集群文件系统基于逻辑卷的话, 那么需要配置lvm.conf, 配置锁的类型</div><div style="line-height: 28px;"   ><a target="_blank" rel="nofollow" href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Cluster_Administration/ap-ha-halvm-CA.html"   >https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Cluster_Administration/ap-ha-halvm-CA.html</a></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >修改lvm锁类型, 2台主机都需要修改.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   ># vi /etc/lvm/lvm.conf</font></div><div style="line-height: 28px;"   ><font size="2"   >locking_type = 3</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >2台主机都启动clvmd服务. (必须在cman启动后才能启动clvmd, 大多数依赖集群的服务都需要先启动cman后启动, 如果要关闭cman服务, 也需要先关闭依赖cman的服务, 例如clvmd, rgmanager)</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   ># chkconfig clvmd on</font></div><div style="line-height: 28px;"   ><font size="2"   ># service clvmd start</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >在任意节点, 创建pv</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_204 ~]# pvcreate /dev/mapper/e06_eva_vd3</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; Physical volume "/dev/mapper/e06_eva_vd3" successfully created</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_204 ~]# pvcreate /dev/mapper/e06_eva_vd4</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; Physical volume "/dev/mapper/e06_eva_vd4" successfully created</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >在任意节点创建集群卷组.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   ># vgcreate</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; [-c|--clustered {y|n}]&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   ># vgcreate -cy shared_vg /dev/mapper/e06_eva_vd3 /dev/mapper/e06_eva_vd4</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >在其他节点扫描pv和vg</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_204 ~]# pvs</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; PV &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;VG &nbsp; &nbsp; &nbsp; &nbsp;Fmt &nbsp;Attr PSize &nbsp; PFree &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; /dev/mapper/e06_eva_vd3 shared_vg lvm2 a-- &nbsp;350.00g 350.00g</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; /dev/mapper/e06_eva_vd4 shared_vg lvm2 a-- &nbsp;350.00g 350.00g</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_204 ~]# vgs</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; VG &nbsp; &nbsp; &nbsp; &nbsp;#PV #LV #SN Attr &nbsp; VSize &nbsp; VFree &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; shared_vg &nbsp; 2 &nbsp; 0 &nbsp; 0 wz--nc 699.99g 699.99g</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >在任意节点创建逻辑卷</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 ~]# lvcreate -L 100G -n lv01 shared_vg</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; Logical volume "lv01" created</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 ~]# lvs</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; LV &nbsp; VG &nbsp; &nbsp; &nbsp; &nbsp;Attr &nbsp; &nbsp; &nbsp; LSize &nbsp; Pool Origin Data% &nbsp;Move Log Cpy%Sync Convert</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; lv01 shared_vg -wi-a----- 100.00g &nbsp;&nbsp;</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >在任意节点创建集群文件系统, 如果要多个节点同时mount一个文件系统的话, 需要多个journal区域.</div><div style="line-height: 28px;"   >本例集群中只有2台主机, 所以只需要使用2个journal区域.</div><div style="line-height: 28px;"   >在格式化文件系统的时候需要设置好.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 ~]# mkfs.gfs2 -p lock_dlm -t yumpg001:lv01 -j 2 /dev/mapper/shared_vg-lv01&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >This will destroy any data on /dev/mapper/shared_vg-lv01.</font></div><div style="line-height: 28px;"   ><font size="2"   >It appears to contain: symbolic link to `../dm-2'</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >Are you sure you want to proceed? [y/n] y</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >Device: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/dev/mapper/shared_vg-lv01</font></div><div style="line-height: 28px;"   ><font size="2"   >Blocksize: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4096</font></div><div style="line-height: 28px;"   ><font size="2"   >Device Size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;100.00 GB (26214400 blocks)</font></div><div style="line-height: 28px;"   ><font size="2"   >Filesystem Size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 100.00 GB (26214398 blocks)</font></div><div style="line-height: 28px;"   ><font size="2"   >Journals: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div style="line-height: 28px;"   ><font size="2"   >Resource Groups: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 400</font></div><div style="line-height: 28px;"   ><font size="2"   >Locking Protocol: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"lock_dlm"</font></div><div style="line-height: 28px;"   ><font size="2"   >Lock Table: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"yumpg001:lv01"</font></div><div style="line-height: 28px;"   ><font size="2"   >UUID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;7c1531b1-e1e5-b746-a2ec-c1244bbb51eb</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >加载文件系统</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_204 ~]# mkdir /data01</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_204 ~]# mount.gfs2 -o lockproto=lock_dlm /dev/mapper/shared_vg-lv01 /data01</font></div><div style="line-height: 28px;"   ><font size="2"   >/dev/mapper/shared_vg-lv01 on /data01 type gfs2 (rw,relatime,lockproto=lock_dlm,hostdata=jid=0)</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 ~]# mkdir /data01</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 ~]# mount.gfs2 -o lockproto=lock_dlm /dev/mapper/shared_vg-lv01 /data01</font></div><div style="line-height: 28px;"   ><font size="2"   >/dev/mapper/shared_vg-lv01 on /data01 type gfs2 (rw,relatime,lockproto=lock_dlm,hostdata=jid=1)</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >接下来要把文件系统卸载掉</div><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_204 ~]# umount /data01</font></div><div style="line-height: 28px;"   ></div><p></p></pre><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >因为多个节点都要使用这个共享存储, 所以可以把它作为全局资源, 添加到独立的service, 并且设置为启动cman时自动启动.</span></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >当然不自动启动也没有问题. 可以和VIP的资源放一起, 跟随指定的service一起启动.</div><div style="line-height: 28px;"   >查看系统支持的资源和对应的配置选项.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 ~]# ccs -f /etc/cluster/cluster.conf --lsresourceopts</font></div><div style="line-height: 28px;"   ><font size="2"   >service - Defines a service (resource group).</font></div><div style="line-height: 28px;"   ><font size="2"   >ASEHAagent - Sybase ASE Failover Instance</font></div><div style="line-height: 28px;"   ><font size="2"   >SAPDatabase - Manages any SAP database (based on Oracle, MaxDB, or DB2)</font></div><div style="line-height: 28px;"   ><font size="2"   >SAPInstance - SAP instance resource agent</font></div><div style="line-height: 28px;"   ><font size="2"   >apache - Defines an Apache web server</font></div><div style="line-height: 28px;"   ><font size="2"   >clusterfs - Defines a cluster file system mount.</font></div><div style="line-height: 28px;"   ><font size="2"   >fs - Defines a file system mount.</font></div><div style="line-height: 28px;"   ><font size="2"   >ip - This is an IP address.</font></div><div style="line-height: 28px;"   ><font size="2"   >lvm - LVM Failover script</font></div><div style="line-height: 28px;"   ><font size="2"   >mysql - Defines a MySQL database server</font></div><div style="line-height: 28px;"   ><font size="2"   >named - Defines an instance of named server</font></div><div style="line-height: 28px;"   ><font size="2"   >netfs - Defines an NFS/CIFS file system mount.</font></div><div style="line-height: 28px;"   ><font size="2"   >nfsclient - Defines an NFS client.</font></div><div style="line-height: 28px;"   ><font size="2"   >nfsexport - This defines an NFS export.</font></div><div style="line-height: 28px;"   ><font size="2"   >nfsserver - This defines an NFS server resource.</font></div><div style="line-height: 28px;"   ><font size="2"   >openldap - Defines an Open LDAP server</font></div><div style="line-height: 28px;"   ><font size="2"   >oracledb - Oracle 10g/11g Failover Instance</font></div><div style="line-height: 28px;"   ><font size="2"   >orainstance - Oracle 10g Failover Instance</font></div><div style="line-height: 28px;"   ><font size="2"   >oralistener - Oracle 10g Listener Instance</font></div><div style="line-height: 28px;"   ><font size="2"   >postgres-8 - Defines a PostgreSQL server</font></div><div style="line-height: 28px;"   ><font size="2"   >samba - Dynamic smbd/nmbd resource agent</font></div><div style="line-height: 28px;"   ><font size="2"   >script - LSB-compliant init script as a clustered resource.</font></div><div style="line-height: 28px;"   ><font size="2"   >tomcat-6 - Defines a Tomcat server</font></div><div style="line-height: 28px;"   ><font size="2"   >vm - Defines a Virtual Machine</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 ~]# ccs -f /etc/cluster/cluster.conf --lsresourceopts lvm</font></div><div style="line-height: 28px;"   ><font size="2"   >lvm - LVM Failover script</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; Required Options:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; name: Name</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; vg_name: Volume group name</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; Optional Options:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; lv_name: Logical Volume name (optional).</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; self_fence: Fence the node if it is not able to clean up LVM tags</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; nfslock: Enable NFS lock workarounds</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __independent_subtree: Treat this and all children as an independent subtree.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __enforce_timeouts: Consider a timeout for operations as fatal.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __max_failures: Maximum number of failures before returning a failure to a status check.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __failure_expire_time: Amount of time before a failure is forgotten.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __max_restarts: Maximum number restarts for an independent subtree before giving up.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __restart_expire_time: Amount of time before a failure is forgotten for an independent subtree.</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_204 ~]# ccs -f /etc/cluster/cluster.conf --lsresourceopts fs</font></div><div style="line-height: 28px;"   ><font size="2"   >fs - Defines a file system mount.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; Required Options:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; name: File System Name</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; mountpoint: Mount Point</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; device: Device or Label</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; Optional Options:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; fstype: File system type</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; force_unmount: Force Unmount</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; quick_status: Quick/brief status checks.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; self_fence: Seppuku Unmount</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; nfslock: Enable NFS lock workarounds</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; nfsrestart: Enable NFS daemon and lockd workaround</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; fsid: NFS File system ID</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; force_fsck: Force fsck support</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; options: Mount Options</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; use_findmnt: Utilize findmnt to detect if and where filesystems are mounted</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __independent_subtree: Treat this and all children as an independent subtree.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __enforce_timeouts: Consider a timeout for operations as fatal.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __max_failures: Maximum number of failures before returning a failure to a status check.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __failure_expire_time: Amount of time before a failure is forgotten.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __max_restarts: Maximum number restarts for an independent subtree before giving up.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __restart_expire_time: Amount of time before a failure is forgotten for an independent subtree.</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >把2个节点的服务停了再开始配置/etc/cluster/cluster.conf</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   ># clusvcadmin -d yumpg001_pg</font></div><div style="line-height: 28px;"   ><font size="2"   ># service rgmanager stop</font></div><div style="line-height: 28px;"   ><font size="2"   ># service clvmd stop</font></div><div style="line-height: 28px;"   ><font size="2"   ># service cman stop</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >把LVM添加进资源, GFS2文件系统添加进资源.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 cluster]# ccs -f /etc/cluster/cluster.conf --addresource lvm name=lvm vg_name=shared_vg lv_name=lv01</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 cluster]# ccs -f /etc/cluster/cluster.conf --addresource fs name="fs" mountpoint="/data01" device="/dev/mapper/shared_vg-lv01" options="lockproto=lock_dlm"</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >把这两个资源添加到yumpg001_pg服务中.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 cluster]# ccs -f /etc/cluster/cluster.conf --addsubservice yumpg001_pg lvm ref="LVM"</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 cluster]# ccs -f /etc/cluster/cluster.conf --addsubservice yumpg001_pg fs ref="FS"</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 cluster]# vi /etc/cluster/cluster.conf&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&lt;cluster config_version="26" name="yumpg001"&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &lt;fence_daemon post_fail_delay="6" post_join_delay="30"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &lt;clusternodes&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;clusternode name="172.16.13.203" nodeid="1"&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;fence&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &lt;method name="ILO"&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;device action="reboot" name="fence_203"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &lt;/method&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;/fence&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;/clusternode&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;clusternode name="172.16.13.204" nodeid="2"&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;fence&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &lt;method name="ILO"&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;device action="reboot" name="fence_204"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &lt;/method&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;/fence&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;/clusternode&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &lt;/clusternodes&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &lt;cman expected_votes="1" two_node="1"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &lt;fencedevices&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;fencedevice agent="fence_ilo" ipaddr="172.16.12.12" login="2010" name="fence_203" passwd="2010"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;fencedevice agent="fence_ilo" ipaddr="172.16.12.13" login="2010" name="fence_204" passwd="2010"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &lt;/fencedevices&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &lt;rm&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;failoverdomains&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;failoverdomain name="yumpg001_fd" nofailback="1" ordered="1" restricted="1"&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &lt;failoverdomainnode name="172.16.13.203" priority="1"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &lt;failoverdomainnode name="172.16.13.204" priority="1"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;/failoverdomain&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;/failoverdomains&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;resources&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;ip address="172.16.13.156" monitor_link="1"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;lvm lv_name="lv01" name="LVM" vg_name="shared_vg"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;fs device="/dev/mapper/shared_vg-lv01" mountpoint="/data01" name="FS" options="lockproto=lock_dlm"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;/resources&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;service autostart="0" domain="yumpg001_fd" name="yumpg001_pg"&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;ip ref="172.16.13.156"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;lvm ref="LVM"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;fs ref="FS"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;/service&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &lt;/rm&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &lt;logging/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&lt;/cluster&gt;</font></div><p></p></pre></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >把生成的/etc/cluster/cluster.conf内容拷贝到另一台服务器.</span></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >同时启动两台主机的cman服务.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 cluster]# service cman start</font></div><div style="line-height: 28px;"   ><font size="2"   >Starting cluster:&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Checking if cluster has been disabled at boot... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Checking Network Manager... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Global setup... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Loading kernel modules... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Mounting configfs... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Starting cman... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Waiting for quorum... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Starting fenced... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Starting dlm_controld... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Tuning DLM kernel config... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Starting gfs_controld... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Unfencing self... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Joining fence domain... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_204 ~]# service cman start</font></div><div style="line-height: 28px;"   ><font size="2"   >Starting cluster:&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Checking if cluster has been disabled at boot... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Checking Network Manager... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Global setup... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Loading kernel modules... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Mounting configfs... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Starting cman... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Waiting for quorum... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Starting fenced... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Starting dlm_controld... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Tuning DLM kernel config... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Starting gfs_controld... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Unfencing self... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;Joining fence domain... [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_204 ~]# clustat</font></div><div style="line-height: 28px;"   ><font size="2"   >Cluster Status for yumpg001 @ Wed May 28 19:49:04 2014</font></div><div style="line-height: 28px;"   ><font size="2"   >Member Status: Quorate</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;Member Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ID &nbsp; Status</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;------ ---- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ---- ------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;172.16.13.203 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 Online</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;172.16.13.204 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 Online, Local</font></div><p></p></pre></div><div style="line-height: 28px;"   >启动clvmd, rgmanager服务.</div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 cluster]# service clvmd start</font></div><div style="line-height: 28px;"   ><font size="2"   >Starting clvmd:&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >Activating VG(s): &nbsp; 1 logical volume(s) in volume group "shared_vg" now active</font></div><div style="line-height: 28px;"   ><font size="2"   >[ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 cluster]# service rgmanager start</font></div><div style="line-height: 28px;"   ><font size="2"   >Starting Cluster Service Manager: [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_204 ~]# service clvmd start</font></div><div style="line-height: 28px;"   ><font size="2"   >Starting clvmd:&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >Activating VG(s): &nbsp; 1 logical volume(s) in volume group "shared_vg" now active</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; clvmd not running on node 172.16.13.203</font></div><div style="line-height: 28px;"   ><font size="2"   >[ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_204 ~]# service rgmanager start</font></div><div style="line-height: 28px;"   ><font size="2"   >Starting Cluster Service Manager: [ &nbsp;OK &nbsp;]</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >启动yumpg001_pg服务, 会自动加载文件系统.</div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 cluster]# clusvcadm -e yumpg001_pg</font></div><div style="line-height: 28px;"   ><font size="2"   >Local machine trying to enable service:yumpg001_pg...Success</font></div><div style="line-height: 28px;"   ><font size="2"   >service:yumpg001_pg is now running on 172.16.13.203</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 cluster]# df -h</font></div><div style="line-height: 28px;"   ><font size="2"   >Filesystem &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Size &nbsp;Used Avail Use% Mounted on</font></div><div style="line-height: 28px;"   ><font size="2"   >/dev/sda1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;32G &nbsp;1.7G &nbsp; 29G &nbsp; 6% /</font></div><div style="line-height: 28px;"   ><font size="2"   >tmpfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;12G &nbsp; 32M &nbsp; 12G &nbsp; 1% /dev/shm</font></div><div style="line-height: 28px;"   ><font size="2"   >/dev/sda3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;96G &nbsp;206M &nbsp; 91G &nbsp; 1% /opt</font></div><div style="line-height: 28px;"   ><font size="2"   >/dev/mapper/shared_vg-lv01 &nbsp;100G &nbsp;259M &nbsp;100G &nbsp; 1% /data01</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >关闭服务, 会自动卸载配置在服务中的文件系统.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 cluster]# clusvcadm -d yumpg001_pg</font></div><div style="line-height: 28px;"   ><font size="2"   >Local machine disabling service:yumpg001_pg...Success</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 cluster]# df -h</font></div><div style="line-height: 28px;"   ><font size="2"   >Filesystem &nbsp; &nbsp; &nbsp;Size &nbsp;Used Avail Use% Mounted on</font></div><div style="line-height: 28px;"   ><font size="2"   >/dev/sda1 &nbsp; &nbsp; &nbsp; &nbsp;32G &nbsp;1.7G &nbsp; 29G &nbsp; 6% /</font></div><div style="line-height: 28px;"   ><font size="2"   >tmpfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;12G &nbsp; 26M &nbsp; 12G &nbsp; 1% /dev/shm</font></div><div style="line-height: 28px;"   ><font size="2"   >/dev/sda3 &nbsp; &nbsp; &nbsp; &nbsp;96G &nbsp;206M &nbsp; 91G &nbsp; 1% /opt</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >接下来需要安装数据库软件, 在2台主机各自安装PostgreSQL 9.3.5软件.</div><div style="line-height: 28px;"   >软件请安装在本地目录中, 不要安装在集群文件系统中.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_204 ~]# useradd postgres</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 cluster]# useradd postgres</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 cluster]# cd /opt</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 opt]# mkdir soft_bak</font></div><div style="line-height: 28px;"   ><font size="2"   >cd soft_bak</font></div><div style="line-height: 28px;"   ><font size="2"   >wget http://ftp.postgresql.org/pub/source/v9.3.5/postgresql-9.3.5.tar.bz2</font></div><div style="line-height: 28px;"   ><font size="2"   >tar -jxvf postgresql-9.3.5.tar.bz2</font></div><div style="line-height: 28px;"   ><font size="2"   >cd postgresql-9.3.5</font></div><div style="line-height: 28px;"   ><font size="2"   >yum -y install lrzsz sysstat e4fsprogs ntp readline-devel zlib zlib-devel openssl openssl-devel pam-devel libxml2-devel libxslt-devel python-devel tcl-devel gcc make smartmontools flex bison perl perl-devel perl-ExtUtils* OpenIPMI-tools openldap*</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >./configure --prefix=/opt/pgsql9.3.5 --with-pgport=1921 --with-perl --with-tcl --with-python --with-openssl --with-pam --with-ldap --with-libxml --with-libxslt --enable-thread-safety &amp;&amp; gmake world &amp;&amp; gmake install-world</font></div><div style="line-height: 28px;"   ><font size="2"   >ln -s /opt/pgsql9.3.5 /opt/pgsql</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >安装完后, 启动集群服务, 挂载共享存储, 在任意节点初始化数据库到共享存储.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >node A,B:</font></div><div style="line-height: 28px;"   ><font size="2"   >service cman start</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >node A,B:</font></div><div style="line-height: 28px;"   ><font size="2"   >service clvmd start</font></div><div style="line-height: 28px;"   ><font size="2"   >service rgmanager start</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >node A:</font></div><div style="line-height: 28px;"   ><font size="2"   >clusvcadmin -e yumpg001_pg</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >在启动了yumpg001_pg服务的节点初始化数据库:&nbsp;</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_204 postgresql-9.3.5]# df -h</font></div><div style="line-height: 28px;"   ><font size="2"   >Filesystem &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Size &nbsp;Used Avail Use% Mounted on</font></div><div style="line-height: 28px;"   ><font size="2"   >/dev/sda1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;32G &nbsp;1.7G &nbsp; 29G &nbsp; 6% /</font></div><div style="line-height: 28px;"   ><font size="2"   >tmpfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;12G &nbsp; 32M &nbsp; 12G &nbsp; 1% /dev/shm</font></div><div style="line-height: 28px;"   ><font size="2"   >/dev/sda3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;96G &nbsp;413M &nbsp; 90G &nbsp; 1% /opt</font></div><div style="line-height: 28px;"   ><font size="2"   >/dev/mapper/shared_vg-lv01 &nbsp;100G &nbsp;259M &nbsp;100G &nbsp; 1% /data01</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_204 postgresql-9.3.5]# mkdir /data01/pgdata</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_204 postgresql-9.3.5]# chown postgres:postgres /data01/pgdata</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >配置2个节点的postgres用户的.bash_profile</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   ># vi /home/postgres/.bash_profile</font></div><div style="line-height: 28px;"   ><font size="2"   ># add by digoal</font></div><div style="line-height: 28px;"   ><font size="2"   >export PS1="$USER@`/bin/hostname -s`-&gt; "</font></div><div style="line-height: 28px;"   ><font size="2"   >export PGPORT=1921</font></div><div style="line-height: 28px;"   ><font size="2"   >export PGDATA=/data01/pgdata/pg_root</font></div><div style="line-height: 28px;"   ><font size="2"   >export LANG=en_US.utf8</font></div><div style="line-height: 28px;"   ><font size="2"   >export PGHOME=/opt/pgsql</font></div><div style="line-height: 28px;"   ><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH</font></div><div style="line-height: 28px;"   ><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div style="line-height: 28px;"   ><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div style="line-height: 28px;"   ><font size="2"   >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div style="line-height: 28px;"   ><font size="2"   >export PGUSER=postgres</font></div><div style="line-height: 28px;"   ><font size="2"   >export PGHOST=$PGDATA</font></div><div style="line-height: 28px;"   ><font size="2"   >export PGDATABASE=postgres</font></div><div style="line-height: 28px;"   ><font size="2"   >alias rm='rm -i'</font></div><div style="line-height: 28px;"   ><font size="2"   >alias ll='ls -lh'</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >在启动了yumpg001_pg服务的节点初始化数据库, 数据目录使用共享存储.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >su - postgres</font></div><div style="line-height: 28px;"   ><font size="2"   >postgres@172_16_13_204-&gt; initdb -D $PGDATA -E UTF8 --locale=C -U postgres -W</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >配置pg_hba.conf, postgresql.conf</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >postgres@172_16_13_204-&gt; cd $PGDATA</font></div><div style="line-height: 28px;"   ><font size="2"   >vi postgresql.conf</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div style="line-height: 28px;"   ><font size="2"   >max_connections = 1000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div style="line-height: 28px;"   ><font size="2"   >superuser_reserved_connections = 13 &nbsp; &nbsp; # (change requires restart)</font></div><div style="line-height: 28px;"   ><font size="2"   >unix_socket_directories = '.' &nbsp; # comma-separated list of directories</font></div><div style="line-height: 28px;"   ><font size="2"   >unix_socket_permissions = 0700 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# begin with 0 to use octal notation</font></div><div style="line-height: 28px;"   ><font size="2"   >password_encryption = on</font></div><div style="line-height: 28px;"   ><font size="2"   >tcp_keepalives_idle = 60 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPIDLE, in seconds;</font></div><div style="line-height: 28px;"   ><font size="2"   >tcp_keepalives_interval = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPINTVL, in seconds;</font></div><div style="line-height: 28px;"   ><font size="2"   >tcp_keepalives_count = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # TCP_KEEPCNT;</font></div><div style="line-height: 28px;"   ><font size="2"   >shared_buffers = 2048MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div style="line-height: 28px;"   ><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div style="line-height: 28px;"   ><font size="2"   >shared_preload_libraries = 'pg_stat_statements,auto_explain' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div style="line-height: 28px;"   ><font size="2"   >vacuum_cost_delay = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 0-100 milliseconds</font></div><div style="line-height: 28px;"   ><font size="2"   >vacuum_cost_limit = 10000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 credits</font></div><div style="line-height: 28px;"   ><font size="2"   >bgwriter_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 10-10000ms between rounds</font></div><div style="line-height: 28px;"   ><font size="2"   >wal_level = hot_standby &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, or hot_standby</font></div><div style="line-height: 28px;"   ><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level;</font></div><div style="line-height: 28px;"   ><font size="2"   >wal_buffers = 16384kB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 32kB, -1 sets based on shared_buffers</font></div><div style="line-height: 28px;"   ><font size="2"   >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div style="line-height: 28px;"   ><font size="2"   >checkpoint_segments = 128 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # in logfile segments, min 1, 16MB each</font></div><div style="line-height: 28px;"   ><font size="2"   >archive_mode = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # allows archiving to be done</font></div><div style="line-height: 28px;"   ><font size="2"   >archive_command = 'DIR=/data05/pgdata/pg_tbs/pg_arch/`date +%F`; test ! -d $DIR &amp;&amp; mkdir $DIR; test ! -f $DIR/%f &amp;&amp; cp %p $DIR/%f' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # command to use to archive a logfile segment</font></div><div style="line-height: 28px;"   ><font size="2"   >max_wal_senders = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of walsender processes</font></div><div style="line-height: 28px;"   ><font size="2"   >wal_keep_segments = 512 &nbsp; &nbsp; &nbsp; &nbsp; # in logfile segments, 16MB each; 0 disables</font></div><div style="line-height: 28px;"   ><font size="2"   >hot_standby = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# "on" allows queries during recovery</font></div><div style="line-height: 28px;"   ><font size="2"   >max_standby_archive_delay = 300s &nbsp; &nbsp; &nbsp; &nbsp;# max delay before canceling queries</font></div><div style="line-height: 28px;"   ><font size="2"   >max_standby_streaming_delay = 300s &nbsp; &nbsp; &nbsp;# max delay before canceling queries</font></div><div style="line-height: 28px;"   ><font size="2"   >wal_receiver_status_interval = 1s &nbsp; &nbsp; &nbsp; # send replies at least this often</font></div><div style="line-height: 28px;"   ><font size="2"   >hot_standby_feedback = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # send info from standby to prevent</font></div><div style="line-height: 28px;"   ><font size="2"   >effective_cache_size = 24000MB</font></div><div style="line-height: 28px;"   ><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div style="line-height: 28px;"   ><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div style="line-height: 28px;"   ><font size="2"   >log_directory = '/data05/pgdata/pg_tbs/pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div style="line-height: 28px;"   ><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,</font></div><div style="line-height: 28px;"   ><font size="2"   >log_file_mode = 0600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# creation mode for log files,</font></div><div style="line-height: 28px;"   ><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div style="line-height: 28px;"   ><font size="2"   >log_rotation_age = 1d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Automatic rotation of logfiles will</font></div><div style="line-height: 28px;"   ><font size="2"   >log_rotation_size = 10MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Automatic rotation of logfiles will</font></div><div style="line-height: 28px;"   ><font size="2"   >log_min_duration_statement = 1s # -1 is disabled, 0 logs all statements</font></div><div style="line-height: 28px;"   ><font size="2"   >log_checkpoints = on</font></div><div style="line-height: 28px;"   ><font size="2"   >log_connections = on</font></div><div style="line-height: 28px;"   ><font size="2"   >log_disconnections = on</font></div><div style="line-height: 28px;"   ><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div style="line-height: 28px;"   ><font size="2"   >log_lock_waits = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # log lock waits &gt;= deadlock_timeout</font></div><div style="line-height: 28px;"   ><font size="2"   >log_statement = 'ddl' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # none, ddl, mod, all</font></div><div style="line-height: 28px;"   ><font size="2"   >log_timezone = 'PRC'</font></div><div style="line-height: 28px;"   ><font size="2"   >track_activity_query_size = 2048 &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div style="line-height: 28px;"   ><font size="2"   >autovacuum = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Enable autovacuum subprocess? &nbsp;'on'</font></div><div style="line-height: 28px;"   ><font size="2"   >log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</font></div><div style="line-height: 28px;"   ><font size="2"   >datestyle = 'iso, mdy'</font></div><div style="line-height: 28px;"   ><font size="2"   >timezone = 'PRC'</font></div><div style="line-height: 28px;"   ><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div style="line-height: 28px;"   ><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div style="line-height: 28px;"   ><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div style="line-height: 28px;"   ><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div style="line-height: 28px;"   ><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><div style="line-height: 28px;"   ><font size="2"   >pg_stat_statements.max = 1000</font></div><div style="line-height: 28px;"   ><font size="2"   >pg_stat_statements.track = all</font></div><div style="line-height: 28px;"   ><font size="2"   >pg_stat_statements.save = on</font></div><div style="line-height: 28px;"   ><font size="2"   >auto_explain.log_min_duration = 1s</font></div><div style="line-height: 28px;"   ><font size="2"   >auto_explain.log_analyze = on</font></div><div style="line-height: 28px;"   ><font size="2"   >auto_explain.log_verbose = on</font></div><div style="line-height: 28px;"   ><font size="2"   >auto_explain.log_buffers = on</font></div><div style="line-height: 28px;"   ><font size="2"   >auto_explain.log_timing = on</font></div><div style="line-height: 28px;"   ><font size="2"   >auto_explain.log_nested_statements = on</font></div></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >vi pg_hba.conf</font></div><div style="line-height: 28px;"   ><font size="2"   >local &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trust</font></div><div style="line-height: 28px;"   ><font size="2"   >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;trust</font></div><div style="line-height: 28px;"   ><font size="2"   >host &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ::1/128 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trust</font></div><div style="line-height: 28px;"   ><font size="2"   >host all all 0.0.0.0/0 md5</font></div><div style="line-height: 28px;"   ><font size="2"   >host replication postgres 0.0.0.0/0 md5</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >在当前节点启动数据库, 并创建extension, 以及表空间.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >pg_ctl start</font></div><div style="line-height: 28px;"   ><font size="2"   >psql postgres postgres</font></div><div style="line-height: 28px;"   ><font size="2"   >create extension pg_stat_statements;</font></div><div style="line-height: 28px;"   ><font size="2"   >create tablespace tbs_def location '/data03/pgdata/pg_tbs/tbs_def';</font></div><div style="line-height: 28px;"   ><font size="2"   >create tablespace tbs_tmp1 location '/data03/pgdata/pg_tbs/tbs_tmp1';</font></div><div style="line-height: 28px;"   ><font size="2"   >create tablespace tbs1 location '/data03/pgdata/pg_tbs/tbs1';</font></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >create tablespace tbs2 location '/data04/pgdata/pg_tbs/tbs2';</font></span></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >grant all on tablespace tbs_def to public;</font></span></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >grant all on tablespace tbs_tmp1 to public;</font></span></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >关闭数据库</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >pg_ctl stop -m fast</font></div><div style="line-height: 28px;"   ></div><p></p></pre></div><div style="line-height: 28px;"   >配置自动切换数据库脚本</div><div style="line-height: 28px;"   >如果要把脚本作为资源的话, 需要的配置如下 :&nbsp;</div><div style="line-height: 28px;"   >注意脚本的调用规格必须和LSB兼容, 例如test.sh start|stop|restart|status|reload</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@db-192-168-10-146 yum.repos.d]# ccs -f /etc/cluster/cluster.conf --lsserviceopts script</font></div><div style="line-height: 28px;"   ><font size="2"   >script - LSB-compliant init script as a clustered resource.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; Required Options:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; name: Name</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; file: Path to script</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; Optional Options:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; service_name: Inherit the service name.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __independent_subtree: Treat this and all children as an independent subtree.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __enforce_timeouts: Consider a timeout for operations as fatal.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __max_failures: Maximum number of failures before returning a failure to a status check.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __failure_expire_time: Amount of time before a failure is forgotten.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __max_restarts: Maximum number restarts for an independent subtree before giving up.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __restart_expire_time: Amount of time before a failure is forgotten for an independent subtree.</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >编写启动数据库的脚本, 遵循LSB.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >vi /usr/local/bin/pgctl.sh</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >#!/bin/bash</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   ># environment.</font></div><div style="line-height: 28px;"   ><font size="2"   ># Get the aliases and functions</font></div><div style="line-height: 28px;"   ><font size="2"   >if [ -f ~/.bashrc ]; then</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; . ~/.bashrc</font></div><div style="line-height: 28px;"   ><font size="2"   >fi</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   ># User specific environment and startup programs</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >export PGHOME=/opt/pgsql</font></div><div style="line-height: 28px;"   ><font size="2"   >export PATH=$PGHOME/bin:$PATH</font></div><div style="line-height: 28px;"   ><font size="2"   >export PGDATA=/data01/pgdata/pg_root</font></div><div style="line-height: 28px;"   ><font size="2"   >export PGPORT=1921</font></div><div style="line-height: 28px;"   ><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >start() {</font></div><div style="line-height: 28px;"   ><font size="2"   >su - postgres -c "$PGHOME/bin/pg_ctl start"</font></div><div style="line-height: 28px;"   ><font size="2"   >return 0</font></div><div style="line-height: 28px;"   ><font size="2"   >}</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >stop() {</font></div><div style="line-height: 28px;"   ><font size="2"   >su - postgres -c "$PGHOME/bin/pg_ctl stop -m fast"</font></div><div style="line-height: 28px;"   ><font size="2"   >return 0&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >}</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >reload() {</font></div><div style="line-height: 28px;"   ><font size="2"   >su - postgres -c "$PGHOME/bin/pg_ctl reload"</font></div><div style="line-height: 28px;"   ><font size="2"   >return 0</font></div><div style="line-height: 28px;"   ><font size="2"   >}</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >status() {</font></div><div style="line-height: 28px;"   ><font size="2"   >su - postgres -c "$PGHOME/bin/pg_ctl status" &nbsp;# 如果需要更加详细的检测, 可以修改此处代码, 例如加入SQL的检测</font></div><div style="line-height: 28px;"   ><font size="2"   >return $?</font></div><div style="line-height: 28px;"   ><font size="2"   >}</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   ># See how we were called.</font></div><div style="line-height: 28px;"   ><font size="2"   >case "$1" in</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; start)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; start</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; exit $?</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ;;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; stop)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; stop</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; exit $?</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ;;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; restart)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; stop</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; start</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; exit $?</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ;;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; reload)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; reload</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; exit $?</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ;;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; status)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; status</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; exit $?</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ;;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; *)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; echo $"Usage: $prog {start|stop|restart|reload|status}"</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; exit 0</font></div><div style="line-height: 28px;"   ><font size="2"   >esac</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >chmod 500 /usr/local/bin/pgctl.sh</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >将脚本添加到/etc/cluster/cluster.conf</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 ~]# ccs -f /etc/cluster/cluster.conf --addresource script name=pgctl file=/usr/local/bin/pgctl.sh</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 ~]# ccs -f /etc/cluster/cluster.conf --addsubservice yumpg001_pg script ref=pgctl</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 ~]# ccs -f /etc/cluster/cluster.conf --lsservices</font></div><div style="line-height: 28px;"   ><font size="2"   >service: name=yumpg001_pg, domain=yumpg001_fd, autostart=0</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; ip: ref=172.16.13.156</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; lvm: ref=LVM</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; fs: ref=FS</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; script: ref=pgctl</font></div><div style="line-height: 28px;"   ><font size="2"   >resources:&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; ip: monitor_link=1, address=172.16.13.156</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; lvm: name=LVM, vg_name=shared_vg, lv_name=lv01</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; fs: name=FS, device=/dev/mapper/shared_vg-lv01, mountpoint=/data01, options=lockproto=lock_dlm</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; script: name=pgctl, file=/usr/local/bin/pgctl.sh</font></div><p></p></pre></div><div style="line-height: 28px;"   >注意这里的subservice的顺序, 启动数据库前必须先启动FS, 如果顺序不对, 必须调整一下, 直接编辑/etc/cluster/cluster.conf即可.&nbsp;</div><div style="line-height: 28px;"   >编辑后记得加版本号和同步, 重启集群.</div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >同步/etc/cluster/cluster.conf, 即两台主机的配置文件内容保持一致.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 ~]# cat /etc/cluster/cluster.conf&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&lt;cluster config_version="32" name="yumpg001"&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &lt;fence_daemon post_fail_delay="6" post_join_delay="30"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &lt;clusternodes&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;clusternode name="172.16.13.203" nodeid="1"&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;fence&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &lt;method name="ILO"&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;device action="reboot" name="fence_203"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &lt;/method&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;/fence&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;/clusternode&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;clusternode name="172.16.13.204" nodeid="2"&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;fence&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &lt;method name="ILO"&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;device action="reboot" name="fence_204"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &lt;/method&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;/fence&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;/clusternode&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &lt;/clusternodes&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &lt;cman expected_votes="1" two_node="1"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &lt;fencedevices&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;fencedevice agent="fence_ilo" ipaddr="172.16.12.12" login="2010" name="fence_203" passwd="2010"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;fencedevice agent="fence_ilo" ipaddr="172.16.12.13" login="2010" name="fence_204" passwd="2010"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &lt;/fencedevices&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &lt;rm&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;failoverdomains&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;failoverdomain name="yumpg001_fd" nofailback="1" ordered="1" restricted="1"&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &lt;failoverdomainnode name="172.16.13.203" priority="1"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &lt;failoverdomainnode name="172.16.13.204" priority="1"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;/failoverdomain&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;/failoverdomains&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;resources&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;ip address="172.16.13.156" monitor_link="1"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;lvm lv_name="lv01" name="LVM" vg_name="shared_vg"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;fs device="/dev/mapper/shared_vg-lv01" mountpoint="/data01" name="FS" options="lockproto=lock_dlm"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;script file="/usr/local/bin/pgctl.sh" name="pgctl"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;/resources&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;service autostart="0" domain="yumpg001_fd" name="yumpg001_pg"&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;ip ref="172.16.13.156"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;lvm ref="LVM"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;fs ref="FS"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;script ref="pgctl"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;/service&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &lt;/rm&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &lt;logging/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&lt;/cluster&gt;</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >重启集群的2个节点服务</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >node A,B :&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   ># clusvcadm -d yumpg001_pg</font></div><div style="line-height: 28px;"   ><font size="2"   ># service clvmd stop</font></div><div style="line-height: 28px;"   ><font size="2"   ># service rgmanager stop</font></div><div style="line-height: 28px;"   ><font size="2"   ># service cman stop</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >node A,B :&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   ># service cman start</font></div><div style="line-height: 28px;"   ><font size="2"   >node A,B :&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   ># service clvmd start</font></div><div style="line-height: 28px;"   ><font size="2"   ># service rgmanager start</font></div><p></p></pre></div><div style="line-height: 28px;"   >在任意节点启动集群服务.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >node A :</font></div><div style="line-height: 28px;"   ><font size="2"   ># clusvcadm -e yumpg001_pg</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 ~]# clustat</font></div><div style="line-height: 28px;"   ><font size="2"   >Cluster Status for yumpg001 @ Wed May 28 21:51:19 2014</font></div><div style="line-height: 28px;"   ><font size="2"   >Member Status: Quorate</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;Member Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ID &nbsp; Status</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;------ ---- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ---- ------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;172.16.13.203 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 Online, Local, rgmanager</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;172.16.13.204 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 Online, rgmanager</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;Service Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Owner (Last) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; State &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;------- ---- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ----- ------ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ----- &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;service:yumpg001_pg &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 172.16.13.203 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;started &nbsp; &nbsp; &nbsp;&nbsp;</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >查看服务所在节点的日志, 我们看到LSB模式的脚本status是用来检测服务状态的, 30秒检查一次.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 ~]# tail -f -n 1 /var/log/messages&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:51:11 172_16_13_203 rgmanager[13987]: Service service:yumpg001_pg started</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:51:45 172_16_13_203 rgmanager[15614]: [script] Executing /usr/local/bin/pgctl.sh status</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:52:15 172_16_13_203 rgmanager[15985]: [script] Executing /usr/local/bin/pgctl.sh status</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:52:45 172_16_13_203 rgmanager[16408]: [script] Executing /usr/local/bin/pgctl.sh status</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >关闭数据库, 因为脚本定义的status返回异常, 自动恢复.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >$ pg_ctl stop -m fast</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:45 172_16_13_203 rgmanager[20418]: [script] script:pgctl: status of /usr/local/bin/pgctl.sh failed (returned 3)</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:45 172_16_13_203 rgmanager[13987]: status on script "pgctl" returned 1 (generic error)</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:45 172_16_13_203 rgmanager[13987]: Stopping service service:yumpg001_pg</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:46 172_16_13_203 rgmanager[20459]: [script] Executing /usr/local/bin/pgctl.sh stop</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:46 172_16_13_203 rgmanager[20541]: [ip] Removing IPv4 address 172.16.13.156/24 from eth0</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:56 172_16_13_203 rgmanager[20600]: [fs] unmounting /data01</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:56 172_16_13_203 multipathd: dm-2: remove map (uevent)</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:56 172_16_13_203 multipathd: dm-2: devmap not registered, can't remove</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:56 172_16_13_203 multipathd: dm-2: remove map (uevent)</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:56 172_16_13_203 multipathd: dm-2: devmap not registered, can't remove</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:56 172_16_13_203 rgmanager[13987]: Service service:yumpg001_pg is recovering</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:56 172_16_13_203 rgmanager[13987]: Recovering failed service service:yumpg001_pg</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:57 172_16_13_203 rgmanager[20744]: [fs] mounting /dev/dm-2 on /data01</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:57 172_16_13_203 kernel: GFS2: fsid=: Trying to join cluster "lock_dlm", "yumpg001:lv01"</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:57 172_16_13_203 kernel: GFS2: fsid=yumpg001:lv01.0: Joined cluster. Now mounting FS...</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:57 172_16_13_203 kernel: GFS2: fsid=yumpg001:lv01.0: jid=0, already locked for use</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:57 172_16_13_203 kernel: GFS2: fsid=yumpg001:lv01.0: jid=0: Looking at journal...</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:57 172_16_13_203 kernel: GFS2: fsid=yumpg001:lv01.0: jid=0: Done</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:57 172_16_13_203 kernel: GFS2: fsid=yumpg001:lv01.0: jid=1: Trying to acquire journal lock...</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:57 172_16_13_203 kernel: GFS2: fsid=yumpg001:lv01.0: jid=1: Looking at journal...</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:57 172_16_13_203 kernel: GFS2: fsid=yumpg001:lv01.0: jid=1: Done</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 21:59:57 172_16_13_203 rgmanager[20853]: [ip] Adding IPv4 address 172.16.13.156/24 to eth0</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:00:01 172_16_13_203 rgmanager[20936]: [script] Executing /usr/local/bin/pgctl.sh start</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:00:01 172_16_13_203 rgmanager[13987]: Service service:yumpg001_pg started</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >断开IP, 自动切换到另一台主机</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@172_16_13_203 ~]# ifdown eth0</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:03:32 172_16_13_204 corosync[31497]: &nbsp; [TOTEM ] A processor failed, forming new configuration.</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:03:34 172_16_13_204 corosync[31497]: &nbsp; [QUORUM] Members[1]: 2</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:03:34 172_16_13_204 corosync[31497]: &nbsp; [TOTEM ] A processor joined or left the membership and a new membership was formed.</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:03:34 172_16_13_204 corosync[31497]: &nbsp; [CPG &nbsp; ] chosen downlist: sender r(0) ip(172.16.13.204) ; members(old:2 left:1)</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:03:34 172_16_13_204 corosync[31497]: &nbsp; [MAIN &nbsp;] Completed service synchronization, ready to provide service.</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:03:34 172_16_13_204 rgmanager[31785]: State change: 172.16.13.203 DOWN</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:03:35 172_16_13_204 kernel: dlm: closing connection to node 1</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:03:40 172_16_13_204 fenced[31552]: fencing node 172.16.13.203</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:03:53 172_16_13_204 fenced[31552]: fence 172.16.13.203 success</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:03:54 172_16_13_204 rgmanager[31785]: Taking over service service:yumpg001_pg from down member 172.16.13.203</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:03:57 172_16_13_204 rgmanager[973]: [fs] mounting /dev/dm-2 on /data01</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:03:58 172_16_13_204 kernel: GFS2: fsid=: Trying to join cluster "lock_dlm", "yumpg001:lv01"</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:03:58 172_16_13_204 kernel: GFS2: fsid=yumpg001:lv01.0: Joined cluster. Now mounting FS...</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:03:58 172_16_13_204 kernel: GFS2: fsid=yumpg001:lv01.0: jid=0, already locked for use</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:03:58 172_16_13_204 kernel: GFS2: fsid=yumpg001:lv01.0: jid=0: Looking at journal...</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:03:58 172_16_13_204 kernel: GFS2: fsid=yumpg001:lv01.0: jid=0: Done</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:03:58 172_16_13_204 kernel: GFS2: fsid=yumpg001:lv01.0: jid=1: Trying to acquire journal lock...</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:03:58 172_16_13_204 kernel: GFS2: fsid=yumpg001:lv01.0: jid=1: Looking at journal...</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:03:58 172_16_13_204 kernel: GFS2: fsid=yumpg001:lv01.0: jid=1: Done</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:03:58 172_16_13_204 rgmanager[1082]: [ip] Adding IPv4 address 172.16.13.156/24 to eth0</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:04:01 172_16_13_204 rgmanager[1176]: [script] Executing /usr/local/bin/pgctl.sh start</font></div><div style="line-height: 28px;"   ><font size="2"   >May 28 22:04:01 172_16_13_204 rgmanager[31785]: Service service:yumpg001_pg started</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >[建议]</div><div style="line-height: 28px;"   >1. 不建议将lvm , gfs的加载放到HA服务中来启动.</div><div style="line-height: 28px;"   >&nbsp; &nbsp;建议lvm和gfs放在启动cman和clvmd后, 手工挂载.&nbsp;</div><div style="line-height: 28px;"   >&nbsp; &nbsp;所以rhcs管理的服务中只需要包含VIP和pg启动脚本即可.</div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >2. 修改资源的检测间隔.</div><div style="line-height: 28px;"   >参考</div><div style="line-height: 28px;"   ><a target="_blank" rel="nofollow" href="https://fedorahosted.org/cluster/wiki/ResourceActions"   >https://fedorahosted.org/cluster/wiki/ResourceActions</a></div><div style="line-height: 28px;"   >或/etc/cluster/cluster.conf</div><div style="line-height: 28px;"   >例如把pgctl.sh的资源检测时间改成10秒一次.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   ># vi /etc/cluster/cluster.conf&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&lt;cluster config_version="36" name="yumpg001"&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >...</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;resources&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;ip address="192.168.173.156" monitor_link="1"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;lvm lv_name="lv01" name="LVM" vg_name="shared_vg"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;fs device="/dev/mapper/shared_vg-lv01" mountpoint="/data01" name="FS" options="lockproto=lock_dlm"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;script file="/usr/local/bin/pgctl.sh" name="pgctl"&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &lt;action name="status" interval="10"/&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;/script&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &lt;/resources&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >...</font></div><p></p></pre></div><div style="line-height: 28px;"   >同步cluster.conf, 重启集群后, 生效.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@192_168_173_204 ~]# tail -f -n 1 /var/log/messages&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >May 29 09:00:39 192_168_173_204 rgmanager[32323]: Service service:yumpg001_pg started</font></div><div style="line-height: 28px;"   ><font size="2"   >May 29 09:00:55 192_168_173_204 rgmanager[1317]: [script] Executing /usr/local/bin/pgctl.sh status</font></div><div style="line-height: 28px;"   ><font size="2"   >May 29 09:01:06 192_168_173_204 rgmanager[1550]: [script] Executing /usr/local/bin/pgctl.sh status</font></div><div style="line-height: 28px;"   ><font size="2"   >May 29 09:01:25 192_168_173_204 rgmanager[1755]: [script] Executing /usr/local/bin/pgctl.sh status</font></div><div style="line-height: 28px;"   ><font size="2"   >May 29 09:01:35 192_168_173_204 rgmanager[1875]: [script] Executing /usr/local/bin/pgctl.sh status</font></div><div style="line-height: 28px;"   ><font size="2"   >May 29 09:01:46 192_168_173_204 rgmanager[2136]: [script] Executing /usr/local/bin/pgctl.sh status</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >[参考]</div><div style="line-height: 28px;"   >1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014428985260/"   >http://blog.163.com/digoal@126/blog/static/1638770402014428985260/</a></div><div style="line-height: 28px;"   >2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://access.redhat.com/site/articles/40051"   >https://access.redhat.com/site/articles/40051</a></div><div style="line-height: 28px;"   >3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://fedorahosted.org/cluster/wiki/ResourceActions"   >https://fedorahosted.org/cluster/wiki/ResourceActions</a></div><div style="line-height: 28px;"   >4.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://access.redhat.com/site/documentation/en-US/"   >https://access.redhat.com/site/documentation/en-US/</a></div><div style="line-height: 28px;"   >5.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Cluster_Administration/index.html"   >https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Cluster_Administration/index.html</a></div><div style="line-height: 28px;"   >6.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Cluster_Administration/ap-ha-halvm-CA.html"   >https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Cluster_Administration/ap-ha-halvm-CA.html</a></div><div style="line-height: 28px;"   >7. man ccs</div><div style="line-height: 28px;"   >8. man ipmitool</div><div style="line-height: 28px;"   >9. man cluster.conf</div><div style="line-height: 28px;"   >10. man mkfs.gfs2</div><div style="line-height: 28px;"   >11. man mount.gfs2</div><div style="line-height: 28px;"   >12. 查看操作系统支持的fence设备和对应的配置项.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@db-192-168-10-146 yum.repos.d]# ccs -f /etc/cluster/cluster.conf --lsfenceopts</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_apc - Fence agent for APC over telnet/ssh</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_apc_snmp - Fence agent for APC over SNMP</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_bladecenter - Fence agent for IBM BladeCenter</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_bladecenter_snmp - Fence agent for IBM BladeCenter over SNMP</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_brocade - Fence agent for Brocade over telnet</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_cisco_mds - Fence agent for Cisco MDS</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_cisco_ucs - Fence agent for Cisco UCS</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_drac - fencing agent for Dell Remote Access Card</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_drac5 - Fence agent for Dell DRAC CMC/5</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_eaton_snmp - Fence agent for Eaton over SNMP</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_egenera - I/O Fencing agent for the Egenera BladeFrame</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_eps - Fence agent for ePowerSwitch</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_hpblade - Fence agent for HP BladeSystem</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_ibmblade - Fence agent for IBM BladeCenter over SNMP</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_idrac - Fence agent for IPMI over LAN</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_ifmib - Fence agent for IF MIB</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_ilo - Fence agent for HP iLO</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_ilo2 - Fence agent for HP iLO</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_ilo3 - Fence agent for IPMI over LAN</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_ilo4 - Fence agent for IPMI over LAN</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_ilo_mp - Fence agent for HP iLO MP</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_imm - Fence agent for IPMI over LAN</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_intelmodular - Fence agent for Intel Modular</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_ipdu - Fence agent for iPDU over SNMP</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_ipmilan - Fence agent for IPMI over LAN</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_kdump - Fence agent for use with kdump</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_pcmk - Helper that presents a RHCS-style interface to stonith-ng for CMAN based clusters</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_rhevm - Fence agent for RHEV-M REST API</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_rsa - Fence agent for IBM RSA</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_rsb - I/O Fencing agent for Fujitsu-Siemens RSB</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_sanbox2 - Fence agent for QLogic SANBox2 FC switches</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_sanlock - Fence agent for watchdog and shared storage</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_scsi - fence agent for SCSI-3 persistent reservations</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_virsh - Fence agent for virsh</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_virt - Fence agent for virtual machines</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_vmware - Fence agent for VMWare</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_vmware_soap - Fence agent for VMWare over SOAP API</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_wti - Fence agent for WTI</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_xvm - Fence agent for virtual machines</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >[root@db-192-168-10-146 yum.repos.d]# ccs -f /etc/cluster/cluster.conf --lsfenceopts fence_ipmilan</font></div><div style="line-height: 28px;"   ><font size="2"   >fence_ipmilan - Fence agent for IPMI over LAN</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; Required Options:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; Optional Options:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; option: No description available</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; auth: IPMI Lan Auth type (md5, password, or none)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; ipaddr: IPMI Lan IP to talk to</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; passwd: Password (if required) to control power on IPMI device</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; passwd_script: Script to retrieve password (if required)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; lanplus: Use Lanplus to improve security of connection</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; login: Username/Login (if required) to control power on IPMI device</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; action: Operation to perform. Valid operations: on, off, reboot, status, list, diag, monitor or metadata</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; timeout: Timeout (sec) for IPMI operation</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; cipher: Ciphersuite to use (same as ipmitool -C parameter)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; method: Method to fence (onoff or cycle)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; power_wait: Wait X seconds after on/off operation</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; delay: Wait X seconds before fencing is started</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; privlvl: Privilege level on IPMI device</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; verbose: Verbose mode</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >13. failover域属性</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >A failover domain is &nbsp;a named subset of cluster nodes &nbsp;that are eligible to run a cluster service in the</font></div><div style="line-height: 28px;"   ><font size="2"   >event of a node failure. &nbsp;A failover domain can have the following characteristics :</font></div><div style="line-height: 28px;"   ><font size="2"   >Unrestricted ― Allows &nbsp;you to specify that a subset of members &nbsp;are preferred, &nbsp;but that a cluster</font></div><div style="line-height: 28px;"   ><font size="2"   >service as signed to this &nbsp;domain can run on any available member.</font></div><div style="line-height: 28px;"   ><font size="2"   >Restricted ― Allows &nbsp;you to restrict the members &nbsp;that can run a particular cluster service. &nbsp;If none of</font></div><div style="line-height: 28px;"   ><font size="2"   >the members &nbsp;in a restricted failover domain are available, &nbsp;the cluster service cannot be started</font></div><div style="line-height: 28px;"   ><font size="2"   >(either manually or by the cluster software).</font></div><div style="line-height: 28px;"   ><font size="2"   >Unordered ― When a clus ter s ervice is &nbsp;as signed to an unordered failover domain, &nbsp;the member on</font></div><div style="line-height: 28px;"   ><font size="2"   >which the cluster service runs &nbsp;is &nbsp;chosen from the available failover domain members &nbsp;with no priority</font></div><div style="line-height: 28px;"   ><font size="2"   >ordering.</font></div><div style="line-height: 28px;"   ><font size="2"   >Ordered ― Allows &nbsp;you to specify a preference order among the members &nbsp;of a failover domain. &nbsp;The</font></div><div style="line-height: 28px;"   ><font size="2"   >member at the top of the list is &nbsp;the most preferred, &nbsp;followed by the second member in the list, &nbsp;and so</font></div><div style="line-height: 28px;"   ><font size="2"   >on.</font></div><div style="line-height: 28px;"   ><font size="2"   >Failback ― Allows &nbsp;you to specify whether a s ervice in the failover domain should fail back to the node</font></div><div style="line-height: 28px;"   ><font size="2"   >that it was &nbsp;originally running on before that node failed. &nbsp;Configuring this &nbsp;characteristic is &nbsp;useful in</font></div><div style="line-height: 28px;"   ><font size="2"   >circumstances &nbsp;where a node repeatedly fails &nbsp;and is &nbsp;part of an ordered failover domain. &nbsp;In that</font></div><div style="line-height: 28px;"   ><font size="2"   >circumstance, &nbsp;if a node is &nbsp;the preferred node in a failover domain, &nbsp;it is &nbsp;possible for a service to fail</font></div><div style="line-height: 28px;"   ><font size="2"   >over and fail back repeatedly between the preferred node and another node, &nbsp;causing severe impact</font></div><div style="line-height: 28px;"   ><font size="2"   >on performance.</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >14. 操作系统支持的资源, 以及资源对应的配置选项.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@db-192-168-10-146 yum.repos.d]# ccs -f /etc/cluster/cluster.conf --lsserviceopts</font></div><div style="line-height: 28px;"   ><font size="2"   >service - Defines a service (resource group).</font></div><div style="line-height: 28px;"   ><font size="2"   >ASEHAagent - Sybase ASE Failover Instance</font></div><div style="line-height: 28px;"   ><font size="2"   >SAPDatabase - Manages any SAP database (based on Oracle, MaxDB, or DB2)</font></div><div style="line-height: 28px;"   ><font size="2"   >SAPInstance - SAP instance resource agent</font></div><div style="line-height: 28px;"   ><font size="2"   >apache - Defines an Apache web server</font></div><div style="line-height: 28px;"   ><font size="2"   >clusterfs - Defines a cluster file system mount.</font></div><div style="line-height: 28px;"   ><font size="2"   >fs - Defines a file system mount.</font></div><div style="line-height: 28px;"   ><font size="2"   >ip - This is an IP address.</font></div><div style="line-height: 28px;"   ><font size="2"   >lvm - LVM Failover script</font></div><div style="line-height: 28px;"   ><font size="2"   >mysql - Defines a MySQL database server</font></div><div style="line-height: 28px;"   ><font size="2"   >named - Defines an instance of named server</font></div><div style="line-height: 28px;"   ><font size="2"   >netfs - Defines an NFS/CIFS file system mount.</font></div><div style="line-height: 28px;"   ><font size="2"   >nfsclient - Defines an NFS client.</font></div><div style="line-height: 28px;"   ><font size="2"   >nfsexport - This defines an NFS export.</font></div><div style="line-height: 28px;"   ><font size="2"   >nfsserver - This defines an NFS server resource.</font></div><div style="line-height: 28px;"   ><font size="2"   >openldap - Defines an Open LDAP server</font></div><div style="line-height: 28px;"   ><font size="2"   >oracledb - Oracle 10g/11g Failover Instance</font></div><div style="line-height: 28px;"   ><font size="2"   >orainstance - Oracle 10g Failover Instance</font></div><div style="line-height: 28px;"   ><font size="2"   >oralistener - Oracle 10g Listener Instance</font></div><div style="line-height: 28px;"   ><font size="2"   >postgres-8 - Defines a PostgreSQL server</font></div><div style="line-height: 28px;"   ><font size="2"   >samba - Dynamic smbd/nmbd resource agent</font></div><div style="line-height: 28px;"   ><font size="2"   >script - LSB-compliant init script as a clustered resource.</font></div><div style="line-height: 28px;"   ><font size="2"   >tomcat-6 - Defines a Tomcat server</font></div><div style="line-height: 28px;"   ><font size="2"   >vm - Defines a Virtual Machine</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@db-192-168-10-146 yum.repos.d]# ccs -f /etc/cluster/cluster.conf --lsserviceopts ip</font></div><div style="line-height: 28px;"   ><font size="2"   >ip - This is an IP address.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; Required Options:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; address: IP Address</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; Optional Options:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; family: Family</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; monitor_link: Monitor NIC Link</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; nfslock: Enable NFS lock workarounds</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; sleeptime: Amount of time (seconds) to sleep.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; disable_rdisc: Disable updating of routing using RDISC protocol</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; prefer_interface: Network interface</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __independent_subtree: Treat this and all children as an independent subtree.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __enforce_timeouts: Consider a timeout for operations as fatal.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __max_failures: Maximum number of failures before returning a failure to a status check.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __failure_expire_time: Amount of time before a failure is forgotten.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __max_restarts: Maximum number restarts for an independent subtree before giving up.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __restart_expire_time: Amount of time before a failure is forgotten for an independent subtree.</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >[root@db-192-168-10-146 yum.repos.d]# ccs -f /etc/cluster/cluster.conf --lsserviceopts fs</font></div><div style="line-height: 28px;"   ><font size="2"   >fs - Defines a file system mount.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; Required Options:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; name: File System Name</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; mountpoint: Mount Point</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; device: Device or Label</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; Optional Options:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; fstype: File system type</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; force_unmount: Force Unmount</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; quick_status: Quick/brief status checks.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; self_fence: Seppuku Unmount</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; nfslock: Enable NFS lock workarounds</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; nfsrestart: Enable NFS daemon and lockd workaround</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; fsid: NFS File system ID</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; force_fsck: Force fsck support</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; options: Mount Options</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; use_findmnt: Utilize findmnt to detect if and where filesystems are mounted</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __independent_subtree: Treat this and all children as an independent subtree.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __enforce_timeouts: Consider a timeout for operations as fatal.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __max_failures: Maximum number of failures before returning a failure to a status check.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __failure_expire_time: Amount of time before a failure is forgotten.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __max_restarts: Maximum number restarts for an independent subtree before giving up.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __restart_expire_time: Amount of time before a failure is forgotten for an independent subtree.</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >[root@db-192-168-10-146 yum.repos.d]# ccs -f /etc/cluster/cluster.conf --lsserviceopts lvm</font></div><div style="line-height: 28px;"   ><font size="2"   >lvm - LVM Failover script</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; Required Options:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; name: Name</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; vg_name: Volume group name</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; Optional Options:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; lv_name: Logical Volume name (optional).</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; self_fence: Fence the node if it is not able to clean up LVM tags</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; nfslock: Enable NFS lock workarounds</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __independent_subtree: Treat this and all children as an independent subtree.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __enforce_timeouts: Consider a timeout for operations as fatal.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __max_failures: Maximum number of failures before returning a failure to a status check.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __failure_expire_time: Amount of time before a failure is forgotten.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __max_restarts: Maximum number restarts for an independent subtree before giving up.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; __restart_expire_time: Amount of time before a failure is forgotten for an independent subtree.</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >15. 服务的属性</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >When you add a service to the clus ter configuration, &nbsp;you configure the following attributes :</font></div><div style="line-height: 28px;"   ><font size="2"   >autostart ― Specifies &nbsp;whether to autos tart the s ervice when the clus ter starts . &nbsp;Use " 1" &nbsp;to</font></div><div style="line-height: 28px;"   ><font size="2"   >enable and " 0 " &nbsp;to disable; &nbsp;the default is &nbsp;enabled.</font></div><div style="line-height: 28px;"   ><font size="2"   >domain ― Specifies &nbsp;a failover domain (if required).</font></div><div style="line-height: 28px;"   ><font size="2"   >exclusive ― Specifies &nbsp;a policy wherein the s ervice only runs &nbsp;on nodes &nbsp;that have no other</font></div><div style="line-height: 28px;"   ><font size="2"   >services &nbsp;running on them.</font></div><div style="line-height: 28px;"   ><font size="2"   >recovery ― Specifies &nbsp;a recovery policy for the s ervice. &nbsp;T he options &nbsp;are to relocate, &nbsp;res tart,</font></div><div style="line-height: 28px;"   ><font size="2"   >disable, &nbsp;or restart-disable the s ervice. &nbsp;T he res tart recovery policy indicates &nbsp;that the s ys tem</font></div><div style="line-height: 28px;"   ><font size="2"   >should attempt to res tart the failed s ervice before trying to relocate the s ervice to another</font></div><div style="line-height: 28px;"   ><font size="2"   >node. &nbsp;T he relocate policy indicates &nbsp;that the s ys tem s hould try to res tart the s ervice in a</font></div><div style="line-height: 28px;"   ><font size="2"   >different node. &nbsp;T he dis able policy indicates &nbsp;that the s ys tem s hould dis able the res ource group</font></div><div style="line-height: 28px;"   ><font size="2"   >if any component fails . &nbsp;T he restart-disable policy indicates &nbsp;that the system should attempt to</font></div><div style="line-height: 28px;"   ><font size="2"   >res tart the s ervice in place if it fails , &nbsp;but if res tarting the s ervice fails &nbsp;the s ervice will be</font></div><div style="line-height: 28px;"   ><font size="2"   >dis abled ins tead of being moved to another hos t in the cluster.</font></div><div style="line-height: 28px;"   ><font size="2"   >If you s elect Restart &nbsp;or Restart - Disable &nbsp;as &nbsp;the recovery policy for the s ervice, &nbsp;you can</font></div><div style="line-height: 28px;"   ><font size="2"   >specify the maximum number of res tart failures &nbsp;before relocating or dis abling the s ervice, &nbsp;and</font></div><div style="line-height: 28px;"   ><font size="2"   >you can s pecify the length of time in s econds &nbsp;after which to forget a restart.</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >16. 配置多播地址, 可选. 如果不配置, 多播地址从集群ID中运算出来.</div><div style="line-height: 28px;"   >所以我们需要在同一个多播域中使用不同的集群名来区分多播地址.</div><div style="line-height: 28px;"   >多播是用于集群中的心跳检测的.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >If you do not specify a multicast address &nbsp;in the cluster configuration file, &nbsp;the Red Hat High Availability</font></div><div style="line-height: 28px;"   ><font size="2"   >Add-On software creates &nbsp;one based on the cluster ID. &nbsp;It generates &nbsp;the lower 16 bits &nbsp;of the address &nbsp;and</font></div><div style="line-height: 28px;"   ><font size="2"   >appends &nbsp;them to the upper portion of the address &nbsp;according to whether the IP protocol is &nbsp;IPv4 &nbsp;or IPv6:</font></div><div style="line-height: 28px;"   ><font size="2"   >For IPv4 &nbsp;― The address &nbsp;formed is &nbsp;239.192. &nbsp;plus &nbsp;the lower 16 bits &nbsp;generated by Red Hat High</font></div><div style="line-height: 28px;"   ><font size="2"   >Availability Add-On software.</font></div><div style="line-height: 28px;"   ><font size="2"   >For IPv6 ― The addres s &nbsp;formed is &nbsp;FF15: : &nbsp;plus &nbsp;the lower 16 bits &nbsp;generated by Red Hat High</font></div><div style="line-height: 28px;"   ><font size="2"   >Availability Add-On software.</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >The cluster ID is &nbsp;a unique identifier that cman generates &nbsp;for each cluster. &nbsp;To view the cluster ID,</font></div><div style="line-height: 28px;"   ><font size="2"   >run the cman_tool status command on a cluster node.</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >[root@db-192-168-10-146 ~]# cman_tool status</font></div><div style="line-height: 28px;"   ><font size="2"   >Version: 6.2.0</font></div><div style="line-height: 28px;"   ><font size="2"   >Config Version: 6</font></div><div style="line-height: 28px;"   ><font size="2"   >Cluster Name: yumpg001</font></div><div style="line-height: 28px;"   ><font size="2"   >Cluster Id: 57130</font></div><div style="line-height: 28px;"   ><font size="2"   >Cluster Member: Yes</font></div><div style="line-height: 28px;"   ><font size="2"   >Cluster Generation: 20</font></div><div style="line-height: 28px;"   ><font size="2"   >Membership state: Cluster-Member</font></div><div style="line-height: 28px;"   ><font size="2"   >Nodes: 1</font></div><div style="line-height: 28px;"   ><font size="2"   >Expected votes: 1</font></div><div style="line-height: 28px;"   ><font size="2"   >Total votes: 1</font></div><div style="line-height: 28px;"   ><font size="2"   >Node votes: 1</font></div><div style="line-height: 28px;"   ><font size="2"   >Quorum: 1 &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >Active subsystems: 8</font></div><div style="line-height: 28px;"   ><font size="2"   >Flags: 2node&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >Ports Bound: 0 177 &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >Node name: 192.168.10.146</font></div><div style="line-height: 28px;"   ><font size="2"   >Node ID: 1</font></div><div style="line-height: 28px;"   ><font size="2"   >Multicast addresses: 239.192.223.10&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >Node addresses: 192.168.10.146&nbsp;</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >17. cluster配置文件有一个版本号, 每次修改配置文件后, 如果要使配置文件在重启cman后生效必须把版本号加1.&nbsp;</div><div style="line-height: 28px;"   >同时必须确保集群中的所有服务器的cluster.conf文件内容一致, 版本号一致.</div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >18. /usr/share/cluster/cluster.rng 包含了详细的cluster.conf文件的说明.</div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >19. 默认是使用多播心跳, 如果要使用单播, 请参考</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014817365719/"   >http://blog.163.com/digoal@126/blog/static/1638770402014817365719/</a></div><div><br></div><div>20. 虚拟化环境的FENCE设备参考</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014817111038741/"   >http://blog.163.com/digoal@126/blog/static/1638770402014817111038741/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020148169845549/"   >http://blog.163.com/digoal@126/blog/static/16387704020148169845549/</a></div><div>手工确认fence结果参考</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201481693725958/"   >http://blog.163.com/digoal@126/blog/static/163877040201481693725958/</a></div><div><br></div><div>21. 自动启动集群, 配置一个启动脚本,&nbsp;</div><div>流程 :&nbsp;</div><div>1. 判断对方节点是否启动, 如telnet 22端口.(你可能需要改端口)</div><div>2. 如果600秒内, 对方启动了, 那么开始启动服务</div><div>cman</div><div>clvmd&nbsp;</div><div>rgmanager</div><div>加载共享存储</div><div>如果是主节点的话, 启动集群服务.(备节点不启动服务)</div><div>具体操作如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># vi /usr/local/bin/start_cluster.sh</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   >PEER="10.10.10.221 22"</font></div><div><font size="2"   >SRV="yumpg001_pg"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >for ((i=0;i&lt;600;i++))</font></div><div><font size="2"   >do</font></div><div><font size="2"   >&nbsp; echo -e "q"|telnet -e "q" $PEER</font></div><div><font size="2"   >&nbsp; if [ $? -eq 0 ]; then</font></div><div><font size="2"   >&nbsp; &nbsp; break</font></div><div><font size="2"   >&nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; sleep 1</font></div><div><font size="2"   >&nbsp; &nbsp; continue</font></div><div><font size="2"   >&nbsp; fi</font></div><div><font size="2"   >done</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >sleep 15</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >service cman start</font></div><div><font size="2"   >sleep 3</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >service clvmd start</font></div><div><font size="2"   >sleep 3</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >service rgmanager start</font></div><div><font size="2"   >sleep 3</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># mount shared disk</font></div><div><font size="2"   >mount /dev/mappver/sharedvg_lv01 /data01</font></div><div><font size="2"   >sleep 3</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># primary node only exec: 指定全路径, sleep 10秒后启动, 否则可能会启动失败</font></div><div><font size="2"   ># 只需要在主节点执行, 备节点不自动启动服务.(当然写上也没关系, 反正会判断是否已启动的)</font></div><div><font size="2"   >sleep 10</font></div><div><font size="2"   >/usr/sbin/clusvcadm -e $SRV</font></div><div><br></div><div><font size="2"   ># chmod 500 /usr/local/bin/start_cluster.sh&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># vi /etc/rc.local</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >su - root -c "/usr/local/bin/start_cluster.sh"</font></div><p></p></pre></div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL HA manual with shared disk use RHCS - 2 - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>