<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">quick maintenance postgresql data use cursor</h2>
	<h5 id="">2014-09-02 15:27:12&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020148231945841/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>有时候可能会需要快速对表的某些数据进行维护, 例如删除一个大表的某些记录,&nbsp;</div><div>一般的方法是通过条件来定位需要操作的数据记录, 其实还可以有其他方法, 例如数据访问方法, 这种方法比较巧妙.</div><div>举个例子 :&nbsp;</div><div>我们可以利用访问方法来删除特定的记录, 例如全表扫描, 根据数据块顺序扫描, 所以删除前面的记录很方便.</div><div>索引扫描, 则根据索引顺序或倒序, 或范围来扫描, 那么可以方便的根据索引的顺序来删除所需要删除的数据.</div><div>bitmap index scan则是根据索引扫描出数据后, 再根据CTID物理排序, 从物理排序这个方向来删除所需要删除的数据.</div><div>本例可以看到利用全表扫描来删除前面的数据.</div><div>例如打开一个游标, 这个游标使用全表扫描, 要删除5条记录的话, 一个FOR循环就搞定了.&nbsp;</div><div>效率非常之高, 不管你的表有多大.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# &nbsp;\dt+ t16</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | Name | Type &nbsp;| &nbsp;Owner &nbsp; | Size &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+------+-------+----------+-------+-------------</font></div><div><font size="2"   >&nbsp;public | t16 &nbsp;| table | postgres | 13 GB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select c1 from t16 limit 10;</font></div><div><font size="2"   >&nbsp;c1&nbsp;</font></div><div><font size="2"   >----</font></div><div><font size="2"   >&nbsp; 6</font></div><div><font size="2"   >&nbsp; 7</font></div><div><font size="2"   >&nbsp; 8</font></div><div><font size="2"   >&nbsp; 9</font></div><div><font size="2"   >&nbsp;10</font></div><div><font size="2"   >&nbsp;11</font></div><div><font size="2"   >&nbsp;12</font></div><div><font size="2"   >&nbsp;13</font></div><div><font size="2"   >&nbsp;14</font></div><div><font size="2"   >&nbsp;15</font></div><div><font size="2"   >(10 rows)</font></div><p></p></pre></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >postgres=# do language plpgsql $$ &nbsp; &nbsp; &nbsp;</font></span></div><div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; ref refcursor;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; open ref for select 1 from t16;</font></div><div><font size="2"   >&nbsp; for i in 1..5 loop</font></div><div><font size="2"   >&nbsp; &nbsp; move ref;</font></div><div><font size="2"   >&nbsp; &nbsp; if found then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; delete from t16 where current of ref;</font></div><div><font size="2"   >&nbsp; &nbsp; else&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; exit;</font></div><div><font size="2"   >&nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; end loop;&nbsp;</font></div><div><font size="2"   >&nbsp; close ref;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >DO</font></div><div><font size="2"   >Time: 1.295 ms</font></div></div><p></p></pre></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select c1 from t16 limit 10;</font></div><div><font size="2"   >&nbsp;c1&nbsp;</font></div><div><font size="2"   >----</font></div><div><font size="2"   >&nbsp;11</font></div><div><font size="2"   >&nbsp;12</font></div><div><font size="2"   >&nbsp;13</font></div><div><font size="2"   >&nbsp;14</font></div><div><font size="2"   >&nbsp;15</font></div><div><font size="2"   >&nbsp;16</font></div><div><font size="2"   >&nbsp;17</font></div><div><font size="2"   >&nbsp;18</font></div><div><font size="2"   >&nbsp;19</font></div><div><font size="2"   >&nbsp;20</font></div><div><font size="2"   >(10 rows)</font></div><p></p></pre></div><div>但是, 如果你使用其他方法的话, 看执行计划就该知道效率非常低下, 例如以下SQL :&nbsp;</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >postgres=# explain delete from t16 where ctid in (select ctid from t16 limit 5);</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >----------------------------------------------------------------------------------------------------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;Delete on t16 &nbsp;(cost=0.00..5916667.96 rows=5 width=36)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Nested Loop Semi Join &nbsp;(cost=0.00..5916667.96 rows=5 width=36)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Join Filter: (t16.ctid = "ANY_subquery".ctid)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on t16 &nbsp;(cost=0.00..2166667.08 rows=50000008 width=6)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Materialize &nbsp;(cost=0.00..0.29 rows=5 width=36)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Subquery Scan on "ANY_subquery" &nbsp;(cost=0.00..0.27 rows=5 width=36)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Limit &nbsp;(cost=0.00..0.22 rows=5 width=6)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on t16 t16_1 &nbsp;(cost=0.00..2166667.08 rows=50000008 width=6)</font></div><div style="line-height: 28px;"   ><font size="2"   >(8 rows)</font></div><div style="line-height: 28px;"   ><font size="2"   >Time: 1.166 ms</font></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div style="line-height: 28px;"   ><font size="2"   >postgres=# delete from t16 where ctid in (select ctid from t16 limit 5);</font></div><div style="line-height: 28px;"   ><font size="2"   >DELETE 5</font></div><div style="line-height: 28px;"   ><font size="2"   >Time: 58200.443 ms</font></div><p></p></pre></div></div><wbr><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/plpgsql-cursors.html"   >http://www.postgresql.org/docs/9.3/static/plpgsql-cursors.html</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="quick maintenance postgresql data use cursor - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>