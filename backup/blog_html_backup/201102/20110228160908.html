<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">how many tuples updated and or deleted will trigger auto vacuum or analyze</h2>
	<h5 id="">2011-02-28 16:09:08&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020111283182516/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">开启autovacuum的前提条件是打开track_counts。因为系统需要根据跟踪到的tuples计数和阀值进行比较来决定是否出发autovacuum 或 autoanalyze。<br>相关参数:<br><tt>autovacuum 是否开启自动vacuum , analyze.<br></tt><tt>log_autovacuum_min_duration 阀值，用于度量是否需要记录下autovacuum的动作到log</tt>里面.(-1表示禁止，0表示记录所有)<br><tt>autovacuum_max_workers 用于指定整个数据库机器同一时间点允许的autovacuum后台进程(不包括lanucher进程)</tt><br><tt>autovacuum_naptime 两个autovacuum或autoanalyze允许周期</tt>间的间隔时间。为了看效果，我们在下面的例子把这个值设置为1S。<br><tt>autovacuum_vacuum_threshold&nbsp;&nbsp;&nbsp; 阀值条件1：最小触发vacuum的度量值(计数器记录update,delete的tuples)<br></tt><tt>autovacuum_analyze_threshold&nbsp;&nbsp; </tt><tt>阀值</tt><tt>条件1：最小触发analyze的度量值(计数器记录insert,update,delete的tuples)</tt><br><tt>autovacuum_vacuum_scale_factor</tt> &nbsp; <tt>阀值</tt>条件2：当前reltuples乘以<tt>autovacuum_vacuum_scale_factor</tt><br><tt>autovacuum_analyze_scale_factor </tt><tt>阀值</tt><tt>条件2：</tt>当前reltuples乘以<tt>autovacuum_analyze_scale_factor</tt><br><tt>注意autovacuum和autoanalyze是分别计数的，不要混淆。<br>每一轮autovacuum,autoanalyze后，相应的计数器将归零。<br><br>假设x为update的tuples计数值,y</tt><tt>为delete的tuples计数值</tt>.<br><tt>假设a为update的tuples计数值,b</tt><tt>为delete的tuples计数值</tt>,<tt>c</tt><tt>为insert的tuples计数值</tt>.<br>假设<tt>当前设置的以下参数值:<br></tt><pre class="prettyprint"   ><p><tt><font size="2"   >autovacuum_vacuum_threshold = 50<br></font></tt><font size="2"   ><tt>autovacuum_analyze_threshold = 50<br></tt><tt>autovacuum_vacuum_scale_factor = 0.2<br></tt><tt>autovacuum_analyze_scale_factor = 0.1</tt></font></p></pre>当表上面也设置了类似值的时候将覆盖数据库参数给出的值。详见create table语法。<br><tt><br></tt>具体的算法参考 :&nbsp;src/backend/postmaster/autovacuum.c &nbsp;relation_needs_vacanalyze函数<br>何时发生autoanalyze ?<br>(a+b+c) &gt; (0.1*reltuples + 50)<br><br><br>何时发生autovacuum ? <br>(x+y) &gt; (0.2*reltuples + 50)<br><br><br>例:<br><pre class="prettyprint"   ><p><font size="2"   >digoal=&gt; truncate table tbl_user;<br>TRUNCATE TABLE<br>digoal=&gt; insert into tbl_user select generate_series(1,100000),'zhou','digoal','sky-mobi',27;<br>INSERT 0 100000<br>digoal=&gt; select * from (select reltuples from pg_class where relname='tbl_user')t,(select last_autovacuum,last_autoanalyze from pg_stat_user_tables where relname='tbl_user') t2,(select now()) t3;<br>&nbsp;reltuples |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autovacuum&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autoanalyze&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; now&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>-----------+-------------------------------+-------------------------------+-------------------------------<br>&nbsp;&nbsp;&nbsp; 100000 | 2011-02-28 15:56:27.841113+08 | 2011-02-28 15:56:31.964444+08 | 2011-02-28 15:56:32.544487+08<br>(1 row)<br>digoal=&gt; update&nbsp; tbl_user set age=28 where id&lt;=5000;<br>UPDATE 5000<br>digoal=&gt; select * from (select reltuples from pg_class where relname='tbl_user')t,(select last_autovacuum,last_autoanalyze from pg_stat_user_tables where relname='tbl_user') t2,(select now()) t3;<br>&nbsp;reltuples |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autovacuum&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autoanalyze&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; now&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>-----------+-------------------------------+-------------------------------+------------------------------<br>&nbsp;&nbsp;&nbsp; 100000 | 2011-02-28 15:56:27.841113+08 | 2011-02-28 15:56:31.964444+08 | 2011-02-28 15:56:43.44112+08<br>(1 row)<br>digoal=&gt; delete from tbl_user where id&lt;=4999;<br>DELETE 4999<br>digoal=&gt; select * from (select reltuples from pg_class where relname='tbl_user')t,(select last_autovacuum,last_autoanalyze from pg_stat_user_tables where relname='tbl_user') t2,(select now()) t3;<br>&nbsp;reltuples |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autovacuum&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autoanalyze&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; now&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>-----------+-------------------------------+-------------------------------+-------------------------------<br>&nbsp;&nbsp;&nbsp; 100000 | 2011-02-28 15:56:27.841113+08 | 2011-02-28 15:56:31.964444+08 | 2011-02-28 15:57:07.145726+08<br>(1 row)<br>digoal=&gt; delete from tbl_user where id&lt;=5000;<br>DELETE 1<br>digoal=&gt; select * from (select reltuples from pg_class where relname='tbl_user')t,(select last_autovacuum,last_autoanalyze from pg_stat_user_tables where relname='tbl_user') t2,(select now()) t3;<br>&nbsp;reltuples |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autovacuum&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autoanalyze&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; now&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>-----------+-------------------------------+-------------------------------+-------------------------------<br>&nbsp;&nbsp;&nbsp; 100000 | 2011-02-28 15:56:27.841113+08 | 2011-02-28 15:56:31.964444+08 | 2011-02-28 15:57:15.339859+08<br>(1 row)<br>digoal=&gt; delete from tbl_user where id&lt;=5001;<br>DELETE 1<br>digoal=&gt; select * from (select reltuples from pg_class where relname='tbl_user')t,(select last_autovacuum,last_autoanalyze from pg_stat_user_tables where relname='tbl_user') t2,(select now()) t3;<br>&nbsp;reltuples |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autovacuum&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autoanalyze&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; now&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>-----------+-------------------------------+-------------------------------+-------------------------------<br>&nbsp;&nbsp;&nbsp; 100000 | 2011-02-28 15:56:27.841113+08 | 2011-02-28 15:56:31.964444+08 | 2011-02-28 15:57:25.626393+08<br>(1 row)<br>digoal=&gt; delete from tbl_user where id&lt;=5050;<br>DELETE 1<br>digoal=&gt; select * from (select reltuples from pg_class where relname='tbl_user')t,(select last_autovacuum,last_autoanalyze from pg_stat_user_tables where relname='tbl_user') t2,(select now()) t3;<br>&nbsp;reltuples |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autovacuum&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autoanalyze&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; now&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>-----------+-------------------------------+-------------------------------+-------------------------------<br>&nbsp;&nbsp;&nbsp; 100000 | 2011-02-28 15:56:27.841113+08 | 2011-02-28 15:56:31.964444+08 | 2011-02-28 15:57:53.702822+08<br>(1 row)<br>digoal=&gt; delete from tbl_user where id&lt;=5051;<br>DELETE 1<br>digoal=&gt; select * from (select reltuples from pg_class where relname='tbl_user')t,(select last_autovacuum,last_autoanalyze from pg_stat_user_tables where relname='tbl_user') t2,(select now()) t3;<br>&nbsp;reltuples |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autovacuum&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autoanalyze&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; now&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>-----------+-------------------------------+-------------------------------+-------------------------------<br>&nbsp;&nbsp;&nbsp;&nbsp; 94949 | 2011-02-28 15:56:27.841113+08 | 2011-02-28 15:57:59.126327+08 | 2011-02-28 15:57:59.661962+08<br>(1 row)</font></p></pre>匹配条件 (5000(update)+5051(delete)) &gt; 100000*0.1+50<br><br>例二:<br><pre class="prettyprint"   ><p><font size="2"   >digoal=&gt; truncate table tbl_user;<br>TRUNCATE TABLE<br>digoal=&gt; insert into tbl_user select generate_series(1,100000),'zhou','digoal','sky-mobi',27;<br>INSERT 0 100000<br>digoal=&gt; select * from (select reltuples from pg_class where relname='tbl_user')t,(select last_autovacuum,last_autoanalyze from pg_stat_user_tables where relname='tbl_user') t2,(select now()) t3;<br>&nbsp;reltuples |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autovacuum&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autoanalyze&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; now&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>-----------+-------------------------------+-------------------------------+-------------------------------<br>&nbsp;&nbsp;&nbsp; 100000 | 2011-02-28 16:02:39.745418+08 | 2011-02-28 16:03:26.717123+08 | 2011-02-28 16:03:27.275454+08<br>(1 row)<br>digoal=&gt; update&nbsp; tbl_user set age=28 where id&lt;=10000;<br>UPDATE 10000<br>digoal=&gt; select * from (select reltuples from pg_class where relname='tbl_user')t,(select last_autovacuum,last_autoanalyze from pg_stat_user_tables where relname='tbl_user') t2,(select now()) t3;<br>&nbsp;reltuples |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autovacuum&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autoanalyze&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; now&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>-----------+-------------------------------+-------------------------------+-------------------------------<br>&nbsp;&nbsp;&nbsp; 100000 | 2011-02-28 16:02:39.745418+08 | 2011-02-28 16:03:26.717123+08 | 2011-02-28 16:03:40.223518+08<br>(1 row)<br><br>digoal=&gt; update tbl_user set age=29 where id&lt;=5000;<br>UPDATE 5000<br>digoal=&gt; select * from (select reltuples from pg_class where relname='tbl_user')t,(select last_autovacuum,last_autoanalyze from pg_stat_user_tables where relname='tbl_user') t2,(select now()) t3;<br>&nbsp;reltuples |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autovacuum&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autoanalyze&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; now&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>-----------+-------------------------------+-------------------------------+-------------------------------<br>&nbsp;&nbsp;&nbsp; 100000 | 2011-02-28 16:02:39.745418+08 | 2011-02-28 16:03:59.872549+08 | 2011-02-28 16:04:01.153831+08<br>(1 row)<br><br>digoal=&gt; delete from tbl_user where id&lt;=5050;<br>DELETE 1<br>digoal=&gt; select * from (select reltuples from pg_class where relname='tbl_user')t,(select last_autovacuum,last_autoanalyze from pg_stat_user_tables where relname='tbl_user') t2,(select now()) t3;<br>&nbsp;reltuples |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autovacuum&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autoanalyze&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; now&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>-----------+-------------------------------+-------------------------------+-------------------------------<br>&nbsp;&nbsp;&nbsp; 100000 | 2011-02-28 16:02:39.745418+08 | 2011-02-28 16:03:59.872549+08 | 2011-02-28 16:05:06.075632+08<br>(1 row)<br>digoal=&gt; delete from tbl_user where id&lt;=5051;<br>DELETE 1<br>digoal=&gt; select * from (select reltuples from pg_class where relname='tbl_user')t,(select last_autovacuum,last_autoanalyze from pg_stat_user_tables where relname='tbl_user') t2,(select now()) t3;<br>&nbsp;reltuples |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autovacuum&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_autoanalyze&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; now&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>-----------+-------------------------------+-------------------------------+-------------------------------<br>&nbsp;&nbsp;&nbsp;&nbsp; 94949 | 2011-02-28 16:05:11.068057+08 | 2011-02-28 16:03:59.872549+08 | 2011-02-28 16:05:11.606445+08<br>(1 row)</font></p></pre>匹配条件 (15000(update)+5051(delete)) &gt; 100000*0.2+50<br><br><br>notice:<br>比较时取的是当前的reltuples，当先发生autoanalyze之后，reltuples可能会发生变化，如reltuples变小，从而导致不满足条件的autovacuum有可能变成满足条件。</div>
	</div>
</div>
</body>
</html>