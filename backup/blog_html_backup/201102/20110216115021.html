<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL's Cursor USAGE with SQL MODE - 翻页优化</h2>
	<h5 id="">2011-02-16 11:50:21&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201111694355822/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">今天谈一下cursor SQL, 函数中CURSOR中的使用另外再谈.<br><wbr><br>PostgreSQL客户端请求数据库返回大批量数据有几种常见的方法。<br>一、SELECT<br>二、CURSOR<br>三、分页取(ORDER BY OFFSET x LIMIT n)<br><br>环境:<br>PostgreSQL 9.0.2<br>RHEL 5 x64 <br>服务端 172.16.3.33<br>客户端 172.16.3.39<br><br>测试表:<br><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; \d tbl_user<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Table "digoal.tbl_user"<br>&nbsp; Column&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Modifiers&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>-----------+-----------------------+-------------------------------------------------------<br>&nbsp;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | bigint&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | not null default nextval('tbl_user_id_seq'::regclass)<br>&nbsp;firstname | character varying(32) | <br>&nbsp;lastname&nbsp; | character varying(32) | <br>&nbsp;corp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | character varying(32) | <br>&nbsp;age&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | smallint&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | <br>Indexes:<br>&nbsp;&nbsp;&nbsp; "tbl_user_pkey" PRIMARY KEY, btree (id)</font></p></pre><br>一、SELECT的情况<br><pre class="prettyprint"  ><p><font size="2"  >postgres@db-172-16-3-39-&gt; psql -h 172.16.3.33 digoal digoal<br>Password for user digoal: <br>psql (9.0.2)<br>Type "help" for help.<br><br>digoal=&gt; </font></p></pre><br># 查看客户端连接后，数据库服务器上占用的内存情况<br><pre class="prettyprint"  ><p><font size="2"  >postgres@db-172-16-3-33-&gt; ps -eo pid,user,pmem,rssize,cmd --sort rssize|grep 172.16.3.39<br>&nbsp;5008 postgres&nbsp; 0.0&nbsp; 3512 postgres: digoal digoal 172.16.3.39(32286) idle&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>28272 root&nbsp;&nbsp;&nbsp;&nbsp; 15.2 2189832 /app/mongodb1.6.5/bin/mongod --config /app/mongodb1.6.5/conf/mongod1954.conf --shardsvr --replSet rep3/172.16.3.39:1953<br>18476 root&nbsp;&nbsp;&nbsp;&nbsp; 21.1 3040676 /opt/mongodb1.7/bin/mongod --config /opt/mongodb1.7/conf/mongod.conf --replSet reptest/172.16.3.39:5281<br>28259 root&nbsp;&nbsp;&nbsp;&nbsp; 25.2 3634580 /app/mongodb1.6.5/bin/mongod --config /app/mongodb1.6.5/conf/mongod1953.conf --shardsvr --replSet rep2/172.16.3.39:1954</font></p></pre><br>约占用内存 3512KB<br><br># select 测试<br><pre class="prettyprint"  ><p><font size="2"  >postgres@db-172-16-3-39-&gt; psql -h 172.16.3.33 digoal digoal<br>Password for user digoal: <br>psql (9.0.2)<br>Type "help" for help.<br>digoal=&gt; select * from tbl_user;</font></p></pre>许久没有结果返回,观察数据库端的内存占用情况<br><pre class="prettyprint"  ><p><font size="2"  >&nbsp;4019 postgres&nbsp; 2.8 409764 postgres: digoal digoal 172.16.3.39(20211) SELECT&nbsp; </font></p></pre>逐渐上升，直到idle<br><pre class="prettyprint"  ><p><font size="2"  >&nbsp;4019 postgres&nbsp; 5.0 721852 postgres: digoal digoal 172.16.3.39(20211) idle&nbsp; </font></p></pre>此时该进程占用RSSIZE约721852 KB<br>再过少许客户端开始返回数据<br><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; select * from tbl_user;<br>&nbsp;&nbsp; id&nbsp;&nbsp;&nbsp; | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>---------+-----------+----------+----------+-----<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>..................</font></p></pre><br>二、CURSOR<br>#　详细语法参考　http://www.postgresql.org/docs/9.0/static/sql-declare.html<br><pre><pre class="prettyprint"  ><p><font size="2"  >DECLARE <tt><i>name</i></tt> [ BINARY ] [ INSENSITIVE ] [ [ NO ] SCROLL ]<br>    CURSOR [ { WITH | WITHOUT } HOLD ] FOR <tt><i>query</i></tt></font></p></pre></pre>举例讲解:<br><br>-- BINARY 不建议使用<br>-- INSENSITIVE 指出该指针不受UPDATE等语句的影响，即定义完CURSOR后返回的值被圈定在定义CURSOR之时。PG默认情况下就是INSENSITIVE的。<br><br>示例一:<br><pre class="prettyprint"  ><p><font size="2"  >SESSION A:<br>digoal=&gt; truncate table tbl_user;<br>TRUNCATE TABLE<br>digoal=&gt; insert into tbl_user select generate_series(1,10),'zhou','digoal','sky-mobi',27;<br>INSERT 0 10<br>digoal=&gt; begin;<br>BEGIN<br>digoal=&gt; declare cur_test scroll cursor for select * from tbl_user;<br>DECLARE CURSOR<br>digoal=&gt; fetch 10 from cur_test;<br>&nbsp;id | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>----+-----------+----------+----------+-----<br>&nbsp; 1 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 2 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 3 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 4 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 5 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 6 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 7 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 8 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 9 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;10 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(10 rows)<br><br>SESSION B:<br>digoal=&gt; insert into tbl_user select generate_series(11,20),'zhou','digoal','sky-mobi',27;<br>INSERT 0 10<br><br>SESSION A:<br>digoal=&gt; fetch 10 from cur_test;<br>&nbsp;id | firstname | lastname | corp | age <br>----+-----------+----------+------+-----<br>(0 rows)</font></p></pre><br>示例二:<br><pre class="prettyprint"  ><p><font size="2"  >SESSION A:<br>digoal=&gt; end;<br>COMMIT<br>digoal=&gt; truncate table tbl_user;<br>TRUNCATE TABLE<br>digoal=&gt; insert into tbl_user select generate_series(1,10),'zhou','digoal','sky-mobi',27;<br>INSERT 0 10<br>digoal=&gt; declare cur_test scroll&nbsp; cursor with hold for select * from tbl_user;<br>DECLARE CURSOR<br>digoal=&gt; select * from pg_cursors;<br>&nbsp;&nbsp; name&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; statement&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | is_holdable | is_binary | is_scrollable |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp; creation_time&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>----------+-----------------------------------------------------------------------+-------------+-----------+---------------+-------<br>------------------------<br>&nbsp;cur_test | declare cur_test scroll&nbsp; cursor with hold for select * from tbl_user; | t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2011-0<br>2-16 11:01:15.146791+08<br>(1 row)<br><br>SESSION B:<br>digoal=&gt; select * from pg_cursors ;<br>&nbsp;name | statement | is_holdable | is_binary | is_scrollable | creation_time <br>------+-----------+-------------+-----------+---------------+---------------<br>(0 rows)<br><br>digoal=&gt; insert into tbl_user select generate_series(11,20),'zhou','digoal','sky-mobi',27;<br>INSERT 0 10<br><br>SESSION A:<br>digoal=&gt; fetch last from cur_test;<br>&nbsp;id | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>----+-----------+----------+----------+-----<br>&nbsp;10 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(1 row)<br><br>digoal=&gt; fetch first from cur_test;<br>&nbsp;id | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>----+-----------+----------+----------+-----<br>&nbsp; 1 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(1 row)<br><br>digoal=&gt; fetch 20 from cur_test;<br>&nbsp;id | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>----+-----------+----------+----------+-----<br>&nbsp; 2 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 3 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 4 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 5 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 6 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 7 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 8 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 9 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;10 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(9 rows)</font></p></pre><br>综上两例,cursor定义后的DML对于FETCH来说是不可见的，甚至在SESSION B删除掉的数据SESSION A的CURSOR还是能够看到的，因此with hold正如PostgreSQL所说，这部分数据已经被保持到内存或临时文件了。<br><pre class="prettyprint"  ><p><font size="2"  >SESSION B：<br>digoal=&gt; delete from tbl_user;<br>DELETE 20<br><br>SESSION A：<br>digoal=&gt; fetch first from cur_test;<br>&nbsp;id | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>----+-----------+----------+----------+-----<br>&nbsp; 1 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(1 row)<br><br>digoal=&gt; fetch 20 from cur_test;<br>&nbsp;id | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>----+-----------+----------+----------+-----<br>&nbsp; 2 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 3 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 4 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 5 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 6 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 7 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 8 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp; 9 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;10 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(9 rows)</font></p></pre><br><br>-- SCROLL&nbsp; 指明该指针可以被往前也可以倒退FETCH数据。( 默认情况下不指定scroll或no scroll , PostgreSQL是这么说的The default is to       allow scrolling in some cases; this is not the same as specifying       <tt>SCROLL</tt>. )<br><br>-- WITH HOLD | WITHOUT HOLD&nbsp; 默认值为WITHOUT HOLD, 使用WITH HOLD将CURSOR的使用范围扩大到SESSION级别，WITHOUT HOLD是TRANSACTION级别，另外一个区别是，WITH HOLD将消耗更多的资源（内存或临时文件）来保持数据。<br>示例:<br>往TBL_USER插入更多数据，让它大起来，看看内存占用情况<br><pre class="prettyprint"  ><p><font size="2"  >SESSION A：<br>digoal=&gt; insert into tbl_user select generate_series(0,9999999),'zhou','digoal','sky-mobi',27;<br>INSERT 0 10000000<br>digoal=&gt; select pg_relation_size('tbl_user')/1024;<br>&nbsp;?column? <br>----------<br>&nbsp;&nbsp; 588240<br>(1 row)<br><br>SESSION B:<br>postgres@db-172-16-3-39-&gt; psql -h 172.16.3.33 digoal digoal<br>Password for user digoal: <br>psql (9.0.2)<br>Type "help" for help.<br>digoal=&gt; <br><br>HOST A：<br>查看SESSION B内存占用情况<br>postgres@db-172-16-3-33-&gt; ps -eo pid,user,pmem,rssize,cmd --sort rssize|grep 172.16.3.39<br>11676 postgres&nbsp; 0.0&nbsp; 3508 postgres: digoal digoal 172.16.3.39(34514) idle <br>3508KB<br><br>SESSION B：<br>digoal=&gt; declare cur_test scroll cursor with hold for select * from tbl_user;<br>DECLARE CURSOR<br><br>HOST A：<br>查看SESSION B内存占用情况<br> postgres@db-172-16-3-33-&gt; ps -eo pid,user,pmem,rssize,cmd --sort rssize|grep 172.16.3.39<br>11676 postgres&nbsp; 4.9 709332 postgres: digoal digoal 172.16.3.39(34514) idle&nbsp; <br>709332KB<br>内存占用比表的大小588240KB略大，和存取结构有关系。</font></p></pre><br>-- WITH HOLD的CURSOR何时被释放，1. 断开SESSION，2. 定义该CURSOR的事务被ABORT。<br>需要注意的是,定义CURSOR的TRANSACTION如果被ABORT了，CURSOR也会被删掉。来看看例子<br><pre class="prettyprint"  ><p><font size="2"  >SESSION B:<br>digoal=&gt; begin;<br>BEGIN<br>digoal=&gt; declare cur_test scroll cursor with hold for select * from tbl_user;<br>DECLARE CURSOR<br>digoal=&gt; select * from pg_cursors;<br>&nbsp;&nbsp; name&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; statement&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | is_holdable | is_binary | is_scrollable |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;creation_time&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>----------+----------------------------------------------------------------------+-------------+-----------+---------------+--------<br>-----------------------<br>&nbsp;cur_test | declare cur_test scroll cursor with hold for select * from tbl_user; | t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2011-02<br>-16 11:19:07.506523+08<br>(1 row)<br>HOST A:<br>postgres@db-172-16-3-33-&gt; ps -eo pid,user,pmem,rssize,cmd --sort rssize|grep 172.16.3.39<br>12205 postgres&nbsp; 0.0&nbsp; 4692 postgres: digoal digoal 172.16.3.39(52980) idle in transaction<br><br>SESSION B:<br>digoal=&gt; fetch 1 from cur_test;<br>&nbsp;id | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>----+-----------+----------+----------+-----<br>&nbsp; 0 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(1 row)<br><br>HOST A:<br>postgres@db-172-16-3-33-&gt; ps -eo pid,user,pmem,rssize,cmd --sort rssize|grep 172.16.3.39<br>12205 postgres&nbsp; 0.0&nbsp; 5128 postgres: digoal digoal 172.16.3.39(52980) idle in transaction <br><br>SESSION B:<br>digoal=&gt; fetch last from cur_test;<br>&nbsp;&nbsp; id&nbsp;&nbsp;&nbsp; | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>---------+-----------+----------+----------+-----<br>&nbsp;9999999 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(1 row)<br><br>HOST A:<br>postgres@db-172-16-3-33-&gt; ps -eo pid,user,pmem,rssize,cmd --sort rssize|grep 172.16.3.39<br>12205 postgres&nbsp; 4.8 703972 postgres: digoal digoal 172.16.3.39(52980) idle in transaction <br><br>SESSION B:<br>digoal=&gt; abort;<br>ROLLBACK<br>digoal=&gt; fetch last from cur_test;<br>ERROR:&nbsp; cursor "cur_test" does not exist<br>注意看内存占用的变化,在取第一行的时候占用约1MB，直接跳到LAST的时候马上内存占用就上来了.<br>ABORT之后CURSOR自动释放.<br><br>-- 相关系统表:<br>digoal=&gt; \d pg_cursors<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; View "pg_catalog.pg_cursors"<br>&nbsp;&nbsp;&nbsp; Column&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Modifiers <br>---------------+--------------------------+-----------<br>&nbsp;name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | text&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | <br>&nbsp;statement&nbsp;&nbsp;&nbsp;&nbsp; | text&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | <br>&nbsp;is_holdable&nbsp;&nbsp; | boolean&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | <br>&nbsp;is_binary&nbsp;&nbsp;&nbsp;&nbsp; | boolean&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | <br>&nbsp;is_scrollable | boolean&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | <br>&nbsp;creation_time | timestamp with time zone | </font></p></pre><br>三、分页取(ORDER BY OFFSET x LIMIT n)<br><pre class="prettyprint"  ><p><font size="2"  >SESSION B:<br>digoal=&gt; \timing<br>Timing is on.<br>digoal=&gt; select * from tbl_user order by id offset 0 limit 1;<br>&nbsp;id | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>----+-----------+----------+----------+-----<br>&nbsp; 0 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(1 row)<br>Time: 1.354 ms<br><br>HOST A:<br>postgres@db-172-16-3-33-&gt; ps -eo pid,user,pmem,rssize,cmd --sort rssize|grep 172.16.3.39<br>13172 postgres&nbsp; 0.0&nbsp; 5256 postgres: digoal digoal 172.16.3.39(53042) idle <br><br>SESSION B:<br>digoal=&gt; select * from tbl_user order by id desc offset 0 limit 1;<br>&nbsp;&nbsp; id&nbsp;&nbsp;&nbsp; | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>---------+-----------+----------+----------+-----<br>&nbsp;9999999 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(1 row)<br><br>Time: 0.404 ms<br><br>HOST A:<br>postgres@db-172-16-3-33-&gt; ps -eo pid,user,pmem,rssize,cmd --sort rssize|grep 172.16.3.39<br>13172 postgres&nbsp; 0.0&nbsp; 5352 postgres: digoal digoal 172.16.3.39(53042) idle&nbsp;&nbsp; <br><br>SESSION B:<br>digoal=&gt; select * from tbl_user order by id offset 9999999 limit 1;<br>&nbsp;&nbsp; id&nbsp;&nbsp;&nbsp; | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>---------+-----------+----------+----------+-----<br>&nbsp;9999999 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(1 row)<br><br>Time: 1679.057 ms<br><br>HOST A:<br>postgres@db-172-16-3-33-&gt; ps -eo pid,user,pmem,rssize,cmd --sort rssize|grep 172.16.3.39<br>13172 postgres&nbsp; 5.7 832020 postgres: digoal digoal 172.16.3.39(53042) idle<br><br>SESSION B: (已经全部在内存，所以现在OFFSET 99999已经比较快了,不过由于走索引，可能有随机硬盘扫描)<br>digoal=&gt; select * from tbl_user order by id offset 99999 limit 1;<br>&nbsp; id&nbsp;&nbsp; | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>-------+-----------+----------+----------+-----<br>&nbsp;99999 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(1 row)<br><br>Time: 15.248 ms<br><br>示例:比较offset 和 move<br>digoal=&gt; begin;<br>BEGIN<br>digoal=&gt; declare cur_test no scroll cursor without hold for select * from tbl_user order by id;<br>DECLARE CURSOR<br>digoal=&gt; \timing<br>Timing is on.<br>digoal=&gt; fetch 1 from cur_test;<br>&nbsp;id | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>----+-----------+----------+----------+-----<br>&nbsp; 0 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(1 row)<br><br>Time: 0.356 ms<br>digoal=&gt; move 99999 cur_test;<br>MOVE 99999<br>Time: 18.613 ms<br>digoal=&gt; fetch 1 from cur_test;<br>&nbsp;&nbsp; id&nbsp;&nbsp; | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>--------+-----------+----------+----------+-----<br>&nbsp;100000 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(1 row)<br><br>Time: 0.286 ms<br>digoal=&gt; fetch first from cur_test;<br>&nbsp;id | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>----+-----------+----------+----------+-----<br>&nbsp; 0 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(1 row)<br><br>Time: 0.308 ms<br>digoal=&gt; move 99999 cur_test;<br>MOVE 99999<br>Time: 18.567 ms<br>内存占用:<br>14622 postgres&nbsp; 0.1 18484 postgres: digoal digoal 172.16.3.39(27450) idle in transaction<br><br>OFFSET:<br>digoal=&gt; \timing<br>Timing is on.<br>digoal=&gt; select * from tbl_user order by id offset 99999 limit 1;<br>&nbsp; id&nbsp;&nbsp; | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>-------+-----------+----------+----------+-----<br>&nbsp;99999 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(1 row)<br>Time: 19.484 ms<br>内存占用<br>14904 postgres&nbsp; 0.1 18496 postgres: digoal digoal 172.16.3.39(27452) idle&nbsp;&nbsp; <br><br>消耗的时间和内存的占用两种方法基本相同.不过再看看下面的例子，你会发现，CURSOR的开销是一次性的，而OFFSET是每次都要开销这么多<br>digoal=&gt; \timing<br>Timing is on.<br>digoal=&gt; begin;<br>BEGIN<br>Time: 0.287 ms<br>digoal=&gt; declare cur_test no scroll cursor without hold for select * from tbl_user order by id;<br>DECLARE CURSOR<br>Time: 1.121 ms<br>digoal=&gt; move 100000 from cur_test;<br>MOVE 100000<br>Time: 18.638 ms<br>digoal=&gt; fetch 10 from cur_test;<br>&nbsp;&nbsp; id&nbsp;&nbsp; | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>--------+-----------+----------+----------+-----<br>&nbsp;100000 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100001 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100002 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100003 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100004 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100005 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100006 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100007 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100008 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100009 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(10 rows)<br>Time: 0.317 ms<br>digoal=&gt; fetch 10 from cur_test;<br>&nbsp;&nbsp; id&nbsp;&nbsp; | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>--------+-----------+----------+----------+-----<br>&nbsp;100010 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100011 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100012 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100013 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100014 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100015 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100016 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100017 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100018 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100019 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(10 rows)<br>Time: 0.223 ms<br><br>OFFSET:<br>digoal=&gt; select * from tbl_user order by id offset 100000 limit 10;<br>&nbsp;&nbsp; id&nbsp;&nbsp; | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>--------+-----------+----------+----------+-----<br>&nbsp;100000 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100001 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100002 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100003 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100004 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100005 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100006 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100007 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100008 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100009 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(10 rows)<br><br>Time: 15.432 ms<br>digoal=&gt; select * from tbl_user order by id offset 100010 limit 10;<br>&nbsp;&nbsp; id&nbsp;&nbsp; | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>--------+-----------+----------+----------+-----<br>&nbsp;100010 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100011 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100012 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100013 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100014 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100015 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100016 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100017 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100018 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;100019 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(10 rows)<br><br>Time: 15.170 ms</font></p></pre># 所以有可能的话还是尽量使用CURSOR来做翻页<br># cursor使用需要注意如下事项:<br>1. 指针使用完一定要记得用close关掉.<br>2. 尽量避免在大的结果集下使用with hold指针，因为需要将数据预加载到内存或临时文件，并发大并且结果集较大的话可能导致内存消耗过多。<br>3. 同时应尽量避免长事务(如等待用户翻页)，由于带有without hold指针的事务会影响VACUUM回收空间,这个是非常严重的事情。<br><br>其他:<br>python的fetchall，fetchmany函数分别返回所有和多个</div>
	</div>
</div>
</body>
</html>