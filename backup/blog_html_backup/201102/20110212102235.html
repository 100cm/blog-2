<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL Random Query Tuning</h2>
	<h5 id="">2011-02-12 10:22:35&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201111292628555/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">&nbsp;&nbsp;&nbsp; 在某些场景可能会需要随机的从表中取出记录。方法比较多，简单的方法可能给数据库带来巨大的开销，下面开始举例说明，看看如何优化一个随机查询。<br>测试表:<br><pre class="prettyprint"  ><p><font size="2"  >create table tbl_user(id serial8 primary key,firstname varchar(32),lastname varchar(32),corp varchar(32),age smallint);</font></p></pre>ID列被作为优化随机查询的选择列.唯一，有索引，非空是比较好的选择.<br>测试记录:<br><pre class="prettyprint"  ><p><font size="2"  >insert into tbl_user select generate_series(1,999999),'zhou','digoal','sky-mobi',27;</font></p></pre>随机查询方法举例:<br>方法&nbsp;&nbsp;&nbsp; 1. 最简单的随机查询，查询出1条记录。<br><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; select * from tbl_user order by random() limit 1;<br>&nbsp;&nbsp; id&nbsp;&nbsp; | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>--------+-----------+----------+----------+-----<br>&nbsp;809085 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(1 row)<br>Time: 411.856 ms</font></p></pre>执行计划:<br><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; explain select * from tbl_user order by random() limit 1;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; QUERY PLAN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>------------------------------------------------------------------------------<br>&nbsp;Limit&nbsp; (cost=24852.98..24852.99 rows=1 width=31)<br>&nbsp;&nbsp; -&gt;&nbsp; Sort&nbsp; (cost=24852.98..27352.98 rows=999999 width=31)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Sort Key: (random())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;&nbsp; Seq Scan on tbl_user&nbsp; (cost=0.00..19852.99 rows=999999 width=31)<br>(4 rows)</font></p></pre>简单是简单，缺点也很明显，这种随机查询在大表上跑数据库肯定是吃不消的。<br><br>以下列举利用索引列进行优化的方法。<br>方法&nbsp;&nbsp;&nbsp; 2.&nbsp; 随机取出n条记录,以下取出5条随机记录<br><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; select * from tbl_user<br>digoal-&gt;&nbsp; where id in<br>digoal-&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (select floor(random() * (max_id - min_id))::int<br>digoal(&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; + min_id<br>digoal(&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; from generate_series(1,5),<br>digoal(&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (select max(id) as max_id,<br>digoal(&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; min(id) as min_id<br>digoal(&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; from tbl_user) s1<br>digoal(&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )<br>digoal-&gt; limit 5;<br>&nbsp;&nbsp; id&nbsp;&nbsp; | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>--------+-----------+----------+----------+-----<br>&nbsp;965638 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;193491 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;294286 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;726263 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;470713 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(5 rows)<br>Time: 0.670 ms</font></p></pre>执行计划:<br><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; explain select * from tbl_user<br>digoal-&gt;&nbsp; where id in<br>digoal-&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (select floor(random() * (max_id - min_id))::int<br>digoal(&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; + min_id<br>digoal(&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; from generate_series(1,5),<br>digoal(&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (select max(id) as max_id,<br>digoal(&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; min(id) as min_id<br>digoal(&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; from tbl_user) s1<br>digoal(&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )<br>digoal-&gt; limit 5;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; QUERY PLAN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp; <br>------------------------------------------------------------------------------------------------------------------------------------<br>--<br>&nbsp;Limit&nbsp; (cost=50.08..69.63 rows=5 width=31)<br>&nbsp;&nbsp; -&gt;&nbsp; Nested Loop&nbsp; (cost=50.08..832.26 rows=200 width=31)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;&nbsp; HashAggregate&nbsp; (cost=50.08..52.08 rows=200 width=8)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;&nbsp; Nested Loop&nbsp; (cost=0.06..37.58 rows=1000 width=16)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;&nbsp; Result&nbsp; (cost=0.06..0.07 rows=1 width=0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InitPlan 1 (returns $0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;&nbsp; Limit&nbsp; (cost=0.00..0.03 rows=1 width=8)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;&nbsp; Index Scan Backward using tbl_user_pkey on tbl_user&nbsp; (cost=0.00..27844.29 rows=999999 width=8<br>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Index Cond: (id IS NOT NULL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InitPlan 2 (returns $1)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;&nbsp; Limit&nbsp; (cost=0.00..0.03 rows=1 width=8)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;&nbsp; Index Scan using tbl_user_pkey on tbl_user&nbsp; (cost=0.00..27844.29 rows=999999 width=8)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Index Cond: (id IS NOT NULL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;&nbsp; Function Scan on generate_series&nbsp; (cost=0.00..10.00 rows=1000 width=0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;&nbsp; Index Scan using tbl_user_pkey on tbl_user&nbsp; (cost=0.00..3.89 rows=1 width=31)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Index Cond: (digoal.tbl_user.id = (((floor((random() * ((($0) - ($1)))::double precision)))::integer + ($1))))<br>(16 rows)</font></p></pre><br>方法&nbsp;&nbsp; 3. 取出N条连续的随机记录.(此处用到函数)<br><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; create or replace function f_get_random (i_range int) returns setof record as $BODY$<br>digoal$&gt; declare<br>digoal$&gt; v_result record;<br>digoal$&gt; v_max_id int;<br>digoal$&gt; v_min_id int;<br>digoal$&gt; v_random numeric;<br>digoal$&gt; begin<br>digoal$&gt; select random() into v_random;<br>digoal$&gt; select max(id),min(id) into v_max_id,v_min_id from tbl_user;<br>digoal$&gt; for v_result in select * from tbl_user where id between (v_min_id+(v_random*(v_max_id-v_min_id))::int) and (v_min_id+(v_random*(v_max_id-v_min_id))::int+i_range)<br>digoal$&gt; loop<br>digoal$&gt; return next v_result;<br>digoal$&gt; end loop;<br>digoal$&gt; return;<br>digoal$&gt; end<br>digoal$&gt; $BODY$ language plpgsql;<br>CREATE FUNCTION</font></p></pre>以下举例取出10条连续的随机记录<br><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; select * from f_get_random(9) as (id bigint,firstname varchar(32),lastname varchar(32),corp varchar(32),age smallint);<br>&nbsp;&nbsp; id&nbsp;&nbsp; | firstname | lastname |&nbsp;&nbsp; corp&nbsp;&nbsp; | age <br>--------+-----------+----------+----------+-----<br>&nbsp;694686 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;694687 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;694688 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;694689 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;694690 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;694691 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;694692 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;694693 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;694694 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>&nbsp;694695 | zhou&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | digoal&nbsp;&nbsp; | sky-mobi |&nbsp; 27<br>(10 rows)<br>Time: 0.418 ms</font></p></pre>执行计划:<br><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; explain select * from tbl_user where id between 694686 and 694695;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; QUERY PLAN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>-------------------------------------------------------------------------------<br>&nbsp;Index Scan using tbl_user_pkey on tbl_user&nbsp; (cost=0.00..4.48 rows=9 width=31)<br>&nbsp;&nbsp; Index Cond: ((id &gt;= 694686) AND (id &lt;= 694695))<br>(2 rows)<br><br>digoal=&gt; explain select max(id),min(id) from tbl_user;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; QUERY PLAN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>--------------------------------------------------------------------------------------------------------------<br>&nbsp;Result&nbsp; (cost=0.06..0.07 rows=1 width=0)<br>&nbsp;&nbsp; InitPlan 1 (returns $0)<br>&nbsp;&nbsp;&nbsp;&nbsp; -&gt;&nbsp; Limit&nbsp; (cost=0.00..0.03 rows=1 width=8)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;&nbsp; Index Scan Backward using tbl_user_pkey on tbl_user&nbsp; (cost=0.00..27844.29 rows=999999 width=8)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Index Cond: (id IS NOT NULL)<br>&nbsp;&nbsp; InitPlan 2 (returns $1)<br>&nbsp;&nbsp;&nbsp;&nbsp; -&gt;&nbsp; Limit&nbsp; (cost=0.00..0.03 rows=1 width=8)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;&nbsp; Index Scan using tbl_user_pkey on tbl_user&nbsp; (cost=0.00..27844.29 rows=999999 width=8)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Index Cond: (id IS NOT NULL)<br>(9 rows)</font></p></pre><br>其他的方法不再一一列举，方法2和方法3可以满足大多数的需求了。开销和运行时间均比方法1下降1000倍以上.<br>注意事项:<br>1. 索引列的类型和查询条件的类型必须匹配.<br>2. random() 取值范围 0.0 到 1.0<br>3. id between x and y 的写法等同于 id&gt;= x and id&lt;=y .<br>&nbsp;&nbsp;&nbsp; id BETWEEN SYMMETRIC x and y 的写法等同于 (id &gt;= x and id &lt;= y) or (id &gt;= y and id &lt;= x)<br>因此两者的执行计划是完全不一样的,如下:<br><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; explain select * from tbl_user where id BETWEEN SYMMETRIC 3 and 2;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; QUERY PLAN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>----------------------------------------------------------------------------------<br>&nbsp;Bitmap Heap Scan on tbl_user&nbsp; (cost=4.63..6.65 rows=1 width=31)<br>&nbsp;&nbsp; Recheck Cond: (((id &gt;= 3) AND (id &lt;= 2)) OR ((id &gt;= 2) AND (id &lt;= 3)))<br>&nbsp;&nbsp; -&gt;&nbsp; BitmapOr&nbsp; (cost=4.63..4.63 rows=1 width=0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;&nbsp; Bitmap Index Scan on tbl_user_pkey&nbsp; (cost=0.00..2.31 rows=1 width=0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Index Cond: ((id &gt;= 3) AND (id &lt;= 2))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;&nbsp; Bitmap Index Scan on tbl_user_pkey&nbsp; (cost=0.00..2.31 rows=1 width=0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Index Cond: ((id &gt;= 2) AND (id &lt;= 3))<br>(7 rows)<br><br>digoal=&gt; explain select * from tbl_user where id BETWEEN 2 and 3;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; QUERY PLAN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>-------------------------------------------------------------------------------<br>&nbsp;Index Scan using tbl_user_pkey on tbl_user&nbsp; (cost=0.00..4.32 rows=1 width=31)<br>&nbsp;&nbsp; Index Cond: ((id &gt;= 2) AND (id &lt;= 3))<br>(2 rows)</font></p></pre></div>
	</div>
</div>
</body>
</html>