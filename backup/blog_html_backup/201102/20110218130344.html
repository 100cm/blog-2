<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Use generate_series fill up two column's range or row-column convert</h2>
	<h5 id="">2011-02-18 13:03:44&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201111805555263/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">假如有以下测试表，包含省份信息和IP段的信息。需要转换为省份+IPs的信息的信息。<br><pre class="prettyprint"   ><p><font size="2"   >digoal=&gt; \d tbl_ip_info <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Table "digoal.tbl_ip_info"<br> &nbsp; Column&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Modifiers <br> ----------+-----------------------+-----------<br> &nbsp;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | integer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | <br> &nbsp;province | character varying(10) |&nbsp; 省份<br> &nbsp;start_ip | inet&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp; 开始IP<br> &nbsp;end_ip&nbsp;&nbsp; | inet&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp; 结束IP</font></p></pre><br>由于PostgreSQL中带了IP类型，所以做起来比较简单，在ORACLE中的话就比较复杂了。<br><br>比如192.168.1.1这个IP+256 = 192.168.2.1 ；在PG中可以轻松实现。<br><pre class="prettyprint"   ><p><font size="2"   >digoal=&gt; select '192.168.1.1'::inet+256;<br>&nbsp; ?column?&nbsp;&nbsp; <br>-------------<br>&nbsp;192.168.2.1<br>(1 row)</font></p></pre><br>插入测试数据 : <br><pre class="prettyprint"   ><p><font size="2"   >digoal=&gt; insert into tbl_ip_info values (1,'浙江','192.168.1.254','192.168.2.5');<br>digoal=&gt; insert into tbl_ip_info values (2,'广东','192.168.2.254','192.168.3.5');<br>digoal=&gt; insert into tbl_ip_info values (3,'湖南','192.168.3.254','192.168.4.5');</font><br></p></pre><pre class="prettyprint"   ><p><font size="2"   >digoal=&gt; select * from tbl_ip_info;<br>&nbsp;id | province |&nbsp;&nbsp; start_ip&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp; end_ip&nbsp;&nbsp;&nbsp; <br>----+----------+---------------+-------------<br>&nbsp; 1 | 浙江&nbsp;&nbsp;&nbsp;&nbsp; | 192.168.1.254 | 192.168.2.5<br>&nbsp; 2 | 广东&nbsp;&nbsp;&nbsp;&nbsp; | 192.168.2.254 | 192.168.3.5<br>&nbsp; 3 | 湖南&nbsp;&nbsp;&nbsp;&nbsp; | 192.168.3.254 | 192.168.4.5<br>(3 rows)</font></p></pre><br>转换为省份+IPs的信息的信息,<br><pre class="prettyprint"   ><p><font size="2"   >digoal=&gt; select id,generate_series(0,end_ip-start_ip)+start_ip from tbl_ip_info ;<br>&nbsp;id |&nbsp;&nbsp; ?column?&nbsp;&nbsp;&nbsp; <br>----+---------------<br>&nbsp; 1 | 192.168.1.254<br>&nbsp; 1 | 192.168.1.255<br>&nbsp; 1 | 192.168.2.0<br>&nbsp; 1 | 192.168.2.1<br>&nbsp; 1 | 192.168.2.2<br>&nbsp; 1 | 192.168.2.3<br>&nbsp; 1 | 192.168.2.4<br>&nbsp; 1 | 192.168.2.5<br>&nbsp; 2 | 192.168.2.254<br>&nbsp; 2 | 192.168.2.255<br>&nbsp; 2 | 192.168.3.0<br>&nbsp; 2 | 192.168.3.1<br>&nbsp; 2 | 192.168.3.2<br>&nbsp; 2 | 192.168.3.3<br>&nbsp; 2 | 192.168.3.4<br>&nbsp; 2 | 192.168.3.5<br>&nbsp; 3 | 192.168.3.254<br>&nbsp; 3 | 192.168.3.255<br>&nbsp; 3 | 192.168.4.0<br>&nbsp; 3 | 192.168.4.1<br>&nbsp; 3 | 192.168.4.2<br>&nbsp; 3 | 192.168.4.3<br>&nbsp; 3 | 192.168.4.4<br>&nbsp; 3 | 192.168.4.5<br>(24 rows)</font></p></pre><br><br>如果是数字类型的范围转换更加方便。如下<br><pre class="prettyprint"   ><p><font size="2"   >digoal=&gt; create table&nbsp; tbl_student_info (id int,teacher_id int,class_start_id int,class_end_id int);<br>CREATE TABLE<br>Time: 1.090 ms<br>digoal=&gt; insert into tbl_student_info values (1,1,1,10),(2,2,11,20),(3,3,21,30);<br>INSERT 0 3<br>Time: 0.362 ms<br>digoal=&gt; select teacher_id,generate_series(class_start_id,class_end_id) class_id from tbl_student_info;<br>&nbsp;teacher_id | class_id <br>------------+----------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 6<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 7<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 8<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 9<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 10<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 11<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 12<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 13<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 14<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 15<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 16<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 17<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 18<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 19<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 20<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 21<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 22<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 23<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 24<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 25<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 26<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 27<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 28<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 29<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 30<br>(30 rows)</font></p></pre><br>使用generate_series来做这种填充，消耗是非常小的<br><pre class="prettyprint"   ><p><font size="2"   >digoal=&gt; explain select id,generate_series(0,end_ip-start_ip)+start_ip from tbl_ip_info ;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; QUERY PLAN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>---------------------------------------------------------------<br>&nbsp;Seq Scan on tbl_ip_info&nbsp; (cost=0.00..20.50 rows=600 width=68)<br>(1 row)</font></p></pre><br>只需要一次全表扫描就可以产生所有需要的结果。<br><br>generate_series还可以设置步长，产生时间值等。类似的函数还有generate_subscripts。<div>&nbsp;
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="Use generate_series fill up two columns range or row-column convert - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a><br></div></div>
	</div>
</div>
</body>
</html>