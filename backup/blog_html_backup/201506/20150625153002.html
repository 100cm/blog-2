<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">don't modify table multi-times in CTE, will cause bug.</h2>
	<h5 id="">2015-06-25 15:30:02&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201552523134343/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>虽然PostgreSQL现在支持在CTE中使用更新，删除等操作，但是不建议同一个表的同一条记录在CTE的多个子句中更新多次。</div><div>这样做容易产生BUG，或者数据不一致(可能是意想不到的结果)。</div><div><br></div><div>测试：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create table t1(id int,info text);</font></div><div><font size="2"   >create table t2(id int,info text);</font></div><div><font size="2"   >create table t3(id int,info text);</font></div><div><font size="2"   >insert into t1 values (1,'test'),(2,'abc');</font></div><div><font size="2"   >insert into t2 values (2,'test'),(3,'abc');</font></div><div><font size="2"   >insert into t3 values (1,'abc'),(2,'test');</font></div><p></p></pre></div><div><br></div><div>更新t1表，在CTE内部更新一次，在外部再更新一次。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# explain with tm1(c1,c2) as (update t1 set id=t2.id from t2 where t1.info=t2.info returning t1.id,t1.info) update t1 set info=t3.info from t3 where t1.id=t3.id returning t1.id,t1.info;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Update on t1 &nbsp;(cost=3326.11..5196.03 rows=123008 width=48)</font></div><div><font size="2"   >&nbsp; &nbsp;CTE tm1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;-&gt; &nbsp;Update on t1 t1_1 &nbsp;(cost=728.10..2598.02 rows=123008 width=48)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Merge Join &nbsp;(cost=728.10..2598.02 rows=123008 width=48)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Merge Cond: (t1_1.info = t2.info)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=364.05..376.45 rows=4960 width=38)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: t1_1.info</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on t1 t1_1 &nbsp;(cost=0.00..59.60 rows=4960 width=38)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=364.05..376.45 rows=4960 width=42)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: t2.info</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on t2 &nbsp;(cost=0.00..59.60 rows=4960 width=42)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Merge Join &nbsp;(cost=728.10..2598.02 rows=123008 width=48)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Merge Cond: (t1.id = t3.id)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=364.05..376.45 rows=4960 width=10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: t1.id</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on t1 &nbsp;(cost=0.00..59.60 rows=4960 width=10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=364.05..376.45 rows=4960 width=42)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: t3.id</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on t3 &nbsp;(cost=0.00..59.60 rows=4960 width=42)</font></div><div><font size="2"   >(19 rows)</font></div><p></p></pre></div><div><br></div><div>在外部的SQL看不到内部的更新，所以依旧以老的值匹配，所以得到这样的结果。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# with tm1(c1,c2) as (update t1 set id=t2.id from t2 where t1.info=t2.info returning t1.id,t1.info) update t1 set info=t3.info from t3 where t1.id=t3.id returning t1.id,t1.info;</font></div><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | abc</font></div><div><font size="2"   >&nbsp; 2 | test</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   >postgres=# select ctid,* from t1;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| id | info&nbsp;</font></div><div><font size="2"   >-------+----+------</font></div><div><font size="2"   >&nbsp;(0,3) | &nbsp;1 | abc</font></div><div><font size="2"   >&nbsp;(0,4) | &nbsp;2 | test</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>分析，</div><div>1. 内部CTE更新后的结果</div><div><span style="line-height: 28px;"   >(2,'test'),(3,'abc'); &nbsp;-- 但是，外部SQL看不到这个结果。所以忽略。</span></div><div>2. 外部更新的结果</div><div><span style="line-height: 28px;"   >(1,'abc'),(2,'test'); &nbsp;-- &nbsp;这是最终结果。</span></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >我们换个方式验证外部SQL看不到CTE的更新。</span></div><div><span style="line-height: 28px;"   >如果要看到CTE的更新，需使用returning，并查看CTE表。</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# create table t(id int,info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# insert into t values (1,'abc');</font></div><div><font size="2"   >INSERT 0 1</font></div></div><div><div><font size="2"   >postgres=# with tm1(id,info) as (update t set info='new' returning *) select * from t;</font></div><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | abc</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select * from t;</font></div><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | new</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >如果要查看CTE更新后的数据，需要使用returning并查看CTE表。</font></div><div><div><font size="2"   >postgres=# with tm1(id,info) as (update t set info='digoal' returning *) select * from tm1;</font></div><div><font size="2"   >&nbsp;id | &nbsp;info &nbsp;</font></div><div><font size="2"   >----+--------</font></div><div><font size="2"   >&nbsp; 1 | digoal</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >接下来换个SQL，使用两个CTE，对t1表进行更新。你会发现结果有点意想不到了。</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# truncate t1;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >postgres=# insert into t1 values (1,'test'),(2,'abc');</font></div><div><font size="2"   >INSERT 0 2</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >注意这里使用了merge join</font></div><div><font size="2"   >postgres=# explain with tm1(c1,c2) as (update t1 set id=t2.id from t2 where t1.info=t2.info returning t1.id,t1.info), tm2(c3,c4) as (update t1 set info=t3.info from t3 where t1.id=t3.id returning t1.id,t1.info) select * from tm1,tm2;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Nested Loop &nbsp;(cost=5196.03..332272934.55 rows=15130968064 width=72)</font></div><div><font size="2"   >&nbsp; &nbsp;CTE tm1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;-&gt; &nbsp;Update on t1 &nbsp;(cost=728.10..2598.02 rows=123008 width=48)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Merge Join &nbsp;(cost=728.10..2598.02 rows=123008 width=48)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Merge Cond: (t1.info = t2.info)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=364.05..376.45 rows=4960 width=38)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: t1.info</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on t1 &nbsp;(cost=0.00..59.60 rows=4960 width=38)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=364.05..376.45 rows=4960 width=42)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: t2.info</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on t2 &nbsp;(cost=0.00..59.60 rows=4960 width=42)</font></div><div><font size="2"   >&nbsp; &nbsp;CTE tm2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;-&gt; &nbsp;Update on t1 t1_1 &nbsp;(cost=728.10..2598.02 rows=123008 width=48)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Merge Join &nbsp;(cost=728.10..2598.02 rows=123008 width=48)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Merge Cond: (t1_1.id = t3.id)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=364.05..376.45 rows=4960 width=10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: t1_1.id</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on t1 t1_1 &nbsp;(cost=0.00..59.60 rows=4960 width=10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=364.05..376.45 rows=4960 width=42)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: t3.id</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on t3 &nbsp;(cost=0.00..59.60 rows=4960 width=42)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;CTE Scan on tm1 &nbsp;(cost=0.00..2460.16 rows=123008 width=36)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;CTE Scan on tm2 &nbsp;(cost=0.00..2460.16 rows=123008 width=36)</font></div><div><font size="2"   >(23 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# with tm1(c1,c2) as (update t1 set id=t2.id from t2 where t1.info=t2.info returning t1.id,t1.info), tm2(c3,c4) as (update t1 set info=t3.info from t3 where t1.id=t3.id returning t1.id,t1.info) select * from tm1,tm2;</font></div><div><font size="2"   >&nbsp;c1 | c2 &nbsp;| c3 | c4 &nbsp;</font></div><div><font size="2"   >----+-----+----+-----</font></div><div><font size="2"   >&nbsp; 3 | abc | &nbsp;1 | abc</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select ctid,* from t1;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| id | info&nbsp;</font></div><div><font size="2"   >-------+----+------</font></div><div><font size="2"   >&nbsp;(0,3) | &nbsp;3 | abc</font></div><div><font size="2"   >&nbsp;(0,4) | &nbsp;1 | abc</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>分析一下更新过程，注意merge join用到了排序，这是和结果至关重要的：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >括号内是ctid</font></div><div><font size="2"   >t1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;t1(updated)</font></div><div><font size="2"   >(0,2) &nbsp;2, abc; &nbsp; &nbsp; &nbsp; &nbsp;3, abc; &nbsp; &nbsp; &nbsp; &nbsp; (0,3) &nbsp;3, abc;</font></div><div><font size="2"   >(0,1) &nbsp;1, test; &nbsp; &nbsp; &nbsp; &nbsp;2, test; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><div style="line-height: 28px;"   ><font size="2"   >括号内是ctid</font></div><div style="line-height: 28px;"   ><font size="2"   >t1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;t1(updated)</font></div><div style="line-height: 28px;"   ><font size="2"   >(0,1) &nbsp;1, test; &nbsp; &nbsp; &nbsp; &nbsp;1, abc; &nbsp; &nbsp; &nbsp; &nbsp; (0,4) &nbsp;1, abc;</font></div><div style="line-height: 28px;"   ><font size="2"   >(0,2) &nbsp;2, abc; &nbsp; &nbsp; &nbsp; &nbsp;2, test; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div></div><div style="line-height: 28px;"   ><font size="2"   >当更新第二条记录时，数据已经变成这样了ctid指向被第一次更新后的ctid：</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >t1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;t1(updated)</font></div><div style="line-height: 28px;"   ><font size="2"   >(0,2) &nbsp;2, abc; &nbsp; &nbsp; &nbsp; &nbsp;3, abc; &nbsp; &nbsp; &nbsp; &nbsp; (0,3) &nbsp;3, abc;</font></div><div style="line-height: 28px;"   ><font size="2"   >(0,4) &nbsp;1, abc; &nbsp; &nbsp; &nbsp; &nbsp;2, test; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;info不匹配，不更新</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >括号内是ctid</font></div><div style="line-height: 28px;"   ><font size="2"   >t1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;t1(updated)</font></div><div style="line-height: 28px;"   ><font size="2"   >(0,1) &nbsp;1, test; &nbsp; &nbsp; &nbsp; &nbsp;1, abc; &nbsp; &nbsp; &nbsp; &nbsp; (0,4) &nbsp;1, abc;</font></div><div style="line-height: 28px;"   ><font size="2"   >(0,3) &nbsp;3, abc; &nbsp; &nbsp; &nbsp; &nbsp;2, test; &nbsp; &nbsp; &nbsp; &nbsp; id不匹配，不更新</font></div><div style="line-height: 28px;"   ><font size="2"   >所以最终的结果是：</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >&nbsp;(0,3) | &nbsp;3 | abc</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;(0,4) | &nbsp;1 | abc</font></div></div></div></div><p></p></pre></div><div>这个更新的结果和执行计划有关。</div><div><br></div><div>下面分析一下这三个表，执行计划会改变。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# truncate t1;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >postgres=# insert into t1 values (1,'test'),(2,'abc');</font></div><div><font size="2"   >INSERT 0 2</font></div><div><font size="2"   >postgres=# analyze t1;</font></div><div><font size="2"   >ANALYZE</font></div><div><font size="2"   >postgres=# analyze t2;</font></div><div><font size="2"   >ANALYZE</font></div><div><font size="2"   >postgres=# analyze t3;</font></div><div><font size="2"   >ANALYZE</font></div><p></p></pre></div><div>重新测试，对于这种SQL，结果和前面是一样的，前面也分析过原因了。</div><div>CTE内部和CTE外部的视角差别造成的结果。而且从执行计划来看，CTE外部的SQL是后执行的，所以如果记录都被更改了，那么结果就是外部为准。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# explain with tm1(c1,c2) as (update t1 set id=t2.id from t2 where t1.info=t2.info returning t1.id,t1.info) update t1 set info=t3.info from t3 where t1.id=t3.id returning t1.id,t1.info;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Update on t1 &nbsp;(cost=2.10..4.21 rows=2 width=20)</font></div><div><font size="2"   >&nbsp; &nbsp;CTE tm1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;-&gt; &nbsp;Update on t1 t1_1 &nbsp;(cost=0.00..2.10 rows=2 width=20)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Nested Loop &nbsp;(cost=0.00..2.10 rows=2 width=20)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Join Filter: (t1_1.info = t2.info)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on t1 t1_1 &nbsp;(cost=0.00..1.02 rows=2 width=10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Materialize &nbsp;(cost=0.00..1.03 rows=2 width=14)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on t2 &nbsp;(cost=0.00..1.02 rows=2 width=14)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Nested Loop &nbsp;(cost=0.00..2.10 rows=2 width=20)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Join Filter: (t1.id = t3.id)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on t1 &nbsp;(cost=0.00..1.02 rows=2 width=10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Materialize &nbsp;(cost=0.00..1.03 rows=2 width=14)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on t3 &nbsp;(cost=0.00..1.02 rows=2 width=14)</font></div><div><font size="2"   >(13 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# with tm1(c1,c2) as (update t1 set id=t2.id from t2 where t1.info=t2.info returning t1.id,t1.info) update t1 set info=t3.info from t3 where t1.id=t3.id returning t1.id,t1.info;</font></div><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | abc</font></div><div><font size="2"   >&nbsp; 2 | test</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   >UPDATE 2</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select ctid,* from t1;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| id | info&nbsp;</font></div><div><font size="2"   >-------+----+------</font></div><div><font size="2"   >&nbsp;(0,3) | &nbsp;1 | abc</font></div><div><font size="2"   >&nbsp;(0,4) | &nbsp;2 | test</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div><br></div><div>但是，对于两个修改动作都在CTE中完成的这种写法，操作结果就和执行计划有关了。</div><div>下面的SQL和前面一样，只是执行计划不一样，结果也不一样。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# truncate t1;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >postgres=# insert into t1 values (1,'test'),(2,'abc');</font></div><div><font size="2"   >INSERT 0 2</font></div><div><font size="2"   >postgres=# analyze t1;</font></div><div><font size="2"   >ANALYZE</font></div><div><font size="2"   >postgres=# explain with tm1(c1,c2) as (update t1 set id=t2.id from t2 where t1.info=t2.info returning t1.id,t1.info), tm2(c3,c4) as (update t1 set info=t3.info from t3 where t1.id=t3.id returning t1.id,t1.info) select * from tm1,tm2;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Nested Loop &nbsp;(cost=4.21..4.35 rows=4 width=72)</font></div><div><font size="2"   >&nbsp; &nbsp;CTE tm1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;-&gt; &nbsp;Update on t1 &nbsp;(cost=0.00..2.10 rows=2 width=20)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Nested Loop &nbsp;(cost=0.00..2.10 rows=2 width=20)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Join Filter: (t1.info = t2.info)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on t1 &nbsp;(cost=0.00..1.02 rows=2 width=10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Materialize &nbsp;(cost=0.00..1.03 rows=2 width=14)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on t2 &nbsp;(cost=0.00..1.02 rows=2 width=14)</font></div><div><font size="2"   >&nbsp; &nbsp;CTE tm2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;-&gt; &nbsp;Update on t1 t1_1 &nbsp;(cost=0.00..2.10 rows=2 width=20)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Nested Loop &nbsp;(cost=0.00..2.10 rows=2 width=20)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Join Filter: (t1_1.id = t3.id)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on t1 t1_1 &nbsp;(cost=0.00..1.02 rows=2 width=10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Materialize &nbsp;(cost=0.00..1.03 rows=2 width=14)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on t3 &nbsp;(cost=0.00..1.02 rows=2 width=14)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;CTE Scan on tm1 &nbsp;(cost=0.00..0.04 rows=2 width=36)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;CTE Scan on tm2 &nbsp;(cost=0.00..0.04 rows=2 width=36)</font></div><div><font size="2"   >(17 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# with tm1(c1,c2) as (update t1 set id=t2.id from t2 where t1.info=t2.info returning t1.id,t1.info), tm2(c3,c4) as (update t1 set info=t3.info from t3 where t1.id=t3.id returning t1.id,t1.info) select * from tm1,tm2;</font></div><div><font size="2"   >&nbsp;c1 | &nbsp;c2 &nbsp;| c3 | &nbsp;c4 &nbsp;</font></div><div><font size="2"   >----+------+----+------</font></div><div><font size="2"   >&nbsp; 2 | test | &nbsp;2 | test</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select ctid,* from t1;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| id | info&nbsp;</font></div><div><font size="2"   >-------+----+------</font></div><div><font size="2"   >&nbsp;(0,3) | &nbsp;2 | test</font></div><div><font size="2"   >&nbsp;(0,4) | &nbsp;2 | test</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>分析：</div><div>CTE是同级别的，同时执行。所以对数据的修改就看谁更快。快慢取决于扫描方法，扫描顺序等。</div><div>这里的t1用到了全表扫描，关联用到了嵌套循环，注意全表扫描是从头开始的，这和执行结果至关重要。</div><div>所以：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >括号内是ctid</font></div><div><font size="2"   >t1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;t1(updated)</font></div><div><font size="2"   >(0,1) &nbsp;1, test; &nbsp; &nbsp; &nbsp; &nbsp;2, test; &nbsp; &nbsp; &nbsp; &nbsp; (0,3) &nbsp;2, test;</font></div><div><font size="2"   >(0,2) &nbsp;2, abc; &nbsp; &nbsp; &nbsp; &nbsp;3, abc; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >括号内是ctid</font></div><div><font size="2"   >t1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;t1(updated)</font></div><div><font size="2"   >(0,1) &nbsp;1, test; &nbsp; &nbsp; &nbsp; &nbsp;1, abc; &nbsp; &nbsp; &nbsp; &nbsp; 已被更新，迅速掠过</font></div><div><font size="2"   >(0,2) &nbsp;2, abc; &nbsp; &nbsp; &nbsp; &nbsp;2, test; &nbsp; &nbsp; &nbsp; &nbsp; (0,4) &nbsp;2, test;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >当CTE tm1 更新第二条记录时：</font></div><div><font size="2"   >t1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;t1(updated)</font></div><div><font size="2"   >(0,2) &nbsp;1, abc; &nbsp; &nbsp; &nbsp; &nbsp;2, test; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="line-height: 28px;"   >已被更新，迅速掠过</span></font></div><div><font size="2"   >所以最终的结果是：</font></div><div><font size="2"   >&nbsp;(0,3) | &nbsp;2 | test</font></div><div><font size="2"   >&nbsp;(0,4) | &nbsp;2 | test</font></div><p></p></pre></div><div><br></div><div>如果将t1表的两条记录的物理顺序颠倒，结果又不一样了。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# truncate t1;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >postgres=# insert into t1 values (2,'abc'),(1,'test');</font></div><div><font size="2"   >INSERT 0 2</font></div><div><font size="2"   >postgres=# analyze t1;</font></div><div><font size="2"   >ANALYZE</font></div><div><font size="2"   >postgres=# with tm1(c1,c2) as (update t1 set id=t2.id from t2 where t1.info=t2.info returning t1.id,t1.info),&nbsp;<span style="line-height: 28px;"   >tm2(c3,c4) as (update t1 set info=t3.info from t3 where t1.id=t3.id returning t1.id,t1.info)</span><span style="line-height: 28px;"   >&nbsp;select * from tm1,tm2;</span></font></div><div><font size="2"   >&nbsp;c1 | c2 &nbsp;| c3 | c4 &nbsp;</font></div><div><font size="2"   >----+-----+----+-----</font></div><div><font size="2"   >&nbsp; 3 | abc | &nbsp;1 | abc</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >即使将tm1,tm2颠倒结果一样。</font></div><div><font size="2"   >postgres=# truncate t1;<br>TRUNCATE TABLE<br>postgres=# insert into t1 values (2,'abc'),(1,'test');<br>INSERT 0 2<br>postgres=# with tm2(c3,c4) as (update t1 set info=t3.info from t3 where t1.id=t3.id returning t1.id,t1.info), tm1(c1,c2) as (update t1 set id=t2.id from t2 where t1.info=t2.info returning t1.id,t1.info) select * from tm1,tm2;<br> c1 | c2  | c3 | c4  <br>----+-----+----+-----<br>  3 | abc |  1 | abc<br>(1 row)</font></div></pre></div><div>所以，在CTE中有多个更新时，如果出现对同一条记录的多次更新，会得到意想不到的结果，需要特别注意。</div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/queries-with.html"   >http://www.postgresql.org/docs/devel/static/queries-with.html</a></div><div>手册中也有提到，不要在一条SQL中多次修改同一条记录，会有意想不到的结果。</div><div><span style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: 18.2399997711182px;"   >Trying to update the same row twice in a single statement is not supported. Only one of the modifications takes place, but it is not easy (and sometimes not possible) to reliably predict which one. This also applies to deleting a row that was already updated in the same statement: only the update is performed. Therefore you should generally avoid trying to modify a single row twice in a single statement. In particular avoid writing&nbsp;</span><tt style="line-height: 18.2399997711182px;"   >WITH</tt><span style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: 18.2399997711182px;"   >&nbsp;sub-statements that could affect the same rows changed by the main statement or a sibling sub-statement. The effects of such a statement will not be predictable.</span></div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="dont modify table multi-times in CTE, will cause bug. - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>