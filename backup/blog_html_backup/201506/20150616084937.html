<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">阿里云RDS for PostgreSQL试用报告 - 5</h2>
	<h5 id="">2015-06-16 8:49:37&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201551683422794/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">我们在连接阿里云RDS for PostgreSQL时，实际上并不是直接连接数据库的，而是通过了一个类似中间件的代理。<div>那么这个代理有没有连接池功能呢？通过测试发现，应该没有连接池的功能，所以如果你的业务系统如果是高并发的短事务，建议你在应用层启用连接池，如果不能启用，那么请在应用层自己假设一个连接池例如pgbouncer。<br><wbr><div>测试：</div><div>3433代理并不是全代理，所以我们看到客户端IP地址就是实际的客户端IP，而不是代理的IP。</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@xxx-&gt; psql &nbsp;-h xxxxxx.pg.rds.aliyuncs.com -p 3433 -U digoal postgres</font></div><div><font size="2"   >psql (9.4.3, server 9.4.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=&gt; select inet_server_addr(),inet_server_port(),inet_client_addr(),inet_client_port();</font></div><div><font size="2"   >&nbsp;inet_server_addr | inet_server_port | inet_client_addr | inet_client_port&nbsp;</font></div><div><font size="2"   >------------------+------------------+------------------+------------------</font></div><div><font size="2"   >&nbsp;10.151.133.24 &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3006 | 10.172.180.141 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;48520</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@xxx-&gt; netstat -anp|grep 3433</font></div><div><font size="2"   >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 10.172.180.141:48520 &nbsp; &nbsp; &nbsp; &nbsp;100.99.60.159:3433 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ESTABLISHED 29955/psql&nbsp;</font></div><p></p></pre></div><div>代理的IP是<span style="line-height: 28px;"   >100.99.60.159</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@xxx-&gt; dig xxxxxx.pg.rds.aliyuncs.com</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.23.rc1.el6_5.1 &lt;&lt;&gt;&gt; xxxxxx.pg.rds.aliyuncs.com</font></div><div><font size="2"   >;; global options: +cmd</font></div><div><font size="2"   >;; Got answer:</font></div><div><font size="2"   >;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 33061</font></div><div><font size="2"   >;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 3, ADDITIONAL: 4</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >;; QUESTION SECTION:</font></div><div><font size="2"   >;xxxxxx.pg.rds.aliyuncs.com. IN A</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >;; ANSWER SECTION:</font></div><div><font size="2"   >xxxxxx.pg.rds.aliyuncs.com. 60 IN A 100.99.60.159</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >;; AUTHORITY SECTION:</font></div><div><font size="2"   >rds.aliyuncs.com. &nbsp; &nbsp; &nbsp; 432000 &nbsp;IN &nbsp; &nbsp; &nbsp;NS &nbsp; &nbsp; &nbsp;ns5.aliyun.com.</font></div><div><font size="2"   >rds.aliyuncs.com. &nbsp; &nbsp; &nbsp; 432000 &nbsp;IN &nbsp; &nbsp; &nbsp;NS &nbsp; &nbsp; &nbsp;ns3.aliyun.com.</font></div><div><font size="2"   >rds.aliyuncs.com. &nbsp; &nbsp; &nbsp; 432000 &nbsp;IN &nbsp; &nbsp; &nbsp;NS &nbsp; &nbsp; &nbsp;ns4.aliyun.com.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >;; ADDITIONAL SECTION:</font></div><div><font size="2"   >ns3.aliyun.com. &nbsp; &nbsp; &nbsp; &nbsp; 432000 &nbsp;IN &nbsp; &nbsp; &nbsp;A &nbsp; &nbsp; &nbsp; 115.124.17.155</font></div><div><font size="2"   >ns4.aliyun.com. &nbsp; &nbsp; &nbsp; &nbsp; 432000 &nbsp;IN &nbsp; &nbsp; &nbsp;A &nbsp; &nbsp; &nbsp; 110.75.20.27</font></div><div><font size="2"   >ns5.aliyun.com. &nbsp; &nbsp; &nbsp; &nbsp; 432000 &nbsp;IN &nbsp; &nbsp; &nbsp;A &nbsp; &nbsp; &nbsp; 110.75.38.28</font></div><div><font size="2"   >ns5.aliyun.com. &nbsp; &nbsp; &nbsp; &nbsp; 432000 &nbsp;IN &nbsp; &nbsp; &nbsp;A &nbsp; &nbsp; &nbsp; 198.11.138.248</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >;; Query time: 0 msec</font></div><div><font size="2"   >;; SERVER: 10.202.72.118#53(10.202.72.118)</font></div><div><font size="2"   >;; WHEN: Tue Jun 16 08:36:46 2015</font></div><div><font size="2"   >;; MSG SIZE &nbsp;rcvd: 200</font></div><p></p></pre></div><div><br></div><div>短连接TPS测试结果：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@xxx-&gt; vi test.sql</font></div><div><font size="2"   >select 1;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pgbench -M extended -C -n -r -f ./test.sql -P 1 -c 88 -j 88 -T 30 -h xxxxxx.pg.rds.aliyuncs.com -p 3433 -U digoal</font></div><div><font size="2"   >progress: 1.0 s, 3201.8 tps, lat 2.234 ms stddev 0.372</font></div><div><font size="2"   >progress: 2.0 s, 3291.6 tps, lat 2.241 ms stddev 0.349</font></div><div><font size="2"   >progress: 3.0 s, 3352.2 tps, lat 2.250 ms stddev 0.370</font></div><div><font size="2"   >progress: 4.0 s, 3310.7 tps, lat 2.253 ms stddev 0.361</font></div><div><font size="2"   >progress: 5.0 s, 3316.0 tps, lat 2.369 ms stddev 0.528</font></div><div><font size="2"   >progress: 6.0 s, 3320.8 tps, lat 2.385 ms stddev 0.484</font></div><div><font size="2"   >progress: 7.0 s, 3310.0 tps, lat 2.398 ms stddev 0.480</font></div><div><font size="2"   >progress: 8.0 s, 3382.5 tps, lat 2.409 ms stddev 0.465</font></div><div><font size="2"   >progress: 9.0 s, 3333.0 tps, lat 2.412 ms stddev 0.475</font></div><div><font size="2"   >progress: 10.0 s, 3333.7 tps, lat 2.400 ms stddev 0.464</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@xxx-&gt; pgbench -M extended -C -n -r -f ./test.sql -P 1 -c 88 -j 88 -T 30 -h 100.99.60.159 -p 3433 -U digoal</font></div><div><font size="2"   >Password:&nbsp;</font></div><div><font size="2"   >progress: 1.0 s, 3433.3 tps, lat 2.290 ms stddev 0.378</font></div><div><font size="2"   >progress: 2.0 s, 3330.3 tps, lat 2.257 ms stddev 0.342</font></div><div><font size="2"   >progress: 3.0 s, 3326.6 tps, lat 2.273 ms stddev 0.453</font></div><div><font size="2"   >progress: 4.0 s, 3293.9 tps, lat 2.244 ms stddev 0.358</font></div><div><font size="2"   >progress: 5.0 s, 3343.6 tps, lat 2.276 ms stddev 0.352</font></div><div><font size="2"   >progress: 6.0 s, 3421.8 tps, lat 2.322 ms stddev 0.398</font></div><div><font size="2"   >progress: 7.0 s, 3611.0 tps, lat 2.475 ms stddev 0.493</font></div><div><font size="2"   >progress: 8.0 s, 3599.6 tps, lat 2.454 ms stddev 0.480</font></div><div><font size="2"   >progress: 9.0 s, 3554.5 tps, lat 2.458 ms stddev 0.476</font></div><div><font size="2"   >progress: 10.0 s, 3590.4 tps, lat 2.466 ms stddev 0.476</font></div><p></p></pre></div><div><br></div><div>长连接TPS测试结果：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@xxx-&gt; pgbench -M extended -n -r -f ./test.sql -P 1 -c 88 -j 88 -T 30 -h xxxxxx.pg.rds.aliyuncs.com -p 3433 -U digoal&nbsp;</font></div><div><font size="2"   >progress: 1.0 s, 46156.5 tps, lat 1.847 ms stddev 0.370</font></div><div><font size="2"   >progress: 2.0 s, 46477.1 tps, lat 1.892 ms stddev 0.238</font></div><div><font size="2"   >progress: 3.0 s, 46863.0 tps, lat 1.877 ms stddev 0.233</font></div><div><font size="2"   >progress: 4.0 s, 47023.7 tps, lat 1.870 ms stddev 0.282</font></div><div><font size="2"   >progress: 5.0 s, 44680.1 tps, lat 1.968 ms stddev 0.649</font></div><div><font size="2"   >progress: 6.0 s, 44693.4 tps, lat 1.967 ms stddev 0.600</font></div><div><font size="2"   >progress: 7.0 s, 46783.2 tps, lat 1.880 ms stddev 0.286</font></div><div><font size="2"   >progress: 8.0 s, 46629.4 tps, lat 1.886 ms stddev 0.249</font></div><div><font size="2"   >progress: 9.0 s, 46894.5 tps, lat 1.875 ms stddev 0.249</font></div><div><font size="2"   >progress: 10.0 s, 46838.3 tps, lat 1.877 ms stddev 0.274</font></div><div><font size="2"   >progress: 11.0 s, 46993.2 tps, lat 1.871 ms stddev 0.272</font></div><div><font size="2"   >progress: 12.0 s, 46889.7 tps, lat 1.875 ms stddev 0.248</font></div><div><font size="2"   >^C</font></div><div><font size="2"   >postgres@xxx-&gt; pgbench -M extended -n -r -f ./test.sql -P 1 -c 88 -j 88 -T 30 -h 100.99.60.159 -p 3433 -U digoal&nbsp;</font></div><div><font size="2"   >Password:&nbsp;</font></div><div><font size="2"   >progress: 1.0 s, 45056.3 tps, lat 1.907 ms stddev 0.669</font></div><div><font size="2"   >progress: 2.0 s, 46966.6 tps, lat 1.872 ms stddev 0.361</font></div><div><font size="2"   >progress: 3.0 s, 47453.7 tps, lat 1.853 ms stddev 0.249</font></div><div><font size="2"   >progress: 4.0 s, 46933.7 tps, lat 1.873 ms stddev 0.388</font></div><div><font size="2"   >progress: 5.0 s, 47332.4 tps, lat 1.858 ms stddev 0.267</font></div><div><font size="2"   >progress: 6.0 s, 46756.9 tps, lat 1.880 ms stddev 0.389</font></div><div><font size="2"   >progress: 7.0 s, 45291.0 tps, lat 1.942 ms stddev 0.628</font></div><div><font size="2"   >progress: 8.0 s, 47250.0 tps, lat 1.861 ms stddev 0.280</font></div><div><font size="2"   >progress: 9.0 s, 45621.5 tps, lat 1.927 ms stddev 0.581</font></div><div><font size="2"   >progress: 10.0 s, 45244.7 tps, lat 1.944 ms stddev 0.726</font></div><p></p></pre></div></div></div><div>进程模式相比线程模式，fork process开销大一点，所以高并发的短事务请求，建议使用连接池。</div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=pgbouncer.git;a=summary"   >http://git.postgresql.org/gitweb/?p=pgbouncer.git;a=summary</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="阿里云RDS for PostgreSQL试用报告 - 5 - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>