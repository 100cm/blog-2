<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Why "INSERT ... ON CONFLICT DO NOTHING/UPDATE" Good for performance</h2>
	<h5 id="">2015-06-23 16:32:31&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201552343231537/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div style="line-height: 28px;"   ><div style="line-height: 28px;"   >PostgreSQL 9.5 新增了存在则更新或啥也不干的原子操作。</div><div style="line-height: 28px;"   >这个特性有什么好处呢？</div><div style="line-height: 28px;"   >如果你的应用程序不做保护，直接插入，可能会导致大量的违反唯一约束的错误，这种错误除了会写数据库日志，还会带来一定的问题。</div><div style="line-height: 28px;"   >例子：</div><div style="line-height: 28px;"   ><pre class="prettyprint"   style="line-height: 28px;"   ><p style="line-height: 28px;"   ></p><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# create table uk_test(id int primary key,info text,crt_time timestamp);</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >CREATE TABLE</font></div></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# insert into uk_test values (1,'test',now());</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >INSERT 0 1</font></div></div><p style="line-height: 28px;"   ></p></pre></div></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   >下面插入几个违反唯一约束的报错。</div><div style="line-height: 28px;"   ><pre class="prettyprint"   style="line-height: 28px;"   ><p style="line-height: 28px;"   ></p><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# insert into uk_test values (1,'test',now());</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >ERROR: &nbsp;duplicate key value violates unique constraint "uk_test_pkey"</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >DETAIL: &nbsp;Key (id)=(1) already exists.</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# insert into uk_test values (1,'test',now());</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >ERROR: &nbsp;duplicate key value violates unique constraint "uk_test_pkey"</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >DETAIL: &nbsp;Key (id)=(1) already exists.</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# insert into uk_test values (1,'test',now());</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >ERROR: &nbsp;duplicate key value violates unique constraint "uk_test_pkey"</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >DETAIL: &nbsp;Key (id)=(1) already exists.</font></div><p style="line-height: 28px;"   ></p></pre></div><div style="line-height: 28px;"   >以上操作实际上已经形成了HEAP tuple，但是没有形成index linepoint，同时在clog中标记为事务失败。</div><div style="line-height: 28px;"   >这些其实是有负面影响的，</div><div style="line-height: 28px;"   >1. 消耗了事务号，我们知道事务号是一个UINT32的整型，每20亿必须做一次frozen。所以这种回滚事务实际上是浪费事务号的。</div><div style="line-height: 28px;"   >2. 浪费XLOG空间，虽然事务回滚了，但是同样形成了块的变更，在XLOG中也是有记录的。</div><div style="line-height: 28px;"   >3. 浪费了空间，同时还需要垃圾回收进程来回收它。</div><div style="line-height: 28px;"   >看看ctid就明白了。</div><div style="line-height: 28px;"   ><pre class="prettyprint"   style="line-height: 28px;"   ><p style="line-height: 28px;"   ></p><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# insert into uk_test values (2,'test',now());</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >INSERT 0 1</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# select ctid,* from uk_test ;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp;ctid &nbsp;| id | info | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >-------+----+------+----------------------------</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp;(0,1) | &nbsp;1 | test | 2015-06-23 15:00:33.452243</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp;(0,5) | &nbsp;2 | test | 2015-06-23 15:00:37.431145</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >(2 rows)</font></div><p style="line-height: 28px;"   ></p></pre></div></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >使用<span style="line-height: 28px;"   >on conflict ... do nothing;可以有效的避免垃圾的产生：</span></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   style="line-height: 28px;"   ><p style="line-height: 28px;"   ></p><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# truncate uk_test ;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >TRUNCATE TABLE</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# insert into uk_test values (1,'digoal',now()) on conflict on constraint uk_test_pkey do nothing;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >INSERT 0 1</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# insert into uk_test values (1,'digoal',now()) on conflict on constraint uk_test_pkey do nothing;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >INSERT 0 0</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# insert into uk_test values (1,'digoal',now()) on conflict on constraint uk_test_pkey do nothing;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >INSERT 0 0</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# insert into uk_test values (1,'digoal',now()) on conflict on constraint uk_test_pkey do nothing;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >INSERT 0 0</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# insert into uk_test values (1,'digoal',now()) on conflict on constraint uk_test_pkey do nothing;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >INSERT 0 0</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# insert into uk_test values (2,'test',now());</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >INSERT 0 1</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# select ctid,* from uk_test ;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp;ctid &nbsp;| id | &nbsp;info &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >-------+----+--------+----------------------------</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp;(0,1) | &nbsp;1 | digoal | 2015-06-23 15:00:59.137141</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp;(0,2) | &nbsp;2 | test &nbsp; | 2015-06-23 15:01:05.143134</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >(2 rows)</font></div><p style="line-height: 28px;"   ></p></pre></div><div style="line-height: 28px;"   >从上面的ctid可以看到，没有产生任何垃圾。</div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >使用<span style="line-height: 28px;"   >on constraint uk_test_pkey do update set info=excluded.info,crt_time=excluded.crt_time;，提供了原子操作，减少了应用和数据库的交互，对性能提升也是非常明显的。</span></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >更新操作和普通的更新没有区别，产生新的版本。</span></div><div style="line-height: 28px;"   ><pre class="prettyprint"   style="line-height: 28px;"   ><p style="line-height: 28px;"   ></p><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# insert into uk_test values (1,'digoal',now()) on conflict on constraint uk_test_pkey do update set info=excluded.info,crt_time=excluded.crt_time;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >INSERT 0 1</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# insert into uk_test values (1,'digoal',now()) on conflict on constraint uk_test_pkey do update set info=excluded.info,crt_time=excluded.crt_time;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >INSERT 0 1</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# select ctid,* from uk_test ;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp;ctid &nbsp;| id | &nbsp;info &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >-------+----+--------+----------------------------</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp;(0,2) | &nbsp;2 | test &nbsp; | 2015-06-23 15:01:05.143134</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp;(0,4) | &nbsp;1 | digoal | 2015-06-23 15:01:27.715183</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >(2 rows)</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><br style="line-height: 21px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# insert into uk_test values (1,'digoal',now()) on conflict on constraint uk_test_pkey do update set info=excluded.info,crt_time=excluded.crt_time;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >INSERT 0 1</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# select ctid,* from uk_test ;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp;ctid &nbsp;| id | &nbsp;info &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >-------+----+--------+----------------------------</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp;(0,2) | &nbsp;2 | test &nbsp; | 2015-06-23 15:01:05.143134</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp;(0,5) | &nbsp;1 | digoal | 2015-06-23 15:01:34.485177</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >(2 rows)</font></div></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><br style="line-height: 21px;"   ></font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# update uk_test set info='new',crt_time=now() where id=1;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >UPDATE 1</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# select ctid,* from uk_test ;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp;ctid &nbsp;| id | info | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >-------+----+------+----------------------------</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp;(0,2) | &nbsp;2 | test | 2015-06-23 15:01:05.143134</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp;(0,6) | &nbsp;1 | new &nbsp;| 2015-06-23 15:02:12.968176</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >(2 rows)</font></div></div><p style="line-height: 28px;"   ></p></pre></div></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >性能测试对比：</div><div style="line-height: 28px;"   >传统的最靠谱的存在则更新，不存在则插入的方法：</div><div style="line-height: 28px;"   ><pre class="prettyprint"   style="line-height: 28px;"   ><p style="line-height: 28px;"   ></p><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# create or replace function ins_update (v_id int) returns void as $$</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >declare</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >begin</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; perform 1 from uk_test where id=v_id limit 1;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; if found then</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; &nbsp; update uk_test set info='test',crt_time=now() where id=v_id;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; else</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; &nbsp; insert into uk_test values(v_id,'test',now());</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; end if;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; exception when others then</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; &nbsp; return;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >end;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >$$ language plpgsql;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >CREATE FUNCTION</font></div></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><br style="line-height: 21px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><br style="line-height: 21px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >性能：</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# select pg_stat_reset_single_table_counters('uk_test'::regclass);</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# truncate uk_test ;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# checkpoint;</font></div></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><br style="line-height: 21px;"   ></font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >pg95@db-172-16-3-150-&gt; vi test.sql</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >\setrandom id 1 5000000</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >select ins_update(:id);</font></div></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><br style="line-height: 21px;"   ></font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >pg95@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -P 1 -c 32 -j 32 -T 60</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 1.0 s, 44468.6 tps, lat 0.638 ms stddev 1.028</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 2.0 s, 46454.6 tps, lat 0.687 ms stddev 1.078</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 3.0 s, 46644.0 tps, lat 0.685 ms stddev 1.112</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 4.0 s, 46005.8 tps, lat 0.693 ms stddev 1.116</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 5.0 s, 45636.1 tps, lat 0.700 ms stddev 1.107</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 6.0 s, 45518.6 tps, lat 0.701 ms stddev 1.117</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 7.0 s, 45674.2 tps, lat 0.699 ms stddev 1.090</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 8.0 s, 45288.2 tps, lat 0.705 ms stddev 1.150</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 9.0 s, 45074.2 tps, lat 0.708 ms stddev 1.125</font></div></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >......</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 56.0 s, 36654.9 tps, lat 0.871 ms stddev 1.590</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 57.0 s, 36694.7 tps, lat 0.870 ms stddev 1.530</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 58.0 s, 36511.4 tps, lat 0.875 ms stddev 1.577</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 59.0 s, 37118.4 tps, lat 0.860 ms stddev 1.502</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 60.0 s, 36207.2 tps, lat 0.880 ms stddev 1.556</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >transaction type: Custom query</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >scaling factor: 1</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >query mode: prepared</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >number of clients: 32</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >number of threads: 32</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >duration: 60 s</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >number of transactions actually processed: 2456377</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >latency average: 0.778 ms</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >latency stddev: 1.327 ms</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >tps = 40934.377749 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >tps = 41005.456116 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >statement latencies in milliseconds:</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; &nbsp; &nbsp; &nbsp; -0.001878 &nbsp; &nbsp; &nbsp; \setrandom id 1 5000000</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.775430 &nbsp; &nbsp; &nbsp; &nbsp;select ins_update(:id);</font></div></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><br style="line-height: 21px;"   ></font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# select * from pg_stat_all_tables where relname='uk_test';</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >-[ RECORD 1 ]-------+------------------------------</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >relid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 16930</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >schemaname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| public</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | uk_test</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >seq_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >seq_tup_read &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >idx_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 13841219</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >idx_tup_fetch &nbsp; &nbsp; &nbsp; | 3655255</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >n_tup_ins &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 1941192</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >n_tup_upd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 515185</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >n_tup_del &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 0</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >n_tup_hot_upd &nbsp; &nbsp; &nbsp; | 482125</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >n_live_tup &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1941184</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >n_dead_tup &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 36686</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >n_mod_since_analyze | 0</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >last_vacuum &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >last_autovacuum &nbsp; &nbsp; | 2015-06-23 16:03:39.271969+08</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >last_analyze &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >last_autoanalyze &nbsp; &nbsp;| 2015-06-23 16:04:38.928135+08</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >vacuum_count &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >autovacuum_count &nbsp; &nbsp;| 1</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >analyze_count &nbsp; &nbsp; &nbsp; | 0</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >autoanalyze_count &nbsp; | 2</font></div></div><p style="line-height: 28px;"   ></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >使用insert into ... on conflict ... update set ...</div><div style="line-height: 28px;"   >性能：</div><div style="line-height: 28px;"   ><pre class="prettyprint"   style="line-height: 28px;"   ><p style="line-height: 28px;"   ></p><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# select pg_stat_reset_single_table_counters('uk_test'::regclass);</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# truncate uk_test ;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# checkpoint;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><br style="line-height: 21px;"   ></font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >pg95@db-172-16-3-150-&gt; vi test.sql</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >\setrandom id 1 5000000</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >insert into uk_test values (:id,'test',now()) on conflict on constraint uk_test_pkey do update set info=excluded.info,crt_time=excluded.crt_time;</font></div></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><br style="line-height: 21px;"   ></font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >pg95@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -P 1 -c 32 -j 32 -T 60</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 1.0 s, 62283.4 tps, lat 0.430 ms stddev 0.823</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 2.0 s, 64971.9 tps, lat 0.490 ms stddev 0.969</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 3.0 s, 65560.7 tps, lat 0.486 ms stddev 0.937</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 4.0 s, 64161.9 tps, lat 0.496 ms stddev 0.956</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 5.0 s, 64003.1 tps, lat 0.498 ms stddev 0.994</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 6.0 s, 63739.1 tps, lat 0.499 ms stddev 1.007</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 7.0 s, 62974.2 tps, lat 0.505 ms stddev 1.005</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 8.0 s, 62266.2 tps, lat 0.512 ms stddev 1.006</font></div></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >......</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 33.0 s, 53306.1 tps, lat 0.598 ms stddev 1.239</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 34.0 s, 52924.6 tps, lat 0.602 ms stddev 1.275</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 35.0 s, 52799.8 tps, lat 0.603 ms stddev 1.268</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 36.0 s, 52527.6 tps, lat 0.607 ms stddev 1.264</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 37.0 s, 51948.2 tps, lat 0.613 ms stddev 1.303</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 38.0 s, 51547.3 tps, lat 0.618 ms stddev 1.330</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 39.0 s, 50852.2 tps, lat 0.626 ms stddev 1.348</font></div></div></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >......</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 57.0 s, 45127.5 tps, lat 0.707 ms stddev 1.614</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 58.0 s, 44983.0 tps, lat 0.708 ms stddev 1.573</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 59.0 s, 45179.3 tps, lat 0.706 ms stddev 1.585</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >progress: 60.0 s, 45045.4 tps, lat 0.708 ms stddev 1.579</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >随着数据重复率越来越高，更新越来越多，TPS呈现下降趋势。</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><br style="line-height: 21px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >transaction type: Custom query</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >scaling factor: 1</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >query mode: prepared</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >number of clients: 32</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >number of threads: 32</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >duration: 60 s</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >number of transactions actually processed: 3237650</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >latency average: 0.589 ms</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >latency stddev: 1.264 ms</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >tps = 53954.428043 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >tps = 54087.133269 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >statement latencies in milliseconds:</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; &nbsp; &nbsp; &nbsp; -0.002449 &nbsp; &nbsp; &nbsp; \setrandom id 1 5000000</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.586167 &nbsp; &nbsp; &nbsp; &nbsp;insert into uk_test values (:id,'test',now()) on conflict on constraint uk_test_pkey do update set info=excluded.info,crt_time=excluded.crt_time;</font></div></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><br style="line-height: 21px;"   ></font></div></div></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><br style="line-height: 21px;"   ></font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >postgres=# select * from pg_stat_all_tables where relname='uk_test';</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >-[ RECORD 1 ]-------+------------------------------</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >relid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 16930</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >schemaname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| public</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | uk_test</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >seq_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >seq_tup_read &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >idx_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 10869657</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >idx_tup_fetch &nbsp; &nbsp; &nbsp; | 2624947</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >n_tup_ins &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2383669</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >n_tup_upd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 853982</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >n_tup_del &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 1</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >n_tup_hot_upd &nbsp; &nbsp; &nbsp; | 800533</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >n_live_tup &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2360714</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >n_dead_tup &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 27022</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >n_mod_since_analyze | 811433</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >last_vacuum &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >last_autovacuum &nbsp; &nbsp; | 2015-06-23 16:01:41.707076+08</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >last_analyze &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >last_autoanalyze &nbsp; &nbsp;| 2015-06-23 16:01:42.553299+08</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >vacuum_count &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >autovacuum_count &nbsp; &nbsp;| 1</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >analyze_count &nbsp; &nbsp; &nbsp; | 0</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >autoanalyze_count &nbsp; | 1</font></div></div></div><p style="line-height: 28px;"   ></p></pre></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >可以看到性能提升是非常明显的。</div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><span style="line-height: 28px;"   >[参考]</span><wbr style="line-height: 28px;"   ><div style="line-height: 28px;"   >1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-insert.html#SQL-ON-CONFLICT"   >http://www.postgresql.org/docs/devel/static/sql-insert.html#SQL-ON-CONFLICT</a></div><div style="line-height: 28px;"   >2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201541094137923/"   >http://blog.163.com/digoal@126/blog/static/163877040201541094137923/</a></div><a style="line-height: 28px;" rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="Why INSERT ... ON CONFLICT DO NOTHING/UPDATE Good for performance - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   style="line-height: 28px;"   ></a><wbr></div>
	</div>
</div>
</body>
</html>