<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">阿里云RDS for PostgreSQL试用报告 - 2</h2>
	<h5 id="">2015-06-11 14:56:17&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020155104492068/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>感谢阿里云提供了两台ECS用于测试，另外还要感谢PG社区的兄弟提供的16台RDS作为测试数据库。</div><div>测试使用2台ECS，以及16台最低配置（256MB shared_buffer, 5G空间, 100个连接）的RDS。ECS和RDS使用内网连接。</div><div><br></div><div>上一篇简单的测试了一下阿里云RDS PG的单节点，查询，更新，插入的性能，也针对参数梳理了一番不太合理或者对性能有影响的地方，有兴趣的同学可以参考：</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402015599230431/"   >http://blog.163.com/digoal@126/blog/static/1638770402015599230431/</a></div><div><br></div><div>接下来要测试一下使用pl/proxy 做分布式处理的性能。</div><div>大家可供参考，注意目前plproxy不支持跨库关联，仅仅是函数代理。</div><div>如果要做跨库事务需要结合PostgreSQL的prepared transaction(分布式事务/2PC)来实现，</div><div>如果要做跨库关联，可以用PostgreSQL的外部表，例如在每个节点上都建立其他节点需要关联的表的外部表，这样也可以做关联。</div><div>plproxy支持run on all,any,NR,HASH四种方式。</div><div>接下来我会一一测试 。&nbsp;</div><div><br></div><wbr><div><div><img title="阿里云RDS for PostgreSQL试用报告 - 2 - 德哥@Digoal - PostgreSQL research"   alt="阿里云RDS for PostgreSQL试用报告 - 2 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/77-4FEITQJhUYXf5sDV9cA==/6630168365188098922.png"   ></div><div><br></div>&nbsp;<div><img title="阿里云RDS for PostgreSQL试用报告 - 2 - 德哥@Digoal - PostgreSQL research"   alt="阿里云RDS for PostgreSQL试用报告 - 2 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/Ez-USBdkIQQGrwjYCYJGTw==/6630784091700045262.png"   ></div><br></div><div>部署ECS：</div><div>安装PostgreSQL 9.4.3，略。</div><div>安装plproxy，可参考</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013102242543765/"   >http://blog.163.com/digoal@126/blog/static/1638770402013102242543765/</a></div><div><pre class="prettyprint"   ><p></p><div><a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=plproxy.git;a=summary"   ><font size="2"   >http://git.postgresql.org/gitweb/?p=plproxy.git;a=summary</font></a></div><div><font size="2"   >cd plproxy</font></div><div><font size="2"   >export PATH=/opt/pgsql/bin:$PATH</font></div><div><font size="2"   >gmake</font></div><div><font size="2"   >gmake install</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >psql</font></div><div><font size="2"   >create extension plproxy;</font></div><p></p></pre></div><div><br></div><div><div>在plproxy代理节点部署数据库密码文件：</div><div>编辑密码文件，免输入密码。(主机名和密码以模糊化，一共有16台RDS)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># vi ~/.pgpass</font></div><div><font size="2"   >xxxx.pg.rds.aliyuncs.com:3433:*:digoal:xxxx</font></div><div><font size="2"   >xxxx.pg.rds.aliyuncs.com:3433:*:digoal:xxxx</font></div><div><font size="2"   >xxxx.pg.rds.aliyuncs.com:3433:*:digoal:xxxx</font></div><div><font size="2"   >xxxx.pg.rds.aliyuncs.com:3433:*:digoal:xxxx</font></div><div><font size="2"   >xxxx.pg.rds.aliyuncs.com:3433:*:digoal:xxxx</font></div><div><font size="2"   >xxxx.pg.rds.aliyuncs.com:3433:*:digoal:xxxx</font></div><div><font size="2"   >xxxx.pg.rds.aliyuncs.com:3433:*:digoal:xxxx</font></div><div><font size="2"   >xxxx.pg.rds.aliyuncs.com:3433:*:digoal:xxxx</font></div><div><font size="2"   >xxxx.pg.rds.aliyuncs.com:3433:*:digoal:xxxx</font></div><div><font size="2"   >xxxx.pg.rds.aliyuncs.com:3433:*:digoal:xxxx</font></div><div><font size="2"   >xxxx.pg.rds.aliyuncs.com:3433:*:renny:xxxx</font></div><div><font size="2"   >xxxx.pg.rds.aliyuncs.com:3433:*:postgres:xxxx</font></div><div><font size="2"   >xxxx.pg.rds.aliyuncs.com:3433:*:dbnosql:xxxx</font></div><div><font size="2"   >xxxx.pg.rds.aliyuncs.com:3433:*:dbuser:xxxx</font></div><div><font size="2"   >xxxx.pg.rds.aliyuncs.com:3433:*:dbuser:xxxx</font></div><div><font size="2"   >xxxx.pg.rds.aliyuncs.com:3433:*:dbuser:xxxx</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >chmod 400 ~/.pgpass</font></div></pre></div><div><span style="line-height: 28px;"   >创建server，用于部署plproxy前期管理远程数据库。</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >create extension dblink;</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   ><br></font></span></div><div><font size="2"   >CREATE SERVER p0 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx1.pg.rds.aliyuncs.com', dbname 'postgres', port '3433');</font></div><div><font size="2"   >CREATE SERVER p1 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx2.pg.rds.aliyuncs.com', dbname 'postgres', port '3433');</font></div><div><font size="2"   >CREATE SERVER p2 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx3.pg.rds.aliyuncs.com', dbname 'postgres', port '3433');</font></div><div><font size="2"   >CREATE SERVER p3 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx4.pg.rds.aliyuncs.com', dbname 'postgres', port '3433');</font></div><div><font size="2"   >CREATE SERVER p4 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx5.pg.rds.aliyuncs.com', dbname 'postgres', port '3433');</font></div><div><font size="2"   >CREATE SERVER p5 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx6.pg.rds.aliyuncs.com', dbname 'postgres', port '3433');</font></div><div><font size="2"   >CREATE SERVER p6 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx7.pg.rds.aliyuncs.com', dbname 'postgres', port '3433');</font></div><div><font size="2"   >CREATE SERVER p7 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx8.pg.rds.aliyuncs.com', dbname 'postgres', port '3433');</font></div><div><font size="2"   >CREATE SERVER p8 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx9.pg.rds.aliyuncs.com', dbname 'postgres', port '3433');</font></div><div><font size="2"   >CREATE SERVER p9 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx10.pg.rds.aliyuncs.com', dbname 'postgres', port '3433');</font></div><div><font size="2"   >CREATE SERVER p10 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx11.pg.rds.aliyuncs.com', dbname 'postgres', port '3433');</font></div><div><font size="2"   >CREATE SERVER p11 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx12.pg.rds.aliyuncs.com', dbname 'postgres', port '3433');</font></div><div><font size="2"   >CREATE SERVER p12 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx13.pg.rds.aliyuncs.com', dbname 'postgres', port '3433');</font></div><div><font size="2"   >CREATE SERVER p13 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx14.pg.rds.aliyuncs.com', dbname 'postgres', port '3433');</font></div><div><font size="2"   >CREATE SERVER p14 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx15.pg.rds.aliyuncs.com', dbname 'postgres', port '3433');</font></div><div><font size="2"   >CREATE SERVER p15 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx16.pg.rds.aliyuncs.com', dbname 'postgres', port '3433');</font></div><p></p></pre></div><div><br></div><div>创建user mapping</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p0 OPTIONS (user 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p1 OPTIONS (user 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p2 OPTIONS (user 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p3 OPTIONS (user 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p4 OPTIONS (user 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p5 OPTIONS (user 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p6 OPTIONS (user 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p7 OPTIONS (user 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p8 OPTIONS (user 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p9 OPTIONS (user 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p10 OPTIONS (user 'renny');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p11 OPTIONS (user 'postgres');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p12 OPTIONS (user 'dbnosql');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p13 OPTIONS (user 'dbuser');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p14 OPTIONS (user 'dbuser');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p15 OPTIONS (user 'dbuser');</font></div><p></p></pre></div><div><br></div><div>创建一个不报错的dblink建立函数，方便管理用：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace function new_dblink_connect(text,text) returns void as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; perform dblink_connect($1,$2);</font></div><div><font size="2"   >&nbsp; exception&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; when SQLSTATE '42710' then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; return;</font></div><div><font size="2"   >&nbsp; &nbsp; when others then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql;</font></div><p></p></pre></div><div><br></div><div>在16台数据节点分别创建2个数据库，一共32个数据库(db0,db16; db1,db17;, ..... db15,db31;)，将用于演示数据节点扩容。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; for i in 0..15 loop</font></div><div><font size="2"   >&nbsp; &nbsp; perform new_dblink_connect('p'||i||'_conn', 'p'||i);</font></div><div><font size="2"   >&nbsp; &nbsp; perform dblink_exec('p'||i||'_conn', 'create database db'||i, false);</font></div><div><font size="2"   >&nbsp; &nbsp; perform dblink_exec('p'||i||'_conn', 'create database db'||(i+16), false);</font></div><div><font size="2"   >&nbsp; &nbsp; perform dblink_disconnect('p'||i||'_conn');</font></div><div><font size="2"   >&nbsp; end loop;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><p></p></pre></div><div><br></div><div>修改server到对应的32个DB。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >alter server p0 options (set dbname 'db0');</font></div><div><font size="2"   >alter server p1 options (set dbname 'db1');</font></div><div><font size="2"   >alter server p2 options (set dbname 'db2');</font></div><div><font size="2"   >alter server p3 options (set dbname 'db3');</font></div><div><font size="2"   >alter server p4 options (set dbname 'db4');</font></div><div><font size="2"   >alter server p5 options (set dbname 'db5');</font></div><div><font size="2"   >alter server p6 options (set dbname 'db6');</font></div><div><font size="2"   >alter server p7 options (set dbname 'db7');</font></div><div><font size="2"   >alter server p8 options (set dbname 'db8');</font></div><div><font size="2"   >alter server p9 options (set dbname 'db9');</font></div><div><font size="2"   >alter server p10 options (set dbname 'db10');</font></div><div><font size="2"   >alter server p11 options (set dbname 'db11');</font></div><div><font size="2"   >alter server p12 options (set dbname 'db12');</font></div><div><font size="2"   >alter server p13 options (set dbname 'db13');</font></div><div><font size="2"   >alter server p14 options (set dbname 'db14');</font></div><div><font size="2"   >alter server p15 options (set dbname 'db15');</font></div><p></p></pre></div><div><br></div><div>新建剩余的DB。每个+16得到新的DB号。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE SERVER p16 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx1.pg.rds.aliyuncs.com', dbname 'db16', port '3433');</font></div><div><font size="2"   >CREATE SERVER p17 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx2.pg.rds.aliyuncs.com', dbname 'db17', port '3433');</font></div><div><font size="2"   >CREATE SERVER p18 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx3.pg.rds.aliyuncs.com', dbname 'db18', port '3433');</font></div><div><font size="2"   >CREATE SERVER p19 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx4.pg.rds.aliyuncs.com', dbname 'db19', port '3433');</font></div><div><font size="2"   >CREATE SERVER p20 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx5.pg.rds.aliyuncs.com', dbname 'db20', port '3433');</font></div><div><font size="2"   >CREATE SERVER p21 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx6.pg.rds.aliyuncs.com', dbname 'db21', port '3433');</font></div><div><font size="2"   >CREATE SERVER p22 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx7.pg.rds.aliyuncs.com', dbname 'db22', port '3433');</font></div><div><font size="2"   >CREATE SERVER p23 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx8.pg.rds.aliyuncs.com', dbname 'db23', port '3433');</font></div><div><font size="2"   >CREATE SERVER p24 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx9.pg.rds.aliyuncs.com', dbname 'db24', port '3433');</font></div><div><font size="2"   >CREATE SERVER p25 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx10.pg.rds.aliyuncs.com', dbname 'db25', port '3433');</font></div><div><font size="2"   >CREATE SERVER p26 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx11.pg.rds.aliyuncs.com', dbname 'db26', port '3433');</font></div><div><font size="2"   >CREATE SERVER p27 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx12.pg.rds.aliyuncs.com', dbname 'db27', port '3433');</font></div><div><font size="2"   >CREATE SERVER p28 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx13.pg.rds.aliyuncs.com', dbname 'db28', port '3433');</font></div><div><font size="2"   >CREATE SERVER p29 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx14.pg.rds.aliyuncs.com', dbname 'db29', port '3433');</font></div><div><font size="2"   >CREATE SERVER p30 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx15.pg.rds.aliyuncs.com', dbname 'db30', port '3433');</font></div><div><font size="2"   >CREATE SERVER p31 FOREIGN DATA WRAPPER dblink_fdw OPTIONS (host 'xxxx16.pg.rds.aliyuncs.com', dbname 'db31', port '3433');</font></div><p></p></pre></div><div><br></div><div>创建user mapping</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p16 OPTIONS (user 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p17 OPTIONS (user 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p18 OPTIONS (user 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p19 OPTIONS (user 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p20 OPTIONS (user 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p21 OPTIONS (user 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p22 OPTIONS (user 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p23 OPTIONS (user 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p24 OPTIONS (user 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p25 OPTIONS (user 'digoal');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p26 OPTIONS (user 'renny');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p27 OPTIONS (user 'postgres');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p28 OPTIONS (user 'dbnosql');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p29 OPTIONS (user 'dbuser');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p30 OPTIONS (user 'dbuser');</font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER p31 OPTIONS (user 'dbuser');</font></div><p></p></pre></div><div><br></div><div>增加一个application_name的参数，用于分辨节点：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >alter server p0 options (add application_name '0');</font></div><div><font size="2"   >alter server p1 options (add application_name '1');</font></div><div><font size="2"   >alter server p2 options (add application_name '2');</font></div><div><font size="2"   >alter server p3 options (add application_name '3');</font></div><div><font size="2"   >alter server p4 options (add application_name '4');</font></div><div><font size="2"   >alter server p5 options (add application_name '5');</font></div><div><font size="2"   >alter server p6 options (add application_name '6');</font></div><div><font size="2"   >alter server p7 options (add application_name '7');</font></div><div><font size="2"   >alter server p8 options (add application_name '8');</font></div><div><font size="2"   >alter server p9 options (add application_name '9');</font></div><div><font size="2"   >alter server p10 options (add application_name '10');</font></div><div><font size="2"   >alter server p11 options (add application_name '11');</font></div><div><font size="2"   >alter server p12 options (add application_name '12');</font></div><div><font size="2"   >alter server p13 options (add application_name '13');</font></div><div><font size="2"   >alter server p14 options (add application_name '14');</font></div><div><font size="2"   >alter server p15 options (add application_name '15');</font></div><div><font size="2"   >alter server p16 options (add application_name '16');</font></div><div><font size="2"   >alter server p17 options (add application_name '17');</font></div><div><font size="2"   >alter server p18 options (add application_name '18');</font></div><div><font size="2"   >alter server p19 options (add application_name '19');</font></div><div><font size="2"   >alter server p20 options (add application_name '20');</font></div><div><font size="2"   >alter server p21 options (add application_name '21');</font></div><div><font size="2"   >alter server p22 options (add application_name '22');</font></div><div><font size="2"   >alter server p23 options (add application_name '23');</font></div><div><font size="2"   >alter server p24 options (add application_name '24');</font></div><div><font size="2"   >alter server p25 options (add application_name '25');</font></div><div><font size="2"   >alter server p26 options (add application_name '26');</font></div><div><font size="2"   >alter server p27 options (add application_name '27');</font></div><div><font size="2"   >alter server p28 options (add application_name '28');</font></div><div><font size="2"   >alter server p29 options (add application_name '29');</font></div><div><font size="2"   >alter server p30 options (add application_name '30');</font></div><div><font size="2"   >alter server p31 options (add application_name '31');</font></div><p></p></pre></div><div><br></div><div>在16台数据节点的32个数据库，每个RDS跑两个数据库。(db0,db16; db1,db17;, ..... db15,db31;)：</div><div>1. 创建schema: digoal；</div><div>2. 创建动态函数，用于plproxy测试动态查询。</div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_sql text;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; v_sql := 'CREATE OR REPLACE FUNCTION digoal.dy(sql text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS SETOF record</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;STRICT</font></div><div><font size="2"   >&nbsp; &nbsp; AS $function$</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; declare</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; rec record;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; begin</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; for rec in execute sql loop</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return next rec;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; end loop;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end;</font></div><div><font size="2"   >&nbsp; &nbsp; $function$;';</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; for i in 0..31 loop</font></div><div><font size="2"   >&nbsp; &nbsp; perform new_dblink_connect('p'||i||'_conn', 'p'||i);</font></div><div><font size="2"   >&nbsp; &nbsp; perform dblink_exec('p'||i||'_conn', 'create schema digoal', false);</font></div><div><font size="2"   >&nbsp; &nbsp; perform dblink_exec('p'||i||'_conn', v_sql, false);</font></div><div><font size="2"   >&nbsp; &nbsp; perform dblink_disconnect('p'||i||'_conn');</font></div><div><font size="2"   >&nbsp; end loop;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >创建plproxy使用的集群，注意顺序：</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >CREATE SERVER rds_pg_cluster FOREIGN DATA WRAPPER plproxy options(</font></span></div><div><div><font size="2"   >connection_lifetime '1800',</font></div><div><font size="2"   >disable_binary &nbsp;'0',</font></div></div><div><font size="2"   >p0 'host=xxxx1.pg.rds.aliyuncs.com dbname=db0 port=3433 user=digoal keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=0',</font></div><div><font size="2"   >p1 'host=xxxx2.pg.rds.aliyuncs.com dbname=db1 port=3433 user=digoal keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=1',</font></div><div><font size="2"   >p2 'host=xxxx3.pg.rds.aliyuncs.com dbname=db2 port=3433 user=digoal keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=2',</font></div><div><font size="2"   >p3 'host=xxxx4.pg.rds.aliyuncs.com dbname=db3 port=3433 user=digoal keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=3',</font></div><div><font size="2"   >p4 'host=xxxx5.pg.rds.aliyuncs.com dbname=db4 port=3433 user=digoal keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=4',</font></div><div><font size="2"   >p5 'host=xxxx6.pg.rds.aliyuncs.com dbname=db5 port=3433 user=digoal keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=5',</font></div><div><font size="2"   >p6 'host=xxxx7.pg.rds.aliyuncs.com dbname=db6 port=3433 user=digoal keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=6',</font></div><div><font size="2"   >p7 'host=xxxx8.pg.rds.aliyuncs.com dbname=db7 port=3433 user=digoal keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=7',</font></div><div><font size="2"   >p8 'host=xxxx9.pg.rds.aliyuncs.com dbname=db8 port=3433 user=digoal keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=8',</font></div><div><font size="2"   >p9 'host=xxxx10.pg.rds.aliyuncs.com dbname=db9 port=3433 user=digoal keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=9',</font></div><div><font size="2"   >p10 'host=xxxx11.pg.rds.aliyuncs.com dbname=db10 port=3433 user=renny keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=10',</font></div><div><font size="2"   >p11 'host=xxxx12.pg.rds.aliyuncs.com dbname=db11 port=3433 user=postgres keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=11',</font></div><div><font size="2"   >p12 'host=xxxx13.pg.rds.aliyuncs.com dbname=db12 port=3433 user=dbnosql keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=12',</font></div><div><font size="2"   >p13 'host=xxxx14.pg.rds.aliyuncs.com dbname=db13 port=3433 user=dbuser keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=13',</font></div><div><font size="2"   >p14 'host=xxxx15.pg.rds.aliyuncs.com dbname=db14 port=3433 user=dbuser keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=14',</font></div><div><font size="2"   >p15 'host=xxxx16.pg.rds.aliyuncs.com dbname=db15 port=3433 user=dbuser keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=15',</font></div><div><font size="2"   >p16 'host=xxxx1.pg.rds.aliyuncs.com dbname=db16 port=3433 user=digoal keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=16',</font></div><div><font size="2"   >p17 'host=xxxx2.pg.rds.aliyuncs.com dbname=db17 port=3433 user=digoal keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=17',</font></div><div><font size="2"   >p18 'host=xxxx3.pg.rds.aliyuncs.com dbname=db18 port=3433 user=digoal keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=18',</font></div><div><font size="2"   >p19 'host=xxxx4.pg.rds.aliyuncs.com dbname=db19 port=3433 user=digoal keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=19',</font></div><div><font size="2"   >p20 'host=xxxx5.pg.rds.aliyuncs.com dbname=db20 port=3433 user=digoal keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=20',</font></div><div><font size="2"   >p21 'host=xxxx6.pg.rds.aliyuncs.com dbname=db21 port=3433 user=digoal keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=21',</font></div><div><font size="2"   >p22 'host=xxxx7.pg.rds.aliyuncs.com dbname=db22 port=3433 user=digoal keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=22',</font></div><div><font size="2"   >p23 'host=xxxx8.pg.rds.aliyuncs.com dbname=db23 port=3433 user=digoal keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=23',</font></div><div><font size="2"   >p24 'host=xxxx9.pg.rds.aliyuncs.com dbname=db24 port=3433 user=digoal keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=24',</font></div><div><font size="2"   >p25 'host=xxxx10.pg.rds.aliyuncs.com dbname=db25 port=3433 user=digoal keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=25',</font></div><div><font size="2"   >p26 'host=xxxx11.pg.rds.aliyuncs.com dbname=db26 port=3433 user=renny keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=26',</font></div><div><font size="2"   >p27 'host=xxxx12.pg.rds.aliyuncs.com dbname=db27 port=3433 user=postgres keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=27',</font></div><div><font size="2"   >p28 'host=xxxx13.pg.rds.aliyuncs.com dbname=db28 port=3433 user=dbnosql keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=28',</font></div><div><font size="2"   >p29 'host=xxxx14.pg.rds.aliyuncs.com dbname=db29 port=3433 user=dbuser keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=29',</font></div><div><font size="2"   >p30 'host=xxxx15.pg.rds.aliyuncs.com dbname=db30 port=3433 user=dbuser keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=30',</font></div><div><font size="2"   >p31 'host=xxxx16.pg.rds.aliyuncs.com dbname=db31 port=3433 user=dbuser keepalives_idle=30 keepalives_interval=10 keepalives_count=10 application_name=31'</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE USER MAPPING FOR public SERVER rds_pg_cluster;</font></div><p></p></pre></div><div><br></div><div>执行动态SQL的代理函数：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION dy(sql text) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;RETURNS SETOF record</font></div><div><font size="2"   >&nbsp;LANGUAGE plproxy</font></div><div><font size="2"   >&nbsp;STRICT</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >&nbsp; cluster 'rds_pg_cluster';</font></div><div><font size="2"   >&nbsp; run on all;</font></div><div><font size="2"   >&nbsp; target digoal.dy;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div>例子(IP已隐去部分)：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from dy('select inet_server_addr(),inet_server_port(),inet_client_addr(),inet_client_port(),count(*) from pg_stat_activity group by 1,2,3,4') as t(c1 inet,c2 int,c3 inet,c4 int,cnt int8) order by 1,2;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; c1 &nbsp; &nbsp; &nbsp; | &nbsp;c2 &nbsp;| &nbsp; &nbsp; &nbsp; c3 &nbsp; &nbsp; &nbsp; | &nbsp;c4 &nbsp; | cnt&nbsp;</font></div><div><font size="2"   >---------------+------+----------------+-------+-----</font></div><div><font size="2"   ><span style="line-height: 21px;"   > 10.151. | 3012 | 10.172. | 48477 |   2<br> 10.151. | 3012 | 10.172. | 48493 |   2<br> 10.151. | 3013 | 10.172. | 27255 |   3<br> 10.151. | 3013 | 10.172. | 27239 |   3<br> 10.151. | 3014 | 10.172. | 64573 |   2<br> 10.151. | 3014 | 10.172. | 64557 |   2<br> 10.151. | 3004 | 10.172. | 63958 |   2<br> 10.151. | 3004 | 10.172. | 63974 |   2<br> 10.151. | 3009 | 10.172. | 34966 |   3<br> 10.151. | 3009 | 10.172. | 34982 |   3<br> 10.151. | 3010 | 10.172. | 24074 |   2<br> 10.151. | 3010 | 10.172. | 24058 |   2<br> 10.151. | 3009 | 10.172. | 56821 |   2<br> 10.151. | 3009 | 10.172. | 56837 |   2<br> 10.151. | 3011 | 10.172. | 29265 |   3<br> 10.151. | 3011 | 10.172. | 29249 |   3<br> 10.151. | 3012 | 10.172. | 14945 |   2<br> 10.151. | 3012 | 10.172. | 14961 |   2<br> 10.151. | 3008 | 10.172. | 24139 |   2<br> 10.151. | 3008 | 10.172. | 24155 |   2<br> 10.151. | 3003 | 10.172. |  9419 |   2<br> 10.151. | 3003 | 10.172. |  9435 |   2<br> 10.151. | 3004 | 10.172. | 35252 |   2<br> 10.151. | 3004 | 10.172. | 35236 |   2<br> 10.151. | 3004 | 10.172. | 47530 |   2<br> 10.151. | 3004 | 10.172. | 47546 |   2<br> 10.151. | 3006 | 10.172. | 33434 |   2<br> 10.151. | 3006 | 10.172. | 33418 |   2<br> 10.151. | 3006 | 10.172. | 56858 |   2<br> 10.151. | 3006 | 10.172. | 56842 |   2<br> 10.151. | 3010 | 10.172. | 46645 |   2<br> 10.151. | 3010 | 10.172. | 46629 |   2<br>(32 rows)</span></font></div><p></p></pre></div><div>16个RDS，server IP有8个，难道北京A区目前只用了8台SERVER存放RDS FOR PostgreSQL ?</div><div><br></div><div>使用dblink在所有节点创建以下dy_ddl实体函数，用于执行DDL：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_sql text;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; v_sql := 'CREATE OR REPLACE FUNCTION digoal.dy_ddl(sql text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS VOID</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;STRICT</font></div><div><font size="2"   >&nbsp; &nbsp; AS $function$</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; declare</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; begin</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; execute sql;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; exception when others then return;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end;</font></div><div><font size="2"   >&nbsp; &nbsp; $function$;';</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; for i in 0..31 loop</font></div><div><font size="2"   >&nbsp; &nbsp; perform new_dblink_connect('p'||i||'_conn', 'p'||i);</font></div><div><font size="2"   >&nbsp; &nbsp; perform dblink_exec('p'||i||'_conn', v_sql, false);</font></div><div><font size="2"   >&nbsp; &nbsp; perform dblink_disconnect('p'||i||'_conn');</font></div><div><font size="2"   >&nbsp; end loop;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><p></p></pre></div><div><br></div><div>创建plproxy函数，代理DDL语句：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION dy_ddl(sql text) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;RETURNS setof void</font></div><div><font size="2"   >&nbsp;LANGUAGE plproxy</font></div><div><font size="2"   >&nbsp;STRICT</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >&nbsp; cluster 'rds_pg_cluster';</font></div><div><font size="2"   >&nbsp; run on all;</font></div><div><font size="2"   >&nbsp; target digoal.dy_ddl;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div><br></div><div>利用这个plproxy代理DDL函数在所有节点创建test表:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select dy_ddl('create table test(id int)');</font></div><div><font size="2"   >&nbsp;dy_ddl&nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp;......</font></div><div><font size="2"   >(32 rows)</font></div><div><font size="2"   >Time: 35.683 ms</font></div><p></p></pre></div><div><br></div><div>查询刚刚创建的test表:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from dy('select id from test') as t(id int);</font></div><div><font size="2"   >&nbsp;id&nbsp;</font></div><div><font size="2"   >----</font></div><div><font size="2"   >(0 rows)</font></div><div><font size="2"   >Time: 2.958 ms</font></div><p></p></pre></div><div><br></div><div>删除test表：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select dy_ddl('drop table test');</font></div><div></div><p></p></pre></div><div>接下来部署测试用例：</div><div>使用dblink，连接到不同的db创建测试表：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_sql text;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; for i in 0..31 loop</font></div><div><font size="2"   >&nbsp; &nbsp; perform new_dblink_connect('p'||i||'_conn', 'p'||i);</font></div><div><font size="2"   >&nbsp; &nbsp; v_sql := 'create table digoal.userinfo(dbid int default '||i||',userid int,info text)';</font></div><div><font size="2"   >&nbsp; &nbsp; perform dblink_exec('p'||i||'_conn', v_sql, false);</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; v_sql := 'create table digoal.session (dbid int default '||i||',userid int,last_login timestamp)';</font></div><div><font size="2"   >&nbsp; &nbsp; perform dblink_exec('p'||i||'_conn', v_sql, false);</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; v_sql := 'create table digoal.login_log (dbid int default '||i||',userid int,db_user name,client_addr inet,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;client_port int,server_addr inet,server_port int,login_time timestamp)';</font></div><div><font size="2"   >&nbsp; &nbsp; perform dblink_exec('p'||i||'_conn', v_sql, false);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; v_sql := 'create table digoal.tbl_small (userid int primary key,info text)';</font></div><div><font size="2"   >&nbsp; &nbsp; perform dblink_exec('p'||i||'_conn', v_sql, false);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; perform dblink_disconnect('p'||i||'_conn');</font></div><div><font size="2"   >&nbsp; end loop;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><p></p></pre></div><div><br></div><div>生成测试数据，每个库200万数据(每个RDS 400万)，一共6400万用户数据：</div><div>创建实体函数：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_sql text;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; v_sql := 'CREATE OR REPLACE FUNCTION digoal.dy_generate_test_ddl()</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS VOID</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;STRICT</font></div><div><font size="2"   >&nbsp; &nbsp; AS $function$</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; declare</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; node int;</font></div><div><font size="2"   ><span>	</span>sql text;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; begin</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; select application_name::int into node from pg_stat_activity where pid=pg_backend_pid();</font></div><div><font size="2"   ><span>	</span>sql := $a$insert into digoal.userinfo select $a$||node||$a$,generate_series($a$||node||$a$,32000000,32)$a$;</font></div><div><font size="2"   ><span>	</span>execute sql;</font></div><div><font size="2"   ><span>	</span>sql := $a$insert into digoal.session select dbid,userid from digoal.userinfo$a$;</font></div><div><font size="2"   ><span>	</span>execute sql;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; exception when others then return;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end;</font></div><div><font size="2"   >&nbsp; &nbsp; $function$;';</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; for i in 0..31 loop</font></div><div><font size="2"   >&nbsp; &nbsp; perform new_dblink_connect('p'||i||'_conn', 'p'||i);</font></div><div><font size="2"   >&nbsp; &nbsp; perform dblink_exec('p'||i||'_conn', v_sql, false);</font></div><div><font size="2"   >&nbsp; &nbsp; perform dblink_disconnect('p'||i||'_conn');</font></div><div><font size="2"   >&nbsp; end loop;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><p></p></pre></div><div><br></div><div>创建代理函数：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION dy_generate_test_ddl() &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;RETURNS setof void</font></div><div><font size="2"   >&nbsp;LANGUAGE plproxy</font></div><div><font size="2"   >&nbsp;STRICT</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >&nbsp; cluster 'rds_pg_cluster';</font></div><div><font size="2"   >&nbsp; run on all;</font></div><div><font size="2"   >&nbsp; target digoal.dy_generate_test_ddl;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div><br></div><div>调用代理函数，生成测试数据：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select dy_generate_test_ddl();</font></div><div></div><p></p></pre></div><div>创建主键：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select dy_ddl('alter table digoal.userinfo add constraint pk_userinfo primary key (userid)');</font></div><div><font size="2"   >select dy_ddl('alter table digoal.session add constraint pk_session primary key (userid)');</font></div><p></p></pre></div><div><br></div><div>生成用于run on any测试的小表数据（每个节点的数据量为50万）：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select dy_ddl('insert into digoal.tbl_small select generate_series(1,500000)');</font></div><div></div><p></p></pre></div><div>在psql中观察进度：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select * from dy('select application_name::int,query,now()-query_start from pg_stat_activity where state=$$active$$ andid&lt;&gt;pg_backend_pid()') as t(c1 int,c2 text,c3 interval) &nbsp;where c2 ~ 'dy_' order by 1;</font></div><div><font size="2"   >\watch 1</font></div><p></p></pre></div><div><br></div><div>创建实体测试函数以及对应的代理函数：</div><div>基于主键的查询, run on NR</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select dy_ddl('</font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION digoal.query_pk(IN i_userid int, OUT dbid int, OUT userid int, OUT info text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS record</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;STRICT</font></div><div><font size="2"   >&nbsp; &nbsp; AS $function$</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; declare</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; begin</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; select t.dbid,t.userid,t.info into dbid,userid,info from digoal.userinfo t where t.userid=i_userid;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end;</font></div><div><font size="2"   >&nbsp; &nbsp; $function$</font></div><div><font size="2"   >');</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION query_pk(IN i_userid int, OUT dbid int, OUT userid int, OUT info text) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;RETURNS setof record</font></div><div><font size="2"   >&nbsp;LANGUAGE plproxy</font></div><div><font size="2"   >&nbsp;STRICT</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >&nbsp; cluster 'rds_pg_cluster';</font></div><div><font size="2"   >&nbsp; run on i_userid;</font></div><div><font size="2"   >&nbsp; target digoal.query_pk;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div><br></div><div>插入, run on NR</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select dy_ddl('</font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION digoal.insert_log(IN i_userid int)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS void</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;STRICT</font></div><div><font size="2"   >&nbsp; &nbsp; AS $function$</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; declare</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; begin</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; set&nbsp;synchronous_commit=off;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; insert into digoal.login_log (userid,db_user,client_addr,client_port,server_addr,server_port,login_time)</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;values (i_userid,current_user,inet_client_addr(),inet_client_port(),inet_server_addr(),inet_server_port(),now());</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end;</font></div><div><font size="2"   >&nbsp; &nbsp; $function$</font></div><div><font size="2"   >');</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION insert_log(IN i_userid int) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;RETURNS void</font></div><div><font size="2"   >&nbsp;LANGUAGE plproxy</font></div><div><font size="2"   >&nbsp;STRICT</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >&nbsp; cluster 'rds_pg_cluster';</font></div><div><font size="2"   >&nbsp; run on i_userid;</font></div><div><font size="2"   >&nbsp; target digoal.insert_log;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div><br></div><div>基于主键的查询+插入, run on NR</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select dy_ddl('</font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION digoal.query_insert(IN i_userid int, OUT dbid int, OUT userid int, OUT info text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS record</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;STRICT</font></div><div><font size="2"   >&nbsp; &nbsp; AS $function$</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; declare</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; begin</font></div><div><span style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; set&nbsp;synchronous_commit=off;</font></span></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; select t.dbid,t.userid,t.info into dbid,userid,info from digoal.userinfo t where t.userid=i_userid;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; insert into digoal.login_log (userid,db_user,client_addr,client_port,server_addr,server_port,login_time)</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;values (i_userid,current_user,inet_client_addr(),inet_client_port(),inet_server_addr(),inet_server_port(),now());</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end;</font></div><div><font size="2"   >&nbsp; &nbsp; $function$</font></div><div><font size="2"   >');</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION query_insert(IN i_userid int, OUT dbid int, OUT userid int, OUT info text) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;RETURNS setof record</font></div><div><font size="2"   >&nbsp;LANGUAGE plproxy</font></div><div><font size="2"   >&nbsp;STRICT</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >&nbsp; cluster 'rds_pg_cluster';</font></div><div><font size="2"   >&nbsp; run on i_userid;</font></div><div><font size="2"   >&nbsp; target digoal.query_insert;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div><br></div><div>基于主键的更新, run on NR</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select dy_ddl('</font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION digoal.update_pk(IN i_userid int)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS void</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;STRICT</font></div><div><font size="2"   >&nbsp; &nbsp; AS $function$</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; declare</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; begin</font></div><div><span style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; set&nbsp;synchronous_commit=off;</font></span></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; update digoal.session t set last_login=now() where t.userid=i_userid;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end;</font></div><div><font size="2"   >&nbsp; &nbsp; $function$</font></div><div><font size="2"   >');</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION update_pk(IN i_userid int) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;RETURNS void</font></div><div><font size="2"   >&nbsp;LANGUAGE plproxy</font></div><div><font size="2"   >&nbsp;STRICT</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >&nbsp; cluster 'rds_pg_cluster';</font></div><div><font size="2"   >&nbsp; run on i_userid;</font></div><div><font size="2"   >&nbsp; target digoal.update_pk;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div><br></div><div>基于主键的查询+更新+插入, run on NR</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select dy_ddl('</font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION digoal.query_update_insert(IN i_userid int, OUT dbid int, OUT userid int, OUT info text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS record</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;STRICT</font></div><div><font size="2"   >&nbsp; &nbsp; AS $function$</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; declare</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; begin</font></div><div><span style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; set&nbsp;synchronous_commit=off;</font></span></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; select t.dbid,t.userid,t.info into dbid,userid,info from digoal.userinfo t where t.userid=i_userid;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; insert into digoal.login_log (userid,db_user,client_addr,client_port,server_addr,server_port,login_time)</font></div><div><font size="2"   ><span>	</span> &nbsp; &nbsp;values (i_userid,current_user,inet_client_addr(),inet_client_port(),inet_server_addr(),inet_server_port(),now());</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; update digoal.session t set last_login=now() where t.userid=i_userid;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end;</font></div><div><font size="2"   >&nbsp; &nbsp; $function$</font></div><div><font size="2"   >');</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION query_update_insert(IN i_userid int, OUT dbid int, OUT userid int, OUT info text) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;RETURNS setof record</font></div><div><font size="2"   >&nbsp;LANGUAGE plproxy</font></div><div><font size="2"   >&nbsp;STRICT</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >&nbsp; cluster 'rds_pg_cluster';</font></div><div><font size="2"   >&nbsp; run on i_userid;</font></div><div><font size="2"   >&nbsp; target digoal.query_update_insert;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div><br></div><div>count汇聚, run on ALL</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select sum(cnt) from (select cnt from dy('select count(*) from digoal.login_log') as t(cnt int8)) t;</font></div><div><span style="line-height: 28px;"   ><font size="2"   >select sum(cnt) from (select cnt from dy('select count(*) from digoal.userinfo') as t(cnt int8)) t;</font></span></div><p></p></pre></div><div><br></div><div>全量复制数据, run on ANY</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select dy_ddl('</font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION digoal.query_smalltbl(IN i_userid int, OUT userid int, OUT info text)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS record</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;STRICT</font></div><div><font size="2"   >&nbsp; &nbsp; AS $function$</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; declare</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; begin</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; select t.userid,t.info into userid,info from digoal.tbl_small t where t.userid=i_userid;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end;</font></div><div><font size="2"   >&nbsp; &nbsp; $function$</font></div><div><font size="2"   >');</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OR REPLACE FUNCTION query_smalltbl(IN i_userid int, OUT userid int, OUT info text) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;RETURNS setof record</font></div><div><font size="2"   >&nbsp;LANGUAGE plproxy</font></div><div><font size="2"   >&nbsp;STRICT</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >&nbsp; cluster 'rds_pg_cluster';</font></div><div><font size="2"   >&nbsp; run on ANY;</font></div><div><font size="2"   >&nbsp; target digoal.query_smalltbl;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div><br></div><div>测试：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select (query_pk(id)).* from generate_series(0,63) t(id) order by dbid;</font></div><div><font size="2"   >&nbsp;dbid | userid | info&nbsp;</font></div><div><font size="2"   >------+--------+------</font></div><div><font size="2"   >&nbsp; &nbsp; 0 | &nbsp; &nbsp; 32 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp;0 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; 1 | &nbsp; &nbsp; 33 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp;1 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp;2 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | &nbsp; &nbsp; 34 |&nbsp;</font></div><div><font size="2"   >......</font></div><div><font size="2"   >&nbsp; &nbsp;31 | &nbsp; &nbsp; 31 |&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;31 | &nbsp; &nbsp; 63 |&nbsp;</font></div><div><font size="2"   >(64 rows)</font></div><p></p></pre></div><div><br></div><div>测试基于主键的查询：</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp;vi test.sql</font></div><div><font size="2"   >\setrandom id 0 32000000</font></div><div><font size="2"   >select query_pk(:id);</font></div></div><div><div><font size="2"   >pgbench -M prepared -n -r -f ./test.sql -P 1 -c 45 -j 45 -T 30</font></div><div><font size="2"   >progress: 1.0 s, 10954.4 tps, lat 3.687 ms stddev 5.910</font></div><div><font size="2"   >progress: 2.0 s, 20403.0 tps, lat 2.008 ms stddev 0.553</font></div><div><font size="2"   >progress: 3.0 s, 20725.8 tps, lat 1.977 ms stddev 0.479</font></div><div><font size="2"   >progress: 4.0 s, 20365.1 tps, lat 2.012 ms stddev 0.527</font></div><div><font size="2"   >progress: 5.0 s, 20135.4 tps, lat 2.035 ms stddev 0.617</font></div><div><font size="2"   >progress: 6.0 s, 20722.6 tps, lat 1.977 ms stddev 0.450</font></div><div><font size="2"   >progress: 7.0 s, 20424.4 tps, lat 2.006 ms stddev 0.504</font></div><div><font size="2"   >progress: 8.0 s, 20631.0 tps, lat 1.985 ms stddev 0.507</font></div><div><font size="2"   >progress: 9.0 s, 20270.0 tps, lat 2.021 ms stddev 0.493</font></div><div><font size="2"   >progress: 10.0 s, 20190.1 tps, lat 2.030 ms stddev 0.492</font></div></div><div><font size="2"   >......</font></div><p></p></pre></div><div><br></div><div>测试插入：</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >vi test.sql</font></div><div><font size="2"   >\setrandom id 0 32000000</font></div><div><font size="2"   >select insert_log(:id);</font></div></div><div><div><font size="2"   >pgbench -M prepared -n -r -f ./test.sql -P 1 -c 45 -j 45 -T 30</font></div><div><font size="2"   >progress: 1.0 s, 11763.3 tps, lat 3.505 ms stddev 5.379</font></div><div><font size="2"   >progress: 2.0 s, 21192.4 tps, lat 1.980 ms stddev 0.748</font></div><div><font size="2"   >progress: 3.0 s, 21406.8 tps, lat 1.961 ms stddev 0.492</font></div><div><font size="2"   >progress: 4.0 s, 21471.7 tps, lat 1.954 ms stddev 0.484</font></div><div><font size="2"   >progress: 5.0 s, 21095.4 tps, lat 1.989 ms stddev 0.718</font></div><div><font size="2"   >progress: 6.0 s, 21494.3 tps, lat 1.953 ms stddev 0.458</font></div><div><font size="2"   >progress: 7.0 s, 21553.9 tps, lat 1.947 ms stddev 0.480</font></div><div><font size="2"   >progress: 8.0 s, 21600.1 tps, lat 1.942 ms stddev 0.471</font></div><div><font size="2"   >progress: 9.0 s, 21665.0 tps, lat 1.937 ms stddev 0.465</font></div><div><font size="2"   >progress: 10.0 s, 21635.1 tps, lat 1.940 ms stddev 0.495</font></div></div><div><font size="2"   >......</font></div><p></p></pre></div><div><br></div><div>测试基于主键的查询+插入</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >vi test.sql</font></div><div><font size="2"   >\setrandom id 0 32000000</font></div><div><font size="2"   >select query_insert(:id);</font></div></div><div><div><font size="2"   >pgbench -M prepared -n -r -f ./test.sql -P 1 -c 45 -j 45 -T 30</font></div><div><font size="2"   >progress: 1.0 s, 8624.2 tps, lat 4.604 ms stddev 7.918</font></div><div><font size="2"   >progress: 2.0 s, 19089.2 tps, lat 2.042 ms stddev 0.521</font></div><div><font size="2"   >progress: 3.0 s, 19272.3 tps, lat 2.022 ms stddev 0.579</font></div><div><font size="2"   >progress: 4.0 s, 19403.2 tps, lat 2.008 ms stddev 0.470</font></div><div><font size="2"   >progress: 5.0 s, 19129.1 tps, lat 2.037 ms stddev 0.485</font></div><div><font size="2"   >progress: 6.0 s, 19166.5 tps, lat 2.033 ms stddev 0.476</font></div><div><font size="2"   >progress: 7.0 s, 19490.7 tps, lat 1.999 ms stddev 0.455</font></div><div><font size="2"   >progress: 8.0 s, 19135.0 tps, lat 2.037 ms stddev 1.044</font></div><div><font size="2"   >progress: 9.0 s, 19213.7 tps, lat 2.029 ms stddev 0.529</font></div><div><font size="2"   >progress: 10.0 s, 19217.0 tps, lat 2.027 ms stddev 0.788</font></div></div><div><font size="2"   >......</font></div><p></p></pre></div><div><br></div><div>测试基于主键的更新</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >vi test.sql</font></div><div><font size="2"   >\setrandom id 0 32000000</font></div><div><font size="2"   >select update_pk(:id);</font></div></div><div><div><font size="2"   >pgbench -M prepared -n -r -f ./test.sql -P 1 -c 45 -j 45 -T 30</font></div><div><font size="2"   >progress: 1.0 s, 3490.1 tps, lat 11.086 ms stddev 11.913</font></div><div><font size="2"   >progress: 2.0 s, 5397.6 tps, lat 7.047 ms stddev 9.854</font></div><div><font size="2"   >progress: 15.6 s, 97.1 tps, lat 26.561 ms stddev 523.168</font></div><div><font size="2"   >progress: 15.6 s, 4886.8 tps, lat 8266.126 ms stddev 6532.652</font></div><div><font size="2"   >progress: 15.6 s, 9123.2 tps, lat 2978.012 ms stddev 5564.965</font></div><div><font size="2"   >progress: 15.7 s, 4682.6 tps, lat 4.406 ms stddev 3.083</font></div><div><font size="2"   >progress: 15.7 s, 6713.8 tps, lat 5.121 ms stddev 4.762</font></div><div><font size="2"   >progress: 15.7 s, 4390.4 tps, lat 8.206 ms stddev 8.209</font></div><div><font size="2"   >progress: 15.7 s, 9268.3 tps, lat 7.934 ms stddev 7.146</font></div><div><font size="2"   >progress: 15.7 s, 6483.0 tps, lat 5.530 ms stddev 6.171</font></div><div><font size="2"   >progress: 15.7 s, 11795.5 tps, lat 7.822 ms stddev 8.948</font></div><div><font size="2"   >progress: 15.7 s, 9453.8 tps, lat 3.019 ms stddev 2.223</font></div><div><font size="2"   >progress: 15.7 s, 10840.1 tps, lat 3.939 ms stddev 3.238</font></div><div><font size="2"   >progress: 15.7 s, 4992.6 tps, lat 6.111 ms stddev 7.013</font></div></div><div><font size="2"   >......</font></div><p></p></pre></div><div><br></div><div>测试基于主键的查询+更新+插入：</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >vi test.sql</font></div><div><font size="2"   >\setrandom id 0 32000000</font></div><div><font size="2"   >select query_update_insert(:id);</font></div></div><div><div><font size="2"   >pgbench -M prepared -n -r -f ./test.sql -P 1 -c 45 -j 45 -T 30</font></div><div><font size="2"   >progress: 1.0 s, 4175.8 tps, lat 10.137 ms stddev 14.241</font></div><div><span style="line-height: 28px;"   ><font size="2"   >progress: 2.0 s, 7094.9 tps, lat 5.901 ms stddev 9.459</font></span></div><div><font size="2"   >progress: 16.6 s, 236.7 tps, lat 87.273 ms stddev 1079.575</font></div><div><font size="2"   >progress: 16.6 s, 8608.3 tps, lat 4727.488 ms stddev 6682.745</font></div><div><font size="2"   >progress: 16.6 s, 10468.6 tps, lat 2716.975 ms stddev 5595.314</font></div><div><font size="2"   >progress: 16.7 s, 14217.1 tps, lat 2218.013 ms stddev 5155.964</font></div><div><font size="2"   >progress: 16.7 s, 10531.9 tps, lat 3.388 ms stddev 2.354</font></div><div><font size="2"   >progress: 16.7 s, 8932.4 tps, lat 3.128 ms stddev 1.638</font></div><div><font size="2"   >progress: 16.7 s, 9434.0 tps, lat 3.413 ms stddev 2.440</font></div><div><font size="2"   >progress: 16.7 s, 8694.5 tps, lat 4.435 ms stddev 4.919</font></div><div><font size="2"   >progress: 16.7 s, 9926.1 tps, lat 4.536 ms stddev 5.436</font></div><div><font size="2"   >progress: 16.7 s, 10110.3 tps, lat 4.008 ms stddev 3.918</font></div><div><font size="2"   >progress: 16.7 s, 8655.8 tps, lat 4.170 ms stddev 5.261</font></div><div><font size="2"   >progress: 16.7 s, 8436.7 tps, lat 2.633 ms stddev 1.674</font></div><div><font size="2"   >progress: 16.7 s, 7747.6 tps, lat 3.145 ms stddev 2.134</font></div><div><font size="2"   >progress: 16.7 s, 6092.3 tps, lat 7.418 ms stddev 9.344</font></div></div><div><font size="2"   >......</font></div><p></p></pre></div><div><div><br></div></div><div>测试聚合</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select sum(cnt) from (select cnt from dy('select count(*) from digoal.login_log') as t(cnt int8)) t;</font></div><div><font size="2"   >&nbsp; &nbsp;sum &nbsp;&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;7445856</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 53.389 ms</font></div></div><div><div><font size="2"   >postgres=# select sum(cnt) from (select cnt from dy('select count(*) from digoal.userinfo') as t(cnt int8)) t;</font></div><div><font size="2"   >&nbsp; &nbsp;sum &nbsp; &nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;32000001</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 196.146 ms</font></div></div><p></p></pre></div><div><br></div><div>测试run on any</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >vi test.sql</font></div><div><font size="2"   >\setrandom id 0 32000000</font></div><div><font size="2"   >select query_smalltbl(:id);</font></div></div><div><font size="2"   >pgbench -M prepared -n -r -f ./test.sql -P 1 -c 45 -j 45 -T 30</font></div><div><div><font size="2"   >progress: 1.0 s, 12066.0 tps, lat 3.342 ms stddev 5.300</font></div><div><font size="2"   >progress: 2.0 s, 20631.4 tps, lat 1.937 ms stddev 0.712</font></div><div><font size="2"   >progress: 3.0 s, 20776.5 tps, lat 1.924 ms stddev 0.584</font></div><div><font size="2"   >progress: 4.0 s, 20498.0 tps, lat 1.950 ms stddev 0.828</font></div><div><font size="2"   >progress: 5.0 s, 20785.4 tps, lat 1.923 ms stddev 0.490</font></div><div><font size="2"   >progress: 6.0 s, 20200.4 tps, lat 1.979 ms stddev 1.027</font></div><div><font size="2"   >progress: 7.0 s, 20957.9 tps, lat 1.907 ms stddev 0.460</font></div><div><font size="2"   >progress: 8.0 s, 21111.2 tps, lat 1.893 ms stddev 0.452</font></div><div><font size="2"   >progress: 9.0 s, 20940.5 tps, lat 1.908 ms stddev 0.461</font></div><div><font size="2"   >progress: 10.0 s, 20540.5 tps, lat 1.946 ms stddev 0.673</font></div></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >对比6400万数据在单一节点的性能提升，因为单节点下6400万数据已经远超出内存，同时RDS限制了IOPS，所以单节点下6400万数据的性能是很差的。</span></div><div><span style="line-height: 28px;"   >下篇再提供单RDS下的数据。</span></div><div><br></div><div>问题：</div><div>1. 偶尔会遇到中间件这层连接不通的问题(内网，不是外网)，再次执行又能通讯。例如:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ERROR: &nbsp;could not establish connection</font></div><div><font size="2"   >DETAIL: &nbsp;could not connect to server: Connection timed out</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Is the server running on host "xxxx.pg.rds.aliyuncs.com" (100.99.xxx.xxx) and accepting</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TCP/IP connections on port 3433?</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >Client 30 aborted in state 1: ERROR: &nbsp;PL/Proxy function public.query_pk(1): [db1] PQconnectPoll: could not connect to server: Connection timed out</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Is the server running on host "xxxx.pg.rds.aliyuncs.com" (100.98.xxx.xxx) and accepting</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TCP/IP connections on port 3433?</font></div></div><p></p></pre></div><div><br></div><div>2. 超时, 通过增加集群连接参数 keepalives_idle=30 keepalives_interval=10 keepalives_count=10</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ERROR: &nbsp;PL/Proxy function public.dy_generate_test_ddl(0): [db11] PQconsumeInput: server closed the connection unexpectedly</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; This probably means the server terminated abnormally</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; before or while processing the request.</font></div><p></p></pre></div><div><br></div><div>3. 尊敬的用户，您的RDS（实例名：rdxxxxxxx1，连接地址：）发生主备切换，请将您的应用程序重连，确保使用正常，如果您的应用程序有自动重连机制请忽略此邮件，谢谢。</div><div>&nbsp; &nbsp;不知道是不是因为负载引起的切换，如果是的话，可能主机并未按照负载峰值来估算跑多少实例，导致超跑了。</div><div>&nbsp; &nbsp;另外一种原因可能是超资源使用被主动KILL了？（这样就有点暴力了）</div><div>&nbsp; &nbsp;不管怎么样，个人认为只有故障才是切换的理由。</div><div><br></div><div>4. 因为RDS限制了最大连接数是100，而且还为超级用户保留了5个连接，然后我这里每个RDS上有两个数据节点库，所以在使用plproxy 测试时，最多能用的连接数是95/2=47.5。</div><div>超出将报错如下：</div><div><pre class="prettyprint"   ><p><font size="2"   >Client 46 aborted in state 1: ERROR: &nbsp;PL/Proxy function public.query_pk(1): [db4] PQconnectPoll: FATAL: &nbsp;remaining connection slots are reserved for non-replication superuser connections</font></p></pre></div><div>所以我这里测试只用45个连接，实际上对单个库，如果响应较慢，那么同一时间最多可能会用掉90个连接。</div><div><br></div><div>5. 本次测试更新性能的硬伤是在RDS的 IOPS和shared_buffers上，如果要上比较高并发的带数据更新需求的业务，建议购买足够的IOPS和内存的RDS，以获得好的性能。以下是一台性能较好的服务器下的benchmark数据，仅供参考：</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201541104656600/"   >http://blog.163.com/digoal@126/blog/static/163877040201541104656600/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020154431045764/"   >http://blog.163.com/digoal@126/blog/static/16387704020154431045764/</a></div></div><div><br></div><div>阿里云RDS监控平台的数据，我的控制台只有5个实例，不过基本上已经能够反映所有实例的情况了：</div><div>单个实例的数据基本上在shared buffer中，所以数据盘的IOPS是很小的。</div><div><div><img title="阿里云RDS for PostgreSQL试用报告 - 2 - 德哥@Digoal - PostgreSQL research"   alt="阿里云RDS for PostgreSQL试用报告 - 2 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/vtd-6uLjaqBrQKFX0v5Dzg==/6630514711350860846.png"   ></div>测试写，更新时xlog的IOPS很高，基本已经到大顶峰，但是使用了异步提交，所以影响较小。<div><img title="阿里云RDS for PostgreSQL试用报告 - 2 - 德哥@Digoal - PostgreSQL research"   alt="阿里云RDS for PostgreSQL试用报告 - 2 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/kjqXVBnYcaSFeJ97GjLEgA==/6630288211955536998.png"   ></div>单个实例在500MB左右。&nbsp;<div><img title="阿里云RDS for PostgreSQL试用报告 - 2 - 德哥@Digoal - PostgreSQL research"   alt="阿里云RDS for PostgreSQL试用报告 - 2 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/SbBu8ea6D598N5sScdoy3Q==/6630611468374497006.png"   ></div></div><div><br></div>[参考]<wbr>&nbsp;<div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=plproxy.git;a=summary"   >http://git.postgresql.org/gitweb/?p=plproxy.git;a=summary</a></div><div><div style="line-height: 28px;"   >2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201541104656600/"   >http://blog.163.com/digoal@126/blog/static/163877040201541104656600/</a></div><div style="line-height: 28px;"   >3.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020154431045764/"   >http://blog.163.com/digoal@126/blog/static/16387704020154431045764/</a></div></div><div>4.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402015599230431/"   >http://blog.163.com/digoal@126/blog/static/1638770402015599230431/</a></div><div>5.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013102242543765/"   >http://blog.163.com/digoal@126/blog/static/1638770402013102242543765/</a></div><div><a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="阿里云RDS for PostgreSQL试用报告 - 2 - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a><br></div></div>
	</div>
</div>
</body>
</html>