<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL auto cast int,int8,... to numeric when use overflow digital compare with it</h2>
	<h5 id="">2015-06-17 10:37:48&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402015517101830909/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>群里一位兄弟提到的一个问题，当表存储的是INT，或者其他如INT8类型时，如果用户请求的值溢出了，会导致不走索引，或者即使走索引也很慢。</div><div>例子：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create table t3(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# insert into t3 select generate_series(1,10000000);</font></div><div><font size="2"   >INSERT 0 10000000</font></div><div><font size="2"   >postgres=# create index idx_t3_id on t3(id);</font></div><div><font size="2"   >CREATE INDEX</font></div><p></p></pre></div><div>使用一个溢出的数字，范围扫描或者相等查询：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# explain analyze select * from t3 where id&gt;999999999999999999999999999999999;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Only Scan using idx_t3_id on t3 &nbsp;(cost=0.43..238213.43 rows=3333333 width=4) (actual time=4052.914..4052.914 rows=0 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: ((id)::numeric &gt; '999999999999999999999999999999999'::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp;Rows Removed by Filter: 10000000</font></div><div><font size="2"   >&nbsp; &nbsp;Heap Fetches: 10000000</font></div><div><font size="2"   >&nbsp;Planning time: 0.283 ms</font></div><div><font size="2"   >&nbsp;Execution time: 4052.944 ms</font></div><div><font size="2"   >(6 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# explain analyze select * from t3 where id=999999999999999999999999999999999;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Only Scan using idx_t3_id on t3 &nbsp;(cost=0.43..238213.43 rows=50000 width=4) (actual time=3907.391..3907.391 rows=0 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: ((id)::numeric = '999999999999999999999999999999999'::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp;Rows Removed by Filter: 10000000</font></div><div><font size="2"   >&nbsp; &nbsp;Heap Fetches: 10000000</font></div><div><font size="2"   >&nbsp;Planning time: 0.103 ms</font></div><div><font size="2"   >&nbsp;Execution time: 3907.421 ms</font></div><div><font size="2"   >(6 rows)</font></div><p></p></pre></div><div>因为这里的操作符是numeric op numeric, 即id和条件都自动转换为numeric了，而索引是int的，所以即使走索引，也需要filter，类似lossy index。因此效率极差。</div><div>那么怎么解决这个问题呢？</div><div>1. 修改SQL，强制条件使用与列类型一致。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# explain analyze select * from t3 where id=999999999999999999999999999999999::int;</font></div><div><font size="2"   >ERROR: &nbsp;int out of range</font></div><p></p></pre></div><div>2. 创建一个partial index来解决这个问题，这个索引是空索引，因为不会有任何引用。</div><div>范围使用溢出范围。(+-)2^31-1</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create index idx_t3_id_2 on t3(id) where id::numeric&lt;-2147483647 or id::numeric&gt;2147483647;</font></div><div><font size="2"   >CREATE INDEX</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# \dt+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | Name | Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp;Size &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+------+-------+----------+--------+-------------</font></div><div><font size="2"   >&nbsp;public | t3 &nbsp; | table | postgres | 344 MB |&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# \di+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp;Name &nbsp; &nbsp; | Type &nbsp;| &nbsp;Owner &nbsp; | Table | &nbsp;Size &nbsp; | Description&nbsp;</font></div><div><font size="2"   >--------+-------------+-------+----------+-------+---------+-------------</font></div><div><font size="2"   >&nbsp;public | idx_t3_id &nbsp; | index | postgres | t3 &nbsp; &nbsp;| 213 MB &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | idx_t3_id_2 | index | postgres | t3 &nbsp; &nbsp;| 32 kB &nbsp; |&nbsp;</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# explain analyze select * from t3 where id=999999999999999999999999999999999;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Only Scan using idx_t3_id_2 on t3 &nbsp;(cost=0.12..89453.47 rows=50000 width=4) (actual time=0.011..0.011 rows=0 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: ((id)::numeric = '999999999999999999999999999999999'::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp;Heap Fetches: 0</font></div><div><font size="2"   >&nbsp;Planning time: 0.343 ms</font></div><div><font size="2"   >&nbsp;Execution time: 0.038 ms</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div><div>OR</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create index idx_t3_id_3 on t3(cast(id as numeric)) where id::numeric&lt;-2147483647 or id::numeric&gt;2147483647;</font></div><div><font size="2"   >CREATE INDEX</font></div><p></p></pre></div><div><br></div><div>3. 当然，你也可以在应用程序端控制，过滤overflow的值。</div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL auto cast int,int8,... to numeric when use overflow digital compare with it - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>