<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Don't use subquery with UPDATE,DELETE (when many tuples return), use UPDATE ... set ... from ... where ; instead</h2>
	<h5 id="">2015-06-18 16:21:33&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201551841540326/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>一位网友使用<span style="line-height: 28px;"   >update t1 set info=(select info from t2 where t1.id=t2.id) where t1.id&lt;9999;</span><span style="line-height: 28px;"   >这种查询时，发现性能很低。</span></div><div><span style="line-height: 28px;"   >而单独执行</span><span style="line-height: 28px;"   >时很快的。</span></div><div>原因分析：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create table t1(id int,info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table t2(id int,info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# insert into t1 select generate_series(1,10000) ;</font></div><div><font size="2"   >INSERT 0 10000</font></div><div><font size="2"   >postgres=# insert into t2 select generate_series(1,1000) ;</font></div><div><font size="2"   >INSERT 0 1000</font></div></div><p></p></pre></div><div>这个SubPlan循环了9998次，慢就慢在这里，虽然单次subquery只需要0.132毫秒，乘以9998后就是1300多毫秒了。</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# explain (analyze,verbose,timing,buffers) update t1 set info=(select info from t2 where t1.id=t2.id) where t1.id&lt;9999;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Update on public.t1 &nbsp;(cost=0.00..145134.50 rows=9999 width=10) (actual time=1368.041..1368.041 rows=0 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=39870</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on public.t1 &nbsp;(cost=0.00..145134.50 rows=9999 width=10) (actual time=0.218..1337.192 rows=9998 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: t1.id, (SubPlan 1), t1.ctid</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (t1.id &lt; 9999)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Rows Removed by Filter: 2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buffers: shared hit=20020</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SubPlan 1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on public.t2 &nbsp;(cost=0.00..14.50 rows=1 width=32) (actual time=0.127..0.132 rows=0 loops=9998)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: t2.info</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (t1.id = t2.id)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Rows Removed by Filter: 1000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buffers: shared hit=19996</font></div><div><font size="2"   >&nbsp;Planning time: 0.095 ms</font></div><div><font size="2"   >&nbsp;Execution time: 1368.077 ms</font></div><div><font size="2"   >(15 rows)</font></div><p></p></pre></div><div>将SQL修改为update ... set ... from ... where ...;</div><div>LOOP消失，性能立马提升</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# explain (analyze,verbose,timing,buffers) update t1 set info=t2.info from t2 where t1.id=t2.id and t1.id&lt;9999;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Update on public.t1 &nbsp;(cost=24.50..221.00 rows=1000 width=48) (actual time=8.103..8.103 rows=0 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=1940</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Hash Join &nbsp;(cost=24.50..221.00 rows=1000 width=48) (actual time=0.569..5.295 rows=1000 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: t1.id, t2.info, t1.ctid, t2.ctid</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Hash Cond: (t1.id = t2.id)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buffers: shared hit=26</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on public.t1 &nbsp;(cost=0.00..149.00 rows=9999 width=10) (actual time=0.038..2.600 rows=9998 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: t1.id, t1.ctid</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (t1.id &lt; 9999)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Rows Removed by Filter: 2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buffers: shared hit=24</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Hash &nbsp;(cost=12.00..12.00 rows=1000 width=42) (actual time=0.518..0.518 rows=1000 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: t2.info, t2.ctid, t2.id</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buckets: 1024 &nbsp;Batches: 1 &nbsp;Memory Usage: 51kB</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buffers: shared hit=2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on public.t2 &nbsp;(cost=0.00..12.00 rows=1000 width=42) (actual time=0.025..0.240 rows=1000 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Output: t2.info, t2.ctid, t2.id</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buffers: shared hit=2</font></div><div><font size="2"   >&nbsp;Planning time: 0.237 ms</font></div><div><font size="2"   >&nbsp;Execution time: 8.156 ms</font></div><div><font size="2"   >(20 rows)</font></div><p></p></pre></div></div><div><br></div><div>对于多个子查询的修改例子：</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >update u_md_rs.s_tmp_zb010s_top4_show t1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;set sal_store_num_this = (select sal_store_num_this from u_md_rs.s_tmp_zb010s_top4_show t2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; where t1.region_no = t2.region_no</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; and t1.region_name = t2.region_name</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; and t2.product_code='total_sal_num'),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;inv_store_num = (select inv_store_num from u_md_rs.s_tmp_zb010s_top4_show t2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;where t1.region_no = t2.region_no</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;and t1.region_name = t2.region_name</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;and t2.product_code='total_inv_num')</font></div><div><font size="2"   >&nbsp; &nbsp;where t1.merge_flag='top';&nbsp;</font></div><p></p></pre></div><div>改为</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >update u_md_rs.s_tmp_zb010s_top4_show t1 set&nbsp;</font></div><div><font size="2"   >sal_store_num_this = case when t2.product_code='total_sal_num' then t2.sal_store_num_this else t1.sal_store_num_this end ,</font></div><div><font size="2"   >inv_store_num = case when t2.product_code='total_inv_num' then t2.inv_store_num else t1.inv_store_num end&nbsp;</font></div><div><font size="2"   >from s_tmp_zb010s_top4_show t2&nbsp;</font></div><div><font size="2"   >where t1.region_no = t2.region_no&nbsp;</font></div><div><font size="2"   >and t1.region_name = t2.region_name&nbsp;</font></div><div><font size="2"   >and t1.merge_flag='top'&nbsp;</font></div><div><font size="2"   >and (t2.product_code='total_sal_num' or t2.product_code='total_inv_num');</font></div><p></p></pre></div></div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="Dont use subquery with UPDATE,DELETE (when many tuples return), use UPDATE ... set ... from ... where ; instead - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>