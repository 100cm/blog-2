<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Convert PostgreSQL materialized view to normal table , modify catalog dictionary</h2>
	<h5 id="">2015-06-09 11:28:39&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201559105235803/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL的可编辑化字典为我们提供了很多便利，例如，我们在PostgreSQL中创建了一些物化视图，可以通过编辑字典，将其转化为普通的表使用。</div><div>例子:</div><div>创建MV的语法：</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \h create materialized view</font></div><div><font size="2"   >Command: &nbsp; &nbsp; CREATE MATERIALIZED VIEW</font></div><div><font size="2"   >Description: define a new materialized view</font></div><div><font size="2"   >Syntax:</font></div><div><font size="2"   >CREATE MATERIALIZED VIEW table_name</font></div><div><font size="2"   >&nbsp; &nbsp; [ (column_name [, ...] ) ]</font></div><div><font size="2"   >&nbsp; &nbsp; [ WITH ( storage_parameter [= value] [, ... ] ) ]</font></div><div><font size="2"   >&nbsp; &nbsp; [ TABLESPACE tablespace_name ]</font></div><div><font size="2"   >&nbsp; &nbsp; AS query</font></div><div><font size="2"   >&nbsp; &nbsp; [ WITH [ NO ] DATA ]</font></div><p></p></pre></div><div>创建基表</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create table p(id int primary key, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# insert into p select generate_series(1,1000),repeat(md5(random()::text),50000);<br>INSERT 0 1000</font></div><div><font size="2"   >postgres=# select pg_relation_size('mvp');<br> pg_relation_size <br>------------------<br>            65536<br>(1 row)<br><br>postgres=# select pg_total_relation_size('mvp');<br> pg_total_relation_size <br>------------------------<br>               22052864<br>(1 row)</font></div><p></p></pre></div><div>创建物化视图</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create materialized view mvp as select * from p;</font></div><div><font size="2"   >SELECT 1000</font></div><div><font size="2"   >postgres=# select count(*) from mvp;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;1000</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>查看物化视图的描述</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \d+ mvp</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Materialized view "public.mvp"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers | Storage &nbsp;| Stats target | Description&nbsp;</font></div><div><font size="2"   >--------+---------+-----------+----------+--------------+-------------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; | integer | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;info &nbsp; | text &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >View definition:</font></div><div><font size="2"   >&nbsp;SELECT p.id,</font></div><div><font size="2"   >&nbsp; &nbsp; p.info</font></div><div><font size="2"   >&nbsp; &nbsp;FROM p;</font></div><div><div style="line-height: 28px;"   ><font size="2"   >postgres=# \dmv</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;Schema | Name | &nbsp; &nbsp; &nbsp; Type &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >--------+------+-------------------+----------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;public | mvp &nbsp;| materialized view | postgres</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>对物化视图是不能执行DML的</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# delete from mvp;</font></div><div><font size="2"   >ERROR: &nbsp;cannot change materialized view "mvp"</font></div><p></p></pre></div><div>刷新没问题</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# refresh materialized view mvp;</font></div><div><font size="2"   >REFRESH MATERIALIZED VIEW</font></div><p></p></pre></div></div><div>接下来看看基表和物化视图的差别在哪里：</div><div><div><div><pre class="prettyprint"   ><p style="line-height: 28px;"   ></p><div><font size="2"   ><span style="line-height: 21px;"   >postgres=# select * from pg_class where relname in ('mvp', 'p');<br> relname | relnamespace | reltype | reloftype | relowner | relam | relfilenode | reltablespace | relpages | reltuples | relallvisibl<br>e | reltoastrelid | relhasindex | relisshared | relpersistence | relkind | relnatts | relchecks | relhasoids | relhaspkey | relhasru<br>les | relhastriggers | relhassubclass | relispopulated | relreplident | relfrozenxid | relminmxid | relacl | reloptions <br>---------+--------------+---------+-----------+----------+-------+-------------+---------------+----------+-----------+-------------<br>--+---------------+-------------+-------------+----------------+---------+----------+-----------+------------+------------+---------<br>----+----------------+----------------+----------------+--------------+--------------+------------+--------+------------<br> p       |         2200 |   24915 |         0 |       10 |     0 |       24919 |             0 |      125 |      1000 |             <br>0 |         24916 | f           | f           | p              | r       |        2 |         0 | f          | f          | f       <br>    | f              | f              | t              | d            |   2140665323 |          1 |        | <br> mvp     |         2200 |   24924 |         0 |       10 |     0 |       24922 |             0 |      125 |      1000 |             <br>0 |         24925 | f           | f           | p              | m       |        2 |         0 | f          | f          | t       <br>    | f              | f              | t              | d            |   2140665326 |          1 |        | <br>(2 rows)</span></font></div><p style="line-height: 28px;"   ></p></pre></div></div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >差别在这里：</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >relkind</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >relhasindex</font></div><div style="line-height: 28px;"   ><font size="2"   >relhaspkey</font></div><div style="line-height: 28px;"   ><font size="2"   >relhasrules</font></div></div><p></p></pre></div><div><div style="line-height: 28px;"   >其实最主要的就是对象类型，是否有重写规则。</div><div style="line-height: 28px;"   >把这两个改掉，同时删除对应的规则。</div><div style="line-height: 28px;"   >除此以外，还有依赖关系需要处理。pg_depend系统表记录了对象间的依赖关系。</div><div style="line-height: 28px;"   >这里我们看到的依赖关系是物化视图在pg_rewrite中的规则和对象mvp,p的依赖，所以必须清理掉。</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >postgres=# select oid from pg_rewrite where ev_class ='mvp'::regclass;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; oid &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >-------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;24928</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >postgres=# select classid::regclass,refclassid::regclass,refobjid::regclass,* from pg_depend where objid=24928;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; classid &nbsp; | refclassid | refobjid | classid | objid | objsubid | refclassid | refobjid | refobjsubid | deptype&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >------------+------------+----------+---------+-------+----------+------------+----------+-------------+---------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;pg_rewrite | pg_class &nbsp; | mvp &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;2618 | 24928 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; 1259 | &nbsp; &nbsp;24922 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | n</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;pg_rewrite | pg_class &nbsp; | p &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;2618 | 24928 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; 1259 | &nbsp; &nbsp;24913 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | n</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;pg_rewrite | pg_class &nbsp; | p &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;2618 | 24928 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; 1259 | &nbsp; &nbsp;24913 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 | n</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;pg_rewrite | pg_class &nbsp; | mvp &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;2618 | 24928 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; 1259 | &nbsp; &nbsp;24922 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | i</font></div><div style="line-height: 28px;"   ><font size="2"   >(4 rows)</font></div></div><p></p></pre></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><dt style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: normal;"   ><tt>DEPENDENCY_NORMAL</tt>&nbsp;(<tt>n</tt>)</dt><dd style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: normal;"   ><p style="font-size: 1em; line-height: 1.5em; margin: 1.2em 0em;"   >A normal relationship between separately-created objects. The dependent object can be dropped without affecting the referenced object. The referenced object can only be dropped by specifying&nbsp;<tt>CASCADE</tt>, in which case the dependent object is dropped, too. Example: a table column has a normal dependency on its data type.</p></dd></div><div style="line-height: 28px;"   ><dt style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: normal;"   ><tt>DEPENDENCY_INTERNAL</tt>&nbsp;(<tt>i</tt>)</dt><dd style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: normal;"   ><p style="font-size: 1em; line-height: 1.5em; margin: 1.2em 0em;"   >The dependent object was created as part of creation of the referenced object, and is really just a part of its internal implementation. A&nbsp;<tt>DROP</tt>&nbsp;of the dependent object will be disallowed outright (we'll tell the user to issue a&nbsp;<tt>DROP</tt>&nbsp;against the referenced object, instead). A&nbsp;<tt>DROP</tt>&nbsp;of the referenced object will be propagated through to drop the dependent object whether<tt>CASCADE</tt>&nbsp;is specified or not. Example: a trigger that's created to enforce a foreign-key constraint is made internally dependent on the constraint's&nbsp;<tt>pg_constraint</tt>&nbsp;entry.</p></dd></div></div></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >以下操作完成物化视图到表的转换：</span></div><div><pre class="prettyprint"   ><p style="line-height: 28px;"   ></p><div><font size="2"   ><span style="line-height: 21px;"   >postgres=# begin;<br>BEGIN<br>postgres=# delete from pg_depend where objid=(select oid from pg_rewrite where ev_class ='mvp'::regclass);<br>DELETE 4<br>postgres=# update pg_class set relhasrules=false,relkind='r' where relname='mvp';<br>UPDATE 1<br>postgres=# delete from pg_rewrite where ev_class = 'mvp'::regclass;<br>DELETE 1<br>postgres=# end;<br>COMMIT</span></font></div><p style="line-height: 28px;"   ></p></pre></div></div></div><div>现在，mvp已经是表了</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# \d+ mvp</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "public.mvp"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers | Storage &nbsp;| Stats target | Description&nbsp;</font></div><div><font size="2"   >--------+---------+-----------+----------+--------------+-------------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; | integer | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;info &nbsp; | text &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# \dmv</font></div><div><font size="2"   >No relations found.</font></div></div><p></p></pre></div><div>执行DML：</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from mvp limit 1;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----+----------------------------------</font></div><div><font size="2"   >&nbsp; 1 | e21975f390393d923193e77d249afe63</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# update mvp set info='new' where id=1;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# select * from mvp where id=1;</font></div><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | new</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>增加主键</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# alter table mvp add constraint pk_mvp primary key(id);</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >postgres=# \d+ mvp</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "public.mvp"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers | Storage &nbsp;| Stats target | Description&nbsp;</font></div><div><font size="2"   >--------+---------+-----------+----------+--------------+-------------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; | integer | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;info &nbsp; | text &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "pk_mvp" PRIMARY KEY, btree (id)</font></div><p></p></pre></div></div><div>查看更新后的pg_class：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from pg_class where relname='mvp';</font></div><div><font size="2"   >-[ RECORD 1 ]--+-----------</font></div><div><font size="2"   >relname &nbsp; &nbsp; &nbsp; &nbsp;| mvp</font></div><div><font size="2"   >relnamespace &nbsp; | 2200</font></div><div><font size="2"   >reltype &nbsp; &nbsp; &nbsp; &nbsp;| 24885</font></div><div><font size="2"   >reloftype &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"   >relowner &nbsp; &nbsp; &nbsp; | 10</font></div><div><font size="2"   >relam &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"   >relfilenode &nbsp; &nbsp;| 24890</font></div><div><font size="2"   >reltablespace &nbsp;| 0</font></div><div><font size="2"   >relpages &nbsp; &nbsp; &nbsp; | 21</font></div><div><font size="2"   >reltuples &nbsp; &nbsp; &nbsp;| 10000</font></div><div><font size="2"   >relallvisible &nbsp;| 0</font></div><div><font size="2"   >reltoastrelid &nbsp;| 26947  -- toast对象</font></div><div><font size="2"   >relhasindex &nbsp; &nbsp;| t</font></div><div><font size="2"   >relisshared &nbsp; &nbsp;| f</font></div><div><font size="2"   >relpersistence | p</font></div><div><font size="2"   >relkind &nbsp; &nbsp; &nbsp; &nbsp;| r &nbsp;-- 更新为表</font></div><div><font size="2"   >relnatts &nbsp; &nbsp; &nbsp; | 2</font></div><div><font size="2"   >relchecks &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"   >relhasoids &nbsp; &nbsp; | f</font></div><div><font size="2"   >relhaspkey &nbsp; &nbsp; | t</font></div><div><font size="2"   >relhasrules &nbsp; &nbsp;| f &nbsp;-- 无规则</font></div><div><font size="2"   >relhastriggers | f</font></div><div><font size="2"   >relhassubclass | f</font></div><div><font size="2"   >relispopulated | t</font></div><div><font size="2"   >relreplident &nbsp; | d</font></div><div><font size="2"   >relfrozenxid &nbsp; | 2140665293</font></div><div><font size="2"   >relminmxid &nbsp; &nbsp; | 1</font></div><div><font size="2"   >relacl &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >reloptions &nbsp; &nbsp; |&nbsp;</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >使用这种手法，我们非常容易的将物化视图转换为普通的表了。</span></div><div>可以用在迁移数据的案例中，例如在PostgreSQL 中创建oracle 外部表， 基于外部表创建物化视图，增量更新，将物化视图转换为表。</div><div>修改字典有风险，操作需谨慎～</div><div><br></div><div>删除正常：</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select pg_relation_filepath('mvp');</font></div><div><font size="2"   >&nbsp;pg_relation_filepath&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;base/12944/26944</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select pg_relation_filepath(26947);</font></div><div><font size="2"   >&nbsp;pg_relation_filepath&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;base/12944/26947</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# drop table p;</font></div><div><font size="2"   >DROP TABLE</font></div></div><div><div><font size="2"   >postgres=# drop table mvp;</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >postgres=# \q</font></div><div><font size="2"   >postgres@digoal-&gt; cd $PGDATA</font></div><div><font size="2"   >postgres@digoal-&gt; ll base/12944/26944*</font></div><div><font size="2"   >-rw-------. 1 postgres postgres 0 Jun &nbsp;9 16:22 base/12944/26944</font></div><div><font size="2"   >postgres@digoal-&gt; ll base/12944/26947*</font></div><div><font size="2"   >-rw-------. 1 postgres postgres 0 Jun &nbsp;9 16:22 base/12944/26947</font></div></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;pg_get_viewdef_worker@src/backend/utils/adt/ruleutils.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* Common code for by-OID and by-name variants of pg_get_viewdef</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static char *</font></div><div><font size="2"   >pg_get_viewdef_worker(Oid viewoid, int prettyFlags, int wrapColumn)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Datum &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; args[2];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nulls[2];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; spirc;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; HeapTuple &nbsp; &nbsp; &nbsp; ruletup;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TupleDesc &nbsp; &nbsp; &nbsp; rulettc;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; StringInfoData buf;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Do this first so that string is alloc'd in outer context not SPI's.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; initStringInfo(&amp;buf);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Connect to SPI manager</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (SPI_connect() != SPI_OK_CONNECT)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, "SPI_connect failed");</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* On the first call prepare the plan to lookup pg_rewrite. We read</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* pg_rewrite over the SPI manager instead of using the syscache to be</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* checked for read access on pg_rewrite.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (plan_getviewrule == NULL)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; argtypes[2];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SPIPlanPtr &nbsp; &nbsp; &nbsp;plan;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; argtypes[0] = OIDOID;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; argtypes[1] = NAMEOID;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; plan = SPI_prepare(query_getviewrule, 2, argtypes);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (plan == NULL)</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, "SPI_prepare failed for \"%s\"", query_getviewrule);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SPI_keepplan(plan);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; plan_getviewrule = plan;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Get the pg_rewrite tuple for the view's SELECT rule</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; args[0] = ObjectIdGetDatum(viewoid);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; args[1] = DirectFunctionCall1(namein, CStringGetDatum(ViewSelectRuleName));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; nulls[0] = ' ';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; nulls[1] = ' ';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; spirc = SPI_execute_plan(plan_getviewrule, args, nulls, true, 0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (spirc != SPI_OK_SELECT)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, "failed to get pg_rewrite tuple for view %u", viewoid);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (SPI_processed != 1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoString(&amp;buf, "Not a view");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Get the rule's definition and put it into executor's memory</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ruletup = SPI_tuptable-&gt;vals[0];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rulettc = SPI_tuptable-&gt;tupdesc;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; make_viewdef(&amp;buf, ruletup, rulettc, prettyFlags, wrapColumn);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Disconnect from SPI manager</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (SPI_finish() != SPI_OK_FINISH)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, "SPI_finish failed");</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return buf.data;</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/catalog-pg-class.html"   >http://www.postgresql.org/docs/9.4/static/catalog-pg-class.html</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/view-pg-matviews.html"   >http://www.postgresql.org/docs/9.4/static/view-pg-matviews.html</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/catalog-pg-rewrite.html"   >http://www.postgresql.org/docs/9.4/static/catalog-pg-rewrite.html</a></div><div>5.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/catalog-pg-depend.html"   >http://www.postgresql.org/docs/9.4/static/catalog-pg-depend.html</a></div><div>6.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/catalog-pg-shdepend.html"   >http://www.postgresql.org/docs/9.4/static/catalog-pg-shdepend.html</a><a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/catalog-pg-depend.html"   ><br></a><span style="line-height: 28px;"   >
</span><a style="line-height: 28px;" rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="Convert PostgreSQL materialized view to normal table , modify catalog dictionary - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div></div>
	</div>
</div>
</body>
</html>