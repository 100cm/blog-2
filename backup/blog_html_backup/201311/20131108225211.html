<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL incremental basebackup exp.</h2>
	<h5 id="">2013-11-08 22:52:11&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013108104214968/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>本文较老, 建议使用支持快照的文件系统如ZFS来实施基于块的增量备份.</div><div><br></div><div>PostgreSQL 物理文件备份一般分为$PGDATA(同时含所有表空间)的备份以及pg_xlog的归档文件的备份.</div><div>在做PITR数据恢复时会用到这两部分文件.&nbsp;</div><div>一般可按照数据库的xlog量以及数据库的io能力做好备份策略.</div><div>例如 :&nbsp;</div><div>方案一 :</div><div>1. 每周一次全备<span style="line-height: 28px;"   >$PGDATA(同时含所有表空间).</span></div><div><span style="line-height: 28px;"   >2. 以及pg_xlog的归档文件保存.</span></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >方案二 :&nbsp;</span></div><div><span style="line-height: 28px;"   >1. 使用rsync做</span><span style="line-height: 28px;"   >全备</span><span style="line-height: 28px;"   >$PGDATA(同时含所有表空间). 如果基础数据非常庞大的话, 可以使用rsync的增量传输功能, 减少网络拷贝量.</span></div><div><span style="line-height: 28px;"   >2.&nbsp;</span><span style="line-height: 28px;"   >以及pg_xlog的归档文件保存.</span></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >方案三 :&nbsp;</span></div><div>1. 对于逻辑上不会变化的表, 在freeze后, 可以封存. 只需要备份一次即可. 以此来减少备份量也是可以的.</div><div>freeze后, 所有的xid都会更改为frozenXid.(2)</div><div><br></div><div>方案三的操作流程,</div><div>1. 首先要在业务层面划分好不会变化的表&nbsp;</div><div>2. 对这些表做vacuum freeze处理, 同时执行checkpoint, 将脏块刷出缓存.</div><div>3. 找出这些表对应的filenode</div><div>4. 备份这些filenode, 同时记录好备份信息.</div><div>5. 下次做全量备份时, 排除这些filenode.</div><div>6. 还原时记得还原这些filenode.</div><div><br></div><div>找出这些表对应的filenode可以使用以下函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace function get_frozen_path(i_nsp name, i_relname name) returns setof text as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_path text;</font></div><div><font size="2"   >&nbsp; v_dir text;</font></div><div><font size="2"   >&nbsp; v_filenode text;</font></div><div><font size="2"   >&nbsp; v_regclass regclass;</font></div><div><font size="2"   >&nbsp; v_filename text;</font></div><div><font size="2"   >&nbsp; v_idx_oid oid;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; -- execute 'vacuum freeze '||i_nsp||'.'||i_relname;</font></div><div><font size="2"   >&nbsp; -- table</font></div><div><font size="2"   >&nbsp; v_regclass := (i_nsp||'.'||i_relname)::regclass;</font></div><div><font size="2"   >&nbsp; v_path := pg_relation_filepath(v_regclass);</font></div><div><font size="2"   >&nbsp; v_dir := substring(v_path, '(.*/)[0-9]+$');</font></div><div><font size="2"   >&nbsp; v_filenode := substring(v_path, '.*/([0-9]+)$');</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; for v_filename in select * from pg_ls_dir(v_dir) as t(ab) where ab ~ ('^'||v_filenode) and ab !~ ('^'||v_filenode||'[0-9]') order by 1 loop</font></div><div><font size="2"   >&nbsp; &nbsp; raise notice '%', v_dir||v_filename;</font></div><div><font size="2"   >&nbsp; end loop;</font></div><div><font size="2"   >&nbsp; -- table toast</font></div><div><font size="2"   >&nbsp; select reltoastrelid::regclass into v_regclass from pg_class where relnamespace=(select oid from pg_namespace where nspname=i_nsp) and relname=i_relname;</font></div><div><font size="2"   >&nbsp; v_path := pg_relation_filepath(v_regclass);</font></div><div><font size="2"   >&nbsp; v_dir := substring(v_path, '(.*/)[0-9]+$');</font></div><div><font size="2"   >&nbsp; v_filenode := substring(v_path, '.*/([0-9]+)$');</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; for v_filename in select * from pg_ls_dir(v_dir) as t(ab) where ab ~ ('^'||v_filenode) and ab !~ ('^'||v_filenode||'[0-9]') order by 1 loop</font></div><div><font size="2"   >&nbsp; &nbsp; raise notice '%', v_dir||v_filename;</font></div><div><font size="2"   >&nbsp; end loop;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; select reltoastidxid::regclass into v_regclass from pg_class where relnamespace=(select oid from pg_namespace where nspname=i_nsp) and relname=i_relname;</font></div><div><font size="2"   >&nbsp; v_path := pg_relation_filepath(v_regclass);</font></div><div><font size="2"   >&nbsp; v_dir := substring(v_path, '(.*/)[0-9]+$');</font></div><div><font size="2"   >&nbsp; v_filenode := substring(v_path, '.*/([0-9]+)$');</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; for v_filename in select * from pg_ls_dir(v_dir) as t(ab) where ab ~ ('^'||v_filenode) and ab !~ ('^'||v_filenode||'[0-9]') order by 1 loop</font></div><div><font size="2"   >&nbsp; &nbsp; raise notice '%', v_dir||v_filename;</font></div><div><font size="2"   >&nbsp; end loop;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; -- index</font></div><div><font size="2"   >&nbsp; for v_idx_oid in select indexrelid from pg_index where indrelid=(i_nsp||'.'||i_relname)::regclass loop</font></div><div><font size="2"   >&nbsp; -- table</font></div><div><font size="2"   >&nbsp; v_regclass := v_idx_oid;</font></div><div><font size="2"   >&nbsp; v_path := pg_relation_filepath(v_regclass);</font></div><div><font size="2"   >&nbsp; v_dir := substring(v_path, '(.*/)[0-9]+$');</font></div><div><font size="2"   >&nbsp; v_filenode := substring(v_path, '.*/([0-9]+)$');</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; for v_filename in select * from pg_ls_dir(v_dir) as t(ab) where ab ~ ('^'||v_filenode) and ab !~ ('^'||v_filenode||'[0-9]') order by 1 loop</font></div><div><font size="2"   >&nbsp; &nbsp; raise notice '%', v_dir||v_filename;</font></div><div><font size="2"   >&nbsp; end loop;</font></div><div><font size="2"   >&nbsp; -- table toast</font></div><div><font size="2"   >&nbsp; select reltoastrelid::regclass into v_regclass from pg_class where oid=v_idx_oid;</font></div><div><font size="2"   >&nbsp; v_path := pg_relation_filepath(v_regclass);</font></div><div><font size="2"   >&nbsp; v_dir := substring(v_path, '(.*/)[0-9]+$');</font></div><div><font size="2"   >&nbsp; v_filenode := substring(v_path, '.*/([0-9]+)$');</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; for v_filename in select * from pg_ls_dir(v_dir) as t(ab) where ab ~ ('^'||v_filenode) and ab !~ ('^'||v_filenode||'[0-9]') order by 1 loop</font></div><div><font size="2"   >&nbsp; &nbsp; raise notice '%', v_dir||v_filename;</font></div><div><font size="2"   >&nbsp; end loop;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; select reltoastidxid::regclass into v_regclass from pg_class where oid=v_idx_oid;</font></div><div><font size="2"   >&nbsp; v_path := pg_relation_filepath(v_regclass);</font></div><div><font size="2"   >&nbsp; v_dir := substring(v_path, '(.*/)[0-9]+$');</font></div><div><font size="2"   >&nbsp; v_filenode := substring(v_path, '.*/([0-9]+)$');</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; for v_filename in select * from pg_ls_dir(v_dir) as t(ab) where ab ~ ('^'||v_filenode) and ab !~ ('^'||v_filenode||'[0-9]') order by 1 loop</font></div><div><font size="2"   >&nbsp; &nbsp; raise notice '%', v_dir||v_filename;</font></div><div><font size="2"   >&nbsp; end loop;</font></div><div><font size="2"   >&nbsp; end loop;</font></div><div><font size="2"   >end</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div><p></p></pre></div></div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><div><div><font size="2"   >digoal=# \dt+ t</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp; Schema &nbsp;| Name | Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp;Size &nbsp; | Description&nbsp;</font></div><div><font size="2"   >----------+------+-------+----------+---------+-------------</font></div><div><font size="2"   >&nbsp;postgres | t &nbsp; &nbsp;| table | postgres | 8475 MB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# \di+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp; Schema &nbsp;| &nbsp; Name &nbsp; | Type &nbsp;| &nbsp;Owner &nbsp; | Table | &nbsp;Size &nbsp; | Description&nbsp;</font></div><div><font size="2"   >----------+----------+-------+----------+-------+---------+-------------</font></div><div><font size="2"   >&nbsp;postgres | idx_t_c1 | index | postgres | t &nbsp; &nbsp; | 1099 MB |&nbsp;</font></div><div><font size="2"   >&nbsp;postgres | idx_t_c2 | index | postgres | t &nbsp; &nbsp; | 9661 MB |&nbsp;</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# \d t</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Unlogged table "postgres.t"</font></div><div><font size="2"   >&nbsp;Column | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >--------+-----------------------------+-----------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;c1 &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;c2 &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;c3 &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;c4 &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;c5 &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;c6 &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;c7 &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;c8 &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;c9 &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;c10 &nbsp; &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;c11 &nbsp; &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;c12 &nbsp; &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;c13 &nbsp; &nbsp;| timestamp without time zone |&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "idx_t_c1" btree (c1)</font></div><div><font size="2"   >&nbsp; &nbsp; "idx_t_c2" btree (c1, c2, c3, c4, c5, c6, c7, c8, c9, c10, c11, c12)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# select get_frozen_path('postgres','t');</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66447</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66447.1</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66447.2</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66447.3</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66447.4</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66447.5</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66447.6</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66447.7</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66447.8</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66447_fsm</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66447_init</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66447_vm</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66448</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66546</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66546.1</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66546.2</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66546.3</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66546.4</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66546.5</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66546.6</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66546.7</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66546.8</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66546.9</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66546_init</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66545</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66545.1</font></div><div><font size="2"   >NOTICE: &nbsp;pg_tblspc/66422/PG_9.3_201306121/16384/66545_init</font></div><div><font size="2"   >&nbsp;get_frozen_path&nbsp;</font></div><div><font size="2"   >-----------------</font></div><div><font size="2"   >(0 rows)</font></div></div><p></p></pre></div><div>这些就是涉及的filenode, 一次备份即可.</div><div><br></div><wbr></div>
	</div>
</div>
</body>
</html>