<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">USE blockdev --setra 0 and systemtap test real BLOCKDEV iops</h2>
	<h5 id="">2013-11-26 14:42:42&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013102621826954/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>我在上一篇文章中讨论了关于调整CPU亲和来降低systemtap带来的性能影响, 本文是一个扩展, 还是用到那个例子, 但是我增加了IO响应时间的柱状图输出, 从柱状图分析IO的一些"奇妙"的东西.</div><div>首先启动数据库, 亲和设置为1</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; taskset -c 1 /home/pg93/pgsql9.3.1/bin/postgres &gt;/dev/null 2&gt;&amp;1</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >然后清除OS CACHE</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# sync; echo 3 &gt; /proc/sys/vm/drop_caches</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >然后启动psql</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.3.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select pg_backend_pid();</font></div><div><font size="2"   >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5167</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>然后启动stap</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# taskset -c 7 stap -e '</font></div><div><font size="2"   >global a</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__start") {</font></div><div><font size="2"   >&nbsp; delete a</font></div><div><font size="2"   >&nbsp; println("query__start ", user_string($arg1), "pid:", pid())</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe vfs.read.return {</font></div><div><font size="2"   >&nbsp; t = gettimeofday_ns() - @entry(gettimeofday_ns())</font></div><div><font size="2"   >&nbsp; # if (execname() == "postgres" &amp;&amp; devname != "N/A")</font></div><div><font size="2"   >&nbsp; &nbsp; a[pid()] &lt;&lt;&lt; t</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__done") {</font></div><div><font size="2"   >&nbsp; if (@count(a[pid()]))&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; printdln("**", pid(), @count(a[pid()]), @avg(a[pid()]))</font></div><div><font size="2"   >&nbsp; println("query__done ", user_string($arg1), "pid:", pid())</font></div><div><font size="2"   >&nbsp; if (@count(a[pid()])) {</font></div><div><font size="2"   >&nbsp; &nbsp; println(@hist_log(a[pid()]))</font></div><div><font size="2"   >&nbsp; &nbsp; #println(@hist_linear(a[pid()],1024,4096,100))</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >&nbsp; delete a</font></div><div><font size="2"   >}' -x 5167</font></div><p></p></pre></div><div>然后执行一条查询</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----</font></div><div><font size="2"   >&nbsp;Seq Scan on postgres.tbl_cost_align &nbsp;(cost=0.00..195393.00 rows=10100000 width=45) (actual time=0.683..3252.479 rows=10100000 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared read=94393</font></div><div><font size="2"   >&nbsp;Total runtime: 4325.405 ms</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div><div>stap的输出如下</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >query__start explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:5167</font></div><div><font size="2"   >5167**94418**14464</font></div><div><font size="2"   >query__done explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:5167</font></div><div><font size="2"   >&nbsp; value |-------------------------------------------------- count</font></div><div><font size="2"   >&nbsp; &nbsp;1024 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp;2048 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp;4096 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 109</font></div><div><font size="2"   >&nbsp; &nbsp;8192 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ &nbsp;86181</font></div><div><font size="2"   >&nbsp; 16384 |@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2045</font></div><div><font size="2"   >&nbsp; 32768 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;90</font></div><div><font size="2"   >&nbsp; 65536 |@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5903</font></div><div><font size="2"   >&nbsp;131072 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;72</font></div><div><font size="2"   >&nbsp;262144 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 7</font></div><div><font size="2"   >&nbsp;524288 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 9</font></div><div><font size="2"   >1048576 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >2097152 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >4194304 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >8388608 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><p></p></pre></div><div>平均的IO响应时间为14464纳秒.</div><div>但是从IO响应时间分布图, 我们看到了比较奇妙的现象.</div><div>响应时间在8192纳秒以内的操作数有86181次, 占了所有IO的绝大部分.</div><div>而另一较大部分<span style="line-height: 28px;"   >32768</span><span style="line-height: 28px;"   >&nbsp;到</span><span style="line-height: 28px;"   >65536纳秒之间的操作数</span><span style="line-height: 28px;"   >是</span><span style="line-height: 28px;"   >5903个.</span></div><div><span style="line-height: 28px;"   >这是为什么呢? 原因是块设备的预读.</span></div><div><span style="line-height: 28px;"   >例如本例的</span><span style="line-height: 28px;"   >tbl_cost_align表对应的</span><span style="line-height: 28px;"   >磁盘为</span><span style="line-height: 28px;"   >/dev/sdb</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \db</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of tablespaces</font></div><div><font size="2"   >&nbsp; &nbsp; Name &nbsp; &nbsp;| &nbsp;Owner &nbsp; | &nbsp; &nbsp; &nbsp; Location &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------+----------+-----------------------</font></div><div><font size="2"   >&nbsp;pg_default | postgres |&nbsp;</font></div><div><font size="2"   >&nbsp;pg_global &nbsp;| postgres |&nbsp;</font></div><div><font size="2"   >&nbsp;tbs_digoal | postgres | /ssd3/pg93/tbs_digoal</font></div><div><font size="2"   >&nbsp;tbs_idx &nbsp; &nbsp;| postgres | /ssd4/pg93/tbs_idx</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# \d tbl_cost_align&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "postgres.tbl_cost_align"</font></div><div><font size="2"   >&nbsp; Column &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >----------+-----------------------------+-----------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;info &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;crt_time | timestamp without time zone |&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "idx_tbl_cost_align_id" btree (id), tablespace "tbs_idx"</font></div><div><font size="2"   >Tablespace: "tbs_idx"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# \q</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; df -h</font></div><div><font size="2"   >Filesystem &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Size &nbsp;Used Avail Use% Mounted on</font></div><div><font size="2"   >/dev/sdc1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;29G &nbsp;7.6G &nbsp; 20G &nbsp;28% /</font></div><div><font size="2"   >tmpfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;48G &nbsp; &nbsp; 0 &nbsp; 48G &nbsp; 0% /dev/shm</font></div><div><font size="2"   >/dev/sdc3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;98G &nbsp; 27G &nbsp; 67G &nbsp;29% /opt</font></div><div><font size="2"   >/dev/sdd1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 183G &nbsp; 18G &nbsp;157G &nbsp;10% /ssd1</font></div><div><font size="2"   >/dev/sde1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 469G &nbsp;1.7G &nbsp;444G &nbsp; 1% /ssd2</font></div><div><font size="2"   >/dev/sda1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 221G &nbsp; 12G &nbsp;198G &nbsp; 6% /ssd3</font></div><div><font size="2"   >/dev/sdb1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 221G &nbsp; 26G &nbsp;184G &nbsp;13% /ssd4</font></div><p></p></pre></div><div>sdb的预读是多少呢?</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# blockdev --getra /dev/sdb</font></div><div><font size="2"   >256</font></div><p></p></pre></div><div><br></div><div>表的大小</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \dt+ tbl_cost_align&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp; Schema &nbsp;| &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp;| Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp;Size &nbsp;| Description&nbsp;</font></div><div><font size="2"   >----------+----------------+-------+----------+--------+-------------</font></div><div><font size="2"   >&nbsp;postgres | tbl_cost_align | table | postgres | 738 MB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>在柱状图中的<span style="line-height: 28px;"   >5903个操作, 如果算上预读的话刚好和表的大小差不多.</span></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select 5903*256*512/1024/1024.0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;?column? &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;737.8750000000000000</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="line-height: 28px;"   >柱状图反映的是一个真实的IO获取的响应时间的现象, 同时也体现了块设备readahead在这里所的作用.</div><div style="line-height: 28px;"   >接下来我把read ahead设置为0 , 那么每次响应就变得很慢了. 来看结果.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 ~]# blockdev --setra 0 /dev/sdb</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# sync; echo 3 &gt; /proc/sys/vm/drop_caches</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; taskset -c 1 /home/pg93/pgsql9.3.1/bin/postgres &gt;/dev/null 2&gt;&amp;1</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >pg93@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.3.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select pg_backend_pid();</font></div><div><font size="2"   >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5330</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-150 ~]# taskset -c 7 stap -e '</font></div><div><font size="2"   >global a</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__start") {</font></div><div><font size="2"   >&nbsp; delete a</font></div><div><font size="2"   >&nbsp; println("query__start ", user_string($arg1), "pid:", pid())</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe vfs.read.return {</font></div><div><font size="2"   >&nbsp; t = gettimeofday_ns() - @entry(gettimeofday_ns())</font></div><div><font size="2"   >&nbsp; # if (execname() == "postgres" &amp;&amp; devname != "N/A")</font></div><div><font size="2"   >&nbsp; &nbsp; a[pid()] &lt;&lt;&lt; t</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__done") {</font></div><div><font size="2"   >&nbsp; if (@count(a[pid()]))&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; printdln("**", pid(), @count(a[pid()]), @avg(a[pid()]))</font></div><div><font size="2"   >&nbsp; println("query__done ", user_string($arg1), "pid:", pid())</font></div><div><font size="2"   >&nbsp; if (@count(a[pid()])) {</font></div><div><font size="2"   >&nbsp; &nbsp; println(@hist_log(a[pid()]))</font></div><div><font size="2"   >&nbsp; &nbsp; #println(@hist_linear(a[pid()],1024,4096,100))</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >&nbsp; delete a</font></div><div><font size="2"   >}' -x 5330</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >-----</font></div><div><font size="2"   >&nbsp;Seq Scan on postgres.tbl_cost_align &nbsp;(cost=0.00..195393.00 rows=10100000 width=45) (actual time=1.115..28424.672 rows=10100000 loop</font></div><div><font size="2"   >s=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared read=94393</font></div><div><font size="2"   >&nbsp;Total runtime: 29471.988 ms</font></div><div><font size="2"   >(4 rows)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >query__start explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:5330</font></div><div><font size="2"   >5330**94418**277500</font></div><div><font size="2"   >query__done explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:5330</font></div><div><font size="2"   >&nbsp; value |-------------------------------------------------- count</font></div><div><font size="2"   >&nbsp; &nbsp;2048 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp;4096 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp;8192 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 7</font></div><div><font size="2"   >&nbsp; 16384 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; 32768 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >&nbsp; 65536 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp;131072 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ &nbsp;62765</font></div><div><font size="2"   >&nbsp;262144 |@@@@@@@@@@@@@@@@@@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 28131</font></div><div><font size="2"   >&nbsp;524288 |@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3509</font></div><div><font size="2"   >1048576 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2</font></div><div><font size="2"   >2097152 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3</font></div><div><font size="2"   >4194304 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >8388608 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div></div><p></p></pre></div></div><div>从结果看到, 平均IO响应时间变成277500纳秒了, 换算成IOPS只有3603.</div><div><br></div>[参考]<wbr><div>1. man blockdev</div><div><div>&nbsp; &nbsp; &nbsp; &nbsp;--setra N</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Set readahead to N 512-byte sectors.</div><div><br></div><div>&nbsp; &nbsp; &nbsp; &nbsp;--getra</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Print readahead (in 512-byte sectors).</div></div><div>2.&nbsp;<a style="line-height: 28px;" href="http://blog.163.com/digoal@126/blog/static/1638770402013102610150692/"   >http://blog.163.com/digoal@126/blog/static/1638770402013102610150692/</a></div></div>
	</div>
</div>
</body>
</html>