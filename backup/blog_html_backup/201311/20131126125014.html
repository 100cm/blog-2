<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">taskset - retrieve or set a process's CPU affinity (affect SYSTEMTAP TIME)</h2>
	<h5 id="">2013-11-26 12:50:14&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013102610150692/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在使用systemtap监控进程或者内核的运行状况时, 我们会发现使用systemtap和不使用systemtap时, 某些操作的运行时间差别会比较大. 这是因为systemtap本身带来的开销导致的, 那么如何减少这部分开销呢?</div><div>可选的方法较多, 例如精简systemtap, 减少systemtap的触发事件的范围, 简化handler的逻辑等等.</div><div>除此之外, 还有其他的方法, 例如设置CPU亲和, Linux进程使用哪个CPU资源是由内核进行调度的.</div><div>被跟踪进程的亲和与stap运行的进程亲和分开, 可以有效的减少stap的影响吗. 实际上影响甚微, 但是有效果. &nbsp;</div><div><span style="line-height: 28px;"   >其次我发现CentOS 6.4 x64系统下面, 使用CPU 0的话, 性能会远远不如使用其他任何CPU. &nbsp;(这才是本文主题)</span></div><div>所以改亲和的话, 只要不使用0号CPU就可以了.</div><div><span style="line-height: 28px;"   >例如 :&nbsp;</span></div><div>服务器上有8个CPU</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-150-&gt; numactl --show</font></div><div><font size="2"   >policy: default</font></div><div><font size="2"   >preferred node: current</font></div><div><font size="2"   >physcpubind: 0 1 2 3 4 5 6 7&nbsp;</font></div><div><font size="2"   >cpubind: 0&nbsp;</font></div><div><font size="2"   >nodebind: 0&nbsp;</font></div><div><font size="2"   >membind: 0&nbsp;</font></div></div><div><div><font size="2"   >pg93@db-172-16-3-150-&gt; cat /proc/cpuinfo&nbsp;</font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 0</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1595.992</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 1</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 0</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 16</font></div><div><font size="2"   >initial apicid &nbsp;: 16</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx rdtscp lm constant_tsc arch_perfmon pebs bts rep_good xtopology nonstop_tsc aperfmperf pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 sse4_2 popcnt lahf_lm dts tpr_shadow vnmi flexpriority ept vpid</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3191.98</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 1</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1595.992</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 0</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 0</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 0</font></div><div><font size="2"   >initial apicid &nbsp;: 0</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx rdtscp lm constant_tsc arch_perfmon pebs bts rep_good xtopology nonstop_tsc aperfmperf pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 sse4_2 popcnt lahf_lm dts tpr_shadow vnmi flexpriority ept vpid</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3191.50</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 2</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1595.992</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 1</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 1</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 18</font></div><div><font size="2"   >initial apicid &nbsp;: 18</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx rdtscp lm constant_tsc arch_perfmon pebs bts rep_good xtopology nonstop_tsc aperfmperf pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 sse4_2 popcnt lahf_lm dts tpr_shadow vnmi flexpriority ept vpid</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3191.98</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 3</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1595.992</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 0</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 1</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 2</font></div><div><font size="2"   >initial apicid &nbsp;: 2</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx rdtscp lm constant_tsc arch_perfmon pebs bts rep_good xtopology nonstop_tsc aperfmperf pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 sse4_2 popcnt lahf_lm dts tpr_shadow vnmi flexpriority ept vpid</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3191.50</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1595.992</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 1</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 2</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 20</font></div><div><font size="2"   >initial apicid &nbsp;: 20</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx rdtscp lm constant_tsc arch_perfmon pebs bts rep_good xtopology nonstop_tsc aperfmperf pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 sse4_2 popcnt lahf_lm dts tpr_shadow vnmi flexpriority ept vpid</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3191.98</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 5</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1595.992</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 0</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 2</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >initial apicid &nbsp;: 4</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx rdtscp lm constant_tsc arch_perfmon pebs bts rep_good xtopology nonstop_tsc aperfmperf pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 sse4_2 popcnt lahf_lm dts tpr_shadow vnmi flexpriority ept vpid</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3191.50</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 6</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1595.992</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 1</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 3</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 22</font></div><div><font size="2"   >initial apicid &nbsp;: 22</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx rdtscp lm constant_tsc arch_perfmon pebs bts rep_good xtopology nonstop_tsc aperfmperf pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 sse4_2 popcnt lahf_lm dts tpr_shadow vnmi flexpriority ept vpid</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3191.98</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 7</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1595.992</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 0</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 3</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >initial apicid &nbsp;: 6</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx rdtscp lm constant_tsc arch_perfmon pebs bts rep_good xtopology nonstop_tsc aperfmperf pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 sse4_2 popcnt lahf_lm dts tpr_shadow vnmi flexpriority ept vpid</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3191.50</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management:</font></div></div><p></p></pre></div><div>从以上CPUINFO可以看出, 这里有2个物理CPU, 0和1.</div><div>使用dmidecode也可以看到这部分信息</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 ~]# dmidecode -t processor</font></div><div><font size="2"   ># dmidecode 2.11</font></div><div><font size="2"   >SMBIOS 2.6 present.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Handle 0x0400, DMI type 4, 40 bytes</font></div><div><font size="2"   >Processor Information</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Socket Designation: CPU1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Type: Central Processor</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Family: Xeon</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Manufacturer: Intel</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ID: A5 06 01 00 FF FB EB BF</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Signature: Type 0, Family 6, Model 26, Stepping 5</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Flags:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FPU (Floating-point unit on-chip)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; VME (Virtual mode extension)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DE (Debugging extension)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PSE (Page size extension)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TSC (Time stamp counter)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MSR (Model specific registers)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PAE (Physical address extension)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MCE (Machine check exception)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CX8 (CMPXCHG8 instruction supported)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; APIC (On-chip APIC hardware supported)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SEP (Fast system call)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MTRR (Memory type range registers)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PGE (Page global enable)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MCA (Machine check architecture)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CMOV (Conditional move instruction supported)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PAT (Page attribute table)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PSE-36 (36-bit page size extension)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CLFSH (CLFLUSH instruction supported)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DS (Debug store)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACPI (ACPI supported)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MMX (MMX technology supported)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FXSR (FXSAVE and FXSTOR instructions supported)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SSE (Streaming SIMD extensions)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SSE2 (Streaming SIMD extensions 2)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SS (Self-snoop)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HTT (Multi-threading)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TM (Thermal monitor supported)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PBE (Pending break enabled)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Version: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Voltage: 1.2 V</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; External Clock: 4800 MHz</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Max Speed: 3600 MHz</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Current Speed: 1600 MHz</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Status: Populated, Enabled</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Upgrade: Socket LGA1366</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; L1 Cache Handle: 0x0700</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; L2 Cache Handle: 0x0701</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; L3 Cache Handle: 0x0702</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Serial Number: Not Specified</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Asset Tag: Not Specified</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Part Number: Not Specified</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Core Count: 4</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Core Enabled: 4</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Thread Count: 4</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Characteristics:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64-bit capable</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Handle 0x0401, DMI type 4, 40 bytes</font></div><div><font size="2"   >Processor Information</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Socket Designation: CPU2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Type: Central Processor</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Family: Xeon</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Manufacturer: Intel</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ID: A5 06 01 00 FF FB EB BF</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Signature: Type 0, Family 6, Model 26, Stepping 5</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Flags:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FPU (Floating-point unit on-chip)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; VME (Virtual mode extension)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DE (Debugging extension)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PSE (Page size extension)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TSC (Time stamp counter)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MSR (Model specific registers)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PAE (Physical address extension)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MCE (Machine check exception)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CX8 (CMPXCHG8 instruction supported)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; APIC (On-chip APIC hardware supported)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SEP (Fast system call)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MTRR (Memory type range registers)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PGE (Page global enable)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MCA (Machine check architecture)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CMOV (Conditional move instruction supported)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PAT (Page attribute table)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PSE-36 (36-bit page size extension)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CLFSH (CLFLUSH instruction supported)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DS (Debug store)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACPI (ACPI supported)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MMX (MMX technology supported)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FXSR (FXSAVE and FXSTOR instructions supported)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SSE (Streaming SIMD extensions)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SSE2 (Streaming SIMD extensions 2)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SS (Self-snoop)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HTT (Multi-threading)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TM (Thermal monitor supported)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PBE (Pending break enabled)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Version: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Voltage: 1.2 V</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; External Clock: 4800 MHz</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Max Speed: 3600 MHz</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Current Speed: 1600 MHz</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Status: Populated, Idle</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Upgrade: Socket LGA1366</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; L1 Cache Handle: 0x0703</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; L2 Cache Handle: 0x0704</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; L3 Cache Handle: 0x0705</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Serial Number: Not Specified</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Asset Tag: Not Specified</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Part Number: Not Specified</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Core Count: 4</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Core Enabled: 4</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Thread Count: 4</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Characteristics:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64-bit capable</font></div></div><div><div><font size="2"   >[root@db-172-16-3-150 ~]# cat /proc/cpuinfo |grep "core id"</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 0</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 0</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 1</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 1</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 2</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 2</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 3</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 3</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# cat /proc/cpuinfo |grep "physical id"</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 1</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 0</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 1</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 0</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 1</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 0</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 1</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 0</font></div></div><p></p></pre></div><div><br></div><div>在没有运行业务的情况下, 我们要测试PostgreSQL某SQL的IO请求次数和请求时间.</div><div>启动PostgreSQL数据库时, 把CPU亲和设置为0. (也就是文章开头提到的性能最烂的做法.)</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; taskset -c 0 /home/pg93/pgsql9.3.1/bin/postgres &gt;/dev/null 2&gt;&amp;1</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >使用亲和1启动psql.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; taskset -c 1 psql</font></div><div><font size="2"   >psql (9.3.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select pg_backend_pid();</font></div><div><font size="2"   >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 24781</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>然后在启动stap时把亲和设置为和PostgreSQL不一样的CPU id. 例如3(这样也确保了不在一个物理core上.).&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# taskset -c 3 stap -e '</font></div><div><font size="2"   >global a</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__start") {</font></div><div><font size="2"   >&nbsp; delete a</font></div><div><font size="2"   >&nbsp; println("query__start ", user_string($arg1), "pid:", pid())</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe vfs.read.return {</font></div><div><font size="2"   >&nbsp; t = gettimeofday_ns() - @entry(gettimeofday_ns())</font></div><div><font size="2"   >&nbsp; # if (execname() == "postgres" &amp;&amp; devname != "N/A") &nbsp;# 这句判断也有一定的影响, 所以不用. 我们使用target模式.</font></div><div><font size="2"   >&nbsp; &nbsp; a[pid()] &lt;&lt;&lt; t</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__done") {</font></div><div><font size="2"   >&nbsp; printdln("**", pid(), @count(a[pid()]), @avg(a[pid()]))</font></div><div><font size="2"   >&nbsp; println("query__done ", user_string($arg1), "pid:", pid())</font></div><div><font size="2"   >&nbsp; delete a</font></div><div><font size="2"   >}' -x&nbsp;24781</font></div><p></p></pre></div><div>在psql中连续快速的执行SQL</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----</font></div><div><font size="2"   >&nbsp;Seq Scan on postgres.tbl_cost_align &nbsp;(cost=0.00..195393.00 rows=10100000 width=45) (actual time=0.023..3154.782 rows=10100000 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared read=94393</font></div><div><font size="2"   >&nbsp;Total runtime: 4710.788 ms</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----</font></div><div><font size="2"   >&nbsp;Seq Scan on postgres.tbl_cost_align &nbsp;(cost=0.00..195393.00 rows=10100000 width=45) (actual time=0.040..3151.680 rows=10100000 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=32 read=94361</font></div><div><font size="2"   >&nbsp;Total runtime: 4696.888 ms</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----</font></div><div><font size="2"   >&nbsp;Seq Scan on postgres.tbl_cost_align &nbsp;(cost=0.00..195393.00 rows=10100000 width=45) (actual time=0.035..3158.134 rows=10100000 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=64 read=94329</font></div><div><font size="2"   >&nbsp;Total runtime: 4706.135 ms</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >stap输出</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >query__start explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:24781</font></div><div><font size="2"   >24781**94417**5461</font></div><div><font size="2"   >query__done explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:24781</font></div><div><font size="2"   >query__start explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:24781</font></div><div><font size="2"   >24781**94361**5429</font></div><div><font size="2"   >query__done explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:24781</font></div><div><font size="2"   >query__start explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:24781</font></div><div><font size="2"   >24781**94329**5529</font></div><div><font size="2"   >query__done explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:24781</font></div><p></p></pre></div></div><div>我们看到每次read IO的时间为<span style="line-height: 28px;"   >5461</span>纳秒左右.</div><div><br></div><div>如果把stap的亲和设置为非0, 即使与stap的亲和一致也没关系. 那么会发生什么情况呢?</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; taskset -c 3 /home/pg93/pgsql9.3.1/bin/postgres &gt;/dev/null 2&gt;&amp;1</font></div><div><div><font size="2"   >pg93@db-172-16-3-150-&gt; taskset -c 3 psql</font></div><div><font size="2"   >psql (9.3.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select pg_backend_pid();</font></div><div><font size="2"   >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 24829</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >[root@db-172-16-3-150 ~]# taskset -c 3 stap -e '</font></div><div><font size="2"   >global a</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__start") {</font></div><div><font size="2"   >&nbsp; delete a</font></div><div><font size="2"   >&nbsp; println("query__start ", user_string($arg1), "pid:", pid())</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe vfs.read.return {</font></div><div><font size="2"   >&nbsp; t = gettimeofday_ns() - @entry(gettimeofday_ns())</font></div><div><font size="2"   >&nbsp; # if (execname() == "postgres" &amp;&amp; devname != "N/A") &nbsp;# 这句判断也有一定的影响, 所以不用. 建议使用target模式.</font></div><div><font size="2"   >&nbsp; &nbsp; a[pid()] &lt;&lt;&lt; t</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe process("/home/pg93/pgsql9.3.1/bin/postgres").mark("query__done") {</font></div><div><font size="2"   >&nbsp; printdln("**", pid(), @count(a[pid()]), @avg(a[pid()]))</font></div><div><font size="2"   >&nbsp; println("query__done ", user_string($arg1), "pid:", pid())</font></div><div><font size="2"   >&nbsp; delete a</font></div><div><font size="2"   >}' -x 24829</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----</font></div><div><font size="2"   >&nbsp;Seq Scan on postgres.tbl_cost_align &nbsp;(cost=0.00..195393.00 rows=10100000 width=45) (actual time=0.023..2039.248 rows=10100000 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared read=94393</font></div><div><font size="2"   >&nbsp;Total runtime: 3065.989 ms</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----</font></div><div><font size="2"   >&nbsp;Seq Scan on postgres.tbl_cost_align &nbsp;(cost=0.00..195393.00 rows=10100000 width=45) (actual time=0.036..2039.643 rows=10100000 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=32 read=94361</font></div><div><font size="2"   >&nbsp;Total runtime: 3066.841 ms</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----</font></div><div><font size="2"   >&nbsp;Seq Scan on postgres.tbl_cost_align &nbsp;(cost=0.00..195393.00 rows=10100000 width=45) (actual time=0.034..2039.005 rows=10100000 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=64 read=94329</font></div><div><font size="2"   >&nbsp;Total runtime: 3066.746 ms</font></div><div><font size="2"   >(4 rows)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >query__start explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:24829</font></div><div><font size="2"   >24829**94417**3277</font></div><div><font size="2"   >query__done explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:24829</font></div><div><font size="2"   >query__start explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:24829</font></div><div><font size="2"   >24829**94361**3272</font></div><div><font size="2"   >query__done explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:24829</font></div><div><font size="2"   >query__start explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:24829</font></div><div><font size="2"   >24829**94329**3273</font></div><div><font size="2"   >query__done explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:24829</font></div></div><p></p></pre></div><div>每次IO响应时间降到了3273纳秒左右, 几乎下降了一半, 所以说CPU 0不行啊.</div><div><br></div><div>最后把STAP的亲和设置为4, (与postgres进程分开使用物理CPU)那么会怎么样呢?</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----</font></div><div><font size="2"   >&nbsp;Seq Scan on postgres.tbl_cost_align &nbsp;(cost=0.00..195393.00 rows=10100000 width=45) (actual time=0.055..2032.953 rows=10100000 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=96 read=94297</font></div><div><font size="2"   >&nbsp;Total runtime: 3059.635 ms</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----</font></div><div><font size="2"   >&nbsp;Seq Scan on postgres.tbl_cost_align &nbsp;(cost=0.00..195393.00 rows=10100000 width=45) (actual time=0.044..2034.114 rows=10100000 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=128 read=94265</font></div><div><font size="2"   >&nbsp;Total runtime: 3060.832 ms</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----</font></div><div><font size="2"   >&nbsp;Seq Scan on postgres.tbl_cost_align &nbsp;(cost=0.00..195393.00 rows=10100000 width=45) (actual time=0.043..2038.548 rows=10100000 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=160 read=94233</font></div><div><font size="2"   >&nbsp;Total runtime: 3065.674 ms</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div><div>测得的IO响应时间又有了一定的下降, 说明还是有一定效果的. 但是相比不使用CPU 0 这里显得效果比较弱了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >query__start explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:24829</font></div><div><font size="2"   >24829**94297**3194</font></div><div><font size="2"   >query__done explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:24829</font></div><div><font size="2"   >query__start explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:24829</font></div><div><font size="2"   >24829**94265**3200</font></div><div><font size="2"   >query__done explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:24829</font></div><div><font size="2"   >query__start explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:24829</font></div><div><font size="2"   >24829**94233**3195</font></div><div><font size="2"   >query__done explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;pid:24829</font></div><p></p></pre></div><div>最后在附一个未开启stap得到的结果.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----</font></div><div><font size="2"   >&nbsp;Seq Scan on postgres.tbl_cost_align &nbsp;(cost=0.00..195393.00 rows=10100000 width=45) (actual time=0.037..1812.712 rows=10100000 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=192 read=94201</font></div><div><font size="2"   >&nbsp;Total runtime: 2833.760 ms</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----</font></div><div><font size="2"   >&nbsp;Seq Scan on postgres.tbl_cost_align &nbsp;(cost=0.00..195393.00 rows=10100000 width=45) (actual time=0.038..1814.074 rows=10100000 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=224 read=94169</font></div><div><font size="2"   >&nbsp;Total runtime: 2835.363 ms</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# explain (analyze,verbose,costs,buffers,timing) select * from tbl_cost_align;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----</font></div><div><font size="2"   >&nbsp;Seq Scan on postgres.tbl_cost_align &nbsp;(cost=0.00..195393.00 rows=10100000 width=45) (actual time=0.039..1814.641 rows=10100000 loops</font></div><div><font size="2"   >=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Output: id, info, crt_time</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=256 read=94137</font></div><div><font size="2"   >&nbsp;Total runtime: 2840.508 ms</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div><div>stap开启后, 查询时间长了220毫秒左右. 本文中每个handler带来的额外开销是 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select 220/94137.0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------</font></div><div><font size="2"   >&nbsp;0.00233701945037551653</font></div><div><font size="2"   >(1 row)</font></div></div><div><span style="line-height: 28px;"   ><font size="2"   >0.002337毫秒.&nbsp;</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >2337纳秒.</font></span></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1. man taskset</div><div>2.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Performance_Tuning_Guide/main-cpu.html"   >https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Performance_Tuning_Guide/main-cpu.html</a></div>3.&nbsp;<a rel="nofollow" href="http://docs.mongodb.org/manual/administration/production-notes/#mongodb-on-numa-hardware"   >http://docs.mongodb.org/manual/administration/production-notes/#mongodb-on-numa-hardware</a></div>
	</div>
</div>
</body>
</html>