<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap examples, DISK IO - 1 Summarizing Disk Read/Write Traffic</h2>
	<h5 id="">2013-11-15 11:22:30&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020131015105532435/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>本文开始给大家讲一下linux系统中disk io相关的跟踪范例.</div><div>例子来自disktop.stp 脚本, 该脚本作者的用意是输出系统中IO请求字节数前10的进程信息以及对应的块设备信息.</div><div>但是这个脚本存在一个严重的BUG, 输出时对应的设备名其实是没有意义的, 它只是当时的设备号, 因为一个进程可能会对多个块设备进行IO操作, 但是脚本中记录的仅仅是最后一次io请求的块设备名.</div><div>后面会讲如何修改这个文件, 修复bug.</div><div>脚本内容以及注解 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 network]# cd /usr/share/systemtap/testsuite/systemtap.examples/io</font></div><div><font size="2"   >[root@db-172-16-3-150 network]# cat&nbsp;<span style="line-height: 28px;"   >disktop.stp</span></font></div><div><div><font size="2"   >#!/usr/bin/stap&nbsp;</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># Copyright (C) 2007 Oracle Corp.</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># Get the status of reading/writing disk every 5 seconds,</font></div><div><font size="2"   ># output top ten entries&nbsp;</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># This is free software,GNU General Public License (GPL);</font></div><div><font size="2"   ># either version 2, or (at your option) any later version.</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># Usage:</font></div><div><font size="2"   ># &nbsp;./disktop.stp</font></div><div><font size="2"   >#</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >global io_stat,device</font></div><div><font size="2"   >global read_bytes,write_bytes</font></div><div><font size="2"   >// 定义几个全局变量, io_stat存储累加的读, 写的字节数</font></div><div><font size="2"   >// device存储设备名, bug就在这里. 它存储的是vfs.read.return或vfs.write.return当时的设备名,&nbsp;</font></div><div><font size="2"   >// 同<span style="line-height: 28px;"   >pid(),execname(),uid(),ppid()操作的块设备</span><span style="line-height: 28px;"   >一下次是可能会变化的.</span></font></div><div><span style="line-height: 28px;"   ><font size="2"   >// read_bytes和write_bytes是全局的读写字节数, 不区分进程号.</font></span></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe vfs.read.return {</font></div><div><font size="2"   >&nbsp; if ($return&gt;0) {</font></div><div><font size="2"   >&nbsp; &nbsp; if (devname!="N/A") {/*skip read from cache*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; io_stat[pid(),execname(),uid(),ppid(),"R"] += $return</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; device[pid(),execname(),uid(),ppid(),"R"] = devname</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; read_bytes += $return</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >}</font></div><div><font size="2"   >// devname != "N/A" 过滤掉cache的块操作. 其他的都是块设备上的io操作.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe vfs.write.return {</font></div><div><font size="2"   >&nbsp; if ($return&gt;0) {</font></div><div><font size="2"   >&nbsp; &nbsp; if (devname!="N/A") { /*skip update cache*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; io_stat[pid(),execname(),uid(),ppid(),"W"] += $return</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; device[pid(),execname(),uid(),ppid(),"W"] = devname</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; write_bytes += $return</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >}</font></div><div><span style="line-height: 28px;"   ><font size="2"   >// devname != "N/A" 过滤掉cache的块操作. 其他的都是块设备上的io操作.</font></span></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe timer.ms(5000) {</font></div><div><font size="2"   >&nbsp; /* skip non-read/write disk */</font></div><div><font size="2"   >&nbsp; if (read_bytes+write_bytes) {</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; printf("\n%-25s, %-8s%4dKb/sec, %-7s%6dKb, %-7s%6dKb\n\n",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ctime(gettimeofday_s()),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"Average:", ((read_bytes+write_bytes)/1024)/5,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"Read:",read_bytes/1024,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"Write:",write_bytes/1024)</font></div><div><font size="2"   >// 输出全局读写字节数, 速率.</font></div><div><font size="2"   >// ctime用于把unix epoch second转换成年月日时分秒</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; /* print header */</font></div><div><font size="2"   >&nbsp; &nbsp; printf("%8s %8s %8s %25s %8s %4s %12s\n",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"UID","PID","PPID","CMD","DEVICE","T","BYTES")</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >// 输出头信息, 包含用户id, 进程id, 父进程id, 命令名, 块设备名, 读写类型, 字节数</font></div><div><font size="2"   >// 接下来的输出与之对应</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; /* print top ten I/O */</font></div><div><font size="2"   >&nbsp; foreach ([process,cmd,userid,parent,action] in io_stat- limit 10)</font></div><div><font size="2"   >&nbsp; &nbsp; printf("%8d %8d %8d %25s %8s %4s %12d\n",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;userid,process,parent,cmd,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;device[process,cmd,userid,parent,action],</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;action,io_stat[process,cmd,userid,parent,action])</font></div><div><font size="2"   >// 输出io请求前10的进程和设备信息.</font></div><div><font size="2"   >// 前面说了, 这里的设备没有意义</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; /* clear data */</font></div><div><font size="2"   >&nbsp; delete io_stat</font></div><div><font size="2"   >&nbsp; delete device</font></div><div><font size="2"   >&nbsp; read_bytes = 0</font></div><div><font size="2"   >&nbsp; write_bytes = 0 &nbsp;</font></div><div><font size="2"   >// 输出后清除全局变量的数据</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe end{</font></div><div><font size="2"   >&nbsp; delete io_stat</font></div><div><font size="2"   >&nbsp; delete device</font></div><div><font size="2"   >&nbsp; delete read_bytes</font></div><div><font size="2"   >&nbsp; delete write_bytes</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div><br></div><div>执行输出举例 :&nbsp;</div><div>这里使用两个块设备的读写来给大家看看脚本的bug.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 io]# df -h</font></div><div><font size="2"   >Filesystem &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Size &nbsp;Used Avail Use% Mounted on</font></div><div><font size="2"   >/dev/sdc1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;29G &nbsp;6.5G &nbsp; 21G &nbsp;24% /</font></div><div><font size="2"   >tmpfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;48G &nbsp; &nbsp; 0 &nbsp; 48G &nbsp; 0% /dev/shm</font></div><div><font size="2"   >/dev/sdc3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;98G &nbsp; 24G &nbsp; 70G &nbsp;26% /opt</font></div><div><font size="2"   >/dev/sdd1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 183G &nbsp;5.4G &nbsp;169G &nbsp; 4% /ssd1</font></div><div><font size="2"   >/dev/sde1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 469G &nbsp;1.7G &nbsp;444G &nbsp; 1% /ssd2</font></div><div><font size="2"   >/dev/sda1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 221G &nbsp;195M &nbsp;209G &nbsp; 1% /ssd3</font></div><div><font size="2"   >/dev/sdb1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 221G &nbsp;9.6G &nbsp;200G &nbsp; 5% /ssd4</font></div><p></p></pre></div><div>我们用到的是/dev/sda1和/dev/sdb1</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \db</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of tablespaces</font></div><div><font size="2"   >&nbsp; &nbsp; Name &nbsp; &nbsp;| &nbsp;Owner &nbsp; | &nbsp; &nbsp; &nbsp; Location &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------+----------+-----------------------</font></div><div><font size="2"   >&nbsp;pg_default | postgres |&nbsp;</font></div><div><font size="2"   >&nbsp;pg_global &nbsp;| postgres |&nbsp;</font></div><div><font size="2"   >&nbsp;tbs_digoal | postgres | /ssd3/pg93/tbs_digoal</font></div><div><font size="2"   >&nbsp;tbs_idx &nbsp; &nbsp;| postgres | /ssd4/pg93/tbs_idx</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div><div>创建表和索引, 分别存在两个设备上.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table test(id int primary key, info text, crt_time timestamp) tablespace tbs_digoal;</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# create index idx_test_info on test(info) tablespace tbs_idx;</font></div><div><font size="2"   >CREATE INDEX</font></div><p></p></pre></div><div>创建测试用的函数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# CREATE OR REPLACE FUNCTION public.f_test(i_id integer)</font></div><div><font size="2"   >&nbsp;RETURNS void</font></div><div><font size="2"   >&nbsp;LANGUAGE plpgsql</font></div><div><font size="2"   >&nbsp;STRICT</font></div><div><font size="2"   >AS $function$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; update test set info=md5(random()::text), crt_time=clock_timestamp() where id=i_id;</font></div><div><font size="2"   >&nbsp; if not found then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into test(id,info,crt_time) values(i_id,md5(random()::text),clock_timestamp());</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; return;</font></div><div><font size="2"   >&nbsp; exception when others then</font></div><div><font size="2"   >&nbsp; &nbsp; return;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$function$;</font></div><p></p></pre></div><div>创建测试用的bench 脚本</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; vi test.sql</font></div><div><font size="2"   >\setrandom id 1 5000000</font></div><div><font size="2"   >select f_test(:id);</font></div><p></p></pre></div><div>进行bench测试, 维持60秒</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 1 -T 60 -h $PGDATA -p 1921 -U postgres digoal</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >测试过程中查看一下相关进程号和进程信息</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 io]# ps -ewf|grep pg93 &nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; &nbsp;9171 &nbsp; &nbsp; 1 &nbsp;0 10:39 pts/3 &nbsp; &nbsp;00:00:00 /home/pg93/pgsql9.3.1/bin/postgres</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; &nbsp;9172 &nbsp;9171 &nbsp;0 10:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: logger process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; &nbsp;9174 &nbsp;9171 &nbsp;0 10:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp; &nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; &nbsp;9175 &nbsp;9171 &nbsp;0 10:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; &nbsp;9176 &nbsp;9171 &nbsp;0 10:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:01 postgres: wal writer process &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; &nbsp;9177 &nbsp;9171 &nbsp;0 10:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum launcher process &nbsp;&nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; &nbsp;9178 &nbsp;9171 &nbsp;0 10:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: archiver process &nbsp; last was 0000000100000010000000ED</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; &nbsp;9179 &nbsp;9171 &nbsp;0 10:39 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process &nbsp;&nbsp;</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; &nbsp;9214 &nbsp;9000 22 10:42 pts/3 &nbsp; &nbsp;00:00:11 pgbench -M prepared -n -r -f ./test.sql -c 1 -T 60 -h /ssd2/pg93/pg_root -p 1921 -U postgres digoal</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; &nbsp;9216 &nbsp;9171 80 10:42 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:40 postgres: postgres digoal [local] SELECT</font></div><p></p></pre></div><div><br></div><div>开启disktop.stp, 收集块设备io统计信息, 从输出来看, bench的postgres进程9216只写了1个块设备, checkpoint也只写了1个块设备, 这即是disktop.stp中的bug, 记录的只是最后一次块操作的设备名.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 io]# stap disktop.stp&nbsp;</font></div><div><font size="2"   >Fri Nov 15 02:42:34 2013 , Average:6711Kb/sec, Read: &nbsp; &nbsp; &nbsp; 7Kb, Write: &nbsp;33552Kb</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;UID &nbsp; &nbsp; &nbsp;PID &nbsp; &nbsp; PPID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CMD &nbsp; DEVICE &nbsp; &nbsp;T &nbsp; &nbsp; &nbsp; &nbsp;BYTES</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;500 &nbsp; &nbsp; 9176 &nbsp; &nbsp; 9171 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;postgres &nbsp; &nbsp; sde1 &nbsp; &nbsp;W &nbsp; &nbsp; 31064064</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;500 &nbsp; &nbsp; 9216 &nbsp; &nbsp; 9171 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;postgres &nbsp; &nbsp; sda1 &nbsp; &nbsp;W &nbsp; &nbsp; &nbsp;3293184</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;500 &nbsp; &nbsp; 9223 &nbsp; &nbsp; 9178 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sh &nbsp; &nbsp; sdc1 &nbsp; &nbsp;R &nbsp; &nbsp; &nbsp; &nbsp; 3620</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;500 &nbsp; &nbsp; 9223 &nbsp; &nbsp; 9178 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;date &nbsp; &nbsp; sdc1 &nbsp; &nbsp;R &nbsp; &nbsp; &nbsp; &nbsp; 3533</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;500 &nbsp; &nbsp; 9223 &nbsp; &nbsp; 9178 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;postgres &nbsp; &nbsp; sdc1 &nbsp; &nbsp;R &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;788</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;500 &nbsp; &nbsp; 9172 &nbsp; &nbsp; 9171 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;postgres &nbsp; &nbsp; sde1 &nbsp; &nbsp;W &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 29</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Fri Nov 15 02:42:39 2013 , Average:3754Kb/sec, Read: &nbsp; &nbsp; 135Kb, Write: &nbsp;18637Kb</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;UID &nbsp; &nbsp; &nbsp;PID &nbsp; &nbsp; PPID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CMD &nbsp; DEVICE &nbsp; &nbsp;T &nbsp; &nbsp; &nbsp; &nbsp;BYTES</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;500 &nbsp; &nbsp; 9176 &nbsp; &nbsp; 9171 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;postgres &nbsp; &nbsp; sde1 &nbsp; &nbsp;W &nbsp; &nbsp; 15630336</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;500 &nbsp; &nbsp; 9216 &nbsp; &nbsp; 9171 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;postgres &nbsp; &nbsp; sda1 &nbsp; &nbsp;W &nbsp; &nbsp; &nbsp;3448832</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;502 &nbsp; &nbsp; 9224 &nbsp; &nbsp; 1670 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;postgres &nbsp; &nbsp; sdd1 &nbsp; &nbsp;R &nbsp; &nbsp; &nbsp; 136419</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;502 &nbsp; &nbsp; 1678 &nbsp; &nbsp; 1670 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;postgres &nbsp; &nbsp; sdd1 &nbsp; &nbsp;W &nbsp; &nbsp; &nbsp; &nbsp; 5547</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;502 &nbsp; &nbsp; 1676 &nbsp; &nbsp; 1670 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;postgres &nbsp; &nbsp; sdd1 &nbsp; &nbsp;R &nbsp; &nbsp; &nbsp; &nbsp; 1968</font></div><p></p></pre></div><div><br></div><div>下面我把disktop.stp修改一下, 在device中存储按块设备的统计, 原来的io_stat保持不变. 脚本如下</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 io]# cat disktop_digoal.stp&nbsp;</font></div><div><font size="2"   >#!/usr/bin/stap&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >global io_stat,device</font></div><div><font size="2"   >global read_bytes,write_bytes</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe vfs.read.return {</font></div><div><font size="2"   >&nbsp; if ($return&gt;0) {</font></div><div><font size="2"   >&nbsp; &nbsp; if (devname!="N/A") {/*skip read from cache*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; io_stat[pid(),execname(),uid(),ppid(),"R"] += $return</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; device[pid(),execname(),uid(),ppid(),"R", devname] += $return</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; read_bytes += $return</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe vfs.write.return {</font></div><div><font size="2"   >&nbsp; if ($return&gt;0) {</font></div><div><font size="2"   >&nbsp; &nbsp; if (devname!="N/A") { /*skip update cache*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; io_stat[pid(),execname(),uid(),ppid(),"W"] += $return</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; device[pid(),execname(),uid(),ppid(),"W", devname] += $return</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; write_bytes += $return</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe timer.ms(5000) {</font></div><div><font size="2"   >&nbsp; /* skip non-read/write disk */</font></div><div><font size="2"   >&nbsp; if (read_bytes+write_bytes) {</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; printf("\n%-25s, %-8s%4dKb/sec, %-7s%6dKb, %-7s%6dKb\n\n",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ctime(gettimeofday_s()),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"Average:", ((read_bytes+write_bytes)/1024)/5,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"Read:",read_bytes/1024,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"Write:",write_bytes/1024)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; /* print header */</font></div><div><font size="2"   >&nbsp; &nbsp; printf("%8s %8s %8s %25s %8s %4s %12s\n",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"UID","PID","PPID","CMD","DEVICE","T","BYTES")</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >&nbsp; /* print top ten I/O */</font></div><div><font size="2"   >&nbsp; foreach ([process,cmd,userid,parent,action] in io_stat- limit 10) {</font></div><div><font size="2"   >&nbsp; &nbsp; foreach ([a,b,c,d,e,f] in device) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; if (a==process &amp;&amp; b==cmd &amp;&amp; c==userid &amp;&amp; d==parent &amp;&amp; e==action)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; printf("%8d %8d %8d %25s %8s %4s %12d\n",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;userid,process,parent,cmd,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;f,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;action,device[process,cmd,userid,parent,action,f])</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; /* clear data */</font></div><div><font size="2"   >&nbsp; delete io_stat</font></div><div><font size="2"   >&nbsp; delete device</font></div><div><font size="2"   >&nbsp; read_bytes = 0</font></div><div><font size="2"   >&nbsp; write_bytes = 0 &nbsp;</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe end{</font></div><div><font size="2"   >&nbsp; delete io_stat</font></div><div><font size="2"   >&nbsp; delete device</font></div><div><font size="2"   >&nbsp; delete read_bytes</font></div><div><font size="2"   >&nbsp; delete write_bytes</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>修改后重复以上测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >[root@db-172-16-3-150 systemtap.examples]# ps -ewf|grep pg93<br>pg93      9614     1  0 11:17 pts/1    00:00:00 /home/pg93/pgsql9.3.1/bin/postgres<br>pg93      9615  9614  0 11:17 ?        00:00:00 postgres: logger process          <br>pg93      9617  9614  0 11:17 ?        00:00:00 postgres: checkpointer process    <br>pg93      9618  9614  0 11:17 ?        00:00:00 postgres: writer process          <br>pg93      9619  9614  0 11:17 ?        00:00:00 postgres: wal writer process      <br>pg93      9620  9614  0 11:17 ?        00:00:00 postgres: autovacuum launcher process   <br>pg93      9621  9614  0 11:17 ?        00:00:00 postgres: archiver process   last was 0000000100000010000000FB<br>pg93      9622  9614  0 11:17 ?        00:00:00 postgres: stats collector process   <br>pg93      9632  9000 16 11:18 pts/3    00:00:00 pgbench -M prepared -n -r -f ./test.sql -c 1 -T 60 -h /ssd2/pg93/pg_root -p 1921 -U postgres digoal<br>pg93      9634  9614 99 11:18 ?        00:00:03 postgres: postgres digoal [local] SELECT</span></font></div><p></p></pre></div><div>可以看到, 修改后的脚本, 输出的设备名有意义了, 同一个进程9249, 也就是bench进程, 写了3个块设备的数据. sdb1 sda1 sde1,</div><div>分别是global, table, index所在的块设备. 同意可以看到<span style="line-height: 28px;"   >wal writer进程只写了pg_xlog所在的块设备.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >[root@db-172-16-3-150 io]# stap disktop_digoal.stp <br>Fri Nov 15 03:18:36 2013 , Average:4103Kb/sec, Read:    1711Kb, Write:  18808Kb<br>     UID      PID     PPID                       CMD   DEVICE    T        BYTES<br>     500     9619     9614                  postgres     sdd1    W     16220160<br>     500     9634     9614                  postgres     sda1    W      1564672<br>     500     9634     9614                  postgres     sdb1    W      1343488<br>     500     9634     9614                  postgres     sde1    W       131072<br>     500     9634     9614                  postgres     sda1    R      1744896<br>     500     9652     9621                        sh     sdc1    R         3620<br>     500     9652     9621                      date     sdc1    R         3533<br>     500     9652     9621                  postgres     sdc1    R          788<br>     500     9615     9614                  postgres     sde1    W           29<br><br>Fri Nov 15 03:18:41 2013 , Average:3780Kb/sec, Read:    1175Kb, Write:  17725Kb<br>     UID      PID     PPID                       CMD   DEVICE    T        BYTES<br>     500     9619     9614                  postgres     sdd1    W     15204352<br>     500     9634     9614                  postgres     sda1    W      1589248<br>     500     9634     9614                  postgres     sdb1    W      1220608<br>     500     9634     9614                  postgres     sde1    W       131072<br>     500     9634     9614                  postgres     sda1    R      1064960<br>     502     9653     1670                  postgres     sdd1    R       136419<br>     502     1678     1670                  postgres     sdd1    W         5547<br>     502     1676     1670                  postgres     sdd1    R         1968</span></font></div><p></p></pre></div></div><div><br></div><div>本文用到的2个probe alias原型.</div><div>/usr/share/systemtap/tapset/vfs.stp</div><div><pre class="prettyprint"   ><p></p><div><div><div><font size="2"   >probe vfs.read.return = kernel.function("vfs_read").return</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; name = "vfs.read"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; retstr = sprintf("%d", $return)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; file = $file</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; pos = $pos</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; buf = $buf</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bytes_to_read = $count</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; dev = __file_dev($file)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; devname = __find_bdevname(dev, __file_bdev($file))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ino = __file_ino($file)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ret = $return</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bytes_read = $return &gt; 0 ? $return : 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; error = $return &lt; 0 ? $return : 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; error_str = error ? errno_str(error) : ""</font></div><div><font size="2"   >}</font></div></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >probe vfs.write.return = kernel.function("vfs_write").return</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; name = "vfs.write"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; retstr = sprintf("%d", $return)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; file = $file</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; pos = $pos</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; buf = $buf</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bytes_to_write = $count</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; dev = __file_dev($file)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; devname = __find_bdevname(dev, __file_bdev($file))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ino = __file_ino($file)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ret = $return</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bytes_written = $return &gt; 0 ? $return : 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; error = $return &lt; 0 ? $return : 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; error_str = error ? errno_str(error) : ""</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div></div><div>$return为.return事件的上下文变量, 即事件函数返回值, 如本例用到的vfs_read.return, 对应的函数vfs_read@fs/read_write.c的返回类型为ssize_t, 代码中为ret, systemtap将使用$return来代表这个ret.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 io]# stap -L 'kernel.function("vfs_read")'</font></div><div><font size="2"   >kernel.function("vfs_read@fs/read_write.c:294") $file:struct file* $buf:char* $count:size_t $pos:loff_t*</font></div><div><font size="2"   >[root@db-172-16-3-150 io]# stap -L 'kernel.function("vfs_read").return'</font></div><div><font size="2"   >kernel.function("vfs_read@fs/read_write.c:294").return $return:ssize_t $file:struct file* $buf:char* $count:size_t $pos:loff_t*</font></div><p></p></pre></div><div><br></div><div>这两个函数的源码 :&nbsp;</div><div>/usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/fs/read_write.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >ssize_t vfs_read(struct file *file, char __user *buf, size_t count, loff_t *pos)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ssize_t ret;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!(file-&gt;f_mode &amp; FMODE_READ))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return -EBADF;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!file-&gt;f_op || (!file-&gt;f_op-&gt;read &amp;&amp; !file-&gt;f_op-&gt;aio_read))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return -EINVAL;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (unlikely(!access_ok(VERIFY_WRITE, buf, count)))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return -EFAULT;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ret = rw_verify_area(READ, file, pos, count);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (ret &gt;= 0) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; count = ret;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (file-&gt;f_op-&gt;read)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ret = file-&gt;f_op-&gt;read(file, buf, count, pos);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ret = do_sync_read(file, buf, count, pos);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (ret &gt; 0) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fsnotify_access(file-&gt;f_path.dentry);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add_rchar(current, ret);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inc_syscr(current);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return ret;</font></div><div><font size="2"   >}</font></div></div><div><span style="line-height: 28px;"   ><font size="2"   >EXPORT_SYMBOL(vfs_read);</font></span></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >ssize_t vfs_write(struct file *file, const char __user *buf, size_t count, loff_t *pos)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ssize_t ret;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!(file-&gt;f_mode &amp; FMODE_WRITE))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return -EBADF;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!file-&gt;f_op || (!file-&gt;f_op-&gt;write &amp;&amp; !file-&gt;f_op-&gt;aio_write))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return -EINVAL;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (unlikely(!access_ok(VERIFY_READ, buf, count)))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return -EFAULT;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ret = rw_verify_area(WRITE, file, pos, count);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (ret &gt;= 0) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; count = ret;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (file-&gt;f_op-&gt;write)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ret = file-&gt;f_op-&gt;write(file, buf, count, pos);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ret = do_sync_write(file, buf, count, pos);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (ret &gt; 0) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fsnotify_modify(file-&gt;f_path.dentry);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add_wchar(current, ret);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inc_syscw(current);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return ret;</font></div><div><font size="2"   >}</font></div><div><font size="2"   >EXPORT_SYMBOL(vfs_write);</font></div></div><p></p></pre></div><div><br></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/mainsect-disk.html"   >https://sourceware.org/systemtap/SystemTap_Beginners_Guide/mainsect-disk.html</a></div><div><span style="line-height: 28px;"   >2.&nbsp;</span><a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://sourceware.org/systemtap/examples/"   >https://sourceware.org/systemtap/examples/</a></div><div><div>3. /usr/share/systemtap/testsuite/systemtap.examples</div><div><span style="line-height: 28px;"   >4. systemtap-testsuite</span></div><div>5. /usr/share/systemtap/testsuite/systemtap.examples/index.txt</div><div>6. /usr/share/systemtap/testsuite/systemtap.examples/keyword-index.txt</div><div>7. /usr/share/systemtap/tapset</div></div><div>8.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-ctime.html"   >https://sourceware.org/systemtap/tapsets/API-ctime.html</a></div><div>9.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-gettimeofday-s.html"   >https://sourceware.org/systemtap/tapsets/API-gettimeofday-s.html</a></div></div>
	</div>
</div>
</body>
</html>