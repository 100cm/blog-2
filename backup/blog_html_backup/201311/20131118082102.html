<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap examples, DISK IO - 2 Tracking I/O Time For Each File Read or Write</h2>
	<h5 id="">2013-11-18 8:21:02&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201310188833407/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>例子来自iotime.stp 脚本, 该脚本用以监控每个进程对文件的读写字节数以及耗费的时间. 注意syscall.read和syscall.write还提供了请求读写字节数的上下文变量($count), 脚本中没有, 我增加了请求读写字节数的输出.</div><div>修改后的脚本内容以及注解 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 network]# cd /usr/share/systemtap/testsuite/systemtap.examples/io</font></div><div><font size="2"   >[root@db-172-16-3-150 io]# cat iotime.stp</font></div><div><font size="2"   >#!/usr/bin/stap</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* Copyright (C) 2006-2007 Red Hat Inc.</font></div><div><font size="2"   >&nbsp;*&nbsp;</font></div><div><font size="2"   >&nbsp;* This copyrighted material is made available to anyone wishing to use,</font></div><div><font size="2"   >&nbsp;* modify, copy, or redistribute it subject to the terms and conditions</font></div><div><font size="2"   >&nbsp;* of the GNU General Public License v.2.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* You should have received a copy of the GNU General Public License</font></div><div><font size="2"   >&nbsp;* along with this program. &nbsp;If not, see &lt;http://www.gnu.org/licenses/&gt;.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Print out the amount of time spent in the read and write systemcall</font></div><div><font size="2"   >&nbsp;* when each file opened by the process is closed. Note that the systemtap&nbsp;</font></div><div><font size="2"   >&nbsp;* script needs to be running before the open operations occur for</font></div><div><font size="2"   >&nbsp;* the script to record data.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* This script could be used to to find out which files are slow to load</font></div><div><font size="2"   >&nbsp;* on a machine. e.g.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* stap iotime.stp -c 'firefox'</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Output format is:</font></div><div><font size="2"   >&nbsp;* timestamp pid (executabable) info_type path ...</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* 200283135 2573 (cupsd) access /etc/printcap read: 0 write: 7063</font></div><div><font size="2"   >&nbsp;* 200283143 2573 (cupsd) iotime /etc/printcap time: 69</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >global start &nbsp;// stap开始时的时间戳</font></div><div><font size="2"   >global time_io &nbsp;// 记录单个进程对单个文件的读和写操作的时间开销 (gettimeofday_us() - @entry(gettimeofday_us())) "@entry()为return event独有."</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >function timestamp:long() { return gettimeofday_us() - start }</font></div><div><font size="2"   >// 返回stap开始后的时间位移量, 在脚本中没有太大的实际意义</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >function proc:string() { return sprintf("%d (%s)", pid(), execname()) }</font></div><div><font size="2"   >// 返回字符串, 包含进程id和进程的command name.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe begin { start = gettimeofday_us() }</font></div><div><font size="2"   >// 开始时, 记录当前的时间戳, 用以后面调用timestamp函数时输出位移量.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >global filehandles, fileread, filewrite, afileread, afilewrite</font></div><div><font size="2"   >// 定义几个全局变量, 存储数组</font></div><div><font size="2"   >// filehandles数组, 索引为pid和fd(进程id和文件描述符), 存储的值为文件名.</font></div><div><font size="2"   >// fileread, filewrite, afileread, afilewrite数组, 索引为pid和fd, 存储的值为读写的字节数, 请求读写的字节数.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe syscall.open.return {</font></div><div><font size="2"   >&nbsp; filename = user_string($filename)</font></div><div><font size="2"   >&nbsp; if ($return != -1) { &nbsp;// 返回值为文件描述符id, -1表示打开文件失败.</font></div><div><font size="2"   >&nbsp; &nbsp; filehandles[pid(), $return] = filename</font></div><div><font size="2"   >&nbsp; } else {</font></div><div><font size="2"   >&nbsp; &nbsp; printf("%d %s access %s fail\n", timestamp(), proc(), filename)</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >}</font></div><div><font size="2"   >// syscall.open.return, 打开文件事件.</font></div><div><font size="2"   >// 写filehandles数组, 索引为pid和fd(进程id和文件描述符), 存储的值为文件名.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe syscall.read.return {</font></div><div><font size="2"   >&nbsp; time = gettimeofday_us() - @entry(gettimeofday_us())</font></div><div><font size="2"   >&nbsp; p = pid()</font></div><div><font size="2"   >&nbsp; fd = $fd</font></div><div><font size="2"   >&nbsp; bytes = $return</font></div><div><font size="2"   >&nbsp; if (bytes &gt; 0)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; fileread[p, fd] += bytes</font></div><div><font size="2"   >&nbsp; if ($count &gt; 0)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; afileread[p, fd] += $count</font></div><div><font size="2"   >&nbsp; time_io[p, fd] &lt;&lt;&lt; time</font></div><div><font size="2"   >}</font></div><div><font size="2"   >// syscall.read.return, 读文件事件.</font></div><div><font size="2"   >// 写fileread, afileread 数组, 索引为pid和fd, 存储的值为读的字节数, 请求读的字节数.</font></div><div><font size="2"   >// 同时写time_io数组, 索引为pid和fd, 存储的值为统计类型, read消耗的时间.&nbsp;</font></div><div><font size="2"   >// time = gettimeofday_us() - @entry(gettimeofday_us()) 放在handler的第一个语句, 减少误差.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe syscall.write.return {</font></div><div><font size="2"   >&nbsp; time = gettimeofday_us() - @entry(gettimeofday_us())</font></div><div><font size="2"   >&nbsp; p = pid()</font></div><div><font size="2"   >&nbsp; fd = $fd</font></div><div><font size="2"   >&nbsp; bytes = $return</font></div><div><font size="2"   >&nbsp; if (bytes &gt; 0)</font></div><div><font size="2"   >&nbsp; &nbsp; filewrite[p, fd] += bytes</font></div><div><font size="2"   >&nbsp; if ($count &gt; 0)</font></div><div><font size="2"   >&nbsp; &nbsp; afilewrite[p, fd] += $count</font></div><div><font size="2"   >&nbsp; time_io[p, fd] &lt;&lt;&lt; time</font></div><div><font size="2"   >}</font></div><div><font size="2"   >// syscall.write.return, 读文件事件.</font></div><div><font size="2"   >// 写filewrite, afilewrite 数组, 索引为pid和fd, 存储的值为写的字节数, 请求写的字节数.</font></div><div><font size="2"   >// 同时写time_io数组, 索引为pid和fd, 存储的值为统计类型, write消耗的时间.&nbsp;</font></div><div><font size="2"   >// time = gettimeofday_us() - @entry(gettimeofday_us()) 放在handler的第一个语句, 减少误差.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe syscall.close {</font></div><div><font size="2"   >&nbsp; if ([pid(), $fd] in filehandles) {</font></div><div><font size="2"   >&nbsp; &nbsp; printf("%d %s access %s attempts read: %d write: %d, actual read: %d write: %d\n",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;timestamp(), proc(), filehandles[pid(), $fd],</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;afileread[pid(), $fd], afilewrite[pid(), $fd],</font></div><div><font size="2"   ><span>	</span> &nbsp; fileread[pid(), $fd], filewrite[pid(), $fd])</font></div><div><font size="2"   >&nbsp; &nbsp; if (@count(time_io[pid(), $fd]))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; printf("%d %s iotime %s time: %d\n", &nbsp;timestamp(), proc(),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;filehandles[pid(), $fd], @sum(time_io[pid(), $fd]))</font></div><div><font size="2"   >&nbsp; &nbsp;}</font></div><div><font size="2"   >&nbsp; delete afileread[pid(), $fd]</font></div><div><font size="2"   >&nbsp; delete afilewrite[pid(), $fd]</font></div><div><font size="2"   >&nbsp; delete fileread[pid(), $fd]</font></div><div><font size="2"   >&nbsp; delete filewrite[pid(), $fd]</font></div><div><font size="2"   >&nbsp; delete filehandles[pid(), $fd]</font></div><div><font size="2"   >&nbsp; delete time_io[pid(),$fd]</font></div><div><font size="2"   >&nbsp; // 文件关闭后清除这些数组的数据, 以便下一次统计.</font></div><div><font size="2"   >}</font></div><div><font size="2"   >// 文件关闭事件, 文件关闭后输出进程对文件的读写操作的统计信息.</font></div><div><font size="2"   >// 请求读写的字节数, 实际的读写字节数, 读写总共耗费的时间.</font></div><div><font size="2"   >// if ([pid(), $fd] in filehandles) 判断stap脚本是否记录到了open动作,&nbsp;</font></div><div><font size="2"   >// 没有记录到的话不输出fileread,filewrite,afileread,afilewrite数组的值,&nbsp;</font></div><div><font size="2"   >// 因为没记录到打开文件的动作, 数据只包含进程对文件的部分读写操作的统计.</font></div><p></p></pre></div><div><br></div><div>执行输出举例 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 io]# stap iotime.stp</font></div><div><font size="2"   >28518687 10992 (postgres) access pg_xlog/archive_status/000000010000001100000008.ready attempts read: 0 write: 0, actual read: 0 write: 0</font></div><div><font size="2"   >28518723 10992 (postgres) access pg_xlog/000000010000001100000008 attempts read: 0 write: 22642688, actual read: 0 write: 22642688</font></div><div><font size="2"   >28518731 10992 (postgres) iotime pg_xlog/000000010000001100000008 time: 30728</font></div><div><font size="2"   >28518887 10994 (postgres) access pg_xlog/archive_status attempts read: 0 write: 0, actual read: 0 write: 0</font></div><div><font size="2"   >28520418 4366 (sh) access /lib64/libtinfo.so.5 attempts read: 832 write: 0, actual read: 832 write: 0</font></div><div><font size="2"   >28520426 4366 (sh) iotime /lib64/libtinfo.so.5 time: 3</font></div><div><font size="2"   >28520525 4366 (sh) access /lib64/libdl.so.2 attempts read: 832 write: 0, actual read: 832 write: 0</font></div><div><font size="2"   >28520529 4366 (sh) iotime /lib64/libdl.so.2 time: 3</font></div><div><font size="2"   >28520622 4366 (sh) access /lib64/libc.so.6 attempts read: 832 write: 0, actual read: 832 write: 0</font></div><div><font size="2"   >28520626 4366 (sh) iotime /lib64/libc.so.6 time: 2</font></div><div><font size="2"   >28520929 4366 (sh) access /usr/lib/locale/locale-archive attempts read: 0 write: 0, actual read: 0 write: 0</font></div><div><font size="2"   >28521157 4366 (sh) access /proc/meminfo attempts read: 1024 write: 0, actual read: 1024 write: 0</font></div><div><font size="2"   >28521162 4366 (sh) iotime /proc/meminfo time: 54</font></div><div><font size="2"   >28521341 4366 (sh) access /usr/lib64/gconv/gconv-modules.cache attempts read: 0 write: 0, actual read: 0 write: 0</font></div><div><font size="2"   >28522690 4366 (date) access /lib64/librt.so.1 attempts read: 832 write: 0, actual read: 832 write: 0</font></div><div><font size="2"   >28522697 4366 (date) iotime /lib64/librt.so.1 time: 3</font></div><div><font size="2"   >28522788 4366 (date) access /lib64/libc.so.6 attempts read: 832 write: 0, actual read: 832 write: 0</font></div><div><font size="2"   >28522792 4366 (date) iotime /lib64/libc.so.6 time: 2</font></div><div><font size="2"   >28522888 4366 (date) access /lib64/libpthread.so.0 attempts read: 832 write: 0, actual read: 832 write: 0</font></div><div><font size="2"   >28522892 4366 (date) iotime /lib64/libpthread.so.0 time: 3</font></div><div><font size="2"   >28523146 4366 (date) access /usr/lib/locale/locale-archive attempts read: 0 write: 0, actual read: 0 write: 0</font></div><div><font size="2"   >28523254 4366 (date) access /etc/localtime attempts read: 8192 write: 0, actual read: 645 write: 0</font></div><div><font size="2"   >28523258 4366 (date) iotime /etc/localtime time: 10</font></div><div><font size="2"   >28523571 10994 (postgres) access pg_xlog/archive_status attempts read: 0 write: 0, actual read: 0 write: 0</font></div><div><font size="2"   >30506631 4361 (postgres) access pg_subtrans/0855 attempts read: 0 write: 8192, actual read: 0 write: 8192</font></div><div><font size="2"   >30506642 4361 (postgres) iotime pg_subtrans/0855 time: 21</font></div><div><font size="2"   >30720464 4361 (postgres) access pg_subtrans/0855 attempts read: 0 write: 8192, actual read: 0 write: 8192</font></div><div><font size="2"   >30720475 4361 (postgres) iotime pg_subtrans/0855 time: 33</font></div><div><font size="2"   >30935841 4361 (postgres) access pg_subtrans/0855 attempts read: 0 write: 8192, actual read: 0 write: 8192</font></div><div><font size="2"   >30935852 4361 (postgres) iotime pg_subtrans/0855 time: 33</font></div><div><font size="2"   >31147483 4361 (postgres) access pg_subtrans/0855 attempts read: 0 write: 8192, actual read: 0 write: 8192</font></div><div><font size="2"   >31147494 4361 (postgres) iotime pg_subtrans/0855 time: 26</font></div><div><font size="2"   >31281002 1581 (irqbalance) access /proc/interrupts attempts read: 8192 write: 0, actual read: 8192 write: 0</font></div><div><font size="2"   >31281013 1581 (irqbalance) iotime /proc/interrupts time: 247</font></div><div><font size="2"   >31281359 1581 (irqbalance) access /proc/stat attempts read: 3072 write: 0, actual read: 3072 write: 0</font></div><div><font size="2"   >31281363 1581 (irqbalance) iotime /proc/stat time: 249</font></div><div><font size="2"   >31281441 1581 (irqbalance) access /proc/irq/15/smp_affinity attempts read: 1024 write: 0, actual read: 9 write: 0</font></div><div><font size="2"   >31281445 1581 (irqbalance) iotime /proc/irq/15/smp_affinity time: 8</font></div><p></p></pre></div><div>// 读写单位字节, 时间单位微秒 (<span style="color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; line-height: 28px;"   >1μs (微秒)&nbsp; 1微秒=0.000001=10</span><sup style="line-height: 22px; color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   >-6</sup><span style="color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; line-height: 28px;"   >秒</span>)</div><div><br></div><div>本文用到的几个probe alias原型(包含对应的call原型).</div><div>/usr/share/systemtap/tapset/syscalls2.stp</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   ># open _______________________________________________________</font></div><div><font size="2"   ># long sys_open(const char __user * filename, int flags, int mode)</font></div><div><font size="2"   ># (obsolete) long sys32_open(const char * filename, int flags, int mode)</font></div><div><font size="2"   >#</font></div><div><font size="2"   >probe syscall.open = kernel.function("compat_sys_open").call ?,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;kernel.function("sys32_open").call ?,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;kernel.function("sys_open").call ?</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; name = "open"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; filename = user_string($filename)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; flags = $flags</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; mode = $mode</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (flags &amp; 64)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; argstr = sprintf("%s, %s, %#o", user_string_quoted($filename),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _sys_open_flag_str($flags), $mode)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; argstr = sprintf("%s, %s", user_string_quoted($filename),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _sys_open_flag_str($flags))</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe syscall.open.return = kernel.function("compat_sys_open").return ?,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kernel.function("sys32_open").return ?,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kernel.function("sys_open").return ?</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; name = "open"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; retstr = return_str(1, $return)</font></div><div><font size="2"   >}</font></div></div><div><div><font size="2"   ># read _______________________________________________________</font></div><div><font size="2"   ># ssize_t sys_read(unsigned int fd, char __user * buf, size_t count)</font></div><div><font size="2"   >probe syscall.read = kernel.function("sys_read").call</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; name = "read"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fd = $fd</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; buf_uaddr = $buf</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; count = $count</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; argstr = sprintf("%d, %p, %d", $fd, $buf, $count)</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe syscall.read.return = kernel.function("sys_read").return</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; name = "read"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; retstr = return_str(1, $return)</font></div><div><font size="2"   >}</font></div></div><div><div><font size="2"   ># write ______________________________________________________</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># ssize_t sys_write(unsigned int fd,</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;const char __user * buf,</font></div><div><font size="2"   ># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;size_t count)</font></div><div><font size="2"   >#</font></div><div><font size="2"   >probe syscall.write = kernel.function("sys_write").call</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; name = "write"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fd = $fd</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; buf_uaddr = $buf</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; count = $count</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; argstr = sprintf("%d, %s, %d", $fd, text_strn(user_string($buf), syscall_string_trunc, 1), $count)</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe syscall.write.return = kernel.function("sys_write").return</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; name = "write"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; retstr = return_str(1, $return)</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div>/usr/share/systemtap/tapset/syscalls.stp</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># close ______________________________________________________</font></div><div><font size="2"   ># long sys_close(unsigned int fd)</font></div><div><font size="2"   >probe syscall.close = kernel.function("sys_close").call</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; name = "close"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fd = $fd</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; argstr = sprint(fd)</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe syscall.close.return = kernel.function("sys_close").return</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; name = "close"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; retstr = return_str(1, $return)</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div><br></div><div>这几个函数的源码位置信息: (源码这里就不贴出来了)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 io]# stap -L 'kernel.function("compat_sys_open").call'</font></div><div><font size="2"   >kernel.function("compat_sys_open@fs/compat.c:1343").call $filename:char const* $flags:int $mode:int</font></div><div><font size="2"   >[root@db-172-16-3-150 io]# stap -L 'kernel.function("sys32_open").call'</font></div><div><font size="2"   >[root@db-172-16-3-150 io]# stap -L 'kernel.function("sys_open").call'</font></div><div><font size="2"   >kernel.function("sys_open@fs/open.c:913").call $filename:char const* $flags:int $mode:int $ret:long int</font></div><div><font size="2"   >[root@db-172-16-3-150 io]# stap -L 'kernel.function("sys_read").call'</font></div><div><font size="2"   >kernel.function("sys_read@fs/read_write.c:389").call $fd:unsigned int $buf:char* $count:size_t $fput_needed:int</font></div><div><font size="2"   >[root@db-172-16-3-150 io]# stap -L 'kernel.function("sys_write").call'</font></div><div><font size="2"   >kernel.function("sys_write@fs/read_write.c:407").call $fd:unsigned int $buf:char const* $count:size_t $fput_needed:int</font></div><div><font size="2"   >[root@db-172-16-3-150 io]# stap -L 'kernel.function("sys_close").call'</font></div><div><font size="2"   >kernel.function("sys_close@fs/open.c:982").call $fd:unsigned int</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-150 io]# stap -L 'kernel.function("compat_sys_open").return'</font></div><div><font size="2"   >kernel.function("compat_sys_open@fs/compat.c:1343").return $return:long int $filename:char const* $flags:int $mode:int</font></div><div><font size="2"   >[root@db-172-16-3-150 io]# stap -L 'kernel.function("sys32_open").return'</font></div><div><font size="2"   >[root@db-172-16-3-150 io]# stap -L 'kernel.function("sys_open").return'</font></div><div><font size="2"   >kernel.function("sys_open@fs/open.c:913").return $return:long int $filename:char const* $flags:int $mode:int $ret:long int</font></div><div><font size="2"   >[root@db-172-16-3-150 io]# stap -L 'kernel.function("sys_read").return'</font></div><div><font size="2"   >kernel.function("sys_read@fs/read_write.c:389").return $return:long int $fd:unsigned int $buf:char* $count:size_t $fput_needed:int</font></div><div><font size="2"   >[root@db-172-16-3-150 io]# stap -L 'kernel.function("sys_write").return'</font></div><div><font size="2"   >kernel.function("sys_write@fs/read_write.c:407").return $return:long int $fd:unsigned int $buf:char const* $count:size_t $fput_needed:int</font></div><div><font size="2"   >[root@db-172-16-3-150 io]# stap -L 'kernel.function("sys_close").return'</font></div><div><font size="2"   >kernel.function("sys_close@fs/open.c:982").return $return:long int $fd:unsigned int</font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/mainsect-disk.html"   >https://sourceware.org/systemtap/SystemTap_Beginners_Guide/mainsect-disk.html</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://sourceware.org/systemtap/examples/"   >https://sourceware.org/systemtap/examples/</a></div><div>3. /usr/share/systemtap/testsuite/systemtap.examples</div><div>4. systemtap-testsuite</div><div>5. /usr/share/systemtap/testsuite/systemtap.examples/index.txt</div><div>6. /usr/share/systemtap/testsuite/systemtap.examples/keyword-index.txt</div><div>7. /usr/share/systemtap/tapset</div><div>8.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-ctime.html"   >https://sourceware.org/systemtap/tapsets/API-ctime.html</a></div><div>9.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-gettimeofday-s.html"   >https://sourceware.org/systemtap/tapsets/API-gettimeofday-s.html</a></div><div><br></div><wbr></div>
	</div>
</div>
</body>
</html>