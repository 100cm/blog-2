<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap examples, Network - 5 Monitoring Network Packets Drops in Kernel</h2>
	<h5 id="">2013-11-14 15:04:22&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020131014111853927/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>例子来自<span style="line-height: 28px;"   >dropwatch.stp</span>脚本, 可用于分析网络协议栈中丢包的确切位置. 确切的位置是使用symname或者symdata将内存地址翻译出来的函数信息, 翻译必须使用stap --all-modules选项以便加载所有的模块的符号表.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;--all-modules</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Equivalent to specifying "-dkernel" and a "-d" for each kernel module that is &nbsp;currently &nbsp;loaded. &nbsp; Cau-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tion: this can make the probe modules considerably larger.</font></div><p></p></pre></div><div><br></div><div>脚本内容以及注解</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 network]# cd /usr/share/systemtap/testsuite/systemtap.examples/network</font></div><div><div><font size="2"   >[root@db-172-16-3-150 network]# cat dropwatch.stp</font></div><div><font size="2"   >#!/usr/bin/stap</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >############################################################</font></div><div><font size="2"   ># Dropwatch.stp</font></div><div><font size="2"   ># Author: Neil Horman &lt;nhorman@redhat.com&gt;</font></div><div><font size="2"   ># An example script to mimic the behavior of the dropwatch utility</font></div><div><font size="2"   ># http://fedorahosted.org/dropwatch</font></div><div><font size="2"   >############################################################</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Array to hold the list of drop points we find</font></div><div><font size="2"   >global locations</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Note when we turn the monitor on and off</font></div><div><font size="2"   >probe begin { printf("Monitoring for dropped packets\n") }</font></div><div><font size="2"   >probe end { printf("Stopping dropped packet monitor\n") }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># increment a drop counter for every location we drop at</font></div><div><font size="2"   >probe kernel.trace("kfree_skb") { locations[$location] &lt;&lt;&lt; 1 }</font></div><div><font size="2"   >//&nbsp;<span style="line-height: 28px;"   >locations</span><span style="line-height: 28px;"   >数组索引为$location, 记录kfree_skb被调用时的location参数信息, 即各模块符号表中的内存地址;</span></font></div><div><span style="line-height: 28px;"   ><font size="2"   >// 使用symname()或者symdata()可以将地址转换成符号信息.</font></span></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Every 5 seconds report our drop locations</font></div><div><font size="2"   >probe timer.sec(5)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; printf("\n")</font></div><div><font size="2"   >&nbsp; foreach (l in locations-) {</font></div><div><font size="2"   >&nbsp; &nbsp; printf("%d packets dropped at %s\n",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;@count(locations[l]), symname(l))</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >&nbsp; delete locations</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   >// 每5秒输出一次</font></div><div><font size="2"   >// 按@count(locations[i]) 倒序输出</font></div><div><font size="2"   >// 输出包含符号名, 以及丢的包个数.</font></div><p></p></pre></div><div><div>如果不加载模块, symname无法正确的翻译出函数名.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 network]# stap ./dropwatch.stp&nbsp;</font></div><div><font size="2"   >Monitoring for dropped packets</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >5 packets dropped at 0xffffffff814a104a</font></div><div><font size="2"   >1 packets dropped at 0xffffffff8147483b</font></div><div><font size="2"   >1 packets dropped at 0xffffffff814dc92c</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >6 packets dropped at 0xffffffff814a104a</font></div><div><font size="2"   >3 packets dropped at 0xffffffff8147483b</font></div><div><font size="2"   >1 packets dropped at 0xffffffff814714c8</font></div><div><font size="2"   >1 packets dropped at 0xffffffffa02078bb</font></div><div><font size="2"   >1 packets dropped at 0xffffffff814dc92c</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >5 packets dropped at 0xffffffff814a104a</font></div><div><font size="2"   >1 packets dropped at 0xffffffff814dc92c</font></div><p></p></pre></div></div><div><span style="line-height: 28px;"   >加载模块(</span>--all-modules)<span style="line-height: 28px;"   >后的执行输出举例 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 network]# stap &nbsp;--all-modules ./dropwatch.stp&nbsp;</font></div><div><font size="2"   >Monitoring for dropped packets</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >5 packets dropped at tcp_v4_rcv</font></div><div><font size="2"   >1 packets dropped at unix_stream_connect</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >5 packets dropped at tcp_v4_rcv</font></div><div><font size="2"   >1 packets dropped at nf_hook_slow</font></div><div><font size="2"   >1 packets dropped at unix_stream_connect</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >5 packets dropped at tcp_v4_rcv</font></div><div><font size="2"   >1 packets dropped at unix_stream_connect</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >6 packets dropped at tcp_v4_rcv</font></div><div><font size="2"   >1 packets dropped at nf_hook_slow</font></div><div><font size="2"   >1 packets dropped at unix_stream_connect</font></div><div><font size="2"   >^CStopping dropped packet monitor</font></div><p></p></pre></div><div><br></div><div>如果要输出模块信息以及函数在模块中的起始位置偏移量, 可以把symname替换成symdata来输出.</div><div>修改<span style="line-height: 28px;"   >dropwatch.stp , 同时输出内存地址, 地址对应的符号表中的信息.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 network]# vi dropwatch.stp&nbsp;</font></div><div><font size="2"   >#!/usr/bin/stap</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >############################################################</font></div><div><font size="2"   ># Dropwatch.stp</font></div><div><font size="2"   ># Author: Neil Horman &lt;nhorman@redhat.com&gt;</font></div><div><font size="2"   ># An example script to mimic the behavior of the dropwatch utility</font></div><div><font size="2"   ># http://fedorahosted.org/dropwatch</font></div><div><font size="2"   >############################################################</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Array to hold the list of drop points we find</font></div><div><font size="2"   >global locations</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Note when we turn the monitor on and off</font></div><div><font size="2"   >probe begin { printf("Monitoring for dropped packets\n") }</font></div><div><font size="2"   >probe end { printf("Stopping dropped packet monitor\n") }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># increment a drop counter for every location we drop at</font></div><div><font size="2"   >probe kernel.trace("kfree_skb") { locations[$location] &lt;&lt;&lt; 1 }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Every 5 seconds report our drop locations</font></div><div><font size="2"   >probe timer.sec(5)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; printf("\n")</font></div><div><font size="2"   >&nbsp; foreach (l in locations-) {</font></div><div><font size="2"   >&nbsp; &nbsp; printf("%d packets dropped at %p, %s, %s\n",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;@count(locations[l]), l, symname(l), symdata(l))</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >&nbsp; delete locations</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>使用修改后的<span style="line-height: 28px;"   >dropwatch.stp&nbsp;</span><span style="line-height: 28px;"   >输出如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 network]# stap &nbsp;--all-modules ./dropwatch.stp&nbsp;</font></div><div><font size="2"   >Monitoring for dropped packets</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >6 packets dropped at 0xffffffff814a104a, tcp_v4_rcv, tcp_v4_rcv+0xaa/0x8d0 [kernel]</font></div><div><font size="2"   >1 packets dropped at 0xffffffff814dc92c, unix_stream_connect, unix_stream_connect+0x1dc/0x4a0 [kernel]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >5 packets dropped at 0xffffffff814a104a, tcp_v4_rcv, tcp_v4_rcv+0xaa/0x8d0 [kernel]</font></div><div><font size="2"   >1 packets dropped at 0xffffffff8147483b, nf_hook_slow, nf_hook_slow+0xeb/0x110 [kernel]</font></div><div><font size="2"   >1 packets dropped at 0xffffffff814dc92c, unix_stream_connect, unix_stream_connect+0x1dc/0x4a0 [kernel]</font></div><div><font size="2"   >^CStopping dropped packet monitor</font></div><p></p></pre></div><div><br></div><div>如果无法使用symname和symdata转换, 手工从文件<span style="line-height: 28px;"   >/boot/System.map-2.6.32-358.el6.x86_64</span><span style="line-height: 28px;"   >中解读也是可以得到对应的函数的.</span></div><div><span style="line-height: 28px;"   >/boot/System.map-2.6.32-358.el6.x86_64这个符号表记录了函数的起始地址和函数的对应关系.</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 network]# sort -k 1 /boot/System.map-2.6.32-358.el6.x86_64 |less</font></div><div><div><font size="2"   >ffffffff814a0f50 t tcp_v4_reqsk_destructor</font></div><div><font size="2"   >ffffffff814a0fa0 T tcp_v4_rcv</font></div><div><font size="2"   >ffffffff814a1870 T tcp_v4_conn_request</font></div></div></div><div><font size="2"   >从$location以及符号表匹配函数 :&nbsp;</font></div><div><span style="line-height: 28px;"   ><font size="2"   >6 packets dropped at 0xffffffff814a104a, tcp_v4_rcv, tcp_v4_rcv+0xaa/0x8d0 [kernel]</font></span></div><div><font size="2"   ><span style="line-height: 28px;"   >0xffffffff814a104a这个地址在</span><span style="line-height: 28px;"   >ffffffff814a0fa0和</span><span style="line-height: 28px;"   >ffffffff814a1870之间, 所以也可以得到</span><span style="line-height: 28px;"   >tcp_v4_rcv.</span></font></div><p></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div><div>本文用到的kernel.trace("kfree_skb")原型.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/include/trace/events/skb.h</font></div><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* Tracepoint for free an sk_buff:</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >TRACE_EVENT(kfree_skb,</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TP_PROTO(struct sk_buff *skb, void *location),</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TP_ARGS(skb, location),</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TP_STRUCT__entry(</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __field( &nbsp; &nbsp; &nbsp; &nbsp;void *, &nbsp; &nbsp; &nbsp; &nbsp; skbaddr &nbsp; &nbsp; &nbsp; &nbsp; )</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __field( &nbsp; &nbsp; &nbsp; &nbsp;unsigned short, protocol &nbsp; &nbsp; &nbsp; &nbsp;)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __field( &nbsp; &nbsp; &nbsp; &nbsp;void *, &nbsp; &nbsp; &nbsp; &nbsp; location &nbsp; &nbsp; &nbsp; &nbsp;)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ),</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TP_fast_assign(</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __entry-&gt;skbaddr = skb;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (skb) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __entry-&gt;protocol = ntohs(skb-&gt;protocol);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __entry-&gt;location = location;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ),</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TP_printk("skbaddr=%p protocol=%u location=%p",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __entry-&gt;skbaddr, __entry-&gt;protocol, __entry-&gt;location)</font></div><div><font size="2"   >);</font></div></div><p></p></pre></div><div><br></div><div>本文例子中每次排第一位的都是tcp_v4_rcv函数, 通过源码, 找到这个函数的定义, 在函数定义中可以找到kfree_skb函数, 也就是本文用到的trace.</div><div>/usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/net/ipv4/tcp_ipv4.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;From tcp_input.c</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >int tcp_v4_rcv(struct sk_buff *skb)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; const struct iphdr *iph;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct tcphdr *th;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct sock *sk;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int ret;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct net *net = dev_net(skb-&gt;dev);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (skb-&gt;pkt_type != PACKET_HOST)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto discard_it;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Count it even if it's bad */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TCP_INC_STATS_BH(net, TCP_MIB_INSEGS);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!pskb_may_pull(skb, sizeof(struct tcphdr)))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto discard_it;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; th = tcp_hdr(skb);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (th-&gt;doff &lt; sizeof(struct tcphdr) / 4)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto bad_packet;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!pskb_may_pull(skb, th-&gt;doff * 4))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto discard_it;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* An explanation is required here, I think.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Packet length and doff are validated by header prediction,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* provided case of th-&gt;doff==0 is eliminated.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* So, we defer the checks. */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!skb_csum_unnecessary(skb) &amp;&amp; tcp_v4_checksum_init(skb))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto bad_packet;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; th = tcp_hdr(skb);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; iph = ip_hdr(skb);</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TCP_SKB_CB(skb)-&gt;seq = ntohl(th-&gt;seq);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TCP_SKB_CB(skb)-&gt;end_seq = (TCP_SKB_CB(skb)-&gt;seq + th-&gt;syn + th-&gt;fin +</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; skb-&gt;len - th-&gt;doff * 4);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TCP_SKB_CB(skb)-&gt;ack_seq = ntohl(th-&gt;ack_seq);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TCP_SKB_CB(skb)-&gt;when &nbsp; &nbsp;= 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TCP_SKB_CB(skb)-&gt;flags &nbsp; = iph-&gt;tos;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TCP_SKB_CB(skb)-&gt;sacked &nbsp;= 0;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sk = __inet_lookup_skb(&amp;tcp_hashinfo, skb, th-&gt;source, th-&gt;dest);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!sk)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto no_tcp_socket;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >process:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (sk-&gt;sk_state == TCP_TIME_WAIT)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto do_time_wait;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (unlikely(iph-&gt;ttl &lt; sk_get_min_ttl(sk))) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NET_INC_STATS_BH(net, LINUX_MIB_TCPMINTTLDROP);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto discard_and_relse;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!xfrm4_policy_check(sk, XFRM_POLICY_IN, skb))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto discard_and_relse;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; nf_reset(skb);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (sk_filter(sk, skb))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto discard_and_relse;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; skb-&gt;dev = NULL;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; inet_rps_save_rxhash(sk, skb-&gt;rxhash);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bh_lock_sock_nested(sk);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ret = 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!sock_owned_by_user(sk)) {</font></div><div><font size="2"   >#ifdef CONFIG_NET_DMA</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; struct tcp_sock *tp = tcp_sk(sk);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!tp-&gt;ucopy.dma_chan &amp;&amp; tp-&gt;ucopy.pinned_list)</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tp-&gt;ucopy.dma_chan = dma_find_channel(DMA_MEMCPY);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (tp-&gt;ucopy.dma_chan)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ret = tcp_v4_do_rcv(sk, skb);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >#endif</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!tcp_prequeue(sk, skb))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ret = tcp_v4_do_rcv(sk, skb);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; } else if (unlikely(sk_add_backlog(sk, skb))) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bh_unlock_sock(sk);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NET_INC_STATS_BH(net, LINUX_MIB_TCPBACKLOGDROP);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto discard_and_relse;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bh_unlock_sock(sk);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sock_put(sk);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return ret;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >no_tcp_socket:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!xfrm4_policy_check(NULL, XFRM_POLICY_IN, skb))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto discard_it;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (skb-&gt;len &lt; (th-&gt;doff &lt;&lt; 2) || tcp_checksum_complete(skb)) {</font></div><div><font size="2"   >bad_packet:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TCP_INC_STATS_BH(net, TCP_MIB_INERRS);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; } else {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcp_v4_send_reset(NULL, skb);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >discard_it:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Discard frame. */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; kfree_skb(skb);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return 0;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >discard_and_relse:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sock_put(sk);</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; goto discard_it;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >do_time_wait:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!xfrm4_policy_check(NULL, XFRM_POLICY_IN, skb)) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet_twsk_put(inet_twsk(sk));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto discard_it;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (skb-&gt;len &lt; (th-&gt;doff &lt;&lt; 2) || tcp_checksum_complete(skb)) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TCP_INC_STATS_BH(net, TCP_MIB_INERRS);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet_twsk_put(inet_twsk(sk));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto discard_it;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; switch (tcp_timewait_state_process(inet_twsk(sk), skb, th)) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; case TCP_TW_SYN: {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; struct sock *sk2 = inet_lookup_listener(dev_net(skb-&gt;dev),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;tcp_hashinfo,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; iph-&gt;daddr, th-&gt;dest,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet_iif(skb));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (sk2) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet_twsk_deschedule(inet_twsk(sk), &amp;tcp_death_row);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet_twsk_put(inet_twsk(sk));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sk = sk2;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto process;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Fall through to ACK */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; case TCP_TW_ACK:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcp_v4_timewait_ack(sk, skb);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; case TCP_TW_RST:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto no_tcp_socket;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; case TCP_TW_SUCCESS:;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; goto discard_it;</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div>查询更多的丢包点如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 network]# grep -rn kfree_skb /usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/|grep -v "\.h:"|less</font></div><div><font size="2"   >/usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/drivers/infiniband/hw/cxgb3/iwch_ev.c:231: &nbsp; &nbsp; dev_kfree_skb_irq(skb);</font></div><div><font size="2"   >/usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/drivers/infiniband/hw/cxgb3/iwch_cm.c:146: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kfree_skb(skb);</font></div><div><font size="2"   >/usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/drivers/infiniband/hw/cxgb3/iwch_cm.c:151: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kfree_skb(skb);</font></div><div><font size="2"   >/usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/drivers/infiniband/hw/cxgb3/iwch_cm.c:162: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kfree_skb(skb);</font></div><div><font size="2"   >/usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/drivers/infiniband/hw/cxgb3/iwch_cm.c:167: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kfree_skb(skb);</font></div></div><div><font size="2"   >... 略.</font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1. /usr/share/systemtap/testsuite/systemtap.examples</div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/useful-systemtap-scripts.html"   >https://sourceware.org/systemtap/SystemTap_Beginners_Guide/useful-systemtap-scripts.html</a></div><div>3. systemtap-testsuite</div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://sourceware.org/systemtap/examples/"   >https://sourceware.org/systemtap/examples/</a></div><div>5. /usr/share/systemtap/testsuite/systemtap.examples/index.txt</div><div>6. /usr/share/systemtap/testsuite/systemtap.examples/keyword-index.txt</div><div>7. /usr/share/systemtap/tapset</div><div>8.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="http://blog.yufeng.info/archives/2497"   >http://blog.yufeng.info/archives/2497</a></div><div>9.&nbsp;/usr/src/debug/kernel-2.6.32-358.el6/linux-2.6.32-358.el6.x86_64/net/ipv4/tcp_ipv4.c</div><div>10.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-symdata.html"   >https://sourceware.org/systemtap/tapsets/API-symdata.html</a></div><div>11.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-symname.html"   >https://sourceware.org/systemtap/tapsets/API-symname.html</a></div><wbr></div>
	</div>
</div>
</body>
</html>