<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL set tablespace bug? zombie files</h2>
	<h5 id="">2013-11-13 11:03:26&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020131013945499/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>为了监控各个表空间的健康状态, 曾经使用过一个函数来做这块的监测,&nbsp;</div><div><a rel="nofollow" href="https://raw.github.com/digoal/sky_postgresql_cluster/a58aab3e8c324c9afc9611b79331f051f2d6100e/INSTALL.txt"   >https://raw.github.com/digoal/sky_postgresql_cluster/a58aab3e8c324c9afc9611b79331f051f2d6100e/INSTALL.txt</a></div><div>函数如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-- 创建测试函数, 用于测试数据库是否正常, 包括所有表空间的测试.</font></div><div><font size="2"   >create or replace function cluster_keepalive_test() returns void as $$</font></div><div><font size="2"   >&nbsp; declare&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; v_tbs name;</font></div><div><font size="2"   >&nbsp; begin</font></div><div><font size="2"   >&nbsp; &nbsp; if ( pg_is_in_recovery() ) then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice 'this is standby node.';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; return;</font></div><div><font size="2"   >&nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; &nbsp; for v_tbs in select spcname from pg_tablespace where spcname &lt;&gt; 'pg_global' loop</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; execute 'alter table cluster_status set tablespace '||v_tbs;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; update cluster_status set last_alive=now();</font></div><div><font size="2"   >&nbsp; &nbsp; end loop;</font></div><div><font size="2"   >&nbsp; end;</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div><p></p></pre></div><div>使用以上函数, 当表空间出现问题, 或者表空间所在的文件系统出现问题后, 函数执行则会报错.</div><div>每间隔2秒运行一次, 以达到监控的目的.</div><div>期间做过重命名表空间目录来验证监控有效性, 做过多次数据库主备切换.</div><div>后来发现在一些表空间中存在一些0KB的文件, 以及一些有size的但是未引用的文件, 来自监控库.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/data05/pgdata/charge/tbs_rop/PG_9.3_201306121/16408:</font></div><div><font size="2"   >total 80K</font></div><div><font size="2"   >-rw------- 1 postgres postgres 8.0K Nov 13 09:43 1188414</font></div><div><font size="2"   >-rw------- 1 postgres postgres &nbsp;24K Nov 13 09:38 1188414_fsm</font></div><div><font size="2"   >-rw------- 1 postgres postgres 8.0K Nov 13 09:33 1188414_vm</font></div><div><font size="2"   >-rw------- 1 postgres postgres &nbsp; &nbsp;0 Nov &nbsp;8 08:01 279480</font></div><div><font size="2"   >-rw------- 1 postgres postgres &nbsp; &nbsp;0 Nov &nbsp;8 08:01 279487</font></div><div><font size="2"   >-rw------- 1 postgres postgres &nbsp; &nbsp;0 Nov &nbsp;8 08:01 279494</font></div><div><font size="2"   >-rw------- 1 postgres postgres &nbsp; &nbsp;0 Nov &nbsp;8 08:01 279501</font></div><div><font size="2"   >-rw------- 1 postgres postgres &nbsp; &nbsp;0 Nov &nbsp;8 08:01 279508</font></div><div><font size="2"   >-rw------- 1 postgres postgres &nbsp; &nbsp;0 Nov &nbsp;8 08:01 279531</font></div><div><font size="2"   >-rw------- 1 postgres postgres &nbsp; &nbsp;0 Nov &nbsp;8 08:01 279538</font></div><div><font size="2"   >-rw------- 1 postgres postgres 8.0K Nov &nbsp;8 08:01 279545</font></div><div><font size="2"   >-rw------- 1 postgres postgres &nbsp;24K Nov &nbsp;8 08:01 279545_fsm</font></div><div><font size="2"   >-rw------- 1 postgres postgres 8.0K Nov &nbsp;8 08:01 279545_vm</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >16408 为监控库oid :&nbsp;</span></div><div><span style="line-height: 28px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >sky_pg_cluster=# select datname from pg_database where oid=16408;</font></div><div><font size="2"   >&nbsp; &nbsp; datname &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;sky_pg_cluster</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>这里面除了<span style="line-height: 28px;"   >1188414, 其他的都是已经没有被引用的垃圾文件.</span></div><div><span style="line-height: 28px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >sky_pg_cluster=# select oid,* from pg_tablespace where spcname='tbs_rop';</font></div><div><font size="2"   >&nbsp; oid &nbsp;| spcname | spcowner | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;spcacl &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| spcoptions&nbsp;</font></div><div><font size="2"   >-------+---------+----------+--------------------------------------+------------</font></div><div><font size="2"   >&nbsp;16402 | tbs_rop | &nbsp; &nbsp; &nbsp; 10 | {postgres=C/postgres,rop=C/postgres} |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><div><font size="2"   >sky_pg_cluster=# select relname,relfilenode from pg_class where reltablespace =16402;</font></div><div><font size="2"   >&nbsp; relname &nbsp;| relfilenode&nbsp;</font></div><div><font size="2"   >-----------+-------------</font></div><div><font size="2"   >&nbsp;t_tbs_rop | &nbsp; &nbsp; 1188414</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>这些文件会带来一些问题, 因为没有被<span style="line-height: 28px;"   >sky_pg_cluster()这个库引用, 所以要删除这个表空间的话, 仅仅删除t_tbs_rop表是没用的, 这些文件会变成僵尸文件在里面, 导致无法执行drop tablespace tbs_rop;</span></div><div><span style="line-height: 28px;"   >使用以上监控方法还有一个弊端是, 会产生大量的xlog.</span></div><div>所以在执行<span style="line-height: 28px;"   >drop tablespace tbs_rop;之前, 需要手动删除这些僵尸文件.&nbsp;</span></div><div><span style="line-height: 28px;"   >或者使用drop database&nbsp;</span><span style="line-height: 28px;"   >sky_pg_cluster, 因为</span><span style="line-height: 28px;"   >drop database时会调用</span><span style="line-height: 28px;"   >remove_dbtablespaces(db_id); 移除所有表空间下的该数据库的子目录.&nbsp;</span></div><div><span style="line-height: 28px;"   >例如本文的</span><span style="line-height: 28px;"   >/data05/pgdata/charge/tbs_rop/PG_9.3_201306121/16408目录.</span></div><div>详见src/backend/commands/dbcommands.c</div><div><span style="line-height: 28px;"   ><br></span></div></span></div></span></div><div><span style="line-height: 28px;"   >现在这个监控函数改成这样 :&nbsp;</span></div><div><span style="line-height: 28px;"   >不需要在各个表空间之间移动表, 产生更少的xlog.</span></div><div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >create or replace function cluster_keepalive_test() returns void as $$</font></div><div style="line-height: 28px;"   ><font size="2"   >declare</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; v_spcname text;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; v_spcoid oid;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; v_nspname name := 'sky_pg_cluster';</font></div><div style="line-height: 28px;"   ><font size="2"   >begin</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; if ( pg_is_in_recovery() ) then</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice 'this is standby node.';</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; return;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; end if;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; update cluster_status set last_alive=now();</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; FOR v_spcname,v_spcoid IN&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; select spcname,oid from pg_tablespace where&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; oid &lt;&gt; (select dattablespace from pg_database where datname=current_database())</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; and spcname &lt;&gt; 'pg_global'&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; LOOP</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; perform 1 from pg_class where&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; reltablespace=v_spcoid&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; and relname='t_'||v_spcname&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; and relkind='r'&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; and relnamespace=(select oid from pg_namespace where nspname=v_nspname)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; limit 1;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; if not found then</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; execute 'create table '||v_nspname||'.t_'||v_spcname||' (crt_time timestamp) tablespace '||v_spcname;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; execute 'insert into '||v_nspname||'.t_'||v_spcname||' values ('''||now()||''')';</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; else</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; execute 'update '||v_nspname||'.t_'||v_spcname||' set crt_time='||''''||now()||'''';</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; end if;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; perform pg_stat_file(pg_relation_filepath(v_nspname||'.t_'||v_spcname));</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; END LOOP;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; select spcname into v_spcname from pg_tablespace where&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; oid = (select dattablespace from pg_database where datname=current_database());</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; perform 1 from pg_class where&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; reltablespace=0&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; and relname='t_'||v_spcname&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; and relkind='r'&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; and relnamespace=(select oid from pg_namespace where nspname=v_nspname)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; limit 1;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; if not found then</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; execute 'create table '||v_nspname||'.t_'||v_spcname||' (crt_time timestamp) tablespace '||v_spcname;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; execute 'insert into '||v_nspname||'.t_'||v_spcname||' values ('''||now()||''')';</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; else</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; execute 'update '||v_nspname||'.t_'||v_spcname||' set crt_time='||''''||now()||'''';</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; end if;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; perform pg_stat_file(pg_relation_filepath(v_nspname||'.t_'||v_spcname));</font></div><div style="line-height: 28px;"   ><font size="2"   >end;</font></div><div style="line-height: 28px;"   ><font size="2"   >$$ language plpgsql strict;</font></div><p></p></pre></div></div><div style="line-height: 28px;"   ><br></div></div><div style="line-height: 28px;"   >使用set tablespace时, 原来的数据文件会变成0kb的一个文件, 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-150-&gt; cd 16384/</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; ll</font></div><div><font size="2"   >total 24K</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 8.0K Nov 11 10:21 66570</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 8.0K Nov 11 10:21 66579</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 8.0K Nov 11 15:43 66591</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# alter table t_tbs_idx set tablespace pg_default ;</font></div><div><font size="2"   >ALTER TABLE</font></div></div><p></p></pre></div><div>再次查看该目录,&nbsp;<span style="line-height: 28px;"   >66579文件的size变0了.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; ll</font></div><div><font size="2"   >total 16K</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 8.0K Nov 11 10:21 66570</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 &nbsp; &nbsp;0 Nov 13 11:28 66579</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 8.0K Nov 11 15:43 66591</font></div><p></p></pre></div><div>执行完checkpoint, 这个文件才会被清除掉.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div></div><div><div><font size="2"   >pg93@db-172-16-3-150-&gt; ll</font></div><div><font size="2"   >total 16K</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 8.0K Nov 11 10:21 66570</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 8.0K Nov 11 15:43 66591</font></div></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div><div>remove_dbtablespaces和dropdb函数代码 :&nbsp;</div><div>src/backend/commands/dbcommands.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* Remove tablespace directories</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* We don't know what tablespaces db_id is using, so iterate through all</font></div><div><font size="2"   >&nbsp;* tablespaces removing &lt;tablespace&gt;/db_id</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static void</font></div><div><font size="2"   >remove_dbtablespaces(Oid db_id)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Relation &nbsp; &nbsp; &nbsp; &nbsp;rel;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; HeapScanDesc scan;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; HeapTuple &nbsp; &nbsp; &nbsp; tuple;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Snapshot &nbsp; &nbsp; &nbsp; &nbsp;snapshot;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* As in createdb(), we'd better use an MVCC snapshot here, since this</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* scan can run for a long time. &nbsp;Duplicate visits to tablespaces would be</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* harmless, but missing a tablespace could result in permanently leaked</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* files.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* XXX change this when a generic fix for SnapshotNow races is implemented</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; snapshot = RegisterSnapshot(GetLatestSnapshot());</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; rel = heap_open(TableSpaceRelationId, AccessShareLock);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; scan = heap_beginscan(rel, snapshot, 0, NULL);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; while ((tuple = heap_getnext(scan, ForwardScanDirection)) != NULL)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dsttablespace = HeapTupleGetOid(tuple);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *dstpath;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; struct stat st;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Don't mess with the global tablespace */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (dsttablespace == GLOBALTABLESPACE_OID)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; continue;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dstpath = GetDatabasePath(db_id, dsttablespace);</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (lstat(dstpath, &amp;st) &lt; 0 || !S_ISDIR(st.st_mode))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Assume we can ignore it */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pfree(dstpath);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; continue;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!rmtree(dstpath, true))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(WARNING,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errmsg("some useless files may be left behind in old database directory \"%s\"",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dstpath)));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Record the filesystem change in XLOG */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xl_dbase_drop_rec xlrec;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; XLogRecData rdata[1];</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xlrec.db_id = db_id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xlrec.tablespace_id = dsttablespace;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rdata[0].data = (char *) &amp;xlrec;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rdata[0].len = sizeof(xl_dbase_drop_rec);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rdata[0].buffer = InvalidBuffer;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rdata[0].next = NULL;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (void) XLogInsert(RM_DBASE_ID, XLOG_DBASE_DROP, rdata);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pfree(dstpath);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; heap_endscan(scan);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; heap_close(rel, AccessShareLock);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; UnregisterSnapshot(snapshot);</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   >........</font></div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* DROP DATABASE</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >void</font></div><div><font size="2"   >dropdb(const char *dbname, bool missing_ok)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db_id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bool &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;db_istemplate;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Relation &nbsp; &nbsp; &nbsp; &nbsp;pgdbrel;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; HeapTuple &nbsp; &nbsp; &nbsp; tup;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; notherbackends;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; npreparedxacts;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Look up the target database's OID, and get exclusive lock on it. We</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* need this to ensure that no new backend starts up in the target</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* database while we are deleting it (see postinit.c), and that no one is</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* using it as a CREATE DATABASE template or trying to delete it for</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* themselves.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; pgdbrel = heap_open(DatabaseRelationId, RowExclusiveLock);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!get_db_info(dbname, AccessExclusiveLock, &amp;db_id, NULL, NULL,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;db_istemplate, NULL, NULL, NULL, NULL, NULL, NULL, NULL))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!missing_ok)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_UNDEFINED_DATABASE),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("database \"%s\" does not exist", dbname)));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Close pg_database, release the lock, since we changed nothing */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; heap_close(pgdbrel, RowExclusiveLock);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(NOTICE,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errmsg("database \"%s\" does not exist, skipping",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dbname)));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Permission checks</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!pg_database_ownercheck(db_id, GetUserId()))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; aclcheck_error(ACLCHECK_NOT_OWNER, ACL_KIND_DATABASE,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dbname);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* DROP hook for the database being removed */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; InvokeObjectDropHook(DatabaseRelationId, db_id, 0);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Disallow dropping a DB that is marked istemplate. &nbsp;This is just to</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* prevent people from accidentally dropping template0 or template1; they</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* can do so if they're really determined ...</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (db_istemplate)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_WRONG_OBJECT_TYPE),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("cannot drop a template database")));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Obviously can't drop my own database */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (db_id == MyDatabaseId)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_OBJECT_IN_USE),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("cannot drop the currently open database")));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Check for other backends in the target database. &nbsp;(Because we hold the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* database lock, no new ones can start after this.)</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* As in CREATE DATABASE, check this after other error conditions.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (CountOtherDBBackends(db_id, &amp;notherbackends, &amp;npreparedxacts))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_OBJECT_IN_USE),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("database \"%s\" is being accessed by other users",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dbname),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errdetail_busy_db(notherbackends, npreparedxacts)));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Remove the database's tuple from pg_database.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; tup = SearchSysCache1(DATABASEOID, ObjectIdGetDatum(db_id));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!HeapTupleIsValid(tup))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, "cache lookup failed for database %u", db_id);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; simple_heap_delete(pgdbrel, &amp;tup-&gt;t_self);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ReleaseSysCache(tup);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Delete any comments or security labels associated with the database.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; DeleteSharedComments(db_id, DatabaseRelationId);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; DeleteSharedSecurityLabel(db_id, DatabaseRelationId);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Remove settings associated with this database</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; DropSetting(db_id, InvalidOid);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Remove shared dependency references for the database.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; dropDatabaseDependencies(db_id);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Drop pages for this database that are in the shared buffer cache. This</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* is important to ensure that no remaining backend tries to write out a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* dirty buffer to the dead database later...</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; DropDatabaseBuffers(db_id);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Tell the stats collector to forget it immediately, too.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; pgstat_drop_database(db_id);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Tell checkpointer to forget any pending fsync and unlink requests for</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* files in the database; else the fsyncs will fail at next checkpoint, or</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* worse, it will delete files that belong to a newly created database</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* with the same OID.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ForgetDatabaseFsyncRequests(db_id);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Force a checkpoint to make sure the checkpointer has received the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* message sent by ForgetDatabaseFsyncRequests. On Windows, this also</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* ensures that background procs don't hold any open files, which would</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* cause rmdir() to fail.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; RequestCheckpoint(CHECKPOINT_IMMEDIATE | CHECKPOINT_FORCE | CHECKPOINT_WAIT);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Remove all tablespace subdirs belonging to the database.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; remove_dbtablespaces(db_id);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Close pg_database, but keep lock till commit.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; heap_close(pgdbrel, NoLock);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Force synchronous commit, thus minimizing the window between removal of</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* the database files and commital of the transaction. If we crash before</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* committing, we'll have a DB that's gone on disk but still there</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* according to pg_database, which is not good.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ForceSyncCommit();</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;src/backend/commands/dbcommands.c</div><div>2.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://github.com/digoal/sky_postgresql_cluster"   >https://github.com/digoal/sky_postgresql_cluster</a></div><div><br></div><wbr></div>
	</div>
</div>
</body>
</html>