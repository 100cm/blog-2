<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL why use bitmap index scan on Mechanical DISK (not index scan)</h2>
	<h5 id="">2013-11-27 16:57:07&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013102735513534/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在上一篇文章中讲了一下explain cost常量的校准, 校准的目的是为了让explain输出的cost和实际的执行时间匹配.&nbsp;</div><div>感兴趣的童鞋可以参考 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201310255717379/"   >http://blog.163.com/digoal@126/blog/static/163877040201310255717379/</a></div><div>本文要讲一讲PostgreSQL的bitmap index scan.</div><div>通常索引的用法是index scan, 这种tuple fetch方法是按照索引的顺序来获取heap table中的实际数据的.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create table tbl(id int, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into tbl select trunc(random()*1000000), md5(random()::text), clock_timestamp() from generate_series(1,1000000);</font></div><div><font size="2"   >INSERT 0 1000000</font></div><div><font size="2"   >digoal=# create index idx_tbl_id on tbl(id);</font></div><div><font size="2"   >CREATE INDEX</font></div></div><div><div><font size="2"   >digoal=# explain analyze select ctid,* from tbl where id&lt;50;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Index Scan using idx_tbl_id on tbl &nbsp;(cost=0.42..46.19 rows=44 width=51) (actual time=0.010..0.138 rows=66 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Index Cond: (id &lt; 50)</font></div><div><font size="2"   >&nbsp;Total runtime: 0.179 ms</font></div><div><font size="2"   >(3 rows)</font></div></div><p></p></pre></div><div>实际输出的数据也是索引中组织的顺序(id的顺序),&nbsp;<span style="line-height: 28px;"   >但是这些记录在HEAP表中的顺序又是什么样的呢? 来看一下这个SQL语句的输出.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select ctid,* from tbl where id&lt;50;</font></div><div><font size="2"   >&nbsp; &nbsp; ctid &nbsp; &nbsp;| id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------+----+----------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp;(6746,88) &nbsp;| &nbsp;0 | 9d0bd1f9e2a2dec268176a1c30d35d91 | 2013-11-27 16:16:35.104228</font></div><div><font size="2"   >&nbsp;(3596,103) | &nbsp;0 | 8c9d231a02e9246494420502febdba98 | 2013-11-27 16:16:30.143426</font></div><div><font size="2"   >&nbsp;(7127,2) &nbsp; | &nbsp;1 | d380eebc0b204806a5561f88eac60c4c | 2013-11-27 16:16:35.710574</font></div><div><font size="2"   >&nbsp;(4182,57) &nbsp;| &nbsp;1 | 03512db2f998d2194704aa5841629800 | 2013-11-27 16:16:31.055188</font></div><div><font size="2"   >&nbsp;(2460,9) &nbsp; | &nbsp;3 | 2a18e2f0fea7edeca9eef178772a1443 | 2013-11-27 16:16:28.410977</font></div><div><font size="2"   >&nbsp;(1182,27) &nbsp;| &nbsp;3 | ad42e49c9dd9523c5cd09cd905f9bc6a | 2013-11-27 16:16:26.526868</font></div><div><font size="2"   >&nbsp;(2446,87) &nbsp;| &nbsp;5 | 3dc28dcdbe1f186ffee64167c39e4ac6 | 2013-11-27 16:16:28.391088</font></div><div><font size="2"   >&nbsp;(2186,88) &nbsp;| &nbsp;5 | d3e88acd04ebf1eee4f2ad9e027565e7 | 2013-11-27 16:16:28.000452</font></div><div><font size="2"   >&nbsp;(758,42) &nbsp; | &nbsp;6 | cf94371c57f37d8101578731cbd17fe5 | 2013-11-27 16:16:25.922565</font></div><div><font size="2"   >&nbsp;(8156,89) &nbsp;| &nbsp;7 | f98f8af894439a5a10c7b30cac5b55d6 | 2013-11-27 16:16:37.371522</font></div><div><font size="2"   >&nbsp;(7540,67) &nbsp;| &nbsp;7 | c699c7f1dc2e3f4641f107507a3f65c2 | 2013-11-27 16:16:36.377514</font></div><div><font size="2"   >&nbsp;(4535,61) &nbsp;| &nbsp;7 | 265b6ed28a52781effa88f131cd0760c | 2013-11-27 16:16:31.60564</font></div><div><font size="2"   >&nbsp;(3776,97) &nbsp;| &nbsp;8 | 19587be3f7c6f144a96104092054c24f | 2013-11-27 16:16:30.420263</font></div><div><font size="2"   >&nbsp;(6820,34) &nbsp;| &nbsp;9 | 45fd7be0d697474fb0a4fd06f7adbc66 | 2013-11-27 16:16:35.220746</font></div><div><font size="2"   >&nbsp;(4917,43) &nbsp;| &nbsp;9 | c5167d758c4756be4d5067e962e6ab35 | 2013-11-27 16:16:32.208947</font></div><div><font size="2"   >&nbsp;(4546,62) &nbsp;| &nbsp;9 | 8c84da762f082af53c9f6485997d483b | 2013-11-27 16:16:31.622895</font></div><div><font size="2"   >&nbsp;(321,47) &nbsp; | &nbsp;9 | 9862a95b4097dbd9cdc0604f4d30d626 | 2013-11-27 16:16:25.333253</font></div><div><font size="2"   >&nbsp;(6515,94) &nbsp;| 10 | 60b58e0c1893470b5820b24b27c435aa | 2013-11-27 16:16:34.731281</font></div><div><font size="2"   >&nbsp;(1781,22) &nbsp;| 11 | 27336b5bb9cb707f148f95104a8a37e1 | 2013-11-27 16:16:27.39882</font></div><div><font size="2"   >&nbsp;(549,92) &nbsp; | 11 | 71176a9fe423190a1016f7fbd88d793e | 2013-11-27 16:16:25.640157</font></div><div><font size="2"   >&nbsp;(6494,41) &nbsp;| 12 | 6949d23d991c96029f2aab78aad1a996 | 2013-11-27 16:16:34.69169</font></div><div><font size="2"   >&nbsp;(6233,61) &nbsp;| 12 | 1d9c712efffb3e46f7c2978237ebffc4 | 2013-11-27 16:16:34.278794</font></div><div><font size="2"   >&nbsp;(5093,54) &nbsp;| 13 | d32a1c91c1f0df37eeed380858056da9 | 2013-11-27 16:16:32.483506</font></div><div><font size="2"   >&nbsp;(8779,52) &nbsp;| 15 | d068fe97b4ae428067fac78f65a60aaf | 2013-11-27 16:16:38.377479</font></div><div><font size="2"   >&nbsp;(697,29) &nbsp; | 15 | eb3877f0c80ab774752a7f01b9f92e16 | 2013-11-27 16:16:25.840375</font></div><div><font size="2"   >&nbsp;(7848,47) &nbsp;| 17 | 2eab244114ea589567b67019dddcc80f | 2013-11-27 16:16:36.870001</font></div><div><font size="2"   >&nbsp;(6276,67) &nbsp;| 18 | 90a8aea4f33d2392227d201e7be7f454 | 2013-11-27 16:16:34.346321</font></div><div><font size="2"   >&nbsp;(4734,24) &nbsp;| 18 | 7683e2089ae935530ec7522e5b9fe659 | 2013-11-27 16:16:31.917192</font></div><div><font size="2"   >&nbsp;(619,49) &nbsp; | 20 | 28bf03bb27cfab74b9d82658f75065d6 | 2013-11-27 16:16:25.735401</font></div><div><font size="2"   >&nbsp;(5810,71) &nbsp;| 21 | f7d7d1d755dca861bf0b51d614a159b5 | 2013-11-27 16:16:33.612123</font></div><div><font size="2"   >&nbsp;(2910,82) &nbsp;| 21 | 48d6ea08185aa4931324ab2a480e2514 | 2013-11-27 16:16:29.092565</font></div><div><font size="2"   >&nbsp;(2175,99) &nbsp;| 21 | 26a9c1a2b4214dd5ea9889f37c683880 | 2013-11-27 16:16:27.984316</font></div><div><font size="2"   >&nbsp;(694,63) &nbsp; | 21 | 161e4e948613d1dafbcdcfb31140625e | 2013-11-27 16:16:25.836873</font></div><div><font size="2"   >&nbsp;(5144,100) | 22 | 578fbc1a322b6352c63b86160d91b378 | 2013-11-27 16:16:32.563874</font></div><div><font size="2"   >&nbsp;(595,72) &nbsp; | 22 | d437a5d81fbb1818caced949bee741cc | 2013-11-27 16:16:25.702936</font></div><div><font size="2"   >&nbsp;(9149,93) &nbsp;| 26 | a4e4cba8e85ec775142530c4d96c4dc3 | 2013-11-27 16:16:38.989989</font></div><div><font size="2"   >&nbsp;(4682,71) &nbsp;| 27 | 5b4b5628e93488b3bc1933e0dbff8e22 | 2013-11-27 16:16:31.837029</font></div><div><font size="2"   >&nbsp;(7123,80) &nbsp;| 31 | 2a2ac461aebc4bc58378ae20d258fabd | 2013-11-27 16:16:35.705067</font></div><div><font size="2"   >&nbsp;(4824,30) &nbsp;| 31 | c68ed527cac804d4ebdf4a463657dfcc | 2013-11-27 16:16:32.058964</font></div><div><font size="2"   >&nbsp;(6158,70) &nbsp;| 32 | c718372be46a253a29881e9585f921dd | 2013-11-27 16:16:34.160599</font></div><div><font size="2"   >&nbsp;(3765,30) &nbsp;| 32 | 00a45375579e1f43ceb7d8a873eba3f9 | 2013-11-27 16:16:30.402245</font></div><div><font size="2"   >&nbsp;(9132,81) &nbsp;| 33 | fbde79db78dffd8a072c363d9806bdcd | 2013-11-27 16:16:38.961699</font></div><div><font size="2"   >&nbsp;(7915,60) &nbsp;| 33 | 25c1cbef46a52e498bead19224978a82 | 2013-11-27 16:16:36.978633</font></div><div><font size="2"   >&nbsp;(2641,93) &nbsp;| 33 | 73a1563152d4efc5339418d2522e3063 | 2013-11-27 16:16:28.688222</font></div><div><font size="2"   >&nbsp;(6354,72) &nbsp;| 35 | 5c7dfc6b8a33d87e398230ea378636b6 | 2013-11-27 16:16:34.46999</font></div><div><font size="2"   >&nbsp;(398,15) &nbsp; | 35 | 080b1511185738c595027bc7e577b103 | 2013-11-27 16:16:25.434516</font></div><div><font size="2"   >&nbsp;(7941,95) &nbsp;| 36 | 5be05a35a63de2182b6f7800bcc62fe5 | 2013-11-27 16:16:37.020692</font></div><div><font size="2"   >&nbsp;(6795,34) &nbsp;| 38 | 8badab36f59646f528ad8609040f4f6a | 2013-11-27 16:16:35.180702</font></div><div><font size="2"   >&nbsp;(6674,29) &nbsp;| 38 | e47872e6791bb8435d03ae447e539378 | 2013-11-27 16:16:34.988681</font></div><div><font size="2"   >&nbsp;(6476,103) | 39 | 5fa14162be8c79a19b8c1399dff44f73 | 2013-11-27 16:16:34.663475</font></div><div><font size="2"   >&nbsp;(6765,88) &nbsp;| 40 | 6fb6e00224c36b8bdb596e3f0771c95a | 2013-11-27 16:16:35.134123</font></div><div><font size="2"   >&nbsp;(3008,16) &nbsp;| 40 | 10bb08a261eeb0d2a10710cd4e433ac8 | 2013-11-27 16:16:29.23959</font></div><div><font size="2"   >&nbsp;(6939,59) &nbsp;| 43 | 89d97fdd7668d4660e07e83cf140ac15 | 2013-11-27 16:16:35.411964</font></div><div><font size="2"   >&nbsp;(5734,68) &nbsp;| 44 | e031bd41748d4ffb453b284b2b4da980 | 2013-11-27 16:16:33.492805</font></div><div><font size="2"   >&nbsp;(5673,74) &nbsp;| 44 | 6d51ff56367a3f5697625c423611f103 | 2013-11-27 16:16:33.393517</font></div><div><font size="2"   >&nbsp;(4502,80) &nbsp;| 44 | 65c6eb557460a849071441dc2143e1d7 | 2013-11-27 16:16:31.553703</font></div><div><font size="2"   >&nbsp;(2940,31) &nbsp;| 44 | 052dba2a21dec816bf7f5da9aa9ce207 | 2013-11-27 16:16:29.137311</font></div><div><font size="2"   >&nbsp;(1718,41) &nbsp;| 44 | 5f4c9f63cf4e402411eb5f961caa7a74 | 2013-11-27 16:16:27.30134</font></div><div><font size="2"   >&nbsp;(576,3) &nbsp; &nbsp;| 44 | b5a10e2e82e3c7ec47dca7746683e7ec | 2013-11-27 16:16:25.675869</font></div><div><font size="2"   >&nbsp;(8775,30) &nbsp;| 45 | b653f3553f546b833d9ab0fb6ad7226d | 2013-11-27 16:16:38.370898</font></div><div><font size="2"   >&nbsp;(8150,98) &nbsp;| 45 | 275044af9ff53b2d6762c9521ccba083 | 2013-11-27 16:16:37.361846</font></div><div><font size="2"   >&nbsp;(2168,55) &nbsp;| 45 | 9514167ea164af19a21030ca54131978 | 2013-11-27 16:16:27.973063</font></div><div><font size="2"   >&nbsp;(782,55) &nbsp; | 45 | a1cb44ec4c1e21a6ec66e5ee598d5b1a | 2013-11-27 16:16:25.954953</font></div><div><font size="2"   >&nbsp;(6549,77) &nbsp;| 48 | 5199ff4dad52eec90396b2e818adb2bd | 2013-11-27 16:16:34.785146</font></div><div><font size="2"   >&nbsp;(2265,43) &nbsp;| 48 | 6379ccacebcd0c44fa6482ba528cf987 | 2013-11-27 16:16:28.118353</font></div><div><font size="2"   >&nbsp;(3926,68) &nbsp;| 49 | 6a923f5cd98b6400f54da62b136123dd | 2013-11-27 16:16:30.651638</font></div><div><font size="2"   >(66 rows)</font></div><p></p></pre></div><div>从输出结果我们可以看出, HEAP表中存储的顺序和ID的排序完全无关, 对于机械盘, 随机块扫描比连续的数据块扫描要慢很多, 这在我以前写的一篇 BLOG中使用systemtap跟踪过, 数据可以通过柱状图直观的观察到.</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201310255717379/"   >http://blog.163.com/digoal@126/blog/static/163877040201310255717379/</a></div><div>那么我们要在这个SQL中优化IO响应怎么办呢? PostgreSQL提供了bitmap index scan这种tuple fetch方法.</div><div>bitmap index scan中, PostgreSQL从索引中取出itempoint中的blocknum, 这些blocknum排序后转到bitmap heap scan. 因为从bitmap index scan中得到的部署itempoint , 而是itempoint中的blocknum, 所以在bitmap heap scan时只有blocknum的信息, 而不是精准的itempoint, 总共需要两次check (一次发生在bitmap index scan, 另一次发生在bitmap heap scan).</div><div>如下, 将random_page_cost调整为40, 这样的话, index scan的成本就高了. PostgreSQL会选择bitmap index scan来降低random scan带来的开销.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# set random_page_cost=40;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# explain analyze select ctid,* from tbl where id&lt;50;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Bitmap Heap Scan on tbl &nbsp;(cost=40.77..1683.57 rows=44 width=51) (actual time=0.043..0.189 rows=66 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Recheck Cond: (id &lt; 50)  -- 二次CHECK, 因为从bitmap index scan只提供块的信息,没有item offset</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on idx_tbl_id &nbsp;(cost=0.00..40.75 rows=44 width=0) (actual time=0.021..0.021 rows=66 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (id &lt; 50)  -- 一次CHECK</font></div><div><font size="2"   >&nbsp;Total runtime: 0.230 ms</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div><div>通过bitmap scan的输出如下, 我们看到输出顺序以及按照blocknum排序了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select ctid,* from tbl where id&lt;50;</font></div><div><font size="2"   >&nbsp; &nbsp; ctid &nbsp; &nbsp;| id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------+----+----------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp;(321,47) &nbsp; | &nbsp;9 | 9862a95b4097dbd9cdc0604f4d30d626 | 2013-11-27 16:16:25.333253</font></div><div><font size="2"   >&nbsp;(398,15) &nbsp; | 35 | 080b1511185738c595027bc7e577b103 | 2013-11-27 16:16:25.434516</font></div><div><font size="2"   >&nbsp;(549,92) &nbsp; | 11 | 71176a9fe423190a1016f7fbd88d793e | 2013-11-27 16:16:25.640157</font></div><div><font size="2"   >&nbsp;(576,3) &nbsp; &nbsp;| 44 | b5a10e2e82e3c7ec47dca7746683e7ec | 2013-11-27 16:16:25.675869</font></div><div><font size="2"   >&nbsp;(595,72) &nbsp; | 22 | d437a5d81fbb1818caced949bee741cc | 2013-11-27 16:16:25.702936</font></div><div><font size="2"   >&nbsp;(619,49) &nbsp; | 20 | 28bf03bb27cfab74b9d82658f75065d6 | 2013-11-27 16:16:25.735401</font></div><div><font size="2"   >&nbsp;(694,63) &nbsp; | 21 | 161e4e948613d1dafbcdcfb31140625e | 2013-11-27 16:16:25.836873</font></div><div><font size="2"   >&nbsp;(697,29) &nbsp; | 15 | eb3877f0c80ab774752a7f01b9f92e16 | 2013-11-27 16:16:25.840375</font></div><div><font size="2"   >&nbsp;(758,42) &nbsp; | &nbsp;6 | cf94371c57f37d8101578731cbd17fe5 | 2013-11-27 16:16:25.922565</font></div><div><font size="2"   >&nbsp;(782,55) &nbsp; | 45 | a1cb44ec4c1e21a6ec66e5ee598d5b1a | 2013-11-27 16:16:25.954953</font></div><div><font size="2"   >&nbsp;(1182,27) &nbsp;| &nbsp;3 | ad42e49c9dd9523c5cd09cd905f9bc6a | 2013-11-27 16:16:26.526868</font></div><div><font size="2"   >&nbsp;(1718,41) &nbsp;| 44 | 5f4c9f63cf4e402411eb5f961caa7a74 | 2013-11-27 16:16:27.30134</font></div><div><font size="2"   >&nbsp;(1781,22) &nbsp;| 11 | 27336b5bb9cb707f148f95104a8a37e1 | 2013-11-27 16:16:27.39882</font></div><div><font size="2"   >&nbsp;(2168,55) &nbsp;| 45 | 9514167ea164af19a21030ca54131978 | 2013-11-27 16:16:27.973063</font></div><div><font size="2"   >&nbsp;(2175,99) &nbsp;| 21 | 26a9c1a2b4214dd5ea9889f37c683880 | 2013-11-27 16:16:27.984316</font></div><div><font size="2"   >&nbsp;(2186,88) &nbsp;| &nbsp;5 | d3e88acd04ebf1eee4f2ad9e027565e7 | 2013-11-27 16:16:28.000452</font></div><div><font size="2"   >&nbsp;(2265,43) &nbsp;| 48 | 6379ccacebcd0c44fa6482ba528cf987 | 2013-11-27 16:16:28.118353</font></div><div><font size="2"   >&nbsp;(2446,87) &nbsp;| &nbsp;5 | 3dc28dcdbe1f186ffee64167c39e4ac6 | 2013-11-27 16:16:28.391088</font></div><div><font size="2"   >&nbsp;(2460,9) &nbsp; | &nbsp;3 | 2a18e2f0fea7edeca9eef178772a1443 | 2013-11-27 16:16:28.410977</font></div><div><font size="2"   >&nbsp;(2641,93) &nbsp;| 33 | 73a1563152d4efc5339418d2522e3063 | 2013-11-27 16:16:28.688222</font></div><div><font size="2"   >&nbsp;(2910,82) &nbsp;| 21 | 48d6ea08185aa4931324ab2a480e2514 | 2013-11-27 16:16:29.092565</font></div><div><font size="2"   >&nbsp;(2940,31) &nbsp;| 44 | 052dba2a21dec816bf7f5da9aa9ce207 | 2013-11-27 16:16:29.137311</font></div><div><font size="2"   >&nbsp;(3008,16) &nbsp;| 40 | 10bb08a261eeb0d2a10710cd4e433ac8 | 2013-11-27 16:16:29.23959</font></div><div><font size="2"   >&nbsp;(3596,103) | &nbsp;0 | 8c9d231a02e9246494420502febdba98 | 2013-11-27 16:16:30.143426</font></div><div><font size="2"   >&nbsp;(3765,30) &nbsp;| 32 | 00a45375579e1f43ceb7d8a873eba3f9 | 2013-11-27 16:16:30.402245</font></div><div><font size="2"   >&nbsp;(3776,97) &nbsp;| &nbsp;8 | 19587be3f7c6f144a96104092054c24f | 2013-11-27 16:16:30.420263</font></div><div><font size="2"   >&nbsp;(3926,68) &nbsp;| 49 | 6a923f5cd98b6400f54da62b136123dd | 2013-11-27 16:16:30.651638</font></div><div><font size="2"   >&nbsp;(4182,57) &nbsp;| &nbsp;1 | 03512db2f998d2194704aa5841629800 | 2013-11-27 16:16:31.055188</font></div><div><font size="2"   >&nbsp;(4502,80) &nbsp;| 44 | 65c6eb557460a849071441dc2143e1d7 | 2013-11-27 16:16:31.553703</font></div><div><font size="2"   >&nbsp;(4535,61) &nbsp;| &nbsp;7 | 265b6ed28a52781effa88f131cd0760c | 2013-11-27 16:16:31.60564</font></div><div><font size="2"   >&nbsp;(4546,62) &nbsp;| &nbsp;9 | 8c84da762f082af53c9f6485997d483b | 2013-11-27 16:16:31.622895</font></div><div><font size="2"   >&nbsp;(4682,71) &nbsp;| 27 | 5b4b5628e93488b3bc1933e0dbff8e22 | 2013-11-27 16:16:31.837029</font></div><div><font size="2"   >&nbsp;(4734,24) &nbsp;| 18 | 7683e2089ae935530ec7522e5b9fe659 | 2013-11-27 16:16:31.917192</font></div><div><font size="2"   >&nbsp;(4824,30) &nbsp;| 31 | c68ed527cac804d4ebdf4a463657dfcc | 2013-11-27 16:16:32.058964</font></div><div><font size="2"   >&nbsp;(4917,43) &nbsp;| &nbsp;9 | c5167d758c4756be4d5067e962e6ab35 | 2013-11-27 16:16:32.208947</font></div><div><font size="2"   >&nbsp;(5093,54) &nbsp;| 13 | d32a1c91c1f0df37eeed380858056da9 | 2013-11-27 16:16:32.483506</font></div><div><font size="2"   >&nbsp;(5144,100) | 22 | 578fbc1a322b6352c63b86160d91b378 | 2013-11-27 16:16:32.563874</font></div><div><font size="2"   >&nbsp;(5673,74) &nbsp;| 44 | 6d51ff56367a3f5697625c423611f103 | 2013-11-27 16:16:33.393517</font></div><div><font size="2"   >&nbsp;(5734,68) &nbsp;| 44 | e031bd41748d4ffb453b284b2b4da980 | 2013-11-27 16:16:33.492805</font></div><div><font size="2"   >&nbsp;(5810,71) &nbsp;| 21 | f7d7d1d755dca861bf0b51d614a159b5 | 2013-11-27 16:16:33.612123</font></div><div><font size="2"   >&nbsp;(6158,70) &nbsp;| 32 | c718372be46a253a29881e9585f921dd | 2013-11-27 16:16:34.160599</font></div><div><font size="2"   >&nbsp;(6233,61) &nbsp;| 12 | 1d9c712efffb3e46f7c2978237ebffc4 | 2013-11-27 16:16:34.278794</font></div><div><font size="2"   >&nbsp;(6276,67) &nbsp;| 18 | 90a8aea4f33d2392227d201e7be7f454 | 2013-11-27 16:16:34.346321</font></div><div><font size="2"   >&nbsp;(6354,72) &nbsp;| 35 | 5c7dfc6b8a33d87e398230ea378636b6 | 2013-11-27 16:16:34.46999</font></div><div><font size="2"   >&nbsp;(6476,103) | 39 | 5fa14162be8c79a19b8c1399dff44f73 | 2013-11-27 16:16:34.663475</font></div><div><font size="2"   >&nbsp;(6494,41) &nbsp;| 12 | 6949d23d991c96029f2aab78aad1a996 | 2013-11-27 16:16:34.69169</font></div><div><font size="2"   >&nbsp;(6515,94) &nbsp;| 10 | 60b58e0c1893470b5820b24b27c435aa | 2013-11-27 16:16:34.731281</font></div><div><font size="2"   >&nbsp;(6549,77) &nbsp;| 48 | 5199ff4dad52eec90396b2e818adb2bd | 2013-11-27 16:16:34.785146</font></div><div><font size="2"   >&nbsp;(6674,29) &nbsp;| 38 | e47872e6791bb8435d03ae447e539378 | 2013-11-27 16:16:34.988681</font></div><div><font size="2"   >&nbsp;(6746,88) &nbsp;| &nbsp;0 | 9d0bd1f9e2a2dec268176a1c30d35d91 | 2013-11-27 16:16:35.104228</font></div><div><font size="2"   >&nbsp;(6765,88) &nbsp;| 40 | 6fb6e00224c36b8bdb596e3f0771c95a | 2013-11-27 16:16:35.134123</font></div><div><font size="2"   >&nbsp;(6795,34) &nbsp;| 38 | 8badab36f59646f528ad8609040f4f6a | 2013-11-27 16:16:35.180702</font></div><div><font size="2"   >&nbsp;(6820,34) &nbsp;| &nbsp;9 | 45fd7be0d697474fb0a4fd06f7adbc66 | 2013-11-27 16:16:35.220746</font></div><div><font size="2"   >&nbsp;(6939,59) &nbsp;| 43 | 89d97fdd7668d4660e07e83cf140ac15 | 2013-11-27 16:16:35.411964</font></div><div><font size="2"   >&nbsp;(7123,80) &nbsp;| 31 | 2a2ac461aebc4bc58378ae20d258fabd | 2013-11-27 16:16:35.705067</font></div><div><font size="2"   >&nbsp;(7127,2) &nbsp; | &nbsp;1 | d380eebc0b204806a5561f88eac60c4c | 2013-11-27 16:16:35.710574</font></div><div><font size="2"   >&nbsp;(7540,67) &nbsp;| &nbsp;7 | c699c7f1dc2e3f4641f107507a3f65c2 | 2013-11-27 16:16:36.377514</font></div><div><font size="2"   >&nbsp;(7848,47) &nbsp;| 17 | 2eab244114ea589567b67019dddcc80f | 2013-11-27 16:16:36.870001</font></div><div><font size="2"   >&nbsp;(7915,60) &nbsp;| 33 | 25c1cbef46a52e498bead19224978a82 | 2013-11-27 16:16:36.978633</font></div><div><font size="2"   >&nbsp;(7941,95) &nbsp;| 36 | 5be05a35a63de2182b6f7800bcc62fe5 | 2013-11-27 16:16:37.020692</font></div><div><font size="2"   >&nbsp;(8150,98) &nbsp;| 45 | 275044af9ff53b2d6762c9521ccba083 | 2013-11-27 16:16:37.361846</font></div><div><font size="2"   >&nbsp;(8156,89) &nbsp;| &nbsp;7 | f98f8af894439a5a10c7b30cac5b55d6 | 2013-11-27 16:16:37.371522</font></div><div><font size="2"   >&nbsp;(8775,30) &nbsp;| 45 | b653f3553f546b833d9ab0fb6ad7226d | 2013-11-27 16:16:38.370898</font></div><div><font size="2"   >&nbsp;(8779,52) &nbsp;| 15 | d068fe97b4ae428067fac78f65a60aaf | 2013-11-27 16:16:38.377479</font></div><div><font size="2"   >&nbsp;(9132,81) &nbsp;| 33 | fbde79db78dffd8a072c363d9806bdcd | 2013-11-27 16:16:38.961699</font></div><div><font size="2"   >&nbsp;(9149,93) &nbsp;| 26 | a4e4cba8e85ec775142530c4d96c4dc3 | 2013-11-27 16:16:38.989989</font></div><div><font size="2"   >(66 rows)</font></div><p></p></pre></div><div>对于非机械盘, 或者这部分数据已经在OS CACHE 或者PostgreSQL shared buffer中的情况, 使用bitmap scan则毫无用处. 反而会增加block排序以及多次check带来的cpu operator开销.</div><div>另外需要提一下, 对于机械盘, 如果是经常有按照某列做范围查询的需求, 可以对这个表根据这个列上的索引做一下cluster. (还需要注意cluster是DDL操作, 会带来排他锁和对这个表的重组, 导致所有索引需要重建, 推荐DML较少的大表在有此类需求的情况下可以考虑) .&nbsp;</div><div>做完cluster后, heap table中的存储顺序则与这个列的索引排序一致了.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# cluster tbl USING idx_tbl_id ;</font></div><div><font size="2"   >CLUSTER</font></div></div><div><div><font size="2"   >digoal=# set enable_bitmapscan=off;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=# select ctid,* from tbl where id&lt;50;</font></div><div><font size="2"   >&nbsp; ctid &nbsp;| id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >--------+----+----------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp;(0,1) &nbsp;| &nbsp;0 | 8c9d231a02e9246494420502febdba98 | 2013-11-27 16:16:30.143426</font></div><div><font size="2"   >&nbsp;(0,2) &nbsp;| &nbsp;0 | 9d0bd1f9e2a2dec268176a1c30d35d91 | 2013-11-27 16:16:35.104228</font></div><div><font size="2"   >&nbsp;(0,3) &nbsp;| &nbsp;1 | d380eebc0b204806a5561f88eac60c4c | 2013-11-27 16:16:35.710574</font></div><div><font size="2"   >&nbsp;(0,4) &nbsp;| &nbsp;1 | 03512db2f998d2194704aa5841629800 | 2013-11-27 16:16:31.055188</font></div><div><font size="2"   >&nbsp;(0,5) &nbsp;| &nbsp;3 | 2a18e2f0fea7edeca9eef178772a1443 | 2013-11-27 16:16:28.410977</font></div><div><font size="2"   >&nbsp;(0,6) &nbsp;| &nbsp;3 | ad42e49c9dd9523c5cd09cd905f9bc6a | 2013-11-27 16:16:26.526868</font></div><div><font size="2"   >&nbsp;(0,7) &nbsp;| &nbsp;5 | d3e88acd04ebf1eee4f2ad9e027565e7 | 2013-11-27 16:16:28.000452</font></div><div><font size="2"   >&nbsp;(0,8) &nbsp;| &nbsp;5 | 3dc28dcdbe1f186ffee64167c39e4ac6 | 2013-11-27 16:16:28.391088</font></div><div><font size="2"   >&nbsp;(0,9) &nbsp;| &nbsp;6 | cf94371c57f37d8101578731cbd17fe5 | 2013-11-27 16:16:25.922565</font></div><div><font size="2"   >&nbsp;(0,10) | &nbsp;7 | 265b6ed28a52781effa88f131cd0760c | 2013-11-27 16:16:31.60564</font></div><div><font size="2"   >&nbsp;(0,11) | &nbsp;7 | f98f8af894439a5a10c7b30cac5b55d6 | 2013-11-27 16:16:37.371522</font></div><div><font size="2"   >&nbsp;(0,12) | &nbsp;7 | c699c7f1dc2e3f4641f107507a3f65c2 | 2013-11-27 16:16:36.377514</font></div><div><font size="2"   >&nbsp;(0,13) | &nbsp;8 | 19587be3f7c6f144a96104092054c24f | 2013-11-27 16:16:30.420263</font></div><div><font size="2"   >&nbsp;(0,14) | &nbsp;9 | 9862a95b4097dbd9cdc0604f4d30d626 | 2013-11-27 16:16:25.333253</font></div><div><font size="2"   >&nbsp;(0,15) | &nbsp;9 | 8c84da762f082af53c9f6485997d483b | 2013-11-27 16:16:31.622895</font></div><div><font size="2"   >&nbsp;(0,16) | &nbsp;9 | c5167d758c4756be4d5067e962e6ab35 | 2013-11-27 16:16:32.208947</font></div><div><font size="2"   >&nbsp;(0,17) | &nbsp;9 | 45fd7be0d697474fb0a4fd06f7adbc66 | 2013-11-27 16:16:35.220746</font></div><div><font size="2"   >&nbsp;(0,18) | 10 | 60b58e0c1893470b5820b24b27c435aa | 2013-11-27 16:16:34.731281</font></div><div><font size="2"   >&nbsp;(0,19) | 11 | 27336b5bb9cb707f148f95104a8a37e1 | 2013-11-27 16:16:27.39882</font></div><div><font size="2"   >&nbsp;(0,20) | 11 | 71176a9fe423190a1016f7fbd88d793e | 2013-11-27 16:16:25.640157</font></div><div><font size="2"   >&nbsp;(0,21) | 12 | 1d9c712efffb3e46f7c2978237ebffc4 | 2013-11-27 16:16:34.278794</font></div><div><font size="2"   >&nbsp;(0,22) | 12 | 6949d23d991c96029f2aab78aad1a996 | 2013-11-27 16:16:34.69169</font></div><div><font size="2"   >&nbsp;(0,23) | 13 | d32a1c91c1f0df37eeed380858056da9 | 2013-11-27 16:16:32.483506</font></div><div><font size="2"   >&nbsp;(0,24) | 15 | d068fe97b4ae428067fac78f65a60aaf | 2013-11-27 16:16:38.377479</font></div><div><font size="2"   >&nbsp;(0,25) | 15 | eb3877f0c80ab774752a7f01b9f92e16 | 2013-11-27 16:16:25.840375</font></div><div><font size="2"   >&nbsp;(0,26) | 17 | 2eab244114ea589567b67019dddcc80f | 2013-11-27 16:16:36.870001</font></div><div><font size="2"   >&nbsp;(0,27) | 18 | 7683e2089ae935530ec7522e5b9fe659 | 2013-11-27 16:16:31.917192</font></div><div><font size="2"   >&nbsp;(0,28) | 18 | 90a8aea4f33d2392227d201e7be7f454 | 2013-11-27 16:16:34.346321</font></div><div><font size="2"   >&nbsp;(0,29) | 20 | 28bf03bb27cfab74b9d82658f75065d6 | 2013-11-27 16:16:25.735401</font></div><div><font size="2"   >&nbsp;(0,30) | 21 | 26a9c1a2b4214dd5ea9889f37c683880 | 2013-11-27 16:16:27.984316</font></div><div><font size="2"   >&nbsp;(0,31) | 21 | f7d7d1d755dca861bf0b51d614a159b5 | 2013-11-27 16:16:33.612123</font></div><div><font size="2"   >&nbsp;(0,32) | 21 | 161e4e948613d1dafbcdcfb31140625e | 2013-11-27 16:16:25.836873</font></div><div><font size="2"   >&nbsp;(0,33) | 21 | 48d6ea08185aa4931324ab2a480e2514 | 2013-11-27 16:16:29.092565</font></div><div><font size="2"   >&nbsp;(0,34) | 22 | d437a5d81fbb1818caced949bee741cc | 2013-11-27 16:16:25.702936</font></div><div><font size="2"   >&nbsp;(0,35) | 22 | 578fbc1a322b6352c63b86160d91b378 | 2013-11-27 16:16:32.563874</font></div><div><font size="2"   >&nbsp;(0,36) | 26 | a4e4cba8e85ec775142530c4d96c4dc3 | 2013-11-27 16:16:38.989989</font></div><div><font size="2"   >&nbsp;(0,37) | 27 | 5b4b5628e93488b3bc1933e0dbff8e22 | 2013-11-27 16:16:31.837029</font></div><div><font size="2"   >&nbsp;(0,38) | 31 | c68ed527cac804d4ebdf4a463657dfcc | 2013-11-27 16:16:32.058964</font></div><div><font size="2"   >&nbsp;(0,39) | 31 | 2a2ac461aebc4bc58378ae20d258fabd | 2013-11-27 16:16:35.705067</font></div><div><font size="2"   >&nbsp;(0,40) | 32 | c718372be46a253a29881e9585f921dd | 2013-11-27 16:16:34.160599</font></div><div><font size="2"   >&nbsp;(0,41) | 32 | 00a45375579e1f43ceb7d8a873eba3f9 | 2013-11-27 16:16:30.402245</font></div><div><font size="2"   >&nbsp;(0,42) | 33 | 73a1563152d4efc5339418d2522e3063 | 2013-11-27 16:16:28.688222</font></div><div><font size="2"   >&nbsp;(0,43) | 33 | fbde79db78dffd8a072c363d9806bdcd | 2013-11-27 16:16:38.961699</font></div><div><font size="2"   >&nbsp;(0,44) | 33 | 25c1cbef46a52e498bead19224978a82 | 2013-11-27 16:16:36.978633</font></div><div><font size="2"   >&nbsp;(0,45) | 35 | 5c7dfc6b8a33d87e398230ea378636b6 | 2013-11-27 16:16:34.46999</font></div><div><font size="2"   >&nbsp;(0,46) | 35 | 080b1511185738c595027bc7e577b103 | 2013-11-27 16:16:25.434516</font></div><div><font size="2"   >&nbsp;(0,47) | 36 | 5be05a35a63de2182b6f7800bcc62fe5 | 2013-11-27 16:16:37.020692</font></div><div><font size="2"   >&nbsp;(0,48) | 38 | e47872e6791bb8435d03ae447e539378 | 2013-11-27 16:16:34.988681</font></div><div><font size="2"   >&nbsp;(0,49) | 38 | 8badab36f59646f528ad8609040f4f6a | 2013-11-27 16:16:35.180702</font></div><div><font size="2"   >&nbsp;(0,50) | 39 | 5fa14162be8c79a19b8c1399dff44f73 | 2013-11-27 16:16:34.663475</font></div><div><font size="2"   >&nbsp;(0,51) | 40 | 6fb6e00224c36b8bdb596e3f0771c95a | 2013-11-27 16:16:35.134123</font></div><div><font size="2"   >&nbsp;(0,52) | 40 | 10bb08a261eeb0d2a10710cd4e433ac8 | 2013-11-27 16:16:29.23959</font></div><div><font size="2"   >&nbsp;(0,53) | 43 | 89d97fdd7668d4660e07e83cf140ac15 | 2013-11-27 16:16:35.411964</font></div><div><font size="2"   >&nbsp;(0,54) | 44 | 65c6eb557460a849071441dc2143e1d7 | 2013-11-27 16:16:31.553703</font></div><div><font size="2"   >&nbsp;(0,55) | 44 | 052dba2a21dec816bf7f5da9aa9ce207 | 2013-11-27 16:16:29.137311</font></div><div><font size="2"   >&nbsp;(0,56) | 44 | 6d51ff56367a3f5697625c423611f103 | 2013-11-27 16:16:33.393517</font></div><div><font size="2"   >&nbsp;(0,57) | 44 | e031bd41748d4ffb453b284b2b4da980 | 2013-11-27 16:16:33.492805</font></div><div><font size="2"   >&nbsp;(0,58) | 44 | 5f4c9f63cf4e402411eb5f961caa7a74 | 2013-11-27 16:16:27.30134</font></div><div><font size="2"   >&nbsp;(0,59) | 44 | b5a10e2e82e3c7ec47dca7746683e7ec | 2013-11-27 16:16:25.675869</font></div><div><font size="2"   >&nbsp;(0,60) | 45 | b653f3553f546b833d9ab0fb6ad7226d | 2013-11-27 16:16:38.370898</font></div><div><font size="2"   >&nbsp;(0,61) | 45 | 9514167ea164af19a21030ca54131978 | 2013-11-27 16:16:27.973063</font></div><div><font size="2"   >&nbsp;(0,62) | 45 | a1cb44ec4c1e21a6ec66e5ee598d5b1a | 2013-11-27 16:16:25.954953</font></div><div><font size="2"   >&nbsp;(0,63) | 45 | 275044af9ff53b2d6762c9521ccba083 | 2013-11-27 16:16:37.361846</font></div><div><font size="2"   >&nbsp;(0,64) | 48 | 5199ff4dad52eec90396b2e818adb2bd | 2013-11-27 16:16:34.785146</font></div><div><font size="2"   >&nbsp;(0,65) | 48 | 6379ccacebcd0c44fa6482ba528cf987 | 2013-11-27 16:16:28.118353</font></div><div><font size="2"   >&nbsp;(0,66) | 49 | 6a923f5cd98b6400f54da62b136123dd | 2013-11-27 16:16:30.651638</font></div><div><font size="2"   >(66 rows)</font></div></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;src/backend/commands/explain.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* ExplainNode -</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;Appends a description of a plan tree to es-&gt;str</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* planstate points to the executor state node for the current plan node.</font></div><div><font size="2"   >&nbsp;* We need to work from a PlanState node, not just a Plan node, in order to</font></div><div><font size="2"   >&nbsp;* get at the instrumentation data (if any) as well as the list of subplans.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* ancestors is a list of parent PlanState nodes, most-closely-nested first.</font></div><div><font size="2"   >&nbsp;* These are needed in order to interpret PARAM_EXEC Params.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* relationship describes the relationship of this plan node to its parent</font></div><div><font size="2"   >&nbsp;* (eg, "Outer", "Inner"); it can be null at top level. &nbsp;plan_name is an</font></div><div><font size="2"   >&nbsp;* optional name to be attached to the node.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* In text format, es-&gt;indent is controlled in this function since we only</font></div><div><font size="2"   >&nbsp;* want it to change at plan-node boundaries. &nbsp;In non-text formats, es-&gt;indent</font></div><div><font size="2"   >&nbsp;* corresponds to the nesting depth of logical output groups, and therefore</font></div><div><font size="2"   >&nbsp;* is controlled by ExplainOpenGroup/ExplainCloseGroup.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static void</font></div><div><font size="2"   >ExplainNode(PlanState *planstate, List *ancestors,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; const char *relationship, const char *plan_name,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ExplainState *es)</font></div><div><font size="2"   >{</font></div></div><div><font size="2"   >...略</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_BitmapHeapScan:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; show_scan_qual(((BitmapHeapScan *) plan)-&gt;bitmapqualorig,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"Recheck Cond", planstate, ancestors, es);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (((BitmapHeapScan *) plan)-&gt;bitmapqualorig)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; show_instrumentation_count("Rows Removed by Index Recheck", 2,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;planstate, es);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* FALL THRU */</font></div></div><div><font size="2"   >...略</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >2.&nbsp;src/backend/nodes/tidbitmap.c</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;* tidbitmap.c</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;PostgreSQL tuple-id (TID) bitmap package</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* This module provides bitmap data structures that are spiritually</font></div><div><font size="2"   >&nbsp;* similar to Bitmapsets, but are specially adapted to store sets of</font></div><div><font size="2"   >&nbsp;* tuple identifiers (TIDs), or ItemPointers. &nbsp;In particular, the division</font></div><div><font size="2"   >&nbsp;* of an ItemPointer into BlockNumber and OffsetNumber is catered for.</font></div><div><font size="2"   >&nbsp;* Also, since we wish to be able to store very large tuple sets in</font></div><div><font size="2"   >&nbsp;* memory with this data structure, we support "lossy" storage, in which</font></div><div><font size="2"   >&nbsp;* we no longer remember individual tuple offsets on a page but only the</font></div><div><font size="2"   >&nbsp;* fact that a particular page needs to be visited.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* The "lossy" storage uses one bit per disk page, so at the standard 8K  -- "失真"存储, 只存储块信息, 所以带来了二次check</font></div><div><font size="2"   >&nbsp;* BLCKSZ, we can represent all pages in 64Gb of disk space in about 1Mb</font></div><div><font size="2"   >&nbsp;* of memory. &nbsp;People pushing around tables of that size should have a</font></div><div><font size="2"   >&nbsp;* couple of Mb to spare, so we don't worry about providing a second level</font></div><div><font size="2"   >&nbsp;* of lossiness. &nbsp;In theory we could fall back to page ranges at some</font></div><div><font size="2"   >&nbsp;* point, but for now that seems useless complexity.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* We also support the notion of candidate matches, or rechecking. &nbsp; &nbsp; &nbsp;This</font></div><div><font size="2"   >&nbsp;* means we know that a search need visit only some tuples on a page,</font></div><div><font size="2"   >&nbsp;* but we are not certain that all of those tuples are real matches.</font></div><div><font size="2"   >&nbsp;* So the eventual heap scan must recheck the quals for these tuples only,</font></div><div><font size="2"   >&nbsp;* rather than rechecking the quals for all tuples on the page as in the</font></div><div><font size="2"   >&nbsp;* lossy-bitmap case. &nbsp;Rechecking can be specified when TIDs are inserted</font></div><div><font size="2"   >&nbsp;* into a bitmap, and it can also happen internally when we AND a lossy</font></div><div><font size="2"   >&nbsp;* and a non-lossy page.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Copyright (c) 2003-2013, PostgreSQL Global Development Group</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* IDENTIFICATION</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;src/backend/nodes/tidbitmap.c</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >3.&nbsp;</span><a style="line-height: 28px;" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/using-explain.html"   >http://www.postgresql.org/docs/9.3/static/using-explain.html</a></div><div>4.&nbsp;<a style="line-height: 28px;" href="http://blog.163.com/digoal@126/blog/static/163877040201310255717379/"   >http://blog.163.com/digoal@126/blog/static/163877040201310255717379/</a></div></div>
	</div>
</div>
</body>
</html>