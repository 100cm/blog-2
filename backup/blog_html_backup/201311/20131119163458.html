<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap examples, Profiling - 1 Counting Function Calls Made</h2>
	<h5 id="">2013-11-19 16:34:58&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013101941820312/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>接下来开始对systemtap example的另一个分类Profiling做一些例子的讲解.</div><div>例子来自functioncallcount.stp 脚本, 该脚本通过函数的调用情况分析<span style="line-height: 28px;"   >内核活动</span><span style="line-height: 28px;"   >. 由于没有终止时间, 同时使用统计类型性能不如数组自增, 所以我做了相应的修改. (但是请注意数组以及全局标量自增是需要锁的, 所以在多CPU(SMP)的系统中并行的自增会带来一定问题.而统计类型不会有这个问题)</span></div><div>修改后的脚本内容以及注解 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 network]# cd /usr/share/systemtap/testsuite/systemtap.examples/profiling</font></div><div><div><font size="2"   >[root@db-172-16-3-150 profiling]# cat functioncallcount.stp</font></div><div><font size="2"   >#!/usr/bin/stap</font></div><div><font size="2"   ># The following line command will probe all the functions</font></div><div><font size="2"   ># in kernel's memory management code:</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># stap &nbsp;functioncallcount.stp "*@mm/*.c"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe kernel.function(@1).call { &nbsp;# probe functions listed on commandline</font></div><div><font size="2"   >&nbsp; # called[probefunc()] &lt;&lt;&lt; 1 &nbsp;# add a count efficiently</font></div><div><font size="2"   >&nbsp; <span style="line-height: 28px;"   >called[probefunc()]++</span></font></div><div><font size="2"   >// 这里当然可以不使用统计类型, 使用数组自增就可以了.&nbsp;</font></div><div><span style="line-height: 28px;"   ><font size="2"   >// 数组在这里的性能比使用统计类型要好</font></span></div><div><font size="2"   >}</font></div><div><font size="2"   >// 第一个stap命令行传入参数为字符串, 指定函数或函数通配符</font></div><div><font size="2"   >// 注意尽量不要使用*, 如果匹配的函数太多, 可能会导致操作系统无响应.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >global called</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >// 最好限定一个统计时间, 否则需要等用户来退出这个模块.&nbsp;</font></div><div><font size="2"   >// 这里相当于10秒后退出.</font></div><div><font size="2"   >probe timer.s(10) {</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe end {</font></div><div><font size="2"   >&nbsp; foreach (fn in called- limit 10) &nbsp;# Sort by call count (in decreasing order)</font></div><div><font size="2"   >&nbsp; # &nbsp; &nbsp; &nbsp; (fn+ in called) &nbsp;# Sort by function name</font></div><div><font size="2"   >&nbsp; &nbsp; #printf("%s %d\n", fn, @count(called[fn]))</font></div><div><font size="2"   >&nbsp; &nbsp; <span style="line-height: 28px;"   >printf("%s %d\n", fn, called[fn])</span></font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   >// end事件触发时, 输出调用次数排名前10的函数名以及调用次数.</font></div><div><font size="2"   >// 或者按照函数名来排序. 输出所有的函数以及调用次数.</font></div><p></p></pre></div><div><br></div><div>执行输出举例 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 profiling]# stap functioncallcount.stp "*@mm/*.c"</font></div><div><font size="2"   >kfree 271266</font></div><div><font size="2"   >__phys_addr 187769</font></div><div><font size="2"   >kmem_cache_free 156818</font></div><div><font size="2"   >__inc_zone_state 122738</font></div><div><font size="2"   >kmem_cache_alloc 109292</font></div><div><font size="2"   >page_waitqueue 96884</font></div><div><font size="2"   >lookup_page_cgroup 79088</font></div><div><font size="2"   >kmem_cache_alloc_node 70086</font></div><div><font size="2"   >__kmalloc_node 70056</font></div><div><font size="2"   >kmem_cache_alloc_node_trace 70056</font></div><p></p></pre></div><div><br></div><div>本文用到的几个函数 :&nbsp;</div><div><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-probefunc.html"   >https://sourceware.org/systemtap/tapsets/API-probefunc.html</a></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Name</font></div><div><font size="2"   >&nbsp; &nbsp; function::probefunc ― Return the probe point's function name, if known</font></div><div><font size="2"   >Synopsis</font></div><div><font size="2"   >&nbsp; &nbsp; probefunc:string()</font></div><div><font size="2"   >Arguments</font></div><div><font size="2"   >&nbsp; &nbsp; None</font></div><div><font size="2"   >Description</font></div><div><font size="2"   >&nbsp; &nbsp; This function returns the name of the function being probed based on the current address, as computed by symname(addr) or usymname(uaddr) depending on probe context (whether the probe is a user probe or a kernel probe).</font></div><div><font size="2"   >Please note</font></div><div><font size="2"   >&nbsp; &nbsp; this function's behaviour differs between SystemTap 2.0 and earlier versions. Prior to 2.0, probefunc obtained the function name from the probe point string as returned by pp, and used the current address as a fallback.</font></div><p></p></pre></div><div><br></div></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" rel="nofollow" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/mainsect-profiling.html"   >https://sourceware.org/systemtap/SystemTap_Beginners_Guide/mainsect-profiling.html</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://sourceware.org/systemtap/examples/"   >https://sourceware.org/systemtap/examples/</a></div><div>3. /usr/share/systemtap/testsuite/systemtap.examples</div><div>4. systemtap-testsuite</div><div>5. /usr/share/systemtap/testsuite/systemtap.examples/index.txt</div><div>6. /usr/share/systemtap/testsuite/systemtap.examples/keyword-index.txt</div><div>7. /usr/share/systemtap/tapset</div><div><br></div><wbr></div>
	</div>
</div>
</body>
</html>