<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL hll (HyperLogLog) extension for "State of The Art Cardinality Estimation Algorithm" - 2</h2>
	<h5 id="">2013-02-27 11:29:57&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013127917876/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">前面一篇主要介绍了PostgreSQL hll的安装.如下 :&nbsp;<div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020131264480325/"   >http://blog.163.com/digoal@126/blog/static/16387704020131264480325/</a><br><div><br><div>一、PostgreSQL hll的主要功能 :&nbsp;</div><div>1. 快速的检索hll中存储的唯一值.</div><div>例如计算网站某天的访问用户数. 以前的算法可能是这样的 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >select count(distinct userid) from access_log where date(crt_time)='2013-02-01'; -- 非常耗时.</font></p></pre></div><div>hll解决了耗时的问题, 使用方法是将用户ID聚合存储到hll类型中. 如下(假设user_id的类型为int) :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create table access_date (acc_date date unique, userids hll);</font></div><div><font size="2"   >insert into access_date select&nbsp;<span style="line-height: 22px;"   >date(crt_time),&nbsp;</span><span style="line-height: 22px;"   >hll_add_agg(hll_hash_integer(user_id)) from access_log group by 1;</span></font></div><div><font size="2"   ><span style="line-height: 22px;"   >select #userids from&nbsp;</span><span style="line-height: 22px;"   >access_date where acc_date=</span><span style="line-height: 22px;"   >'2013-02-01'; -- 这条语句返回只要1毫秒左右. (10亿个唯一值返回也在1毫秒左右)</span></font></div><div><font size="2"   >而hll仅仅需要1.2KB就可以存储1.6e+12的唯一值.&nbsp;</font></div><p></p></pre></div><div><br></div><div>2. 因为hll中实际上存储了键值信息, 所以还可以做类似新增用户等的统计. 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create table access_date(acc_date date unique, userids hll);</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / UNIQUE will create implicit index "access_date_acc_date_key" for table "access_date"</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >Time: 8.219 ms</font></div><div><font size="2"   >digoal=&gt; insert into access_date select current_date, hll_add_agg(hll_hash_integer(user_id)) from generate_series(1,10000) t(user_id);</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >Time: 14.598 ms</font></div><div><font size="2"   >digoal=&gt; insert into access_date select current_date-1, hll_add_agg(hll_hash_integer(user_id)) from generate_series(5000,20000) t(user_id);</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >Time: 16.397 ms</font></div><div><font size="2"   >digoal=&gt; insert into access_date select current_date-2, hll_add_agg(hll_hash_integer(user_id)) from generate_series(9000,40000) t(user_id);</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >Time: 25.487 ms</font></div><div><font size="2"   ><span style="line-height: 19px;"   >digoal=&gt; select *,total_users-coalesce(lag(total_users,1) over (order by rn),0) AS new_users from (<br>digoal(&gt; SELECT acc_date, row_number() over date as rn,#hll_union_agg(userids) OVER date as total_users <br>digoal(&gt; FROM access_date<br>digoal(&gt; WINDOW date AS (ORDER BY acc_date ASC ROWS UNBOUNDED PRECEDING)<br>digoal(&gt; ) t;<br>  acc_date  | rn |   total_users    |    new_users     <br>------------+----+------------------+------------------<br> 2013-02-25 |  1 | 30324.8563878223 | 30324.8563878223<br> 2013-02-26 |  2 | 33944.8370446358 | 3619.98065681347<br> 2013-02-27 |  3 | 38696.2201822711 | 4751.38313763532<br>(3 rows)<br>Time: 2.327 ms</span></font></div><p></p></pre></div><div><br></div><div><div>二、PostgreSQL hll的主要组成部分 :&nbsp;</div><div>1. 两个数据类型 :&nbsp;</div><div><div>digoal=&gt; \dT+</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of data types</div><div>&nbsp;Schema | &nbsp; &nbsp;Name &nbsp; &nbsp; | Internal name | Size | Elements | Access privileges | Description&nbsp;</div><div>--------+-------------+---------------+------+----------+-------------------+-------------</div><div>&nbsp;public | hll &nbsp; &nbsp; &nbsp; &nbsp; | hll &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | var &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</div><div>&nbsp;public | hll_hashval | hll_hashval &nbsp; | 8 &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</div></div><div>hll 你可以想象成多个hll_hashval组成的集合.</div><div>hll_hashval是通过hash函数生成的hash值, 函数在后面介绍.</div><div><br></div><div>2. 几个操作函数 :&nbsp;</div><div>2.1 生成hash值的函数</div><div><table style="margin: 15px 0px; padding: 0px; border: 0px; border-collapse: collapse; border-spacing: 0px; font-family: Helvetica, arial, freesans, clean, sans-serif; font-size: 14px; line-height: 22px; color: rgb(51, 51, 51);"   ><tbody style="margin: 0px; padding: 0px; border: 0px;"   ><tr style="margin: 0px; padding: 0px; border-width: 1px 0px 0px; border-top-style: solid; border-top-color: rgb(204, 204, 204);"   ><th style="margin: 0px; padding: 6px 13px; border: 1px solid rgb(204, 204, 204);"   >Function</th><th style="margin: 0px; padding: 6px 13px; border: 1px solid rgb(204, 204, 204);"   >Input</th><th style="margin: 0px; padding: 6px 13px; border: 1px solid rgb(204, 204, 204);"   >Example</th></tr><tr style="margin: 0px; padding: 0px; border-width: 1px 0px 0px; border-top-style: solid; border-top-color: rgb(204, 204, 204); background-color: rgb(248, 248, 248);"   ><td style="margin: 0px; padding: 6px 13px; border: 1px solid rgb(204, 204, 204);"   ><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >hll_hash_boolean</code></td><td style="margin: 0px; padding: 6px 13px; border: 1px solid rgb(204, 204, 204);"   ><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >boolean</code></td><td style="margin: 0px; padding: 6px 13px; border: 1px solid rgb(204, 204, 204);"   ><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >hll_hash_boolean(TRUE)</code><br><strong style="margin: 0px; padding: 0px; border: 0px;"   >or</strong><br><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >hll_hash_boolean(TRUE, 123/*hash seed*/)</code></td></tr><tr style="margin: 0px; padding: 0px; border-width: 1px 0px 0px; border-top-style: solid; border-top-color: rgb(204, 204, 204);"   ><td style="margin: 0px; padding: 6px 13px; border: 1px solid rgb(204, 204, 204);"   ><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >hll_hash_smallint</code></td><td style="margin: 0px; padding: 6px 13px; border: 1px solid rgb(204, 204, 204);"   ><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >smallint</code></td><td style="margin: 0px; padding: 6px 13px; border: 1px solid rgb(204, 204, 204);"   ><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >hll_hash_smallint(4)</code><br><strong style="margin: 0px; padding: 0px; border: 0px;"   >or</strong><br><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >hll_hash_smallint(4, 123/*hash seed*/)</code></td></tr><tr style="margin: 0px; padding: 0px; border-width: 1px 0px 0px; border-top-style: solid; border-top-color: rgb(204, 204, 204); background-color: rgb(248, 248, 248);"   ><td style="margin: 0px; padding: 6px 13px; border: 1px solid rgb(204, 204, 204);"   ><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >hll_hash_integer</code></td><td style="margin: 0px; padding: 6px 13px; border: 1px solid rgb(204, 204, 204);"   ><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >integer</code></td><td style="margin: 0px; padding: 6px 13px; border: 1px solid rgb(204, 204, 204);"   ><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >hll_hash_integer(21474836)</code><br><strong style="margin: 0px; padding: 0px; border: 0px;"   >or</strong><br><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >hll_hash_integer(21474836, 123/*hash seed*/)</code></td></tr><tr style="margin: 0px; padding: 0px; border-width: 1px 0px 0px; border-top-style: solid; border-top-color: rgb(204, 204, 204);"   ><td style="margin: 0px; padding: 6px 13px; border: 1px solid rgb(204, 204, 204);"   ><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >hll_hash_bigint</code></td><td style="margin: 0px; padding: 6px 13px; border: 1px solid rgb(204, 204, 204);"   ><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >bigint</code></td><td style="margin: 0px; padding: 6px 13px; border: 1px solid rgb(204, 204, 204);"   ><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >hll_hash_bigint(223372036854775808)</code><br><strong style="margin: 0px; padding: 0px; border: 0px;"   >or</strong><br><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >hll_hash_bigint(223372036854775808, 123/*hash seed*/)</code></td></tr><tr style="margin: 0px; padding: 0px; border-width: 1px 0px 0px; border-top-style: solid; border-top-color: rgb(204, 204, 204); background-color: rgb(248, 248, 248);"   ><td style="margin: 0px; padding: 6px 13px; border: 1px solid rgb(204, 204, 204);"   ><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >hll_hash_bytea</code></td><td style="margin: 0px; padding: 6px 13px; border: 1px solid rgb(204, 204, 204);"   ><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >bytea</code></td><td style="margin: 0px; padding: 6px 13px; border: 1px solid rgb(204, 204, 204);"   ><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >hll_hash_bytea(E'\\xDEADBEEF')</code><br><strong style="margin: 0px; padding: 0px; border: 0px;"   >or</strong><br><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >hll_hash_bytea(E'\\xDEADBEEF', 123/*hash seed*/)</code></td></tr><tr style="margin: 0px; padding: 0px; border-width: 1px 0px 0px; border-top-style: solid; border-top-color: rgb(204, 204, 204);"   ><td style="margin: 0px; padding: 6px 13px; border: 1px solid rgb(204, 204, 204);"   ><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >hll_hash_text</code></td><td style="margin: 0px; padding: 6px 13px; border: 1px solid rgb(204, 204, 204);"   ><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >text</code></td><td style="margin: 0px; padding: 6px 13px; border: 1px solid rgb(204, 204, 204);"   ><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >hll_hash_text('foobar')</code><br><strong style="margin: 0px; padding: 0px; border: 0px;"   >or</strong><br><code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid rgb(234, 234, 234); font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; white-space: nowrap;"   >hll_hash_text('foobar', 123/*hash seed*/)</code></td></tr></table><p style="margin-top: 15px; margin-bottom: 15px; border: 0px; color: rgb(51, 51, 51); font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px;"   ><span style="line-height: 22px; font-family: Arial, Helvetica, sans-serif;"   >2.2 将多个hll_hashval聚合成hll的函数</span></p></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >digoal=&gt; \df *.*hll*agg*</font></span></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of functions</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; Name &nbsp; &nbsp; &nbsp;| Result data type | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Argument data types &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Type&nbsp;</font></div><div><font size="2"   >--------+---------------+------------------+------------------------------------------------+------</font></div><div><font size="2"   >&nbsp;public | hll_add_agg &nbsp; | hll &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| hll_hashval &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| agg</font></div><div><font size="2"   >&nbsp;public | hll_add_agg &nbsp; | hll &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| hll_hashval, integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | agg</font></div><div><font size="2"   >&nbsp;public | hll_add_agg &nbsp; | hll &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| hll_hashval, integer, integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| agg</font></div><div><font size="2"   >&nbsp;public | hll_add_agg &nbsp; | hll &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| hll_hashval, integer, integer, bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| agg</font></div><div><font size="2"   >&nbsp;public | hll_add_agg &nbsp; | hll &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| hll_hashval, integer, integer, bigint, integer | agg</font></div><p></p></pre></div><div>由于聚合函数不支持默认值, 所以定义了5个, 如上. 分别用来设置几个调整精度和阈值.</div><div>hll.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int32 log2m = PG_GETARG_INT32(2);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int32 regwidth = PG_GETARG_INT32(3);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int64 expthresh = PG_GETARG_INT64(4);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int32 sparseon = PG_GETARG_INT32(5);</font></div><p></p></pre></div><div>使用方法举例 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select hll_add_agg(hll_hash_integer(t)) from generate_series(1,10) g(t);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hll_add_agg &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >--------------------------------------</font></div><div><font size="2"   >&nbsp;\x128c7f8895a3f5af28cafeb2c0b33a441f4218da0ce907e4355b6018b150d055d8e3d31cc3e945c98357f02c98c8925c9ed0524848de7f7bd2a13b5c5c9d3935c</font></div><div><font size="2"   >f09bf72f24e286b62c7e47f2769b67e461dfb</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>2.3 将多个hll聚合的函数</div><div><pre class="prettyprint"   ><p><font size="2"   >public | hll_union_agg &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | hll &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| hll</font></p></pre></div><div>去重复.</div><div><br></div><div>2.4 比较两个hll或hll_hashval值的函数</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >public | hll_ne &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| hll, hll</font></div></div><div><font size="2"   >public | hll_eq &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| hll, hll</font></div><div><font size="2"   >public | hll_hashval_ne &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| hll_hashval, hll_hashval</font></div><div><font size="2"   >public | hll_hashval_eq &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| hll_hashval, hll_hashval</font></div><p></p></pre></div><div><br></div><div>2.5 union两个hll的函数. 或者理解为<span style="line-height: 22px;"   >在现有的hll中增加hll值.</span></div><div><pre class="prettyprint"   ><p><font size="2"   >public | hll_union &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | hll &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| hll, hll</font></p></pre></div><div><br></div><div>2.6 在现有的hll中增加hll_hashval值</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;public | hll_add_rev &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | hll &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| hll_hashval, hll</font></div><div><font size="2"   >&nbsp;public | hll_add &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | hll &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| hll, hll_hashval</font></div><div><font size="2"   >例如 :&nbsp;</font></div><div><div><font size="2"   >digoal=&gt; select hll_add_rev(hll_hash_bigint(1),hll_add_agg(hll_hash_bigint(t))) from generate_series(3,10) g(t);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hll_add_rev &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;\x128c7fb419d210486ab6c1004403b7fb05c44a06c9ec78d52c26530fd4c5f69b6c771b122f34392c621e721b341d80dfead7e630e12993257f8fb23987d28c06f</font></div><div><font size="2"   >0df795b3d5839b2488b0c</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 0.558 ms</font></div><div><font size="2"   >digoal=&gt; select hll_add(hll_add_agg(hll_hash_bigint(t)),hll_hash_bigint(1)) from generate_series(3,10) g(t);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hll_add &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;\x128c7fb419d210486ab6c1004403b7fb05c44a06c9ec78d52c26530fd4c5f69b6c771b122f34392c621e721b341d80dfead7e630e12993257f8fb23987d28c06f</font></div><div><font size="2"   >0df795b3d5839b2488b0c</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>2.7 计算hll中的唯一值的函数</div><div><p></p><pre class="prettyprint"   ><p></p><div><p><font size="2"   >public | hll_cardinality &nbsp; &nbsp; &nbsp; &nbsp; | double precision | hll</font></p></div><div><div><font size="2"   >例如 :&nbsp;</font></div><div><font size="2"   >digoal=&gt; insert into acc_agg select current_date,hll_add_agg(hll_hash_bigint(t)) from generate_series(1,100000000) g(t);</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >Time: 75452.588 ms</font></div><div><font size="2"   >digoal=&gt; select #userids from acc_agg;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;?column? &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NaN</font></div><div><font size="2"   >&nbsp;10017.3757531911</font></div><div><font size="2"   >&nbsp;98388.5525610614</font></div><div><font size="2"   >&nbsp;1004928.03336943</font></div><div><font size="2"   >&nbsp;9817781.35207598</font></div><div><font size="2"   >&nbsp;99813892.0484923</font></div><div><font size="2"   >(6 rows)</font></div></div><p></p></pre></div><div><br></div><div>2.8 设置或检查阈值和精度的函数</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >-- Returns the schema version of an hll.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_schema_version(hll)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS integer</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Returns the type of an hll.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_type(hll)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS integer</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Returns the log2m value of an hll.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_log2m(hll)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS integer</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Returns the register width of an hll.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_regwidth(hll)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS integer</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Returns the maximum explicit threshold of an hll.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_expthresh(hll, OUT specified bigint, OUT effective bigint)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Returns the sparse enabled value of an hll.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_sparseon(hll)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS integer</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Set output version.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_set_output_version(integer)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS integer</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Set sparse to full compressed threshold to fixed value.</font></div><div><font size="2"   >--</font></div><div><font size="2"   >CREATE FUNCTION hll_set_max_sparse(integer)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;RETURNS integer</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Change the default type modifier, empty and add aggregate defaults.</font></div><div><font size="2"   >CREATE FUNCTION hll_set_defaults(IN i_log2m integer,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IN i_regwidth integer,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IN i_expthresh bigint,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IN i_sparseon integer,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;OUT o_log2m integer,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;OUT o_regwidth integer,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;OUT o_expthresh bigint,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;OUT o_sparseon integer)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;AS 'MODULE_PATHNAME'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;LANGUAGE C STRICT IMMUTABLE;</font></div></div><div><font size="2"   >-- 输出的是老的精度和阈值 :&nbsp;</font></div><div><div><span style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; values[j] = palloc(32);</font></span></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(values[j++], 32, "%d", old_log2m);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; values[j] = palloc(32);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(values[j++], 32, "%d", old_regwidth);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; values[j] = palloc(32);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(values[j++], 32, INT64_FORMAT, old_expthresh);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; values[j] = palloc(32);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(values[j++], 32, "%d", old_sparseon);</font></div></div><p></p></pre></div><div><br></div><div>2.9 DEBUG函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >public | hll_print &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | cstring &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| hll</font></div><div><font size="2"   >例如 :&nbsp;</font></div><div><p></p><div><div><font size="2"   >digoal=&gt; select hll_print(hll_add(hll_add_agg(hll_hash_bigint(t)),hll_hash_bigint(1))) from generate_series(3,10) g(t);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hll_print &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;EXPLICIT, 9 elements, nregs=4096, nbits=5, expthresh=-1(320), sparseon=1:+</font></div><div><font size="2"   >&nbsp;0: -5469109305088493887 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;1: &nbsp; &nbsp;19144387141682250 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;2: &nbsp; 489182038263080531 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;3: &nbsp;1140754268591781659 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;4: &nbsp;1310323436750511730 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;5: &nbsp;1960224177162737638 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;6: &nbsp;3522142095546486706 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;7: &nbsp;4145513480871534457 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;8: &nbsp;6574508035858270988&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >因为未达到阈值, 所以使用explicit存储. 返回的唯一值将会是精确值.</font></div></div><p></p></pre></div><div><p></p></div><div><br></div><div>3. 几个操作符 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-- ----------------------------------------------------------------</font></div><div><font size="2"   >-- Operators</font></div><div><font size="2"   >-- ----------------------------------------------------------------</font></div><div><font size="2"   >-- 比较两个hll类型值是否相等</font></div><div><font size="2"   >CREATE OPERATOR = (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LEFTARG = hll, RIGHTARG = hll, PROCEDURE = hll_eq,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; COMMUTATOR = '=', NEGATOR = '&lt;&gt;',</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; RESTRICT = eqsel, JOIN = eqjoinsel,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; MERGES</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE OPERATOR &lt;&gt; (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; LEFTARG = hll, RIGHTARG = hll, PROCEDURE = hll_ne,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; COMMUTATOR = '&lt;&gt;', NEGATOR = '=',</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; RESTRICT = neqsel, JOIN = neqjoinsel</font></div><div><font size="2"   >);</font></div><div><font size="2"   >-- 合并两个hll类型值, 去重复.</font></div><div><font size="2"   >CREATE OPERATOR || (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;LEFTARG = hll, RIGHTARG = hll, PROCEDURE = hll_union</font></div><div><font size="2"   >);</font></div><div><font size="2"   >-- 合并hll_hashval和hll, 去重复.</font></div><div><font size="2"   >CREATE OPERATOR || (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;LEFTARG = hll, RIGHTARG = hll_hashval, PROCEDURE = hll_add</font></div><div><font size="2"   >);</font></div><div><font size="2"   >-- 同上</font></div><div><font size="2"   >CREATE OPERATOR || (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;LEFTARG = hll_hashval, RIGHTARG = hll, PROCEDURE = hll_add_rev</font></div><div><font size="2"   >);</font></div><div><font size="2"   >-- 计算hll类型值中包含的唯一hll_hashval值.</font></div><div><font size="2"   >CREATE OPERATOR # (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;RIGHTARG = hll, PROCEDURE = hll_cardinality</font></div><div><font size="2"   >);</font></div><p></p></pre></div><div><br></div><div>三、精度调整 :&nbsp;</div><div>在hll.c中 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >// Defaults if type modifier values are not specified.</font></div><div><font size="2"   >//</font></div><div><font size="2"   >#define DEFAULT_LOG2M &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 15 &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >#define DEFAULT_REGWIDTH &nbsp; &nbsp; &nbsp; &nbsp;5</font></div><div><font size="2"   >#define DEFAULT_EXPTHRESH &nbsp; &nbsp; &nbsp; -1</font></div><div><font size="2"   >#define DEFAULT_SPARSEON &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >static int32 g_default_log2m = DEFAULT_LOG2M;</font></div><div><font size="2"   >static int32 g_default_regwidth = DEFAULT_REGWIDTH;</font></div><div><font size="2"   >static int64 g_default_expthresh = DEFAULT_EXPTHRESH;</font></div><div><font size="2"   >static int32 g_default_sparseon = DEFAULT_SPARSEON;</font></div><p></p></pre></div><div>也可以在数据库中调整 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-- 返回为老的值.</font></div><div><div><font size="2"   >digoal=&gt; select * from hll_set_defaults(15,5,-1,1);</font></div><div><font size="2"   >&nbsp;o_log2m | o_regwidth | o_expthresh | o_sparseon&nbsp;</font></div><div><font size="2"   >---------+------------+-------------+------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 12 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 0.330 ms</font></div></div><p></p></pre></div><div><br></div><div>四、用法注意</div><div>1. 更新hll时小心锁, 最好是由程序调度聚合. 不要实时更新.</div><div>2. 浮点型转化成hll_hashval时, 不建议直接转化, 建议将浮点型数值固化后转化.</div><div><a target="_blank" rel="nofollow" href="http://stackoverflow.com/questions/7403210/hashing-floating-point-values"   >http://stackoverflow.com/questions/7403210/hashing-floating-point-values</a></div><div><br></div><div><span style="line-height: 22px;"   >【参考】</span></div></div></div></div><div>1.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/sql-select.html"   >http://www.postgresql.org/docs/9.2/static/sql-select.html</a></div><div>2.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/tutorial-window.html"   >http://www.postgresql.org/docs/9.2/static/tutorial-window.html</a></div><div>3.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/sql-expressions.html#SYNTAX-WINDOW-FUNCTIONS"   >http://www.postgresql.org/docs/9.2/static/sql-expressions.html#SYNTAX-WINDOW-FUNCTIONS</a></div><div>4.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/queries-table-expressions.html#QUERIES-WINDOW"   >http://www.postgresql.org/docs/9.2/static/queries-table-expressions.html#QUERIES-WINDOW</a></div><div>5.&nbsp;<a style="line-height: 22px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/functions-window.html"   >http://www.postgresql.org/docs/9.2/static/functions-window.html</a></div><div>6.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020131264480325/"   >http://blog.163.com/digoal@126/blog/static/16387704020131264480325/</a></div>7.&nbsp;REFERENCE.markdown<div>8.&nbsp;STORAGE.markdown</div></div>
	</div>
</div>
</body>
</html>