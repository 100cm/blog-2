<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL CSVLOG monitor script for nagios</h2>
	<h5 id="">2013-02-22 17:35:13&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201312241028667/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>环境参照上一篇 :&nbsp;</div><div>《<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013121102459107/"   >PostgreSQL LOCK WAITING monitor script for nagios</a>》</div><div><br></div><div>postgresql.conf配置 :&nbsp;</div><div>要求开启csvlog</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >log_destination = 'csvlog'</font></div><div><font size="2"   >logging_collector = on</font></div><div><font size="2"   >log_directory = 'pg_log'</font></div><div><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'</font></div><div><font size="2"   >log_file_mode = 0600</font></div><div><font size="2"   >log_truncate_on_rotation = on</font></div><div><font size="2"   >log_rotation_age = 1d</font></div><div><font size="2"   >log_rotation_size = 10MB</font></div><p></p></pre></div><div><br></div><div>脚本如下 :&nbsp;</div><div>vi&nbsp;<span style="line-height: 22px;"   >/usr/local/nagios/libexec/check_pg_csvlog.sh</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   ># 环境变量</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/opt/pgsql</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"   >export PGPASSFILE=/etc/.pgpass</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >if [ $# -ne 1 ]; then</font></div><div><font size="2"   >&nbsp; echo "USE $0 summary|detail"</font></div><div><font size="2"   >&nbsp; exit 0</font></div><div><font size="2"   >else</font></div><div><font size="2"   >&nbsp; PAR1=$1</font></div><div><font size="2"   >&nbsp; if [ $PAR1 != "summary" ] &amp;&amp; [ $PAR1 != "detail" ]; then</font></div><div><font size="2"   >&nbsp; &nbsp; echo "USE $0 summary|detail"</font></div><div><font size="2"   >&nbsp; &nbsp; exit 0</font></div><div><font size="2"   >&nbsp; fi</font></div><div><font size="2"   >fi</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create_csvlogtable() {</font></div><div><font size="2"   >echo $CONN_INFO</font></div><div><font size="2"   >VER=`psql -q -t $CONN_INFO -c "select '9' from (select substr(version(),12,1) as ver) t where ver::int&gt;=9"|grep -c 9`</font></div><div><font size="2"   >if [ $VER -ge 1 ]; then</font></div><div><font size="2"   ># PostgreSQL 9+</font></div><div><font size="2"   >IS_STDBY=`psql -q -t $CONN_INFO -c "select 'this_is_standby' as a where pg_is_in_recovery();"|grep -c this_is_standby`</font></div><div><font size="2"   >if [ $IS_STDBY -ge 1 ]; then</font></div><div><font size="2"   >&nbsp; return 0</font></div><div><font size="2"   >fi</font></div><div><font size="2"   >psql -q -t $CONN_INFO &lt;&lt;EOF</font></div><div><font size="2"   >do language plpgsql \$\$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >perform 1 from pg_tables where tablename='postgres_log';</font></div><div><font size="2"   >if not found then</font></div><div><font size="2"   >CREATE TABLE postgres_log</font></div><div><font size="2"   >(</font></div><div><font size="2"   >&nbsp; log_time timestamp(3) with time zone,</font></div><div><font size="2"   >&nbsp; user_name text,</font></div><div><font size="2"   >&nbsp; database_name text,</font></div><div><font size="2"   >&nbsp; process_id integer,</font></div><div><font size="2"   >&nbsp; connection_from text,</font></div><div><font size="2"   >&nbsp; session_id text,</font></div><div><font size="2"   >&nbsp; session_line_num bigint,</font></div><div><font size="2"   >&nbsp; command_tag text,</font></div><div><font size="2"   >&nbsp; session_start_time timestamp with time zone,</font></div><div><font size="2"   >&nbsp; virtual_transaction_id text,</font></div><div><font size="2"   >&nbsp; transaction_id bigint,</font></div><div><font size="2"   >&nbsp; error_severity text,</font></div><div><font size="2"   >&nbsp; sql_state_code text,</font></div><div><font size="2"   >&nbsp; message text,</font></div><div><font size="2"   >&nbsp; detail text,</font></div><div><font size="2"   >&nbsp; hint text,</font></div><div><font size="2"   >&nbsp; internal_query text,</font></div><div><font size="2"   >&nbsp; internal_query_pos integer,</font></div><div><font size="2"   >&nbsp; context text,</font></div><div><font size="2"   >&nbsp; query text,</font></div><div><font size="2"   >&nbsp; query_pos integer,</font></div><div><font size="2"   >&nbsp; location text,</font></div><div><font size="2"   >&nbsp; application_name text,</font></div><div><font size="2"   >&nbsp; PRIMARY KEY (session_id, session_line_num)</font></div><div><font size="2"   >);</font></div><div><font size="2"   >end if;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >\$\$;</font></div><div><font size="2"   >EOF</font></div><div><font size="2"   >else</font></div><div><font size="2"   ># PostgreSQL 8+</font></div><div><font size="2"   ># 不支持inline language, 建议预先创建</font></div><div><font size="2"   >echo "PostgreSQL 8.x"</font></div><div><font size="2"   >fi</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >load_csvlog() {</font></div><div><font size="2"   >VER=`psql -q -t $CONN_INFO -c "select '9' from (select substr(version(),12,1) as ver) t where ver::int&gt;=9"|grep -c 9`</font></div><div><font size="2"   >if [ $VER -ge 1 ]; then</font></div><div><font size="2"   >&nbsp; IS_STDBY=`psql -q -t $CONN_INFO -c "select 'this_is_standby' as a where pg_is_in_recovery();"|grep -c this_is_standby`</font></div><div><font size="2"   >&nbsp; if [ $IS_STDBY -ge 1 ]; then</font></div><div><font size="2"   >&nbsp; &nbsp; return 0</font></div><div><font size="2"   >&nbsp; fi</font></div><div><font size="2"   >fi</font></div><div><font size="2"   >if [ $VER -ge 1 ]; then</font></div><div><font size="2"   >psql -q -t $CONN_INFO &lt;&lt;EOF</font></div><div><font size="2"   >do language plpgsql \$\$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >v_dir text;</font></div><div><font size="2"   >v_filename text;</font></div><div><font size="2"   >v_sql text;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >truncate postgres_log;</font></div><div><font size="2"   >select setting into v_dir from pg_settings where name='log_directory';</font></div><div><font size="2"   >for v_filename in select filename from pg_ls_dir(v_dir) t(filename)&nbsp;</font></div><div><font size="2"   >&nbsp; where filename ~ 'csv\$' and filename ~ to_char(current_date,'yyyy-mm-dd') loop</font></div><div><font size="2"   >v_sql := \$_\$COPY postgres_log FROM '\$_\$||v_dir||'/'||v_filename||\$_\$' WITH csv\$_\$;</font></div><div><font size="2"   >raise notice '%', v_sql;</font></div><div><font size="2"   >execute v_sql;</font></div><div><font size="2"   >end loop;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >\$\$;</font></div><div><font size="2"   >EOF</font></div><div><font size="2"   >else</font></div><div><font size="2"   ># PostgreSQL 8.x 不支持do language, 这里忽略导入</font></div><div><font size="2"   >echo "PostgreSQL 8.x"</font></div><div><font size="2"   >fi</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >analyze_csvlog() {</font></div><div><font size="2"   >VER=`psql -q -t $CONN_INFO -c "select '9' from (select substr(version(),12,1) as ver) t where ver::int&gt;=9"|grep -c 9`</font></div><div><font size="2"   >if [ $VER -ge 1 ]; then</font></div><div><font size="2"   >&nbsp; IS_STDBY=`psql -q -t $CONN_INFO -c "select 'this_is_standby' as a where pg_is_in_recovery();"|grep -c this_is_standby`</font></div><div><font size="2"   >&nbsp; if [ $IS_STDBY -ge 1 ]; then</font></div><div><font size="2"   >&nbsp; &nbsp; return 0</font></div><div><font size="2"   >&nbsp; fi</font></div><div><font size="2"   >fi</font></div><div><font size="2"   >CNT=`psql -q -t $CONN_INFO -c "select error_severity from postgres_log where error_severity&lt;&gt;'LOG' group by error_severity;"|grep -c -E "FATAL|ERROR"`</font></div><div><font size="2"   >if [ $CNT -ge 1 ]; then</font></div><div><font size="2"   >&nbsp; result=2</font></div><div><font size="2"   >&nbsp; if [ $PAR1 == "summary" ]; then</font></div><div><font size="2"   >&nbsp; &nbsp; psql -q -t $CONN_INFO &lt;&lt;EOF</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; select inet_server_addr() as server_ip,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; inet_server_port() as server_port,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; error_severity,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; sql_state_code,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; count(1) from postgres_log&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; where error_severity&lt;&gt;'LOG'&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; group by inet_server_addr(),inet_server_port(),error_severity,sql_state_code&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; order by count(1) desc;</font></div><div><font size="2"   >EOF</font></div><div><font size="2"   >&nbsp; fi</font></div><div><font size="2"   >&nbsp; if [ $PAR1 == "detail" ]; then</font></div><div><font size="2"   ># detail的建议按照单库输出,否则太多</font></div><div><font size="2"   >&nbsp; &nbsp; psql -x -q -t $CONN_INFO &lt;&lt;EOF</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; select inet_server_addr() as server_ip,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; inet_server_port() as server_port,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; error_severity,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; connection_from,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; sql_state_code,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; message,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; detail,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; hint,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; internal_query,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; query,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; location</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; from postgres_log&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; where error_severity&lt;&gt;'LOG'&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; order by log_time desc limit $OLINE;</font></div><div><font size="2"   >EOF</font></div><div><font size="2"   >&nbsp; fi</font></div><div><font size="2"   >else</font></div><div><font size="2"   >&nbsp; return 0</font></div><div><font size="2"   >fi</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># global result</font></div><div><font size="2"   >result=0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># set env</font></div><div><font size="2"   >. /usr/local/nagios/etc/check_pg_env.sh</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># monitor</font></div><div><font size="2"   ># detail监控输出最近20条详细信息.</font></div><div><font size="2"   >OLINE=20</font></div><div><font size="2"   >echo $OLINE</font></div><div><font size="2"   >for i in "HZ1_CHECK_PG_CSVLOG_1"</font></div><div><font size="2"   >do</font></div><div><font size="2"   >&nbsp; eval CONN_INFO="$"$i</font></div><div><font size="2"   >&nbsp; create_csvlogtable</font></div><div><font size="2"   >&nbsp; load_csvlog</font></div><div><font size="2"   >&nbsp; analyze_csvlog</font></div><div><font size="2"   >done</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># exit global proc</font></div><div><font size="2"   >exit $result</font></div><p></p></pre></div><div>修改执行权限 :&nbsp;</div><div>chmod 555&nbsp;<span style="line-height: 22px;"   >/usr/local/nagios/libexec/check_pg_csvlog.sh</span></div><div>修改nagios配置 :&nbsp;</div><div>vi&nbsp;/usr/local/nagios/etc/nrpe.cfg</div><div>command[check_pg_csvlog]=/usr/local/nagios/libexec/check_pg_csvlog.sh summary</div><div>重启xinetd服务 :&nbsp;</div><div>service xinetd restart</div><div><br></div><div>直接执行的结果如下 :&nbsp;</div><div><span style="line-height: 22px;"   >/usr/local/nagios/libexec/check_pg_csvlog.sh summary</span></div><div><br></div><div>【其他】</div><div>1. 由于数据需要从csvlog导入数据库表, 所以不推荐频繁调用这个脚本.</div><div>2. 对于9.1以上的系统, 可以考虑使用file_fdw创建外部表, 省去导入过程.</div><div>3. 所有8.4以上系统都支持的直接读取文件的函数, pg_read_file(text, bigint, bigint).&nbsp;</div><div>4. 这个脚本更偏向查看前一天的统计.</div><div>如果要做成实时告警的方式, 需要调整一下策略.</div><div>例如取最近1个小时的ERROR和FATAL记录数作为告警阈值.&nbsp;</div><div>每个系统的频繁程度不一样, 阈值也不一样.</div><div>修改后的nagios check脚本如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   ># 环境变量</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/opt/pgsql</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"   >export PGPASSFILE=/etc/.pgpass</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >if [ $# -ne 0 ]; then</font></div><div><font size="2"   >&nbsp; echo "USE $0"</font></div><div><font size="2"   >&nbsp; exit 0</font></div><div><font size="2"   >fi</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >create_csvlogtable() {</font></div><div><font size="2"   ># debug</font></div><div><font size="2"   ># echo $CONN_INFO</font></div><div><font size="2"   >VER=`psql -q -t $CONN_INFO -c "select '9' from (select substr(version(),12,1) as ver) t where ver::int&gt;=9"|grep -c 9`</font></div><div><font size="2"   >if [ $VER -ge 1 ]; then</font></div><div><font size="2"   ># PostgreSQL 9+</font></div><div><font size="2"   >IS_STDBY=`psql -q -t $CONN_INFO -c "select 'this_is_standby' as a where pg_is_in_recovery();"|grep -c this_is_standby`</font></div><div><font size="2"   >if [ $IS_STDBY -ge 1 ]; then</font></div><div><font size="2"   >&nbsp; return 0</font></div><div><font size="2"   >fi</font></div><div><font size="2"   >psql -q -t $CONN_INFO &lt;&lt;EOF</font></div><div><font size="2"   >do language plpgsql \$\$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >perform 1 from pg_tables where tablename='postgres_log';</font></div><div><font size="2"   >if not found then</font></div><div><font size="2"   >CREATE TABLE postgres_log</font></div><div><font size="2"   >(</font></div><div><font size="2"   >&nbsp; log_time timestamp(3) with time zone,</font></div><div><font size="2"   >&nbsp; user_name text,</font></div><div><font size="2"   >&nbsp; database_name text,</font></div><div><font size="2"   >&nbsp; process_id integer,</font></div><div><font size="2"   >&nbsp; connection_from text,</font></div><div><font size="2"   >&nbsp; session_id text,</font></div><div><font size="2"   >&nbsp; session_line_num bigint,</font></div><div><font size="2"   >&nbsp; command_tag text,</font></div><div><font size="2"   >&nbsp; session_start_time timestamp with time zone,</font></div><div><font size="2"   >&nbsp; virtual_transaction_id text,</font></div><div><font size="2"   >&nbsp; transaction_id bigint,</font></div><div><font size="2"   >&nbsp; error_severity text,</font></div><div><font size="2"   >&nbsp; sql_state_code text,</font></div><div><font size="2"   >&nbsp; message text,</font></div><div><font size="2"   >&nbsp; detail text,</font></div><div><font size="2"   >&nbsp; hint text,</font></div><div><font size="2"   >&nbsp; internal_query text,</font></div><div><font size="2"   >&nbsp; internal_query_pos integer,</font></div><div><font size="2"   >&nbsp; context text,</font></div><div><font size="2"   >&nbsp; query text,</font></div><div><font size="2"   >&nbsp; query_pos integer,</font></div><div><font size="2"   >&nbsp; location text,</font></div><div><font size="2"   >&nbsp; application_name text,</font></div><div><font size="2"   >&nbsp; PRIMARY KEY (session_id, session_line_num)</font></div><div><font size="2"   >);</font></div><div><font size="2"   >end if;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >\$\$;</font></div><div><font size="2"   >EOF</font></div><div><font size="2"   >else</font></div><div><font size="2"   ># PostgreSQL 8+</font></div><div><font size="2"   ># 不支持inline language, 建议预先创建</font></div><div><font size="2"   >echo "PostgreSQL 8.x"</font></div><div><font size="2"   >fi</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >load_csvlog() {</font></div><div><font size="2"   ># 需要用到BOND变量, 减少导入日志数量</font></div><div><font size="2"   >VER=`psql -q -t $CONN_INFO -c "select '9' from (select substr(version(),12,1) as ver) t where ver::int&gt;=9"|grep -c 9`</font></div><div><font size="2"   >if [ $VER -ge 1 ]; then</font></div><div><font size="2"   >&nbsp; IS_STDBY=`psql -q -t $CONN_INFO -c "select 'this_is_standby' as a where pg_is_in_recovery();"|grep -c this_is_standby`</font></div><div><font size="2"   >&nbsp; if [ $IS_STDBY -ge 1 ]; then</font></div><div><font size="2"   >&nbsp; &nbsp; return 0</font></div><div><font size="2"   >&nbsp; fi</font></div><div><font size="2"   >fi</font></div><div><font size="2"   >if [ $VER -ge 1 ]; then</font></div><div><font size="2"   >psql -q -t $CONN_INFO &lt;&lt;EOF</font></div><div><font size="2"   >do language plpgsql \$\$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >v_dir text;</font></div><div><font size="2"   >v_filename text;</font></div><div><font size="2"   >v_sql text;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >set client_min_messages=warning;</font></div><div><font size="2"   >truncate postgres_log;</font></div><div><font size="2"   >select setting into v_dir from pg_settings where name='log_directory';</font></div><div><font size="2"   >for v_filename in select filename from pg_ls_dir(v_dir) t(filename)&nbsp;</font></div><div><font size="2"   >&nbsp; where filename ~ 'csv\$' and (pg_stat_file(v_dir||'/'||filename)).modification+interval $BOND &gt;= now() loop</font></div><div><font size="2"   >v_sql := \$_\$COPY postgres_log FROM '\$_\$||v_dir||'/'||v_filename||\$_\$' WITH csv\$_\$;</font></div><div><font size="2"   >raise notice '%', v_sql;</font></div><div><font size="2"   >execute v_sql;</font></div><div><font size="2"   >end loop;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >\$\$;</font></div><div><font size="2"   >EOF</font></div><div><font size="2"   >else</font></div><div><font size="2"   ># PostgreSQL 8.x 不支持do language, 这里忽略导入</font></div><div><font size="2"   >echo "PostgreSQL 8.x"</font></div><div><font size="2"   >fi</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >analyze_csvlog() {</font></div><div><font size="2"   >VER=`psql -q -t $CONN_INFO -c "select '9' from (select substr(version(),12,1) as ver) t where ver::int&gt;=9"|grep -c 9`</font></div><div><font size="2"   >if [ $VER -ge 1 ]; then</font></div><div><font size="2"   >&nbsp; IS_STDBY=`psql -q -t $CONN_INFO -c "select 'this_is_standby' as a where pg_is_in_recovery();"|grep -c this_is_standby`</font></div><div><font size="2"   >&nbsp; if [ $IS_STDBY -ge 1 ]; then</font></div><div><font size="2"   >&nbsp; &nbsp; return 0</font></div><div><font size="2"   >&nbsp; fi</font></div><div><font size="2"   >fi</font></div><div><font size="2"   ># 严重警告</font></div><div><font size="2"   >CNT=`psql -q -t $CONN_INFO -c "select 'GET_IT' from postgres_log where error_severity&lt;&gt;'LOG' having count(*) &gt;= $CRIT_CNT;"|grep -c "GET_IT"`</font></div><div><font size="2"   >if [ $CNT -ge 1 ]; then</font></div><div><font size="2"   >&nbsp; cresult=1</font></div><div><font size="2"   >&nbsp; &nbsp; psql&nbsp;<span style="line-height: 19px;"   >-F ',' -A </span><span style="line-height: 19px; font-family: Arial, Helvetica, sans-serif;"   >-q -t $CONN_INFO &lt;&lt;EOF</span></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; select inet_server_addr() as server_ip,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; inet_server_port() as server_port,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; error_severity,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; sql_state_code,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; count(1) from postgres_log&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; where error_severity&lt;&gt;'LOG'&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; group by inet_server_addr(),inet_server_port(),error_severity,sql_state_code&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; order by count(1) desc;</font></div><div><font size="2"   >EOF</font></div><div><font size="2"   >return 0</font></div><div><font size="2"   >fi</font></div><div><font size="2"   ># 警告</font></div><div><font size="2"   >CNT=`psql -q -t $CONN_INFO -c "select 'GET_IT' from postgres_log where error_severity&lt;&gt;'LOG' having count(*) &gt;= $WARN_CNT;"|grep -c "GET_IT"`</font></div><div><font size="2"   >if [ $CNT -ge 1 ]; then</font></div><div><font size="2"   >&nbsp; wresult=1</font></div><div><font size="2"   >&nbsp; &nbsp; psql&nbsp;<span style="line-height: 19px;"   >-F ',' -A </span><span style="line-height: 19px; font-family: Arial, Helvetica, sans-serif;"   >-q -t $CONN_INFO &lt;&lt;EOF</span></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; select inet_server_addr() as server_ip,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; inet_server_port() as server_port,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; error_severity,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; sql_state_code,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; count(1) from postgres_log&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; where error_severity&lt;&gt;'LOG'&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; group by inet_server_addr(),inet_server_port(),error_severity,sql_state_code&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; order by count(1) desc;</font></div><div><font size="2"   >EOF</font></div><div><font size="2"   >return 0</font></div><div><font size="2"   >fi</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># global result</font></div><div><font size="2"   >wresult=0</font></div><div><font size="2"   >cresult=0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># set env</font></div><div><font size="2"   >. /usr/local/nagios/etc/check_pg_env.sh</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># monitor</font></div><div><font size="2"   ># 错误阈值.</font></div><div><font size="2"   >BOND="'1 hour'"</font></div><div><font size="2"   >WARN_CNT=100</font></div><div><font size="2"   >CRIT_CNT=200</font></div><div><font size="2"   ># 本脚本不支持8.x的版本</font></div><div><font size="2"   >for i in "HZXY_CHECK_PG_LOCK_1" "HZXY_CHECK_PG_LOCK_5"</font></div><div><font size="2"   >do</font></div><div><font size="2"   >&nbsp; eval CONN_INFO="$"$i</font></div><div><font size="2"   >&nbsp; create_csvlogtable</font></div><div><font size="2"   >&nbsp; load_csvlog</font></div><div><font size="2"   >&nbsp; analyze_csvlog</font></div><div><font size="2"   >done</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># exit global proc</font></div><div><font size="2"   >if [ $cresult -eq 1 ]; then</font></div><div><font size="2"   >exit 2</font></div><div><font size="2"   >fi</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >if [ $wresult -eq 1 ]; then</font></div><div><font size="2"   >exit 1</font></div><div><font size="2"   >fi</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >exit 0</font></div><p></p></pre></div><div>5. 由于nagios check有超时机制, 建议做成异步（如crontab）. 也就是说本地定时CHECK. 将数据写入LOG中.</div><div>nagios的check脚本检查LOG的输出.</div><div>修改后的两个脚本如下 :&nbsp;</div><div>-- 放在crontab 中定期执行的脚本 &nbsp;:&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >#!/bin/bash<br># 环境变量<br>export LANG=en_US.utf8<br>export PGHOME=/opt/pgsql<br>export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib<br>export DATE=`date +"%Y%m%d%H%M"`<br>export PATH=$PGHOME/bin:$PATH:.<br>export MANPATH=$PGHOME/share/man:$MANPATH<br>export PGPASSFILE=/etc/.pgpass<br><br>if [ $# -ne 0 ]; then<br>  echo "USE $0"<br>  exit 0<br>fi<br><br>create_csvlogtable() {<br># debug<br># echo $CONN_INFO<br>VER=`psql -q -t $CONN_INFO -c "select '9' from (select substr(version(),12,1) as ver) t where ver::int&gt;=9"|grep -c 9`<br>if [ $VER -ge 1 ]; then<br># PostgreSQL 9+<br>IS_STDBY=`psql -q -t $CONN_INFO -c "select 'this_is_standby' as a where pg_is_in_recovery();"|grep -c this_is_standby`<br>if [ $IS_STDBY -ge 1 ]; then<br>  return 0<br>fi<br>psql -q -t $CONN_INFO &lt;&lt;EOF<br>do language plpgsql \$\$<br>declare<br>begin<br>perform 1 from pg_tables where tablename='postgres_log';<br>if not found then<br>CREATE TABLE postgres_log<br>(<br>  log_time timestamp(3) with time zone,<br>  user_name text,<br>  database_name text,<br>  process_id integer,<br>  connection_from text,<br>  session_id text,<br>  session_line_num bigint,<br>  command_tag text,<br>  session_start_time timestamp with time zone,<br>  virtual_transaction_id text,<br>  transaction_id bigint,<br>  error_severity text,<br>  sql_state_code text,<br>  message text,<br>  detail text,<br>  hint text,<br>  internal_query text,<br>  internal_query_pos integer,<br>  context text,<br>  query text,<br>  query_pos integer,<br>  location text,<br>  application_name text,<br>  PRIMARY KEY (session_id, session_line_num)<br>);<br>end if;<br>end;<br>\$\$;<br>EOF<br>else<br># PostgreSQL 8+<br># 不支持inline language, 建议预先创建表. <br>echo "PostgreSQL 8.x : $CONN_INFO"<br>fi<br>}<br><br>load_csvlog() {<br># 需要用到BOND变量, 减少导入日志数量<br>VER=`psql -q -t $CONN_INFO -c "select '9' from (select substr(version(),12,1) as ver) t where ver::int&gt;=9"|grep -c 9`<br>if [ $VER -ge 1 ]; then<br>  IS_STDBY=`psql -q -t $CONN_INFO -c "select 'this_is_standby' as a where pg_is_in_recovery();"|grep -c this_is_standby`<br>  if [ $IS_STDBY -ge 1 ]; then<br>    return 0<br>  fi<br>fi<br>if [ $VER -ge 1 ]; then<br>psql -q -t $CONN_INFO &lt;&lt;EOF<br>do language plpgsql \$\$<br>declare<br>v_dir text;<br>v_filename text;<br>v_sql text;<br>begin<br>set client_min_messages=warning;<br>truncate postgres_log;<br>select setting into v_dir from pg_settings where name='log_directory';<br>for v_filename in select filename from pg_ls_dir(v_dir) t(filename) <br>  where filename ~ 'csv\$' and (pg_stat_file(v_dir||'/'||filename)).modification+interval $BOND &gt;= now() loop<br>v_sql := \$_\$COPY postgres_log FROM '\$_\$||v_dir||'/'||v_filename||\$_\$' WITH csv\$_\$;<br>raise notice '%', v_sql;<br>execute v_sql;<br>end loop;<br>end;<br>\$\$;<br>EOF<br>else<br># PostgreSQL 8.x 不支持do language, 所以使用函数.<br>echo "PostgreSQL 8.x : $CONN_INFO"<br>psql -q -t $CONN_INFO &lt;&lt;EOF<br>create or replace function load_csvlog() returns void as \$\$<br>declare<br>v_dir text;<br>v_filename text;<br>v_sql text;<br>begin<br>set client_min_messages=warning;<br>truncate postgres_log;<br>select setting into v_dir from pg_settings where name='log_directory';<br>for v_filename in select filename from pg_ls_dir(v_dir) t(filename) <br>  where filename ~ 'csv\$' and (pg_stat_file(v_dir||'/'||filename)).modification+interval $BOND &gt;= now() loop<br>v_sql := \$_\$COPY postgres_log FROM '\$_\$||v_dir||'/'||v_filename||\$_\$' WITH csv\$_\$;<br>raise notice '%', v_sql;<br>execute v_sql;<br>end loop;<br>return;<br>end;<br>\$\$ language plpgsql;<br>select * from load_csvlog();<br>EOF<br>fi<br>}<br><br>analyze_csvlog() {<br>VER=`psql -q -t $CONN_INFO -c "select '9' from (select substr(version(),12,1) as ver) t where ver::int&gt;=9"|grep -c 9`<br>if [ $VER -ge 1 ]; then<br>  IS_STDBY=`psql -q -t $CONN_INFO -c "select 'this_is_standby' as a where pg_is_in_recovery();"|grep -c this_is_standby`<br>  if [ $IS_STDBY -ge 1 ]; then<br>    return 0<br>  fi<br>fi<br># 严重警告<br>CNT=`psql -q -t $CONN_INFO -c "select 'GET_IT' from postgres_log where error_severity&lt;&gt;'LOG' having count(*) &gt;= $CRIT_CNT;"|grep -c "GET_IT"`<br>if [ $CNT -ge 1 ]; then<br>  cresult=1<br>  echo -e "CHECK ERRORs&gt;$CRIT_CNT. return 2\n"<br># nagios 将|视为status和performance info的分隔符, 所以需要调整一下psql的输出格式<br>    psql -F ',' -A -q -t $CONN_INFO &lt;&lt;EOF<br>      select inet_server_addr() as server_ip,<br>      inet_server_port() as server_port,<br>      error_severity,<br>      sql_state_code,<br>      count(1) from postgres_log <br>      where error_severity&lt;&gt;'LOG' <br>      group by inet_server_addr(),inet_server_port(),error_severity,sql_state_code <br>      having count(1)&gt;100<br>      order by count(1) desc;<br>EOF<br>return 0<br>fi<br># 警告<br>CNT=`psql -q -t $CONN_INFO -c "select 'GET_IT' from postgres_log where error_severity&lt;&gt;'LOG' having count(*) &gt;= $WARN_CNT;"|grep -c "GET_IT"`<br>if [ $CNT -ge 1 ]; then<br>  wresult=1<br>  echo -e "CHECK ERRORs&gt;$WARN_CNT. return 1\n"<br>    psql -F ',' -A -q -t $CONN_INFO &lt;&lt;EOF<br>      select inet_server_addr() as server_ip,<br>      inet_server_port() as server_port,<br>      error_severity,<br>      sql_state_code,<br>      count(1) from postgres_log <br>      where error_severity&lt;&gt;'LOG' <br>      group by inet_server_addr(),inet_server_port(),error_severity,sql_state_code <br>      having count(1)&gt;100<br>      order by count(1) desc;<br>EOF<br>return 0<br>fi<br>}<br><br># global result<br>wresult=0<br>cresult=0<br><br># set env<br>. /usr/local/nagios/etc/check_pg_env.sh<br><br># monitor<br># 错误阈值.<br>BOND="'1 hour'"<br>WARN_CNT=500<br>CRIT_CNT=1000<br>LOGFILE=/tmp/check_pg_csvlog.log<br>TMPLOGFILE=/tmp/check_pg_csvlog.log.tmp<br><br># 清除tmp数据<br>echo "" &gt;$TMPLOGFILE<br><br>for i in "HZ_CHECK_PG_LOCK_1" "HZ_CHECK_PG_LOCK_2"<br>do<br>  eval CONN_INFO="$"$i<br>  create_csvlogtable<br>  load_csvlog<br>  analyze_csvlog &gt;&gt;$TMPLOGFILE 2&gt;&amp;1<br>done<br><br># 替换数据<br>cat $TMPLOGFILE &gt;$LOGFILE<br><br># exit global proc<br>if [ $cresult -eq 1 ]; then<br>exit 2<br>fi<br><br>if [ $wresult -eq 1 ]; then<br>exit 1<br>fi<br><br>exit 0</span></font></div><div></div><p></p></pre></div><p><span style="line-height: 22px;"   >-- nagios的check脚本 :&nbsp;</span></p><p></p><p></p><pre class="prettyprint"   ><p></p><p><font size="2"   ><span style="line-height: 19px;"   >#!/bin/bash<br># 环境变量<br>export LANG=en_US.utf8<br>export PGHOME=/opt/pgsql<br>export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib<br>export DATE=`date +"%Y%m%d%H%M"`<br>export PATH=$PGHOME/bin:$PATH:.<br>export MANPATH=$PGHOME/share/man:$MANPATH<br><br>LOGFILE=/tmp/check_pg_csvlog.log<br><br>CNT=`cat $LOGFILE|grep -c -E "ERROR|FATAL"`<br>if [ $CNT -ge 1 ]; then<br>  RETVAL2=`cat $LOGFILE|grep -c "return 2"`<br>  if [ $RETVAL2 -ge 1 ]; then<br>    # summary<br>    echo -e "CHECK ERRORs DB IP:"<br>    cat $LOGFILE|grep -v "^\$"|grep -v "CHECK ERRORs"|awk -F ',' '{print $1}'|sort|uniq<br>    # detail<br>    echo -e "\n DETAIL:"<br>    cat $LOGFILE|grep -v "^\$"|grep -v "CHECK ERRORs"<br>    exit 2<br>  fi<br>  RETVAL1=`cat $LOGFILE|grep -c "return 1"`<br>  if [ $RETVAL1 -ge 1 ]; then<br>    # summary<br>    echo -e "CHECK ERRORs DB IP:"<br>    cat $LOGFILE|grep -v "^\$"|grep -v "CHECK ERRORs"|awk -F ',' '{print $1}'|sort|uniq<br>    # detail<br>    echo -e "\n DETAIL:"<br>    cat $LOGFILE|grep -v "^\$"|grep -v "CHECK ERRORs"<br>    exit 1<br>  fi<br>  cat $LOGFILE<br>  exit 4<br>fi</span></font></p><p></p></pre><div><br></div>【参考】<div>1.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013121102459107/"   >http://blog.163.com/digoal@126/blog/static/1638770402013121102459107/</a><br><br><wbr></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">francs - 2013-05-08 16:00:13</h5>
				<div>这个日志监控脚本不错，就是比较复杂。</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 francs - 2013-05-08 16:00:13</h5>
				<div style="width:600px;">不复杂.</div>
			</div>
	</div>
</div>
</body>
</html>