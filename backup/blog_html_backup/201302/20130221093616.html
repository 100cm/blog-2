<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL ERROR:  54000: out of memory</h2>
	<h5 id="">2013-02-21 9:36:16&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201312191344783/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">昨天joan那边聊到的一个问题 :&nbsp;<div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2013-02-20 14:29:28 CST aischool_1221_01LOG: &nbsp;incomplete message from client</font></div><div><font size="2"   >2013-02-20 14:29:28 CST aischool_1221_01ERROR: &nbsp;out of memory</font></div><div><font size="2"   >2013-02-20 14:29:28 CST aischool_1221_01DETAIL: &nbsp;Cannot enlarge string buffer containing 0 bytes by 1342177281 more bytes.</font></div><div><font size="2"   >2013-02-20 14:29:28 CST aischool_1221_01LOG: &nbsp;could not send data to client: 断开的管道</font></div><div><font size="2"   >2013-02-20 14:29:28 CST aischool_1221_01LOG: &nbsp;unexpected EOF on client connection</font></div><p></p></pre></div><div>首先要确定问题出在哪块代码中, 经过检索后发现错误来自<span style="line-height: 22px;"   >enlargeStringInfo函数</span><span style="line-height: 22px;"   >如下 :</span></div><div>src/backend/lib/stringinfo.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >00235 /*</font></div><div><font size="2"   >00236 &nbsp;* enlargeStringInfo</font></div><div><font size="2"   >00237 &nbsp;*</font></div><div><font size="2"   >00238 &nbsp;* Make sure there is enough space for 'needed' more bytes</font></div><div><font size="2"   >00239 &nbsp;* ('needed' does not include the terminating null).</font></div><div><font size="2"   >00240 &nbsp;*</font></div><div><font size="2"   >00241 &nbsp;* External callers usually need not concern themselves with this, since</font></div><div><font size="2"   >00242 &nbsp;* all stringinfo.c routines do it automatically. &nbsp;However, if a caller</font></div><div><font size="2"   >00243 &nbsp;* knows that a StringInfo will eventually become X bytes large, it</font></div><div><font size="2"   >00244 &nbsp;* can save some palloc overhead by enlarging the buffer before starting</font></div><div><font size="2"   >00245 &nbsp;* to store data in it.</font></div><div><font size="2"   >00246 &nbsp;*</font></div><div><font size="2"   >00247 &nbsp;* NB: because we use repalloc() to enlarge the buffer, the string buffer</font></div><div><font size="2"   >00248 &nbsp;* will remain allocated in the same memory context that was current when</font></div><div><font size="2"   >00249 &nbsp;* initStringInfo was called, even if another context is now current.</font></div><div><font size="2"   >00250 &nbsp;* This is the desired and indeed critical behavior!</font></div><div><font size="2"   >00251 &nbsp;*/</font></div><div><font size="2"   >00252 void</font></div><div><font size="2"   >00253 enlargeStringInfo(StringInfo str, int needed)</font></div><div><font size="2"   >00254 {</font></div><div><font size="2"   >00255 &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; newlen;</font></div><div><font size="2"   >00256&nbsp;</font></div><div><font size="2"   >00257 &nbsp; &nbsp; /*</font></div><div><font size="2"   >00258 &nbsp; &nbsp; &nbsp;* Guard against out-of-range "needed" values. &nbsp;Without this, we can get</font></div><div><font size="2"   >00259 &nbsp; &nbsp; &nbsp;* an overflow or infinite loop in the following.</font></div><div><font size="2"   >00260 &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >00261 &nbsp; &nbsp; if (needed &lt; 0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* should not happen */</font></div><div><font size="2"   >00262 &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, "invalid string enlargement request size: %d", needed);</font></div><div><font size="2"   >00263 &nbsp; &nbsp; if (((Size) needed) &gt;= (MaxAllocSize - (Size) str-&gt;len))</font></div><div><font size="2"   >00264 &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >00265 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_PROGRAM_LIMIT_EXCEEDED),</font></div><div><font size="2"   >00266 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("out of memory"),</font></div><div><font size="2"   >00267 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errdetail("Cannot enlarge string buffer containing %d bytes by %d more bytes.",</font></div><div><font size="2"   >00268 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;str-&gt;len, needed)));</font></div><div><font size="2"   >00269&nbsp;</font></div><div><font size="2"   >00270 &nbsp; &nbsp; needed += str-&gt;len + 1; &nbsp; &nbsp; /* total space required now */</font></div><div><font size="2"   >00271&nbsp;</font></div><div><font size="2"   >00272 &nbsp; &nbsp; /* Because of the above test, we now have needed &lt;= MaxAllocSize */</font></div><div><font size="2"   >00273&nbsp;</font></div><div><font size="2"   >00274 &nbsp; &nbsp; if (needed &lt;= str-&gt;maxlen)</font></div><div><font size="2"   >00275 &nbsp; &nbsp; &nbsp; &nbsp; return; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* got enough space already */</font></div><div><font size="2"   >00276&nbsp;</font></div><div><font size="2"   >00277 &nbsp; &nbsp; /*</font></div><div><font size="2"   >00278 &nbsp; &nbsp; &nbsp;* We don't want to allocate just a little more space with each append;</font></div><div><font size="2"   >00279 &nbsp; &nbsp; &nbsp;* for efficiency, double the buffer size each time it overflows.</font></div><div><font size="2"   >00280 &nbsp; &nbsp; &nbsp;* Actually, we might need to more than double it if 'needed' is big...</font></div><div><font size="2"   >00281 &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >00282 &nbsp; &nbsp; newlen = 2 * str-&gt;maxlen;</font></div><div><font size="2"   >00283 &nbsp; &nbsp; while (needed &gt; newlen)</font></div><div><font size="2"   >00284 &nbsp; &nbsp; &nbsp; &nbsp; newlen = 2 * newlen;</font></div><div><font size="2"   >00285&nbsp;</font></div><div><font size="2"   >00286 &nbsp; &nbsp; /*</font></div><div><font size="2"   >00287 &nbsp; &nbsp; &nbsp;* Clamp to MaxAllocSize in case we went past it. &nbsp;Note we are assuming</font></div><div><font size="2"   >00288 &nbsp; &nbsp; &nbsp;* here that MaxAllocSize &lt;= INT_MAX/2, else the above loop could</font></div><div><font size="2"   >00289 &nbsp; &nbsp; &nbsp;* overflow. &nbsp;We will still have newlen &gt;= needed.</font></div><div><font size="2"   >00290 &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >00291 &nbsp; &nbsp; if (newlen &gt; (int) MaxAllocSize)</font></div><div><font size="2"   >00292 &nbsp; &nbsp; &nbsp; &nbsp; newlen = (int) MaxAllocSize;</font></div><div><font size="2"   >00293&nbsp;</font></div><div><font size="2"   >00294 &nbsp; &nbsp; str-&gt;data = (char *) repalloc(str-&gt;data, newlen);</font></div><div><font size="2"   >00295&nbsp;</font></div><div><font size="2"   >00296 &nbsp; &nbsp; str-&gt;maxlen = newlen;</font></div><div><font size="2"   >00297 }</font></div><p></p></pre></div><div>从错误的输出Cannot enlarge string buffer containing 0 bytes by 1342177281 more bytes.可以得知.</div><div><span style="line-height: 22px;"   >((Size) needed) &gt;= (MaxAllocSize - (Size) str-&gt;len)</span></div><div><span style="line-height: 22px;"   >同时</span></div><div><span style="line-height: 22px;"   >needed =&nbsp;</span><span style="line-height: 22px;"   >1342177281</span></div><div><span style="line-height: 22px;"   >str-&gt;len = 0</span></div><div><span style="line-height: 22px;"   >1342177281</span><span style="line-height: 22px;"   >已经超过了MaxAllocSize的大小如下 :&nbsp;</span></div><div>src/include/utils/memutils.h</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >00023 /*</font></div><div><font size="2"   >00024 &nbsp;* MaxAllocSize</font></div><div><font size="2"   >00025 &nbsp;* &nbsp; &nbsp; &nbsp;Quasi-arbitrary limit on size of allocations.</font></div><div><font size="2"   >00026 &nbsp;*</font></div><div><font size="2"   >00027 &nbsp;* Note:</font></div><div><font size="2"   >00028 &nbsp;* &nbsp; &nbsp; &nbsp;There is no guarantee that allocations smaller than MaxAllocSize</font></div><div><font size="2"   >00029 &nbsp;* &nbsp; &nbsp; &nbsp;will succeed. &nbsp;Allocation requests larger than MaxAllocSize will</font></div><div><font size="2"   >00030 &nbsp;* &nbsp; &nbsp; &nbsp;be summarily denied.</font></div><div><font size="2"   >00031 &nbsp;*</font></div><div><font size="2"   >00032 &nbsp;* XXX This is deliberately chosen to correspond to the limiting size</font></div><div><font size="2"   >00033 &nbsp;* of varlena objects under TOAST. &nbsp;See VARSIZE_4B() and related macros</font></div><div><font size="2"   >00034 &nbsp;* in postgres.h. &nbsp;Many datatypes assume that any allocatable size can</font></div><div><font size="2"   >00035 &nbsp;* be represented in a varlena header.</font></div><div><font size="2"   >00036 &nbsp;*</font></div><div><font size="2"   >00037 &nbsp;* XXX Also, various places in aset.c assume they can compute twice an</font></div><div><font size="2"   >00038 &nbsp;* allocation's size without overflow, so beware of raising this.</font></div><div><font size="2"   >00039 &nbsp;*/</font></div><div><font size="2"   >00040 #define MaxAllocSize &nbsp; &nbsp;((Size) 0x3fffffff) &nbsp; &nbsp; /* 1 gigabyte - 1 */</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >但是调用</span><span style="line-height: 22px;"   >enlargeStringInfo的函数有很多, 到底是哪个函数调用的从日志上反映不出来. 需要更详细的信息.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22px;"   >void enlargeStringInfo</span><span style="line-height: 22px;"   >	</span><span style="line-height: 22px;"   >(</span><span style="line-height: 22px;"   >	</span><span style="line-height: 22px;"   >StringInfo </span><span style="line-height: 22px;"   >	</span><span style="line-height: 22px;"   >str,</span></font></div><div><font size="2"   >int <span>	</span>needed<span>	</span>&nbsp;</font></div><div><font size="2"   >)<span>			</span></font></div><div><font size="2"   >Definition at line 253 of file stringinfo.c.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >References StringInfoData::data, elog, ereport, errcode(), errdetail(), errmsg(), ERROR, StringInfoData::len, MaxAllocSize, StringInfoData::maxlen, and repalloc().</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Referenced by appendBinaryStringInfo(), appendStringInfo(), appendStringInfoChar(), appendStringInfoSpaces(), CopyReadAttributesCSV(), CopyReadAttributesText(), CopyReadBinaryAttribute(), GetOldFunctionMessage(), PLy_elog(), pq_getmessage(), and XLogSend().</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >要找出到底是哪个函数调用的, 检索以上函数哪些会爆出这个日志</span>LOG: &nbsp;incomplete message from client</div><div>检索到了 :&nbsp;</div><div>src/backend/libpq/pqcomm.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/* --------------------------------</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pq_getmessage &nbsp; - get a message with length word from connection</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;The return value is placed in an expansible StringInfo, which has</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;already been initialized by the caller.</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Only the message body is placed in the StringInfo; the length word</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;is removed. &nbsp;Also, s-&gt;cursor is initialized to zero for convenience</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;in scanning the message contents.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;If maxlen is not zero, it is an upper limit on the length of the</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;message we are willing to accept. &nbsp;We abort the connection (by</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;returning EOF) if client tries to send more than that.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;returns 0 if OK, EOF if trouble</font></div><div><font size="2"   >&nbsp;* --------------------------------</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >int</font></div><div><font size="2"   >pq_getmessage(StringInfo s, int maxlen)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; resetStringInfo(s);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Read message length word */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (pq_getbytes((char *) &amp;len, 4) == EOF)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(COMMERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_PROTOCOL_VIOLATION),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("unexpected EOF within message length word")));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return EOF;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; len = ntohl(len);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (len &lt; 4 ||</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (maxlen &gt; 0 &amp;&amp; len &gt; maxlen))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(COMMERROR,</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_PROTOCOL_VIOLATION),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("invalid message length")));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return EOF;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; len -= 4; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* discount length itself */</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (len &gt; 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Allocate space for message. &nbsp;If we run out of room (ridiculously</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* large message), we will elog(ERROR), but we want to discard the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* message body so as not to lose communication sync.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_TRY();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; enlargeStringInfo(s, len);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_CATCH();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (pq_discardbytes(len) == EOF)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(COMMERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_PROTOCOL_VIOLATION),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("incomplete message from client")));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RE_THROW();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_END_TRY();</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* And grab the message */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (pq_getbytes(s-&gt;data, len) == EOF)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(COMMERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_PROTOCOL_VIOLATION),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("incomplete message from client")));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return EOF;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s-&gt;len = len;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Place a trailing null per StringInfo convention */</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s-&gt;data[len] = '\0';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return 0;</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div>知道原因后, 就需要找出是哪个客户端触发的了, 由于日志中没有客户端IP和端口信息, 所以需要修改一下postgresql.conf</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >log_destination = 'csvlog'</font></div><div><font size="2"   >logging_collector = on</font></div><div><font size="2"   >-- 同时建议开启以下</font></div><div><span style="line-height: 22px;"   ><font size="2"   >log_error_verbosity = verbose</font></span></div><p></p></pre></div><div>重启数据库.</div><div><span style="line-height: 22px;"   >如果是一个可实时重现的错误, 那么建议用gdb跟踪一下, 观察执行过程中的变量值.</span></div><div>如果是随记出现的错误, 下次再触发的时候可以根据日志中的客户端IP和端口找出客户端.</div><div>同时结合客户端的日志找出原因并解决它.</div><div><br></div><div>【其他】</div><div>1. 开启log_error_verbosity = verbose后, 可以看到日志输出对应的代码位置, 这样就不需要自己去检索了 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2013-02-20 17:45:02 CST LOG: &nbsp;08P01: incomplete message from client</font></div><div><font size="2"   >2013-02-20 17:45:02 CST LOCATION: &nbsp;pq_getmessage, pqcomm.c:1105</font></div><div><font size="2"   >2013-02-20 17:45:02 CST ERROR: &nbsp;54000: out of memory</font></div><div><font size="2"   >2013-02-20 17:45:02 CST DETAIL: &nbsp;Cannot enlarge string buffer containing 0 bytes by 1157627900 more bytes.</font></div><div><font size="2"   >2013-02-20 17:45:02 CST LOCATION: &nbsp;enlargeStringInfo, stringinfo.c:268</font></div><p></p></pre></div><wbr></div>2.&nbsp;<div><pre class="prettyprint"   ><p></p><div><font size="2"   >/* --------------------------------</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pq_getbytes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - get a known number of bytes from connection</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;returns 0 if OK, EOF if trouble</font></div><div><font size="2"   >&nbsp;* --------------------------------</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >int</font></div><div><font size="2"   >pq_getbytes(char *s, size_t len)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; size_t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;amount;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; while (len &gt; 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; while (PqRecvPointer &gt;= PqRecvLength)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (pq_recvbuf()) &nbsp; &nbsp; &nbsp; /* If nothing in buffer, then recv some */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return EOF; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Failed to recv data */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; amount = PqRecvLength - PqRecvPointer;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (amount &gt; len)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; amount = len;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; memcpy(s, PqRecvBuffer + PqRecvPointer, amount);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PqRecvPointer += amount;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s += amount;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len -= amount;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return 0;</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>3.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/* --------------------------------</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pq_recvbuf - load some bytes into the input buffer</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;returns 0 if OK, EOF if trouble</font></div><div><font size="2"   >&nbsp;* --------------------------------</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static int</font></div><div><font size="2"   >pq_recvbuf(void)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (PqRecvPointer &gt; 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (PqRecvLength &gt; PqRecvPointer)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* still some unread data, left-justify it in the buffer */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; memmove(PqRecvBuffer, PqRecvBuffer + PqRecvPointer,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PqRecvLength - PqRecvPointer);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PqRecvLength -= PqRecvPointer;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PqRecvPointer = 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PqRecvLength = PqRecvPointer = 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Ensure that we're in blocking mode */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; pq_set_nonblocking(false);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Can fill buffer from PqRecvLength and upwards */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; for (;;)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r = secure_read(MyProcPort, PqRecvBuffer + PqRecvLength,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PQ_RECV_BUFFER_SIZE - PqRecvLength);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (r &lt; 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (errno == EINTR)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; continue; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Ok if interrupted */</font></div></div><div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Careful: an ereport() that tries to write to the client would</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* cause recursion to here, leading to stack overflow and core</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* dump! &nbsp;This message must go *only* to the postmaster log.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(COMMERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode_for_socket_access(),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("could not receive data from client: %m")));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return EOF;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (r == 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* EOF detected. &nbsp;We used to write a log message here, but it's</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* better to expect the ultimate caller to do that.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return EOF;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* r contains number of bytes read, so just incr length */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PqRecvLength += r;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div>4. 使用psql时, 设置<span style="line-height: 28px;"   >VERBOSITY也可以获取到错误信息的代码位置.</span><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \set VERBOSITY verbose</font></div><div><font size="2"   >postgres=# s;</font></div><div><font size="2"   >ERROR: &nbsp;42601: syntax error at or near "s"</font></div><div><font size="2"   >LINE 1: s;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   >LOCATION: &nbsp;scanner_yyerror, scan.l:1053</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>