<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 new feature: Replication slots</h2>
	<h5 id="">2014-02-04 17:05:04&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014144508258/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><span style="line-height: 28px;"   >PostgreSQL 9.4 新增的一个特写, replication slot,&nbsp;</span></div><div><span style="line-height: 28px;"   >1. 可以被流复制的sender节点用于自动识别它xlog中的数据在下面的standby中是否还需要(例如, standby断开连接后, 还未接收到的XLOG), 如果还需要的话, 那么这些XLOG将不会被删除.</span></div><div><span style="line-height: 28px;"   >2. 对于tuples, 如果standby 配置了hot_standby_feedback=on, 那么发生冲突的tuples将不会在sender端被vacuum回收. 用于规避冲突.</span></div><div><span style="line-height: 28px;"   >配置比较简单, 需要在sender端使用函数创建slot, 在receiver端配置对应的slot name即可.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Introduce replication slots.</font></div><div><font size="2"   >author<span>	</span>Robert Haas &lt;rhaas@postgresql.org&gt;<span>	</span></font></div><div><font size="2"   ><span>	</span>Sat, 1 Feb 2014 03:45:17 +0000 (22:45 -0500)</font></div><div><font size="2"   >committer<span>	</span>Robert Haas &lt;rhaas@postgresql.org&gt;<span>	</span></font></div><div><font size="2"   ><span>	</span>Sat, 1 Feb 2014 03:45:36 +0000 (22:45 -0500)</font></div><div><font size="2"   >commit<span>	</span>858ec11858a914d4c380971985709b6d6b7dd6fc</font></div><div><font size="2"   >tree<span>	</span>59eb508185cd8544c3485919a25dee15f3818c21<span>	</span>tree | snapshot</font></div><div><font size="2"   >parent<span>	</span>5bdef38b8917cfbe206d14969c61a5d38fc822b6<span>	</span>commit | diff</font></div><div><font size="2"   >Introduce replication slots.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Replication slots are a crash-safe data structure which can be created</font></div><div><font size="2"   >on either a master or a standby to prevent premature removal of</font></div><div><font size="2"   >write-ahead log segments needed by a standby, as well as (with</font></div><div><font size="2"   >hot_standby_feedback=on) pruning of tuples whose removal would cause</font></div><div><font size="2"   >replication conflicts. &nbsp;Slots have some advantages over existing</font></div><div><font size="2"   >techniques, as explained in the documentation.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >In a few places, we refer to the type of replication slots introduced</font></div><div><font size="2"   >by this patch as "physical" slots, because forthcoming patches for</font></div><div><font size="2"   >logical decoding will also have slots, but with somewhat different</font></div><div><font size="2"   >properties.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Andres Freund and Robert Haas</font></div><p></p></pre></div><div><br></div><div>功能介绍请参考 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/warm-standby.html#STREAMING-REPLICATION-SLOTS"   >http://www.postgresql.org/docs/devel/static/warm-standby.html#STREAMING-REPLICATION-SLOTS</a></div><div>相关参数</div><div>postgresql.conf &nbsp;- sender server config</div><div><dt style="font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"   ><tt>max_replication_slots</tt>&nbsp;(<tt>integer</tt>)</dt><dd style="font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"   ><p style="font-size: 1em; line-height: 1.5em; margin: 1.2em 0em;"   >Specifies the maximum number of replication slots (see&nbsp;<a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/warm-standby.html#STREAMING-REPLICATION-SLOTS"   >Section 25.2.6</a>&nbsp;that the server can support. The default is zero. This parameter can only be set at server start.&nbsp;<tt>wal_level</tt>&nbsp;must be set to&nbsp;<tt>archive</tt>&nbsp;or higher to allow replication slots to be used. Setting it to a lower value than the number of currently existing replication slots will prevent the server from starting.</p></dd></div><div>recovery.conf</div><div><div>+# If set, the PostgreSQL server will use the specified replication slot when</div><div>+# connecting to the primary via streaming replication to control resource</div><div>+# removal on the upstream node. This setting has no effect if primary_conninfo</div><div>+# is not set.</div><div>+#</div><div>+#primary_slotname = ''</div></div><div><br></div><div><span style="line-height: 28px;"   >相关函数, 视图</span></div><div><p style="font-size: 12px; line-height: 1.5em; margin: 1.2em 0em; font-weight: bold; font-family: verdana, sans-serif;"   >Table 9-67. Replication&nbsp;<acronym>SQL&nbsp;Functions</p><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; background-color: rgb(224, 236, 239); border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"   ><colgroup><col><col><col><thead><tr><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Function</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Return Type</th><th style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex;"   >Description</th></tr></thead><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   ><tt>pg_create_physical_replication_slot(<tt style="font-size: 1em;"   >slotname</tt><tt style="font-size: 1em;"   >text</tt>,&nbsp;<tt style="font-size: 1em;"   >plugin</tt>&nbsp;<tt style="font-size: 1em;"   >text</tt>)</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   >(<tt>slotname</tt>&nbsp;<tt>text</tt>,<tt>xlog_position</tt><tt>text</tt>)</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(239, 239, 239); padding: 0.5ex;"   >Creates a new physical replication slot named&nbsp;<tt>slotname</tt>. Streaming changes from a physical slot is only possible with the walsender protocol - see&nbsp;<a style="color: rgb(0, 78, 102);" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/protocol-replication.html"   >Section 48.3</a>. Corresponds to the walsender protocol command&nbsp;<tt>CREATE_REPLICATION_SLOT ... PHYSICAL</tt>.</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   ><tt>pg_drop_replication_slot(<tt style="font-size: 1em;"   >slotname</tt>&nbsp;<tt style="font-size: 1em;"   >text</tt>)</tt></td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >(<tt>slotname</tt>&nbsp;<tt>text</tt>)</td><td style="border: 1px solid rgb(167, 198, 223); background-color: rgb(255, 255, 255); padding: 0.5ex;"   >Drops the physical or logical replication slot named&nbsp;<tt>slotname</tt>. Same as walsender protocol command&nbsp;<tt>DROP_REPLICATION_SLOT</tt>.</td></tr></table></div><div><p style="font-size: 12px; line-height: 1.5em; margin: 1.2em 0em; font-family: verdana, sans-serif;"   >You can create a replication slot like this:</p><pre style="font-size: 12px; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border: 1px solid rgb(207, 207, 207); padding: 2ex; margin-top: 2ex; margin-bottom: 2ex; margin-left: 2ex; overflow: auto; border-top-left-radius: 8px; border-top-right-radius: 8px; border-bottom-right-radius: 8px; border-bottom-left-radius: 8px; background-color: rgb(247, 247, 247); line-height: normal;"   >postgres=# SELECT * FROM pg_create_physical_replication_slot('node_a_slot');
  slotname   | xlog_position
-------------+---------------
 node_a_slot |

postgres=# SELECT * FROM pg_replication_slots;
  slot_name  | slot_type | datoid | database | active | xmin | restart_lsn
-------------+-----------+--------+----------+--------+------+-------------
 node_a_slot | physical  |      0 |          | f      |      |
(1 row)
</pre><p style="font-size: 12px; line-height: 1.5em; margin: 1.2em 0em; font-family: verdana, sans-serif;"   >To configure the standby to use this slot,&nbsp;<tt>primary_slotname</tt>&nbsp;should be configured in the standby's&nbsp;<tt>recovery.conf</tt>. Here is a simple example:</p><pre style="font-size: 12px; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border: 1px solid rgb(207, 207, 207); padding: 2ex; margin-top: 2ex; margin-bottom: 2ex; margin-left: 2ex; overflow: auto; border-top-left-radius: 8px; border-top-right-radius: 8px; border-bottom-right-radius: 8px; border-bottom-left-radius: 8px; background-color: rgb(247, 247, 247); line-height: normal;"   >standby_mode = 'on'
primary_conninfo = 'host=192.168.1.50 port=5432 user=foo password=foopass'
primary_slotname = 'node_a_slot'</pre></div><div>流复制协议也做了相应的改进 :&nbsp;</div><div><br></div><div>使用slot的好处 :&nbsp;</div><div>1. 在没有replication slot这个特性以前, 有两种方法来保持standby需要的xlog, wal keep或者归档, 因为主节点不知道standby到底需要哪些XLOG信息, 配置一般需要较大的余量. slot可以解决这个浪费sender端存储wal空间的问题, 因为sender可以做到保留更精准的wal信息.</div><div>2. 配合standby节点的feedback使用, 可以避免vacuum带来的冲突.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=858ec11858a914d4c380971985709b6d6b7dd6fc"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=858ec11858a914d4c380971985709b6d6b7dd6fc</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=0753bdb352270a03dec52bc959418fa82e9b07cc"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=0753bdb352270a03dec52bc959418fa82e9b07cc</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/runtime-config-replication.html#RUNTIME-CONFIG-REPLICATION-SENDER"   >http://www.postgresql.org/docs/devel/static/runtime-config-replication.html#RUNTIME-CONFIG-REPLICATION-SENDER</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/warm-standby.html#STREAMING-REPLICATION-SLOTS"   >http://www.postgresql.org/docs/devel/static/warm-standby.html#STREAMING-REPLICATION-SLOTS</a></div><div>5.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/protocol-replication.html"   >http://www.postgresql.org/docs/devel/static/protocol-replication.html</a></div><div>6.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/functions-admin.html#FUNCTIONS-REPLICATION"   >http://www.postgresql.org/docs/devel/static/functions-admin.html#FUNCTIONS-REPLICATION</a></div><div>7.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/hot-standby.html#HOT-STANDBY-CONFLICT"   >http://www.postgresql.org/docs/devel/static/hot-standby.html#HOT-STANDBY-CONFLICT</a></div></div>
	</div>
</div>
</body>
</html>