<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Use luapgsql connect postgresql</h2>
	<h5 id="">2014-02-21 11:34:54&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014121113037760/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>lua连接数据库的动态库很多, 这里以luapgsql为例, 讲解如何使用luapgsql连接postgresql.</div><div>luapgsql详细用法参考 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://stpeters.github.io/luapgsql/"   >http://stpeters.github.io/luapgsql/</a></div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/libpq-exec.html"   >http://www.postgresql.org/docs/9.3/static/libpq-exec.html</a></div><div>环境 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Lua 5.2</font></div><div><font size="2"   >CentOS 5.x x64</font></div><div><font size="2"   >PostgreSQL 9.3.2</font></div><p></p></pre></div><div>首先下载luapgsql的源码 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >git clone&nbsp;https://github.com/mbalmer/luapgsql</font></div><div><font size="2"   >cd&nbsp;luapgsql</font></div><p></p></pre></div><div>luapgsql依赖postgresql, libbsd-devel包, 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   ><br></font></div><div><font size="2"   >#include &lt;postgres.h&gt;</font></div><div><font size="2"   >#include &lt;libpq-fe.h&gt;</font></div><div><font size="2"   >#include &lt;libpq/libpq-fs.h&gt;</font></div><div><font size="2"   >#include &lt;pg_config.h&gt;</font></div><div><font size="2"   >#include &lt;catalog/pg_type.h&gt;</font></div></div><div><div><font size="2"   >#ifdef __linux__</font></div><div><font size="2"   >#include &lt;bsd/bsd.h&gt;</font></div><div><font size="2"   >#endif</font></div></div><p></p></pre></div><div><br></div><div>从README得知, 因为是在Linux下使用luapgsql, 所以会用到GNUmakefile, 修改 GNUmakefile,&nbsp;<span style="line-height: 28px;"   >LDADD</span><span style="line-height: 28px;"   >加入</span><span style="line-height: 28px;"   >-L/opt/pgsql9.3.2/lib,&nbsp;</span><span style="line-height: 28px;"   >CFLAGS加入</span><span style="line-height: 28px;"   >-I/opt/pgsql9.3.2/include/server -I/opt/pgsql9.3.2/include</span></div><div><span style="line-height: 28px;"   >视你的postgresql环境情况而定.</span></div><div><pre class="prettyprint"   ><div><font size="2"   >vi&nbsp;GNUmakefile</font></div><div><span style="line-height: 28px;"   ><font size="2"   >SRCS= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; luapgsql.c</font></span></div><div><div><font size="2"   >LIB= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pgsql</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >LUAVER= &nbsp; &nbsp; &nbsp; &nbsp; `lua -v 2&gt;&amp;1 | cut -c 5-7`</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CFLAGS+= &nbsp; &nbsp; &nbsp; &nbsp;-O3 -Wall -fPIC -I/usr/include -I/usr/include/lua${LUAVER} \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -I/opt/pgsql9.3.2/include/server -I/opt/pgsql9.3.2/include -D_GNU_SOURCE</font></div><div><font size="2"   >LDADD+= &nbsp; &nbsp; &nbsp; &nbsp; -L/usr/lib -L/opt/pgsql9.3.2/lib -lpq -lbsd</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >LIBDIR= &nbsp; &nbsp; &nbsp; &nbsp; /usr/lib</font></div><div><font size="2"   >LUADIR= &nbsp; &nbsp; &nbsp; &nbsp; /usr/lib/lua/${LUAVER}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >${LIB}.so: &nbsp; &nbsp; &nbsp;${SRCS:.c=.o}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cc -shared -o ${LIB}.so ${CFLAGS} ${SRCS:.c=.o} ${LDADD}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >clean:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rm -f *.o *.so</font></div><div><font size="2"   >install:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; install -d ${DESTDIR}${LIBDIR}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; install -m 755 ${LIB}.so ${DESTDIR}${LUADIR}/${LIB}.so</font></div></div><p></p></pre></div><div>安装</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >make</font></div><div><font size="2"   >make install</font></div><div><font size="2"   >make install时可能会报错, 因为找不到5.2的lua lib目录. 手工将生成的pgsql.so动态链接库拷贝到你的lua 5.2 lib目录即可</font></div><div><font size="2"   >cp pgsql.so /usr/local/lib/lua/5.2/</font></div><p></p></pre></div><div><br></div><div>使用luapgsql</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >root@db-172-16-3-33-&gt; lua</font></div><div><font size="2"   >Lua 5.2.3 &nbsp;Copyright (C) 1994-2013 Lua.org, PUC-Rio</font></div><div><font size="2"   >&gt; pgsql = require "pgsql"</font></div><div><font size="2"   >&gt; conn = pgsql.connectdb('hostaddr=127.0.0.1 port=5432 dbname=digoal user=digoal password=digoal')</font></div><div><font size="2"   >&gt; print(conn:errorMessage())</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&gt; print(conn:status())</font></div><div><font size="2"   >0</font></div><div><font size="2"   >&gt; print ( pgsql.CONNECTION_OK)</font></div><div><font size="2"   >0</font></div><div><font size="2"   >&gt; res = conn:exec('select info from userinfo limit 10')</font></div><div><font size="2"   >&gt; print(res)</font></div><div><font size="2"   >userdata: 0x1364ced8</font></div><div><font size="2"   >&gt; print(res:ntuples())</font></div><div><font size="2"   >10</font></div><div><font size="2"   >&gt; print(res:getvalue(1,1))</font></div><div><font size="2"   >60bbdab7f524c333a2d7ef38f06444c2</font></div><p></p></pre></div><div><br></div><div>使用print_tbl打印这个模块的内容.</div><div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: monospace; white-space: pre-wrap;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 28px; white-space: pre-wrap;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 136);"   >function</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > print_tbl</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >(</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >v_s</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >)</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp;</span></font></div><div style="line-height: 28px; white-space: pre-wrap;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp; </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >if</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > type</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >(</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >v_s</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >)</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >==</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(0, 136, 0);"   >"table"</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >then</span></font></div><div style="line-height: 28px; white-space: pre-wrap;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp; &nbsp; </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >print</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >(</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >v_s</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >,</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(0, 136, 0);"   >"contents:-----------------------------------------------"</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >)</span></font></div><div style="line-height: 28px; white-space: pre-wrap;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp; &nbsp; </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >for</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > k</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >,</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >v </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >in</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > pairs</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >(</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >v_s</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >)</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >do</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp;</span></font></div><div style="line-height: 28px; white-space: pre-wrap;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp; &nbsp; &nbsp; </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >if</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > type</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >(</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >v_s</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >[</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >k</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >])</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >==</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(0, 136, 0);"   >"table"</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp;</span></font></div><div style="line-height: 28px; white-space: pre-wrap;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp; &nbsp; &nbsp; </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >then</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp;</span></font></div><div style="line-height: 28px; white-space: pre-wrap;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >print</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >(</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >v_s</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >,</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >k</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >,</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >v</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >)</span></font></div><div style="line-height: 28px; white-space: pre-wrap;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp; &nbsp; &nbsp; &nbsp; print_tbl</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >(</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >v_s</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >[</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >k</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >])</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp;</span></font></div><div style="line-height: 28px; white-space: pre-wrap;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp; &nbsp; &nbsp; </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >else</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp;</span></font></div><div style="line-height: 28px; white-space: pre-wrap;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >print</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >(</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >v_s</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >,</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >k</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >,</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >v</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >)</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp;</span></font></div><div style="line-height: 28px; white-space: pre-wrap;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp; &nbsp; &nbsp; </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >end</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp;</span></font></div><div style="line-height: 28px; white-space: pre-wrap;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp; &nbsp; </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >end</span></font></div><div style="line-height: 28px; white-space: pre-wrap;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp; </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >else</span></font></div><div style="line-height: 28px; white-space: pre-wrap;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp; &nbsp; error</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >(</span><span style="line-height: 21px; color: rgb(0, 136, 0);"   >"please enter a table variable."</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >)</span></font></div><div style="line-height: 28px; white-space: pre-wrap;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp; end</span></font></div><div style="line-height: 28px; white-space: pre-wrap;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >end</span></font></div></div><div><span style="line-height: 21px; white-space: pre-wrap;"   ><font face="monospace"   size="2"   >&gt; con = require "pgsql"
&gt; pgsql = require "pgsql"</font></span></div><div><span style="line-height: 21px; white-space: pre-wrap;"   ><font face="monospace"   size="2"   >&gt; print_tbl(pgsql)
table: 0x1ec8c30        contents:-----------------------------------------------
table: 0x1ec8c30        _COPYRIGHT      Copyright (C) 2009 - 2014 by micro systems marc balmer
table: 0x1ec8c30        PQPING_NO_ATTEMPT       3
table: 0x1ec8c30        PG_DIAG_SOURCE_FILE     70
table: 0x1ec8c30        PGRES_COPY_BOTH 8
table: 0x1ec8c30        SEEK_END        2
table: 0x1ec8c30        connectStart    function: 0x7f4ad61d5610
table: 0x1ec8c30        ping    function: 0x7f4ad61d55c0
table: 0x1ec8c30        CONNECTION_AWAITING_RESPONSE    4
table: 0x1ec8c30        PG_DIAG_SOURCE_FUNCTION 82
table: 0x1ec8c30        PGRES_POLLING_FAILED    0
table: 0x1ec8c30        SEEK_CUR        1
table: 0x1ec8c30        PG_DIAG_INTERNAL_QUERY  113
table: 0x1ec8c30        PGRES_POLLING_WRITING   2
table: 0x1ec8c30        PQPING_REJECT   1
table: 0x1ec8c30        PGRES_SINGLE_TUPLE      9
table: 0x1ec8c30        encryptPassword function: 0x7f4ad61d5540
table: 0x1ec8c30        CONNECTION_STARTED      2
table: 0x1ec8c30        CONNECTION_BAD  1
table: 0x1ec8c30        INV_READ        262144
table: 0x1ec8c30        CONNECTION_AUTH_OK      5
table: 0x1ec8c30        INV_WRITE       131072
table: 0x1ec8c30        PG_DIAG_SEVERITY        83
table: 0x1ec8c30        PQERRORS_TERSE  0
table: 0x1ec8c30        PG_DIAG_CONTEXT 87
table: 0x1ec8c30        PG_DIAG_MESSAGE_PRIMARY 77
table: 0x1ec8c30        PQERRORS_VERBOSE        2
table: 0x1ec8c30        CONNECTION_MADE 3
table: 0x1ec8c30        PQERRORS_DEFAULT        1
table: 0x1ec8c30        PG_DIAG_MESSAGE_HINT    72
table: 0x1ec8c30        PGRES_EMPTY_QUERY       0
table: 0x1ec8c30        _DESCRIPTION    PostgreSQL binding for Lua
table: 0x1ec8c30        PGRES_NONFATAL_ERROR    6
table: 0x1ec8c30        PQPING_OK       0
table: 0x1ec8c30        SEEK_SET        0
table: 0x1ec8c30        PG_DIAG_SOURCE_LINE     76
table: 0x1ec8c30        PG_DIAG_INTERNAL_POSITION       112
table: 0x1ec8c30        PQTRANS_UNKNOWN 4
table: 0x1ec8c30        PG_DIAG_MESSAGE_DETAIL  68
table: 0x1ec8c30        PQTRANS_IDLE    0
table: 0x1ec8c30        _VERSION        pgsql 1.2.3
table: 0x1ec8c30        PG_DIAG_STATEMENT_POSITION      80
table: 0x1ec8c30        PGRES_POLLING_READING   1
table: 0x1ec8c30        PQTRANS_ACTIVE  1
table: 0x1ec8c30        PQTRANS_INTRANS 2
table: 0x1ec8c30        PG_DIAG_SQLSTATE        67
table: 0x1ec8c30        PGRES_BAD_RESPONSE      5
table: 0x1ec8c30        connectdb       function: 0x7f4ad61d5670
table: 0x1ec8c30        PQTRANS_INERROR 3
table: 0x1ec8c30        PQPING_NO_RESPONSE      2
table: 0x1ec8c30        PGRES_POLLING_OK        3
table: 0x1ec8c30        PGRES_COPY_IN   4
table: 0x1ec8c30        CONNECTION_OK   0
table: 0x1ec8c30        PGRES_COMMAND_OK        1
table: 0x1ec8c30        CONNECTION_SETENV       6
table: 0x1ec8c30        libVersion      function: 0x7f4ad61d55f0
table: 0x1ec8c30        CONNECTION_SSL_STARTUP  7
table: 0x1ec8c30        PGRES_COPY_OUT  3
table: 0x1ec8c30        PGRES_TUPLES_OK 2
table: 0x1ec8c30        PGRES_FATAL_ERROR       7</font></span></div><p></p></pre></div></div><div><span style="line-height: 21px; white-space: pre-wrap;"   ><font face="monospace"   size="2"   ><br></font></span></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://github.com/mbalmer/luapgsql"   >https://github.com/mbalmer/luapgsql</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://github.com/norman/lua-postgres"   >https://github.com/norman/lua-postgres</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://github.com/keplerproject/luasql"   >https://github.com/keplerproject/luasql</a></div></div>
	</div>
</div>
</body>
</html>