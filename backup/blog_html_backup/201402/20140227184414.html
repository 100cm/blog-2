<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL nagios monitor script (archive, vacuum, age, conn, rollback, standby, lock, xact, seq, index...)</h2>
	<h5 id="">2014-02-27 18:44:14&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201412763135184/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>bucardo提供的check_postgres脚本过于庞大, 我把其中一些比较常用的监控项摘取出来, 加上一些经验值做成了一个shell的nagios监控脚本, 包含了大部分的常用监控项.</div><div>1. 是否打开归档</div><div>2. 是否打开vacuum</div><div>3. 数据库年龄</div><div>4. 连接数</div><div>5. 提交和回滚的比例(问题修复后,手工清除统计信息pg_stat_reset(), 连接到对应的库执行)</div><div>6.&nbsp;standby延迟</div><div>7.&nbsp;锁等待</div><div>8.&nbsp;长事务/空闲事务</div><div>9.&nbsp;prepared事务</div><div>10.&nbsp;序列剩余量(每个库查询)</div><div>11.&nbsp;未使用的索引(每个库查询)</div><div><br></div><div>以PostgreSQL 9.3为例, 脚本如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >vi nagios.sh&nbsp;</font></div><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># exp1 : $prog arch</font></div><div><font size="2"   ># exp2 : $prog idx $dbname</font></div><div><font size="2"   ># please use database superuser</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGPORT=5432</font></div><div><font size="2"   >export PGDATA=/data01/pgdata/pg_root</font></div><div><font size="2"   >export PGHOME=/opt/pgsql</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >export PGUSER=postgres</font></div><div><font size="2"   >export PGHOST=$PGDATA</font></div><div><font size="2"   >export PGDATABASE=postgres</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># monitor parameter</font></div><div><font size="2"   ># cluster monitor</font></div><div><font size="2"   >arch="select case setting when 'on' then 'Normal ' else 'Warning 'end||name||','||setting from pg_settings where name='archive_mode';"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >autovacuum="select case setting when 'on' then 'Normal 'else 'Warning ' end||name||','||setting from pg_settings where name='autovacuum';"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >age="select case when age&gt;600000000 then 'Warning ' else 'Normal ' end||datname||' age '||age from (select datname,age(datfrozenxid) as age from pg_database) t order by age desc;"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >conn="select case when t2.setting-t1.cnt &lt; 200 then 'Warning ' else 'Normal ' end||'max '||t2.setting||' now '||t1.cnt from (select count(*) as cnt from pg_stat_activity) t1, (select setting::int8 from pg_settings where name = 'max_connections') t2;"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >rollback="select case when xact_rollback/xact_commit::numeric &lt;0.1 then 'Normal ' else 'Warning &nbsp;' end||datname||' c '||xact_commit||' r '||xact_rollback &nbsp;from pg_stat_database where xact_commit&gt;100 order by 1 desc;"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >standby="select case when abs&gt;10240000 then 'Warning ' else 'Normal ' end||'ins '||ins||' sent '||sent||' diff '||abs from (select pg_current_xlog_insert_location() as ins,sent_location as sent,abs(pg_xlog_location_diff(pg_current_xlog_insert_location(),sent_location)) as abs from pg_stat_replication) t;"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >lock="select 'Warning '||client_addr||' '||usename||' '||datname||' '||query_start||' '||now()||' '||query from pg_stat_activity where waiting and now()-query_start &gt; interval '1 min';"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >xact="select 'Warning '||client_addr||' '||usename||' '||datname||' '||xact_start||' '||now()||' '||query from pg_stat_activity where now()-xact_start &gt; interval '1 min' and query !~ '^COPY';"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pre_xact="select 'Warning '||transaction||' '||gid||' '||prepared||' '||owner||' '||database from pg_prepared_xacts where now()-prepared &gt; interval '1 min';"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># per database monitor</font></div><div><font size="2"   >seq="do language plpgsql \$\$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_seq name;&nbsp;</font></div><div><font size="2"   >&nbsp; v_max int8 := 0;&nbsp;</font></div><div><font size="2"   >&nbsp; v_last int8 := 0;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; for v_seq in&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; select quote_ident(t2.nspname) || '.' || quote_ident(t1.relname) from pg_class t1, pg_namespace t2 where t1.relnamespace=t2.oid and relkind='S'&nbsp;</font></div><div><font size="2"   >&nbsp; loop</font></div><div><font size="2"   >&nbsp; &nbsp; execute 'select max_value,last_value from '||v_seq into v_max, v_last;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; if v_max-v_last&lt;500000000 then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice 'Warning seq % last % max %', v_seq, v_last, v_max ;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; -- else</font></div><div><font size="2"   >&nbsp; &nbsp; -- &nbsp; raise notice 'Normal seq % last % max %', v_seq, v_last, v_max ;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; end loop;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >\$\$;"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >idx="select 'Warning '||schemaname||' '||relname||' '||indexrelname||' '||idx_scan from pg_stat_all_indexes where idx_scan&lt;10 and schemaname not in ('pg_catalog','pg_toast') and indexrelid not in (select conindid from pg_constraint where contype in ('p','u')) and pg_relation_size(indexrelid)&gt;65536 and not pg_is_in_recovery() order by idx_scan;"</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >eval SQL="$"$1</font></div><div><font size="2"   ># echo "$SQL"</font></div><div><font size="2"   >DB=$2</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >res=`psql -q -A -n -t $DB -c "$SQL" 2&gt;&amp;1`</font></div><div><font size="2"   >if [ $? -eq 0 ]; then</font></div><div><font size="2"   >&nbsp; (echo "$res"|grep "Critical" &gt;/dev/null) &amp;&amp; echo "$res"|grep "Critical" &amp;&amp; exit 2</font></div><div><font size="2"   >&nbsp; (echo "$res"|grep "Warning" &gt;/dev/null) &amp;&amp; echo "$res"|grep "Warning" &amp;&amp; exit 1</font></div><div><font size="2"   >&nbsp; echo "$res"; exit 0</font></div><div><font size="2"   >else</font></div><div><font size="2"   >&nbsp; echo "$res"; exit 3</font></div><div><font size="2"   >fi</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >chmod 500 nagios.sh</font></div><p></p></pre></div><div><br></div><div>使用举例 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-digoal-&gt; ./nagios.sh arch</font></div><div><font size="2"   >Normal archive_mode,on</font></div><div><font size="2"   >postgres@db-digoal-&gt; echo $?</font></div><div><font size="2"   >0</font></div><div><font size="2"   >postgres@db-digoal-&gt; ./nagios.sh autovacuum</font></div><div><font size="2"   >Normal autovacuum,on</font></div><div><font size="2"   >postgres@db-digoal-&gt; ./nagios.sh age</font></div><div><font size="2"   >Normal template1 age 212895</font></div><div><font size="2"   >Normal template0 age 212895</font></div><div><font size="2"   >Normal postgres age 212895</font></div><div><font size="2"   >Normal sky_pg_cluster age 212895</font></div><div><font size="2"   >Normal digoal age 212895</font></div><div><font size="2"   >postgres@db-digoal-&gt; ./nagios.sh conn</font></div><div><font size="2"   >Normal max 6000 now 42</font></div><div><font size="2"   >postgres@db-digoal-&gt; ./nagios.sh rollback</font></div><div><font size="2"   >Warning &nbsp;digoal c 10813 r 2849</font></div><div><font size="2"   >Normal sky_pg_cluster c 133130 r 0</font></div><div><font size="2"   >Normal postgres c 625 r 2</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@db-digoal-&gt; ./nagios.sh standby</font></div><div><font size="2"   >Normal ins 1/747657D8 sent 1/747657D8 diff 0</font></div><div><font size="2"   >postgres@db-digoal-&gt; ./nagios.sh lock</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@db-digoal-&gt; echo $?</font></div><div><font size="2"   >0</font></div><div><font size="2"   >postgres@db-digoal-&gt; ./nagios.sh xact</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@db-digoal-&gt; ./nagios.sh pre_xact</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@db-digoal-&gt; ./nagios.sh seq digoal</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@db-digoal-&gt; ./nagios.sh idx digoal</font></div><div><font size="2"   >Warning digoal tbl_access_log idx_tbl_access_log_1_ntime 0</font></div><p></p></pre></div><div>部署到数据库服务器的nagios监控agent即可.</div><div>部署时nrpe请使用postgres用户, 因为使用unix sock连接数据库.</div><div>如果使用IP地址连接的话, 则不需要postgres用户.</div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="" href="http://blog.163.com/digoal@126/blog/static/16387704020135313354383/;"   >http://blog.163.com/digoal@126/blog/static/16387704020135313354383/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="" href="http://blog.163.com/digoal@126/blog/static/16387704020135334157531/;"   >http://blog.163.com/digoal@126/blog/static/16387704020135334157531/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="" href="http://blog.163.com/digoal@126/blog/static/16387704020135562545536/;"   >http://blog.163.com/digoal@126/blog/static/16387704020135562545536/</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="" rel="nofollow" href="http://bucardo.org/check_postgres/check_postgres.pl.html;"   >http://bucardo.org/check_postgres/check_postgres.pl.html</a></div>5.&nbsp;<a target="" rel="nofollow" href="https://raw.github.com/bucardo/check_postgres/master/check_postgres.pl;"   >https://raw.github.com/bucardo/check_postgres/master/check_postgres.pl</a></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">freya - 2014-03-20 11:15:31</h5>
				<div>学习学习，很佩服德哥，<IMG src="http://b.bst.126.net/common/portrait/face/preview/face0.gif"  ></div>
			</div>
	</div>
</div>
</body>
</html>