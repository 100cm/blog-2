<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">From bad sector to “damaged file” - did it for Linux/ext3 <a greenplum case></h2>
	<h5 id="">2014-02-15 21:32:28&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020141157232418/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>最近一位兄弟的greenplum 数据节点服务器上存储某扇区报错, 帮忙看了存储和链路都正常, 所以从扇区下手找到对应的文件.</div><div>首先看看dmesg中的报错信息, 涉及两个块设备sdb, sdf, 是多路径设备.</div><div>报错中打印了报错的扇区ID&nbsp;<span style="line-height: 28px;"   >1984117351. 后面我们使用debugfs从这个扇区获得对应的inode, 再从这个inode取得对应的文件信息.</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >qla2xxx 0000:07:00.1: scsi(1:0:0:2): Mid-layer underflow detected (40000 of 40000 bytes)...returning error status.</font></div><div><font size="2"   >qla2xxx 0000:07:00.1: scsi(1:0:0:2): Mid-layer underflow detected (40000 of 40000 bytes)...returning error status.</font></div><div><font size="2"   >qla2xxx 0000:07:00.1: scsi(1:0:0:2): Mid-layer underflow detected (40000 of 40000 bytes)...returning error status.</font></div><div><font size="2"   >qla2xxx 0000:07:00.1: scsi(1:0:0:2): Mid-layer underflow detected (40000 of 40000 bytes)...returning error status.</font></div><div><font size="2"   >qla2xxx 0000:07:00.1: scsi(1:0:0:2): Mid-layer underflow detected (40000 of 40000 bytes)...returning error status.</font></div><div><font size="2"   >qla2xxx 0000:07:00.1: scsi(1:0:0:2): Mid-layer underflow detected (40000 of 40000 bytes)...returning error status.</font></div><div><font size="2"   >sd 1:0:0:2: SCSI error: return code = 0x00070000</font></div><div><font size="2"   >end_request: I/O error, dev sdf, sector 1984117351</font></div><div><font size="2"   >device-mapper: multipath: Failing path 8:80.</font></div><div><font size="2"   >sd 0:0:0:2: SCSI error: return code = 0x08000002</font></div><div><font size="2"   >sdb: Current: sense key: Medium Error</font></div><div><font size="2"   >&nbsp; &nbsp; Add. Sense: Unrecovered read error</font></div><div><span style="line-height: 28px;"   ><font size="2"   >Info fld=0x0</font></span></div><div><font size="2"   >end_request: I/O error, dev sdb, sector 1984117351</font></div><div><font size="2"   >device-mapper: multipath: Failing path 8:16.</font></div><p></p></pre></div><div>多路径信息如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># multipath -ll</font></div><div><font size="2"   >msa3vd01vol02 (3600c0ff000103d755811394c01000000) dm-1 HP,MSA2312fc</font></div><div><font size="2"   >[size=1.8T][features=1 queue_if_no_path][hwhandler=0][rw]</font></div><div><font size="2"   >\_ round-robin 0 [prio=50][enabled]</font></div><div><font size="2"   >&nbsp;\_ 0:0:0:2 sdb 8:16 &nbsp;[failed][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=10][enabled]</font></div><div><font size="2"   >&nbsp;\_ 1:0:0:2 sdf 8:80 &nbsp;[failed][ready]</font></div><p></p></pre></div><div>这个设备挂载的目录信息如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># df -h</font></div><div><div><font size="2"   >/dev/mapper/msa3vd01vol02p1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1.8T &nbsp;1.3T &nbsp;417G &nbsp;77% /database/gp_dmdir_3</font></div></div><p></p></pre></div><div>接下来使用debugfs和扇区号找到对应的文件名.</div><div>首先要知道这个块设备的块大小.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># tune2fs -l /dev/sdb1 | grep Block\ size</font></div><div><font size="2"   >Block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4096</font></div><p></p></pre></div><div>从报错的扇区号和块大小来获取对应的块ID&nbsp;<span style="line-height: 28px;"   >248014668</span><span style="line-height: 28px;"   >.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># bc -l</font></div><div><font size="2"   >1984117351*512/4096</font></div><div><font size="2"   >248014668.87500000000000000000</font></div><p></p></pre></div><div>使用open, testb, icheck, ncheck得到文件名.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># debugfs</font></div><div><font size="2"   >debugfs 1.39 (29-May-2006)</font></div><div><font size="2"   >debugfs: &nbsp;open /dev/sdb1</font></div><div><font size="2"   >debugfs: &nbsp;testb 248014668</font></div><div><font size="2"   >Block 248014668 marked in use</font></div><div><font size="2"   >debugfs: &nbsp;icheck 248014668</font></div><div><div><font size="2"   >Block &nbsp; Inode number</font></div><div><font size="2"   >248014668 &nbsp; &nbsp; &nbsp; 103629311</font></div><div><font size="2"   >debugfs: &nbsp;ncheck 103629311</font></div><div><font size="2"   >Inode &nbsp; Pathname</font></div><div><font size="2"   >103629311 &nbsp; &nbsp; &nbsp; /gp13/base/297158/624669617.1</font></div></div><p></p></pre></div></div><div>首先进入到这个块设备挂载的目录, 因为从debugfs取得的是相对路径.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># cd&nbsp;<span style="line-height: 28px;"   >/database/gp_dmdir_3</span></font></div><div><div><font size="2"   ># echo 3 &gt; /proc/sys/vm/drop_caches</font></div></div><p></p></pre></div><div><div>清除缓存后, 遍历这个文件, 再次重现这个问题.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   ># cp gp13/base/297158/624669617.1 ~/</font></div></div><div><font size="2"   ># dmesg</font></div><div><div><font size="2"   >qla2xxx 0000:07:00.1: scsi(1:0:0:2): Mid-layer underflow detected (40000 of 40000 bytes)...returning error status.</font></div><div><font size="2"   >qla2xxx 0000:07:00.1: scsi(1:0:0:2): Mid-layer underflow detected (40000 of 40000 bytes)...returning error status.</font></div><div><font size="2"   >qla2xxx 0000:07:00.1: scsi(1:0:0:2): Mid-layer underflow detected (40000 of 40000 bytes)...returning error status.</font></div><div><font size="2"   >qla2xxx 0000:07:00.1: scsi(1:0:0:2): Mid-layer underflow detected (40000 of 40000 bytes)...returning error status.</font></div><div><font size="2"   >qla2xxx 0000:07:00.1: scsi(1:0:0:2): Mid-layer underflow detected (40000 of 40000 bytes)...returning error status.</font></div><div><font size="2"   >qla2xxx 0000:07:00.1: scsi(1:0:0:2): Mid-layer underflow detected (40000 of 40000 bytes)...returning error status.</font></div><div><font size="2"   >sd 1:0:0:2: SCSI error: return code = 0x00070000</font></div><div><font size="2"   >end_request: I/O error, dev sdf, sector 1984117319</font></div><div><font size="2"   >device-mapper: multipath: Failing path 8:80.</font></div><div><font size="2"   >sd 0:0:0:2: SCSI error: return code = 0x08000002</font></div><div><font size="2"   >sdb: Current: sense key: Medium Error</font></div><div><font size="2"   >&nbsp; &nbsp; Add. Sense: Unrecovered read error</font></div><div><font size="2"   >Info fld=0x0</font></div><div><font size="2"   >end_request: I/O error, dev sdb, sector 1984117319</font></div><div><font size="2"   >device-mapper: multipath: Failing path 8:16.</font></div></div><p></p></pre></div></div><div>问题重现.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># multipath -ll</font></div><div><div><font size="2"   >msa3vd01vol02 (3600c0ff000103d755811394c01000000) dm-1 HP,MSA2312fc</font></div><div><font size="2"   >[size=1.8T][features=1 queue_if_no_path][hwhandler=0][rw]</font></div><div><font size="2"   >\_ round-robin 0 [prio=50][enabled]</font></div><div><font size="2"   >&nbsp;\_ 0:0:0:2 sdb 8:16 &nbsp;[failed][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=10][enabled]</font></div><div><font size="2"   >&nbsp;\_ 1:0:0:2 sdf 8:80 &nbsp;[failed][ready]</font></div></div><p></p></pre></div><div>现在要解决这个问题, 首先要把这个文件重命名掉, 那么greenplum的这个节点不会扫描到这个文件. 也就不会触发重现这个问题.</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   ># mv gp13/base/297158/624669617.1 gp13/base/297158/624669617.1.badsec</font></span></div><div></div><p></p></pre></div><div><span style="line-height: 28px;"   >根据这个文件查到数据哪个数据库对象, 需要用到pg_class.</span><span style="line-height: 28px;"   >relfilenode</span><span style="line-height: 28px;"   >.</span></div><div><span style="line-height: 28px;"   >PostgreSQL 的文件节点存储在pg_class中, 所以通过查询这个系统表就可以找到对应的数据对象.</span></div><div><span style="line-height: 28px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># select * from pg_class where relfilenode=624669617;</font></div><div><font size="2"   >-[ RECORD 1 ]--+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >relname &nbsp; &nbsp; &nbsp; &nbsp;| tbl_1_prt_p20130821</font></div><div><font size="2"   >relnamespace &nbsp; | 297163</font></div><div><font size="2"   >reltype &nbsp; &nbsp; &nbsp; &nbsp;| 624669618</font></div><div><font size="2"   >relowner &nbsp; &nbsp; &nbsp; | 16389</font></div><div><font size="2"   >relam &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"   >relfilenode &nbsp; &nbsp;| 624669617</font></div><div><font size="2"   >reltablespace &nbsp;| 0</font></div><div><font size="2"   >relpages &nbsp; &nbsp; &nbsp; | 0</font></div><div><font size="2"   >reltuples &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"   >reltoastrelid &nbsp;| 624669619</font></div><div><font size="2"   >reltoastidxid &nbsp;| 0</font></div><div><font size="2"   >relaosegrelid &nbsp;| 624669621</font></div><div><font size="2"   >relaosegidxid &nbsp;| 0</font></div><div><font size="2"   >relhasindex &nbsp; &nbsp;| f</font></div><div><font size="2"   >relisshared &nbsp; &nbsp;| f</font></div><div><font size="2"   >relkind &nbsp; &nbsp; &nbsp; &nbsp;| r</font></div><div><font size="2"   >relstorage &nbsp; &nbsp; | a</font></div><div><font size="2"   >relnatts &nbsp; &nbsp; &nbsp; | 21</font></div><div><font size="2"   >relchecks &nbsp; &nbsp; &nbsp;| 1</font></div><div><font size="2"   >reltriggers &nbsp; &nbsp;| 0</font></div><div><font size="2"   >relukeys &nbsp; &nbsp; &nbsp; | 0</font></div><div><font size="2"   >relfkeys &nbsp; &nbsp; &nbsp; | 0</font></div><div><font size="2"   >relrefs &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"   >relhasoids &nbsp; &nbsp; | f</font></div><div><font size="2"   >relhaspkey &nbsp; &nbsp; | f</font></div><div><font size="2"   >relhasrules &nbsp; &nbsp;| f</font></div><div><font size="2"   >relhassubclass | f</font></div><div><font size="2"   >relfrozenxid &nbsp; | 53139347</font></div><div><font size="2"   >relacl &nbsp; &nbsp; &nbsp; &nbsp; | {digoal=arwdxt/digoal}</font></div><div><font size="2"   >reloptions &nbsp; &nbsp; | {appendonly=true,compresslevel=3}</font></div><p></p></pre></div><div><br></div></span></div><div><span style="line-height: 28px;"   >greenplum中每个子节点的dbid和relfilenode应该都是一样的, 所以在其他节点应该也可以找到这个文件. 如下 :&nbsp;</span></div><div><span style="line-height: 28px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># df -h</font></div><div><font size="2"   >Filesystem &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Size &nbsp;Used Avail Use% Mounted on</font></div><div><font size="2"   >/dev/cciss/c0d0p1 &nbsp; &nbsp; &nbsp;25G &nbsp;3.7G &nbsp; 20G &nbsp;16% /</font></div><div><font size="2"   >/dev/cciss/c0d0p3 &nbsp; &nbsp; &nbsp;99G &nbsp; 81G &nbsp; 13G &nbsp;87% /opt</font></div><div><font size="2"   >tmpfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;12G &nbsp; &nbsp; 0 &nbsp; 12G &nbsp; 0% /dev/shm</font></div><div><font size="2"   >/dev/cciss/c0d1p1 &nbsp; &nbsp; 135G &nbsp;109G &nbsp; 20G &nbsp;86% /database/gp_subdir_0</font></div><div><font size="2"   >/dev/cciss/c0d2p1 &nbsp; &nbsp; 135G &nbsp;109G &nbsp; 20G &nbsp;85% /database/gp_subdir_1</font></div><div><font size="2"   >/dev/mapper/msa2vd03vol01p1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1.8T &nbsp;1.3T &nbsp;421G &nbsp;76% /database/gp_dmdir_0</font></div><div><font size="2"   >/dev/mapper/msa2vd03vol02p1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1.8T &nbsp;1.3T &nbsp;423G &nbsp;76% /database/gp_dmdir_1</font></div><div><font size="2"   >/dev/mapper/msa2vd04vol01p1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1.8T &nbsp;1.3T &nbsp;427G &nbsp;76% /database/gp_dmdir_2</font></div><div><font size="2"   >/dev/mapper/msa2vd04vol02p1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1.8T &nbsp;1.3T &nbsp;414G &nbsp;77% /database/gp_dmdir_3</font></div><div><font size="2"   ># cd /database/gp_dmdir_3</font></div><div><span style="line-height: 28px;"   ><font size="2"   ># ll</font></span></div><div><font size="2"   >total 1001012</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root &nbsp; &nbsp; &nbsp;root &nbsp; &nbsp; &nbsp;1024000000 Aug 10 &nbsp;2010 1Gb.file</font></div><div><font size="2"   >drwx------ 14 greenplum greenplum &nbsp; &nbsp; &nbsp; 4096 Feb 15 20:34 gp3</font></div><div><font size="2"   >drwx------ &nbsp;2 greenplum greenplum &nbsp; &nbsp; &nbsp;16384 Jul 21 &nbsp;2010 lost+found</font></div><div><font size="2"   ># ll gp3/base/297158/624669617</font></div><div><font size="2"   >-rw------- 1 greenplum greenplum 0 Nov 18 &nbsp;2012 gp3/base/297158/624669617</font></div><div><font size="2"   ># ll gp3/base/297158/624669617*</font></div><div><font size="2"   >-rw------- 1 greenplum greenplum &nbsp; &nbsp; &nbsp; &nbsp; 0 Nov 18 &nbsp;2012 gp3/base/297158/624669617</font></div><div><font size="2"   >-rw------- 1 greenplum greenplum 456241576 Aug 22 01:56 gp3/base/297158/624669617.1</font></div><p></p></pre></div><div><br></div></span><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >后期处理,&nbsp;</span>因为我们处理扇区的问题把一个节点的624669617.1文件重命名, 所以在全表扫描时, 这部分数据将缺失, 如果使用索引扫描并且扫描到这部分缺失的数据将报错, 后期建议将&nbsp;<span style="line-height: 28px;"   >tbl_1_prt_p20130821这个表的数据删除, 从历史数据重新抽取.</span></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >坏块处理, 使用dd往坏块填充zero. 详见</span></div><div><a target="_blank" rel="nofollow" href="http://smartmontools.sourceforge.net/badblockhowto.html"   >http://smartmontools.sourceforge.net/badblockhowto.html</a></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><div>[root]# dd if=/dev/zero of=/dev/sdb1 bs=4096 count=1 seek=248014668</div><div>[root]# sync</div><div><br></div><div>扫描块设备的坏块: badblocks.</div></span></div><div style="line-height: 28px;"   ><br></div></div><div>参考smartctl工具手册中使用debugfs取文件名的文章</div><div><a target="_blank" rel="nofollow" href="http://smartmontools.sourceforge.net/badblockhowto.html"   >http://smartmontools.sourceforge.net/badblockhowto.html</a></div><div><pre class="prettyprint"   ><p></p><div><p style="margin-bottom: 1em; border: 0px; vertical-align: baseline; clear: both; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; line-height: 17.804800033569336px;"   ><font size="2"   >When a SMART check on a disk reports a bad sector, it is important to be able to identify the file that has the bad sector - and restore it from backups. Below, I show how I did this for my Linux/ext3 VMWARE server - but does anyone know if this can be done for Windows/NTFS?</font></p><p style="margin-bottom: 1em; border: 0px; vertical-align: baseline; clear: both; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; line-height: 17.804800033569336px;"   ><font size="2"   >Here's how I did it for Linux/ext3: I first asked the drive to do a hardware surface scan (below the OS level, with the on-drive SMART circuits):</font></p><pre style="margin-top: 0px; margin-bottom: 10px; padding: 5px; border: 0px; vertical-align: baseline; background-color: rgb(238, 238, 238); font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif; overflow: auto; width: auto; max-height: 600px; word-wrap: normal; line-height: 17.804800033569336px;"   ><code style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;"   ><font size="2"   >vserver:~# smartctl -t long /dev/sdc
</font></code></pre><p style="margin-bottom: 1em; border: 0px; vertical-align: baseline; clear: both; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; line-height: 17.804800033569336px;"   ><font size="2"   >I looked at the results:</font></p><pre style="margin-top: 0px; margin-bottom: 10px; padding: 5px; border: 0px; vertical-align: baseline; background-color: rgb(238, 238, 238); font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif; overflow: auto; width: auto; max-height: 600px; word-wrap: normal; line-height: 17.804800033569336px;"   ><code style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;"   ><font size="2"   >vserver:~# smartctl -a /dev/sdc
...
196 Reallocated_Event_Count 0x0032   100   100   000    Old_age   Always       -       1
197 Current_Pending_Sector  0x0012   100   100   000    Old_age   Always       -       9
...
Num  Test_Description    Status                  Remaining  LifeTime(hours)  LBA_of_first_error
# 1  Extended offline    Completed: read failure       90%     27679         591363172
</font></code></pre><p style="margin-bottom: 1em; border: 0px; vertical-align: baseline; clear: both; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; line-height: 17.804800033569336px;"   ><font size="2"   >So, one sector was already marked bad, 9 were marked for replacing from the "staging" sector space. More importantly, the first logical block address (LBA) that is unreadable, was 591363172.</font></p><p style="margin-bottom: 1em; border: 0px; vertical-align: baseline; clear: both; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; line-height: 17.804800033569336px;"   ><font size="2"   >I found the partition (and the offset inside it) that this number "translated" to:</font></p><pre style="margin-top: 0px; margin-bottom: 10px; padding: 5px; border: 0px; vertical-align: baseline; background-color: rgb(238, 238, 238); font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif; overflow: auto; width: auto; max-height: 600px; word-wrap: normal; line-height: 17.804800033569336px;"   ><code style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;"   ><font size="2"   >vserver:~# fdisk -lu /dev/sdc
Device Boot      Start         End      Blocks   Id  System
/dev/sdc1           32   976773119   488386544   83  Linux
</font></code></pre><p style="margin-bottom: 1em; border: 0px; vertical-align: baseline; clear: both; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; line-height: 17.804800033569336px;"   ><font size="2"   >The partition started at sector 32. So, the bad sector was...</font></p><pre style="margin-top: 0px; margin-bottom: 10px; padding: 5px; border: 0px; vertical-align: baseline; background-color: rgb(238, 238, 238); font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif; overflow: auto; width: auto; max-height: 600px; word-wrap: normal; line-height: 17.804800033569336px;"   ><code style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;"   ><font size="2"   >vserver:~# bc -l
591363172-32+1
591363141
</font></code></pre><p style="margin-bottom: 1em; border: 0px; vertical-align: baseline; clear: both; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; line-height: 17.804800033569336px;"   ><font size="2"   >...at an offset of 591363141 sectors from the beginning of the partition.</font></p><p style="margin-bottom: 1em; border: 0px; vertical-align: baseline; clear: both; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; line-height: 17.804800033569336px;"   ><font size="2"   >Now I could find which file was "hosed":</font></p><pre style="margin-top: 0px; margin-bottom: 10px; padding: 5px; border: 0px; vertical-align: baseline; background-color: rgb(238, 238, 238); font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif; overflow: auto; width: auto; max-height: 600px; word-wrap: normal; line-height: 17.804800033569336px;"   ><code style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;"   ><font size="2"   >vserver:~# tune2fs -l /dev/sdc1 | grep Block\ size
Block size:               4096
</font></code></pre><p style="margin-bottom: 1em; border: 0px; vertical-align: baseline; clear: both; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; line-height: 17.804800033569336px;"   ><font size="2"   >The block size of this EXT3 filesystem was 4096 bytes, so the bad sector destroyed this block in the filesystem:</font></p><pre style="margin-top: 0px; margin-bottom: 10px; padding: 5px; border: 0px; vertical-align: baseline; background-color: rgb(238, 238, 238); font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif; overflow: auto; width: auto; max-height: 600px; word-wrap: normal; line-height: 17.804800033569336px;"   ><code style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;"   ><font size="2"   >vserver:~# bc -l
591363141*512/4096
73920392.62500000000000000000
</font></code></pre><p style="margin-bottom: 1em; border: 0px; vertical-align: baseline; clear: both; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; line-height: 17.804800033569336px;"   ><font size="2"   >And the block number (73920392) corresponded into this file:</font></p><pre style="margin-top: 0px; margin-bottom: 10px; padding: 5px; border: 0px; vertical-align: baseline; background-color: rgb(238, 238, 238); font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif; overflow: auto; width: auto; max-height: 600px; word-wrap: normal; line-height: 17.804800033569336px;"   ><code style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;"   ><font size="2"   >vserver:~# debugfs
debugfs 1.41.3 (12-Oct-2008)
debugfs:  open /dev/sdc1
testb 73920392
debugfs:  testb 73920392
Block 73920392 marked in use
debugfs:  icheck 73920392
Block           Inode number
73920392        18472967
debugfs:  ncheck 18472967
Inode           Pathname
18472967        /path/to/filewithbadsector
</font></code></pre><p style="margin-bottom: 1em; border: 0px; vertical-align: baseline; clear: both; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; line-height: 17.804800033569336px;"   ><font size="2"   >And I restored that file from my backups.</font></p><p style="margin-bottom: 1em; border: 0px; vertical-align: baseline; clear: both; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; line-height: 17.804800033569336px;"   ><font size="2"   >Is there an equivalent procedure I can follow for Windows/NTFS?</font></p></div><div><p style="margin-bottom: 1em; border: 0px; vertical-align: baseline; clear: both; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; line-height: 17.804800033569336px;"   ><font size="2"   >I know you have an NTFS FS, and run windows on that FS. I don't know if you "could" boot a live Linux to work on that driver or not.</font></p><p style="margin-bottom: 1em; border: 0px; vertical-align: baseline; clear: both; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; line-height: 17.804800033569336px;"   ><font size="2"   >If you can boot Linux from CD or USB, you can use ntfsprogs. look at -</font></p><pre style="margin-top: 0px; margin-bottom: 10px; padding: 5px; border: 0px; vertical-align: baseline; background-color: rgb(238, 238, 238); font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif; overflow: auto; width: auto; max-height: 600px; word-wrap: normal; line-height: 17.804800033569336px;"   ><code style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;"   ><font size="2"   >ntfscluster 

ntfsinfo 
</font></code></pre><p style="margin-bottom: 1em; border: 0px; vertical-align: baseline; clear: both; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; line-height: 17.804800033569336px;"   ><font size="2"   >I believe ntfscluster tell you what file a particular cluster stores. I hope this puts you in the right direction.</font></p></div><p></p></pre></div><div><br></div>[参考]<div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://smartmontools.sourceforge.net/badblockhowto.html"   >http://smartmontools.sourceforge.net/badblockhowto.html</a><br><wbr><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://serverfault.com/questions/311270/from-bad-sector-to-damaged-file-did-it-for-linux-ext3-can-i-do-it-for-windo"   >http://serverfault.com/questions/311270/from-bad-sector-to-damaged-file-did-it-for-linux-ext3-can-i-do-it-for-windo</a></div><div>3. man debugfs</div>4. man badblocks</div></div>
	</div>
</div>
</body>
</html>