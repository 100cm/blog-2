<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 keep pg_stat_statements' query texts in a file, not in shared memory</h2>
	<h5 id="">2014-02-03 13:24:34&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014130252595/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.4 提交的一个补丁, 将pg_stat_statements插件的query text保存到文件中, 而不是共享内存.</div><div>所以理论上可以存储更多的SQL统计信息, 因为SQL文本已经不需要存储在内存中了.</div><div>存储SQL的文件如下:</div><div><pre class="prettyprint"   ><p><font size="2"   >pg_stat_tmp/pgss_query_texts.stat</font></p><div></div><p></p></pre><span style="line-height: 28px;"   >同时新增了文件访问接口, 原来存储在内存中的query则替换为query的hash值: queryid.</span></div><div>补丁说明 :&nbsp;<br><wbr><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Keep pg_stat_statements' query texts in a file, not in shared memory.</font></div><div><font size="2"   >author<span>	</span>Tom Lane &lt;tgl@sss.pgh.pa.us&gt;<span>	</span></font></div><div><font size="2"   ><span>	</span>Mon, 27 Jan 2014 20:37:54 +0000 (15:37 -0500)</font></div><div><font size="2"   >committer<span>	</span>Tom Lane &lt;tgl@sss.pgh.pa.us&gt;<span>	</span></font></div><div><font size="2"   ><span>	</span>Mon, 27 Jan 2014 20:37:54 +0000 (15:37 -0500)</font></div><div><font size="2"   >commit<span>	</span>f0d6f20278b7c5c412ce40a9b86c6b31dc2fbfdd</font></div><div><font size="2"   >tree<span>	</span>88d045ea6425c0e2bf72a04775e8fab271fd8d74<span>	</span>tree | snapshot</font></div><div><font size="2"   >parent<span>	</span>ea9df812d8502fff74e7bc37d61bdc7d66d77a7f<span>	</span>commit | diff</font></div><div><font size="2"   >Keep pg_stat_statements' query texts in a file, not in shared memory.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This change allows us to eliminate the previous limit on stored query</font></div><div><font size="2"   >length, and it makes the shared-memory hash table very much smaller,</font></div><div><font size="2"   >allowing more statements to be tracked. &nbsp;(The default value of</font></div><div><font size="2"   >pg_stat_statements.max is therefore increased from 1000 to 5000.)</font></div><div><font size="2"   >In typical scenarios, the hash table can be large enough to hold all the</font></div><div><font size="2"   >statements commonly issued by an application, so that there is little</font></div><div><font size="2"   >"churn" in the set of tracked statements, and thus little need to do I/O</font></div><div><font size="2"   >to the file.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >To further reduce the need for I/O to the query-texts file, add a way</font></div><div><font size="2"   >to retrieve all the columns of the pg_stat_statements view except for</font></div><div><font size="2"   >the query text column. &nbsp;This is probably not of much interest for human</font></div><div><font size="2"   >use but it could be exploited by programs, which will prefer using the</font></div><div><font size="2"   >queryid anyway.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Ordinarily, we'd need to bump the extension version number for the latter</font></div><div><font size="2"   >change. &nbsp;But since we already advanced pg_stat_statements' version number</font></div><div><font size="2"   >from 1.1 to 1.2 in the 9.4 development cycle, it seems all right to just</font></div><div><font size="2"   >redefine what 1.2 means.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Peter Geoghegan, reviewed by Pavel Stehule</font></div><p></p></pre></div><div>注意, 对同一个SQL, 如果search_path不同, 其实可能是两个SQL.</div><div>例如 :&nbsp;</div><div>有两个表, 表名一致都叫tbl, 但是放在两个schema下面.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >1. search_path = public.</font></div><div><font size="2"   >select * from tbl; &nbsp;-&gt; select * from public.tbl;</font></div><div><font size="2"   >2. search_path = $user, public</font></div><div><font size="2"   >\c digoal digoal</font></div><div><font size="2"   >select * from tbl; &nbsp;-&gt; select * from digoal.tbl;</font></div><p></p></pre></div><div>因此这两个sql的hash值queryid实际上是不一样的.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# create schema postgres;</font></div><div><font size="2"   >CREATE SCHEMA</font></div><div><font size="2"   >postgres=# create table public.tbl(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# create table postgres.tbl(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# show search_path;</font></div><div><font size="2"   >-[ RECORD 1 ]---------------</font></div><div><font size="2"   >search_path | "$user",public</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select * from tbl;</font></div><div><font size="2"   >(No rows)</font></div><div><font size="2"   >postgres=# set search_path=public;</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >postgres=# select * from tbl;</font></div><div><font size="2"   >(No rows)</font></div></div><div><font size="2"   >在pg_stat_statements中将得到两条统计信息 &nbsp;:&nbsp;</font></div><div><div><font size="2"   >postgres=# select * from pg_stat_statements where query ~ 'tbl';</font></div><div><font size="2"   >&nbsp;userid | dbid &nbsp;| &nbsp;queryid &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| calls | total_time | rows | shared_blks_hit | shared_blks_read |</font></div><div><font size="2"   >&nbsp;shared_blks_dirtied | shared_blks_written | local_blks_hit | local_blks_read | local_blks_dirtied | local_blks_written | temp_blks_</font></div><div><font size="2"   >read | temp_blks_written | blk_read_time | blk_write_time&nbsp;</font></div><div><font size="2"   >--------+-------+------------+------------------------------------+-------+------------+------+-----------------+------------------+</font></div><div><font size="2"   >---------------------+---------------------+----------------+-----------------+--------------------+--------------------+-----------</font></div><div><font size="2"   >-----+-------------------+---------------+----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;10 | 12855 | 1696001068 | select * from tbl; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp;0.006 | &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;10 | 12855 | &nbsp;165422858 | create table postgres.tbl(id int); | &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp;0.662 | &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 115 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;10 | 12855 | 2799837472 | create table public.tbl(id int); &nbsp; | &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; 0.74 | &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 114 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;10 | 12855 | 2760056465 | select * from tbl; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp;0.011 | &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select * from tbl;</font></div><div><font size="2"   >&nbsp;id&nbsp;</font></div><div><font size="2"   >----</font></div><div><font size="2"   >(0 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select * from pg_stat_statements where query ~ 'tbl';</font></div><div><font size="2"   >&nbsp;userid | dbid &nbsp;| &nbsp;queryid &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| calls | total_time | rows | shared_blks_hit | shared_blks_read |</font></div><div><font size="2"   >&nbsp;shared_blks_dirtied | shared_blks_written | local_blks_hit | local_blks_read | local_blks_dirtied | local_blks_written | temp_blks_</font></div><div><font size="2"   >read | temp_blks_written | blk_read_time | blk_write_time&nbsp;</font></div><div><font size="2"   >--------+-------+------------+------------------------------------+-------+------------+------+-----------------+------------------+</font></div><div><font size="2"   >---------------------+---------------------+----------------+-----------------+--------------------+--------------------+-----------</font></div><div><font size="2"   >-----+-------------------+---------------+----------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;10 | 12855 | 1696001068 | select * from tbl; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp;0.014 | &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;10 | 12855 | &nbsp;165422858 | create table postgres.tbl(id int); | &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp;0.662 | &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 115 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;10 | 12855 | 2799837472 | create table public.tbl(id int); &nbsp; | &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; 0.74 | &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 114 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;10 | 12855 | 2760056465 | select * from tbl; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp;0.011 | &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 |</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >(4 rows)</font></div></div><p></p></pre></div><div>说明 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >Since the queryid hash value is computed on the post-parse-analysis representation of the queries, the opposite is also possible: queries with identical texts might appear as separate entries, if they have different meanings as a result of factors such as different search_path settings.</font></p></pre></div><div><br></div><div>查看文件内容 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-150-&gt; cd $PGDATA</font></div><div><font size="2"   >pg94@db-172-16-3-150-&gt; cd pg_stat_tmp</font></div><div><div><font size="2"   >pg94@db-172-16-3-150-&gt; cat pgss_query_texts.stat&nbsp;</font></div><div><font size="2"   >/* contrib/pg_stat_statements/pg_stat_statements--1.2.sql */</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- complain if script is sourced in psql, rather than via CREATE EXTENSION</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Register functions.</font></div><div><font size="2"   >CREATE FUNCTION pg_stat_statements_reset()</font></div><div><font size="2"   >RETURNS void</font></div><div><font size="2"   >AS '$libdir/pg_stat_statements'</font></div><div><font size="2"   >LANGUAGE C;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION pg_stat_statements(IN showtext boolean,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT userid oid,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT dbid oid,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT queryid bigint,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT query text,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT calls int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT total_time float8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT rows int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT shared_blks_hit int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT shared_blks_read int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT shared_blks_dirtied int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT shared_blks_written int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT local_blks_hit int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT local_blks_read int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT local_blks_dirtied int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT local_blks_written int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT temp_blks_read int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT temp_blks_written int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT blk_read_time float8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT blk_write_time float8</font></div><div><font size="2"   >)</font></div><div><font size="2"   >RETURNS SETOF record</font></div><div><font size="2"   >AS '$libdir/pg_stat_statements', 'pg_stat_statements_1_2'</font></div><div><font size="2"   >LANGUAGE C STRICT VOLATILE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Register a view on the function for ease of use.</font></div><div><font size="2"   >CREATE VIEW pg_stat_statements AS</font></div><div><font size="2"   >&nbsp; SELECT * FROM pg_stat_statements(true);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >GRANT SELECT ON pg_stat_statements TO PUBLIC;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Don't want this to be available to non-superusers.</font></div><div><font size="2"   >REVOKE ALL ON FUNCTION pg_stat_statements_reset() FROM PUBLIC;</font></div><div><font size="2"   >/* contrib/pg_stat_statements/pg_stat_statements--1.2.sql */</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- complain if script is sourced in psql, rather than via CREATE EXTENSION</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Register functions.</font></div><div><font size="2"   >CREATE FUNCTION pg_stat_statements_reset()</font></div><div><font size="2"   >RETURNS void</font></div><div><font size="2"   >AS '$libdir/pg_stat_statements'</font></div><div><font size="2"   >LANGUAGE C;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE FUNCTION pg_stat_statements(IN showtext boolean,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT userid oid,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT dbid oid,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT queryid bigint,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT query text,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT calls int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT total_time float8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT rows int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT shared_blks_hit int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT shared_blks_read int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT shared_blks_dirtied int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT shared_blks_written int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT local_blks_hit int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT local_blks_read int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT local_blks_dirtied int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT local_blks_written int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT temp_blks_read int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT temp_blks_written int8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT blk_read_time float8,</font></div><div><font size="2"   >&nbsp; &nbsp; OUT blk_write_time float8</font></div><div><font size="2"   >)</font></div><div><font size="2"   >RETURNS SETOF record</font></div><div><font size="2"   >AS '$libdir/pg_stat_statements', 'pg_stat_statements_1_2'</font></div><div><font size="2"   >LANGUAGE C STRICT VOLATILE;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Register a view on the function for ease of use.</font></div><div><font size="2"   >CREATE VIEW pg_stat_statements AS</font></div><div><font size="2"   >&nbsp; SELECT * FROM pg_stat_statements(?);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >GRANT SELECT ON pg_stat_statements TO PUBLIC;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- Don't want this to be available to non-superusers.</font></div><div><font size="2"   >REVOKE ALL ON FUNCTION pg_stat_statements_reset() FROM PUBLIC;</font></div><div><font size="2"   >create extension pg_stat_statements;select * from pg_stat_statements;create schema postgres;create table public.tbl(id int);create table postgres.tbl(id int);show search_path;select * from tbl;set search_path=public;select * from tbl;select * from pg_stat_statements where query ~ ?;</font></div></div><p></p></pre></div><div><br></div><div>[注意]</div><div>1. contrib/pg_stat_statements/pg_stat_statements.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;* To facilitate presenting entries to users, we create "representative" query</font></div><div><font size="2"   >&nbsp;* strings in which constants are replaced with '?' characters, to make it</font></div><div><font size="2"   >&nbsp;* clearer what a normalized entry can represent. &nbsp;To save on shared memory,</font></div><div><font size="2"   >&nbsp;* and to avoid having to truncate oversized query strings, we store these</font></div><div><font size="2"   >&nbsp;* strings in a temporary external query-texts file. &nbsp;Offsets into this</font></div><div><font size="2"   >&nbsp;* file are kept in shared memory.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Note about locking issues: to create or delete an entry in the shared</font></div><div><font size="2"   >&nbsp;* hashtable, one must hold pgss-&gt;lock exclusively. &nbsp;Modifying any field</font></div><div><font size="2"   >&nbsp;* in an entry except the counters requires the same. &nbsp;To look up an entry,</font></div><div><font size="2"   >&nbsp;* one must hold the lock shared. &nbsp;To read or update the counters within</font></div><div><font size="2"   >&nbsp;* an entry, one must hold the lock shared or exclusive (so the entry doesn't</font></div><div><font size="2"   >&nbsp;* disappear!) and also take the entry's mutex spinlock.</font></div><div><font size="2"   >&nbsp;* The shared state variable pgss-&gt;extent (the next free spot in the external</font></div><div><font size="2"   >&nbsp;* query-text file) should be accessed only while holding either the</font></div><div><font size="2"   >&nbsp;* pgss-&gt;mutex spinlock, or exclusive lock on pgss-&gt;lock. &nbsp;We use the mutex to</font></div><div><font size="2"   >&nbsp;* allow reserving file space while holding only shared lock on pgss-&gt;lock.</font></div><div><font size="2"   >&nbsp;* Rewriting the entire external query-text file, eg for garbage collection,</font></div><div><font size="2"   >&nbsp;* requires holding pgss-&gt;lock exclusively; this allows individual entries</font></div><div><font size="2"   >&nbsp;* in the file to be read or written while holding only shared lock.</font></div><p></p></pre></div><div>因为现在hashtable里只记录query的offset, query string则记录在文件中, 并且现在query没有截断, 所以query string file可能膨胀.</div><div>例如, 我们只跟踪100个QUERY, 但是实际可能有几万个QUERY, 对于不在hash table的query, 这些query需要从query file中垃圾回收掉, 回收垃圾需要<span style="line-height: 28px;"   >pgss-&gt;lock exclusively, 同时hash table中的信息变更(除计数器变更)也需要</span><span style="line-height: 28px;"   >pgss-&gt;lock exclusively, 所以垃圾回收和跟踪是有锁冲突的, 那么就有可能造成有垃圾却无法回收的情况.</span></div><div>如果是锁冲突造成的, 我们可以尽量的加大max参数, 来减少这种锁冲突, 这样不会因为锁冲突导致垃圾无法回收.</div><div><br></div><div>希望未来可以改进此处,&nbsp;</div><div><br></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=f0d6f20278b7c5c412ce40a9b86c6b31dc2fbfdd"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=f0d6f20278b7c5c412ce40a9b86c6b31dc2fbfdd</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/pgstatstatements.html"   >http://www.postgresql.org/docs/devel/static/pgstatstatements.html</a></div><div><br></div></div></div>
	</div>
</div>
</body>
</html>