<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Lua iterator and generic for</h2>
	<h5 id="">2014-02-18 11:13:47&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014118103640253/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">lua有两种循环的用法<wbr><div>1. &nbsp;数字递增用法</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&gt; for i=1,10,3 do</font></div><div><font size="2"   >&gt;&gt; print(i)</font></div><div><font size="2"   >&gt;&gt; end</font></div><div><font size="2"   >1</font></div><div><font size="2"   >4</font></div><div><font size="2"   >7</font></div><div><font size="2"   >10</font></div><p></p></pre></div><div><br></div><div>2. generic for用法</div><div>不写步长step则默认是1.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&gt; t = {"hello","nihao",nil,"yes"}</font></div><div><font size="2"   >&gt; for k,v in ipairs(t) do</font></div><div><font size="2"   >&gt;&gt; &nbsp; print("k:" .. k .. " v:" .. v)&nbsp;</font></div><div><font size="2"   >&gt;&gt; end</font></div><div><font size="2"   >k:1 v:hello</font></div><div><font size="2"   >k:2 v:nihao</font></div><p></p></pre></div><div>使用table.pack将...变量参数打包成sequence表以及n存储sequences个数.</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >&gt; c = table.pack("he","hello",nil,"a ")</font></span></div><div><div><font size="2"   >&gt; for i=1, c.n do</font></div><div><font size="2"   >print(c[i])</font></div><div><font size="2"   >end</font></div><div><font size="2"   >he</font></div><div><font size="2"   >hello</font></div><div><font size="2"   >nil</font></div><div><font size="2"   >a</font></div></div><p></p></pre></div><div>其他常用的generic for函数</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >Despite its apparent simplicity, the generic for is powerful. With proper</font></div><div style="line-height: 28px;"   ><font size="2"   >iterators, we can traverse almost anything in a readable fashion. The standard</font></div><div style="line-height: 28px;"   ><font size="2"   >libraries provide several iterators, which allow us to iterate over&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >the lines of a file (io.lines),&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >the pairs of a table (pairs),&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >the entries of a sequence (ipairs),&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >the words of a string (string.gmatch),&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >and so on.</font></div><p></p></pre></div></div><div style="line-height: 28px;"   >在没有generic for函数前的自定义循环用法, 使用factory 函数封装non-local变量和iterator函数(匿名函数), 多次调用iterator函数, 变更non-local变量的值来达到循环的目的. 例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&gt; function factory(t) &nbsp;-- 工厂函数, 返回一个匿名函数</font></div><div><font size="2"   >&gt;&gt; &nbsp; local i = 0 &nbsp;-- 封装一个本地变量</font></div><div><font size="2"   >&gt;&gt; &nbsp; return function () i = i+1; return t[i] end &nbsp;把上层本地变量引入这个匿名函数(后面用它做循环)</font></div><div><font size="2"   >&gt;&gt; end</font></div><div><font size="2"   >&gt; tbl = {10,20,30}</font></div><div><font size="2"   >&gt; iterator = factory(tbl) &nbsp;-- 使用工厂函数生成一个循环函数</font></div><div><font size="2"   >&gt; while true do</font></div><div><font size="2"   >&gt;&gt; &nbsp; local element = iterator()</font></div><div><font size="2"   >&gt;&gt; &nbsp; if element == nil then break end</font></div><div><font size="2"   >&gt;&gt; &nbsp; print (element)</font></div><div><font size="2"   >&gt;&gt; end</font></div><div><font size="2"   >10</font></div><div><font size="2"   >20</font></div><div><font size="2"   >30</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >直接使用generic for :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&gt; for element in factory(tbl) do</font></div><div><font size="2"   >&gt;&gt; &nbsp; print (element)</font></div><div><font size="2"   >&gt;&gt; end</font></div><div><font size="2"   >10</font></div><div><font size="2"   >20</font></div><div><font size="2"   >30</font></div><p></p></pre></div><div>generic for 的语法 &nbsp;:&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >for &lt;var-list&gt; in &lt;exp-list&gt; do</font></div><div><font size="2"   >&nbsp; &lt;body&gt;</font></div><div><font size="2"   >end</font></div><p></p></pre></div><div>解释 :&nbsp;</div><div>&lt;var-list&gt; 是1个或多个变量名, 逗号隔开, 不需要事先定义. 列表中的第一个变量为控制变量.</div><div>&lt;exp-list&gt; 是一个或多个表达式, 逗号隔开.</div><div>Lua处理generic for语法的方法和顺序.</div><div>1. 首先运行exp-list中的表达式, 把所有表达式的返回值转成3个返回值, 注意如果其中有返回多值的函数, 最后可能只用第一个返回值. 例如.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&gt; function x(...) return ... end</font></div><div><font size="2"   >&gt; = x(1,2,3)</font></div><div><font size="2"   >1 &nbsp; &nbsp; &nbsp; 2 &nbsp; &nbsp; &nbsp; 3</font></div><div><font size="2"   >&gt; =x(1,2,3),4</font></div><div><font size="2"   >1 &nbsp; &nbsp; &nbsp; 4</font></div><div><font size="2"   >&gt; a,b,c=x(1,2,3),4 &nbsp;-- 函数后面还有其他变量或表达式时, 取第一个返回值.</font></div><div><font size="2"   >&gt; = a,b,c</font></div><div><font size="2"   >1 &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp; &nbsp; nil</font></div><div><font size="2"   >&gt; a,b,c = 4,x(1,2,3) &nbsp;-- 函数在最后一位时, 返回多值</font></div><div><font size="2"   >&gt; = a,b,c</font></div><div><font size="2"   >4 &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp; 2</font></div></div><div><div><font size="2"   >&gt; a,b,c = 4,(x(1,2,3)) &nbsp;-- 函数外加括号, 强制取第一个返回值</font></div><div><font size="2"   >&gt; = a,b,c</font></div><div><font size="2"   >4 &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp; nil</font></div></div><p></p></pre></div><div style="line-height: 28px;"   >如果exp-list中有多个表达式, 则需要考虑以上情况, 不管怎么样, 第一次运行这些表达式的结果会转换成3个值, 多则废弃多的, 少则末尾以nil填补.</div><div style="line-height: 28px;"   >这三个值分别代表iterator function(使用_f表示), invariant state<span style="line-height: 28px;"   >(使用_s表示)</span><span style="line-height: 28px;"   >, initial value for the control variable</span><span style="line-height: 28px;"   >(使用_var表示)</span><span style="line-height: 28px;"   >.</span></div><div style="line-height: 28px;"   >2. 第二步则调用iterator函数, 并把结果赋予给var-list的各个变量.</div><div style="line-height: 28px;"   >var_1, ..., var_n = _f(_s, _var)</div><div style="line-height: 28px;"   >_var = var_1</div><div style="line-height: 28px;"   >然后判断var_1是否为nil, 如果为nil则退出循环, 如果不为nil则继续调用_f(_s, _var);</div><div style="line-height: 28px;"   >所以以下两种用法实际上是同样的效果 :&nbsp;</div><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >for var_1, ..., var_n in &lt;exp-list&gt; do &lt;block&gt; end</font></div><div style="line-height: 28px;"   ></div><p></p></pre><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >等同于</span></div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >do&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >local _f, _s, _var = &lt;exp-list&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >while true do</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; local var_1, ..., var_n = _f(_s, _var)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; _var = var_1</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; if _var == nil then break end</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &lt;block&gt;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; end</font></div><div style="line-height: 28px;"   ><font size="2"   >end</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div></div>
	</div>
</div>
</body>
</html>