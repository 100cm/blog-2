<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL monitor script [from zabbix.org]</h2>
	<h5 id="">2010-08-09 8:24:40&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020107982440114/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><P>zabbix是一个非常好的监控平台软件，通过编写被监控目标的脚步实现对目标的监控。</P>  <P>下面是PostgreSQL的一个监控脚步：（可以在此基础之上进行修改）</P>  <P>原文地址</P>  <P><A rel="nofollow" href="http://www.zabbix.com/forum/showthread.php?t=8009"  >http://www.zabbix.com/forum/showthread.php?t=8009</A></P>  <P>#! /bin/bash<BR>#<BR># Name: zapost<BR>#<BR># Checks PostgreSQL activity.<BR>#<BR># Author: bashman<BR>#<BR># Version: 1.0<BR>#</P>  <P>zapostver="1.0"<BR>rval=0<BR>sql=""</P>  <P>case $1 in</P>  <P>#'summary')<BR>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sql="select a.datname, pg_size_pretty(pg_database_size(a.datid)) as size, cast(blks_hit/(blks_read+blks_hit+0.000001)*100.0 as numeric(5,2)) as cache, cast(xact_commit/(xact_rollback+xact_commit+0.000001)*100.0 as numeric(5,2)) as success from pg_stat_database a order by a.datname"<BR>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;</P>  <P>#'size')<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #comprobar aqui los parametros<BR>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shift<BR>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sql="select pg_database_size('$1') as size"<BR>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;</P>  <P>#'version')<BR>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sql='select version()'<BR>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;</P>  <P>'totalsize')<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sql="select sum(pg_database_size(datid)) as total_size from pg_stat_database"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;</P>  <P>'db_cache')<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # comprueba los parametros<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if [ ! -z $2 ]; then<BR>&nbsp;&nbsp;shift<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;sql="select cast(blks_hit/(blks_read+blks_hit+0.000001)*100.0 as numeric(5,2)) as cache from pg_stat_database where datname = '$1'"<BR>&nbsp;fi<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;</P>  <P>'db_success')<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # comprueba los parametros<BR>&nbsp;if [ ! -z $2 ]; then<BR>&nbsp;&nbsp;shift<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;sql="select cast(xact_commit/(xact_rollback+xact_commit+0.000001)*100.0 as numeric(5,2)) as success from pg_stat_database where datname = '$1'"<BR>&nbsp;fi<BR>&nbsp;;;</P>  <P>'server_processes')<BR>&nbsp;sql="select sum(numbackends) from pg_stat_database"<BR>&nbsp;;;</P>  <P>'tx_commited')<BR>&nbsp;sql="select sum(xact_commit) from pg_stat_database"<BR>&nbsp;;;</P>  <P>'tx_rolledback')<BR>&nbsp;sql="select sum(xact_rollback) from pg_stat_database"<BR>&nbsp;;;</P>  <P>'db_size')<BR>&nbsp;# comprueba los parametros<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if [ ! -z $2 ]; then<BR>&nbsp;&nbsp;shift<BR>&nbsp;&nbsp;sql="select pg_database_size('$1')" #as size"<BR>&nbsp;fi<BR>&nbsp;;;</P>  <P>'db_connections')<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # comprueba los parametros<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if [ ! -z $2 ]; then<BR>&nbsp;&nbsp;shift<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;sql="select numbackends from pg_stat_database where datname = '$1'"<BR>&nbsp;fi<BR>&nbsp;;;</P>  <P>'db_returned')<BR>&nbsp;# comprueba los parametros<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if [ ! -z $2 ]; then<BR>&nbsp;&nbsp;shift<BR>&nbsp;&nbsp;sql="select tup_returned from pg_stat_database where datname = '$1'"<BR>&nbsp;fi<BR>&nbsp;;;</P>  <P>'db_fetched')<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # comprueba los parametros<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if [ ! -z $2 ]; then<BR>&nbsp;&nbsp;shift<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;sql="select tup_fetched from pg_stat_database where datname = '$1'"<BR>&nbsp;fi<BR>&nbsp;;;</P>  <P>'db_inserted')<BR>&nbsp;# comprueba los parametros<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if [ ! -z $2 ]; then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;shift<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;sql="select tup_inserted from pg_stat_database where datname = '$1'"<BR>&nbsp;fi<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;</P>  <P>'db_updated')<BR>&nbsp;# comprueba los parametros<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if [ ! -z $2 ]; then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;shift<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;sql="select tup_updated from pg_stat_database where datname = '$1'"<BR>&nbsp;fi<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;</P>  <P>'db_deleted')<BR>&nbsp;# comprueba los parametros<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if [ ! -z $2 ]; then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;shift<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;sql="select tup_deleted from pg_stat_database where datname = '$1'"<BR>&nbsp;fi<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;</P>  <P>'db_commited')<BR>&nbsp;# comprueba los parametros<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if [ ! -z $2 ]; then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;shift<BR>&nbsp;&nbsp;sql="select xact_commit from pg_stat_database where datname = '$1'"<BR>&nbsp;fi<BR>&nbsp;;;</P>  <P>'db_rolled')<BR>&nbsp;# comprueba los parametros<BR>&nbsp;if [ ! -z $2 ]; then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;shift<BR>&nbsp;&nbsp;sql="select xact_rollback from pg_stat_database where datname = '$1'"<BR>&nbsp;fi<BR>&nbsp;;;</P>  <P>'version')<BR>&nbsp;sql="version"<BR>&nbsp;;;</P>  <P>'zapostver')<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo "$zapostver"<BR>&nbsp;exit $rval<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;</P>  <P>*)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo "zapost version: $zapostver"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo "usage:"<BR>&nbsp;echo "&nbsp;&nbsp;&nbsp; $0 total size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -- Check the total databases size."<BR>&nbsp;echo "&nbsp;&nbsp;&nbsp; $0 db_cache &lt;dbname&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -- Check the database cache hit ratio (percentage)."<BR>&nbsp;echo "&nbsp;&nbsp;&nbsp; $0 db_success &lt;dbname&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -- Check the database success rate (percentage)."<BR>&nbsp;echo "&nbsp;&nbsp;&nbsp; $0 server_processes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -- Check the total number of Server Processes that are active."<BR>&nbsp;echo "&nbsp;&nbsp;&nbsp; $0 tx_commited&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -- Check the total number of commited transactions."<BR>&nbsp;echo "&nbsp;&nbsp;&nbsp; $0 tx_rolledback&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -- Check the total number of rolled back transactions."<BR>&nbsp;echo "&nbsp;&nbsp;&nbsp; $0 db_size &lt;dbname&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -- Check the size of a Database (in bytes)."<BR>&nbsp;echo "&nbsp;&nbsp;&nbsp; $0 db_connections &lt;dbname&gt;&nbsp;&nbsp;&nbsp;&nbsp; -- Check the number of active connections for a specified database."&nbsp;<BR>&nbsp;echo "&nbsp;&nbsp;&nbsp; $0 db_returned &lt;dbname&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -- Check the number of tuples returned for a specified database."<BR>&nbsp;echo "&nbsp;&nbsp;&nbsp; $0 db_fetched &lt;dbname&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -- Check the number of tuples fetched for a specified database."<BR>&nbsp;echo "&nbsp;&nbsp;&nbsp; $0 db_inserted &lt;dbname&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -- Check the number of tuples inserted for a specified database."<BR>&nbsp;echo "&nbsp;&nbsp;&nbsp; $0 db_updated &lt;dbname&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -- Check the number of tuples updated for a specified database."<BR>&nbsp;echo "&nbsp;&nbsp;&nbsp; $0 db_deleted &lt;dbname&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -- Check the number of tuples deleted for a specified database."<BR>&nbsp;echo "&nbsp;&nbsp;&nbsp; $0 db_commited &lt;dbname&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -- Check the number of commited back transactions for a specified database."<BR>&nbsp;echo "&nbsp;&nbsp;&nbsp; $0 db_rolled &lt;dbname&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -- Check the number of rolled back transactions for a specified database."<BR>&nbsp;echo "&nbsp;&nbsp;&nbsp; $0 version&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -- The PostgreSQL version."<BR>&nbsp;echo "&nbsp;&nbsp;&nbsp; $0 zapostver&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -- Version of this script."<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exit $rval<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;<BR>esac</P>  <P>if [ "$sql" != "" ]; then<BR>&nbsp;if [ "$sql" == "version" ]; then<BR>&nbsp;&nbsp;psql --version|head -n1<BR>&nbsp;&nbsp;rval=$?<BR>&nbsp;else<BR>&nbsp;&nbsp;psql -t -c "$sql"<BR>&nbsp;&nbsp;rval=$?<BR>&nbsp;fi<BR>fi</P>  <P>if [ "$rval" -ne 0 ]; then<BR>&nbsp; &nbsp;echo "ZBX_NOTSUPPORTED"<BR>fi</P>  <P>exit $rval</P>  <P>#<BR># end zapost</P></div>
	</div>
</div>
</body>
</html>