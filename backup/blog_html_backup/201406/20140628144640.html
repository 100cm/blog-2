<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL IOPS performance tuning by flashcache</h2>
	<h5 id="">2014-06-28 14:46:40&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014528115551323/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>flashcache缺点之一, 一个SSD区域只能绑定到一个块设备或逻辑卷,PV. 不能像ZPOOL那样共享一个SSD区域.</div><div>其他可选cache软件, bcache, dmcache.</div><div><div style="line-height: 28px;"   >注意, 建议EXT4挂载项：</div><div style="line-height: 28px;"   >nobarrier,discard</div></div><div><a target="_blank" rel="nofollow" href="https://github.com/facebook/flashcache/blob/master/doc/flashcache-doc.txt"   >https://github.com/facebook/flashcache/blob/master/doc/flashcache-doc.txt</a></div><div><a target="_blank" rel="nofollow" href="https://github.com/facebook/flashcache/issues/163"   >https://github.com/facebook/flashcache/issues/163</a></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;discard/nodiscard</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Controls whether ext4 should issue discard/TRIM commands to the underlying block device when blocks &nbsp;are</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; freed. &nbsp; This &nbsp;is &nbsp;useful &nbsp;for &nbsp;SSD devices and sparse/thinly-provisioned LUNs, but it is off by default</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; until sufficient testing has been done.</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;barrier=none / barrier=flush</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; This enables/disables the use of write barriers in the journaling code. &nbsp;barrier=none disables it, &nbsp;bar-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rier=flush &nbsp;enables &nbsp;it. &nbsp;Write &nbsp;barriers &nbsp;enforce &nbsp;proper &nbsp;on-disk &nbsp;ordering of journal commits, making</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; volatile disk write caches safe to use, at some performance penalty. The reiserfs &nbsp;filesystem &nbsp;does &nbsp;not</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; enable &nbsp;write &nbsp;barriers &nbsp;by default. Be sure to enable barriers unless your disks are battery-backed one</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; way or another. Otherwise you risk filesystem corruption in case of power failure.</font></div></div><p></p></pre></div><div><br></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >wget https://github.com/facebook/flashcache/archive/master.zip</font></div><div><font size="2"   ># uname -r</font></div><div><font size="2"   >2.6.32-358.el6.x86_64</font></div><p></p></pre></div><div><br></div><div>参照README-CentOS6安装</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >yum localinstall --nogpgcheck http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >vi /etc/yum.repos.d/epel.repo</font></div><div><font size="2"   >enabled=1</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >yum install -y dkms gcc make yum-utils kernel-devel-`uname -r`</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >yumdownloader --source kernel-`uname -r`</font></div><p></p></pre></div><div>如果没有的话, 需要添加到yum仓库 &nbsp;CentOS-Vault.repo.&nbsp;</div><div>或者直接去网站下载对应的版本</div><div><a target="_blank" rel="nofollow" href="http://vault.centos.org/6.4/os/Source/SPackages/"   >http://vault.centos.org/6.4/os/Source/SPackages/</a></div><div><br></div><div>例如 CentOS6.4 &nbsp; &nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># uname -r</font></div><div><font size="2"   >2.6.32-358.el6.x86_64</font></div><p></p></pre></div><div>下载并安装 &nbsp;wget http://vault.centos.org/6.4/os/Source/SPackages/kernel-2.6.32-358.el6.src.rpm</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >kernel-2.6.32-358.el6.src.rpm</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >unzip master.zip</font></div><div><font size="2"   >cd flashcache-master</font></div><p></p></pre></div><div><br></div><div>安装dracut-flashcache, centos 6 boot支持, 参照doc/dracut-flashcache.txt</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># cd utils/</font></div><div><font size="2"   ># rpm -ivh dracut-flashcache-0.3-1.el6.noarch.rpm&nbsp;</font></div><div><font size="2"   ># rpm -ql dracut-flashcache</font></div><div><font size="2"   >/lib/udev/rules.d/10-flashcache.rules</font></div><div><font size="2"   >/sbin/fc_scan</font></div><div><font size="2"   >/usr/share/doc/dracut-flashcache-0.3</font></div><div><font size="2"   >/usr/share/doc/dracut-flashcache-0.3/COPYING</font></div><div><font size="2"   >/usr/share/doc/dracut-flashcache-0.3/README</font></div><div><font size="2"   >/usr/share/dracut/modules.d</font></div><div><font size="2"   >/usr/share/dracut/modules.d/90flashcache</font></div><div><font size="2"   >/usr/share/dracut/modules.d/90flashcache/63-flashcache.rules</font></div><div><font size="2"   >/usr/share/dracut/modules.d/90flashcache/fc_scan</font></div><div><font size="2"   >/usr/share/dracut/modules.d/90flashcache/install</font></div><div><font size="2"   >/usr/share/dracut/modules.d/90flashcache/installkernel</font></div><div><font size="2"   >/usr/share/dracut/modules.d/90flashcache/parse-flashcache.sh</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >cd flashcache-master</font></div><div><font size="2"   >make</font></div><div><font size="2"   >make install</font></div><p></p></pre></div><div><br></div><div>可选, 配置dracut-flashcache, centos 6 boot支持, 参照doc/dracut-flashcache.txt</div><div><br></div><div>flashcache配置, 参照flashcache-sa-guide.txt</div><div>1. 选择SSD, 做好整块盘, 当然分区也行</div><div>2. 分区的话, 先按4K/8K对齐分好(视盘的情况而定). &nbsp;+(n*2048-1)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># fdisk -c -u /dev/sda</font></div><div><font size="2"   >Device contains neither a valid DOS partition table, nor Sun, SGI or OSF disklabel</font></div><div><font size="2"   >Building a new DOS disklabel with disk identifier 0x0fab9b9b.</font></div><div><font size="2"   >Changes will remain in memory only, until you decide to write them.</font></div><div><font size="2"   >After that, of course, the previous content won't be recoverable.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Warning: invalid flag 0x0000 of partition table 4 will be corrected by w(rite)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Command (m for help): p</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Disk /dev/sda: 240.1 GB, 240068197888 bytes</font></div><div><font size="2"   >255 heads, 63 sectors/track, 29186 cylinders, total 468883199 sectors</font></div><div><font size="2"   >Units = sectors of 1 * 512 = 512 bytes</font></div><div><font size="2"   >Sector size (logical/physical): 512 bytes / 512 bytes</font></div><div><font size="2"   >I/O size (minimum/optimal): 512 bytes / 512 bytes</font></div><div><font size="2"   >Disk identifier: 0x0fab9b9b</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;Device Boot &nbsp; &nbsp; &nbsp;Start &nbsp; &nbsp; &nbsp; &nbsp; End &nbsp; &nbsp; &nbsp;Blocks &nbsp; Id &nbsp;System</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Command (m for help): n</font></div><div><font size="2"   >Command action</font></div><div><font size="2"   >&nbsp; &nbsp;e &nbsp; extended</font></div><div><font size="2"   >&nbsp; &nbsp;p &nbsp; primary partition (1-4)</font></div><div><font size="2"   >p</font></div><div><font size="2"   >Partition number (1-4): 1</font></div><div><font size="2"   >First sector (2048-468883198, default 2048):&nbsp;</font></div><div><font size="2"   >Using default value 2048</font></div><div><font size="2"   >Last sector, +sectors or +size{K,M,G} (2048-468883198, default 468883198): +(204800000-1)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Command (m for help): p</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Disk /dev/sda: 240.1 GB, 240068197888 bytes</font></div><div><font size="2"   >255 heads, 63 sectors/track, 29186 cylinders, total 468883199 sectors</font></div><div><font size="2"   >Units = sectors of 1 * 512 = 512 bytes</font></div><div><font size="2"   >Sector size (logical/physical): 512 bytes / 512 bytes</font></div><div><font size="2"   >I/O size (minimum/optimal): 512 bytes / 512 bytes</font></div><div><font size="2"   >Disk identifier: 0x0fab9b9b</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;Device Boot &nbsp; &nbsp; &nbsp;Start &nbsp; &nbsp; &nbsp; &nbsp; End &nbsp; &nbsp; &nbsp;Blocks &nbsp; Id &nbsp;System</font></div><div><font size="2"   >/dev/sda1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2048 &nbsp; 204802047 &nbsp; 102400000 &nbsp;83 &nbsp;Linux</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># fdisk -l -c -u /dev/sda</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Disk /dev/sda: 240.1 GB, 240068197888 bytes</font></div><div><font size="2"   >87 heads, 11 sectors/track, 489951 cylinders, total 468883199 sectors</font></div><div><font size="2"   >Units = sectors of 1 * 512 = 512 bytes</font></div><div><font size="2"   >Sector size (logical/physical): 512 bytes / 512 bytes</font></div><div><font size="2"   >I/O size (minimum/optimal): 512 bytes / 512 bytes</font></div><div><font size="2"   >Disk identifier: 0x0fab9b9b</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;Device Boot &nbsp; &nbsp; &nbsp;Start &nbsp; &nbsp; &nbsp; &nbsp; End &nbsp; &nbsp; &nbsp;Blocks &nbsp; Id &nbsp;System</font></div><div><font size="2"   >/dev/sda1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2048 &nbsp; 204802047 &nbsp; 102400000 &nbsp;83 &nbsp;Linux</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Examples :</font></div><div><font size="2"   ># df -h</font></div><div><font size="2"   >Filesystem &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Size &nbsp;Used Avail Use% Mounted on</font></div><div><font size="2"   >/dev/sdc1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;29G &nbsp; 14G &nbsp; 14G &nbsp;51% /</font></div><div><font size="2"   >tmpfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;48G &nbsp;8.0K &nbsp; 48G &nbsp; 1% /dev/shm</font></div><div><font size="2"   >/dev/sdc3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;98G &nbsp; 40G &nbsp; 53G &nbsp;43% /opt</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-150 flashcache-master]# flashcache_create --help</font></div><div><font size="2"   >flashcache_create: invalid option -- '-'</font></div><div><font size="2"   >Usage: flashcache_create [-v] [-p back|thru|around] [-b block size] [-m md block size] [-s cache size] [-a associativity] cachedev ssd_devname disk_devname</font></div><div><font size="2"   >Usage : flashcache_create Cache Mode back|thru|around is required argument</font></div><div><font size="2"   >Usage : flashcache_create Default units for -b, -m, -s are sectors, or specify in k/M/G. Default associativity is 512.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >flashcache_create -v -p back -s 20G -b 4k cachedev1 /dev/sda1 /dev/sdc</font></div><div><font size="2"   >Creates a 20GB writeback cache volume with a 4KB block size on ssd&nbsp;</font></div><div><font size="2"   >device /dev/sdc to cache the disk volume /dev/sdb. The name of the device&nbsp;</font></div><div><font size="2"   >created is "cachedev".</font></div><p></p></pre></div><div><br></div><div>如果块设备挂载了文件系统或在使用的话, 不能创建cachedev</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># flashcache_create -v -p back -s 20G -b 4k cachedev1 /dev/sda1 /dev/sdc</font></div><div><font size="2"   >cachedev cachedev1, ssd_devname /dev/sda1, disk_devname /dev/sdc cache mode WRITE_BACK</font></div><div><font size="2"   >block_size 8, md_block_size 8, cache_size 41943040</font></div><div><font size="2"   >Flashcache metadata will use 110MB of your 96733MB main memory</font></div><div><font size="2"   >Loading Flashcache Module</font></div><div><font size="2"   >version string "git commit:&nbsp;</font></div><div><font size="2"   >"</font></div><div><font size="2"   >Creating FlashCache Volume : "echo 0 285474816 flashcache /dev/sdc /dev/sda1 cachedev1 1 2 8 41943040 512 140733193388544 8 | dmsetup create cachedev1"</font></div><div><font size="2"   >device-mapper: reload ioctl on cachedev1 failed: Device or resource busy</font></div><div><font size="2"   >Command failed</font></div><div><font size="2"   >echo 0 285474816 flashcache /dev/sdc /dev/sda1 cachedev1 1 2 8 41943040 512 140733193388544 8 | dmsetup create cachedev1 failed</font></div><p></p></pre></div><div><br></div><div>卸载后就可以使用了</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# flashcache_create -v -p back -s 20G -b 4k cachedev1 /dev/sda1 /dev/sdd1</font></div><div><font size="2"   >cachedev cachedev1, ssd_devname /dev/sda1, disk_devname /dev/sdd1 cache mode WRITE_BACK</font></div><div><font size="2"   >block_size 8, md_block_size 8, cache_size 41943040</font></div><div><font size="2"   >Flashcache metadata will use 110MB of your 96733MB main memory</font></div><div><font size="2"   >Flashcache Module already loaded</font></div><div><font size="2"   >version string "git commit:&nbsp;</font></div><div><font size="2"   >"</font></div><div><font size="2"   >Creating FlashCache Volume : "echo 0 389543936 flashcache /dev/sdd1 /dev/sda1 cachedev1 1 2 8 41943040 512 140733193388544 8 | dmsetup create cachedev1"</font></div><p></p></pre></div><div><br></div><div>查看刚刚创建的DM设备</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# dmsetup status</font></div><div><font size="2"   >cachedev1: 0 389543936 flashcache stats:&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; reads(84), writes(0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; read hits(1), read hit percent(1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; write hits(0) write hit percent(0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; dirty write hits(0) dirty write hit percent(0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; replacement(0), write replacement(0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; write invalidates(0), read invalidates(0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; pending enqueues(0), pending inval(0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; metadata dirties(0), metadata cleans(0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; metadata batch(0) metadata ssd writes(0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; cleanings(0) fallow cleanings(0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; no room(0) front merge(0) back merge(0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; force_clean_block(0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; disk reads(83), disk writes(0) ssd reads(1) ssd writes(83)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; uncached reads(0), uncached writes(0), uncached IO requeue(0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; disk read errors(0), disk write errors(0) ssd read errors(0) ssd write errors(0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; uncached sequential reads(0), uncached sequential writes(0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; pid_adds(0), pid_dels(0), pid_drops(0) pid_expiry(0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; lru hot blocks(2610944), lru warm blocks(2610944)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; lru promotions(0), lru demotions(0)</font></div><p></p></pre></div><div><br></div><div>挂载它</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# mount /dev/mapper/cachedev1 /ssd1</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# df -h</font></div><div><font size="2"   >Filesystem &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Size &nbsp;Used Avail Use% Mounted on</font></div><div><font size="2"   >/dev/sdc1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;29G &nbsp; 14G &nbsp; 14G &nbsp;51% /</font></div><div><font size="2"   >tmpfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;48G &nbsp;8.0K &nbsp; 48G &nbsp; 1% /dev/shm</font></div><div><font size="2"   >/dev/sdc3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;98G &nbsp; 40G &nbsp; 53G &nbsp;43% /opt</font></div><div><font size="2"   >/dev/sdb1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 221G &nbsp; 72G &nbsp;138G &nbsp;35% /ssd4</font></div><div><font size="2"   >/dev/mapper/cachedev1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 183G &nbsp; 49G &nbsp;126G &nbsp;28% /ssd1</font></div><p></p></pre></div><div>建议EXT4挂载项：</div><div>nobarrier,discard</div><div><br></div><div>删除DM设备,&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# umount /ssd1</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# dmsetup remove cachedev1</font></div><p></p></pre></div><div><br></div><div>删除flashcache设备</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# flashcache_destroy /dev/sda1</font></div><div><font size="2"   >flashcache_destroy: Destroying Flashcache found on /dev/sda1. Any data will be lost !!</font></div><p></p></pre></div><div><br></div><div>使用一个机械硬盘, 加上flashcache后看看性能如何.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 ~]# df -h</font></div><div><font size="2"   >Filesystem &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Size &nbsp;Used Avail Use% Mounted on</font></div><div><font size="2"   >/dev/sdc1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;29G &nbsp; 14G &nbsp; 14G &nbsp;51% /</font></div><div><font size="2"   >tmpfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;48G &nbsp;8.0K &nbsp; 48G &nbsp; 1% /dev/shm</font></div><div><font size="2"   >/dev/sdc3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;98G &nbsp; 40G &nbsp; 53G &nbsp;43% /opt</font></div><div><font size="2"   >/dev/sdb1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 221G &nbsp; 72G &nbsp;138G &nbsp;35% /ssd4</font></div></div><div><font size="2"   >[root@db-172-16-3-150 ~]# umount /opt</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-150 ~]# flashcache_create -v -p back -s 40G -b 4k cachedev1 /dev/sda1 /dev/sdc3</font></div><div><font size="2"   >cachedev cachedev1, ssd_devname /dev/sda1, disk_devname /dev/sdc3 cache mode WRITE_BACK</font></div><div><font size="2"   >block_size 8, md_block_size 8, cache_size 83886080</font></div><div><font size="2"   >Flashcache metadata will use 220MB of your 96733MB main memory</font></div><div><font size="2"   >Flashcache Module already loaded</font></div><div><font size="2"   >version string "git commit:&nbsp;</font></div><div><font size="2"   >"</font></div><div><font size="2"   >Creating FlashCache Volume : "echo 0 207254565 flashcache /dev/sdc3 /dev/sda1 cachedev1 1 2 8 83886080 512 140733193388544 8 | dmsetup create cachedev1"</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# mount /dev/mapper/cachedev1 /opt</font></div><p></p></pre></div><div><br></div><div>测试fsync性能</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# /home/bdr/pgsql/bin/pg_test_fsync -f /opt/1</font></div><div><font size="2"   >5 seconds per test</font></div><div><font size="2"   >O_DIRECT supported on this platform for open_datasync and open_sync.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Compare file sync methods using one 8kB write:</font></div><div><font size="2"   >(in wal_sync_method preference order, except fdatasync</font></div><div><font size="2"   >is Linux's default)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open_datasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 12963.806 ops/sec &nbsp; &nbsp; &nbsp;77 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11115.933 ops/sec &nbsp; &nbsp; &nbsp;90 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fsync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 412.602 ops/sec &nbsp; &nbsp;2424 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fsync_writethrough &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;n/a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open_sync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 12989.584 ops/sec &nbsp; &nbsp; &nbsp;77 usecs/op</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Compare file sync methods using two 8kB writes:</font></div><div><font size="2"   >(in wal_sync_method preference order, except fdatasync</font></div><div><font size="2"   >is Linux's default)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open_datasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6513.141 ops/sec &nbsp; &nbsp; 154 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8324.517 ops/sec &nbsp; &nbsp; 120 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fsync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 405.985 ops/sec &nbsp; &nbsp;2463 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fsync_writethrough &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;n/a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open_sync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6530.344 ops/sec &nbsp; &nbsp; 153 usecs/op</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Compare open_sync with different write sizes:</font></div><div><font size="2"   >(This is designed to compare the cost of writing 16kB</font></div><div><font size="2"   >in different write open_sync sizes.)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 * 16kB open_sync write &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9822.855 ops/sec &nbsp; &nbsp; 102 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 * &nbsp;8kB open_sync writes &nbsp; &nbsp; &nbsp; &nbsp; 6519.366 ops/sec &nbsp; &nbsp; 153 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 * &nbsp;4kB open_sync writes &nbsp; &nbsp; &nbsp; &nbsp; 3918.786 ops/sec &nbsp; &nbsp; 255 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8 * &nbsp;2kB open_sync writes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 20.625 ops/sec &nbsp; 48486 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16 * &nbsp;1kB open_sync writes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 10.415 ops/sec &nbsp; 96012 usecs/op</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Test if fsync on non-write file descriptor is honored:</font></div><div><font size="2"   >(If the times are similar, fsync() can sync data written</font></div><div><font size="2"   >on a different descriptor.)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; write, fsync, close &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 678.063 ops/sec &nbsp; &nbsp;1475 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; write, close, fsync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2085.175 ops/sec &nbsp; &nbsp; 480 usecs/op</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Non-Sync'ed 8kB writes:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; write &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;188286.273 ops/sec &nbsp; &nbsp; &nbsp; 5 usecs/op</font></div><p></p></pre></div><div><br></div><div>对比原机械硬盘的性能</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# /home/bdr/pgsql/bin/pg_test_fsync -f /1</font></div><div><font size="2"   >5 seconds per test</font></div><div><font size="2"   >O_DIRECT supported on this platform for open_datasync and open_sync.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Compare file sync methods using one 8kB write:</font></div><div><font size="2"   >(in wal_sync_method preference order, except fdatasync</font></div><div><font size="2"   >is Linux's default)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open_datasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 163.266 ops/sec &nbsp; &nbsp;6125 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 165.646 ops/sec &nbsp; &nbsp;6037 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fsync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;53.012 ops/sec &nbsp; 18864 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fsync_writethrough &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;n/a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open_sync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 164.367 ops/sec &nbsp; &nbsp;6084 usecs/op</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Compare file sync methods using two 8kB writes:</font></div><div><font size="2"   >(in wal_sync_method preference order, except fdatasync</font></div><div><font size="2"   >is Linux's default)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open_datasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;83.180 ops/sec &nbsp; 12022 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 166.243 ops/sec &nbsp; &nbsp;6015 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fsync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;53.661 ops/sec &nbsp; 18636 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fsync_writethrough &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;n/a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open_sync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;82.807 ops/sec &nbsp; 12076 usecs/op</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Compare open_sync with different write sizes:</font></div><div><font size="2"   >(This is designed to compare the cost of writing 16kB</font></div><div><font size="2"   >in different write open_sync sizes.)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 * 16kB open_sync write &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 165.158 ops/sec &nbsp; &nbsp;6055 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 * &nbsp;8kB open_sync writes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 82.624 ops/sec &nbsp; 12103 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 * &nbsp;4kB open_sync writes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 41.285 ops/sec &nbsp; 24222 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8 * &nbsp;2kB open_sync writes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 20.781 ops/sec &nbsp; 48122 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 16 * &nbsp;1kB open_sync writes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 10.390 ops/sec &nbsp; 96242 usecs/op</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Test if fsync on non-write file descriptor is honored:</font></div><div><font size="2"   >(If the times are similar, fsync() can sync data written</font></div><div><font size="2"   >on a different descriptor.)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; write, fsync, close &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;52.233 ops/sec &nbsp; 19145 usecs/op</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; write, close, fsync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;54.324 ops/sec &nbsp; 18408 usecs/op</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Non-Sync'ed 8kB writes:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; write &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;203661.070 ops/sec &nbsp; &nbsp; &nbsp; 5 usecs/op</font></div><p></p></pre></div><div><br></div><div>postgresql update if exists else insert 测试模型结果</div><div>flashcache device ssd+普通机械盘</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -T 60</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 465274</font></div><div><font size="2"   >tps = 7754.017036 (including connections establishing)</font></div><div><font size="2"   >tps = 7756.166925 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003762 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 50000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2.056537 &nbsp; &nbsp; &nbsp; &nbsp;select f(:id);</font></div><p></p></pre></div><div>普通机械盘+raid卡rw cache.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -T 60</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 71206</font></div><div><font size="2"   >tps = 1186.007977 (including connections establishing)</font></div><div><font size="2"   >tps = 1186.820771 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.004485 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 50000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 13.459944 &nbsp; &nbsp; &nbsp; select f(:id);</font></div><p></p></pre></div><div><br></div></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://ftp.sjtu.edu.cn/fedora/epel/6/x86_64/"   >http://ftp.sjtu.edu.cn/fedora/epel/6/x86_64/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://github.com/facebook/flashcache/"   >https://github.com/facebook/flashcache/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201463101652528/"   >http://blog.163.com/digoal@126/blog/static/163877040201463101652528/</a></div><div><br></div><div><span style="line-height: 28px;"   >&nbsp;</span><a style="line-height: 28px;" rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL IOPS performance tuning by flashcache - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div></div>
	</div>
</div>
</body>
</html>