<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">ZFS thin provisioning / sparse ZVOL</h2>
	<h5 id="">2014-06-17 14:18:20&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014517292754/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>zfs支持在zpool基础上创建块设备或volume.</div><div>这个volume同样拥有快照等zfs的功能.</div><div>正常情况下创建zvol时, -V指定的空间会直接从zpool中取出, 确保这个zvol可以使用指定的空间, 而不会导致空间溢出的问题.</div><div><font size="2"   color="#ff0000"   >[root@db- zp1]# df -h</font></div><div><font size="2"   color="#ff0000"   >Filesystem &nbsp; &nbsp; &nbsp;Size &nbsp;Used Avail Use% Mounted on</font></div><div><font size="2"   color="#ff0000"   >/dev/sda1 &nbsp; &nbsp; &nbsp; &nbsp;32G &nbsp;3.7G &nbsp; 27G &nbsp;13% /</font></div><div><font size="2"   color="#ff0000"   >tmpfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16G &nbsp; &nbsp; 0 &nbsp; 16G &nbsp; 0% /dev/shm</font></div><div><font size="2"   color="#ff0000"   >/dev/sda3 &nbsp; &nbsp; &nbsp; 236G &nbsp;188M &nbsp;223G &nbsp; 1% /opt</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;29T &nbsp;128K &nbsp; 29T &nbsp; 1% /zp1</font></div><div><font size="2"   color="#ff0000"   >[root@db- zp1]# zfs create -V 10TB zp1/vol1</font></div><div><font size="2"   color="#ff0000"   >[root@db- zp1]# df -h</font></div><div><font size="2"   color="#ff0000"   >Filesystem &nbsp; &nbsp; &nbsp;Size &nbsp;Used Avail Use% Mounted on</font></div><div><font size="2"   color="#ff0000"   >/dev/sda1 &nbsp; &nbsp; &nbsp; &nbsp;32G &nbsp;3.7G &nbsp; 27G &nbsp;13% /</font></div><div><font size="2"   color="#ff0000"   >tmpfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16G &nbsp; &nbsp; 0 &nbsp; 16G &nbsp; 0% /dev/shm</font></div><div><font size="2"   color="#ff0000"   >/dev/sda3 &nbsp; &nbsp; &nbsp; 236G &nbsp;188M &nbsp;223G &nbsp; 1% /opt</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;19T &nbsp;128K &nbsp; 19T &nbsp; 1% /zp1</font></div></div><div><div><font size="2"   color="#ff0000"   >[root@db- zp1]# ll /dev/zvol/zp1/vol1&nbsp;</font></div><div><font size="2"   color="#ff0000"   >lrwxrwxrwx 1 root root 9 Jun 17 14:06 /dev/zvol/zp1/vol1 -&gt; ../../zd0</font></div><div><font size="2"   color="#ff0000"   >[root@db- zp1]# ll /dev/zd0</font></div><div><font size="2"   color="#ff0000"   >brw-rw---- 1 root disk 230, 0 Jun 17 14:06 /dev/zd0</font></div></div><div><br></div><div>使用thin zvol的话, 甚至可以创建超出zpool大小的zvol, 有点类似EMC存储的thin provisioning卷</div><div>例如</div><div><div><font size="2"   color="#ff0000"   >[root@db- zp1]# zfs create -s -V 30TB zp1/vol2</font></div><div><font size="2"   color="#ff0000"   >[root@db- zp1]# zfs create -s -V 300TB zp1/vol3</font></div><div><font size="2"   color="#ff0000"   >[root@db- zp1]# df -h</font></div><div><font size="2"   color="#ff0000"   >Filesystem &nbsp; &nbsp; &nbsp;Size &nbsp;Used Avail Use% Mounted on</font></div><div><font size="2"   color="#ff0000"   >/dev/sda1 &nbsp; &nbsp; &nbsp; &nbsp;32G &nbsp;3.7G &nbsp; 27G &nbsp;13% /</font></div><div><font size="2"   color="#ff0000"   >tmpfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16G &nbsp; &nbsp; 0 &nbsp; 16G &nbsp; 0% /dev/shm</font></div><div><font size="2"   color="#ff0000"   >/dev/sda3 &nbsp; &nbsp; &nbsp; 236G &nbsp;188M &nbsp;223G &nbsp; 1% /opt</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;19T &nbsp;128K &nbsp; 19T &nbsp; 1% /zp1</font></div><div><font size="2"   color="#ff0000"   >非thin zvol不允许空间超出zpool的剩余空间.</font></div><div><font size="2"   color="#ff0000"   >[root@db- zp1]# zfs create -V 300TB zp1/vol4</font></div><div><font size="2"   color="#ff0000"   >cannot create 'zp1/vol4': out of space</font></div></div><div><div><font size="2"   color="#ff0000"   >[root@db-192-168-173-219 zp1]# zfs create -V 20TB zp1/vol4</font></div><div><font size="2"   color="#ff0000"   >cannot create 'zp1/vol4': out of space</font></div></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><div><font size="2"   color="#ff0000"   >[root@db- zp1]# ll /dev/zd*</font></div><div><font size="2"   color="#ff0000"   >brw-rw---- 1 root disk 230, &nbsp;0 Jun 17 14:06 /dev/zd0</font></div><div><font size="2"   color="#ff0000"   >brw-rw---- 1 root disk 230, 16 Jun 17 14:08 /dev/zd16</font></div><div><font size="2"   color="#ff0000"   >brw-rw---- 1 root disk 230, 32 Jun 17 14:08 /dev/zd32</font></div><div><font size="2"   color="#ff0000"   >[root@db- zp1]# ll /dev/zvol/zp1/vol*</font></div><div><font size="2"   color="#ff0000"   >lrwxrwxrwx 1 root root &nbsp;9 Jun 17 14:06 /dev/zvol/zp1/vol1 -&gt; ../../zd0</font></div><div><font size="2"   color="#ff0000"   >lrwxrwxrwx 1 root root 10 Jun 17 14:08 /dev/zvol/zp1/vol2 -&gt; ../../zd16</font></div><div><font size="2"   color="#ff0000"   >lrwxrwxrwx 1 root root 10 Jun 17 14:08 /dev/zvol/zp1/vol3 -&gt; ../../zd32</font></div></div><div><br></div><div>[参考]</div><div>1. man zfs</div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp;zfs create [-ps] [-b blocksize] [-o property=value] ... -V size volume</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Creates &nbsp;a volume of the given size. The volume is exported as a block device in /dev/zvol/path, where path</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;is the name of the volume in the ZFS namespace. The size represents the logical size &nbsp;as &nbsp;exported &nbsp;by &nbsp;the</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;device. By default, a reservation of equal size is created.</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;size is automatically rounded up to the nearest 128 Kbytes to ensure that the volume has an integral number</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;of blocks regardless of blocksize.</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-p</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Creates all the non-existing parent datasets. Datasets created in this manner are automatically mounted</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;according to the mountpoint property inherited from their parent. Any property specified on the command</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;line using the -o option is ignored. If the target filesystem already exists, the &nbsp;operation &nbsp;completes</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;successfully.</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-s</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Creates &nbsp;a &nbsp;sparse &nbsp;volume &nbsp;with &nbsp;no reservation. See volsize in the Native Properties section for more</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;information about sparse volumes.</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-o property=value</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sets the specified property as if the zfs set property=value command was invoked at the same &nbsp;time &nbsp;the</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dataset &nbsp;was &nbsp;created. &nbsp;Any editable ZFS property can also be set at creation time. Multiple -o options</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;can be specified. An error results if the same property is specified in multiple -o options.</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-b blocksize</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Equivalent to -o volblocksize=blocksize. If this option is specified in conjunction with &nbsp;-o &nbsp;volblock-</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;size, the resulting behavior is undefined.</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp;volsize=size</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;For volumes, specifies the logical size of the volume. By default, creating a volume establishes a reserva-</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tion of equal size. For storage pools with a version number &nbsp;of &nbsp;9 &nbsp;or &nbsp;higher, &nbsp;a &nbsp;refreservation &nbsp;is &nbsp;set</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;instead. &nbsp;Any &nbsp;changes &nbsp;to volsize are reflected in an equivalent change to the reservation (or refreserva-</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tion). The volsize can only be set to a multiple of volblocksize, and cannot be zero.</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;The reservation is kept equal to the volume’s logical size to prevent unexpected &nbsp;behavior &nbsp;for &nbsp;consumers.</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Without the reservation, the volume could run out of space, resulting in undefined behavior or data corrup-</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tion, depending on how the volume is used. These effects can also occur when the &nbsp;volume &nbsp;size &nbsp;is &nbsp;changed</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;while &nbsp;it &nbsp;is in use (particularly when shrinking the size). Extreme care should be used when adjusting the</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;volume size.</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Though not recommended, a "sparse volume" (also known as "thin provisioning") can be created by &nbsp;specifying</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;the &nbsp;-s &nbsp;option to the zfs create -V command, or by changing the reservation after the volume has been cre-</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ated. A "sparse volume" is a volume where the reservation is &nbsp;less &nbsp;then &nbsp;the &nbsp;volume &nbsp;size. &nbsp;Consequently,</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;writes &nbsp;to a sparse volume can fail with ENOSPC when the pool is low on space. For a sparse volume, changes</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;to volsize are not reflected in the reservation.</font></div></div><div><br></div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="ZFS thin provisioning / sparse ZVOL - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>