<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL central stream replication unlinked use (scp, cp, pg_basebackup ...)</h2>
	<h5 id="">2014-06-17 13:49:15&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201451713724384/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前面介绍了集中式PITR备份的架构.</div><div><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201451711013770/"   >http://blog.163.com/digoal@126/blog/static/163877040201451711013770/</a></div><div>本文介绍一下不使用虚拟机的情况下, 稍微细节的东西, 即创建基础数据时规避文件夹冲突问题.</div><div>创建基础备份的方法比较多, 例如scp, cp或者pg_basebackup , 下面分别介绍一下.</div><div>1. 使用scp</div><div><div><font size="2"   color="#99cc00"   >&nbsp; &nbsp; &nbsp;-r &nbsp; &nbsp; &nbsp;Recursively copy entire directories. &nbsp;Note that scp follows symbolic links encountered in the tree</font></div><div><font size="2"   color="#99cc00"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;traversal.</font></div></div><div>格式</div><div><font size="2"   color="#99cc00"   >scp -r $PGDATA $user@$dest_ip:$dir</font></div><div>用法</div><div><font size="2"   color="#99cc00"   >psql</font></div><div><font size="2"   color="#99cc00"   ># select pg_startup_backup(now()::text);</font></div><div><span style="line-height: 28px;"   ><font size="2"   color="#99cc00"   >scp -r $PGDATA $user@$dest_ip:$dir</font></span></div><div><font size="2"   color="#99cc00"   ><span style="line-height: 28px;"   >#&nbsp;</span><span style="line-height: 28px;"   >select pg_stop_backup();</span></font></div><div>已经将表空间等在$PGDATA下使用软链接的都去除软链接了.</div><div>删除隐藏的sock文件.</div><div>后面的事情就是配置流复制了.</div><div><br></div><div>2. 使用cp</div><div><div><font size="2"   color="#99cc00"   >&nbsp; &nbsp; &nbsp; &nbsp;-R, -r, --recursive</font></div><div><font size="2"   color="#99cc00"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; copy directories recursively</font></div></div><div><div><font size="2"   color="#99cc00"   >&nbsp; &nbsp; &nbsp; &nbsp;-L, --dereference</font></div><div><font size="2"   color="#99cc00"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; always follow symbolic links in SOURCE</font></div></div><div><span style="line-height: 28px;"   ><font size="2"   color="#99cc00"   >cp -rL $PGDATA/* $dir/*</font></span></div><div><span style="line-height: 28px;"   >软链接将被去除, 直接使用本地文件夹替代.</span></div><div><span style="line-height: 28px;"   >删除隐藏的sock文件.</span></div><div><span style="line-height: 28px;"   >后面的事情就是配置流复制了.</span></div><div><br></div><div>3. 使用pg_basebackup</div><div>因为直接使用pg_basebackup的plain格式的话, 会创建表空间对应的目录, 所以不建议直接使用.</div><div>建议使用tar模式, 这种模式的话会创建base.tar以及表空间.tar.</div><div>到目的地解压, 分类即可.</div><div>例如 :&nbsp;</div><div><font size="2"   color="#99cc00"   >mkdir ~/testbase</font></div><div><font size="2"   color="#99cc00"   >chmod 700&nbsp;<span style="line-height: 28px;"   >~/testbase</span></font></div><div><font size="2"   color="#99cc00"   >cd ~/testbase</font></div><div><font size="2"   color="#99cc00"   >pg_basebackup -D ~/testbase -F t -x -h 127.0.0.1</font></div><div><div><font size="2"   color="#99cc00"   >pg93@db-172-16-3-150-&gt; pwd</font></div><div><font size="2"   color="#99cc00"   >/home/pg93/testbase</font></div><div><font size="2"   color="#99cc00"   >pg93@db-172-16-3-150-&gt; ll</font></div><div><font size="2"   color="#99cc00"   >total 3.1G</font></div><div><font size="2"   color="#99cc00"   >-rw-rw-r-- 1 pg93 pg93 483K Jun 17 13:44 20270.tar</font></div><div><font size="2"   color="#99cc00"   >-rw-rw-r-- 1 pg93 pg93 3.1G Jun 17 13:44 base.tar</font></div></div><div>将base解压到当前目录</div><div><font size="2"   color="#99cc00"   >pg93@db-172-16-3-150-&gt; tar -xvf base.tar</font></div><div>删除表空间软链接</div><div><font size="2"   color="#99cc00"   >pg93@db-172-16-3-150-&gt; cd pg_tblspc/</font></div><div><div><font size="2"   color="#99cc00"   >pg93@db-172-16-3-150-&gt; ll</font></div><div><font size="2"   color="#99cc00"   >total 0</font></div><div><font size="2"   color="#99cc00"   >lrwxrwxrwx 1 pg93 pg93 19 Jun 17 13:45 20270 -&gt; /ssd4/pg93/tbs_test</font></div><div><font size="2"   color="#99cc00"   >pg93@db-172-16-3-150-&gt; rm -rf 20270</font></div></div><div><div><font size="2"   color="#99cc00"   >pg93@db-172-16-3-150-&gt; mkdir 20270</font></div><div><font size="2"   color="#99cc00"   >pg93@db-172-16-3-150-&gt; chmod 700 20270</font></div><div><font size="2"   color="#99cc00"   >pg93@db-172-16-3-150-&gt; cd 20270/</font></div><div><font size="2"   color="#99cc00"   >pg93@db-172-16-3-150-&gt; tar -xvf ../../20270.tar&nbsp;</font></div><div><font size="2"   color="#99cc00"   >PG_9.3_201306121/</font></div><div><font size="2"   color="#99cc00"   >PG_9.3_201306121/16393/</font></div><div><font size="2"   color="#99cc00"   >PG_9.3_201306121/16393/20271</font></div><div><font size="2"   color="#99cc00"   >PG_9.3_201306121/16393/20271_fsm</font></div></div><div><div><font size="2"   color="#99cc00"   >pg93@db-172-16-3-150-&gt; ll</font></div><div><font size="2"   color="#99cc00"   >total 4.0K</font></div><div><font size="2"   color="#99cc00"   >drwx------ 3 pg93 pg93 4.0K Jun 17 11:53 PG_9.3_201306121</font></div></div><div>删除tar文件</div><div><font size="2"   color="#99cc00"   >pg93@db-172-16-3-150-&gt; rm -f ~/testbase/20270.tar ~/testbase/base.tar</font></div><div><span style="line-height: 28px;"   >删除隐藏的sock文件.</span></div><div><span style="line-height: 28px;"   >后面的事情就是配置流复制了.</span></div><div><br></div><div>如果pg_basebackup可以增加一个选项, follow link的话 , (像cp和scp), 用起来就更方便了.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201451711013770/"   >http://blog.163.com/digoal@126/blog/static/163877040201451711013770/</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL central stream replication unlinked use (scp, cp, pg_basebackup ...) - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>