<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL pg_hba.conf "simple bind" configure Use LDAP auth</h2>
	<h5 id="">2014-06-06 16:07:07&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014563264469/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>上一篇BLOG介绍了OpenLDAP Server的配置,&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201454112329931/"   >http://blog.163.com/digoal@126/blog/static/163877040201454112329931/</a></div><div><br></div><div>本文将要讲一下ldap client的配置, 以及PostgreSQL的ldap认证方法.</div><div>ldap认证方法指的是通过ldap进行认证, 而非数据库本身的用户密码进行认证.</div><div>首先要确保PostgreSQL编译时带上了--with-ldap选项.</div><div>例如以下数据库不可用使用ldap认证, 因为带了<span style="line-height: 28px;"   >--without-ldap</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db6-&gt; pg_config --configure</font></div><div><font size="2"   >'--prefix=/app/pgsql' '--with-pgport=1921' '--with-wal-segsize=64' '--with-perl' '--with-python' '--with-openssl' '--with-pam' '--without-ldap' '--with-libxml' '--with-libxslt' '--enable-thread-safety'</font></div><p></p></pre></div><div><br></div><div>被认证的用户必须在ldap服务端存在, 同时在数据库中也要存在, 但是数据库中的用户密码不被用作校验, 所以不需要指定密码.&nbsp;</div><div>甚至可以指定数据库中的密码的到期日, 因为数据库中的密码不被用作校验, 所以限制数据库的密码到期不会限制用户是否能用.</div><div><br></div><div>首先介绍一下测试环境.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >OpenLDAP server</font></div><div><font size="2"   >172.16.3.150:389</font></div><div><font size="2"   >PostgreSQL Server</font></div><div><span style="line-height: 28px;"   ><font size="2"   >172.16.3.39:1999</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >psql client</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >172.16.3.176</font></span></div><p></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div><div>在ldap中创建一个用户.</div><div>生成用户密码</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# slappasswd</font></div><div><font size="2"   >New password: 111111</font></div><div><font size="2"   >Re-enter new password: 111111</font></div><div><span style="line-height: 28px;"   ><font size="2"   >{SSHA}YrmLO/6mSZOkR+fCbtIbWHOAMoju9cCz</font></span></div><p></p></pre></div><div><br></div><div>创建ldif</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# vi user01.ldif&nbsp;</font></div><div><font size="2"   >dn: uid=new,ou=People,dc=my-domain,dc=com</font></div><div><font size="2"   >uid: new</font></div><div><font size="2"   >cn: new</font></div><div><font size="2"   >objectClass: account</font></div><div><font size="2"   >objectClass: posixAccount</font></div><div><font size="2"   >objectClass: top</font></div><div><font size="2"   >objectClass: shadowAccount</font></div><div><font size="2"   >loginShell: /bin/bash</font></div><div><font size="2"   >uidNumber: 503</font></div><div><font size="2"   >gidNumber: 500</font></div><div><font size="2"   >homeDirectory: /home/new</font></div><div><font size="2"   >userPassword: {SSHA}YrmLO/6mSZOkR+fCbtIbWHOAMoju9cCz</font></div><p></p></pre></div><div>导入ldap</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# ldapadd -x -W -D "cn=Manager,dc=my-domain,dc=com" -f user01.ldif</font></div><div></div><p></p></pre></div><div>我们这里新增的用户在ldap中的DN是</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >uid=new,ou=People,dc=my-domain,dc=com</font></span></div><div></div><p></p></pre></div><div><span style="line-height: 28px;"   >PostgreSQL支持2种ldap的认证模式, simple bind和search</span></div><div><span style="line-height: 28px;"   >参考以下链接了解两种认证模式在pg_hba.conf中的配置方法.</span></div><div><a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/auth-methods.html#AUTH-LDAP"   >http://www.postgresql.org/docs/9.4/static/auth-methods.html#AUTH-LDAP</a></div><div><br></div><div>配置数据库的pg_hba.conf, 我这里用simple bind的写法.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >DN = prefix username suffix</font></div><div><font size="2"   >prefix和suffix对应</font></div><div><span style="line-height: 28px;"   ><font size="2"   >ldapprefix</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >ldapsuffix</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >username对应客户端提交的用户名.</font></span></div><p></p></pre></div><div><span style="line-height: 28px;"   >所以知道openldap中配置的DN的话, pg_hba.conf配置就非常简单了.</span></div><div><span style="line-height: 28px;"   >认证的话就是用到这个DN下的</span><span style="line-height: 28px;"   >userPassword.</span></div><div><br></div><div>因为pg_hba.conf是顺序匹配的, 所以为了方便, 直接在文件的最前面加一条</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >host all new 0.0.0.0/0 ldap ldapserver=172.16.3.150 ldapport=389 ldapprefix="uid=" ldapsuffix=",ou=People,dc=my-domain,dc=com"</font></div><div><div><font size="2"   >pg93@db-172-16-3-39-&gt; pg_ctl reload</font></div><div><font size="2"   >server signaled</font></div></div><p></p></pre></div><div><br></div><div>查看postgresql csvlog确保pg_hba.conf的修改生效.</div><div><pre class="prettyprint"   ><p><font size="2"   >2014-06-06 15:52:13.528 CST,,,5229,,53917265.146d,3,,2014-06-06 15:48:53 CST,,0,LOG,00000,"received SIGHUP, reloading configuration files",,,,,,,,"SIGHUP_handler, postmaster.c:2294",""</font></p></pre></div><div>当数据库中不存在 new用户时, 使用111111这个密码登陆报角色不存在的错误.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db5-&gt; psql -h 172.16.3.39 -p 1999 -U new postgres</font></div><div><font size="2"   >Password for user new:&nbsp;</font></div><div><font size="2"   >psql: FATAL: &nbsp;role "new" does not exist</font></div><p></p></pre></div><div><br></div><div>创建这个用户, 不需要指定密码.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 postgresql-9.3.1]# su - pg93</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; psql</font></div><div><font size="2"   >psql (9.3.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# create role new nosuperuser login;</font></div><div><font size="2"   >CREATE ROLE</font></div><p></p></pre></div><div>现在可以登陆了</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db5-&gt; psql -h 172.16.3.39 -p 1999 -U new postgres</font></div><div><font size="2"   >Password for user new:&nbsp;</font></div><div><font size="2"   >psql (9.1.3, server 9.3.1)</font></div><div><font size="2"   >WARNING: psql version 9.1, server version 9.3.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Some psql features might not work.</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=&gt;&nbsp;</font></div><p></p></pre></div><div><br></div><div><div>修改用户的密码有效时间, 不会影响ldap认证</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# alter role new valid until '1970-01-01';</font></div><div><font size="2"   >ALTER ROLE</font></div><div><font size="2"   >digoal=# \du+ new</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of roles</font></div><div><font size="2"   >&nbsp;Role name | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Attributes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Member of | Description&nbsp;</font></div><div><font size="2"   >-----------+---------------------------------------------+-----------+-------------</font></div><div><font size="2"   >&nbsp;new &nbsp; &nbsp; &nbsp; | Password valid until 1970-01-01 00:00:00+08 | {} &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >digoal=#&nbsp;</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres@db5-&gt; psql -h 172.16.3.39 -p 1999 -U new postgres</font></div><div><font size="2"   >Password for user new:&nbsp;</font></div><div><font size="2"   >psql (9.1.3, server 9.3.1)</font></div><div><font size="2"   >WARNING: psql version 9.1, server version 9.3.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Some psql features might not work.</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=&gt;&nbsp;</font></div></div><p></p></pre></div></div><div>修改用户在数据库中的密码, 不影响ldap密码认证.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=&gt; alter role new encrypted password 'abc';</font></div><div><font size="2"   >ALTER ROLE</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres@db5-&gt; psql -h 172.16.3.39 -p 1999 -U new postgres</font></div><div><font size="2"   >Password for user new: 111111</font></div><div><font size="2"   >psql (9.1.3, server 9.3.1)</font></div><div><font size="2"   >WARNING: psql version 9.1, server version 9.3.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Some psql features might not work.</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=&gt;&nbsp;</font></div></div><p></p></pre></div><div>当然, 使用数据库中的密码是无法认证的</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db5-&gt; psql -h 172.16.3.39 -p 1999 -U new postgres</font></div><div><font size="2"   >Password for user new: abc</font></div><div><font size="2"   >psql: FATAL: &nbsp;LDAP authentication failed for user "new"</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/auth-methods.html#AUTH-LDAP"   >http://www.postgresql.org/docs/9.4/static/auth-methods.html#AUTH-LDAP</a></div><div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   >2. man slapd-mdb, slapd-sql ....</div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   >3.&nbsp;<a style="line-height: 28px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" rel="nofollow" href="http://w.gdu.me/wiki/sysadmin/OpenLDAPconfig.html"   >http://w.gdu.me/wiki/sysadmin/OpenLDAPconfig.html</a></div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   >4.&nbsp;<a style="line-height: 28px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" rel="nofollow" href="http://blog.christophersmart.com/articles/openldap-how-to-fedora/"   >http://blog.christophersmart.com/articles/openldap-how-to-fedora/</a></div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   >5.&nbsp;<a style="line-height: 28px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" rel="nofollow" href="http://directory.fedoraproject.org/wiki/Main_Page"   >http://directory.fedoraproject.org/wiki/Main_Page</a></div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   >6.&nbsp;<a style="line-height: 28px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" rel="nofollow" href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Deployment_Guide/ch-Directory_Servers.html"   >https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Deployment_Guide/ch-Directory_Servers.html</a></div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   >7.&nbsp;<a style="line-height: 28px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" rel="nofollow" href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Deployment_Guide/ch-Configuring_Authentication.html"   >https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Deployment_Guide/ch-Configuring_Authentication.html</a></div><span style="color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; line-height: 28px;"   >8.&nbsp;</span><a style="line-height: 28px; text-decoration: none; color: rgb(85, 108, 136); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;" target="_blank" rel="nofollow" href="http://quark.humbug.org.au/publications/ldap/ldap_tut.html"   >http://quark.humbug.org.au/publications/ldap/ldap_tut.html</a><br style="line-height: 28px; color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   ><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   >9.&nbsp;<a style="line-height: 28px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" rel="nofollow" href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Directory_Server/9.0/index.html"   >https://access.redhat.com/site/documentation/en-US/Red_Hat_Directory_Server/9.0/index.html</a></div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   >10.&nbsp;<a style="line-height: 28px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" rel="nofollow" href="http://www.zytrax.com/books/ldap/index.html"   >http://www.zytrax.com/books/ldap/index.html</a></div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   >11.&nbsp;<a style="line-height: 28px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" rel="nofollow" href="http://grokbase.com/t/postgresql/pgsql-general/086x32w1ew/ldap-authentication"   >http://grokbase.com/t/postgresql/pgsql-general/086x32w1ew/ldap-authentication</a></div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   >12.&nbsp;<a style="line-height: 28px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" rel="nofollow" href="http://www-06.ibm.com/jp/linux/tech/doc/attachments/openldap_install_v1.3.pdf"   >http://www-06.ibm.com/jp/linux/tech/doc/attachments/openldap_install_v1.3.pdf</a></div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   >13.&nbsp;<a style="line-height: 28px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" rel="nofollow" href="http://www.cnblogs.com/gaojian/p/3336657.html"   >http://www.cnblogs.com/gaojian/p/3336657.html</a></div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   >14.&nbsp;<a style="line-height: 28px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" rel="nofollow" href="https://secure.sqlmanager.net/en/articles/postgresql/654"   >https://secure.sqlmanager.net/en/articles/postgresql/654</a></div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   >15.&nbsp;<a style="line-height: 28px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" rel="nofollow" href="http://itc.musc.edu/wiki/PostgreSQL"   >http://itc.musc.edu/wiki/PostgreSQL</a></div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   >16.&nbsp;<a style="line-height: 28px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" rel="nofollow" href="http://paginas.fe.up.pt/~jvv/PERL/manual/site/lib/URI/ldap.html"   >http://paginas.fe.up.pt/~jvv/PERL/manual/site/lib/URI/ldap.html</a></div></div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   ><span style="line-height: 28px;"   >17.&nbsp;</span><a style="line-height: 28px; text-decoration: none; color: rgb(85, 108, 136);" target="_blank" rel="nofollow" href="http://www.openldap.org/doc/admin24/backends.html"   >http://www.openldap.org/doc/admin24/backends.html</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL pg_hba.conf simple bind configure Use LDAP auth - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>