<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL stream repication can implement between FreeBSD and CentOS</h2>
	<h5 id="">2014-06-27 10:59:42&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201452710421844/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>环境 :&nbsp;</div><div>主节点</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CentOS 5.8 x64</font></div><div><font size="2"   >PostgreSQL 9.3.2</font></div><div><font size="2"   >编译器 : gcc</font></div><div><font size="2"   >pg_config</font></div><div><div><font size="2"   >BINDIR = /opt/pgsql9.3.2/bin</font></div><div><font size="2"   >DOCDIR = /opt/pgsql9.3.2/share/doc</font></div><div><font size="2"   >HTMLDIR = /opt/pgsql9.3.2/share/doc</font></div><div><font size="2"   >INCLUDEDIR = /opt/pgsql9.3.2/include</font></div><div><font size="2"   >PKGINCLUDEDIR = /opt/pgsql9.3.2/include</font></div><div><font size="2"   >INCLUDEDIR-SERVER = /opt/pgsql9.3.2/include/server</font></div><div><font size="2"   >LIBDIR = /opt/pgsql9.3.2/lib</font></div><div><font size="2"   >PKGLIBDIR = /opt/pgsql9.3.2/lib</font></div><div><font size="2"   >LOCALEDIR = /opt/pgsql9.3.2/share/locale</font></div><div><font size="2"   >MANDIR = /opt/pgsql9.3.2/share/man</font></div><div><font size="2"   >SHAREDIR = /opt/pgsql9.3.2/share</font></div><div><font size="2"   >SYSCONFDIR = /opt/pgsql9.3.2/etc</font></div><div><font size="2"   >PGXS = /opt/pgsql9.3.2/lib/pgxs/src/makefiles/pgxs.mk</font></div><div><font size="2"   >CONFIGURE = '--prefix=/opt/pgsql9.3.2' '--with-pgport=5432' '--with-perl' '--with-python' '--with-tcl' '--with-openssl' '--with-pam' '--without-ldap' '--with-libxml' '--with-libxslt' '--enable-thread-safety' '--with-wal-blocksize=16'</font></div><div><font size="2"   >CC = gcc</font></div><div><font size="2"   >CPPFLAGS = -D_GNU_SOURCE -I/usr/include/libxml2</font></div><div><font size="2"   >CFLAGS = -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv</font></div><div><font size="2"   >CFLAGS_SL = -fpic</font></div><div><font size="2"   >LDFLAGS = -L../../../src/common -Wl,-rpath,'/opt/pgsql9.3.2/lib',--enable-new-dtags</font></div><div><font size="2"   >LDFLAGS_EX =&nbsp;</font></div><div><font size="2"   >LDFLAGS_SL =&nbsp;</font></div><div><font size="2"   >LIBS = -lpgport -lpgcommon -lxslt -lxml2 -lpam -lssl -lcrypto -lz -lreadline -ltermcap -lcrypt -ldl -lm&nbsp;</font></div><div><font size="2"   >VERSION = PostgreSQL 9.3.2</font></div></div><p></p></pre></div><div><br></div><div><br></div><div>standby 节点</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >FreeBSD 10 x64</font></div><div><font size="2"   >PostgreSQL 9.3.4</font></div><div><font size="2"   >编译器 : cc</font></div><div><font size="2"   >pg_config</font></div><div><div><font size="2"   >BINDIR = /opt/pgsql9.3.4/bin</font></div><div><font size="2"   >DOCDIR = /opt/pgsql9.3.4/share/doc</font></div><div><font size="2"   >HTMLDIR = /opt/pgsql9.3.4/share/doc</font></div><div><font size="2"   >INCLUDEDIR = /opt/pgsql9.3.4/include</font></div><div><font size="2"   >PKGINCLUDEDIR = /opt/pgsql9.3.4/include</font></div><div><font size="2"   >INCLUDEDIR-SERVER = /opt/pgsql9.3.4/include/server</font></div><div><font size="2"   >LIBDIR = /opt/pgsql9.3.4/lib</font></div><div><font size="2"   >PKGLIBDIR = /opt/pgsql9.3.4/lib</font></div><div><font size="2"   >LOCALEDIR = /opt/pgsql9.3.4/share/locale</font></div><div><font size="2"   >MANDIR = /opt/pgsql9.3.4/share/man</font></div><div><font size="2"   >SHAREDIR = /opt/pgsql9.3.4/share</font></div><div><font size="2"   >SYSCONFDIR = /opt/pgsql9.3.4/etc</font></div><div><font size="2"   >PGXS = /opt/pgsql9.3.4/lib/pgxs/src/makefiles/pgxs.mk</font></div><div><font size="2"   >CONFIGURE = 'CPPFLAGS=-I/usr/local/include' '--prefix=/opt/pgsql9.3.4' '--with-pgport=5432' '--with-perl' '--with-python' '--with-tcl' '--with-openssl' '--with-pam' '--without-ldap' '--with-libxml' '--with-libxslt' '--enable-thread-safety' '--with-wal-blocksize=16'</font></div><div><font size="2"   >CC = cc</font></div><div><font size="2"   >CPPFLAGS = -I/usr/local/include -I/usr/local/include/libxml2 -I/usr/include</font></div><div><font size="2"   >CFLAGS = -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv</font></div><div><font size="2"   >CFLAGS_SL = -fPIC -DPIC</font></div><div><font size="2"   >LDFLAGS = -L../../../src/common -L/usr/local/lib -L/usr/lib -Wl,--as-needed -Wl,-R'/opt/pgsql9.3.4/lib'</font></div><div><font size="2"   >LDFLAGS_EX =&nbsp;</font></div><div><font size="2"   >LDFLAGS_SL =&nbsp;</font></div><div><font size="2"   >LIBS = -lpgport -lpgcommon -lxslt -lxml2 -lpam -lssl -lcrypto -lz -lreadline -lcrypt -lm&nbsp;</font></div><div><font size="2"   >VERSION = PostgreSQL 9.3.4</font></div></div><p></p></pre></div><div><br></div><div>以上环境libpq binary-compatible, 所以可以作为流复制的主备(已测试一台60G的数据库成功复制, 以及打开测试完全没有问题). 各位客官可模仿.</div><div>这里用到BSD, 主要为了用它的zfs, zfsonlinux目前存在一定的性能问题, 在等brain的回复, 具体是否可以通过模块的参数来优化请期待.</div><div><br></div><div>FreeBSD下的standby激活后的读写测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres@digoal:~ % pg_ctl promote</font></div><div><font size="2"   >server promoting</font></div></div><div><div><font size="2"   >postgres@digoal:~ % psql</font></div><div><font size="2"   >psql (9.3.4)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=&gt; create table test(id int primary key, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=&gt; create or replace function f(v_id int) returns void as $$</font></div><div><font size="2"   >postgres$&gt; declare</font></div><div><font size="2"   >postgres$&gt; begin</font></div><div><font size="2"   >postgres$&gt; &nbsp; update test set info=md5(now()::text),crt_time=now() where id=v_id;</font></div><div><font size="2"   >postgres$&gt; &nbsp; if not found then</font></div><div><font size="2"   >postgres$&gt; &nbsp; &nbsp; insert into test values (v_id, md5(now()::text), now());</font></div><div><font size="2"   >postgres$&gt; &nbsp; end if;</font></div><div><font size="2"   >postgres$&gt; &nbsp; exception when others then</font></div><div><font size="2"   >postgres$&gt; &nbsp; &nbsp; return;</font></div><div><font size="2"   >postgres$&gt; end;</font></div><div><font size="2"   >postgres$&gt; $$ language plpgsql strict;</font></div><div><font size="2"   >sCREATE FUNCTION</font></div><div><font size="2"   >postgres=&gt; select f(1);</font></div><div><font size="2"   >&nbsp;f&nbsp;</font></div><div><font size="2"   >---</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=&gt; select * from test;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | 9de5370fe00c7ed52b48080e2fb3efc9 | 2014-06-27 19:07:14.725201</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=&gt; select f(1);</font></div><div><font size="2"   >&nbsp;f&nbsp;</font></div><div><font size="2"   >---</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=&gt; select * from test;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | f91841b8d4a52cb4ce82e835aa161283 | 2014-06-27 19:07:20.969022</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres@digoal:~ % cd</font></div><div><font size="2"   >postgres@digoal:~ % vi test.sql</font></div></div><div><div><font size="2"   >\setrandom v_id 1 50000000</font></div><div><font size="2"   >select f(:v_id);</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres@digoal:~ % pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -T 30</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 1512165</font></div><div><font size="2"   >tps = 50368.843235 (including connections establishing)</font></div><div><font size="2"   >tps = 50416.031069 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001875 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom v_id 1 50000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.313934 &nbsp; &nbsp; &nbsp; &nbsp;select f(:v_id);</font></div></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201451181344545/"   >http://blog.163.com/digoal@126/blog/static/163877040201451181344545/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014526992910/"   >http://blog.163.com/digoal@126/blog/static/1638770402014526992910/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020145264116819/"   >http://blog.163.com/digoal@126/blog/static/16387704020145264116819/</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL stream repication can implement between FreeBSD and CentOS - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>